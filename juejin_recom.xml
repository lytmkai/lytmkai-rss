<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[剑指offer-54、字符流中第一个不重复的字符]]></title>    <link>https://juejin.cn/post/7586877892468375579</link>    <guid>https://juejin.cn/post/7586877892468375579</guid>    <pubDate>2025-12-24T00:05:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586877892468375579" data-draft-id="7585727457471627264" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="剑指offer-54、字符流中第一个不重复的字符"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-24T00:05:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            剑指offer-54、字符流中第一个不重复的字符
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T00:05:04.000Z" title="Wed Dec 24 2025 00:05:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">题⽬描述</h2>
<p>请实现⼀个函数⽤来找出字符流中第⼀个只出现⼀次的字符。例如，当从字符流中只读出前两个字符" go "时，第⼀个只出现⼀次的字符是" g "。当从该字符流中读出前六个字符“ google "时，第⼀个只出现⼀次的字符是" l "。</p>
<p>返回值描述：如果当前字符流没有存在出现⼀次的字符，返回 # 字符。</p>
<h2 data-id="heading-1">思路及解答</h2>
<h3 data-id="heading-2">有序哈希表</h3>
<p>可以直接使用哈希的数据结构来存取我们的字符，对与重复的字符可以对值进行统计或者标记都行。这里要用LinkedHashMap，因为题目要求到了要出现的第一个不重复的字符，所以如果不使用有序map的话，那么我们就不能保证取到的是第一个不重复的字符。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-comment">//Insert one char from stringstream</span>
    <span class="hljs-comment">//因为后面要遍历保证有序，所以这里使用LinkedHashMap</span>
    Map&lt;Character,Integer&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;&gt;();
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Insert</span><span class="hljs-params">(<span class="hljs-type">char</span> ch)</span>{
        <span class="hljs-keyword">if</span>(map.containsKey(ch)){
            map.put(ch,-<span class="hljs-number">1</span>);
        }<span class="hljs-keyword">else</span>{
            map.put(ch,<span class="hljs-number">1</span>);
        }
    }
  <span class="hljs-comment">//return the first appearence once char in current stringstream</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">char</span> <span class="hljs-title function_">FirstAppearingOnce</span><span class="hljs-params">()</span>{
        <span class="hljs-keyword">for</span>(Character i : map.keySet()){
            <span class="hljs-keyword">if</span>(map.get(i) == <span class="hljs-number">1</span>){
                <span class="hljs-keyword">return</span> i;
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-string">'#'</span>;
    }
}
</code></pre>
<ul>
<li><strong>时间复杂度</strong>：插入O(1)，查询最坏O(n)</li>
<li><strong>空间复杂度</strong>：O(n)</li>
</ul>
<h3 data-id="heading-3">队列+计数数组(最优)</h3>
<p>结合了队列的先进先出特性和数组的快速访问能力，能够高效解决动态字符流中的首个不重复字符查找问题</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] count = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">128</span>];  <span class="hljs-comment">// ASCII字符计数数组</span>
    <span class="hljs-keyword">private</span> Queue&lt;Character&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();  <span class="hljs-comment">// 维护候选字符顺序</span>
    
    <span class="hljs-comment">// 插入字符到流中</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Insert</span><span class="hljs-params">(<span class="hljs-type">char</span> ch)</span> {
        count[ch]++;  <span class="hljs-comment">// 字符出现次数加1</span>
        queue.add(ch);  <span class="hljs-comment">// 字符加入队列</span>
        
        <span class="hljs-comment">// 清理队列头部已重复的字符</span>
        <span class="hljs-keyword">while</span> (!queue.isEmpty() &amp;&amp; count[queue.peek()] &gt; <span class="hljs-number">1</span>) {
            queue.poll();
        }
    }
    
    <span class="hljs-comment">// 返回当前第一个不重复字符</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">char</span> <span class="hljs-title function_">FirstAppearingOnce</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> queue.isEmpty() ? <span class="hljs-string">'#'</span> : queue.peek();
    }
}
</code></pre>
<ul>
<li><strong>时间复杂度</strong>：每个字符的插入操作是均摊O(1)，查询操作是严格的O(1)</li>
<li><strong>空间复杂度</strong>：O(1)（固定大小的数组和队列）</li>
</ul>
<h3 data-id="heading-4">双数组记录</h3>
<p>通过记录字符首次出现的位置和状态，在查询时进行全局扫描</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] position = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">128</span>];  <span class="hljs-comment">// 记录字符位置或状态</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;  <span class="hljs-comment">// 当前字符位置索引</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Solution</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 初始化，-1表示未出现过</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">128</span>; i++) {
            position[i] = -<span class="hljs-number">1</span>;
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Insert</span><span class="hljs-params">(<span class="hljs-type">char</span> ch)</span> {
        <span class="hljs-keyword">if</span> (position[ch] == -<span class="hljs-number">1</span>) {
            <span class="hljs-comment">// 第一次出现，记录位置</span>
            position[ch] = index;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (position[ch] &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-comment">// 重复出现，标记为-2</span>
            position[ch] = -<span class="hljs-number">2</span>;
        }
        index++;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">char</span> <span class="hljs-title function_">FirstAppearingOnce</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">minIndex</span> <span class="hljs-operator">=</span> Integer.MAX_VALUE;
        <span class="hljs-type">char</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-string">'#'</span>;
        
        <span class="hljs-comment">// 扫描找到最小正整数值对应的字符</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">128</span>; i++) {
            <span class="hljs-keyword">if</span> (position[i] &gt; <span class="hljs-number">0</span> &amp;&amp; position[i] &lt; minIndex) {
                minIndex = position[i];
                result = (<span class="hljs-type">char</span>) i;
            }
        }
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<ul>
<li><strong>时间复杂度</strong>：插入O(1)，查询O(1)（固定128次循环）</li>
<li><strong>空间复杂度</strong>：O(1)</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PHP 初学者指南 基础结构与常见错误]]></title>    <link>https://juejin.cn/post/7586942589322248228</link>    <guid>https://juejin.cn/post/7586942589322248228</guid>    <pubDate>2025-12-24T00:10:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586942589322248228" data-draft-id="7586969583782363142" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PHP 初学者指南 基础结构与常见错误"/> <meta itemprop="keywords" content="后端,PHP"/> <meta itemprop="datePublished" content="2025-12-24T00:10:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PHP 初学者指南 基础结构与常见错误
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T00:10:47.000Z" title="Wed Dec 24 2025 00:10:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">PHP 初学者指南 基础结构与常见错误</h2>
<p>PHP(Hypertext Preprocessor)是 Web 开发中使用最广泛的脚本语言之一。无论是构建动态网站还是复杂应用,PHP 通常都是核心。然而对于初学者来说,入门 PHP 可能有点令人生畏。语法特性、最佳实践和各种陷阱混杂在一起,很容易迷失方向。</p>
<p>突然间,我觉得有必要讨论一些非常基础但对刚接触 PHP 的初学者至关重要的内容。许多新手开发者忽视了理解基本结构和 PHP 中常见错误的重要性。虽然这些看起来微不足道,但掌握这些基础知识将帮助你编写更整洁、更高效的代码,并避免可能损害项目的问题。</p>
<p>本文将探讨 PHP 的基本结构,并重点介绍初学者最常犯的一些错误。无论你是刚起步还是有一些经验,理解这些基础知识以及如何避免错误,都将帮助你编写整洁、高效且安全的 PHP 代码。</p>
<p>让我们以简单、清晰且易于理解的方式来分解这些内容。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2025-12%2Fphp-for-beginners-essential-structure-and-common-mistakes" target="_blank" title="https://catchadmin.com/post/2025-12/php-for-beginners-essential-structure-and-common-mistakes" ref="nofollow noopener noreferrer">原文链接 PHP 初学者指南 基础结构与常见错误</a></p>
<h3 data-id="heading-1">PHP 结构:基础知识</h3>
<p>在深入常见错误之前,我们先看看每个初学者都必须理解的 PHP 基本结构。</p>
<h4 data-id="heading-2">PHP 语法</h4>
<p>PHP 代码嵌入在 HTML 中。要在网页中执行 PHP,我们用 <code>&lt;?php ... ?&gt;</code> 标签包裹 PHP 代码。</p>
<p>示例:</p>
<pre><code class="hljs language-php" lang="php">&lt;!DOCTYPE html&gt;
&lt;html lang=<span class="hljs-string">"en"</span>&gt;
&lt;head&gt;
    &lt;meta charset=<span class="hljs-string">"UTF-8"</span>&gt;
    &lt;meta name=<span class="hljs-string">"viewport"</span> content=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;
    &lt;title&gt;PHP Basics&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;Welcome to PHP!&lt;/h1&gt;
    <span class="hljs-meta">&lt;?php</span>
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"Hello, World!"</span>;
    <span class="hljs-meta">?&gt;</span>
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>在上面的示例中,PHP 块 <code>&lt;?php echo "Hello, World!"; ?&gt;</code> 在 HTML body 中生成消息 "Hello, World!"。理解基本语法是编写 PHP 脚本的第一步。</p>
<h4 data-id="heading-3">变量和数据类型</h4>
<p>在 PHP 中,变量以美元符号 <code>$</code> 为前缀,后跟变量名。PHP 是弱类型语言,这意味着声明变量时不需要指定数据类型。类型将根据赋值自动推断。</p>
<p>示例:</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$name</span> = <span class="hljs-string">"John"</span>;      <span class="hljs-comment">// String</span>
<span class="hljs-variable">$age</span> = <span class="hljs-number">30</span>;           <span class="hljs-comment">// Integer</span>
<span class="hljs-variable">$height</span> = <span class="hljs-number">5.9</span>;       <span class="hljs-comment">// Float</span>
<span class="hljs-variable">$isStudent</span> = <span class="hljs-literal">true</span>;   <span class="hljs-comment">// Boolean</span>
</code></pre>
<h4 data-id="heading-4">函数</h4>
<p>PHP 中的函数是可重用的代码块。使用 <code>function</code> 关键字定义它们,这有助于组织和模块化代码。</p>
<p>示例:</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">greet</span>(<span class="hljs-params"><span class="hljs-variable">$name</span></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello, <span class="hljs-subst">$name</span>!"</span>;
}
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">greet</span>(<span class="hljs-string">"Alice"</span>); <span class="hljs-comment">// Outputs: Hello, Alice!</span>
<span class="hljs-meta">?&gt;</span>
</code></pre>
<p>理解如何定义和使用函数将在代码变得更复杂时为你节省大量时间和精力。</p>
<h3 data-id="heading-5">初学者在 PHP 中常犯的错误</h3>
<p>虽然 PHP 是一门强大而灵活的语言,但初学者经常会犯一些常见错误。让我们深入了解一些最常见的陷阱以及如何避免它们。</p>
<h4 data-id="heading-6">忘记使用正确的 PHP 标签</h4>
<p>一个常见错误是忘记正确打开或关闭 PHP 标签。PHP 代码必须始终包含在 <code>&lt;?php ... ?&gt;</code> 中。如果这些标签缺失或不正确,代码将无法运行。</p>
<p>错误示例:</p>
<pre><code class="hljs language-php" lang="php">&lt;html&gt;
&lt;body&gt;
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"Hello, World!"</span>; <span class="hljs-comment">// Error: no PHP opening tag</span>
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>正确示例:</p>
<pre><code class="hljs language-php" lang="php">&lt;html&gt;
&lt;body&gt;
    <span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">echo</span> <span class="hljs-string">"Hello, World!"</span>; <span class="hljs-meta">?&gt;</span>
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h4 data-id="heading-7">字符串中未转义特殊字符</h4>
<p>处理字符串时,需要转义特殊字符,特别是在字符串中使用引号时。否则会导致语法错误。</p>
<p>错误示例:</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$greeting</span> = <span class="hljs-string">"He said, "</span>Hello!<span class="hljs-string">""</span>;
</code></pre>
<p>正确示例:</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$greeting</span> = <span class="hljs-string">"He said, \"Hello!\""</span>;
</code></pre>
<p>或者,可以对外层字符串使用单引号:</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$greeting</span> = <span class="hljs-string">'He said, "Hello!"'</span>;
</code></pre>
<p>这个小错误可能导致代码出现意外行为,所以务必正确处理特殊字符。</p>
<h4 data-id="heading-8">使用错误的比较运算符</h4>
<p>PHP 有两种比较运算符:<code>=</code> 用于赋值,<code>==</code> 用于比较。初学者经常混淆这两者,导致意外结果。</p>
<p>错误示例:</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$age</span> = <span class="hljs-number">30</span>;
<span class="hljs-keyword">if</span> (<span class="hljs-variable">$age</span> = <span class="hljs-number">25</span>) {  <span class="hljs-comment">// Mistake: uses assignment, not comparison</span>
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"Age is 25"</span>;
}
</code></pre>
<p>正确示例:</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$age</span> = <span class="hljs-number">30</span>;
<span class="hljs-keyword">if</span> (<span class="hljs-variable">$age</span> == <span class="hljs-number">25</span>) {  <span class="hljs-comment">// Correct: comparison operator</span>
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"Age is 25"</span>;
}
</code></pre>
<p>在 if 语句中使用赋值运算符 <code>=</code> 会导致错误的条件判断。始终使用 <code>==</code> 进行比较以避免此类错误。</p>
<h4 data-id="heading-9">未使用适当的缩进和代码格式</h4>
<p>虽然 PHP 不强制严格的缩进规则,但未能正确格式化代码会使其难以阅读和调试,特别是随着项目的增长。</p>
<p>错误示例:</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">greet</span>(<span class="hljs-params"><span class="hljs-variable">$name</span></span>)</span>{
      <span class="hljs-keyword">if</span>(<span class="hljs-variable">$name</span>==<span class="hljs-string">"Alice"</span>){<span class="hljs-keyword">echo</span> <span class="hljs-string">"Hello, Alice!"</span>;}<span class="hljs-keyword">else</span>{<span class="hljs-keyword">echo</span> <span class="hljs-string">"Hello, Guest!"</span>;}
    }
<span class="hljs-meta">?&gt;</span>
</code></pre>
<p>正确示例:</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">greet</span>(<span class="hljs-params"><span class="hljs-variable">$name</span></span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$name</span> == <span class="hljs-string">"Alice"</span>) {
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"Hello, Alice!"</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"Hello, Guest!"</span>;
    }
}
<span class="hljs-meta">?&gt;</span>
</code></pre>
<p>正确格式化的代码不仅仅关乎美观——它对可读性和可维护性至关重要。</p>
<h4 data-id="heading-10">不当使用全局变量</h4>
<p>如果不谨慎使用,全局变量可能导致不可预测的行为。通常最好在函数之间显式传递变量,而不是依赖全局作用域。</p>
<p>错误示例:</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$counter</span> = <span class="hljs-number">10</span>;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">increaseCounter</span>(<span class="hljs-params"/>) </span>{
    <span class="hljs-variable">$counter</span>++;  <span class="hljs-comment">// Refers to the global variable</span>
}
<span class="hljs-title function_ invoke__">increaseCounter</span>();
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$counter</span>;  <span class="hljs-comment">// Outputs 11</span>
</code></pre>
<p>更好的做法:</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$counter</span> = <span class="hljs-number">10</span>;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">increaseCounter</span>(<span class="hljs-params"><span class="hljs-variable">$counter</span></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$counter</span> + <span class="hljs-number">1</span>;
}
<span class="hljs-variable">$counter</span> = <span class="hljs-title function_ invoke__">increaseCounter</span>(<span class="hljs-variable">$counter</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$counter</span>;  <span class="hljs-comment">// Outputs 11</span>
</code></pre>
<p>显式传递变量使代码更可预测,更易于调试。</p>
<h3 data-id="heading-11">编写整洁 PHP 代码的最佳实践</h3>
<p>现在我们已经介绍了一些常见错误,让我们探讨一些能帮助你编写更好 PHP 代码的最佳实践。</p>
<h4 data-id="heading-12">使用 isset() 和 empty() 检查变量</h4>
<p>在访问变量之前,检查它是否已设置很重要。使用 <code>isset()</code> 和 <code>empty()</code> 有助于防止访问未定义变量时出错。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$username</span>) &amp;&amp; !<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$username</span>)) {
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"Username is set and not empty."</span>;
}
</code></pre>
<p>这有助于避免意外错误,使代码更健壮。</p>
<h4 data-id="heading-13">始终清理用户输入</h4>
<p>PHP 经常用于处理用户输入,但未经检查的输入可能导致安全漏洞,如 SQL 注入或 XSS 攻击。始终清理和验证用户输入。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$username</span> = <span class="hljs-title function_ invoke__">htmlspecialchars</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'username'</span>]);
</code></pre>
<p>使用 <code>htmlspecialchars()</code> 等函数或数据库查询的预处理语句对于编写安全的 PHP 应用至关重要。</p>
<h4 data-id="heading-14">保持函数小而专注</h4>
<p>理想情况下,一个函数应该执行一项任务并做好它。保持函数小而专注于单一职责,使代码更模块化且更易于测试。</p>
<p>示例:</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetchUserData</span>(<span class="hljs-params"><span class="hljs-variable">$userId</span></span>) </span>{
    <span class="hljs-comment">// Fetch user data from database</span>
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">displayUserProfile</span>(<span class="hljs-params"><span class="hljs-variable">$userData</span></span>) </span>{
    <span class="hljs-comment">// Display user profile information</span>
}
</code></pre>
<p>通过分离关注点,每个函数都变得更易于理解和修改。</p>
<h3 data-id="heading-15">进阶技巧</h3>
<h4 data-id="heading-16">使用命名空间</h4>
<p>随着项目的增长,将代码组织到命名空间中以避免命名冲突变得越来越重要。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">MyApp</span>\<span class="hljs-title class_">Controllers</span>;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserController</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">show</span>(<span class="hljs-params"/>) </span>{
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"Displaying user profile."</span>;
    }
}
</code></pre>
<p>命名空间有助于保持代码组织有序,并防止命名冲突,特别是在大型项目中。</p>
<h4 data-id="heading-17">使用 Composer 进行依赖管理</h4>
<p>PHP 项目通常依赖外部库。Composer 是管理这些依赖的最佳工具。</p>
<pre><code class="hljs language-bash" lang="bash">composer require vendor/package
</code></pre>
<p>Composer 简化了依赖管理,并确保库始终保持最新。</p>
<h3 data-id="heading-18">结语</h3>
<p>掌握 PHP 需要对其结构和常见陷阱有扎实的理解。通过遵循最佳实践并避免错误,你将顺利编写整洁、高效且安全的 PHP 代码。虽然 PHP 一开始可能看起来令人生畏,但有了正确的基础,你很快就能轻松构建强大的应用。</p>
<p>无论你是刚起步还是希望提升技能,这些见解都将帮助你成为更自信、更有能力的 PHP 开发者。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python性能优化实战：7个让代码提速300%的冷门技巧（附基准测试）]]></title>    <link>https://juejin.cn/post/7587175302346899491</link>    <guid>https://juejin.cn/post/7587175302346899491</guid>    <pubDate>2025-12-24T00:18:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587175302346899491" data-draft-id="7586851351470293032" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python性能优化实战：7个让代码提速300%的冷门技巧（附基准测试）"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-24T00:18:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python性能优化实战：7个让代码提速300%的冷门技巧（附基准测试）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T00:18:00.000Z" title="Wed Dec 24 2025 00:18:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Python性能优化实战：7个让代码提速300%的冷门技巧（附基准测试）</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>Python因其简洁易用的语法和丰富的生态系统成为最受欢迎的编程语言之一，但其解释型语言的特性也带来了性能上的挑战。尽管Python的标准实现（CPython）在大多数场景下表现足够优秀，但在处理计算密集型任务时，性能瓶颈往往成为开发者的痛点。</p>
<p>本文将深入探讨7个鲜为人知但极具效果的Python性能优化技巧，这些技巧不仅基于扎实的理论基础，还通过实际基准测试验证了其效果。无论你是数据科学家、后端工程师还是算法开发者，这些技巧都能帮助你显著提升代码执行效率。</p>
<hr/>
<h2 data-id="heading-2">1. 利用<code>__slots__</code>减少内存开销</h2>
<h3 data-id="heading-3">问题背景</h3>
<p>Python的动态特性允许对象随时添加新属性，这是通过<code>__dict__</code>字典实现的。然而，这种灵活性会带来显著的内存开销和访问延迟。</p>
<h3 data-id="heading-4">解决方案</h3>
<p>通过定义<code>__slots__</code>可以显式声明类的属性列表，从而避免创建<code>__dict__</code>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RegularClass</span>:
    <span class="hljs-keyword">pass</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SlotClass</span>:
    __slots__ = [<span class="hljs-string">'x'</span>, <span class="hljs-string">'y'</span>]
</code></pre>
<h3 data-id="heading-5">基准测试</h3>
<p>使用<code>memory_profiler</code>测量内存占用差异：</p>
<ul>
<li><code>RegularClass</code>实例：约1000字节</li>
<li><code>SlotClass</code>实例：约64字节（节省90%+内存）</li>
</ul>
<hr/>
<h2 data-id="heading-6">2. 用生成器表达式替代列表推导式</h2>
<h3 data-id="heading-7">问题背景</h3>
<p>列表推导式会立即生成完整列表，当处理大规模数据时可能导致不必要的内存消耗。</p>
<h3 data-id="heading-8">解决方案</h3>
<p>改用生成器表达式（圆括号代替方括号）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 列表推导式（立即求值）</span>
<span class="hljs-built_in">sum</span>([x*x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10_000_000</span>)])

<span class="hljs-comment"># 生成器表达式（惰性求值）</span>
<span class="hljs-built_in">sum</span>(x*x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10_000_000</span>))
</code></pre>
<h3 data-id="heading-9">基准测试</h3>
<p>处理1000万数据时：</p>
<ul>
<li>列表推导式：峰值内存1.2GB</li>
<li>生成器表达式：峰值内存&lt;10MB</li>
</ul>
<hr/>
<h2 data-id="heading-10">3. 局部变量加速访问</h2>
<h3 data-id="heading-11">Python作用域查找机制</h3>
<p>Python按照LEGB规则查找变量（Local → Enclosing → Global → Builtin），局部变量访问速度远快于全局变量。</p>
<h3 data-id="heading-12">优化方法</h3>
<p>将高频访问的全局变量转为局部变量：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">slow_func</span>():
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10_000_000</span>):
        math.sqrt(i)  <span class="hljs-comment"># Global lookup</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">fast_func</span>():
    sqrt = math.sqrt  <span class="hljs-comment"># Local cache</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10_000_000</span>):
        sqrt(i)
</code></pre>
<h3 data-id="heading-13">基准测试</h3>
<p>提速效果达30%-50%（PyPy中差异更明显）。</p>
<hr/>
<h2 data-id="heading-14">4. NumPy的向量化操作替代循环</h2>
<h3 data-id="heading-15">Python循环的瓶颈</h3>
<p>CPython的解释器开销导致纯Python循环效率低下。</p>
<h3 data-id="heading-16">NumPy的SIMD优势</h3>
<p>利用CPU的单指令多数据流(SIMD)指令并行计算：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np

<span class="hljs-comment"># Python原生循环</span>
result = [x*x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> big_list]

<span class="hljs-comment"># NumPy向量化</span>
result = np.array(big_list)**<span class="hljs-number">2</span>
</code></pre>
<h3 data-id="heading-17">基准测试</h3>
<p>对于1000万规模数据：NumPy比原生循环快200倍以上。</p>
<hr/>
<h2 data-id="heading-18">5. <code>functools.lru_cache</code>缓存重复计算</h2>
<h3 data-id="heading-19">Memoization技术原理</h3>
<p>存储函数调用结果以避免重复计算。适用于递归或昂贵I/O操作场景。</p>
<h3 data-id="heading-20">Python内置实现示例</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> lru_cache

<span class="hljs-meta">@lru_cache(<span class="hljs-params">maxsize=<span class="hljs-number">128</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">fibonacci</span>(<span class="hljs-params">n</span>):
    <span class="hljs-keyword">if</span> n &lt; <span class="hljs-number">2</span>:
        <span class="hljs-keyword">return</span> n
    <span class="hljs-keyword">return</span> fibonacci(n-<span class="hljs-number">1</span>) + fibonacci(n-<span class="hljs-number">2</span>)
</code></pre>
<h3 data-id="heading-21">Benchmark对比结果</h3>
<p>计算fibonacci(35)：无缓存需15秒 vs. LRU缓存仅0.01毫秒。</p>
<hr/>
<p>##6.Pandas优化:避免链式赋值</p>
<p>####常见反模式
链式赋值(chained assignment)会导致Pandas创建临时副本:</p>
<pre><code class="hljs language-python" lang="python">df[df[<span class="hljs-string">'age'</span>]&gt;<span class="hljs-number">30</span>][<span class="hljs-string">'score'</span>]=<span class="hljs-number">100</span> <span class="hljs-comment">#Bad!</span>
</code></pre>
<p>####正确方式
使用`.loc[]单次操作:</p>
<pre><code class="hljs language-python" lang="python">df.loc[df[<span class="hljs-string">'age'</span>]&gt;<span class="hljs-number">30</span>,<span class="hljs-string">'score'</span>]=<span class="hljs-number">100</span> <span class="hljs-comment">#Good!</span>
</code></pre>
<p>####性能影响
大数据集上可减少50%+执行时间并避免SettingWithCopyWarning.</p>
<hr/>
<p>##7.C扩展:Cython/Numba终极加速</p>
<p>####何时需要C扩展？
当其他优化手段仍无法满足性能需求时。</p>
<p>####Numba即时编译示例：
<code>python from numba import jit @jit(nopython=True) def monte_carlo_pi(nsamples): acc=0 ... return4*acc/nsamples </code>
####速度对比：
纯Python:12.3s vs.Numba加速后:0.4s (30倍提升)</p>
<hr/>
<p>##总结</p>
<p>本文介绍的7种技术涵盖了从基础语法到高级工具的完整优化路径：</p>
<p>1️⃣ <strong>内存层面</strong>：通过__slots__降低对象开销；
2️⃣ <strong>控制流层面</strong>：利用生成器延迟计算；
3️⃣ <strong>作用域层面</strong>：局部变量加速访问；
4️⃣ <strong>数值计算</strong>：NumPy向量化操作；
5️⃣ <strong>算法层面</strong>：LRU缓存复用计算结果；
6️⃣ <strong>数据处理</strong>：Pandas最佳实践；
7️⃣ <strong>终极方案</strong>：Numba/Cython编译扩展。</p>
<p>这些技巧的组合使用可以实现300%甚至更高的性能提升——我们的实际案例中曾将一个数据分析流水线从6小时缩短到40分钟！</p>
<p>真正的优化艺术在于平衡可读性与性能收益——永远先用profiler(cProfile/ruby-prof等)定位热点再精准优化！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[局部变量的产生]]></title>    <link>https://juejin.cn/post/7586942589322362916</link>    <guid>https://juejin.cn/post/7586942589322362916</guid>    <pubDate>2025-12-24T00:28:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586942589322362916" data-draft-id="7586663700900888585" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="局部变量的产生"/> <meta itemprop="keywords" content="C++"/> <meta itemprop="datePublished" content="2025-12-24T00:28:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ozyzo"/> <meta itemprop="url" content="https://juejin.cn/user/458965109710202"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            局部变量的产生
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/458965109710202/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ozyzo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T00:28:32.000Z" title="Wed Dec 24 2025 00:28:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">代码如下：</h2>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-comment">// 局部变量的产生</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>{
    <span class="hljs-comment">// 循环变量i，只能在循环的内部使</span>
    <span class="hljs-comment">// 理解为局部变量。</span>
    <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span>( i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">10</span>;i++){
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d"</span>,i);
        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>;j&lt;<span class="hljs-number">3</span>;j++){
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d"</span>,i);
        }
    }
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"i=%d"</span>,i); 
}
</code></pre>
<h2 data-id="heading-1">运行结果如下：</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4800091aaa724747b4f91e48236e4a66~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgb3p5em8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767140911&amp;x-signature=qGY9zQwlukhHy57lv8%2BraJWn6%2Fs%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis集群脑裂问题深度解析与解决方案]]></title>    <link>https://juejin.cn/post/7586851351470309416</link>    <guid>https://juejin.cn/post/7586851351470309416</guid>    <pubDate>2025-12-24T00:31:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586851351470309416" data-draft-id="7587175302346948643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis集群脑裂问题深度解析与解决方案"/> <meta itemprop="keywords" content="Redis"/> <meta itemprop="datePublished" content="2025-12-24T00:31:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis集群脑裂问题深度解析与解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T00:31:26.000Z" title="Wed Dec 24 2025 00:31:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、脑裂问题全景透视</h2>
<h3 data-id="heading-1">1.1 核心概念</h3>
<p>Redis集群脑裂（Split-Brain）是指因网络分区或配置异常导致集群分裂为多个独立子集群，各子集群均认为自身为主节点，形成"双活"或"多活"的异常状态。该问题本质是分布式系统CAP理论中一致性与可用性冲突的典型表现。</p>
<h3 data-id="heading-2">1.2 典型危害</h3>
<ul>
<li><strong>数据灾难</strong>：双主节点写入导致数据覆盖（电商系统数据覆盖导致丢失8%交易数据）</li>
<li><strong>服务中断</strong>：客户端连接风暴引发系统雪崩（金融交易平台平台故障恢复耗时45分钟）</li>
<li><strong>运维灾难</strong>：脑裂恢复后需人工介入数据校验（社交消息系统耗时1周处理对账差异）</li>
</ul>
<h3 data-id="heading-3">1.3 发生场景矩阵</h3>

























<table><thead><tr><th>场景类型</th><th>具体诱因</th><th>典型表现</th></tr></thead><tbody><tr><td><strong>网络分区</strong>​</td><td>机房光纤中断/跨机房路由故障</td><td>哨兵集群分裂选举</td></tr><tr><td><strong>节点异常</strong>​</td><td>主节点CPU过载/内存Swap</td><td>哨兵误判主节点下线</td></tr><tr><td><strong>配置错误</strong>​</td><td>quorum设置不当/超时参数不合理</td><td>自动故障转移失控</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-4">二、脑裂形成机制详解</h2>
<h3 data-id="heading-5">2.1 哨兵模式下的脑裂链条</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3025bcdf6ec84d54885d4275d9fce013~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVTmqZjlrZDnmq4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767141122&amp;x-signature=g4X3GwvX9RD8wbLnFh7HTeuzJd0%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-6">2.2 集群模式下的特殊诱因</h3>
<ul>
<li><strong>Slot分配冲突</strong>：跨机房部署时Slot分布不均</li>
<li><strong>故障转移竞态</strong>：多个节点同时触发选举</li>
<li><strong>数据同步延迟</strong>：异步复制导致数据不一致窗口</li>
</ul>
<hr/>
<h2 data-id="heading-7">三、防御体系构建</h2>
<h3 data-id="heading-8">3.1 配置防御矩阵</h3>
<h4 data-id="heading-9">哨兵模式关键配置</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 哨兵集群配置（3节点部署）</span>
<span class="hljs-string">sentinel</span> <span class="hljs-string">monitor</span> <span class="hljs-string">mymaster</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> <span class="hljs-number">6379 </span><span class="hljs-number">2</span>
<span class="hljs-string">sentinel</span> <span class="hljs-string">down-after-milliseconds</span> <span class="hljs-string">mymaster</span> <span class="hljs-number">5000</span>
<span class="hljs-string">sentinel</span> <span class="hljs-string">parallel-syncs</span> <span class="hljs-string">mymaster</span> <span class="hljs-number">1</span>
<span class="hljs-string">sentinel</span> <span class="hljs-string">auth-pass</span> <span class="hljs-string">mymaster</span> <span class="hljs-string">your_password</span>
</code></pre>
<h4 data-id="heading-10">集群模式增强配置</h4>
<pre><code class="hljs language-lua" lang="lua"># Redis <span class="hljs-number">7.0</span>+配置
cluster-<span class="hljs-built_in">require</span>-full-coverage no
cluster-node-timeout <span class="hljs-number">15000</span>
<span class="hljs-built_in">min</span>-replicas-to-<span class="hljs-built_in">write</span> <span class="hljs-number">2</span>
<span class="hljs-built_in">min</span>-replicas-<span class="hljs-built_in">max</span>-lag <span class="hljs-number">15</span>
</code></pre>
<h3 data-id="heading-11">3.2 网络层加固方案</h3>
<ul>
<li><strong>多路径网络</strong>：部署双活网络链路（如AWS Global Accelerator）</li>
<li><strong>质量监控</strong>：实时检测丢包率（阈值&gt;1%告警）</li>
<li><strong>熔断机制</strong>：网络延迟&gt;200ms时自动降级</li>
</ul>
<h3 data-id="heading-12">3.3 应用层防护策略</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 分布式锁增强方案（Redisson实现）</span>
RLock <span class="hljs-keyword">lock</span> = redisson.getLock(<span class="hljs-string">"order_lock"</span>);
<span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">lock</span>.tryLock(<span class="hljs-number">3</span>, <span class="hljs-number">10</span>, TimeUnit.SECONDS)) {
        <span class="hljs-comment">// 业务逻辑</span>
    }
} <span class="hljs-keyword">catch</span> (InterruptedException e) {
    <span class="hljs-comment">// 异常处理</span>
} <span class="hljs-keyword">finally</span> {
    <span class="hljs-keyword">lock</span>.unlock();
}
</code></pre>
<hr/>
<h2 data-id="heading-13">四、实战案例解析</h2>
<h3 data-id="heading-14">4.1 金融支付系统故障复盘</h3>
<p><strong>故障现象</strong>：</p>
<ul>
<li>支付订单状态出现"已扣款未发货"异常</li>
<li>监控显示两个主节点同时处理写请求</li>
</ul>
<p><strong>处理流程</strong>：</p>
<ol>
<li>
<p><strong>紧急处置</strong>：</p>
<pre><code class="hljs language-objectivec" lang="objectivec"># 冻结写入
redis-cli -h <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> <span class="hljs-built_in">CLUSTER</span> SET-SLOT IMPORTING
redis-cli -h <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.2</span> <span class="hljs-built_in">CLUSTER</span> SET-SLOT EXPORTING
</code></pre>
</li>
<li>
<p><strong>数据校验</strong>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 冲突检测脚本</span>
def detect_conflicts():
    <span class="hljs-attr">keys</span> = redis_scan()
    for key in keys:
        <span class="hljs-attr">val1</span> = get_from_dc1(key)
        <span class="hljs-attr">val2</span> = get_from_dc2(key)
        if val1 != val2:
            log_conflict(key, val1, val2)
</code></pre>
</li>
<li>
<p><strong>恢复策略</strong>：</p>
<ul>
<li>以时间戳最新节点为基准</li>
<li>人工复核冲突数据（涉及资金类数据）</li>
</ul>
</li>
</ol>
<h3 data-id="heading-15">4.2 电商系统优化方案</h3>
<p><strong>架构升级</strong>：</p>
<ul>
<li>哨兵集群从3节点扩展至5节点（跨3机房部署）</li>
<li>启用<code>cluster-allow-replica-migration</code>自动迁移</li>
<li>客户端实现重试逻辑（指数退避策略）</li>
</ul>
<p><strong>效果对比</strong>：</p>

























<table><thead><tr><th>指标</th><th>优化前</th><th>优化后</th></tr></thead><tbody><tr><td>脑裂发生率</td><td>0.2次/月</td><td>0次/季度</td></tr><tr><td>故障恢复时间</td><td>30分钟</td><td>2分钟</td></tr><tr><td>数据丢失率</td><td>0.15%</td><td>0%</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-16">五、高级防御技术</h2>
<h3 data-id="heading-17">5.1 多级锁校验架构</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AntiSplitLock</span> {
    <span class="hljs-keyword">private</span> RedissonClient redisson;
    <span class="hljs-keyword">private</span> Zookeeper zk;
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(String key)</span> {
        <span class="hljs-comment">// 第一关：Redis集群锁</span>
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock1</span> <span class="hljs-operator">=</span> redisson.getLock(key);
        <span class="hljs-keyword">if</span>(!lock1.tryLock(<span class="hljs-number">3</span>, TimeUnit.SECONDS)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        
        <span class="hljs-comment">// 第二关：ZooKeeper锁</span>
        <span class="hljs-type">InterProcessMutex</span> <span class="hljs-variable">lock2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterProcessMutex</span>(zk, <span class="hljs-string">"/locks/"</span>+key);
        <span class="hljs-keyword">if</span>(lock2.acquire(<span class="hljs-number">2</span>, TimeUnit.SECONDS)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">else</span> {
            lock1.unlock();
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
}
</code></pre>
<h3 data-id="heading-18">5.2 数据版本控制</h3>
<pre><code class="hljs language-vbnet" lang="vbnet">def update_with_version(<span class="hljs-keyword">key</span>, value, version):
    pipeline = redis.pipeline()
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        <span class="hljs-keyword">try</span>:
            pipeline.watch(<span class="hljs-keyword">key</span>+<span class="hljs-string">":meta"</span>)
            current_ver = pipeline.<span class="hljs-keyword">get</span>(<span class="hljs-keyword">key</span>+<span class="hljs-string">":meta"</span>)
            <span class="hljs-keyword">if</span> version &lt;= current_ver:
                pipeline.unwatch()
                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
            pipeline.multi()
            pipeline.<span class="hljs-keyword">set</span>(<span class="hljs-keyword">key</span>, value)
            pipeline.incr(<span class="hljs-keyword">key</span>+<span class="hljs-string">":meta"</span>)
            pipeline.execute()
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        except WatchError:
            <span class="hljs-keyword">continue</span>
</code></pre>
<hr/>
<h2 data-id="heading-19">六、运维保障体系</h2>
<h3 data-id="heading-20">6.1 监控指标矩阵</h3>

























<table><thead><tr><th>监控维度</th><th>关键指标</th><th>告警阈值</th></tr></thead><tbody><tr><td>集群状态</td><td>master_link_status</td><td>!= "up"</td></tr><tr><td>数据同步</td><td>repl_backlog_active</td><td>&lt; 1GB</td></tr><tr><td>节点健康</td><td>node_time_skew</td><td>&gt; 100ms</td></tr></tbody></table>
<h3 data-id="heading-21">6.2 自动化恢复流程</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 自动脑裂处理脚本</span>
<span class="hljs-function"><span class="hljs-keyword">if</span> <span class="hljs-title">detect_split_brain</span>()</span>; then
    freeze_writes
    backup_old_master
    elect_new_leader
    sync_data
    resume_writes
fi
</code></pre>
<hr/>
<h2 data-id="heading-22">七、总结与展望</h2>
<p>Redis集群脑裂问题的根治需要构建"配置防御+网络加固+应用防护+智能监控"的四维体系。随着Redis 7.0引入的CRDT（无冲突复制数据类型）和Raft协议增强，未来可通过技术演进从根本上降低脑裂风险。建议生产环境采用"哨兵+集群"混合架构，结合混沌工程定期演练，打造真正高可用的Redis服务。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangGraph1.0速通指南（三）—— LangGraph1.0 自动邮件处理智能体实战]]></title>    <link>https://juejin.cn/post/7586901995429806089</link>    <guid>https://juejin.cn/post/7586901995429806089</guid>    <pubDate>2025-12-24T00:41:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586901995429806089" data-draft-id="7586506307726540810" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangGraph1.0速通指南（三）—— LangGraph1.0 自动邮件处理智能体实战"/> <meta itemprop="keywords" content="人工智能,Agent,LangChain"/> <meta itemprop="datePublished" content="2025-12-24T00:41:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大模型真好玩"/> <meta itemprop="url" content="https://juejin.cn/user/3140624091453053"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangGraph1.0速通指南（三）—— LangGraph1.0 自动邮件处理智能体实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3140624091453053/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大模型真好玩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T00:41:39.000Z" title="Wed Dec 24 2025 00:41:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">前言</h2>
<p>上期内容 <a href="https://juejin.cn/post/7585553799298056238" target="_blank" title="https://juejin.cn/post/7585553799298056238">LangGraph1.0速通指南（二）—— LangGraph1.0 条件边、记忆、人在回路</a> 分享了条件边、智能体记忆和人在回路等核心机制。通过点、边、条件边的组合，大家已经能够搭建起具备记忆能力并支持人工介入的智能体工作流。为了帮助大家更熟练地掌握这些概念，并体会其在真实场景中的应用，本期笔者将把前两期所学的知识——包括状态、节点、边、条件路由、记忆与中断机制——融会贯通，动手构建一个<strong>自动邮件处理智能体</strong>项目。</p>
<p>LangGraph1.0 与先前版本变动不大，预计花费三节左右的时间讲解，同时也要说明笔者的专栏<a href="https://juejin.cn/column/7526240014499495972" target="_blank" title="https://juejin.cn/column/7526240014499495972">《深入浅出LangChain&amp;LangGraph AI Agent 智能体开发》</a>适合所有对 LangChain 感兴趣的学习者，无论之前是否接触过 LangChain。该专栏基于笔者在实际项目中的深度使用经验，系统讲解了使用LangChain/LangGraph如何开发智能体，目前已更新 33 讲，并持续补充实战与拓展内容。欢迎感兴趣的同学关注笔者的掘金账号与专栏，也可关注笔者的同名微信公众号 <strong>大模型真好玩</strong>，每期分享涉及的代码均可在公众号私信: <strong>LangChain智能体开发</strong>免费获取。</p>
<h2 data-id="heading-1">一、电子邮件智能体场景分析</h2>
<h3 data-id="heading-2">1.1 需求分析</h3>
<p>作为一名开发者笔者每天都需要处理大量的工作邮件——包括问题咨询、Bug 报告、账单通知、功能请求等。邮件不仅类型多样，紧急程度也各不相同，手动分类、回复耗时耗力，尤其在忙碌时更容易遗漏或延迟处理。为此笔者希望构建一个<strong>自动邮件处理智能体</strong>，它能够：</p>
<ul>
<li><strong>自动分类</strong>：识别邮件的类型（如问题、Bug、账单、功能请求等）与紧急程度。</li>
<li><strong>智能处理</strong>：根据邮件类型执行相应操作（如为 Bug 创建跟踪工单，为其他问题搜索内部文档获取解答）。</li>
<li><strong>自动生成回复</strong>：基于分类与处理结果，生成有针对性的回复内容。</li>
<li><strong>审核机制</strong>：在必要时（如涉及重要决策或复杂问题）暂停流程，引入人工审核，确保回复准确性与安全性。</li>
</ul>
<p>该智能体将帮助笔者提升邮件处理效率，同时通过“人在回路”保证对自动回复的可控制。</p>
<h3 data-id="heading-3">1.2 根据需求分析设计图</h3>
<p>基于以上需求笔者设计的智能体将具备以下核心功能流程：</p>
<ol>
<li>
<p><strong>邮件提取与解析</strong>：从收件箱获取原始邮件，提取关键内容（发件人、主题、正文等）。</p>
</li>
<li>
<p><strong>自动分类与路由</strong>：对邮件内容进行分类，并依据类别决定后续处理路径。</p>
</li>
<li>
<p><strong>内容处理与生成</strong>：</p>
<ul>
<li>若为 <strong>Bug 报告</strong>，在错误跟踪系统中说明已经收到并跟踪错误；</li>
<li>若为<strong>其他类别</strong>（如问题咨询），则在内部知识库中检索相关答案。</li>
</ul>
</li>
<li>
<p><strong>回复生成与审核</strong>：</p>
<ul>
<li>根据处理结果生成回复草稿；</li>
<li>依据邮件类别与紧急程度，决定是否发送至人工审核节点；</li>
<li>审核通过后自动发送邮件，或由人工修订后发出。</li>
</ul>
</li>
</ol>
<p>整体流程可通过以下示意图概括：</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ed3ff3bded24b13bdc9a68fd4cff84f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767141699&amp;x-signature=YfzhQ7ER5qNt7hprcxw1nGdD5T8%3D" alt="0.png" loading="lazy"/></p>
<h2 data-id="heading-4">二、项目代码编写</h2>
<h3 data-id="heading-5">2.1 定义智能体状态</h3>
<ol>
<li><strong>环境配置与模型初始化：</strong> 首先配置项目环境并初始化大语言模型，本次同样使用deepseek模型，需要提前执行<code>pip install langchain-deepseek</code>安装相关的依赖包，并在项目文件夹下新建<code>.env</code>文件，将注册的DeepSeek API填入该文件中。</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> uuid
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Literal</span>, TypedDict
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv
<span class="hljs-keyword">from</span> langchain_deepseek <span class="hljs-keyword">import</span> ChatDeepSeek
<span class="hljs-keyword">from</span> langgraph.types <span class="hljs-keyword">import</span> Command, interrupt
<span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> END, START, StateGraph
<span class="hljs-keyword">from</span> langgraph.checkpoint.memory <span class="hljs-keyword">import</span> InMemorySaver

load_dotenv()

llm = ChatDeepSeek(
    model=<span class="hljs-string">"deepseek-chat"</span>,
)
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd86f6585fe8462d81c7bdbd1097925f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767141699&amp;x-signature=Zl9xbGyObOKbuSM28xiCdTfnoHI%3D" alt="3.png" loading="lazy"/></p>
<ol start="2">
<li><strong>定义状态数据结构：</strong> 智能体的状态设计需要与工作流节点相匹配，确保每个节点的输入输出都有明确的数据结构。<code>EmailAgentState</code>的设计从上到下分别是读取邮件节点、分类节点、bug追踪节点、文档查询节点、自动撰写节点的相关内容。本项目处理的是单封邮件的独立流程，因此未使用笔者在《<a href="https://juejin.cn/post/7584689488770252835" target="_blank" title="https://juejin.cn/post/7584689488770252835">LangGraph1.0速通指南（一）—— 核心概念、点、边</a>》中介绍的<code>reducer</code>进行状态聚合。但在需要处理连续对话或多轮交互的场景中，<code>reducer</code>机制将是管理状态演进的关键工具。</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 1. 定义图状态State</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">EmailClassification</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    <span class="hljs-comment"># 分类包括问题、错误、账单、功能, 不属于这些功能就分类为复杂</span>
    intent: <span class="hljs-type">Literal</span>[<span class="hljs-string">'question'</span>, <span class="hljs-string">'bug'</span>, <span class="hljs-string">'billing'</span>, <span class="hljs-string">'feature'</span>, <span class="hljs-string">'complex'</span>]
    <span class="hljs-comment"># 紧急程度： 低、中、高、关键</span>
    urgency: <span class="hljs-type">Literal</span>[<span class="hljs-string">'low'</span>, <span class="hljs-string">'medium'</span>, <span class="hljs-string">'high'</span>, <span class="hljs-string">'critical'</span>]
    <span class="hljs-comment"># 邮件主题</span>
    topic: <span class="hljs-built_in">str</span>
    <span class="hljs-comment"># 邮件摘要</span>
    summary: <span class="hljs-built_in">str</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">EmailAgentState</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    <span class="hljs-comment"># 储存读取邮件内容, 发件人邮件地址，邮件ID</span>
    email_content: <span class="hljs-built_in">str</span>
    sender_email: <span class="hljs-built_in">str</span>
    email_id: <span class="hljs-built_in">str</span>

    <span class="hljs-comment"># 分类意图节点的结果，</span>
    classification: EmailClassification

    <span class="hljs-comment"># Bug tracking 错误处理系统只需要查询一些API， 这里就存储一个工单ID即可</span>
    ticket_id: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span>

    <span class="hljs-comment"># 搜索文档结果</span>
    search_results: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>] | <span class="hljs-literal">None</span>
    <span class="hljs-comment"># 客户历史：客户历史是一个字典，键是客户的电子邮件，值是与该客户相关的任何搜索结果</span>
    customer_history: <span class="hljs-built_in">dict</span> | <span class="hljs-literal">None</span>

    <span class="hljs-comment"># 生成内容:</span>
    draft_response: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span>
</code></pre>
<h3 data-id="heading-6">2.2 定义智能体节点</h3>
<ol>
<li><strong>邮件读取与分类节点：</strong> 首先明确读取节点与分类节点的功能。在实际生产环境下，读取节点通常通过调用特定邮箱的 API 实现，但为简化流程，笔者在此略过该节点，直接将邮件内容输入至后续分类节点。分类节点通过预设提示词，调用 DeepSeek 大模型对邮件进行分类。LangChain1.0 支持便捷的大模型结构化输出，具体方法笔者不再展开，如需深入了解可参考此前分享：<a href="https://juejin.cn/post/7567301894648004648" target="_blank" title="https://juejin.cn/post/7567301894648004648">LangChain1.0速通指南（一）——LangChain1.0核心升级</a>。</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">read_email</span>(<span class="hljs-params">state: EmailAgentState</span>) -&gt; EmailAgentState:
    <span class="hljs-string">'''
    实际生产中这一步要从邮箱提供的api中提取电子邮件，这里仅仅是演示，
    会将电子邮件直接传给分类节点，该函数简写
    '''</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">classify_intent</span>(<span class="hljs-params">state: EmailAgentState</span>) -&gt; EmailAgentState:
    <span class="hljs-string">"用大模型进行节点分类和紧急程度识别，然后依据结果路由"</span>

    structured_llm = llm.with_structured_output(EmailClassification)

    classification_pormpt = <span class="hljs-string">f"""
    分析用户输入的邮件并进行分类
    
    邮件: <span class="hljs-subst">{state[<span class="hljs-string">'email_content'</span>]}</span>
    来自: <span class="hljs-subst">{state[<span class="hljs-string">'sender_email'</span>]}</span>
    
    提供分类、紧急程度、主题和内容摘要
    """</span>

    classication = structured_llm.invoke(classification_pormpt)

    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">'classification'</span>: classication
    }
</code></pre>
<ol start="2">
<li><strong>知识库搜索节点：</strong>  目前搜索节点仅为功能模拟，在实际部署时，可替换为对接真实知识库的检索接口。该节点接收并依据上一节点（即分类节点）输出的状态信息，从中提取邮件意图与主题，进而模拟在内部知识库中执行检索的过程。</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">search_documentation</span>(<span class="hljs-params">state: EmailAgentState</span>) -&gt; EmailAgentState:
    <span class="hljs-string">'''
    查询知识库节点，这里模拟操作
    '''</span>
    classification = state.get(<span class="hljs-string">'classification'</span>, {})

    query = <span class="hljs-string">f"<span class="hljs-subst">{classification.get(<span class="hljs-string">'intent'</span>, <span class="hljs-string">''</span>)}</span>  <span class="hljs-subst">{classification.get(<span class="hljs-string">'topic'</span>, <span class="hljs-string">''</span>)}</span>"</span>

    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 模拟查询的逻辑</span>
        search_results = [
            <span class="hljs-string">'search_result_1'</span>,
            <span class="hljs-string">'search_result_2'</span>,
            <span class="hljs-string">'search_result_3'</span>
        ]
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        search_results = [<span class="hljs-string">f'搜索接口不可用'</span>]

    <span class="hljs-keyword">return</span> {<span class="hljs-string">'search_results'</span>: search_results}
</code></pre>
<ol start="3">
<li><strong>Bug跟踪节点：</strong> 模拟跟踪的内容，创建跟踪工单</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">bug_tracking</span>(<span class="hljs-params">state: EmailAgentState</span>) -&gt; EmailAgentState:
    <span class="hljs-string">'''
    模拟bug修复的相关内容
    '''</span>
    ticket_id = <span class="hljs-string">f"Bug-<span class="hljs-subst">{uuid.uuid4()}</span> fixed"</span>
    <span class="hljs-keyword">return</span> {<span class="hljs-string">'ticket_id'</span>: ticket_id}
</code></pre>
<ol start="4">
<li><strong>回复生成节点：</strong> 节点接收来自搜索节点的信息（如原始检索结果、以换行符连接的客户历史记录等），并将其作为上下文参考，指导大模型的回复生成。大模型基于邮件分类、紧急程度及所附的参考信息，生成拟回复的邮件内容。除了生成回复内容，该节点还会输出一个<strong>处理命令</strong>。该命令将根据邮件的类别与紧急程度，自动判断下一步应执行的操作——例如“直接发送回复”或“转交人工审核”。</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">write_response</span>(<span class="hljs-params">state: EmailAgentState</span>) -&gt; Command[<span class="hljs-type">Literal</span>[<span class="hljs-string">'human_review'</span>, <span class="hljs-string">'send_reply'</span>]]:
    <span class="hljs-string">'''
    根据分类结果、搜索结果等中间结果生产报告
    '''</span>
    classification = state.get(<span class="hljs-string">'classification'</span>, {})

    context_sections = []

    <span class="hljs-keyword">if</span> state.get(<span class="hljs-string">'search_results'</span>):
        formatted_docs = <span class="hljs-string">"\n"</span>.join([<span class="hljs-string">f"- <span class="hljs-subst">{doc}</span>"</span> <span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> state[<span class="hljs-string">'search_results'</span>]])
        context_sections.append(<span class="hljs-string">f"相关内容:\n<span class="hljs-subst">{formatted_docs}</span>"</span>)
    <span class="hljs-keyword">if</span> state.get(<span class="hljs-string">'customer_history'</span>):
        context_sections.append(<span class="hljs-string">f"Customer tier: <span class="hljs-subst">{state[<span class="hljs-string">'customer_history'</span>].get(<span class="hljs-string">'tier'</span>, <span class="hljs-string">'standard'</span>)}</span>"</span>)

    
    <span class="hljs-comment"># 构建提示词</span>
    draft_prompt = <span class="hljs-string">f"""
        撰写50字邮件回复:
        邮件内容: <span class="hljs-subst">{state.get(<span class="hljs-string">'email_content'</span>)}</span>
        
        邮件分类: <span class="hljs-subst">{classification.get(<span class="hljs-string">'intent'</span>, <span class="hljs-string">'unkown'</span>)}</span>
        紧急程度: <span class="hljs-subst">{classification.get(<span class="hljs-string">'urgency'</span>, <span class="hljs-string">'medium'</span>)}</span>
        
        <span class="hljs-subst">{<span class="hljs-built_in">chr</span>(<span class="hljs-number">10</span>).join(context_sections)}</span>
    """</span>

    response = llm.invoke(draft_prompt)

    <span class="hljs-comment"># 根据紧急程度决定是否需要人类审核</span>
    needs_review = (
        classification.get(<span class="hljs-string">'urgency'</span>) <span class="hljs-keyword">in</span> [<span class="hljs-string">'high'</span>, <span class="hljs-string">'critical'</span>] <span class="hljs-keyword">or</span>
        classification.get(<span class="hljs-string">'intent'</span>) == <span class="hljs-string">'complex'</span>
    )

    <span class="hljs-keyword">if</span> needs_review:
        goto = <span class="hljs-string">'human_review'</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'需要人工审核'</span>)
    <span class="hljs-keyword">else</span>:
        goto = <span class="hljs-string">'send_reply'</span>

    <span class="hljs-keyword">return</span> Command(
        update={<span class="hljs-string">'draft_response'</span>: response.content},
        goto=goto
    )
</code></pre>
<ol start="5">
<li><strong>人工审核节点和回复节点：</strong> 流程执行至该节点时，系统将自动暂停并等待人工输入。只有在邮件紧急程度为紧急或分类结果为复杂情况下，才会进入工作节点来人工确认。该节点采用中断机制，根据人工反馈的指令，节点将返回相应的路由命令，引导流程走向“结束”或“发送回复”分支。回复节点笔者这里只模拟自动发送邮件。</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">human_review</span>(<span class="hljs-params">state: EmailAgentState</span>) -&gt; Command[<span class="hljs-type">Literal</span>[<span class="hljs-string">'send_reply'</span>, END]]:
    <span class="hljs-string">'''
    人类审查节点，审查结束后决定是否要回复该邮件
    '''</span>
    classification = state.get(<span class="hljs-string">'classification'</span>, {})

    human_decision = interrupt({
        <span class="hljs-string">"邮件ID"</span>: state[<span class="hljs-string">'email_id'</span>],
        <span class="hljs-string">"原始邮件内容"</span>: state[<span class="hljs-string">'email_content'</span>],
        <span class="hljs-string">"自动回复内容"</span>: state[<span class="hljs-string">'draft_response'</span>],
        <span class="hljs-string">'紧急程度'</span>: classification[<span class="hljs-string">'urgency'</span>],
        <span class="hljs-string">'分类'</span>: classification[<span class="hljs-string">'intent'</span>],
        <span class="hljs-string">'下一步'</span>: <span class="hljs-string">'请审核是否同意发送该邮件'</span>
    })

    <span class="hljs-keyword">if</span> human_decision==<span class="hljs-string">'approved'</span>:
        <span class="hljs-keyword">return</span> Command(
            update={},
            goto=<span class="hljs-string">'send_reply'</span>
        )
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> Command(
            update={},
            goto=END
        )

<span class="hljs-keyword">def</span> <span class="hljs-title function_">send_reply</span>(<span class="hljs-params">state: EmailAgentState</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'---成功发送---'</span>)
</code></pre>
<h3 data-id="heading-7">2.3 构建智能体图</h3>
<p>具备以上节点函数后，通过边将节点函数相连接构造智能体。智能体定义遵循 <a href="https://juejin.cn/creator/content/article/essays?status=all" target="_blank" title="https://juejin.cn/creator/content/article/essays?status=all">LangGraph1.0速通指南（一）—— LangGraph1.0 核心概念、点、边</a>讲解的三步骤：定义状态、添加节点、添加边。同时由于需要使用中断机制，还需要添加内存检查点。</p>
<pre><code class="hljs language-python" lang="python">builder = StateGraph(EmailAgentState)

builder.add_node(<span class="hljs-string">"read_email"</span>, read_email)
builder.add_node(<span class="hljs-string">"classify_intent"</span>, classify_intent)
builder.add_node(<span class="hljs-string">"search_documentation"</span>,search_documentation)
builder.add_node(<span class="hljs-string">"bug_tracking"</span>, bug_tracking)
builder.add_node(<span class="hljs-string">"write_response"</span>, write_response)
builder.add_node(<span class="hljs-string">"human_review"</span>,human_review)
builder.add_node(<span class="hljs-string">"send_reply"</span>, send_reply)

builder.add_edge(START, <span class="hljs-string">"read_email"</span>)
builder.add_edge(<span class="hljs-string">"read_email"</span>,<span class="hljs-string">"classify_intent"</span>)
builder.add_edge(<span class="hljs-string">"classify_intent"</span>,<span class="hljs-string">"search_documentation"</span>)
builder.add_edge(<span class="hljs-string">"classify_intent"</span>,<span class="hljs-string">"bug_tracking"</span>)
builder.add_edge(<span class="hljs-string">"search_documentation"</span>,<span class="hljs-string">"write_response"</span>)
builder.add_edge(<span class="hljs-string">"bug_tracking"</span>,<span class="hljs-string">"write_response"</span>)
builder.add_edge(<span class="hljs-string">"send_reply"</span>,END)

memory=InMemorySaver()
app = builder.<span class="hljs-built_in">compile</span>(checkpointer=memory)
</code></pre>
<h2 data-id="heading-8">三、 智能体测试与验证</h2>
<p>为了验证笔者构建的邮件处理智能体是否按预期工作，下面通过两个典型场景进行测试：高紧急度Bug报告和常规问候邮件。</p>
<h3 data-id="heading-9">3.1 Bug报告处理测试</h3>
<p>测试一个需要人工审核的高优先级Bug报告，预期的处理流程如下：</p>
<ul>
<li>由于邮件内容包含"紧急Bug"，分类节点会将其识别为<code>intent: bug</code>且<code>urgency: critical</code></li>
<li>工作流会创建Bug工单，然后进入<code>human_review</code>节点等待审核</li>
<li>系统会打印中断信息并等待人工输入</li>
<li>根据人工决策，邮件将被发送或终止</li>
</ul>
<pre><code class="hljs language-python" lang="python">initial_state = {
    <span class="hljs-string">"email_content"</span>: <span class="hljs-string">"我遇到了一个紧急bug, 有客户重复订阅了一个产品"</span>,
    <span class="hljs-string">"sender_email"</span>: <span class="hljs-string">"test@163.com"</span>,
    <span class="hljs-string">"email_id"</span>: <span class="hljs-string">"email_123"</span>
}

config = {<span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"thread_id"</span>: <span class="hljs-string">"customer_123"</span>}}
result = app.invoke(initial_state, config=config)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f'准备审核的回复内容:<span class="hljs-subst">{result[<span class="hljs-string">'draft_response'</span>]}</span>...\n'</span>)
<span class="hljs-keyword">if</span> <span class="hljs-string">'__interrupt__'</span> <span class="hljs-keyword">in</span> result:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'Interrupt:<span class="hljs-subst">{result}</span>'</span>)
    msg = result[<span class="hljs-string">'__interrupt__'</span>][-<span class="hljs-number">1</span>].value
    <span class="hljs-built_in">print</span>(msg)
    human = <span class="hljs-built_in">input</span>(<span class="hljs-string">f"请输入: "</span>)
    human_response = Command(
        resume=human
    )
    final_result = app.invoke(human_response, config)
</code></pre>
<p>从运行结果来看，工作流成功识别出紧急Bug，创建了工单并生成了回复草稿。由于紧急程度为"critical"，系统正确触发了人工审核中断：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2accfc253e654876b30940ff398e4801~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767141699&amp;x-signature=xnFBjPMV39WHPQFMfWsuHQPDVAs%3D" alt="1.png" loading="lazy"/></p>
<h3 data-id="heading-10">3.2：常规问候处理流程</h3>
<p>测试一个无需审核的普通问候邮件，预期结果如下:</p>
<ul>
<li>问候邮件会被分类为<code>intent: question</code>且<code>urgency: low</code></li>
<li>工作流将跳过人工审核节点，直接生成并发送回复</li>
<li>整个过程完全自动化，无需人工干预</li>
</ul>
<pre><code class="hljs language-python" lang="python">initial_state = {
    <span class="hljs-string">"email_content"</span>: <span class="hljs-string">"你好呀，我是新同事苍井空"</span>,
    <span class="hljs-string">"sender_email"</span>: <span class="hljs-string">"test@163.com"</span>,
    <span class="hljs-string">"email_id"</span>: <span class="hljs-string">"email_123"</span>
}

config = {<span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"thread_id"</span>: <span class="hljs-string">"customer_123"</span>}}
result = app.invoke(initial_state, config=config)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f'准备审核的回复内容:<span class="hljs-subst">{result[<span class="hljs-string">'draft_response'</span>]}</span>...\n'</span>)
<span class="hljs-keyword">if</span> <span class="hljs-string">'__interrupt__'</span> <span class="hljs-keyword">in</span> result:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'Interrupt:<span class="hljs-subst">{result}</span>'</span>)
    msg = result[<span class="hljs-string">'__interrupt__'</span>][-<span class="hljs-number">1</span>].value
    <span class="hljs-built_in">print</span>(msg)
    human = <span class="hljs-built_in">input</span>(<span class="hljs-string">f"请输入: "</span>)
    human_response = Command(
        resume=human
    )
    final_result = app.invoke(human_response, config)
</code></pre>
<p>从运行结果可以看出系统正确识别出低优先级问候邮件，自动生成友好回复并直接发送，无需人工介入：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f77929f98e4942de88cb65a5fb216f64~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767141699&amp;x-signature=vJ3xobrmdGZ23x%2F4qdpyIYrKwCI%3D" alt="2.png" loading="lazy"/></p>
<p>完整代码大家可以关注笔者的同名微信公众号 <strong>大模型真好玩</strong>，并私信: <strong>LangChain智能体开发</strong>免费获取。</p>
<h2 data-id="heading-11">四、总结</h2>
<p>本文通过构建自动邮件处理智能体，系统演示了LangGraph1.0的状态管理、条件路由、人在回路等核心机制在实战中的应用。相信大家经过实战，能更加掌握LangGraph1.0编写智能体的核心技巧。</p>
<p><a href="https://juejin.cn/column/7526240014499495972" target="_blank" title="https://juejin.cn/column/7526240014499495972">《深入浅出LangChain&amp;LangGraph AI Agent 智能体开发》</a>专栏内容源自笔者在实际学习和工作中对 LangChain 与 LangGraph 的深度使用经验，旨在帮助大家系统性地、高效地掌握 AI Agent 的开发方法，在各大技术平台获得了不少关注与支持。目前已更新33讲，正在更新LangGraph1.0速通指南，并随时补充笔者在实际工作中总结的拓展知识点。如果大家感兴趣，欢迎关注笔者的掘金账号与专栏，也可关注笔者的同名微信公众号 <strong>大模型真好玩</strong>，每期分享涉及的代码均可在公众号私信: <strong>LangChain智能体开发</strong>免费获取。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文搞懂柯里化：函数式编程技巧的解析和实践案例]]></title>    <link>https://juejin.cn/post/7586969583782395910</link>    <guid>https://juejin.cn/post/7586969583782395910</guid>    <pubDate>2025-12-24T00:43:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586969583782395910" data-draft-id="7576483553879425050" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文搞懂柯里化：函数式编程技巧的解析和实践案例"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-12-24T00:43:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏多多"/> <meta itemprop="url" content="https://juejin.cn/user/747323639737191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文搞懂柯里化：函数式编程技巧的解析和实践案例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/747323639737191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏多多
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T00:43:33.000Z" title="Wed Dec 24 2025 00:43:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><h2 data-id="heading-0">1. 什么是柯里化</h2>
<p>柯里化（Currying）是函数式编程中的一种重要技术，它将一个接收多个参数的函数转换为一系列只接收单个参数的函数的过程。我们常用的Lodash，里面就包含很多柯里化的应用。通过柯里化，我们可以将原本需要一次性传入所有参数的函数，转换为可以分多次传入参数的形式，每次传入一个参数就返回一个新的函数，直到所有参数都传入后才执行最终的计算。</p>
<p>举个简单的例子，一个接收三个参数的函数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b, c</span>) {
  <span class="hljs-keyword">return</span> a + b + c;
}
</code></pre>
<p>经过柯里化后，我们可以这样调用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>)(<span class="hljs-number">2</span>)(<span class="hljs-number">3</span>); <span class="hljs-comment">// 6</span>
</code></pre>
<p>或者分步骤调用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> add1 = <span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>);
<span class="hljs-keyword">const</span> add1And2 = <span class="hljs-title function_">add1</span>(<span class="hljs-number">2</span>);
<span class="hljs-keyword">const</span> result = <span class="hljs-title function_">add1And2</span>(<span class="hljs-number">3</span>); <span class="hljs-comment">// 6</span>
</code></pre>
<p>这就是柯里化的核心思想：将多参数函数转化为单参数函数的序列。</p>
<h2 data-id="heading-1">2.实现方式</h2>
<p>在JavaScript中，我们可以手动实现函数的柯里化，也可以创建一个通用的柯里化工具函数。</p>
<h3 data-id="heading-2">2.1. 手动柯里化</h3>
<p>针对特定函数进行柯里化：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">b</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">c</span>) {
      <span class="hljs-keyword">return</span> a + b + c;
    };
  };
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>)(<span class="hljs-number">2</span>)(<span class="hljs-number">3</span>)); <span class="hljs-comment">// 6</span>
</code></pre>
<h3 data-id="heading-3">2.2. 通用柯里化函数</h3>
<p>创建一个可以将任何函数柯里化的工具：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">curry</span>(<span class="hljs-params">fn</span>) {
  <span class="hljs-comment">// 获取原函数的参数长度</span>
  <span class="hljs-keyword">const</span> arity = fn.<span class="hljs-property">length</span>;
  
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">curried</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-comment">// 如果传入的参数足够，直接调用原函数</span>
    <span class="hljs-keyword">if</span> (args.<span class="hljs-property">length</span> &gt;= arity) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">fn</span>(...args);
    }
    
    <span class="hljs-comment">// 否则返回一个新函数，等待接收更多参数</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...moreArgs</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">curried</span>(...args.<span class="hljs-title function_">concat</span>(moreArgs));
    };
  };
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">sum</span> = (<span class="hljs-params">a, b, c</span>) =&gt; a + b + c;
<span class="hljs-keyword">const</span> curriedSum = <span class="hljs-title function_">curry</span>(sum);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">curriedSum</span>(<span class="hljs-number">1</span>)(<span class="hljs-number">2</span>)(<span class="hljs-number">3</span>)); <span class="hljs-comment">// 6</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">curriedSum</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)(<span class="hljs-number">3</span>)); <span class="hljs-comment">// 6</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">curriedSum</span>(<span class="hljs-number">1</span>)(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>)); <span class="hljs-comment">// 6</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">curriedSum</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)); <span class="hljs-comment">// 6</span>
</code></pre>
<p>这个通用柯里化函数的优点是可以处理任意参数数量的函数，并且支持分批传入多个参数。</p>
<h2 data-id="heading-4">3. 柯里化的用途</h2>
<p>柯里化在实际开发中有许多实用场景：</p>
<h3 data-id="heading-5">3.1. 参数复用</h3>
<p>通过柯里化，我们可以固定某些参数，实现参数的复用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 普通函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">greeting, name</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${greeting}</span>, <span class="hljs-subst">${name}</span>!`</span>;
}

<span class="hljs-comment">// 柯里化后</span>
<span class="hljs-keyword">const</span> curriedGreet = <span class="hljs-title function_">curry</span>(greet);

<span class="hljs-comment">// 创建特定问候语的函数</span>
<span class="hljs-keyword">const</span> sayHello = <span class="hljs-title function_">curriedGreet</span>(<span class="hljs-string">'Hello'</span>);
<span class="hljs-keyword">const</span> sayHi = <span class="hljs-title function_">curriedGreet</span>(<span class="hljs-string">'Hi'</span>);

<span class="hljs-comment">// 复用固定的问候语参数</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">sayHello</span>(<span class="hljs-string">'Alice'</span>)); <span class="hljs-comment">// "Hello, Alice!"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">sayHello</span>(<span class="hljs-string">'Bob'</span>));   <span class="hljs-comment">// "Hello, Bob!"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">sayHi</span>(<span class="hljs-string">'Charlie'</span>));  <span class="hljs-comment">// "Hi, Charlie!"</span>
</code></pre>
<h3 data-id="heading-6">3.2. 延迟执行</h3>
<p>柯里化允许我们延迟函数的执行，直到收集到所有必要的参数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 日志函数，需要级别、消息和时间</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">log</span>(<span class="hljs-params">level, message, timestamp</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[<span class="hljs-subst">${timestamp}</span>] <span class="hljs-subst">${level}</span>: <span class="hljs-subst">${message}</span>`</span>);
}

<span class="hljs-keyword">const</span> curriedLog = <span class="hljs-title function_">curry</span>(log);

<span class="hljs-comment">// 固定日志级别</span>
<span class="hljs-keyword">const</span> errorLog = <span class="hljs-title function_">curriedLog</span>(<span class="hljs-string">'ERROR'</span>);

<span class="hljs-comment">// 后续调用只需要消息，时间可以在最后统一添加</span>
<span class="hljs-keyword">const</span> loginError = <span class="hljs-title function_">errorLog</span>(<span class="hljs-string">'Login failed'</span>);

<span class="hljs-comment">// 最后传入时间参数，执行日志输出</span>
<span class="hljs-title function_">loginError</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>());
</code></pre>
<h3 data-id="heading-7">3.3. 函数组合</h3>
<p>柯里化是函数组合的基础，能够让我们更灵活地组合多个函数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 工具函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">add</span> = (<span class="hljs-params">a, b</span>) =&gt; a + b;
<span class="hljs-keyword">const</span> <span class="hljs-title function_">multiply</span> = (<span class="hljs-params">a, b</span>) =&gt; a * b;

<span class="hljs-comment">// 柯里化工具函数</span>
<span class="hljs-keyword">const</span> curriedAdd = <span class="hljs-title function_">curry</span>(add);
<span class="hljs-keyword">const</span> curriedMultiply = <span class="hljs-title function_">curry</span>(multiply);

<span class="hljs-comment">// 创建特定功能的函数</span>
<span class="hljs-keyword">const</span> add5 = <span class="hljs-title function_">curriedAdd</span>(<span class="hljs-number">5</span>);
<span class="hljs-keyword">const</span> multiplyBy2 = <span class="hljs-title function_">curriedMultiply</span>(<span class="hljs-number">2</span>);

<span class="hljs-comment">// 组合函数：先加5，再乘以2</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">add5ThenMultiplyBy2</span> = (<span class="hljs-params">x</span>) =&gt; <span class="hljs-title function_">multiplyBy2</span>(<span class="hljs-title function_">add5</span>(x));

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">add5ThenMultiplyBy2</span>(<span class="hljs-number">3</span>)); <span class="hljs-comment">// (3 + 5) * 2 = 16</span>
</code></pre>
<h3 data-id="heading-8">3.4. 事件处理中的应用</h3>
<p>在事件处理中，柯里化可以方便地传递额外参数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 柯里化的事件处理函数</span>
<span class="hljs-keyword">const</span> handleClick = <span class="hljs-title function_">curry</span>(<span class="hljs-function">(<span class="hljs-params">message, event</span>) =&gt;</span> {
  event.<span class="hljs-title function_">preventDefault</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(message);
});

<span class="hljs-comment">// 为不同按钮绑定不同消息的点击事件</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'btn1'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-title function_">handleClick</span>(<span class="hljs-string">'Button 1 clicked'</span>));
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'btn2'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-title function_">handleClick</span>(<span class="hljs-string">'Button 2 clicked'</span>));
</code></pre>
<h2 data-id="heading-9">4. 柯里化的优缺点</h2>
<p>优点：</p>
<ul>
<li>
<p><strong>提高代码复用性</strong>：通过固定部分参数，可以创建具有特定功能的新函数。</p>
</li>
<li>
<p><strong>增强函数灵活性</strong>：可以根据需要分阶段传入参数，而不必一次性提供所有参数。</p>
</li>
<li>
<p><strong>便于函数组合</strong>：柯里化的函数更容易进行组合，创建更复杂的逻辑。</p>
</li>
<li>
<p><strong>延迟执行</strong>：允许我们在需要的时候才执行函数，有助于处理异步操作。</p>
</li>
<li>
<p><strong>清晰的参数顺序</strong>：柯里化促使我们思考参数的合理顺序，通常将变化较少的参数放在前面，变化较多的参数放在后面，便于复用。</p>
</li>
</ul>
<p>缺点：</p>
<ul>
<li>
<p><strong>增加代码复杂性</strong>：柯里化会使函数调用链变长，可能降低代码的可读性。</p>
</li>
<li>
<p><strong>调试难度增加</strong>：多层嵌套的函数调用会使调试过程变得复杂。</p>
</li>
<li>
<p><strong>性能影响</strong>：柯里化涉及多个函数的创建和调用，可能会有轻微的性能损耗。</p>
</li>
<li>
<p><strong>不适合所有场景</strong>：对于参数数量不确定或经常需要传入不同数量参数的函数，柯里化可能不是最佳选择。</p>
</li>
</ul>
<h2 data-id="heading-10">5. 柯里化与部分应用的区别</h2>
<p>柯里化常常与部分应用（Partial Application）混淆，但它们是不同的概念：</p>
<ul>
<li><strong>柯里化</strong>：将一个接收n个参数的函数转换为n个只接收一个参数的函数序列。</li>
<li><strong>部分应用</strong>：固定函数的部分参数，返回一个接收剩余参数的新函数。</li>
</ul>
<p>例如，对于一个接收3个参数的函数：</p>
<ul>
<li>柯里化版本：<code>fn(a)(b)(c)</code></li>
<li>部分应用版本：<code>partial(fn, a, b)(c)</code> 或 <code>partial(fn, a)(b, c)</code></li>
</ul>
<p>简单来说，柯里化总是将函数转换为一系列单参数函数，而部分应用则可以固定任意数量的参数。</p>
<h2 data-id="heading-11">6. 实际应用案例</h2>
<p>下面是一些可能会碰到的实际应用案例：</p>
<h3 data-id="heading-12">6.1. 表单验证</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 柯里化的验证函数</span>
<span class="hljs-keyword">const</span> validate = <span class="hljs-title function_">curry</span>(<span class="hljs-function">(<span class="hljs-params">rule, value</span>) =&gt;</span> {
  <span class="hljs-keyword">switch</span>(rule) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'required'</span>:
      <span class="hljs-keyword">return</span> value !== <span class="hljs-string">''</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'minLength'</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">min</span>) =&gt;</span> value.<span class="hljs-property">length</span> &gt;= min;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'isEmail'</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-regexp">/^[^\s@]+@[^\s@]+\.[^\s@]+$/</span>.<span class="hljs-title function_">test</span>(value);
    <span class="hljs-attr">default</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
});

<span class="hljs-comment">// 创建特定的验证器</span>
<span class="hljs-keyword">const</span> isRequired = <span class="hljs-title function_">validate</span>(<span class="hljs-string">'required'</span>);
<span class="hljs-keyword">const</span> minLength5 = <span class="hljs-title function_">validate</span>(<span class="hljs-string">'minLength'</span>)(<span class="hljs-number">5</span>);
<span class="hljs-keyword">const</span> isEmail = <span class="hljs-title function_">validate</span>(<span class="hljs-string">'isEmail'</span>);

<span class="hljs-comment">// 使用验证器</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">isRequired</span>(<span class="hljs-string">'test'</span>));      <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">isRequired</span>(<span class="hljs-string">''</span>));          <span class="hljs-comment">// false</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">minLength5</span>(<span class="hljs-string">'hello'</span>));     <span class="hljs-comment">// true (长度为5)</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">minLength5</span>(<span class="hljs-string">'hi'</span>));        <span class="hljs-comment">// false (长度为2)</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">isEmail</span>(<span class="hljs-string">'test@example.com'</span>)); <span class="hljs-comment">// true</span>
</code></pre>
<h3 data-id="heading-13">6.2. API请求封装</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 基础请求函数</span>
<span class="hljs-keyword">const</span> request = <span class="hljs-title function_">curry</span>(<span class="hljs-function">(<span class="hljs-params">method, url, data</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(url, {
    method,
    <span class="hljs-attr">body</span>: data ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data) : <span class="hljs-literal">undefined</span>,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>
    }
  }).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>());
});

<span class="hljs-comment">// 创建特定HTTP方法的请求函数</span>
<span class="hljs-keyword">const</span> get = <span class="hljs-title function_">request</span>(<span class="hljs-string">'GET'</span>);
<span class="hljs-keyword">const</span> post = <span class="hljs-title function_">request</span>(<span class="hljs-string">'POST'</span>);
<span class="hljs-keyword">const</span> put = <span class="hljs-title function_">request</span>(<span class="hljs-string">'PUT'</span>);
<span class="hljs-keyword">const</span> del = <span class="hljs-title function_">request</span>(<span class="hljs-string">'DELETE'</span>);

<span class="hljs-comment">// 创建特定资源的请求函数</span>
<span class="hljs-keyword">const</span> getUser = <span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/users'</span>);
<span class="hljs-keyword">const</span> createUser = <span class="hljs-title function_">post</span>(<span class="hljs-string">'/api/users'</span>);
<span class="hljs-keyword">const</span> updateUser = put;

<span class="hljs-comment">// 使用</span>
<span class="hljs-title function_">getUser</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user));
<span class="hljs-title function_">createUser</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'John'</span> }).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">newUser</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newUser));
<span class="hljs-title function_">updateUser</span>(<span class="hljs-string">'/api/users/1'</span>, { <span class="hljs-attr">name</span>: <span class="hljs-string">'John Doe'</span> });
</code></pre>
<h2 data-id="heading-14">7. 总结</h2>
<p>柯里化是函数式编程中的一项强大技术，它通过将多参数函数转换为一系列单参数函数，提供了更高的灵活性和代码复用性。虽然柯里化会增加一些代码复杂性，但在适当的场景下，它能显著提升代码的可读性和可维护性。在实际开发中，我们应该根据具体场景灵活运用柯里化，平衡其带来的好处与可能的复杂性增加。</p>
<hr/>
<blockquote>
<p>本次分享就到这儿啦，我是鹏多多，深耕前端的技术创作者，如果您看了觉得有帮助，欢迎评论，关注，点赞，转发，我们下次见~</p>
</blockquote>
<p>PS：在本页按F12，在console中输入document.getElementsByClassName('panel-btn')[0].click();有惊喜哦~</p>
<p><code>往期文章</code></p>
<ul>
<li><a href="https://juejin.cn/post/7568192652286754870" target="_blank" title="https://juejin.cn/post/7568192652286754870">纯前端提取图片颜色插件Color-Thief教学+实战完整指南</a></li>
<li><a href="https://juejin.cn/post/7565737512816771135" target="_blank" title="https://juejin.cn/post/7565737512816771135">react-konva实战指南：Canvas高性能+易维护的组件化图形开发实现教程</a></li>
<li><a href="https://juejin.cn/post/7560905838074462271" target="_blank" title="https://juejin.cn/post/7560905838074462271">React无限滚动插件react-infinite-scroll-component的配置+优化+避坑指南</a></li>
<li><a href="https://juejin.cn/post/7560542615484137491" target="_blank" title="https://juejin.cn/post/7560542615484137491">前端音频兼容解决：音频神器howler.js从基础到进阶完整使用指南</a></li>
<li><a href="https://juejin.cn/post/7559871680015024169" target="_blank" title="https://juejin.cn/post/7559871680015024169">使用React-OAuth进行Google/GitHub登录的教程和案例</a></li>
<li><a href="https://juejin.cn/post/7550585427834404927" target="_blank" title="https://juejin.cn/post/7550585427834404927">纯前端人脸识别利器：face-api.js手把手深入解析教学</a></li>
<li><a href="https://juejin.cn/post/7553865490732433462" target="_blank" title="https://juejin.cn/post/7553865490732433462">关于React父组件调用子组件方法forwardRef的详解和案例</a></li>
<li><a href="https://juejin.cn/post/7553484874609410074" target="_blank" title="https://juejin.cn/post/7553484874609410074">React跨组件数据共享useContext详解和案例</a></li>
<li><a href="https://juejin.cn/post/7545087762837815334" target="_blank" title="https://juejin.cn/post/7545087762837815334">Web图像编辑神器tui.image-editor从基础到进阶的实战指南</a></li>
<li><a href="https://juejin.cn/post/7544323659788288046" target="_blank" title="https://juejin.cn/post/7544323659788288046">开发个人微信小程序类目选择/盈利方式/成本控制与服务器接入指南</a></li>
<li><a href="https://juejin.cn/post/7541741121400864778" target="_blank" title="https://juejin.cn/post/7541741121400864778">前端图片裁剪Cropper.js核心功能与实战技巧详解</a></li>
<li><a href="https://juejin.cn/post/7536530451461472265" target="_blank" title="https://juejin.cn/post/7536530451461472265">编辑器也有邪修？盘点VS Code邪门/有趣的扩展</a></li>
<li><a href="https://juejin.cn/post/7535005018257981466" target="_blank" title="https://juejin.cn/post/7535005018257981466">js使用IntersectionObserver实现目标元素可见度的交互</a></li>
<li><a href="https://juejin.cn/post/7534547200330121225" target="_blank" title="https://juejin.cn/post/7534547200330121225">Web前端页面开发阿拉伯语种适配指南</a></li>
<li><a href="https://juejin.cn/post/7516122409948020736" target="_blank" title="https://juejin.cn/post/7516122409948020736">让网页拥有App体验？PWA 将网页变为桌面应用的保姆级教程PWA</a></li>
<li><a href="https://juejin.cn/post/6953803916484018206" target="_blank" title="https://juejin.cn/post/6953803916484018206">使用nvm管理node.js版本以及更换npm淘宝镜像源</a></li>
<li><a href="https://juejin.cn/post/7140443283209060383" target="_blank" title="https://juejin.cn/post/7140443283209060383">手把手教你搭建规范的团队vue项目，包含commitlint，eslint，prettier，husky，commitizen等等</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大数据-193 Apache Tez 实战：Hive on Tez 安装配置、DAG原理与常见坑]]></title>    <link>https://juejin.cn/post/7586959875767746569</link>    <guid>https://juejin.cn/post/7586959875767746569</guid>    <pubDate>2025-12-24T00:49:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586959875767746569" data-draft-id="7586872817876434970" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大数据-193 Apache Tez 实战：Hive on Tez 安装配置、DAG原理与常见坑"/> <meta itemprop="keywords" content="后端,大数据,Apache"/> <meta itemprop="datePublished" content="2025-12-24T00:49:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武子康"/> <meta itemprop="url" content="https://juejin.cn/user/149189314230039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大数据-193 Apache Tez 实战：Hive on Tez 安装配置、DAG原理与常见坑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189314230039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武子康
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T00:49:10.000Z" title="Wed Dec 24 2025 00:49:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TL;DR</h2>
<ul>
<li>场景：Hadoop2/YARN 生态中用 Tez 替代 MapReduce，给 Hive/Pig 提速。</li>
<li>结论：关键在 tez.lib.uris（HDFS 包路径）+ 全节点一致的 tez-site.xml/Classpath + Hive 引擎切换。</li>
<li>产出：一套可落地的 Tez 安装配置清单 + 版本矩阵 + 错误速查卡。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f707f4da123a4f519b0e5cba4d3614a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767142150&amp;x-signature=gmXCVqxUeLE3otCZXPE9ugD8jyE%3D" alt="大数据-193 Apache Tez 实战：Hive on Tez 安装配置、DAG原理与常见坑" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb0de74204e14408be388d1f1912dff8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767142150&amp;x-signature=qM4sufiR18wtPxIcMJDCRefH4H0%3D" alt="Hadoop1 和 Hadoop2 的架构 与 Tez 的关系" loading="lazy"/></p>
<h2 data-id="heading-1">基本介绍</h2>
<p>Tez (发音为"tez") 是一个运行在 Hadoop 生态系统中的高效数据处理框架，旨在优化批处理和交互式查询。作为 Apache 基金会下的顶级开源项目(Apache Tez)，它最初由 Hortonworks 开发，现已成为 Hadoop 生态系统中重要的数据处理组件。</p>
<p>Tez 的核心设计目标是作为 MapReduce 的替代执行引擎，它通过引入更灵活的执行模型显著提高了处理效率。与传统的 MapReduce 相比，Tez 具有以下显著优势：</p>
<ol>
<li>采用有向无环图(DAG)执行模型，允许更复杂的数据处理流水线</li>
<li>支持动态任务调度和资源分配</li>
<li>减少了中间结果的磁盘I/O开销</li>
<li>提供更细粒度的任务执行控制</li>
</ol>
<p>在实际应用中，Tez 被广泛应用于以下场景：</p>
<ul>
<li>Hive 查询加速(作为执行引擎)</li>
<li>Pig 脚本处理</li>
<li>复杂ETL流程</li>
<li>交互式分析查询</li>
</ul>
<p>技术架构方面，Tez 包含以下关键组件：</p>
<ol>
<li>Tez API：提供编程接口</li>
<li>Tez Runtime：执行引擎核心</li>
<li>DAG 调度器：管理任务执行顺序</li>
<li>资源管理器接口：与YARN集成</li>
</ol>
<p>性能测试表明，对于典型的工作负载，Tez 相比传统MapReduce可以带来2-10倍的性能提升，特别是在处理复杂查询和多阶段任务时优势更为明显。</p>
<h2 data-id="heading-2">Tez 的背景</h2>
<ul>
<li>
<p><strong>MapReduce 的局限性</strong>:
Hadoop 最初是基于 MapReduce 编程模型设计的，这种模型虽然概念简单、易于理解，但在处理复杂的数据处理任务时存在明显的效率问题。MapReduce 采用严格的"map-shuffle-reduce"执行流程，每个任务阶段(map 或 reduce)都需要将中间结果写入磁盘，这种频繁的磁盘I/O操作会带来显著的性能开销。例如，在一个典型的ETL(抽取-转换-加载)作业中，数据可能需要经过多个map和reduce阶段，每次都会产生磁盘写入，导致整体处理延迟增加。此外，MapReduce 的批处理特性使得它对迭代算法(如机器学习)和交互式查询的支持较差。</p>
</li>
<li>
<p><strong>Tez 的改进与优势</strong>:
为了解决MapReduce的这些限制，Apache Tez应运而生。Tez通过引入更灵活的执行引擎，允许开发者构建复杂的数据处理DAG(有向无环图)，而不是局限于固定的map-reduce阶段。例如，一个典型的Hive查询在Tez上运行时，可以将多个操作(如过滤、聚合、连接等)组织成一个优化的执行计划，避免了中间结果的多次落盘。Tez还支持内存中的数据处理，显著减少了I/O开销。实际应用中，Tez可以将某些Hive查询的性能提升数倍，特别是在处理多表连接或复杂聚合时效果尤为明显。此外，Tez与YARN的深度集成使其能够更好地利用集群资源，支持更细粒度的任务调度。</p>
</li>
</ul>
<h2 data-id="heading-3">核心解释</h2>
<p>Tez将MapTask和ReduceTask进一步拆分为如下所示的内容：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70522fded70f4d95bae65df3f032a055~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767142150&amp;x-signature=JkQLmJQELikhii6JmXMvR3q3ZIM%3D" alt="Map Reduce 原理分析" loading="lazy"/>
Tez的Task由Input、Processor、Output阶段组成，可以表达所有复杂的Map、Reduce操作，如下图所示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb3195127181471ba214ff26595e1cf6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767142150&amp;x-signature=PllSQpkmmbqqz6B%2Fh1w64TSY6dI%3D" alt="Tez Task 原理分析" loading="lazy"/></p>
<p>Tez是一个基于Hadoop YARN构建的开源计算框架，它通过优化数据处理流程来显著提升作业执行效率。与传统MapReduce框架相比，Tez的核心优势在于其能够将多个相互依赖的作业转换为单个综合性的DAG（有向无环图）作业，这种优化带来了以下显著改进：</p>
<ol>
<li>
<p><strong>数据处理流程优化</strong>：</p>
<ul>
<li>消除了传统MapReduce中多个作业间的冗余HDFS读写操作</li>
<li>中间数据直接在内存中传递，减少磁盘I/O开销</li>
<li>任务调度更加智能，能够识别和优化依赖关系</li>
</ul>
</li>
<li>
<p><strong>性能提升表现</strong>：</p>
<ul>
<li>对于小型任务（如简单的数据转换或聚合查询），性能提升可达2-3倍</li>
<li>对于复杂的大型任务（涉及多表连接或复杂计算的ETL流程），性能提升更为显著，可达7-10倍</li>
<li>实际性能提升因数据规模、集群配置和查询复杂度而异</li>
</ul>
</li>
<li>
<p><strong>实际应用案例</strong>：</p>
<ul>
<li>Hortonworks已将Tez深度集成到Hive引擎中，作为默认执行引擎</li>
<li>在典型的TPC-DS基准测试中，使用Tez的Hive查询性能明显优于传统MapReduce</li>
<li>某电商平台的数据仓库中，月报表生成时间从原来的6小时缩短至45分钟</li>
</ul>
</li>
<li>
<p><strong>技术实现细节</strong>：</p>
<ul>
<li>采用动态任务调度机制，根据运行时情况优化执行计划</li>
<li>支持细粒度的资源管理，可精确控制每个任务的资源分配</li>
<li>提供可视化工具帮助开发者理解和优化DAG执行流程</li>
</ul>
</li>
<li>
<p><strong>适用场景</strong>：</p>
<ul>
<li>交互式查询（如Hive、Pig等SQL-on-Hadoop场景）</li>
<li>复杂ETL数据处理流程</li>
<li>机器学习特征工程中的多步骤数据处理</li>
<li>需要低延迟响应的数据分析任务</li>
</ul>
</li>
</ol>
<p>值得注意的是，Tez的性能优势在以下场景尤为突出：当作业包含多个连续的MapReduce步骤时，或者当中间数据量较大时，Tez的优化效果会更加明显。实际部署时建议结合具体业务场景进行性能调优。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0da1c8792ab34e46a95e47918ae36c41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767142150&amp;x-signature=5OOzyibk63o4UCyZQlJRwjqIq%2Bs%3D" alt="Pig Hive MR Tez" loading="lazy"/></p>
<p>Tez+Hive仍然采用MapReduce计算框架，但对DAG的作业依赖关系进行了裁剪，并将多个小作业合并成一个大作业，不仅减少了计算量，而且写HDFS次数也大大减少。</p>
<h2 data-id="heading-4">Tez 的工作原理</h2>
<ul>
<li>DAG 结构: 在 Tez 中，数据处理任务被表示为一个 DAG（Directed Acyclic Graph，有向无环图），其中每个节点代表一个处理任务，边表示数据的流动方向。不同于 MapReduce 固定的 map 和 reduce 阶段，Tez 可以定义任意数量的任务节点和数据流，从而更加灵活高效。</li>
<li>按需计算模型: Tez 支持按需加载数据，避免了不必要的中间结果存储。数据可以直接在内存中传递，减少磁盘操作，从而加速计算。</li>
</ul>
<h2 data-id="heading-5">Tez 的特点</h2>
<ul>
<li>
<p><strong>高效资源管理</strong>: Tez 与 YARN（Yet Another Resource Negotiator）深度集成，采用先进的资源调度算法，能够更智能地分配和使用集群资源。它通过实时监控工作负载的变化（如数据量、计算复杂度等），动态调整 CPU、内存等资源的分配比例。例如，在数据倾斜场景下，Tez 会自动为负载较重的节点分配更多资源，同时避免资源闲置浪费。这种机制相比传统静态资源分配方式可提升 30%以上的集群利用率。</p>
</li>
<li>
<p><strong>可重用的容器</strong>: Tez 创新性地实现了容器复用机制。在 YARN 架构中，容器是基本的资源分配单元（包含固定的 CPU 和内存配额）。传统框架如 MapReduce 每个任务都需要新建容器，而 Tez 允许同一容器在多个任务间重复使用（如 Map 阶段完成后容器可直接用于 Reduce 阶段）。实测表明，这种机制可以减少 40% 的任务启动时间，特别适合需要频繁启停任务的迭代计算场景（如机器学习训练）。</p>
</li>
<li>
<p><strong>延迟优化</strong>: Tez 通过两项核心技术显著降低处理延迟：一是采用内存化的数据流水线（pipelining），避免像 MapReduce 那样频繁将中间数据写入 HDFS；二是实现智能的任务拓扑优化，自动选择最短执行路径。例如在 Hive 查询中，Tez 可以将多个连续的 Map-Reduce 作业合并为一个 DAG 执行，使典型 TPC-DS 查询延迟降低 50-70%，达到准实时（near-real-time）响应水平。</p>
</li>
<li>
<p><strong>容错性</strong>: Tez 提供多层次的容错机制：1）任务级重试（自动重试失败任务最多 3 次）；2）基于检查点（checkpoint）的部分重算，仅需重新执行故障点之后的子任务；3）备用执行计划（speculative execution）应对慢节点问题。在 Amazon EMR 的实际应用中，这些机制使得 10%节点故障时的作业完成时间仅增加 15%，而传统框架通常需要完全重新执行。</p>
</li>
</ul>
<h2 data-id="heading-6">安装部署</h2>
<p>下载软件包： apache-tez-0.9.2-bin.tar.gz
解压缩：</p>
<pre><code class="hljs language-shell" lang="shell">tar -zxvf apache-tez-0.9.0-bin.tar.gz
cd apache-tez-0.9.0-bin/share
</code></pre>
<p>将tez的压缩包放到HDFS上：</p>
<pre><code class="hljs language-shell" lang="shell">hdfs dfs -mkdir -p /user/tez
hdfs dfs -put tez.tar.gz /user/tez
</code></pre>
<p>$HADOOP_HOME/etc/hadoop/ 下创建 tez-site.xml 文件，做如下配置：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 指定在hdfs上的tez包文件 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>tez.lib.uris<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>hdfs://hadoop1:9000/user/tez/tez.tar.gz<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
</code></pre>
<p>保存后将文件复制到集群所有节点</p>
<h2 data-id="heading-7">环境变量</h2>
<p>增加客户端节点的配置：</p>
<pre><code class="hljs language-shell" lang="shell">vim /etc/profile

export TEZ_CONF_DIR=$HADOOP_CONF_DIR
export TEZ_JARS=/opt/apps/tez/*:/opt/apps/tez/lib/*
export
HADOOP_CLASSPATH=$TEZ_CONF_DIR:$TEZ_JARS:$HADOOP_CLASSPATH

</code></pre>
<h2 data-id="heading-8">单次配置</h2>
<p>Hive这是Tez执行</p>
<pre><code class="hljs language-shell" lang="shell">xhive

set hive.execution.engine=tez;
</code></pre>
<h2 data-id="heading-9">永久配置</h2>
<p>如果是想默认使用Tez，则需要在配置文件中进行修改：</p>
<pre><code class="hljs language-shell" lang="shell">vim $HIVE_HOME/conf/hive-site.xml

&lt;property&gt;
&lt;name&gt;hive.execution.engine&lt;/name&gt;
&lt;value&gt;tez&lt;/value&gt;
&lt;/property&gt;
</code></pre>
<h2 data-id="heading-10">Tez 与 Hive、Pig 的集成</h2>
<ul>
<li>Hive on Tez: Hive 是一种基于 SQL 的数据仓库工具，最初使用 MapReduce 作为底层引擎。自从引入 Tez 后，Hive on Tez 大幅提升了查询性能，尤其是在复杂查询场景中。相比于传统的 MapReduce，Tez 的 DAG 模型使得 Hive 可以以更加并行化的方式执行查询。</li>
<li>Pig on Tez: Pig 是一种面向数据流的编程语言，通常用于分析和处理大规模数据。Tez 也作为 Pig 的底层引擎使用，极大地提升了 Pig 脚本的执行效率。</li>
</ul>
<h2 data-id="heading-11">Tez 的优势</h2>
<ul>
<li>高性能: 通过减少磁盘 IO、优化任务并行化和重用资源，Tez 显著提升了数据处理的性能，尤其是在复杂查询和数据流处理中。</li>
<li>灵活性: Tez 允许用户根据具体的数据处理需求，构建任意复杂的 DAG，从而打破了 MapReduce 固定阶段的限制。</li>
<li>可扩展性: Tez 在大规模数据处理环境中表现出色，适合在大数据集群中处理大规模、复杂的批处理和流式处理任务。</li>
</ul>
<h2 data-id="heading-12">使用场景</h2>
<ul>
<li>数据仓库查询加速: 许多使用 Hive 的企业已经转向 Tez 来加速 SQL 查询，尤其是涉及到大数据集和复杂操作的场景。</li>
<li>批处理任务优化: Tez 的 DAG 模型使其非常适合执行复杂的批处理任务，如多阶段数据清洗、转换和加载（ETL）工作流。</li>
<li>实时或近实时处理: Tez 可以用于需要低延迟的场景，如实时数据分析和在线报告。</li>
</ul>
<h2 data-id="heading-13">Tez 的局限性</h2>
<ul>
<li>学习曲线: 虽然 Tez 比 MapReduce 灵活高效，但它也更加复杂，要求开发者了解 DAG 模型及其配置。</li>
<li>任务复杂度: 对于非常简单的任务，Tez 的性能提升可能不明显，因此 Tez 更适用于复杂的、多阶段的任务场景。</li>
</ul>
<h2 data-id="heading-14">错误速查</h2>


















































<table><thead><tr><th>症状</th><th>根因定位</th><th>修复</th></tr></thead><tbody><tr><td>作业启动即失败：提示找不到 tez.tar.gz / FileNotFoundException</td><td>tez.lib.uris 指向的 HDFS 路径不存在或文件名不一致</td><td>hdfs dfs -ls /user/tez + 核对 tez-site.xml<br/>上传并统一文件名；确保 tez.lib.uris=hdfs://.../user/tez/tez.tar.gz 与实际一致</td></tr><tr><td>Hive 切到 tez 仍走 MR</td><td>hive.execution.engine 未生效（会话/配置文件未加载）</td><td>Hive 里 set hive.execution.engine;<br/>单次 set hive.execution.engine=tez;；永久写入 hive-site.xml 并重启相关服务/客户端</td></tr><tr><td>NoClassDefFoundError: org/apache/tez/...</td><td>客户端 classpath 未包含 Tez jars 或 TEZ_JARS 路径错误</td><td>echo $HADOOP_CLASSPATH + 检查 /opt/apps/tez/lib<br/>修正 TEZ_JARS 路径；把 Tez 解压目录与环境变量对齐；重新登录/source /etc/profile</td></tr><tr><td>只有部分节点能跑，部分节点报类缺失/配置缺失</td><td>tez-site.xml 未分发到全节点或版本不一致</td><td>对比各节点 $HADOOP_HOME/etc/hadoop/tez-site.xml<br/>统一分发 tez-site.xml 到所有节点（含边缘节点/HS2 所在节点）并校验一致性</td></tr><tr><td>Tez AM 启动失败、Container 反复重试</td><td>YARN 资源不足、队列限制、ACL 或 AM 内存设置不匹配</td><td>YARN RM UI/日志：ApplicationMaster 失败原因<br/>调整队列资源/并发；降低并发或提高 AM/Task 内存；检查队列 ACL</td></tr><tr><td>Hive 报 TezTask 执行错误（return code 2 等）</td><td>上游依赖未就绪（Tez lib、classpath、权限），或 SQL 触发大 shuffle</td><td>先用最小 SQL 验证；看 HS2/Tez AM 日志<br/>先跑简单查询验证链路；再逐步放大；必要时调 Tez/Hive 的内存与并行参数</td></tr><tr><td>HDFS 权限错误：无法读取 /user/tez</td><td>上传目录权限/属主不允许运行用户读取</td><td>hdfs dfs -ls -h /user/tez 看权限与属主<br/>给执行用户/组读权限；或将 Tez 包放到公共可读目录并规范权限配置</td></tr><tr><td>写了但不生效（尤其是 profile）</td><td>环境变量未加载、写法断行导致 export 异常</td><td><code>envgrep TEZ</code> 检查是否存在</td></tr></tbody></table>
<h2 data-id="heading-15">其他系列</h2>
<h3 data-id="heading-16">🚀 AI篇持续更新中（长期更新）</h3>
<p><strong>AI炼丹日志-29 - 字节跳动 DeerFlow 深度研究框<em>斜体样式</em>架 私有部署 测试上手 架构研究</strong>，持续打造实用AI工具指南！
<strong>AI研究-132 Java 生态前沿 2025：Spring、Quarkus、GraalVM、CRaC 与云原生落地</strong></p>
<h3 data-id="heading-17">💻 Java篇持续更新中（长期更新）</h3>
<p><strong>Java-207 RabbitMQ Direct 交换器路由：RoutingKey 精确匹配、队列多绑定与日志分流实战</strong>
MyBatis 已完结，Spring 已完结，Nginx已完结，Tomcat已完结，分布式服务已完结，Dubbo已完结，MySQL已完结，MongoDB已完结，Neo4j已完结，FastDFS 已完结，OSS已完结，GuavaCache已完结，EVCache已完结，RabbitMQ正在更新... 深入浅出助你打牢基础！</p>
<h3 data-id="heading-18">📊 大数据板块已完成多项干货更新（300篇）：</h3>
<p>包括 Hadoop、Hive、Kafka、Flink、ClickHouse、Elasticsearch 等二十余项核心组件，覆盖离线+实时数仓全栈！
<strong>大数据-278 Spark MLib - 基础介绍 机器学习算法 梯度提升树 GBDT案例 详解</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LLM 扩展方式的三年演进之路：复杂之后，回归简单]]></title>    <link>https://juejin.cn/post/7586972442422165545</link>    <guid>https://juejin.cn/post/7586972442422165545</guid>    <pubDate>2025-12-24T00:50:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586972442422165545" data-draft-id="7586971886589362219" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LLM 扩展方式的三年演进之路：复杂之后，回归简单"/> <meta itemprop="keywords" content="LLM,人工智能,面试"/> <meta itemprop="datePublished" content="2025-12-24T00:50:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Baihai_IDP"/> <meta itemprop="url" content="https://juejin.cn/user/3123071228582343"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LLM 扩展方式的三年演进之路：复杂之后，回归简单
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3123071228582343/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Baihai_IDP
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T00:50:55.000Z" title="Wed Dec 24 2025 00:50:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>编者按：</strong> 在当前 LLM 能力日益增强、扩展方式不断演进的背景下，我们是否正在走向一种“越复杂越强大”的技术路径？抑或，真正的突破恰恰源于回归简单与通用？</p>
<p>今天我们为大家带来的文章指出，尽管过去三年间出现了从插件、上下文协议、记忆功能等多种扩展机制，但最终的趋势很可能是：赋予智能体通用的计算能力，并相信它能自主完成复杂任务，而非依赖过度设计的专用工具。</p>
<p>文章系统梳理了过去三年 LLM 扩展方式的演进脉络 —— 从 ChatGPT 插件的超前尝试，到自定义指令的简化回潮。从 MCP 协议的重量级架构，到 Agent Skills 以 Markdown 和脚本实现的轻量级“重生”。作者指出，早期因模型能力不足而失败的“通用工具+自然语言指令”愿景，如今正因模型真正变“聪明”而成为可能。</p>
</blockquote>
<p><strong>作者 | Sawyer Hood</strong></p>
<p><strong>编译 | 岳扬</strong></p>
<p>三年前，“使用大语言模型”还意味着把一大段文字粘贴到聊天框里，然后期待能收到些有用的东西。如今，我们让智能体对接代码库、操控浏览器，允许它们自主运行并代表我们执行具体任务。在此期间，有一个关键的问题一直在酝酿：我们如何能让终端用户真正地按照自己的意愿、为满足自己的具体需求，来调整和塑造这些 AI 系统的工作方式？</p>
<p>随着模型能力的增强，终端用户可用的定制方式和机制也在不断扩展。我们从简单的系统提示词起步，演进到复杂的客户端-服务器协议，而后又再次回归简化的模式。</p>
<p><strong>我想借此机会回顾一下过去三年大语言模型扩展方式的演变，并谈谈我对未来趋势的看法。</strong></p>
<h2 data-id="heading-0"><strong>01 ChatGPT 插件（2023 年 3 月）[1]</strong></h2>
<p>在 ChatGPT 发布仅四个月后，OpenAI 就推出了 ChatGPT 插件。如今回过头看，这项设计在当时可谓极度超前。</p>
<p>这一构想雄心勃勃：给大语言模型一个符合 OpenAPI 规范的链接，让它“自由发挥”，调用各类 REST 接口。这直接体现了 AGI 式的思维模式：通过标准化 API 实现通用工具的调用。</p>
<pre><code class="hljs language-perl" lang="perl">{
<span class="hljs-string">"schema_version"</span>:<span class="hljs-string">"v1"</span>,
<span class="hljs-string">"name_for_human"</span>:<span class="hljs-string">"TODO Manager"</span>,
<span class="hljs-string">"name_for_model"</span>:<span class="hljs-string">"todo_manager"</span>,
<span class="hljs-string">"description_for_human"</span>:<span class="hljs-string">"Manages your TODOs!"</span>,
<span class="hljs-string">"description_for_model"</span>:<span class="hljs-string">"An app for managing a user's TODOs"</span>,
<span class="hljs-string">"api"</span>:{<span class="hljs-string">"url"</span>:<span class="hljs-string">"/openapi.json"</span>},
<span class="hljs-string">"auth"</span>:{<span class="hljs-string">"type"</span>:<span class="hljs-string">"none"</span>},
<span class="hljs-string">"logo_url"</span>:<span class="hljs-string">"https://example.com/logo.png"</span>,
<span class="hljs-string">"legal_info_url"</span>:<span class="hljs-string">"http://example.com"</span>,
<span class="hljs-string">"contact_email"</span>:<span class="hljs-string">"hello@example.com"</span>
}
</code></pre>
<p>那么问题出在哪里呢？当时的模型尚未准备就绪。GPT-3.5（甚至早期的 GPT-4）在处理庞大的 API 规范文档时存在困难，很容易“产生幻觉”（译者注：即编造不存在的信息或调用不存在的接口）或在上下文信息中“迷失方向”（译者注：即无法准确理解或跟踪当前任务所需的上下文，导致错误操作或理解偏差）。此外，用起来也很麻烦，每开始一个新的对话，即使想使用和上一次相同的插件，也必须重新手动在列表中找到并点击启用它。</p>
<p>尽管当时存在种种不足，但 ChatGPT 插件仍让我们窥见了未来：其中的 Code Interpreter 插件（后更名为 Advanced Data Analysis）变得不可或缺，它预示了我们今天正在使用的强大代码执行沙箱。</p>
<h2 data-id="heading-1"><strong>02 自定义指令（2023 年 7 月）[2]</strong></h2>
<p>自定义指令是对插件过于繁杂的一种“化繁为简”的回应。写到这里时我甚至愣了一下，因为我一度认为这项功能是在插件之前推出的。</p>
<p>它只是在每次对话中自动追加一段用户自定义的提示词（prompt）。简单、直观，却解决了一个大麻烦：重复设置上下文。</p>
<p>它可被视为后来所有 .cursorrules 和 CLAUDE.md 文件的理念原型。</p>
<h2 data-id="heading-2"><strong>03 Custom GPT（2023 年 11 月）[3]</strong></h2>
<p>OpenAI 将指令和工具重新打包，推出了“Custom GPT”。这是将提示词工程“产品化”的一次尝试：你可以将一个角色设定、若干文件和几个操作打包成一个可分享的链接。</p>
<p>相比插件最初所承诺的那种开放、灵活、可自由扩展的能力，Custom GPT 的做法实际上是一种战略上的退让 —— 它转向了经过精心设计、功能单一的“应用”（apps）模式。</p>
<h2 data-id="heading-3"><strong>04 ChatGPT 的记忆功能（2024 年 2 月）[4]</strong></h2>
<p>之前的扩展方式（如自定义指令、插件、Custom GPT 等）都依赖用户主动提供上下文或相关配置。而“记忆”功能则由系统自动记录并利用用户的历史对话信息，在用户无需干预的情况下动态调整模型行为，实现更自然、持续的个性化体验。</p>
<p>ChatGPT 记忆会记录你对话中的细节，并在后续对话的上下文中悄悄插入这些信息。这就像一个能自我编写的系统提示词。比如你提到自己是素食者，几周后它依然记得。这个功能虽小，却标志着智能体开始能自主积累和利用上下文信息，像一个有“记忆”的助手一样持续与用户互动，而不是每次对话都从零开始。</p>
<h2 data-id="heading-4"><strong>05 Cursor Rules（2024 年 4 月）[5]</strong></h2>
<p>以前，用户得在聊天界面里反复输入或设置上下文（比如代码风格、项目规范等），既麻烦又难以复用。而 Cursor 的做法是把这些指令直接写进项目代码仓库，从而彻底改变了这一游戏规则。</p>
<p>.cursorrules 文件的出现令人耳目一新。它不再需要你把项目上下文手动粘贴到聊天窗口里，而是让你直接将这些规则提交到 Git 仓库中：</p>
<ul>
<li>"We use tabs, not spaces."</li>
<li>"No semicolons."</li>
<li>"Always use TypeScript."</li>
</ul>
<p>它最初只是一个单独的文件，后来演变为一个 .cursor/rules 文件夹，支持更精细的作用域控制。你可以组织多个规则文件，甚至指定它们的适用条件，比如仅对特定文件类型或子目录生效。这是人们第一次觉得对大语言模型的扩展真正“原生地融入”了代码本身。</p>
<p>后来，Cursor 还引入了让大语言模型自行决定何时应用某条规则的功能 —— 这种模式我们之后还会再次见到。</p>
<h2 data-id="heading-5"><strong>06 模型上下文协议（2024 年 11 月）[6]</strong></h2>
<p>到了 2024 年底，大语言模型终于变得足够智能，能够稳定、可靠地操作真正的工具了。Anthropic 推出的模型上下文协议（Model Context Protocol, MCP）正是对这一能力需求的正式回应。</p>
<p>MCP 是一个重量级的解决方案。使用 MCP 时，客户端必须与 MCP 服务器保持一个持久的连接。服务器负责向客户端（通常是智能体）提供工具的定义、资源（如文件、日志等）以及提示词。当客户端决定调用某个工具时，它会向服务器发送一条消息说明“我调用了这个工具”。随后，服务器执行该工具（或协调执行），并将结果返回给客户端。</p>
<p>与“自定义指令”（仅附加上下文）不同，MCP 赋予模型真正的执行能力 —— 它可以读取你的代码仓库、查询你的 Postgres 数据库，甚至部署到 Vercel。除了提供工具，MCP 还允许服务器直接向智能体提供资源（如文档、日志）和提示词。</p>
<p>这套机制虽然功能非常强大，但可能有点“用牛刀杀鸡”了。虽然复杂，但对构建智能体的开发者而言，多花点功夫也值得。但若要求普通用户自行搭建并连接 MCP 服务，门槛就太高了。正因如此，围绕降低 MCP 使用难度的初创生态迅速兴起，比如 Smithery[7] 这类公司。</p>
<p>值得注意的是，2025 年 10 月发布[8]的 ChatGPT Apps 实际上正是以 MCP 作为底层基础构建的。这是 OpenAI 试图让终端用户在无需感知 MCP 存在的前提下，也能享受其能力的一次尝试。</p>
<h2 data-id="heading-6"><strong>07 Claude Code：新智能体，新扩展机制（2025 年 2 月）</strong></h2>
<p>2025 年初，Anthropic 发布了 Claude Code，几乎将当时所有的 LLM 扩展机制集于一身：</p>
<ul>
<li><strong>CLAUDE.md</strong>：为整个项目仓库设置操作规范的标准化方式。</li>
<li><strong>MCP</strong>：用来对接那些功能强、结构复杂的外部工具。</li>
<li><strong>斜杠命令（Slash Commands）</strong> ：类似于 Cursor 提供的 Notebooks 功能，用于保存和复用提示词。</li>
<li><strong>钩子（Hooks）</strong> ：能在智能体运行过程中介入并调整其执行流程（例如：“如果测试失败，就立即停止”）。</li>
<li><strong>子智能体（Sub-agents）</strong> ：动态创建专门的“子智能体”（或工作单元）来处理特定的子任务。</li>
<li><strong>输出风格（Output Styles）</strong> ：（已弃用）用于配置回答语气和响应格式。</li>
</ul>
<p>这些功能中哪些能长期留存，仍有待时间检验。事实上，Anthropic 已经尝试弃用“输出风格”这一特性[9]。</p>
<h2 data-id="heading-7"><strong>08 Agent Skills（2025 年 10 月）</strong></h2>
<p>Claude Code 新增的这一扩展机制意义重大，值得深入探讨。Agent Skills 可视为 ChatGPT 插件理念的“重生”。</p>
<p>MCP 依赖一整套客户端-服务器通信协议，而 Agent Skills 则简单得多 —— 它们只不过是包含 Markdown 文件和脚本（可用任意语言编写）的普通文件夹。</p>
<p>智能体会简单地扫描 skills/ 目录，读取每个 SKILL.md 文件的 frontmatter（前置元数据），并据此构建一个轻量级索引。只有当某项技能与当前任务相关时，它才会加载该技能的完整内容。这解决了 MCP 的一个主要痛点：所有工具的定义都必须一次性塞进模型的上下文窗口，导致上下文膨胀（context bloat）</p>
<p>以下是从 Anthropic 的 Skills 示例仓库[10]中摘录的一个用 Playwright 做端到端测试的技能结构片段：</p>
<pre><code class="hljs language-objectivec" lang="objectivec">webapp-testing/
├── examples/
│   ├── console_logging.py
│   ├── element_discovery.py
│   └── static_html_automation.py
├── scripts/
│   └── with_server.py
└── <span class="hljs-built_in">SKILL</span>.md
</code></pre>
<p>Skill 目录中可以包含脚本、示例和纯文本说明等多种内容，形式灵活。但其中唯一必需的文件只有 SKILL.md。接下来，我们来看看这个文件长什么样：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-string">name:</span> <span class="hljs-string">webapp-testing</span>
<span class="hljs-string">description:</span> <span class="hljs-string">Toolkit</span> <span class="hljs-string">for</span> <span class="hljs-string">interacting</span> <span class="hljs-string">with</span> <span class="hljs-string">and</span> <span class="hljs-string">testing</span> <span class="hljs-string">local</span> <span class="hljs-string">web</span> <span class="hljs-string">applications</span> <span class="hljs-string">using</span> <span class="hljs-string">Playwright.</span> <span class="hljs-string">Supports</span> <span class="hljs-string">verifying</span> <span class="hljs-string">frontend</span> <span class="hljs-string">functionality,</span> <span class="hljs-string">debugging</span> <span class="hljs-string">UI</span> <span class="hljs-string">behavior,</span> <span class="hljs-string">capturing</span> <span class="hljs-string">browser</span> <span class="hljs-string">screenshots,</span> <span class="hljs-string">and</span> <span class="hljs-string">viewing</span> <span class="hljs-string">browser</span> <span class="hljs-string">logs.</span>
<span class="hljs-string">license:</span> <span class="hljs-string">Complete</span> <span class="hljs-string">terms</span> <span class="hljs-string">in</span> <span class="hljs-string">LICENSE.txt</span>
<span class="hljs-meta">---
</span>
<span class="hljs-comment"># Web Application Testing</span>

<span class="hljs-string">To</span> <span class="hljs-string">test</span> <span class="hljs-string">local</span> <span class="hljs-string">web</span> <span class="hljs-string">applications,</span> <span class="hljs-string">write</span> <span class="hljs-string">native</span> <span class="hljs-string">Python</span> <span class="hljs-string">Playwright</span> <span class="hljs-string">scripts.</span>

 <span class="hljs-string">**HelperScripts</span> <span class="hljs-string">Available**:</span>

<span class="hljs-string">-</span> <span class="hljs-string">`scripts/with_server.py`</span> <span class="hljs-string">-</span> <span class="hljs-string">Manages</span> <span class="hljs-string">server</span> <span class="hljs-string">lifecycle</span> <span class="hljs-string">(supports</span> <span class="hljs-string">multiple</span> <span class="hljs-string">servers)</span>

 <span class="hljs-string">**Always</span> <span class="hljs-string">run</span> <span class="hljs-string">scripts</span> <span class="hljs-string">with</span> <span class="hljs-string">`--help`</span> <span class="hljs-string">first</span> <span class="hljs-string">**</span>  <span class="hljs-string">to</span> <span class="hljs-string">see</span> <span class="hljs-string">usage.</span> <span class="hljs-string">DO</span> <span class="hljs-string">NOT</span> <span class="hljs-string">read</span> <span class="hljs-string">the</span> <span class="hljs-string">source</span> <span class="hljs-string">until</span> <span class="hljs-string">you</span> <span class="hljs-string">try</span> <span class="hljs-string">running</span> <span class="hljs-string">the</span> <span class="hljs-string">script</span> <span class="hljs-string">first</span> <span class="hljs-string">and</span> <span class="hljs-string">find</span> <span class="hljs-string">that</span> <span class="hljs-string">a</span> <span class="hljs-string">customized</span> <span class="hljs-string">solution</span> <span class="hljs-string">is</span> <span class="hljs-string">absolutely</span> <span class="hljs-string">necessary.</span> <span class="hljs-string">These</span> <span class="hljs-string">scripts</span> <span class="hljs-string">can</span> <span class="hljs-string">be</span> <span class="hljs-string">very</span> <span class="hljs-string">large</span> <span class="hljs-string">and</span> <span class="hljs-string">thus</span> <span class="hljs-string">pollute</span> <span class="hljs-string">your</span> <span class="hljs-string">context</span> <span class="hljs-string">window.</span> <span class="hljs-string">They</span> <span class="hljs-string">exist</span> <span class="hljs-string">to</span> <span class="hljs-string">be</span> <span class="hljs-string">called</span> <span class="hljs-string">directly</span> <span class="hljs-string">as</span> <span class="hljs-string">black-box</span> <span class="hljs-string">scripts</span> <span class="hljs-string">rather</span> <span class="hljs-string">than</span> <span class="hljs-string">ingested</span> <span class="hljs-string">into</span> <span class="hljs-string">your</span> <span class="hljs-string">context</span> <span class="hljs-string">window.</span>
</code></pre>
<p>这只是一个包含一些元数据和技能描述的普通 Markdown 文件。智能体读取该文件，并可以自由引用其中提到的其他文件（智能体也能读取这些文件）。相比之下，一个 Playwright MCP 服务器需要定义几十个工具来控制浏览器，而这个 Skill 只需说一句：“你拥有 bash 环境，这是编写 Playwright 脚本的方法。”</p>
<p>诚然，要使用“Skill”，智能体必须具备对计算机的通用访问能力 —— 但这恰恰体现了“苦涩的教训”（the bitter lesson）[11]：与其为每个任务都定制一套专用工具，不如给智能体提供通用工具，并相信它有能力自主运用这些工具来完成任务 —— 这很可能才是制胜之道。</p>
<h2 data-id="heading-8"><strong>09 未来展望</strong></h2>
<p>Agent Skills 真正实现了 ChatGPT 插件最初所描绘的那个愿景：只需给模型提供一些说明（instructions）和通用工具（generic tools），然后相信它能自己完成中间所需的“胶水”工作。而我有一个假设：<strong>如今这种模式之所以可能奏效，是因为模型真的足够聪明了。</strong></p>
<p>Agent Skills 之所以有效，是因为它默认智能体具备“自己编写工具”的能力（比如通过 bash 命令等）。你不需要提供一个封装好的专用工具，而只需给它一段代码片段，它就能自行推断如何通用地运行这段代码，来应对当前任务。</p>
<p>更重要的是，我认为“Agent Skills”正在重新定义“智能体”的本质。<strong>智能体不再仅仅是一个在 while 循环里不断运行的大语言模型（LLM），而是一个绑着一台计算机的、在 while 循环里跑的大语言模型。</strong></p>
<p>Claude Code 是第一个让我真正意识到这一点的软件，但它过于面向开发者，远非面向大众的终极形态。其他应用（如 Zo Computer[12]）试图将大语言模型与计算机能力打包成一个整体应用，但我认为，它们仍未充分向终端用户隐藏底层计算机的复杂性。毕竟，当我请同事帮忙做一件事时，我不需要知道他电脑里所有的文件结构或操作细节。我只需要知道他有一台能用的电脑，并且相信他能自己搞定就行了。</p>
<p>展望 2026 年，我相信我们使用的 LLM 应用将越来越多地以新颖而巧妙的方式“绑上一台计算机” —— 而作为用户，我们可能根本察觉不到。</p>
<p>如果我能“做空” MCP，我一定会“做空”它。<strong>我预计，我们最终会回归到用最易用、最普适的“编程语言”来扩展智能体 —— 那就是自然语言。</strong></p>
<p><strong>END</strong></p>
<p><strong>本期互动内容 🍻</strong></p>
<p><strong>❓作者认为未来的方向是“给模型通用工具，让它自己写胶水代码”，而不是依赖复杂协议。你认同这个“苦涩的教训”吗？为什么？</strong></p>
<p><strong>文中链接</strong></p>
<p>[1]<a href="https://link.juejin.cn?target=https%3A%2F%2Fopenai.com%2Findex%2Fchatgpt-plugins%2F" target="_blank" title="https://openai.com/index/chatgpt-plugins/" ref="nofollow noopener noreferrer">openai.com/index/chatg…</a></p>
<p>[2]<a href="https://link.juejin.cn?target=https%3A%2F%2Fopenai.com%2Findex%2Fcustom-instructions-for-chatgpt%2F%3Futm_source%3Dchatgpt.com" target="_blank" title="https://openai.com/index/custom-instructions-for-chatgpt/?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">openai.com/index/custo…</a></p>
<p>[3]<a href="https://link.juejin.cn?target=https%3A%2F%2Fopenai.com%2Findex%2Fintroducing-gpts%2F" target="_blank" title="https://openai.com/index/introducing-gpts/" ref="nofollow noopener noreferrer">openai.com/index/intro…</a></p>
<p>[4]<a href="https://link.juejin.cn?target=https%3A%2F%2Fopenai.com%2Findex%2Fmemory-and-new-controls-for-chatgpt%2F" target="_blank" title="https://openai.com/index/memory-and-new-controls-for-chatgpt/" ref="nofollow noopener noreferrer">openai.com/index/memor…</a></p>
<p>[5]<a href="https://link.juejin.cn?target=https%3A%2F%2Fcursor.com%2Fchangelog%2F0-32-x" target="_blank" title="https://cursor.com/changelog/0-32-x" ref="nofollow noopener noreferrer">cursor.com/changelog/0…</a></p>
<p>[6]<a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FModel_Context_Protocol" target="_blank" title="https://en.wikipedia.org/wiki/Model_Context_Protocol" ref="nofollow noopener noreferrer">en.wikipedia.org/wiki/Model_…</a></p>
<p>[7]<a href="https://link.juejin.cn?target=https%3A%2F%2Fsmithery.ai%2F" target="_blank" title="https://smithery.ai/" ref="nofollow noopener noreferrer">smithery.ai/</a></p>
<p>[8]<a href="https://link.juejin.cn?target=https%3A%2F%2Fopenai.com%2Findex%2Fintroducing-apps-in-chatgpt%2F" target="_blank" title="https://openai.com/index/introducing-apps-in-chatgpt/" ref="nofollow noopener noreferrer">openai.com/index/intro…</a></p>
<p>[9]<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fclaude-code%2Fblob%2Fmain%2FCHANGELOG.md%255B%232030" target="_blank" title="https://github.com/anthropics/claude-code/blob/main/CHANGELOG.md%5B#2030" ref="nofollow noopener noreferrer">github.com/anthropics/…</a>]()</p>
<p>[10]<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills%2Fblob%2Fmain%2Fwebapp-testing%2FSKILL.md" target="_blank" title="https://github.com/anthropics/skills/blob/main/webapp-testing/SKILL.md" ref="nofollow noopener noreferrer">github.com/anthropics/…</a></p>
<p>[11]<a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FBitter_lesson" target="_blank" title="https://en.wikipedia.org/wiki/Bitter_lesson" ref="nofollow noopener noreferrer">en.wikipedia.org/wiki/Bitter…</a></p>
<p>[12]<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.zo.computer%2F" target="_blank" title="https://www.zo.computer/" ref="nofollow noopener noreferrer">www.zo.computer/</a></p>
<p><strong>本文经原作者授权，由 Baihai IDP 编译。如需转载译文，请联系获取授权。</strong></p>
<p><strong>原文链接：</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.sawyerhood.com%2Fblog%2Fllm-extension" target="_blank" title="https://www.sawyerhood.com/blog/llm-extension" ref="nofollow noopener noreferrer">www.sawyerhood.com/blog/llm-ex…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用了MySQL的INSERT ON DUPLICATE KEY UPDATE，怎么还报唯一索引冲突错误]]></title>    <link>https://juejin.cn/post/7586901995429871625</link>    <guid>https://juejin.cn/post/7586901995429871625</guid>    <pubDate>2025-12-24T00:57:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586901995429871625" data-draft-id="7586703355646492699" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用了MySQL的INSERT ON DUPLICATE KEY UPDATE，怎么还报唯一索引冲突错误"/> <meta itemprop="keywords" content="MySQL,后端,SQL"/> <meta itemprop="datePublished" content="2025-12-24T00:57:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="青石路"/> <meta itemprop="url" content="https://juejin.cn/user/1999357021005580"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用了MySQL的INSERT ON DUPLICATE KEY UPDATE，怎么还报唯一索引冲突错误
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1999357021005580/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    青石路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T00:57:04.000Z" title="Wed Dec 24 2025 00:57:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">开心一刻</h2>
<p>一天，老婆笑容满面的冲到我面前<br/>
老婆：你娶我到底是图我啥<br/>
我：便宜<br/>
老婆笑容瞬间消失，气呼呼的道：你会不会说话？<br/>
并且强调：我爸当年那是可怜你，没跟你多要<br/>
我：不是，你爸不是这么说的<br/>
老婆：那怎么说的<br/>
我开始学着老丈人的口吻：不许退，给你便宜点<br/></p>
<div align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/145c7b4e26194e5e81243a259cb88af9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767142624&amp;x-signature=XbcCvm3PTHFLzDz7MaVUbMmh9IY%3D" alt="开心一刻" loading="lazy"/></div>
<h2 data-id="heading-1">INSERT ON DUPLICATE KEY UPDATE</h2>
<p>关于 <code>INSERT ... ON DUPLICATE KEY UPDATE</code>，相信大家都有所了解，是 <code>MySQL</code> 针对</p>
<blockquote>
<p>不存在则插入，存在则更新</p>
</blockquote>
<p>的一种方言实现；<code>存不存在</code> 该如何判定呢，基于表的 <code>唯一索引</code> 或 <code>主键</code></p>
<p>举个例子，如果列 <code>a</code> 被声明为 <code>唯一</code> 且表中已经存在 <code>a=1</code> 的记录，则以下两条语句具有类似的效果</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t1 (a,b,c) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>)
  <span class="hljs-keyword">ON</span> DUPLICATE KEY <span class="hljs-keyword">UPDATE</span> c<span class="hljs-operator">=</span>c<span class="hljs-operator">+</span><span class="hljs-number">1</span>;

<span class="hljs-keyword">UPDATE</span> t1 <span class="hljs-keyword">SET</span> c<span class="hljs-operator">=</span>c<span class="hljs-operator">+</span><span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> a<span class="hljs-operator">=</span><span class="hljs-number">1</span>;
</code></pre>
<p>假设我们有表</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `tbl_insert_on_update` (
  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  `uk_column1` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  `uk_column2` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  `remark` text,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),
  <span class="hljs-keyword">UNIQUE</span> KEY `name` (`name`)
) ENGINE<span class="hljs-operator">=</span>InnoDB
</code></pre>
<p>一开始表中没有数据，那么</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> tbl_insert_on_update(id, name, uk_column1, uk_column2, remark)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'张三'</span>, <span class="hljs-string">'20050101001'</span>, <span class="hljs-string">'男一号'</span>, <span class="hljs-string">'风一样的男子'</span>)
<span class="hljs-keyword">ON</span> DUPLICATE KEY <span class="hljs-keyword">UPDATE</span> uk_column1<span class="hljs-operator">=</span><span class="hljs-string">'20050101002'</span>, uk_column2<span class="hljs-operator">=</span><span class="hljs-string">'男二号'</span>, remark<span class="hljs-operator">=</span><span class="hljs-string">'狂风一样的男子'</span>;
</code></pre>
<p>的作用，相信大家都知道，与</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> tbl_insert_on_update(id, name, uk_column1, uk_column2, remark)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'张三'</span>, <span class="hljs-string">'20050101001'</span>, <span class="hljs-string">'男一号'</span>, <span class="hljs-string">'风一样的男子'</span>);
</code></pre>
<p>作用一样，会往表中插入一条新的记录；如果再执行一次</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> tbl_insert_on_update(id, name, uk_column1, uk_column2, remark)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'张三'</span>, <span class="hljs-string">'20050101001'</span>, <span class="hljs-string">'男一号'</span>, <span class="hljs-string">'风一样的男子'</span>)
<span class="hljs-keyword">ON</span> DUPLICATE KEY <span class="hljs-keyword">UPDATE</span> uk_column1<span class="hljs-operator">=</span><span class="hljs-string">'20050101002'</span>, uk_column2<span class="hljs-operator">=</span><span class="hljs-string">'男二号'</span>, remark<span class="hljs-operator">=</span><span class="hljs-string">'狂风一样的男子'</span>;
</code></pre>
<p>呢，会是怎么样的结果？相信大家都知道</p>
<div align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a67391724fdd49c49a4b8c777679d035~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767142624&amp;x-signature=und9tkxAabtRGe70a0t6Ow2CfWo%3D" alt="insert_on_update_再执行一次" loading="lazy"/></div>
<p>与</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">UPDATE</span> tbl_insert_on_update <span class="hljs-keyword">SET</span> uk_column1<span class="hljs-operator">=</span><span class="hljs-string">'20050101002'</span>, uk_column2<span class="hljs-operator">=</span><span class="hljs-string">'男二号'</span>, remark<span class="hljs-operator">=</span><span class="hljs-string">'狂风一样的男子'</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
</code></pre>
<p>的效果一样。我们接着做个简单调整，拿掉 <code>name</code></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> tbl_insert_on_update(id, uk_column1, uk_column2, remark)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'20050101001'</span>, <span class="hljs-string">'男一号'</span>, <span class="hljs-string">'风一样的男子'</span>)
<span class="hljs-keyword">ON</span> DUPLICATE KEY <span class="hljs-keyword">UPDATE</span> uk_column1<span class="hljs-operator">=</span><span class="hljs-string">'20050101003'</span>, uk_column2<span class="hljs-operator">=</span><span class="hljs-string">'男三号'</span>, remark<span class="hljs-operator">=</span><span class="hljs-string">'暴风一样的男子'</span>;
</code></pre>
<p>或者拿掉 <code>id</code></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> tbl_insert_on_update(name, uk_column1, uk_column2, remark)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-string">'张三'</span>, <span class="hljs-string">'20050101001'</span>, <span class="hljs-string">'男一号'</span>, <span class="hljs-string">'风一样的男子'</span>)
<span class="hljs-keyword">ON</span> DUPLICATE KEY <span class="hljs-keyword">UPDATE</span> uk_column1<span class="hljs-operator">=</span><span class="hljs-string">'20050101003'</span>, uk_column2<span class="hljs-operator">=</span><span class="hljs-string">'男三号'</span>, remark<span class="hljs-operator">=</span><span class="hljs-string">'暴风一样的男子'</span>;
</code></pre>
<p>会是怎么样的一个结果，你们可以大胆猜一下。这两个 SQL 的执行结果是一样的</p>
<div align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fcc56051e4c24b888d7ccb70fed7bba3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767142624&amp;x-signature=W%2BDJ5QTi1N%2BUfCrqrtRoX2vn0ik%3D" alt="男三浩" loading="lazy"/></div>
<p>此时你们是不是有疑问呢</p>
<blockquote>
<p>为什么拿掉 <code>name</code> 和拿掉 <code>id</code> 的 INSERT ... ON DUPLICATE KEY UPDATE 的执行结果会是一样的？</p>
</blockquote>
<p>这个问题先放一放，我们先录入女一号的数据</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> tbl_insert_on_update(id, name, uk_column1, uk_column2, remark)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-number">2</span>, <span class="hljs-string">'婉儿'</span>, <span class="hljs-string">'20050101001X'</span>, <span class="hljs-string">'女一号'</span>, <span class="hljs-string">'花一样的女子'</span>);
</code></pre>
<p>假设我们要修改女一号的信息，包括 <code>姓名</code>，是不是可以这么实现</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> tbl_insert_on_update(id, name, uk_column1, uk_column2, remark)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-number">2</span>, <span class="hljs-string">'婉儿'</span>, <span class="hljs-string">'20050101001X'</span>, <span class="hljs-string">'女一号'</span>, <span class="hljs-string">'花一样的女子'</span>)
<span class="hljs-keyword">ON</span> DUPLICATE KEY <span class="hljs-keyword">UPDATE</span>, name<span class="hljs-operator">=</span><span class="hljs-string">'张三'</span>, uk_column1<span class="hljs-operator">=</span><span class="hljs-string">'20050101002X'</span>, uk_column2<span class="hljs-operator">=</span><span class="hljs-string">'女二号'</span>, remark<span class="hljs-operator">=</span><span class="hljs-string">'牵牛花一样的女子'</span>;
</code></pre>
<p>有什么问题吗，执行下就知道了嘛</p>
<div align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80d7289949da4d01b4e54029844f72f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767142624&amp;x-signature=%2BaD5b68%2Fb3%2FAFjXpF2yQROcxhfU%3D" alt="唯一索引冲突" width="90%" loading="lazy"/></div>
<p>执行报错了，提示</p>
<blockquote>
<p>1062 - Duplicate entry '张三' for key 'tbl_insert_on_update.name'</p>
</blockquote>
<p>这个错误信息我们是不是很熟悉？不就是唯一索引冲突吗？那么问题又来了</p>
<blockquote>
<p>用了MySQL的INSERT ON DUPLICATE KEY UPDATE，为什么还会唯一索引冲突？</p>
</blockquote>
<h2 data-id="heading-2">如何判断是否存在</h2>
<p>我们写 <code>INSERT ... ON DUPLICATE KEY UPDATE</code> 语句时，并未指定用哪个 <code>主键</code> 或者 <code>唯一索引</code> 来判定记录是否存在</p>
<blockquote>
<p>Oracle、SQL Server、PostgreSQL 的 <code>MERGE</code> 有类似作用</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">MERGE</span> <span class="hljs-keyword">INTO</span> TBL_INSERT_ON_UPDATE t
<span class="hljs-keyword">USING</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AS</span> ID, <span class="hljs-string">'张三'</span> <span class="hljs-keyword">AS</span> NAME, <span class="hljs-string">'20050101001'</span> <span class="hljs-keyword">AS</span> UK_COLUMN1, <span class="hljs-string">'男一号'</span> <span class="hljs-keyword">AS</span> UK_COLUMN2, <span class="hljs-string">'风一样的男子'</span> <span class="hljs-keyword">AS</span> REMARK <span class="hljs-keyword">FROM</span> dual
) s
<span class="hljs-keyword">ON</span> (t.NAME <span class="hljs-operator">=</span> s.NAME)  <span class="hljs-comment">-- 基于 NAME 字段匹配</span>
<span class="hljs-keyword">WHEN</span> MATCHED <span class="hljs-keyword">THEN</span>
    <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">SET</span>
        t.ID <span class="hljs-operator">=</span> s.ID,
        t.UK_COLUMN1 <span class="hljs-operator">=</span> s.UK_COLUMN1,
        t.UK_COLUMN2 <span class="hljs-operator">=</span> s.UK_COLUMN2,
        t.REMARK <span class="hljs-operator">=</span> s.REMARK
<span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">NOT</span> MATCHED <span class="hljs-keyword">THEN</span>
    <span class="hljs-keyword">INSERT</span> (ID, NAME, UK_COLUMN1, UK_COLUMN2, REMARK)
    <span class="hljs-keyword">VALUES</span> (s.ID, s.NAME, s.UK_COLUMN1, s.UK_COLUMN2, s.REMARK);
</code></pre>
<p>其中的 <code>ON</code>  明确指定匹配字段（根据哪些字段判断记录是否存在），一般是指定 <code>主键</code>字段或 <code>唯一索引</code>字段</p>
</blockquote>
<p>那 MySQL 是如何判定记录是否存在的呢？我们可以翻阅下官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F8.0%2Fen%2Finsert-on-duplicate.html" target="_blank" title="https://dev.mysql.com/doc/refman/8.0/en/insert-on-duplicate.html" ref="nofollow noopener noreferrer">INSERT ... ON DUPLICATE KEY UPDATE Statement</a>。一开头有如下一段描述</p>
<blockquote>
<p>If you specify an <code>ON DUPLICATE KEY UPDATE</code> clause and a row to be inserted would cause a duplicate value in a <code>UNIQUE</code> index or <code>PRIMARY KEY</code>, an <a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F8.0%2Fen%2Fupdate.html" target="_blank" title="https://dev.mysql.com/doc/refman/8.0/en/update.html" ref="nofollow noopener noreferrer"><code>UPDATE</code></a> of the old row occurs</p>
<p>当我们使用 <code>ON DUPLICATE KEY UPDATE</code>  子句时，插入的行导致 <code>唯一</code> 索引或者 <code>主键</code> 重复时，会更新旧的行</p>
</blockquote>
<p>通过这段话，我们只知道 MySQL 是根据唯一索引或主键来判定行是否存在，并不知道</p>
<ol>
<li>先根据主键判定，不冲突之后再根据唯一索引判定？</li>
<li>有多个唯一索引时，这些唯一索引的判定优先级是怎样的？</li>
</ol>
<p>官方文档里面并未明确说明这些问题，只是在结尾进行了如下说明</p>
<blockquote>
<p>An <a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F8.0%2Fen%2Finsert-on-duplicate.html" target="_blank" title="https://dev.mysql.com/doc/refman/8.0/en/insert-on-duplicate.html" ref="nofollow noopener noreferrer"><code>INSERT ... ON DUPLICATE KEY UPDATE</code></a> statement against a table having more than one unique or primary key is also marked as unsafe. (Bug #11765650, Bug #58637)</p>
<p>当表中有多个唯一索引或者主键时，INSERT ... ON DUPLICATE KEY UPDATE 语句不安全</p>
</blockquote>
<p>不安全代表执行结果不固定，会出现我们预期之外的结果</p>
<h2 data-id="heading-3">工作原理</h2>
<p>如果让你们来实现 <code>不存在则插入，存在则更新</code>，你们会怎么实现？</p>
<p>逐个查询主键以及所有唯一索引，判断该行数据是否存在，一旦存在则根据重复的主键或者唯一索引进行 <code>UPDATE</code>，都不存在则进行 <code>INSERT</code>；这不仅是你们最容易想到的实现方式，也是我最容易想到的方式。</p>
<p>但 MySQL 并未采用这种方式，而是采用了另外一种更高效的方式，先尝试插入，存储引擎会向<strong>所有相关的唯一索引（包括主键）</strong> 中插入对应的索引条目，如果都插入成功，说明数据行不存在，那么 <code>INSERT</code> 数据行；一旦存储引擎尝试插入某个唯一索引时，发现该数据行已经存在，会立即停止插入动作，并向MySQL服务层抛出 <code>重复键</code> 错误，服务层收到重复键错误后，并不会让整个语句失败（因为使用了 ON DUPLICATE KEY UPDATE 子句），而是转换执行模式，会先回滚之前的插入，然后根据重复的那个唯一索引找到数据行对应的 <code>旧行</code> 数据，最后 <code>UPDATE</code> 数据行；总结下来分三步</p>
<ol>
<li>
<p>尝试插入</p>
<p>所有唯一索引（包括主键）都插入成功，则插入数据行，相当于完成普通的 <code>INSERT</code></p>
<p>一旦某个唯一索引插入失败，则立即停止插入，存储引擎会向上层抛出一个 <code>重复键</code> 错误</p>
</li>
<li>
<p>模式转换</p>
<p>MySQL服务器收到重复键后，发现执行语句中有 <code>ON DUPLICATE KEY UPDATE</code> 子句，不会直接让整个语句失败，而是先回滚之前的那部分唯一索引的插入，然后根据插入失败的唯一索引找到已经存在的 <code>旧行</code></p>
</li>
<li>
<p>执行更新</p>
<p>根据插入失败的唯一索引，对旧行执行更新操作，相当于完成普通的 <code>UPDATE</code></p>
</li>
</ol>
<p>整个 <code>尝试-失败-转换-更新</code> 过程时一个原子操作，那么完全成功，要么完全失败；相比于 <code>先查询后判断</code> 的传统实现，这种实现方式效率更高。</p>
<h2 data-id="heading-4">问题答疑</h2>
<p>前面涉及到两个问题，现在我们来解惑下</p>
<ol>
<li>
<p>为什么拿掉 <code>name</code> 和拿掉 <code>id</code> 的 INSERT ... ON DUPLICATE KEY UPDATE 的执行结果会是一样的？</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 拿掉name</span>
<span class="hljs-keyword">INSERT</span> tbl_insert_on_update(id, uk_column1, uk_column2, remark)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'20050101001'</span>, <span class="hljs-string">'男一号'</span>, <span class="hljs-string">'风一样的男子'</span>)
<span class="hljs-keyword">ON</span> DUPLICATE KEY <span class="hljs-keyword">UPDATE</span> uk_column1<span class="hljs-operator">=</span><span class="hljs-string">'20050101003'</span>, uk_column2<span class="hljs-operator">=</span><span class="hljs-string">'男三号'</span>, remark<span class="hljs-operator">=</span><span class="hljs-string">'暴风一样的男子'</span>;

<span class="hljs-comment">-- 拿掉id</span>
<span class="hljs-keyword">INSERT</span> tbl_insert_on_update(name, uk_column1, uk_column2, remark)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-string">'张三'</span>, <span class="hljs-string">'20050101001'</span>, <span class="hljs-string">'男一号'</span>, <span class="hljs-string">'风一样的男子'</span>)
<span class="hljs-keyword">ON</span> DUPLICATE KEY <span class="hljs-keyword">UPDATE</span> uk_column1<span class="hljs-operator">=</span><span class="hljs-string">'20050101003'</span>, uk_column2<span class="hljs-operator">=</span><span class="hljs-string">'男三号'</span>, remark<span class="hljs-operator">=</span><span class="hljs-string">'暴风一样的男子'</span>;
</code></pre>
<p>这个问题是不是很简单，我们一起来分析下</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> tbl_insert_on_update(id, uk_column1, uk_column2, remark)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'20050101001'</span>, <span class="hljs-string">'男一号'</span>, <span class="hljs-string">'风一样的男子'</span>)
<span class="hljs-keyword">ON</span> DUPLICATE KEY <span class="hljs-keyword">UPDATE</span> uk_column1<span class="hljs-operator">=</span><span class="hljs-string">'20050101003'</span>, uk_column2<span class="hljs-operator">=</span><span class="hljs-string">'男三号'</span>, remark<span class="hljs-operator">=</span><span class="hljs-string">'暴风一样的男子'</span>;
</code></pre>
<p>INSERT 的字段中没有 <code>name</code>，但有 <code>id</code>，可想而知判断数据行是否存在，用到的是 <code>主键</code>，因为 <code>id=1</code> 的记录已经存在，所以根据 id 去更新其他字段值；那么执行结果与如下 SQL 一致</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">UPDATE</span> tbl_insert_on_update <span class="hljs-keyword">SET</span> uk_column1<span class="hljs-operator">=</span><span class="hljs-string">'20050101003'</span>, uk_column2<span class="hljs-operator">=</span><span class="hljs-string">'男三号'</span>, remark<span class="hljs-operator">=</span><span class="hljs-string">'暴风一样的男子'</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
</code></pre>
<p>同理</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> tbl_insert_on_update(name, uk_column1, uk_column2, remark)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-string">'张三'</span>, <span class="hljs-string">'20050101001'</span>, <span class="hljs-string">'男一号'</span>, <span class="hljs-string">'风一样的男子'</span>)
<span class="hljs-keyword">ON</span> DUPLICATE KEY <span class="hljs-keyword">UPDATE</span> uk_column1<span class="hljs-operator">=</span><span class="hljs-string">'20050101003'</span>, uk_column2<span class="hljs-operator">=</span><span class="hljs-string">'男三号'</span>, remark<span class="hljs-operator">=</span><span class="hljs-string">'暴风一样的男子'</span>;
</code></pre>
<p>INSERT 的字段中没有 <code>id</code>，但有 <code>name</code>，可想而知判断数据行是否存在，用到的是 <code>唯一索引</code>，因为 <code>name=张三</code> 的记录已经存在，所以根据 name 去更新其他字段值；那么执行结果与如下 SQL 一致</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">UPDATE</span> tbl_insert_on_update <span class="hljs-keyword">SET</span> uk_column1<span class="hljs-operator">=</span><span class="hljs-string">'20050101003'</span>, uk_column2<span class="hljs-operator">=</span><span class="hljs-string">'男三号'</span>, remark<span class="hljs-operator">=</span><span class="hljs-string">'暴风一样的男子'</span> <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-string">'张三'</span>;
</code></pre>
<p><code>id = 1</code> 与 <code>name = '张三'</code> 指向的本来就是同一行数据，更新的列与列值都一致，那么执行结果自然就一样了</p>
</li>
<li>
<p>存在多个唯一索引（包含主键）时，判断数据行是否存在，这些唯一索引的优先级顺序是怎样的？</p>
<p>MySQL 官方文档并未明确说明这个优先级顺序，但在 MySQL 的实现中肯定有这个优先级顺序的实现算法，可能跟版本、存储引擎有关</p>
<p>基于 <code>8.0.31</code> 版本，简单测试出以下优先级</p>
<blockquote>
<p>主键 &gt; 唯一索引</p>
<p>唯一索引之间按创建顺序，先创建的优先级高</p>
</blockquote>
<p>官方文档已经明确说明：当表中有多个唯一索引或者主键时，INSERT ... ON DUPLICATE KEY UPDATE 语句不安全，所以如上的测试结果并不具备确定性，不能作为使用准则</p>
</li>
<li>
<p>用了MySQL的INSERT ON DUPLICATE KEY UPDATE，怎么还报唯一索引冲突错误</p>
<p>MySQL是基于尝试插入的第一个冲突的唯一索引来执行更新的，更新的字段完全有可能触发其他唯一索引（包括主键）冲突</p>
<p>这个问题根本不成立！</p>
</li>
</ol>
<h2 data-id="heading-5">总结</h2>
<ol>
<li>
<p>不管是 MySQL，还是 Oracle、SQL Server、PostgreSQL，针对 <code>不存在则插入，存在则更新</code> 判断数据是否存在的逻辑都是一样的，只是 MySQL 不需要显示指定 <code>判存</code> 的唯一索引（包括主键），由 MySQL 引擎内部自动实现</p>
</li>
<li>
<p>关于判断数据行是否存在，多个唯一索引的优先级，看似能测出 MySQL 中的优先级，但并不具备确定性，不能作为使用准则</p>
<p>类似不确定的排序问题还有：<a href="https://juejin.cn/post/7290017749715632168" target="_blank" title="https://juejin.cn/post/7290017749715632168">我试图扯掉这条 SQL 的底裤</a></p>
</li>
<li>
<p>INSERT ... ON DUPLICATE KEY UPDATE 使用过程中有一些需要注意的点，需要结合自己的业务来分析是否可以忽略这些点</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fyouzhibing%2Fp%2F15248758.html" target="_blank" title="https://www.cnblogs.com/youzhibing/p/15248758.html" ref="nofollow noopener noreferrer">记录不存在则插入，存在则更新 → MySQL 的实现方式有哪些？</a></p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C#.NET AsyncLock 完全解析：async/await 下的并发控制方案]]></title>    <link>https://juejin.cn/post/7586869907067125795</link>    <guid>https://juejin.cn/post/7586869907067125795</guid>    <pubDate>2025-12-23T23:38:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586869907067125795" data-draft-id="7586851351470276648" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C#.NET AsyncLock 完全解析：async/await 下的并发控制方案"/> <meta itemprop="keywords" content="C#,.NET"/> <meta itemprop="datePublished" content="2025-12-23T23:38:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="唐青枫"/> <meta itemprop="url" content="https://juejin.cn/user/3737995266234280"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C#.NET AsyncLock 完全解析：async/await 下的并发控制方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3737995266234280/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    唐青枫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T23:38:19.000Z" title="Tue Dec 23 2025 23:38:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">简介</h3>
<p><code>AsyncLock</code> 是一种自定义的异步互斥锁（<code>Mutex Lock</code>），专为异步编程场景设计，用于在 <code>async/await</code> 方法中实现线程安全的互斥访问。它弥补了 <code>.NET</code> 中传统 <code>lock</code> 语句（基于 <code>Monitor</code>）的不足，因为 <code>lock</code> 是同步阻塞的，在异步环境中会阻塞线程池线程，导致性能下降或死锁风险。</p>
<ul>
<li>
<p>核心原理：<code>AsyncLock</code> 通常基于 <code>SemaphoreSlim(1, 1)</code> 实现，允许异步等待锁的获取，而不阻塞当前线程。等待的任务会被挂起（<code>suspend</code>），释放线程池资源，支持 <code>CancellationToken</code> 取消操作。</p>
</li>
<li>
<p>来源：<code>.NET</code> 标准库中没有内置 <code>AsyncLock</code>，通常通过 <code>NuGet</code> 包 <code>Nito.AsyncEx</code>（由 `Stephen Cleary 维护）使用。该库提供了生产就绪的实现。</p>
</li>
</ul>
<p>使用方式：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> AsyncLock _mutex = <span class="hljs-keyword">new</span> AsyncLock();

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">DoWorkAsync</span>()</span>
{
    <span class="hljs-keyword">using</span> (<span class="hljs-keyword">await</span> _mutex.LockAsync())
    {
        <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">100</span>);
    }
}
</code></pre>
<h3 data-id="heading-1">为什么需要 AsyncLock？</h3>
<p>在异步编程中，共享资源（如文件、数据库或 UI 更新）需要互斥访问：</p>
<ul>
<li>
<p>传统 <code>lock</code> 的问题：<code>lock</code> 会阻塞调用线程，如果在 <code>async</code> 方法中使用，会导致线程池耗尽，尤其在高并发场景（如 <code>Web API</code> 或 <code>TCP</code> 处理）中。</p>
</li>
<li>
<p><code>AsyncLock</code> 的优势：非阻塞等待，使用 <code>await</code> 挂起任务，适合 <code>I/O</code> 密集型操作（如网络请求、文件读写）。</p>
</li>
<li>
<p>适用场景：</p>
<ul>
<li>
<p>异步方法中保护共享状态（如缓存更新）。</p>
</li>
<li>
<p><code>UI</code> 线程与后台任务的同步。</p>
</li>
<li>
<p>避免死锁的并发控制。</p>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-2">普通 lock 的问题</h4>
<p>在同步代码中，我们通常用 <code>lock</code> 来保护临界区：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">object</span> _syncRoot = <span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>();

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Increment</span>()</span>
{
    <span class="hljs-keyword">lock</span> (_syncRoot)
    {
        _count++;
    }
}
</code></pre>
<p>但是在异步代码中：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">IncrementAsync</span>()</span>
{
    <span class="hljs-keyword">lock</span> (_syncRoot)
    {
        <span class="hljs-keyword">await</span> SomeAsyncOperation(); <span class="hljs-comment">// ❌ 编译错误</span>
    }
}
</code></pre>
<p><code>lock</code> 不能与 <code>await</code> 一起使用，因为：</p>
<ul>
<li>
<p><code>await</code> 会让出线程控制权；</p>
</li>
<li>
<p>离开 <code>lock</code> 作用域时会立即释放锁；</p>
</li>
<li>
<p>这会破坏线程安全。</p>
</li>
</ul>
<h3 data-id="heading-3">AsyncLock 的基本思想</h3>
<p>核心目标是实现 异步安全的锁，使得：</p>
<ul>
<li>
<p>异步任务按顺序进入临界区；</p>
</li>
<li>
<p>释放时能唤醒下一个等待者；</p>
</li>
<li>
<p>不阻塞线程（不像 <code>lock</code> 会阻塞）。</p>
</li>
</ul>
<h4 data-id="heading-4">基本原理</h4>
<p>可以用 <code>SemaphoreSlim</code>（轻量信号量）实现：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AsyncLock</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> SemaphoreSlim _semaphore = <span class="hljs-keyword">new</span> SemaphoreSlim(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>);
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> Task&lt;IDisposable&gt; _releaser;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AsyncLock</span>()</span>
    {
        _releaser = Task.FromResult((IDisposable)<span class="hljs-keyword">new</span> Releaser(<span class="hljs-keyword">this</span>));
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> Task&lt;IDisposable&gt; <span class="hljs-title">LockAsync</span>()</span>
    {
        <span class="hljs-keyword">var</span> wait = _semaphore.WaitAsync();
        <span class="hljs-keyword">return</span> wait.IsCompleted
            ? _releaser
            : wait.ContinueWith((_, state) =&gt; (IDisposable)state,
                                _releaser.Result, CancellationToken.None,
                                TaskContinuationOptions.ExecuteSynchronously,
                                TaskScheduler.Default);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Releaser</span> : <span class="hljs-title">IDisposable</span>
    {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> AsyncLock _toRelease;

        <span class="hljs-function"><span class="hljs-keyword">internal</span> <span class="hljs-title">Releaser</span>(<span class="hljs-params">AsyncLock toRelease</span>)</span> =&gt; _toRelease = toRelease;

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dispose</span>()</span>
        {
            _toRelease._semaphore.Release();
        }
    }
}
</code></pre>
<h3 data-id="heading-5">使用示例</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> AsyncLock _lock = <span class="hljs-keyword">new</span> AsyncLock();
<span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> _count = <span class="hljs-number">0</span>;

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">IncrementAsync</span>()</span>
{
    <span class="hljs-keyword">using</span> (<span class="hljs-keyword">await</span> _lock.LockAsync())
    {
        _count++;
        <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">100</span>); <span class="hljs-comment">// 模拟异步操作</span>
        Console.WriteLine(<span class="hljs-string">$"Count: <span class="hljs-subst">{_count}</span>"</span>);
    }
}
</code></pre>
<p>调用示例</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">var</span> tasks = Enumerable.Range(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>).Select(_ =&gt; IncrementAsync());
<span class="hljs-keyword">await</span> Task.WhenAll(tasks);
</code></pre>
<p>输出将是：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">Count: 1</span>
<span class="hljs-section">Count: 2</span>
<span class="hljs-section">Count: 3</span>
<span class="hljs-section">Count: 4</span>
<span class="hljs-section">Count: 5</span>
</code></pre>
<p>所有操作顺序执行，没有并发问题。</p>
<h3 data-id="heading-6">与 SemaphoreSlim 的区别</h3>






























<table><thead><tr><th>特性</th><th><code>SemaphoreSlim</code></th><th><code>AsyncLock</code></th></tr></thead><tbody><tr><td>可同时进入的任务数</td><td>可指定 (n)</td><td>永远只允许 1</td></tr><tr><td>使用方式</td><td><code>WaitAsync</code>/<code>Release</code></td><td><code>using(await LockAsync())</code></td></tr><tr><td>使用便捷性</td><td>稍复杂</td><td>简洁且自动释放</td></tr><tr><td>推荐场景</td><td>控制并发数量</td><td>异步临界区互斥</td></tr></tbody></table>
<h3 data-id="heading-7">改进版：支持 CancellationToken</h3>
<p>可以进一步增强：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IDisposable&gt; <span class="hljs-title">LockAsync</span>(<span class="hljs-params">CancellationToken cancellationToken</span>)</span>
{
    <span class="hljs-keyword">await</span> _semaphore.WaitAsync(cancellationToken).ConfigureAwait(<span class="hljs-literal">false</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Releaser(_semaphore);
}
</code></pre>
<h3 data-id="heading-8">异步文件写入</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AsyncFileWriter</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> AsyncLock _lock = <span class="hljs-keyword">new</span> AsyncLock();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">string</span> _filePath;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AsyncFileWriter</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> path</span>)</span> =&gt; _filePath = path;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">WriteAsync</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> message</span>)</span>
    {
        <span class="hljs-keyword">using</span> (<span class="hljs-keyword">await</span> _lock.LockAsync())
        {
            <span class="hljs-keyword">await</span> File.AppendAllTextAsync(_filePath, message + Environment.NewLine);
        }
    }
}
</code></pre>
<p>多个异步任务并发写同一个文件时，也不会出现内容交错。</p>
<h3 data-id="heading-9">高级用法</h3>
<h4 data-id="heading-10">带超时控制的 AsyncLock</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AsyncLockWithTimeout</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> SemaphoreSlim _semaphore = <span class="hljs-keyword">new</span> SemaphoreSlim(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>);
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;LockResult&gt; <span class="hljs-title">TryLockAsync</span>(<span class="hljs-params">TimeSpan timeout, CancellationToken cancellationToken = <span class="hljs-literal">default</span></span>)</span>
    {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">await</span> _semaphore.WaitAsync(timeout, cancellationToken))
        {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> LockResult(<span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> LockResult(<span class="hljs-keyword">this</span>, <span class="hljs-literal">false</span>);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">LockResult</span> : <span class="hljs-title">IDisposable</span>
    {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> AsyncLockWithTimeout _lock;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">bool</span> _acquired;
        
        <span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> Acquired =&gt; _acquired;
        
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">LockResult</span>(<span class="hljs-params">AsyncLockWithTimeout asyncLock, <span class="hljs-built_in">bool</span> acquired</span>)</span>
        {
            _lock = asyncLock;
            _acquired = acquired;
        }
        
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dispose</span>()</span>
        {
            <span class="hljs-keyword">if</span> (_acquired)
            {
                _lock._semaphore.Release();
            }
        }
    }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-built_in">bool</span>&gt; <span class="hljs-title">TryProcessWithTimeoutAsync</span>()</span>
{
    <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> lockResult = <span class="hljs-keyword">await</span> _lock.TryLockAsync(TimeSpan.FromSeconds(<span class="hljs-number">5</span>));
    
    <span class="hljs-keyword">if</span> (lockResult.Acquired)
    {
        <span class="hljs-comment">// 成功获取锁</span>
        <span class="hljs-keyword">await</span> ProcessDataAsync();
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">else</span>
    {
        <span class="hljs-comment">// 获取锁超时</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
}
</code></pre>
<h3 data-id="heading-11">性能与注意事项</h3>
<h4 data-id="heading-12">优点</h4>
<ul>
<li>
<p>异步友好，不会阻塞线程；</p>
</li>
<li>
<p>简洁易用；</p>
</li>
<li>
<p>线程安全。</p>
</li>
</ul>
<h4 data-id="heading-13">注意</h4>
<ul>
<li>
<p>不适合高频率、极短临界区操作（<code>SemaphoreSlim</code> 有开销）；</p>
</li>
<li>
<p>不要长时间持有锁；</p>
</li>
<li>
<p>推荐作用于需要保护的异步资源（如数据库、文件、共享状态）。</p>
</li>
</ul>
<h3 data-id="heading-14">对比总结</h3>

























<table><thead><tr><th>场景</th><th>推荐锁类型</th></tr></thead><tbody><tr><td>同步代码块</td><td><code>lock</code></td></tr><tr><td>异步方法</td><td><code>AsyncLock</code></td></tr><tr><td>控制并发数</td><td><code>SemaphoreSlim</code></td></tr><tr><td>跨进程或跨机器</td><td>分布式锁（Redis、SQL、Zookeeper 等）</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CocoaPods Podfile优化设置手册-持续更新]]></title>    <link>https://juejin.cn/post/7586892413891117102</link>    <guid>https://juejin.cn/post/7586892413891117102</guid>    <pubDate>2025-12-23T17:04:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586892413891117102" data-draft-id="7586877892468047899" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CocoaPods Podfile优化设置手册-持续更新"/> <meta itemprop="keywords" content="iOS,架构"/> <meta itemprop="datePublished" content="2025-12-23T17:04:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sweet丶"/> <meta itemprop="url" content="https://juejin.cn/user/3227821869921646"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CocoaPods Podfile优化设置手册-持续更新
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821869921646/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sweet丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T17:04:33.000Z" title="Tue Dec 23 2025 17:04:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>配置Podfile时，如果结合一些优化选项，能大大的提升开发效率。本文是为使用cocoapod管理组件库提供一个podfile优化设置的最佳实践。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">install!</span> <span class="hljs-string">'cocoapods'</span><span class="hljs-string">,</span>
    <span class="hljs-comment"># 禁用输入输出路径</span>
    <span class="hljs-attr">disable_input_output_paths:</span> <span class="hljs-literal">true</span><span class="hljs-string">,</span>
    
    <span class="hljs-comment"># 增量安装（只更新变化的 Pods）</span>
    <span class="hljs-attr">incremental_installation:</span> <span class="hljs-literal">true</span><span class="hljs-string">,</span>
    
    <span class="hljs-comment"># 为每个 Pod 创建独立项目</span>
    <span class="hljs-attr">generate_multiple_pod_projects:</span> <span class="hljs-literal">true</span><span class="hljs-string">,</span>
    
    <span class="hljs-comment"># 生成确定性的 UUID（便于缓存）</span>
    <span class="hljs-attr">deterministic_uuids:</span> <span class="hljs-literal">true</span><span class="hljs-string">,</span>
    
    <span class="hljs-comment"># 锁定 Pod 项目 UUID</span>
    <span class="hljs-attr">lock_pod_sources:</span> <span class="hljs-literal">true</span><span class="hljs-string">,</span>
    
    <span class="hljs-comment"># 保留 Pod 的原始文件结构</span>
    <span class="hljs-attr">preserve_pod_file_structure:</span> <span class="hljs-literal">true</span><span class="hljs-string">,</span>
    
    <span class="hljs-comment"># 共享编译方案</span>
    <span class="hljs-attr">share_schemes_for_development_pods:</span> <span class="hljs-literal">true</span><span class="hljs-string">,</span>
    
    <span class="hljs-comment"># 禁用代码签名（用于开发 Pods）</span>
    <span class="hljs-attr">disable_code_signature_for_development_pods:</span> <span class="hljs-literal">true</span>
</code></pre>
<h3 data-id="heading-1">🚀 一、构建性能优化类</h3>
<h4 data-id="heading-2"><strong>1. <code>disable_input_output_paths: true</code></strong></h4>
<ul>
<li><strong>基本说明</strong>：
默认情况下，CocoaPods 会为每个 Pod 生成<strong>输入输出路径映射文件</strong>，这些文件告诉 Xcode 如何查找和链接 Pod 中的资源文件（如图片、xib、storyboard 等），设置 <code>disable_input_output_paths: true</code> 会禁用这个功能。</li>
</ul>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 1.默认为false，即CocoaPods 会为每个 Pod 创建 .xcconfig 文件包含类似：</span>
<span class="hljs-variable constant_">FRAMEWORK_SEARCH_PATHS</span> = <span class="hljs-variable">$(</span>inherited) <span class="hljs-string">"${PODS_CONFIGURATION_BUILD_DIR}/AFNetworking"</span>
<span class="hljs-variable constant_">LD_RUNPATH_SEARCH_PATHS</span> = <span class="hljs-variable">$(</span>inherited) <span class="hljs-string">'@executable_path/Frameworks'</span> <span class="hljs-string">'@loader_path/Frameworks'</span>
<span class="hljs-comment"># 2.设置true时，不使用复杂的路径映射，使用更简单的框架搜索路径。</span>
</code></pre>
<ul>
<li>
<p><strong>好处</strong>：</p>
<ul>
<li><strong>构建速度显著提升</strong>：增量构建速度提升 <strong>30-50%</strong>，全量构建也有 <strong>10-20%</strong> 的提升</li>
<li><strong>减少系统开销</strong>：减少 Xcode 构建系统对大量文件的监控和检查</li>
</ul>
</li>
<li>
<p><strong>原理</strong>：</p>
<ol>
<li><strong>绕过依赖验证</strong>：CocoaPods 默认会验证每个源文件的输入输出路径，确保编译正确性。启用此选项后，跳过这些验证</li>
<li><strong>减少文件系统操作</strong>：避免为每个资源文件创建和维护路径映射记录</li>
<li><strong>简化构建图</strong>：构建系统不需要跟踪复杂的文件依赖关系图</li>
</ol>
</li>
<li>
<p><strong>缺点</strong>：</p>
<ol>
<li><strong>依赖检查失效</strong>：可能掩盖 Podspec 配置错误，如资源文件路径错误</li>
<li><strong>构建确定性下降</strong>：在极端情况下可能导致缓存不一致问题</li>
<li><strong>调试困难</strong>：当资源文件找不到时，错误信息不够明确，排查困难</li>
<li><strong>Podspec 质量要求高</strong>：要求所有 Pod 的 spec 文件必须正确配置资源路径</li>
</ol>
</li>
<li>
<p><strong>推荐场景</strong>：</p>
<ul>
<li>大型项目（Pod 数量 &gt; 15）</li>
<li>CI/CD 流水线环境</li>
<li>Podspec 质量可靠且经过充分测试</li>
</ul>
</li>
<li>
<p><strong>验证是否生效</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查生成的 Pods.xcconfig 文件</span>
grep -r <span class="hljs-string">"input.xcfilelist\|output.xcfilelist"</span> Pods/
<span class="hljs-comment"># 如果生效，应该找不到相关配置</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-3"><strong>2. <code>generate_multiple_pod_projects: true</code></strong></h4>
<ul>
<li><strong>基本说明</strong>：
CocoaPods 1.7.0+ 引入的功能，改变传统的单 <code>Pods.xcodeproj</code> 结构，为每个 Pod 生成独立的 Xcode 项目文件。</li>
</ul>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 传统方式（generate_multiple_pod_projects: false）：</span>
<span class="hljs-title class_">Pods</span>/
  └── <span class="hljs-title class_">Pods</span>.xcodeproj          <span class="hljs-comment"># 单个项目文件</span>
        ├── <span class="hljs-title class_">Target</span>: <span class="hljs-title class_">Alamofire</span>
        ├── <span class="hljs-title class_">Target</span>: <span class="hljs-title class_">SDWebImage</span>
        └── ...
        
<span class="hljs-comment"># 新方式（generate_multiple_pod_projects: true）：</span>
<span class="hljs-title class_">Pods</span>/
  ├── <span class="hljs-title class_">Alamofire</span>.xcodeproj     <span class="hljs-comment"># 独立项目文件</span>
  ├── <span class="hljs-title class_">SDWebImage</span>.xcodeproj    <span class="hljs-comment"># 独立项目文件</span>
  ├── ...                     <span class="hljs-comment"># 其他Pod项目文件</span>
  └── <span class="hljs-title class_">Pods</span>.xcodeproj          <span class="hljs-comment"># 仅包含聚合Target</span>
</code></pre>
<ul>
<li>
<p><strong>好处</strong>：</p>
<ul>
<li><strong>并行编译支持</strong>：Xcode 可以同时编译多个独立项目，充分利用多核 CPU</li>
<li><strong>增量编译优化</strong>：修改一个 Pod 不会触发其他 Pod 重新编译</li>
<li><strong>模块化清晰</strong>：每个 Pod 的构建配置完全独立，避免相互干扰</li>
<li><strong>缓存效率提升</strong>：构建产物可以按 Pod 单独缓存和复用</li>
</ul>
</li>
<li>
<p><strong>原理</strong>：</p>
<ol>
<li><strong>项目结构重构</strong>：将 monolithic 的单项目拆分为多个子项目</li>
<li><strong>构建图优化</strong>：Xcode 可以更好地分析依赖关系，实现并行构建</li>
<li><strong>配置隔离</strong>：每个 Pod 有独立的构建设置，减少配置冲突</li>
</ol>
</li>
<li>
<p><strong>缺点</strong>：</p>
<ol>
<li><strong>Xcode 索引变慢</strong>：项目文件增多导致 Xcode 索引时间增加 20%</li>
<li><strong>内存占用增加</strong>：Xcode 需要同时加载多个项目，内存使用增长明显</li>
<li><strong>初次生成耗时</strong>：首次 <code>pod install</code> 时间增加约 10%</li>
</ol>
</li>
<li>
<p><strong>推荐场景</strong>：</p>
<ul>
<li>Pod 数量较多（&gt; 20个）的大型项目</li>
<li>需要频繁进行增量构建</li>
<li>项目采用模块化架构设计</li>
</ul>
</li>
</ul>
<h4 data-id="heading-4"><strong>3. <code>incremental_installation: true</code></strong></h4>
<ul>
<li><strong>基本说明</strong>：
CocoaPods 1.11.0+ 引入的增量安装功能，仅更新变更的 Pod 配置，跳过未变更的部分。</li>
</ul>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 普通 pod install 流程：</span>
<span class="hljs-number">1</span>. 解析整个 <span class="hljs-title class_">Podfile</span> 和 <span class="hljs-title class_">Podspec</span>
<span class="hljs-number">2</span>. 生成所有 <span class="hljs-title class_">Pod</span> 的项目配置
<span class="hljs-number">3</span>. 写入 <span class="hljs-title class_">Pods</span>.xcodeproj
<span class="hljs-number">4</span>. 更新所有相关文件

<span class="hljs-comment"># 增量安装流程（incremental_installation: true）：</span>
<span class="hljs-number">1</span>. 计算 <span class="hljs-title class_">Podfile</span>/<span class="hljs-title class_">Podspec</span> 的哈希值
<span class="hljs-number">2</span>. 与上次缓存对比，识别变更的 <span class="hljs-title class_">Pod</span>
<span class="hljs-number">3</span>. 仅重新生成变更 <span class="hljs-title class_">Pod</span> 的配置
<span class="hljs-number">4</span>. 保留未变更 <span class="hljs-title class_">Pod</span> 的项目状态，只重新编译有变化的 <span class="hljs-title class_">Pod</span>
</code></pre>
<ul>
<li>
<p><strong>好处</strong>：</p>
<ul>
<li><strong>编译时间大幅减少</strong>：<code>pod install</code>或<code>pod update</code>导致的pod库编译时间减少 <strong>40-70%</strong></li>
<li><strong>磁盘 I/O 减少</strong>：避免大量文件的重复写入</li>
</ul>
</li>
<li>
<p><strong>原理</strong>：</p>
<ol>
<li><strong>哈希比对</strong>：计算 Podfile、Podspecs 和本地文件的哈希值</li>
<li><strong>变更检测</strong>：仅处理哈希值发生变化的 Pod</li>
<li><strong>状态缓存</strong>：在 <code>Pods/.incremental_cache</code> 目录保存安装状态</li>
<li><strong>智能更新</strong>：保持未变更 Pod 的项目引用不变</li>
</ol>
</li>
<li>
<p><strong>缺点</strong>：</p>
<ol>
<li><strong>状态管理复杂</strong>：缓存状态可能损坏，需要手动清理</li>
<li><strong>首次无优势</strong>：新环境或清理缓存后首次运行无优化效果</li>
<li><strong>依赖条件</strong>：必须同时启用 <code>generate_multiple_pod_projects: true</code></li>
<li><strong>调试困难</strong>：缓存不一致时可能出现难以复现的问题</li>
</ol>
</li>
<li>
<p><strong>推荐场景</strong>：</p>
<ul>
<li>开发环境中频繁执行 <code>pod install</code></li>
<li>CI/CD 流水线，有良好的缓存策略</li>
<li>项目 Pod 依赖稳定，不频繁变动</li>
</ul>
</li>
<li>
<p><strong>用法</strong>：</p>
<pre><code class="hljs language-ruby" lang="ruby">install! <span class="hljs-string">'cocoapods'</span>,
  <span class="hljs-symbol">generate_multiple_pod_projects:</span> <span class="hljs-literal">true</span>,
  <span class="hljs-symbol">incremental_installation:</span> <span class="hljs-literal">true</span>
</code></pre>
</li>
<li>
<p><strong>缓存清理</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 清理增量缓存（遇到问题时）</span>
<span class="hljs-built_in">rm</span> -rf Pods/.incremental_cache

<span class="hljs-comment"># 完整重置</span>
<span class="hljs-built_in">rm</span> -rf Pods Podfile.lock Pods/.incremental_cache
pod install
</code></pre>
</li>
</ul>
<h3 data-id="heading-5">🏗️ 二、模块化与架构类</h3>
<h4 data-id="heading-6"><strong>4. <code>generate_target_xcconfig_fragments: true</code></strong></h4>
<ul>
<li><strong>基本说明</strong>：
为每个 Target 生成独立的 <code>.xcconfig</code> 配置文件片段，而不是将所有配置合并到全局文件。</li>
</ul>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 传统方式（generate_target_xcconfig_fragments: false）：</span>
<span class="hljs-title class_">Pods</span>/
  └── <span class="hljs-title class_">Target</span> <span class="hljs-title class_">Support</span> <span class="hljs-title class_">Files</span>/
        └── <span class="hljs-title class_">Pods</span>-<span class="hljs-title class_">YourApp</span>.xcconfig     <span class="hljs-comment"># 所有Pod配置合并到一个文件</span>
              ├── <span class="hljs-comment"># Alamofire 设置</span>
              ├── <span class="hljs-comment"># SDWebImage 设置  </span>
              └── <span class="hljs-comment"># 其他所有Pod设置</span>

<span class="hljs-comment"># 新方式（generate_target_xcconfig_fragments: true）：</span>
<span class="hljs-title class_">Pods</span>/
  └── <span class="hljs-title class_">Target</span> <span class="hljs-title class_">Support</span> <span class="hljs-title class_">Files</span>/
        ├── <span class="hljs-title class_">Pods</span>-<span class="hljs-title class_">YourApp</span>.xcconfig          <span class="hljs-comment"># 主配置文件</span>
        ├── <span class="hljs-title class_">Pods</span>-<span class="hljs-title class_">YourApp</span>.alamofire.xcconfig   <span class="hljs-comment"># Alamofire配置片段</span>
        ├── <span class="hljs-title class_">Pods</span>-<span class="hljs-title class_">YourApp</span>.sdwebimage.xcconfig  <span class="hljs-comment"># SDWebImage配置片段</span>
        └── ...                              <span class="hljs-comment"># 其他Pod配置片段</span>
</code></pre>
<ul>
<li>
<p><strong>好处</strong>：</p>
<ul>
<li><strong>配置隔离清晰</strong>：每个 Pod 的编译设置独立管理</li>
<li><strong>调试方便</strong>：可以单独查看和修改某个 Pod 的配置</li>
<li><strong>避免全局污染</strong>：减少配置冲突的可能性</li>
<li><strong>易于覆盖</strong>：主项目可以针对特定 Pod 进行配置覆盖</li>
</ul>
</li>
<li>
<p><strong>原理</strong>：</p>
<ol>
<li><strong>配置分片</strong>：将原本合并的配置拆分为多个文件</li>
<li><strong>引用链</strong>：主 <code>.xcconfig</code> 通过 <code>#include</code> 引用各个片段</li>
<li><strong>按需加载</strong>：Xcode 只加载需要的配置片段</li>
</ol>
</li>
<li>
<p><strong>缺点</strong>：</p>
<ol>
<li><strong>文件数量激增</strong>：每个 Pod 对应一个配置文件，管理稍复杂</li>
<li><strong>配置覆盖复杂</strong>：主项目需要覆盖特定 Pod 配置时步骤更多</li>
<li><strong>Xcode 界面混乱</strong>：项目导航器中 <code>.xcconfig</code> 文件数量明显增加</li>
<li><strong>初学者困惑</strong>：配置结构更复杂，学习成本增加</li>
</ol>
</li>
<li>
<p><strong>推荐场景</strong>：</p>
<ul>
<li>需要精细控制各个 Pod 编译选项的项目</li>
<li>中大型团队，需要明确的配置责任划分</li>
<li>频繁调试和修改 Pod 编译设置的场景</li>
</ul>
</li>
</ul>
<h4 data-id="heading-7"><strong>5. <code>deterministic_uuids: true</code></strong></h4>
<ul>
<li><strong>基本说明</strong>：
控制 Xcode 项目文件中各种元素 UUID 的生成方式，确保每次 <code>pod install</code> 生成相同的 UUID。</li>
</ul>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 非确定性UUID（默认，deterministic_uuids: false）：</span>
<span class="hljs-comment"># 每次 pod install 生成随机UUID：</span>
<span class="hljs-title class_">PBXProject</span> <span class="hljs-variable constant_">UUID</span>: <span class="hljs-string">"A1B2C3D4-E5F6-7890-ABCD-EF1234567890"</span>  <span class="hljs-comment"># 每次不同</span>
<span class="hljs-title class_">PBXGroup</span> <span class="hljs-variable constant_">UUID</span>: <span class="hljs-string">"B2C3D4E5-F678-9012-3456-7890ABCDEF12"</span>     <span class="hljs-comment"># 每次不同</span>

<span class="hljs-comment"># 确定性UUID（deterministic_uuids: true）：</span>
<span class="hljs-comment"># 基于内容哈希生成固定UUID：</span>
<span class="hljs-title class_">PBXProject</span> <span class="hljs-variable constant_">UUID</span>: <span class="hljs-string">"8F9A1B2C-3D4E-5F67-89AB-CDEF01234567"</span>  <span class="hljs-comment"># 始终相同</span>
<span class="hljs-title class_">PBXGroup</span> <span class="hljs-variable constant_">UUID</span>: <span class="hljs-string">"9A1B2C3D-4E5F-6789-01AB-23456789CDEF"</span>     <span class="hljs-comment"># 始终相同</span>
</code></pre>
<ul>
<li>
<p><strong>好处</strong>：</p>
<ul>
<li><strong>版本控制稳定</strong>：极大减少 <code>.pbxproj</code> 文件的合并冲突</li>
<li><strong>CI/CD 一致性</strong>：不同机器、不同时间生成的产物完全一致</li>
<li><strong>可重复构建</strong>：确保构建过程的确定性</li>
<li><strong>团队协作顺畅</strong>：避免因 UUID 变化导致的文件变动</li>
</ul>
</li>
<li>
<p><strong>原理</strong>：</p>
<ol>
<li><strong>哈希生成</strong>：基于文件路径、类型等属性计算哈希值</li>
<li><strong>UUID 派生</strong>：从哈希值派生成固定格式的 UUID</li>
<li><strong>内容寻址</strong>：相同内容始终生成相同 UUID</li>
</ol>
</li>
<li>
<p><strong>缺点</strong>：</p>
<ol>
<li><strong>UUID 泄露风险</strong>：通过 UUID 可能推断出项目内部结构</li>
<li><strong>迁移成本</strong>：从非确定性切换到确定性需要重生成所有项目文件</li>
<li><strong>工具兼容性</strong>：某些第三方工具可能依赖随机 UUID 的特性</li>
<li><strong>历史问题</strong>：已有的项目切换时可能遇到历史遗留问题</li>
</ol>
</li>
<li>
<p><strong>推荐场景</strong>：</p>
<ul>
<li>团队协作项目，多人同时修改 Podfile</li>
<li>CI/CD 流水线，需要确保构建一致性</li>
<li>大型项目，<code>.pbxproj</code> 文件经常产生合并冲突</li>
<li>项目初期就开始使用，避免中途切换</li>
</ul>
</li>
<li>
<p><strong>用法</strong>：</p>
<pre><code class="hljs language-ruby" lang="ruby">install! <span class="hljs-string">'cocoapods'</span>,
  <span class="hljs-symbol">deterministic_uuids:</span> <span class="hljs-literal">true</span>
</code></pre>
</li>
<li>
<p><strong>迁移步骤</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 从非确定性切换到确定性的完整步骤</span>
1. 备份当前 Pods 目录
2. 修改 Podfile 添加 deterministic_uuids: <span class="hljs-literal">true</span>
3. 清理旧项目文件：
   <span class="hljs-built_in">rm</span> -rf Pods Podfile.lock
4. 重新安装：
   pod install
5. 提交所有变更到版本控制
</code></pre>
</li>
</ul>
<h3 data-id="heading-8">💾 三、缓存与存储优化类</h3>
<h4 data-id="heading-9"><strong>6. <code>share_schemes_for_development: true</code></strong></h4>
<ul>
<li><strong>基本说明</strong>：
为开发中的 Pod 自动生成和共享 Xcode schemes，方便直接运行和调试 Pod 代码。</li>
</ul>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 未启用时（默认）：</span>
<span class="hljs-comment"># Pod 的 scheme 通常不可见或需要手动创建</span>
<span class="hljs-comment"># 只能通过主项目间接调试 Pod 代码</span>

<span class="hljs-comment"># 启用后（share_schemes_for_development: true）：</span>
<span class="hljs-comment"># 每个 Pod 自动生成开发 scheme：</span>
<span class="hljs-title class_">Alamofire</span>.xcodeproj
  └── xcshareddata/xcschemes/
        └── <span class="hljs-title class_">Alamofire</span>.xcscheme      <span class="hljs-comment"># 自动生成，可直接运行</span>
<span class="hljs-title class_">SDWebImage</span>.xcodeproj
  └── xcshareddata/xcschemes/
        └── <span class="hljs-title class_">SDWebImage</span>.xcscheme     <span class="hljs-comment"># 自动生成，可直接运行</span>
</code></pre>
<ul>
<li>
<p><strong>好处</strong>：</p>
<ul>
<li><strong>直接调试 Pod</strong>：可以在 Xcode 中直接运行和测试 Pod 代码</li>
<li><strong>开发体验好</strong>：便于修改和验证第三方库</li>
<li><strong>单元测试方便</strong>：可以直接运行 Pod 自带的测试</li>
<li><strong>学习第三方库</strong>：通过运行示例代码快速理解库的使用</li>
</ul>
</li>
<li>
<p><strong>原理</strong>：</p>
<ol>
<li><strong>Scheme 生成</strong>：为每个 Pod 的 Target 创建对应的 <code>.xcscheme</code> 文件</li>
<li><strong>共享配置</strong>：将 scheme 放在 <code>xcshareddata</code> 目录，供所有用户使用</li>
<li><strong>构建配置</strong>：配置适当的构建目标和运行环境</li>
</ol>
</li>
<li>
<p><strong>缺点</strong>：</p>
<ol>
<li><strong>Scheme 污染</strong>：Xcode Scheme 列表可能变得非常长</li>
<li><strong>性能开销</strong>：每个 Pod 生成 scheme 增加 <code>pod install</code> 时间约 5-10%</li>
<li><strong>命名冲突</strong>：不同 Pod 可能有相同 Target 名称，导致 scheme 名称冲突</li>
<li><strong>维护负担</strong>：需要管理大量 scheme 文件</li>
</ol>
</li>
<li>
<p><strong>推荐场景</strong>：</p>
<ul>
<li>需要频繁修改和调试 Pod 代码的项目</li>
<li>开发自定义 Pod 或 Fork 第三方库时</li>
<li>学习和研究第三方库实现原理</li>
<li>需要直接运行 Pod 的测试用例</li>
</ul>
</li>
<li>
<p><strong>用法</strong>：</p>
<pre><code class="hljs language-ruby" lang="ruby">install! <span class="hljs-string">'cocoapods'</span>,
  <span class="hljs-symbol">share_schemes_for_development:</span> <span class="hljs-literal">true</span>
    <span class="hljs-comment"># 只为特定 Pod 启用 scheme 共享</span>
    pod <span class="hljs-string">'MyCustomPod'</span>, <span class="hljs-symbol">:share_schemes_for_development</span> =&gt; <span class="hljs-literal">true</span>
    pod <span class="hljs-string">'OtherPod'</span>  <span class="hljs-comment"># 默认不共享 scheme</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-10"><strong>7. <code>preserve_pod_file_structure: true</code></strong></h4>
<ul>
<li><strong>基本说明</strong>：
保持 Pod 的原始文件目录结构，而不是将文件扁平化处理。</li>
</ul>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 默认情况（preserve_pod_file_structure: false）：</span>
<span class="hljs-comment"># Pod 文件被扁平化到单个目录</span>
<span class="hljs-title class_">Pods</span>/<span class="hljs-title class_">Alamofire</span>/
  ├── <span class="hljs-title class_">AFNetworking</span>.h
  ├── <span class="hljs-title class_">AFURLSessionManager</span>.h
  ├── <span class="hljs-title class_">AFHTTPSessionManager</span>.h
  └── ... 所有.h和.m文件在同一层级

<span class="hljs-comment"># 启用后（preserve_pod_file_structure: true）：</span>
<span class="hljs-comment"># 保持原始目录结构</span>
<span class="hljs-title class_">Pods</span>/<span class="hljs-title class_">Alamofire</span>/
  ├── <span class="hljs-title class_">Source</span>/
  │   ├── <span class="hljs-title class_">Core</span>/
  │   │   ├── <span class="hljs-title class_">AFURLSessionManager</span>.h
  │   │   └── <span class="hljs-title class_">AFURLSessionManager</span>.m
  │   └── <span class="hljs-title class_">Serialization</span>/
  │       ├── <span class="hljs-title class_">AFURLRequestSerialization</span>.h
  │       └── <span class="hljs-title class_">AFURLResponseSerialization</span>.h
  └── <span class="hljs-title class_">UIKit</span>+<span class="hljs-title class_">AFNetworking</span>/
      └── <span class="hljs-title class_">AFImageDownloader</span>.h
</code></pre>
<ul>
<li>
<p><strong>好处</strong>：</p>
<ul>
<li><strong>结构清晰</strong>：便于查看和理解第三方库的组织结构</li>
</ul>
</li>
<li>
<p><strong>原理</strong>：</p>
<ol>
<li><strong>结构保持</strong>：在 <code>Pods/</code> 目录中镜像 Pod 的原始文件结构</li>
<li><strong>引用路径保持</strong>：头文件引用路径保持不变</li>
<li><strong>资源保持</strong>：资源文件保持原始相对路径</li>
</ol>
</li>
<li>
<p><strong>缺点</strong>：</p>
<ol>
<li><strong>头文件搜索路径复杂</strong>：需要配置更复杂的 Header Search Paths</li>
<li><strong>构建优化失效</strong>：某些构建优化（如预编译头）可能失效</li>
<li><strong>可能暴露内部结构</strong>：某些 Pod 的内部结构可能不希望被查看</li>
<li><strong>项目导航稍乱</strong>：Xcode 中文件层级更深，导航稍麻烦</li>
</ol>
</li>
<li>
<p><strong>推荐场景</strong>：</p>
<ul>
<li>学习和研究第三方库代码结构</li>
<li>某些 Pod 必须保持特定目录结构才能工作</li>
<li>需要精确控制头文件包含路径的项目</li>
</ul>
</li>
</ul>
<h3 data-id="heading-11">🛡️ 四、稳定性与兼容性类</h3>
<h4 data-id="heading-12"><strong>8. <code>warn_for_multiple_dependency_sources: true</code></strong></h4>
<ul>
<li><strong>基本说明</strong>：
检测并警告同一个 Pod 从多个源引入的情况，避免潜在的版本冲突。</li>
</ul>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 可能产生警告的场景：</span>
<span class="hljs-comment"># Podfile 配置：</span>
pod <span class="hljs-string">'Alamofire'</span>, <span class="hljs-string">'~&gt; 5.0'</span>           <span class="hljs-comment"># 从官方源</span>
pod <span class="hljs-string">'Alamofire'</span>, <span class="hljs-symbol">:git</span> =&gt; <span class="hljs-string">'https://github.com/Alamofire/Alamofire.git'</span>  <span class="hljs-comment"># 从Git源</span>

<span class="hljs-comment"># 安装时警告：</span>
[!] <span class="hljs-string">'Alamofire'</span> is sourced from <span class="hljs-string">`https://github.com/CocoaPods/Specs.git`</span> 
    <span class="hljs-keyword">and</span> <span class="hljs-string">`https://github.com/Alamofire/Alamofire.git`</span> <span class="hljs-keyword">in</span> <span class="hljs-string">`MyApp`</span>.
</code></pre>
<ul>
<li>
<p><strong>好处</strong>：</p>
<ul>
<li><strong>提前发现问题</strong>：在安装阶段发现潜在的依赖冲突</li>
<li><strong>避免运行时问题</strong>：防止同一库的不同版本被链接</li>
<li><strong>配置清晰</strong>：确保依赖来源明确和一致</li>
<li><strong>维护友好</strong>：便于理解和维护复杂的依赖关系</li>
</ul>
</li>
<li>
<p><strong>原理</strong>：</p>
<ol>
<li><strong>源追踪</strong>：记录每个 Pod 的安装来源（Specs repo、Git、本地路径等）</li>
<li><strong>冲突检测</strong>：检查同一 Pod 是否有多个不同来源</li>
<li><strong>警告输出</strong>：在 <code>pod install</code> 过程中输出明确的警告信息</li>
</ol>
</li>
<li>
<p><strong>缺点</strong>：</p>
<ol>
<li><strong>警告噪声</strong>：某些合法场景（如测试不同分支）也会产生警告</li>
<li><strong>可能误报</strong>：复杂依赖图可能产生误警告</li>
<li><strong>配置繁琐</strong>：需要显式指定 source 来消除警告</li>
</ol>
</li>
<li>
<p><strong>推荐场景</strong>：</p>
<ul>
<li>复杂的多源依赖项目</li>
<li>团队协作，确保依赖配置一致</li>
<li>长期维护的项目，需要清晰的依赖管理</li>
</ul>
</li>
<li>
<p><strong>消除警告</strong>：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 明确指定 source 消除警告</span>
source <span class="hljs-string">'https://github.com/CocoaPods/Specs.git'</span>

pod <span class="hljs-string">'Alamofire'</span>, <span class="hljs-string">'~&gt; 5.0'</span>

<span class="hljs-comment"># 或者显式指定不同名称</span>
pod <span class="hljs-string">'Alamofire'</span>, <span class="hljs-symbol">:git</span> =&gt; <span class="hljs-string">'https://github.com/Alamofire/Alamofire.git'</span>, <span class="hljs-symbol">:branch</span> =&gt; <span class="hljs-string">'feature'</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-13"><strong>9. <code>deduplicate_targets: true</code></strong></h4>
<ul>
<li><strong>基本说明</strong>：
自动检测和合并项目中重复的 Target，减少冗余配置。</li>
</ul>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 重复Target示例：</span>
<span class="hljs-comment"># 多个Pod依赖同一个库的不同版本</span>
pod <span class="hljs-string">'JSONKit'</span>, <span class="hljs-string">'~&gt; 1.4'</span>
pod <span class="hljs-string">'AFNetworking'</span>, <span class="hljs-string">'~&gt; 4.0'</span>  <span class="hljs-comment"># AFNetworking 内部依赖 JSONKit ~&gt; 1.5</span>

<span class="hljs-comment"># 未启用去重时：</span>
<span class="hljs-title class_">Pods</span>.xcodeproj
  ├── <span class="hljs-title class_">Target</span>: <span class="hljs-title class_">JSONKit</span> (<span class="hljs-number">1.4</span>)
  └── <span class="hljs-title class_">Target</span>: <span class="hljs-title class_">JSONKit</span> (<span class="hljs-number">1.5</span>)  <span class="hljs-comment"># 重复的Target</span>

<span class="hljs-comment"># 启用去重后：</span>
<span class="hljs-title class_">Pods</span>.xcodeproj
  └── <span class="hljs-title class_">Target</span>: <span class="hljs-title class_">JSONKit</span> (<span class="hljs-number">1.5</span>)  <span class="hljs-comment"># 自动选择较高版本，合并为一个</span>
</code></pre>
<ul>
<li>
<p><strong>好处</strong>：</p>
<ul>
<li><strong>避免重复链接</strong>：防止同一库被多次链接到最终产物</li>
<li><strong>减少冲突</strong>：避免符号重复定义的链接错误</li>
</ul>
</li>
<li>
<p><strong>原理</strong>：</p>
<ol>
<li><strong>依赖分析</strong>：分析所有 Pod 的依赖关系图</li>
<li><strong>版本冲突解决</strong>：按照语义化版本规则解决版本冲突</li>
<li><strong>Target 合并</strong>：将相同的库合并到单个 Target</li>
<li><strong>引用更新</strong>：更新所有依赖引用指向合并后的 Target</li>
</ol>
</li>
<li>
<p><strong>缺点</strong>：</p>
<ol>
<li><strong>合并风险</strong>：自动合并可能掩盖重要的版本差异</li>
<li><strong>调试困难</strong>：难以确定实际使用的是哪个版本</li>
<li><strong>意外行为</strong>：可能意外使用非预期的版本</li>
<li><strong>控制权丧失</strong>：自动决策可能不符合项目需求</li>
</ol>
</li>
<li>
<p><strong>推荐场景</strong>：</p>
<ul>
<li>依赖关系复杂的项目</li>
<li>希望保持项目结构简洁</li>
<li>信任 CocoaPods 的版本冲突解决策略</li>
</ul>
</li>
<li>
<p><strong>版本冲突策略</strong>：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># CocoaPods 的版本选择策略：</span>
<span class="hljs-comment"># 1. 严格版本要求优先</span>
<span class="hljs-comment"># 2. 较高版本优先（在兼容范围内）</span>
<span class="hljs-comment"># 3. 显式指定的版本优先于传递依赖</span>

<span class="hljs-comment"># 可以通过:dependency 控制</span>
pod <span class="hljs-string">'MyPod'</span>, <span class="hljs-string">'~&gt; 1.0'</span>
pod <span class="hljs-string">'OtherPod'</span>, <span class="hljs-symbol">:dependency</span> =&gt; [<span class="hljs-string">'MyPod'</span>, <span class="hljs-string">'~&gt; 1.1'</span>]  <span class="hljs-comment"># 强制使用特定版本</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-14"><strong>10. <code>lock_pod_sources: true</code></strong></h4>
<ul>
<li><strong>基本说明</strong>：
锁定 Pod 的源信息，确保每次安装使用相同的源代码版本。</li>
</ul>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># Podfile.lock 中锁定的源信息：</span>
<span class="hljs-variable constant_">PODS</span>:
  - <span class="hljs-title class_">Alamofire</span> (<span class="hljs-number">5.6</span>.<span class="hljs-number">1</span>)
  - <span class="hljs-title class_">SDWebImage</span> (<span class="hljs-number">5.15</span>.<span class="hljs-number">0</span>)

<span class="hljs-variable constant_">EXTERNAL</span> <span class="hljs-variable constant_">SOURCES</span>:
  <span class="hljs-title class_">MyCustomPod</span>:
    <span class="hljs-symbol">:git</span>: <span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/company</span><span class="hljs-regexp">/MyCustomPod.git
    :commit: a1b2c3d4e5f678901234567890abcdef12345678  # 锁定具体commit
  AnotherPod:
    :path: ../</span><span class="hljs-title class_">LocalPods</span>/<span class="hljs-title class_">AnotherPod</span>  <span class="hljs-comment"># 锁定本地路径</span>
</code></pre>
<ul>
<li>
<p><strong>好处</strong>：</p>
<ul>
<li><strong>构建确定性</strong>：确保不同时间、不同环境的构建结果一致</li>
<li><strong>避免意外更新</strong>：防止 Git 仓库更新导致不可预期的变化</li>
<li><strong>安全可控</strong>：锁定已知可工作的版本，减少风险</li>
<li><strong>团队一致性</strong>：确保团队成员使用相同的代码版本</li>
</ul>
</li>
<li>
<p><strong>原理</strong>：</p>
<ol>
<li><strong>源信息记录</strong>：在 <code>Podfile.lock</code> 中记录每个 Pod 的精确来源</li>
<li><strong>哈希锁定</strong>：对于 Git 源，记录具体的 commit SHA</li>
<li><strong>路径锁定</strong>：对于本地路径，记录完整路径信息</li>
<li><strong>严格校验</strong>：安装时严格校验源信息是否匹配</li>
</ol>
</li>
<li>
<p><strong>缺点</strong>：</p>
<ol>
<li><strong>安全更新延迟</strong>：需要手动更新锁定的依赖</li>
<li><strong>锁文件膨胀</strong>：<code>Podfile.lock</code> 可能变得很大</li>
<li><strong>团队同步成本</strong>：锁文件变更需要团队协调更新</li>
<li><strong>灵活性降低</strong>：无法自动获取最新修复或特性</li>
</ol>
</li>
<li>
<p><strong>推荐场景</strong>：</p>
<ul>
<li>生产环境构建</li>
<li>需要严格可重复构建的项目</li>
<li>团队协作，确保环境一致</li>
<li>对稳定性要求极高的项目</li>
</ul>
</li>
<li>
<p><strong>更新策略</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 更新特定 Pod 到最新版本</span>
pod update Alamofire

<span class="hljs-comment"># 更新所有 Pod（谨慎使用）</span>
pod update

<span class="hljs-comment"># 检查可用更新但不实际更新</span>
pod outdated
</code></pre>
</li>
</ul>
<h3 data-id="heading-15">⚙️ 五、实验性/高级功能类</h3>
<h4 data-id="heading-16"><strong>11. <code>use_frameworks! :linkage =&gt; :static</code></strong></h4>
<ul>
<li><strong>基本说明</strong>：
将动态框架改为静态链接，改变库的链接方式和运行时行为。</li>
</ul>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 不同链接方式对比：</span>
<span class="hljs-comment"># 1. 动态框架（默认，use_frameworks!）：</span>
<span class="hljs-comment">#    运行时加载，多个App可共享，支持热更新</span>
<span class="hljs-comment">#    文件: Alamofire.framework (包含二进制和资源)</span>

<span class="hljs-comment"># 2. 静态框架（use_frameworks! :linkage =&gt; :static）：</span>
<span class="hljs-comment">#    编译时链接，直接嵌入App二进制</span>
<span class="hljs-comment">#    文件: libAlamofire.a (静态库) + 头文件</span>

<span class="hljs-comment"># 3. 静态库（不使用use_frameworks!）：</span>
<span class="hljs-comment">#    传统静态库方式</span>
<span class="hljs-comment">#    文件: libAlamofire.a + 头文件 + 资源bundle</span>
</code></pre>
<ul>
<li>
<p><strong>好处</strong>：</p>
<ul>
<li><strong>启动速度提升</strong>：减少动态库加载时间，冷启动速度提升 <strong>10-30%</strong></li>
<li><strong>包体积可能减小</strong>：去除动态框架的封装开销</li>
<li><strong>部署简化</strong>：不需要关心动态库的签名和部署</li>
<li><strong>兼容性更好</strong>：避免动态库版本冲突问题</li>
</ul>
</li>
<li>
<p><strong>原理</strong>：</p>
<ol>
<li><strong>链接方式改变</strong>：从动态链接（<code>@rpath</code>）改为静态链接</li>
<li><strong>二进制合并</strong>：库代码直接嵌入主二进制，而不是单独的文件</li>
<li><strong>符号解析</strong>：所有符号在链接时解析，而不是运行时</li>
</ol>
</li>
<li>
<p><strong>缺点</strong>：</p>
<ol>
<li><strong>二进制兼容性问题</strong>：某些 Pod 明确要求动态链接</li>
<li><strong>符号冲突风险</strong>：静态链接可能暴露私有符号导致冲突</li>
<li><strong>调试信息缺失</strong>：崩溃堆栈可能不清晰</li>
<li><strong>动态库依赖问题</strong>：依赖动态库的 Pod 无法使用</li>
<li><strong>Swift 运行时问题</strong>：某些 Swift 特性可能受影响</li>
</ol>
</li>
<li>
<p><strong>兼容性检查清单</strong>：
✅ <strong>支持</strong>：</p>
<ul>
<li>纯 Swift Pod，不依赖 Objective-C 动态特性</li>
<li>不包含 <code>vendored_frameworks</code></li>
<li>不依赖资源包（或者资源处理正确）</li>
<li>不包含 <code>pre_install</code>/<code>post_install</code> 钩子修改链接设置</li>
</ul>
<p>❌ <strong>不支持</strong>：</p>
<ul>
<li>包含 <code>s.vendored_frameworks</code> 的 Pod</li>
<li>依赖动态系统框架的 Pod</li>
<li>使用 <code>@objc</code> 动态派发的复杂场景</li>
<li>需要运行时加载的插件式架构</li>
</ul>
</li>
<li>
<p><strong>推荐场景</strong>：</p>
<ul>
<li>对启动性能要求极高的 App</li>
<li>希望简化部署流程</li>
<li>Pod 都经过兼容性验证</li>
<li>新项目，可以从开始就规划静态链接</li>
</ul>
</li>
<li>
<p><strong>用法</strong>：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 全局启用静态框架</span>
use_frameworks! <span class="hljs-symbol">:linkage</span> =&gt; <span class="hljs-symbol">:static</span>

<span class="hljs-comment"># 或针对特定 Pod</span>
use_frameworks!
pod <span class="hljs-string">'DynamicPod'</span>  <span class="hljs-comment"># 使用动态框架</span>
pod <span class="hljs-string">'StaticPod'</span>, <span class="hljs-symbol">:linkage</span> =&gt; <span class="hljs-symbol">:static</span>  <span class="hljs-comment"># 使用静态框架</span>
</code></pre>
</li>
<li>
<p><strong>兼容性测试命令</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查哪些Pod可能有问题</span>
pod install --verbose | grep -i <span class="hljs-string">"static\|dynamic\|linkage"</span>

<span class="hljs-comment"># 测试构建</span>
xcodebuild -workspace App.xcworkspace -scheme App clean build
</code></pre>
</li>
</ul>
<h4 data-id="heading-17"><strong>12. <code>skip_pods_project_generation: true</code></strong></h4>
<ul>
<li><strong>基本说明</strong>：
跳过 Pods 项目的生成，直接将 Pod 文件作为源文件集成到主项目中。</li>
</ul>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 传统方式（skip_pods_project_generation: false）：</span>
<span class="hljs-title class_">App</span>.xcworkspace
  ├── <span class="hljs-title class_">App</span>.xcodeproj
  └── <span class="hljs-title class_">Pods</span>.xcodeproj  <span class="hljs-comment"># 独立的Pods项目</span>

<span class="hljs-comment"># 跳过生成（skip_pods_project_generation: true）：</span>
<span class="hljs-title class_">App</span>.xcworkspace
  └── <span class="hljs-title class_">App</span>.xcodeproj   <span class="hljs-comment"># 所有Pod文件直接作为源文件加入</span>
        ├── <span class="hljs-title class_">Source</span>/
        │   └── <span class="hljs-title class_">App</span> files...
        └── <span class="hljs-title class_">Pods</span>/     <span class="hljs-comment"># Pod文件作为项目的一部分</span>
            ├── <span class="hljs-title class_">Alamofire</span>/
            ├── <span class="hljs-title class_">SDWebImage</span>/
            └── ...
</code></pre>
<ul>
<li>
<p><strong>好处</strong>：</p>
<ul>
<li><strong>极简项目结构</strong>：只有一个 Xcode 项目文件</li>
<li><strong>构建配置统一</strong>：所有代码使用相同的构建设置</li>
<li><strong>无需 workspace</strong>：可以直接打开 <code>.xcodeproj</code> 文件工作</li>
<li><strong>某些场景简单</strong>：对于非常简单的项目可能更直观</li>
</ul>
</li>
<li>
<p><strong>原理</strong>：</p>
<ol>
<li><strong>项目结构扁平化</strong>：不生成独立的 <code>Pods.xcodeproj</code></li>
<li><strong>文件直接引用</strong>：将 Pod 文件直接添加到主项目的文件引用树</li>
<li><strong>配置合并</strong>：Pod 的构建设置合并到主项目配置中</li>
</ol>
</li>
<li>
<p><strong>缺点</strong>：</p>
<ol>
<li><strong>高级功能丧失</strong>：无法单独编译、测试、分析 Pod</li>
<li><strong>调试极其困难</strong>：难以设置 Pod 代码的断点和调试</li>
<li><strong>社区支持差</strong>：使用人数少，问题排查资源稀缺</li>
<li><strong>升级风险高</strong>：CocoaPods 版本更新可能破坏此功能</li>
<li><strong>与生态不兼容</strong>：很多工具和插件假设 Pods 项目存在</li>
<li><strong>配置冲突</strong>：Pod 与主项目的构建设置可能冲突</li>
</ol>
</li>
<li>
<p><strong>强烈建议</strong>：
仅用于：</p>
<ul>
<li>原型验证或概念验证项目</li>
<li>极其简单的个人项目（Pod 数量 &lt; 3）</li>
<li>短期存在的测试项目</li>
</ul>
<p>绝不用于：</p>
<ul>
<li>生产环境项目</li>
<li>团队协作项目</li>
<li>长期维护的项目</li>
<li>包含复杂 Pod 依赖的项目</li>
</ul>
</li>
<li>
<p><strong>退出策略</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 从 skip_pods_project_generation 切换回标准模式的步骤：</span>
1. 备份项目
2. 修改 Podfile，移除 skip_pods_project_generation: <span class="hljs-literal">true</span>
3. 清理所有 Pod 相关文件：
   <span class="hljs-built_in">rm</span> -rf Pods Podfile.lock App.xcworkspace
4. 从主项目中移除所有 Pod 文件引用
5. 重新安装：
   pod install
6. 验证构建是否正常
</code></pre>
</li>
</ul>
<h2 data-id="heading-18">🔍 监控与验证方法</h2>
<h3 data-id="heading-19">性能监控脚本</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># monitor_pods_performance.sh</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"=== CocoaPods 性能监控 ==="</span>

<span class="hljs-comment"># 1. 测量 pod install 时间</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"1. 测量 pod install 时间:"</span>
time pod install 2&gt;&amp;1 | grep real

<span class="hljs-comment"># 2. 检查生成的项目结构</span>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n2. 项目结构统计:"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"独立项目文件数: <span class="hljs-subst">$(find Pods -name <span class="hljs-string">"*.xcodeproj"</span> | wc -l)</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Xcconfig 文件数: <span class="hljs-subst">$(find Pods -name <span class="hljs-string">"*.xcconfig"</span> | wc -l)</span>"</span>

<span class="hljs-comment"># 3. 检查增量缓存</span>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n3. 增量缓存状态:"</span>
<span class="hljs-keyword">if</span> [ -d <span class="hljs-string">"Pods/.incremental_cache"</span> ]; <span class="hljs-keyword">then</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"增量缓存已启用，大小: <span class="hljs-subst">$(du -sh Pods/.incremental_cache | cut -f1)</span>"</span>
<span class="hljs-keyword">else</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"增量缓存未启用"</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 4. 构建时间测试</span>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n4. 构建时间测试 (clean build):"</span>
xcodebuild clean -workspace App.xcworkspace -scheme App 2&gt;/dev/null
time xcodebuild -workspace App.xcworkspace -scheme App -showBuildTimingSummary 2&gt;&amp;1 | <span class="hljs-built_in">tail</span> -5
</code></pre>
<h3 data-id="heading-20">配置验证命令</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 验证各优化是否生效</span>
pod install --verbose 2&gt;&amp;1 | grep -E <span class="hljs-string">"(incremental|deterministic|multiple.*project)"</span>

<span class="hljs-comment"># 检查生成的 UUID 是否确定</span>
grep -r <span class="hljs-string">"projectReferences"</span> Pods/Pods.xcodeproj/project.pbxproj | <span class="hljs-built_in">head</span> -1

<span class="hljs-comment"># 验证静态链接</span>
otool -L App.app/App | grep -v <span class="hljs-string">"@rpath\|/usr/lib\|/System"</span>
</code></pre>
<h2 data-id="heading-21">⚠️ 问题排查指南</h2>






























<table><thead><tr><th>问题现象</th><th>可能原因</th><th>解决方案</th></tr></thead><tbody><tr><td><strong>构建失败：符号找不到</strong></td><td><code>disable_input_output_paths: true</code> + Podspec 配置错误</td><td>1. 临时禁用该选项测试<br/>2. 检查问题 Pod 的 spec 文件<br/>3. 确保资源文件路径正确</td></tr><tr><td><strong>Xcode 卡顿严重</strong></td><td><code>generate_multiple_pod_projects: true</code> + 项目过多</td><td>1. 减少项目生成粒度<br/>2. 升级 Xcode 和硬件<br/>3. 关闭 Xcode 的某些索引功能</td></tr><tr><td><strong>增量安装后构建异常</strong></td><td>增量缓存损坏</td><td>1. 清理缓存：<code>rm -rf Pods/.incremental_cache</code><br/>2. 完整重建：<code>rm -rf Pods Podfile.lock; pod install</code></td></tr><tr><td><strong>版本控制频繁冲突</strong></td><td>未启用 <code>deterministic_uuids: true</code></td><td>1. 启用确定性 UUID<br/>2. 团队统一执行完整重建<br/></td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：分层设计的取舍之道（从 “简单粗暴” 到依赖倒置）]]></title>    <link>https://juejin.cn/post/7586892413891035182</link>    <guid>https://juejin.cn/post/7586892413891035182</guid>    <pubDate>2025-12-23T15:57:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586892413891035182" data-draft-id="7586892413891018798" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：分层设计的取舍之道（从 “简单粗暴” 到依赖倒置）"/> <meta itemprop="keywords" content="后端,Go,领域驱动设计"/> <meta itemprop="datePublished" content="2025-12-23T15:57:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="喵个咪"/> <meta itemprop="url" content="https://juejin.cn/user/1350630784901262"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：分层设计的取舍之道（从 “简单粗暴” 到依赖倒置）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1350630784901262/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    喵个咪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T15:57:30.000Z" title="Tue Dec 23 2025 15:57:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读26分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：分层设计的取舍之道（从 “简单粗暴” 到依赖倒置）</h2>
<p>在后端开发领域，分层设计是破解系统复杂度、提升可维护性的“核心心法”。对于 GoWind Admin 这类企业级中后台框架而言，API 层、Service 层（业务逻辑层）与 Data 层（数据访问层）的交互模式，直接决定了框架的灵活性、开发效率与长期演进能力。其中，Service 层与 Data 层的耦合程度，更是架构设计的“关键胜负手”。​</p>
<p>本文将聚焦 GoWind Admin 的实际开发场景，深入剖析“Service 层直接引用 Data 层 Repo”（简单粗暴方案）、“基于依赖倒置的接口解耦”（工程化方案）以及“新增 biz 层的进阶方案”三种核心模式，拆解分层设计的取舍逻辑——架构设计没有“最优解”，只有“最适配当前场景的解”，尤其对于需要兼顾“开箱即用效率”与“企业级扩展需求”的中后台框架而言，平衡感至关重要。</p>
<h3 data-id="heading-1">一、分层设计的核心：先想清楚“为什么要分层”</h3>
<p>讨论取舍之前，我们必须先锚定分层设计的核心诉求——脱离业务场景的分层，都是“纸上谈兵”。对于 GoWind Admin 这类需要支撑多业务模块、多团队协作的中后台框架，分层的核心价值在于：</p>
<ul>
<li><strong>分离关注点</strong>：让各层聚焦核心职责——API 层只处理请求校验与协议转换，Service 层只封装业务规则与流程，Data 层只负责数据读写与存储适配，避免“一锅粥”式的代码冗余；</li>
<li><strong>提升可测试性</strong>：支持各层独立单元测试，无需依赖其他层的真实实现（如 Data 层的数据库），降低测试成本并提升测试覆盖率；</li>
<li><strong>增强可扩展性</strong>：修改某一层的实现时（如 Data 层替换 ORM、API 层新增 GRPC 协议），能最小化对其他层的影响，支撑框架长期演进；</li>
<li><strong>降低协作成本</strong>：明确的分层边界让团队分工更清晰（前端对接 API 层、后端开发聚焦 Service 层、数据团队优化 Data 层），避免跨层开发导致的冲突。</li>
</ul>
<p>结合 GoWind Admin 的代码结构，其核心分层逻辑清晰可追溯：</p>
<ul>
<li>API 层：对应 <code>api/protos</code>（协议定义）与 <code>api/gen</code>（生成的 HTTP/GRPC 代码），负责接收前端请求、校验参数格式、转换协议数据；</li>
<li>Service 层：对应 <code>app/admin/service/internal/service</code>，封装核心业务逻辑（如权限校验、数据组装、流程编排）；</li>
<li>Data 层：对应 <code>app/admin/service/internal/data</code>，包含 Repo（仓库）、ORM 操作、缓存适配等，是数据读写的“唯一入口”。</li>
</ul>
<p>需要强调的是，分层的本质是“trade-off（权衡）”：过度简化会导致耦合死锁（修改一处牵动全身），过度抽象会增加冗余成本（接口与实现的重复编码）。对于 GoWind Admin 这类“开箱即用”的框架，核心目标是在“快速落地业务”与“支撑长期扩展”之间找到精准平衡。</p>
<h3 data-id="heading-2">二、方案一：“简单粗暴”的直接引用——适配轻量场景与快速验证</h3>
<p>对于 GoWind Admin 的初期版本或轻量业务模块（如简单的日志查询、配置管理），“Service 层直接引用 Data 层 Repo”是最高效的落地方式。这种方案的核心是“放弃抽象、拥抱直接依赖”，用最小的代码成本完成功能落地。</p>
<h4 data-id="heading-3">1. 实现方式：Service 直连 Data Repo，无中间抽象</h4>
<p>该方案中，Data 层直接实现 Repo 类（无接口定义），Service 层通过导入 Data 包直接引用 Repo 实例，在 Service 方法中完成“数据查询 + 业务逻辑 + 数据组装”的全流程。以下是基于 GoWind Admin 部门管理模块的真实场景示例：</p>
<p>Data层：直接实现Repo（无接口，与Ent ORM强绑定）</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> data

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"context"</span>
    <span class="hljs-string">"go-wind-admin/app/admin/service/internal/data/ent"</span>
    <span class="hljs-string">"go-wind-admin/app/admin/service/internal/data/ent/department"</span>
)

<span class="hljs-comment">// DepartmentRepo 部门数据访问实现（直接耦合Ent模型）</span>
<span class="hljs-keyword">type</span> DepartmentRepo <span class="hljs-keyword">struct</span> {
    client *ent.Client <span class="hljs-comment">// 直接依赖Ent客户端</span>
}

<span class="hljs-comment">// NewDepartmentRepo 构造函数：创建Repo实例</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewDepartmentRepo</span><span class="hljs-params">(client *ent.Client)</span></span> *DepartmentRepo {
    <span class="hljs-keyword">return</span> &amp;DepartmentRepo{client: client}
}

<span class="hljs-comment">// GetByID 根据ID查询部门（直接实现查询逻辑，无接口约束）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *DepartmentRepo)</span></span> GetByID(ctx context.Context, id <span class="hljs-type">uint32</span>) (*ent.Department, <span class="hljs-type">error</span>) {
    <span class="hljs-keyword">return</span> r.client.Department.
        Query().
        Where(department.ID(id)).
        Only(ctx)
}
</code></pre>
<p>Service层：直接导入Data层Repo，强依赖实现</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> service

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"context"</span>
    <span class="hljs-string">"go-wind-admin/app/admin/service/internal/data"</span>
    dto <span class="hljs-string">"go-wind-admin/api/gen/go/user/service/v1"</span>
)

<span class="hljs-comment">// DepartmentService 部门业务逻辑实现</span>
<span class="hljs-keyword">type</span> DepartmentService <span class="hljs-keyword">struct</span> {
    deptRepo *data.DepartmentRepo <span class="hljs-comment">// 直接依赖Data层的具体实现</span>
}

<span class="hljs-comment">// NewDepartmentService 构造函数：注入Data层Repo实例</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewDepartmentService</span><span class="hljs-params">(deptRepo *data.DepartmentRepo)</span></span> *DepartmentService {
    <span class="hljs-keyword">return</span> &amp;DepartmentService{deptRepo: deptRepo}
}

<span class="hljs-comment">// GetDepartmentInfo 查询部门详情（直接调用Repo方法）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *DepartmentService)</span></span> GetDepartmentInfo(ctx context.Context, id <span class="hljs-type">uint32</span>) (*dto.DepartmentVO, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 1. 直接调用Data层Repo的具体方法</span>
    deptEnt, err := s.deptRepo.GetByID(ctx, id)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err <span class="hljs-comment">// 直接返回Data层错误（无抽象隔离）</span>
    }

    <span class="hljs-comment">// 2. 业务逻辑处理（如权限校验、状态转换）</span>
    <span class="hljs-keyword">if</span> deptEnt.Status == <span class="hljs-number">0</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"部门已禁用"</span>)
    }

    <span class="hljs-comment">// 3. 数据组装（Service层直接依赖Ent模型字段）</span>
    <span class="hljs-keyword">return</span> &amp;dto.DepartmentVO{
        ID:              deptEnt.ID,
        Name:            deptEnt.Name,
        OrganizationID:  deptEnt.OrganizationID,
        Status:          deptEnt.Status,
        CreatedAt:       deptEnt.CreatedAt.Format(<span class="hljs-string">"2006-01-02 15:04:05"</span>),
    }, <span class="hljs-literal">nil</span>
}
</code></pre>
<h4 data-id="heading-4">2. 核心优缺点：效率优先，牺牲灵活性</h4>
<p>这种方案的优缺点高度鲜明，完全围绕“快速落地”展开，适合 GoWind Admin 框架“开箱即用”的核心定位：</p>

























<table><thead><tr><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>开发效率极高：无需定义接口，直接导入调用，省去“接口-实现”的冗余编码，适合快速落地MVP或轻量模块；</td><td>耦合度极高：Service 层与 Data 层强绑定（依赖具体 Repo 类、Ent 模型），若替换 ORM（如从 Ent 改为 GORM）或调整 Repo 方法签名，需修改所有 Service 调用处；</td></tr><tr><td>架构极简无冗余：代码链路清晰（API→Service→Data），无中间抽象层，新人上手门槛低，可快速接入开发；</td><td>可测试性差：单元测试需依赖真实数据库（或 Ent 客户端），无法快速 Mock 数据，导致测试周期长、环境依赖高；</td></tr><tr><td>调试成本低：问题定位直接，可通过调用链路快速追踪到数据查询或业务逻辑问题，无需排查抽象层的适配问题；</td><td>扩展性缺失：若需支持多存储（如 MySQL/PostgreSQL 切换、加 Redis 缓存），需修改 Service 层代码，违反“开闭原则”；</td></tr><tr><td>适配框架“开箱即用”定位：可快速生成基础 CRUD 代码，降低中后台框架的初期使用成本；</td><td>业务迭代隐患：随着业务复杂度提升（如新增多租户隔离、数据权限控制），耦合会持续累积，后期重构成本指数级增加；</td></tr></tbody></table>
<h4 data-id="heading-5">3. 适用场景：精准匹配“轻量、快速、短期”需求</h4>
<p>这种方案并非“低端方案”，而是“适配特定场景的高效方案”，尤其适合 GoWind Admin 的以下使用场景：</p>
<ul>
<li><strong>轻量业务模块</strong>：如日志查询、系统配置、简单数据统计等，业务逻辑单一（以单表 CRUD 为主），无复杂规则或关联查询；</li>
<li><strong>MVP 验证阶段</strong>：需要快速落地核心功能，验证业务价值，无需考虑长期扩展（如内部工具、临时业务系统）；</li>
<li><strong>小团队协作场景</strong>：1-3 人团队开发，沟通成本低，无需通过抽象层规范协作边界；</li>
<li><strong>无多存储适配需求</strong>：明确长期使用单一存储（如仅用 MySQL），无切换 ORM、加缓存、读写分离的计划。</li>
</ul>
<p>例如，GoWind Admin 的初期版本中，“系统公告”模块就采用了这种方案——直接让 Service 调用 Data 层 Repo，快速实现“公告发布、查询、删除”功能，待后续用户量增长、需要加缓存或多租户隔离时，再进行架构升级。</p>
<h3 data-id="heading-6">三、方案二：依赖倒置的接口解耦——支撑企业级扩展与长期维护</h3>
<p>当 GoWind Admin 支撑的业务规模扩大（如接入多租户、多业务线）、团队人数增加，“直接引用”的耦合问题会逐渐暴露：修改 Data 层需联动修改大量 Service 代码、单元测试难以落地、多存储适配困难。此时，基于依赖倒置原则（DIP）的接口解耦方案，成为突破瓶颈的核心手段。</p>
<h4 data-id="heading-7">1. 依赖倒置的核心逻辑：抽象主导，解耦依赖</h4>
<p>依赖倒置原则（DIP）的核心是“颠倒依赖方向”，打破“高层模块依赖低层模块”的传统逻辑：</p>
<ul>
<li>高层模块（Service 层/Biz 层）不依赖低层模块（Data 层）的具体实现，二者都依赖抽象（接口）；</li>
<li>抽象（接口）不依赖细节（Data 层实现），细节（Data 层实现）依赖抽象（接口）。</li>
</ul>
<p>落地到 GoWind Admin 中，就是：由 Service 层定义 Repo 接口（明确“需要什么功能”），Data 层实现该接口（明确“如何实现功能”），通过依赖注入（DI）将 Data 层的实现注入到 Service 中。这种模式下，Service 层完全隔离于 Data 层的具体实现，实现“面向抽象编程”。</p>
<h4 data-id="heading-8">2. 实现方式：接口定义+实现分离+依赖注入，三步落地</h4>
<p>仍以 GoWind Admin 部门管理模块为例，我们拆解“接口解耦”的完整实现流程，包含“接口定义、实现分离、依赖注入”三个核心步骤：</p>
<h5 data-id="heading-9">步骤 1：Service 层定义 Repo 接口（抽象主导）</h5>
<p>Service 层根据业务需求，定义 Repo 接口——只声明“需要的方法”，不关心“如何实现”；同时，定义 Service 层专属的业务实体（Entity），脱离对 Data 层 ORM 模型的依赖：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Service层：定义抽象接口与业务实体，脱离Data层依赖</span>
<span class="hljs-keyword">package</span> service

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"context"</span>
    <span class="hljs-string">"go-wind-admin/app/admin/service/internal/data/ent/department"</span>
    dto <span class="hljs-string">"go-wind-admin/api/gen/go/user/service/v1"</span>
)

<span class="hljs-comment">// -------------------------- 抽象接口：定义“需要什么功能” --------------------------</span>
<span class="hljs-keyword">type</span> DepartmentRepo <span class="hljs-keyword">interface</span> {
    <span class="hljs-comment">// 只声明业务需要的方法，参数与返回值使用Service层实体</span>
    GetByID(ctx context.Context, id <span class="hljs-type">uint32</span>) (*department.DepartmentEntity, <span class="hljs-type">error</span>)
    ListByOrgID(ctx context.Context, orgID <span class="hljs-type">uint32</span>) ([]*department.DepartmentEntity, <span class="hljs-type">error</span>)
    UpdateStatus(ctx context.Context, id <span class="hljs-type">uint32</span>, status <span class="hljs-type">int32</span>) <span class="hljs-type">error</span>
}

<span class="hljs-comment">// -------------------------- 业务实体：Service层专属，解耦ORM模型 --------------------------</span>
<span class="hljs-keyword">type</span> DepartmentEntity <span class="hljs-keyword">struct</span> {
    ID              <span class="hljs-type">uint32</span>
    Name            <span class="hljs-type">string</span>
    OrganizationID  <span class="hljs-type">uint32</span>
    Status          <span class="hljs-type">int32</span>
    CreatedAt       <span class="hljs-type">int64</span>
}

<span class="hljs-comment">// -------------------------- 业务逻辑实现：依赖抽象接口 --------------------------</span>
<span class="hljs-keyword">type</span> DepartmentService <span class="hljs-keyword">struct</span> {
    deptRepo DepartmentRepo <span class="hljs-comment">// 依赖抽象接口，而非具体实现</span>
}

<span class="hljs-comment">// NewDepartmentService 构造函数：通过依赖注入传入接口实现</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewDepartmentService</span><span class="hljs-params">(deptRepo DepartmentRepo)</span></span> *DepartmentService {
    <span class="hljs-keyword">return</span> &amp;DepartmentService{deptRepo: deptRepo}
}

<span class="hljs-comment">// GetDepartmentInfo 查询部门详情：调用抽象接口，无Data层依赖</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *DepartmentService)</span></span> GetDepartmentInfo(ctx context.Context, id <span class="hljs-type">uint32</span>) (*dto.DepartmentVO, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 调用抽象接口，不关心底层是Ent/GORM/缓存实现</span>
    deptEntity, err := s.deptRepo.GetByID(ctx, id)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }

    <span class="hljs-comment">// 业务逻辑处理（与Data层实现完全隔离）</span>
    <span class="hljs-keyword">if</span> deptEntity.Status == <span class="hljs-number">0</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"部门已禁用"</span>)
    }

    <span class="hljs-comment">// 数据组装：基于Service层实体，不依赖ORM模型</span>
    <span class="hljs-keyword">return</span> &amp;dto.DepartmentVO{
        ID:              deptEntity.ID,
        Name:            deptEntity.Name,
        OrganizationID:  deptEntity.OrganizationID,
        Status:          deptEntity.Status,
        CreatedAt:       time.Unix(deptEntity.CreatedAt, <span class="hljs-number">0</span>).Format(<span class="hljs-string">"2006-01-02 15:04:05"</span>),
    }, <span class="hljs-literal">nil</span>
}
</code></pre>
<h5 data-id="heading-10">步骤 2：Data 层实现 Repo 接口（细节适配抽象）</h5>
<p>Data 层根据 Service 层定义的接口，实现具体的 Data 访问逻辑——可适配不同的存储方式（如 MySQL、Redis、MongoDB），同时完成“ORM 模型与 Service 实体”的转换：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Data层：实现Service层定义的接口，适配具体存储</span>
<span class="hljs-keyword">package</span> data

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"context"</span>
    <span class="hljs-string">"encoding/json"</span>
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"time"</span>

    <span class="hljs-string">"go-wind-admin/app/admin/service/internal/data/ent"</span>
    <span class="hljs-string">"go-wind-admin/app/admin/service/internal/data/ent/department"</span>
    <span class="hljs-string">"go-wind-admin/app/admin/service/internal/service"</span>
    <span class="hljs-string">"github.com/redis/go-redis/v8"</span>
)

<span class="hljs-comment">// -------------------------- 接口实现：适配Ent+Redis存储 --------------------------</span>
<span class="hljs-keyword">type</span> DepartmentRepoImpl <span class="hljs-keyword">struct</span> {
    entClient *ent.Client   <span class="hljs-comment">// Ent客户端（MySQL访问）</span>
    cache     *redis.Client <span class="hljs-comment">// Redis客户端（缓存适配）</span>
}

<span class="hljs-comment">// NewDepartmentRepoImpl 构造函数：创建接口实现实例</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewDepartmentRepoImpl</span><span class="hljs-params">(entClient *ent.Client, cache *redis.Client)</span></span> service.DepartmentRepo {
    <span class="hljs-keyword">return</span> &amp;DepartmentRepoImpl{
        entClient: entClient,
        cache:     cache,
    }
}

<span class="hljs-comment">// GetByID 实现接口方法：先查缓存，再查数据库（适配多存储）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *DepartmentRepoImpl)</span></span> GetByID(ctx context.Context, id <span class="hljs-type">uint32</span>) (*service.DepartmentEntity, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 1. 先查缓存（提升性能，适配企业级需求）</span>
    cacheKey := fmt.Sprintf(<span class="hljs-string">"dept:%d"</span>, id)
    cacheData, err := r.cache.Get(ctx, cacheKey).Result()
    <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> {
        <span class="hljs-comment">// 缓存命中：转换为Service层实体</span>
        <span class="hljs-keyword">var</span> entity service.DepartmentEntity
        <span class="hljs-keyword">if</span> err := json.Unmarshal([]<span class="hljs-type">byte</span>(cacheData), &amp;entity); err == <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> &amp;entity, <span class="hljs-literal">nil</span>
        }
    }

    <span class="hljs-comment">// 2. 缓存未命中：查询MySQL（Ent ORM实现）</span>
    deptEnt, err := r.entClient.Department.
        Query().
        Where(department.ID(id)).
        Only(ctx)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }

    <span class="hljs-comment">// 3. 转换为Service层实体（解耦ORM模型）</span>
    entity := &amp;service.DepartmentEntity{
        ID:              deptEnt.ID,
        Name:            deptEnt.Name,
        OrganizationID:  deptEnt.OrganizationID,
        Status:          deptEnt.Status,
        CreatedAt:       deptEnt.CreatedAt.Unix(),
    }

    <span class="hljs-comment">// 4. 写入缓存（更新缓存，支撑高并发）</span>
    jsonData, _ := json.Marshal(entity)
    r.cache.Set(ctx, cacheKey, jsonData, <span class="hljs-number">10</span>*time.Minute)

    <span class="hljs-keyword">return</span> entity, <span class="hljs-literal">nil</span>
}

<span class="hljs-comment">// ListByOrgID 实现接口方法：按组织ID查询部门列表</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *DepartmentRepoImpl)</span></span> ListByOrgID(ctx context.Context, orgID <span class="hljs-type">uint32</span>) ([]*service.DepartmentEntity, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 实现逻辑：查询数据库+实体转换+缓存优化...</span>
    deptEnts, err := r.entClient.Department.
        Query().
        Where(department.OrganizationID(orgID)).
        All(ctx)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }

    <span class="hljs-comment">// 转换为Service层实体列表</span>
    entities := <span class="hljs-built_in">make</span>([]*service.DepartmentEntity, <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(deptEnts))
    <span class="hljs-keyword">for</span> _, dept := <span class="hljs-keyword">range</span> deptEnts {
        entities = <span class="hljs-built_in">append</span>(entities, &amp;service.DepartmentEntity{
            ID:              dept.ID,
            Name:            dept.Name,
            OrganizationID:  dept.OrganizationID,
            Status:          dept.Status,
            CreatedAt:       dept.CreatedAt.Unix(),
        })
    }

    <span class="hljs-keyword">return</span> entities, <span class="hljs-literal">nil</span>
}

<span class="hljs-comment">// UpdateStatus 实现接口方法：更新部门状态</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *DepartmentRepoImpl)</span></span> UpdateStatus(ctx context.Context, id <span class="hljs-type">uint32</span>, status <span class="hljs-type">int32</span>) <span class="hljs-type">error</span> {
    <span class="hljs-comment">// 实现逻辑：更新数据库+清理缓存...</span>
    _, err := r.entClient.Department.
        UpdateOneID(id).
        SetStatus(status).
        Save(ctx)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> err
    }

    <span class="hljs-comment">// 清理缓存，避免脏数据</span>
    r.cache.Del(ctx, fmt.Sprintf(<span class="hljs-string">"dept:%d"</span>, id))
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}
</code></pre>
<h5 data-id="heading-11">步骤 3：依赖注入（DI）组装依赖</h5>
<p>通过依赖注入工具（如 GoWind Admin 中集成的 Google Wire），将 Data 层的接口实现注入到 Service 层，完成依赖组装——Service 层无需关心“实现从哪来”，只需依赖抽象接口：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// providers/wire_set.go：依赖注入配置，组装Service与Data层依赖</span>
<span class="hljs-keyword">package</span> providers

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"github.com/google/wire"</span>
    <span class="hljs-string">"go-wind-admin/app/admin/service/internal/service"</span>
    <span class="hljs-string">"go-wind-admin/app/admin/service/internal/data"</span>
)

<span class="hljs-comment">// -------------------------- 依赖组装：绑定接口与实现 --------------------------</span>
<span class="hljs-keyword">var</span> ServiceProviderSet = wire.NewSet(
    <span class="hljs-comment">// Service层构造函数：依赖DepartmentRepo接口</span>
    service.NewDepartmentService,
    <span class="hljs-comment">// 绑定：将Data层的DepartmentRepoImpl作为DepartmentRepo接口的实现</span>
    data.NewDepartmentRepoImpl,
)

<span class="hljs-comment">// -------------------------- Data层依赖：提供基础客户端 --------------------------</span>
<span class="hljs-keyword">var</span> DataProviderSet = wire.NewSet(
    <span class="hljs-comment">// 提供Ent客户端（MySQL访问）</span>
    data.NewEntClient,
    <span class="hljs-comment">// 提供Redis客户端（缓存访问）</span>
    data.NewRedisClient,
)

<span class="hljs-comment">// -------------------------- 全局Provider：整合所有依赖 --------------------------</span>
<span class="hljs-keyword">var</span> AllProviderSet = wire.NewSet(
    ServiceProviderSet,
    DataProviderSet,
)
</code></pre>
<h4 data-id="heading-12">3. 核心优缺点：灵活性优先，牺牲部分初期效率</h4>
<p>这种方案的核心价值在于“支撑企业级需求”，优缺点与“直接引用”形成鲜明对比：</p>





























<table><thead><tr><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>彻底解耦：Service 层与 Data 层完全隔离，修改 Data 层实现（如换 ORM、加缓存）不影响 Service 代码；</td><td>初期开发效率低：需额外定义接口、实现类、实体转换逻辑，代码量增加 30%-50%；</td></tr><tr><td>可测试性极强：单元测试可通过 Mock 工具（如 gomock）生成接口的 Mock 实现，无需依赖真实数据库；</td><td>上手门槛高：需理解依赖倒置、接口抽象、依赖注入等概念，团队需掌握相关工具（如 Google Wire）；</td></tr><tr><td>扩展性极强：支持多存储适配（如同时支持 MySQL/PostgreSQL、加 Redis 缓存、读写分离），新增实现只需加 Impl 类，无需修改 Service；</td><td>调试链路变长：抽象层增加了问题定位的中间环节，需通过日志或调试工具追踪接口调用链路；</td></tr><tr><td>规范协作边界：明确的接口定义让团队分工更清晰（Service 团队设计接口，Data 团队实现接口），适合大团队协作；</td><td>需要统一接口设计规范：若接口设计不合理（如方法过多、参数冗余），会导致实现类冗余、维护成本增加；</td></tr><tr><td>符合开闭原则：对扩展开放（新增实现），对修改关闭（不动已有代码），支撑框架长期演进；</td><td>依赖注入配置复杂：多模块、多接口的 DI 配置容易出错，需要严格的代码审查；</td></tr></tbody></table>
<h4 data-id="heading-13">4. 适用场景：匹配“复杂、长期、企业级”需求</h4>
<p>这种方案是 GoWind Admin 作为“企业级中后台框架”的核心支撑，适合以下场景：</p>
<ul>
<li><strong>复杂业务模块</strong>：如用户管理、权限控制、订单管理等，业务逻辑复杂（多规则、多关联、多状态），需要频繁迭代；</li>
<li><strong>长期维护的项目</strong>：项目迭代周期长（1年以上），需要持续扩展功能、优化性能；</li>
<li><strong>多存储适配需求</strong>：需要支持多数据库（MySQL/PostgreSQL）、加缓存（Redis）、读写分离、分库分表；</li>
<li><strong>大团队协作场景</strong>：5人以上团队，需要通过抽象层规范协作边界，避免跨层开发冲突；</li>
<li><strong>重视自动化测试</strong>：要求高测试覆盖率，需要快速 Mock 依赖，实现单元测试自动化。</li>
</ul>
<p>例如，GoWind Admin 的“用户权限”核心模块就采用了这种方案——Service 层定义 UserRepo、RoleRepo 接口，Data 层分别实现“MySQL 实现”“缓存增强实现”，通过依赖注入灵活切换，既支撑了多租户场景下的权限隔离，又通过缓存优化了查询性能，同时便于单元测试落地。</p>
<h3 data-id="heading-14">四、分层设计的取舍原则：平衡是核心，适配是关键</h3>
<p>两种方案没有“优劣之分”，只有“适配与否”。对于 GoWind Admin 这类需要兼顾“开箱即用效率”与“企业级扩展”的中后台框架，分层设计的核心是“动态平衡”——根据项目阶段、业务复杂度、团队能力，选择最适合的方案，甚至混合使用两种方案。以下是四个核心取舍原则：</p>
<h4 data-id="heading-15">1. 先极简，再抽象：坚决避免过度设计</h4>
<p>项目初期（或新模块启动），优先选择“直接引用”方案，快速落地核心功能，验证业务价值；当耦合问题明确暴露（如需要换存储、写单元测试困难、多实现需求出现）时，再逐步重构为“依赖倒置”；若业务复杂度进一步提升到跨模块协作密集的程度，再引入 biz 层。</p>
<p>例如，GoWind Admin 的“数据字典”模块，初期采用直接引用方案快速落地，当后续需要支持“不同业务线自定义数据字典”（多实现需求）时，再抽离 DataDictionaryRepo 接口，实现“普通数据字典”“业务线专属数据字典”两个 Impl 类——过度抽象会让初期开发陷入“架构内卷”，反而拖慢进度。</p>
<blockquote>
<p><strong>核心提醒</strong>：抽象的价值在于“应对已知的变化”，而非“预防未知的变化”。未知的变化可通过“预留重构空间”（如规范命名、避免硬编码）应对，无需提前抽象。</p>
</blockquote>
<h4 data-id="heading-16">2. 按“变化频率”分层，而非“教条式”分层</h4>
<p>分层的核心是“分离关注点、应对变化”，而非严格遵守“接口-实现”的教条。我们应聚焦“高频变化点”做抽象，对“稳定无变化点”保持极简：</p>
<ul>
<li>若某类 Repo 只有单一实现、且短期内无扩展需求（如“系统日志”Repo），无需强行抽接口；</li>
<li>若某类 Repo 需要多实现（如“用户查询”Repo，需支持普通用户/管理员/第三方用户三种权限查询），则必须抽接口；</li>
<li>若某层逻辑稳定无变化（如 API 层的参数校验规则），无需过度抽象；若逻辑高频变化（如 Data 层的存储方式），则必须抽象隔离。</li>
<li>若业务以单一模块逻辑为主，无跨模块交互，无需引入 biz 层；若跨模块协作密集，则需新增 biz 层隔离核心业务。</li>
</ul>
<h4 data-id="heading-17">3. 团队能力匹配架构复杂度：不盲目追求“高级架构”</h4>
<p>架构复杂度必须与团队能力匹配：若团队成员对“依赖倒置、DI、接口设计”等概念不熟悉，强行推复杂架构会导致“接口设计混乱、Impl 与接口不匹配、DI 配置出错”等问题，反而降低效率；若团队尚未掌握多层协作规范，引入 biz 层会进一步增加沟通与维护成本。</p>
<p>此时，宁可选择“直接引用”方案，先保证功能落地与稳定迭代；同时通过技术分享、小模块试点（如先在“用户管理”模块尝试接口解耦），让团队逐步熟悉相关概念，再慢慢升级架构。</p>
<h4 data-id="heading-18">4. 混合使用两种方案：在同一项目中“按需适配”</h4>
<p>无需在整个项目中“一刀切”使用某一种方案，可根据模块的重要性、复杂度，混合使用三种方案：​</p>
<ul>
<li><strong>核心复杂业务模块</strong>（如订单、支付、权限）：采用“biz 层+依赖倒置”方案，保证业务编排清晰与扩展性；​</li>
<li><strong>普通业务模块</strong>（如用户管理、部门管理）：采用“依赖倒置”方案，保证稳定性与可测试性；​</li>
<li><strong>边缘业务模块</strong>（如系统公告、数据统计）：采用“直接引用”方案，保证开发效率；​</li>
<li><strong>过渡阶段模块</strong>：先采用“直接引用”快速落地，待明确扩展需求后，再逐步重构升级。​</li>
</ul>
<p>例如，GoWind Admin 目前就采用这种混合模式：核心的“订单支付”模块用 biz 层+依赖倒置，“用户权限”模块用依赖倒置，边缘的“系统日志”“公告管理”模块用直接引用，既保证了核心模块的扩展性，又兼顾了边缘模块的开发效率。</p>
<h3 data-id="heading-19">五、进阶方案：新增 biz 层——应对超大型复杂项目</h3>
<p>当 GoWind Admin 支撑的业务规模跃升至“超大型”级别（如多租户 SaaS、跨业务线协作、强事务一致性要求），仅靠 Service 与 Data 两层将难以承载日益复杂的业务规则编排、跨聚合根操作、状态机流转等需求。此时，引入 biz 层（业务核心逻辑层）成为必要演进。</p>
<p>这一设计其核心目标是：将“通用服务能力”与“核心业务逻辑”彻底分离，实现关注点隔离、复用性提升与演进解耦。</p>
<h4 data-id="heading-20">1. 四层架构的职责边界</h4>
<p>引入 biz 层后，GoWind Admin 的分层中，完整的调用链为：</p>
<p><code>API 层 → Service 层 → Biz 层 → Data 层</code></p>
<p>各层职责明确，依赖方向严格<strong>单向向下</strong>：</p>



































<table><thead><tr><th>层级</th><th>职责</th><th>依赖方向</th><th>关键特征</th></tr></thead><tbody><tr><td>API 层</td><td>协议处理（HTTP/gRPC）、参数校验、DTO 转换</td><td>→ Service 层</td><td>无业务逻辑，仅做协议适配</td></tr><tr><td>Service 层</td><td><strong>对外暴露的 RPC 服务接口</strong>，协调 Biz 层完成用例，处理通用横切逻辑（如权限上下文提取、日志埋点）</td><td>→ Biz 层</td><td>是<strong>服务契约</strong>的实现者，不包含核心业务规则</td></tr><tr><td>Biz 层</td><td><strong>核心业务逻辑载体</strong>，实现用例（Use Case）的完整流程，包含跨聚合、状态判断、事务边界、领域规则</td><td>→ Data 层（通过 Repo 接口）</td><td>是<strong>业务复杂度</strong>的集中地，应保持“纯逻辑”，无基础设施依赖</td></tr><tr><td>Data 层</td><td>数据访问实现，Repo 接口的具体实现（MySQL/Redis/ES 等），ORM 操作、缓存策略、实体转换</td><td>无（仅被 Biz 层调用）</td><td>是<strong>基础设施适配层</strong>，对上层透明</td></tr></tbody></table>
<h4 data-id="heading-21">2. 重构示例：以“创建多租户用户”为例</h4>
<p>假设业务需求：在指定租户下创建用户，需同时初始化用户角色、部门关联、并发送欢迎消息。这是一个典型的跨模块、多步骤、含校验的复杂用例。</p>
<h5 data-id="heading-22">步骤 1：定义 Biz 层核心逻辑与 Repo 接口</h5>
<p>Biz 层定义业务实体和核心方法，并声明所需的数据访问接口（由 Data 层实现）：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// app/admin/service/internal/biz/user.go</span>
<span class="hljs-keyword">package</span> biz

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"context"</span>
    <span class="hljs-string">"errors"</span>
    <span class="hljs-string">"fmt"</span>
)

<span class="hljs-comment">// User 用户业务实体（脱离 ORM）</span>
<span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> {
    ID          <span class="hljs-type">uint32</span>
    TenantID    <span class="hljs-type">uint32</span>
    Username    <span class="hljs-type">string</span>
    DepartmentID <span class="hljs-type">uint32</span>
    RoleIDs     []<span class="hljs-type">uint32</span>
}

<span class="hljs-keyword">type</span> CreateUserReq <span class="hljs-keyword">struct</span> {
    Username    <span class="hljs-type">string</span>
    DepartmentID <span class="hljs-type">uint32</span>
    RoleIDs     []<span class="hljs-type">uint32</span>
}

<span class="hljs-comment">// 定义 Repo 接口（由 Biz 层定义，Data 层实现）</span>
<span class="hljs-keyword">type</span> UserRepo <span class="hljs-keyword">interface</span> {
    Create(ctx context.Context, u *User) (*User, <span class="hljs-type">error</span>)
    CheckUsernameUnique(ctx context.Context, tenantID <span class="hljs-type">uint32</span>, username <span class="hljs-type">string</span>) (<span class="hljs-type">bool</span>, <span class="hljs-type">error</span>)
}

<span class="hljs-keyword">type</span> RoleRepo <span class="hljs-keyword">interface</span> {
    AssignRolesToUser(ctx context.Context, userID, tenantID <span class="hljs-type">uint32</span>, roleIDs []<span class="hljs-type">uint32</span>) <span class="hljs-type">error</span>
}

<span class="hljs-keyword">type</span> MessageRepo <span class="hljs-keyword">interface</span> {
    SendWelcomeMessage(ctx context.Context, userID <span class="hljs-type">uint32</span>) <span class="hljs-type">error</span>
}

<span class="hljs-comment">// UserBiz 核心业务编排</span>
<span class="hljs-keyword">type</span> UserBiz <span class="hljs-keyword">struct</span> {
    userRepo    UserRepo
    roleRepo    RoleRepo
    messageRepo MessageRepo
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewUserBiz</span><span class="hljs-params">(ur UserRepo, rr RoleRepo, mr MessageRepo)</span></span> *UserBiz {
    <span class="hljs-keyword">return</span> &amp;UserBiz{
        userRepo:    ur,
        roleRepo:    rr,
        messageRepo: mr,
    }
}

<span class="hljs-comment">// CreateUserInTenant 在租户下创建用户（核心业务流程）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *UserBiz)</span></span> CreateUserInTenant(ctx context.Context, tenantID <span class="hljs-type">uint32</span>, req *CreateUserReq) (*User, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 1. 校验用户名在租户内唯一</span>
    unique, err := b.userRepo.CheckUsernameUnique(ctx, tenantID, req.Username)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"校验用户名失败: %w"</span>, err)
    }
    <span class="hljs-keyword">if</span> !unique {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">"用户名已存在"</span>)
    }

    <span class="hljs-comment">// 2. 创建用户</span>
    user := &amp;User{
        TenantID:    tenantID,
        Username:    req.Username,
        DepartmentID: req.DepartmentID,
        RoleIDs:     req.RoleIDs,
    }
    createdUser, err := b.userRepo.Create(ctx, user)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"创建用户失败: %w"</span>, err)
    }

    <span class="hljs-comment">// 3. 分配角色（跨聚合操作）</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(req.RoleIDs) &gt; <span class="hljs-number">0</span> {
        <span class="hljs-keyword">if</span> err := b.roleRepo.AssignRolesToUser(ctx, createdUser.ID, tenantID, req.RoleIDs); err != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"分配角色失败: %w"</span>, err)
        }
    }

    <span class="hljs-comment">// 4. 发送欢迎消息（异步或同步）</span>
    <span class="hljs-keyword">if</span> err := b.messageRepo.SendWelcomeMessage(ctx, createdUser.ID); err != <span class="hljs-literal">nil</span> {
        <span class="hljs-comment">// 消息发送失败可降级，不阻断主流程</span>
        log.Printf(<span class="hljs-string">"发送欢迎消息失败: %v"</span>, err)
    }

    <span class="hljs-keyword">return</span> createdUser, <span class="hljs-literal">nil</span>
}
</code></pre>
<h5 data-id="heading-23">步骤 2：Service 层仅协调 Biz 层，不处理核心逻辑</h5>
<p>Service 层实现 gRPC/HTTP 服务接口，只负责参数转换、上下文提取、调用 Biz 层：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// app/admin/service/internal/service/user_service.go</span>
<span class="hljs-keyword">package</span> service

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"context"</span>
    <span class="hljs-string">"go-wind-admin/app/admin/service/internal/biz"</span>
    pb <span class="hljs-string">"go-wind-admin/api/gen/go/admin/service/v1"</span>
)

<span class="hljs-keyword">type</span> UserService <span class="hljs-keyword">struct</span> {
    pb.UnimplementedUserServiceServer
    uc *biz.UserBiz <span class="hljs-comment">// 仅依赖 Biz 层</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewUserService</span><span class="hljs-params">(uc *biz.UserBiz)</span></span> *UserService {
    <span class="hljs-keyword">return</span> &amp;UserService{uc: uc}
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *UserService)</span></span> CreateUser(ctx context.Context, req *pb.CreateUserRequest) (*pb.CreateUserReply, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 1. 从上下文提取租户ID（通用逻辑）</span>
    tenantID, err := extractTenantID(ctx)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, status.Error(codes.InvalidArgument, <span class="hljs-string">"租户ID缺失"</span>)
    }

    <span class="hljs-comment">// 2. 调用 Biz 层完成核心业务</span>
    user, err := s.uc.CreateUserInTenant(ctx, tenantID, &amp;biz.CreateUserReq{
        Username:    req.Username,
        DepartmentID: req.DepartmentId,
        RoleIDs:     req.RoleIds,
    })
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, status.Error(codes.Internal, err.Error())
    }

    <span class="hljs-comment">// 3. 转换返回</span>
    <span class="hljs-keyword">return</span> &amp;pb.CreateUserReply{
        UserId: user.ID,
        Msg:    <span class="hljs-string">"创建成功"</span>,
    }, <span class="hljs-literal">nil</span>
}
</code></pre>
<h5 data-id="heading-24">步骤 3：Data 层实现 Repo 接口，屏蔽存储细节</h5>
<p>Data 层实现 Biz 层定义的接口，可自由组合 MySQL（Ent）、Redis、消息队列等：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// app/admin/service/internal/data/user_repo.go</span>
<span class="hljs-keyword">package</span> data

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"context"</span>
    <span class="hljs-string">"go-wind-admin/app/admin/service/internal/biz"</span>
    <span class="hljs-string">"go-wind-admin/app/admin/service/internal/data/ent"</span>
)

<span class="hljs-keyword">type</span> userRepo <span class="hljs-keyword">struct</span> {
    data *Data <span class="hljs-comment">// 包含 ent.Client, redis 等</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *userRepo)</span></span> Create(ctx context.Context, u *biz.User) (*biz.User, <span class="hljs-type">error</span>) {
    entUser, err := r.data.db.User.
        Create().
        SetTenantID(u.TenantID).
        SetUsername(u.Username).
        SetDepartmentID(u.DepartmentID).
        Save(ctx)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }

    <span class="hljs-comment">// 转换为 biz.User</span>
    <span class="hljs-keyword">return</span> &amp;biz.User{
        ID:          entUser.ID,
        TenantID:    entUser.TenantID,
        Username:    entUser.Username,
        DepartmentID: entUser.DepartmentID,
    }, <span class="hljs-literal">nil</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *userRepo)</span></span> CheckUsernameUnique(ctx context.Context, tenantID <span class="hljs-type">uint32</span>, username <span class="hljs-type">string</span>) (<span class="hljs-type">bool</span>, <span class="hljs-type">error</span>) {
    count, err := r.data.db.User.
        Query().
        Where(user.TenantID(tenantID), user.Username(username)).
        Count(ctx)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, err
    }
    <span class="hljs-keyword">return</span> count == <span class="hljs-number">0</span>, <span class="hljs-literal">nil</span>
}
</code></pre>
<h5 data-id="heading-25">步骤 4：依赖注入（Wire）组装四层依赖</h5>
<p>通过 Wire 将依赖从 Data → Biz → Service 逐层注入：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// app/admin/service/internal/wire.go</span>
<span class="hljs-keyword">var</span> userSet = wire.NewSet(
    <span class="hljs-comment">// Biz 层</span>
    biz.NewUserBiz,
    <span class="hljs-comment">// Data 层 Repo 实现</span>
    NewUserRepo,
    NewRoleRepo,
    NewMessageRepo,
)

<span class="hljs-keyword">var</span> serviceSet = wire.NewSet(
    service.NewUserService,
    userSet,
)
</code></pre>
<h4 data-id="heading-26">3. 引入 biz 层的核心价值</h4>





























<table><thead><tr><th>价值</th><th>说明</th></tr></thead><tbody><tr><td>业务逻辑内聚</td><td>所有核心规则集中在 Biz 层，避免 Service 层膨胀</td></tr><tr><td>Service 层轻量化</td><td>Service 仅做协议与 Biz 的桥梁，易于维护和测试</td></tr><tr><td>Data 层彻底解耦</td><td>Biz 层只依赖 Repo 接口，Data 层可自由替换实现</td></tr><tr><td>支持复杂事务</td><td>Biz 方法天然成为事务边界（可通过 middleware 实现）</td></tr><tr><td>便于领域建模</td><td>为未来引入 DDD（领域驱动设计）打下基础</td></tr></tbody></table>
<h4 data-id="heading-27">4. 何时需要引入 biz 层？</h4>
<ul>
<li>业务逻辑涉及多个聚合根（如用户+角色+部门）；</li>
<li>存在复杂状态流转（如订单状态机）；</li>
<li>需要强事务一致性（如资金变更）；</li>
<li>项目已进入稳定迭代期，需长期维护；</li>
<li>团队已具备分层协作规范，能清晰划分 Biz/Service/Data 职责。</li>
</ul>
<blockquote>
<p>⚠️ 切记：不要过早引入 biz 层！对于简单 CRUD 模块，四层架构反而增加理解成本。GoWind Admin 在 用户、租户、权限等核心模块采用 Biz 层，而在公告、日志等边缘模块仍使用 Service → Data 直连，体现了“按需分层”的务实哲学。</p>
</blockquote>
<h3 data-id="heading-28">六、总结：分层设计的本质是“动态适配”</h3>
<p>分层设计的终极目标，不是追求“最优雅、最复杂的架构”，而是追求“最适配当前场景的架构”。对于 GoWind Admin 这类企业级中后台框架而言，分层设计的取舍，本质是在“开发效率”与“架构韧性”之间的动态平衡：</p>
<ul>
<li>当需求是“快速、轻量、短期”：选择“Service 直连 Data Repo”，把效率放在第一位，快速验证业务价值；</li>
<li>当需求是“复杂、长期、企业级”：选择“依赖倒置 + 接口解耦”，把可维护性和扩展性放在第一位，支撑框架长期演进。</li>
</ul>
<p>更重要的是，架构设计不是“一劳永逸”的——它需要随着项目阶段、业务规模、团队能力的变化而动态调整。作为开发者，我们应跳出“非黑即白”的架构认知，聚焦业务需求，用“极简思维”避免过度设计，用“抽象思维”应对已知变化，让分层设计真正成为支撑业务发展的“工具”，而非束缚开发效率的“枷锁”。</p>
<p>对于 GoWind Admin 的使用者而言，无需一开始就追求“全接口解耦”的架构，可根据自身业务场景灵活选择：小项目直接用“简单方案”快速落地，中大型项目逐步升级为“工程化方案”——这正是 GoWind Admin 作为“开箱即用”框架的核心优势：既支持新手快速上手，也能支撑企业级用户的长期扩展。</p>
<h3 data-id="heading-29">七、结语：架构即选择，分层即责任</h3>
<p>GoWind Admin 的分层演进之路，映射出无数中后台系统从“能用”到“好用”、再到“可生长”的成长轨迹。它并非一开始就堆砌抽象与接口，而是在真实业务需求与工程约束中，<strong>选择在恰当时机做恰如其分的解耦</strong>——这正是成熟工程思维的体现。</p>
<p>在微服务与单体并存、快速交付与长期维护共存的今天，一个优秀的中后台框架，不该是某种“架构教条”的复制品，而应是一个<strong>具备弹性与智慧的工程载体</strong>：</p>
<ul>
<li>既能以“简单粗暴”之姿，让新手开发者 <strong>5分钟跑通 CRUD</strong>；</li>
<li>也能以“接口解耦、四层清晰”之态，支撑千人团队协同作战、百万级数据流转。</li>
</ul>
<p>现在，你就可以亲身体验这一切。</p>
<p>👉 访问在线演示地址：<a href="https://link.juejin.cn?target=http%3A%2F%2F124.221.26.30%3A8080" target="_blank" title="http://124.221.26.30:8080" ref="nofollow noopener noreferrer">http://124.221.26.30:8080</a><br/>
👉 使用默认账号登录：用户名 <code>admin</code> / 密码 <code>admin</code></p>
<p>GoWind Admin 正是这样一种平衡的产物。它的底层逻辑不是“抽象越多越好”，而是“<strong>抽象得刚刚好</strong>”。</p>
<ul>
<li>你只需关注业务？它提供脚手架与直连线，开箱即用。</li>
<li>你需要扩展存储？它预留接口与依赖注入，无缝切换。</li>
<li>你面临复杂编排？它支持 Biz 层拆解，职责分明。</li>
</ul>
<p><strong>分层不是目的，而是手段；解耦不是炫技，而是为未来留出空间。</strong></p>
<p>作为开发者，我们在使用 GoWind Admin 时，也应秉持同样的理念：</p>
<blockquote>
<p>不为抽象而抽象，只为业务而设计；不为复杂而复杂，只为演进而分层。</p>
</blockquote>
<p>愿你在构建下一个企业级系统的路上，既能“乘风而起”，亦能“稳如磐石”。</p>
<h3 data-id="heading-30">附：快速决策指南（供读者参考）</h3>

























<table><thead><tr><th>项目特征</th><th>推荐分层方案</th><th>适用团队规模 / 技术成熟度</th></tr></thead><tbody><tr><td><strong>MVP 验证 / 内部工具 / 单表管理</strong><br/>（业务逻辑简单，无多存储需求）</td><td>Service 直连 Data Repo（方案一）</td><td>1–3 人小团队<br/>Go 基础扎实但架构经验有限<br/>追求快速交付、验证想法</td></tr><tr><td><strong>中等复杂度 / 多人协作 / 需单元测试</strong><br/>（如用户管理、权限控制、多租户）</td><td>依赖倒置 + 接口解耦（方案二）</td><td>3–10 人团队<br/>熟悉依赖注入（Wire）、接口抽象<br/>有自动化测试或高可维护性要求</td></tr><tr><td><strong>超大型系统 / 多业务线 / 高复用 / 强事务</strong><br/>（如订单、支付、跨模块编排）</td><td>新增 Biz 层 + 四层架构（进阶方案）</td><td>10 人以上团队或多个子团队<br/>具备领域建模意识<br/>长期维护、高内聚低耦合为优先目标</td></tr></tbody></table>
<blockquote>
<p>💡 提示：GoWind Admin 默认生成的模块多采用 方案一（直连），便于新手快速上手；而 用户、租户、权限等核心模块已按方案二或方案三实现，可直接参考源码学习工程化分层实践。</p>
</blockquote>
<h3 data-id="heading-31">项目地址</h3>
<blockquote>
<ul>
<li>GoWind Admin（Gitee）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Ftx7do%2Fgo-wind-admin" target="_blank" title="https://gitee.com/tx7do/go-wind-admin" ref="nofollow noopener noreferrer">gitee.com/tx7do/go-wi…</a></li>
<li>GoWind Admin（GitHub）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftx7do%2Fgo-wind-admin" target="_blank" title="https://github.com/tx7do/go-wind-admin" ref="nofollow noopener noreferrer">github.com/tx7do/go-wi…</a></li>
</ul>
<p>MIT 开源协议，欢迎 Star、Fork、PR，共建企业级 Go 中后台生态。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Go 1.25.5 通关讲解]]></title>    <link>https://juejin.cn/post/7586939930155401259</link>    <guid>https://juejin.cn/post/7586939930155401259</guid>    <pubDate>2025-12-23T17:19:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586939930155401259" data-draft-id="7586942589321936932" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Go 1.25.5 通关讲解"/> <meta itemprop="keywords" content="后端,Go,面试"/> <meta itemprop="datePublished" content="2025-12-23T17:19:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吴佳浩"/> <meta itemprop="url" content="https://juejin.cn/user/2696441245481975"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Go 1.25.5 通关讲解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2696441245481975/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吴佳浩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T17:19:27.000Z" title="Tue Dec 23 2025 17:19:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial;color:#00325e}.markdown-body ::selection{background-color:#00325e;color:#fff}.markdown-body blockquote{padding:10px 20px;background-color:#fffaf0;box-shadow:0 3px 10px 0 rgba(255,172,194,.24);border:1px solid #f3ca8e;transition:all .2s;margin:1em 0;border-radius:5px}.markdown-body blockquote p{font-size:14px;line-height:25px;color:#795548}.markdown-body blockquote p:last-child{margin:0}.markdown-body blockquote:hover{border-color:#ff9800;background-color:#fff8e0;box-shadow:0 6px 10px -5px rgba(225,173,98,.3803921569)}.markdown-body blockquote code{color:#ff502c}.markdown-body pre{border:1px solid #8cc0f3;box-shadow:0 3px 10px 0 rgba(255,198,198,.28);border-radius:5px;transition:all .2s;overflow-x:auto;white-space:pre-wrap}.markdown-body pre:hover{border-color:#6d9dce}.markdown-body pre&gt;code{padding:10px 20px;color:#00325e;background:#f0f8ff;font-size:12px;line-height:1.6;display:block}.markdown-body code{background:#f6fbff;color:#0b5393;padding:2px 4px;border-radius:4px;font-size:12px}.markdown-body p{font-size:14px;line-height:28px;text-align:justify;margin-bottom:17px;color:#595959}.markdown-body a{color:#00325e;text-decoration:none}.markdown-body a:after{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAAXNSR0IArs4c6QAAAQdJREFUKFNt0DtLA0EUBeBzZle0Eks7rcUfEfBRCha7NorYa6NmVJzgyi4smUgKtdZGCJktLMVH4Y8QeztLWyE7VyLEuNFbXj4Oh0P8c8mZm+uJrEN4BJFTeP/MUVe3bnocfALwkOlo1zS7iZAzf6Cx7oXgbaqjxiDEWCcVaGyxQ8pSWo9XhqhoQ/xUFbaKjhe5V+CmR7mnSplEEF6GSmJ+F/d0KHvbCIIJCLc85U6BC5mONgbJNM3uFag++sX7z8O8MzsWBucifMx0dDGE1kmm458KDVukAlnNdDz/exEeW3dNkbfsYC0xtmgDWP6ELLZ0/F6BJu/UoFQN5AkoeUjeJPvx6+i+X5Sjah4tA6gYAAAAAElFTkSuQmCC);margin-left:2px}.markdown-body a:hover{box-shadow:0 1px}.markdown-body table{max-width:100%;border-collapse:collapse;border-spacing:0;box-shadow:0 3px 10px 0 rgba(255,238,172,.24);transition:all .2s}.markdown-body table:hover{box-shadow:0 3px 10px 0 rgba(185,169,103,.24)}.markdown-body table tr th{border:1px solid #8cc0f3;background-color:#f0f8ff;padding:12px 15px}.markdown-body table tr td{border:1px solid rgba(243,202,142,.4);padding:12px 15px}.markdown-body table tbody tr{transition:all .2s}.markdown-body table tbody tr:hover td{border-color:#f3ca8e;background-color:#fff8e0;z-index:1}.markdown-body img{max-width:100%}.markdown-body h1{font-size:20px;margin-top:30px;margin-bottom:10px;padding-left:30px;position:relative}.markdown-body h1&gt;code{font-size:20px}.markdown-body h1:before{content:"🍺";display:block;font-size:18px;width:18px;height:18px;left:0;position:absolute}.markdown-body h2{font-size:18px;margin-top:30px;margin-bottom:10px;padding-left:28px;position:relative}.markdown-body h2&gt;code{font-size:18px}.markdown-body h2:before{content:"🍻";display:block;font-size:16px;width:16px;height:16px;left:0;position:absolute}.markdown-body h3{font-size:16px;margin-top:30px;margin-bottom:10px;padding-left:26px;position:relative}.markdown-body h3&gt;code{font-size:16px}.markdown-body h3:before{content:"🥂";display:block;font-size:14px;width:14px;height:14px;left:0;position:absolute}.markdown-body h4{font-size:14px;margin-top:30px;margin-bottom:10px;padding-left:24px;position:relative}.markdown-body h4&gt;code{font-size:14px}.markdown-body h4:before{content:"🥃";display:block;font-size:12px;width:12px;height:12px;left:0;position:absolute}.markdown-body h5{font-size:12px;margin-top:30px;margin-bottom:10px}.markdown-body h5&gt;code{font-size:12px}.markdown-body h6{font-size:10px;margin-top:30px;margin-bottom:10px}.markdown-body h6&gt;code{font-size:10px}.markdown-body h1,.markdown-body h2{color:#ff502c}.markdown-body hr{height:4px;border:none;margin-top:32px;margin-bottom:32px;background-size:4px 1px;background-image:linear-gradient(270deg,#6d9dce,#8cc0f3 25%,transparent 50%)}.markdown-body hr:nth-child(2n){background-image:linear-gradient(270deg,#ff9800,#fff8e0 25%,transparent 50%)}.markdown-body ul{padding-inline-start:20px}.markdown-body ul li{list-style-type:"🔸"}.markdown-body ul li li{list-style-type:"◻️"}.markdown-body ul li li li{list-style-type:"▫️"}.markdown-body ol{padding-inline-start:20px}.markdown-body ol ::marker{color:#ff9800}.markdown-body ol,.markdown-body ul{line-height:2em}.markdown-body li{padding-inline-start:1ch}.markdown-body li.task-list-item{list-style:none;padding-inline-start:0}.markdown-body li input{padding-right:2px}.markdown-body li input[type=checkbox i]{appearance:none}.markdown-body li input:before{content:"🟩";display:block;width:13px;height:13px}.markdown-body li input:checked:before{content:"✅"}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">Go 1.25.5 通关讲解</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91f7995c326642bcb748d04b8ad2ea22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC05L2z5rWp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767115166&amp;x-signature=3L0h4idfzHRNwYIBNAWA5smcYq4%3D" alt="image.png" loading="lazy"/></p>
<p><strong>作者</strong>：吴佳浩</p>
<p><strong>最后更新</strong>：2025-12-24</p>
<p><strong>适用版本</strong>：golang 1.25.5</p>
<blockquote>
<p>距离上一次写go的版本更新已经一年多了快两年了，今天继续和大家一起来聊一聊go的最新版本都更新了些什么内容，内容比较多筒子们搬好小笨板凳，一起来学习一下吧！！！</p>
</blockquote>
<h3 data-id="heading-1">介绍</h3>
<p>Go 1.25 是在 2025 年 8 月发布的重要版本,紧随 Go 1.24 六个月后推出。Go 1.25.5 是该系列的最新补丁版本(发布于 2025 年 12 月 2 日),主要包含安全修复和 bug 修复。这一版本保持了 Go 1 的兼容性承诺,因此几乎所有的 Go 程序都能够像以前一样进行编译和运行。</p>
<h3 data-id="heading-2">核心特性概览</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">mindmap
  root((&amp;#34;Go 1.25.5&amp;#34;))
    运行时增强
      容器感知 GOMAXPROCS
      实验性垃圾回收器
      nil 指针检查修复
    标准库新增
      testing/synctest 正式版
      实验性 JSON v2
      os.Root API 完善
    工具链改进
      &amp;#34;DWARF 5 调试信息&amp;#34;
      &amp;#34;go doc http 服务器&amp;#34;
      &amp;#34;go.mod ignore 指令&amp;#34;
    性能优化
      切片栈分配优化
      编译器内联增强
    安全修复
      crypto/x509 修复
      资源消耗限制

</code></pre>
<h3 data-id="heading-3">重大变更详解</h3>
<h4 data-id="heading-4">1. 容器感知的 GOMAXPROCS</h4>
<p><strong>这是 Go 1.25 最重要的运行时改进之一!</strong></p>
<h5 data-id="heading-5">问题背景</h5>
<p>在 Go 1.25 之前,在容器环境中运行 Go 程序时会遇到一个严重问题:</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 假设你的 Kubernetes 容器分配了 4 个 CPU</span>
<span class="hljs-comment">// 但主机有 16 个 CPU 核心</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    fmt.Println(<span class="hljs-string">"GOMAXPROCS:"</span>, runtime.GOMAXPROCS(<span class="hljs-number">0</span>))
    <span class="hljs-comment">// 在 Go 1.24 及之前: 输出 16 (错误!)</span>
    <span class="hljs-comment">// 在 Go 1.25: 输出 4 (正确!)</span>
}
</code></pre>
<h5 data-id="heading-6">新的行为</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[程序启动] --&gt; B{检查环境}
    B --&gt;|容器环境| C[读取 cgroup CPU 限制]
    B --&gt;|非容器| D[使用逻辑 CPU 数量]
    C --&gt; E{比较值}
    E --&gt;|CPU 限制 &lt; 逻辑 CPU| F[使用较小值]
    E --&gt;|CPU 限制 &gt;= 逻辑 CPU| D
    F --&gt; G[设置 GOMAXPROCS]
    D --&gt; G
    G --&gt; H[定期更新检查]
    H --&gt; I{限制变化?}
    I --&gt;|是| G
    I --&gt;|否| J[继续运行]
</code></pre>
<h5 data-id="heading-7">实际示例</h5>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"runtime"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    fmt.Println(<span class="hljs-string">"初始 GOMAXPROCS:"</span>, runtime.GOMAXPROCS(<span class="hljs-number">0</span>))
    fmt.Println(<span class="hljs-string">"逻辑 CPU 数:"</span>, runtime.NumCPU())
    
    <span class="hljs-comment">// Go 1.25 会自动考虑 cgroup 限制</span>
    <span class="hljs-comment">// 在 Docker/K8s 中:</span>
    <span class="hljs-comment">// docker run --cpus=4 yourimage</span>
    <span class="hljs-comment">// GOMAXPROCS 将自动设置为 4</span>
    
    <span class="hljs-comment">// 如果需要手动设置</span>
    runtime.GOMAXPROCS(<span class="hljs-number">8</span>)
    fmt.Println(<span class="hljs-string">"手动设置后:"</span>, runtime.GOMAXPROCS(<span class="hljs-number">0</span>))
    
    <span class="hljs-comment">// 或使用新的 API 恢复默认值</span>
    runtime.SetDefaultGOMAXPROCS()
    fmt.Println(<span class="hljs-string">"恢复默认后:"</span>, runtime.GOMAXPROCS(<span class="hljs-number">0</span>))
}
</code></pre>
<p><strong>重要提示:</strong></p>
<ul>
<li>这个特性仅在 <code>go.mod</code> 中指定 Go 1.25 或更高版本时才生效</li>
<li>可通过 <code>GODEBUG=containermaxprocs=0</code> 禁用</li>
<li>可通过 <code>GODEBUG=updatemaxprocs=0</code> 禁用自动更新</li>
</ul>
<h4 data-id="heading-8">2. testing/synctest - 并发测试的救星</h4>
<p>从实验性功能正式毕业!这个包解决了 Go 并发测试的老大难问题。</p>
<h5 data-id="heading-9">传统并发测试的痛点</h5>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 传统方式 - 不可靠且慢</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestOldWay</span><span class="hljs-params">(t *testing.T)</span></span> {
    ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)
    
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        time.Sleep(<span class="hljs-number">100</span> * time.Millisecond) <span class="hljs-comment">// 😱 不确定的等待</span>
        ch &lt;- <span class="hljs-number">42</span>
    }()
    
    <span class="hljs-keyword">select</span> {
    <span class="hljs-keyword">case</span> v := &lt;-ch:
        <span class="hljs-keyword">if</span> v != <span class="hljs-number">42</span> {
            t.Errorf(<span class="hljs-string">"期望 42, 得到 %d"</span>, v)
        }
    <span class="hljs-keyword">case</span> &lt;-time.After(<span class="hljs-number">1</span> * time.Second): <span class="hljs-comment">// 😱 浪费时间</span>
        t.Fatal(<span class="hljs-string">"超时"</span>)
    }
}
</code></pre>
<h5 data-id="heading-10">使用 synctest 的新方式</h5>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"testing"</span>
    <span class="hljs-string">"testing/synctest"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestWithSynctest</span><span class="hljs-params">(t *testing.T)</span></span> {
    <span class="hljs-comment">// 在虚拟时间"气泡"中运行测试</span>
    synctest.Test(t, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> {
        ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)
        
        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
            time.Sleep(<span class="hljs-number">100</span> * time.Millisecond) <span class="hljs-comment">// ⚡ 虚拟时间,瞬间完成!</span>
            ch &lt;- <span class="hljs-number">42</span>
        }()
        
        <span class="hljs-comment">// 等待所有 goroutine 阻塞</span>
        synctest.Wait()
        
        v := &lt;-ch
        <span class="hljs-keyword">if</span> v != <span class="hljs-number">42</span> {
            t.Errorf(<span class="hljs-string">"期望 42, 得到 %d"</span>, v)
        }
    })
}

<span class="hljs-comment">// 更复杂的例子 - 测试超时逻辑</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Read</span><span class="hljs-params">(input &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)</span></span> (<span class="hljs-type">int</span>, <span class="hljs-type">error</span>) {
    <span class="hljs-keyword">select</span> {
    <span class="hljs-keyword">case</span> v := &lt;-input:
        <span class="hljs-keyword">return</span> v, <span class="hljs-literal">nil</span>
    <span class="hljs-keyword">case</span> &lt;-time.After(<span class="hljs-number">1</span> * time.Minute):
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, fmt.Errorf(<span class="hljs-string">"超时"</span>)
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestReadTimeout</span><span class="hljs-params">(t *testing.T)</span></span> {
    synctest.Test(t, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> {
        ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)
        
        <span class="hljs-comment">// 测试超时情况</span>
        _, err := Read(ch)
        <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> {
            t.Error(<span class="hljs-string">"期望超时错误"</span>)
        }
    })
    <span class="hljs-comment">// ⚡ 1 分钟的超时在虚拟时间中瞬间完成!</span>
}
</code></pre>
<p><strong>synctest 的魔法:</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Test as 测试代码
    participant Bubble as Synctest 气泡
    participant Time as 虚拟时钟
    participant Goroutines as Goroutines
    
    Test-&gt;&gt;Bubble: synctest.Test()
    Bubble-&gt;&gt;Time: 创建虚拟时钟
    Test-&gt;&gt;Goroutines: 启动 goroutines
    Goroutines-&gt;&gt;Time: time.Sleep(1min)
    Note over Goroutines,Time: 所有 goroutine 阻塞
    Test-&gt;&gt;Bubble: synctest.Wait()
    Bubble-&gt;&gt;Time: 检测到全部阻塞
    Time-&gt;&gt;Time: ⚡ 瞬间推进时间!
    Time-&gt;&gt;Goroutines: 唤醒
    Goroutines-&gt;&gt;Test: 返回结果
</code></pre>
<h4 data-id="heading-11">3. 实验性 JSON v2 包</h4>
<p>完全重写的 JSON 实现,解决老版本的诸多痛点!</p>
<h5 data-id="heading-12">启用方式</h5>
<pre><code class="hljs language-bash" lang="bash">GOEXPERIMENT=jsonv2 go build
</code></pre>
<h5 data-id="heading-13">新特性对比</h5>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 旧版 encoding/json 的问题</span>
<span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> {
    Name  <span class="hljs-type">string</span>
    Email <span class="hljs-type">string</span>
}

<span class="hljs-comment">//  无法自定义字段顺序</span>
<span class="hljs-comment">//  无法控制空值处理</span>
<span class="hljs-comment">//  性能较差</span>
<span class="hljs-comment">// 错误信息不够详细</span>

<span class="hljs-comment">// 使用 JSON v2 (实验性)</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">"encoding/json/v2"</span>

<span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> {
    Name  <span class="hljs-type">string</span> <span class="hljs-string">`json:"name"`</span>
    Email <span class="hljs-type">string</span> <span class="hljs-string">`json:"email,omitzero"`</span> <span class="hljs-comment">// 新标签!</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">example</span><span class="hljs-params">()</span></span> {
    user := User{Name: <span class="hljs-string">"张三"</span>}
    
    <span class="hljs-comment">// 更好的性能</span>
    <span class="hljs-comment">// 更详细的错误信息</span>
    <span class="hljs-comment">// 更灵活的配置选项</span>
    data, err := jsonv2.Marshal(user)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-comment">// 错误信息更加友好和详细</span>
        fmt.Println(err)
    }
}
</code></pre>
<p><strong>JSON v2 改进:</strong></p>
<ul>
<li>更高性能</li>
<li>更精确的错误信息</li>
<li>更灵活的配置</li>
<li>更好的流式 API</li>
<li>注意:API 可能会在未来版本中调整</li>
</ul>
<h4 data-id="heading-14">4. 实验性 Green Tea 垃圾回收器</h4>
<p>针对现代多核系统和大量小对象场景优化的新 GC!</p>
<h5 data-id="heading-15">启用方式</h5>
<pre><code class="hljs language-bash" lang="bash">GOEXPERIMENT=greenteagc go build
</code></pre>
<h5 data-id="heading-16">GC 演进历程</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">timeline
    title Go 垃圾回收器演进
    Go 1.0-1.4 : 标记-清除 GC
              : 停顿时间长
    Go 1.5 : 并发标记-清除
           : 大幅降低停顿
    Go 1.8-1.24 : 持续优化
                : 亚毫秒级停顿
    Go 1.25 : Green Tea GC (实验)
            : NUMA 优化
            : 适合多核系统
</code></pre>
<h5 data-id="heading-17">Green Tea GC 特点</h5>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Green Tea GC 针对以下场景优化:</span>

<span class="hljs-comment">// 1. 大量小对象创建</span>
<span class="hljs-keyword">type</span> Cache <span class="hljs-keyword">struct</span> {
    data <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]*Entry
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Cache)</span></span> Process() {
    <span class="hljs-comment">// 频繁创建小对象</span>
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++ {
        entry := &amp;Entry{
            Key:   fmt.Sprintf(<span class="hljs-string">"key-%d"</span>, i),
            Value: []<span class="hljs-type">byte</span>(<span class="hljs-string">"data"</span>),
        }
        c.data[entry.Key] = entry
    }
}

<span class="hljs-comment">// 2. 多核系统 (8+ 核心)</span>
<span class="hljs-comment">// Green Tea GC 减少内存跳转</span>
<span class="hljs-comment">// 在 NUMA 架构上表现更好</span>

<span class="hljs-comment">// 3. 高并发场景</span>
<span class="hljs-comment">// 更好的 CPU 缓存利用率</span>
<span class="hljs-comment">// 减少等待内存的延迟</span>
</code></pre>
<p><strong>使用建议:</strong></p>
<ul>
<li>适合:多核服务器、微服务、高并发应用</li>
<li>⚠️ 实验性质,API 和实现可能变化</li>
<li>建议先在测试环境验证性能</li>
</ul>
<h4 data-id="heading-18">5. nil 指针检查修复 - 重要的 Bug 修复</h4>
<p>Go 1.21-1.24 中存在一个编译器 bug,现在修复了!</p>
<h5 data-id="heading-19">Bug 演示</h5>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Go 1.21-1.24 的 BUG 行为 (错误!)</span>
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"os"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">oldBuggyBehavior</span><span class="hljs-params">()</span></span> {
    f, err := os.Open(<span class="hljs-string">"不存在的文件.txt"</span>)
    
    <span class="hljs-comment">//  危险!在检查错误前使用了 f</span>
    name := f.Name() <span class="hljs-comment">// 在 Go 1.21-1.24 中不会 panic (BUG!)</span>
    
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span>
    }
    
    fmt.Println(name)
}

<span class="hljs-comment">// Go 1.25 的正确行为</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fixedBehavior</span><span class="hljs-params">()</span></span> {
    f, err := os.Open(<span class="hljs-string">"不存在的文件.txt"</span>)
    
    <span class="hljs-comment">//  正确:先检查错误</span>
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        fmt.Println(<span class="hljs-string">"错误:"</span>, err)
        <span class="hljs-keyword">return</span>
    }
    
    <span class="hljs-comment">// 只有在没有错误时才使用 f</span>
    name := f.Name()
    fmt.Println(name)
}

<span class="hljs-comment">//  在 Go 1.25 中会正确 panic</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">willPanicNow</span><span class="hljs-params">()</span></span> {
    f, err := os.Open(<span class="hljs-string">"不存在的文件.txt"</span>)
    name := f.Name() <span class="hljs-comment">// 💥 panic: nil pointer dereference</span>
    
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span>
    }
    fmt.Println(name)
}
</code></pre>
<p><strong>迁移检查清单:</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[审查代码] --&gt; B{是否先使用&lt;br/&gt;后检查错误?}
    B --&gt;|是| C[ 需要修复]
    B --&gt;|否| D[ 无需改动]
    C --&gt; E[调整顺序:&lt;br/&gt;先检查错误]
    E --&gt; F[重新测试]
    F --&gt; G[升级到 Go 1.25]
    D --&gt; G
</code></pre>
<h3 data-id="heading-20">工具链改进</h3>
<h4 data-id="heading-21">1. DWARF 5 调试信息</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 默认使用 DWARF 5</span>
go build -o myapp main.go

<span class="hljs-comment"># 优势:</span>
<span class="hljs-comment">#  调试信息体积减少</span>
<span class="hljs-comment">#  链接速度更快(大型程序明显)</span>
<span class="hljs-comment">#  更好的调试器支持</span>

<span class="hljs-comment"># 如需禁用(回退到 DWARF 4)</span>
GOEXPERIMENT=nodwarf5 go build -o myapp main.go
</code></pre>
<h4 data-id="heading-22">2. go doc 内置 HTTP 服务器</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 新功能!启动本地文档服务器</span>
go doc -http=:8080

<span class="hljs-comment"># 浏览器访问 http://localhost:8080</span>
<span class="hljs-comment">#  查看所有包的文档</span>
<span class="hljs-comment">#  搜索功能</span>
<span class="hljs-comment">#  比 pkg.go.dev 更快</span>
</code></pre>
<h4 data-id="heading-23">3. go.mod ignore 指令</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// go.mod</span>
module myproject

<span class="hljs-keyword">go</span> <span class="hljs-number">1.25</span>

<span class="hljs-comment">// 忽略特定目录</span>
ignore ./vendor
ignore ./testdata
ignore ./tmp

<span class="hljs-comment">// go 命令会忽略这些目录</span>
</code></pre>
<h3 data-id="heading-24">标准库更新精选</h3>
<h4 data-id="heading-25">1. net/http - CSRF 保护</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"net/http"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    mux := http.NewServeMux()
    
    <span class="hljs-comment">// 注册处理器</span>
    mux.HandleFunc(<span class="hljs-string">"/api/data"</span>, handleData)
    
    <span class="hljs-comment">// 使用新的 CrossOriginProtection</span>
    protection := &amp;http.CrossOriginProtection{
        <span class="hljs-comment">// 允许的额外来源</span>
        AllowedOrigins: []<span class="hljs-type">string</span>{
            <span class="hljs-string">"https://trusted-domain.com"</span>,
        },
    }
    
    <span class="hljs-comment">// 应用保护</span>
    handler := protection.Wrap(mux)
    
    http.ListenAndServe(<span class="hljs-string">":8080"</span>, handler)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">handleData</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> {
    <span class="hljs-comment">// 自动检查:</span>
    <span class="hljs-comment">//  Sec-Fetch-Site 头</span>
    <span class="hljs-comment">//  Origin 与 Host 比较</span>
    <span class="hljs-comment">//  拒绝不安全的跨域请求</span>
    
    w.Write([]<span class="hljs-type">byte</span>(<span class="hljs-string">"安全的响应"</span>))
}
</code></pre>
<h4 data-id="heading-26">2. sync.WaitGroup.Go 方法</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"sync"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> wg sync.WaitGroup
    
    <span class="hljs-comment">// 老方法 - 啰嗦</span>
    wg.Add(<span class="hljs-number">1</span>)
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">defer</span> wg.Done()
        doWork()
    }()
    
    <span class="hljs-comment">// 新方法 - 简洁! ✨</span>
    wg.Go(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        doWork()
    })
    
    <span class="hljs-comment">// 多个任务</span>
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++ {
        i := i <span class="hljs-comment">// 注意:Go 1.22+ 不需要这行</span>
        wg.Go(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
            fmt.Println(<span class="hljs-string">"任务"</span>, i)
        })
    }
    
    wg.Wait()
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">doWork</span><span class="hljs-params">()</span></span> {
    time.Sleep(<span class="hljs-number">100</span> * time.Millisecond)
    fmt.Println(<span class="hljs-string">"工作完成"</span>)
}
</code></pre>
<h4 data-id="heading-27">3. os.Root - 安全的文件系统操作</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"os"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 创建受限的文件系统根</span>
    root, err := os.OpenRoot(<span class="hljs-string">"/safe/directory"</span>)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-built_in">panic</span>(err)
    }
    <span class="hljs-keyword">defer</span> root.Close()
    
    <span class="hljs-comment">// 所有操作都限制在 /safe/directory 内</span>
    
    <span class="hljs-comment">//  读取文件</span>
    data, err := root.ReadFile(<span class="hljs-string">"config.json"</span>)
    
    <span class="hljs-comment">//  创建目录</span>
    err = root.Mkdir(<span class="hljs-string">"subdir"</span>, <span class="hljs-number">0755</span>)
    
    <span class="hljs-comment">//  符号链接 (Go 1.25 新增!)</span>
    err = root.Symlink(<span class="hljs-string">"target.txt"</span>, <span class="hljs-string">"link.txt"</span>)
    
    <span class="hljs-comment">//  读取符号链接 (Go 1.25 新增!)</span>
    target, err := root.Readlink(<span class="hljs-string">"link.txt"</span>)
    
    <span class="hljs-comment">//  递归删除 (Go 1.25 新增!)</span>
    err = root.RemoveAll(<span class="hljs-string">"old-data"</span>)
    
    <span class="hljs-comment">//  无法访问父目录</span>
    <span class="hljs-comment">// 即使尝试 "../../../etc/passwd" 也会被阻止</span>
    _, err = root.Open(<span class="hljs-string">"../../../etc/passwd"</span>)
    <span class="hljs-comment">// err != nil (权限拒绝)</span>
    
    fmt.Println(<span class="hljs-string">"安全操作完成"</span>)
}
</code></pre>
<h4 data-id="heading-28">4. runtime.FlightRecorder - 运行时分析</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"os"</span>
    <span class="hljs-string">"runtime"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 启动 flight recorder</span>
    runtime.StartFlightRecorder()
    
    <span class="hljs-comment">// 运行你的程序</span>
    doWork()
    
    <span class="hljs-comment">// 发生问题时,获取记录</span>
    <span class="hljs-keyword">if</span> err := detectProblem(); err != <span class="hljs-literal">nil</span> {
        <span class="hljs-comment">// 保存最近的运行时事件</span>
        f, _ := os.Create(<span class="hljs-string">"flight-record.txt"</span>)
        runtime.WriteFlightRecord(f)
        f.Close()
        
        fmt.Println(<span class="hljs-string">"问题记录已保存"</span>)
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">doWork</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 你的应用逻辑</span>
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++ {
        <span class="hljs-comment">// ...</span>
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">detectProblem</span><span class="hljs-params">()</span></span> <span class="hljs-type">error</span> {
    <span class="hljs-comment">// 检测异常情况</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}
</code></pre>
<h3 data-id="heading-29">性能优化</h3>
<h4 data-id="heading-30">切片栈分配优化</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 编译器现在可以在栈上分配更多切片</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">process</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 以前:在堆上分配</span>
    <span class="hljs-comment">// 现在:可能在栈上分配(更快!)</span>
    data := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, <span class="hljs-number">1024</span>)
    
    <span class="hljs-comment">// 多个连续切片也能优化</span>
    batch1 := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, <span class="hljs-number">10</span>)
    batch2 := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, <span class="hljs-number">20</span>)
    batch3 := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, <span class="hljs-number">30</span>)
    
    <span class="hljs-comment">// 使用切片...</span>
    _ = data
    _ = batch1
    _ = batch2
    _ = batch3
}

<span class="hljs-comment">// 性能提升:</span>
<span class="hljs-comment">//  减少 GC 压力</span>
<span class="hljs-comment">//  更好的缓存局部性</span>
<span class="hljs-comment">//  更快的内存访问</span>
</code></pre>
<h4 data-id="heading-31">GOAMD64=v3 融合乘加指令</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 在 GOAMD64=v3 或更高版本</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">calculate</span><span class="hljs-params">(a, b, c <span class="hljs-type">float64</span>)</span></span> <span class="hljs-type">float64</span> {
    <span class="hljs-comment">// 编译器会使用 FMA (Fused Multiply-Add) 指令</span>
    <span class="hljs-keyword">return</span> a*b + c
    
    <span class="hljs-comment">// 优势:</span>
    <span class="hljs-comment">//  更快(单指令)</span>
    <span class="hljs-comment">//  更精确(更少舍入误差)</span>
    
    <span class="hljs-comment">// 如需避免融合:</span>
    <span class="hljs-comment">// return float64(a*b) + c</span>
}

<span class="hljs-comment">// 编译时启用:</span>
<span class="hljs-comment">// GOAMD64=v3 go build</span>
</code></pre>
<h3 data-id="heading-32">安全更新 (Go 1.25.5 特有)</h3>
<h4 data-id="heading-33">CVE-2025-61729: crypto/x509 资源消耗</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 修复前:恶意证书可导致资源耗尽</span>
<span class="hljs-comment">// HostnameError.Error() 无限制打印主机名</span>

<span class="hljs-comment">// 修复后:</span>
<span class="hljs-comment">//  限制打印的主机名数量</span>
<span class="hljs-comment">//  使用 strings.Builder 提高效率</span>
<span class="hljs-comment">//  防止二次时间复杂度</span>

<span class="hljs-comment">// 无需代码更改,升级到 1.25.5 即可</span>
</code></pre>
<h3 data-id="heading-34">平台支持更新</h3>
<h4 data-id="heading-35">Linux 平台增强</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// linux/loong64 现在支持:</span>
<span class="hljs-comment">//  race 检测器</span>
<span class="hljs-comment">//  SetCgoTraceback</span>
<span class="hljs-comment">//  内部链接模式</span>

<span class="hljs-comment">// linux/riscv64 现在支持:</span>
<span class="hljs-comment">//  plugin 构建模式</span>

<span class="hljs-comment">// GORISCV64 新值:</span>
<span class="hljs-comment">// GORISCV64=rva23u64 go build</span>
</code></pre>
<h4 data-id="heading-36">macOS 要求</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">#  重要:Go 1.25 需要 macOS 12 Monterey 或更高版本</span>
<span class="hljs-comment"># 不再支持 macOS 11 Big Sur 及更早版本</span>

<span class="hljs-comment"># 检查你的 macOS 版本:</span>
sw_vers

<span class="hljs-comment"># ProductName:    macOS</span>
<span class="hljs-comment"># ProductVersion: 12.0 或更高 </span>
</code></pre>
<h4 data-id="heading-37">Windows 32位 ARM 弃用</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># ⚠️ windows/arm (32位) 将在 Go 1.26 中移除</span>
<span class="hljs-comment"># 如果你使用此平台,请计划迁移到:</span>
<span class="hljs-comment"># - windows/arm64 (推荐)</span>
<span class="hljs-comment"># - 其他平台</span>
</code></pre>
<h3 data-id="heading-38">实验功能总结</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[Go 1.25 实验性功能] --&gt; B[GOEXPERIMENT=greenteagc]
    A --&gt; C[GOEXPERIMENT=jsonv2]
    A --&gt; D[GOEXPERIMENT=nodwarf5]
    
    B --&gt; B1[新垃圾回收器]
    B --&gt; B2[NUMA 优化]
    B --&gt; B3[多核性能提升]
    
    C --&gt; C1[重写的 JSON 包]
    C --&gt; C2[更好的性能]
    C --&gt; C3[API 可能变化]
    
    D --&gt; D1[回退到 DWARF 4]
    D --&gt; D2[兼容性选项]
    
    style A fill:#f9f,stroke:#333,stroke-width:4px
    style B fill:#ff9,stroke:#333
    style C fill:#ff9,stroke:#333
    style D fill:#9f9,stroke:#333
</code></pre>
<h3 data-id="heading-39">GODEBUG 设置一览</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 容器相关</span>
GODEBUG=containermaxprocs=0  <span class="hljs-comment"># 禁用 cgroup CPU 限制感知</span>
GODEBUG=updatemaxprocs=0     <span class="hljs-comment"># 禁用 GOMAXPROCS 自动更新</span>

<span class="hljs-comment"># GC 调试</span>
GODEBUG=checkfinalizers=1    <span class="hljs-comment"># 启用 finalizer 诊断</span>

<span class="hljs-comment"># 其他</span>
GODEBUG=http2client=0        <span class="hljs-comment"># 禁用 HTTP/2 客户端</span>
GODEBUG=http2server=0        <span class="hljs-comment"># 禁用 HTTP/2 服务器</span>
</code></pre>
<h3 data-id="heading-40">升级检查清单</h3>
<h4 data-id="heading-41">升级前</h4>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 检查当前 Go 版本:<code>go version</code></li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 备份项目代码</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 检查是否使用了 nil 指针相关的危险模式</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 审查错误处理顺序</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 记录当前性能基准</li>
</ul>
<h4 data-id="heading-42">升级步骤</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 下载 Go 1.25.5</span>
<span class="hljs-comment"># 从 https://go.dev/dl/ 下载对应平台版本</span>

<span class="hljs-comment"># 2. 安装</span>
<span class="hljs-comment"># macOS/Linux:</span>
sudo tar -C /usr/local -xzf go1.25.5.linux-amd64.tar.gz

<span class="hljs-comment"># 3. 验证安装</span>
go version
<span class="hljs-comment"># 应输出: go version go1.25.5 ...</span>

<span class="hljs-comment"># 4. 更新 go.mod</span>
go mod edit -go=1.25

<span class="hljs-comment"># 5. 下载依赖</span>
go mod download

<span class="hljs-comment"># 6. 重新构建</span>
go build ./...

<span class="hljs-comment"># 7. 运行测试</span>
go <span class="hljs-built_in">test</span> ./...
</code></pre>
<h4 data-id="heading-43">升级后验证</h4>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 所有测试通过</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 应用正常启动</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 检查容器环境中的 GOMAXPROCS 值</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 监控性能指标</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 检查日志中的新警告</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 验证调试信息正常</li>
</ul>
<h3 data-id="heading-44">性能测试对比</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// benchmark_test.go</span>
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"runtime"</span>
    <span class="hljs-string">"testing"</span>
)

<span class="hljs-comment">// 测试 GOMAXPROCS 行为</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkGOMAXPROCS</span><span class="hljs-params">(b *testing.B)</span></span> {
    b.Logf(<span class="hljs-string">"GOMAXPROCS: %d"</span>, runtime.GOMAXPROCS(<span class="hljs-number">0</span>))
    b.Logf(<span class="hljs-string">"NumCPU: %d"</span>, runtime.NumCPU())
    
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; b.N; i++ {
        <span class="hljs-comment">// 你的工作负载</span>
        _ = runtime.GOMAXPROCS(<span class="hljs-number">0</span>)
    }
}

<span class="hljs-comment">// 测试切片分配</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkSliceAlloc</span><span class="hljs-params">(b *testing.B)</span></span> {
    b.ReportAllocs()
    
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; b.N; i++ {
        <span class="hljs-comment">// Go 1.25 优化了栈分配</span>
        data := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, <span class="hljs-number">1024</span>)
        _ = data
    }
}
</code></pre>
<p>运行对比:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Go 1.24</span>
go <span class="hljs-built_in">test</span> -bench=. -benchmem

<span class="hljs-comment"># Go 1.25</span>
go <span class="hljs-built_in">test</span> -bench=. -benchmem

<span class="hljs-comment"># 对比结果,特别关注:</span>
<span class="hljs-comment"># - allocs/op (分配次数应该减少)</span>
<span class="hljs-comment"># - ns/op (时间应该减少)</span>
</code></pre>
<h3 data-id="heading-45">容器化最佳实践</h3>
<h4 data-id="heading-46">Dockerfile 示例</h4>
<pre><code class="hljs language-dockerfile" lang="dockerfile"># 使用 Go 1.25.5
FROM golang:1.25.5-alpine AS builder

WORKDIR /app

# 复制依赖文件
COPY go.mod go.sum ./
RUN go mod download

# 复制源代码
COPY . .

# 构建应用
RUN CGO_ENABLED=0 GOOS=linux go build -o myapp

# 运行阶段
FROM alpine:latest

WORKDIR /app
COPY --from=builder /app/myapp .

# Go 1.25 会自动识别容器 CPU 限制
# 无需手动设置 GOMAXPROCS!

EXPOSE 8080
CMD ["./myapp"]
</code></pre>
<h4 data-id="heading-47">Kubernetes 部署</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">myapp</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">myapp</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">myapp:go1.25.5</span>
        <span class="hljs-attr">resources:</span>
          <span class="hljs-attr">requests:</span>
            <span class="hljs-attr">cpu:</span> <span class="hljs-string">"1"</span>
            <span class="hljs-attr">memory:</span> <span class="hljs-string">"512Mi"</span>
          <span class="hljs-attr">limits:</span>
            <span class="hljs-attr">cpu:</span> <span class="hljs-string">"4"</span>        <span class="hljs-comment"># Go 1.25 会自动使用这个限制!</span>
            <span class="hljs-attr">memory:</span> <span class="hljs-string">"2Gi"</span>
        <span class="hljs-comment"># 无需设置 GOMAXPROCS 环境变量 </span>
</code></pre>
<h3 data-id="heading-48">常见问题与解答</h3>
<h4 data-id="heading-49">Q1: 我应该立即升级到 Go 1.25.5 吗?</h4>
<p><strong>A:</strong> 推荐升级,原因:</p>
<ul>
<li>包含重要安全修复 (CVE-2025-61729)</li>
<li>容器环境性能改进</li>
<li>修复了 nil 指针检查 bug</li>
<li>⚠️ 建议先在测试环境验证</li>
</ul>
<h4 data-id="heading-50">Q2: 实验性功能可以在生产环境使用吗?</h4>
<p><strong>A:</strong> 不推荐:</p>
<ul>
<li>Green Tea GC - 仍在实验阶段</li>
<li>JSON v2 - API 可能变化</li>
<li>可在测试环境试用并反馈</li>
</ul>
<h4 data-id="heading-51">Q3: 容器感知 GOMAXPROCS 会影响现有应用吗?</h4>
<p><strong>A:</strong> 大多数情况改进性能:</p>
<ul>
<li>减少不必要的上下文切换</li>
<li>更好的资源利用</li>
<li>⚠️ 如果手动设置过 GOMAXPROCS,新特性会被禁用</li>
<li>可用 <code>GODEBUG</code> 禁用此特性</li>
</ul>
<h4 data-id="heading-52">Q4: 如何检查我的代码是否受 nil 指针 bug 影响?</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 搜索危险模式</span>
grep -rn <span class="hljs-string">"err :="</span> . | grep -A 5 <span class="hljs-string">"if err"</span>

<span class="hljs-comment"># 2. 使用 vet 工具</span>
go vet ./...

<span class="hljs-comment"># 3. 代码审查重点:</span>
<span class="hljs-comment"># - 是否在检查 err 之前使用了返回值?</span>
<span class="hljs-comment"># - 特别注意 os.Open, os.Create 等函数</span>
</code></pre>
<h4 data-id="heading-53">Q5: macOS 11 用户怎么办?</h4>
<p><strong>A:</strong> 需要升级或使用旧版本:</p>
<ul>
<li>升级到 macOS 12 或更高 (推荐)</li>
<li>继续使用 Go 1.24 (有安全风险)</li>
<li>使用 Docker 容器开发</li>
</ul>
<h3 data-id="heading-54">迁移建议</h3>
<h4 data-id="heading-55">低风险项目 (推荐直接升级)</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[简单 Web 服务] --&gt; E[ 直接升级]
    B[CLI 工具] --&gt; E
    C[微服务] --&gt; E
    D[批处理脚本] --&gt; E
    E --&gt; F[测试]
    F --&gt; G[部署]
</code></pre>
<ul>
<li>Web API 服务</li>
<li>命令行工具</li>
<li>不涉及复杂并发的应用</li>
<li>不依赖实验性功能的项目</li>
</ul>
<h4 data-id="heading-56">中等风险项目 (先测试再升级)</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[复杂应用] --&gt; B[创建测试分支]
    B --&gt; C[升级 Go 版本]
    C --&gt; D[运行完整测试套件]
    D --&gt; E{测试通过?}
    E --&gt;|是| F[性能测试]
    E --&gt;|否| G[修复问题]
    G --&gt; D
    F --&gt; H{性能符合预期?}
    H --&gt;|是| I[逐步推广]
    H --&gt;|否| J[分析性能问题]
    J --&gt; G
</code></pre>
<ul>
<li>高并发系统</li>
<li>关键业务应用</li>
<li>使用大量 goroutines</li>
<li>有严格性能要求</li>
</ul>
<h4 data-id="heading-57">高风险项目 (谨慎评估)</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Team as 团队
    participant Test as 测试环境
    participant Stage as 预发布环境
    participant Prod as 生产环境
    
    Team-&gt;&gt;Test: 1. 部署 Go 1.25.5
    Test-&gt;&gt;Test: 2. 功能测试 (1周)
    Test-&gt;&gt;Test: 3. 压力测试
    Test-&gt;&gt;Team: 4. 收集问题
    Team-&gt;&gt;Stage: 5. 修复后部署
    Stage-&gt;&gt;Stage: 6. 灰度验证 (1-2周)
    Stage-&gt;&gt;Team: 7. 监控指标
    Team-&gt;&gt;Prod: 8. 逐步升级
    Prod-&gt;&gt;Team: 9. 持续监控
</code></pre>
<ul>
<li>金融交易系统</li>
<li>实时数据处理</li>
<li>有状态服务</li>
<li>零停机时间要求</li>
</ul>
<h3 data-id="heading-58">资源链接</h3>
<h4 data-id="heading-59">官方文档</h4>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fdoc%2Fgo1.25" target="_blank" title="https://go.dev/doc/go1.25" ref="nofollow noopener noreferrer">Go 1.25 发布说明</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fdl%2F" target="_blank" title="https://go.dev/dl/" ref="nofollow noopener noreferrer">Go 1.25.5 下载</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpkg.go.dev%2Fstd" target="_blank" title="https://pkg.go.dev/std" ref="nofollow noopener noreferrer">标准库文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgolang%2Fgo%2Fissues" target="_blank" title="https://github.com/golang/go/issues" ref="nofollow noopener noreferrer">已知问题追踪</a></li>
</ul>
<h4 data-id="heading-60">社区资源</h4>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgocn.vip%2F" target="_blank" title="https://gocn.vip/" ref="nofollow noopener noreferrer">Go 中文论坛</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fblog%2F" target="_blank" title="https://go.dev/blog/" ref="nofollow noopener noreferrer">Go 官方博客</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgobyexample.com%2F" target="_blank" title="https://gobyexample.com/" ref="nofollow noopener noreferrer">Go by Example</a></li>
</ul>
<h4 data-id="heading-61">工具推荐</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 版本管理</span>
go install golang.org/dl/go1.25.5@latest
go1.25.5 download

<span class="hljs-comment"># 依赖更新检查</span>
go install github.com/oligot/go-mod-upgrade@latest
go-mod-upgrade

<span class="hljs-comment"># 安全扫描</span>
go install golang.org/x/vuln/cmd/govulncheck@latest
govulncheck ./...

<span class="hljs-comment"># 性能分析</span>
go <span class="hljs-built_in">test</span> -cpuprofile=cpu.prof -memprofile=mem.prof -bench=.
go tool pprof cpu.prof
</code></pre>
<h3 data-id="heading-62">最佳实践总结</h3>
<h4 data-id="heading-63">DO</h4>
<ol>
<li><strong>及时升级到 1.25.5</strong> - 包含重要安全修复</li>
<li><strong>充分测试</strong> - 特别是错误处理逻辑</li>
<li><strong>利用新特性</strong> - 如 WaitGroup.Go(), testing/synctest</li>
<li><strong>监控容器资源</strong> - 验证 GOMAXPROCS 行为</li>
<li><strong>更新 go.mod</strong> - 声明 Go 1.25 获得新特性</li>
<li><strong>阅读迁移指南</strong> - 了解可能的破坏性变更</li>
</ol>
<h4 data-id="heading-64">DON'T</h4>
<ol>
<li><strong>不要在生产环境使用实验性功能</strong> - 除非充分测试</li>
<li><strong>不要忽略 vet 警告</strong> - 可能指示真实问题</li>
<li><strong>不要手动设置 GOMAXPROCS</strong> - 除非有特殊需求</li>
<li><strong>不要跳过测试阶段</strong> - 直接部署到生产</li>
<li><strong>不要混用旧的错误处理模式</strong> - 统一代码风格</li>
<li><strong>不要假设向后兼容</strong> - 验证关键路径</li>
</ol>
<h3 data-id="heading-65">版本对比快查表</h3>

































































<table><thead><tr><th>特性</th><th>Go 1.24</th><th>Go 1.25.5</th><th>备注</th></tr></thead><tbody><tr><td>容器感知 GOMAXPROCS</td><td>❌</td><td>✅</td><td>需 go.mod 1.25</td></tr><tr><td>testing/synctest</td><td>🧪 实验</td><td>✅ 正式</td><td>并发测试利器</td></tr><tr><td>JSON v2</td><td>❌</td><td>🧪 实验</td><td>需 GOEXPERIMENT</td></tr><tr><td>Green Tea GC</td><td>❌</td><td>🧪 实验</td><td>需 GOEXPERIMENT</td></tr><tr><td>DWARF 5</td><td>❌</td><td>✅ 默认</td><td>可禁用</td></tr><tr><td>nil 指针检查</td><td>🐛 Bug</td><td>✅ 修复</td><td>破坏性修复</td></tr><tr><td>os.Root 符号链接</td><td>❌</td><td>✅</td><td>新增 API</td></tr><tr><td>WaitGroup.Go</td><td>❌</td><td>✅</td><td>简化并发</td></tr><tr><td>最低 macOS 版本</td><td>11</td><td>12</td><td>⚠️ 不兼容</td></tr></tbody></table>
<h3 data-id="heading-66">筒子们这点非常重要 - 请务必看完这句话</h3>
<p><strong>Go 1.25.5 已发布,包含重要安全修复和性能改进。建议评估后升级,优先在测试环境验证,特别关注容器部署和错误处理逻辑。对于生产环境,可选择灰度发布或逐步升级策略。实验性功能(Green Tea GC, JSON v2)不建议在生产环境使用,但可在测试环境试用并向社区反馈。</strong></p>
<hr/>
<p><em>本文基于 Go 1.25.5 官方文档整理,最后更新: 2025年12月</em>24日</p>
<p>感谢整个 Go 社区的贡献!</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91f7995c326642bcb748d04b8ad2ea22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC05L2z5rWp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767115166&amp;x-signature=3L0h4idfzHRNwYIBNAWA5smcYq4%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Netty（30）Netty的性能指标和监控有哪些工具和技术？]]></title>    <link>https://juejin.cn/post/7586969583782248454</link>    <guid>https://juejin.cn/post/7586969583782248454</guid>    <pubDate>2025-12-23T23:01:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586969583782248454" data-draft-id="7586943543019241514" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Netty（30）Netty的性能指标和监控有哪些工具和技术？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-23T23:01:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Netty（30）Netty的性能指标和监控有哪些工具和技术？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T23:01:39.000Z" title="Tue Dec 23 2025 23:01:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在生产环境中，监控Netty应用的性能指标是确保系统稳定性和高效运行的重要手段。以下是一些常用的工具和技术，用于监控Netty的性能指标：</p>
<h3 data-id="heading-0">1. 使用JMX进行监控</h3>
<p>Java Management Extensions (JMX) 是Java平台的标准监控和管理工具。Netty提供了对JMX的支持，可以通过JMX来监控Netty的各种性能指标。</p>
<h4 data-id="heading-1">1.1 启用Netty的JMX支持</h4>
<p>可以通过在启动Netty时启用JMX支持来监控Netty的性能指标。以下是一个示例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.bootstrap.ServerBootstrap;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelPipeline;
<span class="hljs-keyword">import</span> io.netty.channel.EventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.socket.SocketChannel;
<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;
<span class="hljs-keyword">import</span> io.netty.handler.codec.string.StringDecoder;
<span class="hljs-keyword">import</span> io.netty.handler.codec.string.StringEncoder;
<span class="hljs-keyword">import</span> io.netty.handler.jmx.JmxReporter;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MonitoringServer</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">bossGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>(<span class="hljs-number">1</span>);
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">workerGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">ServerBootstrap</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerBootstrap</span>();
            b.group(bossGroup, workerGroup)
             .channel(NioServerSocketChannel.class)
             .childHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() {
                 <span class="hljs-meta">@Override</span>
                 <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception {
                     <span class="hljs-type">ChannelPipeline</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> ch.pipeline();
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringDecoder</span>());
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringEncoder</span>());
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleServerHandler</span>());
                 }
             });

            <span class="hljs-comment">// 启用JMX监控</span>
            <span class="hljs-type">JmxReporter</span> <span class="hljs-variable">reporter</span> <span class="hljs-operator">=</span> JmxReporter.forRegistry(b.config().group().next().parent().executor().getExecutorMetrics()).build();
            reporter.start();

            b.bind(<span class="hljs-number">8080</span>).sync().channel().closeFuture().sync();
        } <span class="hljs-keyword">finally</span> {
            bossGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        }
    }
}
</code></pre>
<h4 data-id="heading-2">1.2 使用JConsole监控JMX指标</h4>
<p>JConsole是JDK自带的一个JMX客户端工具，可以用来监控和管理Java应用程序。启动JConsole并连接到运行中的Netty应用程序后，可以查看各种JMX指标，包括线程池状态、内存使用情况、GC统计信息等。</p>
<h3 data-id="heading-3">2. 使用Metrics库进行监控</h3>
<p>Metrics是一个流行的Java库，用于收集和报告各类应用程序的性能指标。Netty可以与Metrics库集成，收集和报告各种性能指标。</p>
<h4 data-id="heading-4">2.1 添加Metrics依赖</h4>
<p>首先，需要在项目中添加Metrics库的依赖。以下是Maven依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.dropwizard.metrics<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>metrics-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.dropwizard.metrics<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>metrics-jmx<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h4 data-id="heading-5">2.2 集成Metrics库</h4>
<p>以下是一个示例，展示了如何将Metrics库集成到Netty应用中，并通过JMX报告性能指标：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.codahale.metrics.ConsoleReporter;
<span class="hljs-keyword">import</span> com.codahale.metrics.MetricRegistry;
<span class="hljs-keyword">import</span> com.codahale.metrics.jmx.JmxReporter;
<span class="hljs-keyword">import</span> com.codahale.metrics.jvm.GarbageCollectorMetricSet;
<span class="hljs-keyword">import</span> com.codahale.metrics.jvm.MemoryUsageGaugeSet;
<span class="hljs-keyword">import</span> io.netty.bootstrap.ServerBootstrap;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelPipeline;
<span class="hljs-keyword">import</span> io.netty.channel.EventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.socket.SocketChannel;
<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;
<span class="hljs-keyword">import</span> io.netty.handler.codec.string.StringDecoder;
<span class="hljs-keyword">import</span> io.netty.handler.codec.string.StringEncoder;

<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MetricsMonitoringServer</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">MetricRegistry</span> <span class="hljs-variable">metrics</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MetricRegistry</span>();
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 注册JVM内存和GC指标</span>
        metrics.register(<span class="hljs-string">"jvm.gc"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">GarbageCollectorMetricSet</span>());
        metrics.register(<span class="hljs-string">"jvm.memory"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">MemoryUsageGaugeSet</span>());

        <span class="hljs-comment">// 启用ConsoleReporter，定期打印指标</span>
        <span class="hljs-type">ConsoleReporter</span> <span class="hljs-variable">reporter</span> <span class="hljs-operator">=</span> ConsoleReporter.forRegistry(metrics)
                .convertRatesTo(TimeUnit.SECONDS)
                .convertDurationsTo(TimeUnit.MILLISECONDS)
                .build();
        reporter.start(<span class="hljs-number">1</span>, TimeUnit.MINUTES);

        <span class="hljs-comment">// 启用JMXReporter</span>
        <span class="hljs-type">JmxReporter</span> <span class="hljs-variable">jmxReporter</span> <span class="hljs-operator">=</span> JmxReporter.forRegistry(metrics).build();
        jmxReporter.start();

        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">bossGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>(<span class="hljs-number">1</span>);
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">workerGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">ServerBootstrap</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerBootstrap</span>();
            b.group(bossGroup, workerGroup)
             .channel(NioServerSocketChannel.class)
             .childHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() {
                 <span class="hljs-meta">@Override</span>
                 <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception {
                     <span class="hljs-type">ChannelPipeline</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> ch.pipeline();
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringDecoder</span>());
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringEncoder</span>());
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MetricsHandler</span>(metrics)); <span class="hljs-comment">// 使用MetricsHandler收集指标</span>
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleServerHandler</span>());
                 }
             });

            b.bind(<span class="hljs-number">8080</span>).sync().channel().closeFuture().sync();
        } <span class="hljs-keyword">finally</span> {
            bossGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        }
    }
}
</code></pre>
<h4 data-id="heading-6">2.3 实现MetricsHandler</h4>
<p><code>MetricsHandler</code>用于收集Netty相关的性能指标，例如请求数量、处理时间等。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.codahale.metrics.Meter;
<span class="hljs-keyword">import</span> com.codahale.metrics.MetricRegistry;
<span class="hljs-keyword">import</span> com.codahale.metrics.Timer;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInboundHandlerAdapter;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MetricsHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ChannelInboundHandlerAdapter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Meter requestsMeter;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Timer processingTimer;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MetricsHandler</span><span class="hljs-params">(MetricRegistry metrics)</span> {
        <span class="hljs-built_in">this</span>.requestsMeter = metrics.meter(<span class="hljs-string">"requests"</span>);
        <span class="hljs-built_in">this</span>.processingTimer = metrics.timer(<span class="hljs-string">"processing-time"</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead</span><span class="hljs-params">(ChannelHandlerContext ctx, Object msg)</span> <span class="hljs-keyword">throws</span> Exception {
        requestsMeter.mark();
        Timer.<span class="hljs-type">Context</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> processingTimer.time();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-built_in">super</span>.channelRead(ctx, msg);
        } <span class="hljs-keyword">finally</span> {
            context.stop();
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> {
        cause.printStackTrace();
        ctx.close();
    }
}
</code></pre>
<h3 data-id="heading-7">3. 使用Prometheus和Grafana进行监控</h3>
<p>Prometheus和Grafana是流行的开源监控和可视化工具。Netty可以通过Metrics库集成Prometheus，收集和报告性能指标，并通过Grafana进行可视化展示。</p>
<h4 data-id="heading-8">3.1 添加Prometheus依赖</h4>
<p>首先，需要在项目中添加Prometheus的依赖。以下是Maven依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.prometheus<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>simpleclient<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.prometheus<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>simpleclient_httpserver<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.prometheus<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>simpleclient_dropwizard<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h4 data-id="heading-9">3.2 集成Prometheus</h4>
<p>以下是一个示例，展示了如何将Prometheus集成到Netty应用中，并通过HTTP端点报告性能指标：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.codahale.metrics.MetricRegistry;
<span class="hljs-keyword">import</span> io.prometheus.client.CollectorRegistry;
<span class="hljs-keyword">import</span> io.prometheus.client.dropwizard.DropwizardExports;
<span class="hljs-keyword">import</span> io.prometheus.client.exporter.HTTPServer;
<span class="hljs-keyword">import</span> io.netty.bootstrap.ServerBootstrap;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelPipeline;
<span class="hljs-keyword">import</span> io.netty.channel.EventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.socket.SocketChannel;
<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;
<span class="hljs-keyword">import</span> io.netty.handler.codec.string.StringDecoder;
<span class="hljs-keyword">import</span> io.netty.handler.codec.string.StringEncoder;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrometheusMonitoringServer</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">MetricRegistry</span> <span class="hljs-variable">metrics</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MetricRegistry</span>();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 注册Prometheus Collector</span>
        CollectorRegistry.defaultRegistry.register(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DropwizardExports</span>(metrics));

        <span class="hljs-comment">// 启动Prometheus HTTP Server</span>
        <span class="hljs-type">HTTPServer</span> <span class="hljs-variable">prometheusServer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HTTPServer</span>(<span class="hljs-number">1234</span>);

        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">bossGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>(<span class="hljs-number">1</span>);
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">workerGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">ServerBootstrap</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerBootstrap</span>();
            b.group(bossGroup, workerGroup)
             .channel(NioServerSocketChannel.class)
             .childHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() {
                 <span class="hljs-meta">@Override</span>
                 <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception {
                     <span class="hljs-type">ChannelPipeline</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> ch.pipeline();
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringDecoder</span>());
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringEncoder</span>());
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MetricsHandler</span>(metrics)); <span class="hljs-comment">// 使用MetricsHandler收集指标</span>
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleServerHandler</span>());
                 }
             });

            b.bind(<span class="hljs-number">8080</span>).sync().channel().closeFuture().sync();
        } <span class="hljs-keyword">finally</span> {
            bossGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
            prometheusServer.stop();
        }
    }
}
</code></pre>
<h4 data-id="heading-10">3.3 配置Prometheus和Grafana</h4>
<p>配置Prometheus以从Netty应用程序中抓取指标，并使用Grafana进行可视化。</p>
<ul>
<li><strong>Prometheus配置文件</strong> (<code>prometheus.yml</code>):</li>
</ul>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">global:</span>
  <span class="hljs-attr">scrape_interval:</span> <span class="hljs-string">15s</span>

<span class="hljs-attr">scrape_configs:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">'netty'</span>
    <span class="hljs-attr">static_configs:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">'localhost:1234'</span>]
</code></pre>
<ul>
<li>
<p><strong>Grafana配置</strong>:</p>
<ol>
<li>启动Grafana并登录到仪表板。</li>
<li>添加Prometheus作为数据源，指向Prometheus服务器地址（例如，<code>http://localhost:9090</code>）。</li>
<li>创建新的仪表板并添加图表，从Prometheus数据源中选择Netty相关的指标进行可视化。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-11">总结</h3>
<p>通过以上步骤，我们展示了如何使用JMX、Metrics库、Prometheus和Grafana来监控Netty的性能指标。每种方法都有其独特的优点和适用场景，开发者可以根据实际需求选择合适的监控工具和技术。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android15适配之edge-to-edge和16kb到底咋适配]]></title>    <link>https://juejin.cn/post/7586943543019290666</link>    <guid>https://juejin.cn/post/7586943543019290666</guid>    <pubDate>2025-12-23T23:57:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586943543019290666" data-draft-id="7584243498528538624" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android15适配之edge-to-edge和16kb到底咋适配"/> <meta itemprop="keywords" content="前端,Android,Android Studio"/> <meta itemprop="datePublished" content="2025-12-23T23:57:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Coffeeee"/> <meta itemprop="url" content="https://juejin.cn/user/2089524588718126"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android15适配之edge-to-edge和16kb到底咋适配
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2089524588718126/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Coffeeee
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T23:57:26.000Z" title="Tue Dec 23 2025 23:57:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前一篇写了废了好大的功夫才把编译环境弄好跑通，然后高高兴兴的提测了，没想到提测后的第二天，测试小姐姐就跑来大叫：“你看下为什么那么多页面顶部那么靠上了，都没法点返回键了，我要给你提Bug!!!”，吓我一跳，心想着着我刚接手的项目，业务代码一行都没有动过，就只改了些gradle文件啊，怎么会出问题呢？马上解释“先别激动，我先看下啊，没改啥东西啊”结果人家把测试机放下了，人早就溜回去提Bug了，我把测试机拿来一看，果然标题栏一大半都被状态栏给挡住了，好几个页面都这样，奇怪了啊，随后一琢磨，怕是Android15的某个新特性在作妖吧，果然最终定位到了是edge-to-edge</p>
<h2 data-id="heading-0">edge-to-edge</h2>
<p>对edge-to-edge一无所知的我只好先从了解它开始，只有知道它做了些什么事情，才能再慢慢去处理产生的兼容问题，上官网查询了下，发现这段介绍 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7cba83a5e7b415585de1cbf0b1c33a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29mZmVlZWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767139045&amp;x-signature=GFSEkmU1AUK2FbIXjkwRQVI5w5A%3D" alt="image.png" width="90%" loading="lazy"/></p>
<p>说的还是蛮直白的，把点都说到了，就是个无边框设计，谷歌把这种页面全撑开了，同时把导航栏，状态栏之类的都弄成透明的，他们还把这个改动当成是一次体验上的优化，真是谢谢他们了，让我刚进公司就喜提个p0级的bug，搞不好也要被优化</p>
<h3 data-id="heading-1">增加视图边距</h3>
<p>首先来看下问题，如下图所示，大致可以展现出实际现象</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/685ab20d1a8d47c5b41c93dd7171d1b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29mZmVlZWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767139045&amp;x-signature=a4hf6xTfU9NrIiWlD%2FMjpRNYv8Y%3D" alt="image.png" width="50%" loading="lazy"/>
<p>界面上顶部与底部各有一个按钮，他们都被系统的状态栏和导航栏给挡住了，如果你的应用已经升级到了targetSdk35并且运行在不低于Android15的设备上，如果不做处理的话，你的应用也会有这样的问题，如果想让被遮挡的区域回到可操作范围的话，就必须给界面留出一定的边距，官方给出的解决方案如下</p>
<blockquote>
<p>为避免在手势模式或按钮模式下出现此类视觉重叠，您可以使用 getInsets(int) 和 WindowInsetsCompat.Type.systemBars()增加视图的边距</p>
</blockquote>
<p>那么就来尝试下，在Activity中添加如下处理 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/305590440d0444dcbf1b29f4388b0d4a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29mZmVlZWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767139045&amp;x-signature=ORU0OWuH9zMhQHH90lnfmFJQp8o%3D" alt="image.png" width="90%" loading="lazy"/></p>
<p>root就是页面的根视图，给根视图设置边距，这个边距是系统状态栏的边距，
<code>WindowInsets.Type.systemBars()</code>表示系统的所有状态栏，包括顶部状态栏以及底部导航栏，如果单纯只想设置状态栏的边距或者导航栏的边距，可以使用如下方式 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e54bb7f15d0a4baa98532c88130fed08~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29mZmVlZWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767139045&amp;x-signature=SHrmeEvqGieKPMvKrmKY7tsEvc4%3D" alt="image.png" width="70%" loading="lazy"/></p>
<p>现在我们的界面被遮挡的部分就出来了</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f043a28e8684e388cec01b0b40a7362~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29mZmVlZWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767139045&amp;x-signature=FH3WzZelRdWfjI8NQiOGzWeU23M%3D" alt="image.png" width="50%" loading="lazy"/>
<h3 data-id="heading-2">处理挖孔屏</h3>
<p>细心的人会发现<code>WindowInsets.Type.systemBars()</code>获取的值里面其实并不包含挖孔屏或者刘海屏</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbe1f507e4a44c138d8e2b974dae01c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29mZmVlZWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767139045&amp;x-signature=wE5yyYcCxQQ%2FEwuRlIR%2FuOTw4%2BQ%3D" alt="image.png" width="80%" loading="lazy"/>
<p>那么这是不是代表着我们就可以不用考虑这类设备了呢？怎么可能，就比如上述代码，我们如果将模拟器调成带刘海的，我们就会发现...</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ee06b401ebd4fd79f314dda795be645~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29mZmVlZWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767139045&amp;x-signature=VCHVLn2kvFHmhmdwIdA9hP7hZqU%3D" alt="image.png" width="40%" loading="lazy"/>
<p>好像也没啥问题，但是尝试下转个屏呢 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b443b1741a0484c86e46e863f9d47d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29mZmVlZWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767139045&amp;x-signature=CTDmAeidJXmtDqNAob8hP8BCj60%3D" alt="image.png" width="70%" loading="lazy"/></p>
<p>就会发现刘海区域已经将我们界面的一部分给遮挡住了，并没有预留出边距，所以为了将这种场景也考虑进去，我们的代码必须改一下 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4525872aaae742c8bb1d4cee84325d86~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29mZmVlZWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767139045&amp;x-signature=oBrm53Tv3FxZZ4heNXSdzG64otg%3D" alt="image.png" width="90%" loading="lazy"/></p>
<p>增加了<code>WindowInsets.Type.displayCutout()</code>,这样的话当设备是挖孔或者刘海屏的时候，我们的界面也会根据刘海或者挖孔所占的区域大小，留出相应边距</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a83ac350f80c4ca99e7650b846a218e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29mZmVlZWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767139045&amp;x-signature=uVOL3f72ums%2BdH3HSGu%2Bwz5Eews%3D" alt="image.png" width="70%" loading="lazy"/>
<p>现在界面展示效果就好些了,bug改完了，打个包给测试验一下吧</p>
<h3 data-id="heading-3">隐藏或展示systemBar</h3>
<p>包给到测试后，我继续去了解了下edge-to-edge，发现除了给系统栏增加边距之外，还可以隐藏系统栏，通过先获取<code>WindowInsetsControllerCompat</code>，然后调用<code>hide</code>函数就可以，至于想隐藏什么东西，就将参数传给<code>hide</code>函数就好</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40efbb73fe7d407c832a0de7d43b3f89~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29mZmVlZWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767139045&amp;x-signature=8nXyOmRvgxzFQqSME8ZC8kAi%2Ft8%3D" alt="image.png" width="90%" loading="lazy"/>
<p>上述代码就是将状态栏，导航栏全部隐藏</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a444b941f3e4a79bad7bd7b6ac6661a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29mZmVlZWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767139045&amp;x-signature=BdSlrnMeT6I29OPdmyTm4mon9k0%3D" alt="image.png" width="40%" loading="lazy"/>
<p>如果只想要单独隐藏状态栏或者导航栏，只需要传入<code>WindowInsets.Type.statusBars()</code>或者
<code>WindowInsets.Type.navigationBars()</code>即可，同样的，如果想在隐藏后再展示的话，可以调用<code>show</code>函数，传参逻辑同<code>hide</code>一样</p>
<h3 data-id="heading-4">改变状态栏icon颜色</h3>
<p>很多时候，页面都需要根据不同主题去切换状态栏icon的颜色，比如淡颜色主题的，icon需要呈现黑色，而一些深色主题的，icon需要显示成白色，而这种功能同样可以使用<code>WindowInsetsControllerCompat</code>来实现，<code>isAppearanceLightStatusBars</code>设置成<code>true</code>就是黑色icon，<code>false</code>就是白色icon</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5d98e9c695b49afa8713b2810e46ca3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29mZmVlZWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767139045&amp;x-signature=h9jEvmf0CVR6h0zhHCCpci3dc9Q%3D" alt="image.png" width="90%" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/626ea84e4db347e285ae44c4609104ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29mZmVlZWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767139045&amp;x-signature=Dcc54Du6XebvyQ3AVHWtmGB%2B6Tk%3D" alt="image.png" width="70%" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7e9b9e715594bb99d9180edcadaee4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29mZmVlZWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767139045&amp;x-signature=WIupCkBY9oBZPCDNn%2BJ6D4uwK8k%3D" alt="image.png" width="90%" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5fb8f8f086643b7b6724a1172583ed4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29mZmVlZWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767139045&amp;x-signature=1rBE%2FPII3eeqsU9cwcBK%2F3AWwWQ%3D" alt="image.png" width="70%" loading="lazy"/>
<h3 data-id="heading-5">导航栏透明</h3>
<p>开头我们在Android 15的介绍中有注意到，三按钮导航栏变成了半透明，而且从之前的展示效果中也注意到，底部三按钮导航栏的确不是全透明的</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55c85192b65e4cfc8b929571c9c703bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29mZmVlZWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767139045&amp;x-signature=71U16qvgjWokCbvm6ZiZvZIocMU%3D" alt="image.png" width="70%" loading="lazy"/>
<p>如果我们想把导航栏设置成全透明的，只需要一行代码即可 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd4655416ca046d0a40a629b27fbe8c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29mZmVlZWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767139045&amp;x-signature=1d5e2%2FFtPVRtJLKLCgvEhdPJ6z0%3D" alt="image.png" width="90%" loading="lazy"/></p>
<p>将<code>isNavigationBarContrastEnforced</code>属性设置成<code>false</code>就可以获得一个全透明的导航栏</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/620a5dc5ad914085bccf2573c7d85990~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29mZmVlZWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767139045&amp;x-signature=iqQWxHPvL0Q9DGK7QJs4dP%2B09ek%3D" alt="image.png" width="70%" loading="lazy"/>
<h2 data-id="heading-6">16kb内存页面</h2>
<p>当我在适配完edge-to-edge的某个下午，运营小姐姐给我弹了个消息出来</p>
<ul>
<li>运营：听说你是新来的Android,在做我们产品的Android15适配是哇</li>
<li>我：是的，有什么事吗？</li>
<li>运营：没啥大事，你可能要多加一件事情，就是要做一下16kb内存页面对齐的事情，之前谷歌就要求做了，我们给推迟了</li>
<li>我：16kb？那是啥？</li>
<li>运营：你不是做Android的吗？这个都不知道？</li>
<li>我：我是不知道呀，以前都没听过</li>
<li>运营：自己查资料去吧</li>
</ul>
<p>看起来像是个耐心不怎么好的运营，我只能自己去查了，去官网上看了下，发现一段对于16kb的介绍</p>
<blockquote>
<p>从历史上看，Android 仅支持 4 KB 内存页面大小，这优化了系统内存性能，以适应 Android 设备通常拥有的平均总内存量。从 Android 15 开始，AOSP 支持配置为使用 16 KB 页面大小的设备（16 KB 设备）。如果您的应用直接或通过 SDK 间接使用任何 NDK 库，则需要重新构建应用，才能在这些 16 KB 设备上运行</p>
</blockquote>
<p>是一项内存方面的优化，但是要做这件事之前，需要重新构建应用，好家伙这么麻烦的吗，可以不构建吗？然后下面就看到了另一句话</p>
<blockquote>
<p>如果不重新编译，应用将无法在未来 Android 版本的 16 KB 设备上运行</p>
</blockquote>
<p>还是谷歌狠啊，你不做直接没法在手机上运行，那么问题来了，如何知道自己的应用用到了NDK的库并且都是些什么库呢，我这里有两种方式</p>
<h3 data-id="heading-7">Analyze Apk</h3>
<p>在Android Studio中的菜单栏里面选择Build-&gt;Analyze Apk,选择一个构建好的apk文件，或者直接generate apk构建一个apk文件，然后从右下角弹出来的框子中点击analyze选项</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/860d8b5cc16849919daf6a88111bb606~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29mZmVlZWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767139045&amp;x-signature=yo9DsKgpYZz8NEugBAO8KSHrrbs%3D" alt="image.png" width="80%" loading="lazy"/>
<p>都会跳出来一个页面来展示出你的apk里面是否包含了不符合16kb的so文件，像这样</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a977b7f10484997a37c17e260a7ec60~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29mZmVlZWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767139045&amp;x-signature=paBkjEzWjHyDUokl6pvMK37OUYY%3D" alt="image.png" width="90%" loading="lazy"/>
<p>上图的意思就是这个apk不支持16kb的设备，并且指出了是项目中用到的mmkv这个库不支持</p>
<h3 data-id="heading-8">AnalyzeSoGradlePlugin</h3>
<p>另一种方式是在项目中使用AnalyzeSoGradlePlugin这个插件，它可以帮你检测出哪些库不支持16kb,<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FRavenLiao%2FAnalyzeSoGradlePlugin" target="_blank" title="https://github.com/RavenLiao/AnalyzeSoGradlePlugin" ref="nofollow noopener noreferrer">这个是项目地址</a>，使用方式很简单，首先第一步在app/build.gradle文件中引入插件，版本使用最新版本就好</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4685af58d0d348ee93699d8c927a9e2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29mZmVlZWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767139045&amp;x-signature=NEocZ07dJm%2BafENw2f%2BoTXWjPvw%3D" alt="image.png" width="90%" loading="lazy"/>
<p>同步之后，在终端执行以下命令</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97d0982a5de342cb80ee1c8ed5137455~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29mZmVlZWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767139045&amp;x-signature=KJ6PYu083PXkgmc8poyJI2NXMk0%3D" alt="image.png" width="70%" loading="lazy"/>
<p>最终就会生成一个本地的html文件，这个文件就生成在<code>/app/build/reports/analyze-so/aggregate/analyze-so-report.html</code>目录下</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d200aa39ffe2425aa807f0963ed00b2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29mZmVlZWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767139045&amp;x-signature=%2Fj8wfuoVQC6ue6SPty9S22yLA0Q%3D" alt="image.png" width="80%" loading="lazy"/>
<p>这个插件不但会告诉你哪个so库不支持，而且还会指出是哪个库引入的并且引入版本是多少</p>
<p>以上两种方式都可以用，方法一无代码侵入，但是信息量较少，方法二需要有代码侵入，但是可以知道so是否支持16kb,so库的来源以及版本，下面来看下如何对齐16kb</p>
<h3 data-id="heading-9">三方库对齐</h3>
<p>通过上述使用AnalyzeSoGradlePlugin插件的方式我们可以很容易知道哪些三方库没有对齐，那么针对这些库我们能做的只能去他们官方文档中去寻找是否有版本已经做过对齐工作，下面是我列举的几个三方库以及他们做过16kb对齐的版本</p>













































<table><thead><tr><th>标题</th><th>对齐的版本</th><th>官方地址</th></tr></thead><tbody><tr><td>MMKV</td><td>v1.3.14</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTencent%2FMMKV%2Freleases" target="_blank" title="https://github.com/Tencent/MMKV/releases" ref="nofollow noopener noreferrer"> mmkv更新日志</a></td></tr><tr><td>android-gif-drawable</td><td>v1.2.29</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkoral--%2Fandroid-gif-drawable%2Freleases" target="_blank" title="https://github.com/koral--/android-gif-drawable/releases" ref="nofollow noopener noreferrer"> android-gif-drawable更新日志</a></td></tr><tr><td>firebase-crashlytics-ndk</td><td>v19.0.2</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Ffirebase.google.cn%2Fsupport%2Frelease-notes%2Fandroid%23google-services_plugin_v4-4-2" target="_blank" title="https://firebase.google.cn/support/release-notes/android#google-services_plugin_v4-4-2" ref="nofollow noopener noreferrer">Firebase更新日志</a></td></tr><tr><td>Flutter</td><td>v3.27.0</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.flutter.dev%2Frelease%2Frelease-notes%2Frelease-notes-3.27.0" target="_blank" title="https://docs.flutter.dev/release/release-notes/release-notes-3.27.0" ref="nofollow noopener noreferrer">Flutter更新日志</a></td></tr><tr><td>AndroidPdfViewer</td><td>v3.2.0-beta.1</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FDImuthuUpe%2FAndroidPdfViewer" target="_blank" title="https://github.com/DImuthuUpe/AndroidPdfViewer" ref="nofollow noopener noreferrer">Github地址</a></td></tr><tr><td>腾讯TRTC</td><td>v12.2</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fdocument%2Fproduct%2F647%2F46907" target="_blank" title="https://cloud.tencent.com/document/product/647/46907" ref="nofollow noopener noreferrer">官方更新日志</a></td></tr><tr><td>声网RTC</td><td>v4.5.0</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.shengwang.cn%2Fdoc%2Frtc%2Fandroid%2Foverview%2Frelease-notes" target="_blank" title="https://doc.shengwang.cn/doc/rtc/android/overview/release-notes" ref="nofollow noopener noreferrer">官方更新日志</a></td></tr></tbody></table>
<p>其实单从三方库对齐这件事情上看，没什么难度，有网就行，但是其中运气成份占很大比重，有的幸运儿，可能只需要更新几个库就完成了整个16kb对齐工作，但是有的倒霉孩子可能会遇到有些库官方并没有给出对应的适配版本，咋办呢？</p>
<ol>
<li>找其他三方库来代替：缺点就是这种方式多少得侵入一些业务代码</li>
<li>把源码搞下来自己编译：这种方式前提人家是开源的，得拿到人家完整的c层代码</li>
</ol>
<p>两种方案都不是什么轻松的事情，如果前期不做好调研工作，那么很容易会让你的任务延期，等待而来的就是领导跟项目经理的盘问</p>
<h3 data-id="heading-10">本地库</h3>
<p>除了三方库，项目中还会有一些需要自己去编译的库，这些库相对来讲是最保险的，因为主动权就在自己的手里，你只需要去重新编译下就好了，官网也给出了对应的编译方式</p>
<h4 data-id="heading-11">r28以及以上</h4>
<p>ndk版本在28或以上的，应用会默认编译为16kb对齐</p>
<h4 data-id="heading-12">r27</h4>
<p>ndk版本是27的需要添加如下配置</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e5b751db88346c1a78123c98b473013~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29mZmVlZWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767139045&amp;x-signature=I18knupQJhEqSF0Zd0oOrBHu6Ms%3D" alt="image.png" width="80%" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7937e05394084a3d957bbbb789a1adc3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29mZmVlZWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767139045&amp;x-signature=gwUl26O3wa%2F1%2BNAbsxQrHaqkGLM%3D" alt="image.png" width="80%" loading="lazy"/>
<h4 data-id="heading-13">r26或更低版本</h4>
<p>ndk版本是26或者更低版本，配置如下</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87feccfb33564b3db777491249e77a61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29mZmVlZWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767139045&amp;x-signature=NMgp8s62CmwoQNnWi6830ZNhFjo%3D" alt="image.png" width="80%" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80727c9358d34445b6c862693632a743~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29mZmVlZWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767139045&amp;x-signature=qRt8gjPJjYFHjrVpbuW0JwXMSKU%3D" alt="image.png" width="90%" loading="lazy"/>
<p>但是光编译还不行，还要检查一下代码当中某些位置是否存在假定设备使用了特定的页面大小，如果有的话，运行时仍旧会报错，排查分为以下两个步骤</p>
<ol>
<li>移除代码逻辑中引用 <code>PAGE_SIZE</code> 常量或假设设备内存页大小为 4 KB (4096) 的任何硬编码依赖项。请改用<code>getpagesize()</code> 或 <code>sysconf(_SC_PAGESIZE)</code></li>
<li>查找<code>mmap()</code>的用法以及需要页对齐实参的其他 API，并在必要时替换为替代方案</li>
</ol>
<h3 data-id="heading-14">二方库</h3>
<p>有些项目当中会依赖一些其他研发组或者部门所开发的库，这类库称为二方库，这种库明面上看似不需要自己动手最轻松，但是个人认为是最难对齐的，原因如下</p>
<ol>
<li>有的库的年代比较久远，“maintainer是谁”这个问题会成为你一段时间内特别想知道的事情，并且还要期盼着不要出现最坏情况，maintainer没交接完就离职了</li>
<li>一定的沟通成本，what,why,how可能需要重复不止一遍，就算都拉到一个会议室，一个群里面，每个库的对齐方式也是不一样的，一次性也说不完</li>
<li>排期增加了太多不确定因素，有的人需要花三天，有的人需要花两天，有的人可以立即开始，有的人可能这周任务排满了得下周开始,有的人交付后没达到效果得回炉重造......一系列因素堆在一起，问题就来了，咱这任务得排到哪一天截止才能让产品领导项目经理对你点头微笑呢？</li>
</ol>
<h2 data-id="heading-15">总结</h2>
<p>折腾了俩特性，感觉edge-to-edge虽说展现出的现象挺吓人，一会这个看不见了一会那个点不了了，但是真不难适配，知道怎么整边衬区，怎么控制那些系统栏就可以了，16kb说心里话，是真的不管人死活，它本身出来就是一个优化体验的事情，做成可配置的就好了啊，为什么一定非要强制，不做还不让上架，app都不让人用，实在是不明白</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Netty（29）如何实现基于Netty的长连接和推送通知？]]></title>    <link>https://juejin.cn/post/7586943543019225130</link>    <guid>https://juejin.cn/post/7586943543019225130</guid>    <pubDate>2025-12-23T23:00:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586943543019225130" data-draft-id="7586969583782232070" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Netty（29）如何实现基于Netty的长连接和推送通知？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-23T23:00:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Netty（29）如何实现基于Netty的长连接和推送通知？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T23:00:47.000Z" title="Tue Dec 23 2025 23:00:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>实现基于Netty的长连接和推送通知涉及到多个步骤，包括服务器端和客户端的实现、心跳检测、消息推送等。以下是详细的实现过程和代码示例。</p>
<h3 data-id="heading-0">1. 实现服务器端</h3>
<p>服务器端需要处理客户端的连接、心跳检测、消息推送等功能。</p>
<h4 data-id="heading-1">1.1 定义服务器端</h4>
<p>首先，我们定义一个简单的服务器，它将接收客户端的连接并处理消息。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.bootstrap.ServerBootstrap;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelPipeline;
<span class="hljs-keyword">import</span> io.netty.channel.EventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.socket.SocketChannel;
<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;
<span class="hljs-keyword">import</span> io.netty.handler.codec.string.StringDecoder;
<span class="hljs-keyword">import</span> io.netty.handler.codec.string.StringEncoder;
<span class="hljs-keyword">import</span> io.netty.handler.timeout.IdleStateHandler;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PushNotificationServer</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">bossGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>(<span class="hljs-number">1</span>);
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">workerGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">ServerBootstrap</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerBootstrap</span>();
            b.group(bossGroup, workerGroup)
             .channel(NioServerSocketChannel.class)
             .childHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() {
                 <span class="hljs-meta">@Override</span>
                 <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception {
                     <span class="hljs-type">ChannelPipeline</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> ch.pipeline();
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IdleStateHandler</span>(<span class="hljs-number">60</span>, <span class="hljs-number">30</span>, <span class="hljs-number">0</span>)); <span class="hljs-comment">// 心跳检测</span>
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringDecoder</span>());
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringEncoder</span>());
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HeartbeatHandler</span>()); <span class="hljs-comment">// 心跳处理器</span>
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PushNotificationServerHandler</span>()); <span class="hljs-comment">// 主要处理器</span>
                 }
             });

            b.bind(<span class="hljs-number">8080</span>).sync().channel().closeFuture().sync();
        } <span class="hljs-keyword">finally</span> {
            bossGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        }
    }
}
</code></pre>
<h4 data-id="heading-2">1.2 实现心跳处理器</h4>
<p><code>HeartbeatHandler</code>用于处理心跳检测，确保客户端和服务器端的长连接保持活跃。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInboundHandlerAdapter;
<span class="hljs-keyword">import</span> io.netty.handler.timeout.IdleState;
<span class="hljs-keyword">import</span> io.netty.handler.timeout.IdleStateEvent;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeartbeatHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ChannelInboundHandlerAdapter</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">userEventTriggered</span><span class="hljs-params">(ChannelHandlerContext ctx, Object evt)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">if</span> (evt <span class="hljs-keyword">instanceof</span> IdleStateEvent) {
            <span class="hljs-type">IdleStateEvent</span> <span class="hljs-variable">event</span> <span class="hljs-operator">=</span> (IdleStateEvent) evt;
            <span class="hljs-keyword">if</span> (event.state() == IdleState.READER_IDLE) {
                System.out.println(<span class="hljs-string">"Reader idle, closing connection"</span>);
                ctx.close();
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event.state() == IdleState.WRITER_IDLE) {
                System.out.println(<span class="hljs-string">"Writer idle, sending heartbeat"</span>);
                ctx.writeAndFlush(<span class="hljs-string">"HEARTBEAT"</span>);
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">super</span>.userEventTriggered(ctx, evt);
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> {
        cause.printStackTrace();
        ctx.close();
    }
}
</code></pre>
<h4 data-id="heading-3">1.3 实现主要处理器</h4>
<p><code>PushNotificationServerHandler</code>用于处理客户端消息和推送通知。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;
<span class="hljs-keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PushNotificationServerHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SimpleChannelInboundHandler</span>&lt;String&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, String msg)</span> <span class="hljs-keyword">throws</span> Exception {
        System.out.println(<span class="hljs-string">"Received message: "</span> + msg);
        <span class="hljs-comment">// 处理接收到的消息</span>
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelActive</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception {
        System.out.println(<span class="hljs-string">"Client connected: "</span> + ctx.channel().remoteAddress());
        <span class="hljs-comment">// 可以在这里向客户端发送欢迎消息或初始化数据</span>
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> {
        cause.printStackTrace();
        ctx.close();
    }

    <span class="hljs-comment">// 用于向所有连接的客户端推送消息</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pushNotification</span><span class="hljs-params">(ChannelHandlerContext ctx, String message)</span> {
        ctx.writeAndFlush(message);
    }
}
</code></pre>
<h3 data-id="heading-4">2. 实现客户端</h3>
<p>客户端需要连接服务器并处理心跳响应和推送通知。</p>
<h4 data-id="heading-5">2.1 定义客户端</h4>
<p>首先，我们定义一个简单的客户端，它将连接服务器并处理消息。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.bootstrap.Bootstrap;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelPipeline;
<span class="hljs-keyword">import</span> io.netty.channel.EventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.socket.SocketChannel;
<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioSocketChannel;
<span class="hljs-keyword">import</span> io.netty.handler.codec.string.StringDecoder;
<span class="hljs-keyword">import</span> io.netty.handler.codec.string.StringEncoder;
<span class="hljs-keyword">import</span> io.netty.handler.timeout.IdleStateHandler;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PushNotificationClient</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">group</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Bootstrap</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bootstrap</span>();
            b.group(group)
             .channel(NioSocketChannel.class)
             .handler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() {
                 <span class="hljs-meta">@Override</span>
                 <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception {
                     <span class="hljs-type">ChannelPipeline</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> ch.pipeline();
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IdleStateHandler</span>(<span class="hljs-number">0</span>, <span class="hljs-number">30</span>, <span class="hljs-number">0</span>)); <span class="hljs-comment">// 心跳检测</span>
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringDecoder</span>());
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringEncoder</span>());
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HeartbeatHandler</span>()); <span class="hljs-comment">// 心跳处理器</span>
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PushNotificationClientHandler</span>()); <span class="hljs-comment">// 主要处理器</span>
                 }
             });

            b.connect(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">8080</span>).sync().channel().closeFuture().sync();
        } <span class="hljs-keyword">finally</span> {
            group.shutdownGracefully();
        }
    }
}
</code></pre>
<h4 data-id="heading-6">2.2 实现主要处理器</h4>
<p><code>PushNotificationClientHandler</code>用于处理服务器的消息和心跳响应。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;
<span class="hljs-keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PushNotificationClientHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SimpleChannelInboundHandler</span>&lt;String&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, String msg)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"HEARTBEAT"</span>.equals(msg)) {
            System.out.println(<span class="hljs-string">"Received heartbeat from server"</span>);
        } <span class="hljs-keyword">else</span> {
            System.out.println(<span class="hljs-string">"Received notification: "</span> + msg);
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelActive</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception {
        System.out.println(<span class="hljs-string">"Connected to server"</span>);
        <span class="hljs-comment">// 可以在这里发送初始消息</span>
        ctx.writeAndFlush(<span class="hljs-string">"Client connected"</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> {
        cause.printStackTrace();
        ctx.close();
    }
}
</code></pre>
<h3 data-id="heading-7">3. 发送推送通知</h3>
<p>服务器端可以通过<code>ChannelGroup</code>来管理所有的客户端连接，并向所有连接的客户端发送推送通知。</p>
<h4 data-id="heading-8">3.1 使用ChannelGroup管理客户端连接</h4>
<p>修改<code>PushNotificationServerHandler</code>以使用<code>ChannelGroup</code>管理客户端连接。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;
<span class="hljs-keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;
<span class="hljs-keyword">import</span> io.netty.channel.group.ChannelGroup;
<span class="hljs-keyword">import</span> io.netty.channel.group.DefaultChannelGroup;
<span class="hljs-keyword">import</span> io.netty.util.concurrent.GlobalEventExecutor;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PushNotificationServerHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SimpleChannelInboundHandler</span>&lt;String&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ChannelGroup</span> <span class="hljs-variable">channels</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultChannelGroup</span>(GlobalEventExecutor.INSTANCE);

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handlerAdded</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception {
        channels.add(ctx.channel());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handlerRemoved</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception {
        channels.remove(ctx.channel());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, String msg)</span> <span class="hljs-keyword">throws</span> Exception {
        System.out.println(<span class="hljs-string">"Received message: "</span> + msg);
        <span class="hljs-comment">// 处理接收到的消息</span>
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelActive</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception {
        System.out.println(<span class="hljs-string">"Client connected: "</span> + ctx.channel().remoteAddress());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> {
        cause.printStackTrace();
        ctx.close();
    }

    <span class="hljs-comment">// 用于向所有连接的客户端推送消息</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pushNotification</span><span class="hljs-params">(String message)</span> {
        channels.writeAndFlush(message);
    }
}
</code></pre>
<h4 data-id="heading-9">3.2 发送推送通知</h4>
<p>在服务器端的某个地方调用<code>pushNotification</code>方法向所有客户端发送推送通知。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PushNotificationServerMain</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">PushNotificationServer</span> <span class="hljs-variable">server</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PushNotificationServer</span>();
        server.start();

        <span class="hljs-comment">// 模拟推送通知</span>
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            Thread.sleep(<span class="hljs-number">10000</span>); <span class="hljs-comment">// 每10秒推送一次通知</span>
            server.pushNotification(<span class="hljs-string">"This is a push notification"</span>);
        }
    }
}
</code></pre>
<h3 data-id="heading-10">4. 总结</h3>
<p>通过以上步骤，我们实现了一个基于Netty的长连接和推送通知系统。服务器端通过<code>ChannelGroup</code>管理所有客户端连接，并定期发送心跳消息以保持连接活跃。客户端处理心跳响应和推送通知，确保连接的稳定性和消息的实时性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于 YOLOv8 的智能车牌定位检测系统设计与实现—从模型训练到 PyQt 可视化落地的完整实战方案]]></title>    <link>https://juejin.cn/post/7586939930155204651</link>    <guid>https://juejin.cn/post/7586939930155204651</guid>    <pubDate>2025-12-23T15:12:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586939930155204651" data-draft-id="7586943543018881066" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于 YOLOv8 的智能车牌定位检测系统设计与实现—从模型训练到 PyQt 可视化落地的完整实战方案"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-23T15:12:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我是杰尼"/> <meta itemprop="url" content="https://juejin.cn/user/4200579899599495"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于 YOLOv8 的智能车牌定位检测系统设计与实现—从模型训练到 PyQt 可视化落地的完整实战方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4200579899599495/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我是杰尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T15:12:24.000Z" title="Tue Dec 23 2025 15:12:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">基于 YOLOv8 的智能车牌定位检测系统设计与实现—从模型训练到 PyQt 可视化落地的完整实战方案</h2>
<h3 data-id="heading-1">一、项目背景与研究意义</h3>
<p>随着智慧交通与城市智能化建设的不断推进，<strong>车牌识别（License Plate Detection &amp; Recognition）</strong> 已成为交通管理、停车系统、电子收费、高速卡口等场景中的关键技术模块。</p>
<p>在整个车牌识别流程中，<strong>车牌位置检测</strong> 是最基础、也是最关键的一步。如果检测阶段出现漏检或定位不准，将直接影响后续 OCR 识别效果。</p>
<p>传统基于规则或颜色特征的方法存在明显局限：</p>
<ul>
<li>对光照变化敏感</li>
<li>难以适应复杂背景</li>
<li>泛化能力差</li>
<li>实际工程中误检率高</li>
</ul>
<p>近年来，<strong>基于深度学习的目标检测算法</strong> 在该领域表现突出，尤其是 YOLO 系列模型，在实时性和精度之间取得了良好平衡。</p>
<p>因此，本文将完整介绍一个 <strong>基于 YOLOv8 的车牌位置实时检测系统</strong>，从数据集、模型训练到 PyQt5 图形界面部署，给出一套<strong>可直接运行、可二次开发、可用于课程设计或毕设的完整工程方案</strong>。</p>
<hr/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ff584357ba54342833c157a526c03bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767107544&amp;x-signature=UHI0VlTVTTF2y5vhMCTOcI%2FY39s%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98d380bef9c449d4b185fd88134245ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767107544&amp;x-signature=6DKSQkWGgfxrziZijwN6TwUR9Dg%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/629097eca9734ff8bddf21d765f8f009~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767107544&amp;x-signature=paGmmkvutXuAdJQZE6GCgIIgMLQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-2">源码下载与效果演示</h3>
<p>哔哩哔哩视频下方：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1ZZ7szhEdM" target="_blank" title="https://www.bilibili.com/video/BV1ZZ7szhEdM" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1ZZ…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f450a975cd54ec9b624d8b7aa233e43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767107544&amp;x-signature=1gUbbrBw5znwxvtm17vzr9%2BPbiU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-3">二、系统总体设计</h3>
<h4 data-id="heading-4">2.1 系统架构概览</h4>
<p>本系统采用典型的 <strong>“模型 + 推理接口 + GUI 前端”</strong> 架构，整体流程如下：</p>
<pre><code class="hljs language-markdown" lang="markdown">输入源（图片 / 视频 / 摄像头）
<span class="hljs-code">        ↓
YOLOv8 目标检测模型
        ↓
检测结果解析（边框、类别、置信度）
        ↓
PyQt5 图形界面实时显示与结果保存
</span></code></pre>
<h4 data-id="heading-5">2.2 功能模块划分</h4>
<p>系统主要包含以下功能模块：</p>
<ul>
<li>
<p><strong>输入模块</strong></p>
<ul>
<li>单张图片检测</li>
<li>文件夹批量检测</li>
<li>视频文件检测</li>
<li>摄像头实时检测</li>
</ul>
</li>
<li>
<p><strong>模型推理模块</strong></p>
<ul>
<li>YOLOv8 权重加载</li>
<li>GPU / CPU 自动适配</li>
<li>置信度阈值可配置</li>
</ul>
</li>
<li>
<p><strong>结果展示模块</strong></p>
<ul>
<li>实时绘制检测框</li>
<li>类别与置信度标注</li>
<li>检测结果保存</li>
</ul>
</li>
<li>
<p><strong>训练支持模块</strong></p>
<ul>
<li>数据集结构说明</li>
<li>YOLOv8 训练命令</li>
<li>模型评估指标输出</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-6">三、YOLOv8 模型原理简析</h3>
<h4 data-id="heading-7">3.1 YOLOv8 技术特点</h4>
<p>YOLOv8 是 Ultralytics 于 2023 年发布的新一代 YOLO 模型，相较于 YOLOv5 / YOLOv7，在工程实践中具有以下优势：</p>
<ul>
<li><strong>Anchor-Free 设计</strong></li>
<li><strong>更高的检测精度</strong></li>
<li><strong>更快的推理速度</strong></li>
<li><strong>原生支持多任务（检测 / 分割 / 姿态）</strong></li>
<li><strong>模型结构更清晰，便于二次开发</strong></li>
</ul>
<p>本项目使用 YOLOv8 的 <strong>Detection（目标检测）分支</strong>，仅关注车牌区域的定位问题。</p>
<hr/>
<h4 data-id="heading-8">3.2 网络结构说明（简要）</h4>
<p>YOLOv8 网络主要由三部分构成：</p>
<ol>
<li>
<p><strong>Backbone</strong></p>
<ul>
<li>提取多尺度特征</li>
<li>使用 C2f 等轻量化模块</li>
</ul>
</li>
<li>
<p><strong>Neck</strong></p>
<ul>
<li>FPN + PAN 结构</li>
<li>融合不同层级特征</li>
</ul>
</li>
<li>
<p><strong>Head</strong></p>
<ul>
<li>Anchor-Free 检测头</li>
<li>直接预测中心点、宽高与类别</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-9">四、数据集构建与格式规范</h3>
<h4 data-id="heading-10">4.1 数据集组织结构</h4>
<p>采用标准 YOLO 格式组织数据：</p>
<pre><code class="hljs language-text" lang="text">dataset/
├── images/
│   ├── train/
│   └── val/
├── labels/
│   ├── train/
│   └── val/
</code></pre>
<h4 data-id="heading-11">4.2 标签格式说明</h4>
<p>每张图像对应一个 <code>.txt</code> 标签文件，格式如下：</p>
<pre><code class="hljs language-text" lang="text">class_id x_center y_center width height
</code></pre>
<p>其中坐标全部为 <strong>归一化数值（0~1）</strong>。</p>
<p>示例：</p>
<pre><code class="hljs language-text" lang="text">0 0.5123 0.3784 0.4012 0.1856
</code></pre>
<blockquote>
<p>本项目仅设置一个类别：<code>license_plate</code></p>
</blockquote>
<hr/>
<h3 data-id="heading-12">五、模型训练流程详解</h3>
<h4 data-id="heading-13">5.1 环境准备</h4>
<pre><code class="hljs language-bash" lang="bash">pip install ultralytics
</code></pre>
<p>确认 GPU 环境（可选）：</p>
<pre><code class="hljs language-bash" lang="bash">nvidia-smi
</code></pre>
<hr/>
<h4 data-id="heading-14">5.2 训练配置文件</h4>
<p><code>data.yaml</code> 示例：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">path:</span> <span class="hljs-string">dataset</span>
<span class="hljs-attr">train:</span> <span class="hljs-string">images/train</span>
<span class="hljs-attr">val:</span> <span class="hljs-string">images/val</span>

<span class="hljs-attr">names:</span>
  <span class="hljs-attr">0:</span> <span class="hljs-string">license_plate</span>
</code></pre>
<hr/>
<h4 data-id="heading-15">5.3 启动训练</h4>
<pre><code class="hljs language-bash" lang="bash">yolo detect train \
data=data.yaml \
model=yolov8n.pt \
epochs=100 \
batch=16 \
imgsz=640
</code></pre>
<p>训练完成后，将在 <code>runs/detect/train</code> 目录生成：</p>
<ul>
<li><code>weights/best.pt</code></li>
<li><code>results.png</code></li>
<li><code>confusion_matrix.png</code></li>
</ul>
<hr/>
<h4 data-id="heading-16">5.4 模型评估指标</h4>
<p>重点关注以下指标：</p>
<ul>
<li><strong>Precision</strong></li>
<li><strong>Recall</strong></li>
<li><strong>mAP@0.5</strong></li>
<li><strong>mAP@0.5:0.95</strong></li>
</ul>
<p>在车牌检测任务中，若 mAP@0.5 达到 <strong>90% 以上</strong>，即可满足大多数工程需求。</p>
<hr/>
<h3 data-id="heading-17">六、模型推理与结果解析</h3>
<h4 data-id="heading-18">6.1 Python 推理示例</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> ultralytics <span class="hljs-keyword">import</span> YOLO

model = YOLO(<span class="hljs-string">"best.pt"</span>)
results = model(<span class="hljs-string">"test.jpg"</span>, conf=<span class="hljs-number">0.25</span>, save=<span class="hljs-literal">True</span>)
</code></pre>
<h4 data-id="heading-19">6.2 推理结果内容</h4>
<p>每个 <code>results</code> 对象包含：</p>
<ul>
<li>边框坐标（xyxy）</li>
<li>类别 ID</li>
<li>置信度</li>
<li>原始图像路径</li>
<li>保存结果路径</li>
</ul>
<hr/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24020b32225c4d1db3ccdb8a1c214ed7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767107544&amp;x-signature=BcYIf5VhlXtHSYuyrOrH9oRg4Tc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-20">七、PyQt5 图形界面设计与实现</h3>
<h4 data-id="heading-21">7.1 界面设计目标</h4>
<ul>
<li>零命令行操作</li>
<li>所见即所得</li>
<li>支持实时检测</li>
<li>支持结果保存</li>
</ul>
<h4 data-id="heading-22">7.2 核心界面功能</h4>
<ul>
<li>文件选择按钮</li>
<li>视频/摄像头切换</li>
<li>置信度调节</li>
<li>检测结果显示区域</li>
</ul>
<h4 data-id="heading-23">7.3 实时检测流程</h4>
<ol>
<li>获取图像帧</li>
<li>调用 YOLOv8 推理</li>
<li>绘制检测框</li>
<li>显示到 GUI 界面</li>
</ol>
<hr/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0c0fb6e34994fbf98d0be27708cd87c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767107544&amp;x-signature=YjNEwLicpJ8dIN1XDGDk82JxDY4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-24">八、系统运行与部署方式</h3>
<h4 data-id="heading-25">8.1 直接运行（推荐）</h4>
<pre><code class="hljs language-bash" lang="bash">python main.py
</code></pre>
<p>项目已集成：</p>
<ul>
<li>训练完成权重</li>
<li>推理逻辑</li>
<li>UI 界面</li>
</ul>
<p>无需再次训练即可使用。</p>
<hr/>
<h4 data-id="heading-26">8.2 二次开发方向</h4>
<ul>
<li>接入 <strong>OCR 模块</strong> 实现车牌字符识别</li>
<li>多目标联合检测（车辆 + 行人 + 车牌）</li>
<li>导出 ONNX / TensorRT</li>
<li>部署至 Jetson / 边缘设备</li>
</ul>
<hr/>
<h3 data-id="heading-27">九、工程应用价值分析</h3>
<p>本项目具备以下实际价值：</p>
<ul>
<li>✔ 适合作为 <strong>课程设计 / 毕设项目</strong></li>
<li>✔ 适合学习 YOLOv8 工程化落地</li>
<li>✔ 可直接扩展为完整车牌识别系统</li>
<li>✔ 界面友好，适合非算法人员使用</li>
</ul>
<hr/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f1f20db5b084ddcb347a8245e01d82f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767107544&amp;x-signature=IQWpNbBNV4CIY6itZIVkjZJyOZU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-28">十、总结</h3>
<p>本文完整介绍了一个 <strong>基于 YOLOv8 的车牌位置检测系统</strong>，从模型原理、数据准备、训练评估到 PyQt5 可视化部署，构建了一套<strong>可复现、可运行、可扩展的工程方案</strong>。</p>
<p>如果你希望：</p>
<ul>
<li>快速掌握 YOLOv8 实战</li>
<li>构建真实可用的检测系统</li>
<li>为毕设或项目准备高质量工程</li>
</ul>
<p>那么该方案将是一个非常理想的参考起点。</p>
<blockquote>
<p>如果本文对你有所帮助，欢迎点赞、收藏与交流 🚀</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[智谱年末王炸：GLM-4.7开源，这可能是给程序员最好的圣诞礼物]]></title>    <link>https://juejin.cn/post/7586973107322437672</link>    <guid>https://juejin.cn/post/7586973107322437672</guid>    <pubDate>2025-12-23T15:38:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586973107322437672" data-draft-id="7586910902285713460" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="智谱年末王炸：GLM-4.7开源，这可能是给程序员最好的圣诞礼物"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-12-23T15:38:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            智谱年末王炸：GLM-4.7开源，这可能是给程序员最好的圣诞礼物
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T15:38:56.000Z" title="Tue Dec 23 2025 15:38:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>2025年的年底，本以为AI圈的大战会随着节日季的到来暂时偃旗息鼓，没想到智谱AI在这个节点扔下了一枚重磅炸弹。</p>
<p>就在12月23日，他们正式发布并开源了GLM-4.7。这不仅仅是一次常规的版本号迭代，更像是一次针对开发者痛点的精准爆破。如果你还在为开源模型写不出能跑的代码而头疼，或者还在心疼闭源API高昂的账单，那么GLM-4.7可能正是你在等的那个破局者。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2Fgdfhtghfgj-1024x439.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/gdfhtghfgj-1024x439.webp" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef457956cacc432da8bc4e17becd91b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767109136&amp;x-signature=n%2FsNQs48V%2FVTkAoFL2PIGcFmEC4%3D" alt="gdfhtghfgj" loading="lazy"/></a></p>
<p><strong>这不是参数堆砌，是实打实的“智力”升级</strong></p>
<p>先说最直观的感受。过去我们用开源模型写代码，往往是“一看顿悟，一跑报错”。但这次GLM-4.7在编程能力的提升上有点吓人。</p>
<p>看看硬指标。在目前公认最难啃的SWE-bench Verified榜单上，GLM-4.7拿下了73.8%的成绩。这是什么概念？这是目前开源模型的最高纪录（SOTA），比上一代GLM-4.6提升了整整5.8个百分点。</p>
<p>更更有意思的是LiveCodeBench v6这个榜单，它考察的是模型面对最新编程难题的反应。GLM-4.7跑出了84.9%的分数。在这个维度上，它甚至把闭源的优等生Claude Sonnet 4.5甩在了身后。这意味着，在处理那些教科书里找不到答案的新鲜代码问题时，这个开源模型可能比你花钱买的服务还要灵光。</p>
<p><strong>它学会了像资深工程师那样“思考”</strong></p>
<p>为什么这次提升这么大？扒开技术白皮书，你会发现智谱这次没在堆算力上死磕，而是在“思考机制”上动了脑筋。</p>
<p>GLM-4.7引入了一套很像人类工程师的思维模式。</p>
<p>首先是“交错式思考”。以前的模型是闷头干活，现在的GLM-4.7在调用工具或者敲代码之前，会先停下来琢磨一下逻辑，每拿到一个中间结果，还会再次校准方向。这种走一步看一步的稳健策略，直接治好了模型容易“一条道走到黑”的毛病。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2Fgregdfhgdf-1024x723.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/gregdfhgdf-1024x723.webp" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae913b73a4044e68961c08d8a0743653~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767109136&amp;x-signature=P%2Bgr891a0jU5Wrd1lvzvIwdk188%3D" alt="gregdfhgdf" loading="lazy"/></a></p>
<p>其次是“保留式思考”。这简直是为长对话量身定制的。当你和模型进行多轮Debug时，它不会像金鱼一样只有七秒记忆。它会自动把之前的推理过程打包缓存起来。这不仅让对话更连贯，还能帮你省下大量的Token费用，毕竟不用每次都从头盘逻辑了。</p>
<p>还有一个很人性化的“轮级思考”开关。处理简单问题时，关掉深度思考，秒回；遇到复杂架构设计，开启深度模式，虽然慢点但质量高。这种把控制权交给用户的设计，确实很懂行。</p>
<p><strong>从后端到前端，审美终于在线了</strong></p>
<p>除了写逻辑代码，GLM-4.7在“面子工程”上也下了功夫。</p>
<p>很多后端出身的开发者应该都有过被模型生成的“直男审美”HTML丑哭的经历。这次GLM-4.7生成的UI代码，据测试已经非常有现代感了，组件层级清晰，配色合理。甚至在生成PPT这种视觉物料时，它对16:9宽屏的适配率从以前勉强及格的52%直接飙升到了91%。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2Fwfasdfsdf-1017x1024.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/wfasdfsdf-1017x1024.webp" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ae82b337c5b4bd590c8e7ae2e644da2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767109136&amp;x-signature=n26dxd%2FbESiXCECdz%2FpyPhM6F8k%3D" alt="wfasdfsdf" loading="lazy"/></a></p>
<p>官方甚至演示了它从零开始手搓一个《植物大战僵尸》风格的网页游戏，或者1:1复刻iOS主界面。这说明它不仅懂代码，还懂产品，具备了从需求理解到完整交付的端到端能力。</p>
<p><strong>开源，才是最大的诚意</strong></p>
<p>在这个闭源模型越来越封闭的2025年，智谱选择把这样一个358B参数量（MoE架构）的旗舰模型直接开源，确实需要魄力。</p>
<p>目前，权重已经在Hugging Face和ModelScope上架了。如果你不想自己部署，官方API的价格也杀到了地板价，甚至推出了针对开发者的Coding Plan。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2FiShot_2025-12-23_23.30.34-1024x407.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/iShot_2025-12-23_23.30.34-1024x407.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9e6260699dd422ba5011f3080a52ef2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767109136&amp;x-signature=kjTUb0AQYG5R1gEE56LRQlQp2q8%3D" alt="iShot_2025-12-23_23.30.34" loading="lazy"/></a></p>
<p>总的来说，GLM-4.7给国产大模型在2025年画上了一个极其漂亮的句号。它证明了在代码智能体和复杂逻辑推理这些硬核领域，开源模型不仅能追平闭源巨头，甚至在某些局部战场已经实现了反超。</p>
<p>对于咱们开发者来说，不需要关心那些宏大的商业叙事，只需要知道：手里又多了一把免费且锋利的瑞士军刀。趁着热乎，赶紧去GitHub上拉下来试试吧。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Gradle 基础篇之基础知识的介绍和使用]]></title>    <link>https://juejin.cn/post/7586973107322470440</link>    <guid>https://juejin.cn/post/7586973107322470440</guid>    <pubDate>2025-12-23T15:55:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586973107322470440" data-draft-id="7565728388402151459" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Gradle 基础篇之基础知识的介绍和使用"/> <meta itemprop="keywords" content="后端,gradle"/> <meta itemprop="datePublished" content="2025-12-23T15:55:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一线大码"/> <meta itemprop="url" content="https://juejin.cn/user/3280598429340984"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Gradle 基础篇之基础知识的介绍和使用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3280598429340984/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一线大码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T15:55:05.000Z" title="Tue Dec 23 2025 15:55:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">1. 项目结构</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f97d7feaa6d44ce9dd9c791fd39b8a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA57q_5aSn56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767110104&amp;x-signature=eenouzBltNW0D1xGPbUQtyXyGYs%3D" alt="image.png" loading="lazy"/></p>
<p>目录介绍：</p>
<ol>
<li><strong>build.gradle</strong>：项目编译时要读取的配置文件，build.gradle有两个，一个是全局的，一个是在模块里面。全局的build.gradle主要设置的是声明仓库源，gradle的版本号说明等。</li>
<li><strong>gradlew</strong>：linux下的gradle环境脚本。可以执行gradle指令，比如./greadle build。</li>
<li><strong>gradlew.bat</strong>：windows下的gradle环境脚本。可以执行gradle指令。</li>
<li><strong>settings.gradle</strong>：包含一些必要设置，例如，任务或项目之间的依赖关系等，无论有多少子模块，该文件都只有一个，且在根目录中。</li>
<li><strong>gradle</strong>：包含wrapper文件夹及其两个子文件，可以自动安装gradle环境。也就是如果本地没有安装gradle环境，则可以使用这里的。</li>
</ol>
<p>Gradle-Wrapper是为了简化Gradle的安装和部署，目的是为了使任意的gradle项目都不需要单独安装环境，项目会自动识别有无gradle环境。如果在本地没有找到与gradle-wrapper.properties中版本相同的Gradle。IDEA就会自动帮你下载一个gradle环境。gradle/wrapper/gradle-wrapper.properties内容解析：</p>
<pre><code class="hljs language-properties" lang="properties">#greadistributionBase和distributionPath配合使用，指定gradle解压后的存放位置。
#GRADLE_USER_HOME表示用户目录，可以在环境变量中配置，如果未配置，则使用默认的：
    #windows系统默认是：C:\window\&lt;user-name&gt;\.gradle\
    #linux系统：$HOME/.gradle
greadistributionBase=GRADLE_USER_HOME   
distributionPath=wrapper/dists

#指定某个版本的gradle的下载地址。
distributionUrl=https://services.gradle.org/distributions/gradle-9.2.1-bin.zip
networkTimeout=10000
validateDistributionUrl=true

#zipStoreBase和zipStorePath配合使用，指定下载的gradle.zip文件的存放位置。
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21cf3d3fe13c4c5b89a1d89dd7c9a95a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA57q_5aSn56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767110104&amp;x-signature=3AW1srm3o20M%2FldoCXg8MNMt%2BIk%3D" alt="image.png" loading="lazy"/></p>
<p>这里的 <strong>包装器</strong> 指的就是使用<code>gradle-wrapper.properties</code>指定的gradle来构建项目。</p>
<p>Gradle遵循COC（约定优于配置）的理念，默认情况下提供了与Maven项目相同的项目结构配置：</p>
<pre><code class="hljs language-java" lang="java">project root
src/main/java
src/main/resource
src/test/java
src/test/resource
src/main/webapp(web工程)
</code></pre>
<h2 data-id="heading-1">2. 常用命令</h2>
<p>执行 <strong>gradle build</strong> 构建项目，会产生一个build目录，里面有打包好的jar包。</p>
<p>执行 <strong>gradle build -x test</strong> 跳过测试构建项目。</p>
<pre><code class="hljs language-bin" lang="bin">PS D:\Project\gradle-demo&gt; gradle build
Java HotSpot(TM) 64-Bit Server VM warning: Sharing is only supported for boot loader classes because bootstrap classpath has been appended

BUILD SUCCESSFUL in 12s
7 actionable tasks: 7 executed
PS D:\Project\gradle-demo&gt;
</code></pre>
<p>执行 <strong>gradle clean</strong> 命令会删除build目录。</p>
<pre><code class="hljs language-bin" lang="bin">PS D:\Project\gradle-demo&gt; gradle clean

BUILD SUCCESSFUL in 800ms
1 actionable task: 1 executed
PS D:\Project\gradle-demo&gt; 
</code></pre>
<p>执行 <strong>gradle -v</strong> 可以查看版本，用的是本地安装的gradle，配置环境变量的那个gradle。</p>
<pre><code class="hljs language-bin" lang="bin">PS D:\Project\gradle-demo&gt; gradle -v
</code></pre>
<p>执行 <strong>./gradlew -v</strong> 这里用的是项目中wrapper下的那个gradle。</p>
<pre><code class="hljs language-bin" lang="bin">PS D:\Project\rcp&gt; ./gradlew -v
</code></pre>
<p>执行 <strong>gradle -h</strong> 可以查看帮助。</p>
<pre><code class="hljs language-bin" lang="bin">PS D:\Project\gradle-demo&gt; gradle -h
</code></pre>
<h2 data-id="heading-2">3. build.gradle</h2>
<pre><code class="hljs language-java" lang="java">plugins {
    id <span class="hljs-string">'java'</span>
    id <span class="hljs-string">'org.springframework.boot'</span> version <span class="hljs-string">'4.0.0'</span>
    id <span class="hljs-string">'io.spring.dependency-management'</span> version <span class="hljs-string">'1.1.7'</span>
}

group = <span class="hljs-string">'com.example'</span>
version = <span class="hljs-string">'0.0.1-SNAPSHOT'</span>
description = <span class="hljs-string">'gradle-demo'</span>

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(<span class="hljs-number">17</span>)
    }
}

configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }
}

repositories {
    <span class="hljs-comment">//配置国内下载源</span>
    maven{
        url <span class="hljs-string">'https://maven.aliyun.com/repository/public/'</span>
    }
    mavenCentral()
}

dependencies {
    implementation <span class="hljs-string">'org.springframework.boot:spring-boot-starter-webmvc'</span>
    compileOnly <span class="hljs-string">'org.projectlombok:lombok'</span>
    developmentOnly <span class="hljs-string">'org.springframework.boot:spring-boot-devtools'</span>
    annotationProcessor <span class="hljs-string">'org.projectlombok:lombok'</span>
    testImplementation <span class="hljs-string">'org.springframework.boot:spring-boot-starter-webmvc-test'</span>
    testRuntimeOnly <span class="hljs-string">'org.junit.platform:junit-platform-launcher'</span>
}

tasks.named(<span class="hljs-string">'test'</span>) {
    useJUnitPlatform()
}
</code></pre>
<ol>
<li><strong>group、name、version</strong>：group是module所在组；name是module的名字，同一个组里name具有唯一性；version是module的版本号；group、name、version三者构成了该module的唯一性。</li>
<li><strong>apply</strong>：在module中应用一个插件。和<strong>plugins</strong>一个意思。</li>
<li><strong>dependencies</strong>：用来声明module所依赖的jar包或其他module。</li>
<li><strong>repositories</strong>：用来声明仓库，告诉程序到哪个仓库去查找对应的module、jar包等依赖。</li>
<li><strong>task</strong>：用来声明module的任务，其对应org.gradle.api.Task。</li>
</ol>
<p><strong>依赖管理</strong></p>
<p>Gradle依赖的粒度控制相较于Maven也更加精细，maven只有compile、provided、test、runtime四种scope，而gradle有以下几种scope：</p>
<ol>
<li><strong>implementation</strong>：默认的scope。implementation的作用域会让依赖在编译和运行时均包含在内，但是不会暴露在类库使用者的编译时。举例，如果我们的类库包含了gson，那么其他人使用我们的类库时，编译时不会出现gson的依赖。</li>
<li><strong>api</strong>：和implementation类似，都是编译和运行时都可见的依赖。但是api允许我们将自己类库的依赖暴露给我们类库的使用者。</li>
<li><strong>compileOnly</strong>和<strong>runtimeOnly</strong>：这两种顾名思义，一种只在编译时可见，一种只在运行时可见，而runtimeOnly和Maven的provided比较接近。</li>
<li><strong>testImplementation</strong>：这种依赖在测试编译时和运行时可见，类似于Maven的test作用域。</li>
<li><strong>testCompileOnly</strong>和<strong>testRuntimeOnly</strong>：这两种类似于compileOnly和runtimeOnly，但是作用于测试编译时和运行时。</li>
<li><strong>annotationProcessor</strong>：用来声明“只在编译期运行的注解处理器依赖”，不会进入运行时。Java在编译阶段可以运行一类特殊的程序，叫注解处理器，用来：扫描源码中的注解、生成新代码（.java 文件）或在编译期做校验、直接报错。Gradle用annotationProcessor来告诉编译器：这些依赖，是给“编译器”用的，不是给程序运行用的。</li>
</ol>
<p>通过简短精悍的依赖配置和多种多样的作用与选择，Gradle可以为我们提供比Maven更加优秀的依赖管理功能。</p>
<h2 data-id="heading-3">4. Groovy 语法</h2>
<p>Groovy是一种基于JVM的动态语言，语法和Java相似，最终也是要编译.class文件在JVM上运行。Groovy完全兼容Java，在此基础上添加了很多动态类型和灵活特性，比如支持闭包，支持DSL（领域特定语言），是一门非常灵活的动态脚本语言。</p>
<p>要执行Groovy的脚本，必须安装Groovy环境，或者使用Java的ClassLoader来调用。</p>
<h3 data-id="heading-4">4.1. 变量、方法、类</h3>
<p>1、Groovy中使用<code>def</code>关键字来定义变量，可以不指定变量类型，默认访问修饰符是<code>public</code>。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">def</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
def <span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
<span class="hljs-type">def</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-string">"hello world!"</span>;
</code></pre>
<p>2、方法使用返回类型或<code>def</code>关键字定义，方法可以接收任意数量的参数，这些参数可以不申明类型，如果不提供可见性修饰符，则该方法为<code>public</code>。如果指定了方法返回类型，可以不需要<code>def</code>关键字来定义方法。如果不使用<code>return</code>，则方法的返回值为最后一行代码的执行结果。</p>
<pre><code class="hljs language-java" lang="java">def <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span>{
    println a + b
}

<span class="hljs-type">int</span> <span class="hljs-title function_">minus</span><span class="hljs-params">(a, b)</span>{
    <span class="hljs-keyword">return</span> a - b
}

<span class="hljs-type">int</span> <span class="hljs-title function_">minus</span><span class="hljs-params">(a, b)</span>{
    a - b
}
</code></pre>
<p>省略：</p>
<ul>
<li>语句后面的分号可以省略。</li>
<li>方法的括号可以省略。</li>
<li>参数类型可以省略。</li>
<li><code>return</code>可以省略。</li>
</ul>
<p>3、Groovy类非常类似Java类。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">def</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>()
    p.increaseAge <span class="hljs-number">5</span>
    println p.age

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>{
    String name
    <span class="hljs-type">integer</span> <span class="hljs-variable">age</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>
    def <span class="hljs-title function_">increaseAge</span><span class="hljs-params">(Integer years)</span>{
        <span class="hljs-built_in">this</span>.age += years
    }
}
</code></pre>
<p>区别：</p>
<ul>
<li>默认类的修饰符为public。</li>
<li>没有可见性修饰符的字段会自动生成对应的setter和getter方法。</li>
<li>类不需要与它的源文件有相同的名称，但还是建议采用相同的名称。</li>
</ul>
<h3 data-id="heading-5">4.2. for、switch</h3>
<p>1、Groovy支持Java的for(int i=0; i&lt;N; i++)形式的循环语句，另外还支持for in loop形式，支持遍历范围、列表、Map、数组和字符串等多种类型。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//遍历范围</span>
<span class="hljs-type">def</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
<span class="hljs-keyword">for</span>(i in <span class="hljs-number">0.</span><span class="hljs-number">.3</span>){
    x += i
}
<span class="hljs-keyword">assert</span> x == <span class="hljs-number">6</span>
<span class="hljs-comment">//遍历列表</span>
<span class="hljs-type">def</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
<span class="hljs-keyword">for</span>(i in [<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>]){
    x += i
}
<span class="hljs-keyword">assert</span> x == <span class="hljs-number">6</span>
<span class="hljs-comment">//遍历Map中的值</span>
<span class="hljs-type">def</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> [<span class="hljs-string">'a'</span>:<span class="hljs-number">1</span>, <span class="hljs-string">'b'</span>:<span class="hljs-number">2</span>, <span class="hljs-string">'c'</span>:<span class="hljs-number">3</span>]
x = <span class="hljs-number">0</span>
<span class="hljs-keyword">for</span>(v in map.values()){
    x += v
}
<span class="hljs-keyword">assert</span> x == <span class="hljs-number">6</span>
</code></pre>
<p>2、Groovy中的switch语句不仅兼容Java代码，还可以处理更多的case表达式。case表达式可以是字符串、列表、范围、Integer等等。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">def</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> <span class="hljs-number">16</span>
<span class="hljs-type">def</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-string">""</span>

<span class="hljs-keyword">switch</span>(x){
    <span class="hljs-keyword">case</span> <span class="hljs-string">"ok"</span>:
        result = <span class="hljs-string">"found ok"</span>
    <span class="hljs-keyword">case</span> [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-string">'list'</span>]:
        result = <span class="hljs-string">"list"</span>
        <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">case</span> <span class="hljs-number">10.</span><span class="hljs-number">.19</span>:
        result = <span class="hljs-string">"range"</span>
        <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">case</span> Integer:
        result = <span class="hljs-string">"integer"</span>
        <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">default</span>:
        result = <span class="hljs-string">"default"</span>
}
<span class="hljs-keyword">assert</span> result == <span class="hljs-string">"range"</span>
</code></pre>
<h3 data-id="heading-6">4.3. 数据类型</h3>
<p>Groovy中的数据类型主要有以下几种：</p>
<ul>
<li>Java中的基本数据类型。</li>
<li>Groovy中的容器类。</li>
<li>闭包</li>
</ul>
<h4 data-id="heading-7">4.3.1. 字符串</h4>
<p>在Groovy中有两种字符串类型，普通字符串String(java.lang.String)和插值字符串GString(groovy.lang.GString)。</p>
<p>在Groovy中单引号字符串和双引号字符串都可以定义一个字符串常量，只不过单引号字符串不支持插值。</p>
<p>双引号字符串可以支持插值，插值指的是替换字符串中的占位符，占位符表达式是<code>${}</code>或者以<code>$</code>为前缀。</p>
<p>三引号字符串了可以保留文本的换行和缩进符，不支持插值。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">def</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">'我是chian人'</span>
println <span class="hljs-string">"hello ${name}"</span>
println <span class="hljs-string">"hello $name"</span>

<span class="hljs-type">def</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> <span class="hljs-string">''</span><span class="hljs-string">'中国人和美国人
    一起吃火锅
    好不好？'</span><span class="hljs-string">''</span>
</code></pre>
<p>String是不可变的，GString是可变的，GString和String即使有相同的字面量，它们的hashCode也可能不同，因此应该避免使用GString作为Map的Key。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//当双引号字符串中包含插值表达式时，字符串类型为GString。下面断言为true</span>
<span class="hljs-keyword">assert</span> <span class="hljs-string">"one: ${1}"</span>.hashCode() != <span class="hljs-string">"one: 1"</span>.hashCode
</code></pre>
<h4 data-id="heading-8">4.3.2. List</h4>
<p>Groovy在Java集合的基础上进行了增强和简化，Groovy的List对应Java中的List接口，默认的实现类为Java中的ArrayList。可以使用as操作符显式指定List的实现类为java.util.LinkedList。使用<code>[]</code>获取List中具有正索引或负索引的元素。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">def</span> <span class="hljs-variable">number</span> <span class="hljs-operator">=</span> [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]
<span class="hljs-keyword">assert</span> number <span class="hljs-keyword">instanceof</span> List
<span class="hljs-type">def</span> <span class="hljs-variable">linkedList</span> <span class="hljs-operator">=</span> [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>] as LinkedList
<span class="hljs-keyword">assert</span> linkedList <span class="hljs-keyword">instanceof</span> java.util.LinkedList

<span class="hljs-type">def</span> <span class="hljs-variable">number</span> <span class="hljs-operator">=</span> [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]
<span class="hljs-keyword">assert</span> number[<span class="hljs-number">1</span>] == <span class="hljs-number">2</span>
<span class="hljs-comment">//-1表示列表末尾的第一个元素</span>
<span class="hljs-keyword">assert</span> number[-<span class="hljs-number">1</span>] == <span class="hljs-number">4</span>
<span class="hljs-comment">//在列表末尾追加一个元素5</span>
number &lt;&lt; <span class="hljs-number">5</span>
<span class="hljs-keyword">assert</span> number[<span class="hljs-number">4</span>] == <span class="hljs-number">5</span>
<span class="hljs-keyword">assert</span> number[-<span class="hljs-number">1</span>] ==<span class="hljs-number">5</span>
</code></pre>
<h4 data-id="heading-9">4.3.3. Map</h4>
<p>Groovy中创建Map同样使用<code>[]</code>，需要同时指定键和值，默认的实现为java.util.LinkedHashMap。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">def</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> [one: <span class="hljs-string">'aaa'</span>, tow: <span class="hljs-string">"bbb"</span>, three: <span class="hljs-string">"ccc"</span>]
<span class="hljs-keyword">assert</span> name[<span class="hljs-string">'one'</span>] == <span class="hljs-string">'aaa'</span>
<span class="hljs-keyword">assert</span> name.two == <span class="hljs-string">'bbb'</span>
</code></pre>
<p>Map中的键关联问题：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">def</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">'name'</span>
<span class="hljs-comment">//使用字符串key作为键</span>
<span class="hljs-type">def</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> [key: <span class="hljs-string">'张三'</span>]
<span class="hljs-keyword">assert</span> person.containKey(<span class="hljs-string">'key'</span>)
<span class="hljs-comment">//使用变量key作为键</span>
person = [(key): <span class="hljs-string">'李四'</span>]
<span class="hljs-keyword">assert</span> person.contailsKey(<span class="hljs-string">'name'</span>)
</code></pre>
<h3 data-id="heading-10">4.4. 闭包</h3>
<p>Groovy中的闭包是一个开放的、匿名的、可以接受参数和返回值的代码块。</p>
<p>定义闭包</p>
<pre><code class="hljs language-java" lang="java">{ [closureParameters -&gt; ] statements }
</code></pre>
<p>闭包分为两个部分，分别是参数列表部分<code>[closureParameters -&gt; ]</code>和语句部分<code>statements</code>。</p>
<p>参数列表部分是可选的，如果闭包只有一个参数，则参数名是可选的，Groovy会隐式指定it作为参数名。</p>
<pre><code class="hljs language-java" lang="java">{ println it} <span class="hljs-comment">//使用隐式参数it的闭包</span>
</code></pre>
<p>当需要指定参数列表时，需要<code>-&gt;</code>将参数列表和闭包体分离。</p>
<pre><code class="hljs language-java" lang="java">{ it -&gt; println it}
 
{ String a, String b -&gt;
    println <span class="hljs-string">"${a} is ${b}"</span>
}
</code></pre>
<p>闭包是groovy.lang.Cloush类的一个实例。这使得闭包可以赋值给变量或字段。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//将闭包赋值给一个变量</span>
<span class="hljs-type">def</span> <span class="hljs-variable">println</span> <span class="hljs-operator">=</span> {it -&gt; println it}
<span class="hljs-keyword">assert</span> println <span class="hljs-keyword">instanceof</span> Closure

<span class="hljs-comment">//将闭包赋值给Closuer类型变量</span>
<span class="hljs-type">Closuer</span> <span class="hljs-variable">do</span> <span class="hljs-operator">=</span> { println <span class="hljs-string">'do!'</span>}
</code></pre>
<p>调用闭包</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">def</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> {<span class="hljs-number">123</span>}
<span class="hljs-keyword">assert</span> <span class="hljs-title function_">code</span><span class="hljs-params">()</span> == <span class="hljs-number">123</span> <span class="hljs-comment">//闭包当做方法调用</span>
<span class="hljs-keyword">assert</span> code.call() == <span class="hljs-number">123</span> <span class="hljs-comment">//显式调用call方法</span>
<span class="hljs-type">def</span> <span class="hljs-variable">isOddNumber</span> <span class="hljs-operator">=</span> { <span class="hljs-type">int</span> i -&gt; i%<span class="hljs-number">2</span> != <span class="hljs-number">0</span>}
<span class="hljs-keyword">assert</span> <span class="hljs-title function_">isOddNumber</span><span class="hljs-params">(<span class="hljs-number">3</span>)</span> == <span class="hljs-literal">true</span> <span class="hljs-comment">//调用带参数的闭包</span>
</code></pre>
<p>闭包作为方法参数</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//无参数闭包</span>
def <span class="hljs-title function_">test1</span><span class="hljs-params">(Closure closure)</span>{
    println <span class="hljs-string">"test1 start..."</span>
    closuer(); <span class="hljs-comment">//调用闭包</span>
    println <span class="hljs-string">"test1 end..."</span>
}

test1{prinln <span class="hljs-string">"hahaha"</span>}

<span class="hljs-comment">//有参数闭包</span>
def <span class="hljs-title function_">test2</span><span class="hljs-params">(Closuer closure)</span>{
    <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;
    <span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">200</span>;
    println <span class="hljs-string">"test2 starte"</span>
    closure(a,b);<span class="hljs-comment">//调用闭包</span>
    println <span class="hljs-string">"test2 end"</span>
}

test2 { x,y -&gt;{
    println(<span class="hljs-string">"x:"</span> + x)
    println(<span class="hljs-string">"y:"</span> + y)
  }
}
</code></pre>
<h2 data-id="heading-11">5. 构建过程</h2>
<p>任何由Gradle构建的项目都遵循这个过程，分为三个阶段：</p>
<ul>
<li>Initialization：初始化阶段。按顺序执行init.gradle -&gt; settings.gradle脚本，生成Gradle、Setting、Project对象。</li>
<li>Configuration：编译阶段，也叫配置阶段。按顺序执行root目录下的build.gradle -&gt; 子项目build.gradle脚本，生成Task执行流程图。</li>
<li>Execution：执行阶段。按照Task执行图顺序运行每一个Task，完成一个个步骤，生成最终的APK文件或JAR包文件。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea6f6e3d27244808b6d4709b871c2483~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA57q_5aSn56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767110104&amp;x-signature=EffZqg6fTZY2BcN11zNUsYIl9dQ%3D" alt="ce424e1e61b7a6015f9b24f1b82aa56f_c92c66c5d6c748a48a1ae8de632a0903.png" loading="lazy"/></p>
<p>整个构建过程，官方在一些节点都设置有hook钩子函数，以便我们在构建过程中添加自己的逻辑。影响构建过程。hook钩子函数可以理解为监听函数，另外也可以设置Linsener监听函数。</p>
<h3 data-id="heading-12">5.1. Task</h3>
<p>Task是Gradle执行的基本单元。Gradle构建项目是先把所有<code>.gradle</code>脚本都执行一遍，编译生成对应的Gradle、Setting、Project对象。然后根据配置，生成一张Task组成的<code>有向无环图</code>。</p>
<p>最终Gradle会按照图上一个个Task的关联按顺序挨个执行。每个Task都完成一个特定功能，所有Task都执行一遍，则整个项目的构建任务就完成了。</p>
<p><strong>创建Task</strong></p>
<pre><code class="hljs language-java" lang="java">task hello{
    println <span class="hljs-string">"hello world"</span>
}
task (hello2){
    println <span class="hljs-string">"hello world2"</span>
}
task (<span class="hljs-string">'hello3'</span>){
    println <span class="hljs-string">"hello world3"</span>
}
task (<span class="hljs-string">"hello4"</span>){
    println <span class="hljs-string">"hello world4"</span>
}
</code></pre>
<p><strong>Task的Action</strong></p>
<p>Task内部的Action不是唯一的，而是一个集合，可以往里面添加各种 Action，看下面Task中的声明：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//在Action队列头部添加action</span>
Task.doFirst(Action&lt;? supper Task&gt; action);
Task.doFirst(Closure action);
<span class="hljs-comment">//在Action队列头部添加action</span>
Task.doLast(Action&lt;? supper Task&gt; action);
Task.doLast(Closure action);

<span class="hljs-comment">//删除所有的action</span>
Task <span class="hljs-title function_">deleteAllAction</span><span class="hljs-params">()</span>;
</code></pre>
<p>doFirst和doLast接受的都是闭包。</p>
<ul>
<li>doFirst添加的action最先执行。</li>
<li>task自身的action在中间执行，无法在task外部添加，需要在自定义task时写。</li>
<li>doLast添加的action最后执行。</li>
</ul>
<pre><code class="hljs language-java" lang="java">task speak{
    println(<span class="hljs-string">"This is AA! -- 配置阶段"</span>)
    doFirst{
        println(<span class="hljs-string">"This is doFirst -- inner -- 执行阶段"</span>)
    }
    doLast{
        println(<span class="hljs-string">"This is doLast -- inner -- 执行阶段"</span>)
    }
}

speak.doFirst{
    println(<span class="hljs-string">"This is doFirst -- outer -- 执行阶段"</span>)
}

speak.doLast{
    println(<span class="hljs-string">"This is doLast -- outer -- 执行阶段"</span>)
}

</code></pre>
<p>执行任务：</p>
<pre><code class="hljs language-java" lang="java">gradle speak
</code></pre>
<p>执行结果：</p>
<pre><code class="hljs language-java" lang="java">&gt; Configure project :
This is AA! -- 配置阶段

&gt; Task :speak
This is doFirst -- outer -- 执行阶段
This is doFirst -- inner -- 执行阶段
This is doLast -- inner -- ִ执行阶段
This is doLast -- outer -- ִ执行阶段
</code></pre>
<p><strong>Task依赖</strong></p>
<p>Task依赖是指可以在Task之间指定执行顺序，重点理解dependsOn。</p>
<ul>
<li>A.dependsOn B --&gt; 执行A的时候先执行B</li>
<li>A.mustRunAfter B --&gt; 同时执行A和B，需要先执行B再执行A。若执行关系不成立则报错。</li>
<li>A.shouldRunAfter B --&gt; 同mustRunAfter，区别：执行关系不成立但是不报错。</li>
</ul>
<pre><code class="hljs language-java" lang="java">task s1{
    doLast{
            println(<span class="hljs-string">"This is s1"</span>)
    }
}
task s2{
    doLast{
            println(<span class="hljs-string">"This is s2"</span>)
    }
}
s1.dependOn s2
</code></pre>
<p>或者</p>
<pre><code class="hljs language-java" lang="java">task s1{
    doLast{
            println(<span class="hljs-string">"This is s1"</span>)
    }
}
task s2{
    dependOn s1
    doLast{
            println(<span class="hljs-string">"This is s2"</span>)
    }
}
</code></pre>
<p><strong>自定义Task</strong></p>
<p>Gradle中的Task都继承自<code>org.gradle.api.DefaultTask</code>，自定义Task也需要继承这个类，自己写方法，然后加上@TaskAction注解，表示这个方法是Task中的action。可以加多个，按倒序执行。</p>
<p>自定义任务：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTask</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DefaultTask</span>{
    <span class="hljs-meta">@TaskAction</span>
    def <span class="hljs-title function_">ss1</span><span class="hljs-params">()</span>{
        println(<span class="hljs-string">"This is MyTask action1"</span>)
    }
    <span class="hljs-meta">@TaskAction</span>
    def <span class="hljs-title function_">ss2</span><span class="hljs-params">()</span>{
        println(<span class="hljs-string">"This is MyTask action2"</span>)
    }
}

tasks.register(<span class="hljs-string">'speak'</span>, MyTask) {
    println(<span class="hljs-string">"This is AA"</span>)
    doFirst {
        println(<span class="hljs-string">"This is doFirst"</span>)
    }
    doLast {
        println(<span class="hljs-string">"This is doLast"</span>)
    }
}
</code></pre>
<p>执行结果：</p>
<pre><code class="hljs language-java" lang="java">PS D:\Project\gradle-demo&gt; gradle speak
This is AA

&gt; Task :speak
This is doFirst
This is MyTask action2
This is MyTask action1
This is doLast
</code></pre>
<p><strong>系统自带Task</strong></p>
<p>Gradle提供了很多task给我们使用，比如copy、delete等。</p>
<p><strong>设置默认Task</strong></p>
<p>意思是脚本中我们不调用该Task，设置的默认Task也会执行。</p>
<pre><code class="hljs language-java" lang="java">defaultTasks <span class="hljs-string">'aaa'</span>, <span class="hljs-string">'bbb'</span>

tasks.register(<span class="hljs-string">'aaa'</span>) {
    doLast {
        println(<span class="hljs-string">"Default aaa task"</span>)
    }
}
tasks.register(<span class="hljs-string">'bbb'</span>) {
    doLast {
        println(<span class="hljs-string">"Default bbb task"</span>)
    }
}
tasks.register(<span class="hljs-string">'other'</span>) {
    doLast {
        println(<span class="hljs-string">"not a default task"</span>)
    }
}
</code></pre>
<p>执行结果</p>
<pre><code class="hljs language-java" lang="java">PS D:\Project\gradle-demo&gt; gradle -q
Default aaa task
Default bbb task
PS D:\Project\gradle-demo&gt; 
</code></pre>
<h3 data-id="heading-13">5.2. Plugin</h3>
<p><strong>什么是插件</strong></p>
<p>插件只是一组任务，几乎所有的任务，如编译任务，设置域对象，设置源文件等都由插件处理。</p>
<p>Gradle本身只是提供了基本的核心功能，其他特性比如编译Java源码等能力都需要通过插件实现。</p>
<p><strong>应用插件</strong></p>
<p>两种方式：</p>
<pre><code class="hljs language-java" lang="java">plugins {
    id <span class="hljs-string">'java'</span>
}
</code></pre>
<p>或者</p>
<pre><code class="hljs language-java" lang="java">apply plugin: <span class="hljs-string">'java'</span>
</code></pre>
<p>插件都有自己的短名称，上述两种写法都使用了短名称去应用JavaPlugin。我们还可以用完全的名称：</p>
<pre><code class="hljs language-java" lang="java">apply plugin: org.gradle.api.plugins.JavaPlugin
</code></pre>
<p>由于Gradle的默认导入，还可以这样写：</p>
<pre><code class="hljs language-java" lang="java">apply plugin: JavaPlugin
</code></pre>
<p>插件的应用是幂等的，如果一个插件已经被应用，再次应用不会有任何效果。</p>
<p>一个插件是任何实现了Plugin接口的类，Gradle提供了核心插件作为其发行包的一部分，所以核心插件可以像上述方式一样简单应用，但是对于第三方插件，需要进行配置使插件在构建路径中可用。</p>
<p>核心插件：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.gradle.org%2Fcurrent%2Fuserguide%2Fplugin_reference.html" target="_blank" title="https://docs.gradle.org/current/userguide/plugin_reference.html" ref="nofollow noopener noreferrer">docs.gradle.org/current/use…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c316c828ada4cd9a70a15b9c0f4e4b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA57q_5aSn56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767110104&amp;x-signature=nfylJ1JSyL7HBStv9J6%2F6FL2V9M%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5fe0755ecd2b4df2896858de301abcff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA57q_5aSn56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767110104&amp;x-signature=7v5JzrbqbKMPIagncFlkbrZQUI4%3D" alt="image.png" loading="lazy"/></p>
<p>第三方插件：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplugins.gradle.org%2F" target="_blank" title="https://plugins.gradle.org/" ref="nofollow noopener noreferrer">plugins.gradle.org/</a></p>
<p><strong>插件都做了什么</strong></p>
<p>把插件应用到项目中可以用来扩展项目功能。包括：</p>
<ul>
<li>将任务添加到项目（如编译、测试）。</li>
<li>使用有用的默认设置对已添加的任务进行预配置。</li>
<li>向项目中添加依赖配置。</li>
<li>通过扩展对现有类型添加新的属性和方法。</li>
</ul>
<p><strong>Java插件</strong></p>
<p>Gradle中的Java插件，提供了诸如编译、测试、打包等功能。</p>
<p>Java插件为工程定义了许多默认值。如Java源文件位置。如果遵循这些默认规则，那么无需在脚本文件中书写太多代码。当然，Gradle也允许自定义项目中一些规则。</p>
<p>Java插件向项目中添加了大量任务，如下所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fee4416aa874539822b2215791b2a8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA57q_5aSn56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767110104&amp;x-signature=13mpgTyhHCPbR5cp9WMGnixHbfU%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bde205df543140dd9882c80a6e739099~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA57q_5aSn56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767110104&amp;x-signature=1bbnyKb%2FReGX2Na%2Btam7d5DR5Rs%3D" alt="image.png" loading="lazy"/></p>
<p>对于每个添加到该项目中的源集。Java插件将添加以下编译任务。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a11a6da911d24f78842dc7729e82b83a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA57q_5aSn56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767110104&amp;x-signature=Vz9el73IDUJhartE72gaW%2F%2BQAaY%3D" alt="image.png" loading="lazy"/></p>
<p>Java插件还增加了大量的任务构成该项目的生命周期：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c97433c038464d2b9495f4278f9b13f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA57q_5aSn56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767110104&amp;x-signature=Jtq0qA7tcgA9mk7Abt9E5N8An3Q%3D" alt="image.png" loading="lazy"/></p>
<p><strong>Java项目常用的任务</strong></p>
<p>Java项目（使用了Java插件）执行gradle build后，会默认执行下列任务：</p>
<pre><code class="hljs language-java" lang="java">gradle build
:compileJava
:processResources
:classes
:jar
:assemble
:cpmilerTestJava
:processTestResources
:testClasses
:test
:check
:build
BUILD SUCCESSFUL

Total time: <span class="hljs-number">1.12</span> secs
</code></pre>
<p>clean：删除build目录以及所有构建完成的文件。</p>
<p>assemble：编译并打包jar文件，但不会执行单元测试。</p>
<p>test：编译并执行单元测试。</p>
<p>check：编译并测试代码。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[让 AI 工作空间更智能：Amazon Quick Suite 集成博查搜索实践]]></title>    <link>https://juejin.cn/post/7586869907066945571</link>    <guid>https://juejin.cn/post/7586869907066945571</guid>    <pubDate>2025-12-23T14:08:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586869907066945571" data-draft-id="7586687526868205583" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="让 AI 工作空间更智能：Amazon Quick Suite 集成博查搜索实践"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-23T14:08:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="亚马逊云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2850395271209496"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            让 AI 工作空间更智能：Amazon Quick Suite 集成博查搜索实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2850395271209496/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    亚马逊云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T14:08:42.000Z" title="Tue Dec 23 2025 14:08:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>引言</strong>  <strong>（企业</strong> <strong>AI</strong> <strong>助手的</strong> <strong>“</strong> <strong>信息孤岛</strong> <strong>“</strong> <strong>挑战）</strong></h2>
<p>在数字化转型的浪潮中，企业对智能化工作空间的需求日益迫切。Amazon Quick Suite 作为亚马逊云科技推出的新一代 agentic AI 驱动的数字工作空间，正在重新定义企业用户与数据、知识的交互方式。它不仅提供强大的商业智能分析能力，更通过 AI 助手将洞察转化为行动，让每个员工都能拥有一个智能化的工作伙伴。</p>
<p>然而，AI 助手的能力边界很大程度上取决于其获取信息的能力。企业用户在日常工作中面临多样化的信息检索需求：产品经理需要追踪实时市场动态和行业新闻，研发团队需要查询技术文档和学术论文，管理层需要获取经过智能排序的高质量决策参考。如何让 Quick Suite 的 AI 助手具备这种多场景、高质量的信息检索能力，是提升用户体验的关键。</p>
<p>本文将介绍如何借助<a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.bochaai.com%2F" target="_blank" title="https://open.bochaai.com/" ref="nofollow noopener noreferrer">博查搜索</a>的能力，让用户可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.aws.amazon.com%2Fquicksuite%2Flatest%2Fuserguide%2Fwhat-is.html" target="_blank" title="https://docs.aws.amazon.com/quicksuite/latest/userguide/what-is.html" ref="nofollow noopener noreferrer">Amazon Quick Suite</a> 的统一 Chat Agent 界面中获得实时网络搜索能力，同时保持企业级的安全性和可扩展性。</p>
<blockquote>
<p>📢限时插播：无需管理基础设施，利用亚马逊技术与生态，快速集成与部署生成式AI模型能力。</p>
<p>✨ 精心设计，旨在引导您深入探索Amazon Bedrock的模型选择与调用、模型自动化评估以及安全围栏(Guardrail)等重要功能。</p>
<p>⏩快快点击进入《<a href="https://link.juejin.cn?target=https%3A%2F%2Fevents.amazoncloud.cn%2Flabs%2Fcloudlab-amazon-bedrock-first-experience%3Fvisitfrom%3D3P_Juejinhead_1223%26sc_medium%3Downed%26sc_campaign%3Dcloudlab%26sc_channel%3D3P_Juejinhead_1223" target="_blank" title="https://events.amazoncloud.cn/labs/cloudlab-amazon-bedrock-first-experience?visitfrom=3P_Juejinhead_1223&amp;sc_medium=owned&amp;sc_campaign=cloudlab&amp;sc_channel=3P_Juejinhead_1223" ref="nofollow noopener noreferrer">多模一站通 —— Amazon Bedrock 上的基础模型初体验</a>》实验构建无限, 探索启程！</p>
</blockquote>
<h2 data-id="heading-1"><a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fquicksuite%2F" target="_blank" title="https://aws.amazon.com/cn/quicksuite/" ref="nofollow noopener noreferrer"><strong>Amazon Quick Suite</strong></a> <strong>：</strong> <strong>Agentic AI</strong> <strong>驱动的数字工作空间</strong></h2>
<p>Amazon Quick Suite 是一个由Agentic AI 驱动的数字工作空间，为企业用户提供一组代理式团队成员，他们可以快速回答工作中的问题并将答案转化为操作。</p>
<p>Amazon Quick Suite 是一个全面的、由生成式 AI 驱动的商业智能平台，可轻松分析数据、创建可视化、自动化工作流程并在整个组织内进行协作。该服务将传统商业智能功能与现代 AI 助手相结合，无需机器学习专业知识即可使用。您可以连接到多样化的数据源、创建交互式仪表板、构建智能自动化，并通过与 AI 代理的自然语言对话获得即时洞察。</p>
<p>Quick Suite 包含五项集成功能，协同运作：Amazon Quick Sight 用于数据可视化，Amazon Quick Flows 用于工作流自动化，Amazon Quick Automate 用于流程优化，Amazon Quick Index 用于数据发现，以及 Amazon Quick Research 用于综合分析。该平台超越了传统商业智能的范畴，通过浏览器、Slack 和 Microsoft Office 应用程序的扩展，将 AI 助手直接集成到您现有的工具中。</p>
<h2 data-id="heading-2"><strong>博查搜索：为企业</strong> <strong>AI</strong> <strong>打造的智能搜索引擎</strong></h2>
<h3 data-id="heading-3"><strong>公司概况</strong></h3>
<p>博查搜索（Bocha）是一家专注于<strong>世界知识搜索引擎与语义排序技术</strong>的技术公司，面向 AI 应用提供高质量、高覆盖、低时延的联网检索服务。公司目前服务超过 30,000+ 泛企业用户，接入 100,000+ AI 应用，在金融、政务、教育、企业、车机等各个行业均有落地。</p>
<h3 data-id="heading-4"><strong>核心产品</strong></h3>
<p>博查搜索提供三大核心产品：</p>
<p><strong>（</strong> <strong>1</strong> <strong>）</strong> <strong>Web Search API</strong> <strong>（主力产品）</strong></p>
<ul>
<li>多模态混合搜索（网页+新闻+百科+视频+机酒）</li>
<li>IndexNow 秒级收录网页</li>
<li>Summary 长文返回，支持指定时间、指定域</li>
<li>支持 API、MCP、SDK 多种调用方式</li>
<li>接入 Coze、Dify、火山引擎等工作流</li>
</ul>
<p><strong>（</strong> <strong>2</strong> <strong>）</strong> <strong>Semantic Reranker</strong> <strong>（语义排序引擎）</strong></p>
<ul>
<li>自研深度语义理解模型，优化检索结果前 N 条的相关性</li>
<li>模型友好、高相关性、适合智能体场景</li>
</ul>
<p><strong>（</strong> <strong>3</strong> <strong>）</strong> <strong>BochaDB</strong> <strong>（企业级知识索引）</strong></p>
<ul>
<li>支持企业内部知识库统一索引</li>
<li>提供结构化搜索、内容审查、访问控制</li>
<li>支持本地部署/私有云方案</li>
</ul>
<h3 data-id="heading-5"><strong>技术优势</strong></h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90337720d5964562b26373fd10ce0248~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767103739&amp;x-signature=OxbCeF5S4VdcXE9YBnZ1UOPk5AU%3D" alt="1.webp" loading="lazy"/></p>
<h3 data-id="heading-6"><strong>典型应用场景</strong></h3>
<p>博查搜索主要服务以下客户类型：</p>
<ul>
<li><strong>AI</strong> <strong>产品方</strong>：模型公司、智能体产品、App/插件应用</li>
<li><strong>政务平台</strong>：城市大脑、政务问答、政府网站智能搜索</li>
<li><strong>大型企业</strong>：银行、保险、医药、互联网公司</li>
<li><strong>研发团队</strong>：高校研究机构、开发者社区</li>
</ul>
<p>典型解决方案包括：模型联网问答（RAG）检索、智能客服与智能问答底座、多源信息聚合与企业搜索、行业知识库与垂直搜索能力。</p>
<h2 data-id="heading-7"><strong>解决方案：通过</strong> <strong>AgentCore Gateway</strong> <strong>集成博查搜索</strong></h2>
<p>我们的解决方案采用模块化架构，通过 Amazon Bedrock AgentCore Gateway 作为统一的工具服务器，将博查搜索服务集成到 Amazon Quick Suite 中。架构如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed17aecfa6a14dbb86f4b20c36080605~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767103739&amp;x-signature=ZhODJN1SJnOcPMextwSDlPfwv2o%3D" alt="2.webp" loading="lazy"/></p>
<h3 data-id="heading-8"><strong>架构亮点</strong></h3>
<ol>
<li><strong>统一认证</strong>：使用 Amazon Cognito Service-to-Service 认证，Quick Suite 只需配置一次</li>
<li><strong>模块化设计</strong>：每个服务/工具独立部署为 Amazon Lambda 函数，互不影响</li>
<li><strong>灵活扩展</strong>：通过 AgentCore Gateway Targets 机制，可以轻松添加新的服务/工具</li>
<li><strong>安全管理</strong>：所有 API Keys 通过 Lambda 环境变量管理，不暴露在代码中</li>
</ol>
<h2 data-id="heading-9"><strong>实施指南</strong></h2>
<h3 data-id="heading-10"><strong>前置条件</strong></h3>
<p>在开始之前，请确保您具备以下条件：</p>
<ul>
<li>亚马逊云科技账户，具有创建 IAM 角色和策略的权限</li>
<li>Amazon Quick Suite 访问权限（Author Pro 订阅）</li>
<li>博查的 API Keys</li>
<li>本地开发环境：</li>
<li>Amazon CLI 已配置（aws configure）</li>
<li>Python 3.9 或更高版本</li>
<li>jq（JSON 处理工具）</li>
</ul>
<h3 data-id="heading-11"><strong>实施步骤</strong></h3>
<h4 data-id="heading-12"><strong>第一步：准备开发环境</strong></h4>
<p>首先，克隆项目代码并设置 Python 虚拟环境：</p>
<pre><code class="hljs language-Bash" lang="Bash"><span class="hljs-comment"># 克隆项目git clone https://github.com/xina0311/amazon-quick-suite-web-search-integration.git</span>
<span class="hljs-built_in">cd</span> amazon-quick-suite-web-search-integration

<span class="hljs-comment"># 创建并激活 Python 虚拟环境</span>
python3 -m venv venv
<span class="hljs-built_in">source</span> venv/bin/activate

<span class="hljs-comment"># 安装 Python 依赖</span>
pip install -r requirements.txt

<span class="hljs-comment"># 验证安装</span>
python3 -c <span class="hljs-string">"import boto3, requests; print('✓ 依赖安装成功')"</span>
</code></pre>
<h4 data-id="heading-13"><strong>第二步：部署基础设施</strong></h4>
<p>运行自动化脚本部署 Amazon Cognito 和 AgentCore Gateway：</p>
<pre><code class="hljs language-Bash" lang="Bash">./deploy_infrastructure.sh us-east-1
</code></pre>
<p>这个脚本将自动完成以下任务：</p>
<ol>
<li>创建 Cognito User Pool 和 App Client（用于 Service-to-Service 认证）</li>
<li>创建 Amazon Bedrock AgentCore Gateway</li>
<li>配置 Cognito JWT 认证</li>
<li>生成配置文件 txt</li>
</ol>
<p>部署完成后，记录以下信息（保存在 config.txt 中）：</p>
<ul>
<li>Gateway URL</li>
<li>Client ID</li>
<li>Client Secret</li>
<li>Token URL</li>
</ul>
<h4 data-id="heading-14"><strong>第三步：部署博查搜索服务</strong></h4>
<pre><code class="hljs language-Bash" lang="Bash"><span class="hljs-built_in">cd</span> providers/bocha

<span class="hljs-comment"># 设置 API Keyexport BOCHA_API_KEY="your-bocha-api-key"# 部署 Lambda 函数</span>
./deploy.sh

<span class="hljs-comment"># 测试 Lambda 功能</span>
./test_lambda.sh
</code></pre>
<p>测试成功后，您将看到类似以下的搜索结果：</p>
<pre><code class="hljs language-markdown" lang="markdown">✓ 测试 1 通过

<span class="hljs-section">响应预览:
------------------------------------------------------------</span>
<span class="hljs-section"># 博查 Web Search 结果</span>

共找到 3 个结果

<span class="hljs-section">## 1. 亚马逊CEO解读Bedrock新功能AgentCore...</span>
<span class="hljs-strong">**链接:**</span> https://...
<span class="hljs-section"><span class="hljs-strong">**摘要:**</span> Amazon Bedrock AgentCore推出新功能...
------------------------------------------------------------</span>
</code></pre>
<p>将博查添加到 Gateway：</p>
<pre><code class="hljs language-Bash" lang="Bash">python3 add_target.py
./test_target.sh
</code></pre>
<p><strong>第四步：在</strong> <strong>Amazon Quick Suite</strong> <strong>中配置</strong> <strong>MCP Integration</strong></p>
<ol>
<li>登录 Amazon Quick Suite 控制台</li>
<li>导航到 <strong>Integrations</strong> → <strong>Actions</strong> → <strong>Model Context Protocol</strong></li>
<li>点击 “+” 创建新的 Integration</li>
</ol>
<p>填写以下信息：</p>
<p><strong>Name</strong>:</p>
<pre><code class="hljs language-sql" lang="sql">AI Web <span class="hljs-keyword">Search</span>
</code></pre>
<p><strong>Description</strong>:</p>
<pre><code class="hljs language-sql" lang="sql">This integration provides three specialized AI<span class="hljs-operator">-</span>powered web <span class="hljs-keyword">search</span> tools <span class="hljs-keyword">for</span> different information retrieval needs.

Tool <span class="hljs-keyword">is</span> BochaWebSearchTarget___bocha_web_search. This tool specializes <span class="hljs-keyword">in</span> <span class="hljs-type">real</span><span class="hljs-operator">-</span><span class="hljs-type">time</span> web content search. It excels <span class="hljs-keyword">at</span> finding breaking news, latest articles, <span class="hljs-keyword">current</span> events <span class="hljs-keyword">and</span> up<span class="hljs-operator">-</span><span class="hljs-keyword">to</span><span class="hljs-operator">-</span><span class="hljs-type">date</span> information <span class="hljs-keyword">from</span> the internet. Best choice <span class="hljs-keyword">when</span> you need the most recent news stories <span class="hljs-keyword">or</span> want <span class="hljs-keyword">to</span> know what <span class="hljs-keyword">is</span> happening <span class="hljs-keyword">right</span> now <span class="hljs-keyword">on</span> <span class="hljs-keyword">any</span> topic.

Guidelines <span class="hljs-keyword">for</span> tool selection <span class="hljs-operator">-</span> Use BochaWebSearchTarget <span class="hljs-keyword">when</span> users ask about news, <span class="hljs-keyword">current</span> events <span class="hljs-keyword">or</span> recent happenings. Use MetasoWebSearchTarget <span class="hljs-keyword">when</span> users need research papers, academic content, technical docs <span class="hljs-keyword">or</span> <span class="hljs-keyword">specific</span> media types. Use CloudswayWebSearchTarget <span class="hljs-keyword">when</span> users want intelligent <span class="hljs-keyword">search</span> <span class="hljs-keyword">with</span> relevance ranking <span class="hljs-keyword">or</span> need <span class="hljs-type">time</span><span class="hljs-operator">-</span>filtered results.
</code></pre>
<p><strong>MCP Server Endpoint</strong>: 从 config.txt 复制 GATEWAY_URL</p>
<p><strong>Authentication Type</strong>: 选择 “Service authentication”</p>
<p><strong>Client ID</strong>: 从 config.txt 复制</p>
<p><strong>Client Secret</strong>: 从 config.txt 复制</p>
<p><strong>Token URL</strong>: 从 config.txt 复制</p>
<ol start="4">
<li>点击 <strong>Save</strong> 保存配置</li>
<li>等待 1-2 分钟，状态变为 “Available”</li>
<li>查看 <strong>Available Actions</strong>，确认看到搜索工具</li>
</ol>
<h4 data-id="heading-15"><strong>第五步：实际使用示例</strong></h4>
<p>配置完成后，您可以在 Amazon Quick Suite 的 Chat Agent 中使用博查搜索。</p>
<ol>
<li>为chat agent添加博查搜索工具</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f5c19fecc124f8faf87fa9649e0be48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767103739&amp;x-signature=DLDG7Xb8WAEya3dyZrcO78bGXk8%3D" alt="3.webp" loading="lazy"/>
2.  Chat Agent 将调用博查搜索工具，返回最新的新闻和文章。</p>
<p>查找关于 Amazon Bedrock AgentCore 的最新信息</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76e2e43437894cb399adba156ccc085d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767103739&amp;x-signature=Yb8vdkMmLJ13WCPY50%2F7qLRvamE%3D" alt="4.webp" loading="lazy"/></p>
<p>从 Response events 中可以看到，Chat Agent 识别用户需求后，自动调用了博查搜索 API（BochaWebSearchTarget），从 AI_Web_Search 获取最新信息，并基于搜索结果生成回答。</p>
<h2 data-id="heading-16"><strong>总结</strong></h2>
<p>本文展示了如何利用 Amazon Bedrock AgentCore Gateway 和 Model Context Protocol (MCP) 将专业的智能搜索能力集成到 Amazon Quick Suite 中，为企业 AI 工作空间提供强大的信息检索能力。博查搜索提供的多模态混合搜索、秒级内容收录和语义排序能力，为 Quick Suite 的 AI 助手提供了高质量、低时延的信息检索支持。</p>
<p>通过这一技术集成方案，我们实现了：</p>
<ul>
<li><strong>统一的用户体验</strong>：用户无需在多个工具间切换，在 Quick Suite 的 Chat Agent 中即可完成所有搜索需求</li>
<li><strong>企业级的安全管理</strong>：通过 Amazon Cognito Service-to-Service 认证和环境变量管理 API Keys，确保访问控制和密钥安全</li>
<li><strong>灵活的架构设计</strong>：模块化的 Lambda 函数和 Gateway Targets 机制，让您可以轻松添加更多搜索服务或其他第三方工具</li>
<li><strong>开箱即用的部署</strong>：提供完整的自动化脚本和详细文档，大幅降低集成门槛</li>
</ul>
<p>Amazon Quick Suite 通过开放的 MCP 协议，为企业构建了一个可扩展的 AI 工作空间平台。您可以使用相同的技术架构集成更多专业服务，真正打造符合企业需求的智能化数字工作空间。</p>
<p>*<em>前述特定亚马逊云科技生成式人工智能相关的服务目前在亚马逊云科技海外区域可用。亚马逊云科技中国区域相关云服务由西云数据和光环新网运营，具体信息以中国区域官网为准。</em></p>
<p><strong>本篇作者</strong>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f46f06faaca4465b85c768e11bec38ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767103739&amp;x-signature=VsGsTavJ7e1sDPQnmk6XUH3Uejs%3D" alt="5.webp" loading="lazy"/></p>
<blockquote>
<p>本期最新实验《<a href="https://link.juejin.cn?target=https%3A%2F%2Fevents.amazoncloud.cn%2Flabs%2Fcloudlab-amazon-bedrock-first-experience%3Fvisitfrom%3D3P_Juejintail_1223%26sc_medium%3Downed%26sc_campaign%3Dcloudlab%26sc_channel%3D3P_Juejintail_1223" target="_blank" title="https://events.amazoncloud.cn/labs/cloudlab-amazon-bedrock-first-experience?visitfrom=3P_Juejintail_1223&amp;sc_medium=owned&amp;sc_campaign=cloudlab&amp;sc_channel=3P_Juejintail_1223" ref="nofollow noopener noreferrer">多模一站通 —— Amazon Bedrock 上的基础模型初体验</a>》</p>
<p>✨ 精心设计，旨在引导您深入探索Amazon Bedrock的模型选择与调用、模型自动化评估以及安全围栏(Guardrail)等重要功能。无需管理基础设施，利用亚马逊技术与生态，快速集成与部署生成式AI模型能力。</p>
<p>⏩️[<a href="https://link.juejin.cn?target=https%3A%2F%2Fevents.amazoncloud.cn%2Flabs%2Fcloudlab-amazon-bedrock-first-experience%3Fvisitfrom%3D3P_Juejintail_1223%26sc_medium%3Downed%26sc_campaign%3Dcloudlab%26sc_channel%3D3P_Juejintail_1223" target="_blank" title="https://events.amazoncloud.cn/labs/cloudlab-amazon-bedrock-first-experience?visitfrom=3P_Juejintail_1223&amp;sc_medium=owned&amp;sc_campaign=cloudlab&amp;sc_channel=3P_Juejintail_1223" ref="nofollow noopener noreferrer">点击进入实验</a>] 即刻开启  AI 开发之旅</p>
<p>构建无限, 探索启程！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C++与浏览器交织-从Chrome插件到WebAssembly，开启性能之门]]></title>    <link>https://juejin.cn/post/7586939930155122731</link>    <guid>https://juejin.cn/post/7586939930155122731</guid>    <pubDate>2025-12-23T14:47:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586939930155122731" data-draft-id="7586939930155106347" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" C++与浏览器交织-从Chrome插件到WebAssembly，开启性能之门"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-23T14:47:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             C++与浏览器交织-从Chrome插件到WebAssembly，开启性能之门
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T14:47:14.000Z" title="Tue Dec 23 2025 14:47:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>网络编程与HTML解析曾经是浏览器开发的必修课，但现在，我们有了更便捷的工具，Qt的WebEngine模块和V8引擎让C++开发者能够轻松构建自定义浏览器。</p>
</blockquote>
<p>C++与浏览器开发，这两个看似独立的技术领域实际上存在着丰富的交集点。C++可以直接调用浏览器核心组件，如通过V8引擎运行JavaScript，利用WebAssembly将C++代码运行在浏览器中。</p>
<p>同时，C++也在浏览器扩展开发中发挥着关键作用。从性能优化到系统集成，C++为浏览器开发提供了强大的底层支持。</p>
<hr/>
<h2 data-id="heading-0">01 浏览器开发的技术演进</h2>
<p>浏览器技术经历了从简单网络客户端到复杂应用平台的演变过程。早期的浏览器实现需要处理<strong>网络编程、HTML解析和渲染</strong>等多个层面。</p>
<p>而如今，开发者已经可以通过成熟的框架和引擎更轻松地创建自定义浏览器。</p>
<p>C++在这一演进过程中扮演着关键角色，它不仅是Chrome、Firefox等主流浏览器的实现语言，也提供了与浏览器技术交互的多种途径。</p>
<p>Google的V8 JavaScript引擎就是用C++编写的高性能引擎，它被用于Chrome和Node.js中。</p>
<hr/>
<h2 data-id="heading-1">02 构建自定义浏览器：Qt WebEngine方案</h2>
<p>对于C++开发者来说，最便捷的浏览器开发方案是使用<strong>Qt WebEngine模块</strong>。该模块提供了完整的网页浏览器引擎，使得在没有本地网页引擎的平台中嵌入互联网内容变得简单。</p>
<p>Qt WebEngine基于Chromium项目，它支持渲染HTML、XHTML和SVG文档，使用CSS进行样式设计，并通过JavaScript进行脚本编写。</p>
<p>在C++中使用Qt WebEngine显示网页非常简单：</p>
<pre><code class="hljs language-cpp" lang="cpp">QWebEngineView *view = <span class="hljs-keyword">new</span> <span class="hljs-built_in">QWebEngineView</span>(parent);
view-&gt;<span class="hljs-built_in">load</span>(<span class="hljs-built_in">QUrl</span>(<span class="hljs-string">"http://www.qt.io/"</span>));
view-&gt;<span class="hljs-built_in">show</span>();
</code></pre>
<p>这段代码创建了一个Web引擎视图，加载指定URL，并显示出来。这种简洁的API设计使得开发者可以轻松将Web内容集成到自己的应用程序中。</p>
<p>Qt WebEngine的架构设计巧妙地将<strong>网页渲染和JavaScript执行</strong>分离到独立进程中，提高了安全性和稳定性。每个页面都属于一个Web引擎配置文件，其中包含共享的设置、脚本和cookie。</p>
<p>这样的设计使得开发者可以创建专门用于隐私浏览的配置文件，其中不会永久保存任何信息。</p>
<hr/>
<h2 data-id="heading-2">03 核心浏览器引擎：深入理解V8</h2>
<p>V8引擎是Google开源的<strong>高性能JavaScript和WebAssembly引擎</strong>，用C++编写。它是现代浏览器技术栈的核心组件，理解V8对于深入浏览器开发至关重要。</p>
<p>V8引擎实现了ECMAScript和WebAssembly标准，能在Windows、macOS和Linux等多个平台上运行。</p>
<p>它采用独特的编译和执行机制，直接编译JavaScript源代码为机器码，而不通过中间字节码，这一设计使其执行速度极快。</p>
<p>V8的内存管理机制是其高性能的关键之一。它使用<strong>停止世界、分代、精确的垃圾收集器</strong>，能够高效地管理对象内存分配和回收不再需要的对象。</p>
<p>对于C++开发者而言，V8最大的优势在于其可嵌入性——它可以被轻松集成到任何C++应用程序中。</p>
<p>开发者可以通过V8使自己的C++应用程序将其自定义对象和函数暴露给JavaScript代码，从而实现两种语言之间的无缝交互。</p>
<hr/>
<h2 data-id="heading-3">04 WebAssembly：让C++在浏览器中运行</h2>
<p>WebAssembly是近年来浏览器技术的重要突破，它允许将C++等低级语言代码运行在浏览器环境中。通过编译器如Emscripten，可以将C++代码编译成WebAssembly模块。</p>
<p>WebAssembly模块的优势显而易见：<strong>体积更小、执行更快、跨平台、安全性高</strong>，并且支持C/C++、Rust等多种编程语言。</p>
<p>要在浏览器中运行C++代码，通常需要三个步骤：首先使用Emscripten将C/C++源码编译成wasm模块；然后通过JavaScript加载该模块；最后使用JavaScript调用wasm模块中的函数。</p>
<p>在实际应用中，WebAssembly已被广泛使用：<strong>Google Earth</strong>采用WebAssembly技术实现在多个浏览器中的3D绘制；FFmpeg通过WebAssembly在浏览器中加速视频编解码；甚至Adobe Photoshop也发布了基于WebAssembly的在线测试版本。</p>
<hr/>
<h2 data-id="heading-4">05 Chrome插件与C++的结合</h2>
<p>Chrome插件开发通常使用HTML、CSS和JavaScript，但在需要底层功能时，C++也能发挥重要作用。Chrome插件可以通过NPAPI（较老）或PPAPI（较新）技术，配合C++编写的dll动态链接库实现更底层的功能。</p>
<p>开发C++支持的Chrome插件需要几个关键步骤：</p>
<p>创建一个描述插件的JSON文件（manifest.json），这是每个Chrome插件必不可少的配置文件。</p>
<p>实现C++的DLL文件作为插件核心，导出一个C接口以便JavaScript能够调用。</p>
<p>编写JavaScript文件，调用C++导出的函数。</p>
<p>将这三个文件打包成ZIP文件（最终为.crx文件），通过Chrome的扩展程序页面加载。</p>
<hr/>
<h2 data-id="heading-5">06 浏览器开发的最佳实践</h2>
<p>在浏览器开发过程中，遵循一些最佳实践可以提高开发效率和程序质量。对于WebAssembly开发，应选择性能关键部分进行编译，而不是盲目将整个应用转换为wasm。</p>
<p>WebAssembly是对JavaScript的补充，而不是替代。</p>
<p>对于Chrome插件开发，需要合理配置manifest.json文件的权限申请。常见权限包括“contextMenus”、“tabs”、“notifications”、“webRequest”和“storage”等。</p>
<p>考虑到安全性问题，Chrome浏览器42及以上版本已逐渐不再支持不安全的NPAPI插件，推荐使用更安全的PPAPI。</p>
<p>对于Qt WebEngine应用，如果要在高DPI设备上获得良好体验，建议将应用程序属性<code>Qt::AA_EnableHighDpiScaling</code>设置为启用基于监视器像素密度的自动缩放。</p>
<p>此外，页面渲染和JavaScript执行被分开到独立的Qt WebEngine进程中，这有助于缓解由于特定内容引发的安全问题和崩溃。</p>
<hr/>
<h2 data-id="heading-6">07 浏览器开发的未来趋势</h2>
<p>浏览器技术仍在快速发展中，C++与浏览器开发的结合将更加紧密。WebAssembly技术正在突破浏览器环境，向服务端和边缘计算领域扩展，使C++代码能在更多环境中高效运行。</p>
<p><strong>WebAssembly具备服务端应用能力</strong>，只要抹平系统接口差异，它也能在其他操作系统中运行。</p>
<p>这使得开发者可以编写一份核心代码，同时在浏览器端和服务器端运行，减少了开发和维护成本。</p>
<p>随着Web技术的不断发展，JavaScript仍然是web端开发的主流脚本语言，WebAssembly与其互为补充，共同构建更强大的Web应用。</p>
<hr/>
<p>浏览器技术栈在持续演进，对C++开发者而言，挑战与机遇并存。Qt WebEngine让传统桌面应用能够轻松嵌入现代Web内容，而WebAssembly则为C++代码打开了通向浏览器的大门。</p>
<p>V8引擎提供了在C++应用中执行JavaScript的能力，这些技术共同构建了一个多元化的开发生态。同时，掌握如何开发Chrome插件并集成C++功能，能够帮助开发者创造出更强大、更个性化的浏览器体验。</p>
<p>理解这些技术的核心原理与适用场景，是C++开发者在当今互联网时代保持竞争力的关键。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C++高并发编程核心技能解析]]></title>    <link>https://juejin.cn/post/7586939930155139115</link>    <guid>https://juejin.cn/post/7586939930155139115</guid>    <pubDate>2025-12-23T14:48:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586939930155139115" data-draft-id="7586943543018766378" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C++高并发编程核心技能解析"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-23T14:48:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C++高并发编程核心技能解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T14:48:44.000Z" title="Tue Dec 23 2025 14:48:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在当今的多核处理器时代，高并发编程已成为C++开发者必须掌握的核心技能。无论是构建高性能服务器、实时交易系统，还是大规模数据处理平台，并发编程能力直接决定了程序的性能和响应能力。本文将深入探讨C++高并发编程必须掌握的关键技能和技术栈。</p>
<h2 data-id="heading-0">一、现代C++并发基础</h2>
<h3 data-id="heading-1">1.1 线程管理与同步</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// C++11以来的标准线程库</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;condition_variable&gt;</span></span>

std::mutex mtx;
std::condition_variable cv;
<span class="hljs-type">bool</span> ready = <span class="hljs-literal">false</span>;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">worker_thread</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mtx)</span></span>;
    cv.<span class="hljs-built_in">wait</span>(lock, []{ <span class="hljs-keyword">return</span> ready; });
    <span class="hljs-comment">// 执行任务</span>
}
</code></pre>
<h3 data-id="heading-2">1.2 原子操作与内存模型</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;atomic&gt;</span></span>

std::atomic&lt;<span class="hljs-type">int</span>&gt; counter{<span class="hljs-number">0</span>};
std::atomic&lt;<span class="hljs-type">bool</span>&gt; flag{<span class="hljs-literal">false</span>};

<span class="hljs-comment">// 内存顺序的选择至关重要</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span> </span>{
    counter.<span class="hljs-built_in">fetch_add</span>(<span class="hljs-number">1</span>, std::memory_order_relaxed);
}
</code></pre>
<h2 data-id="heading-3">二、核心并发原语与模式</h2>
<h3 data-id="heading-4">2.1 锁的高级用法</h3>
<ul>
<li><strong>RAII锁管理</strong>：<code>std::lock_guard</code>、<code>std::unique_lock</code></li>
<li><strong>读写锁</strong>：<code>std::shared_mutex</code>（C++17）</li>
<li><strong>死锁避免策略</strong>：<code>std::lock()</code>、<code>std::try_lock()</code></li>
</ul>
<h3 data-id="heading-5">2.2 条件变量的正确使用</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadSafeQueue</span> {
<span class="hljs-keyword">private</span>:
    std::queue&lt;T&gt; queue;
    <span class="hljs-keyword">mutable</span> std::mutex mtx;
    std::condition_variable cond;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">push</span><span class="hljs-params">(T value)</span> </span>{
        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mtx)</span></span>;
        queue.<span class="hljs-built_in">push</span>(std::<span class="hljs-built_in">move</span>(value));
        cond.<span class="hljs-built_in">notify_one</span>();
    }
    
    <span class="hljs-function">T <span class="hljs-title">pop</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mtx)</span></span>;
        cond.<span class="hljs-built_in">wait</span>(lock, [<span class="hljs-keyword">this</span>]{ <span class="hljs-keyword">return</span> !queue.<span class="hljs-built_in">empty</span>(); });
        T value = std::<span class="hljs-built_in">move</span>(queue.<span class="hljs-built_in">front</span>());
        queue.<span class="hljs-built_in">pop</span>();
        <span class="hljs-keyword">return</span> value;
    }
};
</code></pre>
<h2 data-id="heading-6">三、异步编程与Future/Promise模式</h2>
<h3 data-id="heading-7">3.1 std::async与std::future</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;future&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>

<span class="hljs-function">std::future&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">async_task</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">async</span>(std::launch::async, []{
        std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">seconds</span>(<span class="hljs-number">1</span>));
        <span class="hljs-keyword">return</span> <span class="hljs-number">42</span>;
    });
}

<span class="hljs-comment">// 使用std::packaged_task</span>
<span class="hljs-function">std::packaged_task&lt;<span class="hljs-title">int</span><span class="hljs-params">()</span>&gt; <span class="hljs-title">task</span><span class="hljs-params">([](){ <span class="hljs-keyword">return</span> <span class="hljs-number">7</span>; })</span></span>;
std::future&lt;<span class="hljs-type">int</span>&gt; result = task.<span class="hljs-built_in">get_future</span>();
std::<span class="hljs-built_in">thread</span>(std::<span class="hljs-built_in">move</span>(task)).<span class="hljs-built_in">detach</span>();
</code></pre>
<h3 data-id="heading-8">3.2 std::promise的深入应用</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">set_value_async</span><span class="hljs-params">(std::promise&lt;<span class="hljs-type">int</span>&gt;&amp;&amp; promise)</span> </span>{
    std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">milliseconds</span>(<span class="hljs-number">500</span>));
    promise.<span class="hljs-built_in">set_value</span>(<span class="hljs-number">100</span>);
}
</code></pre>
<h2 data-id="heading-9">四、无锁编程与高性能并发数据结构</h2>
<h3 data-id="heading-10">4.1 CAS（Compare-And-Swap）操作</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LockFreeStack</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span> {
        T data;
        Node* next;
    };
    
    std::atomic&lt;Node*&gt; head{<span class="hljs-literal">nullptr</span>};
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">push</span><span class="hljs-params">(<span class="hljs-type">const</span> T&amp; data)</span> </span>{
        Node* new_node = <span class="hljs-keyword">new</span> Node{data, <span class="hljs-literal">nullptr</span>};
        new_node-&gt;next = head.<span class="hljs-built_in">load</span>();
        <span class="hljs-keyword">while</span>(!head.<span class="hljs-built_in">compare_exchange_weak</span>(new_node-&gt;next, new_node));
    }
};
</code></pre>
<h3 data-id="heading-11">4.2 内存回收挑战与解决方案</h3>
<ul>
<li>Hazard Pointer模式</li>
<li>Epoch-Based Reclamation</li>
<li>Read-Copy-Update（RCU）</li>
</ul>
<h2 data-id="heading-12">五、并发设计模式</h2>
<h3 data-id="heading-13">5.1 生产者-消费者模式</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadPool</span> {
<span class="hljs-keyword">private</span>:
    std::vector&lt;std::thread&gt; workers;
    ThreadSafeQueue&lt;std::function&lt;<span class="hljs-type">void</span>()&gt;&gt; tasks;
    std::atomic&lt;<span class="hljs-type">bool</span>&gt; stop{<span class="hljs-literal">false</span>};
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">ThreadPool</span>(<span class="hljs-type">size_t</span> threads) {
        <span class="hljs-keyword">for</span>(<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; threads; ++i) {
            workers.<span class="hljs-built_in">emplace_back</span>([<span class="hljs-keyword">this</span>] {
                <span class="hljs-keyword">while</span>(!stop) {
                    <span class="hljs-keyword">auto</span> task = tasks.<span class="hljs-built_in">pop</span>();
                    <span class="hljs-keyword">if</span>(task) <span class="hljs-built_in">task</span>();
                }
            });
        }
    }
};
</code></pre>
<h3 data-id="heading-14">5.2 Actor模型实现</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> Message&gt;
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Actor</span> {
<span class="hljs-keyword">private</span>:
    std::unique_ptr&lt;std::thread&gt; worker;
    ThreadSafeQueue&lt;Message&gt; mailbox;
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) {
            <span class="hljs-keyword">auto</span> msg = mailbox.<span class="hljs-built_in">pop</span>();
            <span class="hljs-keyword">if</span>(!msg) <span class="hljs-keyword">break</span>;
            <span class="hljs-built_in">process</span>(*msg);
        }
    }
};
</code></pre>
<h2 data-id="heading-15">六、性能优化与调试技巧</h2>
<h3 data-id="heading-16">6.1 性能分析工具</h3>
<ul>
<li><strong>perf</strong>：Linux性能分析器</li>
<li><strong>Intel VTune</strong>：深入性能分析</li>
<li><strong>Valgrind Helgrind</strong>：并发错误检测</li>
</ul>
<h3 data-id="heading-17">6.2 常见性能陷阱</h3>
<ul>
<li><strong>虚假共享（False Sharing）</strong></li>
<li><strong>锁竞争与粒度问题</strong></li>
<li><strong>内存屏障开销</strong></li>
<li><strong>线程创建销毁成本</strong></li>
</ul>
<h3 data-id="heading-18">6.3 调试并发问题</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 使用Thread Sanitizer（TSAN）</span>
<span class="hljs-comment">// 编译时加入 -fsanitize=thread</span>

<span class="hljs-comment">// 死锁检测</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">potential_deadlock</span><span class="hljs-params">()</span> </span>{
    std::mutex m1, m2;
    
    <span class="hljs-function">std::thread <span class="hljs-title">t1</span><span class="hljs-params">([&amp;] {
        std::lock_guard&lt;std::mutex&gt; g1(m1);
        std::this_thread::sleep_for(std::chrono::milliseconds(<span class="hljs-number">100</span>));
        std::lock_guard&lt;std::mutex&gt; g2(m2);
    })</span></span>;
    
    <span class="hljs-function">std::thread <span class="hljs-title">t2</span><span class="hljs-params">([&amp;] {
        std::lock_guard&lt;std::mutex&gt; g2(m2);
        std::this_thread::sleep_for(std::chrono::milliseconds(<span class="hljs-number">100</span>));
        std::lock_guard&lt;std::mutex&gt; g1(m1);
    })</span></span>;
}
</code></pre>
<h2 data-id="heading-19">七、现代C++并发新特性（C++17/20/23）</h2>
<h3 data-id="heading-20">7.1 执行策略与并行算法</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;algorithm&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;execution&gt;</span></span>

<span class="hljs-function">std::vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">data</span><span class="hljs-params">(<span class="hljs-number">1000000</span>)</span></span>;
std::<span class="hljs-built_in">sort</span>(std::execution::par, data.<span class="hljs-built_in">begin</span>(), data.<span class="hljs-built_in">end</span>());
</code></pre>
<h3 data-id="heading-21">7.2 协程与异步编程</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;coroutine&gt;</span></span>

<span class="hljs-function">Generator&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">range</span><span class="hljs-params">(<span class="hljs-type">int</span> start, <span class="hljs-type">int</span> end)</span> </span>{
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = start; i &lt; end; ++i) {
        <span class="hljs-keyword">co_yield</span> i;
    }
}

<span class="hljs-function">task&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">async_computation</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">int</span> result = <span class="hljs-keyword">co_await</span> <span class="hljs-built_in">async_operation</span>();
    <span class="hljs-keyword">co_return</span> result * <span class="hljs-number">2</span>;
}
</code></pre>
<h2 data-id="heading-22">八、最佳实践与架构考量</h2>
<h3 data-id="heading-23">8.1 设计原则</h3>
<ol>
<li><strong>优先使用任务而非线程</strong></li>
<li><strong>尽量减少共享状态</strong></li>
<li><strong>使用无锁数据结构时需谨慎</strong></li>
<li><strong>合理设置线程池大小</strong></li>
<li><strong>考虑NUMA架构影响</strong></li>
</ol>
<h3 data-id="heading-24">8.2 测试策略</h3>
<ul>
<li>压力测试与负载测试</li>
<li>竞态条件检测</li>
<li>性能回归测试</li>
<li>死锁和活锁检测</li>
</ul>
<h2 data-id="heading-25">九、学习路径与资源推荐</h2>
<h3 data-id="heading-26">9.1 必读经典</h3>
<ul>
<li>《C++ Concurrency in Action》（第二版）</li>
<li>《The Art of Multiprocessor Programming》</li>
<li>《Is Parallel Programming Hard, And, If So, What Can You Do About It?》</li>
</ul>
<h3 data-id="heading-27">9.2 实践项目建议</h3>
<ol>
<li>实现一个高性能线程池</li>
<li>构建无锁队列和栈</li>
<li>实现生产者-消费者模型变体</li>
<li>编写并发缓存系统</li>
</ol>
<h2 data-id="heading-28">结语</h2>
<p>C++高并发编程是一个不断发展的领域，从C++11的标准线程库到C++20的协程，工具和范式都在持续演进。掌握高并发编程不仅需要理解底层原理，更需要在实际项目中不断实践和优化。记住，在并发编程中，正确性永远优先于性能，只有在确保正确的前提下，优化才有意义。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[扣子彻底变了！拥抱 Vibe Coding，不只是智能体！]]></title>    <link>https://juejin.cn/post/7586893663075860490</link>    <guid>https://juejin.cn/post/7586893663075860490</guid>    <pubDate>2025-12-23T13:02:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586893663075860490" data-draft-id="7586877892467851291" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="扣子彻底变了！拥抱 Vibe Coding，不只是智能体！"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-23T13:02:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苍何"/> <meta itemprop="url" content="https://juejin.cn/user/588993963763405"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            扣子彻底变了！拥抱 Vibe Coding，不只是智能体！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993963763405/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苍何
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T13:02:58.000Z" title="Tue Dec 23 2025 13:02:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是苍何的第 466 篇原创！</p>
<p>大家好，我是苍何。</p>
<p>前几天去火山大会上，最让人不可思议的是，在扣子的分论坛上，门口挤爆了，还有很多人根本进不去。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01c6403bbcca4bbdbf8df1ed92cbea65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=DqnWKTJQC%2BygCPn%2FZe1dO8RifDk%3D" alt="图片" loading="lazy"/></p>
<p>不用想也知道，扣子终于在沉寂了许久后，终于放大招了，我也有幸参与了扣子新产品发布的闭门会。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d26618152b51452faa51ec13083e14f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=MvPe6FZtSmTnXxX3h171BK5dDys%3D" alt="图片" loading="lazy"/></p>
<p>结合一些我了解到的（能说的东西），也想给大家做个分享。</p>
<p>先说结论，这次扣子直接强势推出<strong>扣子编程</strong>，可以说是扣子全面迈向 Vibe Coding 的重要一步。</p>
<p>在扣子编程，可以直接通过对话轻松构建智能体（Vibe Agent）、工作流（Vibe WorkFlow）和网站。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae23e1148a5246ccb47c119215041d41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=PwCSsrHI17QfrstZPjhtSYSDm5E%3D" alt="图片" loading="lazy"/></p>
<p>他是长这样子的，可以看到原先在扣子上不同空间项目和资源这些数据都同步过来了，现在更像是一站式 AI 开发平台了，可以通过对话创建智能体、工作流、网页应用和移动应用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/620b8102b8f7480c8548b5ba62622bcd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=rhrGYrubni2a%2FCzbaDh6T7kg0SA%3D" alt="图片" loading="lazy"/></p>
<p>发布会上说，扣子编程是首个提供完整 Vibe Infra 服务的开发平台，提供开箱即用的云端环境、拥有完善的集成与基础设施，内置模型、数据库、对象存储等常用能力。提供一键部署服务。</p>
<p>其实从闭门会回来后，我就一直在适用扣子编程，并做了不少的应用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35807dfccd9448d29f619cf0495932d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=TwT6D0arFlLFA22Vd90v%2BRuI0KQ%3D" alt="图片" loading="lazy"/></p>
<p>感触还蛮大的，原先要手动创建的智能体，拖拉拽才能完成的工作流，现在都是直接对话式生成，非常方便，一句话做应用再次成为了现实。</p>
<p>先 showcase 吧，看下扣子编程究竟能做哪些东西。</p>
<p>一句话生成天气查询智能体，并按照指定格式输出：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffcbee24e2d44d098bf3918d082172df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=p3RxwlCq86KXjKJljd80dJa0rJY%3D" alt="图片" loading="lazy"/></p>
<p>一句话生成 AI 早报资讯卡片，并自动同步到飞书多维表格和发送飞书消息：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/989bccb6ccba47498c88c6cc9f8701cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=Su7f7mKyEKwTWayLzl792LZNu6U%3D" alt="图片" loading="lazy"/></p>
<p>对话生成极客风格的个人主页应用，并可一键分享或者部署。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58a04622b59444d8879bf860e1b7ec76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=Xki4Cx%2BhvDaLW6vZdP7Q2w20TIg%3D" alt="图片" loading="lazy"/></p>
<p>生成作品集应用网站：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6340a16fba842d28ede377521c21c7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=zEkTlKaXKo%2BqZe8IpLGheiAOtAM%3D" alt="图片" loading="lazy"/></p>
<p>小红书图片生成器，可根据主题生成小红书图片。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eeca254f122749efa5f9b987bf1657bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=eSs9XUO4xvZeOKbfjsb5xsK4gDM%3D" alt="图片" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c42fec7549904947bc740cf512aeb29c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=zNEOp%2BNPnmlXZP99YGAKwtuy51w%3D" alt="图片" loading="lazy"/></p>
<p>可能你说上面的太简单，我还用扣子编程做了个前后端并带有数据库的供应商后台管理系统：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/886eae96a43249eca772fab780897026~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=G09ev3ZCxRQlqwSOsC208UfWGvo%3D" alt="图片" loading="lazy"/></p>
<p>具备供应商管理的基本功能以及添加搜索供应商，管理所有产品信息和库存，甚至可以导出数据：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59f5859408254105baa642cef0edbca4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=pXnXrV7nmTeVxk5jbcLMjQQY%2F6E%3D" alt="图片" loading="lazy"/></p>
<p>支持查看仪表盘信息：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a705d6a47d8f4bdbb6eab74cf2fc99b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=vsemTVcZb6lcjzGH9G%2BoH42T0q0%3D" alt="图片" loading="lazy"/></p>
<p>当然了，基本的登录注册功能也是必须有的：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1a4f09cb7174c83a942bb277790fc7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=ij3IIYdbuw4iD9lDHBjdZ7CibX8%3D" alt="图片" loading="lazy"/></p>
<p>可以说是一个合格的全栈应用了，而这个系统也是我在扣子编程中多轮对话完成的系统，他是一个完整的后台管理系统。</p>
<p>下面，从我实测的角度来给大家介绍下如何用好扣子编程吧。</p>
<p>原先的扣子，说实话，上手是有一些学习成本的，特别是工作流的创建，节点的搭建并不是一两句话就能搞定的事。</p>
<p>之前通过扣子搭建的 AI 视频工作流，很多同学用起来是简单，但真要自己去改，就显得有些摸不着头脑了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85e2dbbaf17d47f0b15d0a5fbe300d81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=MVYRdp7oBfl14t35IWunjRamwxM%3D" alt="图片" loading="lazy"/></p>
<p>因为节点真的有点儿长，长到不想看的那种🐶。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e0cbd70037f4334ac6769de594a8382~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=%2Fs1ZfAjtErCNZ6nVC6hSrQJcvNk%3D" alt="图片" loading="lazy"/></p>
<p>所以，我认为，扣子编程的推出，其实是将搭建智能体工作流以及应用这件事的门槛又降低了一个维度，你现在安全可以通过对话式去创建。</p>
<p>可以在原先的扣子最上方，点击进入扣子编程，也可以直接输入链接进入：code.coze.cn</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/471f2b1089354275ae06c63e36fd9264~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=J5qH%2FlBNUE7%2B8Vrr9GrvZ2lcf1o%3D" alt="图片" loading="lazy"/></p>
<p>进入后，原先扣子的「空间切换」、「资源库」位置没变，「项目开发」改为了「项目管理」，在扣子编程开发的智能体、工作流或者应用都会有一个 new 的标识：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01c8fa3f666c492c8d428d0515a7df90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=2fN3cVPiCBmuhxeyyIQYoNFQdto%3D" alt="图片" loading="lazy"/></p>
<p>也可以新建文件夹来存放，这个在原先扣子中也同样可以看到，两边数据是相通的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f358f44d85e745d5b16048989ab1138a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=sDsNb0D3aURVmLfLk5RUVkwoLTs%3D" alt="图片" loading="lazy"/></p>
<p>在扣子编程中新增了集成管理，一共分为内置集成和外部集成，内置集成集成了大语言模型、生图大模型，数据库、对象存储等常用元能力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6547535ab1644b89a4c7ec1db8369634~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=0YeRkjtF9oUNFRX6P1krsCBYh%2Fk%3D" alt="图片" loading="lazy"/></p>
<p>外部集成可以用飞书、企微、邮件、公众号等能力。像上面的几个 case 都分别用了内外部集成的能力，可以说很方便了。</p>
<p>如果我们要做一个智能体，现在只需要在扣子编程中输入需求，比如：</p>
<blockquote>
<p>做一个实时天气查询助手智能体，能够准确、及时地为用户提供全国各省、城市的天气情况。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb506bc7e06f4bae966ae0b7600813d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=A%2F3Hdgkq6o%2F20XYjhschFgOXHQo%3D" alt="图片" loading="lazy"/></p>
<p>扣子编程会自动创建任务来完成智能体的开发，包括会自动创建工具，联网搜索，自动编写智能体所需的系统提示词：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b63fc096a30c4cb0a19cf84be9e5836e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=i3T16GhKsRblFDlXMb5CMf4hlIU%3D" alt="图片" loading="lazy"/></p>
<p>可以直接切换选择不同模型来匹配 agent 节点，在右上角可以切换文件目录，查看 agent 的代码：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/447b56a74736459396681b38e69a9cd3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=zbaAavwxznbo0OWEvbT4JulyumE%3D" alt="图片" loading="lazy"/></p>
<p>可以设置编辑器主题、字体、代码编辑行为、上下文管理等常用设置。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4451c7c84ef4016b48c2b18c88e390e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=LnbRee98tclIy%2FzsF0n%2BfcDAj%2FI%3D" alt="图片" loading="lazy"/></p>
<p>调试 OK 后，就可以一键部署，可以绑定自己的域名部署后，查看线上环境日志，还是很方便的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/939f0437c06f4818b834eb709521d2d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=BZlMkikMsbG6ij%2FBOZxbG7H9atM%3D" alt="图片" loading="lazy"/></p>
<p>除此之外，还有非常多的开发工具及集成服务可以使用的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9afb3b02f1e449aca09fc34ae317f362~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=VNI4N8yAoFmOYwVe76b6gvjyPr0%3D" alt="图片" loading="lazy"/></p>
<p>在做智能体开发的时候，有个点还是期望扣子后面能优化的，就是我想使用之前资源库中的工作流，让他去找，没办法找到并使用。</p>
<p>这要是打通了，就更方便了，直接就可以原地整活，把之前做的工作流智能体用扣子编程重新做更多好的应用出来。</p>
<p>在 vibe 应用的时候，一次输入的需求可以明确详细一些，第一版产出的效果就会好些，比如供应商管理系统我给的提示词是这样子的:</p>
<pre><code class="hljs language-swift" lang="swift">你是一位全栈工程师，同时精通产品规划和<span class="hljs-type">UI设计</span><span class="hljs-operator">。</span> 我想开发一个供应商后台管理系统，
<span class="hljs-number">1</span><span class="hljs-operator">、</span>思考用户需要供应商管理系统app实现哪些功能 
<span class="hljs-number">2</span><span class="hljs-operator">、</span>结合用户需求，以产品经理的视角去规划的功能<span class="hljs-operator">、</span>页面和交互； 
<span class="hljs-number">3</span><span class="hljs-operator">、</span>作为设计师思考这些原型界面的设计，并以设计师的视角去输出完整的<span class="hljs-type">UI</span><span class="hljs-operator">/</span><span class="hljs-type">UX；</span> 
<span class="hljs-number">4</span><span class="hljs-operator">、</span>可以使用<span class="hljs-type">FontAwesome等开源图标库，让界面显得更精美和接近真实</span> 
<span class="hljs-number">5</span><span class="hljs-operator">、</span>引入tailwindcss来完成，而不是变成style样式，图片使用unsplash 我希望这些界面是需要能直接拿去进行推广的<span class="hljs-operator">。</span>
</code></pre>
<p>然后通过多轮对话调整，指定能力和调试 bug，效果会更好一些。</p>
<h2 data-id="heading-0">最后聊聊</h2>
<p>说实话，看到扣子这次全面拥抱 Vibe Coding，我还是挺感慨的。</p>
<p>这不仅仅是一个功能的更新，更像是一种信号：</p>
<p><strong>应用开发的门槛，正在被 AI 以前所未有的速度拉平。</strong></p>
<p>扣子选择这条路，其实是在告诉我们：未来的编程，可能真的不需要写代码，而是需要懂逻辑。Vibe Coding 的核心，就是让技术服务于创意，而不是让技术成为创意的绊脚石。</p>
<p>对于我们普通用户来说，这无疑是最好的时代。你不需要精通 Python 或 Java，只需要清晰地知道自己想要什么，剩下的交给 AI 就好。</p>
<p>当然，任何新技术的普及都需要时间，现在的扣子编程或许还有提升空间，但它展示出的可能性已经足够让人兴奋。</p>
<p>我很期待看到大家用它做出什么好玩的东西。如果你也有点子，不妨去试一试，说不定下一个爆款应用，就出自你手。</p>
<p>大家对这次更新怎么看？欢迎在评论区和我交流。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Agents 智能体工作流的核心组成、模式、应用场景及案例]]></title>    <link>https://juejin.cn/post/7586893663075942410</link>    <guid>https://juejin.cn/post/7586893663075942410</guid>    <pubDate>2025-12-23T13:55:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586893663075942410" data-draft-id="7586865729703641126" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Agents 智能体工作流的核心组成、模式、应用场景及案例"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-12-23T13:55:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="智泊AI"/> <meta itemprop="url" content="https://juejin.cn/user/3572727470361578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Agents 智能体工作流的核心组成、模式、应用场景及案例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3572727470361578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    智泊AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T13:55:36.000Z" title="Tue Dec 23 2025 13:55:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如今，AI Agents（智能体）一词充斥于各类讨论之中，然而新兴技术的演进常伴生术语的模糊、预期的虚高，以及所谓“权威”所制造的迷雾。本文旨在穿透智能体领域泛滥的浮躁与包装，直指 Agentic AI 的本质核心：智能体工作流。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b426f3b680844d0a4a4af5709ba49bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767102936&amp;x-signature=4bCsl%2F5jarsgHxZzYxn29ifxq7k%3D" alt="图片" loading="lazy"/></p>
<p>仅靠智能体自身，所能执行的任务极为有限。它们必须依托清晰的角色定义、明确的目标导向，以及一套可落地的结构化执行路径——而这，正是“工作流”所承载的核心价值。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer"><strong>更多AI大模型学习视频及资源，都在智泊AI。</strong></a></p>
<p>唯有深入理解智能体工作流，方能真正洞悉AI智能体的运行机制与内在逻辑。本文将系统拆解AI智能体的关键构成要素，深入解析工作流的核心属性、典型范式、现实应用与典型实例，并全面梳理其带来的核心优势与现存挑战。</p>
<p><strong>一、AI智能体的核心组成</strong></p>
<p>AI智能体是一种以大语言模型（LLM）为核心驱动、通过工具与现实环境交互的系统，能够在极少人工介入的前提下执行复杂任务。</p>
<p>它被配置为承担特定角色，并拥有可调节的自主能力以实现预设目标，同时内置记忆机制，能够从历史交互中汲取经验，持续优化自身表现。虽然其设计目标是实现半自主运行，但这一能力的实现高度依赖于一个结构完备的组件体系。</p>
<p>该体系由三大支柱构成：支撑推理与决策的LLM、赋能任务执行的工具集，以及推动经验沉淀与响应优化的记忆模块。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec55ed75238c40c29cac5f2e4e38531b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767102936&amp;x-signature=%2BK3yTZzhJoI40cwOWj5j2kp7qMk%3D" alt="图片" loading="lazy"/></p>
<p><strong>1.推理能力（Reasoning）</strong></p>
<p>AI智能体的核心优势之一，体现在其迭代推理能力上，这一能力驱动其在问题解决全周期中持续进行主动思辨。该能力根植于底层的大型语言模型（LLM），并集中体现为两大核心职能：‌规划‌与‌反思‌。</p>
<p>‌规划阶段‌：智能体通过对任务进行系统性分解，将复杂目标拆解为一系列更细粒度、可执行的操作单元。这一机制不仅保障了任务处理的条理性，还支持智能体按需调用差异化的工具资源。</p>
<p>同时，该过程亦涵盖查询的精细化拆分，即将高复杂度的输入转化为多个低难度子查询，从而显著提升LLM输出的精准度与稳定性。</p>
<p>‌反思阶段‌：智能体依托对自身行动结果的回溯性分析开展推理。基于从外部数据源获取的反馈与信息，它能动态评估当前路径的有效性，并据此对后续行动计划进行迭代式优化与修正。</p>
<p><strong>2.工具（Tools）</strong></p>
<p>LLM的知识呈现静态化与参数化本质，其认知边界严格受限于训练阶段所编码的数据。为突破这一固有数据集的约束，智能体可通过集成外部工具——如网络搜索引擎、应用程序接口（API）、数据库及计算框架——实现能力拓展。</p>
<p>由此，智能体得以接入实时外部信息以支撑决策过程，并执行需协同多方应用的复杂任务。此类工具通常与特定权限体系紧密关联，下表列出了AI智能体的常见工具及其对应功能：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06864105fa2b487488dd9bcb9f69b1ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767102936&amp;x-signature=lKo7xtyDQr3eYfccxclIDk7wDhI%3D" alt="图片" loading="lazy"/></p>
<p>当大语言模型（LLM）为完成任务而选用外部工具时，这一过程被称为“函数调用”，从而突破纯文本生成的局限，实现与现实世界的交互。工具的启用方式可由终端用户事先设定，亦可交由智能体自主判断。</p>
<p>由智能体动态决策工具使用，能有效应对复杂任务场景；然而，在流程相对简单的场景中，这种动态性可能引入冗余开销，此时采用预设工具方案更为高效。</p>
<p><strong>3.记忆（Memory）</strong></p>
<p>从过往经验中习得并保留行动发生的上下文，构成了智能体工作流与纯LLM驱动工作流之间的核心差异。</p>
<p>记忆作为关键组件，使智能体能够在多次用户交互与会话中有效捕获并持久化上下文信息与反馈信号。智能体的记忆系统主要划分为两类：‌</p>
<p>短期记忆‌：用于暂存实时交互数据，例如对话历史，以辅助智能体动态规划下一步操作，从而推进整体目标的实现；‌</p>
<p>长期记忆‌：用于累积跨会话、随时间演进的知识与经验，推动智能体逐步实现个性化演进，并持续优化其长期表现。</p>
<p><strong>二、智能体工作流是什么？</strong></p>
<p>广义而言，工作流是一组为达成特定任务或目标而串联的关联性操作环节。基础形态的工作流具备确定性特征，即严格依照预设的步骤顺序执行，无法对新出现的信息或环境变动作出响应。</p>
<p>以自动化费用审批为例，其规则可表述为：“当费用类型标注为‘餐饮费’且金额小于50美元时，系统自动通过审批”。</p>
<p>部分工作流引入了大语言模型（LLM）或其他机器学习技术，此类流程通常被归类为AI工作流，并可细分为智能体工作流与非智能体工作流两类。在非智能体工作流中，LLM仅作为指令驱动的输出生成器，不参与决策闭环。</p>
<p>典型案例如文本摘要流程：输入原始长文→向LLM发出摘要指令→直接输出摘要内容。由此可知，即便嵌入了LLM，也不等同于构建了智能体工作流。</p>
<p>智能体工作流则由一个或多个智能体动态驱动，旨在实现既定目标的一连串交互式步骤。用户赋予智能体有限的自主权限，使其具备采集信息、执行动作与落地决策的能力。</p>
<p>此类工作流深度融合了AI智能体的三大核心能力：推理判断、工具调用与环境交互、以及持久化记忆机制，从而将传统静态流程革新为具备响应性、环境适应性与自我演进特性的动态系统。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9e25004e17345049bce04d33494e607~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767102936&amp;x-signature=aFlBtE7Ixn4IeXck4B2rdoZnWc0%3D" alt="图片" loading="lazy"/></p>
<p><strong>1.智能体工作流的核心特征</strong></p>
<p>当一个或多个智能体成为任务推进的核心驱动力时，AI工作流即展现出智能体特性。</p>
<p>在原有非智能体工作流中引入智能体，可构建混合型架构，融合结构化流程的稳定与可预期，同时保留大语言模型（LLM）的智能响应与动态适应能力。智能体工作流的三大核心机制如下：</p>
<p>‌制定计划‌：以规划为开端，LLM通过对复杂任务的层级拆解，生成细粒度子任务序列，并优选执行路径。</p>
<p>‌工具执行行动‌：依托预设的工具集合及其授权范围，智能体精准执行既定方案，完成目标任务。</p>
<p>‌反思与迭代‌：在每一步执行后，智能体自主评估输出结果，动态修正计划，通过多轮循环逼近最优解。</p>
<p>由此可明确划分三类工作流形态：传统非AI工作流、非智能体AI工作流、智能体AI工作流。</p>
<p>二者关键差异在于：传统规则驱动流程依赖固定步骤编排，而AI工作流由模型驱动完成任务；非智能体AI工作流使用静态模型执行预设逻辑，智能体AI工作流则采用具备自主决策能力的动态智能体。</p>
<p>正因如此，智能体工作流在响应变化与自我优化层面，显著优于非智能体形态。</p>
<p><strong>2.智能体架构与智能体工作流的区别</strong></p>
<p>任何新兴技术的兴起，往往伴随着大量新术语的涌现。尽管“智能体架构”与“智能体工作流”常被混为一谈，但二者在本质上存在明确分野。</p>
<p>‌智能体工作流‌，是指智能体为达成特定目标所循序执行的操作序列，涵盖：依托LLM规划行动路径、拆解子任务、调用互联网搜索等外部工具执行操作，以及通过LLM对执行结果进行反思并动态优化后续策略等关键环节。</p>
<p>‌智能体架构‌，则指支撑特定任务实现的底层技术框架与系统级设计方案。</p>
<p>其形态多样、结构灵活，但无论何种设计，均必须包含三大核心组件：具备自主决策与推理能力的智能体核心、可供调用的外部任务工具集，以及支撑上下文感知的短期与长期记忆系统。</p>
<p><strong>三、智能体工作流的核心模式</strong></p>
<p>智能体工作流是为完成特定目标而设计的结构化步骤序列。因此，探讨智能体工作流时，核心是分析使智能体能够实现其最终目标的特定行为模式。</p>
<p>如前所述，AI智能体的核心组件在这些模式中发挥着关键作用：智能体的推理能力促进了规划和反思模式，而它们使用工具与环境互动的能力则是工具使用模式的基础。</p>
<p><strong>1.规划模式（Planning Pattern</strong>* <em>）</em>*</p>
<p>规划模式使智能体能够自主将复杂任务拆解为一系列更小、更简单的子任务，即任务分解。这种模式能降低LLM的认知负荷、提升推理能力，并减少幻觉及其他不准确输出，从而优化结果质量。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7968f831c78b45969e36fa1c607050ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767102936&amp;x-signature=gQfmcdJmoj35z4QUrUZhjpG%2BvAY%3D" alt="图片" loading="lazy"/></p>
<p>当目标达成路径模糊、应对过程需动态调整时，规划模式展现出显著的适应性优势。以AI智能体接收“修复软件漏洞”指令为例，其会运用规划模式将任务分解为：阅读漏洞报告→定位相关代码段→列出潜在原因→选择特定调试策略。</p>
<p>若初次尝试未能成功，智能体能依据执行反馈信息动态优化后续策略。相较于固定流程的确定性工作流，规划模式在灵活性提升的同时，可能削弱输出结果的稳定性。</p>
<p>因此，该模式更契合对复杂推理与多阶段分析有深度需求的场景。</p>
<p><strong>2.工具使用模式（Tool Use Pattern）</strong></p>
<p>生成式LLM的核心短板在于其完全依赖预训练数据，既无法接入实时信息，也无法校验超出训练范围的事实，因而极易产出错误内容或对未知问题进行主观臆测。</p>
<p>检索增强生成（RAG）通过引入关联的实时外部数据，为LLM提供动态上下文支撑，显著增强了响应的准确度与语境契合度。</p>
<p>而工具使用模式则进一步突破了传统RAG的边界，使LLM能够与现实环境进行动态交互，而非局限于被动检索外部数据源。</p>
<p>在智能体工作流中，该模式通过驱动智能体调用外部工具、应用程序、实时数据流及其他计算服务，全方位延展了其功能边界与行动能力。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1758ce0f3ab944bbbc54d41d4826a018~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767102936&amp;x-signature=A3tvQuX%2FTUpLphqBoHzgX8J29Ew%3D" alt="图片" loading="lazy"/></p>
<p>常见工具包括API、信息检索工具（如向量搜索）、网页浏览器、机器学习模型及代码解释器等。这些工具用于执行特定任务，如网页搜索、从外部数据库提取数据或收发邮件，助力智能体达成目标。</p>
<p><strong>3.反思模式（Reflection Pattern）</strong></p>
<p>反思模式是一种简单却高效的智能体设计模式，能显著提升智能体工作流的性能。</p>
<p>它是智能体的自我反馈机制：在输出最终结果或采取进一步行动前，智能体会迭代评估自身输出或决策的质量，通过自我批判优化方法、修正错误，并提升后续响应与决策的准确性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf606598fbdb4ced91afa035b83d6834~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767102936&amp;x-signature=Ynxl6sGIsLKxRiORrPG4KOBb9is%3D" alt="图片" loading="lazy"/></p>
<p>当智能体在初次执行任务时遭遇失败，反思模式的作用便得到充分彰显——以代码生成为例：智能体产出代码片段后，于沙箱或执行环境中运行，将捕获的错误信息循环反馈至LLM，直至代码顺利运行。</p>
<p>该模式的核心竞争力在于，智能体能自主开展批判性分析，并将提炼的洞察实时嵌入执行流程，全程无需人工介入即可达成渐进式改进。</p>
<p>此类反思所得可持久化存入记忆模块，不仅加速当前对话中的问题收敛，更能依据用户偏好进行动态适配，从而显著增强后续交互的个性化与效能。</p>
<p><strong>四、智能体工作流的应用场景</strong></p>
<p>规划与工具使用等核心设计模式，经由灵活的组合运用，可驱动智能体工作流在多元领域中实现广泛适配。</p>
<p>除模式的重组外，还可通过为AI智能体定制差异化工具集、授权其动态选择工具的权限，或嵌入人工反馈机制、动态调节自主决策层级，进一步拓展其应用弹性。</p>
<p>此类多维度的配置策略，使智能体工作流能够精准契合各行业多样化任务需求。后续将聚焦阐述三大高价值应用场景：Agentic RAG、智能研究助手及智能编码助手。</p>
<p><strong>1.Agentic RAG</strong></p>
<p>‌RAG‌ 是一种借助外部数据源检索相关信息，从而为大语言模型（LLM）扩充知识的架构。</p>
<p>‌智能体RAG‌ 则在该流程中嵌入一个或多个智能体，以增强系统能力。</p>
<p>在‌规划阶段‌，智能体可运用‌查询分解‌，将复杂请求拆解为若干子任务，或判断是否需向用户追问以明确意图。</p>
<p>‌AI智能体‌ 同时承担对检索结果与生成响应的‌相关性‌与‌准确性‌评估职责，确认无误后才交付用户。</p>
<p>若输出未达预期，智能体将触发迭代机制：重拟查询、回溯至‌查询分解‌环节，或重构整体响应策略。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bb7f23ce5414bc681b3616722ea1cda~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767102936&amp;x-signature=je63p07%2F5A2gyIKnlIQI8KwRf4A%3D" alt="图片" loading="lazy"/></p>
<p><strong>2.智能研究助手（Agentic Research Assistants）</strong></p>
<p>智能研究助手（部分AI企业称之为“DeepResearch”）依托网络与多元外部数据源，针对复杂议题生成深度分析报告与细致洞察。此类工具基于智能体RAG架构，响应用户查询时主动从互联网及其他外部渠道获取信息。</p>
<p>与传统RAG机制不同，智能研究助手不仅通过检索外部数据优化大语言模型的输出，更能对多源信息进行整合与深度分析。</p>
<p>这一能力由三大关键特征支撑：</p>
<p>其一，其底层大语言模型经过网页浏览、任务拆解与动态规划的专项训练；</p>
<p>其二，工作流中的智能体主动向用户发起交互，通过提问补充细节或澄清意图，以更精准地对齐最终目标；</p>
<p>其三，智能体可依据新获取的信息动态修正执行路径，灵活拓展分析维度，或持续调用多个数据源，直至达成完整信息闭环。</p>
<p>正因如此，智能研究助手能够提炼深层洞察、捕捉长期演化趋势、构建系统性专题报告，超越了单纯的知识检索范畴。</p>
<p>截至本文撰写时，OpenAI、Perplexity及谷歌均已上线公开的深度研究型工具。</p>
<p><strong>3.智能编码助手（Agentic Coding Assistants）</strong></p>
<p>智能体编码助手能够在极低的人力干预下完成代码的生成、重构、优化与调试。与之相对，非智能体编码助手（例如GitHub Copilot的早期版本）依赖于经过微调的生成式LLM，其功能仅止步于代码的初步产出。</p>
<p>真正赋予编码助手“智能体”属性的，是其与运行环境的动态交互能力：它能执行自身生成的代码，依据执行反馈、异常信息或用户意见进行多轮迭代与修正。</p>
<p>此类助手还可被授权直接对代码库执行提交操作、发起拉取请求（PR），实现开发流程的自动化闭环（如Anthropic的Claude Code），标志着软件开发自动化的关键跃迁。</p>
<p>同时，智能体编码助手能够提议终端指令及其他代码增补方案，并在执行前强制请求人工确认（如Cursor的Agent），确保人类对变更拥有最终决策权。</p>
<p>尤为关键的是，它能将过往的错误模式编码进长期记忆，实现持续自我进化，随时间推移不断提升智能水平。</p>
<p><strong>五、智能体工作流实例</strong></p>
<p>前文介绍了智能体工作流的应用场景，下文将通过Claygent和ServiceNow AI智能体两个真实案例，详细拆解其工作流程。</p>
<p>这两个案例中的工作流采用了独特的模式与工具组合，赋予智能体不同程度的自主权与决策权，并依赖不同的人工反馈机制。</p>
<p><strong>1.Claygent（Clay公司）</strong></p>
<p>对于增长与销售团队而言，挖掘潜在客户并完成数据补全往往耗时耗力。Clay公司推出的AI驱动研究智能体Claygent，正是为破解这一难题而生——它能持续爬取网络与内部数据源，实时输出可直接落地的洞察。</p>
<p>若你希望基于姓名与邮箱列表，自动补全LinkedIn个人资料并生成定制化邀约信息，流程如下：</p>
<p>‌第一步‌：明确所需提取的数据维度（如职业经历、教育履历、核心技能），并将这些字段嵌入预设的提示模板；</p>
<p>‌第二步‌：Claygent的LLM接收指令，联动网络爬虫工具定位目标LinkedIn链接，精准抓取个人资料中的关键内容；</p>
<p>‌第三步‌：提取后的数据被传递至另一LLM，由你自由定义其分析逻辑——无论是归纳、分类还是趋势提炼，均可按需配置；</p>
<p>‌第四步‌：同一或另一LLM随即基于 enriched 数据，为每位目标用户生成高度个性化的推广文案。</p>
<p>Claygent正是这样一个可塑性强的智能体工作流范本：它在保留预配置提示模板对任务边界约束的同时，赋予用户极大的创造性空间，实现精准与灵活的动态平衡。</p>
<p><strong>2.ServiceNow AI智能体</strong></p>
<p>ServiceNow 是一个云端平台，旨在优化与自动化跨 IT、运营、人力资源及客户服务等多个职能领域的工作流程。</p>
<p>其 ServiceNow Platform 已集成对 AI 智能体的接入能力，目标是推动重复性任务与既有流程的自动化，同时确保人类始终保有最终决策权。</p>
<p>以下为一个智能体工作流在处理技术支持案例中的应用示例：当终端用户提交技术支持工单后，自动化流程随即启动。</p>
<p>工单所含信息被分发至一个或多个 AI 智能体，这些智能体基于企业内部 IT 支持知识库执行 RAG 操作。它们综合检索结果、比对历史相似案例，并为一线 IT 支持人员生成精炼摘要。</p>
<p>最终，智能体输出处置建议，由专家审阅并决定是否采纳。ServiceNow AI Agents 体现了一种在生产环境中部署智能体的创新范式。</p>
<p>既保持审慎，又赋予其清晰界定的角色、限定任务范围，以及对影响最终用户或客户决策的有限自主权限。</p>
<p><strong>六、智能体工作流的优势与局限</strong></p>
<p>智能体已从机器学习领域快速渗透至主流应用场景，伴随而来的是诸多兴奋、期待与过高预期。</p>
<p>要客观认知其价值，需拨开炒作迷雾，明确其真实能力与局限。下文将从优势、挑战与局限三方面展开分析。</p>
<p><strong>1.智能体工作流的优势</strong></p>
<p>智能体工作流突破了传统自动化固有的边界，赋予AI智能体规划、调适与持续进化的内在能力。</p>
<p>区别于依赖预设规则的确定性流程，智能体工作流能够实时响应动态环境，借助反馈机制迭代方案，从而驾驭更高阶的任务需求。</p>
<p>这种动态适应特性，使其在强调灵活应变、自主学习与智能决策的场景中展现出独特优势，具体体现为：</p>
<p>‌灵活性、适应性与可定制性‌：传统静态工作流在面对环境变化或突发状况时往往捉襟见肘，而智能体工作流能依据任务复杂度动态调整执行策略，确保始终输出高效且适配的解决方案。</p>
<p>通过模块化整合多种能力单元，该工作流支持灵活拼装，可随应用场景的深化持续演进与升级。</p>
<p>‌复杂任务处理能力提升‌：依托任务拆解与多步规划机制，智能体工作流在应对复杂任务时的表现显著优于传统“零样本”确定性方法。</p>
<p>‌自我修正与持续学习‌：引入反思机制后，智能体工作流可对自身决策过程进行评估，主动优化策略路径，从而稳步提升输出质量。</p>
<p>融合短期记忆与长期经验存储，系统能从历史交互中汲取知识，逐步增强运行效率，并实现个体化行为适配。</p>
<p>‌运营效率与可扩展性优化‌：在合理架构下，智能体工作流可精准自动化高频重复操作，显著降低人力依赖与运营开销。</p>
<p>同时，其架构天然具备良好的横向扩展能力，可无缝支撑更大规模的任务负载与更复杂的系统集成。</p>
<p><strong>2.智能体工作流的挑战与局限</strong></p>
<p>尽管AI智能体展现出显著的创新潜力与多重优势，其应用仍面临诸多现实挑战与内在局限。</p>
<p>受其概率性本质影响，智能体的引入必然抬升工作流的复杂程度。需清醒认识到：“能够自动化”并不等同于“应当自动化”。</p>
<p>在评估是否采纳智能体驱动的工作流时，必须审慎权衡以下关键限制：</p>
<p>‌简单任务的冗余复杂性‌：针对表单填写、基础数据提取等结构化程度高、规则明确的流程，部署AI智能体反而会引入不必要的资源消耗。</p>
<p>若传统确定性规则系统已能精准完成任务，启用智能体不仅无益，更可能引发效率滑坡、成本攀升乃至系统性能退化。</p>
<p>‌自主权提升导致可靠性降低‌：随着智能体在流程中决策权限的扩大，其概率性输出所伴随的不确定性亦同步加剧，致使结果的稳定性与可控性显著削弱。</p>
<p>为此，必须为智能体构建清晰的边界约束，并实施持续的权限审计与行为监控。</p>
<p>‌伦理与实践考量‌：并非所有决策场景均适配AI系统的介入。</p>
<p>在涉及高风险或高度敏感的领域部署智能体时，必须建立严格的监管框架，确保其运行符合合规要求，并有效防范潜在的伦理与操作风险。</p>
<p>基于上述限制，建议在引入智能体前，系统性地回应以下核心问题以评估其必要性：</p>
<p>该任务是否复杂至需依赖自适应决策？</p>
<p>现有确定性方案是否已充分覆盖需求？</p>
<p>更轻量的AI辅助工具（如无智能体的RAG）能否达成同等效果？</p>
<p>工作流是否蕴含不确定性、动态环境或多步推理，且智能体具备更优处理能力？</p>
<p>赋予智能体自主权将带来哪些具体风险？</p>
<p>这些风险是否具备可落地的缓解路径？</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer"><strong>更多AI大模型学习视频及资源，都在智泊AI。</strong></a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手写一个 Askama 模板压缩工具]]></title>    <link>https://juejin.cn/post/7586872817876074522</link>    <guid>https://juejin.cn/post/7586872817876074522</guid>    <pubDate>2025-12-23T13:56:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586872817876074522" data-draft-id="7586877892467916827" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手写一个 Askama 模板压缩工具"/> <meta itemprop="keywords" content="性能优化,Rust,前端"/> <meta itemprop="datePublished" content="2025-12-23T13:56:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="jump_jump"/> <meta itemprop="url" content="https://juejin.cn/user/4230576474692765"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手写一个 Askama 模板压缩工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4230576474692765/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    jump_jump
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T13:56:07.000Z" title="Tue Dec 23 2025 13:56:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Web 开发中，前端资源的大小直接影响用户体验。大型模板文件不仅占用带宽，还会延长页面加载时间。虽然市面上有很多 HTML 压缩工具，但对于使用了模板引擎的 HTML 文件（如 Askama、Jinja2 等），通用压缩器往往会破坏模板语法。</p>
<p>于是个人写了一个 Askama 模板压缩工具 askama-minify，专门用于压缩 Askama 模板文件，同时完美保留模板语法。</p>
<h2 data-id="heading-0">Askama 为什么要压缩</h2>
<h3 data-id="heading-1">模板文件占用的空间</h3>
<p>在实际的 Web 项目中，模板文件往往占据相当大的体积：</p>





























<table><thead><tr><th>项目类型</th><th>模板数量</th><th>总大小</th><th>压缩后大小</th></tr></thead><tbody><tr><td>小型网站</td><td>10-20</td><td>200-500KB</td><td>100-250KB</td></tr><tr><td>中型应用</td><td>50-100</td><td>1-3MB</td><td>500KB-1.5MB</td></tr><tr><td>大型系统</td><td>200+</td><td>5-10MB</td><td>2-5MB</td></tr></tbody></table>
<h3 data-id="heading-2">压缩的好处</h3>
<ol>
<li><strong>减少带宽消耗</strong>：模板大小减少 40-55%，直接降低流量成本</li>
<li><strong>加快页面加载</strong>：更小的文件意味着更快的传输速度</li>
<li><strong>提升用户体验</strong>：首屏渲染时间缩短，特别是移动端用户</li>
<li><strong>降低服务器负载</strong>：传输数据量减少，服务器压力降低</li>
<li><strong>节省存储空间</strong>：生产环境的模板文件占用更少空间</li>
</ol>
<h3 data-id="heading-3">Askama 自带的压缩配置</h3>
<p>Askama 本身提供了 whitespace 控制功能，在项目根目录的 <code>askama.toml</code> 中配置：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-section">[general]</span>
<span class="hljs-comment"># 三种模式可选</span>
<span class="hljs-attr">whitespace</span> = <span class="hljs-string">"suppress"</span>   <span class="hljs-comment"># 或 "minimize" / "preserve"</span>
</code></pre>
<p><strong>三种模式对比：</strong></p>

























<table><thead><tr><th>模式</th><th>行为</th><th>适用场景</th></tr></thead><tbody><tr><td><code>preserve</code></td><td>保留所有空白（默认）</td><td>开发调试</td></tr><tr><td><code>suppress</code></td><td>激进移除空白</td><td>生产环境</td></tr><tr><td><code>minimize</code></td><td>适度移除空白</td><td>平衡模式</td></tr></tbody></table>
<p>也可以在单个模板上覆盖：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[derive(Template)]</span>
<span class="hljs-meta">#[template(path = <span class="hljs-string">"example.html"</span>, whitespace = <span class="hljs-string">"suppress"</span>)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ExampleTemplate</span>;
</code></pre>
<h3 data-id="heading-4">Askama 自带压缩的局限性</h3>
<p>Askama 的 whitespace 控制有以下限制：</p>
<ol>
<li><strong>只处理空白字符</strong>：不能移除 HTML 注释 <code>&lt;!-- --&gt;</code></li>
<li><strong>不影响 CSS</strong>：<code>&lt;style&gt;</code> 标签内的 CSS 完全保留</li>
<li><strong>不影响 JavaScript</strong>：<code>&lt;script&gt;</code> 标签内的 JS 完全保留</li>
<li><strong>不优化代码</strong>：无法进行属性合并、颜色优化等</li>
</ol>
<p><strong>示例对比：</strong></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 原始模板 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-tag">body</span> {
        <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">0</span>;
        <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">0</span>;
        <span class="hljs-comment">/* 这是 CSS 注释 */</span>
        <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ff0000</span>;
    }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// 这是 JS 注释</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Hello"</span>);
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- Askama whitespace = "suppress" 的结果 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css"><span class="hljs-selector-tag">body</span>{<span class="hljs-attribute">margin-top</span>:<span class="hljs-number">0</span>;<span class="hljs-attribute">margin-bottom</span>:<span class="hljs-number">0</span>;<span class="hljs-comment">/*这是CSS注释*/</span><span class="hljs-attribute">background-color</span>:<span class="hljs-number">#ff0000</span>;}</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript"><span class="hljs-comment">//这是JS注释</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Hello"</span>);</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- askama-minify 的结果 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css"><span class="hljs-selector-tag">body</span>{<span class="hljs-attribute">margin</span>:<span class="hljs-number">0</span> <span class="hljs-number">0</span>;<span class="hljs-attribute">background-color</span>:red}</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Hello"</span>);</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>可以看到，askama-minify 做得更彻底：</p>
<ul>
<li>移除了所有注释</li>
<li>合并了 CSS 属性</li>
<li>优化了颜色值</li>
<li>压缩了 JavaScript</li>
</ul>
<h2 data-id="heading-5">项目演进</h2>
<p>任何项目都不是一蹴而就的，下面是关于 askama-minify 库的编写思路。希望能对大家有一些帮助。</p>
<h2 data-id="heading-6">为什么需要专门的工具（补充）</h2>
<p>在使用 Askama 这样的 Rust 模板引擎时，我们的模板文件中会包含特殊的语法：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- Askama 模板语法 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{{ title }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
{% for item in items %}
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ item.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
{% endfor %}
</code></pre>
<p>通用的 HTML 压缩器（如 html-minifier）可能会：</p>
<ul>
<li>将 <code>{{ }}</code> 识别为无效语法而破坏</li>
<li>将 <code>{% %}</code> 中的空格错误处理</li>
<li>无法区分模板语法和普通文本</li>
</ul>
<p>因此我们需要一个专门设计的压缩工具。</p>
<h2 data-id="heading-7">简单的 HTML 压缩</h2>
<p>最基础的 HTML 压缩非常简单：移除多余的空白字符即可。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">minify_html_simple</span>(content: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">result</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">with_capacity</span>(content.<span class="hljs-title function_ invoke__">len</span>());
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">last_was_space</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">for</span> <span class="hljs-variable">ch</span> <span class="hljs-keyword">in</span> content.<span class="hljs-title function_ invoke__">chars</span>() {
        <span class="hljs-keyword">if</span> ch.<span class="hljs-title function_ invoke__">is_whitespace</span>() {
            <span class="hljs-keyword">if</span> !last_was_space &amp;&amp; !result.<span class="hljs-title function_ invoke__">is_empty</span>() {
                result.<span class="hljs-title function_ invoke__">push</span>(<span class="hljs-string">' '</span>);
                last_was_space = <span class="hljs-literal">true</span>;
            }
        } <span class="hljs-keyword">else</span> {
            result.<span class="hljs-title function_ invoke__">push</span>(ch);
            last_was_space = <span class="hljs-literal">false</span>;
        }
    }

    result
}
</code></pre>
<p>这个简单版本会将：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>   Hello   <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>压缩为：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span> Hello <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>但这样还不够——我们需要：</p>
<ol>
<li>移除 HTML 注释</li>
<li>处理特殊标签（<code>&lt;pre&gt;</code>, <code>&lt;textarea&gt;</code>）</li>
<li>保留模板语法</li>
</ol>
<h2 data-id="heading-8">保留模板语法</h2>
<p>模板语法的保留是本工具的核心。我们需要在遇到 <code>{{</code> 和 <code>{%</code> 时，保持原样输出，直到遇到对应的 <code>}}</code> 和 <code>%}</code>。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">minify_html</span>(content: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">result</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">with_capacity</span>(content.<span class="hljs-title function_ invoke__">len</span>());
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">chars</span> = content.<span class="hljs-title function_ invoke__">chars</span>().<span class="hljs-title function_ invoke__">peekable</span>();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">in_template_brace</span> = <span class="hljs-literal">false</span>;  <span class="hljs-comment">// {{ }}</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">in_template_chevron</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// {% %}</span>

    <span class="hljs-keyword">while</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Some</span>(ch) = chars.<span class="hljs-title function_ invoke__">next</span>() {
        <span class="hljs-comment">// 检测模板语法开始</span>
        <span class="hljs-keyword">if</span> ch == <span class="hljs-string">'{'</span> {
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Some</span>(&amp;next_ch) = chars.<span class="hljs-title function_ invoke__">peek</span>() {
                <span class="hljs-keyword">if</span> next_ch == <span class="hljs-string">'{'</span> {
                    in_template_brace = <span class="hljs-literal">true</span>;
                    result.<span class="hljs-title function_ invoke__">push</span>(ch);
                    <span class="hljs-keyword">continue</span>;
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> next_ch == <span class="hljs-string">'%'</span> {
                    in_template_chevron = <span class="hljs-literal">true</span>;
                    result.<span class="hljs-title function_ invoke__">push</span>(ch);
                    <span class="hljs-keyword">continue</span>;
                }
            }
        }

        <span class="hljs-comment">// 在模板语法内，保持原样</span>
        <span class="hljs-keyword">if</span> in_template_brace || in_template_chevron {
            result.<span class="hljs-title function_ invoke__">push</span>(ch);
            <span class="hljs-comment">// 检测模板语法结束</span>
            <span class="hljs-keyword">if</span> in_template_brace &amp;&amp; ch == <span class="hljs-string">'}'</span> &amp;&amp; result.<span class="hljs-title function_ invoke__">ends_with</span>(<span class="hljs-string">"}}"</span>) {
                in_template_brace = <span class="hljs-literal">false</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> in_template_chevron &amp;&amp; ch == <span class="hljs-string">'}'</span> &amp;&amp; result.<span class="hljs-title function_ invoke__">ends_with</span>(<span class="hljs-string">"%}"</span>) {
                in_template_chevron = <span class="hljs-literal">false</span>;
            }
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-comment">// ... 其他处理逻辑</span>
    }

    result
}
</code></pre>
<p>测试一下：</p>
<pre><code class="hljs language-javascript" lang="javascript">输入: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{{ title }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
输出: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{{ title }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>  <span class="hljs-comment">// 完美保留</span>

输入: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>  {{  title  }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
输出: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span> {{ title }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>  <span class="hljs-comment">// 模板外空格压缩，模板内保留</span>
</code></pre>
<h2 data-id="heading-9">移除 HTML 注释</h2>
<p>HTML 注释的移除需要小心，不能破坏字符串中的 <code>&lt;!--</code>：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// HTML 注释处理（只在不在 script/style 内时处理）</span>
<span class="hljs-keyword">if</span> !in_script &amp;&amp; !in_style &amp;&amp; ch == <span class="hljs-string">'&lt;'</span> &amp;&amp; chars.<span class="hljs-title function_ invoke__">peek</span>() == <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-string">'!'</span>) {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">comment</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"&lt;"</span>);
    comment.<span class="hljs-title function_ invoke__">push</span>(chars.<span class="hljs-title function_ invoke__">next</span>().<span class="hljs-title function_ invoke__">unwrap</span>()); <span class="hljs-comment">// '!'</span>

    <span class="hljs-keyword">if</span> chars.<span class="hljs-title function_ invoke__">peek</span>() == <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-string">'-'</span>) {
        comment.<span class="hljs-title function_ invoke__">push</span>(chars.<span class="hljs-title function_ invoke__">next</span>().<span class="hljs-title function_ invoke__">unwrap</span>()); <span class="hljs-comment">// first '-'</span>
        <span class="hljs-keyword">if</span> chars.<span class="hljs-title function_ invoke__">peek</span>() == <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-string">'-'</span>) {
            comment.<span class="hljs-title function_ invoke__">push</span>(chars.<span class="hljs-title function_ invoke__">next</span>().<span class="hljs-title function_ invoke__">unwrap</span>()); <span class="hljs-comment">// second '-'</span>
            <span class="hljs-comment">// 这是一个注释，跳过直到 --&gt;</span>
            <span class="hljs-keyword">while</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Some</span>(c) = chars.<span class="hljs-title function_ invoke__">next</span>() {
                comment.<span class="hljs-title function_ invoke__">push</span>(c);
                <span class="hljs-keyword">if</span> comment.<span class="hljs-title function_ invoke__">ends_with</span>(<span class="hljs-string">"--&gt;"</span>) {
                    <span class="hljs-keyword">break</span>;
                }
            }
            <span class="hljs-keyword">continue</span>; <span class="hljs-comment">// 跳过注释</span>
        }
    }
    result.<span class="hljs-title function_ invoke__">push_str</span>(&amp;comment);
    <span class="hljs-keyword">continue</span>;
}
</code></pre>
<h2 data-id="heading-10">处理特殊标签</h2>
<p>某些标签（如 <code>&lt;pre&gt;</code> 和 <code>&lt;textarea&gt;</code>）的内容需要完全保留原样，包括空格和换行：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">in_pre</span> = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">in_textarea</span> = <span class="hljs-literal">false</span>;

<span class="hljs-comment">// 在标签检测时</span>
<span class="hljs-keyword">if</span> tag_name == <span class="hljs-string">"pre"</span> {
    in_pre = <span class="hljs-literal">true</span>;
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> tag_name == <span class="hljs-string">"textarea"</span> {
    in_textarea = <span class="hljs-literal">true</span>;
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> tag_name == <span class="hljs-string">"/pre"</span> {
    in_pre = <span class="hljs-literal">false</span>;
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> tag_name == <span class="hljs-string">"/textarea"</span> {
    in_textarea = <span class="hljs-literal">false</span>;
}

<span class="hljs-comment">// 在字符处理时</span>
<span class="hljs-keyword">if</span> in_pre || in_textarea {
    result.<span class="hljs-title function_ invoke__">push</span>(ch);  <span class="hljs-comment">// 完全保留</span>
    <span class="hljs-keyword">continue</span>;
}
</code></pre>
<h2 data-id="heading-11">添加 CSS 优化</h2>
<p>HTML 中的 <code>&lt;style&gt;</code> 标签内容可以使用专业的 CSS 优化器。这里选择 lightningcss，它是 Parcel 团队开发的高性能 CSS 解析器：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> lightningcss::stylesheet::{MinifyOptions, ParserOptions, PrinterOptions, StyleSheet};

<span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">minify_css</span>(css_code: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">stylesheet</span> = StyleSheet::<span class="hljs-title function_ invoke__">parse</span>(css_code, ParserOptions::<span class="hljs-title function_ invoke__">default</span>());

    <span class="hljs-keyword">match</span> stylesheet {
        <span class="hljs-title function_ invoke__">Ok</span>(<span class="hljs-keyword">mut</span> sheet) =&gt; {
            sheet.<span class="hljs-title function_ invoke__">minify</span>(MinifyOptions::<span class="hljs-title function_ invoke__">default</span>()).<span class="hljs-title function_ invoke__">ok</span>();
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">result</span> = sheet.<span class="hljs-title function_ invoke__">to_css</span>(PrinterOptions {
                minify: <span class="hljs-literal">true</span>,
                ..PrinterOptions::<span class="hljs-title function_ invoke__">default</span>()
            });

            <span class="hljs-keyword">match</span> result {
                <span class="hljs-title function_ invoke__">Ok</span>(output) =&gt; output.code,
                <span class="hljs-title function_ invoke__">Err</span>(e) =&gt; {
                    eprintln!(<span class="hljs-string">"Warning: Failed to minify CSS: {:?}"</span>, e);
                    css_code.<span class="hljs-title function_ invoke__">to_string</span>()
                },
            }
        }
        <span class="hljs-title function_ invoke__">Err</span>(e) =&gt; {
            eprintln!(<span class="hljs-string">"Warning: Failed to parse CSS: {:?}"</span>, e);
            css_code.<span class="hljs-title function_ invoke__">to_string</span>()
        },
    }
}
</code></pre>
<p>lightningcss 的优化效果非常好：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 输入 */</span>
<span class="hljs-selector-tag">body</span> {
    <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ff0000</span>;
}

<span class="hljs-comment">/* 输出 */</span>
<span class="hljs-selector-tag">body</span>{<span class="hljs-attribute">margin</span>:<span class="hljs-number">0</span> <span class="hljs-number">0</span>;<span class="hljs-attribute">background-color</span>:red}
</code></pre>
<ul>
<li>属性合并：<code>margin-top: 0; margin-bottom: 0</code> → <code>margin: 0 0</code></li>
<li>颜色优化：<code>#ff0000</code> → <code>red</code></li>
<li>移除所有不必要的空格和换行</li>
</ul>
<h2 data-id="heading-12">添加 JavaScript 压缩</h2>
<p>JavaScript 的压缩需要更加小心，因为：</p>
<ol>
<li>字符串中的注释语法不应被处理</li>
<li>除法运算符 <code>/</code> 容易与注释混淆</li>
<li>转义字符需要正确处理（<code>\"</code>, <code>\'</code>）</li>
<li>正则表达式需要保护</li>
</ol>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">minify_js</span>(js_code: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">result</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">with_capacity</span>(js_code.<span class="hljs-title function_ invoke__">len</span>());
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">chars</span> = js_code.<span class="hljs-title function_ invoke__">chars</span>().<span class="hljs-title function_ invoke__">peekable</span>();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">in_string</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">in_single_comment</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">in_multi_comment</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">string_char</span> = <span class="hljs-string">'\0'</span>;

    <span class="hljs-keyword">while</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Some</span>(ch) = chars.<span class="hljs-title function_ invoke__">next</span>() {
        <span class="hljs-comment">// 处理单行注释</span>
        <span class="hljs-keyword">if</span> !in_string &amp;&amp; !in_multi_comment &amp;&amp; ch == <span class="hljs-string">'/'</span> &amp;&amp; chars.<span class="hljs-title function_ invoke__">peek</span>() == <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-string">'/'</span>) {
            in_single_comment = <span class="hljs-literal">true</span>;
            chars.<span class="hljs-title function_ invoke__">next</span>(); <span class="hljs-comment">// 跳过第二个 /</span>
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-keyword">if</span> in_single_comment {
            <span class="hljs-keyword">if</span> ch == <span class="hljs-string">'\n'</span> {
                in_single_comment = <span class="hljs-literal">false</span>;
            }
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-comment">// 处理多行注释</span>
        <span class="hljs-keyword">if</span> !in_string &amp;&amp; !in_single_comment &amp;&amp; ch == <span class="hljs-string">'/'</span> &amp;&amp; chars.<span class="hljs-title function_ invoke__">peek</span>() == <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-string">'*'</span>) {
            in_multi_comment = <span class="hljs-literal">true</span>;
            chars.<span class="hljs-title function_ invoke__">next</span>(); <span class="hljs-comment">// 跳过 *</span>
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-keyword">if</span> in_multi_comment {
            <span class="hljs-keyword">if</span> ch == <span class="hljs-string">'*'</span> &amp;&amp; chars.<span class="hljs-title function_ invoke__">peek</span>() == <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-string">'/'</span>) {
                in_multi_comment = <span class="hljs-literal">false</span>;
                chars.<span class="hljs-title function_ invoke__">next</span>(); <span class="hljs-comment">// 跳过 /</span>
            }
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-comment">// 处理字符串</span>
        <span class="hljs-keyword">if</span> ch == <span class="hljs-string">'"'</span> || ch == <span class="hljs-string">'\''</span> || ch == <span class="hljs-string">'`'</span> {
            <span class="hljs-keyword">if</span> !in_string {
                in_string = <span class="hljs-literal">true</span>;
                string_char = ch;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ch == string_char {
                <span class="hljs-comment">// 检查是否被转义：计算前面的反斜杠数量</span>
                <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">backslash_count</span> = <span class="hljs-number">0</span>;
                <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">temp_result</span> = result.<span class="hljs-title function_ invoke__">clone</span>();
                <span class="hljs-keyword">while</span> temp_result.<span class="hljs-title function_ invoke__">ends_with</span>(<span class="hljs-string">'\\'</span>) {
                    backslash_count += <span class="hljs-number">1</span>;
                    temp_result.<span class="hljs-title function_ invoke__">pop</span>();
                }
                <span class="hljs-comment">// 偶数个反斜杠（包括0个）意味着引号没有被转义</span>
                <span class="hljs-keyword">if</span> backslash_count % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> {
                    in_string = <span class="hljs-literal">false</span>;
                }
            }
            result.<span class="hljs-title function_ invoke__">push</span>(ch);
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-keyword">if</span> in_string {
            result.<span class="hljs-title function_ invoke__">push</span>(ch);
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-comment">// 压缩空白（保留必要的空格）</span>
        <span class="hljs-comment">// ...</span>
    }

    result
}
</code></pre>
<p>测试转义字符处理：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 输入</span>
<span class="hljs-keyword">let</span> s = <span class="hljs-string">"test\\"</span>;  <span class="hljs-comment">// 字符串中有转义的反斜杠</span>
<span class="hljs-keyword">let</span> s2 = <span class="hljs-string">'quote\''</span>;

<span class="hljs-comment">// 输出</span>
<span class="hljs-keyword">let</span> s=<span class="hljs-string">"test\\"</span>;   <span class="hljs-comment">// 正确保留转义字符</span>
<span class="hljs-keyword">let</span> s2=<span class="hljs-string">'quote\''</span>;  <span class="hljs-comment">// 正确保留转义字符</span>
</code></pre>
<h2 data-id="heading-13">整合三层压缩</h2>
<p>将 HTML、CSS、JS 压缩整合在一起，在解析 HTML 时识别 <code>&lt;script&gt;</code> 和 <code>&lt;style&gt;</code> 标签：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">minify_html</span>(content: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">in_script</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">in_style</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">script_content</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">new</span>();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">style_content</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">new</span>();

    <span class="hljs-keyword">while</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Some</span>(ch) = chars.<span class="hljs-title function_ invoke__">next</span>() {
        <span class="hljs-comment">// 标签处理</span>
        <span class="hljs-keyword">if</span> ch == <span class="hljs-string">'&lt;'</span> {
            <span class="hljs-comment">// ... 读取标签名</span>

            <span class="hljs-keyword">if</span> tag_name == <span class="hljs-string">"script"</span> {
                in_script = <span class="hljs-literal">true</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> tag_name == <span class="hljs-string">"/script"</span> {
                <span class="hljs-comment">// 压缩并输出 script 内容</span>
                <span class="hljs-keyword">if</span> !script_content.<span class="hljs-title function_ invoke__">trim</span>().<span class="hljs-title function_ invoke__">is_empty</span>() {
                    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">minified</span> = <span class="hljs-title function_ invoke__">minify_js</span>(&amp;script_content);
                    result.<span class="hljs-title function_ invoke__">push_str</span>(&amp;minified);
                }
                script_content.<span class="hljs-title function_ invoke__">clear</span>();
                in_script = <span class="hljs-literal">false</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> tag_name == <span class="hljs-string">"style"</span> {
                in_style = <span class="hljs-literal">true</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> tag_name == <span class="hljs-string">"/style"</span> {
                <span class="hljs-comment">// 压缩并输出 style 内容</span>
                <span class="hljs-keyword">if</span> !style_content.<span class="hljs-title function_ invoke__">trim</span>().<span class="hljs-title function_ invoke__">is_empty</span>() {
                    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">minified</span> = <span class="hljs-title function_ invoke__">minify_css</span>(&amp;style_content);
                    result.<span class="hljs-title function_ invoke__">push_str</span>(&amp;minified);
                }
                style_content.<span class="hljs-title function_ invoke__">clear</span>();
                in_style = <span class="hljs-literal">false</span>;
            }
        }

        <span class="hljs-comment">// 收集 script/style 内容</span>
        <span class="hljs-keyword">if</span> !in_tag {
            <span class="hljs-keyword">if</span> in_script {
                script_content.<span class="hljs-title function_ invoke__">push</span>(ch);
                <span class="hljs-keyword">continue</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> in_style {
                style_content.<span class="hljs-title function_ invoke__">push</span>(ch);
                <span class="hljs-keyword">continue</span>;
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-14">压缩效果</h2>
<p>经过三层压缩，整体压缩率可达 <strong>40-55%</strong>：</p>






























<table><thead><tr><th>层级</th><th>贡献率</th><th>示例</th></tr></thead><tbody><tr><td>CSS 优化</td><td>20-30%</td><td><code>margin-top: 0; margin-bottom: 0</code> → <code>margin:0 0</code></td></tr><tr><td>JS 压缩</td><td>15-25%</td><td>移除注释和空白</td></tr><tr><td>HTML 压缩</td><td>10-15%</td><td>移除换行和缩进</td></tr><tr><td>注释移除</td><td>5-10%</td><td>取决于注释密度</td></tr></tbody></table>
<p>完整示例：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 输入：324 字节 --&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>{{ title }}<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 这是注释 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-tag">body</span> {
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f0f0f0</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{{ heading }}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    {% for item in items %}
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ item.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    {% endfor %}
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-comment">// 这是注释</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Hello"</span>);
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 输出：152 字节，-53% --&gt;</span>
<span class="hljs-meta">&lt;!doctype <span class="hljs-keyword">html</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">zh-CN</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">UTF-8</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>{{ title }}<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css"><span class="hljs-selector-tag">body</span>{<span class="hljs-attribute">background-color</span>:<span class="hljs-number">#f0f0f0</span>;<span class="hljs-attribute">margin</span>:<span class="hljs-number">0</span>;<span class="hljs-attribute">padding</span>:<span class="hljs-number">20px</span>}</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{{ heading }}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>{% for item in items %} <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ item.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>{% endfor %}<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Hello"</span>);</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h2 data-id="heading-15">其他技术细节</h2>
<h3 data-id="heading-16">命令行参数设计</h3>
<p>使用 clap 库来处理命令行参数：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> clap::Parser;

<span class="hljs-meta">#[derive(Parser, Debug)]</span>
<span class="hljs-meta">#[command(name = <span class="hljs-string">"askama-minify"</span>)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Args</span> {
    <span class="hljs-comment">/// 要压缩的文件或文件夹路径</span>
    <span class="hljs-meta">#[arg(value_name = <span class="hljs-string">"PATH"</span>)]</span>
    path: PathBuf,

    <span class="hljs-comment">/// 递归处理文件夹（默认启用）</span>
    <span class="hljs-meta">#[arg(short, long, default_value_t = true)]</span>
    recursive: <span class="hljs-type">bool</span>,

    <span class="hljs-comment">/// 输出文件或文件夹路径</span>
    <span class="hljs-meta">#[arg(short = 'd', long)]</span>
    output: <span class="hljs-type">Option</span>&lt;PathBuf&gt;,

    <span class="hljs-comment">/// 输出文件的后缀名（例如: "min" 会生成 .min.html）</span>
    <span class="hljs-meta">#[arg(short = 's', long)]</span>
    suffix: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">String</span>&gt;,
}
</code></pre>
<h3 data-id="heading-17">文件处理优化</h3>
<p>使用 walkdir 库实现高效的文件夹遍历：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> walkdir::WalkDir;

<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">walker</span> = <span class="hljs-keyword">if</span> recursive {
    WalkDir::<span class="hljs-title function_ invoke__">new</span>(path)
} <span class="hljs-keyword">else</span> {
    WalkDir::<span class="hljs-title function_ invoke__">new</span>(path).<span class="hljs-title function_ invoke__">max_depth</span>(<span class="hljs-number">1</span>)
};

<span class="hljs-keyword">for</span> <span class="hljs-variable">entry</span> <span class="hljs-keyword">in</span> walker.<span class="hljs-title function_ invoke__">into_iter</span>().<span class="hljs-title function_ invoke__">filter_map</span>(|e| e.<span class="hljs-title function_ invoke__">ok</span>()) {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">file_path</span> = entry.<span class="hljs-title function_ invoke__">path</span>();
    <span class="hljs-keyword">if</span> !file_path.<span class="hljs-title function_ invoke__">is_file</span>() || !<span class="hljs-title function_ invoke__">is_template_file</span>(file_path) {
        <span class="hljs-keyword">continue</span>;
    }
    <span class="hljs-comment">// 处理文件...</span>
}
</code></pre>
<h3 data-id="heading-18">代码质量优化</h3>
<ol>
<li><strong>常量提取</strong>：避免魔法字符串</li>
</ol>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">const</span> DEFAULT_SUFFIX: &amp;<span class="hljs-type">str</span> = <span class="hljs-string">"min"</span>;
<span class="hljs-keyword">const</span> MIN_MARKER: &amp;<span class="hljs-type">str</span> = <span class="hljs-string">".min."</span>;
<span class="hljs-keyword">const</span> VALID_EXTENSIONS: &amp;[&amp;<span class="hljs-type">str</span>] = &amp;[<span class="hljs-string">"html"</span>, <span class="hljs-string">"htm"</span>, <span class="hljs-string">"xml"</span>, <span class="hljs-string">"svg"</span>];
</code></pre>
<ol start="2">
<li><strong>避免不必要的字符串分配</strong>：使用 <code>eq_ignore_ascii_case</code> 而不是 <code>to_lowercase()</code></li>
</ol>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 优化后</span>
ext_str.<span class="hljs-title function_ invoke__">eq_ignore_ascii_case</span>(valid_ext)

<span class="hljs-comment">// 优化前（会创建新字符串）</span>
ext_str.<span class="hljs-title function_ invoke__">to_lowercase</span>() == valid_ext
</code></pre>
<ol start="3">
<li><strong>空文件快速处理</strong></li>
</ol>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">if</span> original_size == <span class="hljs-number">0</span> {
    fs::<span class="hljs-title function_ invoke__">write</span>(output_path, <span class="hljs-string">""</span>)?;
    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Ok</span>((<span class="hljs-number">0</span>, <span class="hljs-number">0</span>));
}
</code></pre>
<h2 data-id="heading-19">使用方式</h2>
<h3 data-id="heading-20">安装</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 克隆仓库</span>
git <span class="hljs-built_in">clone</span> https://github.com/wsafight/askama-minify.git
<span class="hljs-built_in">cd</span> askama-minify

<span class="hljs-comment"># 编译</span>
cargo build --release
</code></pre>
<p>编译后的二进制文件位于 <code>target/release/askama-minify</code>。</p>
<h3 data-id="heading-21">基本用法</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 压缩单个文件（默认生成 .min.html 后缀）</span>
./target/release/askama-minify template.html

<span class="hljs-comment"># 指定输出文件</span>
./target/release/askama-minify -d output.html template.html

<span class="hljs-comment"># 压缩整个文件夹</span>
./target/release/askama-minify templates/

<span class="hljs-comment"># 输出到指定目录并保持目录结构</span>
./target/release/askama-minify -d dist/ templates/
</code></pre>
<h3 data-id="heading-22">命令行选项</h3>





























<table><thead><tr><th>选项</th><th>简写</th><th>说明</th><th>默认值</th></tr></thead><tbody><tr><td><code>--output &lt;PATH&gt;</code></td><td><code>-d</code></td><td>输出文件或文件夹路径</td><td>原路径</td></tr><tr><td><code>--suffix &lt;SUFFIX&gt;</code></td><td><code>-s</code></td><td>输出文件后缀名</td><td><code>min</code></td></tr><tr><td><code>--recursive</code></td><td><code>-r</code></td><td>递归处理子文件夹</td><td><code>true</code></td></tr></tbody></table>
<h3 data-id="heading-23">后缀规则</h3>






























<table><thead><tr><th>配置</th><th>结果</th><th>示例</th></tr></thead><tbody><tr><td>无 <code>-d</code> 无 <code>-s</code></td><td>默认后缀 <code>min</code></td><td><code>file.html</code> → <code>file.min.html</code></td></tr><tr><td>无 <code>-d</code> 有 <code>-s</code></td><td>自定义后缀</td><td><code>file.html</code> + <code>-s prod</code> → <code>file.prod.html</code></td></tr><tr><td>有 <code>-d</code> 无 <code>-s</code></td><td>不添加后缀</td><td><code>file.html</code> + <code>-d out.html</code> → <code>out.html</code></td></tr><tr><td>有 <code>-d</code> 有 <code>-s</code></td><td>后缀 + 自定义路径</td><td><code>file.html</code> + <code>-d out/</code> + <code>-s prod</code> → <code>out/file.prod.html</code></td></tr></tbody></table>
<h3 data-id="heading-24">集成到构建流程</h3>
<h4 data-id="heading-25">方式一：在 <code>build.rs</code> 中使用</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// build.rs</span>
<span class="hljs-keyword">use</span> std::process::Command;

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-comment">// 在生产构建时自动压缩模板</span>
    <span class="hljs-keyword">if</span> std::env::<span class="hljs-title function_ invoke__">var</span>(<span class="hljs-string">"PROFILE"</span>).<span class="hljs-title function_ invoke__">as_deref</span>() == <span class="hljs-title function_ invoke__">Ok</span>(<span class="hljs-string">"release"</span>) {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">status</span> = Command::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">"./target/release/askama-minify"</span>)
            .<span class="hljs-title function_ invoke__">args</span>([<span class="hljs-string">"-d"</span>, <span class="hljs-string">"dist/templates/"</span>, <span class="hljs-string">"templates/"</span>])
            .<span class="hljs-title function_ invoke__">status</span>()
            .<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">"Failed to execute askama-minify"</span>);

        <span class="hljs-keyword">if</span> !status.<span class="hljs-title function_ invoke__">success</span>() {
            <span class="hljs-built_in">panic!</span>(<span class="hljs-string">"Template minification failed"</span>);
        }
    }
}
</code></pre>
<h4 data-id="heading-26">方式二：在 Makefile 中使用</h4>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-comment"># Makefile</span>
<span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: build minify-templates</span>

<span class="hljs-section">build: minify-templates</span>
	cargo build --release

<span class="hljs-section">minify-templates:</span>
	askama-minify -d dist/templates/ -s prod templates/
</code></pre>
<h4 data-id="heading-27">方式三：在 CI/CD 中使用</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># .github/workflows/deploy.yml</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span> [ <span class="hljs-string">main</span> ]

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">deploy:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">Rust</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions-rs/toolchain@v1</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">toolchain:</span> <span class="hljs-string">stable</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">askama-minify</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          git clone https://github.com/wsafight/askama-minify.git
          cd askama-minify
          cargo build --release
</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Minify</span> <span class="hljs-string">templates</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">./askama-minify/target/release/askama-minify</span> <span class="hljs-string">-d</span> <span class="hljs-string">dist/</span> <span class="hljs-string">-s</span> <span class="hljs-string">prod</span> <span class="hljs-string">templates/</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span>
        <span class="hljs-attr">run:</span> <span class="hljs-comment"># 你的部署脚本</span>
</code></pre>
<h3 data-id="heading-28">在 Askama 中使用压缩后的模板</h3>
<p>有两种使用方式：</p>
<h4 data-id="heading-29">方式一：切换模板路径（推荐）</h4>
<p>开发环境使用源模板，生产环境使用压缩模板：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> askama::Template;

<span class="hljs-meta">#[derive(Template)]</span>
<span class="hljs-meta">#[template(
    path = <span class="hljs-string">"{{ template_path }}"</span>,  // 通过配置传入
    whitespace = <span class="hljs-string">"suppress"</span>
)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">HomePage</span> {
    title: <span class="hljs-type">String</span>,
}

<span class="hljs-comment">// 根据环境变量选择模板路径</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_template_path</span>(name: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> {
    <span class="hljs-keyword">if</span> std::env::<span class="hljs-title function_ invoke__">var</span>(<span class="hljs-string">"PROFILE"</span>).<span class="hljs-title function_ invoke__">as_deref</span>() == <span class="hljs-title function_ invoke__">Ok</span>(<span class="hljs-string">"release"</span>) {
        <span class="hljs-built_in">format!</span>(<span class="hljs-string">"dist/{}.prod.html"</span>, name)  <span class="hljs-comment">// 使用压缩版</span>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">format!</span>(<span class="hljs-string">"templates/{}.html"</span>, name)   <span class="hljs-comment">// 使用源文件</span>
    }
}
</code></pre>
<h4 data-id="heading-30">方式二：构建时替换</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 开发环境</span>
<span class="hljs-built_in">cp</span> templates/*.html templates/

<span class="hljs-comment"># 生产构建时</span>
askama-minify -d templates/ -s prod templates/
</code></pre>
<h3 data-id="heading-31">实际项目示例</h3>
<p>假设你有以下项目结构：</p>
<pre><code class="hljs language-csharp" lang="csharp">my-app/
├── templates/
│   ├── <span class="hljs-keyword">base</span>.html
│   ├── index.html
│   └── user/
│       ├── profile.html
│       └── settings.html
├── dist/              <span class="hljs-meta"># 压缩后的输出目录</span>
├── Cargo.toml
└── build.rs
</code></pre>
<p><strong>开发时</strong>：直接使用 <code>templates/</code> 下的原始文件</p>
<p><strong>部署前</strong>：运行压缩命令</p>
<pre><code class="hljs language-bash" lang="bash">askama-minify -d dist/ -s prod templates/
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-csharp" lang="csharp">dist/
├── <span class="hljs-keyword">base</span>.prod.html
├── index.prod.html
└── user/
    ├── profile.prod.html
    └── settings.prod.html
</code></pre>
<p><strong>配置 Askama 使用生产模板</strong>：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-comment"># askama.toml</span>
<span class="hljs-section">[general]</span>
<span class="hljs-attr">dirs</span> = [<span class="hljs-string">"dist"</span>]  <span class="hljs-comment"># 指向压缩后的目录</span>
</code></pre>
<h2 data-id="heading-32">总结</h2>
<p>askama-minify 通过以下技术实现了高效的模板压缩：</p>
<ol>
<li><strong>模板语法保留</strong>：完整保留 <code>{{ }}</code> 和 <code>{% %}</code> 语法</li>
<li><strong>三层压缩策略</strong>：HTML 层、CSS 层、JS 层分别优化</li>
<li><strong>智能边缘处理</strong>：正确处理转义字符、运算符、正则表达式</li>
<li><strong>专业 CSS 优化</strong>：使用 lightningcss 进行属性合并和颜色优化</li>
<li><strong>Rust 实现</strong>：高性能、内存安全</li>
</ol>
<h3 data-id="heading-33">与 Askama 自带压缩的对比</h3>








































<table><thead><tr><th>特性</th><th>Askama whitespace</th><th>askama-minify</th></tr></thead><tbody><tr><td>空白压缩</td><td>✅</td><td>✅</td></tr><tr><td>HTML 注释移除</td><td>❌</td><td>✅</td></tr><tr><td>CSS 压缩优化</td><td>❌</td><td>✅</td></tr><tr><td>JavaScript 压缩</td><td>❌</td><td>✅</td></tr><tr><td>模板语法保留</td><td>✅</td><td>✅</td></tr><tr><td>构建时处理</td><td>❌</td><td>✅</td></tr></tbody></table>
<p>项目已开源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwsafight%2Faskama-minify" target="_blank" title="https://github.com/wsafight/askama-minify" ref="nofollow noopener noreferrer">github.com/wsafight/as…</a></p>
<p>欢迎大家提出 issue 和 pr。</p>
<h2 data-id="heading-34">参考资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fparcel-bundler%2Flightningcss" target="_blank" title="https://github.com/parcel-bundler/lightningcss" ref="nofollow noopener noreferrer">lightningcss</a> - 出色的 CSS 解析和优化工具</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fclap-rs%2Fclap" target="_blank" title="https://github.com/clap-rs/clap" ref="nofollow noopener noreferrer">clap</a> - 强大的命令行参数解析库</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdjc%2Faskama" target="_blank" title="https://github.com/djc/askama" ref="nofollow noopener noreferrer">Askama</a> - 灵活的 Rust 模板引擎</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[彻底搞懂 SSH 与 Git 的“幕后交易”]]></title>    <link>https://juejin.cn/post/7586893663075958794</link>    <guid>https://juejin.cn/post/7586893663075958794</guid>    <pubDate>2025-12-23T14:01:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586893663075958794" data-draft-id="7586892413890805806" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="彻底搞懂 SSH 与 Git 的“幕后交易”"/> <meta itemprop="keywords" content="GitHub,Git,全栈"/> <meta itemprop="datePublished" content="2025-12-23T14:01:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ssshooter"/> <meta itemprop="url" content="https://juejin.cn/user/3122268751795101"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            彻底搞懂 SSH 与 Git 的“幕后交易”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3122268751795101/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ssshooter
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T14:01:43.000Z" title="Tue Dec 23 2025 14:01:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>很多开发者在配置 GitHub SSH 的时候，通常是按照网上的教程，噼里啪啦一顿复制：先 <code>ssh-keygen</code>，再把公钥贴到 GitHub，最后 <code>git push</code>。如果一切顺利，你会觉得这是一种“魔法”，但一旦报错，往往就一脸懵逼。</p>
<p>其实，这背后是一套非常逻辑严密的“身份代换”过程。</p>
<h4 data-id="heading-0">1. 钥匙与锁：非对称加密的“挑战”</h4>
<p>SSH 的核心是<strong>非对称加密</strong>。当你运行 <code>ssh-keygen</code> 时，你其实是产生了一对关系：**私钥（Private Key）**留在你电脑里，相当于你的指纹；**公钥（Public Key）**上传到 GitHub，相当于在 GitHub 门口装了一个只认你指纹的扫描仪。</p>
<p>当你尝试 <code>git push</code> 时，并不是直接发送密码，而是一个“挑战与应答”的过程：</p>
<ol>
<li>GitHub 拿你的公钥加密一段随机信息发给你。</li>
<li>只有你电脑里的私钥能解开这段信息并签上名发回去。</li>
<li>GitHub 验证签名成功，门开了。</li>
</ol>
<p>这就是为什么 SSH 比账号密码安全得多：即便网络被监听，黑客也拿不到你的私钥。</p>
<h4 data-id="heading-1">2. 管理员 ssh-agent：你的“钥匙包”</h4>
<p>如果你电脑里有很多把钥匙（比如公司的、个人的、不同服务器的），你不可能每次推送代码都手动指定用哪把。</p>
<p>这时候 <strong><code>ssh-add</code></strong> 就出场了。它把你的私钥加载进一个叫 <code>ssh-agent</code> 的后台管家那里。当你发起连接时，这个管家会像拿着一大串钥匙的保安，挨个去试。</p>
<p>但这里有个陷阱：<strong>试错是有上限的</strong>。如果管家试了 5-6 把钥匙都没对上，GitHub 就会觉得你在暴力破解，直接切断连接。这就是为什么有时候明明钥匙是对的，却依然报错 <code>Too many authentication failures</code>。</p>
<h4 data-id="heading-2">3. SSH Config：这才是真正的“高级配置”</h4>
<p>为了不让管家“盲目试错”，我们需要一个名为 <code>config</code> 的配置文件（在 <code>~/.ssh/</code> 目录下）。</p>
<p>这个文件就像一张<strong>精确的地图</strong>，它告诉 SSH：</p>
<ul>
<li>“如果是去 GitHub，请直接用这把名为 <code>id_ed25519_me</code> 的钥匙。”</li>
<li>“不要去试其他的钥匙（<code>IdentitiesOnly yes</code>）。”</li>
<li>“甚至如果 22 端口被封了，你可以偷偷走 443 端口。”</li>
</ul>
<p>有了它，SSH 就不再是猜测，而是精准导航。</p>
<h4 data-id="heading-3">4. Git 与 SSH 的“外包关系”</h4>
<p>很多人分不清 Git 地址和 SSH 地址。其实，当你看到 <code>git@github.com:user/repo.git</code> 这种地址时，它本质上就是一个 <strong>SSH 路径</strong>。</p>
<ul>
<li><strong>Git 是货物</strong>：它只负责打包你的代码变更（Commit）。</li>
<li><strong>SSH 是隧道</strong>：它负责把这些货物安全地送到远程仓库（Push）。</li>
</ul>
<p>Git 其实很懒，它根本不负责身份校验。它只是把地址里的 <code>github.com</code> 丢给系统里的 SSH 客户端，说：“喂，帮我连上这个地方，我要发货。”</p>
<p>这时候，SSH 客户端就会去翻你的 <code>config</code> 文件，找对应的钥匙，建立隧道。隧道一旦修通，Git 就在里面欢快地传输数据。</p>
<h4 data-id="heading-4">5. 总结：一个完整的链路</h4>
<p>当你完成一次成功的提交并推送时，底层逻辑是这样的：</p>
<ol>
<li><strong>Git Commit</strong>：在本地把修改存进仓库。</li>
<li><strong>Git Push</strong>：识别到地址是 SSH 格式，呼叫 SSH 客户端。</li>
<li><strong>SSH 寻址</strong>：查看 <code>~/.ssh/config</code>，确定去哪个 IP、用哪个端口、带哪把钥匙。</li>
<li><strong>身份验证</strong>：通过 <code>ssh-agent</code> 提供的私钥与 GitHub 上的公钥完成“暗号对接”。</li>
<li><strong>数据传输</strong>：身份确认，隧道开启，Git 开始搬运代码。</li>
</ol>
<p>一句话总结：</p>
<p>ssh-keygen 造了钥匙，GitHub 拿了模具，ssh-add 把它挂在腰间，config 给了你一张地图，而 Git 则是那个顺着地图走、拿着钥匙开门送货的快递员。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再只会调 API 了！LangChain.js 才是前端 AI 工程化的真正起点]]></title>    <link>https://juejin.cn/post/7586872817875812378</link>    <guid>https://juejin.cn/post/7586872817875812378</guid>    <pubDate>2025-12-23T12:07:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586872817875812378" data-draft-id="7586893663075696650" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再只会调 API 了！LangChain.js 才是前端 AI 工程化的真正起点"/> <meta itemprop="keywords" content="前端,LangChain"/> <meta itemprop="datePublished" content="2025-12-23T12:07:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="白兰地空瓶"/> <meta itemprop="url" content="https://juejin.cn/user/191753514127514"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再只会调 API 了！LangChain.js 才是前端 AI 工程化的真正起点
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/191753514127514/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    白兰地空瓶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T12:07:38.000Z" title="Tue Dec 23 2025 12:07:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>2025 年，如果你还在代码里写：</strong><br/>
<code>const res = await fetch('https://api.openai.com/v1/chat/completions')</code></p>
<p>那你大概率，正在亲手制造一个未来必然崩塌的 <strong>AI 屎山工程</strong>。</p>
</blockquote>
<p>随着 <strong>DeepSeek 等国产大模型的爆发</strong>，前端开发者的主战场已经彻底转移：</p>
<p>❌ 不再是：<strong>我会不会调用模型 API</strong><br/>
✅ 而是：<strong>我能不能编排一个稳定、可扩展、可演进的 AI 工作流</strong></p>
<p>而 <strong>LangChain.js</strong>，正是这场迁移里的<strong>标准答案</strong>。</p>
<hr/>
<h2 data-id="heading-0">一、LangChain 到底是什么？为什么它成了“AI 工程事实标准”？</h2>
<p>在写任何代码之前，我们必须搞清楚一件事：</p>
<blockquote>
<p><strong>LangChain ≠ AI 模型</strong><br/>
<strong>LangChain = AI 应用的“工程骨架”</strong></p>
</blockquote>
<h3 data-id="heading-1">一个前端能秒懂的比喻</h3>
<ul>
<li>
<p>🧠 <strong>大模型（LLM）</strong> ：一个聪明但失忆、不会用工具的大脑</p>
</li>
<li>
<p>🦴 <strong>LangChain</strong>：让这个大脑</p>
<ul>
<li>能记事</li>
<li>会用工具</li>
<li>能拆任务</li>
<li>会按流程干活</li>
</ul>
</li>
</ul>
<p>它解决的不是“模型聪不聪明”，而是<strong>工程层面的三大致命痛点</strong>：</p>
<h3 data-id="heading-2">❌ 痛点 1：逻辑碎片化</h3>
<p>复杂业务 ≠ 一次 Prompt<br/>
LangChain 的 <strong>Chain</strong>，让多步推理变成流水线。</p>
<h3 data-id="heading-3">❌ 痛点 2：数据孤岛</h3>
<p>模型不知道你的：</p>
<ul>
<li>PDF</li>
<li>私有文档</li>
<li>数据库</li>
</ul>
<p>LangChain 的 <strong>RAG（检索增强生成）</strong> ，让模型“读你自己的数据”。</p>
<h3 data-id="heading-4">❌ 痛点 3：模型锁死</h3>
<p>今天 OpenAI<br/>
明天 DeepSeek<br/>
后天再换别的？</p>
<p>LangChain 用 <strong>统一接口</strong>，让你实现真正的 <strong>模型自由</strong>。</p>
<blockquote>
<p><strong>一句话总结</strong><br/>
👉 LangChain 之于 AI，就像 <strong>React 之于浏览器</strong>、<strong>Express 之于 Node.js</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-5">二、LangChain 的“四大支柱”，你代码里其实已经用到了</h2>
<p>你写的实战代码，其实已经踩在 LangChain 的核心设计上，只是你可能没意识到。</p>
<h3 data-id="heading-6">🧱 1. Model I/O（模型输入输出）</h3>
<ul>
<li>PromptTemplate</li>
<li>ChatModel</li>
<li>OutputParser</li>
</ul>
<p>👉 负责 <strong>“怎么喂模型、怎么拿结果”</strong></p>
<hr/>
<h3 data-id="heading-7">🧱 2. Retrieval（检索 / RAG）</h3>
<ul>
<li>文档切片</li>
<li>向量化</li>
<li>相似度搜索</li>
</ul>
<p>👉 负责 <strong>“让模型说你自己的话”</strong></p>
<hr/>
<h3 data-id="heading-8">🧱 3. Chains（执行链）</h3>
<blockquote>
<p><strong>LangChain 的灵魂</strong></p>
</blockquote>
<p>把 Prompt / Model / Parser<br/>
像管道一样串起来。</p>
<hr/>
<h3 data-id="heading-9">🧱 4. Agents（智能体）</h3>
<p>不给流程<br/>
只给工具</p>
<p>让 AI 自己决定：</p>
<ul>
<li>搜索？</li>
<li>算数？</li>
<li>写代码？</li>
</ul>
<p>👉 这是 <strong>AI 从“脚本”走向“自治”</strong> 的起点。</p>
<hr/>
<h2 data-id="heading-10">三、Prompt 工程化：像写 React 组件一样写 Prompt</h2>
<p>你代码里最亮眼的一点，是这一段 👇</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PromptTemplate</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/core/prompts'</span>;

<span class="hljs-keyword">const</span> prompt = <span class="hljs-title class_">PromptTemplate</span>.<span class="hljs-title function_">fromTemplate</span>(<span class="hljs-string">`
你是一个 {role}
请用不超过 {limit} 字回答以下问题：
{question}
`</span>);
</code></pre>
<h3 data-id="heading-11">💡 为什么这是“工程级 Prompt”？</h3>
<p>因为它解决了 <strong>提示词三大老问题</strong>：</p>
<h4 data-id="heading-12">✅ 1. 解耦</h4>
<p>Prompt 不再是字符串拼接<br/>
而是 <strong>配置 + 参数</strong></p>
<h4 data-id="heading-13">✅ 2. 可维护</h4>
<ul>
<li>可版本化</li>
<li>可复用</li>
<li>可测试</li>
</ul>
<h4 data-id="heading-14">✅ 3. 防手滑</h4>
<p>占位符校验，避免：</p>
<blockquote>
<p>“怎么模型突然胡说八道了？”</p>
</blockquote>
<blockquote>
<p><strong>类比一句话</strong><br/>
👉 <code>PromptTemplate</code> 就是 <strong>AI 世界里的 Props</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-15">四、DeepSeek 丝滑接入：这才是适配器模式的正确用法</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatDeepSeek</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/deepseek'</span>;

<span class="hljs-keyword">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({
  <span class="hljs-attr">model</span>: <span class="hljs-string">'deepseek-reasoner'</span>,
  <span class="hljs-attr">temperature</span>: <span class="hljs-number">0.7</span>,
});
</code></pre>
<h3 data-id="heading-16">为什么 LangChain 对前端特别友好？</h3>
<p>因为各家模型虽然<strong>长得像 OpenAI</strong>，但细节全是坑：</p>
<ul>
<li>BaseURL 不同</li>
<li>Auth 不同</li>
<li>Token 计算不同</li>
</ul>
<p>LangChain 的 Provider 层，<strong>把这些脏活全吃掉了</strong>。</p>
<p>你只需要：</p>
<blockquote>
<p><strong>关心业务，不关心模型厂商</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-17">五、真正的灵魂：<code>.pipe()</code> 与 LCEL 声明式编排</h2>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">chain</span> = prompt.pipe(model)<span class="hljs-comment">;</span>
</code></pre>
<blockquote>
<p><strong>这行代码，是整篇文章的技术核心</strong></p>
</blockquote>
<h3 data-id="heading-18">什么是 LCEL（LangChain Expression Language）？</h3>
<p>它借鉴的是 <strong>Unix 管道思想</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cat</span> file | grep keyword | <span class="hljs-built_in">sort</span>
</code></pre>
<p>在 LangChain 中：</p>
<pre><code class="hljs">Prompt → Model → Output
</code></pre>
<h3 data-id="heading-19">对比一下就懂了</h3>
<p>❌ 命令式（越写越乱）：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">const</span> <span class="hljs-keyword">text</span> = <span class="hljs-built_in">await</span> prompt.format(...)
<span class="hljs-keyword">const</span> res = <span class="hljs-built_in">await</span> model.invoke(<span class="hljs-keyword">text</span>)
</code></pre>
<p>✅ 声明式（可组合、可扩展）：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> chain = prompt.<span class="hljs-built_in">pipe</span>(model)
await chain.<span class="hljs-built_in">invoke</span>(...)
</code></pre>
<blockquote>
<p><strong>LCEL 的真正价值在于</strong></p>
<ul>
<li>天然支持 Streaming</li>
<li>天然支持并发</li>
<li>天然可观测</li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-20">六、进阶实战：多链协作，才是 AI 工程的常态</h2>
<p>真实场景几乎从来不是“一问一答”。</p>
<p>你这个例子，非常典型，也非常高级 👇</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> fullChain = <span class="hljs-title class_">RunnableSequence</span>.<span class="hljs-title function_">from</span>([
  <span class="hljs-function">(<span class="hljs-params">input</span>) =&gt;</span> explainChain.<span class="hljs-title function_">invoke</span>({ <span class="hljs-attr">topic</span>: input.<span class="hljs-property">topic</span> }).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-property">text</span>),
  <span class="hljs-function">(<span class="hljs-params">explanation</span>) =&gt;</span>
    summaryChain.<span class="hljs-title function_">invoke</span>({ explanation }).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span>
      <span class="hljs-string">`【详情】<span class="hljs-subst">${explanation}</span>\n【总结】<span class="hljs-subst">${r.text}</span>`</span>
    )
]);
</code></pre>
<h3 data-id="heading-21">这段代码本质上在干什么？</h3>
<p>👉 <strong>AI 流水线加工</strong></p>
<ul>
<li>原子性：每个 Chain 都能单测</li>
<li>组合性：像搭积木一样拼</li>
<li>闭环性：前端只管一个输入</li>
</ul>
<blockquote>
<p><strong>这，才配叫 AI 工程化</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-22">七、前端 AI 实战避坑指南</h2>
<h3 data-id="heading-23">⚠️ 1. 永远别把 API Key 写在浏览器</h3>
<p>LangChain = <strong>Node / Serverless 专属</strong></p>
<h3 data-id="heading-24">⚠️ 2. Temperature 不是随便填的</h3>
<ul>
<li><code>0.0</code>：代码 / 数学</li>
<li><code>0.7</code>：博客 / 对话</li>
<li><code>1.0+</code>：创作 / 发散</li>
</ul>
<h3 data-id="heading-25">⚠️ 3. 一定要用 Streaming</h3>
<pre><code class="hljs language-scss" lang="scss">chain<span class="hljs-selector-class">.stream</span>()
</code></pre>
<p>体验差距 = ChatGPT vs 普通输入框</p>
<hr/>
<h2 data-id="heading-26">八、结语：你不是不会 AI，你只是缺一套“工程语法”</h2>
<p>很多人觉得 AI 开发 = 调包<br/>
其实真正的分水岭在于：</p>
<blockquote>
<p><strong>你有没有一套可组合、可演进的 AI 结构</strong></p>
</blockquote>
<p>LangChain 的意义，不是让模型更聪明<br/>
而是让 <strong>人类工程师重新掌控复杂度</strong></p>
<hr/>
<h3 data-id="heading-27">🎯 最后一句话送你</h3>
<blockquote>
<p><strong>Prompt → Model → Chain</strong></p>
<p>这是前端迈入 AI 工程时代的第一性原理。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Jetpack Compose Navigation]]></title>    <link>https://juejin.cn/post/7586892413890641966</link>    <guid>https://juejin.cn/post/7586892413890641966</guid>    <pubDate>2025-12-23T12:44:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586892413890641966" data-draft-id="7585146584893980722" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Jetpack Compose Navigation"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-23T12:44:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Best_Jerry"/> <meta itemprop="url" content="https://juejin.cn/user/1099167360106999"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Jetpack Compose Navigation
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1099167360106999/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Best_Jerry
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T12:44:31.000Z" title="Tue Dec 23 2025 12:44:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fcodelabs%2Fjetpack-compose-navigation%3Fhl%3Dzh-cn%26continue%3Dhttps%253A%252F%252Fdeveloper.android.com%252Fcourses%252Fpathways%252Fjetpack-compose-for-android-developers-3%253Fhl%253Dzh-cn%2523codelab-https%253A%252F%252Fdeveloper.android.com%252Fcodelabs%252Fjetpack-compose-navigation%230" target="_blank" title="https://developer.android.com/codelabs/jetpack-compose-navigation?hl=zh-cn&amp;continue=https%3A%2F%2Fdeveloper.android.com%2Fcourses%2Fpathways%2Fjetpack-compose-for-android-developers-3%3Fhl%3Dzh-cn%23codelab-https%3A%2F%2Fdeveloper.android.com%2Fcodelabs%2Fjetpack-compose-navigation#0" ref="nofollow noopener noreferrer">Jetpack Compose Navigation</a></p>
<p>了解如何在 Compose 中使用 Jetpack Navigation 库、在应用中导航、使用参数进行导航、支持深层链接及测试导航。</p>
<h2 data-id="heading-0">1. 简介</h2>
<h3 data-id="heading-1">使用 Compose 进行导航</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fguide%2Fnavigation%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/guide/navigation?hl=zh-cn" ref="nofollow noopener noreferrer">Navigation</a> 是一个 Jetpack 库，用于在应用中从一个目的地导航到另一个目的地。Navigation 库还提供了一个专用工件，用于<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fnavigation%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/jetpack/compose/navigation?hl=zh-cn" ref="nofollow noopener noreferrer">使用 Jetpack Compose 实现一致而惯用的导航方式</a>。此 Codelab 会重点介绍这个制品 (<code>navigation-compose</code>)。</p>
<h3 data-id="heading-2"><strong>实践内容</strong></h3>
<p>您将使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmaterial.io%2Fdesign%2Fmaterial-studies%2Frally.html%23about-rally" target="_blank" title="https://material.io/design/material-studies/rally.html#about-rally" ref="nofollow noopener noreferrer">Rally Material 研究</a>作为此 Codelab 的基础，从而实现 Jetpack Navigation 组件并在可组合的 Rally 屏幕之间实现导航。</p>
<h3 data-id="heading-3"><strong>学习内容</strong></h3>
<ul>
<li>将 Jetpack Navigation 与 Jetpack Compose 配合使用的基础知识</li>
<li>在可组合项之间导航</li>
<li>将自定义标签页栏可组合项集成到导航层次结构中</li>
<li>使用实参进行导航</li>
<li>使用深层链接进行导航</li>
<li>测试导航</li>
</ul>
<h2 data-id="heading-4">2. 设置</h2>
<p>如需自行学习，请克隆此 Codelab 的起始代码（<code>main</code> 分支）。</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">$ </span><span class="bash">git <span class="hljs-built_in">clone</span> https://github.com/android/codelab-android-compose.git</span>
</code></pre>
<p>或者，您也可以下载两个 ZIP 文件：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fandroid%2Fcodelab-android-compose%2Farchive%2Frefs%2Fheads%2Fmain.zip" target="_blank" title="https://github.com/android/codelab-android-compose/archive/refs/heads/main.zip" ref="nofollow noopener noreferrer">起始代码</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fandroid%2Fcodelab-android-compose%2Farchive%2Frefs%2Fheads%2Fend.zip" target="_blank" title="https://github.com/android/codelab-android-compose/archive/refs/heads/end.zip" ref="nofollow noopener noreferrer">解决方案</a></li>
</ul>
<p>现在，您已下载相应代码，请在 Android Studio 中打开 <strong>NavigationCodelab</strong> 项目文件夹。现已准备就绪，可以开始开发项目了。</p>
<blockquote>
<p>compose-codelabs 库包含开发者在线课程中所有 Codelab 的起始代码。</p>
<p>对于此 Codelab，请使用 <strong>NavigationCodelab</strong> 项目。</p>
<ul>
<li><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29d39ffd20f848cf98486a20de6d5834~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767098671&amp;x-signature=%2BTiPewpCcc70Nl7B4b3kZOr0nOg%3D" alt="android_studio_folder.png" loading="lazy"/> <strong>NavigationCodelab</strong> - 这个项目包含此 Codelab 的起始代码和完成后的代码</li>
</ul>
<p>该项目有多个 git 分支：</p>
<ul>
<li><strong>main</strong> - 该项目的<strong>起始代码</strong>；您将更改这些代码来完成此 Codelab</li>
<li><strong>end</strong> - 包含此 Codelab 的<strong>解决方案</strong></li>
</ul>
</blockquote>
<h2 data-id="heading-5">3. Rally 应用概览</h2>
<p>首先，您应当熟悉 Rally 应用及其代码库。运行应用并稍加探索。</p>
<p>Rally 有三个主屏幕作为可组合项：</p>
<ol>
<li><strong><code>OverviewScreen</code></strong> - 所有财务交易和提醒的概览</li>
<li><strong><code>AccountsScreen</code></strong> - 有关现有账户的数据分析</li>
<li><strong><code>BillsScreen</code></strong> - 预定支出</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67240abc70804e4ebbd5d3c6a558d04b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767098671&amp;x-signature=nzzdKfR5S9Nl1REd0M4LEZ5yNEk%3D" alt="image.png" loading="lazy"/></p>
<p>在屏幕的最顶部，Rally 使用<strong>自定义标签页栏可组合项 ( <code>RallyTabRow</code> )</strong>  在这三个屏幕之间进行导航。点按每个图标应该会展开当前所选内容，您也会转到其对应的屏幕：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e5f7420dd05407d83f378c1d8bcb610~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767098671&amp;x-signature=d1S7qg3111odGP48EWWO0U8%2FuDU%3D" alt="image.png" loading="lazy"/></p>
<p>在导航到这些可组合屏幕时，您还可以将它们视为导航目的地，因为我们希望在特定时间点到达各个目的地。这些目的地是在 <code>RallyDestinations.kt</code> 文件中预定义的。</p>
<p>在该文件中，您会找到所有三个定义为对象的主要目的地（<code>Overview, Accounts</code> 和 <code>Bills</code>），以及一个日后要添加到应用的 <code>SingleAccount</code>。每个对象都从 <code>RallyDestination</code> 接口扩展，并且包含有关每个目的地的必要信息，以便进行导航：</p>
<ol>
<li>顶栏的 <code>icon</code></li>
<li>字符串 <code>route</code>（这对 Compose Navigation 而言是必需的，可作为指向相应目的地的路径）</li>
<li><code>screen</code>，表示相应目的地的整个可组合项</li>
</ol>
<p>运行应用时，您会发现自己实际上可以在当前使用顶栏的目的地之间导航。然而，应用实际上并未使用 Compose Navigation，但它当前使用的导航机制依靠手动切换一些可组合项和触发<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fmental-model%3Fhl%3Dzh-cn%23recomposition" target="_blank" title="https://developer.android.com/jetpack/compose/mental-model?hl=zh-cn#recomposition" ref="nofollow noopener noreferrer">重组</a>来显示新内容。因此，此 Codelab 的目标是成功迁移并实现 Compose Navigation。</p>
<h2 data-id="heading-6">4. 迁移到 Compose Navigation</h2>
<p>迁移到 Jetpack Compose 所涉及的基本步骤如下：</p>
<ol>
<li>添加最新的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmvnrepository.com%2Fartifact%2Fandroidx.navigation%2Fnavigation-compose" target="_blank" title="https://mvnrepository.com/artifact/androidx.navigation/navigation-compose" ref="nofollow noopener noreferrer">Compose Navigation 依赖项</a></li>
<li>设置 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fnavigation%3Fhl%3Dzh-cn%23getting-started" target="_blank" title="https://developer.android.com/jetpack/compose/navigation?hl=zh-cn#getting-started" ref="nofollow noopener noreferrer"><code>NavController</code></a></li>
<li>添加 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fnavigation%3Fhl%3Dzh-cn%23create-navhost" target="_blank" title="https://developer.android.com/jetpack/compose/navigation?hl=zh-cn#create-navhost" ref="nofollow noopener noreferrer"><code>NavHost</code></a> 并创建导航图</li>
<li>准备路线以在不同的应用目的地之间导航</li>
<li>将当前导航机制替换为 Compose Navigation</li>
</ol>
<p>下面我们将更详细地逐一介绍这些步骤。</p>
<h3 data-id="heading-7">添加 Navigation 依赖项</h3>
<p>打开应用的 build 文件（位于 <code>app/build.gradle</code>）。在“dependencies”区段中，添加 <code>navigation-compose</code> 依赖项。</p>
<pre><code class="hljs language-arduino" lang="arduino">dependencies {
  implementation <span class="hljs-string">"androidx.navigation:navigation-compose:{latest_version}"</span>
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>您可以点击<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fandroidx%2Freleases%2Fnavigation%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/jetpack/androidx/releases/navigation?hl=zh-cn" ref="nofollow noopener noreferrer">此处</a>找到最新版 Navigation Compose。</p>
<p>现在，同步项目，然后您就可以开始使用 Compose 中的 Navigation 了。</p>
<h3 data-id="heading-8"><strong>设置 NavController</strong></h3>
<p>使用 Compose 中的 Navigation 时，<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fnavigation%3Fhl%3Dzh-cn%23getting-started" target="_blank" title="https://developer.android.com/jetpack/compose/navigation?hl=zh-cn#getting-started" ref="nofollow noopener noreferrer"><code>NavController</code></a> 是核心组件。它可跟踪返回堆栈可组合条目、使堆栈向前移动、支持对返回堆栈执行操作，以及在不同目的地状态之间导航。由于 <code>NavController</code> 是导航的核心，因此在设置 Compose Navigation 时必须先创建它。</p>
<p><code>NavController</code> 是通过调用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fnavigation%2Fcompose%2Fpackage-summary%3Fhl%3Dzh-cn%23rememberNavController(kotlin.Array)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/navigation/compose/package-summary?hl=zh-cn#rememberNavController(kotlin.Array)" ref="nofollow noopener noreferrer"><code>rememberNavController()</code></a> 函数获取的。这将创建并<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fstate%3Fhl%3Dzh-cn%23state-in-composables" target="_blank" title="https://developer.android.com/jetpack/compose/state?hl=zh-cn#state-in-composables" ref="nofollow noopener noreferrer">记住</a> <code>NavController</code>，它可以在配置更改后继续存在（使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fsaveable%2Fpackage-summary%3Fhl%3Dzh-cn%23rememberSaveable(kotlin.Array%2Candroidx.compose.runtime.saveable.Saver%2Ckotlin.String%2Ckotlin.Function0)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/saveable/package-summary?hl=zh-cn#rememberSaveable(kotlin.Array,androidx.compose.runtime.saveable.Saver,kotlin.String,kotlin.Function0)" ref="nofollow noopener noreferrer"><code>rememberSaveable</code></a>）。</p>
<blockquote>
<p><strong>注意</strong>：此 Codelab 不会介绍 Compose 中状态管理的基础知识。如果您需要了解详情，不妨考虑仔细阅读 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fstate%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/jetpack/compose/state?hl=zh-cn" ref="nofollow noopener noreferrer">“状态和 Jetpack Compose”文档</a>或学习<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fcodelabs%2Fjetpack-compose-state%3Fhl%3Dzh-cn%230" target="_blank" title="https://developer.android.com/codelabs/jetpack-compose-state?hl=zh-cn#0" ref="nofollow noopener noreferrer">“Jetpack Compose 中的状态”Codelab</a>。</p>
</blockquote>
<p>一定要创建 <code>NavController</code> 并将其放置在可组合项层次结构的顶层（通常位于 <code>App</code> 可组合项中）。之后，所有需要引用 <code>NavController</code> 的可组合项都可以访问它。这么做符合<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fstate%3Fhl%3Dzh-cn%23state-hoisting" target="_blank" title="https://developer.android.com/jetpack/compose/state?hl=zh-cn#state-hoisting" ref="nofollow noopener noreferrer">状态提升</a>的原则，并可确保 <code>NavController</code> 是在可组合屏幕之间导航和维护返回堆栈的主要可信来源。</p>
<p>打开 <code>RallyActivity.kt</code>。使用 <code>RallyApp</code> 内的 <code>rememberNavController()</code> 获取 <code>NavController</code>，因为它是整个应用的根可组合项和入口点：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.navigation.compose.rememberNavController
<span class="hljs-comment">// ...</span>

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">RallyApp</span><span class="hljs-params">()</span></span> {
    RallyTheme {
        <span class="hljs-keyword">var</span> currentScreen: RallyDestination <span class="hljs-keyword">by</span> remember { mutableStateOf(Overview) }
        <span class="hljs-keyword">val</span> navController = rememberNavController()
        Scaffold(
            <span class="hljs-comment">// ...</span>
        ) { 
            <span class="hljs-comment">// ...</span>
       }
}
</code></pre>
<h3 data-id="heading-9"><strong>Compose Navigation 中的路线</strong></h3>
<p>如前所述，Rally 应用有三个主要目的地，以及一个日后要添加的额外目的地 (<code>SingleAccount</code>)。这些目的地在 <code>RallyDestinations.kt</code> 中定义。我们已经提到，每个目的地都有定义的 <code>icon</code>、<code>route</code> 和 <code>screen</code>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46a1239218a4421c8fc1a0add70c7632~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767098671&amp;x-signature=783l3CkXRXp%2FbMkSC3f7Z3bufH8%3D" alt="image.png" loading="lazy"/></p>
<p>接下来，将这些目的地添加到导航图中，其中 <code>Overview</code> 作为应用启动时的起始目的地。</p>
<p>使用 Compose 中的 Navigation 时，导航图中的每个可组合目的地都与一个<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fnavigation%3Fhl%3Dzh-cn%23create-navhost" target="_blank" title="https://developer.android.com/jetpack/compose/navigation?hl=zh-cn#create-navhost" ref="nofollow noopener noreferrer"><strong>路线</strong></a>相关联。路线用字符串表示，用于定义指向可组合项的路径，并指引您的 <code>navController</code> 到达正确的位置。您可以将其视为指向特定目的地的隐式深层链接。<strong>每个目的地都必须有一条唯一的路线</strong>。</p>
<p>为此，我们会使用每个 <code>RallyDestination</code> 对象的 <code>route</code> 属性。例如，<code>Overview.route</code> 是将您转到 <code>Overview</code> 屏幕可组合项的路线。</p>
<h3 data-id="heading-10"><strong>使用导航图调用 NavHost 可组合项</strong></h3>
<p>下一步是添加 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fnavigation%3Fhl%3Dzh-cn%23create-navhost" target="_blank" title="https://developer.android.com/jetpack/compose/navigation?hl=zh-cn#create-navhost" ref="nofollow noopener noreferrer"><code>NavHost</code></a> 并创建导航图。</p>
<p>Navigation 的 3 个主要部分是 <code>NavController</code>、<code>NavGraph</code> 和 <code>NavHost</code>。<code>NavController</code> 始终与一个 <code>NavHost</code> 可组合项相关联。<code>NavHost</code> 充当容器，负责显示导航图的当前目的地。当您在可组合项之间进行导航时，<code>NavHost</code> 的内容会自动进行<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fmental-model%3Fhl%3Dzh-cn%23recomposition" target="_blank" title="https://developer.android.com/jetpack/compose/mental-model?hl=zh-cn#recomposition" ref="nofollow noopener noreferrer">重组</a>。此外，它还会将 <code>NavController</code> 与导航图 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroidx%2Fnavigation%2FNavGraph%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/androidx/navigation/NavGraph?hl=zh-cn" ref="nofollow noopener noreferrer"><code>NavGraph</code></a>) 相关联，后者用于标出能够在其间进行导航的可组合目的地。它实际上是一系列可提取的目的地。</p>
<p>返回到 <code>RallyActivity.kt</code> 中的 <code>RallyApp</code> 可组合项。将 <code>Scaffold</code> 内的 <code>Box</code> 可组合项（其中包含当前屏幕的内容，用于手动切换屏幕）替换为新的 <code>NavHost</code>（可按照以下代码示例进行创建）。</p>
<p>传入我们在上一步中创建的 <code>navController</code>，以将其挂接到这个 <code>NavHost</code>。如前所述，每个 <code>NavController</code> 都必须与一个 <code>NavHost</code> 相关联。</p>
<p><code>NavHost</code> 还需要一个 <code>startDestination</code> 路线才能知道在应用启动时显示哪个目的地，因此请将其设置为 <code>Overview.route</code>。此外，传递 <code>Modifier</code> 以接受外部 <code>Scaffold</code> 内边距，然后将其应用于 <code>NavHost</code>。</p>
<p>最后一个形参 <code>builder: NavGraphBuilder.() -&gt; Unit</code> 负责定义和构建导航图。该形参使用的是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fguide%2Fnavigation%2Fnavigation-kotlin-dsl%3Fhl%3Dzh-cn%23navgraphbuilder" target="_blank" title="https://developer.android.com/guide/navigation/navigation-kotlin-dsl?hl=zh-cn#navgraphbuilder" ref="nofollow noopener noreferrer">Navigation Kotlin DSL</a> 中的 lambda 语法，因此可作为函数正文内部的尾随 lambda 传递并从括号中取出：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.navigation.compose.NavHost
...

Scaffold(...) { innerPadding -&gt;
    NavHost(
        navController = navController,
        startDestination = Overview.route,
        modifier = Modifier.padding(innerPadding)
    ) { 
       <span class="hljs-comment">// builder parameter will be defined here as the graph</span>
    }
}
</code></pre>
<h3 data-id="heading-11">向 Nav<strong>Graph</strong> 添加目的地</h3>
<p>现在，您可以定义导航图以及 <code>NavController</code> 可导航到的目的地。如上所述，<code>builder</code> 形参要求使用函数，因此 Navigation Compose 提供了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fnavigation%2Fcompose%2Fpackage-summary%3Fhl%3Dzh-cn%23(androidx.navigation.NavGraphBuilder).composable(kotlin.String%2C%2520kotlin.collections.List%2C%2520kotlin.collections.List%2C%2520kotlin.Function1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/navigation/compose/package-summary?hl=zh-cn#(androidx.navigation.NavGraphBuilder).composable(kotlin.String,%20kotlin.collections.List,%20kotlin.collections.List,%20kotlin.Function1)" ref="nofollow noopener noreferrer"><code>NavGraphBuilder.composable</code></a> 扩展函数，以便轻松将各个可组合目的地添加到导航图中，并定义必要的导航信息。</p>
<p>第一个目的地是 <code>Overview</code>，因此您需要通过 <code>composable</code> 扩展函数添加它，并为其设置唯一字符串 <code>route</code>。此操作只会将目的地添加到导航图中，因此您还需要定义导航到此目的地时要显示的实际界面。此外，还可通过 <code>composable</code> 函数正文内部的尾随 lambda 完成此操作，这是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fkotlin%3Fhl%3Dzh-cn%23trailing-lambdas" target="_blank" title="https://developer.android.com/jetpack/compose/kotlin?hl=zh-cn#trailing-lambdas" ref="nofollow noopener noreferrer">Compose 中常用的模式</a>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.navigation.compose.composable
<span class="hljs-comment">// ...</span>

NavHost(
    navController = navController,
    startDestination = Overview.route,
    modifier = Modifier.padding(innerPadding)
) { 
    composable(route = Overview.route) { 
        Overview.screen()
    }
}
</code></pre>
<p>我们会按照这种模式将所有三个主屏幕可组合项添加为三个目的地：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">NavHost(
    navController = navController,
    startDestination = Overview.route,
    modifier = Modifier.padding(innerPadding)
) { 
    composable(route = Overview.route) {
        Overview.screen()
    }
    composable(route = Accounts.route) {
        Accounts.screen()
    }
    composable(route = Bills.route) {
        Bills.screen()
    }
</code></pre>
<p>现在运行应用，您会看到 <code>Overview</code> 作为起始目的地，以及其对应的界面。</p>
<p>我们之前提到过自定义顶部标签页栏可组合项 <code>RallyTabRow</code>，该可组合项之前处理了屏幕之间的手动导航。此时，它尚未与新导航相关联，因此您可以验证一下点击标签页是否会更改所显示屏幕可组合项的目的地。</p>
<h2 data-id="heading-12">5. 将 RallyTabRow 与导航集成</h2>
<p>在此步骤中，您需要将 <code>RallyTabRow</code> 与 <code>navController</code> 和导航图连接起来，以便其导航到正确的目的地。</p>
<p>为此，您需要使用新的 <code>navController</code>，为 <code>RallyTabRow</code> 的 <code>onTabSelected</code> 回调定义正确的导航操作。此回调定义了选择特定标签页图标时应发生的情况，并通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fnavigation%3Fhl%3Dzh-cn%23nav-to-composable" target="_blank" title="https://developer.android.com/jetpack/compose/navigation?hl=zh-cn#nav-to-composable" ref="nofollow noopener noreferrer"><code>navController.navigate(route)</code></a> 执行导航操作<code>.</code></p>
<blockquote>
<p><strong>注意</strong>：为了使代码具有可测试性且可重复使用，建议不要将整个 <code>navController</code> 直接传递给可组合项。不过，您应该始终提供回调，定义您希望触发的确切导航操作。</p>
</blockquote>
<p>遵循此指南，在 <code>RallyActivity</code> 中找到 <code>RallyTabRow</code> 可组合项及其回调形参 <code>onTabSelected</code>。</p>
<p>由于我们希望点按标签页后导航到特定目的地，因此您还需要知道所选择的确切标签页图标。幸运的是，<code>onTabSelected: (RallyDestination) -&gt; Unit</code> 形参已提供这些信息。您将使用这些信息和 <code>RallyDestination</code> 路线来指引 <code>navController</code> 并在用户选择标签页时调用 <code>navController.navigate(newScreen.route)</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">RallyApp</span><span class="hljs-params">()</span></span> {
    RallyTheme {
        <span class="hljs-keyword">var</span> currentScreen: RallyDestination <span class="hljs-keyword">by</span> remember { mutableStateOf(Overview) }
        <span class="hljs-keyword">val</span> navController = rememberNavController()
        Scaffold(
            topBar = {
                RallyTabRow(
                    allScreens = rallyTabRowScreens,
                    <span class="hljs-comment">// Pass the callback like this,</span>
                    <span class="hljs-comment">// defining the navigation action when a tab is selected:</span>
                    onTabSelected = { newScreen -&gt;
                        navController.navigate(newScreen.route)
                    },
                    currentScreen = currentScreen,
                )
            }
</code></pre>
<p>如果现在运行应用，可以验证点按 <code>RallyTabRow</code> 中的各个标签页是否确实会导航到正确的可组合目的地。不过，您目前可能已经注意到以下两个问题：</p>
<ol>
<li>重按同一标签页会启动同一目的地的多个副本</li>
<li>标签页的界面与所显示的正确目的地不符，也就是说，无法正常展开和收起所选标签页：</li>
</ol>
<p>下面我们来解决这两个问题！</p>
<h3 data-id="heading-13"><strong>启动目的地的单个副本</strong></h3>
<p>为了解决第一个问题，并确保返回堆栈顶部最多只有给定目的地的一个副本，Compose Navigation API 提供了一个 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fnavigation%2FNavOptionsBuilder%3Fhl%3Dzh-cn%23launchSingleTop()" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/navigation/NavOptionsBuilder?hl=zh-cn#launchSingleTop()" ref="nofollow noopener noreferrer"><code>launchSingleTop</code></a> 标志，您可以将其传递给 <code>navController.navigate()</code> 操作，如下所示：</p>
<p><code>navController.navigate(route) { launchSingleTop = true }</code></p>
<p>由于您希望在整个应用中实现这种行为，因此对于每个目的地，不要将此标志复制粘贴到所有的 .<code>navigate(...)</code> 调用中，而是将其提取到 <code>RallyActivity</code> 底部的辅助扩展程序中。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.navigation.NavHostController
<span class="hljs-comment">// ...</span>

<span class="hljs-function"><span class="hljs-keyword">fun</span> NavHostController.<span class="hljs-title">navigateSingleTopTo</span><span class="hljs-params">(route: <span class="hljs-type">String</span>)</span></span> =
    <span class="hljs-keyword">this</span>.navigate(route) { launchSingleTop = <span class="hljs-literal">true</span> }
</code></pre>
<p>现在，您可以将 <code>navController.navigate(newScreen.route)</code> 调用替换为 .<code>navigateSingleTopTo(...)</code>。重新运行应用，然后验证一下：在顶栏中多次点击其图标时，现在是否只会获得单个目的地的一个副本：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">RallyApp</span><span class="hljs-params">()</span></span> {
    RallyTheme {
        <span class="hljs-keyword">var</span> currentScreen: RallyDestination <span class="hljs-keyword">by</span> remember { mutableStateOf(Overview) }
        <span class="hljs-keyword">val</span> navController = rememberNavController()
        Scaffold(
            topBar = {
                RallyTabRow(
                    allScreens = rallyTabRowScreens,
                    onTabSelected = { newScreen -&gt;
                        navController
                            .navigateSingleTopTo(newScreen.route)
                    },
                    currentScreen = currentScreen,
                )
            }
</code></pre>
<h3 data-id="heading-14"><strong>控制导航选项和返回堆栈状态</strong></h3>
<p>除了 <code>launchSingleTop</code> 之外，您还可以使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fnavigation%2FNavOptionsBuilder%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/navigation/NavOptionsBuilder?hl=zh-cn" ref="nofollow noopener noreferrer"><code>NavOptionsBuilder</code></a> 中的其他标志进一步控制和自定义导航行为。由于 <code>RallyTabRow</code> 的作用类似于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fmaterial%2Fpackage-summary%3Fhl%3Dzh-cn%23BottomNavigation(androidx.compose.ui.Modifier%2Candroidx.compose.ui.graphics.Color%2Candroidx.compose.ui.graphics.Color%2Candroidx.compose.ui.unit.Dp%2Ckotlin.Function1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/material/package-summary?hl=zh-cn#BottomNavigation(androidx.compose.ui.Modifier,androidx.compose.ui.graphics.Color,androidx.compose.ui.graphics.Color,androidx.compose.ui.unit.Dp,kotlin.Function1)" ref="nofollow noopener noreferrer"><code>BottomNavigation</code></a>，因此您还应想一想，在导航到和离开目的地时是否要保存并恢复目的地状态。例如，如果要滚动到“Overview”屏幕底部，然后导航到“Accounts”屏幕，接着返回，那么您是否要保持滚动位置？是否要重按 <code>RallyTabRow</code> 中的同一目的地，以重新加载屏幕状态？这些都是有效问题，应根据您自己的应用设计要求来确定。</p>
<p>我们将介绍同一 <code>navigateSingleTopTo</code> 扩展函数中可供您使用的一些其他选项：</p>
<ul>
<li><code>launchSingleTop = true</code> - 如上所述，这可确保返回堆栈顶部最多只有给定目的地的一个副本</li>
<li>在 Rally 应用中，这意味着，多次重按同一标签页不会启动同一目的地的多个副本</li>
<li><code>popUpTo(startDestination) { saveState = true }</code> - 弹出到导航图的起始目的地，以免在您选择标签页时在返回堆栈上积累大量目的地</li>
<li>在 Rally 中，这意味着，在任何目的地按下返回箭头都会将整个返回堆栈弹出到“Overview”屏幕</li>
<li><code>restoreState = true</code> - 确定此导航操作是否应恢复 <code>PopUpToBuilder.saveState</code> 或 <code>popUpToSaveState</code> 属性之前保存的任何状态。请注意，如果之前未使用要导航到的目的地 ID 保存任何状态，<strong>此项不会产生任何影响</strong></li>
<li>在 Rally 中，这意味着，重按同一标签页会保留屏幕上之前的数据和用户状态，而无需重新加载</li>
</ul>
<p>您可以将所有这些选项逐一添加到代码中，然后在添加每个选项后运行应用，并在添加每个标志后验证确切行为。这样一来，您就可以在实践中了解每个标志是如何更改导航和返回堆栈状态的：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.navigation.NavHostController
<span class="hljs-keyword">import</span> androidx.navigation.NavGraph.Companion.findStartDestination
<span class="hljs-comment">// ...</span>

<span class="hljs-function"><span class="hljs-keyword">fun</span> NavHostController.<span class="hljs-title">navigateSingleTopTo</span><span class="hljs-params">(route: <span class="hljs-type">String</span>)</span></span> =
    <span class="hljs-keyword">this</span>.navigate(route) { 
        popUpTo(
            <span class="hljs-keyword">this</span><span class="hljs-symbol">@navigateSingleTopTo</span>.graph.findStartDestination().id
        ) {
            saveState = <span class="hljs-literal">true</span>
        }
        launchSingleTop = <span class="hljs-literal">true</span>
        restoreState = <span class="hljs-literal">true</span>
}
</code></pre>
<blockquote>
<p><strong>注意</strong>：如果您需要有关管理多个返回堆栈的更多指导，请参阅<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fguide%2Fnavigation%2Fmulti-back-stacks%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/guide/navigation/multi-back-stacks?hl=zh-cn" ref="nofollow noopener noreferrer">有关支持多个返回堆栈的文档</a>。</p>
</blockquote>
<h3 data-id="heading-15"><strong>解决标签页界面问题</strong></h3>
<p>在此 Codelab 开始时，<code>RallyTabRow</code> 虽然仍在使用手动导航机制，但会使用 <code>currentScreen</code> 变量来确定是展开还是收起各个标签页。</p>
<p>不过，在您完成更改后，<code>currentScreen</code> 将不再更新。因此，<code>RallyTabRow</code> 内展开和收起所选标签页的操作不再起作用。</p>
<p>如需使用 Compose Navigation 重新启用此行为，您需要知道在每个时间点显示的当前目的地是什么（或者用导航术语来说，当前返回堆栈条目的顶部是什么），然后在此行为每次更改时更新 <code>RallyTabRow</code>。</p>
<p>如需以 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2FState%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/State?hl=zh-cn" ref="nofollow noopener noreferrer"><code>State</code></a> 的形式获取返回堆栈中当前目的地的实时更新，您可以使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fnavigation%2Fcompose%2Fpackage-summary%3Fhl%3Dzh-cn%23(androidx.navigation.NavController).currentBackStackEntryAsState()" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/navigation/compose/package-summary?hl=zh-cn#(androidx.navigation.NavController).currentBackStackEntryAsState()" ref="nofollow noopener noreferrer"><code>navController.currentBackStackEntryAsState()</code></a>，然后获取其当前 <code>destination:</code></p>
<blockquote>
<p><strong>注意</strong>：此 Codelab 不会介绍 Compose 中状态管理的基础知识。如果您需要了解详情，不妨考虑仔细阅读 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fstate%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/jetpack/compose/state?hl=zh-cn" ref="nofollow noopener noreferrer">“状态和 Jetpack Compose”文档</a>或学习<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fcodelabs%2Fjetpack-compose-state%3Fhl%3Dzh-cn%230" target="_blank" title="https://developer.android.com/codelabs/jetpack-compose-state?hl=zh-cn#0" ref="nofollow noopener noreferrer">“Jetpack Compose 中的状态”Codelab</a>。</p>
</blockquote>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.navigation.compose.currentBackStackEntryAsState
<span class="hljs-keyword">import</span> androidx.compose.runtime.getValue
<span class="hljs-comment">// ...</span>

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">RallyApp</span><span class="hljs-params">()</span></span> {
    RallyTheme {
        <span class="hljs-keyword">val</span> navController = rememberNavController()

        <span class="hljs-keyword">val</span> currentBackStack <span class="hljs-keyword">by</span> navController.currentBackStackEntryAsState()
        <span class="hljs-comment">// Fetch your currentDestination: </span>
        <span class="hljs-keyword">val</span> currentDestination = currentBackStack?.destination
        <span class="hljs-comment">// ...</span>
    }
}
</code></pre>
<p><code>currentBackStack?.destination</code> 会返回 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fnavigation%2FNavDestination%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/navigation/NavDestination?hl=zh-cn" ref="nofollow noopener noreferrer"><code>NavDestination</code></a><code>.</code>如需重新正确更新 <code>currentScreen</code>，您需要想方设法将返回值 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fnavigation%2FNavDestination%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/navigation/NavDestination?hl=zh-cn" ref="nofollow noopener noreferrer"><code>NavDestination</code></a> 与 Rally 的三个主要屏幕可组合项之一进行匹配。您必须确定当前显示的目的地，以便随后将这些信息传递给 <code>RallyTabRow.</code>如前所述，每个目的地都有一条唯一的路线，因此我们可以使用此 String 路线作为类似的 ID，以进行严格的对比并找到唯一匹配。</p>
<p>如需更新 <code>currentScreen</code>，您需要迭代 <code>rallyTabRowScreens</code> 列表，以找到匹配路线，然后返回对应的 <code>RallyDestination</code>。Kotlin 为此提供了一个便捷的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fapi%2Flatest%2Fjvm%2Fstdlib%2Fkotlin.collections%2Ffind.html" target="_blank" title="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.collections/find.html" ref="nofollow noopener noreferrer"><code>.find()</code></a> 函数：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.navigation.compose.currentBackStackEntryAsState
<span class="hljs-keyword">import</span> androidx.compose.runtime.getValue
<span class="hljs-comment">// ...</span>

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">RallyApp</span><span class="hljs-params">()</span></span> {
    RallyTheme {
        <span class="hljs-keyword">val</span> navController = rememberNavController()

        <span class="hljs-keyword">val</span> currentBackStack <span class="hljs-keyword">by</span> navController.currentBackStackEntryAsState()
        <span class="hljs-keyword">val</span> currentDestination = currentBackStack?.destination

        <span class="hljs-comment">// Change the variable to this and use Overview as a backup screen if this returns null</span>
        <span class="hljs-keyword">val</span> currentScreen = rallyTabRowScreens.find { it.route == currentDestination?.route } ?: Accounts
        <span class="hljs-comment">// ...</span>
    }
}
</code></pre>
<p>由于已将 <code>currentScreen</code> 传递给 <code>RallyTabRow</code>，因此您可以运行应用，并验证标签页栏界面现在是否已相应更新。</p>
<blockquote>
<p><strong>注意</strong>：现在也支持直接通过 Navigation Component 进行返回行为导航。您无需为它进行任何其他设置。在目的地之间切换，然后按返回按钮后，系统会正确弹出返回堆栈并转到上一个目的地。</p>
</blockquote>
<h2 data-id="heading-16">6. 从 RallyDestination 中提取屏幕可组合项</h2>
<p>到目前为止，为简单起见，我们一直使用 <code>RallyDestination</code> 接口中的 <code>screen</code> 属性以及通过该属性扩展的屏幕对象，将可组合界面添加到 <code>NavHost (RallyActivity.kt</code>) 中：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> com.example.compose.rally.ui.overview.OverviewScreen
<span class="hljs-comment">// ...</span>

NavHost(
    navController = navController,
    startDestination = Overview.route,
    modifier = Modifier.padding(innerPadding)
) { 
    composable(route = Overview.route) { 
        Overview.screen()
    }
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>不过，此 Codelab 中的后续步骤（例如点击事件）需要将额外信息直接传递给可组合屏幕。在生产环境中，肯定需要传递更多数据。</p>
<p>若要实现这一目标，正确且更简洁的方式是将可组合项直接添加到 <code>NavHost</code> 导航图中，然后从 <code>RallyDestination</code> 中提取。之后，<code>RallyDestination</code> 和屏幕对象将仅保存导航专属信息（例如 <code>icon</code> 和 <code>route</code>），还将与任何与 Compose 界面相关的信息分离。</p>
<p>打开 <code>RallyDestinations.kt</code>。将每个屏幕的可组合项从 <code>RallyDestination</code> 对象的 <code>screen</code> 形参提取到 <code>NavHost</code> 中对应的 <code>composable</code> 函数中，以替换之前的 <code>.screen()</code> 调用，如下所示<code>:</code></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> com.example.compose.rally.ui.accounts.AccountsScreen
<span class="hljs-keyword">import</span> com.example.compose.rally.ui.bills.BillsScreen
<span class="hljs-keyword">import</span> com.example.compose.rally.ui.overview.OverviewScreen
<span class="hljs-comment">// ...</span>

NavHost(
    navController = navController,
    startDestination = Overview.route,
    modifier = Modifier.padding(innerPadding)
) {
    composable(route = Overview.route) {
        OverviewScreen()
    }
    composable(route = Accounts.route) {
        AccountsScreen()
    }
    composable(route = Bills.route) {
        BillsScreen()
    }
}
</code></pre>
<p>此时，您可以从 <code>RallyDestination</code> 及其对象中安全移除 <code>screen</code> 形参：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">RallyDestination</span> {
    <span class="hljs-keyword">val</span> icon: ImageVector
    <span class="hljs-keyword">val</span> route: String
}

<span class="hljs-comment">/**
 * Rally app navigation destinations
 */</span>
<span class="hljs-keyword">object</span> Overview : RallyDestination {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> icon = Icons.Filled.PieChart
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> route = <span class="hljs-string">"overview"</span>
}
<span class="hljs-comment">// ...</span>
</code></pre>
<p>再次运行应用，并验证一切是否像先前一样正常运行。现在，您已经完成此步骤，接下来可以在可组合屏幕中设置点击事件了。</p>
<h3 data-id="heading-17">对 OverviewScreen 启用点击</h3>
<p>目前，<code>OverviewScreen</code> 中的所有点击事件都已被忽略。也就是说，“Accounts”和“Bills”的子部分“SEE ALL”按钮可供点击，但实际上不会转到任何位置。此步骤的目的是为这些点击事件启用导航。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/986335db3edf4d6f9c61e81fb52cd3c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767098671&amp;x-signature=A8JVziZPYqijXPG3Tq3C2fgRizI%3D" alt="image.png" loading="lazy"/></p>
<p><code>OverviewScreen</code> 可组合项可以接受多个函数作为回调，以设置为点击事件，在本示例中，这应该是可让您转到 <code>AccountsScreen</code> 或 <code>BillsScreen</code> 的导航操作。我们来将这些导航回调传递给 <code>onClickSeeAllAccounts</code> 和 <code>onClickSeeAllBills</code>，以导航到相关目的地。</p>
<p>打开 <code>RallyActivity.kt</code>，在 <code>NavHost</code> 中找到 <code>OverviewScreen</code>，然后将 <code>navController.navigateSingleTopTo(...)</code> 传递给具有相应路线的两个导航回调：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">OverviewScreen(
    onClickSeeAllAccounts = {
        navController.navigateSingleTopTo(Accounts.route) 
    },
    onClickSeeAllBills = { 
        navController.navigateSingleTopTo(Bills.route) 
    }
)
</code></pre>
<p><code>navController</code> 现在将获得足够的信息（例如确切目的地的路线）<code>,</code>可在用户点击按钮时导航到正确的目的地。如果您查看 <code>OverviewScreen</code> 的实现，便会发现这些回调已设置为相应的 <code>onClick</code> 形参<code>:</code></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">OverviewScreen</span><span class="hljs-params">(...)</span></span> {
    <span class="hljs-comment">// ...</span>
    AccountsCard(
        onClickSeeAll = onClickSeeAllAccounts,
        onAccountClick = onAccountClick
    )
    <span class="hljs-comment">// ...</span>
    BillsCard(
        onClickSeeAll = onClickSeeAllBills
    )
}
</code></pre>
<p>如前所述，若能将 <code>navController</code> 保持在导航层次结构的顶层并将其提升到 <code>App</code> 可组合项级别（例如，不将其直接传递给 <code>OverviewScreen)</code>，就可以轻松地单独预览、重复使用和测试 <code>OverviewScreen</code> 可组合项，而不必依赖于实际或模拟的 <code>navController</code> 实例。此外，改为传递回调还可让您快速更改点击事件！</p>
<h2 data-id="heading-18">7. 使用实参导航到 SingleAccountScreen</h2>
<p>让我们为 <code>Accounts</code> 和 <code>Overview</code> 屏幕添加一些新功能！目前，这些屏幕会显示一个包含多种不同类型账户（“Checking”“Home Savings”等）的列表。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80c666002dac45d5a9cafe0970ad43b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767098671&amp;x-signature=jCxAndPgpk14a6N4SIviRLd0v34%3D" alt="image.png" loading="lazy"/></p>
<p>不过，点击这些账户类型（目前）不会起任何作用。接下来，让我们解决这个问题！在点按每个账号类型后，我们希望看到一个包含完整账号详细信息的新屏幕。为此，我们需要向 <code>navController</code> 提供与所点击的确切账户类型有关的其他信息。这可以通过<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fnavigation%3Fhl%3Dzh-cn%23nav-with-args" target="_blank" title="https://developer.android.com/jetpack/compose/navigation?hl=zh-cn#nav-with-args" ref="nofollow noopener noreferrer">实参</a>实现。</p>
<p>实参是一类非常强大的工具，它们会将一个或多个实参传递给路线，从而使导航路线变为动态形式。它支持根据所提供的不同实参显示不同的信息。</p>
<blockquote>
<p><strong>注意</strong>：具名实参的定义方式是附加到路线并用大括号括起来，如下所示：<code>{argument}</code>。其语法与 Kotlin 的 String 模板语法类似，均在必要时使用美元符号来转义变量名称，例如：<code>{${argument}}</code></p>
</blockquote>
<p>在 <code>RallyApp</code> 中，通过向现有 <code>NavHost:</code> 添加新的 <code>composable</code> 函数，将新的目的地 <code>SingleAccountScreen</code>（用于处理这些具体账户的显示操作）添加到导航图中：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> com.example.compose.rally.ui.accounts.SingleAccountScreen
<span class="hljs-comment">// ...</span>

NavHost(
    navController = navController,
    startDestination = Overview.route,
    modifier = Modifier.padding(innerPadding)
) {
    ...
    composable(route = SingleAccount.route) {
        SingleAccountScreen()
    }
}
</code></pre>
<h3 data-id="heading-19"><strong>设置 SingleAccountScreen 到达目的地</strong></h3>
<p>当您到达 <code>SingleAccountScreen</code> 时，此目的地将需要更多信息才能知道打开时应显示的确切账户类型。我们可以使用实参传递此类信息。您需要指明，其路线还需要一个实参 <code>{account_type}</code>。如果您查看 <code>RallyDestination</code> 及其 <code>SingleAccount</code> 对象，便会发现该实参已定义为 <code>accountTypeArg</code> String，供您使用。</p>
<p>如需在导航时随路线一起传递实参，您需要按照以下模式将它们附加在一起：<code>"route/{argument}"</code>。在本示例中，应如下所示：<code>"${SingleAccount.route}/{${SingleAccount.accountTypeArg}}"</code>。请注意，$ 符号用于转义变量：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.navigation.NavType
<span class="hljs-keyword">import</span> androidx.navigation.compose.navArgument
<span class="hljs-comment">// ...</span>

composable(
    route =
        <span class="hljs-string">"<span class="hljs-subst">${SingleAccount.route}</span>/{<span class="hljs-subst">${SingleAccount.accountTypeArg}</span>}"</span>
) { 
    SingleAccountScreen()
}
</code></pre>
<p>这样可确保当操作被触发以导航到 <code>SingleAccountScreen</code> 时，还必须传递 <code>accountTypeArg</code> 实参，否则导航将会失败。您可以将其视为其他要导航到 <code>SingleAccountScreen</code> 的目的地需要遵循的签名或协定。</p>
<blockquote>
<p><strong>注意</strong>：为了提高代码安全性和处理任何极端情况，您还可以将默认值设置为实参并明确指定其类型。</p>
</blockquote>
<p>第二步是让此 <code>composable</code> 知道它应该接受实参。为此，您可以定义其 <code>arguments</code> 形参。您可以根据需要定义任意数量的实参，因为 <code>composable</code> 函数默认接受实参列表。在本示例中，您只需添加一个名为 <code>accountTypeArg</code> 的实参，并将其类型指定为 <code>String</code>，即可提高安全性。如果您未明确设置类型，系统将根据此实参的默认值推断出其类型：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.navigation.NavType
<span class="hljs-keyword">import</span> androidx.navigation.compose.navArgument
<span class="hljs-comment">// ...</span>

composable(
    route =
        <span class="hljs-string">"<span class="hljs-subst">${SingleAccount.route}</span>/{<span class="hljs-subst">${SingleAccount.accountTypeArg}</span>}"</span>,
    arguments = listOf(
        navArgument(SingleAccount.accountTypeArg) { type = NavType.StringType }
    )
) { 
    SingleAccountScreen()
}
</code></pre>
<p>这样就可以做到完美运行，您可以选择保留代码，如下所示。不过，由于我们的所有目的地专属信息都位于 <code>RallyDestinations.kt</code> 及其对象中，因此我们会继续采用相同的方法（就像我们在前面为 <code>Overview</code>、<code>Accounts,</code> 和 <code>Bills</code> 采取的方法一样）并将此实参列表迁移到 <code>SingleAccount:</code></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">object</span> SingleAccount : RallyDestination {
    <span class="hljs-comment">// ...</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> route = <span class="hljs-string">"single_account"</span>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> accountTypeArg = <span class="hljs-string">"account_type"</span>
    <span class="hljs-keyword">val</span> arguments = listOf(
        navArgument(accountTypeArg) { type = NavType.StringType }
    )
}
</code></pre>
<p>将之前的实参替换为 <code>SingleAccount.arguments</code>，现在返回到相应的 NavHost <code>composable</code>。这还可以确保让 <code>NavHost</code> 尽可能简洁且易读：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">composable(
    route = <span class="hljs-string">"<span class="hljs-subst">${SingleAccount.route}</span>/{<span class="hljs-subst">${SingleAccount.accountTypeArg}</span>}"</span>,
    arguments =  SingleAccount.arguments
) {
    SingleAccountScreen()
}
</code></pre>
<p>现在，您已使用实参定义了 <code>SingleAccountScreen</code> 的完整路线，接下来要确保将此 <code>accountTypeArg</code> 进一步向下传递给 <code>SingleAccountScreen</code> 可组合项，这样它就会知道要正确显示哪个账户类型。如果您查看 <code>SingleAccountScreen</code> 的实现，就会发现它已设置完毕且正在等待接受 <code>accountType</code> 形参：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">SingleAccountScreen</span><span class="hljs-params">(
    accountType: <span class="hljs-type">String</span>? = UserData.accounts.first()</span></span>.name
) { 
   <span class="hljs-comment">// ... </span>
}
</code></pre>
<p>简而言之，到目前为止：</p>
<ul>
<li>您已确保我们定义请求实参的路线，作为先前目的地的信号</li>
<li>您已确保 <code>composable</code> 知道它需要接受实参</li>
</ul>
<p>最后一步是以某种方式真正<strong>检索传递的实参</strong>值。</p>
<p>在 Compose Navigation 中，每个 <code>NavHost</code> 可组合函数都可以访问当前的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fnavigation%2FNavBackStackEntry%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/navigation/NavBackStackEntry?hl=zh-cn" ref="nofollow noopener noreferrer"><code>NavBackStackEntry</code></a>，该类用于保存当前路线的相关信息，以及返回堆栈中条目的已传递实参。您可以使用该类从 <code>navBackStackEntry</code> 中获取所需的 <code>arguments</code> 列表，然后搜索并检索所需的确切实参，将其进一步向下传递给可组合屏幕。</p>
<p>在这种情况下，您需要从 <code>navBackStackEntry</code> 请求 <code>accountTypeArg</code>。然后，您需要将其进一步向下传递给 <code>SingleAccountScreen'</code> 的 <code>accountType</code> 形参。</p>
<p>您也可以为实参提供一个默认值（如果尚未提供）作为占位符，并包含这种极端情况，以提高代码的安全性。</p>
<p>现在，您的代码应如下所示：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">NavHost(...) {
    <span class="hljs-comment">// ...</span>
    composable(
        route =
          <span class="hljs-string">"<span class="hljs-subst">${SingleAccount.route}</span>/{<span class="hljs-subst">${SingleAccount.accountTypeArg}</span>}"</span>,
        arguments = SingleAccount.arguments
    ) { navBackStackEntry -&gt;
        <span class="hljs-comment">// Retrieve the passed argument</span>
        <span class="hljs-keyword">val</span> accountType =
            navBackStackEntry.arguments?.getString(SingleAccount.accountTypeArg)

        <span class="hljs-comment">// Pass accountType to SingleAccountScreen</span>
        SingleAccountScreen(accountType)
    }
}
</code></pre>
<p>您的 <code>SingleAccountScreen</code> 现已获得在您导航到那里时显示正确账户类型所需的必要信息。如果您查看 <code>SingleAccountScreen,</code> 的实现，就会发现它已经将传递的 <code>accountType</code> 与 <code>UserData</code> 源进行匹配，以获取相应的账户详细信息。</p>
<p>我们再来执行一项次要优化任务，将 <code>"${SingleAccount.route}/{${SingleAccount.accountTypeArg}}"</code> 路线也移至 <code>RallyDestinations.kt</code> 及其 <code>SingleAccount</code> 对象中<code>:</code></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">object</span> SingleAccount : RallyDestination {
    <span class="hljs-comment">// ...</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> route = <span class="hljs-string">"single_account"</span>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> accountTypeArg = <span class="hljs-string">"account_type"</span>
    <span class="hljs-keyword">val</span> routeWithArgs = <span class="hljs-string">"<span class="hljs-subst">${route}</span>/{<span class="hljs-subst">${accountTypeArg}</span>}"</span>
    <span class="hljs-keyword">val</span> arguments = listOf(
        navArgument(accountTypeArg) { type = NavType.StringType }
    )
}
</code></pre>
<p>同样，在相应的 <code>NavHost composable:</code> 中进行替换</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ...</span>
composable(
    route = SingleAccount.routeWithArgs,
    arguments = SingleAccount.arguments
) {...}
</code></pre>
<h3 data-id="heading-20"><strong>设置“Accounts”和“Overview”的起始目的地</strong></h3>
<p>现在，您已经定义了 <code>SingleAccountScreen</code> 路线及其成功导航到 <code>SingleAccountScreen</code> 所需要和接受的实参，接下来您需要确保是从上一个目的地（即您来自的目的地）传递同一 <code>accountTypeArg</code> 实参。</p>
<p>如您所见，这包含两个方面：一个是提供并传递实参的起始目的地，另一个是接受该实参并使用它显示正确信息的到达目的地。<strong>这两者都需要进行明确定义</strong>。</p>
<p>例如，当您位于 <code>Accounts</code> 目的地，并点按“Checking”账户类型时，“Accounts”目的地需要将“Checking”String（已附加到“single_account”String 路线）作为实参传递，以便成功打开相应的 <code>SingleAccountScreen</code>。其 String 路线将如下所示：<code>"single_account/Checking"</code></p>
<p>使用 <code>navController.navigateSingleTopTo(...),</code> 时，您需要使用与其完全相同的路线，并包含传递的实参，如下所示：</p>
<p><code>navController.navigateSingleTopTo("${SingleAccount.route}/$accountType")</code>。</p>
<p>将此导航操作回调传递给 <code>OverviewScreen</code> 和 <code>AccountsScreen</code> 的 <code>onAccountClick</code> 形参。请注意，这些形参已预定义为 <code>onAccountClick: (String) -&gt; Unit</code>，其中 String 作为输入。也就是说，当用户点按 <code>Overview</code> 和 <code>Account</code> 中的特定账户类型时，该账户类型 String 已经可供您使用，并且可以作为导航实参轻松传递：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">OverviewScreen(
    <span class="hljs-comment">// ...</span>
    onAccountClick = { accountType -&gt;
        navController
          .navigateSingleTopTo(<span class="hljs-string">"<span class="hljs-subst">${SingleAccount.route}</span>/<span class="hljs-variable">$accountType</span>"</span>)
    }
)
<span class="hljs-comment">// ...</span>
                    
AccountsScreen(
    <span class="hljs-comment">// ...</span>
    onAccountClick = { accountType -&gt;
        navController
          .navigateSingleTopTo(<span class="hljs-string">"<span class="hljs-subst">${SingleAccount.route}</span>/<span class="hljs-variable">$accountType</span>"</span>)
    }
)
</code></pre>
<p>为确保内容易于阅读，您可以将此导航操作提取到私有辅助扩展函数中：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.navigation.NavHostController
<span class="hljs-comment">// ...</span>
OverviewScreen(
    <span class="hljs-comment">// ...</span>
    onAccountClick = { accountType -&gt;
        navController.navigateToSingleAccount(accountType)
    }
)

<span class="hljs-comment">// ...</span>
                    
AccountsScreen(
    <span class="hljs-comment">// ...</span>
    onAccountClick = { accountType -&gt;
        navController.navigateToSingleAccount(accountType)
    }
)

<span class="hljs-comment">// ...</span>

<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> NavHostController.<span class="hljs-title">navigateToSingleAccount</span><span class="hljs-params">(accountType: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-keyword">this</span>.navigateSingleTopTo(<span class="hljs-string">"<span class="hljs-subst">${SingleAccount.route}</span>/<span class="hljs-variable">$accountType</span>"</span>)
}
</code></pre>
<p>此时，当您运行应用时，可以点击每个账户类型，系统会将您转到显示给定账户数据的对应 <code>SingleAccountScreen</code>。</p>
<h2 data-id="heading-21">8. 启用深层链接支持</h2>
<p>除了添加实参之外，您还可以添加<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fnavigation%3Fhl%3Dzh-cn%23deeplinks" target="_blank" title="https://developer.android.com/jetpack/compose/navigation?hl=zh-cn#deeplinks" ref="nofollow noopener noreferrer">深层链接</a>，将特定网址、操作和/或 MIME 类型与可组合项关联起来。在 Android 中，深层链接是指将用户直接转到应用内特定目的地的链接。Navigation Compose 支持<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fguide%2Fnavigation%2Fnavigation-deep-link%3Fhl%3Dzh-cn%23implicit" target="_blank" title="https://developer.android.com/guide/navigation/navigation-deep-link?hl=zh-cn#implicit" ref="nofollow noopener noreferrer">隐式深层链接</a>。调用隐式深层链接（例如，当用户点击某个链接）时，Android 可以将应用打开到相应的目的地。</p>
<p>在此部分中，您将添加一个新的深层链接，用于导航到包含相应账户类型的 <code>SingleAccountScreen</code> 可组合项，还要让此深层链接向外部应用公开。我们来回顾一下，此可组合项的路线是 <code>"single_account/{account_type}"</code>，这也是您将用于深层链接的路线，其中包含一些与深层链接相关的细微更改。</p>
<p>默认情况下，系统不会启用向外部应用公开深层链接这一功能，因此您还必须向应用的 <code>manifest.xml</code> 文件添加 <code>&lt;intent-filter&gt;</code> 元素，这是第一步。</p>
<p>首先，向应用的 <code>AndroidManifest.xml</code> 添加深层链接。您需要通过 <code>&lt;activity&gt;</code> 内的 <code>&lt;intent-filter&gt;</code> 创建一个新的 intent 过滤器，相应操作为 <code>VIEW</code>，类别为 <code>BROWSABLE</code> 和 <code>DEFAULT</code>。</p>
<p>然后，在该过滤器内，您需要使用 <code>data</code> 标记添加 <strong><code>scheme</code></strong>（<code>rally</code> - 应用名称）和 <strong><code>host</code></strong>（<code>single_account</code> - 导航到可组合项的路线），以定义精确的深层链接。这将为您提供 <code>rally://single_account</code> 作为深层链接网址。</p>
<p>请注意，您无需在 <code>AndroidManifest</code> 中声明 <code>account_type</code> 实参。该实参稍后会附加到 <code>NavHost</code> 可组合函数内。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">&lt;activity
    android:name=<span class="hljs-string">".RallyActivity"</span>
    android:windowSoftInputMode=<span class="hljs-string">"adjustResize"</span>
    android:label=<span class="hljs-string">"@string/app_name"</span>
    android:exported=<span class="hljs-string">"true"</span>&gt;
    &lt;intent-filter&gt;
        &lt;action android:name=<span class="hljs-string">"android.intent.action.MAIN"</span> /&gt;
        &lt;category android:name=<span class="hljs-string">"android.intent.category.LAUNCHER"</span> /&gt;
    &lt;/intent-filter&gt;
    &lt;intent-filter&gt;
        &lt;action android:name=<span class="hljs-string">"android.intent.action.VIEW"</span> /&gt;
        &lt;category android:name=<span class="hljs-string">"android.intent.category.DEFAULT"</span> /&gt;
        &lt;category android:name=<span class="hljs-string">"android.intent.category.BROWSABLE"</span> /&gt;
        &lt;<span class="hljs-keyword">data</span> android:scheme=<span class="hljs-string">"rally"</span> android:host=<span class="hljs-string">"single_account"</span> /&gt;
    &lt;/intent-filter&gt;
&lt;/activity&gt;
</code></pre>
<h3 data-id="heading-22">触发并验证深层链接</h3>
<p>现在，您可以在 <code>RallyActivity</code> 中响应传入的 intent。</p>
<p>可组合项 <code>SingleAccountScreen</code> 已经接受实参，但现在还需要接受新创建的深层链接，才能在其深层链接触发时启动此目的地。</p>
<p>在 <code>SingleAccountScreen</code> 的可组合函数内，再添加一个形参 <code>deepLinks</code>。与 <code>arguments,</code> 类似，它还接受 <code>navDeepLink</code> 列表，因为您可以定义多个指向同一目的地的深层链接。传递 <code>uriPattern</code>，匹配清单 <code>rally://singleaccount</code> 的 <code>intent-filter</code> 中定义的一个 uriPattern，但这次您还需附加其 <code>accountTypeArg</code> 实参：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.navigation.navDeepLink
<span class="hljs-comment">// ...</span>

composable(
    route = SingleAccount.routeWithArgs,
    <span class="hljs-comment">// ...</span>
    deepLinks = listOf(navDeepLink {
        uriPattern = <span class="hljs-string">"rally://<span class="hljs-subst">${SingleAccount.route}</span>/{<span class="hljs-subst">${SingleAccount.accountTypeArg}</span>}"</span>
    })
)
</code></pre>
<p>您知道接下来该怎么做，对吧？将此列表移至 <code>RallyDestinations SingleAccount:</code></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">object</span> SingleAccount : RallyDestination {
    <span class="hljs-comment">// ...</span>
    <span class="hljs-keyword">val</span> arguments = listOf(
        navArgument(accountTypeArg) { type = NavType.StringType }
    )
    <span class="hljs-keyword">val</span> deepLinks = listOf(
       navDeepLink { uriPattern = <span class="hljs-string">"rally://<span class="hljs-variable">$route</span>/{<span class="hljs-variable">$accountTypeArg</span>}"</span>}
    )
}
</code></pre>
<p>同样，在相应的 <code>NavHost</code> 可组合项中进行替换：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ...</span>
composable(
    route = SingleAccount.routeWithArgs,
    arguments = SingleAccount.arguments,
    deepLinks = SingleAccount.deepLinks
) {...}
</code></pre>
<h3 data-id="heading-23">使用 adb 测试深层链接</h3>
<p>现在，您的应用和 <code>SingleAccountScreen</code> 已准备好处理深层链接。为了测试它能否正常运行，请在已连接的模拟器或设备上重新安装 Rally，打开命令行并执行以下命令，以便模拟深层链接启动：</p>
<pre><code class="hljs language-sql" lang="sql">adb shell am <span class="hljs-keyword">start</span> <span class="hljs-operator">-</span>d "rally://single_account/Checking" <span class="hljs-operator">-</span>a android.intent.action.VIEW
</code></pre>
<p>系统会带您直接进入“Checking”账户，不过您也可以针对所有其他账户类型验证它能否正常运行。</p>
<h2 data-id="heading-24">9. 将 NavHost 提取到 RallyNavHost</h2>
<p>您的 <code>NavHost</code> 现已完成。不过，为了使其可测试并保持 <code>RallyActivity</code> 更加简洁，您可以将当前 <code>NavHost</code> 及其辅助函数（如 <code>navigateToSingleAccount</code>）从 <code>RallyApp</code> 可组合项提取到它自己的可组合函数，并将其命名为 <code>RallyNavHost</code>。</p>
<p><code>RallyApp</code> 是应使用 <code>navController</code> 直接处理的唯一一个可组合项。如前所述，其他每个嵌套的可组合屏幕应该仅获得导航回调，而不是 <code>navController</code> 本身。</p>
<p>因此，新的 <code>RallyNavHost</code> 将接受 <code>RallyApp</code> 中的 <code>navController</code> 和 <code>modifier</code> 作为形参：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">RallyNavHost</span><span class="hljs-params">(
    navController: <span class="hljs-type">NavHostController</span>,
    modifier: <span class="hljs-type">Modifier</span> = Modifier
)</span></span> {
    NavHost(
        navController = navController,
        startDestination = Overview.route,
        modifier = modifier
    ) {
        composable(route = Overview.route) {
            OverviewScreen(
                onClickSeeAllAccounts = {
                    navController.navigateSingleTopTo(Accounts.route)
                },
                onClickSeeAllBills = {
                    navController.navigateSingleTopTo(Bills.route)
                },
                onAccountClick = { accountType -&gt;
                   navController.navigateToSingleAccount(accountType)
                }
            )
        }
        composable(route = Accounts.route) {
            AccountsScreen(
                onAccountClick = { accountType -&gt;
                   navController.navigateToSingleAccount(accountType)
                }
            )
        }
        composable(route = Bills.route) {
            BillsScreen()
        }
        composable(
            route = SingleAccount.routeWithArgs,
            arguments = SingleAccount.arguments,
            deepLinks = SingleAccount.deepLinks
        ) { navBackStackEntry -&gt;
            <span class="hljs-keyword">val</span> accountType =
              navBackStackEntry.arguments?.getString(SingleAccount.accountTypeArg)
            SingleAccountScreen(accountType)
        }
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> NavHostController.<span class="hljs-title">navigateSingleTopTo</span><span class="hljs-params">(route: <span class="hljs-type">String</span>)</span></span> =
    <span class="hljs-keyword">this</span>.navigate(route) { launchSingleTop = <span class="hljs-literal">true</span> }

<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> NavHostController.<span class="hljs-title">navigateToSingleAccount</span><span class="hljs-params">(accountType: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-keyword">this</span>.navigateSingleTopTo(<span class="hljs-string">"<span class="hljs-subst">${SingleAccount.route}</span>/<span class="hljs-variable">$accountType</span>"</span>)
}
</code></pre>
<p>现在，将新的 <code>RallyNavHost</code> 添加到 <code>RallyApp</code>，然后重新运行应用，验证一切是否像先前一样正常运行：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">RallyApp</span><span class="hljs-params">()</span></span> {
    RallyTheme {
    ...
        Scaffold(
        ...
        ) { innerPadding -&gt;
            RallyNavHost(
                navController = navController,
                modifier = Modifier.padding(innerPadding)
            )
        }
     }
}
</code></pre>
<h2 data-id="heading-25">10. 测试 Compose Navigation</h2>
<blockquote>
<p><strong>注意</strong>：此 Codelab 没有介绍 Compose 测试方面的基础知识。如需了解这些内容，请参阅 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Ftesting%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/jetpack/compose/testing?hl=zh-cn" ref="nofollow noopener noreferrer">Compose 测试文档</a>或学习<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fcodelabs%2Fjetpack-compose-testing%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/codelabs/jetpack-compose-testing?hl=zh-cn" ref="nofollow noopener noreferrer">“在 Jetpack Compose 中进行测试”Codelab</a>。</p>
</blockquote>
<p>从此 Codelab 的开头开始，您就确保不将 <code>navController</code> 直接传入任何可组合项（高级应用除外），而是将导航回调作为形参传递。这样一来，您的所有可组合项均可<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fnavigation%3Fhl%3Dzh-cn%23testing" target="_blank" title="https://developer.android.com/jetpack/compose/navigation?hl=zh-cn#testing" ref="nofollow noopener noreferrer">单独测试</a>，因为它们不需要在测试中使用 <code>navController</code> 实例。</p>
<p>一定要测试整个 Compose Navigation 机制能否在应用中按预期运行，方法是测试传递给可组合项的 <code>RallyNavHost</code> 和导航操作。这些将是此部分的主要目标。如需单独测试各个可组合函数，请务必查看<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fcodelabs%2Fjetpack-compose-testing%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/codelabs/jetpack-compose-testing?hl=zh-cn" ref="nofollow noopener noreferrer">在 Jetpack Compose 中进行测试</a> Codelab。</p>
<p>若要开始测试，我们首先需要添加必要的测试依赖项，因此请返回到应用的 build 文件（位于 <code>app/build.gradle</code>）。在测试依赖项部分中，添加 <code>navigation-testing</code> 依赖项：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">dependencies {
<span class="hljs-comment">// ...</span>
  androidTestImplementation <span class="hljs-string">"androidx.navigation:navigation-testing:<span class="hljs-variable">$rootProject</span>.composeNavigationVersion"</span>
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<h3 data-id="heading-26">准备 NavigationTest 类</h3>
<p>您的 <code>RallyNavHost</code> 可独立于 <code>Activity</code> 本身进行测试。</p>
<p>由于此测试仍会在 Android 设备上运行，因此您需要创建测试目录 <code>/app/src/androidTest/java/com/example/compose/rally</code>，然后创建一个新的测试文件来测试类并将其命名为 <code>NavigationTest</code>。</p>
<p>首先，若要使用 Compose 测试 API，以及使用 Compose 进行测试并控制可组合项和应用，请添加 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fui%2Ftest%2Fjunit4%2FComposeTestRule%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/ui/test/junit4/ComposeTestRule?hl=zh-cn" ref="nofollow noopener noreferrer">Compose 测试规则</a>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.compose.ui.test.junit4.createComposeRule
<span class="hljs-keyword">import</span> org.junit.Rule

<span class="hljs-keyword">class</span> <span class="hljs-title class_">NavigationTest</span> {

    <span class="hljs-meta">@get:Rule</span>
    <span class="hljs-keyword">val</span> composeTestRule = createComposeRule()

}
</code></pre>
<h3 data-id="heading-27"><strong>编写首个测试</strong></h3>
<p>创建一个公共 <code>rallyNavHost</code> 测试函数，并为其添加 <code>@Test</code> 注解。在该函数中，首先需要设置要测试的 Compose 内容。您可以使用 <code>composeTestRule</code> 的 <code>setContent</code> 执行此操作。它接受一个可组合形参作为正文，并且支持您编写 Compose 代码，以及在测试环境中添加可组合项，就像您在常规生产环境应用中一样。</p>
<p>在 <code>setContent,</code> 内，您可以设置当前测试对象 <code>RallyNavHost</code>，并将新的 <code>navController</code> 实例传递给该对象。Navigation Testing 工件提供了一个便捷的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fnavigation%2Ftesting%2FTestNavHostController%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/navigation/testing/TestNavHostController?hl=zh-cn" ref="nofollow noopener noreferrer"><code>TestNavHostController</code></a> 供您使用。接下来，我们来添加此步骤：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.compose.ui.platform.LocalContext
<span class="hljs-keyword">import</span> androidx.navigation.compose.ComposeNavigator
<span class="hljs-keyword">import</span> androidx.navigation.testing.TestNavHostController
<span class="hljs-keyword">import</span> org.junit.Assert.fail
<span class="hljs-keyword">import</span> org.junit.Test
<span class="hljs-comment">// ...</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">NavigationTest</span> {

    <span class="hljs-meta">@get:Rule</span>
    <span class="hljs-keyword">val</span> composeTestRule = createComposeRule()

    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> navController: TestNavHostController

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">rallyNavHost</span><span class="hljs-params">()</span></span> {
        composeTestRule.setContent {
            <span class="hljs-comment">// Creates a TestNavHostController</span>
            navController = 
                TestNavHostController(LocalContext.current)
            <span class="hljs-comment">// Sets a ComposeNavigator to the navController so it can navigate through composables</span>
            navController.navigatorProvider.addNavigator(
                ComposeNavigator()
            )
            RallyNavHost(navController = navController)
        }
        fail()
    }
}
</code></pre>
<p>如果您复制了上述代码，<code>fail()</code> 调用会确保您的测试一直失败，直到出现实际断言为止。它用于提醒您完成测试的实现。</p>
<blockquote>
<p><strong>注意</strong>：如需检查 <code>RallyNavHost</code> 能否正常运行，必须先组合其层次结构，然后再测试其他一切内容。这意味着，您的测试断言和验证必须在 <code>setContent</code> 函数<strong>外部和之后</strong>编写。</p>
</blockquote>
<p>如需验证是否显示了正确的屏幕可组合项，您可以使用其 <code>contentDescription</code> 并断言它会显示。在此 Codelab 中，“Accounts”和“Overview”目的地的 <code>contentDescription</code> 之前已设置完毕，因此您已经可以使用它们进行测试验证。</p>
<p>首次验证时，您应该检查“Overview”屏幕在 <code>RallyNavHost</code> 首次初始化时是否会作为第一个目的地显示。您还应重命名测试来反映这一点，不妨将其命名为 <code>rallyNavHost_verifyOverviewStartDestination</code>。为此，请将 <code>fail()</code> 调用替换为以下代码：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.compose.ui.test.assertIsDisplayed
<span class="hljs-keyword">import</span> androidx.compose.ui.test.onNodeWithContentDescription
<span class="hljs-comment">// ...</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">NavigationTest</span> {

    <span class="hljs-meta">@get:Rule</span>
    <span class="hljs-keyword">val</span> composeTestRule = createComposeRule()

    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> navController: TestNavHostController

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">rallyNavHost_verifyOverviewStartDestination</span><span class="hljs-params">()</span></span> {
        composeTestRule.setContent {
            navController = 
                TestNavHostController(LocalContext.current)
            navController.navigatorProvider.addNavigator(
                ComposeNavigator()
            )
            RallyNavHost(navController = navController)
        }

        composeTestRule
            .onNodeWithContentDescription(<span class="hljs-string">"Overview Screen"</span>)
            .assertIsDisplayed()
    }
}
</code></pre>
<p>再次运行测试，并验证测试是否会通过。</p>
<p>由于您需要以相同的方式为即将到来的每项测试设置 <code>RallyNavHost</code>，因此您可以将其初始化部分提取到带注解的 <code>@Before</code> 函数中，以避免多余的重复代码并确保测试更加简洁：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> org.junit.Before
<span class="hljs-comment">// ...</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">NavigationTest</span> {

    <span class="hljs-meta">@get:Rule</span>
    <span class="hljs-keyword">val</span> composeTestRule = createComposeRule()
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> navController: TestNavHostController

    <span class="hljs-meta">@Before</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setupRallyNavHost</span><span class="hljs-params">()</span></span> {
        composeTestRule.setContent {
            navController = 
                TestNavHostController(LocalContext.current)
            navController.navigatorProvider.addNavigator(
                ComposeNavigator()
            )
            RallyNavHost(navController = navController)
        }
    }

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">rallyNavHost_verifyOverviewStartDestination</span><span class="hljs-params">()</span></span> {
        composeTestRule
            .onNodeWithContentDescription(<span class="hljs-string">"Overview Screen"</span>)
            .assertIsDisplayed()
    }
}
</code></pre>
<h3 data-id="heading-28">在测试中导航</h3>
<p>您可以通过多种方式测试导航实现，具体方法是：点击界面元素，然后验证显示的目的地；或者比较预期路线与当前路线。</p>
<h4 data-id="heading-29"><strong>通过界面点击和屏幕 contentDescription 进行测试</strong></h4>
<p>如果您要测试具体应用的实现，最好在界面中执行点击操作。接下来的文本内容可以验证这一点：在“Overview”屏幕中，点击“Accounts”子部分中的“SEE ALL”按钮后，您便会转到“Accounts”目的地：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/310ee2cbe7c34e54a5231c0cbe7cb41e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767098671&amp;x-signature=S6Zb68uxfg1XgcjmFjI6JQDtA28%3D" alt="image.png" loading="lazy"/></p>
<p>您将再次在 <code>OverviewScreenCard</code> 可组合项中使用为此特定按钮设置的 <code>contentDescription</code>，从而通过 <code>performClick()</code> 模拟对该按钮的点击，并验证“Accounts”目的地随后是否会显示：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.compose.ui.test.performClick
<span class="hljs-comment">// ...</span>

<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">rallyNavHost_clickAllAccount_navigatesToAccounts</span><span class="hljs-params">()</span></span> {
    composeTestRule
        .onNodeWithContentDescription(<span class="hljs-string">"All Accounts"</span>)
        .performClick()

    composeTestRule
        .onNodeWithContentDescription(<span class="hljs-string">"Accounts Screen"</span>)
        .assertIsDisplayed()
}
</code></pre>
<p>您可以按照此模式在应用中测试其余所有的点击导航操作。</p>
<h4 data-id="heading-30">通过界面点击和路线对比进行测试</h4>
<p>您还可以使用 <code>navController</code> 检查您的断言，只需将当前 String 路线与预期路线进行比较即可。为此，请按照与上一部分中相同的步骤，在界面中执行点击操作，然后使用 <code>navController.currentBackStackEntry?.destination?.route</code> 来比较当前路线与预期路线。</p>
<p>您还需要再执行一个步骤，即确保先在“Overview”屏幕上滚动到“Bills”子部分，否则测试将会失败，因为它无法找到具有 <code>contentDescription</code>“All Bills”的节点：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.compose.ui.test.performScrollTo
<span class="hljs-keyword">import</span> org.junit.Assert.assertEquals
<span class="hljs-comment">// ...</span>

<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">rallyNavHost_clickAllBills_navigateToBills</span><span class="hljs-params">()</span></span> {
    composeTestRule.onNodeWithContentDescription(<span class="hljs-string">"All Bills"</span>)
        .performScrollTo()
        .performClick()

    <span class="hljs-keyword">val</span> route = navController.currentBackStackEntry?.destination?.route
    assertEquals(route, <span class="hljs-string">"bills"</span>)
}
</code></pre>
<blockquote>
<p><strong>注意</strong>：如需详细了解导航代码的高级测试，请参阅<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fguide%2Fnavigation%2Fnavigation-testing%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/guide/navigation/navigation-testing?hl=zh-cn" ref="nofollow noopener noreferrer">测试导航</a>指南。</p>
</blockquote>
<p>您可以按照这些模式涵盖任何其他导航路线、目的地和点击操作，以便完成测试类。立即运行整套测试，验证它们是否均已通过。</p>
<h2 data-id="heading-31">11. 恭喜</h2>
<p>恭喜，您已成功完成此 Codelab！您可以<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fandroid%2Fcodelab-android-compose%2Ftree%2Fend%2FNavigationCodelab" target="_blank" title="https://github.com/android/codelab-android-compose/tree/end/NavigationCodelab" ref="nofollow noopener noreferrer">在此处找到解决方案代码</a>，并将其与您的代码进行比较。</p>
<p>您已向 Rally 应用添加了 Jetpack Compose Navigation，现在已经熟悉了它的关键概念。您学习了如何设置可组合目的地的导航图、定义导航路线和操作、通过实参向路线传递额外信息、设置深层链接以及测试导航。</p>
<p>如需获取更多主题和信息（例如<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fnavigation%3Fhl%3Dzh-cn%23bottom-nav" target="_blank" title="https://developer.android.com/jetpack/compose/navigation?hl=zh-cn#bottom-nav" ref="nofollow noopener noreferrer">底部导航栏集成</a>、多模块导航和<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fnavigation%3Fhl%3Dzh-cn%23nested-nav" target="_blank" title="https://developer.android.com/jetpack/compose/navigation?hl=zh-cn#nested-nav" ref="nofollow noopener noreferrer">嵌套图</a>），您可以访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fandroid%2Fnowinandroid" target="_blank" title="https://github.com/android/nowinandroid" ref="nofollow noopener noreferrer">Now in Android GitHub 代码库</a>，了解具体的实现方式。</p>
<h3 data-id="heading-32"><strong>接下来做什么？</strong></h3>
<p>参阅以下材料，继续完成您的 <a href="https://link.juejin.cn?target=http%3A%2F%2Fgoo.gle%2Fcompose-pathway" target="_blank" title="http://goo.gle/compose-pathway" ref="nofollow noopener noreferrer">Jetpack Compose 开发者在线课程</a>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fcodelabs%2Fjetpack-compose-testing%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/codelabs/jetpack-compose-testing?hl=zh-cn" ref="nofollow noopener noreferrer">“测试 Compose”Codelab</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DEOQB8PTLkpY%26hl%3Dzh-cn" target="_blank" title="https://www.youtube.com/watch?v=EOQB8PTLkpY&amp;hl=zh-cn" ref="nofollow noopener noreferrer">“Jetpack Compose 中的常见性能问题”视频</a></li>
</ul>
<p>如需详细了解 Jetpack Navigation，请参阅以下内容：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fguide%2Fnavigation%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/guide/navigation?hl=zh-cn" ref="nofollow noopener noreferrer">Jetpack 导航</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fcodelabs%2Fandroid-navigation%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/codelabs/android-navigation?hl=zh-cn" ref="nofollow noopener noreferrer">“了解 Jetpack Navigation”Codelab</a></li>
</ul>
<h3 data-id="heading-33">参考文档</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fnavigation%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/jetpack/compose/navigation?hl=zh-cn" ref="nofollow noopener noreferrer">“使用 Compose 进行导航”文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fnavigation%2Fcompose%2Fpackage-summary%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/navigation/compose/package-summary?hl=zh-cn" ref="nofollow noopener noreferrer">Navigation Compose 参考文档</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[抢先实测豆包1.8模型，多模态Agent超强！]]></title>    <link>https://juejin.cn/post/7586877892467834907</link>    <guid>https://juejin.cn/post/7586877892467834907</guid>    <pubDate>2025-12-23T12:55:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586877892467834907" data-draft-id="7586872817875943450" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="抢先实测豆包1.8模型，多模态Agent超强！"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-23T12:55:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苍何"/> <meta itemprop="url" content="https://juejin.cn/user/588993963763405"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            抢先实测豆包1.8模型，多模态Agent超强！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993963763405/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苍何
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T12:55:56.000Z" title="Tue Dec 23 2025 12:55:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是苍何的第 463 篇原创！</p>
<p>大家好，我是人在火山大会的苍何。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a899720895b347bfa7a13c46ac7538bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099356&amp;x-signature=hHMg4dHF7tbhSEfCFajUyFbd30k%3D" alt="图片" loading="lazy"/></p>
<p>说实话，我现在就在火山引擎 FORCE 原动力大会的现场，人太多了，多到要挤着才能进来。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c9a7a542baa41e6a3772d52adc4d125~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099356&amp;x-signature=cdt%2BNHT2lwO%2BobeizJrOENtK%2FLI%3D" alt="图片" loading="lazy"/></p>
<p>这一年也见证了豆包大模型的快速成长，今天豆包大模型 1.8 也正式发布。</p>
<p>这次模型的更新带来了更强的 Agent 能力和多模态理解能力，在公开测试集中的表现相对于豆包 1.6有了很大的提升。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ebeb84f9b1f45ac81a21227580a901a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099356&amp;x-signature=2BeSakW%2BPk4N1y84am%2BHP9FrN0g%3D" alt="图片" loading="lazy"/></p>
<p>不少能力都可以和其他全球顶尖模型一争高下，在不同场景维度下的测试集表现也很出色。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40519c8e1e9144baaed2809f28d12f21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099356&amp;x-signature=F4TZgUYkPxHHhvf88tzyz4p%2FqmI%3D" alt="图片" loading="lazy"/></p>
<p>豆包大模型 1.8 大幅增强工具调用（Tool Use）能力，长文和多轮指令遵循大幅度增强，Coding能力也显著增强。</p>
<p>具备 OS Agent 落地能力，支持 Agent 完成屏幕操作任务。模型格式输出更稳定，执行规划能力和复杂流程理解再提升，更适合复杂多步多分支的企业级 Agent 任务。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8d7c0a07b8243d7b91a809c10969a19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099356&amp;x-signature=GjU%2B%2FjmmYjDOyaVc2K3VpK6kVjA%3D" alt="图片" loading="lazy"/></p>
<p>同时视觉理解基础能力大幅跃升，图片理解Tokens消耗更少，理解精度更高，单次视频理解帧数从640帧提升至1280帧，（在1秒1帧的情况下，可支持20分钟长视频理解）。</p>
<p>同时火山方舟应用实验室还支持Video Cup Tool体验：新增低帧率(如每5s一帧)查看完整视频后，聚焦某个与问题强相关的视频片段，正常或高帧率（如每1s一帧或5帧）具体理解并回答问题。</p>
<p>模型推理能力更出色，支持思考长度可调节，各模式下思考更加精简，Tokens更节省。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c83c6736930443d7b9c3299d1a7ef277~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099356&amp;x-signature=7vIwS7oeZQPMetGvRQpTmlCtbZw%3D" alt="图片" loading="lazy"/></p>
<p>关于模型信息更新信息给大家介绍完毕，接下来是带来一手实测，其实前些天就拿到了内测资格，这次测试我更聚焦于实际 Agent复杂场景，而非简单case测试。</p>
<p>先是来一个自动写公众号图文并发布的场景，要求根据主题搜索相关图文信息，并写文章，同时发布到公众号后台。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d0abf0ae7154b938d2d5ec636029cf3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099356&amp;x-signature=MQji13Yrok1lnUeMTyiZrr5rJLU%3D" alt="wxv_4301758944881786880" loading="lazy"/></p>
<p>我是在 Trae 中调用豆包大模型 1.8 的 API，然后自定义的智能体。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/476474e909594110862847fb890fd7f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099356&amp;x-signature=oThvdiZNuh4D%2Fd2LCrMok61Bru8%3D" alt="图片" loading="lazy"/></p>
<p>智能体的提示词是这样子的：</p>
<pre><code class="hljs language-arduino" lang="arduino">你是专业的内容编辑，擅长做公众号文章的创作，你能根据指定的主题创作一篇公众号文章，并写入到文件中，文件名以标题.md来命名，你需要先调用Chrome DevTools 工具去浏览器搜索查找相关信息（注意这一步是必须的，你必须调用工具自行百度搜索，
搜索内容是用户输入的主题，请严格将用户主题放入搜索而非其他多余元素），然后调用MiniMax MCP工具来生成文章配图，
放在image文件夹下，并引入到到文章中。最后帮我到公众号后台发布。公众号标题你自行选择爆款标题。
</code></pre>
<p>同时配置了 Chrome DevTools MCP 和 MiniMax MCP。</p>
<p>可以看到豆包大模型 1.8 会根据任务自动调用浏览器搜索内容，然后生成文字和配图，最后发布。</p>
<p>整个长时任务，可以看到豆包大模型 1.8 完成的很不错。</p>
<p>另外看一个更复杂的实测，扮演一个CTO 助手审核邮件匹配出合适的投资项目。</p>
<p>为了测试它到底有多硬核，我给它设置了一个极具挑战性的 <strong>Case</strong>：模拟一个 <strong>CTO 助手</strong>，完成一整套 AI 项目的立项审批。</p>
<blockquote>
<p>背景：模拟一家奶茶公司，茶小鲜，要投资 AI 项目的，由各个分公司提报项目到指定邮件。CTO再结合公司的情况进行审查出合适的投资项目。</p>
</blockquote>
<p>先给大家看下最终的效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd55bc8d4dbb4eaba89da9795360dace~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099356&amp;x-signature=Z1FKYm37%2FmwxB5c%2BZD1G1HqA8WY%3D" alt="wxv_4301754318765424641" loading="lazy"/></p>
<p>整个任务足够复杂，从邮件中提取附件并解析附件，然后去调用众多的公司文件解析，最终生层决策报告。</p>
<p>你可以看下我给的提示词：</p>
<pre><code class="hljs language-objectivec" lang="objectivec">作为 <span class="hljs-built_in">CTO</span> 助手，请按照以下详细流程完成 AI 项目审批工作：
<span class="hljs-number">1.</span> 邮件筛选与提取：
● 使用 Chrome DevTools 工具登录 <span class="hljs-number">163</span> 邮箱
● 精确筛选满足以下条件的邮件：
 ○ 主题包含<span class="hljs-string">"立项申请"</span>的邮件
 ○ 主题包含<span class="hljs-string">"2026年战略重点"</span>的邮件
● 确保完整获上述取邮件正文内容和所有附件
<span class="hljs-number">1.</span> 附件下载与存储：
● 将所有符合条件的邮件附件下载至指定路径：/Users/Downloads<span class="hljs-comment">/*.pdf
2. 内容解析与整合：
● 调用 mcp-email-service 中的专用解析工具
● 对每份PDF附件进行结构化解析
● 将解析结果与对应邮件正文内容进行智能整合
3. 战略契合度评估：
● 以公司最新发布的 邮件 2026年战略重点 的正文和附件内容 为评估基准
● 为每个项目生成量化评分和详细评估意见
4. HTML汇报页面制作：
● 创建专业的企业级HTML静态页面，包含：
 ○ 项目概览仪表盘
 ○ 战略契合度雷达图
 ○ 预算分配饼图
 ○ ROI预测折线图
● 确保所有数据展示均标注明确来源：
 ○ 直接引用原始PDF文件关键页截图
 ○ 标注具体引用位置（页码/段落）
● 实现交互功能：
 ○ 点击数据可跳转至对应PDF原文
 ○ 支持筛选和排序功能
5. 自动交付：
● 生成完成后自动在默认浏览器中打开HTML页面
质量要求：
1. 数据准确性：所有引用数据必须与原始文件100%一致
2. 视觉规范：符合公司VI标准，使用官方配色方案
3. 安全要求：处理过程中不得存储任何敏感邮件内容
</span></code></pre>
<p>可以看到它直接调用 Chrome DevTools MCP，像真人一样登录邮箱、精准筛选、自动下载附件到指定路径。这种 OS Agent 的落地感，真的非常丝滑。 </p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8089da4547bc4c6ca3e1d8e7222a8105~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099356&amp;x-signature=RzMmuhpouKuQvANju6Jm35AcUrw%3D" alt="图片" loading="lazy"/></p>
<p>它没有上来就盲目操作，而是先在后台给自己拆解了 10 个任务步骤：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-number">1</span>、登录<span class="hljs-number">163</span>邮箱并筛选包含"立项申请"的邮件
<span class="hljs-number">2</span>、下载符合条件邮件的所有PDF附件到/Downloads/
<span class="hljs-number">3</span>、调用mcp-email-service解析所有PDF附件和邮件正文
<span class="hljs-number">4</span>、以指定基准文件评估项目战略契合度，选出最合适的投资项目
<span class="hljs-number">5</span>、创建企业级<span class="hljs-selector-tag">HTML</span>静态汇报页面，包含仪表盘、图表和交互功能
<span class="hljs-number">6</span>、在默认浏览器中打开生成的<span class="hljs-selector-tag">HTML</span>页面完成交付
<span class="hljs-number">7</span>、解析新增补充文档：中国茶饮AI应用白皮书、投资回报分析报告、预算制度、人力资源档案
<span class="hljs-number">8</span>、结合补充文档重新评估项目投资价值，确定最终最优项目
<span class="hljs-number">9</span>、更新<span class="hljs-selector-tag">HTML</span>评估报告，整合新的评估维度
<span class="hljs-number">10</span>、重新打开更新后的<span class="hljs-selector-tag">HTML</span>报告完成最终交付
</code></pre>
<p>大概总结一下</p>
<p>登录与筛选： 搞定 163 邮箱。登录这个步骤需要人工扫描参与收集数据（邮件的正文和邮件的附件）<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/523dfa3c7a074066a3afbfc9acc76744~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099356&amp;x-signature=6uYrGEo2jewW%2F777eUFdn4i9pok%3D" alt="图片" loading="lazy"/></p>
<p>调用MCP工具 mcp-email-service 提取结构化数据这里包含了需要结合的本地文件。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e8b23db6fe841fa99a37f98a615326e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099356&amp;x-signature=QHkjfXgBRFSTbNC73Iz97orcapQ%3D" alt="图片" loading="lazy"/></p>
<p>每一个 PDF的文件都至少有十几页，字数非常多，这人要一个个看没个把小时很难看完。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4e4f671cea04e40a15c2d6fd6997cf5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099356&amp;x-signature=OoXRx6Zf6tI5oNvmXuk9FWOzZIA%3D" alt="图片" loading="lazy"/></p>
<p>此时整个任务需要加载5+5 =10份PDF的解析任务，每份文档大小不低于500kb</p>
<p>最后是战略契合度评估环节，这一点最难，它需要理解 256K 窗口里的那堆复杂战略。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4405701805d1487a87ca5b0b318a50d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099356&amp;x-signature=%2BX2ptVdvxlOVIg7LkLBUnDfTJqA%3D" alt="图片" loading="lazy"/></p>
<p> 我中途丢给它《中国茶饮 AI 白皮书》和预算制度，它能迅速合并维度，重新修正投资价值。</p>
<p>最终自动在浏览器打开一个带交互功能的 HTML 仪表盘。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/048053bf5c3b43f483c83b4bc695e8cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099356&amp;x-signature=ZEWQo6JE84tpeOpsXF8CdH5l%2FNQ%3D" alt="图片" loading="lazy"/></p>
<p>最后得到评估报告：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a3b6831061d41a5be7d0a28fc77af6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099356&amp;x-signature=A4qKrpr07Fx6QM8s%2BJZC1nTAVWg%3D" alt="图片" loading="lazy"/></p>
<p>在测试过程中，我有几个非常深刻的体会：</p>
<p><strong>1、工具调用（ToolUse）极其稳定</strong></p>
<p>以前的 Agent 经常会在多步调用中断片，但豆包 1.8 的输出格式非常稳定。即使是面对 mcp_mcp-email-service_parse_pdf 这种复杂的自定义工具，它也能精准传参，报错率低得惊人。 </p>
<p><strong>2、思考长度可调节</strong></p>
<p>它支持思考过程的精简或深入。在处理“战略契合度评分”时，我能感觉到它在进行深度逻辑推理；而在处理下载附件这种确定性任务时，它又非常节省 Tokens，这才是成熟模型该有的样子。</p>
<p><strong>3、视觉与多模态的精准度</strong></p>
<p>在 HTML 报告里，它能直接引用 PDF 原始文件的关键页截图，并标注页码。这种对多模态内容的“索引”能力，避免了 AI 常见的胡说八道。 </p>
<p>最后统计了下大概的 token 消耗情况：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33afcdc3e8cd4892bd319221021e1bd6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099356&amp;x-signature=6BWkRUv%2Fll%2FUkbeJvXmPN4DKS34%3D" alt="图片" loading="lazy"/></p>
<p>在企业级复杂的业务场景中，豆包大模型 1.8 更适合处理复杂的 Agent 任务。</p>
<p>看完豆包 1.8 的表现，我一直在想，现在的工具真的太多了，开发者和职场人的切换成本越来越高。</p>
<p>我觉得<strong>工具不应该让人去适应它，而应该主动融入我们的工作流。</strong></p>
<p>豆包这次把 Agent、超长上下文和多模态打通，其实是给了每个人一个“一站式”的数字办公室。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[以前我以为达人营销很玄学，用了 Aha 才知道还能这么玩！（附教程）]]></title>    <link>https://juejin.cn/post/7586872817875992602</link>    <guid>https://juejin.cn/post/7586872817875992602</guid>    <pubDate>2025-12-23T12:58:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586872817875992602" data-draft-id="7586892413890707502" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="以前我以为达人营销很玄学，用了 Aha 才知道还能这么玩！（附教程）"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-23T12:58:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苍何"/> <meta itemprop="url" content="https://juejin.cn/user/588993963763405"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            以前我以为达人营销很玄学，用了 Aha 才知道还能这么玩！（附教程）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993963763405/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苍何
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T12:58:46.000Z" title="Tue Dec 23 2025 12:58:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是苍何的第 458 篇原创！</p>
<p>大家好，我是在学出海做产品的苍何。</p>
<p>最近这段时间，我一直在研究 AI 出海。</p>
<p>看了很多案例，也研究了不少工具。甚至我自己以身入局做达人，天天泡在 X、Reddit 、YouTube 上。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/746b754293714f1b84b5e0a8328d9941~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099526&amp;x-signature=qfuMyMApkDsL5h%2BeiPOw9xr6vWk%3D" alt="图片" loading="lazy"/></p>
<p>发现一个扎心的真相：<strong>再 PLG 的产品，如果没有外部信任与内容曝光，也会迅速被淹没。</strong></p>
<p>所以用达人营销解决产品增长问题显得尤为重要。我想着是否能用 AI 来解决这个问题。</p>
<p>扫了一圈市面上的工具，发现现在的 AI 营销产品真是满天飞，看得人眼花缭乱。</p>
<p>但真正能落到执行层面的并不多。大多数还是停留在辅助创作上，帮你写点文案、出几张图，解决的是“做内容快一点”，而不是“营销这件事怎么真的跑起来”。</p>
<p>直到我在 Product Hunt 上看到了 <strong>Aha</strong> 这个产品，决定深入研究一下。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2191751edd9e4abd9c5bf86a164c21b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099526&amp;x-signature=U5dO%2F3Q4aOCyjuDFyaNayEQF1tU%3D" alt="图片" loading="lazy"/></p>
<p>查了下 Aha 这家公司，主要是做 AI 达人营销的，也即为品牌与创作者搭建更高效、更智能的平台协作体系。团队成员来自北美、亚洲等地，拥有连续创业、VC 投资及TikTOK、阿里等大厂背景。<strong>产品上线 9个月即赢得全球 300+ 家企业客户的信任与长期合作。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3361fed844fc4a6bbe8d39e83b1b6cf4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099526&amp;x-signature=fuob6YhB4tUA0oKqyQp%2FTbezNjA%3D" alt="图片" loading="lazy"/></p>
<p>在这之前，我特意去扒了他们的技术 Blog 和白皮书（老读者的都知道，我不信宣传语，我信底层逻辑）。读完之后，我发现这东西有点意思。</p>
<p>它不是那种一键生成的傻瓜工具，相反，<strong>它是有使用门槛的。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74c631c91b4446908b0c948d951c45a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099526&amp;x-signature=Zuo9r00R%2BDw7a1DOm9u9U8PpNqE%3D" alt="图片" loading="lazy"/>来源：<a href="https://link.juejin.cn?target=https%3A%2F%2Faha.inc%2Funiversity%3FuniversityType%3DAha%2Binsights%26utm_source%3Dinf022" target="_blank" title="https://aha.inc/university?universityType=Aha+insights&amp;utm_source=inf022" ref="nofollow noopener noreferrer">aha.inc/university?…</a></p>
<p>这个门槛不在于操作难，而在于<strong>认知的转变</strong>。一旦你搞明白了其中的 AI 逻辑和原理，把它当成一个「智能 Agent」而不是一个普通的搜号工具来用，一切就会变得极其丝滑。</p>
<p>今天就来拆解一下，这个声称比行业领先一年的产品，到底是怎么用大模型重构达人营销的。</p>
<h2 data-id="heading-0">01 告别「玄学」，回归「第一性原理」</h2>
<p>以前找达人（Influencer）带货或推广，在很多人的印象里就是「玄学」。</p>
<p>你会觉得：这个博主粉丝多，应该能火；那个博主看起来很极客，应该适合我的产品。结果投下去，钱花了，水花都没一个。</p>
<p>Aha 的创始人 Kay 在他们的技术复盘里提到了一个很有趣的观点：<strong>达人营销的本质，其实和「搜索/广告推荐」是同一类问题</strong> 。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b1f8c70f6b8404aae206b4d90fe1e73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099526&amp;x-signature=aUb%2B7wBGELeUObhIMGb6rP3EJBM%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<ul>
<li><strong>Query（查询）：</strong>  你的品牌、产品、Campaign 需求。</li>
<li><strong>Candidates（候选人）：</strong>  全球几百万的创作者。</li>
<li><strong>Scoring Function（评分）：</strong>  谁最相关、最有价值。</li>
</ul>
<p>所以，Aha 并没有搞什么花里胡哨的新名词，而是老老实实地用大模型重构了经典的「召回（Recall）→ 粗排（Coarse Ranking）→ 精排（Fine Ranking）」架构。</p>
<p><strong>这里最大的创新点在于：它让 LLM（大模型）成为了决策者，而不是单纯的特征提取工具</strong>。</p>
<p>传统推荐系统需要海量的历史点击数据，但达人营销是「零数据」行业，我们不知道这个博主还没发的视频会不会火。这时候，大模型的「语义理解」能力就进场了。</p>
<p>它像一个人类专家一样，去阅读博主的字幕、简介、风格，然后推理：<strong>这个人的受众，到底会不会买我的单？</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94f07549246448a2ba0fadd5c86d9d54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099526&amp;x-signature=bzsO%2ByGnRMvusaJBYTtHUSEzPok%3D" alt="图片" loading="lazy"/></p>
<p>这就是为什么说它有门槛——你得相信 AI 的推理能力，胜过相信粉丝数。</p>
<h2 data-id="heading-1">02 不被「宰」的秘密：动态定价</h2>
<p>除了找人准，还有一个痛点是「谈钱」。</p>
<p>海外达人报价那是相当混乱，完全看心情。Aha 做了一个<strong>动态定价 AI 系统</strong> 。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d78fa63b80e44c1d8d87de37cefc552f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099526&amp;x-signature=PgYKsQrgn1mZWVqbpOmdIgKS31o%3D" alt="图片" loading="lazy"/></p>
<p>它不靠猜，而是基于达人的历史表现、受众数据、甚至实时的市场供需关系（比如旺季淡季），自动算出一个一口价 。</p>
<p>这有点像打车软件的预估价，直接省去了你跟达人一来一回几十封邮件砍价的时间。</p>
<p>看个数据：</p>
<p>Aha 的客户 Vizard（一个 AI 切片工具），以前人工搞一个月才能完成的达人合作，用 Aha 几天就搞定了，效率提升了 5-10 倍。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d2dd288b6b0414d8c940c772550d007~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099526&amp;x-signature=PCD8HOJ26mnqCUDt24DZsptWjRE%3D" alt="图片" loading="lazy"/></p>
<p>还有一个大家都比较熟悉的做 PPT 的 AI 产品 AiPPT，平均每次点击成本（CPC）甚至压到了 $0.43 。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c9b824a337442c09c745cf23d62052e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099526&amp;x-signature=Knf5VSBOIguDeS5ncVDYu2oUUI4%3D" alt="图片" loading="lazy"/></p>
<p>这在传统的 Agency 模式下，几乎是不可能做到的数据。</p>
<h2 data-id="heading-2">03 既然这么强，到底该怎么用？</h2>
<p>如果你也想试试用 AI Agent 来替你跑腿，这里有几个我总结的「避坑指南」。</p>
<p><strong>第一：Campaign 信息越精确，AI 做得越好（Prompt 工程）</strong></p>
<p>在 Aha 上创建 Campaign，输入 URL 它会自动抓取信息。但我建议你别偷懒，<strong>要把这一步当成是在写 Prompt。</strong></p>
<p>虽然它能自动生成，但你要人工去校准。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ac46699ff094deab46aa8bd3f4efb5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099526&amp;x-signature=F%2FtIEMrRd4iRG72pzFO1WDPCD6c%3D" alt="图片" loading="lazy"/></p>
<p>比如：你的竞品是谁？你的核心受众画像（Persona）到底是什么？</p>
<p>你给 AI 的 Context（上下文）越丰富、越准确，它在「精排」阶段的语义推理就越精准。别指望你给个「好用的软件」这种模糊指令，它能给你找到精准的垂类博主。</p>
<p>另外我发现还有一个非常重要、但经常被忽略的检查步骤。</p>
<p>在正式发布 Campaign 之前，Aha 会给你 3–5 个预匹配达人。</p>
<p>这一步的作用不是让你直接挑达人，而是用来“校验前面的 Campaign 信息是否设置准确”。</p>
<p>你可以简单看几个问题：</p>
<p>1、这些达人的内容方向，是否贴近你设定的 Persona？</p>
<p>2、他们是否是你“希望被你的目标用户看到的那种人”？</p>
<p>如果你发现这 3–5 个达人明显不对路，那基本可以确定你前面的 Context 给得不够准。</p>
<p>这时候最优解不是「凑合着发」，而是果断返回第一步，重新编辑 Campaign 信息。</p>
<p>相反，如果这几个预匹配达人一眼看过去就很对，那说明你的产品信息已经写对了，语义方向是清晰的，这时再进入付费 + 发布，效率和结果都会好很多。</p>
<p>⚠️ 这里一定要注意一点：</p>
<p>这 3–5 个预匹配达人并不是完整的合作名单，只是一个「校准样本」，千万别在这里就开始纠结数量或者覆盖面，别误会了 hhhh。</p>
<p>真正的 Aha，是在你确认方向正确、正式发布之后才开始全速工作的。</p>
<p>前面的步骤，本质上都是在帮你把「方向盘校正好」。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec16f4a7fac04f3db81c7a27dedac9bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099526&amp;x-signature=DQWTM3nI0Dfy%2Bl9e7PexqWiiXxc%3D" alt="图片" loading="lazy"/></p>
<p><strong>第二：格局打开，全球投放</strong></p>
<p>Aha 覆盖了 140 多个国家。很多出海的朋友如果不熟悉当地语言，往往只盯着英美投。</p>
<p>但其实，除了少数价值明显偏低、转化路径不清晰的市场之外，很多非英语国家（比如拉美、东南亚）的流量洼地价值巨大，达人更好找、报价更理性、内容竞争没那么激烈。</p>
<p>利用 Aha 的多语言能力，你应该尽可能多选一些国家和语言。国家一放开，语言一放开，可合作的达人池自然就会变大，同样的预算，能跑出的内容数量和测试空间，也会明显拉开差距。</p>
<p>既然 AI 能帮你解决了多语言沟通、建联、谈价、合同和流程合规这些本该最麻烦的问题，就别把自己的路走窄了。</p>
<p><strong>第三：预算结构要符合「量变到质变」</strong></p>
<p>如果你只打算投 1 个博主，那我建议你别用 Aha，去买彩票可能更快。</p>
<p>Aha 的逻辑是概率与确定性的博弈。根据他们的最佳实践，初期最好能投 50-100 个达人，用数量来放大爆款的概率 。</p>
<p>这就是我在开头说的「门槛」：</p>
<p>你不能带着「赌一把」的心态，而要带着「做实验」的心态。利用 AI 的规模化能力，快速跑出数据，然后复投那些效果好的 ROI 模型。</p>
<h2 data-id="heading-3">04 什么样的产品适合用？</h2>
<p>研究了一圈，我觉得两类团队最适合用 Aha：</p>
<p><strong>1、AI / 软件 / App / AI 硬件类产品</strong></p>
<p>这类产品往往不是“卖一个功能点”，而是卖一整套使用体验或工作方式的改变。</p>
<p>无论是 AI 工具、企业软件，还是 AI 硬件，单靠官网文案或广告，很难让用户真正理解它“好在哪”。</p>
<p>相比反复解释参数、能力和技术路线，让真实创作者直接演示使用过程——比如一次完整的操作流程、一个真实使用场景、一个前后对比的效果展示，往往比再精致的文案都更有说服力。</p>
<p>本质上，这类产品需要被看到、被用过、被理解，而不是被“说明”。</p>
<p>2、具备一定团队规模、处于快速增长期的创业团队</p>
<p>这类团队通常已经明确增长方向，也知道达人营销是有效手段，但现实问题是：人永远不够用。</p>
<p>市场同学要分出很多精力做脏活累活：</p>
<p>选达人、建联、谈合作、审内容、催进度、看数据……</p>
<p>哪一步都不复杂，但全部堆在一起，就会迅速吃掉整个团队的精力。</p>
<p>Aha 更适合这种“没时间、没人力、有预算、有计划”的团队。</p>
<p>把大量重复、琐碎、但必须被执行的工作交给 AI，让有限的人力真正用在策略判断、创意方向和结果决策上，而不是被流程拖慢增长节奏。</p>
<h3 data-id="heading-4">写在最后</h3>
<p>现在的 AI 工具很多，能真正解决业务闭环的不多。</p>
<p>Aha 给我的感觉是，它不仅是个工具，更像是一个「全职的 AI 营销员工」。它帮你把找人、发邮件、谈价格、签合同、催稿子这些脏活累活全干了。</p>
<p>如果你的产品也准备出海，或者正在为海外增长发愁，建议你别急着上手操作。</p>
<p>因为是 ToB 的产品，流程还是比较严谨的。<strong>强烈建议先去官网约个 Demo 演示</strong>，让他们的专家给你讲讲具体怎么适配你的赛道，感受一下那个「语义匹配」的精准度，再决定要不要上车。</p>
<p>少走弯路，才是最快的捷径。</p>
<p>在 AI 时代，对普通人来说真正的壁垒从来不是模型本身，而是如何把模型嵌入到复杂业务流里，让它能够稳定、规模化地产生结果。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在macOS上无缝整合：为Claude Code配置魔搭社区免费API完全指南]]></title>    <link>https://juejin.cn/post/7586922268024340516</link>    <guid>https://juejin.cn/post/7586922268024340516</guid>    <pubDate>2025-12-23T13:03:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586922268024340516" data-draft-id="7586588823906811913" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在macOS上无缝整合：为Claude Code配置魔搭社区免费API完全指南"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-23T13:03:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="90后晨仔"/> <meta itemprop="url" content="https://juejin.cn/user/2717648476705773"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在macOS上无缝整合：为Claude Code配置魔搭社区免费API完全指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2717648476705773/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    90后晨仔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T13:03:13.000Z" title="Tue Dec 23 2025 13:03:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">引言：当Claude遇见魔搭，本地开发者的福音</h3>
<p>本文将详细记录在macOS系统上，从零开始配置Claude Code使用魔搭API的完整过程，涵盖每一步操作、遇到的每一个坑及其解决方案。</p>
<h3 data-id="heading-1">环境准备与初始状态</h3>
<p><strong>系统环境</strong>：macOS (Apple Silicon)，终端为zsh，已安装Homebrew。
<strong>目标</strong>：配置Claude Code，使其后端使用魔搭社区的免费Anthropic兼容API。</p>
<h3 data-id="heading-2">第一阶段：Python环境搭建与基础配置</h3>
<h4 data-id="heading-3">问题一：pip命令不存在</h4>
<p>最初尝试安装anthropic库时，终端提示<code>zsh: command not found: pip</code>。</p>
<p><strong>解决方案</strong>：</p>
<ol>
<li>通过Homebrew安装Python 3：<code>brew install python</code></li>
<li>验证安装：<code>python3 --version</code> 和 <code>pip3 --version</code></li>
</ol>
<h4 data-id="heading-4">问题二：externally-managed-environment错误</h4>
<p>在系统Python环境下直接运行<code>pip install anthropic</code>遇到此错误，这是新版Python的保护机制。</p>
<p><strong>解决方案</strong>：使用Python虚拟环境，隔离项目依赖：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建虚拟环境</span>
python3 -m venv venv
<span class="hljs-comment"># 激活虚拟环境</span>
<span class="hljs-built_in">source</span> venv/bin/activate
<span class="hljs-comment"># 在虚拟环境中安装所需库</span>
pip install anthropic
</code></pre>
<h3 data-id="heading-5">第二阶段：魔搭API配置详解</h3>
<h4 data-id="heading-6">获取魔搭API密钥</h4>
<ol>
<li>注册并登录<a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelscope.cn" target="_blank" title="https://modelscope.cn" ref="nofollow noopener noreferrer">魔搭社区</a></li>
<li>完成阿里云账号绑定（必需步骤）</li>
<li>在个人中心获取Access Token（格式为<code>ms-xxxxxxxxxxxx</code>）</li>
<li><strong>关键点</strong>：实际使用时需去掉<code>ms-</code>前缀</li>
</ol>
<h4 data-id="heading-7">环境变量配置</h4>
<p>在<code>~/.zshrc</code>中添加以下配置：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 魔搭社区配置</span>
<span class="hljs-built_in">export</span> ANTHROPIC_API_KEY=<span class="hljs-string">"your_token_without_ms_prefix"</span>  <span class="hljs-comment"># 重要：去掉ms-前缀</span>
<span class="hljs-built_in">export</span> ANTHROPIC_BASE_URL=<span class="hljs-string">"https://api-inference.modelscope.cn"</span>
<span class="hljs-built_in">export</span> ANTHROPIC_MODEL=<span class="hljs-string">"Qwen/Qwen3-Coder-480B-A35B-Instruct"</span>
</code></pre>
<p>使配置生效：<code>source ~/.zshrc</code></p>
<h3 data-id="heading-8">第三阶段：Claude Code配置与问题排查</h3>
<h4 data-id="heading-9">Claude Code配置文件创建</h4>
<p>创建Claude Code专用配置文件：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> -p ~/.claude
nano ~/.claude/settings.json
</code></pre>
<p>文件内容如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"ANTHROPIC_API_KEY"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"your_token_without_ms_prefix"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ANTHROPIC_BASE_URL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://api-inference.modelscope.cn"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ANTHROPIC_MODEL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Qwen/Qwen3-Coder-480B-A35B-Instruct"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>nano编辑器保存技巧</strong>：按<code>Control+X</code> → 按<code>Y</code> → 按<code>Enter</code></p>
<h4 data-id="heading-10">遇到的典型问题及解决</h4>
<ol>
<li>
<p><strong>Auth Conflict错误</strong></p>
<pre><code class="hljs language-java" lang="java">⚠Auth conflict: Both a <span class="hljs-title function_">token</span> <span class="hljs-params">(ANTHROPIC_AUTH_TOKEN)</span> and an API <span class="hljs-title function_">key</span> <span class="hljs-params">(ANTHROPIC_API_KEY)</span> are set.
</code></pre>
<p><strong>原因</strong>：环境变量命名冲突，同时存在<code>ANTHROPIC_AUTH_TOKEN</code>和<code>ANTHROPIC_API_KEY</code>。
<strong>解决</strong>：统一使用<code>ANTHROPIC_API_KEY</code>，删除或注释掉<code>ANTHROPIC_AUTH_TOKEN</code>的定义。</p>
</li>
<li>
<p><strong>模型不支持错误</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Model id:</span> <span class="hljs-string">ZhipuAI/GLM-4.6,</span> <span class="hljs-string">has</span> <span class="hljs-literal">no</span> <span class="hljs-string">provider</span> <span class="hljs-string">supported</span>
</code></pre>
<p><strong>原因</strong>：某些模型在魔搭的Anthropic兼容接口中暂不可用。
<strong>解决</strong>：更换为魔搭文档中明确支持的模型，如<code>Qwen/Qwen3-Coder-480B-A35B-Instruct</code>。</p>
</li>
<li>
<p><strong>环境变量未生效</strong>
<strong>解决步骤</strong>：</p>
<ul>
<li>确认<code>~/.zshrc</code>修改已保存</li>
<li>运行<code>source ~/.zshrc</code>使配置生效</li>
<li>通过<code>echo $ANTHROPIC_API_KEY</code>验证</li>
<li>如仍无效，尝试重启终端应用</li>
</ul>
</li>
</ol>
<h3 data-id="heading-11">第四阶段：验证与测试</h3>
<h4 data-id="heading-12">Python脚本测试</h4>
<p>创建测试文件<code>test_modelscope.py</code>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> anthropic

client = anthropic.Anthropic(
    api_key=<span class="hljs-string">"your_token_without_ms_prefix"</span>,
    base_url=<span class="hljs-string">"https://api-inference.modelscope.cn"</span>
)

<span class="hljs-keyword">with</span> client.messages.stream(
    model=<span class="hljs-string">"Qwen/Qwen3-Coder-480B-A35B-Instruct"</span>,
    messages=[{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"用Python写一个快速排序函数"</span>}],
    max_tokens=<span class="hljs-number">1024</span>
) <span class="hljs-keyword">as</span> stream:
    <span class="hljs-keyword">for</span> text <span class="hljs-keyword">in</span> stream.text_stream:
        <span class="hljs-built_in">print</span>(text, end=<span class="hljs-string">""</span>, flush=<span class="hljs-literal">True</span>)
</code></pre>
<p>成功运行并获取代码生成结果，表明API配置正确。</p>
<h4 data-id="heading-13">Claude Code启动验证</h4>
<ol>
<li>激活虚拟环境：<code>source venv/bin/activate</code></li>
<li>启动Claude Code：<code>claude</code></li>
<li>在Claude Code中输入<code>/status</code>命令，确认Base URL和Model配置正确</li>
<li>进行实际对话测试，验证功能完整性</li>
</ol>
<h3 data-id="heading-14">配置流程图</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[开始配置] --&gt; B[安装Python环境]
    B --&gt; C{是否遇到pip问题?}
    C --&gt;|是| D[通过Homebrew安装Python]
    C --&gt;|否| E[创建虚拟环境]
    D --&gt; E
    E --&gt; F[安装anthropic库]
    F --&gt; G[获取魔搭API密钥]
    G --&gt; H[配置环境变量]
    H --&gt; I[创建Claude配置文件]
    I --&gt; J{是否遇到冲突?}
    J --&gt;|是| K[排查环境变量冲突]
    J --&gt;|否| L[启动Claude Code]
    K --&gt; L
    L --&gt; M[验证配置]
    M --&gt; N[成功使用]
</code></pre>
<h3 data-id="heading-15">最佳实践与注意事项</h3>
<ol>
<li><strong>虚拟环境管理</strong>：为每个AI项目创建独立的虚拟环境，避免依赖冲突</li>
<li><strong>API密钥安全</strong>：切勿将API密钥提交到版本控制系统，使用环境变量管理</li>
<li><strong>免费额度监控</strong>：魔搭社区每日2000次免费调用，注意合理使用</li>
<li><strong>模型选择</strong>：优先使用魔搭文档中明确支持Anthropic协议的模型</li>
<li><strong>故障排查顺序</strong>：环境变量 → 配置文件 → 网络连接 → 模型可用性</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用即梦视频3.5pro复刻爆款AI探班视频，直接发现一个AI片场！]]></title>    <link>https://juejin.cn/post/7586877892467425307</link>    <guid>https://juejin.cn/post/7586877892467425307</guid>    <pubDate>2025-12-23T11:04:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586877892467425307" data-draft-id="7586877892467376155" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用即梦视频3.5pro复刻爆款AI探班视频，直接发现一个AI片场！"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-23T11:04:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苍何"/> <meta itemprop="url" content="https://juejin.cn/user/588993963763405"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用即梦视频3.5pro复刻爆款AI探班视频，直接发现一个AI片场！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993963763405/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苍何
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T11:04:00.000Z" title="Tue Dec 23 2025 11:04:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是苍何的第 462 篇原创！</p>
<p>大家好，我是加班加到忧伤又颓废的苍何。</p>
<p>一颓废就想摆烂，一摆烂就想刷搞笑视频，结果刷到了一系列 AI 走进经典电影片场的视频，挺有趣的，而且流量还都高的离谱。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5485b7b3ee8f4d329a78e67c34756f9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=y2BSw%2F25FFrbDAMqTlhAuHW%2FmEU%3D" alt="图片" loading="lazy"/></p>
<p>立马来了灵感，想着也复刻一个（顺带蹭噌），于是花了一些时间做了个剧场更多的 AI 片场视频，走进更多片场，满满的回忆杀，答应我一定要看完。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc803b057da64661a0c646b78935fed0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=dzxBSWM%2B0RTSz48EcmCjcX5Quh0%3D" alt="wxv_4300760788626571269" loading="lazy"/></p>
<p>讲真的，看到《少年包青天》那一幕，眼里多少有些湿润，那个时候爸妈都在外面打工，暑假每天下午 4 点，端着小板凳坐在外公旁边看着包拯查案，现在他却去了另外一个世界。</p>
<p>其实这种视频的制作并不复杂，最近尤其可以很简单——就在昨天，即梦网页版做了全新升级，包括画布和 Agent 带来的交互方式更新，视频 3.5 Pro与图片 4.5 等重要模型能力上新，以及能够打造更自由更专业的“一镜到底”的智能多帧2.0。<br/>
我做的这支视频的全部流程基本都能在即梦网页版的画布里完成，真的是“一站式AI片场”。本着独乐乐不如众乐乐的宗旨，我来给大家分享下如何用即梦的“AI片场”完成这种“AI探班”的视频。按照惯例，教程同样主打有手就行，就能复刻出同样爆款视频。</p>
<p>先说工具，这次用的是即梦网页版的画布，在画布里可以调用图片 4.5 和 Agent 模式来生成所需图片，用视频 3.5 pro 来生成同框片场视频，用智能多帧 2.0 来一镜到底出片。总的来说就是最新模型、各种工具都能在画布里随时调用，不用再频繁切换场景，</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8cb4322523884725b78d642628d02d5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=iqzio2VF8tcAczqdYChLufJQdBo%3D" alt="图片" loading="lazy"/></p>
<blockquote>
<p>这个视频3.5 Pro 模型是基于字节自研模型Seedance 1.5 Pro，支持视频与音频的同时生成，我的视频中主角说话的声音其实就是通过它依次生成的。</p>
</blockquote>
<p>这个AI片场还有个特点，就是管理很清晰。用即梦画布+Agent一站式创作，除了上面提到的整合创作，还可以做可视化的素材管理，支持多个资产并行，同时还加入了工单模式，交互体验更加高效。很适合AI漫剧、AI短片等视频创作，真的是随时随地马上开机。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5cd98f69de4f4b90a17907d237c4b66d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=zTMEkNeFvVi6nZawAli4tXtSAhg%3D" alt="图片" loading="lazy"/>我发现即梦AI网页版现在不仅仅是个简单的生成工具，简直直接进化成了一个一站式“AI片场”，像AI漫剧、AI短片都可以直接在上面一站式完成，无需切换平台。</p>
<p>接下来我们直接来上教程，希望你也能复刻出一毛一样的爆款 AI 探班视频。</p>
<p>做这个视频分一下几个步骤：</p>
<p>1、文生角色图：生成一个特点鲜明的美女；（这里如果你想用真人出镜的话这一步可略过）<br/>
2、参考生成剧照场景图：上传第一步的美女图片及各经典电视剧剧照图片，生成合影；<br/>
3、首尾帧生视频；</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/868e511d105b489ba08c5238dcd5a987~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=5c%2FvicxdBUieUjWiz%2Ff81MNkRGY%3D" alt="图片" loading="lazy"/></p>
<p><strong>第一步：生成一个特点鲜明的美女</strong></p>
<p>打开即梦网页版，选择即梦 Agent 模式，输入以下提示词，Agent 自动识别并调文生图工具，就得到了这么一组校花照片。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e9954be00c34903adc61d8b23af1e61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=crnPo%2BAnwyyQ19bp5DgZrsK6wu8%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs">提示词：
提示词：双眼皮，大眼睛，长发微卷的长腿校花美女，穿着学生制服，白色百褶短裙，微笑，全身立体照片
</code></pre>
<p>一次生成 4 张，不满意可以点击「再次生成」，选择一张喜欢的照片：</p>
<p>最终我选择了这张作为女主角，特点够鲜明吧，卷发百褶裙女孩，大学梦中女神的样子。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f302a08d2af43faa06b9e0bf4d6a491~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=oQgn7q%2BoTH%2BkwBwuYTf%2FqUErjDE%3D" alt="图片" loading="lazy"/></p>
<p><strong>第二步：参考生成剧照场景图</strong></p>
<p>在即梦里，这里一共有 2 种方法，一种是同样选择即梦agent模式，上传参考图，输入提示词，agent自动调用生图模型生成图片</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b8ad4fa15e74b58ac5c9dabb9d9c8df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=BalY6PQ%2Bb7ZeXvApasm2Vh7AggE%3D" alt="图片" loading="lazy"/></p>
<p>第二种方式是直接选择图片生成，选择最新的图片 4.5 模型，来生成剧场场景照片。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6436668267ca49c1b0074925a854ddf3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=aLJcoZW86rQRNR5ExDq1tsx4vXo%3D" alt="图片" loading="lazy"/></p>
<blockquote>
<p>测下来即梦图片 4.5 相较于 4.0 有整体提升，在人像场景和美观度上，4.5得到显著改善，同时在画面美感和推理能力也有所增强。</p>
</blockquote>
<p>这个的提示词，需要根据你想要哪部电影剧场来做提示词的提炼，我提炼了个元提示词，大家可以在此基础上替换为自己想要的电影或者电视剧。</p>
<pre><code class="hljs">一张纪实风格的幕后照片，拍摄于一个繁忙的电视剧拍摄现场，模仿《填入电影或电视剧名》1999版的场景。参考图中的女孩（图1）站在四个人（图2）中间，五人看着镜头微笑合影。
背景是在古色古香的花园里面，有古代造型的亭子，
摄影机吊臂、专业灯光设备以及许多忙碌的剧组工作人员，电影颗粒感，抓拍瞬间。
</code></pre>
<p>比如，如果是想要《小李飞刀》的剧场，就直接将电视剧名填入进去，然后也可以做一些更多细节的补充。</p>
<blockquote>
<p>注意：其他合影的提示词与此类似，大家可以发挥自己的想象修改提示词</p>
</blockquote>
<p>放几张在即梦生成的合影图片，大家可以感受一下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9cda41c3a7cd4ee59b702e5d55fe83e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=iIXWnxBU%2Bit07GnSLumUQwL2%2FUY%3D" alt="图片" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b035152c378b476f92395c364821ab1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=e5vkRzGSmA9urm8CyQp9JMJaXA4%3D" alt="图片" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88fb37b59c094e7fa5477212f17d38d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=gzOZpozAi69SssMorULy8MrC8oo%3D" alt="图片" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6114623529634dda8e4d207b45846131~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=uK6HFSBhz9O89FIxXXkQCXbxafo%3D" alt="图片" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d6ed2720f014b179ac81e8ae4e72bfc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=%2Fm4arnyntkjhWR8bXGFjGp0MGyA%3D" alt="图片" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05f43f6244df4664a04f52c863f850ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=1Sf5SbjKSDLUWY3cAkDKBqBlTpE%3D" alt="图片" loading="lazy"/></p>
<p>依次生成各种合影图片之后，就可以开始视频的创作啦。</p>
<p><strong>第三步：视频生成</strong></p>
<p>在即梦中这里同样有 2 种方法，第一种就是用最新出来的智能多帧 2.0，<strong>新升级的智能多帧2.0 支持上传视频段落，进行“视频 + 视频”或“视频 + 图片”的拼接了，同时也可以视频片段修改，支持锁定特定片段后进行精细化编辑。</strong></p>
<p>点击「视频生成」，选择「智能多帧模式」，依次导入第二步生成的合影，即梦的智能多帧模式，在帧与帧之间输入提示词，生成好之后，如果对其中某个片段不满意，可以点击左下角的片段编辑。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7888d46567d24bf3bca9c94c40a6e070~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=7E9XyNAHlNx9FOqvoXdDQVlITEg%3D" alt="图片" loading="lazy"/></p>
<p>这里每个帧之间的提示词，基本都是这样的，如果想更复杂也可以自己稍加修改。</p>
<blockquote>
<p>提示词：图2中的卷发百褶裙女孩，从图2的片场中走出，走到了图3的片场中，与图3中的主创们合影</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5aae876e780a40da95de68051d8dcacb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=xYYy2ylWeLnsa3ujDRWBkS%2BJPkw%3D" alt="图片" loading="lazy"/></p>
<p>可以一镜到底生成视频：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59245fae83724bb0b170fcaec409ee28~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=mKjSIXWPc%2FPExSSD71auSWBsZs0%3D" alt="图片" loading="lazy"/></p>
<p>但这里我发现如果过于多片段，在个别片段中会有瑕疵，也可以直接编辑。</p>
<p>除了智能多帧，还可以用即梦的首尾帧模式。首尾帧模式还可以直接使用最新的视频 3.5 Pro 模型，智能多帧 2.0 目前还无法使用视频 3.5 Pro ，且帧与帧之间可以生成8秒的视频，首尾帧模式模式下最多可生成 12 s 的视频。</p>
<p>点击视频生成、选择首尾帧，然后在视频模型那里选择视频 3.5 Pro。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d78e58173e6146119112f4e7dfbf12a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=5I3E1qTW9QV08P%2FzjpUhQeV0wiM%3D" alt="图片" loading="lazy"/></p>
<p>即梦最新的视频3.5Pro模型支持音画同出，而且时长可以选择5s、10s，最长支持12s。</p>
<p>这里可以输入如下提示词：</p>
<pre><code class="hljs">提示词：图1中的卷发百褶裙女孩，走出图1 的片场，走到图2的片场中转过身来，
与片场主创合影，要求有脚步声，有片场嘈杂的工作声音，前3秒女孩只走路，后7秒女孩边走边与图2主创互动说：“三位老师辛苦啦”。
要求人物走路时自然灵动，眼神到位。
</code></pre>
<p>提示词大差不差，大家自己微调即可。</p>
<p>这里放一个首尾帧生成的片段，视频中声音也是由视频 3.5 Pro 直出的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf6b4162faf5450a87469cade750e67a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=OnMAmw3IJlOQL3GrjDLJOT8vB0U%3D" alt="wxv_4300881757102358532" loading="lazy"/></p>
<p>怎么样，是不是非常简单，大家快点实践起来吧。</p>
<p>接下来，我准备把这些视频发布到短视频平台，看看数据，到时再来和大家汇报。</p>
<p>当昔日耳熟能详的歌声响起，那些熟悉的街道、庭院和江湖并没有消失。</p>
<p>它们只是换了一种方式，活在我们的记忆里，也活在每一个被 AI 唤醒的想象中。</p>
<p>原来我们怀念的从来不只是某部剧，<strong>而是那个搬着小板凳守在电视机前，相信所有故事都会有好结局的自己</strong></p>
<p>这一刻 AI 最动人的时刻，或许就是让我们与曾经的自己重逢。</p>
<p>在这个片场里，每个人都可以是造梦者，随时开机。</p>
<p>随时回到那个相信光的世界。</p>
<p>回到开头提到的工具，这次即梦AI网页版的升级，真的有点东西。它把“灵感—画面—视频—长镜头”这一整套创作全流程都打通了，完全就是给了我们一个随身携带的一站式“AI片场”。</p>
<p>首发接入的 Seedance 1.5 pro表现也很不错，除了音画同出，还可以说方言，人物表情等也能达到影视级的呈现。企业用户12月18日起可前往火山方舟体验中心体验。</p>
<p>不管你是想做那种让人一眼惊艳的创意海报，还是想做剧情复杂的AI漫剧、AI短片，它现在的能力都能接得住，而且门槛低到离谱。</p>
<p>以后再有啥天马行空的脑洞，真不用担心技术不行了，打开网页随时都能开机创作。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[观测云在企业应用性能故障分析场景中的最佳实践]]></title>    <link>https://juejin.cn/post/7586855770504675362</link>    <guid>https://juejin.cn/post/7586855770504675362</guid>    <pubDate>2025-12-23T11:12:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586855770504675362" data-draft-id="7586973107321585704" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="观测云在企业应用性能故障分析场景中的最佳实践"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-23T11:12:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="可观测性用观测云"/> <meta itemprop="url" content="https://juejin.cn/user/2392958212523102"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            观测云在企业应用性能故障分析场景中的最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392958212523102/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    可观测性用观测云
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T11:12:25.000Z" title="Tue Dec 23 2025 11:12:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>某企业经常遇到应用性能问题，对于应用性能的监测缺少基本的手段，这无疑对故障的排查增加了难度，而且对于产品大促期间，这无疑会影响用户的体验以及最终的交易，本文主要通过介绍某出海企业用户在使用观测云应用性能监测分析时的故障场景分析实践。</p>
<h2 data-id="heading-1">应用性能监测</h2>
<p>观测云拥有应用性能监测的能力，支持各种主流语言的技术栈，并兼容 OpenTelemetry，Skywalking，Jaeger，DDTrace 等等开源的 Agent，最佳部署方案是将 DataKit 部署在每一台应用服务器中，通过服务所在主机的 DataKit 后将数据打到观测云中心，能更好地对应用服务的服务器主机指标、应用日志、系统日志、应用服务链路数据等统一汇聚，进行各项数据的关联分析，而观测云应用性能监测主要功能包含服务，概览，链路，错误追踪，Profiling，应用性能指标检测等功能，本文主要基于观测云的应用监测能力，对用户故障场景进行分析实践。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67e933182523400184c88c247e696322~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=Ws%2FyDwidhStiwAWac9m2SiyHte4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">应用性能故障场景分析</h2>
<p>故障概述：用户反馈在 17:00 前后发生应用性能访问的故障，页面卡顿，数据加载不出，基于此进行了以下场景的分析。</p>
<h3 data-id="heading-3">某服务故障场景分析实践-Read time out</h3>
<ul>
<li>如图，通过观测云查看到，请求量增加，从 1 万 3 的请求量级增加到，20 万左右量级，并出现大量报错，请求超时，建议平时做好压测</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/731ff73df8a24c12be1dcfdd2464a6b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=wWKVj%2FSEhSMzkRmp%2FZHYkhqwjl8%3D" alt="" loading="lazy"/></p>
<ul>
<li>查看报错聚类分析，服务报错在该段时间，Read time out 报错最多</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6e10a7cfe634eaeb6fd03d2cb25a0ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=S4fQKM7A0nKE6jljOLGgVTzWZ7E%3D" alt="" loading="lazy"/></p>
<ul>
<li>分析 timeout 详细，超时底层栈在 SocketInputStream.socketRead，该底层方法即发起请求后在读数据的返回</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c64674f67d7448e5849a361261406122~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=qh36Ybu0oA7jjaXf%2BtNWNCQDQ6w%3D" alt="" loading="lazy"/></p>
<ul>
<li>查看链路的瀑布图，有 1 分钟超时报错，建议检查超时设置</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d31b0fe2a0f44238bfaf709619e35da3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=V%2FoFi7tFmW6gvimM8Yjzp1J1od4%3D" alt="" loading="lazy"/></p>
<ul>
<li>查看链路调用超时的拓扑图，有调 MySQL 数据库，在应用侧超时报错</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/629684b72bc848688cccb1eaee351a0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=BydhavSr187rpqEGfQmXBKb7hG4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">MySQL 故障场景分析实践-JDBC连接通信异常</h3>
<ul>
<li>对 MySQL 请求量分析，发现在 17:00 左右，MySQL 请求量级也增加至少不低于 10 倍，并出现了大量报错</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e245e410d5534f5cb15033c801736bab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=qLqfd0U%2BTwh797wHrcj%2F5Ck8OHc%3D" alt="" loading="lazy"/></p>
<ul>
<li>报错如下，主要是数据包发送接收超时，通信失败以及服务 shutdown 的情况</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a9ef549a4e6435b95c46d64651d618f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=ox5RI32BpQbr4GK7ORbRDV2ENMk%3D" alt="" loading="lazy"/></p>
<ul>
<li>以上时间段可能有 MySQL 重启，筛选 17:00 左右数据，没有 server shutdown 的报错，但依然是通信超时异常</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dce4def37cad4204ad9dd94f8c372218~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=F4C8VZ4PyBdGsZTrJdwbthAzxQo%3D" alt="" loading="lazy"/></p>
<ul>
<li>报错详细堆栈显示 Druid 数据库连接产生的 jdbc 异常，建议用户检查数据库连接池连接与配置情况</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04180bfc5e074682b6ada431e4f56f07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=QYoE%2F3y%2FJXD4a6AsFCKhKqnw4yk%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">MySQL 故障场景分析实践-MySQL 请求调用分析</h3>
<ul>
<li>分析 MySQL 的请求与调用，很多服务都会调用 MySQL，每秒 5 万多请求调用</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e447affb33a24199a1275fda8a7b28db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=YfQEhekCJK70a%2FNszgqnD4By2M4%3D" alt="" loading="lazy"/></p>
<ul>
<li>其中调用 MySQL 调用最多的为该服务，每秒 4 万多请求</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f0faf7029264f6fb744658cce4cf798~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=MT0bXF5u0Om1tvYm1BCsszYEOxc%3D" alt="" loading="lazy"/></p>
<ul>
<li>其次调用 MySQL 调用最多的为 xxxxx-product-server 服务，每秒 9 千多请求</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63fb8b2b2c7d42898726ac144aad3a24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=NzNe%2F9EtthEmSA2MQ7J2vgTjrz0%3D" alt="" loading="lazy"/></p>
<ul>
<li>对 MySQL 调用最多的服务分析上下游调用情况，发现很多服务都会通过该配置服务调用 MySQL，建议考虑是否可以增加 MySQL 缓存优化</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0347a17cd8094893865abc35891ec3a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=wjutaJgidaw7QENv1fW%2FuLW8YjE%3D" alt="" loading="lazy"/></p>
<ul>
<li>而且服务之间很多相互调用，服务之间也会直接或者间接的调用调数据库，只要有一个服务有问题，就可能引起连锁性能问题</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82f52074fffe4327a9de398924853689~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=gbfqGX6Xh1OKQxrhXteHDri%2FzJc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">调用数据库较多的配置服务-量能分析实践</h3>
<ul>
<li>分析配置服务请求，发现请求量从 5 万级别到 50 万级别</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eea56f5d415c48d7923022c2804a995b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=ErRVBGXFwzNSigHp2bS%2BmcsFUFw%3D" alt="" loading="lazy"/></p>
<ul>
<li>大量请求错误，并呈现几分钟的严重超时</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc39f984622f400694b12f18e26d2be1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=bCOIDlKALRUfDR%2FaXQSNhnJsgWU%3D" alt="" loading="lazy"/></p>
<ul>
<li>超时也是从 17:00 左右发生，等待数据返回</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25fbcf25cc0a46af8bd298ebcdad4854~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=JGg3NLLgQ44yuxYlrhkQpsA8uhY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">观测云应用性能分析总结</h2>
<p>综上场景分析实践，基于观测云的应用性能监测分析得出结论与建议：</p>
<ul>
<li>MySQL 数据库连接问题导致本次故障，建议检查数据库连接配置，确认为连接池数不够用，连接超时，可以基于观测云增加基于连接池指标的监控</li>
<li>业务请求并发量较高，导致 MySQL 数据库请求连接数量过高</li>
<li>对调用 MySQL 较多的 xxxxx-config-server 服务，后续可以考虑采用 redis 缓存方式，减少对 MySQL 的调用</li>
<li>当有高并发活动大促时，为避免高并发导致一系列的故障采用秒级可以拉起的高性能数据库厂商</li>
<li>对于高并发的场景，提前做好性能压测，确保对应的资源能满足对应活动的并发量请求</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀开源编程新王诞生，对标Claude Sonnet 4.5？实测GLM-4.7：Coding和Agentic能力直逼Gemini 3和Claude 4.5]]></title>    <link>https://juejin.cn/post/7586865729703084070</link>    <guid>https://juejin.cn/post/7586865729703084070</guid>    <pubDate>2025-12-23T11:15:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586865729703084070" data-draft-id="7586902693857984554" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀开源编程新王诞生，对标Claude Sonnet 4.5？实测GLM-4.7：Coding和Agentic能力直逼Gemini 3和Claude 4.5"/> <meta itemprop="keywords" content="ChatGLM (智谱),AIGC,AI编程"/> <meta itemprop="datePublished" content="2025-12-23T11:15:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="win4r"/> <meta itemprop="url" content="https://juejin.cn/user/1739869037541555"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀开源编程新王诞生，对标Claude Sonnet 4.5？实测GLM-4.7：Coding和Agentic能力直逼Gemini 3和Claude 4.5
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1739869037541555/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    win4r
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T11:15:25.000Z" title="Tue Dec 23 2025 11:15:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>昨天凌晨，智谱AI悄悄放了个大招——发布了最新的开源大模型GLM-4.7。</p>
<p>🔥🔥🔥本篇笔记所对应的视频：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1UTBKBxESA%2F" target="_blank" title="https://www.bilibili.com/video/BV1UTBKBxESA/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1UT…</a></p>
<p>说"悄悄"是因为这年头新模型实在太多，大家早就审美疲劳了。但这款模型有点不一样，358B参数的MoE架构，关键是MIT开源协议——这意味着你拿去商用都没问题。</p>
<p>光看参数和协议没意思，模型好不好用，还得实测才知道。我花了几个小时把这款模型从简单到复杂折腾了一遍，下面跟大家聊聊真实的使用感受。</p>
<h2 data-id="heading-0">先说说官方给的成绩单</h2>
<p>在看实测之前，简单过一下官方公布的基准测试数据。</p>
<p>数学竞赛这一项，GLM-4.7拿了95.7分，直接超过了GPT-5.1。代码能力方面，超过了DeepSeek 3.2和Claude Sonnet 4.5。科学推理、复杂推理这几个维度，基本都是同样的结果——比DeepSeek 3.2强，跟Claude Sonnet 4.5打得有来有回，部分指标还有明显优势。</p>
<p>当然，基准测试这东西，大家心里都清楚，参考价值有限。真正好不好用，还是得拉出来遛遛。</p>
<h2 data-id="heading-1">第一轮：前端能力试水</h2>
<h3 data-id="heading-2">一句话生成太阳系动画</h3>
<p>先从简单的开始。我在官方网页版输入了一句话："用SVG生成模拟太阳系的动画"。</p>
<p>结果确实让我有点意外。它不仅画出了八大行星围绕太阳公转的动画，而且动画相当流畅。放大之后能看到行星的运行轨迹，月球绕着地球转，土星还带着光环。</p>
<p>就这么简单的一句提示词，能出这个效果，前端基础能力是过关的。</p>
<h3 data-id="heading-3">冒泡排序可视化</h3>
<p>接下来加点难度。我让它创建一个冒泡算法的动画演示，要求画面里有12颗大小不同的小行星，还有一艘指挥舰来执行排序操作。</p>
<p>这个任务其实挺考验综合能力的——算法理解、前端实现、动画设计、交互逻辑，缺一不可。</p>
<p>最终效果：点击开始后，指挥舰会在小行星上方移动，发现左侧的小行星比右侧大，就执行交换。整个过程有状态提示，显示"正在比较"或"正在交换"，运行全程没有报错。</p>
<p>到这里，基本的前端+算法能力算是验证通过了。</p>
<h3 data-id="heading-4">3D恐龙狩猎游戏</h3>
<p>然后是真正的硬菜——让它从零开发一个3D风格的恐龙狩猎游戏。</p>
<p>要求挺复杂的：玩家操控一辆装有机枪的皮卡车，用鼠标瞄准射击恐龙，键盘控制车辆移动。场景要有侏罗纪风格，原始森林、高大植物、岩石、河流、火山，还要有雾气效果。</p>
<p>坦白讲，发出这个提示词的时候，我没抱太大期望。这种需求涉及3D图形渲染、物理碰撞检测、AI行为系统、多模态交互，一般的模型做出来要么跑不起来，要么就是一堆报错。</p>
<p>结果出乎意料——游戏真的能玩。皮卡车可以用键盘控制移动，鼠标瞄准射击。远处会刷新恐龙，小型恐龙两三枪就倒，大型恐龙要多打几枪。开枪后恐龙还会逃跑，打死后尸体会消失。远处能看到山脉和雾气效果，游戏结束后会显示得分。</p>
<p>能一次跑通这么复杂的游戏项目，说明它对大规模代码组织和系统性工程实现的能力确实不弱。</p>
<h3 data-id="heading-5">数学推导动画</h3>
<p>接着测试了数学能力。让它创建一个演示圆面积公式推导过程的交互动画。</p>
<p>这个任务的难点在于把抽象的数学概念变成直观的视觉呈现。需要理解极限思想，还要把圆切割、重排成近似长方形的过程用动画展示出来。</p>
<p>最终效果很不错。可以设置切割数量，比如切成64份，然后看着这64个扇形被分开、重组成一个近似的长方形，高是半径r，底边是πr。下面还有文字解释切割原理、重排原理、极限思想，公式推导一目了然。</p>
<p>这种把复杂概念可视化的能力，在教育场景下应该挺有价值的。</p>
<h3 data-id="heading-6">PPT自动生成</h3>
<p>最后试了一下让它根据网页内容自动生成PPT。给了一个GLM-4.7的官方介绍链接，让它直接做成演示文稿。</p>
<p>生成的PPT有模型介绍、核心特性、基准测试数据、三大思考模式、使用方法、产品优势等内容，还自动配了代码截图和数据图表。</p>
<p>作为一键生成的初稿，效果算是及格线以上，拿来稍作修改就能用。</p>
<h2 data-id="heading-7">第二轮：Claude Code接入测试</h2>
<p>前端能力测完了，接下来试试在Claude Code中调用这款模型，测试它的工具调用能力和复杂编程能力。</p>
<h3 data-id="heading-8">配置方法</h3>
<p>接入方式很简单，三条命令搞定：设置Base URL、API Key、模型ID。海外用户可以通过z.ai平台获取API，国内用户用BigModel平台。</p>
<p>启动Claude Code后，模型ID显示为GLM-4.7，说明接入成功。</p>
<h3 data-id="heading-9">浏览器自动化测试</h3>
<p>这部分使用了谷歌官方的Chrome DevTools MCP来测试浏览器自动化能力。</p>
<p>任务是：访问我的博客，点击进入前三篇文章，提取内容，然后改写成适合发X（原Twitter）的短文案。</p>
<p>整个过程看着它自动打开浏览器，点击第一篇博客、返回首页、点击第二篇、返回、点击第三篇，然后提取内容进行改写。最终输出了三篇带emoji表情和标签的X Post，运行速度也挺快。</p>
<p>工具调用能力没问题。</p>
<h3 data-id="heading-10">终极测试：iOS原生APP开发</h3>
<p>压轴的是一个难度拉满的任务——开发一款iOS原生背单词APP。</p>
<p>要求支持iOS 17+、Swift 5.9、SwiftUI、SwiftData、Swift Charts等技术栈。功能包括：首页展示学习进度、单词卡片支持正反面3D翻转动画、练习测试模块、学习进度统计图表、设置模块等。</p>
<p>先用Xcode初始化一个空项目，然后在Claude Code中执行init命令生成CLAUDE.md文件，让它理解项目结构。接着进入计划模式，粘贴完整需求，让它制定开发计划并执行。</p>
<p>等了大概十多分钟，它完成了开发。然后我又让它把显示语言改成中文。</p>
<p>在Xcode中运行，编译成功。测试结果：可以滑动卡片切换单词，点击翻转查看中文释义，点击"已掌握"后自动切换下一个单词，有每日目标显示，练习和进度模块也能正常使用。</p>
<p>唯一没实现的是设置功能，不过让它继续补充应该问题不大。</p>
<p>能在十几分钟内完成一个功能相对完整的iOS原生应用，这个复杂编程能力确实有点东西。</p>
<h2 data-id="heading-11">几个值得关注的特性</h2>
<p>除了实测体验，GLM-4.7还有几个设计上的亮点值得一提：</p>
<p>三种思考模式。Interleaved Thinking是在每次响应和工具调用前先思考；Preserved Thinking是在多轮对话中保留之前的思考过程，不用每次从头推导；Turn-level Thinking是支持按轮次控制是否启用思考，简单问题关掉思考降低延迟，复杂任务打开提高准确性。</p>
<p>这种设计对长链路、多步骤的Agent任务应该挺有帮助，能减少信息丢失和前后不一致的问题。</p>
<p>上下文和输出限制。200K的上下文窗口，128K的最大输出长度，做复杂项目的时候不太容易撑爆。</p>
<p>开源友好。权重在HuggingFace和ModelScope都能下载，支持vLLM和SGLang本地部署，MIT协议商用无压力。</p>
<h2 data-id="heading-12">总结</h2>
<p>折腾了一圈下来，说说我的真实感受：</p>
<p>GLM-4.7的前端能力确实不错，从简单的SVG动画到复杂的3D游戏都能一次跑通，代码组织能力和工程实现能力在开源模型里算是第一梯队。工具调用稳定，iOS原生开发也能应付，综合编程能力比上一代有明显提升。</p>
<p>当然，基准测试里那些"超越GPT-5.1"、"领先Claude Sonnet 4.5"的说法，还是要打个问号。毕竟基准测试和实际使用场景差异很大，而且不同任务表现可能差别也不小。</p>
<p>但不管怎么说，作为一款MIT协议的开源模型，能做到这个水平，对开发者来说是个好消息。毕竟有竞争才有进步，开源生态越卷，大家的选择就越多。</p>
<p>想试试的可以去z.ai（海外）或BigModel平台（国内）体验网页版，也可以在Claude Code里通过API调用。本地部署的话，HuggingFace上有权重可以下载。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 布局组件选择指南]]></title>    <link>https://juejin.cn/post/7586855770504740898</link>    <guid>https://juejin.cn/post/7586855770504740898</guid>    <pubDate>2025-12-23T11:22:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586855770504740898" data-draft-id="7586855770504724514" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 布局组件选择指南"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2025-12-23T11:22:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="麦客奥德彪"/> <meta itemprop="url" content="https://juejin.cn/user/2365804752418232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 布局组件选择指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2365804752418232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    麦客奥德彪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T11:22:26.000Z" title="Tue Dec 23 2025 11:22:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">快速决策流程图</h2>
<pre><code class="hljs language-scss" lang="scss">需要布局？
├─ 只有一个子组件？
│  ├─ 需要居中？ → Center
│  ├─ 需要边距？ → <span class="hljs-attribute">Padding</span>
│  ├─ 需要背景/边框/圆角？ → Container
│  ├─ 需要固定大小？ → SizedBox
│  ├─ 需要特定对齐？ → Align
│  └─ 需要保持宽高比？ → AspectRatio
│
└─ 有多个子组件？
   ├─ 横向排列？ → Row
   ├─ 纵向排列？ → Column
   ├─ 重叠显示？ → Stack
   ├─ 自动换行？ → Wrap
   ├─ 网格显示？ → GridView
   ├─ 列表显示？ → ListView
   └─ 内容超出屏幕？ → SingleChildScrollView
</code></pre>
<h2 data-id="heading-1">场景化选择指南</h2>
<h3 data-id="heading-2">1. 基础样式场景</h3>
<h4 data-id="heading-3">需要设置背景色、圆角、阴影、边框</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 使用 Container</span>
<span class="hljs-selector-tag">Container</span>(
  <span class="hljs-attribute">decoration</span>: <span class="hljs-built_in">BoxDecoration</span>(
    <span class="hljs-attribute">color</span>: Colors.blue,
    <span class="hljs-attribute">borderRadius</span>: BorderRadius.<span class="hljs-built_in">circular</span>(<span class="hljs-number">12</span>),
    <span class="hljs-attribute">boxShadow</span>: [<span class="hljs-built_in">BoxShadow</span>(<span class="hljs-attribute">color</span>: Colors.grey, <span class="hljs-attribute">blurRadius</span>: <span class="hljs-number">4</span>)],
  ),
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'内容'</span>),
)
</code></pre>
<h4 data-id="heading-4">只需要边距</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 使用 Padding（更轻量）</span>
<span class="hljs-selector-tag">Padding</span>(
  <span class="hljs-attribute">padding</span>: EdgeInsets.<span class="hljs-built_in">all</span>(<span class="hljs-number">16</span>),
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'内容'</span>),
)

<span class="hljs-comment">// ❌ 避免用 Container（过重）</span>
<span class="hljs-selector-tag">Container</span>(
  <span class="hljs-attribute">padding</span>: EdgeInsets.<span class="hljs-built_in">all</span>(<span class="hljs-number">16</span>),
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'内容'</span>),
)
</code></pre>
<h4 data-id="heading-5">需要固定间距</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 使用 SizedBox</span>
<span class="hljs-selector-tag">Column</span>(
  <span class="hljs-attribute">children</span>: [
    <span class="hljs-built_in">Text</span>(<span class="hljs-string">'第一行'</span>),
    <span class="hljs-built_in">SizedBox</span>(<span class="hljs-attribute">height</span>: <span class="hljs-number">16</span>),  <span class="hljs-comment">// 间距</span>
    <span class="hljs-built_in">Text</span>(<span class="hljs-string">'第二行'</span>),
  ],
)
</code></pre>
<h3 data-id="heading-6">2. 排列布局场景</h3>
<h4 data-id="heading-7">横向排列（如工具栏、按钮组）</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 使用 Row</span>
<span class="hljs-selector-tag">Row</span>(
  <span class="hljs-attribute">mainAxisAlignment</span>: MainAxisAlignment.spaceBetween,
  <span class="hljs-attribute">children</span>: [
    <span class="hljs-built_in">Icon</span>(Icons.menu),
    <span class="hljs-built_in">Text</span>(<span class="hljs-string">'标题'</span>),
    <span class="hljs-built_in">Icon</span>(Icons.search),
  ],
)
</code></pre>
<h4 data-id="heading-8">纵向排列（如表单、卡片内容）</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 使用 Column</span>
<span class="hljs-selector-tag">Column</span>(
  <span class="hljs-attribute">crossAxisAlignment</span>: CrossAxisAlignment.start,
  <span class="hljs-attribute">children</span>: [
    <span class="hljs-built_in">Text</span>(<span class="hljs-string">'姓名'</span>),
    <span class="hljs-built_in">TextField</span>(),
    <span class="hljs-built_in">SizedBox</span>(<span class="hljs-attribute">height</span>: <span class="hljs-number">16</span>),
    <span class="hljs-built_in">Text</span>(<span class="hljs-string">'邮箱'</span>),
    <span class="hljs-built_in">TextField</span>(),
  ],
)
</code></pre>
<h4 data-id="heading-9">子组件需要自适应分配空间</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 使用 Expanded 或 Flexible</span>
<span class="hljs-selector-tag">Row</span>(
  <span class="hljs-attribute">children</span>: [
    <span class="hljs-built_in">Icon</span>(Icons.star),
    <span class="hljs-built_in">Expanded</span>(  <span class="hljs-comment">// 占据剩余空间</span>
      <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'这是一段很长的文本...'</span>),
    ),
    <span class="hljs-built_in">Icon</span>(Icons.more_vert),
  ],
)
</code></pre>
<h3 data-id="heading-10">3. 特殊排列场景</h3>
<h4 data-id="heading-11">标签云、流式布局（自动换行）</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 使用 Wrap</span>
<span class="hljs-selector-tag">Wrap</span>(
  <span class="hljs-attribute">spacing</span>: <span class="hljs-number">8</span>,
  <span class="hljs-attribute">runSpacing</span>: <span class="hljs-number">8</span>,
  <span class="hljs-attribute">children</span>: [
    <span class="hljs-built_in">Chip</span>(<span class="hljs-attribute">label</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'Flutter'</span>)),
    <span class="hljs-built_in">Chip</span>(<span class="hljs-attribute">label</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'Dart'</span>)),
    <span class="hljs-built_in">Chip</span>(<span class="hljs-attribute">label</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'Mobile'</span>)),
    <span class="hljs-comment">// 自动换行</span>
  ],
)
</code></pre>
<h4 data-id="heading-12">图片上叠加按钮、角标</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 使用 Stack + Positioned</span>
<span class="hljs-selector-tag">Stack</span>(
  <span class="hljs-attribute">children</span>: [
    Image.<span class="hljs-built_in">network</span>(<span class="hljs-string">'url'</span>),
    <span class="hljs-built_in">Positioned</span>(
      <span class="hljs-attribute">top</span>: <span class="hljs-number">8</span>,
      <span class="hljs-attribute">right</span>: <span class="hljs-number">8</span>,
      <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Icon</span>(Icons.favorite, <span class="hljs-attribute">color</span>: Colors.red),
    ),
  ],
)
</code></pre>
<h3 data-id="heading-13">4. 列表场景</h3>
<h4 data-id="heading-14">少量固定项目（&lt;20项）</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 使用 Column（简单直接）</span>
<span class="hljs-selector-tag">Column</span>(
  <span class="hljs-attribute">children</span>: [
    <span class="hljs-built_in">ListTile</span>(<span class="hljs-attribute">title</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'项目1'</span>)),
    <span class="hljs-built_in">ListTile</span>(<span class="hljs-attribute">title</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'项目2'</span>)),
    <span class="hljs-built_in">ListTile</span>(<span class="hljs-attribute">title</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'项目3'</span>)),
  ],
)
</code></pre>
<h4 data-id="heading-15">大量动态数据</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 使用 ListView.builder（性能优化）</span>
<span class="hljs-selector-tag">ListView</span><span class="hljs-selector-class">.builder</span>(
  <span class="hljs-attribute">itemCount</span>: <span class="hljs-number">1000</span>,
  <span class="hljs-attribute">itemBuilder</span>: (context, index) {
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ListTile</span>(<span class="hljs-attribute">title</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'项目 $index'</span>));
  },
)
</code></pre>
<h4 data-id="heading-16">横向滚动列表</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 使用 ListView + scrollDirection</span>
<span class="hljs-selector-tag">ListView</span><span class="hljs-selector-class">.builder</span>(
  <span class="hljs-attribute">scrollDirection</span>: Axis.horizontal,
  <span class="hljs-attribute">itemCount</span>: <span class="hljs-number">10</span>,
  <span class="hljs-attribute">itemBuilder</span>: (context, index) {
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Container</span>(
      <span class="hljs-attribute">width</span>: <span class="hljs-number">150</span>,
      <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Card</span>(<span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'卡片 $index'</span>)),
    );
  },
)
</code></pre>
<h4 data-id="heading-17">网格布局</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 固定列数用 GridView.count</span>
<span class="hljs-selector-tag">GridView</span><span class="hljs-selector-class">.count</span>(
  <span class="hljs-attribute">crossAxisCount</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attribute">children</span>: List.<span class="hljs-built_in">generate</span>(<span class="hljs-number">20</span>, (index) =&gt; <span class="hljs-built_in">Card</span>()),
)

<span class="hljs-comment">// ✅ 固定宽度用 GridView.extent</span>
<span class="hljs-selector-tag">GridView</span><span class="hljs-selector-class">.extent</span>(
  <span class="hljs-attribute">maxCrossAxisExtent</span>: <span class="hljs-number">150</span>,  <span class="hljs-comment">// 每项最大宽度</span>
  <span class="hljs-attribute">children</span>: List.<span class="hljs-built_in">generate</span>(<span class="hljs-number">20</span>, (index) =&gt; <span class="hljs-built_in">Card</span>()),
)
</code></pre>
<h3 data-id="heading-18">5. 滚动场景</h3>
<h4 data-id="heading-19">单个组件需要滚动</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 使用 SingleChildScrollView</span>
<span class="hljs-selector-tag">SingleChildScrollView</span>(
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Column</span>(
    <span class="hljs-attribute">children</span>: [
      <span class="hljs-comment">// 很多内容</span>
    ],
  ),
)
</code></pre>
<h4 data-id="heading-20">列表需要滚动</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// ✅ ListView 自带滚动</span>
<span class="hljs-built_in">ListView</span>(children: [...])

<span class="hljs-comment">// ❌ 不需要额外包裹 SingleChildScrollView</span>
</code></pre>
<h4 data-id="heading-21">避免嵌套滚动冲突</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ ListView 内使用 shrinkWrap</span>
<span class="hljs-selector-tag">Column</span>(
  <span class="hljs-attribute">children</span>: [
    <span class="hljs-built_in">Text</span>(<span class="hljs-string">'标题'</span>),
    ListView.<span class="hljs-built_in">builder</span>(
      <span class="hljs-attribute">shrinkWrap</span>: true,  <span class="hljs-comment">// 重要！</span>
      <span class="hljs-attribute">physics</span>: <span class="hljs-built_in">NeverScrollableScrollPhysics</span>(),  <span class="hljs-comment">// 禁用内部滚动</span>
      <span class="hljs-attribute">itemCount</span>: <span class="hljs-number">10</span>,
      <span class="hljs-attribute">itemBuilder</span>: (context, index) =&gt; <span class="hljs-built_in">ListTile</span>(),
    ),
  ],
)
</code></pre>
<h3 data-id="heading-22">6. 对齐场景</h3>
<h4 data-id="heading-23">单个组件居中</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 使用 Center（最简单）</span>
<span class="hljs-selector-tag">Center</span>(<span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'居中文本'</span>))

<span class="hljs-comment">// ✅ 或使用 Align（更灵活）</span>
<span class="hljs-selector-tag">Align</span>(
  <span class="hljs-attribute">alignment</span>: Alignment.center,
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'居中文本'</span>),
)
</code></pre>
<h4 data-id="heading-24">多个组件整体居中</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 使用 Center 包裹 Column/Row</span>
<span class="hljs-selector-tag">Center</span>(
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Column</span>(
    <span class="hljs-attribute">mainAxisSize</span>: MainAxisSize.min,  <span class="hljs-comment">// 重要！</span>
    <span class="hljs-attribute">children</span>: [
      <span class="hljs-built_in">Text</span>(<span class="hljs-string">'标题'</span>),
      <span class="hljs-built_in">Text</span>(<span class="hljs-string">'副标题'</span>),
    ],
  ),
)
</code></pre>
<h4 data-id="heading-25">Row/Column 内部对齐</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 使用对齐属性</span>
<span class="hljs-selector-tag">Column</span>(
  <span class="hljs-attribute">mainAxisAlignment</span>: MainAxisAlignment.center,  <span class="hljs-comment">// 主轴居中</span>
  <span class="hljs-attribute">crossAxisAlignment</span>: CrossAxisAlignment.start,  <span class="hljs-comment">// 交叉轴起始</span>
  <span class="hljs-attribute">children</span>: [...],
)
</code></pre>
<h3 data-id="heading-26">7. 响应式场景</h3>
<h4 data-id="heading-27">根据屏幕宽度调整布局</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// ✅ 使用 LayoutBuilder</span>
<span class="hljs-built_in">LayoutBuilder</span>(
  builder: (context, constraints) {
    if (constraints.maxWidth &gt; <span class="hljs-number">600</span>) {
      return <span class="hljs-built_in">Row</span>(children: [侧边栏, 内容]);  <span class="hljs-comment">// 平板/桌面</span>
    } else {
      return <span class="hljs-built_in">Column</span>(children: [内容]);  <span class="hljs-comment">// 手机</span>
    }
  },
)
</code></pre>
<h4 data-id="heading-28">适配安全区域（刘海屏、底部栏）</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 使用 SafeArea</span>
<span class="hljs-selector-tag">SafeArea</span>(
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Column</span>(<span class="hljs-attribute">children</span>: [...]),
)
</code></pre>
<h2 data-id="heading-29">常见错误与优化</h2>
<h3 data-id="heading-30">❌ 错误示例 1：过度使用 Container</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ❌ 只需要边距，却用 Container</span>
<span class="hljs-selector-tag">Container</span>(
  <span class="hljs-attribute">padding</span>: EdgeInsets.<span class="hljs-built_in">all</span>(<span class="hljs-number">16</span>),
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'内容'</span>),
)

<span class="hljs-comment">// ✅ 应该用 Padding</span>
<span class="hljs-selector-tag">Padding</span>(
  <span class="hljs-attribute">padding</span>: EdgeInsets.<span class="hljs-built_in">all</span>(<span class="hljs-number">16</span>),
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'内容'</span>),
)
</code></pre>
<h3 data-id="heading-31">❌ 错误示例 2：不必要的嵌套</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ❌ 多层无意义嵌套</span>
<span class="hljs-selector-tag">Container</span>(
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Center</span>(
    <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Container</span>(
      <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'内容'</span>),
    ),
  ),
)

<span class="hljs-comment">// ✅ 简化</span>
<span class="hljs-selector-tag">Center</span>(<span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'内容'</span>))
</code></pre>
<h3 data-id="heading-32">❌ 错误示例 3：Column 超出屏幕未处理</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ❌ 内容多时会溢出</span>
<span class="hljs-selector-tag">Column</span>(
  <span class="hljs-attribute">children</span>: [
    <span class="hljs-comment">// 很多内容</span>
  ],
)

<span class="hljs-comment">// ✅ 添加滚动</span>
<span class="hljs-selector-tag">SingleChildScrollView</span>(
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Column</span>(<span class="hljs-attribute">children</span>: [...]),
)
</code></pre>
<h3 data-id="heading-33">❌ 错误示例 4：ListView 内嵌套 ListView</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ❌ 会报错或性能差</span>
<span class="hljs-selector-tag">ListView</span>(
  <span class="hljs-attribute">children</span>: [
    <span class="hljs-built_in">ListView</span>(<span class="hljs-attribute">children</span>: [...]),  <span class="hljs-comment">// 错误！</span>
  ],
)

<span class="hljs-comment">// ✅ 使用 shrinkWrap</span>
<span class="hljs-selector-tag">ListView</span>(
  <span class="hljs-attribute">children</span>: [
    <span class="hljs-built_in">ListView</span>(
      <span class="hljs-attribute">shrinkWrap</span>: true,
      <span class="hljs-attribute">physics</span>: <span class="hljs-built_in">NeverScrollableScrollPhysics</span>(),
      <span class="hljs-attribute">children</span>: [...],
    ),
  ],
)
</code></pre>
<h2 data-id="heading-34">性能优化建议</h2>
<ol>
<li><strong>大列表必须用 .builder</strong>：超过 20 项就用 <code>ListView.builder</code> 或 <code>GridView.builder</code></li>
<li><strong>避免深层嵌套</strong>：超过 5 层考虑拆分成独立 Widget</li>
<li><strong>合理使用 const</strong>：静态 Widget 加 <code>const</code> 提升性能</li>
<li><strong>避免在 build 中创建大量对象</strong>：把样式定义提取到常量</li>
<li><strong>使用 <code>RepaintBoundary</code></strong>：隔离频繁重绘的组件</li>
</ol>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 性能优化示例</span>
<span class="hljs-selector-tag">const</span> <span class="hljs-selector-tag">EdgeInsets</span> <span class="hljs-selector-tag">_padding</span> = <span class="hljs-selector-tag">EdgeInsets</span><span class="hljs-selector-class">.all</span>(<span class="hljs-number">16</span>);  <span class="hljs-comment">// 复用常量</span>

<span class="hljs-selector-tag">ListView</span><span class="hljs-selector-class">.builder</span>(  <span class="hljs-comment">// 大列表用 builder</span>
  <span class="hljs-attribute">itemCount</span>: <span class="hljs-number">1000</span>,
  <span class="hljs-attribute">itemBuilder</span>: (context, index) {
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">RepaintBoundary</span>(  <span class="hljs-comment">// 隔离重绘</span>
      <span class="hljs-attribute">child</span>: const <span class="hljs-built_in">ListTile</span>(<span class="hljs-attribute">title</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'项目'</span>)),  <span class="hljs-comment">// 使用 const</span>
    );
  },
)
</code></pre>
<h2 data-id="heading-35">快速记忆口诀</h2>
<ul>
<li><strong>单个组件</strong>：居中 Center，边距 Padding，样式 Container</li>
<li><strong>横向排列</strong>：Row + Expanded</li>
<li><strong>纵向排列</strong>：Column + Expanded</li>
<li><strong>层叠覆盖</strong>：Stack + Positioned</li>
<li><strong>自动换行</strong>：Wrap 最方便</li>
<li><strong>列表滚动</strong>：ListView.builder 性能好</li>
<li><strong>网格展示</strong>：GridView.count 列数定</li>
<li><strong>内容太多</strong>：SingleChildScrollView 包一包</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 Guava ListenableFuture 学习生产级并发调用实践]]></title>    <link>https://juejin.cn/post/7586942589321183268</link>    <guid>https://juejin.cn/post/7586942589321183268</guid>    <pubDate>2025-12-23T11:26:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586942589321183268" data-draft-id="7586940555403952169" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 Guava ListenableFuture 学习生产级并发调用实践"/> <meta itemprop="keywords" content="后端,面试,架构"/> <meta itemprop="datePublished" content="2025-12-23T11:26:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 Guava ListenableFuture 学习生产级并发调用实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T11:26:18.000Z" title="Tue Dec 23 2025 11:26:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>之前从 Elasticsearch 源码学到了线程池配置的设计思想，但 ES 的代码太底层，难以直接迁移到业务系统。今天在 Guava 框架中找到了更实用的方案：相比 <code>CompletableFuture</code> 复杂的链式调用，<code>ListenableFuture</code> 提供了更清晰的并发编排模式。</p>
<hr/>
<h2 data-id="heading-1">一、为什么选择 Guava ListenableFuture</h2>
<h3 data-id="heading-2">CompletableFuture 的痛点</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// allOf 返回 Void，还要手动 join</span>
CompletableFuture.allOf(productFuture, inventoryFuture)
    .thenApply(v -&gt; {
        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> productFuture.join();  <span class="hljs-comment">// 还要再次 join</span>
        <span class="hljs-type">Inventory</span> <span class="hljs-variable">inventory</span> <span class="hljs-operator">=</span> inventoryFuture.join();
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductDetailDTO</span>(product, inventory);
    });
</code></pre>
<h3 data-id="heading-3">Guava 的优势</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 提交任务</span>
ListenableFuture&lt;Product&gt; productFuture = executor.submit(() -&gt; 
    productService.getProduct(id));
ListenableFuture&lt;Inventory&gt; inventoryFuture = executor.submit(() -&gt; 
    inventoryService.getInventory(id));

<span class="hljs-comment">// 等待全部成功后组装</span>
<span class="hljs-keyword">return</span> Futures.whenAllSucceed(productFuture, inventoryFuture)
    .call(() -&gt; {
        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> Futures.getDone(productFuture);
        <span class="hljs-type">Inventory</span> <span class="hljs-variable">inventory</span> <span class="hljs-operator">=</span> Futures.getDone(inventoryFuture);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductDetailDTO</span>(product, inventory);
    }, executor);
</code></pre>
<p>核心优势：</p>
<ul>
<li><strong>职责分离</strong>：提交和处理分开</li>
<li><strong>类型安全</strong>：<code>getDone()</code> 直接返回结果</li>
<li><strong>语义清晰</strong>：<code>whenAllSucceed</code> 明确表达意图</li>
</ul>
<hr/>
<h2 data-id="heading-4">二、业务场景：电商商品详情页</h2>
<p>用户访问商品详情页，需要并行查询商品服务和库存服务：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[GET /product/123] --&gt; B[ProductFacade]
    B --&gt; C[商品服务 80ms]
    B --&gt; D[库存服务 60ms]
    C --&gt; E[组装结果]
    D --&gt; E
    E --&gt; F[返回DTO]
</code></pre>
<ul>
<li>串行耗时：80ms + 60ms = 140ms</li>
<li>并行耗时：max(80ms, 60ms) ≈ 80ms</li>
</ul>
<hr/>
<h2 data-id="heading-5">三、完整代码实现</h2>
<h3 data-id="heading-6">数据模型</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 商品信息</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String id;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String name;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> priceInCents;
    
    Product(String id, String name, <span class="hljs-type">int</span> priceInCents) {
        <span class="hljs-built_in">this</span>.id = id;
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.priceInCents = priceInCents;
    }
    
    String <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> id; }
    String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> name; }
    <span class="hljs-type">int</span> <span class="hljs-title function_">getPriceInCents</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> priceInCents; }
}

<span class="hljs-comment">// 库存信息</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Inventory</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String productId;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> quantity;
    
    Inventory(String productId, <span class="hljs-type">int</span> quantity) {
        <span class="hljs-built_in">this</span>.productId = productId;
        <span class="hljs-built_in">this</span>.quantity = quantity;
    }
    
    String <span class="hljs-title function_">getProductId</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> productId; }
    <span class="hljs-type">int</span> <span class="hljs-title function_">getQuantity</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> quantity; }
}

<span class="hljs-comment">// 返回的 DTO</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductDetailDTO</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String productId;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String name;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> priceInCents;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> quantity;
    
    ProductDetailDTO(String productId, String name, <span class="hljs-type">int</span> priceInCents, <span class="hljs-type">int</span> quantity) {
        <span class="hljs-built_in">this</span>.productId = productId;
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.priceInCents = priceInCents;
        <span class="hljs-built_in">this</span>.quantity = quantity;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"ProductDetailDTO{"</span> +
                <span class="hljs-string">"productId='"</span> + productId + <span class="hljs-string">'\''</span> +
                <span class="hljs-string">", name='"</span> + name + <span class="hljs-string">'\''</span> +
                <span class="hljs-string">", priceInCents="</span> + priceInCents +
                <span class="hljs-string">", quantity="</span> + quantity +
                <span class="hljs-string">'}'</span>;
    }
}
</code></pre>
<h3 data-id="heading-7">模拟服务</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {
    Product <span class="hljs-title function_">getProduct</span><span class="hljs-params">(String productId)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        TimeUnit.MILLISECONDS.sleep(<span class="hljs-number">80</span>);  <span class="hljs-comment">// 模拟网络调用</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(productId, <span class="hljs-string">"MacBook Pro 14"</span>, <span class="hljs-number">149900</span>);
    }
}

<span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InventoryService</span> {
    Inventory <span class="hljs-title function_">getInventory</span><span class="hljs-params">(String productId)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        TimeUnit.MILLISECONDS.sleep(<span class="hljs-number">60</span>);  <span class="hljs-comment">// 模拟网络调用</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Inventory</span>(productId, <span class="hljs-number">42</span>);
    }
}
</code></pre>
<h3 data-id="heading-8">核心门面类</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductFacade</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ProductService productService;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> InventoryService inventoryService;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ListeningExecutorService executor;
    
    ProductFacade(ProductService productService,
                  InventoryService inventoryService,
                  ListeningExecutorService executor) {
        <span class="hljs-built_in">this</span>.productService = productService;
        <span class="hljs-built_in">this</span>.inventoryService = inventoryService;
        <span class="hljs-built_in">this</span>.executor = executor;
    }
    
    <span class="hljs-comment">/**
     * 并行获取商品信息和库存信息，然后组装成 ProductDetailDTO
     */</span>
    ListenableFuture&lt;ProductDetailDTO&gt; <span class="hljs-title function_">getProductDetail</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String productId)</span> {
        <span class="hljs-comment">// 步骤1：Fan-Out 并行查询</span>
        ListenableFuture&lt;Product&gt; productFuture = executor.submit(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Callable</span>&lt;Product&gt;() {
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
                    <span class="hljs-keyword">return</span> productService.getProduct(productId);
                }
            }
        );
        
        ListenableFuture&lt;Inventory&gt; inventoryFuture = executor.submit(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Callable</span>&lt;Inventory&gt;() {
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> Inventory <span class="hljs-title function_">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
                    <span class="hljs-keyword">return</span> inventoryService.getInventory(productId);
                }
            }
        );
        
        <span class="hljs-comment">// 步骤2：Fan-In 汇总结果</span>
        <span class="hljs-comment">// whenAllSucceed：只有两个 Future 都成功，才执行 call 里的逻辑</span>
        <span class="hljs-keyword">return</span> Futures.whenAllSucceed(productFuture, inventoryFuture)
            .call(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Callable</span>&lt;ProductDetailDTO&gt;() {
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> ProductDetailDTO <span class="hljs-title function_">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
                    <span class="hljs-comment">// getDone：安全获取已完成的 Future 结果</span>
                    <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> Futures.getDone(productFuture);
                    <span class="hljs-type">Inventory</span> <span class="hljs-variable">inventory</span> <span class="hljs-operator">=</span> Futures.getDone(inventoryFuture);
                    
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductDetailDTO</span>(
                        product.getId(),
                        product.getName(),
                        product.getPriceInCents(),
                        inventory.getQuantity()
                    );
                }
            }, executor);
    }
}
</code></pre>
<p>关键点：</p>
<ol>
<li><strong><code>executor.submit(Callable)</code></strong>：提交任务到线程池异步执行，立即返回 <code>ListenableFuture</code></li>
<li><strong><code>Futures.whenAllSucceed(f1, f2)</code></strong>：等待所有 Future 都成功完成，任何一个失败整体就失败</li>
<li><strong><code>Futures.getDone(future)</code></strong>：安全获取已完成的结果，因为 <code>whenAllSucceed</code> 保证了成功</li>
</ol>
<h3 data-id="heading-9">程序入口</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-comment">// 创建线程池</span>
    <span class="hljs-type">ListeningExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> MoreExecutors.listeningDecorator(
        Executors.newFixedThreadPool(<span class="hljs-number">4</span>)
    );
    
    <span class="hljs-comment">// 初始化服务</span>
    <span class="hljs-type">ProductService</span> <span class="hljs-variable">productService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductService</span>();
    <span class="hljs-type">InventoryService</span> <span class="hljs-variable">inventoryService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InventoryService</span>();
    <span class="hljs-type">ProductFacade</span> <span class="hljs-variable">facade</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductFacade</span>(
        productService, inventoryService, executor
    );
    
    <span class="hljs-type">String</span> <span class="hljs-variable">productId</span> <span class="hljs-operator">=</span> <span class="hljs-string">"P123"</span>;
    <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.nanoTime();
    
    <span class="hljs-comment">// 发起并行查询</span>
    ListenableFuture&lt;ProductDetailDTO&gt; future = facade.getProductDetail(productId);
    
    <span class="hljs-comment">// 阻塞等待结果（Demo 演示用，实际 Web 场景可以用回调异步处理）</span>
    <span class="hljs-type">ProductDetailDTO</span> <span class="hljs-variable">dto</span> <span class="hljs-operator">=</span> future.get();
    
    <span class="hljs-type">long</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> System.nanoTime();
    <span class="hljs-type">long</span> <span class="hljs-variable">costMillis</span> <span class="hljs-operator">=</span> (end - start) / <span class="hljs-number">1_000_000L</span>;
    
    System.out.println(<span class="hljs-string">"Result = "</span> + dto);
    System.out.println(<span class="hljs-string">"Cost   = "</span> + costMillis + <span class="hljs-string">" ms"</span>);
    
    executor.shutdown();
}
</code></pre>
<p>执行结果：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">Result</span> = ProductDetailDTO{productId=<span class="hljs-string">'P123'</span>, name=<span class="hljs-string">'MacBook Pro 14'</span>, priceInCents=<span class="hljs-number">149900</span>, quantity=<span class="hljs-number">42</span>}
<span class="hljs-attr">Cost</span>   = <span class="hljs-number">85</span> ms
</code></pre>
<hr/>
<h2 data-id="heading-10">四、执行流程</h2>
<h3 data-id="heading-11">时序图</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant C as Controller
    participant F as ProductFacade
    participant E as 线程池
    participant PS as ProductService
    participant IS as InventoryService
    
    C-&gt;&gt;F: getProductDetail(&amp;#34;P123&amp;#34;)
    F-&gt;&gt;E: submit(查商品)
    F-&gt;&gt;E: submit(查库存)
    
    par 并行执行
        E-&gt;&gt;PS: getProduct(&amp;#34;P123&amp;#34;)
        PS--&gt;&gt;E: Product(80ms)
    and
        E-&gt;&gt;IS: getInventory(&amp;#34;P123&amp;#34;)
        IS--&gt;&gt;E: Inventory(60ms)
    end
    
    E-&gt;&gt;F: 两个结果都完成
    F-&gt;&gt;F: 组装 ProductDetailDTO
    F--&gt;&gt;C: 返回结果(~85ms)
</code></pre>
<h3 data-id="heading-12">Fan-Out / Fan-In 模式</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[请求] --&gt; B[Fan-Out]
    B --&gt; C[任务1]
    B --&gt; D[任务2]
    C --&gt; E[Fan-In]
    D --&gt; E
    E --&gt; F[结果]
    
    style B fill:#e1f5ff
    style E fill:#fff4e1
</code></pre>
<p>这是并发编程的经典模式：</p>
<ul>
<li><strong>Fan-Out</strong>：将一个任务拆分成多个并行子任务</li>
<li><strong>Fan-In</strong>：等待所有子任务完成后汇总结果</li>
</ul>
<hr/>
<h2 data-id="heading-13">五、与 Elasticsearch 的对比</h2>
<h3 data-id="heading-14">ES 的场景：多索引并行查询</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[搜索请求] --&gt; B[logs-2024-01]
    A --&gt; C[logs-2024-02]
    A --&gt; D[logs-2024-03]
    B --&gt; E[合并排序]
    C --&gt; E
    D --&gt; E
    E --&gt; F[Top 10]
</code></pre>
<h3 data-id="heading-15">电商场景：多服务并行查询</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[详情请求] --&gt; B[商品服务]
    A --&gt; C[库存服务]
    B --&gt; D[简单组装]
    C --&gt; D
    D --&gt; E[返回DTO]
</code></pre>
<h3 data-id="heading-16">共同点</h3>






























<table><thead><tr><th>维度</th><th>Elasticsearch</th><th>电商商品详情</th></tr></thead><tbody><tr><td>模式</td><td>Fan-Out / Fan-In</td><td>Fan-Out / Fan-In</td></tr><tr><td>并行目标</td><td>多个索引/分片</td><td>多个微服务</td></tr><tr><td>汇总方式</td><td>合并排序</td><td>简单组装</td></tr><tr><td>核心诉求</td><td>正确性 + 性能</td><td>响应时间</td></tr></tbody></table>
<p>虽然场景不同，但底层思想一致：</p>
<ol>
<li><strong>分解</strong>：把大任务拆成多个独立小任务</li>
<li><strong>并行</strong>：利用线程池同时执行</li>
<li><strong>汇总</strong>：等待全部完成后组装结果</li>
</ol>
<hr/>
<h2 data-id="heading-17">六、更多应用场景</h2>
<h3 data-id="heading-18">订单详情页</h3>
<pre><code class="hljs language-java" lang="java">ListenableFuture&lt;Order&gt; orderFuture = getOrder(orderId);
ListenableFuture&lt;User&gt; userFuture = getUser(userId);
ListenableFuture&lt;List&lt;OrderItem&gt;&gt; itemsFuture = getOrderItems(orderId);
ListenableFuture&lt;Logistics&gt; logisticsFuture = getLogistics(orderId);

<span class="hljs-keyword">return</span> Futures.whenAllSucceed(orderFuture, userFuture, itemsFuture, logisticsFuture)
    .call(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderDetailDTO</span>(...), executor);
</code></pre>
<h3 data-id="heading-19">用户个人中心</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 并行查询：用户信息、订单统计、优惠券、积分</span>
ListenableFuture&lt;UserInfo&gt; userFuture = getUserInfo(userId);
ListenableFuture&lt;OrderStats&gt; statsFuture = getOrderStats(userId);
ListenableFuture&lt;List&lt;Coupon&gt;&gt; couponFuture = getCoupons(userId);
ListenableFuture&lt;Points&gt; pointsFuture = getPoints(userId);

<span class="hljs-keyword">return</span> Futures.whenAllSucceed(userFuture, statsFuture, couponFuture, pointsFuture)
    .call(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserCenterVO</span>(...), executor);
</code></pre>
<h3 data-id="heading-20">数据报表</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 并行查询：销售数据、用户数据、库存数据</span>
ListenableFuture&lt;SalesData&gt; salesFuture = getSalesData(startDate, endDate);
ListenableFuture&lt;UserData&gt; userDataFuture = getUserData(startDate, endDate);
ListenableFuture&lt;InventoryData&gt; inventoryFuture = getInventoryData();

<span class="hljs-keyword">return</span> Futures.whenAllSucceed(salesFuture, userDataFuture, inventoryFuture)
    .call(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReportVO</span>(...), executor);
</code></pre>
<hr/>
<h2 data-id="heading-21">七、异常处理与降级</h2>
<h3 data-id="heading-22">单个服务降级</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用 Futures.catching 处理异常</span>
ListenableFuture&lt;Product&gt; productWithFallback = Futures.catching(
    productFuture,
    Exception.class,
    ex -&gt; {
        log.error(<span class="hljs-string">"查询商品失败，使用默认值"</span>, ex);
        <span class="hljs-keyword">return</span> getDefaultProduct(productId);
    },
    executor
);
</code></pre>
<h3 data-id="heading-23">超时控制</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用 Futures.withTimeout 添加超时</span>
ListenableFuture&lt;Product&gt; productFuture = Futures.withTimeout(
    executor.submit(() -&gt; productService.getProduct(id)),
    <span class="hljs-number">2</span>, TimeUnit.SECONDS,
    scheduledExecutor  <span class="hljs-comment">// 需要一个 ScheduledExecutorService</span>
);
</code></pre>
<h3 data-id="heading-24">部分失败允许</h3>
<p>如果允许部分查询失败，可以使用 <code>Futures.successfulAsList()</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 即使部分失败，也返回成功的结果（失败的为 null）</span>
ListenableFuture&lt;List&lt;Object&gt;&gt; results = Futures.successfulAsList(
    productFuture, 
    inventoryFuture
);

<span class="hljs-keyword">return</span> Futures.transform(results, list -&gt; {
    <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> (Product) list.get(<span class="hljs-number">0</span>);
    <span class="hljs-type">Inventory</span> <span class="hljs-variable">inventory</span> <span class="hljs-operator">=</span> (Inventory) list.get(<span class="hljs-number">1</span>);
    
    <span class="hljs-comment">// 处理可能为 null 的情况</span>
    <span class="hljs-keyword">if</span> (product == <span class="hljs-literal">null</span>) product = getDefaultProduct();
    <span class="hljs-keyword">if</span> (inventory == <span class="hljs-literal">null</span>) inventory = getDefaultInventory();
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductDetailDTO</span>(...);
}, executor);
</code></pre>
<hr/>
<h2 data-id="heading-25">八、生产环境配置建议</h2>
<h3 data-id="heading-26">线程池配置</h3>
<p>基于 ES 的经验（详见我的上一篇文章），推荐配置：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">int</span> <span class="hljs-variable">processors</span> <span class="hljs-operator">=</span> Runtime.getRuntime().availableProcessors();

<span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">threadPool</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    processors,                          <span class="hljs-comment">// 核心线程数 = CPU 核心数</span>
    processors * <span class="hljs-number">2</span>,                      <span class="hljs-comment">// 最大线程数（IO 密集型）</span>
    <span class="hljs-number">60</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">256</span> * processors * <span class="hljs-number">2</span>),  <span class="hljs-comment">// 有理论依据的队列大小</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadFactoryBuilder</span>()
        .setNameFormat(<span class="hljs-string">"ProductQuery-%d"</span>)  <span class="hljs-comment">// 线程命名</span>
        .build(),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy()  <span class="hljs-comment">// 业务系统用降级策略</span>
);

<span class="hljs-type">ListeningExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> MoreExecutors.listeningDecorator(threadPool);
</code></pre>
<h3 data-id="heading-27">Spring Bean 配置</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExecutorConfig</span> {
    
    <span class="hljs-meta">@Bean("productQueryExecutor")</span>
    <span class="hljs-keyword">public</span> ListeningExecutorService <span class="hljs-title function_">productQueryExecutor</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">processors</span> <span class="hljs-operator">=</span> Runtime.getRuntime().availableProcessors();
        
        <span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">threadPool</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
            processors,
            processors * <span class="hljs-number">2</span>,
            <span class="hljs-number">60</span>, TimeUnit.SECONDS,
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">256</span> * processors * <span class="hljs-number">2</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadFactoryBuilder</span>()
                .setNameFormat(<span class="hljs-string">"ProductQuery-%d"</span>)
                .build(),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy()
        );
        
        <span class="hljs-keyword">return</span> MoreExecutors.listeningDecorator(threadPool);
    }
}
</code></pre>
<h3 data-id="heading-28">监控指标</h3>
<p>关键监控点：</p>
<ul>
<li><strong>活跃线程数</strong>：当前正在执行任务的线程数</li>
<li><strong>队列大小</strong>：等待执行的任务数</li>
<li><strong>拒绝次数</strong>：线程池满了被拒绝的任务数</li>
<li><strong>平均执行时间</strong>：任务的平均耗时</li>
</ul>
<p>告警阈值：</p>
<ul>
<li>队列堆积 &gt; 最大线程数 × 100：可能有慢查询</li>
<li>拒绝次数突增：流量超过处理能力</li>
<li>活跃线程数长期 = 最大线程数：需要扩容</li>
</ul>
<hr/>
<h2 data-id="heading-29">九、何时使用并发</h2>
<h3 data-id="heading-30">适合的场景</h3>
<ol>
<li><strong>多个独立的 IO 操作</strong>：查询多个数据表、调用多个外部 API</li>
<li><strong>操作之间无依赖</strong>：查商品和查评论没有先后顺序</li>
<li><strong>对响应时间敏感</strong>：用户等待的接口</li>
</ol>
<h3 data-id="heading-31">不适合的场景</h3>
<ol>
<li><strong>有依赖关系的操作</strong>：第二步依赖第一步的结果（应该用 <code>transformAsync</code>）</li>
<li><strong>需要事务一致性</strong>：扣库存和创建订单必须在同一事务</li>
<li><strong>纯 CPU 密集计算</strong>：应该用 <code>ParallelStream</code> 或 <code>ForkJoinPool</code></li>
<li><strong>需要消息可靠性保证</strong>：用 MQ（RabbitMQ、RocketMQ）</li>
</ol>
<hr/>
<h2 data-id="heading-32">十、总结</h2>
<h3 data-id="heading-33">核心收获</h3>
<ol>
<li>
<p><strong>Guava ListenableFuture 比 CompletableFuture 更清晰</strong></p>
<ul>
<li><code>whenAllSucceed</code> 语义明确</li>
<li><code>getDone</code> 类型安全</li>
<li>职责分离，代码可读性强</li>
</ul>
</li>
<li>
<p><strong>Fan-Out / Fan-In 是通用模式</strong></p>
<ul>
<li>ES 用于多索引查询</li>
<li>业务系统用于多服务聚合</li>
<li>底层思想一致</li>
</ul>
</li>
<li>
<p><strong>线程池配置有理论依据</strong></p>
<ul>
<li>核心线程数 = CPU 核心数</li>
<li>最大线程数 = CPU 核心数 × 2（IO 密集型）</li>
<li>队列大小 = 256 × 最大线程数</li>
</ul>
</li>
</ol>
<h3 data-id="heading-34">实践建议</h3>
<ol>
<li><strong>从简单场景开始</strong>：先用在商品详情这类典型场景</li>
<li><strong>加强监控</strong>：关注线程池状态和任务执行时间</li>
<li><strong>做好降级</strong>：考虑异常和超时情况</li>
<li><strong>压测验证</strong>：用真实流量验证配置合理性</li>
</ol>
<p>这套模式可以作为你以后所有"多服务并行查询 + 聚合返回"场景的模板：代码清晰、思路简单、足够贴近真实业务。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[例题]]></title>    <link>https://juejin.cn/post/7586687526867681295</link>    <guid>https://juejin.cn/post/7586687526867681295</guid>    <pubDate>2025-12-23T11:48:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586687526867681295" data-draft-id="7586703355645788187" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="例题"/> <meta itemprop="keywords" content="C++"/> <meta itemprop="datePublished" content="2025-12-23T11:48:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ozyzo"/> <meta itemprop="url" content="https://juejin.cn/user/458965109710202"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            例题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/458965109710202/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ozyzo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T11:48:43.000Z" title="Tue Dec 23 2025 11:48:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">（一）</h2>
<h2 data-id="heading-1">代码如下:</h2>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-type">void</span> <span class="hljs-title function_">f</span><span class="hljs-params">(<span class="hljs-type">int</span> m)</span>{
    m += <span class="hljs-number">10</span>;
}
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>{
    <span class="hljs-type">int</span> m = <span class="hljs-number">1</span>;
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"m=%d\n"</span>, m);
    f(m);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"m=%d"</span>, m);
}
</code></pre>
<h2 data-id="heading-2">运行结果如下：</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a1591fcd44f455c81e8558b9ffdbd13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgb3p5em8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767095322&amp;x-signature=XbeZMsa%2FmcH7%2F88TUmJ8Oxz7I2o%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62d886672144485cb910b0cc3466ac1f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgb3p5em8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767095322&amp;x-signature=iEWJUMlXk1wH5%2Bq10RuexzLlaxU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-3">（二）</h2>
<h2 data-id="heading-4">代码如下：</h2>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-type">void</span> <span class="hljs-title function_">f</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span>{
    x += <span class="hljs-number">1</span>;
    y -= <span class="hljs-number">1</span>;
}
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>{
    <span class="hljs-type">int</span> x = <span class="hljs-number">10</span>;
    <span class="hljs-type">int</span> y = <span class="hljs-number">10</span>;
    f(x,y);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"x=%d,y=%d"</span>, x,y);
}
</code></pre>
<h2 data-id="heading-5">运行结果如下：</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35b060b52d9e40a5b4bcee512a9fc3f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgb3p5em8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767095322&amp;x-signature=RN%2BviUNU4NLFzsepDLEzzk37xvg%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82967286693846e3a60b6902af9973e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgb3p5em8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767095322&amp;x-signature=Ei%2BMDPWczrmsgo%2BvHXsklNw553s%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 性能优化完整指南]]></title>    <link>https://juejin.cn/post/7586687526867632143</link>    <guid>https://juejin.cn/post/7586687526867632143</guid>    <pubDate>2025-12-23T11:33:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586687526867632143" data-draft-id="7586687526867615759" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 性能优化完整指南"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2025-12-23T11:33:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="麦客奥德彪"/> <meta itemprop="url" content="https://juejin.cn/user/2365804752418232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 性能优化完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2365804752418232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    麦客奥德彪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T11:33:42.000Z" title="Tue Dec 23 2025 11:33:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、构建优化（Build Optimization）</h2>
<h3 data-id="heading-1">1.1 使用 const 构造函数</h3>
<p><strong>原理</strong>：const Widget 在编译时创建，不会在每次 build 时重建。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// ❌ 错误：每次都创建新对象</span>
Widget <span class="hljs-built_in">build</span>(BuildContext context) {
  return <span class="hljs-built_in">Container</span>(
    padding: EdgeInsets.all(<span class="hljs-number">16</span>),
    child: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'标题'</span>),
  );
}

<span class="hljs-comment">// ✅ 正确：使用 const</span>
Widget <span class="hljs-built_in">build</span>(BuildContext context) {
  return <span class="hljs-built_in">Container</span>(
    padding: const EdgeInsets.all(<span class="hljs-number">16</span>),
    child: const <span class="hljs-built_in">Text</span>(<span class="hljs-string">'标题'</span>),
  );
}
</code></pre>
<p><strong>优化建议</strong>：</p>
<ul>
<li>静态文本、图标、样式等都用 const</li>
<li>善用 IDE 提示，它会提示哪里可以加 const</li>
<li>对于不变的 Widget 树，整个都标记为 const</li>
</ul>
<h3 data-id="heading-2">1.2 避免在 build 方法中创建对象</h3>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// ❌ 错误：每次 build 都创建新样式</span>
Widget <span class="hljs-title function_ invoke__">build</span>(BuildContext context) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Text</span>(
    <span class="hljs-string">'内容'</span>,
    <span class="hljs-attr">style</span>: <span class="hljs-title function_ invoke__">TextStyle</span>(<span class="hljs-attr">fontSize</span>: <span class="hljs-number">16</span>, <span class="hljs-attr">color</span>: Colors.blue),  // 每次重建
  );
}

<span class="hljs-comment">// ✅ 正确：提取为常量</span>
<span class="hljs-built_in">static</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">_textStyle</span> = <span class="hljs-title function_ invoke__">TextStyle</span>(<span class="hljs-attr">fontSize</span>: <span class="hljs-number">16</span>, <span class="hljs-attr">color</span>: Colors.blue);

Widget <span class="hljs-title function_ invoke__">build</span>(BuildContext context) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Text</span>(<span class="hljs-string">'内容'</span>, <span class="hljs-attr">style</span>: _textStyle);
}
</code></pre>
<h3 data-id="heading-3">1.3 拆分 Widget，缩小重建范围</h3>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// ❌ 错误：整个页面重建</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-type">State</span>&lt;<span class="hljs-type">MyPage</span>&gt; createState() =&gt; _MyPageState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_MyPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State&lt;MyPage&gt;</span> </span>{
  int _counter = <span class="hljs-number">0</span>;

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">return</span> <span class="hljs-type">Column</span>(
      children: [
        <span class="hljs-type">Header</span>(),  <span class="hljs-comment">// 不需要重建，但会重建</span>
        <span class="hljs-type">Text</span>('计数: $_counter'),  <span class="hljs-comment">// 需要重建</span>
        <span class="hljs-type">Footer</span>(),  <span class="hljs-comment">// 不需要重建，但会重建</span>
      ],
    );
  }
}

<span class="hljs-comment">// ✅ 正确：拆分可变部分</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">return</span> <span class="hljs-type">Column</span>(
      children: [
        const <span class="hljs-type">Header</span>(),  <span class="hljs-comment">// const，不会重建</span>
        <span class="hljs-type">CounterWidget</span>(),  <span class="hljs-comment">// 只有这部分重建</span>
        const <span class="hljs-type">Footer</span>(),  <span class="hljs-comment">// const，不会重建</span>
      ],
    );
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CounterWidget</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-type">State</span>&lt;<span class="hljs-type">CounterWidget</span>&gt; createState() =&gt; _CounterWidgetState();
}
</code></pre>
<h3 data-id="heading-4">1.4 使用 Builder 延迟构建</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ❌ 错误：一次性构建大量 Widget</span>
<span class="hljs-selector-tag">Column</span>(
  <span class="hljs-attribute">children</span>: List.<span class="hljs-built_in">generate</span>(<span class="hljs-number">1000</span>, (index) =&gt; <span class="hljs-built_in">ListTile</span>(<span class="hljs-attribute">title</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'$index'</span>))),
)

<span class="hljs-comment">// ✅ 正确：按需构建</span>
<span class="hljs-selector-tag">ListView</span><span class="hljs-selector-class">.builder</span>(
  <span class="hljs-attribute">itemCount</span>: <span class="hljs-number">1000</span>,
  <span class="hljs-attribute">itemBuilder</span>: (context, index) =&gt; <span class="hljs-built_in">ListTile</span>(<span class="hljs-attribute">title</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'$index'</span>)),
)
</code></pre>
<h2 data-id="heading-5">二、渲染优化（Rendering Optimization）</h2>
<h3 data-id="heading-6">2.1 使用 RepaintBoundary 隔离重绘</h3>
<p><strong>原理</strong>：创建独立的绘制层，避免不必要的重绘传播。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 隔离频繁变化的动画区域</span>
<span class="hljs-selector-tag">Column</span>(
  <span class="hljs-attribute">children</span>: [
    const <span class="hljs-built_in">Text</span>(<span class="hljs-string">'静态标题'</span>),
    <span class="hljs-built_in">RepaintBoundary</span>(
      <span class="hljs-attribute">child</span>: <span class="hljs-built_in">AnimatedWidget</span>(),  <span class="hljs-comment">// 动画只重绘这部分</span>
    ),
    const <span class="hljs-built_in">Text</span>(<span class="hljs-string">'静态底部'</span>),
  ],
)
</code></pre>
<p><strong>适用场景</strong>：</p>
<ul>
<li>复杂动画</li>
<li>频繁更新的区域（如时钟、进度条）</li>
<li>列表项中的复杂 Widget</li>
</ul>
<h3 data-id="heading-7">2.2 避免使用 Opacity 做淡入淡出</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ❌ 错误：Opacity 会导致昂贵的离屏渲染</span>
<span class="hljs-selector-tag">Opacity</span>(
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.5</span>,
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">ComplexWidget</span>(),
)

<span class="hljs-comment">// ✅ 正确：使用 AnimatedOpacity</span>
<span class="hljs-selector-tag">AnimatedOpacity</span>(
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.5</span>,
  <span class="hljs-attribute">duration</span>: <span class="hljs-built_in">Duration</span>(<span class="hljs-attribute">milliseconds</span>: <span class="hljs-number">300</span>),
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">ComplexWidget</span>(),
)

<span class="hljs-comment">// ✅ 或者直接用颜色透明度</span>
<span class="hljs-selector-tag">Container</span>(
  <span class="hljs-attribute">color</span>: Colors.blue.<span class="hljs-built_in">withOpacity</span>(<span class="hljs-number">0.5</span>),
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">ComplexWidget</span>(),
)
</code></pre>
<h3 data-id="heading-8">2.3 避免使用 ClipPath/ClipRRect 的昂贵裁剪</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ❌ 较慢：复杂路径裁剪</span>
<span class="hljs-selector-tag">ClipPath</span>(
  <span class="hljs-attribute">clipper</span>: <span class="hljs-built_in">CustomClipper</span>(),
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">ComplexWidget</span>(),
)

<span class="hljs-comment">// ✅ 较快：使用 DecoratedBox + borderRadius</span>
<span class="hljs-selector-tag">Container</span>(
  <span class="hljs-attribute">decoration</span>: <span class="hljs-built_in">BoxDecoration</span>(
    <span class="hljs-attribute">borderRadius</span>: BorderRadius.<span class="hljs-built_in">circular</span>(<span class="hljs-number">12</span>),
  ),
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">ComplexWidget</span>(),
)
</code></pre>
<h3 data-id="heading-9">2.4 减少 saveLayer 调用</h3>
<p><strong>会触发 saveLayer 的操作</strong>（都很昂贵）：</p>
<ul>
<li>Opacity（部分情况）</li>
<li>ColorFilter</li>
<li>ShaderMask</li>
<li>BackdropFilter</li>
<li>带透明度的 ClipRRect</li>
</ul>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ❌ 避免这种写法</span>
<span class="hljs-selector-tag">Opacity</span>(
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.5</span>,
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Container</span>(
    <span class="hljs-attribute">decoration</span>: <span class="hljs-built_in">BoxDecoration</span>(
      <span class="hljs-attribute">color</span>: Colors.blue,
      <span class="hljs-attribute">boxShadow</span>: [<span class="hljs-built_in">BoxShadow</span>(...)],
    ),
  ),
)

<span class="hljs-comment">// ✅ 改为直接设置颜色透明度</span>
<span class="hljs-selector-tag">Container</span>(
  <span class="hljs-attribute">decoration</span>: <span class="hljs-built_in">BoxDecoration</span>(
    <span class="hljs-attribute">color</span>: Colors.blue.<span class="hljs-built_in">withOpacity</span>(<span class="hljs-number">0.5</span>),
    <span class="hljs-attribute">boxShadow</span>: [<span class="hljs-built_in">BoxShadow</span>(...)],
  ),
)
</code></pre>
<h2 data-id="heading-10">三、列表优化（List Optimization）</h2>
<h3 data-id="heading-11">3.1 使用 ListView.builder 而非 ListView</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ❌ 错误：一次性创建所有 Widget</span>
<span class="hljs-selector-tag">ListView</span>(
  <span class="hljs-attribute">children</span>: List.<span class="hljs-built_in">generate</span>(<span class="hljs-number">10000</span>, (i) =&gt; <span class="hljs-built_in">ListTile</span>(<span class="hljs-attribute">title</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'$i'</span>))),
)

<span class="hljs-comment">// ✅ 正确：按需加载</span>
<span class="hljs-selector-tag">ListView</span><span class="hljs-selector-class">.builder</span>(
  <span class="hljs-attribute">itemCount</span>: <span class="hljs-number">10000</span>,
  <span class="hljs-attribute">itemBuilder</span>: (context, index) =&gt; <span class="hljs-built_in">ListTile</span>(<span class="hljs-attribute">title</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'$index'</span>)),
)
</code></pre>
<h3 data-id="heading-12">3.2 添加 itemExtent 或 prototypeItem</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 指定固定高度，提升滚动性能</span>
<span class="hljs-selector-tag">ListView</span><span class="hljs-selector-class">.builder</span>(
  <span class="hljs-attribute">itemCount</span>: <span class="hljs-number">1000</span>,
  <span class="hljs-attribute">itemExtent</span>: <span class="hljs-number">56.0</span>,  <span class="hljs-comment">// 每项固定高度</span>
  <span class="hljs-attribute">itemBuilder</span>: (context, index) =&gt; <span class="hljs-built_in">ListTile</span>(<span class="hljs-attribute">title</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'$index'</span>)),
)

<span class="hljs-comment">// ✅ 或使用 prototypeItem</span>
<span class="hljs-selector-tag">ListView</span><span class="hljs-selector-class">.builder</span>(
  <span class="hljs-attribute">itemCount</span>: <span class="hljs-number">1000</span>,
  <span class="hljs-attribute">prototypeItem</span>: const <span class="hljs-built_in">ListTile</span>(<span class="hljs-attribute">title</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'原型'</span>)),
  <span class="hljs-attribute">itemBuilder</span>: (context, index) =&gt; <span class="hljs-built_in">ListTile</span>(<span class="hljs-attribute">title</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'$index'</span>)),
)
</code></pre>
<h3 data-id="heading-13">3.3 使用 AutomaticKeepAlive 保持状态</h3>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyListItem</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-type">State</span>&lt;<span class="hljs-type">MyListItem</span>&gt; createState() =&gt; _MyListItemState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_MyListItemState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State&lt;MyListItem&gt;</span></span>
    <span class="hljs-keyword">with</span> <span class="hljs-type">AutomaticKeepAliveClientMixin</span> {
  <span class="hljs-meta">@override</span>
  bool get wantKeepAlive =&gt; <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 保持状态不被销毁</span>

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">super</span>.build(context);  <span class="hljs-comment">// 必须调用</span>
    <span class="hljs-keyword">return</span> <span class="hljs-type">ExpansiveWidget</span>();  <span class="hljs-comment">// 展开收起的复杂组件</span>
  }
}
</code></pre>
<h3 data-id="heading-14">3.4 缓存复杂计算结果</h3>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyListItem</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> data;
  
  const <span class="hljs-type">MyListItem</span>(<span class="hljs-keyword">this</span>.data);

  <span class="hljs-comment">// ❌ 错误：每次 build 都计算</span>
  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">final</span> processed = expensiveProcessing(data);
    <span class="hljs-keyword">return</span> <span class="hljs-type">Text</span>(processed);
  }
}

<span class="hljs-comment">// ✅ 正确：使用 Memo 或在外部处理</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyListItem</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> data;
  <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> processed;  <span class="hljs-comment">// 预处理好的数据</span>
  
  const <span class="hljs-type">MyListItem</span>(<span class="hljs-keyword">this</span>.data, <span class="hljs-keyword">this</span>.processed);

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">return</span> <span class="hljs-type">Text</span>(processed);
  }
}
</code></pre>
<h2 data-id="heading-15">四、图片优化（Image Optimization）</h2>
<h3 data-id="heading-16">4.1 使用合适的图片格式和尺寸</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ❌ 错误：加载原图（10MB，4000x3000）</span>
<span class="hljs-selector-tag">Image</span><span class="hljs-selector-class">.network</span>(<span class="hljs-string">'https://example.com/huge-image.jpg'</span>)

<span class="hljs-comment">// ✅ 正确：使用缩略图或指定尺寸</span>
<span class="hljs-selector-tag">Image</span><span class="hljs-selector-class">.network</span>(
  <span class="hljs-string">'https://example.com/thumbnail.jpg'</span>,
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100</span>,
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100</span>,
  <span class="hljs-attribute">cacheWidth</span>: <span class="hljs-number">100</span>,  <span class="hljs-comment">// 解码时缩放，节省内存</span>
  <span class="hljs-attribute">cacheHeight</span>: <span class="hljs-number">100</span>,
)
</code></pre>
<h3 data-id="heading-17">4.2 使用 cached_network_image 缓存网络图片</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">import</span> '<span class="hljs-selector-tag">package</span>:<span class="hljs-selector-tag">cached_network_image</span>/<span class="hljs-selector-tag">cached_network_image</span><span class="hljs-selector-class">.dart</span>';

<span class="hljs-comment">// ✅ 自动缓存，避免重复下载</span>
<span class="hljs-selector-tag">CachedNetworkImage</span>(
  <span class="hljs-attribute">imageUrl</span>: <span class="hljs-string">'https://example.com/image.jpg'</span>,
  <span class="hljs-attribute">placeholder</span>: (context, url) =&gt; <span class="hljs-built_in">CircularProgressIndicator</span>(),
  <span class="hljs-attribute">errorWidget</span>: (context, url, error) =&gt; <span class="hljs-built_in">Icon</span>(Icons.error),
  <span class="hljs-attribute">memCacheWidth</span>: <span class="hljs-number">200</span>,  <span class="hljs-comment">// 内存缓存优化</span>
  <span class="hljs-attribute">maxWidthDiskCache</span>: <span class="hljs-number">400</span>,  <span class="hljs-comment">// 磁盘缓存优化</span>
)
</code></pre>
<h3 data-id="heading-18">4.3 预加载图片</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@override</span>
void didChangeDependencies() {
  super<span class="hljs-selector-class">.didChangeDependencies</span>();
  <span class="hljs-comment">// 预加载下一页可能用到的图片</span>
  <span class="hljs-built_in">precacheImage</span>(AssetImage('assets/next_page.png'), context);
  <span class="hljs-built_in">precacheImage</span>(NetworkImage('https://example.com/image.jpg'), context);
}
</code></pre>
<h3 data-id="heading-19">4.4 使用 ResizeImage 缩小图片</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 解码时就缩放，节省内存</span>
<span class="hljs-selector-tag">Image</span>(
  <span class="hljs-attribute">image</span>: <span class="hljs-built_in">ResizeImage</span>(
    <span class="hljs-built_in">NetworkImage</span>(<span class="hljs-string">'https://example.com/image.jpg'</span>),
    <span class="hljs-attribute">width</span>: <span class="hljs-number">300</span>,
    <span class="hljs-attribute">height</span>: <span class="hljs-number">300</span>,
  ),
)
</code></pre>
<h2 data-id="heading-20">五、状态管理优化</h2>
<h3 data-id="heading-21">5.1 选择合适的状态管理方案</h3>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// ❌ 简单应用过度设计</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">return</span> <span class="hljs-type">Provider</span>&lt;<span class="hljs-type">ComplexStore</span>&gt;(
      create: (_) =&gt; <span class="hljs-type">ComplexStore</span>(),
      child: <span class="hljs-type">MaterialApp</span>(...),
    );
  }
}

<span class="hljs-comment">// ✅ 简单情况用 StatefulWidget 或 ValueNotifier</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CounterWidget</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-type">State</span>&lt;<span class="hljs-type">CounterWidget</span>&gt; createState() =&gt; _CounterWidgetState();
}

<span class="hljs-comment">// ✅ 复杂情况用 Provider/Riverpod/Bloc</span>
</code></pre>
<h3 data-id="heading-22">5.2 使用 ValueListenableBuilder 局部刷新</h3>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyWidget</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-type">State</span>&lt;<span class="hljs-type">MyWidget</span>&gt; createState() =&gt; _MyWidgetState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_MyWidgetState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State&lt;MyWidget&gt;</span> </span>{
  <span class="hljs-keyword">final</span> _counter = <span class="hljs-type">ValueNotifier</span>&lt;int&gt;(<span class="hljs-number">0</span>);

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">return</span> <span class="hljs-type">Column</span>(
      children: [
        const <span class="hljs-type">Text</span>('静态标题'),  <span class="hljs-comment">// 不会重建</span>
        <span class="hljs-type">ValueListenableBuilder</span>&lt;int&gt;(
          valueListenable: _counter,
          builder: (context, value, child) {
            <span class="hljs-keyword">return</span> <span class="hljs-type">Text</span>('计数: $value');  <span class="hljs-comment">// 只有这里重建</span>
          },
        ),
        <span class="hljs-type">ElevatedButton</span>(
          onPressed: () =&gt; _counter.value++,
          child: const <span class="hljs-type">Text</span>('增加'),
        ),
      ],
    );
  }

  <span class="hljs-meta">@override</span>
  void dispose() {
    _counter.dispose();
    <span class="hljs-keyword">super</span>.dispose();
  }
}
</code></pre>
<h3 data-id="heading-23">5.3 使用 Selector 精确监听</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 使用 Provider + Selector</span>
Consumer&lt;MyModel&gt;(
  builder: (context, model, child) {
    <span class="hljs-keyword">return</span> Text(<span class="hljs-string">'<span class="hljs-subst">${model.counter}</span>'</span>);  <span class="hljs-comment">// model 任何变化都会重建</span>
  },
)

<span class="hljs-comment">// ✅ 改为 Selector，只监听特定字段</span>
Selector&lt;MyModel, <span class="hljs-built_in">int</span>&gt;(
  selector: (context, model) =&gt; model.counter,  <span class="hljs-comment">// 只监听 counter</span>
  builder: (context, counter, child) {
    <span class="hljs-keyword">return</span> Text(<span class="hljs-string">'<span class="hljs-subst">$counter</span>'</span>);  <span class="hljs-comment">// 只有 counter 变化才重建</span>
  },
)
</code></pre>
<h2 data-id="heading-24">六、异步与网络优化</h2>
<h3 data-id="heading-25">6.1 使用 FutureBuilder/StreamBuilder 避免手动管理状态</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// ✅ 自动处理加载、成功、失败状态</span>
FutureBuilder&lt;List&lt;Item&gt;&gt;(
  future: fetchItems(),
  builder: (context, snapshot) {
    if (snapshot.hasData) {
      return <span class="hljs-built_in">ListView</span>(children: snapshot.data!.map(...)<span class="hljs-selector-class">.toList</span>());
    } else if (snapshot.hasError) {
      return Text('错误: ${snapshot.error}');
    }
    return <span class="hljs-built_in">CircularProgressIndicator</span>();
  },
)
</code></pre>
<h3 data-id="heading-26">6.2 使用 compute 执行耗时计算</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// ❌ 错误：在主线程执行耗时操作</span>
List&lt;Item&gt; <span class="hljs-built_in">parseData</span>(String json) {
  return <span class="hljs-built_in">expensiveParsing</span>(json);  <span class="hljs-comment">// 阻塞 UI</span>
}

<span class="hljs-comment">// ✅ 正确：在后台线程执行</span>
Future&lt;List&lt;Item&gt;&gt; <span class="hljs-built_in">parseData</span>(String json) async {
  return <span class="hljs-built_in">compute</span>(_parseInBackground, json);
}

List&lt;Item&gt; <span class="hljs-built_in">_parseInBackground</span>(String json) {
  return <span class="hljs-built_in">expensiveParsing</span>(json);
}
</code></pre>
<h3 data-id="heading-27">6.3 防抖和节流</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 搜索框防抖</span>
Timer? _debounce;

void <span class="hljs-built_in">onSearchChanged</span>(String query) {
  _debounce?<span class="hljs-selector-class">.cancel</span>();
  _debounce = <span class="hljs-built_in">Timer</span>(const Duration(milliseconds: <span class="hljs-number">500</span>), () {
    <span class="hljs-built_in">performSearch</span>(query);  <span class="hljs-comment">// 500ms 后才执行</span>
  });
}

<span class="hljs-keyword">@override</span>
void dispose() {
  _debounce?<span class="hljs-selector-class">.cancel</span>();
  super<span class="hljs-selector-class">.dispose</span>();
}
</code></pre>
<h2 data-id="heading-28">七、内存优化</h2>
<h3 data-id="heading-29">7.1 及时释放资源</h3>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyWidget</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-type">State</span>&lt;<span class="hljs-type">MyWidget</span>&gt; createState() =&gt; _MyWidgetState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_MyWidgetState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State&lt;MyWidget&gt;</span> </span>{
  late <span class="hljs-type">AnimationController</span> _controller;
  late <span class="hljs-type">StreamSubscription</span> _subscription;

  <span class="hljs-meta">@override</span>
  void initState() {
    <span class="hljs-keyword">super</span>.initState();
    _controller = <span class="hljs-type">AnimationController</span>(vsync: <span class="hljs-keyword">this</span>, ...);
    _subscription = stream.listen(...);
  }

  <span class="hljs-meta">@override</span>
  void dispose() {
    _controller.dispose();  <span class="hljs-comment">// ✅ 释放动画控制器</span>
    _subscription.cancel();  <span class="hljs-comment">// ✅ 取消订阅</span>
    <span class="hljs-keyword">super</span>.dispose();
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) =&gt; <span class="hljs-type">Container</span>();
}
</code></pre>
<h3 data-id="heading-30">7.2 避免内存泄漏</h3>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// ❌ 错误：闭包持有 State 引用</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_MyWidgetState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State&lt;MyWidget&gt;</span> </span>{
  void startTimer() {
    <span class="hljs-type">Timer</span>.periodic(<span class="hljs-type">Duration</span>(seconds: <span class="hljs-number">1</span>), (timer) {
      setState(() {});  <span class="hljs-comment">// 即使 Widget 销毁，timer 仍在运行</span>
    });
  }
}

<span class="hljs-comment">// ✅ 正确：保存引用并取消</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_MyWidgetState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State&lt;MyWidget&gt;</span> </span>{
  <span class="hljs-type">Timer</span>? _timer;

  void startTimer() {
    _timer = <span class="hljs-type">Timer</span>.periodic(<span class="hljs-type">Duration</span>(seconds: <span class="hljs-number">1</span>), (timer) {
      <span class="hljs-keyword">if</span> (mounted) {  <span class="hljs-comment">// 检查是否仍然挂载</span>
        setState(() {});
      }
    });
  }

  <span class="hljs-meta">@override</span>
  void dispose() {
    _timer?.cancel();
    <span class="hljs-keyword">super</span>.dispose();
  }
}
</code></pre>
<h3 data-id="heading-31">7.3 使用弱引用或事件总线</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 使用 event_bus 避免直接持有引用</span>
final EventBus eventBus = <span class="hljs-built_in">EventBus</span>();

<span class="hljs-comment">// 订阅</span>
StreamSubscription subscription = eventBus<span class="hljs-selector-class">.on</span>&lt;UserEvent&gt;()<span class="hljs-selector-class">.listen</span>((event) {
  <span class="hljs-comment">// 处理事件</span>
});

<span class="hljs-comment">// 取消订阅</span>
subscription<span class="hljs-selector-class">.cancel</span>();
</code></pre>
<h2 data-id="heading-32">八、启动优化</h2>
<h3 data-id="heading-33">8.1 延迟初始化</h3>
<pre><code class="hljs language-scss" lang="scss">void <span class="hljs-selector-tag">main</span>() async {
  WidgetsFlutterBinding<span class="hljs-selector-class">.ensureInitialized</span>();
  
  <span class="hljs-comment">// ✅ 只初始化必要的服务</span>
  await <span class="hljs-built_in">initCriticalServices</span>();
  
  <span class="hljs-built_in">runApp</span>(MyApp());
  
  <span class="hljs-comment">// ✅ 应用启动后再初始化非关键服务</span>
  <span class="hljs-built_in">initNonCriticalServices</span>();
}
</code></pre>
<h3 data-id="heading-34">8.2 使用占位符快速渲染首屏</h3>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">return</span> <span class="hljs-type">MaterialApp</span>(
      home: <span class="hljs-type">FutureBuilder</span>(
        future: loadInitialData(),
        builder: (context, snapshot) {
          <span class="hljs-keyword">if</span> (snapshot.connectionState == <span class="hljs-type">ConnectionState</span>.done) {
            <span class="hljs-keyword">return</span> <span class="hljs-type">HomePage</span>();
          }
          <span class="hljs-keyword">return</span> <span class="hljs-type">SplashScreen</span>();  <span class="hljs-comment">// ✅ 轻量级占位屏幕</span>
        },
      ),
    );
  }
}
</code></pre>
<h2 data-id="heading-35">九、性能监控与分析</h2>
<h3 data-id="heading-36">9.1 使用 Flutter DevTools</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 运行应用后打开 DevTools</span>
flutter run
<span class="hljs-comment"># 然后在浏览器打开 DevTools 链接</span>
</code></pre>
<p><strong>重点关注</strong>：</p>
<ul>
<li>Performance 页面：查看帧率、重建次数</li>
<li>Memory 页面：监控内存使用</li>
<li>Network 页面：分析网络请求</li>
</ul>
<h3 data-id="heading-37">9.2 使用 Timeline</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-string">'dart:developer'</span>;

<span class="hljs-keyword">void</span> <span class="hljs-title function_">expensiveOperation</span>(<span class="hljs-params"/>) {
  <span class="hljs-title class_">Timeline</span>.<span class="hljs-title function_">startSync</span>(<span class="hljs-string">'expensiveOperation'</span>);
  <span class="hljs-comment">// 执行操作</span>
  <span class="hljs-title class_">Timeline</span>.<span class="hljs-title function_">finishSync</span>();
}
</code></pre>
<h3 data-id="heading-38">9.3 检查过度重建</h3>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyWidget</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    print('<span class="hljs-type">MyWidget</span> build');  <span class="hljs-comment">// 监控重建次数</span>
    <span class="hljs-keyword">return</span> <span class="hljs-type">Container</span>();
  }
}
</code></pre>
<h2 data-id="heading-39">十、编译优化</h2>
<h3 data-id="heading-40">10.1 使用 Profile/Release 模式测试性能</h3>
<pre><code class="hljs language-arduino" lang="arduino"># ❌ Debug 模式性能差，不能作为参考
flutter run

# ✅ Profile 模式：保留调试信息 + 优化性能
flutter run --profile

# ✅ Release 模式：最佳性能
flutter run --release
flutter build apk --release
flutter build ios --release
</code></pre>
<h3 data-id="heading-41">10.2 启用代码混淆</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># Android</span>
flutter build apk --obfuscate <span class="hljs-attr">--split-debug-info</span>=/&lt;project-name&gt;/&lt;directory&gt;

<span class="hljs-comment"># iOS</span>
flutter build ios --obfuscate <span class="hljs-attr">--split-debug-info</span>=/&lt;project-name&gt;/&lt;directory&gt;
</code></pre>
<h3 data-id="heading-42">10.3 分析包体积</h3>
<pre><code class="hljs language-css" lang="css"># 分析包大小
flutter build apk <span class="hljs-attr">--analyze-size</span>
flutter build appbundle <span class="hljs-attr">--analyze-size</span>

# 查看详细信息
flutter build apk <span class="hljs-attr">--target-platform</span> android-arm64 <span class="hljs-attr">--analyze-size</span>
</code></pre>
<h2 data-id="heading-43">性能优化检查清单</h2>
<p><strong>每个页面发布前检查</strong>：</p>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 使用了 const 构造函数</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 避免在 build 中创建对象</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 大列表使用了 .builder</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 图片指定了合适的尺寸</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 没有不必要的重建</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 动画使用了 RepaintBoundary</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 资源在 dispose 中释放</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 在 Profile 模式下测试过性能</li>
</ul>
<p><strong>性能指标参考</strong>：</p>
<ul>
<li>帧率：保持 60fps（或 120fps for 高刷屏）</li>
<li>卡顿：UI 线程不超过 16ms，Raster 线程不超过 16ms</li>
<li>内存：不出现明显泄漏，增长趋势平稳</li>
<li>启动时间：冷启动 &lt; 3秒，热启动 &lt; 1秒</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[京东金融鸿蒙端部署AI超分模型实践]]></title>    <link>https://juejin.cn/post/7586877892467277851</link>    <guid>https://juejin.cn/post/7586877892467277851</guid>    <pubDate>2025-12-23T10:11:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586877892467277851" data-draft-id="7586865729702920230" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="京东金融鸿蒙端部署AI超分模型实践"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-12-23T10:11:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            京东金融鸿蒙端部署AI超分模型实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T10:11:17.000Z" title="Tue Dec 23 2025 10:11:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>1. 背景</strong></h2>
<p><strong>这可能是全网第一篇完整讲解鸿蒙端使用CANN部署AI模型的文章, 满满干货。</strong></p>
<p>社区作为用户交流、信息传递的核心载体，图片内容（如理财产品截图、投资经验分享配图、用户互动评论图片等）的展示质量直接影响用户的信息获取效率与平台信任感。从京东金融App社区的业务需求来看，当前用户上传图片普遍存在多样性失真问题：部分用户通过老旧设备拍摄的图片分辨率较低，部分用户为节省流量选择低画质压缩上传，还有部分截图类内容因原始来源清晰度不足导致信息模糊（如理财产品收益率数字、合同条款细节等），这些问题不仅降低了内容可读性，还可能因信息传递不清晰引发用户误解。</p>
<p>京东金融App团队已完成Real-ESRGAN-General-x4v3超分辨率模型在安卓端的部署，能够针对性提升评论区、内容详情页、个人主页等核心场景的图片清晰度，从视觉体验层面优化用户留存与互动意愿。</p>
<p>ESRGAN-General-x4v3模型在安卓端的部署，采用的是ONNX框架，该方案已有大量公开资料可参考，且取得显著业务成效。但鸿蒙端部署面临核心技术瓶颈：鸿蒙系统不支持ONNX框架，部署端侧AI仅能使用华为自研的CANN（Compute Architecture for Neural Networks）架构，且当前行业内缺乏基于CANN部署端侧AI的公开资料与成熟方案，全程需技术团队自主探索。接下来我会以ESRGAN-General-x4v3为例, 分享从模型转换(NPU亲和性改造)到端侧离线模型部署的全部过程。</p>
<h2 data-id="heading-1"><strong>2. 部署前期准备</strong></h2>
<h3 data-id="heading-2"><strong>2.1 离线模型转换</strong></h3>
<p>CANN Kit当前仅支持Caffe、TensorFlow、ONNX和MindSpore模型转换为离线模型，其他格式的模型需要开发者自行转换为CANN Kit支持的模型格式。模型转换为OM离线模型，移动端AI程序直接读取离线模型进行推理。</p>
<h4 data-id="heading-3"><strong>2.1.1 下载CANN工具</strong></h4>
<p>从鸿蒙开发者官网下载 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcontentcenter-vali-drcn.dbankcdn.cn%2Fpvt_2%2FDeveloperAlliance_package_901_9%2Fc0%2Fv3%2FEvg84kYpQlOkQvRT-Th0tw%2FDDK-tools-next-5.1.1.1.zip%3FHW-CC-KV%3DV1%26HW-CC-Date%3D20251015T082207Z%26HW-CC-Expire%3D315360000%26HW-CC-Sign%3D8D8CE92B39E6A5353B8A43EB6779C1D79C346C40776F2242593CBD751BE87EE4" target="_blank" title="https://contentcenter-vali-drcn.dbankcdn.cn/pvt_2/DeveloperAlliance_package_901_9/c0/v3/Evg84kYpQlOkQvRT-Th0tw/DDK-tools-next-5.1.1.1.zip?HW-CC-KV=V1&amp;HW-CC-Date=20251015T082207Z&amp;HW-CC-Expire=315360000&amp;HW-CC-Sign=8D8CE92B39E6A5353B8A43EB6779C1D79C346C40776F2242593CBD751BE87EE4" ref="nofollow noopener noreferrer">DDK-tools-5.1.1.1 </a>, 解压使用Tools下的OMG工具，将ONNX、TensorFlow模型转换为OM模型。(OMG工具位于Tools下载的tools/tools_omg下，<strong>仅可运行在64位Linux平台上</strong>。)</p>
<p>﻿</p>
<h4 data-id="heading-4"><strong>2.1.2 下载ESRGAN-General-x4v3模型文件</strong></h4>
<p>从<a href="https://link.juejin.cn?target=https%3A%2F%2Faihub.qualcomm.com%2Fcompute%2Fmodels%2Freal_esrgan_general_x4v3" target="_blank" title="https://aihub.qualcomm.com/compute/models/real_esrgan_general_x4v3" ref="nofollow noopener noreferrer">aihub.qualcomm.com/compute/mod…</a>下载模型的onnx文件.</p>
<p>注意: 下载链接中的a8a8的量化模型使用了高通的算子(亲测无法转换), CANN工具无法进行转换, 因此请下载float的量化模型。</p>
<p><strong>下载后有两个文件:</strong></p>
<p>•model.onnx文件 (模型结构): 包含计算图、opset版本、节点配置等，文件较小。</p>
<p>•model.data文件 (权重数据): 包含神经网络参数、权重等，文件较大。</p>
<p>现在我们需要把这种分离文件格式的模型合并成一个文件,后续的操作都使用这个。</p>
<p><strong>合并文件:</strong></p>
<p>请使用JoyCode写个合并脚本即可, 提示词: 请写一个脚本, 把onnx模型文件的.onnx和.data文件合并。</p>
<h4 data-id="heading-5"><strong>2.1.3 OM模型转换</strong></h4>
<p><strong>1. ONNX opset 版本转换</strong></p>
<p>当前使用CANN进行模型转换, 支持ONNX opset版本7~18（最高支持到V1.13.1）, 首先需要查看原始的onnx模型的opset版本是否在支持范围, 这里我们使用<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flutzroeder%2Fnetron%2Ftags" target="_blank" title="https://github.com/lutzroeder/netron/tags" ref="nofollow noopener noreferrer">Netron</a>(点击下载)可视化工具进行查看。</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de53c34107d842da95851d71bc1915d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089477&amp;x-signature=GTZxPGBS3O3%2FeUQCZKdolPJZiyI%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<p>目前该模型使用的opset版本是20, 因此我们需要把该模型的opset版本转成18, 才可以用CANN转换成鸿蒙上可部署的模型。请使用JoyCode写个opset转换脚本即可, 提示词: 请写一个脚本, 把onnx模型文件的opset版本从20转换成18。</p>
<p>﻿</p>
<p><strong>2. OM离线模型</strong>****</p>
<p>命令行中的参数说明请参见<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides%2Fcannkit-overall-parameter" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-overall-parameter" ref="nofollow noopener noreferrer">OMG参数</a>，转换命令：</p>
<pre><code class="hljs language-css" lang="css">./tools/tools_omg/omg <span class="hljs-attr">--model</span> new_model_opset18<span class="hljs-selector-class">.onnx</span> <span class="hljs-attr">--framework</span> <span class="hljs-number">5</span> <span class="hljs-attr">--output</span> ./model
</code></pre>
<p>转换完成后, 生成model.om的模型文件, 该模型文件就是鸿蒙上可以正常使用的模型文件</p>
<h3 data-id="heading-6"><strong>2.2 查看模型的输入/输出张量信息</strong></h3>
<p>部署AI模式时, 我们需要确认模型的输入张量和输出张量信息, 请使用JoyCode编写一个脚本, 确定输入输出张量信息, 提示词: 写一个脚本查看onnx模型的输入输出张量信息。</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e07ceb9dcfc04f71a9cf179cf399ffb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089477&amp;x-signature=OaBgcmN8vLYLQUhTU0GiR1jqx6E%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<h4 data-id="heading-7"><strong>2.2.1 输入张量</strong></h4>
<p>BCHW格式, 是深度学习中常见的张量维度排列格式, 在图像处理场景中:</p>
<p>•B (Batch): 批次大小 - 一次处理多少个样本。</p>
<p>•C (Channel): 通道数 - 图像的颜色通道数。</p>
<p>•H (Height): 高度 - 图像的像素高度。</p>
<p>•W (Width): 宽度 - 图像的像素宽度。</p>
<p>由此可以得出结论, 该模型1个批次处理1张宽高为128*128的RGB图片(因为C是3,因此不包含R通道)。</p>
<p>﻿</p>
<h4 data-id="heading-8"><strong>2.2.2 输出张量</strong></h4>
<p>该模型1个批次输出1张宽高为512*512的RGB图片。</p>
<p>﻿</p>
<h4 data-id="heading-9"><strong>2.2.3 BCHW和BHWC格式的区别:</strong></h4>
<p>超分模型中的BCHW和BHWC是两种不同的张量存储格式，主要区别在于通道维度的位置：</p>
<p>﻿</p>
<p>•<strong>BCHW格式（Batch-Channel-Height-Width）</strong></p>
<p>◦维度顺序：[批次, 通道, 高度, 宽度]</p>
<p>◦内存布局：通道维度在空间维度之前</p>
<p>◦常用框架：PyTorch、TensorRT等</p>
<p>示例: 形状为 (1, 3, 256, 256) 的RGB图像</p>
<p><strong>内存中的存储顺序：</strong> R通道的所有像素 -&gt; G通道的所有像素 -&gt; B通道的所有像素</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">tensor_bchw</span> = torch.randn(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">256</span>, <span class="hljs-number">256</span>)
访问第一个像素的RGB值需要跨越不同的内存区域
<span class="hljs-attr">pixel_0_0_r</span> = tensor_bchw[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]  <span class="hljs-comment"># R通道</span>
<span class="hljs-attr">pixel_0_0_g</span> = tensor_bchw[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]  <span class="hljs-comment"># G通道  </span>
<span class="hljs-attr">pixel_0_0_b</span> = tensor_bchw[<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]  <span class="hljs-comment"># B通道</span>
</code></pre>
<p>•<strong>BHWC格式（Batch-Height-Width-Channel）</strong></p>
<p>◦维度顺序：[批次, 高度, 宽度, 通道]</p>
<p>◦内存布局：通道维度在最后，像素的所有通道连续存储</p>
<p>◦常用框架：TensorFlow、OpenCV等</p>
<p>示例：形状为 (1, 256, 256, 3) 的RGB图像</p>
<p>内存中的存储顺序：像素(0,0)的RGB -&gt; 像素(0,1)的RGB -&gt; ... -&gt; 像素(0,255)的RGB -&gt; 像素(1,0)的RGB...</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">tensor_bhwc</span> = tf.random.normal([<span class="hljs-number">1</span>, <span class="hljs-number">256</span>, <span class="hljs-number">256</span>, <span class="hljs-number">3</span>])
<span class="hljs-comment"># 访问第一个像素的RGB值在连续的内存位置</span>
<span class="hljs-attr">pixel_0_0_rgb</span> = tensor_bhwc[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, :]  <span class="hljs-comment"># [R, G, B]</span>
</code></pre>
<p>﻿</p>
<h2 data-id="heading-10"><strong>3. 鸿蒙端部署核心步骤</strong></h2>
<h3 data-id="heading-11"><strong>3.1 创建项目</strong></h3>
<p>1.创建DevEco Studio项目，选择“Native C++”模板，点击“Next”。</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46f2d4161ef44984881401020f6a30fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089477&amp;x-signature=FO4ZXb3ysjT2qkzUpotPqVcQOaM%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<p>2.按需填写“Project name”、“Save location”和“Module name”，选择“Compile SDK”为“5.1.0(18)”及以上版本，点击“Finish”。</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c8bac1d934c44b7b3daff85617fbb4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089477&amp;x-signature=P6mxqs%2BLOWtEY%2BGaMsH5jxAlfrQ%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<h3 data-id="heading-12"><strong>3.2 配置项目NAPI</strong></h3>
<p>CANN部署只提供了C++接口, 因此需要使用NAPI, 编译HAP时，NAPI层的so需要编译依赖NDK中的libneural_network_core.so和libhiai_foundation.so。</p>
<p>﻿</p>
<p><strong>头文件引用</strong></p>
<p>按需引用NNCore和CANN Kit的头文件。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"neural_network_runtime/neural_network_core.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"CANNKit/hiai_options.h"</span></span>
</code></pre>
<p><strong>编写CMakeLists.txt</strong></p>
<p>CMakeLists.txt示例代码如下。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">cmake_minimum_required</span>(VERSION <span class="hljs-number">3.5</span>.<span class="hljs-number">0</span>)
<span class="hljs-built_in">project</span>(myNpmLib)

<span class="hljs-built_in">set</span>(NATIVERENDER_ROOT_PATH ${CMAKE_CURRENT_SOURCE_DIR})

<span class="hljs-built_in">include_directories</span>(${NATIVERENDER_ROOT_PATH}
                    ${NATIVERENDER_ROOT_PATH}/include)

<span class="hljs-built_in">include_directories</span>(${HMOS_SDK_NATIVE}/sysroot/usr/lib)
<span class="hljs-built_in">FIND_LIBRARY</span>(cann-lib hiai_foundation)

<span class="hljs-built_in">add_library</span>(imagesr SHARED HIAIModelManager.cpp ImageSuperResolution.cpp)
<span class="hljs-built_in">target_link_libraries</span>(imagesr PUBLIC libace_napi.z.so
    libhilog_ndk.z.so
    librawfile.z.so
    ${cann-lib}
    libneural_network_core.so
    )
</code></pre>
<h3 data-id="heading-13"><strong>3.3 集成模型</strong></h3>
<p>模型的加载、编译和推理主要是在native层实现，应用层主要作为数据传递和展示作用。模型推理之前需要对输入数据进行预处理以匹配模型的输入，同样对于模型的输出也需要做处理获取自己期望的结果</p>
<p>﻿</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb2af561a0954b37802f76a57a72b5a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089477&amp;x-signature=llwQdjDQLIDuprCBEFSSf29%2FQU8%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<h4 data-id="heading-14"><strong>3.3.1 加载离线模型</strong></h4>
<p>为了让App运行时能够读取到模型文件和处理推理结果，需要先把离线模型和模型对应的结果标签文件预置到工程的“entry/src/main/resources/rawfile”目录中。</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3e78a1905514c80af05ac4bbd3c9411~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089477&amp;x-signature=UB4r11wWFJskohWLsZSQ3QNlSfs%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<p>在App应用创建时加载模型:</p>
<p>1.native层读取模型的buffer。</p>
<pre><code class="hljs language-ini" lang="ini">const char* <span class="hljs-attr">modelPath</span> = <span class="hljs-string">"imagesr.om"</span><span class="hljs-comment">;</span>
RawFile *<span class="hljs-attr">rawFile</span> = OH_ResourceManager_OpenRawFile(resourceMgr, modelPath)<span class="hljs-comment">;</span>
long <span class="hljs-attr">modelSize</span> = OH_ResourceManager_GetRawFileSize(rawFile)<span class="hljs-comment">;</span>
std::unique_ptr&lt;uint8_t<span class="hljs-section">[]</span>&gt; <span class="hljs-attr">modelData</span> = std::make_unique&lt;uint8_t[]&gt;(modelSize)<span class="hljs-comment">;</span>
int <span class="hljs-attr">res</span> = OH_ResourceManager_ReadRawFile(rawFile, modelData.get(), modelSize)<span class="hljs-comment">;</span>
</code></pre>
<p>2.使用模型的buffer, 调用OH_NNCompilation_ConstructWithOfflineModelBuffer创建模型的编译实例</p>
<pre><code class="hljs language-ini" lang="ini">HiAI_Compatibility <span class="hljs-attr">compibility</span> = HMS_HiAICompatibility_CheckFromBuffer(modelData, modelSize)<span class="hljs-comment">;</span>
OH_NNCompilation *<span class="hljs-attr">compilation</span> = OH_NNCompilation_ConstructWith<span class="hljs-literal">Off</span>lineModelBuffer(modelData, modelSize)<span class="hljs-comment">;</span>
</code></pre>
<p>3.（可选）根据需要调用HMS_HiAIOptions_SetOmOptions接口，打开维测功能（如Profiling）。</p>
<pre><code class="hljs language-ini" lang="ini">const char *<span class="hljs-attr">out_path</span> = <span class="hljs-string">"/data/storage/el2/base/haps/entry/files"</span><span class="hljs-comment">;</span>
HiAI_OmType <span class="hljs-attr">omType</span> = HIAI_OM_TYPE_PROFILING<span class="hljs-comment">;</span>
OH_NN_ReturnCode <span class="hljs-attr">ret</span> = HMS_HiAIOptions_SetOmOptions(compilation, omType, out_path)<span class="hljs-comment">;     </span>
</code></pre>
<p>4.设置模型的deviceID。</p>
<pre><code class="hljs language-ini" lang="ini">size_t <span class="hljs-attr">deviceID</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
const size_t *<span class="hljs-attr">allDevicesID</span> = nullptr<span class="hljs-comment">;</span>
uint32_t <span class="hljs-attr">deviceCount</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
OH_NN_ReturnCode <span class="hljs-attr">ret</span> = OH_NNDevice_GetAllDevicesID(&amp;allDevicesID, &amp;deviceCount)<span class="hljs-comment">;</span>

for (uint32_t <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; deviceCount; i++) {</span>
    const char *<span class="hljs-attr">name</span> = nullptr<span class="hljs-comment">;</span>
    <span class="hljs-attr">ret</span> = OH_NNDevice_GetName(allDevicesID[i], &amp;name)<span class="hljs-comment">;</span>
    if (ret != OH_NN_SUCCESS || <span class="hljs-attr">name</span> == nullptr) {
        OH_LOG_ERROR(LOG_APP, "OH_NNDevice_GetName failed")<span class="hljs-comment">;</span>
        return deviceID<span class="hljs-comment">;</span>
    }
    if (std::string(name) == "HIAI_F") {
        <span class="hljs-attr">deviceID</span> = allDevicesID[i]<span class="hljs-comment">;</span>
        break<span class="hljs-comment">;</span>
    }
}

<span class="hljs-attr">ret</span> = OH_NNCompilation_SetDevice(compilation, deviceID)<span class="hljs-comment">;</span>
</code></pre>
<p>5.调用OH_NNCompilation_Build，执行模型编译。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">ret</span> = SetModelBuildOptions(compilation)<span class="hljs-comment">;</span>
<span class="hljs-attr">ret</span> = OH_NNCompilation_Build(compilation)<span class="hljs-comment">;</span>
</code></pre>
<p>6.调用OH_NNExecutor_Construct，创建模型执行器。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">executor_</span> = OH_NNExecutor_Construct(compilation)<span class="hljs-comment">;</span>
</code></pre>
<p>7.调用OH_NNCompilation_Destroy，释放模型编译实例。</p>
<p>﻿</p>
<h4 data-id="heading-15"><strong>3.3.2 准备输入输出****Tensor</strong></h4>
<p>1.处理模型的输入，模型的输入为1<em>3</em>128*128格式(BCHW) Float类型的数据, 需要把RGB 数据转成BCHW格式并进行归一化。</p>
<pre><code class="hljs language-ini" lang="ini">从图片中读取的RGB数据为BHWC,需要转换成模型可以识别的BCHW
/**
 * 把bhwc转成bchw
 */
uint8_t *<span class="hljs-attr">rgbData</span> = static_cast&lt;uint8_t*&gt;(data)<span class="hljs-comment">;</span>
uint8_t *<span class="hljs-attr">floatData_tmp</span> = new uint8_t[length]<span class="hljs-comment">;</span>
for (int <span class="hljs-attr">c</span> = <span class="hljs-number">0</span><span class="hljs-comment">; c &lt; 3; ++c) {</span>
    for (int <span class="hljs-attr">h</span> = <span class="hljs-number">0</span><span class="hljs-comment">; h &lt; 128; ++h) {</span>
        for (int <span class="hljs-attr">w</span> = <span class="hljs-number">0</span><span class="hljs-comment">; w &lt; 128; ++w) {</span>
            // HWC 索引: h * width * channels + w * channels +c 
            int <span class="hljs-attr">hwc_index</span> = h * <span class="hljs-number">128</span> * <span class="hljs-number">3</span> + w * <span class="hljs-number">3</span> + c<span class="hljs-comment">;</span>
            // CHW 索引: C * height * width + h* width + W
            int <span class="hljs-attr">chw_index</span> = c * <span class="hljs-number">128</span> * <span class="hljs-number">128</span> + h * <span class="hljs-number">128</span> + w<span class="hljs-comment">;</span>
            floatData_tmp<span class="hljs-section">[chw_index]</span> = rgbData<span class="hljs-section">[hwc_index]</span><span class="hljs-comment">;</span>
        }
    }
}
//归一化
float *<span class="hljs-attr">floatData</span> = new float[length]<span class="hljs-comment">;</span>
for (size_t <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; length; ++i) {</span>
    floatData<span class="hljs-section">[i]</span> = static_cast&lt;float&gt;(floatData_tmp<span class="hljs-section">[i]</span>)/ 255.0f<span class="hljs-comment">;</span>
}
</code></pre>
<p>2.创建模型的输入和输出Tensor，并把应用层传递的数据填充到输入的Tensor中</p>
<pre><code class="hljs language-ini" lang="ini">// 准备输入张量
size_t <span class="hljs-attr">inputCount</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
OH_NN_ReturnCode <span class="hljs-attr">ret</span> = OH_NNExecutor_GetInputCount(executor_, &amp;inputCount)<span class="hljs-comment">;</span>
for (size_t <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; inputCount; ++i) {</span>
    NN_TensorDesc *<span class="hljs-attr">tensorDesc</span> = OH_NNExecutor_CreateInputTensorDesc(executor_, i)<span class="hljs-comment">;</span>
    NN_Tensor *<span class="hljs-attr">tensor</span> = OH_NNTensor_Create(deviceID_, tensorDesc)<span class="hljs-comment">;</span>
    if (tensor != nullptr) {
        inputTensors_.push_back(tensor)<span class="hljs-comment">;</span>
    }
    OH_NNTensorDesc_Destroy(&amp;tensorDesc)<span class="hljs-comment">;</span>
}


<span class="hljs-attr">ret</span> = SetInputTensorData(inputTensors_, inputData)<span class="hljs-comment">;</span>

// 准备输出张量
size_t <span class="hljs-attr">outputCount</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
<span class="hljs-attr">ret</span> = OH_NNExecutor_GetOutputCount(executor_, &amp;outputCount)<span class="hljs-comment">;</span>

for (size_t <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; outputCount; i++) {</span>
    NN_TensorDesc *<span class="hljs-attr">tensorDesc</span> = OH_NNExecutor_CreateOutputTensorDesc(executor_, i)<span class="hljs-comment">;</span>
    NN_Tensor *<span class="hljs-attr">tensor</span> = OH_NNTensor_Create(deviceID_, tensorDesc)<span class="hljs-comment">;</span>
    if (tensor != nullptr) {
        outputTensors_.push_back(tensor)<span class="hljs-comment">;</span>
    }
    OH_NNTensorDesc_Destroy(&amp;tensorDesc)<span class="hljs-comment">;</span>
}
if (outputTensors_.size() != outputCount) {
    DestroyTensors(inputTensors_)<span class="hljs-comment">;</span>
    DestroyTensors(outputTensors_)<span class="hljs-comment">;</span>
    OH_LOG_ERROR(LOG_APP, "output size mismatch.")<span class="hljs-comment">;</span>
    return OH_NN_FAILED<span class="hljs-comment">;</span>
}
</code></pre>
<p>﻿</p>
<h4 data-id="heading-16"><strong>3.3.3 进行推理</strong></h4>
<p>调用OH_NNExecutor_RunSync，完成模型的同步推理。</p>
<pre><code class="hljs language-scss" lang="scss">OH_NN_ReturnCode ret = <span class="hljs-built_in">OH_NNExecutor_RunSync</span>(executor_, inputTensors_.data(), inputTensors_<span class="hljs-selector-class">.size</span>(),
                                                 outputTensors_<span class="hljs-selector-class">.data</span>(), outputTensors_<span class="hljs-selector-class">.size</span>());
</code></pre>
<p>说明</p>
<p>•如果不更换模型，则首次编译加载完成后可多次推理，即一次编译加载，多次推理。</p>
<p>•所有关于模型的操作, 均无法多线程执行。</p>
<p>﻿</p>
<h4 data-id="heading-17"><strong>3.3.4 获取模型输出并处理数据</strong></h4>
<p>1.调用OH_NNTensor_GetDataBuffer，获取输出的Tensor，在输出Tensor中会得到模型的输出数据。</p>
<pre><code class="hljs language-ini" lang="ini">// 获取第一个输出张量
NN_Tensor* <span class="hljs-attr">tensor</span> = outputTensors_[<span class="hljs-number">0</span>]<span class="hljs-comment">;</span>

// 获取张量数据缓冲区
void *<span class="hljs-attr">tensorData</span> = OH_NNTensor_GetDataBuffer(tensor)<span class="hljs-comment">;</span>

// 获取张量大小
size_t <span class="hljs-attr">size</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
OH_NN_ReturnCode <span class="hljs-attr">ret</span> = OH_NNTensor_GetSize(tensor, &amp;size)<span class="hljs-comment">;</span>

float *<span class="hljs-attr">tensorDataOutput</span> = (float*)malloc(size)<span class="hljs-comment">;</span>
// 将tensorData的数据一次性复制到tensorDataOutput中
memcpy(tensorDataOutput, tensorData, size)<span class="hljs-comment">;</span>
</code></pre>
<p>﻿</p>
<p>2.对Tensor输出数据进行相应的处理</p>
<p>把模型输出的BCHW转成BHWC, 并进行反归一化处理</p>
<p>﻿</p>
<pre><code class="hljs language-ini" lang="ini">//把模型输出的BCHW转成BHWC
float *<span class="hljs-attr">outputResult</span> = static_cast&lt;float *&gt;(tensorData)<span class="hljs-comment">;</span>
float *<span class="hljs-attr">output_tmp</span> = new float[size/sizeof(float)]<span class="hljs-comment">;</span>
for (int <span class="hljs-attr">h</span> = <span class="hljs-number">0</span><span class="hljs-comment">; h &lt; 512; ++h) {</span>
    for (int <span class="hljs-attr">w</span> = <span class="hljs-number">0</span><span class="hljs-comment">; w &lt; 512; ++w) {</span>
        for (int <span class="hljs-attr">c</span> = <span class="hljs-number">0</span><span class="hljs-comment">; c &lt; 3; ++c) {</span>
            output_tmp<span class="hljs-section">[h * 512 * 3 + w* 3 + c]</span> = outputResult<span class="hljs-section">[c * 512 * 512 + h * 512 + w]</span><span class="hljs-comment">;</span>
        }
    }
}
std::vector&lt;float&gt; output(size / sizeof(float), 0.0)<span class="hljs-comment">;</span>
for (size_t <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; size / sizeof(float); ++i) {</span>
    output<span class="hljs-section">[i]</span> = output_tmp<span class="hljs-section">[i]</span><span class="hljs-comment">;</span>
}
delete <span class="hljs-section">[]</span> output_tmp<span class="hljs-comment">;</span>


 // 计算总的数据大小
size_t <span class="hljs-attr">totalSize</span> = output.size()<span class="hljs-comment">;</span>

// 分配结果数据内存
std::unique_ptr&lt;uint8_t<span class="hljs-section">[]</span>&gt; <span class="hljs-attr">result_data</span> = std::make_unique&lt;uint8_t[]&gt;(totalSize)<span class="hljs-comment">;</span>

// 将float数据转换为uint8_t (反归一化)
size_t <span class="hljs-attr">index</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
for (float value : result) {
    // 将float值转换为uint8_t (0-255范围)
    float <span class="hljs-attr">scaledValue</span> = value * <span class="hljs-number">255.0</span>f<span class="hljs-comment">;</span>
    <span class="hljs-attr">scaledValue</span> = std::max(<span class="hljs-number">0.0</span>f, std::min(<span class="hljs-number">255.0</span>f, scaledValue))<span class="hljs-comment">;</span>
    result_data<span class="hljs-section">[index++]</span> = static_cast&lt;uint8_t&gt;(scaledValue)<span class="hljs-comment">;</span>
}

result_data 就是最终的超分数据,可以正常显示
</code></pre>
<p>﻿</p>
<h2 data-id="heading-18"><strong>4. 总结与技术展望</strong></h2>
<p>京东金融App在鸿蒙端部署Real-ESRGAN-General-x4v3超分辨率模型的完整实践过程，成功解决了ONNX模型到OM离线模型转换、BCHW与BHWC张量格式处理、以及基于CANN Kit和NAPI的完整部署链路等关键技术难题。</p>
<p>展望端智能的未来发展，随着芯片算力的指数级增长、模型压缩技术的突破性进展以及边缘计算架构的日趋成熟，端侧设备将从单纯的数据采集终端演进为具备强大推理能力的智能计算节点，通过实现多模态AI融合、实时个性化学习、隐私保护计算和跨设备协同等核心能力，将大语言模型、计算机视觉、语音识别等AI技术深度集成到移动设备中，构建起无需联网即可提供智能服务的自主计算生态，推动人机交互从被动响应向主动感知、预测和服务的范式转变，最终开启真正意义上的普惠人工智能时代。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【前瞻技术布局】咖啡机器人：具身智能技术首阶段探索与实践]]></title>    <link>https://juejin.cn/post/7586872817875402778</link>    <guid>https://juejin.cn/post/7586872817875402778</guid>    <pubDate>2025-12-23T10:13:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586872817875402778" data-draft-id="7586872817875386394" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【前瞻技术布局】咖啡机器人：具身智能技术首阶段探索与实践"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-12-23T10:13:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【前瞻技术布局】咖啡机器人：具身智能技术首阶段探索与实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T10:13:44.000Z" title="Tue Dec 23 2025 10:13:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、前言</h2>
<p>我是一名京东具身智能算法团队的研究人员，目前，主要专注在<strong>真实场景真实机器人</strong>下打造一套<strong>快速落地新场景的具身智能技术架构</strong>，聚集机器人操作泛化能力提升，涉及模仿/强化学习、“视觉-语言-动作”大模型等方法研究。本文主要以第一阶段<strong>咖啡机器人</strong>任务场景为切入点，来阐述所取得的技术突破，以及后续技术优化方向。如下是机器人全程自主完成打咖啡的视频。</p>
<h2 data-id="heading-1">二、问题定义和路径选择</h2>
<p>具身智能，指的是配备实体身躯、支持物理交互的智能体所展现出的智能形态。凭借这一智能形式，机器人及其他智能设备得以在复杂多变的现实世界中执行各类任务。然而，鉴于任务的复杂性以及操作所呈现出的高难度与多样性，具身智能技术遭遇诸多挑战，当前仍处于持续发展阶段。现阶段，多数具身智能研究仅在<strong>实验室或结构化场景中</strong>开展，很难将成果迁移至真实场景加以应用。究其根源，理想环境屏蔽了诸多在真实场景中才会暴露的问题。有鉴于此，我将研究重心聚焦于<strong>真实场景下的具身智能技术突破</strong>，同时，为推动具身智能技术广泛赋能多元业务，着力打造一套能够<strong>快速适配新场景的具身智能技术架构</strong>。</p>
<p>目前，具身操作是具身智能核心技术卡点，其技术路线粗分为<strong>预测机器人操作动作</strong>与<strong>预测物体抓取位姿</strong>。前者泛化性弱且依赖大量专家数据，后者难适用于复杂长序列任务，灵巧手位姿也难获取。鉴于此，创建了技术上<strong>乘上启下“末端模仿” 新路径</strong>，融合两者优势，包括<strong>预测预抓取位姿</strong>（易实现、泛化性强）与<strong>统一操作轨迹学习</strong>（减少专家数据依赖、操作灵巧），且该路径可灵活扩展为 “视觉 - 语言 - 动作” 大模型方法。</p>
<h2 data-id="heading-2">三、快速落地新场景技术架构打造</h2>
<p>在当今快速变化的技术环境中，集团会面临着不断适应新业务场景的挑战。只能适应单一场景的具身智能技术不具备长期价值，而能够快速落地新场景的具身智能技术则至关重要。因此，针对于真实场景下机器人打咖啡任务，打造了一套快速落地新场景的技术架构<strong>原型</strong>，并取得了关键技术突破。</p>
<h3 data-id="heading-3">1、关键技术突破及价值</h3>
<h4 data-id="heading-4">1）真实场景下从0到1打造具身智能系统技术架构</h4>
<ul>
<li><strong>面临挑战</strong>：具身智能系统往往涉及内容模块较多，耦合关系较为复杂，可扩展性较差，难以快速适应新任务场景。与此同时，真实场景下，往往面临着通信时延、模型推理速度和系统稳定性等挑战。</li>
<li><strong>技术突破</strong>：如下图所示，打造了一套具备<strong>高扩展性</strong>的具身智能系统技术架构，只需定义<strong>合适的子任务序列</strong>就可落地新场景。其中，该系统以<strong>ROS系统</strong>为基础构建，整个流程通过主调度模块进行协调，确保各模块之间的协同工作，通过不同控制模式决定系统不同阶段的工作方式，包括导航、感知、基于Agent的任务规划、遥操、具身操作等。此外，设计了模型异步推理、GRPC协议数据传输和子母路由通信等机制来攻克通信时延、推理速度慢等问题。</li>
<li><strong>核心价值</strong>：在真实场景下，从<strong>0到1打造了整套具身智能系统技术架构</strong>，并且<strong>成功落地咖啡机器人任务场景</strong>中，而不是在简单的实验室或者结构化场景下。与此同时，为后续真实场景下具身智能技术的研发提供了<strong>坚实的基础</strong>。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b02253d41164017a0172efd1e9bd843~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089624&amp;x-signature=zON%2FHei2%2B46dKW50pzuvwhtDWb8%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-5">2）面向双臂灵巧手构建高频率一体式遥操技术</h4>
<ul>
<li><strong>面临挑战</strong>：目前，大多数遥操采用了同构方式。这种方式需要额外配置相应的机械臂，并且不同结构机器人是无法共享，可扩展性及便捷性低。其次，双臂和灵巧手的一体式遥操技术对其同步性及延迟率要求高，实现难度大。</li>
<li><strong>技术突破</strong>：如以下视频所示，构建了<strong>面向双臂灵巧手的一体式高频率遥操技术</strong>。通过结合<strong>惯性动捕</strong>和<strong>视觉动捕</strong>技术，对遥操设备进行了创新设计，使机器人能够精准复刻人类动作。同时，借助<strong>手和臂数据透传技术</strong>，优化了从动作捕捉到控制执行的高频率跟随链路，极大提升了系统响应速度与操作精度。</li>
<li><strong>核心价值</strong>：相比于行业其他遥操技术，该技术具备<strong>轻量化</strong>、<strong>价格低廉</strong>和<strong>扩展性强</strong>特点。此外，通过该遥操技术，双臂灵巧手的整体控制频率达<strong>50hz</strong>以上，并且系统延时在<strong>50ms</strong>以内。</li>
</ul>
<h4 data-id="heading-6">3）少量数据下实现物体位置的泛化操作</h4>
<ul>
<li><strong>面临挑战</strong>：具身操作的泛化性一直是一个挑战性问题。目前，大多数方法都依赖于大量数据使其涌现出泛化性能。然而，大量的示教数据需要消耗大量人力物力。训练模型也需较多计算资源的支撑，且效果也难以达到较佳的泛化性能。</li>
<li><strong>技术突破</strong>：如下图所示，提出了基于<strong>末端模仿的泛化操作方法</strong>，聚集于<strong>统一的操作轨迹学习</strong>，能在较少的数据下实现较强的位置泛化能力，涉及核心模块包括：<strong>操作物体感知与位姿估计</strong>、<strong>预操作位姿到达</strong>和<strong>聚集物体的策略学习</strong>。此外，设计了<strong>聚集于物体的视觉特征</strong>提取模块，增强对核心操作区域的感知。</li>
<li><strong>核心价值</strong>：相比与行业已有方法，首次提出聚集于<strong>核心操作轨迹</strong>的学习方法，能在较少数据量情况下实现物体位置的泛化操作，在打咖啡任务中，成功率<strong>达90%以上</strong>。此外，在大量抓取任务中（拿扫码枪、抓娃娃、搬箱子等等），该方法表现出的性能相比于baseline成功率<strong>提升了50%以上</strong>。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de04b425d526422bad7473e244ab627c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089624&amp;x-signature=Dcq78%2Fe4DYuNjBHPOAWdFxPqOBw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">2、咖啡机器人任务场景实践</h3>
<p>基于所打造的具身智能技术架构，首先落地了<strong>咖啡机器人</strong>任务场景。机器人打咖啡任务主要包含以下几个步骤：<strong>导航到咖啡机</strong>、<strong>拿起空杯子</strong>、<strong>放好杯子</strong>、<strong>点击屏幕</strong>（选择咖啡、确认按钮和已放好按钮）、<strong>拿起咖啡杯</strong>、<strong>导航到用户位置</strong>、<strong>将咖啡杯递给人</strong>。打咖啡任务是一个真实场景下的<strong>长序列任务</strong>，包含多个子任务。子任务都是按序列衔接好的，完成当前子任务才会执行下一个子任务。与此同时，设计了<strong>子任务是否成功完成的检测机制</strong>，提升整个系统的<strong>鲁棒性</strong>，比如：点击屏幕过程中，如果没有点击触发，会反复点击直到成功。即便面对打咖啡这样复杂的场景，凭借该具身智能技术架构打造的系统，仍能以极高的成功率完成任务。以下是机器人打咖啡的<strong>精彩瞬间</strong>。</p>















<table><thead><tr><th><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0381409b2064b36a783793d6a7c139d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089624&amp;x-signature=YnHLRytog4ywJwxClniADi89pY4%3D" alt="拿空杯子" loading="lazy"/>拿空杯子</th><th><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12dd036fe35542dfb4fe7fd15ca6f728~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089624&amp;x-signature=weLQjTOHkRUMGvIijdI8p9eibt4%3D" alt="拿空杯子" loading="lazy"/>放杯子</th><th><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56ee51ab7f8048f1ba81120fc2928793~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089624&amp;x-signature=C9qjfReUKd3cdDMHS6iUNFkP2Z0%3D" alt="拿空杯子" loading="lazy"/>选咖啡</th></tr></thead><tbody><tr><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd8d48bc8a0e46639d463378bf7a9f91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089624&amp;x-signature=w9A%2FtA6aCLpaDdX6jf7AI0sdusA%3D" alt="拿空杯子" loading="lazy"/>点击按钮</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45740e6694f64f42bc1fd3d2c89ccafe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089624&amp;x-signature=xhGOBuKWhs8NZl7dN2D2WVuINuA%3D" alt="拿空杯子" loading="lazy"/>拿咖啡杯</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/daeef9b122a2495bae43e5ca6251a369~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089624&amp;x-signature=QYaQx2LTsOqjBzxgICAi1Anp0qs%3D" alt="拿空杯子" loading="lazy"/>递送给人</td></tr></tbody></table>
<p>在咖啡机器人任务场景实践中，遇到诸多新问题。起初为机器人在胸部和头部各配备 RealSense D435 相机，却发现胸部相机易被机械臂遮挡，且两款相机 <strong>FOV 过小，常无法捕捉操作物体和灵巧手</strong>，而这类问题在<strong>实验室桌面操作场景中难以察觉</strong>。于是，将头部相机换成 FOV 更大的 ZED 相机，可新相机又导致<strong>模型视觉特征不聚集</strong>，遂通过聚焦手部局部视角解决。点击屏幕时，<strong>按钮需快速抽离动作才能触发</strong>，给灵巧手控制带来极大困难。为此设计检测机制，让灵巧手能反复尝试，有效提升了点击成功率。</p>
<h2 data-id="heading-8">四、下一步技术优化及进展</h2>
<p>后续，将进一步完善和优化整个具身智能系统架构，使其能快速落地新场景。核心聚集于<strong>具身操作方向，提升机器人的泛化操作能力，扩充其技能库的上限</strong>。结合具身技术<strong>发展趋势</strong>以及现有架构的<strong>不足</strong>，主要围绕以下两个方面开展工作。</p>
<ul>
<li><strong>“视觉-语言-动作”大模型促进快速落地新场景</strong>：“视觉-语言-动作”大模型会<strong>利用“视觉-语言”预训练模型知识</strong>来促进对机器人动作的学习。在大量的数据训练基础上，“视觉-语言-动作”大模型将会涌现出令人意想不到的能力：<strong>基于语言指令的新技能泛化</strong>、<strong>新物体泛化</strong>、甚至<strong>多机协作能力</strong>。这些潜能在Figure AI公司最新发布的Helix模型实验结果中已展现出来。</li>
<li><strong>真机强化学习优化整个具身智能系统</strong>：在目前的具身操作技术中，大多数采用了模仿学习方法。然而，<strong>模仿学习</strong>存在其<strong>局限性</strong>，较为<strong>依赖于专家数据</strong>，并且存在<strong>性能上限</strong>。<strong>强化学习</strong>方法则能使机器人探索更多数据，<strong>突破其性能上限</strong>，对专家数据<strong>依赖程度较低</strong>。另外，真机强化学习是基于机器人实时与环境交互所得数据来优化模型，这种优化不仅仅是提升模型性能，而且能够对<strong>整个具身系统进行优化</strong>。</li>
</ul>
<h2 data-id="heading-9">五、我对具身智能的思考和坚持</h2>
<ul>
<li>在具身智能技术的实际落地进程中，真实场景的复杂程度往往远远超出了在实验室或结构化场景中预先设定的界限。在<strong>真实任务场景中进行技术探索</strong>，不但有助于我们对算法的实际性能进行验证和优化，还能够发掘出<strong>在实验室或结构化场景中未曾预想到的问题与挑战</strong>。通过在真实场景中对技术进行测试和应用，我们能够获取更为丰富的数据和反馈，进而推动技术不断迭代和创新。</li>
<li>随着 Figure AI 公司发布的 Helix 模型并在物流仓库中的成功应用，这使我愈发坚信具身智能的时代已然降临。对其实现的技术逻辑进行剖析：重点围绕<strong>一个机器人本体</strong>，在一个特定的<strong>垂类领域中积累充足的数据量</strong>，<strong>在 “视觉 - 语言 - 动作” 大模型</strong>的有力支持下，机器人能够学会<strong>多种类人的技能</strong>，并且具有<strong>较强的泛化性能</strong>。其能够出圈的核心在于<strong>围绕一本体在真实场景下打磨技术</strong>。我认为这是实现快速落地的较佳方案，值得借鉴。此外，当前技术都围绕提升机器人任务成功率开展，若要真正将其在新场景中落地，还必须考虑机器人完成任务的<strong>效率问题</strong>。</li>
<li>展望未来，机器人会逐步融入人类社会。我们须倾<strong>热血</strong>与<strong>干劲</strong>，全力投身具身智能技术攻坚，力求让<strong>技术快速落地新场景</strong>，为企业<strong>技术增长添砖加瓦</strong>。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[DeepSeek 正当红，聊聊大模型应用的四大关键要素和未来]]></title>    <link>https://juejin.cn/post/7586872817875370010</link>    <guid>https://juejin.cn/post/7586872817875370010</guid>    <pubDate>2025-12-23T10:13:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586872817875370010" data-draft-id="7586703355646672923" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="DeepSeek 正当红，聊聊大模型应用的四大关键要素和未来"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-12-23T10:13:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            DeepSeek 正当红，聊聊大模型应用的四大关键要素和未来
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T10:13:15.000Z" title="Tue Dec 23 2025 10:13:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>大模型应用的春天来了。在人工智能的浪潮中，大模型正成为推动技术变革的核心力量。春节前，DeepSeek R1 的发布在全球范围内引发了巨大轰动，它不仅在性能上与 OpenAI 的模型不相上下，更凭借其基于 CoT（Chain of Thought）的推理过程，展现出强大的逻辑能力，同时，开源和低成本的优势，让众多企业迅速接入。DeepSeek 已然成为各行业关注的焦点，今年无疑是大模型应用爆发的关键一年。</p>
<h2 data-id="heading-1">一、大模型应用的爆发：为什么是2025？</h2>
<p>技术的发展并非一蹴而就，而是经历从萌芽到成熟，再到广泛应用的过程。20多年前的PC互联网和10多年前的移动互联网的兴起，都经历了这样的阶段，如今，从周期和技术成熟度来看，AI大模型也正站在爆发的前夜。</p>
<p>DeepSeek R1 的出现，不仅展示了大模型的强大能力，更以开源和低成本的姿态，为更多企业和开发者提供了平等的机会。短短一个多月，国内众多公司纷纷接入，甚至包括腾讯、阿里等行业巨头。这种现象表明，大模型的应用已经具备了广泛落地的基础，从金融风控到投资决策，从智能家居到医疗辅助，大模型的应用场景正在不断拓展。2025年，或许就是这场技术变革的“临界点”。</p>
<h2 data-id="heading-2">二、大模型的应用价值：不只是“通用聊天”</h2>
<p>很多人可能会问：既然 DeepSeek、ChatGPT 等聊天类App已经如此强大，为什么还要开发基于大模型的应用呢？原因主要有两个方面：一是通用聊天应用虽然灵活，但在很多专业领域，普通用户并不具备问正确问题的能力；二是大模型推理需要基于场景的相关数据，通用聊天工具从互联网搜索到的数据，可能不全或者不准确，在医疗、投资等大部分专业领域需要准确数据的场景，并不可靠。</p>
<p>在当下的技术发展阶段，大模型尚未真正具备智能，其核心价值在于卓越的数据处理能力。这种能力在众多专业领域中展现出巨大的潜力，能够显著提升工作效率。以医疗领域为例，大模型能够基于患者的病历、检查报告、生理数据等多维度信息，快速进行病情分析和辅助诊断，为医生提供精准的决策支持。在投资领域，它也能迅速获取市场动态数据，完成基本面与技术面的深度分析，为投资者提供科学的决策参考。这些应用场景充分证明，大模型的价值远不止于简单的“聊天”。</p>
<h2 data-id="heading-3">三、做好大模型应用的关键：四大要素</h2>
<p>过去两年，我们在积极探索大模型的应用过程中：从营销运营领域的热搜机器人、到 Coding 领域的 JoyCoder，金融科技领域从社区的热点话题生成、到基金/保险产品解读。DeepSeek R1 的出现，让我们更加意识到，目前的应用还非常初级，只是有，离好还有很大的差距和空间。基于过往的这些场景探索，大模型应用要取得更好的效果，我们认为需要综合考虑以下4大要素：好的效果 = 大模型 + 专业知识 + 知识库 + 工程架构。</p>
<h3 data-id="heading-4">（1）专业知识和交互设计：让大模型“容易使用”</h3>
<p>DeepSeek 等通用聊天类App虽然简单，但要用好的话往往需要用户具备专业知识，看似普惠，事实上门槛比较高，交互体验也不够便捷。例如在投资领域，普通用户可能并不知道该问什么问题，如果只是问“今天的市场行情怎么样，这只股票是买入还是卖出”，大模型并不能给出能赚到钱的答案。而稍有一些投资经验的人，可以问“分析一下沪深300指数的技术面，时间从2021年到现在，从形态、均线、趋势等看走势是反弹还是反转，并用MACD、背离、量能等交叉确认”等更复杂的问题。如果涉及到更具体买卖决策和调仓建议，可能需要更加深入和专业的问题。</p>
<p>此外，交互不够便捷也是一大问题。用户需要组织语言、打字输入，还要在聊天工具和具体的如券商的App之间来回切换，体验较差。今日头条等之所以能取代门户网站，正是因为其在交互上体验更好。因此，交互设计和专业知识的结合是大模型应用成功的关键，场景化的AI是探索的一个方向。</p>
<h3 data-id="heading-5">（2）领域知识库和搜索能力：让大模型“有据可依”</h3>
<p>问准确的问题还不够，还需要有充分的上下文信息以及准确获取的能力。首先，信息的及时、准确和丰富至关重要。大模型是神经网络，仿照大脑的原理构建，可以看作一个看完了互联网上所有数据的超级专家。就像让医生看病或操盘手交易，需要告知其“病情”或“行情”才能开展工作，信息越及时和全面，专家的决策就越准确、可靠。</p>
<p>DeepSeek App 虽然具有联网能力，能在回答问题前搜索相关信息，但搜索回来的数据可能存在问题，如数据过期或数据较少，导致推理结果不够准确。比如下图案例，做出推理结论而引用的数据4和6是过期的，导致看起来完美的推理逻辑也是无法用的。企业要想用好大模型，必须建立本地知识库，确保数据的数量和质量。在 DeepSeek 这类大模型开源后，算法已经平权，企业之间的竞争又回到了数据这个生产力要素。</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a69006c4f7374a5db454810ca94e50f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089595&amp;x-signature=MAYoWya5VmYSKTLCSziRV8e1%2Bf8%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<p>其次，高效准确地获取数据也极为关键。即使知识库建的很大、很丰富，搜索能力也至关重要，这是百度、谷歌等深耕多年的能力，技术门槛比较高，要做好并不容易。知识库本身的架构，访问权限设计，以及各种RAG技术，都极为关键。（图片来自于网络）</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f269a89b9590421ab3f3d6b901d1739f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089595&amp;x-signature=Z4nG6Lck4F%2FCmyrusR6Oo0ABZ64%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<h3 data-id="heading-6">（3）Agent架构与工程能力：让大模型“激发潜能”</h3>
<p>对于简单问题，大模型可以通过一轮对话给出答案；而对于复杂问题，如买一张去西藏的便宜机票，或判断中证A500指数基金什么时候买，则需要更加复杂的设计，如果能更好地组织和引导，类似于人类的头脑风暴和专家讨论，把多个专家的智力都激发出来，就有可能找到更好的解决方案。</p>
<p>大模型是一个待机的超级专家，提供简单的API供应用随时调用，如何面向大模型编程，激发其潜力需要研发人员的精心设计，目标是大模型成为真的“大脑”，取代原来预设的业务流程，策略引擎和流程编排工具，让应用具备自主智能。通过Agent架构，甚至多Agent（智能体）交互，可以引导大模型进行多轮交互和逻辑推理，从而获得更准确的结果，工具/MCP，记忆，规划、思维链、反思等架构和设计模式，需要持续探索应用。（图片来自于网络）</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8044a97b264446ebc724181142caf0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089595&amp;x-signature=ouQ0gzTXYd%2B%2B%2FcCtu%2BrhmtJp%2BtE%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<h3 data-id="heading-7">（4）大模型自身：“选择比拥有更重要”</h3>
<p>大模型是整个应用的核心部件，当然是最重要的。但从应用开发的角度来看，选择合适的大模型并灵活切换更为关键，应用系统的架构，需要更加灵活的支持多个大模型。DeepSeek R1的成功表明，大模型在持续的竞争和迭代，另外，不同大模型在不同领域的潜质也不一样，就像有些人擅长科学，有些擅长经商，有些擅长音乐，多Agent系统中，每个Agent可以使用不同的大模型。未来，大模型的市场竞争将更加激烈，选择比拥有更重要。</p>
<h2 data-id="heading-8">四、大模型的未来：探索与展望</h2>
<p>DeepSeek R1 是终点吗？当然不是。Transformer 是实现 AGI（通用人工智能）的终极算法架构吗？估计也不是。吴军、杨立琨、王兴兴等专家都曾提出过类似的观点：尽管Transformer架构在自然语言处理等领域取得了巨大突破，但它并非万能。未来仍有可能出现更强大的算法，推动人工智能迈向新的高度。</p>
<p>数据真的已经用完了吗？应该也不是。人类在学习和沉淀规律时，从来不仅仅是依赖过往的书本知识。从开普勒三大定律到牛顿力学，这些伟大的科学发现，都是通过对现实世界中的数据进行获取、分析和总结得出的。无论是日月星辰的运行轨迹，还是潮起潮落风云变幻，亦或是粒子撞击的微观过程，甚至是人类自身的脉搏跳动，只要通过摄像机、传感器等工具进行捕捉，就能从这些更广泛、更丰富的自然界获取数据。这些数据，或许将成为未来人工智能发展的重要“养料”，为模型的训练和优化提供新的思路和方向。</p>
<p>除了算法和数据，大模型的未来发展还需要强大的算力。量子计算或许是解决这一问题的关键方案。哦，还有能源问题，小时候看《变形金刚》，一直不理解他们为什么整天争夺“终极能源”，未来当硅基生命充满大地和天空的时候，能源问题或许将成为制约技术发展的关键瓶颈。</p>
<p>这一天，或许终将会到来。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[拿走200多万奖金的AI人才，到底给出了什么样的技术方案？]]></title>    <link>https://juejin.cn/post/7586865729702985766</link>    <guid>https://juejin.cn/post/7586865729702985766</guid>    <pubDate>2025-12-23T10:26:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586865729702985766" data-draft-id="7586836874016899082" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="拿走200多万奖金的AI人才，到底给出了什么样的技术方案？"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-12-23T10:26:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            拿走200多万奖金的AI人才，到底给出了什么样的技术方案？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T10:26:28.000Z" title="Tue Dec 23 2025 10:26:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在国内，懂技术 —— 尤其是 AI 技术的年轻人，真的不缺崭露头角的机会。</p>
<p>前段时间，2025 年腾讯广告算法大赛结果揭晓，前 10 名队伍的全部成员都拿到了腾讯的录用意向书，冠军还拿到了 200 万元巨额奖金。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a92f9d0e3c0745ce9165a6e5bdab10a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090388&amp;x-signature=aiNp7bFi%2BtRPWXBPgwkSwuz5OeQ%3D" alt="图片" loading="lazy"/></p>
<p>当时，看完选手们的答辩，腾讯公司副总裁蒋杰感慨地说，这届年轻人的知识储备令人惊叹，他们做出来的东西和工业界的实际工作非常接近，没有代差。</p>
<p>如果说大赛考的是一个已经被工业界解决的问题，选手们查查论文、复现方案，拼拼工程把问题解决掉倒也不是什么新鲜事。但看过今年赛题的人都知道，这次摆在桌面上的，是一个仍在探索中的真实难题，没有现成答案，也不存在所谓「最优解」。</p>
<p>也正因如此，比赛真正精彩的部分，其实不在排名本身，而在于：这道题究竟难在哪里？工业界已经做了些什么？而这些年轻人，又给出了哪些实用的解法？</p>
<p>在这篇文章中，我们将结合冠亚军团队的解决方案，来详细聊聊这些问题。</p>
<p>广告推荐</p>
<p>从来不是一件简单的事</p>
<p>一提到广告，很多人都会下意识皱眉。这种情绪其实很正常，没有人喜欢被无关的信息打断。但换个角度看，今天我们习以为常的很多内容和服务之所以能够长期、稳定地存在，本身就离不开广告的支撑。</p>
<p>也正因如此，平台真正想做的，并不是把更多广告塞给用户，而是尽量让广告「少出现一点、对一点」。只有把广告在合适的时间，推给真正可能需要的人，才能减少无效曝光，也减少对其他人的打扰。腾讯广告算法大赛所讨论的，正是如何把这件事做得更克制、更聪明。</p>
<p>在业界，目前主要有两种方法在 PK。一种是已经用了很多年的判别式方法，另一种是最近两三年兴起的生成式方法。</p>
<p>要理解两种方法的差异，我们可以举个例子：假设你是一个新来的班主任，想要根据小明同学的兴趣给他推荐合适的课外书。</p>
<p>在传统的判别式方法里，你的任务很明确：不是理解小明的成长过程，而是判断「这本书适不适合他」。学校会给你一张小明的档案表，以及一张馆藏书单。档案表上记录的是一系列已经被「统计好」的特征，你需要做的，是把这些特征代入模型，给每一本书算一个匹配分数，然后按分数高低排序。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c24688e1ff147c19cb14895cc6fdbc4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090388&amp;x-signature=8i3QxqMVOBjsHeXURIr3T7imK2g%3D" alt="图片" loading="lazy"/></p>
<p>而按照最近兴起的生成式方法，学校换了一种要求。不再让你给书打分，而是直接把小明过去一整年的借阅「流水账」交给你，让你去发现其中的规律，并预测：接下来最可能发生的那一次借书，会是什么样子。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1c71b0ea4dc4b8ea8d506954eacfd90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090388&amp;x-signature=pVnujfg9fhU5qr%2BiVE0f3aQzX%2F4%3D" alt="图片" loading="lazy"/></p>
<p>后一种方法之所以兴起，是因为前一种方法在研究多年之后，遇到了很难克服的瓶颈。</p>
<p>从例子里可以看出，传统判别式方法，更像是把小明压缩成一张「人设表」，在书和人之间算匹配度，然后用一种级联的「漏斗」去筛选。这种方式在早期非常有效，但后来，随着系统不断加入新的手工特征、更多统计维度、更复杂的级联模型，效果提升却越来越有限，尤其是在冷启动方面。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c9439cdd8984e57acde19e6237c7469~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090388&amp;x-signature=PE%2BMGXtHEyBkS9mmeSVNDFaXwl0%3D" alt="图片" loading="lazy"/></p>
<p>传统判别式方法的级联架构，像漏斗一样对广告层层筛选。</p>
<p>原因并不是工程师不努力，而是这种范式本身就存在很大的局限，包括特征挖掘遇上天花板，模型架构无法有效建模世界知识、推理用户意图、吸收多领域多模态用户行为信息，级联架构把目标拆碎并带来误差累积等。这就造成一个局面：算法工程师已经很难通过简单地增加特征或扩大现有模型规模来获得预期效果。</p>
<p>而生成式方法换了一种思路。它不急着给小明下结论，而是直接看他一整段时间的借阅记录，去理解兴趣是如何变化的，并顺着这个过程，预测「下一步最可能发生什么」。</p>
<p>对应到广告场景里，这意味着系统不再只判断「点不点」某个广告，而是尝试回答：在此时此刻，这个人最不反感、也最可能有用的广告，会是什么。</p>
<p>生成式模型本身的一些特质，使得它们擅长回答这类问题，包括处理长时间跨度的行为序列的能力，可以直接利用大模型中已经学到的世界知识和多模态先验等。</p>
<p>腾讯广告算法大赛所关注的，正是这一代方法，而且考虑到多模态信息在此类场景中的重要性，他们把赛题确定为「全模态生成式推荐」。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0d2b6ac883142508e732c428f529dfa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090388&amp;x-signature=UFFdnwGKQbkWueDddIt8N7sfNcI%3D" alt="图片" loading="lazy"/></p>
<p>目前，业界已经涌现出了一些优秀工作，有些成功地将传统级联架构中的某个组件替换为了生成式模型，比如 Google TIGER、Meta HSTU；还有些探索了端到端的生成式推荐，比如快手的 OneRec、腾讯的单模型框架 GPR。值得注意的是，HSTU 首次在推荐中观察到了 Scaling Law，这说明推荐系统也可以「吃到 scaling 的红利」。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06ec532929574330ab65c6a202e653aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090388&amp;x-signature=pPVOmuM%2FrBRpy3OVdb7GLL3y6P0%3D" alt="图片" loading="lazy"/></p>
<p>传统级联方法、用生成式模型替代部分组件的方法以及端到端生成式方法（腾讯 GPR）对比图。图源：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2511.10138" target="_blank" title="https://arxiv.org/pdf/2511.10138" ref="nofollow noopener noreferrer">arxiv.org/pdf/2511.10…</a></p>
<p>不过，这一领域依然存在很多挑战，比如工业级动态词表带来的训练 / 推理双重爆炸、毫秒级延迟与巨量算力的矛盾、大尺寸模型性能尚未得到充分验证等。</p>
<p>就是在这样的探索阶段，选手们拿到了这个赛题。对于没有接触过广告业务的他们来说，这个赛题极具挑战性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4d0c50ae9784f3dace93bdc2a985cd5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090388&amp;x-signature=eXQC%2FS4odmfjfDvAe4dCarazYFw%3D" alt="图片" loading="lazy"/></p>
<p>首先从数据规模来看，赛题对应的是超大规模数据场景：涉及千万级广告、千万级用户，以及同样规模的交互序列，但可用于训练的计算资源却是有限的，这要求模型在效果与效率之间做出权衡。</p>
<p>其次，数据本身的结构也非常复杂。选手拿到的是经过脱敏处理的用户全模态历史行为数据，包含文本、图像以及用户与广告之间的协同行为信息，同时还存在特征缺失、行为序列时间跨度大的问题，需要在不完整信息下建模长期与短期行为。</p>
<p>在任务层面，复赛赛题并非单一目标优化，而是同时涉及曝光、点击与转化等多个隐式目标，并且存在近半数的冷启动 item，这进一步提高了建模难度。</p>
<p>接下来我们就看看，本届大赛的冠亚军团队是怎么解决这些问题的。</p>
<p>冠军 Echoch：让推荐系统真正理解</p>
<p>用户「此时此刻」想要什么</p>
<p>冠军 Echoch 团队由来自华中科技大学、北京大学、中国科学技术大学的同学组成。在答辩中，他们从特征工程、模型设计、语义 ID、训推加速四个角度介绍了自己的方案。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ca4d3f5787245aea1f1605f692cd9cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090388&amp;x-signature=W%2BjRQYNhasLs6GtBOB1Mv%2FwO5Oc%3D" alt="图片" loading="lazy"/></p>
<p>三级会话体系 + 周期编码 + 时间差分桶：让模型拥有节奏感</p>
<p>同一个行为，在不同时间和状态下，含义可能完全不一样。比如同样是点一个广告，早上看到可能是随便点点，晚上可能更容易下单；5 分钟前点过一双鞋可能是刚感兴趣，3 天前点过的鞋可能已经不喜欢了。所以 Echoch 团队努力去解决的第一个大问题是：如何让推荐系统拥有「时间感」和「节奏感」，知道用户「此时此刻」处于什么状态。</p>
<p>为了解决这个问题，他们提出了三种方法，从不同角度来描述用户行为的特征，分别是：三级会话体系、周期编码和时间差分桶。</p>
<p>所谓的三级会话体系如下图所示，它解决的问题是怎么组织用户的各种行为：是刚点开，随手划两下；还是已经刷了一会儿，兴趣在变化；还是之前刷过，现在又回来刷了。这样的区分有助于系统判断「用户现在想干嘛」，从而决定推荐的时机和节奏。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d427e23747b541b4b07eaa6b8496318d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090388&amp;x-signature=NJ9GuIsIPgX%2BtnaJFSlo%2BUfXa2g%3D" alt="图片" loading="lazy"/></p>
<p>而周期编码的作用则是找到时间点的规律，让模型感知此刻是用户常刷的高峰期，还是偶尔点开的空档，从而决定推荐的内容类型。时间差分桶是为了让模型分清「新鲜度」，即某个商品是「刚刚感兴趣」还是「早就看过」，从而决定历史行为的参考权重。</p>
<p>这几个维度的信息叠加在一起，可以让推荐系统既贴着用户的作息周期，又更好地把握新鲜度和轰炸感，在合适的时间推合适的内容。</p>
<p>点击和转化：一个模型，两套策略</p>
<p>到了复赛阶段，大赛的规则其实发生了一些变化：在初赛中，选手们只需要预测「点击」行为；但到了复赛，他们需要同时预测「点击」与「转化」两种行为。</p>
<p>这就带来了一个问题：两种行为的目标与权重差异巨大，但模型只能生成一个统一的用户画像，推荐时左右为难。</p>
<p>对此，Echoch 团队给出的解决方案是让同一个模型，能根据「想让用户点击」还是「想让用户购买」自动切换推荐策略，而不是一套画像硬撑两个目标。</p>
<p>除此之外，他们在模型设计层面还发现了一个问题，就是用 HSTU 作为基座模型会遇到显存瓶颈和性能瓶颈。经过调查，他们发现这个问题的本质是 HSTU 需要靠「外挂补丁」去了解时间和行为信息，这样不但显存和计算成本很高，效果也开始停滞。于是，他们把基座模型换成了 LLM，因为 LLM 天生就有一个叫 RoPE 的位置编码机制，就像自带了「时间感」，这样时间和行为就不再是负担。结果不仅线上得分提升不少，显存占用也减少 5G 左右。</p>
<p>引入随机性，让冷门广告也有曝光机会</p>
<p>对于 Echoch 团队来说，语义 ID 层面的核心问题在于：用传统的聚类方法给广告编号，热门广告占据了大部分「好位置」，冷门广告被挤到角落，几乎没有被推荐的机会。</p>
<p>对此，他们给出的解法是：在编码的最后一层，故意引入一些随机性，让码表使用更均匀，从而让更多广告能被模型真正看到、参与训练。这种方法效果显著：长尾物品训练关注度提升了 190 倍，码表利用率从 81.2% 提升至 100%，Gini 系数（衡量曝光分布的不平等程度的指标）从 0.53 降至接近于 0。</p>
<p>引入 Muon 优化器，训练又快又稳定</p>
<p>前面提到，HSTU 首次证明，推荐系统也能吃到 scaling 的红利。但对于选手来说，训练更大的模型却没有那么容易，因为他们可以调动的计算资源是有限的。模型一大就面临显存不够用、训练不稳定的问题。</p>
<p>为了不在模型规模上妥协，Echoch 引入了 Muon 优化器。与需要为每个参数额外存储 2 份历史信息的 AdamW 相比，Muon 通过 Newton-Schulz 迭代把梯度矩阵变成正交矩阵，省掉了记录二阶动量的显存开销，显存占用实测锐减 45%，收敛速度提升 40%。</p>
<p>亚军 leejt：大数据，大模型</p>
<p>scaling is all you need</p>
<p>亚军 leejt 团队成员来自中山大学。在答辩中，他们从数据处理、模型训练、模型推理与后训练等几个角度介绍了自己的方案。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db11134f23f642e582e6ed306039728f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090388&amp;x-signature=zSCsCGlVuOSIF9ryVmuzaMVB4V4%3D" alt="图片" loading="lazy"/></p>
<p>共享词表 + 哈希编码：巧妙处理超大规模数据</p>
<p>和 LLM 一样，全模态生成式广告推荐的底层逻辑也是 next-token 预测，但两者面对的 token 世界规模完全不同。语言模型的词表只有十几万，而且是静态的；而在广告推荐中，如果把每个广告都视作一个 token，词表规模会迅速膨胀到千万甚至上亿级。即便在比赛这种受控环境下，广告数量也超过了 1800 万。如果为每个广告分配独立的嵌入向量，显存很快就会爆掉。</p>
<p>因此，leejt 团队在数据处理阶段做的第一件事，就是压缩词表规模。他们发现，接近一半的广告交互频次极低，既难以学到稳定表示，又大量消耗显存，于是将这些低频广告映射到共享词表中；同时再通过 ID 哈希，把原始广告 ID 压缩成更紧凑的表示。这两步基本解决了模型「训不起来」的问题。</p>
<p>此外，这里还涉及对多模态特征的取舍与压缩。面对维度极高、噪声较重的多模态向量，leejt 并没有选择直接堆进模型，而是先用 SVD 做降维去噪，再通过 RQ-KMeans 将连续向量离散为语义 ID（SID），把高维连续空间压缩成可控的离散表示。与此同时，对于缺失率高、线下验证效果不佳的模态特征，他们选择直接舍弃，而不是让模型为低质量信息付出建模成本。</p>
<p>session 划分 + 异构时序图：数据脏乱差也不怕</p>
<p>除了数据规模，真正让团队感到棘手的，还有数据本身的复杂性。</p>
<p>用户行为序列看似很长，但仔细分析会发现，很多序列其实是多个 session 拼接而成，如果不显式建模 session 边界，模型会把跨天、跨兴趣阶段的行为当成连续偏好来学，噪声极大；此外，大量商品是冷启动或低频，同时多模态特征维度高、缺失多、噪声重，如果直接输入模型，只会放大不确定性。</p>
<p>leejt 给出的解法是：主动补充序列之外的信息结构。一方面，他们通过时间特征和 session 划分，让模型知道哪些行为是「刚刚发生的」，哪些只是历史残留；另一方面，他们引入了异构时序图，把用户、广告以及语义层面的节点连接在一起。当某个用户或广告自身信息不足时，模型可以通过与其相邻的用户、相似广告和语义簇来「借信号」，用群体行为来弥补个体数据的稀疏。这一步的本质，是把原本只能在一条序列上盲猜的问题，转化成在一个关系网络中有依据地推断。</p>
<p>极致的工程优化：把 GPU 利用率拉到 100%</p>
<p>和 Echoch 团队一样，在有限的算力上训出更大更有效的模型也是 leejt 团队的核心目标。这方面，他们确实做得很成功，把模型从 4 层 512 维扩展到 8 层 2048 维，带来了百分位级别的性能提升。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29ec3c3382904a6e8ef9d3f43d4a70b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090388&amp;x-signature=kZkp4tSDw%2BKKsWa%2F2mCbYgY93VQ%3D" alt="图片" loading="lazy"/></p>
<p>团队的解法是从多个环节挤出效率空间：混合精度训练、梯度检查点、torch.compile 图编译，以及把所有数据预处理都放进 Dataloader 里让数据加载和模型计算完全并行。这套方法效果显著：每步训练时间从 3.5 秒压缩到 0.8 秒，GPU 利用率拉满到 100%，省下来的时间和空间全部用来把模型做大做深，最终验证了团队的核心信念 ——Scaling is all you need。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e499579c9d24733a5c8e764edaa74bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090388&amp;x-signature=l9tOgWi1zh17vY%2F3F94aGmwS7%2FM%3D" alt="图片" loading="lazy"/></p>
<p>腾讯广告算法大赛</p>
<p>让技术理想照进现实的起点</p>
<p>从这次比赛来看，全模态生成式广告推荐确实不是一个简单的问题。但年轻一代给出了非常有价值的思路。这些方案既有扎实的工程功底，也有对问题本质的深刻理解。</p>
<p>从业界实践来看，从判别式到生成式的演进正在平稳推进。蒋杰提到，腾讯内部已经尝试在召回和粗排阶段用生成式模型替代传统的判别式模型，并且取得了不错的效果，这些收益在财报的营收数据上也有所体现。这说明生成式推荐不只是学术界的热门话题，而是真正能落地、能创造商业价值的技术方向。</p>
<p>为了适应这种趋势，腾讯广告内部也在积极布局。蒋杰提到，未来，他们的数据将全面多模态化，内部广告系统也将全面 Agent 化。同时，为了支持整个社区的发展，腾讯广告会将本次大赛的数据开源，让更多研究者和开发者能够在真实场景的数据上探索和验证自己的想法。</p>
<p>而生成式广告推荐的想象空间，其实远超这次大赛所考察的范围。比赛关注的还是「从候选池里挑出最合适的广告」，但未来可能出现即时生成的广告 —— 不再是从现有素材中检索，而是根据用户当下的兴趣、场景、情绪，实时生成个性化的广告文案、图片甚至视频。到那时，「千人千面」才算真正名副其实。</p>
<p>当然，这中间还有很多技术难点需要克服。腾讯广告算法大赛，正是这样一个让技术理想照进现实的起点。</p>
<p>期待明年还能看到如此精彩的赛事。</p>
<p>参考链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FhlUk9P6vJk7fTir-TaVxNg" target="_blank" title="https://mp.weixin.qq.com/s/hlUk9P6vJk7fTir-TaVxNg" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/hlUk9P6vJ…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS 上架需要哪些准备，围绕证书、描述文件和上传方式等关键环节展开分析]]></title>    <link>https://juejin.cn/post/7586922268023816228</link>    <guid>https://juejin.cn/post/7586922268023816228</guid>    <pubDate>2025-12-23T10:29:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586922268023816228" data-draft-id="7586943543017963562" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS 上架需要哪些准备，围绕证书、描述文件和上传方式等关键环节展开分析"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-23T10:29:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="疯狂的程序猴"/> <meta itemprop="url" content="https://juejin.cn/user/2760245749234147"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS 上架需要哪些准备，围绕证书、描述文件和上传方式等关键环节展开分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2760245749234147/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    疯狂的程序猴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T10:29:17.000Z" title="Tue Dec 23 2025 10:29:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在不少项目中，iOS 上架被放在开发流程的末尾。功能完成、测试通过，大家自然会认为“准备工作也差不多了”。
但真正开始提交时，问题才集中出现，而且很少是代码层面的。</p>
<p>我参与过的多个项目里，上架前的准备并不是某一个步骤没做好，而是 <strong>很多小前提从来没有被明确过</strong>。</p>
<hr/>
<h2 data-id="heading-0"><strong>准备上架之前，先确认你在为哪个“应用”负责</strong></h2>
<p>在苹果体系里，一个 App 的存在并不是从代码开始的，而是从 <strong>应用标识</strong> 开始的。</p>
<p>在实际项目中，我见过不少团队直到准备上传时，才发现：</p>
<ul>
<li>当前 Bundle ID 已被历史项目占用</li>
<li>测试包和正式包共用了同一个标识</li>
<li>应用在 App Store Connect 中根本不存在</li>
</ul>
<p>这些问题并不复杂，但一旦拖到最后才发现，返工成本就会非常高。</p>
<p>在上架准备阶段，我通常会先确认 Apple Developer 账号中已经存在的应用标识情况。
在非 macOS 环境下，可以通过 <strong>开心上架（Appuploader）查看账号内的 Bundle ID 列表</strong>，提前判断是否需要新增或调整。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81cb52f874424811bc79d3cc8db91fd7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC55qE56iL5bqP54y0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090556&amp;x-signature=%2BfpDP8tMxkArfZ80G3yTb3veZGM%3D" alt="查看bid" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-1"><strong>证书是否“能用”，比是否“已创建”更重要</strong></h2>
<p>很多团队在准备上架时，会确认“证书有没有”，但很少确认“这份证书是不是适合现在用”。</p>
<p>我遇到过的情况包括：</p>
<ul>
<li>使用了开发证书生成发布包</li>
<li>证书只存在于某一台 Mac</li>
<li>构建机和上传机使用的证书不一致</li>
</ul>
<p>这些问题并不会在开发阶段明显暴露，但在上架时会集中爆发。</p>
<p>在一些跨平台或 CI 驱动的项目中，我们会通过 <strong>开心上架（Appuploader）创建 iOS 证书</strong>，直接生成 <code>.p12</code> 文件，用于构建和发布流程。
这样做的好处在于：证书不再是某一台设备的“隐性状态”，而是明确的工程资源。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4725c2a6cb5943ada19f899f6ee73261~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC55qE56iL5bqP54y0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090556&amp;x-signature=J6pd5f8OCU8WxtxJacfZbZZwrac%3D" alt="证书生成" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-2"><strong>描述文件，往往决定了“能不能安装”和“能不能提交”</strong></h2>
<p>描述文件在很多项目里存在感很低，但在上架准备阶段，它的作用非常具体。</p>
<p>我遇到过的常见问题包括：</p>
<ul>
<li>描述文件类型选错</li>
<li>描述文件绑定的 Bundle ID 与实际应用不一致</li>
<li>开发描述文件被带到了发布包中</li>
</ul>
<p>这些问题在构建阶段不一定报错，但在安装或审核阶段一定会出现异常。</p>
<p>在准备上架前，我更倾向于直接检查描述文件的内部信息，而不是反复下载。
通过 <strong>开心上架（Appuploader）查看 mobileprovision 文件内容</strong>，可以确认描述文件类型、绑定的应用标识以及使用的证书是否正确。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a04c6c9dc33049b9a0dfc2f51f6179e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC55qE56iL5bqP54y0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090556&amp;x-signature=9T9jMPIyoNsI0IRD2uAgYOxA94s%3D" alt="查看描述文件" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-3"><strong>App Store 元数据准备，常常和工程配置不同步</strong></h2>
<p>上架准备不仅是工程问题，还涉及应用信息本身。</p>
<p>我见过一些被拒案例，并不是因为功能违规，而是：</p>
<ul>
<li>应用描述与实际行为不一致</li>
<li>权限说明缺失或表述不准确</li>
<li>截图与当前版本不匹配</li>
</ul>
<p>这些问题往往出现在工程配置和运营信息由不同角色维护的项目中。
如果在准备阶段没有明确责任边界，上架时就容易出现反复。</p>
<hr/>
<h2 data-id="heading-4"><strong>上传方式，也属于“上架准备”的一部分</strong></h2>
<p>很多人会把上传当成最后一步，但在工程实践中，上传方式本身需要提前考虑。</p>
<p>常见差异包括：</p>
<ul>
<li>是否依赖 Xcode</li>
<li>是否只能在 macOS 上执行</li>
<li>是否支持失败重试</li>
</ul>
<p>在一些项目中，我们会使用 <strong>开心上架（Appuploader）的上传方式</strong>，将上传动作从 Xcode 中拆分出来，使其可以在 Windows、Linux 或 macOS 环境中执行。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6399d2bfc112435e8e4e9ecb126c83ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC55qE56iL5bqP54y0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090556&amp;x-signature=DegpVbAVeKXuDt1OXa8STtdzfWA%3D" alt="ipa上传" loading="lazy"/></p>
<p>这并不会改变苹果的审核流程，但能让上架准备更贴合团队的实际工作方式。</p>
<hr/>
<h2 data-id="heading-5"><strong>iOS 上架准备，本质是在降低不确定性</strong></h2>
<p>回顾多次发布经历，我逐渐意识到：
所谓“上架准备”，并不是多做几步操作，而是 把流程中的不确定因素尽量提前暴露出来。</p>
<p>当你在提交之前已经清楚地知道：</p>
<ul>
<li>应用身份是什么</li>
<li>用的证书和描述文件是哪一份</li>
<li>IPA 内部实际包含什么</li>
<li>上传会在哪个环境完成</li>
</ul>
<p>上架本身反而变成了一件相对平稳的事情。
上架流程参考链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.appuploader.net%2Ftutorial%2Fzh%2F1%2F1.html" target="_blank" title="https://www.appuploader.net/tutorial/zh/1/1.html" ref="nofollow noopener noreferrer">www.appuploader.net/tutorial/zh…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React/Vue 代理配置全攻略：Vite 与 Webpack 实战指南]]></title>    <link>https://juejin.cn/post/7586877892467261467</link>    <guid>https://juejin.cn/post/7586877892467261467</guid>    <pubDate>2025-12-23T10:03:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586877892467261467" data-draft-id="7586892413889855534" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React/Vue 代理配置全攻略：Vite 与 Webpack 实战指南"/> <meta itemprop="keywords" content="Vue.js,React.js"/> <meta itemprop="datePublished" content="2025-12-23T10:03:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端无涯"/> <meta itemprop="url" content="https://juejin.cn/user/3967483738859639"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React/Vue 代理配置全攻略：Vite 与 Webpack 实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3967483738859639/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端无涯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T10:03:19.000Z" title="Tue Dec 23 2025 10:03:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<blockquote>
<p>在前端开发中，<strong>跨域问题</strong>是我们绕不开的坎。浏览器的同源策略限制了不同域名、端口或协议之间的资源请求，而开发环境中前端项目（通常是<code>localhost:3000</code>/<code>localhost:5173</code>）与后端接口（如<code>http://api.example.com</code>）往往不在同一域下，直接请求会触发跨域错误。</p>
</blockquote>
<p>为了解决开发环境的跨域问题，主流的前端构建工具（Vite、Webpack）都提供了 ** 代理（Proxy）** 功能。代理的核心原理是：以构建工具启动的开发服务器作为中间层，前端请求先发送到开发服务器，再由开发服务器转发到后端接口服务器（服务器之间的请求不受同源策略限制），最后将后端响应返回给前端，从而绕过浏览器的跨域限制。</p>
<p>本文将详细讲解 React 和 Vue 两大主流框架，分别基于<strong>Vite</strong>（新一代前端构建工具）和<strong>Webpack</strong>（传统主流构建工具）的代理配置方案，涵盖基础配置、进阶场景和常见问题排查。</p>
<h2 data-id="heading-0">一、Vue 框架的代理配置</h2>
<p>Vue 项目的构建工具主要分为两种：<strong>Vite</strong>（Vue 3 推荐）和<strong>Vue CLI</strong>（基于 Webpack，Vue 2/3 都支持），两者的代理配置方式略有不同。</p>
<h3 data-id="heading-1">1.1 Vue + Vite 代理配置</h3>
<p>Vite 的代理配置在项目根目录的<code>vite.config.js</code>（或<code>vite.config.ts</code>）文件中，通过<code>server.proxy</code>选项配置。</p>
<h4 data-id="heading-2">基础配置示例</h4>
<p>假设前端项目运行在<code>http://localhost:5173</code>，后端接口地址为<code>http://localhost:8080/api</code>，我们希望将前端以<code>/api</code>开头的请求代理到后端接口。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">vue</span>()],
  <span class="hljs-comment">// 开发服务器配置</span>
  <span class="hljs-attr">server</span>: {
    <span class="hljs-attr">port</span>: <span class="hljs-number">5173</span>, <span class="hljs-comment">// 前端项目端口（默认5173，可自定义）</span>
    <span class="hljs-attr">open</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 启动时自动打开浏览器</span>
    <span class="hljs-comment">// 代理配置</span>
    <span class="hljs-attr">proxy</span>: {
      <span class="hljs-comment">// 匹配以/api开头的请求</span>
      <span class="hljs-string">'/api'</span>: {
        <span class="hljs-attr">target</span>: <span class="hljs-string">'http://localhost:8080'</span>, <span class="hljs-comment">// 后端接口的基础地址</span>
        <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 开启跨域模拟（关键：让后端认为请求来自target域名）</span>
        <span class="hljs-attr">rewrite</span>: <span class="hljs-function">(<span class="hljs-params">path</span>) =&gt;</span> path.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^/</span>api/, <span class="hljs-string">''</span>) <span class="hljs-comment">// 路径重写（可选：如果后端接口没有/api前缀，需要去掉）</span>
      }
    }
  }
})
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>配置项说明</strong>：</p>
<ul>
<li><code>target</code>：后端接口的服务器地址（必填）。</li>
<li><code>changeOrigin</code>：是否开启跨域模拟，设置为<code>true</code>时，开发服务器会在转发请求时修改<code>Host</code>请求头为<code>target</code>的域名，避免后端因域名校验拒绝请求（建议始终开启）。</li>
<li><code>rewrite</code>：路径重写函数，用于修改转发到后端的请求路径。例如前端请求<code>/api/user</code>，经过重写后会转发到<code>http://localhost:8080/user</code>（如果后端接口本身带有<code>/api</code>前缀，则不需要此配置）。</li>
</ul>
<h4 data-id="heading-3">测试效果</h4>
<p>前端发送请求：</p>
<pre><code class="hljs language-css" lang="css">// 原本需要直接请求http://localhost:<span class="hljs-number">8080</span>/api/user（跨域）
// 现在直接请求/api/user，会被代理转发
<span class="hljs-built_in">fetch</span>(<span class="hljs-string">'/api/user'</span>)
  .<span class="hljs-built_in">then</span>(res =&gt; res.<span class="hljs-built_in">json</span>())
  .<span class="hljs-built_in">then</span>(data =&gt; console.<span class="hljs-built_in">log</span>(data))
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-4">1.2 Vue + Vue CLI（Webpack）代理配置</h3>
<p>Vue CLI 基于 Webpack，其代理配置在项目根目录的<code>vue.config.js</code>文件中，通过<code>devServer.proxy</code>选项配置（底层依赖<code>webpack-dev-server</code>的 proxy 功能）。</p>
<h4 data-id="heading-5">基础配置示例</h4>
<p>需求与上述一致：将<code>/api</code>开头的请求代理到<code>http://localhost:8080</code>。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// vue.config.js</span>
<span class="hljs-keyword">module</span>.<span class="hljs-keyword">exports</span> = {
  devServer: {
    port: <span class="hljs-number">8081</span>, <span class="hljs-comment">// 前端项目端口</span>
    open: <span class="hljs-literal">true</span>,
    proxy: {
      <span class="hljs-string">'/api'</span>: {
        target: <span class="hljs-string">'http://localhost:8080'</span>,
        changeOrigin: <span class="hljs-literal">true</span>,
        pathRewrite: { <span class="hljs-string">'^/api'</span>: <span class="hljs-string">''</span> } <span class="hljs-comment">// 路径重写（与Vite的rewrite作用一致，语法不同）</span>
      }
    }
  }
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>注意</strong>：Vue CLI 的路径重写使用<code>pathRewrite</code>对象，而 Vite 使用<code>rewrite</code>函数，语法略有差异，但功能一致。</p>
<h2 data-id="heading-6">二、React 框架的代理配置</h2>
<p>React 项目的构建工具同样分为<strong>Vite</strong>（新一代）和<strong>Create React App</strong>（基于 Webpack，简称 CRA，React 官方脚手架）。</p>
<h3 data-id="heading-7">2.1 React + Vite 代理配置</h3>
<p>React + Vite 的代理配置与 Vue + Vite 完全一致，因为 Vite 的代理功能是框架无关的。</p>
<h4 data-id="heading-8">基础配置示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> react <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-react'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">react</span>()],
  <span class="hljs-attr">server</span>: {
    <span class="hljs-attr">port</span>: <span class="hljs-number">5173</span>,
    <span class="hljs-attr">proxy</span>: {
      <span class="hljs-string">'/api'</span>: {
        <span class="hljs-attr">target</span>: <span class="hljs-string">'http://localhost:8080'</span>,
        <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">rewrite</span>: <span class="hljs-function">(<span class="hljs-params">path</span>) =&gt;</span> path.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^/</span>api/, <span class="hljs-string">''</span>)
      }
    }
  }
})
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-9">2.2 React + Create React App（Webpack）代理配置</h3>
<p>CRA 隐藏了 Webpack 的核心配置，因此其代理配置分为两种方式：<strong>简单配置（package.json）<strong>和</strong>进阶配置（setupProxy.js）</strong> 。</p>
<h4 data-id="heading-10">方式 1：简单配置（package.json）</h4>
<p>适用于单一路径的代理场景，直接在<code>package.json</code>中添加<code>proxy</code>字段。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"react-app"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.1.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"private"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^18.2.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"react-dom"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^18.2.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 简单代理配置：将所有请求代理到http://localhost:8080</span>
  <span class="hljs-attr">"proxy"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://localhost:8080"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>注意</strong>：这种方式的局限性很大：</p>
<ul>
<li>只能配置一个代理目标，无法针对不同路径配置不同代理。</li>
<li>不支持路径重写、HTTPS 等进阶配置。</li>
</ul>
<h4 data-id="heading-11">方式 2：进阶配置（setupProxy.js）</h4>
<p>适用于多路径代理、路径重写等复杂场景，需要创建<code>src/setupProxy.js</code>文件，并安装<code>http-proxy-middleware</code>依赖（CRA 已内置该依赖，若未安装可手动执行<code>npm install http-proxy-middleware --save-dev</code>）。</p>
<h5 data-id="heading-12">基础配置示例（匹配 /api 路径）</h5>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// src/setupProxy.js</span>
<span class="hljs-keyword">const</span> { createProxyMiddleware } = <span class="hljs-keyword">require</span>(<span class="hljs-string">'http-proxy-middleware'</span>)

module.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">app</span>) </span>{
  app.<span class="hljs-keyword">use</span>(
    <span class="hljs-comment">// 匹配以/api开头的请求</span>
    <span class="hljs-string">'/api'</span>,
    <span class="hljs-title function_ invoke__">createProxyMiddleware</span>({
      <span class="hljs-attr">target</span>: <span class="hljs-string">'http://localhost:8080'</span>,
      <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">pathRewrite</span>: { <span class="hljs-string">'^/api'</span>: <span class="hljs-string">''</span> }
    })
  )
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h5 data-id="heading-13">多代理规则示例</h5>
<p>如果需要将<code>/api</code>代理到<code>http://localhost:8080</code>，将<code>/admin</code>代理到<code>http://localhost:9090</code>，可以配置多个代理规则：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// src/setupProxy.js</span>
<span class="hljs-keyword">const</span> { createProxyMiddleware } = <span class="hljs-keyword">require</span>(<span class="hljs-string">'http-proxy-middleware'</span>)

module.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">app</span>) </span>{
  <span class="hljs-comment">// 代理/api到8080端口</span>
  app.<span class="hljs-keyword">use</span>(
    <span class="hljs-string">'/api'</span>,
    <span class="hljs-title function_ invoke__">createProxyMiddleware</span>({
      <span class="hljs-attr">target</span>: <span class="hljs-string">'http://localhost:8080'</span>,
      <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">pathRewrite</span>: { <span class="hljs-string">'^/api'</span>: <span class="hljs-string">''</span> }
    })
  )
  <span class="hljs-comment">// 代理/admin到9090端口</span>
  app.<span class="hljs-keyword">use</span>(
    <span class="hljs-string">'/admin'</span>,
    <span class="hljs-title function_ invoke__">createProxyMiddleware</span>({
      <span class="hljs-attr">target</span>: <span class="hljs-string">'http://localhost:9090'</span>,
      <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">pathRewrite</span>: { <span class="hljs-string">'^/admin'</span>: <span class="hljs-string">''</span> }
    })
  )
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>注意</strong>：修改<code>setupProxy.js</code>后，需要重启 CRA 的开发服务器才能生效。</p>
<h2 data-id="heading-14">三、代理的进阶配置场景</h2>
<p>除了基础的代理配置，我们还会遇到一些复杂场景，比如代理 HTTPS 接口、携带 Cookie、匹配正则路径等。</p>
<h3 data-id="heading-15">3.1 代理 HTTPS 接口</h3>
<p>如果后端接口是 HTTPS 协议（如<code>https://api.example.com</code>），需要添加<code>secure: false</code>配置，忽略 SSL 证书验证（开发环境下常用，生产环境不建议）。</p>
<h4 data-id="heading-16">Vite 配置示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">proxy</span>: {
  <span class="hljs-string">'/api'</span>: {
    <span class="hljs-attr">target</span>: <span class="hljs-string">'https://api.example.com'</span>,
    <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">secure</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 忽略HTTPS证书验证</span>
    <span class="hljs-attr">rewrite</span>: <span class="hljs-function">(<span class="hljs-params">path</span>) =&gt;</span> path.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^/</span>api/, <span class="hljs-string">''</span>)
  }
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-17">Webpack（Vue CLI/CRA）配置示例</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// Vue CLI：vue.config.js</span>
proxy: {
  <span class="hljs-string">'/api'</span>: {
    target: <span class="hljs-string">'https://api.example.com'</span>,
    changeOrigin: <span class="hljs-literal">true</span>,
    secure: <span class="hljs-literal">false</span>,
    pathRewrite: { <span class="hljs-string">'^/api'</span>: <span class="hljs-string">''</span> }
  }
}

<span class="hljs-comment">// CRA：setupProxy.js</span>
<span class="hljs-title function_ invoke__">createProxyMiddleware</span>({
  <span class="hljs-attr">target</span>: <span class="hljs-string">'https://api.example.com'</span>,
  <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">secure</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">pathRewrite</span>: { <span class="hljs-string">'^/api'</span>: <span class="hljs-string">''</span> }
})
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-18">3.2 跨域携带 Cookie</h3>
<p>如果需要在跨域请求中携带 Cookie（如用户登录状态），需要同时配置前端请求的<code>withCredentials</code>和代理的<code>cookieDomainRewrite</code>。</p>
<h4 data-id="heading-19">前端请求配置</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// fetch请求</span>
fetch(<span class="hljs-string">'/api/user'</span>, {
  credentials: <span class="hljs-string">'include'</span> <span class="hljs-comment">// 携带Cookie</span>
})

<span class="hljs-comment">// axios请求</span>
axios.<span class="hljs-keyword">get</span>(<span class="hljs-string">'/api/user'</span>, {
  withCredentials: <span class="hljs-literal">true</span> <span class="hljs-comment">// 携带Cookie</span>
})
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-20">代理配置</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Vite</span>
<span class="hljs-attr">proxy</span>: {
  <span class="hljs-string">'/api'</span>: {
    <span class="hljs-attr">target</span>: <span class="hljs-string">'http://localhost:8080'</span>,
    <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">rewrite</span>: <span class="hljs-function">(<span class="hljs-params">path</span>) =&gt;</span> path.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^/</span>api/, <span class="hljs-string">''</span>),
    <span class="hljs-attr">cookieDomainRewrite</span>: <span class="hljs-string">'localhost'</span> <span class="hljs-comment">// 将后端返回的Cookie域名重写为前端域名</span>
  }
}

<span class="hljs-comment">// Webpack</span>
<span class="hljs-title function_">createProxyMiddleware</span>({
  <span class="hljs-attr">target</span>: <span class="hljs-string">'http://localhost:8080'</span>,
  <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">pathRewrite</span>: { <span class="hljs-string">'^/api'</span>: <span class="hljs-string">''</span> },
  <span class="hljs-attr">cookieDomainRewrite</span>: <span class="hljs-string">'localhost'</span>
})
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-21">3.3 正则匹配路径</h3>
<p>如果需要匹配更复杂的路径（如以<code>/api/v1</code>或<code>/api/v2</code>开头的请求），可以使用正则表达式作为代理的匹配规则。</p>
<h4 data-id="heading-22">Vite 配置示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">proxy</span>: {
  <span class="hljs-comment">// 匹配以/api/v开头的请求</span>
  <span class="hljs-string">'^/api/v\d+'</span>: {
    <span class="hljs-attr">target</span>: <span class="hljs-string">'http://localhost:8080'</span>,
    <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">rewrite</span>: <span class="hljs-function">(<span class="hljs-params">path</span>) =&gt;</span> path.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^/</span>api/, <span class="hljs-string">''</span>)
  }
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-23">Webpack（CRA）配置示例</h4>
<pre><code class="hljs language-php" lang="php">app.<span class="hljs-keyword">use</span>(
  <span class="hljs-comment">// 正则匹配/api/v1或/api/v2</span>
  /^/api/v\d+/,
  <span class="hljs-title function_ invoke__">createProxyMiddleware</span>({
    <span class="hljs-attr">target</span>: <span class="hljs-string">'http://localhost:8080'</span>,
    <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">pathRewrite</span>: { <span class="hljs-string">'^/api'</span>: <span class="hljs-string">''</span> }
  })
)
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-24">四、代理配置常见问题排查</h2>
<p>配置代理后，如果请求仍然失败，可从以下几个方面排查：</p>
<h3 data-id="heading-25">4.1 代理规则未匹配</h3>
<ul>
<li>检查前端请求的路径是否与代理的匹配规则一致（如前端请求<code>/api/user</code>，代理规则是<code>/api</code>，则匹配；若请求<code>/user</code>，则不匹配）。</li>
<li>正则匹配时，注意正则表达式的语法是否正确（如转义字符、量词等）。</li>
</ul>
<h3 data-id="heading-26">4.2 路径重写错误</h3>
<ul>
<li>如果后端接口没有<code>/api</code>前缀，但代理配置了<code>rewrite: (path) =&gt; path.replace(/^/api/, '')</code>，则前端请求<code>/api/user</code>会被转发到<code>/user</code>；若后端接口有<code>/api</code>前缀，去掉重写配置即可。</li>
<li>检查路径重写的语法（Vite 用<code>rewrite</code>函数，Webpack 用<code>pathRewrite</code>对象）。</li>
</ul>
<h3 data-id="heading-27">4.3 changeOrigin 未开启</h3>
<ul>
<li>若后端接口有域名校验（如只允许特定域名访问），未开启<code>changeOrigin: true</code>会导致后端拒绝请求，此时需要开启该配置。</li>
</ul>
<h3 data-id="heading-28">4.4 后端接口地址错误</h3>
<ul>
<li>检查<code>target</code>配置的后端地址是否正确（包括域名、端口、协议），可直接在浏览器中访问后端接口地址，确认接口是否正常。</li>
</ul>
<h3 data-id="heading-29">4.5 开发服务器未重启</h3>
<ul>
<li>修改 Vite/Vue CLI 的配置文件后，开发服务器会自动重启；但修改 CRA 的<code>setupProxy.js</code>后，需要手动重启开发服务器才能生效。</li>
</ul>
<h2 data-id="heading-30">五、总结</h2>
<p>开发环境的代理配置是解决跨域问题的最优方案，不同构建工具的配置方式虽有差异，但核心原理一致。</p>
<ul>
<li><strong>Vite</strong>：配置简洁，框架无关，通过<code>server.proxy</code>实现，支持函数式路径重写和正则匹配。</li>
<li><strong>Webpack</strong>：Vue CLI 通过<code>devServer.proxy</code>配置，CRA 则分为简单的<code>package.json</code>配置和进阶的<code>setupProxy.js</code>配置，底层依赖<code>http-proxy-middleware</code>。</li>
</ul>
<p>在实际开发中，我们可以根据项目的框架（React/Vue）和构建工具（Vite/Webpack）选择对应的配置方式，并根据业务需求添加路径重写、HTTPS 支持、Cookie 携带等进阶配置。同时，遇到问题时可按照 “规则匹配→路径重写→跨域配置→接口地址” 的顺序排查，快速定位问题。</p>
<p>最后需要注意：<strong>代理配置仅适用于开发环境</strong>，生产环境的跨域问题需要通过后端配置 CORS（跨域资源共享）或 Nginx 反向代理来解决。</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文带你了解LangChain数据容器及其使用]]></title>    <link>https://juejin.cn/post/7586687526867402767</link>    <guid>https://juejin.cn/post/7586687526867402767</guid>    <pubDate>2025-12-23T09:43:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586687526867402767" data-draft-id="7586836874016391178" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文带你了解LangChain数据容器及其使用"/> <meta itemprop="keywords" content="LangChain,Agent,AI编程"/> <meta itemprop="datePublished" content="2025-12-23T09:43:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="FreeCode"/> <meta itemprop="url" content="https://juejin.cn/user/1282499717900794"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文带你了解LangChain数据容器及其使用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1282499717900794/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    FreeCode
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T09:43:48.000Z" title="Tue Dec 23 2025 09:43:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><blockquote>
<p>在LangChain生态中，<strong>State</strong>、<strong>Runtime</strong>、<strong>RunnableConfig</strong> 是三个核心概念，分别承担状态数据容器、环境数据容器、配置数据容器的角色。
管理和使用好这些数据容器，直接影响智能体的性能表现。本文带领大家深刻理解这三个概念和它们的使用方法。</p>
</blockquote>
<h2 data-id="heading-0">一、概念解读</h2>
<h3 data-id="heading-1">1.1 状态（State）：状态数据容器</h3>
<p>State是表示智能体当前状态的内部<strong>共享数据结构</strong>。它在智能体执行步骤或节点之间传输。</p>
<h4 data-id="heading-2">1.1.1 LangChain中的状态（State）</h4>
<ol>
<li><strong>默认状态 AgentState</strong> <br/>
create_agent接口创建的Agent的默认状态是 <code>langchain.agents.AgentState</code>，它是一个只包含必要键messages的字典（dict），用于存储智能体的短期记忆。</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AgentState</span>(TypedDict, <span class="hljs-type">Generic</span>[ResponseT]):
    <span class="hljs-string">"""State schema for the agent."""</span>
    messages: Required[Annotated[<span class="hljs-built_in">list</span>[AnyMessage], add_messages]]
    jump_to: NotRequired[Annotated[JumpTo | <span class="hljs-literal">None</span>, EphemeralValue, PrivateStateAttr]]
    structured_response: NotRequired[Annotated[ResponseT, OmitFromInput]]
</code></pre>
<ol start="2">
<li>
<p><strong>自定义状态（State）</strong> <br/>
智能体默认通过消息状态自动维护对话历史。开发者也可以为智能体配置自定义状态模式，使其在对话过程中记录更多额外信息。自定义状态模式定义为一个继承AgentState的TypedDict类型，并在create_agent接口中传递给state_schema参数。</p>
<p>在LangChain 1.0中，自定义的state schemas必须是TypedDict类型，Pydantic模型和dataclass类型不再支持。此外，自定义状态还可以通过中间件实现。</p>
</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent,AgentState 

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomState</span>(<span class="hljs-title class_ inherited__">AgentState</span>):
    <span class="hljs-string">"""定制 Agent State Schema."""</span>
    counter: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span>

agent = create_agent(
    model=<span class="hljs-string">"openai:gpt-4o"</span>,
    tools=[get_weather],
    system_prompt=<span class="hljs-string">"你是一个乐于助人的个人助手。"</span>,
    state_schema=CustomState,
)
<span class="hljs-comment"># Run the agent</span>
agent.invoke(
    {<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"北京今天天气怎么样？"</span>}]}
)
</code></pre>
<h4 data-id="heading-3">1.1.2 LangGraph中的状态（State）</h4>
<p>在LangGraph中，状态类型可以是 TypedDict、dataclass 或Pydantic模型。官方推荐的图状态模式定义方式是使用TypedDict。若需在状态中设置默认值，可使用dataclass。如果需要实现递归数据验证，可以用Pydantic BaseModel定义图的状态（但需注意，Pydantic的性能要低于TypedDict 或 dataclass）。
状态的模式会作为图中所有节点（Node）与边（Edge）的输入（input）模式。所有节点（Node）都会输出状态的更新信息，这些信息随后会通过指定的归约函数进行应用于状态（State）。</p>
<p>LangGraph实现了基础的消息状态 <code>langgraph.graph.MessagesState</code>。开发者可以继承MessagesState类来自定义需要的状态。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MessagesState</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    messages: Annotated[<span class="hljs-built_in">list</span>[AnyMessage], add_messages]
</code></pre>
<h3 data-id="heading-4">1.2 运行时（Runtime）：环境数据容器</h3>
<p>LangChain通过create_agent方法创建的智能体，底层是基于LangGraph的运行时来执行的。
LangGraph对外暴露一个 <code>langgraph.runtime.Runtime</code>对象，它包含以下信息：</p>
<ul>
<li>上下文（Context）：静态信息，例如用户 ID、数据库连接，或智能体调用所需的其他依赖项。</li>
<li>存储（Store）：用于长期记忆的 BaseStore 实例。</li>
<li>流写入器（Stream writer）：用于通过自定义流模式传输信息的对象。</li>
</ul>
<h3 data-id="heading-5">1.3 运行配置（RunnableConfig）：配置数据容器</h3>
<p>LangChain框架抽象出了一个“可调用、可组合、可序列化” 的组件接口Runable，作为其最基本的工作单元。其核心定义在 langchain-core 模块中，<code>langchain_core.runnables.Runnable</code>。LangChain同时还提供了RunnableConfig类，用于配置Runnable组件的运行时参数。它位于 <code>langchain_core.runnables.RunnableConfig</code>。RunnableConfig是一个TypedDict，包含以下字段：</p>
<ol>
<li><strong>tags</strong>: list[str]   为当前调用及其所有子调用添加标签，用于过滤和分类不同的调用（比如按业务模块、用户ID、任务类型打标签）。</li>
<li><strong>metadata</strong>: dict[str, Any]  当前调用及子调用的元数据，要求键是字符串，值可JSON序列化（如字符串、数字、列表、字典）。</li>
<li><strong>callbacks</strong>: Callbacks    回调函数集合，用于监听Runnable执行的生命周期事件（启动、成功、失败、结束、工具调用等）。</li>
<li><strong>run_name</strong>: str    为当前调用的运行实例命名，默认值为当前Runnable类的名称。</li>
<li><strong>max_concurrency</strong>: int | None  控制当前调用中并行子调用的最大数量；默认为ThreadPoolExecutor的默认值（通常为CPU核心数 × 5）。</li>
<li><strong>recursion_limit</strong>: int   限制当前调用的最大递归次数，防止无限递归。默认值为 25。</li>
<li><strong>configurable</strong>: dict[str, Any]  为Runnable中预先标记为可配置的字段提供运行时动态值。可配置字段通过configurable_fields或configurable_alternatives定义，支持在运行时覆盖默认值，无需修改代码。</li>
<li><strong>run_id</strong>: uuid.UUID | None  当前调用的唯一标识（UUID），用于追踪系统中唯一识别一次运行。若未提供，LangChain 会自动生成一个新的 UUID。</li>
</ol>
<p>RunnableConfig是控制Runnable执行的核心,涵盖可观测性（tags/metadata/callbacks）、性能控制（max_concurrency/recursion_limit）、动态配置（configurable）、追踪（run_name/run_id）等维度。RunnableConfig会透传所有子调用。当前调用的配置会作用于其所有子调用（如 Chain 调用 LLM、图节点调用工具），实现全链路统一配置。</p>
<p>LangGraph是基于langchain_core模块构建的有状态图执行框架，其核心组件（如图、状态机）均实现了Runnable接口，所以LangGraph无缝兼容RunnableConfig。配置会自动传递到节点，支持节点内读取和使用。</p>
<h2 data-id="heading-6">二、数据容器传入</h2>
<h3 data-id="heading-7">2.1 LangChain中的数据容器传入</h3>
<p>在LangChain中，通过craete_agent接口的参数state_schema、context_schema、store分别传入状态、上下文、存储的定义。
通过智能体的调用方法invoke/ainvoke,stream/astream, batch/abatch等传入初始的状态、运行配置、上下文数据。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> TypedDict
<span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnableConfig
<span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> ToolMessage
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent, AgentState
<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool, ToolRuntime
<span class="hljs-keyword">from</span> langgraph.types <span class="hljs-keyword">import</span> Command
<span class="hljs-keyword">from</span> langgraph.checkpoint.memory <span class="hljs-keyword">import</span> InMemorySaver
<span class="hljs-keyword">from</span> langgraph.store.memory <span class="hljs-keyword">import</span> InMemoryStore
<span class="hljs-keyword">from</span> model <span class="hljs-keyword">import</span> model


<span class="hljs-comment"># 自定义状态</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomState</span>(<span class="hljs-title class_ inherited__">AgentState</span>):
    <span class="hljs-string">"""定制 Agent State Schema."""</span>
    counter: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span>
<span class="hljs-comment"># 自定义上下文</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomContext</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    <span class="hljs-string">"""定制 Runtime Context Schema."""</span>
    user_id: <span class="hljs-built_in">str</span>
<span class="hljs-comment"># 工具</span>
<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">counter</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span>, runtime: ToolRuntime</span>) -&gt; Command:
    <span class="hljs-string">"""用户消息接收次数计数器：每次接收到用户消息调用此工具。"""</span>
    <span class="hljs-keyword">if</span> query.strip() != <span class="hljs-string">""</span>:
        runtime.state[<span class="hljs-string">"counter"</span>] += <span class="hljs-number">1</span>
        store = runtime.store
        store.put((<span class="hljs-string">"users"</span>,), runtime.context[<span class="hljs-string">"user_id"</span>], {<span class="hljs-string">"counter"</span>: runtime.state[<span class="hljs-string">"counter"</span>]})
        info=store.get((<span class="hljs-string">"users"</span>,), runtime.context[<span class="hljs-string">"user_id"</span>])
        <span class="hljs-built_in">print</span>(info)
    <span class="hljs-keyword">return</span> Command (update={<span class="hljs-string">"messages"</span>: [ToolMessage(<span class="hljs-string">"消息次数记录成功！"</span>, tool_call_id=runtime.tool_call_id)], <span class="hljs-string">"counter"</span>: runtime.state[<span class="hljs-string">"counter"</span>]})

<span class="hljs-comment"># 创建智能体</span>
agent = create_agent(
    model=model,
    tools=[counter],
    system_prompt=<span class="hljs-string">"你是一个个人助手"</span>,
    state_schema=CustomState,         <span class="hljs-comment"># 指定状态模型</span>
    context_schema=CustomContext,     <span class="hljs-comment"># 指定上下文模型</span>
    checkpointer=InMemorySaver(),     <span class="hljs-comment"># 设置检查点</span>
    store=InMemoryStore(),            <span class="hljs-comment"># 存储（长期记忆）</span>
)

<span class="hljs-comment"># 创建运行配置</span>
config=RunnableConfig(
    tags=[<span class="hljs-string">"user-123"</span>],
    metadata={<span class="hljs-string">"source"</span>: <span class="hljs-string">"user-input"</span>},
    run_name=<span class="hljs-string">"user-query"</span>,
    configurable={<span class="hljs-string">"thread_id"</span>: <span class="hljs-string">"1"</span>},
)
<span class="hljs-comment"># 初始状态</span>
init_state = CustomState(
        messages=[{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你好"</span>}], 
        counter=<span class="hljs-number">0</span>
    )
<span class="hljs-comment"># 上下文</span>
context = CustomContext(user_id=<span class="hljs-string">"123"</span>)

<span class="hljs-comment"># 调用智能体</span>
result = agent.invoke(
    <span class="hljs-built_in">input</span>=init_state,
    config=config,
    context=context,
)
<span class="hljs-comment"># 打印结果</span>
<span class="hljs-keyword">for</span> key,value <span class="hljs-keyword">in</span> result.items():
    <span class="hljs-keyword">if</span> key == <span class="hljs-string">"messages"</span>:
        <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> value:
            msg.pretty_print()
    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span>(key, value)
</code></pre>
<h3 data-id="heading-8">2.2 LangGraph中的数据容器传入</h3>
<p>在LangGraph中，通过StateGraph传入state_schema、context_schema；通过compile方法传入store对象。
通过图的调用方法invoke/ainvoke,stream/astream, batch/abatch等传入初始的状态、运行配置、上下文数据。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> TypedDict
<span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnableConfig
<span class="hljs-keyword">from</span> langchain.messages <span class="hljs-keyword">import</span> AIMessage, HumanMessage
<span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> MessagesState, StateGraph, START, END
<span class="hljs-keyword">from</span> langgraph.runtime <span class="hljs-keyword">import</span> Runtime
<span class="hljs-keyword">from</span> langgraph.store.memory <span class="hljs-keyword">import</span> InMemoryStore
<span class="hljs-keyword">from</span> langgraph.checkpoint.memory <span class="hljs-keyword">import</span> InMemorySaver
<span class="hljs-keyword">from</span> model <span class="hljs-keyword">import</span> model


<span class="hljs-comment"># 自定义图状态</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyGraphState</span>(<span class="hljs-title class_ inherited__">MessagesState</span>):
    <span class="hljs-string">"""MyGraphState"""</span>
    counter: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span>
<span class="hljs-comment"># 自定义上下文</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyContext</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    <span class="hljs-string">"""MyContext"""</span>
    user_id: <span class="hljs-built_in">str</span>
<span class="hljs-comment"># 自定义输出格式</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyStructuredOutput</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    <span class="hljs-string">"""MyStructedOutput"""</span>
    response: <span class="hljs-built_in">str</span>
    user_id: <span class="hljs-built_in">str</span>

<span class="hljs-comment"># 定义Node</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">node_1</span>(<span class="hljs-params">state: MyGraphState, runtime: Runtime, config: RunnableConfig</span>) -&gt; MyGraphState:
    <span class="hljs-string">"""node_1"""</span>
    state[<span class="hljs-string">"counter"</span>] += <span class="hljs-number">1</span>
    user_id = runtime.context[<span class="hljs-string">"user_id"</span>]
    thread_id = config[<span class="hljs-string">"configurable"</span>][<span class="hljs-string">"thread_id"</span>]
    store = runtime.store
    store.put((<span class="hljs-string">"users"</span>,),user_id,{<span class="hljs-string">"thread_id"</span>:thread_id, <span class="hljs-string">"counter"</span>:state[<span class="hljs-string">"counter"</span>]})
    state[<span class="hljs-string">"messages"</span>].append(AIMessage(content=<span class="hljs-string">f"user_id为<span class="hljs-subst">{user_id}</span>的用户的消息次数记录成功！"</span>))
    <span class="hljs-built_in">print</span>(store.get((<span class="hljs-string">"users"</span>,),user_id))
    <span class="hljs-keyword">return</span> state
<span class="hljs-keyword">def</span> <span class="hljs-title function_">node_2</span>(<span class="hljs-params">state: MyGraphState, runtime: Runtime, config: RunnableConfig</span>) -&gt; MyGraphState:
    <span class="hljs-string">"""node_2"""</span>
    user_id = runtime.context[<span class="hljs-string">"user_id"</span>]
    thread_id = config[<span class="hljs-string">"configurable"</span>][<span class="hljs-string">"thread_id"</span>]
    store = runtime.store
    user_data = store.get((<span class="hljs-string">"users"</span>,),user_id)
    <span class="hljs-keyword">if</span> user_data <span class="hljs-keyword">and</span> user_data.value[<span class="hljs-string">"thread_id"</span>] == thread_id <span class="hljs-keyword">and</span> state[<span class="hljs-string">"counter"</span>] &lt; <span class="hljs-number">10</span>:
        structed_model = model.with_structured_output(MyStructuredOutput)
        prompt = <span class="hljs-string">" "</span>.join([msg.content <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> state[<span class="hljs-string">"messages"</span>]])
        response = structed_model.invoke(prompt)
        state[<span class="hljs-string">"messages"</span>].append(AIMessage(content=response[<span class="hljs-string">"response"</span>]))
    <span class="hljs-keyword">return</span> state

<span class="hljs-comment"># 构建图</span>
graph = StateGraph(state_schema=MyGraphState,context_schema=MyContext)
graph.add_node(node_1)
graph.add_node(node_2)
graph.add_edge(START, <span class="hljs-string">"node_1"</span>)
graph.add_edge(<span class="hljs-string">"node_1"</span>, <span class="hljs-string">"node_2"</span>)
graph.add_edge(<span class="hljs-string">"node_2"</span>, END)

<span class="hljs-comment">#编译图</span>
agent = graph.<span class="hljs-built_in">compile</span>(checkpointer=InMemorySaver(), store=InMemoryStore())

<span class="hljs-comment"># 创建运行配置</span>
config=RunnableConfig(
    tags=[<span class="hljs-string">"user-123"</span>],
    metadata={<span class="hljs-string">"source"</span>: <span class="hljs-string">"user-input"</span>},
    run_name=<span class="hljs-string">"user-query"</span>,
    configurable={<span class="hljs-string">"thread_id"</span>: <span class="hljs-string">"1"</span>},
)

<span class="hljs-comment"># 调用</span>
result = agent.invoke(
    <span class="hljs-built_in">input</span>={<span class="hljs-string">"messages"</span>: [HumanMessage(content=<span class="hljs-string">"你好"</span>)], <span class="hljs-string">"counter"</span>: <span class="hljs-number">0</span>},
    config=config,
    context={<span class="hljs-string">"user_id"</span>: <span class="hljs-string">"user_123"</span>},
)

<span class="hljs-comment"># 打印结果</span>
<span class="hljs-keyword">for</span> key,value <span class="hljs-keyword">in</span> result.items():
    <span class="hljs-keyword">if</span> key == <span class="hljs-string">"messages"</span>:
        <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> value:
            msg.pretty_print()
    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span>(key, value)

</code></pre>
<h2 data-id="heading-9">三、访问数据容器</h2>
<h3 data-id="heading-10">3.1 工具（Tools）访问</h3>
<p>在LangChain中，工具可以通过 <code>langchain.tools.ToolRuntime</code>访问运行时信息。ToolRuntime作为统一的工具参数，可使工具获取状态、配置、工具调用ID、上下文、存储、流式输出这些运行时信息。
在工具函数签名中注入runtime:ToolRuntime参数，即可在函数内部引用相关信息，如runtime.state、runtime.context、runtime.config等。可以访问的信息如下：</p>
<ul>
<li><code>context</code>: Runtime context (from langgraph <code>Runtime</code>)</li>
<li><code>store</code>: <code>BaseStore</code> instance for persistent storage (from langgraph <code>Runtime</code>)</li>
<li><code>stream_writer</code>: <code>StreamWriter</code> for streaming output (from langgraph <code>Runtime</code>)</li>
<li><code>state</code>: The current graph state</li>
<li><code>tool_call_id</code>: The ID of the current tool call</li>
<li><code>config</code>: <code>RunnableConfig</code> for the current execution</li>
</ul>
<p>注意：ToolRuntime中的context、store、stream_writer来自LangGraph的Runtime对象。</p>
<p>示例代码可参考2.1节的案例。</p>
<h3 data-id="heading-11">3.2 中间件（Middleware）访问</h3>
<p>LangChain的中间件可以在每个步骤控制和定制智能体的执行过程。中间件提供两种类型的钩子用于植入智能体的执行过程：</p>
<ul>
<li>节点类型钩子，如before_agent, before_model, after_model, after_agent；</li>
<li>包裹类型钩子，如wrap_model_call, wrap_tool_call。</li>
</ul>
<p>节点类型的中间件接收state和runtime参数作为其输入，返回State更新或<code>Command</code>。对于包裹型中间件，wrap_model_call类型的接收ModelRequest和handler参数作为其输入，返回<code>ModelResponse</code> 或 <code>AIMessage</code>；wrap_tool_call类型的接收ToolCallRequest和handler参数作为其输入，返回 <code>ToolMessage</code> 或 <code>Command</code>。ModelRequest和ToolCallRequest中包含了state和runtime信息。
<strong>特别要注意的是，中间件不支持访问RunnableConfig</strong>。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass
<span class="hljs-keyword">from</span> collections.abc <span class="hljs-keyword">import</span> <span class="hljs-type">Callable</span>
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent, AgentState
<span class="hljs-keyword">from</span> langchain.agents.middleware <span class="hljs-keyword">import</span> dynamic_prompt, ModelRequest, before_model, after_model, wrap_model_call, wrap_tool_call
<span class="hljs-keyword">from</span> langchain.tools.tool_node <span class="hljs-keyword">import</span> ToolCallRequest
<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> ToolMessage
<span class="hljs-keyword">from</span> langgraph.runtime <span class="hljs-keyword">import</span> Runtime
<span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnableConfig
<span class="hljs-keyword">from</span> model <span class="hljs-keyword">import</span> model

<span class="hljs-comment"># 上下文</span>
<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Context</span>:
    user_name: <span class="hljs-built_in">str</span>

<span class="hljs-comment"># 工具</span>
<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">think_tool</span>(<span class="hljs-params">thought: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""在回答问题前先进行思考"""</span>
    <span class="hljs-keyword">return</span> thought

<span class="hljs-comment"># Dynamic prompts（dynamic_prompt为wrap_model_call的子类）</span>
<span class="hljs-meta">@dynamic_prompt</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">dynamic_system_prompt</span>(<span class="hljs-params">request: ModelRequest</span>) -&gt; <span class="hljs-built_in">str</span>:
    user_name = request.runtime.context.user_name  
    system_prompt = <span class="hljs-string">f"You are a helpful assistant. Address the user as <span class="hljs-subst">{user_name}</span>. you must use think_tool before you answer the questions."</span>
    <span class="hljs-keyword">return</span> system_prompt

<span class="hljs-meta">@wrap_model_call</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">modify_model_call</span>(<span class="hljs-params">request: ModelRequest, handler: <span class="hljs-type">Callable</span></span>) -&gt; <span class="hljs-built_in">dict</span> | <span class="hljs-literal">None</span>:
    <span class="hljs-comment"># 从配置中获取线程ID</span>
    user_name = request.runtime.context.user_name
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Modifying model call for user: <span class="hljs-subst">{user_name}</span>"</span>)
    result = handler(request)
    <span class="hljs-keyword">return</span> result

<span class="hljs-meta">@wrap_tool_call</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">modify_tool_call</span>(<span class="hljs-params">request: ToolCallRequest, handler: <span class="hljs-type">Callable</span></span>) -&gt; ToolMessage:
    <span class="hljs-comment"># 从配置中获取线程ID</span>
    user_name = request.runtime.context.user_name
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Modifying tool call for user: <span class="hljs-subst">{user_name}</span>"</span>)
    result = handler(request)
    <span class="hljs-keyword">return</span> result


<span class="hljs-comment"># Before model hook</span>
<span class="hljs-meta">@before_model</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">log_before_model</span>(<span class="hljs-params">state: AgentState, runtime: Runtime</span>) -&gt; <span class="hljs-built_in">dict</span> | <span class="hljs-literal">None</span>:  
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Processing request for user: <span class="hljs-subst">{runtime.context.user_name}</span>"</span>)  
    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

<span class="hljs-comment"># After model hook</span>
<span class="hljs-meta">@after_model</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">log_after_model</span>(<span class="hljs-params">state: AgentState, runtime: Runtime</span>) -&gt; <span class="hljs-built_in">dict</span> | <span class="hljs-literal">None</span>:  
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Completed request for user: <span class="hljs-subst">{runtime.context.user_name}</span>"</span>)  
    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

<span class="hljs-comment"># 创建智能体</span>
agent = create_agent(
    model,
    tools=[think_tool],
    middleware=[dynamic_system_prompt, log_before_model, modify_model_call, modify_tool_call, log_after_model],  
    context_schema=Context
)

<span class="hljs-comment"># 创建运行配置</span>
config=RunnableConfig(
    tags=[<span class="hljs-string">"user-123"</span>],
    metadata={<span class="hljs-string">"source"</span>: <span class="hljs-string">"user-input"</span>},
    run_name=<span class="hljs-string">"user-query"</span>,
    configurable={<span class="hljs-string">"thread_id"</span>: <span class="hljs-string">"1"</span>},
)

<span class="hljs-comment"># 调用</span>
result = agent.invoke(
    {<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"What's my name?"</span>}]},
    config,
    context=Context(user_name=<span class="hljs-string">"John Smith"</span>)
)

<span class="hljs-comment"># 打印结果</span>
<span class="hljs-built_in">print</span>(result[<span class="hljs-string">"messages"</span>][-<span class="hljs-number">1</span>].content)

</code></pre>
<h3 data-id="heading-12">3.3 节点访问</h3>
<p>节点本质上是一个Python函数，它接收state、runtime、config等参数作为输入。
因此节点函数可以在其内部方便的访问状态、运行时信息、配置等数据。
节点函数的返回值通常是更新后的状态。
代码示例可参考2.2节的案例。</p>
<h2 data-id="heading-13">四、总结</h2>
<h3 data-id="heading-14">4.1 核心定位与本质</h3>
<p>三者的<strong>本质身份</strong>和<strong>核心使命</strong>，这是理解差异的基础：</p>





























<table><thead><tr><th>概念</th><th>核心定位</th><th>本质类型</th><th>类比（便于理解）</th></tr></thead><tbody><tr><td><strong>State</strong></td><td>图的<strong>数据载体</strong>，存储图执行过程中的所有状态数据，是节点间通信的唯一媒介。</td><td>通常为<strong>TypedDict（字典）</strong> 或 <code>dataclass</code>（Pydantic 模型），支持结构化数据定义。</td><td>程序中的“变量/数据库”，存数据</td></tr><tr><td><strong>RunnableConfig</strong></td><td>图/节点的<strong>配置载体</strong>，传递静态/运行时的配置信息，是跨 LangChain/LangGraph 的通用配置结构。</td><td>本质是<strong>Python 字典</strong>（带类型提示的 <code>RunnableConfig</code> 类型），包含回调、标签、线程 ID 等配置项。</td><td>程序的“配置文件/命令行参数”</td></tr><tr><td><strong>Runtime</strong></td><td>图的<strong>执行环境信息</strong>，管理运行时资源与执行流程，是图运行的“底层支撑”。</td><td>LangGraph 内置的<strong>Runtime 类实例</strong>，包含存储、缓存、流写入器等资源。</td><td>程序的“操作系统/运行时环境”</td></tr></tbody></table>
<h3 data-id="heading-15">4.2 关键维度深度对比</h3>















































<table><thead><tr><th>对比维度</th><th>State（状态）</th><th>RunnableConfig（配置）</th><th>Runtime(运行时)</th></tr></thead><tbody><tr><td><strong>生命周期</strong></td><td>与<strong>图的单次执行会话</strong>绑定：从图启动开始创建，到执行结束销毁（或持久化）；节点每次调用都会接收/修改 State。</td><td>与<strong>单次节点/图调用</strong>绑定：可全局传递（整个图共用），也可按节点/请求单独指定；调用结束后配置失效。</td><td>与<strong>图的编译/实例化</strong>绑定：编译图时创建 Runtime 实例，直到图对象被销毁；同一 Runtime 可支撑多次图执行。</td></tr><tr><td><strong>核心作用</strong></td><td>1. 存储节点的输入/输出数据；<br/> 2. 作为节点间数据传递的唯一媒介；<br/> 3. 决定图的分支走向（如条件边的判断依据）。</td><td>1. 传递回调函数（监控执行过程）；<br/> 2. 传递元数据（线程 ID、用户 ID、标签）；<br/> 3. 配置缓存策略、并发限制。</td><td>1. 管理运行时资源（存储、流写入器）；<br/> 2. 提供上下文环境；<br/> 3. 处理持久化、并行执行、事件流等底层能力。</td></tr><tr><td><strong>数据流向</strong></td><td><strong>节点间双向流动</strong>：节点读取 State 中的数据，修改后返回新的 State 供下一个节点使用。</td><td><strong>自上而下传递</strong>：从图的调用方传递到节点，节点仅读取配置，一般不修改（特殊场景可动态更新）。</td><td><strong>全局静态存在</strong>：节点可读取 Runtime 中的资源（如缓存、存储），但不能修改 Runtime 本身的核心属性。</td></tr><tr><td><strong>可修改性</strong></td><td><strong>高度可修改</strong>：节点的核心逻辑就是修改 State（如新增/更新字段），是图的“可变数据层”。</td><td><strong>几乎不可修改</strong>：节点仅读取配置项，修改配置无实际意义（配置是单次调用的静态参数）。</td><td><strong>不可修改</strong>：Runtime 是执行环境，节点仅使用其提供的资源，不修改 Runtime 实例。</td></tr><tr><td><strong>典型属性/字段</strong></td><td>业务相关的自定义字段（如 <code>user_query</code>、<code>tool_results</code>、<code>agent_answer</code>）。</td><td><code>callbacks</code>（回调）、<code>tags</code>（标签）、<code>metadata</code>（元数据）、<code>thread_id</code>（线程 ID）。</td><td><code>store</code>（键值存储）、<code>stream_writer</code>（流写入器）、<code>context</code>（运行时上下文）。</td></tr><tr><td><strong>定义方式</strong></td><td>由用户<strong>自定义结构化类型</strong>（如 TypedDict 定义字段名和类型）。</td><td>由用户<strong>按框架规范组装字典</strong>（可使用 LangChain 的 <code>RunnableConfig</code> 类型提示）。</td><td>由 LangGraph<strong>内置实现</strong>，用户仅在编译图时指定配置（如缓存、存储），可自定义上下文。</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[开发调试与生产分析的利器：MyBatis SQL日志合并插件，让复杂日志秒变可执行SQL]]></title>    <link>https://juejin.cn/post/7586869907066290211</link>    <guid>https://juejin.cn/post/7586869907066290211</guid>    <pubDate>2025-12-23T10:34:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586869907066290211" data-draft-id="7586610067568951296" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="开发调试与生产分析的利器：MyBatis SQL日志合并插件，让复杂日志秒变可执行SQL"/> <meta itemprop="keywords" content="后端,Chrome,MyBatis"/> <meta itemprop="datePublished" content="2025-12-23T10:34:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一灰灰"/> <meta itemprop="url" content="https://juejin.cn/user/377887729916126"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            开发调试与生产分析的利器：MyBatis SQL日志合并插件，让复杂日志秒变可执行SQL
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/377887729916126/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一灰灰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T10:34:58.000Z" title="Tue Dec 23 2025 10:34:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cabdd940b674c26bdcb1e0fecf689db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54Gw54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090897&amp;x-signature=R52jnuTnTQ3FSVpN8bLqN6PzL8Y%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">一、开篇</h2>
<p>在Java开发的世界里，MyBatis作为最受欢迎的ORM框架之一，为我们提供了灵活的SQL操作能力。然而，伴随着这种灵活性，也带来了一个让人头疼的问题：当应用在开发或生产环境中遇到SQL相关问题时，如何快速定位和分析那些被参数化的SQL日志？</p>
<p>相信各位javaer都会有类似的经历：面对控制台中输出的MyBatis日志，看到类似"Preparing: SELECT * FROM user WHERE id = ? AND status = ?"和"Parameters: 123(Long), active(String)"这样的信息，却需要手动将参数值代入SQL模板中，才能知道这条SQL实际执行的是什么？这个过程不仅繁琐，而且容易出错，尤其是在处理复杂查询时。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/799c2105406e49cda8456c9435511feb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54Gw54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090897&amp;x-signature=6Wj3NvkOm7YKdbc8nEdlcjKu9hY%3D" alt="" loading="lazy"/></p>
<p>下面给大家推荐一个能彻底解决这个问题的神器——MyBatis SQL Log Merger插件，它不仅能大幅提升开发调试效率，更是生产环境SQL分析的得力助手。</p>
<h2 data-id="heading-1">二、场景痛点分析</h2>
<h3 data-id="heading-2">1. 开发阶段痛点</h3>
<p>在开发过程中，我们经常需要验证SQL的正确性，分析查询性能，或者调试业务逻辑。传统的做法是：</p>
<ol>
<li>从日志中复制SQL模板和参数信息</li>
<li>手动将参数值代入SQL模板中</li>
<li>将完整的SQL粘贴到数据库客户端执行</li>
<li>分析执行结果</li>
</ol>
<p>这个过程不仅耗时，而且容易出错，特别是当SQL包含大量参数或复杂条件时。</p>
<h3 data-id="heading-3">2. 生产阶段痛点</h3>
<p>在生产环境中，这个问题更加突出。当系统出现性能问题或异常时，比如现在出现了一个慢SQL，但是面对控制台上输出的SQL模板和传参，需要快速分析MyBatis日志，但：</p>
<ol>
<li>生产环境的SQL通常更加复杂，尤其是涉及多个表关联的场景</li>
<li>不能直接在生产数据库中执行可能影响业务的SQL（业务重放可能加剧问题的影响面）</li>
<li>需要将生产日志带回安全环境进行分析</li>
<li>手动还原SQL既耗时又可能引入错误</li>
</ol>
<p>这些痛点严重影响了问题排查效率，延长了故障恢复时间；同时也极大的降低了程序员的幸福指数</p>
<h2 data-id="heading-4">三、插件核心功能介绍</h2>
<p>MyBatis SQL Log Merger插件正是为了解决这些痛点而生</p>
<h3 data-id="heading-5">1. 一键将MyBatis日志转换为可执行SQL</h3>
<p>只需将MyBatis日志复制到插件中，即可一键生成完整的、可直接执行的SQL语句。插件会自动识别SQL模板和参数信息，并将参数值正确地代入SQL中。</p>
<p>如在监控的网页上，开启SQL提取功能，选中sql模板和sql传参，直接生成对应的sql；更能一键导航到您配置的sql管理工具站点</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bdb6cc475137488a85c040ba555a784e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54Gw54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090897&amp;x-signature=SXGcDlq4oOn%2Bt7iLeG2pgUx3jLo%3D" alt="00.gif" loading="lazy"/></p>
<h3 data-id="heading-6">2. 独立的SQL合成工具页</h3>
<p>除了上面的在目标网站上注入合成按钮之外，这个插件还提供了一个独立的页面，适用于从非浏览器场景获取Mybatis执行日志的场景，如 IDEA 的控制台日志：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed38fe4512ff4b58a32e1afbab4eef6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54Gw54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090897&amp;x-signature=kJYAPPNlqNvA7ITfMx3fyERPSUE%3D" alt="01.gif" loading="lazy"/></p>
<p>在这个独立的SQL合成工具页中，提供了两种输入方式</p>
<ul>
<li><strong>单框模式</strong>：适用于完整的MyBatis日志，插件自动解析SQL模板和参数</li>
<li><strong>双框模式</strong>：分别输入SQL模板和参数信息，提供更精确的控制</li>
</ul>

















<table><thead><tr><th>输入模式</th><th>示例图</th></tr></thead><tbody><tr><td>单框模式</td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6951e1c9f8ac4f3aba8b4867492b6bf2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54Gw54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090897&amp;x-signature=k26aJRrzYUmxAWu9T%2BIqJqP7Ccg%3D" alt="" loading="lazy"/> <br/> <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/158df85e97fa4ca09b857d1a1ae0abaf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54Gw54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090897&amp;x-signature=CQUdhcyPyzZ3qQIrLfpNhLMk0Mo%3D" alt="" loading="lazy"/></td></tr><tr><td>双框模式</td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3aef7fd95151421ca3c1a682c90bc0a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54Gw54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090897&amp;x-signature=Iuh3k2fd0g4QCPqi3ewfOy3ALqk%3D" alt="" loading="lazy"/></td></tr></tbody></table>
<h3 data-id="heading-7">3. SQL格式化与语法高亮</h3>
<p>生成的SQL支持进行格式化，提高可读性，并提供语法高亮功能，方便快速识别SQL结构和潜在问题；生成的SQL可以通过一键复制到剪贴板，方便粘贴到数据库客户端或其他工具中执行。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f2a9f869e94413db0c0e44808cb0a79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54Gw54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090897&amp;x-signature=ddsStxTBsyquHR7ouQ9pmmTp60o%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">4. 本地处理，保障数据安全</h3>
<p>所有处理都在浏览器本地进行，无需上传任何数据到服务器，确保敏感的SQL信息不会泄露，特别适合处理生产环境日志。</p>
<h3 data-id="heading-9">5. 插件优势</h3>
<ul>
<li>提升开发效率
<ul>
<li>通过自动化处理SQL日志，插件可以将原本需要几分钟的手动操作缩短到几秒钟，大幅提升开发效率。开发人员可以将更多时间专注于业务逻辑的实现，而不是繁琐的日志分析。</li>
</ul>
</li>
<li>支持生产环境安全分析
<ul>
<li>插件的本地处理特性使其非常适合分析生产环境日志。无需将敏感数据上传到任何服务器，确保数据安全，同时又能高效地进行SQL分析。</li>
</ul>
</li>
<li>数据本地处理，无泄漏风险
<ul>
<li>所有处理都在浏览器本地完成，没有任何数据传输，完全避免了敏感SQL信息泄露的风险，符合企业安全要求。</li>
</ul>
</li>
<li>多语言支持
<ul>
<li>插件支持中英文界面，满足国际化团队的需求，让不同语言背景的开发人员都能方便使用。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-10">四、使用方法详解</h2>
<h3 data-id="heading-11">1. 开发场景应用</h3>
<p>在开发环境中使用MyBatis SQL Log Merger非常简单：</p>
<ol>
<li><strong>安装插件</strong>：从Chrome应用商店安装 <a href="https://link.juejin.cn?target=https%3A%2F%2Fchromewebstore.google.com%2Fdetail%2Fmybatis-sql-log-merger%2Fldlekpjpadmkfoohidfgjjcmegdbkbho" target="_blank" title="https://chromewebstore.google.com/detail/mybatis-sql-log-merger/ldlekpjpadmkfoohidfgjjcmegdbkbho" ref="nofollow noopener noreferrer">MyBatis SQL Log Merger</a></li>
<li><strong>获取日志</strong>：从IDE控制台或日志文件中复制MyBatis的DEBUG级别日志</li>
<li><strong>粘贴处理</strong>：打开插件界面，粘贴日志内容，点击"Process SQL/处理SQL"</li>
<li><strong>验证结果</strong>：查看生成的完整SQL，如有需要可复制到数据库客户端执行</li>
</ol>
<p>这种方式可以大大加快SQL验证和调试的速度。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3c7e82b556d447f8a2cf2a8f2652815~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54Gw54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090897&amp;x-signature=Gpa3vZZ2mMDXhYAeAg2fF3fy%2FQ8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">2. 生产场景应用</h3>
<p>在生产环境中分析日志时，可以这样使用(对于有网页可以直接查看服务日志的场景)</p>
<ol>
<li><strong>SQL日志查询网页</strong>：安装插件之后，建议将插件固定到外部工具栏；然后导航到目标网站</li>
<li><strong>激活提取SQL按钮</strong>：点击 Chrome 工具栏中的 <code>MyBatis SQL Log Merger</code> 图标，在弹出窗口中，点击非活动状态指示器旁边的"注入 SQL 提取按钮"切换开关</li>
<li><strong>复制SQL</strong>：直接复制包含SQL模板和SQL参数的两行日志</li>
<li><strong>提取SQL</strong>：点击右小角的提取SQL按钮，将自动得到可执行的SQL语句</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/124f5588c1804ffaa4e4cae41aad120c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54Gw54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090897&amp;x-signature=UYZTcA7SRNmqy975ktm6TXFrfys%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c268ce3f080348d880eba4fd1049e603~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54Gw54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090897&amp;x-signature=nXDxdqtxGdbNkNolFTRtTdC0Uaw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c1d6525874746d7b441088357c01967~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54Gw54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090897&amp;x-signature=qLRKnCXbexPfj6vpkc4bxPU%2FB4s%3D" alt="" loading="lazy"/></p>
<p>这种方式既保证了生产数据的安全，又能高效地进行SQL分析。</p>
<h3 data-id="heading-13">3. 不同日志格式的支持</h3>
<p>插件支持多种MyBatis日志格式：</p>
<ul>
<li>标准MyBatis日志格式</li>
<li>带"Preparing:"和"Parameters:"前缀的日志</li>
<li>不同日志框架（Log4j、Logback等）的输出格式</li>
<li>自定义日志格式</li>
</ul>
<h2 data-id="heading-14">五、小结</h2>
<p>这个插件的优势还是比较明显的，MyBatis SQL Log Merger插件是一个真正解决开发和运维痛点的工具。它不仅在开发阶段能大幅提升调试效率，在生产环境中也能帮助快速定位和分析SQL相关问题。强烈推荐给每一个有需要的javer开发小伙伴🙂，有兴趣的小伙伴可以直接在谷歌浏览器上点进行下载体验</p>
<ul>
<li>主页：<a href="https://link.juejin.cn?target=https%3A%2F%2Fai.hhui.top%2Fmybatislog%2Findex.html" target="_blank" title="https://ai.hhui.top/mybatislog/index.html" ref="nofollow noopener noreferrer">MyBatis SQL 日志合并工具</a></li>
<li>谷歌插件商店：<a href="https://link.juejin.cn?target=https%3A%2F%2Fchromewebstore.google.com%2Fdetail%2Fmybatis-sql-log-merger%2Fldlekpjpadmkfoohidfgjjcmegdbkbho" target="_blank" title="https://chromewebstore.google.com/detail/mybatis-sql-log-merger/ldlekpjpadmkfoohidfgjjcmegdbkbho" ref="nofollow noopener noreferrer">Chrome商店下载地址</a></li>
<li>项目源码： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliuyueyi%2Fai-chrome-mysql-merge" target="_blank" title="https://github.com/liuyueyi/ai-chrome-mysql-merge" ref="nofollow noopener noreferrer">ai-chrome-mysql-merge</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS CPU 占用率在性能问题中的表现形式]]></title>    <link>https://juejin.cn/post/7586869907066339363</link>    <guid>https://juejin.cn/post/7586869907066339363</guid>    <pubDate>2025-12-23T10:38:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586869907066339363" data-draft-id="7586973107321552936" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS CPU 占用率在性能问题中的表现形式"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-23T10:38:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我是谁的程序员"/> <meta itemprop="url" content="https://juejin.cn/user/2390811467846089"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS CPU 占用率在性能问题中的表现形式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2390811467846089/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我是谁的程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T10:38:37.000Z" title="Tue Dec 23 2025 10:38:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在不少性能讨论里，<strong>iOS CPU 占用率</strong>常被当成一个直观指标：数值高了就是问题，低了就算安全。
但真正参与过线上问题排查之后，会发现这种理解过于粗糙。</p>
<p>我第一次真正被 CPU 占用率困住，并不是因为它“飙到了一个夸张的数”，而是因为——
<strong>它看起来不高，却始终维持在一个不该出现的水平。</strong></p>
<hr/>
<h2 data-id="heading-0">CPU 问题，往往从一句模糊的反馈开始</h2>
<p>那次的反馈很典型：页面不卡，但手机有点热，用一会儿就掉电。</p>
<p>如果只从功能角度看，这几乎没有可操作的信息。
但经验告诉我，这类问题十有八九和 CPU 使用方式有关。</p>
<hr/>
<h2 data-id="heading-1">Instruments 能看到很多，但前提是你知道该看什么</h2>
<p>排查 CPU 的第一反应，通常还是 Instruments。</p>
<p>Time Profiler 很快能给出调用栈、线程分布、函数耗时。
在短时间测试里，一切都显得“还行”：</p>
<ul>
<li>主线程没有明显阻塞</li>
<li>CPU 峰值不高</li>
<li>没有死循环</li>
</ul>
<p>如果就此下结论，很容易认为“CPU 没问题”。</p>
<hr/>
<h2 data-id="heading-2">当 CPU 问题不发生在瞬间</h2>
<p>问题出在这里：
这次的 CPU 异常，并不是某一次操作触发的，而是<strong>持续存在的状态</strong>。</p>
<p>单次 Time Profiler 很难说明：</p>
<ul>
<li>为什么 CPU 一直处在偏高区间</li>
<li>哪些操作在“慢慢累积”</li>
<li>为什么退出页面后 CPU 没有明显回落</li>
</ul>
<p>这类问题，本质上和时间有关。</p>
<hr/>
<h2 data-id="heading-3">把 CPU 放回真实使用环境里看</h2>
<p>后来我换了一种方式，不再急着抓调用栈，而是先观察 CPU 在真实使用过程中的变化。</p>
<p>这一步，我用的是 <strong>克魔（KeyMob）</strong>。</p>
<p>原因并不复杂：
它可以在真机上持续监控 CPU 占用率，并把变化过程完整记录下来，而不是只看某一个采样点。</p>
<hr/>
<h2 data-id="heading-4">一条 CPU 曲线，比一个数值更有说服力</h2>
<p>当我连续使用 App 十几分钟之后，CPU 的问题才真正显现出来：</p>
<ul>
<li>CPU 没有明显峰值</li>
<li>但均值始终偏高</li>
<li>页面切换后没有明显回落</li>
<li>前后台切换时存在短暂抖动</li>
</ul>
<p>这些现象，单独看都不算“异常”，
但组合在一起，就很难忽略了。</p>
<hr/>
<h2 data-id="heading-5">回到 Instruments，这一次目标很明确</h2>
<p>有了趋势之后，再回到 Instruments，事情就变得简单多了。</p>
<p>我开始刻意盯着几段流程：</p>
<ul>
<li>页面切换时的线程活动</li>
<li>某些异步任务是否在后台持续运行</li>
<li>定时逻辑是否按预期结束</li>
</ul>
<p>最终发现，一个看似无害的轮询逻辑，在页面退出后并没有停止。</p>
<p>如果没有前面的长期观察，这个点很容易被忽略。</p>
<hr/>
<h2 data-id="heading-6">WebView 和 CPU，经常是“低调的消耗者”</h2>
<p>在另一个项目中，CPU 占用问题并不来自 Native。</p>
<p>通过 <strong>Safari Inspector</strong>，我发现某些 WebView 页面在退到后台后，仍然有 JS 定时任务在执行。
每一次执行都不重，但长期叠加，对 CPU 的影响非常稳定。</p>
<p>这类问题，用纯 Native 的 CPU 分析工具很难察觉。</p>
<hr/>
<h2 data-id="heading-7">网络行为，有时会把 CPU 问题放大</h2>
<p>还有一次 CPU 异常，最终是通过 <strong>Charles</strong> 才理清楚的。</p>
<p>抓包发现：</p>
<ul>
<li>接口在弱网环境下频繁重试</li>
<li>数据解析逻辑被反复触发</li>
<li>日志输出量明显增加</li>
</ul>
<p>单次看，这些行为都算不上严重。
但在真实使用中，它们共同维持了一个不必要的 CPU 活跃状态。</p>
<hr/>
<h2 data-id="heading-8">CPU 占用率，不是一个孤立指标</h2>
<p>经历这些排查之后，我对 CPU 占用率的理解发生了变化：</p>
<ul>
<li>它不是用来“判定对错”的</li>
<li>而是用来提示“行为是否合理”</li>
</ul>
<p>在工程实践中，我更关心的是：</p>
<ul>
<li>CPU 在什么阶段升高</li>
<li>操作结束后是否能回落</li>
<li>是否存在长期活跃的线程或任务</li>
</ul>
<p>KeyMob 在这里的价值，并不是替代 Instruments，而是帮我<strong>找到该用 Instruments 看哪里</strong>。</p>
<hr/>
<h2 data-id="heading-9">实际工作中常用的一种组合方式</h2>
<p>现在在处理 CPU 相关问题时，我通常会这样配合工具：</p>
<ul>
<li><strong>KeyMob</strong>：观察真机 CPU 长期变化</li>
<li><strong>Instruments</strong>：定位具体消耗点</li>
<li><strong>Safari Inspector</strong>：检查 WebView 行为</li>
<li><strong>Charles</strong>：分析网络引发的 CPU 活动</li>
<li><strong>Xcode</strong>：验证逻辑与线程状态</li>
</ul>
<p>这样做的好处是，不会被单一视角误导。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[终于找到可以一键做 AI 漫剧的方法了]]></title>    <link>https://juejin.cn/post/7586836874016931850</link>    <guid>https://juejin.cn/post/7586836874016931850</guid>    <pubDate>2025-12-23T10:43:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586836874016931850" data-draft-id="7586892413890052142" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="终于找到可以一键做 AI 漫剧的方法了"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-23T10:43:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苍何"/> <meta itemprop="url" content="https://juejin.cn/user/588993963763405"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            终于找到可以一键做 AI 漫剧的方法了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993963763405/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苍何
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T10:43:15.000Z" title="Tue Dec 23 2025 10:43:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是苍何的第 459 篇原创！</p>
<p>大家好，我是继续学习做 AI 漫剧的苍何。</p>
<p>前几天给大家分享了制作 AI 漫剧从 0 到 1 详细教程，深深感受到了大家的热情。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34f259334e824e40b5ef8c90c8f12709~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=5%2Bh%2F6LujSuXx9HC%2FihFf%2BZ1szf8%3D" alt="图片" loading="lazy"/></p>
<p>于是我们决定本周末举办一场关于 AI 漫剧的线下沙龙，目前已经有 100 人报名了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/915ccf466bd24a5fae04fd594fe3da44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=qLZfSd5EOTL%2BUiOjFVp%2Bc64Pqds%3D" alt="图片" loading="lazy"/></p>
<p>其实也想学习那些大神们是用的什么工具和方法，现在感觉到了最大的一个痛点就是，我对影视漫剧制作行业一无所知。</p>
<p>特别对于分镜剧集的把控，可以说非常失控。</p>
<p>既然 AI 都这么牛了，理论上应该有能一键出漫剧的平台吧，一找，还真有，而且不少。</p>
<p>一番了解后尝试了个朋友推荐的新工具，实现了我一键做 AI 漫剧的需求。</p>
<p>我们先来看看效果，先来个简单的《哪吒闹海》故事漫剧：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71806cdd4c544f6f83b8ce5f7199c830~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=vwDG2RYg9D6qJ6bfgPetKqCxy5E%3D" alt="wxv_4291534038629990405" loading="lazy"/></p>
<p>马上元旦了，来个Q版祝福吧：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae0773c52f8e4d378ef2a017e4d222cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=afmVJB60m9TkuVFLoMy%2FWTApDXk%3D" alt="wxv_4292152091554185235" loading="lazy"/></p>
<p>然后我还做了两个稍微复杂一点的，《滕王阁序》的故事：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/832e94f130d14d298cbe6c39cf027b86~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=TYZGuL1tOLtC3PYAS%2BCYCOZp1FU%3D" alt="wxv_4291534670208270337" loading="lazy"/></p>
<p>还整了个《凡人修仙》前传的剧情：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83ee238805ce48ed806e6a4b9e6e93b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=%2FvFJE7EHAX5UlEll0Q%2FrxSE3PZI%3D" alt="wxv_4291536283052015618" loading="lazy"/></p>
<p>这几个漫剧都是直接一键直出，不用自己考虑剧集和分镜。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15255337a29749428c3fd1c9a5c283c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=Fh2RO1lWh0mK0LbQ9uOc0QkR%2Bqk%3D" alt="图片" loading="lazy"/></p>
<p>真正做到了一句话（或者一份剧本），Agent 就可以自动完成剧本填充、人物、场景、风格设定，自动批量制作分镜图以及自动批量生视频，最后导出完整视频。</p>
<p>甚至配音和音乐都是一键生成，不用切换平台剪辑处理了。</p>
<blockquote>
<p>下面给大家分享一下我整个的创作过程，如果对你有帮助可以点赞三连支持告诉我。</p>
</blockquote>
<p>我把这次的 AI 漫剧制作 做了个信息图。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2ddefb308dc4f4489b0a21b1c39fa27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=a7mVPBHaLxdiGnWK%2BO3iNnixjOM%3D" alt="图片" loading="lazy"/></p>
<p>先说下工具，这次用的是商汤科技的的 Seko2.0，地址在这里：seko.sensetime.com</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6567b629558944a0ad9e5c227bdfe40d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=I4R%2BeSB0q2ZDKeTl9c7n7AgmNR0%3D" alt="图片" loading="lazy"/></p>
<p>这里除了一句话生成外也是可以上传剧本的，参考生图模型有即梦 4.0</p>
<p>在漫剧创作的时候，主角是非常重要的，之前我还用 NotebookLM 帮生成主角，现在 Seko 中可以直接使用内置的主体，比如拉布布、娜扎等，也可自定义一个主体。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b011fef7d1d240e184276f00c11a5daa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=gHMFDo1wk9bAtRkAL6ICAUrkpW0%3D" alt="图片" loading="lazy"/></p>
<p>这点很重要，我们必须先确认人物的主体，再选择想要的风格，在 Seko 中可以直接添加多种的风格，卡通、3D、日漫等，种类比较全，完全够用了，不够也可以自己自定义。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f40a491f9c82441b83f58e65a9a2ced2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=RPOPq5UCpj0LzmLgRajWr8VCM8k%3D" alt="图片" loading="lazy"/></p>
<p>下面就以我创作的作品《滕王阁序故事》来简单分享下我的创作流程。</p>
<p><strong>第一步，上传剧本或者一句话描述。</strong></p>
<p>点击对话框一句话输入：“讲述王勃创作《滕王阁序》时的故事”。选择画风为古风。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d5c84aa77b042eebda4b557ae69fdc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=eOxoxYcf6FGibMFPz%2B%2FOVj4QFdk%3D" alt="图片" loading="lazy"/></p>
<p>注意开启多剧集模式，就可以分多集制作视频。</p>
<p><strong>第二步，策划剧本大纲</strong></p>
<p>点击开始就可以看到它开始吭哧吭哧的干活了，首先出策划剧本大纲，交代基本信息、主要角色以及情节概要。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d740f30a84b49e58625be522474e4a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=lmlD3x1JgQOTCLlMVPu3CpILo1w%3D" alt="图片" loading="lazy"/></p>
<p>然后规划剧集，可以看到这里 Seko 一共帮规划了 5 集，并给出了分镜大纲。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a153a9baf1440e3bba7fcff890243d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=ZEiEbdG5mwYjsraLh1jJFbKQj28%3D" alt="图片" loading="lazy"/></p>
<p>如果对以上的部分有任何不满意，直接在对话框中就可以修改，直到修改满意之后，确认剧本大纲发送。</p>
<p><strong>第三步，分集制作分镜</strong></p>
<p>接下来开始分集制作分镜了，确认了剧本大纲之后，就会分为左右 2 栏，左边为剧本大纲，右边为每一集的故事梗概、美术风格、主体列表、场景列表以及分镜剧本。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/511ccd049228400f82ee3ba0b0f58b71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=g0fcL%2BqSkWtEMNHaEdkCdd62SOA%3D" alt="wxv_4292155039546032133" loading="lazy"/></p>
<p>这是自动生成的主体列表，会在以后的场景中使用到，并 保证整体人物的一致性。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbb33fd9b5364622beef716c5cef589c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=AWs02z99%2FzWW%2BZmf2R6O4y51co0%3D" alt="图片" loading="lazy"/></p>
<p>这里生成的场景图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8eb45b6d20c34fe3a55abb94f9731ee9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=ZIhjhPGNHen1inPa5YjvWXb9VCs%3D" alt="图片" loading="lazy"/></p>
<p>在一集中同一个场景里的各种景别构图，例如第一集中在滕王阁宴这个场景，几个分镜均为滕王阁宴的远、中、近、特，更加符合剧情片的实际生成使用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10bd500de5784acc985865f3de54de62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=wLKY1DsV7cDIwjbuUW8XznDP6FU%3D" alt="图片" loading="lazy"/></p>
<p>第二集中的滕王阁里面的场景也高度保持了场景的一致性，这点非常重要。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6aa59b826727499e8fb9e22aece1108c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=YoNioSr%2BqCwYQhidCddC2%2FDyiMQ%3D" alt="图片" loading="lazy"/></p>
<p>如果对主体列表及场景列表有任何的不满意，可以点击图片右上角的修改图标，进去修改，对分镜剧本不满意的可以直接对话框中修改。</p>
<p>以上内容确认无误之后，可以选择屏幕右下角的模型、画面比例，之后点击生成分镜</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/411327f2172f402da929ae18c5bd200b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=GB%2B9sYEnuiTCijuUJfw4KMM7A9g%3D" alt="图片" loading="lazy"/></p>
<p>Agent 就开始一步一步执行了，分析脚本、明确分镜主体、匹配参考风格、设计构图等这些都是自动执行的，我们只要看着就好。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c42ef3f5390c4fc3b213820304b033fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=U8GYAQZtRzTko%2Brj%2FOWIBeZNZBo%3D" alt="图片" loading="lazy"/></p>
<p>然后就出来了分镜图，如果想看全部的分镜图，可以点击右下角的故事版视图查看所有。</p>
<p>在这里可以从左至右浏览每一个分镜图是否符合要求，如果不符合要求，可以点击屏幕中间的画布编辑，对分镜图进行编辑，包括消除、局部重绘制，元素添加以及裁剪，编辑完成之后点击右上角的应用修改即可。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e580b2d8745648dbb71960f427515e2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=0Bjy%2BWDrgAmU6Vt3weiUdXWY%2F1o%3D" alt="图片" loading="lazy"/></p>
<p>也可以选中下方要修改的分镜图，在屏幕左侧中部，图片提示词板块，点击重新编辑或者引用改图，进行修改。</p>
<p><strong>第四步，分镜转视频</strong></p>
<p>依次修改完分镜图之后，点击右上角的一键转视频，即可将所有的分镜图转为视频。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c96da59a14c64e2e9ab5cb2680e29cc7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=rg4Z6FlIvrSPAkeFve5dD%2F%2Fwd1I%3D" alt="图片" loading="lazy"/></p>
<p>所有分镜图转为视频之后，可以选中需要修改的视频，在屏幕左侧中间的视频提示词板块，修改视频。</p>
<p>如有对口型的需要，可以点击屏幕中上部的对口型，重新制作视频</p>
<p>如果对声音不满意，点击左上侧的配音按钮，即可对当段视频进行声音修改</p>
<p>逐一修改好视频之后，点击导出就可以得到第一集的视频了</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44b05136c2534cef89572e6c39afab12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=u6iutFa%2BV6dTG%2FogEHFpnEGzcjM%3D" alt="图片" loading="lazy"/></p>
<p>点击屏幕左上角的返回策划，回到剧集策划页面，点击左侧中部的加号按钮，就可开始第二集、第三集的创作啦。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c211d42f003c480c84a37e9ba42d2017~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=0gw7qWeMOub0BouipZXxP60FRCo%3D" alt="图片" loading="lazy"/></p>
<p>这个 Agent，可以说完全解决了 AI 漫剧创作的不少痛点，生图支持即梦等，而且速度贼快，完全省心省力，爱了爱了。</p>
<p>以上就是基本的一个步骤，人工大部分时间是用来做最后的决策，Seko 的 Agent 帮我自动做了很多工作。。</p>
<p>这真的达到了一键做漫剧了，也不需要什么过多复杂的提示词，通通交给 Agent。</p>
<p>我发现 Seko 在多集中依旧能保持上下文记忆，全过程都能保持每集中剧情对应的主体和场景调用的参考图一致，这样才不至于每集生成的人物和场景的随机。</p>
<p>刚好看到官网有优惠活动，到今年 12 月 31 日，免费生成 100 张，而且这段期间年会员直接半价，买积分的话也有 8 折优惠。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f386b24b298e4a63af8ac6baba05c3cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=2%2FXUja6RcdCYZsIUMTiv2tEPgzo%3D" alt="图片" loading="lazy"/></p>
<p>很兴奋，又剁手冲了，希望能多做些漫剧，圆我梦。</p>
<p>突然想起那些曾经被困在漫长流程里的灵感，被时间消磨的热情，现在有了更快抵达世界的方式。</p>
<p>技术进步的真正温度，或许不在于它取代了什么，而在于它为我们腾出了什么：腾出双手去捕捉更多转瞬即逝的创意，腾出心力去打磨故事里更动人的细节，最重要的是，腾出那份“也许我能试试”的勇气。</p>
<p>当工具隐入幕后，站在聚光灯下的，始终是那个渴望讲述、渴望被看见的你。<strong>而最好的作品，永远诞生于人类讲故事的本能，与时代赋予的新可能相遇之时</strong>。</p>
<p>这条路的前方，会有更多人的创作之梦，被温柔地照亮。</p>
<p>不妨试试看，也许你的下一个想法，就能快速变成一部作品。期待在评论区，看到你用它打造出的第一个成果。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>