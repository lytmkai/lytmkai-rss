<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Reactor网络模型深度解析：从并发困境说起]]></title>    <link>https://juejin.cn/post/7578714735307636762</link>    <guid>https://juejin.cn/post/7578714735307636762</guid>    <pubDate>2025-12-01T14:12:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578714735307636762" data-draft-id="7578714735307620378" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Reactor网络模型深度解析：从并发困境说起"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-01T14:12:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Reactor网络模型深度解析：从并发困境说起
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T14:12:19.000Z" title="Mon Dec 01 2025 14:12:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    30
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文深入探讨Reactor网络模型的核心机制，解答高并发场景下的关键问题，揭示现代高性能服务器的架构奥秘。通过对比分析、原理阐述和实战代码，带您彻底理解Reactor如何优雅应对海量并发请求。</p>
</blockquote>
<h2 data-id="heading-0"><strong>并发困难</strong></h2>
<p>想象这样一个场景：你的电商网站正在举办"双11"大促，每秒有10万用户同时点击"立即购买"。传统的"一线程一连接"架构瞬间崩溃——不是内存耗尽，就是CPU被上下文切换拖垮。</p>
<p>这正是我在职业生涯早期遭遇的真实困境。直到我理解了<strong>Reactor模式</strong>，才发现原来高性能网络编程可以如此优雅。</p>
<h2 data-id="heading-1"><strong>第一章：传统并发模型的崩溃边缘</strong></h2>
<h3 data-id="heading-2"><strong>1.1 阻塞I/O的致命缺陷</strong></h3>
<p>让我们从最直观的代码开始：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 经典的多线程服务器 - 每个连接一个线程</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">handle_client</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd)</span> </span>{
    <span class="hljs-type">char</span> buffer[<span class="hljs-number">1024</span>];
    <span class="hljs-comment">// 阻塞点：数据未到达时线程休眠</span>
    <span class="hljs-type">int</span> n = <span class="hljs-built_in">recv</span>(sockfd, buffer, <span class="hljs-built_in">sizeof</span>(buffer), <span class="hljs-number">0</span>);
    <span class="hljs-comment">// 线程被唤醒，处理业务</span>
    <span class="hljs-built_in">process_request</span>(buffer);
    <span class="hljs-built_in">send</span>(sockfd, response, <span class="hljs-built_in">strlen</span>(response), <span class="hljs-number">0</span>);
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">int</span> server_fd = <span class="hljs-built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);
    <span class="hljs-comment">// ... bind, listen</span>
    
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>) {
        <span class="hljs-type">int</span> client_fd = <span class="hljs-built_in">accept</span>(server_fd, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);
        <span class="hljs-comment">// 致命的资源消耗：每个线程需要8MB栈空间</span>
        <span class="hljs-function">std::thread <span class="hljs-title">t</span><span class="hljs-params">(handle_client, client_fd)</span></span>;
        t.<span class="hljs-built_in">detach</span>();
    }
}
</code></pre>
<p><strong>问题分析</strong>：</p>
<ul>
<li>连接数增长 → 线程数线性增长</li>
<li>1000个连接 ≈ 8GB内存（仅线程栈）</li>
<li>上下文切换开销呈指数级上升</li>
<li>大部分线程处于阻塞等待状态（资源浪费）</li>
</ul>
<h3 data-id="heading-3"><strong>1.2 C10K问题的挑战</strong></h3>
<p>2000年提出的C10K（并发1万连接）问题，暴露了传统模型的根本缺陷：</p>

























<table><thead><tr><th>资源类型</th><th>传统模型消耗</th><th>物理限制</th></tr></thead><tbody><tr><td>内存</td><td>10,000 × 8MB = 80GB</td><td>服务器通常只有128GB</td></tr><tr><td>文件描述符</td><td>10,000</td><td>系统默认限制1024</td></tr><tr><td>CPU时间</td><td>大量用于线程切换</td><td>实际业务处理占比低</td></tr></tbody></table>
<h2 data-id="heading-4"><strong>第二章：Reactor的架构革命</strong></h2>
<h3 data-id="heading-5"><strong>2.1 核心思想：事件驱动与状态机</strong></h3>
<p>Reactor模式的核心转变：<strong>从"主动轮询"到"被动通知"</strong>。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 传统模型：主动询问每个连接</span>
<span class="hljs-keyword">for</span>(each connection) {
    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">has_data</span>(connection)) {  <span class="hljs-comment">// 主动检查</span>
        <span class="hljs-built_in">process</span>(connection);
    }
}

<span class="hljs-comment">// Reactor模型：等待事件通知</span>
<span class="hljs-keyword">while</span>(events = <span class="hljs-built_in">wait_for_events</span>()) {  <span class="hljs-comment">// 被动等待</span>
    <span class="hljs-keyword">for</span>(each event in events) {
        <span class="hljs-built_in">handle_event</span>(event);  <span class="hljs-comment">// 事件触发处理</span>
    }
}
</code></pre>
<h3 data-id="heading-6"><strong>2.2 系统调用：从select到epoll的演进</strong></h3>
<p><strong>第一代：select/poll的局限</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">select</span><span class="hljs-params">(<span class="hljs-type">int</span> nfds, fd_set *readfds, fd_set *writefds, 
           fd_set *exceptfds, <span class="hljs-keyword">struct</span> timeval *timeout)</span></span>;
</code></pre>
<ul>
<li>每次调用需要传递全部fd集合（用户态→内核态拷贝）</li>
<li>内核线性扫描所有fd（O(n)复杂度）</li>
<li>fd数量限制（通常1024）</li>
</ul>
<p><strong>第二代：epoll的突破</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 1. 创建epoll实例</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">epoll_create</span><span class="hljs-params">(<span class="hljs-type">int</span> size)</span></span>;

<span class="hljs-comment">// 2. 注册/修改fd兴趣</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">epoll_ctl</span><span class="hljs-params">(<span class="hljs-type">int</span> epfd, <span class="hljs-type">int</span> op, <span class="hljs-type">int</span> fd, <span class="hljs-keyword">struct</span> epoll_event *event)</span></span>;

<span class="hljs-comment">// 3. 等待事件</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">epoll_wait</span><span class="hljs-params">(<span class="hljs-type">int</span> epfd, <span class="hljs-keyword">struct</span> epoll_event *events, 
               <span class="hljs-type">int</span> maxevents, <span class="hljs-type">int</span> timeout)</span></span>;
</code></pre>
<p><strong>epoll的核心优势</strong>：</p>
<ol>
<li><strong>红黑树存储fd</strong>：高效增删改（O(log n)）</li>
<li><strong>就绪列表</strong>：事件触发时加入列表</li>
<li><strong>mmap共享内存</strong>：避免用户态-内核态数据拷贝</li>
<li><strong>边缘触发(ET)</strong>：减少事件通知次数</li>
</ol>
<h3 data-id="heading-7"><strong>2.3 Reactor的完整架构</strong></h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// Reactor模式四层架构</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactorArchitecture</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-comment">// 1. 事件多路分发器（Demultiplexer）</span>
    EventDemultiplexer* demux;
    
    <span class="hljs-comment">// 2. 事件处理器注册表（Event Handler Registry）</span>
    std::map&lt;Handle, EventHandler*&gt; handlers;
    
    <span class="hljs-comment">// 3. 事件循环（Event Loop）</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">event_loop</span><span class="hljs-params">()</span></span>;
    
    <span class="hljs-comment">// 4. 具体事件处理器（Concrete Event Handlers）</span>
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">AcceptorHandler</span> : <span class="hljs-keyword">public</span> EventHandler {...};
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectionHandler</span> : <span class="hljs-keyword">public</span> EventHandler {...};
};

<span class="hljs-comment">// 事件循环核心算法</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Reactor::event_loop</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">while</span>(!stop) {
        <span class="hljs-comment">// 等待事件发生（毫秒级甚至纳秒级）</span>
        <span class="hljs-keyword">auto</span> events = demux-&gt;<span class="hljs-built_in">select</span>(timeout);
        
        <span class="hljs-comment">// 分发事件到对应处理器</span>
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span>&amp; event : events) {
            EventHandler* handler = <span class="hljs-built_in">get_handler</span>(event.handle);
            <span class="hljs-keyword">if</span>(handler) {
                handler-&gt;<span class="hljs-built_in">handle_event</span>(event.type);
            }
        }
        
        <span class="hljs-comment">// 处理定时器事件</span>
        <span class="hljs-built_in">process_timers</span>();
        
        <span class="hljs-comment">// 处理异步任务</span>
        <span class="hljs-built_in">process_async_tasks</span>();
    }
}
</code></pre>
<h2 data-id="heading-8"><strong>第三章：深入关键问题：并发消息处理机制</strong></h2>
<h3 data-id="heading-9"><strong>3.1 问题的本质：Reactor如何处理"同时到达"的消息？</strong></h3>
<p>这是最常见的误解点。我们需要区分两个概念：</p>
<ul>
<li><strong>物理同时</strong>：多个数据包在同一纳秒到达网卡</li>
<li><strong>逻辑同时</strong>：Reactor在单次事件循环中处理多个就绪事件</li>
</ul>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 实际的处理时序</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Reactor::handle_events</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 单次epoll_wait可能返回多个就绪socket</span>
    <span class="hljs-type">int</span> n = <span class="hljs-built_in">epoll_wait</span>(epfd, events, <span class="hljs-number">64</span>, <span class="hljs-number">-1</span>);
    
    <span class="hljs-comment">// 这些socket的数据"几乎同时"到达内核缓冲区</span>
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; n; i++) {
        <span class="hljs-comment">// 但处理是顺序的！关键在此！</span>
        <span class="hljs-built_in">handle_socket</span>(events[i].data.fd);
    }
}
</code></pre>
<h3 data-id="heading-10"><strong>3.2 内核缓冲区的关键作用</strong></h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "客户端同时发送"
        C1[客户端1] --&gt;|数据包1| NIC[网卡]
        C2[客户端2] --&gt;|数据包2| NIC
        C3[客户端3] --&gt;|数据包3| NIC
    end
    
    subgraph "内核空间"
        NIC --&gt;|DMA拷贝| Memory[内核内存]
        Memory --&gt; TCP[TCP协议栈]
        TCP --&gt; B1[Socket1缓冲区]
        TCP --&gt; B2[Socket2缓冲区]
        TCP --&gt; B3[Socket3缓冲区]
    end
    
    subgraph "Reactor处理"
        B1 --&gt;|epoll标记可读| E[epoll就绪列表]
        B2 --&gt;|epoll标记可读| E
        B3 --&gt;|epoll标记可读| E
        E --&gt; R[Reactor顺序读取]
    end
    
    R --&gt; P1[处理Socket1]
    R --&gt; P2[处理Socket2]
    R --&gt; P3[处理Socket3]
</code></pre>
<p><strong>关键理解</strong>：</p>
<ol>
<li>数据包到达网卡后，由DMA直接写入内存</li>
<li>内核TCP协议栈处理，存入对应socket的接收缓冲区</li>
<li>epoll将该socket标记为"可读"</li>
<li>Reactor下次<code>epoll_wait</code>时获知多个socket就绪</li>
<li><strong>虽然是顺序处理，但每个recv都是非阻塞的，立即返回</strong></li>
</ol>
<h3 data-id="heading-11"><strong>3.3 性能瓶颈分析与解决方案</strong></h3>
<p><strong>场景分析</strong>：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 假设有3个客户端几乎同时发送数据</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">handle_socket</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span> </span>{
    <span class="hljs-comment">// 步骤1：读取数据（很快，微秒级）</span>
    <span class="hljs-type">char</span> buf[<span class="hljs-number">1024</span>];
    <span class="hljs-type">int</span> n = <span class="hljs-built_in">recv</span>(fd, buf, <span class="hljs-built_in">sizeof</span>(buf), <span class="hljs-number">0</span>);
    
    <span class="hljs-comment">// 步骤2：业务处理（可能很慢，毫秒级）</span>
    std::string result = <span class="hljs-built_in">expensive_processing</span>(buf, n);
    
    <span class="hljs-comment">// 步骤3：发送响应</span>
    <span class="hljs-built_in">send</span>(fd, result.<span class="hljs-built_in">c_str</span>(), result.<span class="hljs-built_in">length</span>(), <span class="hljs-number">0</span>);
}
</code></pre>
<p><strong>处理时间线</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">时间轴：0ms     1ms     2ms     3ms     4ms     5ms
Socket1: <span class="hljs-section">[recv]</span><span class="hljs-section">[proc...................]</span><span class="hljs-section">[send]</span>
Socket2:        等待...<span class="hljs-section">[recv]</span><span class="hljs-section">[proc...................]</span><span class="hljs-section">[send]</span>
Socket3:                等待...........<span class="hljs-section">[recv]</span><span class="hljs-section">[proc...................]</span><span class="hljs-section">[send]</span>
</code></pre>
<p><strong>问题</strong>：Socket2、3需要等待Socket1的业务处理完成！</p>
<p><strong>解决方案：Reactor + 线程池</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 优化的Reactor架构</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">HighPerformanceReactor</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-comment">// I/O线程（主Reactor）</span>
    std::thread io_thread;
    
    <span class="hljs-comment">// 业务线程池</span>
    ThreadPool worker_pool;
    
    <span class="hljs-comment">// 用于线程间通信的任务队列</span>
    moodycamel::ConcurrentQueue&lt;IORequest&gt; request_queue;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">handle_read_event</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span> </span>{
        <span class="hljs-comment">// 1. I/O线程：快速读取数据</span>
        IORequest req = <span class="hljs-built_in">read_data_nonblocking</span>(fd);
        
        <span class="hljs-comment">// 2. 提交到业务线程池</span>
        worker_pool.<span class="hljs-built_in">enqueue</span>([<span class="hljs-keyword">this</span>, req]() {
            <span class="hljs-comment">// 3. Worker线程：处理耗时业务</span>
            ProcessResult result = <span class="hljs-built_in">process_business</span>(req);
            
            <span class="hljs-comment">// 4. 将写任务交回I/O线程</span>
            io_thread.<span class="hljs-built_in">post</span>([fd, result]() {
                <span class="hljs-built_in">send_response</span>(fd, result);
            });
        });
        
        <span class="hljs-comment">// I/O线程立即返回，继续处理其他事件</span>
    }
};
</code></pre>
<p><strong>优化后的时间线</strong>：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">I</span>/<span class="hljs-selector-tag">O</span>线程: <span class="hljs-selector-attr">[recv1]</span><span class="hljs-selector-attr">[recv2]</span><span class="hljs-selector-attr">[recv3]</span><span class="hljs-selector-attr">[send1]</span><span class="hljs-selector-attr">[send2]</span><span class="hljs-selector-attr">[send3]</span>
<span class="hljs-selector-tag">Worker1</span>:         <span class="hljs-selector-attr">[proc1...........]</span>
<span class="hljs-selector-tag">Worker2</span>:         <span class="hljs-selector-attr">[proc2...........]</span>
<span class="hljs-selector-tag">Worker3</span>:         <span class="hljs-selector-attr">[proc3...........]</span>
</code></pre>
<h2 data-id="heading-12"><strong>第四章：工业级Reactor实现细节</strong></h2>
<h3 data-id="heading-13"><strong>4.1 完整的事件状态机</strong></h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">enum class</span> <span class="hljs-title class_">ConnectionState</span> {
    ACCEPTING,      <span class="hljs-comment">// 接受连接</span>
    READING,        <span class="hljs-comment">// 读取数据</span>
    PROCESSING,     <span class="hljs-comment">// 处理中（可能在Worker线程）</span>
    WRITING,        <span class="hljs-comment">// 写入数据</span>
    CLOSING         <span class="hljs-comment">// 关闭连接</span>
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Connection</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">int</span> fd;
    ConnectionState state;
    std::vector&lt;<span class="hljs-type">char</span>&gt; input_buffer;
    std::vector&lt;<span class="hljs-type">char</span>&gt; output_buffer;
    <span class="hljs-type">size_t</span> bytes_to_write;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">handle_event</span><span class="hljs-params">(EventType type)</span> </span>{
        <span class="hljs-keyword">switch</span>(state) {
            <span class="hljs-keyword">case</span> ConnectionState::READING:
                <span class="hljs-keyword">if</span>(type == EventType::READ) {
                    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">read_data</span>() &gt; <span class="hljs-number">0</span>) {
                        <span class="hljs-comment">// 数据读够一个完整请求</span>
                        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">parse_complete</span>()) {
                            state = ConnectionState::PROCESSING;
                            <span class="hljs-built_in">submit_to_thread_pool</span>();
                        }
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-comment">// 连接关闭或错误</span>
                        state = ConnectionState::CLOSING;
                    }
                }
                <span class="hljs-keyword">break</span>;
                
            <span class="hljs-keyword">case</span> ConnectionState::WRITING:
                <span class="hljs-keyword">if</span>(type == EventType::WRITE) {
                    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">write_data</span>() == output_buffer.<span class="hljs-built_in">size</span>()) {
                        <span class="hljs-comment">// 数据全部发送完成</span>
                        <span class="hljs-keyword">if</span>(keep_alive) {
                            state = ConnectionState::READING;
                            <span class="hljs-built_in">reset_for_next_request</span>();
                        } <span class="hljs-keyword">else</span> {
                            state = ConnectionState::CLOSING;
                        }
                    }
                }
                <span class="hljs-keyword">break</span>;
                
            <span class="hljs-comment">// ... 其他状态处理</span>
        }
    }
};
</code></pre>
<h3 data-id="heading-14"><strong>4.2 内存管理优化</strong></h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 对象池避免频繁new/delete</span>
<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectionPool</span> {
<span class="hljs-keyword">private</span>:
    std::vector&lt;T*&gt; free_list;
    std::mutex lock;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">T* <span class="hljs-title">acquire</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">guard</span><span class="hljs-params">(lock)</span></span>;
        <span class="hljs-keyword">if</span>(!free_list.<span class="hljs-built_in">empty</span>()) {
            T* obj = free_list.<span class="hljs-built_in">back</span>();
            free_list.<span class="hljs-built_in">pop_back</span>();
            <span class="hljs-keyword">return</span> obj;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">T</span>();
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">release</span><span class="hljs-params">(T* obj)</span> </span>{
        obj-&gt;<span class="hljs-built_in">reset</span>();  <span class="hljs-comment">// 重置状态而非销毁</span>
        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">guard</span><span class="hljs-params">(lock)</span></span>;
        free_list.<span class="hljs-built_in">push_back</span>(obj);
    }
};

<span class="hljs-comment">// 缓冲区设计</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Buffer</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-comment">// 使用连续内存块，避免小内存分配</span>
    <span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-type">size_t</span> INITIAL_SIZE = <span class="hljs-number">1024</span>;
    <span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-type">size_t</span> MAX_SIZE = <span class="hljs-number">65536</span>;
    
    std::unique_ptr&lt;<span class="hljs-type">char</span>[]&gt; data;
    <span class="hljs-type">size_t</span> capacity;
    <span class="hljs-type">size_t</span> read_index;
    <span class="hljs-type">size_t</span> write_index;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 确保容量（指数增长策略）</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ensure_capacity</span><span class="hljs-params">(<span class="hljs-type">size_t</span> need)</span> </span>{
        <span class="hljs-keyword">if</span>(write_index + need &lt;= capacity) <span class="hljs-keyword">return</span>;
        
        <span class="hljs-type">size_t</span> new_capacity = std::<span class="hljs-built_in">max</span>(capacity * <span class="hljs-number">2</span>, 
                                      write_index - read_index + need);
        new_capacity = std::<span class="hljs-built_in">min</span>(new_capacity, MAX_SIZE);
        
        <span class="hljs-keyword">auto</span> new_data = std::<span class="hljs-built_in">make_unique</span>&lt;<span class="hljs-type">char</span>[]&gt;(new_capacity);
        <span class="hljs-comment">// 复制有效数据</span>
        std::<span class="hljs-built_in">copy</span>(data.<span class="hljs-built_in">get</span>() + read_index, 
                  data.<span class="hljs-built_in">get</span>() + write_index, 
                  new_data.<span class="hljs-built_in">get</span>());
        write_index -= read_index;
        read_index = <span class="hljs-number">0</span>;
        data = std::<span class="hljs-built_in">move</span>(new_data);
        capacity = new_capacity;
    }
};
</code></pre>
<h3 data-id="heading-15"><strong>4.3 性能调优参数</strong></h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// Linux内核参数调优</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">tune_system_parameters</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 1. 文件描述符限制</span>
    <span class="hljs-built_in">system</span>(<span class="hljs-string">"ulimit -n 1000000"</span>);
    
    <span class="hljs-comment">// 2. TCP参数优化</span>
    <span class="hljs-type">int</span> fd = <span class="hljs-built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);
    
    <span class="hljs-comment">// 启用TCP_NODELAY（禁用Nagle算法）</span>
    <span class="hljs-type">int</span> flag = <span class="hljs-number">1</span>;
    <span class="hljs-built_in">setsockopt</span>(fd, IPPROTO_TCP, TCP_NODELAY, &amp;flag, <span class="hljs-built_in">sizeof</span>(flag));
    
    <span class="hljs-comment">// 增大接收缓冲区</span>
    <span class="hljs-type">int</span> recv_buf_size = <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;  <span class="hljs-comment">// 1MB</span>
    <span class="hljs-built_in">setsockopt</span>(fd, SOL_SOCKET, SO_RCVBUF, 
               &amp;recv_buf_size, <span class="hljs-built_in">sizeof</span>(recv_buf_size));
    
    <span class="hljs-comment">// 启用SO_REUSEPORT（Linux 3.9+）</span>
    <span class="hljs-built_in">setsockopt</span>(fd, SOL_SOCKET, SO_REUSEPORT, &amp;flag, <span class="hljs-built_in">sizeof</span>(flag));
    
    <span class="hljs-comment">// 3. 网卡队列调整</span>
    <span class="hljs-comment">// ethtool -G eth0 rx 4096 tx 4096</span>
}

<span class="hljs-comment">// Reactor内部参数</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ReactorConfig</span> {
    <span class="hljs-type">size_t</span> max_connections = <span class="hljs-number">1000000</span>;      <span class="hljs-comment">// 最大连接数</span>
    <span class="hljs-type">size_t</span> io_threads = <span class="hljs-number">1</span>;                 <span class="hljs-comment">// I/O线程数（主从Reactor）</span>
    <span class="hljs-type">size_t</span> worker_threads = std::thread::<span class="hljs-built_in">hardware_concurrency</span>();
    <span class="hljs-type">size_t</span> task_queue_size = <span class="hljs-number">10000</span>;        <span class="hljs-comment">// 任务队列大小</span>
    <span class="hljs-type">size_t</span> buffer_size = <span class="hljs-number">16384</span>;            <span class="hljs-comment">// 每个连接的缓冲区大小</span>
    <span class="hljs-type">int</span> epoll_timeout_ms = <span class="hljs-number">1</span>;              <span class="hljs-comment">// epoll_wait超时时间</span>
    <span class="hljs-type">bool</span> use_et_mode = <span class="hljs-literal">true</span>;               <span class="hljs-comment">// 使用边缘触发</span>
};
</code></pre>
<h2 data-id="heading-16"><strong>第五章：现实世界的挑战与解决方案</strong></h2>
<h3 data-id="heading-17"><strong>5.1 惊群问题（Thundering Herd）</strong></h3>
<p><strong>问题</strong>：多个进程/线程同时监听同一个端口，当新连接到达时全部被唤醒。</p>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// Linux 3.9+ 的SO_REUSEPORT</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">setup_reuseport</span><span class="hljs-params">(<span class="hljs-type">int</span> port)</span> </span>{
    <span class="hljs-type">int</span> fd = <span class="hljs-built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);
    
    <span class="hljs-type">int</span> reuse = <span class="hljs-number">1</span>;
    <span class="hljs-built_in">setsockopt</span>(fd, SOL_SOCKET, SO_REUSEADDR, &amp;reuse, <span class="hljs-built_in">sizeof</span>(reuse));
    <span class="hljs-built_in">setsockopt</span>(fd, SOL_SOCKET, SO_REUSEPORT, &amp;reuse, <span class="hljs-built_in">sizeof</span>(reuse));
    
    <span class="hljs-comment">// 内核会自动分配连接给不同的监听socket</span>
    <span class="hljs-keyword">return</span> fd;
}

<span class="hljs-comment">// 或者使用accept锁</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AcceptMutex</span> {
<span class="hljs-keyword">private</span>:
    std::atomic&lt;<span class="hljs-type">bool</span>&gt; lock{<span class="hljs-literal">false</span>};
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">try_lock</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> !lock.<span class="hljs-built_in">exchange</span>(<span class="hljs-literal">true</span>, std::memory_order_acquire);
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">unlock</span><span class="hljs-params">()</span> </span>{
        lock.<span class="hljs-built_in">store</span>(<span class="hljs-literal">false</span>, std::memory_order_release);
    }
};
</code></pre>
<h3 data-id="heading-18"><strong>5.2 长连接与心跳机制</strong></h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectionManager</span> {
<span class="hljs-keyword">private</span>:
    std::unordered_map&lt;<span class="hljs-type">int</span>, std::shared_ptr&lt;Connection&gt;&gt; connections;
    std::priority_queue&lt;HeartbeatCheck&gt; heartbeat_queue;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">check_heartbeats</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">auto</span> now = std::chrono::steady_clock::<span class="hljs-built_in">now</span>();
        
        <span class="hljs-keyword">while</span>(!heartbeat_queue.<span class="hljs-built_in">empty</span>() &amp;&amp; 
              heartbeat_queue.<span class="hljs-built_in">top</span>().expiry_time &lt; now) {
            <span class="hljs-keyword">auto</span> conn = heartbeat_queue.<span class="hljs-built_in">top</span>().connection;
            heartbeat_queue.<span class="hljs-built_in">pop</span>();
            
            <span class="hljs-keyword">if</span>(conn-&gt;last_active + HEARTBEAT_TIMEOUT &lt; now) {
                <span class="hljs-comment">// 发送心跳包</span>
                <span class="hljs-built_in">send_heartbeat</span>(conn-&gt;fd);
                
                <span class="hljs-comment">// 重新加入队列，等待响应</span>
                heartbeat_queue.<span class="hljs-built_in">push</span>({
                    now + HEARTBEAT_INTERVAL,
                    conn
                });
            }
        }
    }
};
</code></pre>
<h3 data-id="heading-19"><strong>5.3 流量控制与背压（Backpressure）</strong></h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FlowController</span> {
<span class="hljs-keyword">private</span>:
    std::atomic&lt;<span class="hljs-type">size_t</span>&gt; current_connections{<span class="hljs-number">0</span>};
    std::atomic&lt;<span class="hljs-type">size_t</span>&gt; request_rate{<span class="hljs-number">0</span>};
    <span class="hljs-type">size_t</span> max_connections;
    <span class="hljs-type">size_t</span> max_request_rate;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">should_accept_new_connection</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-type">size_t</span> conns = current_connections.<span class="hljs-built_in">load</span>();
        <span class="hljs-keyword">if</span>(conns &gt;= max_connections * <span class="hljs-number">0.9</span>) {
            <span class="hljs-comment">// 连接数接近上限，开始限流</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        current_connections.<span class="hljs-built_in">fetch_add</span>(<span class="hljs-number">1</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">should_process_request</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-type">size_t</span> rate = request_rate.<span class="hljs-built_in">load</span>();
        <span class="hljs-keyword">if</span>(rate &gt; max_request_rate) {
            <span class="hljs-comment">// 返回429 Too Many Requests</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        request_rate.<span class="hljs-built_in">fetch_add</span>(<span class="hljs-number">1</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">request_completed</span><span class="hljs-params">()</span> </span>{
        request_rate.<span class="hljs-built_in">fetch_sub</span>(<span class="hljs-number">1</span>);
    }
};
</code></pre>
<h2 data-id="heading-20"><strong>第六章：性能对比与基准测试</strong></h2>
<h3 data-id="heading-21"><strong>6.1 不同模型性能对比</strong></h3>






















































<table><thead><tr><th>指标</th><th>多线程阻塞I/O</th><th>单线程Reactor</th><th>Reactor+线程池</th><th>多Reactor</th></tr></thead><tbody><tr><td>最大连接数</td><td>~1000</td><td>10万+</td><td>10万+</td><td>100万+</td></tr><tr><td>QPS（echo）</td><td>5,000</td><td>50,000</td><td>50,000</td><td>200,000</td></tr><tr><td>QPS（10ms业务）</td><td>100</td><td>100</td><td>10,000</td><td>40,000</td></tr><tr><td>内存使用</td><td>高</td><td>极低</td><td>低</td><td>中等</td></tr><tr><td>编程复杂度</td><td>简单</td><td>中等</td><td>复杂</td><td>复杂</td></tr><tr><td>适用场景</td><td>低并发</td><td>高并发I/O</td><td>通用</td><td>极致性能</td></tr></tbody></table>
<h3 data-id="heading-22"><strong>6.2 实际基准测试数据</strong></h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 使用wrk进行压力测试</span>
<span class="hljs-comment">// wrk -t12 -c1000 -d30s http://localhost:8080/</span>

<span class="hljs-comment">// 测试结果对比</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">BenchmarkResult</span> {
    std::string model;
    <span class="hljs-type">int</span> connections;
    <span class="hljs-type">int</span> threads;
    <span class="hljs-type">double</span> requests_per_second;
    <span class="hljs-type">double</span> latency_avg_ms;
    <span class="hljs-type">double</span> latency_max_ms;
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">print</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
        std::cout &lt;&lt; std::format(
            <span class="hljs-string">"Model: {}\n"</span>
            <span class="hljs-string">"Connections: {}\n"</span>
            <span class="hljs-string">"RPS: {:.1f}\n"</span>
            <span class="hljs-string">"Latency Avg: {:.2f}ms\n"</span>
            <span class="hljs-string">"Latency Max: {:.2f}ms\n\n"</span>,
            model, connections, requests_per_second,
            latency_avg_ms, latency_max_ms
        );
    }
};

<span class="hljs-comment">// 示例数据</span>
std::vector&lt;BenchmarkResult&gt; results = {
    {<span class="hljs-string">"Thread-per-connection"</span>, <span class="hljs-number">1000</span>, <span class="hljs-number">1000</span>, <span class="hljs-number">4800.5</span>, <span class="hljs-number">12.3</span>, <span class="hljs-number">210.5</span>},
    {<span class="hljs-string">"Single Reactor"</span>, <span class="hljs-number">10000</span>, <span class="hljs-number">1</span>, <span class="hljs-number">52300.2</span>, <span class="hljs-number">1.2</span>, <span class="hljs-number">15.8</span>},
    {<span class="hljs-string">"Reactor+ThreadPool"</span>, <span class="hljs-number">10000</span>, <span class="hljs-number">8</span>, <span class="hljs-number">49800.7</span>, <span class="hljs-number">2.5</span>, <span class="hljs-number">32.4</span>},
    {<span class="hljs-string">"Multi-Reactor"</span>, <span class="hljs-number">100000</span>, <span class="hljs-number">4</span>, <span class="hljs-number">187600.4</span>, <span class="hljs-number">0.8</span>, <span class="hljs-number">12.7</span>}
};
</code></pre>
<h2 data-id="heading-23"><strong>第七章：现代演进与未来趋势</strong></h2>
<h3 data-id="heading-24"><strong>7.1 从Reactor到Proactor</strong></h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// Windows IOCP（完成端口）示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ProactorServer</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">start</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// 创建IOCP完成端口</span>
        HANDLE iocp = <span class="hljs-built_in">CreateIoCompletionPort</span>(INVALID_HANDLE_VALUE, 
                                            <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        
        <span class="hljs-comment">// 投递异步操作</span>
        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {
            OVERLAPPED* overlapped = <span class="hljs-built_in">create_overlapped</span>();
            <span class="hljs-built_in">WSARecv</span>(socket, &amp;buffer, <span class="hljs-number">1</span>, &amp;bytes_recvd, 
                   &amp;flags, overlapped, <span class="hljs-literal">NULL</span>);
        }
        
        <span class="hljs-comment">// 等待完成通知</span>
        <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) {
            DWORD bytes_transferred;
            ULONG_PTR completion_key;
            OVERLAPPED* overlapped;
            
            <span class="hljs-built_in">GetQueuedCompletionStatus</span>(iocp, &amp;bytes_transferred,
                                     &amp;completion_key, &amp;overlapped, INFINITE);
            
            <span class="hljs-comment">// 操作已完成，直接处理结果</span>
            <span class="hljs-built_in">process_completion</span>(completion_key, bytes_transferred, overlapped);
        }
    }
};
</code></pre>
<h3 data-id="heading-25"><strong>7.2 C++20协程与io_uring</strong></h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 使用C++20协程的异步服务器</span>
<span class="hljs-function">async_task&lt;<span class="hljs-type">void</span>&gt; <span class="hljs-title">handle_connection</span><span class="hljs-params">(io_uring&amp; ring, <span class="hljs-type">int</span> client_fd)</span> </span>{
    <span class="hljs-type">char</span> buffer[<span class="hljs-number">4096</span>];
    
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 异步读取（非阻塞）</span>
        <span class="hljs-type">ssize_t</span> n = <span class="hljs-keyword">co_await</span> <span class="hljs-built_in">async_read</span>(ring, client_fd, 
                                       buffer, <span class="hljs-built_in">sizeof</span>(buffer));
        
        <span class="hljs-comment">// 处理请求（可以在线程池中）</span>
        std::string response = <span class="hljs-keyword">co_await</span> <span class="hljs-built_in">async_process</span>(buffer, n);
        
        <span class="hljs-comment">// 异步写入</span>
        <span class="hljs-function"><span class="hljs-keyword">co_await</span> <span class="hljs-title">async_write</span><span class="hljs-params">(ring, client_fd, 
                            response.data(), response.size())</span></span>;
        
    } <span class="hljs-built_in">catch</span>(<span class="hljs-type">const</span> std::exception&amp; e) {
        std::cerr &lt;&lt; <span class="hljs-string">"Connection error: "</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;
    }
    
    ::<span class="hljs-built_in">close</span>(client_fd);
}

<span class="hljs-comment">// io_uring 是现代Linux的高性能异步I/O接口</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setup_io_uring</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">io_uring</span> ring;
    <span class="hljs-built_in">io_uring_queue_init</span>(<span class="hljs-number">32</span>, &amp;ring, <span class="hljs-number">0</span>);
    
    <span class="hljs-comment">// 提交多个I/O请求</span>
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
        <span class="hljs-keyword">struct</span> <span class="hljs-title class_">io_uring_sqe</span>* sqe = <span class="hljs-built_in">io_uring_get_sqe</span>(&amp;ring);
        <span class="hljs-built_in">io_uring_prep_read</span>(sqe, fd, buffer, size, offset);
        <span class="hljs-built_in">io_uring_sqe_set_data</span>(sqe, user_data);
    }
    
    <span class="hljs-comment">// 批量提交</span>
    <span class="hljs-built_in">io_uring_submit</span>(&amp;ring);
    
    <span class="hljs-comment">// 等待完成</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">io_uring_cqe</span>* cqe;
    <span class="hljs-built_in">io_uring_wait_cqe</span>(&amp;ring, &amp;cqe);
}
</code></pre>
<h2 data-id="heading-26"><strong>第八章：总结与最佳实践</strong></h2>
<h3 data-id="heading-27"><strong>8.1 Reactor模式的核心价值</strong></h3>
<ol>
<li><strong>资源效率</strong>：用少量线程服务大量连接</li>
<li><strong>可扩展性</strong>：连接数增长时性能下降缓慢</li>
<li><strong>响应性</strong>：避免单个慢连接影响其他连接</li>
<li><strong>模块化</strong>：清晰的关注点分离</li>
</ol>
<h3 data-id="heading-28"><strong>8.2 实施建议</strong></h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// Reactor实施检查清单</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactorChecklist</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">checklist</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// 1. 选择合适的I/O多路复用器</span>
        <span class="hljs-comment">//    - Linux: epoll (ET模式)</span>
        <span class="hljs-comment">//    - BSD: kqueue</span>
        <span class="hljs-comment">//    - Windows: IOCP（实际是Proactor）</span>
        
        <span class="hljs-comment">// 2. 使用非阻塞I/O</span>
        <span class="hljs-built_in">set_nonblocking</span>(fd);
        
        <span class="hljs-comment">// 3. 实现连接状态机</span>
        <span class="hljs-comment">//    每个连接维护明确的状态</span>
        
        <span class="hljs-comment">// 4. 分离I/O和业务处理</span>
        <span class="hljs-comment">//    I/O线程只做I/O，业务交给线程池</span>
        
        <span class="hljs-comment">// 5. 实现优雅关闭</span>
        <span class="hljs-comment">//    支持平滑重启</span>
        
        <span class="hljs-comment">// 6. 添加监控指标</span>
        <span class="hljs-comment">//    连接数、QPS、延迟、队列长度</span>
        
        <span class="hljs-comment">// 7. 实施限流和熔断</span>
        <span class="hljs-comment">//    防止过载</span>
        
        <span class="hljs-comment">// 8. 进行压力测试</span>
        <span class="hljs-comment">//    找到系统瓶颈</span>
    }
};
</code></pre>
<h3 data-id="heading-29"><strong>8.3 何时选择Reactor</strong></h3>
<p><strong>适合场景</strong>：</p>
<ul>
<li>高并发连接（&gt;1000）</li>
<li>I/O密集型应用</li>
<li>需要低延迟响应</li>
<li>长连接服务（如聊天、推送）</li>
</ul>
<p><strong>不适合场景</strong>：</p>
<ul>
<li>极低并发（&lt;100）</li>
<li>CPU密集型计算</li>
<li>简单的一次性请求</li>
</ul>
<h2 data-id="heading-30"><strong>结语</strong></h2>
<p>Reactor模式不是银弹，但它解决了C10K甚至C100K问题的核心挑战。从<code>select</code>到<code>epoll</code>，从单Reactor到多Reactor，从同步到异步，网络编程的演进始终围绕一个核心目标：<strong>用更少的资源服务更多的连接</strong>。</p>
<p>理解Reactor不仅是为了写出高性能服务器，更是为了掌握事件驱动编程的思想。这种思想已经渗透到现代软件的各个层面，从前端的React/Vue，到后端的Node.js/Nginx，再到操作系统的GUI事件循环。</p>
<p>正如计算机科学家Doug McIlroy所说："做一件事情，把它做好"。Reactor模式正是这一哲学在网络编程中的完美体现——它专注于事件分发这一件事，并做到了极致。</p>
<hr/>
<p><strong>进一步阅读</strong>：</p>
<ol>
<li>《UNIX网络编程 卷1：套接字联网API》</li>
<li>《Linux多线程服务端编程》</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[正则解决Markdown流式输出不完整图片、表格、数学公式]]></title>    <link>https://juejin.cn/post/7579068270293663770</link>    <guid>https://juejin.cn/post/7579068270293663770</guid>    <pubDate>2025-12-02T09:04:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579068270293663770" data-draft-id="7578877638988496896" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="正则解决Markdown流式输出不完整图片、表格、数学公式"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-02T09:04:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="隔壁的大叔"/> <meta itemprop="url" content="https://juejin.cn/user/1714893871660205"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            正则解决Markdown流式输出不完整图片、表格、数学公式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1714893871660205/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    隔壁的大叔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T09:04:42.000Z" title="Tue Dec 02 2025 09:04:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Markdown碎片处理</h2>
<p>在大模型SSE流式输出的时候，往往返回的是Markdown字符串。其他类型比如 <code>#</code> <code>*</code> <code>-</code>等，实时渲染的时候抖动是比较小的，但是像图片链接、表格、块级数学公式在渲染的时候往往会造成剧烈的页面抖动，用户体验不友好。接下来我们就一一解决这三个场景。</p>
<h3 data-id="heading-1">不完整图片链接</h3>
<pre><code class="hljs language-md" lang="md">
//不完整图片链接
![Vue Logo](https://img0.

//完整图片链接
![<span class="hljs-string">Vue Logo</span>](<span class="hljs-link">https://img0.baidu.com/it/u=736188794,4119241415&amp;fm=253&amp;fmt=auto&amp;app=120&amp;f=JPEG?w=1140&amp;h=760 "Vue.js Logo"</span>)


</code></pre>
<p>渲染效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/effacd94fdad4a0cbb9d1bc0791ffb33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZqU5aOB55qE5aSn5Y-U:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273092&amp;x-signature=w8d7h60wGGCRjcwUqB0o6Tau%2BMg%3D" alt="image.png" loading="lazy"/></p>
<p>处理这种不完整的链接我们可以直接正则匹配替换掉不完整的图片链接为空，等链接完整后再做渲染</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 处理图片流式碎片
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">markdown</span> - 原始 Markdown 字符串
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">string</span>} 清理后的 Markdown 字符串
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">stripBrokenImages</span>(<span class="hljs-params">md</span>) {
  <span class="hljs-keyword">if</span>(<span class="hljs-title function_">typeof</span>(md) !== <span class="hljs-string">'string'</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'%c v3-markdown-stream：请传正确的md字符串～ '</span>,<span class="hljs-string">'background:#ea2039;color:#ffffff;padding:2px 5px;'</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
  }
  <span class="hljs-keyword">if</span>(!md) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
  }
  md = md.<span class="hljs-title function_">replace</span>(
    <span class="hljs-regexp">/^\s*\[([^\]]+)\]:[ \t]*(\S+)(?:[ \t]+(["'])(?:(?!\3)[\s\S])*?)?$/gm</span>,
    <span class="hljs-function">(<span class="hljs-params">s, id, src, quote</span>) =&gt;</span> {
      <span class="hljs-comment">// 如果捕获到开启引号却没闭合，或者 src 后直接换行（缺引号），都认为不完整</span>
      <span class="hljs-keyword">if</span> (quote &amp;&amp; !s.<span class="hljs-title function_">endsWith</span>(quote)) <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>; <span class="hljs-comment">// 引号没闭合</span>
      <span class="hljs-keyword">if</span> (!quote &amp;&amp; <span class="hljs-regexp">/["']$/</span>.<span class="hljs-title function_">test</span>(src)) <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>; <span class="hljs-comment">// src 结尾多余引号，也视为异常</span>
      <span class="hljs-keyword">return</span> s; <span class="hljs-comment">// 完整定义，保留</span>
    }
  );
  md = md.<span class="hljs-title function_">replace</span>(
    <span class="hljs-regexp">/!\[([^\]]*)\]\(([^)]*(?:\([^)]*\)[^)]*)*)\)/g</span>,
    <span class="hljs-function">(<span class="hljs-params">s, alt, body</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> open = (body.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/\(/g</span>) || []).<span class="hljs-property">length</span>;
      <span class="hljs-keyword">const</span> close = (body.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/\)/g</span>) || []).<span class="hljs-property">length</span>;
      <span class="hljs-keyword">if</span> (open !== close) <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>; <span class="hljs-comment">// 括号不匹配 → 不完整</span>
      <span class="hljs-keyword">if</span> (body.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'"'</span>) &amp;&amp; (body.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/"/g</span>) || []).<span class="hljs-property">length</span> % <span class="hljs-number">2</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
      <span class="hljs-keyword">if</span> (body.<span class="hljs-title function_">includes</span>(<span class="hljs-string">"'"</span>) &amp;&amp; (body.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/'/g</span>) || []).<span class="hljs-property">length</span> % <span class="hljs-number">2</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
      <span class="hljs-keyword">return</span> s; <span class="hljs-comment">// 完整，保留</span>
    }
  );
  <span class="hljs-keyword">return</span> md.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/!\[[^\]]*\]\([^)]*$/g</span>, <span class="hljs-string">""</span>);
}
</code></pre>
<h3 data-id="heading-2">不完整表格字符串</h3>
<pre><code class="hljs language-md" lang="md">//不完整表格字符串
| 姓名 | 年龄 | 职业 |
|------|-----

//完整表格字符串
| 姓名 | 年龄 | 职业 |
|------|------|------|
| 张三 | 25   | 工程师 |
| 李四 | 30   | 设计师 |
| 王五 | 28   | 产品经理 |



</code></pre>
<p>渲染效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/959c4663a7524ae4badbbc34561f05cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZqU5aOB55qE5aSn5Y-U:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273092&amp;x-signature=gwtjQB7zzMPwNS%2B8tPLYgPr06DM%3D" alt="image.png" loading="lazy"/></p>
<p>处理这种不完整的表格字符串，我们也可以使用正则替换掉不完整的表格字符串</p>
<p><mark>注意：一旦分隔符和表头数量一致后就可以放行渲染，避免等待时间过长</mark></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 过滤流式输出中结构不完整的表格字符串
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">content</span> - 流式输出的原始内容
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">string</span>} 过滤后的内容（仅保留合法表格，非法表格替换为空）
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">filterInvalidTables</span>(<span class="hljs-params">content</span>) {
  <span class="hljs-comment">// 表头加载完成后过滤</span>
  <span class="hljs-comment">// const tableRegex = /(?:^\|(?:\s*.+?\s*)?\|?$[\n\r]?)+(?:^\|(?:\s*[-:]+)+(?:\s*\|\s*[-:]+)*\s*\|?$[\n\r]?)+(?:^\|(?:\s*.+?\s*)?\|?$[\n\r]?)*(?=\n|$)/gm;</span>
  <span class="hljs-comment">//宽松模式过滤</span>
  <span class="hljs-keyword">const</span> tableRegex = <span class="hljs-regexp">/^\|(?:\s*.+?\s*)?\|?$(?:\r?\n^\|(?:\s*[-:]+)+(?:\s*\|\s*[-:]+)*\s*\|?$(?:\r?\n^\|(?:\s*.+?\s*)?\|?$)*)?/gm</span>;
  <span class="hljs-keyword">return</span> content.<span class="hljs-title function_">replace</span>(tableRegex, <span class="hljs-function">(<span class="hljs-params">match</span>) =&gt;</span> {
    <span class="hljs-comment">// 分割表头行和分隔符行</span>
    <span class="hljs-keyword">const</span> lines = match.<span class="hljs-title function_">trim</span>().<span class="hljs-title function_">split</span>(<span class="hljs-regexp">/[\r\n]+/</span>).<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">line</span> =&gt;</span> line.<span class="hljs-title function_">trim</span>());
    <span class="hljs-keyword">if</span> (lines.<span class="hljs-property">length</span> &lt; <span class="hljs-number">2</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>; <span class="hljs-comment">// 至少需要表头行 + 分隔符行</span>
    <span class="hljs-comment">// 最后一行表头（处理多行表头场景）</span>
    <span class="hljs-keyword">const</span> headerLine = lines[<span class="hljs-number">0</span>].<span class="hljs-title function_">trim</span>();
    <span class="hljs-comment">// 分隔符行</span>
    <span class="hljs-keyword">const</span> separatorLine = lines[<span class="hljs-number">1</span>].<span class="hljs-title function_">trim</span>();

    <span class="hljs-comment">// 提取表头列数：分割 | 后，过滤空字符串（处理前后 | 的情况）</span>
    <span class="hljs-keyword">const</span> headerColumns = headerLine.<span class="hljs-title function_">split</span>(<span class="hljs-string">'|'</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">col</span> =&gt;</span> col.<span class="hljs-title function_">trim</span>()).<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">col</span> =&gt;</span> col);
    <span class="hljs-keyword">const</span> headerCount = headerColumns.<span class="hljs-property">length</span>;

    <span class="hljs-comment">// 提取分隔符列数：分割 | 后，过滤空字符串，且必须包含至少1个 -</span>
    <span class="hljs-keyword">const</span> separatorColumns = separatorLine.<span class="hljs-title function_">split</span>(<span class="hljs-string">'|'</span>)
      .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">col</span> =&gt;</span> col.<span class="hljs-title function_">trim</span>())
      .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">col</span> =&gt;</span> col &amp;&amp; <span class="hljs-regexp">/-/</span>.<span class="hljs-title function_">test</span>(col)); <span class="hljs-comment">// 分隔符必须包含 -</span>
    <span class="hljs-keyword">const</span> separatorCount = separatorColumns.<span class="hljs-property">length</span>;

    <span class="hljs-comment">// 仅当列数完全一致时保留表格，否则替换为空</span>
    <span class="hljs-keyword">return</span> (headerCount === separatorCount &amp;&amp; headerCount&gt;<span class="hljs-number">0</span> &amp;&amp; separatorCount&gt;<span class="hljs-number">0</span>) ? match : <span class="hljs-string">''</span>;
  });
}
</code></pre>
<h3 data-id="heading-3">不完整的数学公式</h3>
<pre><code class="hljs language-md" lang="md">//完整的数学公式
$$
\\frac{n!}{k!(n-k)!} = \\binom{n}{k}
$$

//不完整的数学公式
$$
\\frac{n!}{k!(n-k)!
</code></pre>
<p>渲染效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a398d607775345d7b470ddc5a311a099~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZqU5aOB55qE5aSn5Y-U:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273092&amp;x-signature=GBae1qFwJ%2Bn9L2rvi25d%2FULsDzQ%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3216b6849265454a8288d7e4ce210437~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZqU5aOB55qE5aSn5Y-U:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273092&amp;x-signature=uUn7%2BilXSqstoO4a3hFvHO9T4%2F8%3D" alt="image.png" loading="lazy"/></p>
<p>针对这种也可以使用正则替换不完整的代码块为空</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 清除 Markdown 中未闭合的块级公式（$$ 开头未闭合）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">markdown</span> - 原始 Markdown 字符串
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">string</span>} 处理后的 Markdown 字符串
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">clearUnclosedBlockMath</span>(<span class="hljs-params">markdown</span>) {
  <span class="hljs-comment">// 正则说明：</span>
  <span class="hljs-comment">// 1. /\$\$(?!.*?\$\$).*$/s - 核心正则</span>
  <span class="hljs-comment">// 2. \$\$ - 匹配块级公式开始标记</span>
  <span class="hljs-comment">// 3. (?!.*?\$\$) - 正向否定预查：确保后面没有 $$ 闭合（非贪婪匹配任意字符）</span>
  <span class="hljs-comment">// 4. .*$ - 匹配从 $$ 开始到字符串结束的所有内容</span>
  <span class="hljs-comment">// 5. s 修饰符 - 让 . 匹配换行符（支持多行公式）</span>
  <span class="hljs-comment">// 6. g 修饰符 - 全局匹配（处理多个未闭合公式的极端情况）</span>
  <span class="hljs-keyword">return</span> markdown.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\$\$(?!.*?\$\$).*$/g</span>s, <span class="hljs-string">''</span>);
}
</code></pre>
<h3 data-id="heading-4">结语</h3>
<p>正则在处理这种问题的时候，简单粗暴但有用，有点俄式美学的味道～
最后，如果你觉得这个文章对你有帮助，不妨点个赞并分享给更多的开发者朋友，让我们一起让 Markdown 解析变得更简单、更强大！</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxhy12345%2Fv3-markdown-stream" target="_blank" title="https://github.com/xhy12345/v3-markdown-stream" ref="nofollow noopener noreferrer">GitHub源码仓库地址</a>
如果觉得好用，欢迎给个Star ⭐️ 支持一下！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 的“时光胶囊”：useRef 才是那个打破“闭包陷阱”的救世主]]></title>    <link>https://juejin.cn/post/7578917474659614771</link>    <guid>https://juejin.cn/post/7578917474659614771</guid>    <pubDate>2025-12-02T09:08:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578917474659614771" data-draft-id="7578803751608549426" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 的“时光胶囊”：useRef 才是那个打破“闭包陷阱”的救世主"/> <meta itemprop="keywords" content="前端,React.js,设计模式"/> <meta itemprop="datePublished" content="2025-12-02T09:08:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大布布将军"/> <meta itemprop="url" content="https://juejin.cn/user/1535361573994189"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 的“时光胶囊”：useRef 才是那个打破“闭包陷阱”的救世主
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1535361573994189/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大布布将军
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T09:08:44.000Z" title="Tue Dec 02 2025 09:08:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言：它不仅仅是 <code>document.getElementById</code></h2>
<p>如果去面试 React 开发岗位，问到 <code>useRef</code> 是干嘛的，90% 的候选人会说：“用来获取 DOM 元素，比如给 input 设置焦点。”</p>
<p>这就好比你买了一台最新的 iPhone 15 Pro Max，结果只用来打电话。</p>
<p>在 React 的函数式组件（Functional Component）世界里，<code>useRef</code> 其实是一个<strong>法外之地</strong>。
它是你在严格的“不可变数据流”和“频繁重渲染”中，唯一的<strong>逃生舱（Escape Hatch）</strong>。</p>
<p>今天咱们不聊怎么 <code>input.focus()</code>，咱们来聊聊怎么用 <code>useRef</code> 搞定那些 <code>useState</code> 和 <code>useEffect</code> 搞不定的烂摊子。</p>
<hr/>
<h2 data-id="heading-1">核心概念：它是一个“静音”的盒子</h2>
<p>首先，你得把 <code>useRef</code> 理解成一个盒子。</p>
<ul>
<li><strong><code>useState</code></strong>：是<strong>大喇叭</strong>。你改了里面的值，React 立马大喊：“数据变了！所有组件起立，重新渲染！”</li>
<li><strong><code>useRef</code></strong>：是<strong>静音抽屉</strong>。你偷偷把里面的值改了，React 根本不知道，组件该干嘛干嘛，不会触发重渲染。</li>
</ul>
<p>而且，最最重要的是：<strong>组件每次重渲染，这个盒子都是同一个盒子（内存地址不变）。</strong></p>
<p>这就赋予了它两个神级能力：<strong>“穿越时空”</strong> 和 <strong>“暗度陈仓”</strong>。</p>
<hr/>
<h2 data-id="heading-2">骚操作一：破解“闭包陷阱” (Stale Closure)</h2>
<p>这是所有 React 新手的噩梦。</p>
<p><strong>场景</strong>：你想写一个定时器，每秒打印一下当前的 count 值。</p>
<h3 data-id="heading-3">❌ 翻车现场：</h3>
<pre><code class="hljs language-scss" lang="scss">const <span class="hljs-selector-attr">[count, setCount]</span> = <span class="hljs-built_in">useState</span>(<span class="hljs-number">0</span>);

<span class="hljs-built_in">useEffect</span>(() =&gt; {
  const timer = <span class="hljs-built_in">setInterval</span>(() =&gt; {
    <span class="hljs-comment">// 💀 恐怖故事：这里永远打印 0</span>
    console<span class="hljs-selector-class">.log</span>('Current Count:', count);
  }, <span class="hljs-number">1000</span>);

  return () =&gt; <span class="hljs-built_in">clearInterval</span>(timer);
}, <span class="hljs-selector-attr">[]</span>); <span class="hljs-comment">// 依赖数组为空，effect 只跑一次</span>
</code></pre>
<p><strong>为什么？</strong> 因为 <code>useEffect</code> 执行的那一瞬间（Mount 时），它捕获了当时的 <code>count</code>（也就是 0）。就像拍了一张照片，照片里的人永远定格在那一刻。哪怕外面 <code>count</code> 变成了 100，定时器闭包里的 <code>count</code> 还是 0。</p>
<p><strong>✅ useRef 救场：</strong></p>
<p>我们要用 <code>useRef</code> 造一个“时光胶囊”，永远保存<strong>最新</strong>的值。</p>
<pre><code class="hljs language-const" lang="const">// 1. 创建一个胶囊
const countRef = useRef(count);

// 2. 每次渲染，都把最新的值塞进胶囊里
// 注意：修改 ref 不会触发渲染，所以这里很安全
countRef.current = count;

useEffect(() =&gt; {
  const timer = setInterval(() =&gt; {
    // 3. 定时器里读胶囊里的值，而不是读外面的快照
    console.log('Current Count:', countRef.current); 
  }, 1000);

  return () =&gt; clearInterval(timer);
}, []); // 依然不需要依赖 count，定时器也不用重启
</code></pre>
<p>这就是 <code>useRef</code> 的“穿透”能力。它打破了闭包的限制，让你在旧的 Effect 里读到了新的 State。</p>
<h2 data-id="heading-4">骚操作二：记录“上一次”的值 (usePrevious)</h2>
<p>在 Class 组件时代，我们有 <code>componentDidUpdate(prevProps)</code>，可以很方便地对比新旧数据。 到了 Hooks 时代，官方竟然没给这个功能？</p>
<p>别急，<code>useRef</code> 既然能存值，那就能存“前任”。</p>
<h3 data-id="heading-5">手写一个 <code>usePrevious</code> Hook：</h3>
<pre><code class="hljs language-function" lang="function">  // 创建一个 ref 来存储值
  const ref = useRef();

  // 每次渲染后，把当前值存进去
  // 注意：useEffect 是在渲染*之后*执行的
  useEffect(() =&gt; {
    ref.current = value;
  }, [value]);

  // 返回 ref 里的值
  // 注意：也就是在本次渲染时，ref.current 还是*上一次*存进去的值
  return ref.current;
}

// 使用
const Demo = () =&gt; {
  const [count, setCount] = useState(0);
  const prevCount = usePrevious(count);

  return (
    &lt;div&gt;
      &lt;p&gt;现在是: {count}&lt;/p&gt;
      &lt;p&gt;刚才还是: {prevCount}&lt;/p&gt;
    &lt;/div&gt;
  );
};
</code></pre>
<p><strong>原理分析：</strong></p>
<ol>
<li><strong>Render 1 (count=0)</strong> : <code>usePrevious</code> 返回 <code>undefined</code>。Render 结束，Effect 运行，<code>ref.current</code> 变为 0。</li>
<li><strong>Render 2 (count=1)</strong> : <code>usePrevious</code> 返回 <code>ref.current</code> (也就是 0)。Render 结束，Effect 运行，<code>ref.current</code> 变为 1。</li>
</ol>
<p>你看，不需要任何魔法，只是利用了 React 的执行顺序，就实现了“时光倒流”。</p>
<hr/>
<h2 data-id="heading-6">骚操作三：防止“初次渲染”执行 Effect</h2>
<p>有时候，我们希望 <code>useEffect</code> 只有在依赖变化时执行，而<strong>不要</strong>在组件刚挂载（Mount）时执行。</p>
<p>比如：用户修改搜索词时发请求，但刚进页面时不要发。</p>
<pre><code class="hljs language-const" lang="const">
useEffect(() =&gt; {
  // 如果是第一次，把开关关掉，直接 return，啥也不干
  if (isFirstMount.current) {
    isFirstMount.current = false;
    return;
  }

  // 从第二次开始，这里的逻辑才会执行
  console.log('搜索词变了，发起请求...');
}, [query]);
</code></pre>
<p>这简直就是控制 Effect 执行时机的最强“阀门”。</p>
<hr/>
<h2 data-id="heading-7">总结：使用 <code>useRef</code> 的红线</h2>
<p>虽然 <code>useRef</code> 很爽，既能穿透闭包，又能静默更新，但请记住一条<strong>铁律</strong>：</p>
<p><strong>永远不要在渲染期间（Rendering Logic）读取或写入 <code>ref.current</code>。</strong></p>
<pre><code class="hljs language-const" lang="const">  const count = useRef(0);
  
  // ❌ 报错警告！这是不纯的操作！
  // 在渲染过程中修改 ref，会导致行为不可预测
  count.current = count.current + 1; 

  // ❌ 也不要直接读来做渲染判断
  // 因为 ref 变了不会触发重绘，视图可能不会更新
  return &lt;div&gt;{count.current}&lt;/div&gt;;
};
</code></pre>
<p><strong>正确的使用姿势：</strong></p>
<ul>
<li>在 <code>useEffect</code> 里读/写。</li>
<li>在 <code>Event Handler</code>（点击事件等）里读/写。</li>
<li>总之，别在 return JSX 之前的那个函数体里直接搞事。</li>
</ul>
<p><code>useRef</code> 是 React 留给我们的后门，当你发现 <code>useState</code> 让你的组件频繁渲染卡顿，或者 <code>useEffect</code> 的依赖数组让你头秃时，不妨想想这个静音的小盒子。</p>
<p>好了，收工。</p>
<blockquote>
<p><strong>下期预告</strong>：你真的以为你会写 <code>useCallback</code> 和 <code>useMemo</code> 吗？我打赌你的代码里 80% 的 <code>useMemo</code> 都在做负优化。下一篇，我们来聊聊 React 性能优化的“安慰剂效应”。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Swift 中的async和await]]></title>    <link>https://juejin.cn/post/7578948893762551835</link>    <guid>https://juejin.cn/post/7578948893762551835</guid>    <pubDate>2025-12-02T09:10:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578948893762551835" data-draft-id="7578836326474940443" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Swift 中的async和await"/> <meta itemprop="keywords" content="iOS,Swift"/> <meta itemprop="datePublished" content="2025-12-02T09:10:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Haha_bj"/> <meta itemprop="url" content="https://juejin.cn/user/2612027844214647"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Swift 中的async和await
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612027844214647/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Haha_bj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T09:10:53.000Z" title="Tue Dec 02 2025 09:10:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>异步编程</code>是指程序在执行任务时，不需要等待任务完成才能继续执行其他任务。传统的同步编程方式会导致程序等待某个操作完成（比如网络请求、磁盘读写等），直到任务完成后才会继续执行，可能会造成性能瓶颈。异步编程允许程序在等待某个操作时去执行其他任务，从而提高效率。</p>
<p><code>async</code> 和 <code>await</code> 是 Swift 5.5 引入的用于处理异步编程的关键字，它们使得处理异步任务变得更加简单和直观。它们提供了一种新的方式来管理异步操作，相比传统的回调函数或闭包，<code>async</code>/<code>await</code> 更接近同步代码的写法，让代码更加易读和可维护。</p>
<h3 data-id="heading-0">一、<code>async</code> 和 <code>await</code></h3>
<ul>
<li><strong><code>async</code></strong>: 用于标记一个函数为异步函数。异步函数会返回一个 <code>Task</code> 类型，可以在执行时暂停，直到结果准备好。</li>
<li><strong><code>await</code></strong>: 用于暂停函数的执行，直到异步操作完成并返回结果。</li>
</ul>
<h4 data-id="heading-1">1、<strong>标记异步函数</strong></h4>
<p>使用 <code>async</code> 关键字来定义一个异步函数，表示这个函数包含异步操作，并且可能需要一些时间来执行。</p>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">handleData</span>() <span class="hljs-keyword">async</span> -&gt;<span class="hljs-type">String</span>{
        
        <span class="hljs-comment">// 模拟网络请求，慢处理等</span>
        
        <span class="hljs-keyword">return</span> <span class="hljs-string">"handle data"</span>
    }
</code></pre>
<p><code>handleData()</code>是一个异步函数，它返回一个字符串。函数内部的操作可能会是一个耗时操作，虽然这里没有具体的异步代码，但它表示这段代码可以用异步方式进行处理。</p>
<h4 data-id="heading-2">2、 <strong>调用异步函数</strong></h4>
<p>调用一个异步函数，必须在一个异步上下文中使用 <code>await</code> 关键字。<code>await</code> 会暂停当前的代码执行，直到异步函数返回结果。</p>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-comment">/// 去调用异步任务</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">callAsync</span>() <span class="hljs-keyword">async</span>{
        <span class="hljs-comment">/// 等待异常函数返回结果</span>
        <span class="hljs-keyword">let</span> result <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> handleData()
        <span class="hljs-built_in">print</span>(result)
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">handleData</span>() <span class="hljs-keyword">async</span> -&gt;<span class="hljs-type">String</span>{
        <span class="hljs-comment">// 模拟网络请求，慢处理等</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"handle data"</span>
    }
</code></pre>
<h4 data-id="heading-3">3 <strong>异步任务的创建</strong></h4>
<p>使用 <code>Task</code> 来创建异步任务。<code>Task</code> 允许你在异步上下文之外执行异步代码。</p>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() {
        <span class="hljs-keyword">super</span>.viewDidLoad()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"1"</span>)
        <span class="hljs-type">Task</span> {
            <span class="hljs-comment">/// 等待异常函数返回结果</span>
            <span class="hljs-keyword">let</span> result <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> handleData()
            <span class="hljs-built_in">print</span>(result)
        }
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"2"</span>)
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">handleData</span>() <span class="hljs-keyword">async</span> -&gt;<span class="hljs-type">String</span>{
        <span class="hljs-comment">// 模拟网络请求，慢处理等</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"handle data"</span>
    }
    
    <span class="hljs-comment">// 打印信息 1 、 2 、 handle data</span>
</code></pre>
<p><code>Task</code> 是一个异步任务，它会自动创建一个新的异步上下文来执行异步代码。<code>当你需要在不直接处于异步函数内部的地方执行异步代码时。</code></p>
<h3 data-id="heading-4">二、<strong><code>async</code> 和 <code>await</code> 与传统的闭包回调对比</strong></h3>
<p>传统的异步编程中，我们可能会使用闭包来处理异步操作的回调</p>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() {
        <span class="hljs-keyword">super</span>.viewDidLoad()
        
        handleData { data <span class="hljs-keyword">in</span>
            <span class="hljs-built_in">print</span>(data)
        }
       
    }
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">handleData</span>(<span class="hljs-params">completion</span>: <span class="hljs-keyword">@escaping</span>(<span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Void</span>){
        <span class="hljs-type">DispatchQueue</span>.main.async {
            <span class="hljs-keyword">let</span> data <span class="hljs-operator">=</span> <span class="hljs-string">"handle data"</span>
            completion(data)
        }
    }
</code></pre>
<p>使用 <code>async</code> 和 <code>await</code> 后，你可以这样写</p>
<pre><code class="hljs language-Swift" lang="Swift"> <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() {
         <span class="hljs-keyword">super</span>.viewDidLoad()
         <span class="hljs-type">Task</span> {
             <span class="hljs-comment">/// 等待异常函数返回结果</span>
             <span class="hljs-keyword">let</span> result <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> handleData()
             <span class="hljs-built_in">print</span>(result)
         }
     }

     <span class="hljs-keyword">func</span> <span class="hljs-title function_">handleData</span>() <span class="hljs-keyword">async</span> -&gt;<span class="hljs-type">String</span>{
         <span class="hljs-comment">// 模拟网络请求，慢处理等</span>
         <span class="hljs-keyword">return</span> <span class="hljs-string">"handle data"</span>
     }
</code></pre>
<p>相比使用闭包，<code>async</code> 和 <code>await</code> 更加简洁、直观。</p>
<h3 data-id="heading-5">三、<strong>错误处理</strong></h3>
<p>异步函数中，错误处理通常使用 <code>do-catch</code> 语句来处理。你可以在异步函数中抛出错误，并使用 <code>await</code> 来捕获和处理它们</p>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">jlDataError</span>: <span class="hljs-title class_">Error</span>{
    <span class="hljs-keyword">case</span> invalidData
}

 <span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewController</span>: <span class="hljs-title class_">UIViewController</span> {

     <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() {
         <span class="hljs-keyword">super</span>.viewDidLoad()
         <span class="hljs-type">Task</span> {
             <span class="hljs-keyword">do</span> {
                 <span class="hljs-keyword">let</span> result <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> handleData()
                 <span class="hljs-built_in">print</span>(result)
             } <span class="hljs-keyword">catch</span>{
                 <span class="hljs-built_in">print</span>(<span class="hljs-string">"Error:<span class="hljs-subst">\(error)</span>"</span>)
             }
             
         }

     }

     <span class="hljs-keyword">func</span> <span class="hljs-title function_">handleData</span>() <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt;<span class="hljs-type">String</span>{
         
         <span class="hljs-keyword">let</span> success <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
         <span class="hljs-keyword">if</span> success <span class="hljs-operator">==</span> <span class="hljs-literal">false</span>{
             <span class="hljs-keyword">throw</span> jlDataError.invalidData
         }
         <span class="hljs-comment">// 模拟网络请求，慢处理等</span>
         <span class="hljs-keyword">return</span> <span class="hljs-string">"handle data"</span>
     }
     
 }
</code></pre>
<p>上述代码中，<code>handleData()</code> 可能会抛出 <code>DataError.invalidData</code> 错误，调用它时需要使用 <code>try await</code> 来捕获和处理错误。</p>
<h3 data-id="heading-6">四、 <strong>并发执行多个异步任务</strong></h3>
<p>可以使用 <code>async let</code> 来并行执行多个异步任务，并且在最后获取它们的结果。这是一个非常强大的功能，尤其是当你需要同时处理多个异步操作时。</p>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() {
         <span class="hljs-keyword">super</span>.viewDidLoad()
         <span class="hljs-type">Task</span> {
             <span class="hljs-comment">// 异步并发任务</span>
             <span class="hljs-keyword">async</span> <span class="hljs-keyword">let</span> handleData1 <span class="hljs-operator">=</span> handleData1()
             <span class="hljs-comment">// 异步并发任务</span>
             <span class="hljs-keyword">async</span> <span class="hljs-keyword">let</span> handleData2 <span class="hljs-operator">=</span> handleData2()
             <span class="hljs-comment">// 等待结果</span>
             <span class="hljs-keyword">let</span> r1 <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> handleData1
             <span class="hljs-keyword">let</span> r2 <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> handleData2
             <span class="hljs-built_in">print</span>(r1,r2)
             
         }

     }

     <span class="hljs-keyword">func</span> <span class="hljs-title function_">handleData1</span>() <span class="hljs-keyword">async</span>  -&gt;<span class="hljs-type">String</span>{
        
         <span class="hljs-comment">// 模拟网络请求，慢处理等</span>
         <span class="hljs-keyword">return</span> <span class="hljs-string">"handle data1"</span>
     }
     
     <span class="hljs-keyword">func</span> <span class="hljs-title function_">handleData2</span>() <span class="hljs-keyword">async</span>  -&gt;<span class="hljs-type">String</span>{
        
         <span class="hljs-comment">// 模拟网络请求，慢处理等</span>
         <span class="hljs-keyword">return</span> <span class="hljs-string">"handle data2"</span>
     }
</code></pre>
<p>在上面的代码中，<code>handleData1</code> 和 <code>handleData2</code> 会并行执行，最终我们使用 <code>await</code> 来获取它们的结果。</p>
<h3 data-id="heading-7"><strong>总结</strong></h3>
<p><code>async</code> 和 <code>await</code> 是处理异步操作的核心工具，它们通过提供一种类似同步代码的结构，使得异步编程更加简单和清晰。使用这些特性，你可以：</p>
<ul>
<li>简化代码，使其更加易读和维护。</li>
<li>避免回调地狱（callback hell）和嵌套的闭包。</li>
<li>更容易进行错误处理。</li>
<li>使并发执行变得简单，减少手动管理异步任务的复杂度。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain Tools —— 让 AI 拥有「双手」]]></title>    <link>https://juejin.cn/post/7578853751531110415</link>    <guid>https://juejin.cn/post/7578853751531110415</guid>    <pubDate>2025-12-02T08:30:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578853751531110415" data-draft-id="7578877638988431360" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain Tools —— 让 AI 拥有「双手」"/> <meta itemprop="keywords" content="LangChain,Node.js,AI编程"/> <meta itemprop="datePublished" content="2025-12-02T08:30:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Dr_哈哈"/> <meta itemprop="url" content="https://juejin.cn/user/2208293602984286"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain Tools —— 让 AI 拥有「双手」
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2208293602984286/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Dr_哈哈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T08:30:52.000Z" title="Tue Dec 02 2025 08:30:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">LangChain Tools 知识点详解</h2>
<blockquote>
<p>让 AI 拥有「双手」—— Tools 是 LangChain 中最强大的功能之一</p>
</blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fjs.langchain.com%2F" target="_blank" title="https://js.langchain.com/" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75c0964f1ed64b6cbfb1ae119cb59be7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRHJf5ZOI5ZOI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765269052&amp;x-signature=QHPRT4SjH5uqU9cx1jcLds2rsK4%3D" alt="LangChain" loading="lazy"/></a>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2F" target="_blank" title="https://nodejs.org/" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc89e9ba08664627a0ecbb61b8885546~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRHJf5ZOI5ZOI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765269052&amp;x-signature=ii8Lbk2moh%2BazLzHRDy1ylogky8%3D" alt="Node.js" loading="lazy"/></a>
<a href="https://link.juejin.cn?target=LICENSE" target="_blank" title="LICENSE" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5fa8433112749288e01c79961881b56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRHJf5ZOI5ZOI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765269052&amp;x-signature=InfnRUfLXyl%2F05a8CLZ%2FfjnnuqE%3D" alt="License" loading="lazy"/></a></p>
<h3 data-id="heading-1">📖 前言</h3>
<p><strong>你是否遇到过这些问题？</strong></p>
<ul>
<li>🤔 让 AI 查询实时信息，它却说"我的知识截止到..."</li>
<li>🤔 让 AI 做精确计算，它却给出一个估算值</li>
<li>🤔 想让 AI 调用你的 API，却不知道从何下手</li>
</ul>
<p><strong>LangChain Tools 就是解决这些问题的利器！</strong></p>
<p>本文将带你从零开始，系统学习 LangChain Tools 的使用方法。无论你是 AI 开发新手还是有经验的开发者，都能从中获得实用的知识和技巧。</p>
<h4 data-id="heading-2">✨ 本文特色</h4>
<ul>
<li>📚 <strong>系统全面</strong> - 从概念到实战，循序渐进</li>
<li>💻 <strong>代码丰富</strong> - 每个知识点都有可运行的示例</li>
<li>🔧 <strong>真实案例</strong> - 包含 TavilySearch 等真实 API 集成</li>
<li>🎯 <strong>实战导向</strong> - 提供完整的动手实践任务</li>
</ul>
<hr/>
<h3 data-id="heading-3">🚀 快速开始 - 环境搭建（5 分钟）</h3>
<blockquote>
<p>在开始学习之前，让我们先搭建好开发环境，确保后面的每个案例都能运行！</p>
</blockquote>
<h4 data-id="heading-4">第 1 步：安装 Trae 编辑器</h4>
<p><a href="https://www.trae.ai/" target="_blank" title="https://www.trae.ai/" ref="nofollow noopener noreferrer">Trae</a> 是字节跳动推出的 AI 原生 IDE，内置强大的 AI 助手，特别适合学习 AI 开发：</p>

























<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td><strong>AI 代码助手</strong></td><td>内置 Claude/GPT，遇到问题可直接询问</td></tr><tr><td><strong>智能补全</strong></td><td>AI 驱动的代码补全，提高开发效率</td></tr><tr><td><strong>中文友好</strong></td><td>完善的中文界面和 AI 中文对话支持</td></tr><tr><td><strong>完全免费</strong></td><td>个人版免费使用，无需付费</td></tr></tbody></table>
<p><strong>安装步骤：</strong></p>
<ol>
<li>访问 <a href="https://www.trae.ai/" target="_blank" title="https://www.trae.ai/" ref="nofollow noopener noreferrer">www.trae.ai/</a></li>
<li>下载并安装 Trae 编辑器（支持 Mac/Windows）</li>
<li>打开 Trae，登录账号</li>
</ol>
<h4 data-id="heading-5">第 2 步：创建项目</h4>
<p>打开 Trae，创建一个新的文件夹作为学习项目：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建项目文件夹</span>
<span class="hljs-built_in">mkdir</span> langchain-tools-demo
<span class="hljs-built_in">cd</span> langchain-tools-demo

<span class="hljs-comment"># 初始化 Node.js 项目</span>
npm init -y
</code></pre>
<h4 data-id="heading-6">第 3 步：安装依赖</h4>
<p>在 Trae 终端（快捷键 <code>Ctrl + `</code> 或 <code>Cmd + `</code>）中执行：</p>
<pre><code class="hljs language-bash" lang="bash">npm install @langchain/core @langchain/deepseek zod dotenv
</code></pre>
<p><strong>依赖说明：</strong></p>

























<table><thead><tr><th>包名</th><th>作用</th></tr></thead><tbody><tr><td><code>@langchain/core</code></td><td>LangChain 核心库，包含 Tool 相关 API</td></tr><tr><td><code>@langchain/deepseek</code></td><td>DeepSeek 大模型集成</td></tr><tr><td><code>zod</code></td><td>Schema 验证库，用于定义工具参数</td></tr><tr><td><code>dotenv</code></td><td>环境变量管理</td></tr></tbody></table>
<h4 data-id="heading-7">第 4 步：配置环境变量</h4>
<p>在项目根目录创建 <code>.env</code> 文件：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># DeepSeek API Key（必需）</span>
<span class="hljs-comment"># 获取地址: https://platform.deepseek.com/</span>
DEEPSEEK_API_KEY=sk-xxxxxxxxxxxxxxxx
</code></pre>
<blockquote>
<p>💡 <strong>如何获取 DeepSeek API Key？</strong></p>
<ol>
<li>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.deepseek.com%2F" target="_blank" title="https://platform.deepseek.com/" ref="nofollow noopener noreferrer">platform.deepseek.com/</a></li>
<li>注册并登录账号</li>
<li>在 API Keys 页面创建新的 Key</li>
<li>新用户赠送免费额度，足够学习使用</li>
</ol>
</blockquote>
<h4 data-id="heading-8">第 5 步：配置 package.json</h4>
<p>修改 <code>package.json</code>，添加 ES Module 支持：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"langchain-tools-demo"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"module"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"test"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"@langchain/core"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^1.1.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"@langchain/deepseek"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^1.0.2"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"dotenv"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^17.0.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"zod"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^3.23.0"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-9">第 6 步：创建第一个测试文件</h4>
<p>创建 <code>test-setup.js</code> 验证环境：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatDeepSeek</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/deepseek"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"dotenv/config"</span>;

<span class="hljs-comment">// 测试 LLM 连接</span>
<span class="hljs-keyword">const</span> llm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({
  <span class="hljs-attr">model</span>: <span class="hljs-string">"deepseek-chat"</span>,
  <span class="hljs-attr">temperature</span>: <span class="hljs-number">0</span>,
});

<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llm.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">"你好，请用一句话介绍自己"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"✅ 环境配置成功！"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"AI 回复:"</span>, response.<span class="hljs-property">content</span>);
</code></pre>
<p>运行测试：</p>
<pre><code class="hljs language-bash" lang="bash">node test-setup.js
</code></pre>
<p>如果看到 AI 的回复，说明环境配置成功！🎉</p>
<h4 data-id="heading-10">环境问题排查</h4>

























<table><thead><tr><th>问题</th><th>解决方案</th></tr></thead><tbody><tr><td><code>Cannot find module</code></td><td>运行 <code>npm install</code> 安装依赖</td></tr><tr><td><code>DEEPSEEK_API_KEY not set</code></td><td>检查 <code>.env</code> 文件是否存在且格式正确</td></tr><tr><td><code>ERR_MODULE_NOT_FOUND</code></td><td>检查 <code>package.json</code> 中是否有 <code>"type": "module"</code></td></tr><tr><td>网络连接错误</td><td>检查网络，DeepSeek API 需要能访问外网</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-11">📚 目录</h3>
<ul>
<li><a href="#%E4%BB%80%E4%B9%88%E6%98%AF-tools" title="#%E4%BB%80%E4%B9%88%E6%98%AF-tools">什么是 Tools？</a></li>
<li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-tools" title="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-tools">为什么需要 Tools？</a></li>
<li><a href="#tools-%E7%9A%84%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5" title="#tools-%E7%9A%84%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5">Tools 的核心概念</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89-tool" title="#%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89-tool">创建自定义 Tool</a></li>
<li><a href="#%E5%B7%A5%E5%85%B7%E7%BB%91%E5%AE%9A%E4%B8%8E%E8%B0%83%E7%94%A8" title="#%E5%B7%A5%E5%85%B7%E7%BB%91%E5%AE%9A%E4%B8%8E%E8%B0%83%E7%94%A8">工具绑定与调用</a></li>
<li><a href="#%E5%AE%8C%E6%95%B4%E7%9A%84%E5%B7%A5%E5%85%B7%E8%B0%83%E7%94%A8%E5%BE%AA%E7%8E%AF" title="#%E5%AE%8C%E6%95%B4%E7%9A%84%E5%B7%A5%E5%85%B7%E8%B0%83%E7%94%A8%E5%BE%AA%E7%8E%AF">完整的工具调用循环</a></li>
<li><a href="#langchain-%E5%86%85%E7%BD%AE%E5%B7%A5%E5%85%B7---tavilysearch" title="#langchain-%E5%86%85%E7%BD%AE%E5%B7%A5%E5%85%B7---tavilysearch">LangChain 内置工具 - TavilySearch</a></li>
<li><a href="#agent-%E6%99%BA%E8%83%BD%E4%BB%A3%E7%90%86%E8%BF%9B%E9%98%B6" title="#agent-%E6%99%BA%E8%83%BD%E4%BB%A3%E7%90%86%E8%BF%9B%E9%98%B6">Agent 智能代理（进阶）</a></li>
<li><a href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90" title="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90">实战案例分析</a></li>
<li><a href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5" title="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">最佳实践</a></li>
<li><a href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98-faq" title="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98-faq">常见问题 FAQ</a></li>
</ul>
<hr/>
<h3 data-id="heading-12">什么是 Tools？</h3>
<h4 data-id="heading-13">🤔 一句话解释</h4>
<p><strong>Tools 是让大语言模型能够调用外部功能（如查询数据、执行计算、调用 API）的机制。</strong></p>
<h4 data-id="heading-14">形象比喻</h4>
<p>想象你是一个非常聪明的人（AI），但你：</p>
<ul>
<li>❌ 不知道现在几点（没有实时信息）</li>
<li>❌ 算不了复杂数学（只能粗略估算）</li>
<li>❌ 查不了数据库（没有访问权限）</li>
</ul>
<p><strong>Tools 就像给你配备了：</strong></p>
<ul>
<li>⏰ 一块手表（查询时间工具）</li>
<li>🧮 一个计算器（数学计算工具）</li>
<li>💾 一个数据库终端（数据查询工具）</li>
</ul>
<p>现在你可以通过这些"工具"来完成原本做不到的事情！</p>
<hr/>
<h3 data-id="heading-15">为什么需要 Tools？</h3>
<h4 data-id="heading-16">LLM 的天然局限性</h4>






























<table><thead><tr><th>局限性</th><th>说明</th><th>Tools 如何解决</th></tr></thead><tbody><tr><td><strong>知识截止日期</strong></td><td>训练数据有时间限制，无法获取最新信息</td><td>通过搜索工具获取实时信息</td></tr><tr><td><strong>无法执行计算</strong></td><td>只能估算，不能精确计算</td><td>调用计算器工具</td></tr><tr><td><strong>无法访问数据</strong></td><td>无法查询数据库或调用 API</td><td>通过数据查询工具访问</td></tr><tr><td><strong>无法执行操作</strong></td><td>不能发送邮件、修改文件等</td><td>通过操作类工具执行</td></tr></tbody></table>
<h4 data-id="heading-17">没有 Tools vs 有 Tools</h4>
<h5 data-id="heading-18">❌ 没有 Tools</h5>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">用户: 北京今天天气怎么样？</span>
<span class="hljs-section">AI: 抱歉，我无法获取实时天气信息。建议你访问天气预报网站...</span>
</code></pre>
<h5 data-id="heading-19">✅ 有 Tools</h5>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">用户: 北京今天天气怎么样？</span>
<span class="hljs-section">AI: [调用天气工具]</span>
    → 获取到: 北京今天晴朗，温度 15°C，湿度 45%

<span class="hljs-section">回答: 北京今天天气晴朗，温度 15°C，湿度 45%，适合出行！</span>
</code></pre>
<hr/>
<h3 data-id="heading-20">Tools 的核心概念</h3>
<h4 data-id="heading-21">1. Tool 的四要素</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> myTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-comment">// 1️⃣ 名称 - AI 用来识别工具</span>
  <span class="hljs-attr">name</span>: <span class="hljs-string">"get_weather"</span>,

  <span class="hljs-comment">// 2️⃣ 描述 - 告诉 AI 什么时候使用这个工具</span>
  <span class="hljs-attr">description</span>: <span class="hljs-string">"获取指定城市的天气信息。当用户询问天气时使用此工具。"</span>,

  <span class="hljs-comment">// 3️⃣ 参数 Schema - 定义工具需要什么输入</span>
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">city</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"城市名称"</span>),
    <span class="hljs-attr">unit</span>: z.<span class="hljs-title function_">enum</span>([<span class="hljs-string">"celsius"</span>, <span class="hljs-string">"fahrenheit"</span>]).<span class="hljs-title function_">optional</span>(),
  }),

  <span class="hljs-comment">// 4️⃣ 执行函数 - 工具的实际逻辑</span>
  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ city, unit }) =&gt; {
    <span class="hljs-comment">// 调用天气 API</span>
    <span class="hljs-keyword">const</span> weather = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchWeather</span>(city);
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(weather);
  },
});
</code></pre>
<h4 data-id="heading-22">2. Tool 的工作流程</h4>
<pre><code class="hljs language-php" lang="php">┌─────────────┐
│  用户提问    │ <span class="hljs-string">"北京天气怎么样？"</span>
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  AI 分析     │ 需要调用 get_weather 工具
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  Tool 调用   │ <span class="hljs-title function_ invoke__">get_weather</span>({ <span class="hljs-attr">city</span>: <span class="hljs-string">"北京"</span> })
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  返回结果    │ { temp: <span class="hljs-number">15</span>, condition: <span class="hljs-string">"晴"</span> }
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  AI 整合答案 │ <span class="hljs-string">"北京今天晴朗，15°C"</span>
└─────────────┘
</code></pre>
<h4 data-id="heading-23">3. Tool 的类型</h4>

























<table><thead><tr><th>类型</th><th>类名</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>结构化工具</strong></td><td><code>DynamicStructuredTool</code></td><td>需要明确参数定义的工具（推荐）</td></tr><tr><td><strong>简单工具</strong></td><td><code>Tool</code></td><td>参数简单的工具（较少使用）</td></tr><tr><td><strong>内置工具</strong></td><td>如 <code>Calculator</code></td><td>使用 LangChain 提供的现成工具</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-24">创建自定义 Tool</h3>
<h4 data-id="heading-25">示例 1: 天气查询工具</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">DynamicStructuredTool</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/tools"</span>;
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">"zod"</span>;

<span class="hljs-keyword">const</span> weatherTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"get_weather"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"获取指定城市的天气信息。当用户询问天气时使用此工具。"</span>,

  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">city</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"城市名称，例如：北京、上海、深圳"</span>),
    <span class="hljs-attr">unit</span>: z.<span class="hljs-title function_">enum</span>([<span class="hljs-string">"celsius"</span>, <span class="hljs-string">"fahrenheit"</span>]).<span class="hljs-title function_">optional</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"温度单位"</span>),
  }),

  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ city, unit = <span class="hljs-string">"celsius"</span> }) =&gt; {
    <span class="hljs-comment">// 实际应用中这里会调用真实的天气 API</span>
    <span class="hljs-keyword">const</span> weatherData = {
      北京: { <span class="hljs-attr">temp</span>: <span class="hljs-number">15</span>, <span class="hljs-attr">condition</span>: <span class="hljs-string">"晴朗"</span>, <span class="hljs-attr">humidity</span>: <span class="hljs-number">45</span> },
      上海: { <span class="hljs-attr">temp</span>: <span class="hljs-number">20</span>, <span class="hljs-attr">condition</span>: <span class="hljs-string">"多云"</span>, <span class="hljs-attr">humidity</span>: <span class="hljs-number">65</span> },
    };

    <span class="hljs-keyword">const</span> data = weatherData[city] || {
      <span class="hljs-attr">temp</span>: <span class="hljs-number">22</span>,
      <span class="hljs-attr">condition</span>: <span class="hljs-string">"未知"</span>,
      <span class="hljs-attr">humidity</span>: <span class="hljs-number">50</span>,
    };

    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
      <span class="hljs-attr">city</span>: city,
      <span class="hljs-attr">temperature</span>: <span class="hljs-string">`<span class="hljs-subst">${data.temp}</span>°C`</span>,
      <span class="hljs-attr">condition</span>: data.<span class="hljs-property">condition</span>,
      <span class="hljs-attr">humidity</span>: <span class="hljs-string">`<span class="hljs-subst">${data.humidity}</span>%`</span>,
    });
  },
});
</code></pre>
<h4 data-id="heading-26">示例 2: 计算器工具</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> calculatorTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"calculator"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"执行数学计算。支持加减乘除、幂运算等。"</span>,

  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">expression</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"数学表达式，例如: '2 + 3 * 4'"</span>),
  }),

  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ expression }) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 生产环境应使用 math.js 等安全的库</span>
      <span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Function</span>(<span class="hljs-string">`"use strict"; return (<span class="hljs-subst">${expression}</span>)`</span>)();
      <span class="hljs-keyword">return</span> <span class="hljs-string">`计算结果: <span class="hljs-subst">${expression}</span> = <span class="hljs-subst">${result}</span>`</span>;
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">`计算错误: <span class="hljs-subst">${error.message}</span>`</span>;
    }
  },
});
</code></pre>
<h4 data-id="heading-27">示例 3: 数据库查询工具</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> databaseTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"query_database"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"查询用户数据库。可以根据用户 ID 或邮箱查询用户信息。"</span>,

  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">query_type</span>: z.<span class="hljs-title function_">enum</span>([<span class="hljs-string">"by_id"</span>, <span class="hljs-string">"by_email"</span>]).<span class="hljs-title function_">describe</span>(<span class="hljs-string">"查询类型"</span>),
    <span class="hljs-attr">value</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"查询值：ID 或邮箱"</span>),
  }),

  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ query_type, value }) =&gt; {
    <span class="hljs-comment">// 模拟数据库查询</span>
    <span class="hljs-keyword">const</span> users = [
      { <span class="hljs-attr">id</span>: <span class="hljs-string">"001"</span>, <span class="hljs-attr">email</span>: <span class="hljs-string">"zhang@example.com"</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"张三"</span> },
      { <span class="hljs-attr">id</span>: <span class="hljs-string">"002"</span>, <span class="hljs-attr">email</span>: <span class="hljs-string">"li@example.com"</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"李四"</span> },
    ];

    <span class="hljs-keyword">let</span> user;
    <span class="hljs-keyword">if</span> (query_type === <span class="hljs-string">"by_id"</span>) {
      user = users.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">u</span>) =&gt;</span> u.<span class="hljs-property">id</span> === value);
    } <span class="hljs-keyword">else</span> {
      user = users.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">u</span>) =&gt;</span> u.<span class="hljs-property">email</span> === value);
    }

    <span class="hljs-keyword">return</span> user ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(user) : <span class="hljs-string">"未找到用户"</span>;
  },
});
</code></pre>
<h4 data-id="heading-28">📝 实战练习 1：创建你的第一个工具</h4>
<p>在项目中创建 <code>01-create-tool.js</code> 文件，完整代码如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 实战练习 1：创建自定义工具
 * 运行命令：node 01-create-tool.js
 */</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">DynamicStructuredTool</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/tools"</span>;
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">"zod"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"dotenv/config"</span>;

<span class="hljs-comment">// 创建天气查询工具</span>
<span class="hljs-keyword">const</span> weatherTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"get_weather"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"获取指定城市的天气信息"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">city</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"城市名称"</span>),
  }),
  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ city }) =&gt; {
    <span class="hljs-comment">// 模拟天气数据</span>
    <span class="hljs-keyword">const</span> weatherData = {
      北京: { <span class="hljs-attr">temp</span>: <span class="hljs-number">15</span>, <span class="hljs-attr">condition</span>: <span class="hljs-string">"晴朗"</span> },
      上海: { <span class="hljs-attr">temp</span>: <span class="hljs-number">20</span>, <span class="hljs-attr">condition</span>: <span class="hljs-string">"多云"</span> },
      深圳: { <span class="hljs-attr">temp</span>: <span class="hljs-number">28</span>, <span class="hljs-attr">condition</span>: <span class="hljs-string">"小雨"</span> },
    };
    <span class="hljs-keyword">const</span> data = weatherData[city] || { <span class="hljs-attr">temp</span>: <span class="hljs-number">25</span>, <span class="hljs-attr">condition</span>: <span class="hljs-string">"未知"</span> };
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ city, ...data });
  },
});

<span class="hljs-comment">// 创建计算器工具</span>
<span class="hljs-keyword">const</span> calculatorTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"calculator"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"执行数学计算"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">expression</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"数学表达式"</span>),
  }),
  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ expression }) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Function</span>(<span class="hljs-string">`"use strict"; return (<span class="hljs-subst">${expression}</span>)`</span>)();
      <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${expression}</span> = <span class="hljs-subst">${result}</span>`</span>;
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">`计算错误: <span class="hljs-subst">${e.message}</span>`</span>;
    }
  },
});

<span class="hljs-comment">// 测试工具</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"🔧 测试天气工具:"</span>);
<span class="hljs-keyword">const</span> weather = <span class="hljs-keyword">await</span> weatherTool.<span class="hljs-title function_">invoke</span>({ <span class="hljs-attr">city</span>: <span class="hljs-string">"北京"</span> });
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(weather);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"\n🔧 测试计算器工具:"</span>);
<span class="hljs-keyword">const</span> calc = <span class="hljs-keyword">await</span> calculatorTool.<span class="hljs-title function_">invoke</span>({ <span class="hljs-attr">expression</span>: <span class="hljs-string">"2 + 3 * 4"</span> });
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(calc);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"\n✅ 工具创建成功！"</span>);
</code></pre>
<p><strong>运行测试：</strong></p>
<pre><code class="hljs language-bash" lang="bash">node 01-create-tool.js
</code></pre>
<p><strong>预期输出：</strong></p>
<pre><code class="hljs language-css" lang="css">🔧 测试天气工具:
{"city":<span class="hljs-string">"北京"</span>,<span class="hljs-string">"temp"</span>:<span class="hljs-number">15</span>,<span class="hljs-string">"condition"</span>:<span class="hljs-string">"晴朗"</span>}

🔧 测试计算器工具:
<span class="hljs-number">2</span> + <span class="hljs-number">3</span> * <span class="hljs-number">4</span> = <span class="hljs-number">14</span>

✅ 工具创建成功！
</code></pre>
<hr/>
<h3 data-id="heading-29">工具绑定与调用</h3>
<h4 data-id="heading-30">1. 绑定工具到 LLM</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatDeepSeek</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/deepseek"</span>;

<span class="hljs-comment">// 初始化 LLM</span>
<span class="hljs-keyword">const</span> llm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({
  <span class="hljs-attr">model</span>: <span class="hljs-string">"deepseek-chat"</span>,
  <span class="hljs-attr">temperature</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 工具调用建议使用低温度</span>
});

<span class="hljs-comment">// 定义工具列表</span>
<span class="hljs-keyword">const</span> tools = [weatherTool, calculatorTool, databaseTool];

<span class="hljs-comment">// 绑定工具</span>
<span class="hljs-keyword">const</span> llmWithTools = llm.<span class="hljs-title function_">bindTools</span>(tools);
</code></pre>
<h4 data-id="heading-31">2. 调用并检查工具请求</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 用户提问</span>
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llmWithTools.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">"北京今天天气怎么样？"</span>);

<span class="hljs-comment">// 检查 AI 是否请求调用工具</span>
<span class="hljs-keyword">if</span> (response.<span class="hljs-property">tool_calls</span> &amp;&amp; response.<span class="hljs-property">tool_calls</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"AI 决定调用工具:"</span>);

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> toolCall <span class="hljs-keyword">of</span> response.<span class="hljs-property">tool_calls</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`工具名称: <span class="hljs-subst">${toolCall.name}</span>`</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`参数:`</span>, toolCall.<span class="hljs-property">args</span>);

    <span class="hljs-comment">// 找到对应的工具并执行</span>
    <span class="hljs-keyword">const</span> tool = tools.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.<span class="hljs-property">name</span> === toolCall.<span class="hljs-property">name</span>);
    <span class="hljs-keyword">if</span> (tool) {
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> tool.<span class="hljs-title function_">invoke</span>(toolCall.<span class="hljs-property">args</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`工具返回:`</span>, result);
    }
  }
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// AI 直接回答，无需工具</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"AI 回答:"</span>, response.<span class="hljs-property">content</span>);
}
</code></pre>
<h4 data-id="heading-32">3. 工具调用的完整流程</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 完整示例：AI 自动选择并调用工具</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">askWithTools</span>(<span class="hljs-params">question</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`🤔 用户: <span class="hljs-subst">${question}</span>\n`</span>);

  <span class="hljs-comment">// 1. AI 分析问题并决定是否需要工具</span>
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llmWithTools.<span class="hljs-title function_">invoke</span>(question);

  <span class="hljs-comment">// 2. 如果需要工具，执行工具调用</span>
  <span class="hljs-keyword">if</span> (response.<span class="hljs-property">tool_calls</span> &amp;&amp; response.<span class="hljs-property">tool_calls</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">const</span> toolResults = [];

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> toolCall <span class="hljs-keyword">of</span> response.<span class="hljs-property">tool_calls</span>) {
      <span class="hljs-keyword">const</span> tool = tools.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.<span class="hljs-property">name</span> === toolCall.<span class="hljs-property">name</span>);
      <span class="hljs-keyword">if</span> (tool) {
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> tool.<span class="hljs-title function_">invoke</span>(toolCall.<span class="hljs-property">args</span>);
        toolResults.<span class="hljs-title function_">push</span>({
          <span class="hljs-attr">name</span>: toolCall.<span class="hljs-property">name</span>,
          <span class="hljs-attr">result</span>: result,
        });
      }
    }

    <span class="hljs-comment">// 3. 将工具结果返回给 AI，让 AI 生成最终答案</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"✅ 工具调用完成，结果:"</span>, toolResults);

    <span class="hljs-comment">// 实际应用中，需要将工具结果传回 AI 继续对话</span>
    <span class="hljs-comment">// 这通常通过 Agent 自动完成（见下一节）</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"✅ AI 直接回答:"</span>, response.<span class="hljs-property">content</span>);
  }
}

<span class="hljs-comment">// 测试</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">askWithTools</span>(<span class="hljs-string">"北京今天天气怎么样？"</span>);
<span class="hljs-keyword">await</span> <span class="hljs-title function_">askWithTools</span>(<span class="hljs-string">"计算 123 * 456"</span>);
<span class="hljs-keyword">await</span> <span class="hljs-title function_">askWithTools</span>(<span class="hljs-string">"你好"</span>);
</code></pre>
<h4 data-id="heading-33">📝 实战练习 2：AI 自动选择工具</h4>
<p>创建 <code>02-bind-tools.js</code> 文件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 实战练习 2：将工具绑定到 LLM
 * 运行命令：node 02-bind-tools.js
 */</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatDeepSeek</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/deepseek"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">DynamicStructuredTool</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/tools"</span>;
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">"zod"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"dotenv/config"</span>;

<span class="hljs-comment">// 1. 创建工具</span>
<span class="hljs-keyword">const</span> weatherTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"get_weather"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"获取指定城市的天气信息。当用户询问天气时使用此工具。"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">city</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"城市名称"</span>),
  }),
  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ city }) =&gt; {
    <span class="hljs-keyword">const</span> data = { 北京: <span class="hljs-number">15</span>, 上海: <span class="hljs-number">20</span>, 深圳: <span class="hljs-number">28</span> };
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ city, <span class="hljs-attr">temp</span>: data[city] || <span class="hljs-number">25</span>, <span class="hljs-attr">unit</span>: <span class="hljs-string">"°C"</span> });
  },
});

<span class="hljs-keyword">const</span> calculatorTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"calculator"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"执行数学计算。当用户需要计算时使用此工具。"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">expression</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"数学表达式"</span>),
  }),
  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ expression }) =&gt; {
    <span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Function</span>(<span class="hljs-string">`"use strict"; return (<span class="hljs-subst">${expression}</span>)`</span>)();
    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${expression}</span> = <span class="hljs-subst">${result}</span>`</span>;
  },
});

<span class="hljs-comment">// 2. 初始化 LLM 并绑定工具</span>
<span class="hljs-keyword">const</span> llm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({ <span class="hljs-attr">model</span>: <span class="hljs-string">"deepseek-chat"</span>, <span class="hljs-attr">temperature</span>: <span class="hljs-number">0</span> });
<span class="hljs-keyword">const</span> tools = [weatherTool, calculatorTool];
<span class="hljs-keyword">const</span> llmWithTools = llm.<span class="hljs-title function_">bindTools</span>(tools);

<span class="hljs-comment">// 3. 测试 AI 自动选择工具</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">testToolSelection</span>(<span class="hljs-params">question</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`\n🤔 用户: <span class="hljs-subst">${question}</span>`</span>);
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llmWithTools.<span class="hljs-title function_">invoke</span>(question);

  <span class="hljs-keyword">if</span> (response.<span class="hljs-property">tool_calls</span> &amp;&amp; response.<span class="hljs-property">tool_calls</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"🔧 AI 决定调用工具:"</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> tc <span class="hljs-keyword">of</span> response.<span class="hljs-property">tool_calls</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`   工具: <span class="hljs-subst">${tc.name}</span>, 参数:`</span>, tc.<span class="hljs-property">args</span>);
      <span class="hljs-keyword">const</span> tool = tools.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.<span class="hljs-property">name</span> === tc.<span class="hljs-property">name</span>);
      <span class="hljs-keyword">if</span> (tool) {
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> tool.<span class="hljs-title function_">invoke</span>(tc.<span class="hljs-property">args</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`   结果: <span class="hljs-subst">${result}</span>`</span>);
      }
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"💬 AI 直接回答:"</span>, response.<span class="hljs-property">content</span>);
  }
}

<span class="hljs-comment">// 运行测试</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">testToolSelection</span>(<span class="hljs-string">"北京今天天气怎么样？"</span>);
<span class="hljs-keyword">await</span> <span class="hljs-title function_">testToolSelection</span>(<span class="hljs-string">"计算 15 * 8 + 20"</span>);
<span class="hljs-keyword">await</span> <span class="hljs-title function_">testToolSelection</span>(<span class="hljs-string">"你好，介绍一下你自己"</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"\n✅ 测试完成！"</span>);
</code></pre>
<p><strong>运行测试：</strong></p>
<pre><code class="hljs language-bash" lang="bash">node 02-bind-tools.js
</code></pre>
<p><strong>观察要点：</strong></p>
<ul>
<li>AI 会根据问题自动选择合适的工具</li>
<li>询问天气时，AI 调用 <code>get_weather</code> 工具</li>
<li>需要计算时，AI 调用 <code>calculator</code> 工具</li>
<li>普通对话时，AI 直接回答，不调用工具</li>
</ul>
<hr/>
<h3 data-id="heading-34">完整的工具调用循环</h3>
<h4 data-id="heading-35">核心概念：ToolMessage</h4>
<p>在 LangChain 中，完整的工具调用流程需要使用 <code>ToolMessage</code> 来将工具执行结果传回给 AI：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">HumanMessage</span>, <span class="hljs-title class_">AIMessage</span>, <span class="hljs-title class_">ToolMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/messages"</span>;
</code></pre>
<h4 data-id="heading-36">工具调用的完整流程</h4>
<pre><code class="hljs language-css" lang="css">用户: <span class="hljs-string">"上海今天天气怎么样？"</span>
    │
    ▼
┌────────────────────────────────────────┐
│ 第 <span class="hljs-number">1</span> 步：发送用户消息给 AI              │
│ → messages = [<span class="hljs-built_in">HumanMessage</span>(<span class="hljs-string">"..."</span>)]     │
└───────────────┬────────────────────────┘
                │
                ▼
┌────────────────────────────────────────┐
│ 第 <span class="hljs-number">2</span> 步：AI 分析并返回 tool_calls       │
│ → aiResponse.tool_calls = [...]        │
└───────────────┬────────────────────────┘
                │
                ▼
┌────────────────────────────────────────┐
│ 第 <span class="hljs-number">3</span> 步：执行工具调用                   │
│ → result = await tool.<span class="hljs-built_in">invoke</span>(args)     │
└───────────────┬────────────────────────┘
                │
                ▼
┌────────────────────────────────────────┐
│ 第 <span class="hljs-number">4</span> 步：将工具结果包装为 ToolMessage   │
│ → messages.<span class="hljs-built_in">push</span>(<span class="hljs-built_in">ToolMessage</span>(...))      │
└───────────────┬────────────────────────┘
                │
                ▼
┌────────────────────────────────────────┐
│ 第 <span class="hljs-number">5</span> 步：将所有消息发送给 AI            │
│ → AI 根据工具结果生成最终回答           │
└───────────────┬────────────────────────┘
                │
                ▼
最终回答: <span class="hljs-string">"上海今天天气多云，温度 20°C，湿度 65%。"</span>
</code></pre>
<h4 data-id="heading-37">实现完整的工具调用循环</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">HumanMessage</span>, <span class="hljs-title class_">ToolMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/messages"</span>;

<span class="hljs-comment">/**
 * 完整的工具调用流程：
 * 1. 用户提问
 * 2. AI 分析并返回 tool_calls
 * 3. 执行工具调用
 * 4. 将工具结果作为 ToolMessage 传回 AI
 * 5. AI 根据工具结果生成最终回答
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">chatWithTools</span>(<span class="hljs-params">question</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`🤔 用户: <span class="hljs-subst">${question}</span>\n`</span>);

  <span class="hljs-comment">// 第 1 步：将用户问题发送给 AI</span>
  <span class="hljs-keyword">const</span> messages = [<span class="hljs-keyword">new</span> <span class="hljs-title class_">HumanMessage</span>(question)];
  <span class="hljs-keyword">const</span> aiResponse = <span class="hljs-keyword">await</span> llmWithTools.<span class="hljs-title function_">invoke</span>(messages);

  <span class="hljs-comment">// 第 2 步：检查 AI 是否需要调用工具</span>
  <span class="hljs-keyword">if</span> (aiResponse.<span class="hljs-property">tool_calls</span> &amp;&amp; aiResponse.<span class="hljs-property">tool_calls</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"🔧 AI 决定调用以下工具:"</span>);

    <span class="hljs-comment">// 保存 AI 的响应（包含 tool_calls）</span>
    messages.<span class="hljs-title function_">push</span>(aiResponse);

    <span class="hljs-comment">// 第 3 步：执行每个工具调用</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> toolCall <span class="hljs-keyword">of</span> aiResponse.<span class="hljs-property">tool_calls</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`  - 工具: <span class="hljs-subst">${toolCall.name}</span>`</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`    参数:`</span>, toolCall.<span class="hljs-property">args</span>);

      <span class="hljs-keyword">const</span> tool = tools.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.<span class="hljs-property">name</span> === toolCall.<span class="hljs-property">name</span>);
      <span class="hljs-keyword">if</span> (tool) {
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> tool.<span class="hljs-title function_">invoke</span>(toolCall.<span class="hljs-property">args</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`    结果:`</span>, result);

        <span class="hljs-comment">// 第 4 步：将工具结果作为 ToolMessage 添加到消息列表</span>
        messages.<span class="hljs-title function_">push</span>(
          <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolMessage</span>({
            <span class="hljs-attr">tool_call_id</span>: toolCall.<span class="hljs-property">id</span>,
            <span class="hljs-attr">content</span>: result,
          })
        );
      }
    }

    <span class="hljs-comment">// 第 5 步：将所有消息（包括工具结果）发送给 AI，获取最终回答</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"\n📝 AI 整合工具结果...\n"</span>);
    <span class="hljs-keyword">const</span> finalResponse = <span class="hljs-keyword">await</span> llmWithTools.<span class="hljs-title function_">invoke</span>(messages);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"✅ AI 最终回答:"</span>, finalResponse.<span class="hljs-property">content</span>);

    <span class="hljs-keyword">return</span> finalResponse.<span class="hljs-property">content</span>;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// AI 直接回答，无需工具</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"✅ AI 直接回答:"</span>, aiResponse.<span class="hljs-property">content</span>);
    <span class="hljs-keyword">return</span> aiResponse.<span class="hljs-property">content</span>;
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">chatWithTools</span>(<span class="hljs-string">"上海今天天气怎么样？"</span>);
<span class="hljs-keyword">await</span> <span class="hljs-title function_">chatWithTools</span>(<span class="hljs-string">"现在几点了？"</span>);
<span class="hljs-keyword">await</span> <span class="hljs-title function_">chatWithTools</span>(<span class="hljs-string">"你好，介绍一下你自己"</span>); <span class="hljs-comment">// 无需工具</span>
</code></pre>
<h4 data-id="heading-38">ToolMessage 的关键属性</h4>

















<table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td><code>tool_call_id</code></td><td>必须与 AI 返回的 <code>toolCall.id</code> 对应</td></tr><tr><td><code>content</code></td><td>工具的执行结果（字符串）</td></tr></tbody></table>
<h4 data-id="heading-39">为什么需要 ToolMessage？</h4>
<ol>
<li><strong>对话完整性</strong>：让 AI 知道工具已执行并获取结果</li>
<li><strong>上下文连续</strong>：AI 可以基于工具结果继续推理</li>
<li><strong>多工具支持</strong>：通过 <code>tool_call_id</code> 匹配多个并行调用</li>
</ol>
<h4 data-id="heading-40">📝 实战练习 3：完整的工具调用循环</h4>
<p>创建 <code>03-tool-loop.js</code> 文件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 实战练习 3：完整的工具调用循环
 * 运行命令：node 03-tool-loop.js
 */</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatDeepSeek</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/deepseek"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">DynamicStructuredTool</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/tools"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">HumanMessage</span>, <span class="hljs-title class_">ToolMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/messages"</span>;
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">"zod"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"dotenv/config"</span>;

<span class="hljs-comment">// 创建工具</span>
<span class="hljs-keyword">const</span> weatherTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"get_weather"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"获取城市天气"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({ <span class="hljs-attr">city</span>: z.<span class="hljs-title function_">string</span>() }),
  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ city }) =&gt; {
    <span class="hljs-keyword">const</span> data = { 北京: <span class="hljs-string">"晴朗 15°C"</span>, 上海: <span class="hljs-string">"多云 20°C"</span>, 深圳: <span class="hljs-string">"小雨 28°C"</span> };
    <span class="hljs-keyword">return</span> data[city] || <span class="hljs-string">"未知城市"</span>;
  },
});

<span class="hljs-keyword">const</span> timeTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"get_time"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"获取当前时间"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({}),
  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> () =&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toLocaleString</span>(<span class="hljs-string">"zh-CN"</span>),
});

<span class="hljs-comment">// 初始化</span>
<span class="hljs-keyword">const</span> llm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({ <span class="hljs-attr">model</span>: <span class="hljs-string">"deepseek-chat"</span>, <span class="hljs-attr">temperature</span>: <span class="hljs-number">0</span> });
<span class="hljs-keyword">const</span> tools = [weatherTool, timeTool];
<span class="hljs-keyword">const</span> llmWithTools = llm.<span class="hljs-title function_">bindTools</span>(tools);

<span class="hljs-comment">// 完整的工具调用循环</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">chat</span>(<span class="hljs-params">question</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`\n🤔 用户: <span class="hljs-subst">${question}</span>\n`</span>);

  <span class="hljs-comment">// 第 1 步：发送问题</span>
  <span class="hljs-keyword">const</span> messages = [<span class="hljs-keyword">new</span> <span class="hljs-title class_">HumanMessage</span>(question)];
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llmWithTools.<span class="hljs-title function_">invoke</span>(messages);

  <span class="hljs-comment">// 第 2 步：检查是否需要工具</span>
  <span class="hljs-keyword">if</span> (response.<span class="hljs-property">tool_calls</span> &amp;&amp; response.<span class="hljs-property">tool_calls</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"🔧 调用工具中..."</span>);
    messages.<span class="hljs-title function_">push</span>(response);

    <span class="hljs-comment">// 第 3 步：执行工具</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> tc <span class="hljs-keyword">of</span> response.<span class="hljs-property">tool_calls</span>) {
      <span class="hljs-keyword">const</span> tool = tools.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.<span class="hljs-property">name</span> === tc.<span class="hljs-property">name</span>);
      <span class="hljs-keyword">if</span> (tool) {
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> tool.<span class="hljs-title function_">invoke</span>(tc.<span class="hljs-property">args</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`   <span class="hljs-subst">${tc.name}</span>: <span class="hljs-subst">${result}</span>`</span>);

        <span class="hljs-comment">// 第 4 步：添加 ToolMessage</span>
        messages.<span class="hljs-title function_">push</span>(
          <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolMessage</span>({
            <span class="hljs-attr">tool_call_id</span>: tc.<span class="hljs-property">id</span>,
            <span class="hljs-attr">content</span>: result,
          })
        );
      }
    }

    <span class="hljs-comment">// 第 5 步：获取最终回答</span>
    <span class="hljs-keyword">const</span> final = <span class="hljs-keyword">await</span> llmWithTools.<span class="hljs-title function_">invoke</span>(messages);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"\n✅ AI:"</span>, final.<span class="hljs-property">content</span>);
    <span class="hljs-keyword">return</span> final.<span class="hljs-property">content</span>;
  }

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"✅ AI:"</span>, response.<span class="hljs-property">content</span>);
  <span class="hljs-keyword">return</span> response.<span class="hljs-property">content</span>;
}

<span class="hljs-comment">// 测试</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">chat</span>(<span class="hljs-string">"北京天气怎么样？"</span>);
<span class="hljs-keyword">await</span> <span class="hljs-title function_">chat</span>(<span class="hljs-string">"现在几点了？"</span>);
<span class="hljs-keyword">await</span> <span class="hljs-title function_">chat</span>(<span class="hljs-string">"你好"</span>);
</code></pre>
<p><strong>运行测试：</strong></p>
<pre><code class="hljs language-bash" lang="bash">node 03-tool-loop.js
</code></pre>
<p><strong>关键学习点：</strong></p>
<ul>
<li><code>HumanMessage</code>：用户消息</li>
<li><code>ToolMessage</code>：工具结果消息，必须包含 <code>tool_call_id</code></li>
<li>AI 会整合工具结果，生成自然语言回答</li>
</ul>
<hr/>
<h3 data-id="heading-41">LangChain 内置工具 - TavilySearch</h3>
<blockquote>
<p>🔍 让 AI 拥有真正的互联网搜索能力</p>
</blockquote>
<h4 data-id="heading-42">什么是 TavilySearch？</h4>
<p><strong>TavilySearch</strong> 是 LangChain 官方推荐的搜索工具，专为 AI Agent 设计。它是目前最适合与 LLM 配合使用的搜索引擎。</p>

























<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td><strong>专为 AI 设计</strong></td><td>返回结构化数据，便于 LLM 理解和处理</td></tr><tr><td><strong>实时搜索</strong></td><td>获取互联网最新信息，突破 LLM 知识截止日期限制</td></tr><tr><td><strong>免费额度</strong></td><td>每月 1000 次免费调用，足够学习和个人项目使用</td></tr><tr><td><strong>易于集成</strong></td><td>LangChain 原生支持，几行代码即可使用</td></tr></tbody></table>
<h4 data-id="heading-43">获取 Tavily API Key</h4>
<ol>
<li>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Ftavily.com%2F" target="_blank" title="https://tavily.com/" ref="nofollow noopener noreferrer">tavily.com/</a></li>
<li>点击 "Get API Key" 注册账号（支持 GitHub/Google 一键登录）</li>
<li>在 Dashboard 中复制你的 API Key</li>
<li>在项目根目录的 <code>.env</code> 文件中添加：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">TAVILY_API_KEY=tvly-xxxxxxxxxxxxxxxxx
</code></pre>
<h4 data-id="heading-44">安装依赖</h4>
<pre><code class="hljs language-bash" lang="bash">npm install @langchain/tavily
</code></pre>
<h4 data-id="heading-45">基础使用</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">TavilySearch</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/tavily"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"dotenv/config"</span>;

<span class="hljs-comment">// 创建 TavilySearch 工具实例</span>
<span class="hljs-keyword">const</span> tavilyTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TavilySearch</span>({
  <span class="hljs-attr">maxResults</span>: <span class="hljs-number">3</span>, <span class="hljs-comment">// 返回结果数量（1-10）</span>
  <span class="hljs-comment">// topic: "general",  // 可选: "general" | "news"</span>
  <span class="hljs-comment">// includeAnswer: true, // 可选: 是否包含 AI 生成的摘要</span>
});

<span class="hljs-comment">// 直接调用搜索（注意：需要传入对象格式）</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> tavilyTool.<span class="hljs-title function_">invoke</span>({ <span class="hljs-attr">query</span>: <span class="hljs-string">"LangChain 最新版本特性"</span> });
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(result, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));
</code></pre>
<h4 data-id="heading-46">与 LLM 集成使用</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatDeepSeek</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/deepseek"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TavilySearch</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/tavily"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">HumanMessage</span>, <span class="hljs-title class_">ToolMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/messages"</span>;

<span class="hljs-comment">// 初始化 LLM 和搜索工具</span>
<span class="hljs-keyword">const</span> llm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({ <span class="hljs-attr">model</span>: <span class="hljs-string">"deepseek-chat"</span>, <span class="hljs-attr">temperature</span>: <span class="hljs-number">0</span> });
<span class="hljs-keyword">const</span> tavilyTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TavilySearch</span>({ <span class="hljs-attr">maxResults</span>: <span class="hljs-number">3</span> });

<span class="hljs-comment">// 绑定工具到 LLM</span>
<span class="hljs-keyword">const</span> llmWithSearch = llm.<span class="hljs-title function_">bindTools</span>([tavilyTool]);

<span class="hljs-comment">// 完整的搜索问答流程</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">searchAndAnswer</span>(<span class="hljs-params">question</span>) {
  <span class="hljs-keyword">const</span> messages = [<span class="hljs-keyword">new</span> <span class="hljs-title class_">HumanMessage</span>(question)];
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llmWithSearch.<span class="hljs-title function_">invoke</span>(messages);

  <span class="hljs-keyword">if</span> (response.<span class="hljs-property">tool_calls</span> &amp;&amp; response.<span class="hljs-property">tool_calls</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    messages.<span class="hljs-title function_">push</span>(response);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> toolCall <span class="hljs-keyword">of</span> response.<span class="hljs-property">tool_calls</span>) {
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> tavilyTool.<span class="hljs-title function_">invoke</span>(toolCall.<span class="hljs-property">args</span>);
      <span class="hljs-comment">// TavilySearch 返回对象，需要转换为字符串</span>
      <span class="hljs-keyword">const</span> resultStr =
        <span class="hljs-keyword">typeof</span> result === <span class="hljs-string">"string"</span> ? result : <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(result);
      messages.<span class="hljs-title function_">push</span>(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolMessage</span>({
          <span class="hljs-attr">tool_call_id</span>: toolCall.<span class="hljs-property">id</span>,
          <span class="hljs-attr">content</span>: resultStr, <span class="hljs-comment">// ToolMessage 的 content 必须是字符串</span>
        })
      );
    }

    <span class="hljs-comment">// AI 整合搜索结果生成最终答案</span>
    <span class="hljs-keyword">const</span> finalResponse = <span class="hljs-keyword">await</span> llmWithSearch.<span class="hljs-title function_">invoke</span>(messages);
    <span class="hljs-keyword">return</span> finalResponse.<span class="hljs-property">content</span>;
  }

  <span class="hljs-keyword">return</span> response.<span class="hljs-property">content</span>;
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> answer = <span class="hljs-keyword">await</span> <span class="hljs-title function_">searchAndAnswer</span>(<span class="hljs-string">"2024年 AI 领域有哪些重大突破？"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(answer);
</code></pre>
<h4 data-id="heading-47">TavilySearch 配置选项</h4>









































<table><thead><tr><th>参数</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>maxResults</code></td><td>number</td><td>5</td><td>返回结果数量（1-10）</td></tr><tr><td><code>topic</code></td><td>string</td><td>"general"</td><td>搜索主题："general" 或 "news"</td></tr><tr><td><code>includeAnswer</code></td><td>boolean</td><td>false</td><td>是否包含 AI 生成的摘要答案</td></tr><tr><td><code>includeRawContent</code></td><td>boolean</td><td>false</td><td>是否包含原始网页内容</td></tr><tr><td><code>searchDepth</code></td><td>string</td><td>"basic"</td><td>搜索深度："basic" 或 "advanced"</td></tr></tbody></table>
<h4 data-id="heading-48">为什么选择 TavilySearch？</h4>



































<table><thead><tr><th>对比项</th><th>TavilySearch</th><th>Google Search API</th><th>Bing Search API</th></tr></thead><tbody><tr><td><strong>AI 优化</strong></td><td>✅ 专为 LLM 设计</td><td>❌ 通用搜索</td><td>❌ 通用搜索</td></tr><tr><td><strong>免费额度</strong></td><td>✅ 1000 次/月</td><td>❌ 需付费</td><td>⚠️ 有限免费</td></tr><tr><td><strong>接入难度</strong></td><td>✅ LangChain 原生支持</td><td>⚠️ 需要额外配置</td><td>⚠️ 需要额外配置</td></tr><tr><td><strong>返回格式</strong></td><td>✅ 结构化，LLM 友好</td><td>⚠️ 需要解析</td><td>⚠️ 需要解析</td></tr></tbody></table>
<h4 data-id="heading-49">📝 实战练习 4：使用 TavilySearch 搜索实时信息</h4>
<blockquote>
<p>⚠️ 本练习需要 Tavily API Key，请先完成注册</p>
</blockquote>
<p><strong>第 1 步：安装依赖</strong></p>
<pre><code class="hljs language-bash" lang="bash">npm install @langchain/tavily
</code></pre>
<p><strong>第 2 步：配置 API Key</strong></p>
<p>在 <code>.env</code> 文件中添加：</p>
<pre><code class="hljs language-bash" lang="bash">TAVILY_API_KEY=tvly-xxxxxxxxxxxxxxxx
</code></pre>
<p><strong>第 3 步：创建 <code>04-tavily-search.js</code> 文件</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 实战练习 4：TavilySearch 真实搜索
 * 运行命令：node 04-tavily-search.js
 */</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatDeepSeek</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/deepseek"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TavilySearch</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/tavily"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">HumanMessage</span>, <span class="hljs-title class_">ToolMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/messages"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"dotenv/config"</span>;

<span class="hljs-comment">// 检查 API Key</span>
<span class="hljs-keyword">if</span> (!process.<span class="hljs-property">env</span>.<span class="hljs-property">TAVILY_API_KEY</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"❌ 请先配置 TAVILY_API_KEY"</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"   获取地址: https://tavily.com/"</span>);
  process.<span class="hljs-title function_">exit</span>(<span class="hljs-number">1</span>);
}

<span class="hljs-comment">// 创建搜索工具</span>
<span class="hljs-keyword">const</span> searchTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TavilySearch</span>({ <span class="hljs-attr">maxResults</span>: <span class="hljs-number">3</span> });

<span class="hljs-comment">// 初始化 LLM</span>
<span class="hljs-keyword">const</span> llm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({ <span class="hljs-attr">model</span>: <span class="hljs-string">"deepseek-chat"</span>, <span class="hljs-attr">temperature</span>: <span class="hljs-number">0</span> });
<span class="hljs-keyword">const</span> llmWithSearch = llm.<span class="hljs-title function_">bindTools</span>([searchTool]);

<span class="hljs-comment">// 搜索并回答</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">searchAndAnswer</span>(<span class="hljs-params">question</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`\n🔍 问题: <span class="hljs-subst">${question}</span>\n`</span>);

  <span class="hljs-keyword">const</span> messages = [<span class="hljs-keyword">new</span> <span class="hljs-title class_">HumanMessage</span>(question)];
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llmWithSearch.<span class="hljs-title function_">invoke</span>(messages);

  <span class="hljs-keyword">if</span> (response.<span class="hljs-property">tool_calls</span> &amp;&amp; response.<span class="hljs-property">tool_calls</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"📡 搜索中..."</span>);
    messages.<span class="hljs-title function_">push</span>(response);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> tc <span class="hljs-keyword">of</span> response.<span class="hljs-property">tool_calls</span>) {
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> searchTool.<span class="hljs-title function_">invoke</span>(tc.<span class="hljs-property">args</span>);
      <span class="hljs-keyword">const</span> resultStr =
        <span class="hljs-keyword">typeof</span> result === <span class="hljs-string">"string"</span> ? result : <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(result);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(
        <span class="hljs-string">`   找到 <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.parse(resultStr).results?.length || <span class="hljs-number">0</span>}</span> 条结果`</span>
      );

      messages.<span class="hljs-title function_">push</span>(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolMessage</span>({ <span class="hljs-attr">tool_call_id</span>: tc.<span class="hljs-property">id</span>, <span class="hljs-attr">content</span>: resultStr })
      );
    }

    <span class="hljs-keyword">const</span> final = <span class="hljs-keyword">await</span> llmWithSearch.<span class="hljs-title function_">invoke</span>(messages);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"\n✅ AI 回答:"</span>, final.<span class="hljs-property">content</span>);
    <span class="hljs-keyword">return</span> final.<span class="hljs-property">content</span>;
  }

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"✅ AI 回答:"</span>, response.<span class="hljs-property">content</span>);
  <span class="hljs-keyword">return</span> response.<span class="hljs-property">content</span>;
}

<span class="hljs-comment">// 测试真实搜索</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">searchAndAnswer</span>(<span class="hljs-string">"2024年诺贝尔物理学奖得主是谁？"</span>);
</code></pre>
<p><strong>运行测试：</strong></p>
<pre><code class="hljs language-bash" lang="bash">node 04-tavily-search.js
</code></pre>
<p><strong>如果没有 Tavily API Key</strong>，可以跳过此练习，前面的练习已经涵盖了 Tools 的核心概念。</p>
<hr/>
<h3 data-id="heading-50">Agent 智能代理（进阶）</h3>
<blockquote>
<p>⚠️ <strong>注意</strong>：在 LangChain.js v1.x 中，Agent 相关功能已迁移到 <code>@langchain/langgraph</code> 包。</p>
<p>如果你需要使用 Agent，请安装：<code>npm install @langchain/langgraph</code></p>
</blockquote>
<h4 data-id="heading-51">什么是 Agent？</h4>
<p><strong>Agent</strong> 是一个智能代理，它可以：</p>
<ol>
<li>🤔 <strong>分析任务</strong> - 理解用户需求</li>
<li>🛠️ <strong>选择工具</strong> - 决定调用哪些工具</li>
<li>🔄 <strong>执行循环</strong> - 自动调用工具、获取结果、再分析</li>
<li>💬 <strong>生成答案</strong> - 整合所有信息，给出最终回答</li>
</ol>
<h4 data-id="heading-52">手动实现 vs Agent</h4>



































<table><thead><tr><th>对比项</th><th>手动实现（推荐入门）</th><th>Agent（进阶）</th></tr></thead><tbody><tr><td><strong>依赖包</strong></td><td><code>@langchain/core</code></td><td><code>@langchain/langgraph</code></td></tr><tr><td><strong>工具选择</strong></td><td>需要你编写逻辑</td><td>AI 自动决定</td></tr><tr><td><strong>循环调用</strong></td><td>需要手动编写循环</td><td>自动执行多轮调用</td></tr><tr><td><strong>学习曲线</strong></td><td>低，更容易理解原理</td><td>高，抽象程度更高</td></tr><tr><td><strong>适用场景</strong></td><td>学习、简单任务</td><td>复杂的生产应用</td></tr></tbody></table>
<h4 data-id="heading-53">学习建议</h4>
<ol>
<li><strong>先掌握手动实现</strong>：理解工具调用的完整流程</li>
<li><strong>再学习 LangGraph</strong>：用于构建复杂的 Agent 应用</li>
<li><strong>参考文档</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Flangchain-ai.github.io%2Flanggraphjs%2F" target="_blank" title="https://langchain-ai.github.io/langgraphjs/" ref="nofollow noopener noreferrer">langchain-ai.github.io/langgraphjs…</a></li>
</ol>
<hr/>
<h3 data-id="heading-54">实战案例分析</h3>
<h4 data-id="heading-55">案例 1: 智能客服助手</h4>
<p><strong>需求</strong>: 创建一个客服助手，可以查询订单状态、退款信息、物流信息。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">HumanMessage</span>, <span class="hljs-title class_">ToolMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/messages"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">DynamicStructuredTool</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/tools"</span>;
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">"zod"</span>;

<span class="hljs-comment">// 工具 1: 查询订单</span>
<span class="hljs-keyword">const</span> orderTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"query_order"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"查询订单状态和详情"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">order_id</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"订单号"</span>),
  }),
  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ order_id }) =&gt; {
    <span class="hljs-comment">// 调用订单系统 API</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
      <span class="hljs-attr">order_id</span>: order_id,
      <span class="hljs-attr">status</span>: <span class="hljs-string">"已发货"</span>,
      <span class="hljs-attr">total</span>: <span class="hljs-number">299.0</span>,
      <span class="hljs-attr">items</span>: [<span class="hljs-string">"iPhone 数据线"</span>, <span class="hljs-string">"充电器"</span>],
    });
  },
});

<span class="hljs-comment">// 工具 2: 查询物流</span>
<span class="hljs-keyword">const</span> logisticsTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"query_logistics"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"查询包裹物流信息"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">tracking_number</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"物流单号"</span>),
  }),
  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ tracking_number }) =&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
      <span class="hljs-attr">status</span>: <span class="hljs-string">"运输中"</span>,
      <span class="hljs-attr">location</span>: <span class="hljs-string">"北京分拨中心"</span>,
      <span class="hljs-attr">expected_delivery</span>: <span class="hljs-string">"2025-12-05"</span>,
    });
  },
});

<span class="hljs-comment">// 工具 3: 申请退款</span>
<span class="hljs-keyword">const</span> refundTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"request_refund"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"为订单申请退款"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">order_id</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"订单号"</span>),
    <span class="hljs-attr">reason</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"退款原因"</span>),
  }),
  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ order_id, reason }) =&gt; {
    <span class="hljs-comment">// 调用退款系统</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
      <span class="hljs-attr">refund_id</span>: <span class="hljs-string">"RF"</span> + <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
      <span class="hljs-attr">status</span>: <span class="hljs-string">"已提交"</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">"退款申请已提交，预计 3-5 个工作日处理完成"</span>,
    });
  },
});

<span class="hljs-comment">// 创建客服工具集</span>
<span class="hljs-keyword">const</span> customerServiceTools = [orderTool, logisticsTool, refundTool];
<span class="hljs-keyword">const</span> llmWithCustomerTools = llm.<span class="hljs-title function_">bindTools</span>(customerServiceTools);

<span class="hljs-comment">// 使用完整的工具调用流程</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">customerServiceChat</span>(<span class="hljs-params">question</span>) {
  <span class="hljs-keyword">const</span> messages = [<span class="hljs-keyword">new</span> <span class="hljs-title class_">HumanMessage</span>(question)];
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llmWithCustomerTools.<span class="hljs-title function_">invoke</span>(messages);

  <span class="hljs-keyword">if</span> (response.<span class="hljs-property">tool_calls</span> &amp;&amp; response.<span class="hljs-property">tool_calls</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    messages.<span class="hljs-title function_">push</span>(response);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> toolCall <span class="hljs-keyword">of</span> response.<span class="hljs-property">tool_calls</span>) {
      <span class="hljs-keyword">const</span> tool = customerServiceTools.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.<span class="hljs-property">name</span> === toolCall.<span class="hljs-property">name</span>);
      <span class="hljs-keyword">if</span> (tool) {
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> tool.<span class="hljs-title function_">invoke</span>(toolCall.<span class="hljs-property">args</span>);
        messages.<span class="hljs-title function_">push</span>(
          <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolMessage</span>({
            <span class="hljs-attr">tool_call_id</span>: toolCall.<span class="hljs-property">id</span>,
            <span class="hljs-attr">content</span>: result,
          })
        );
      }
    }

    <span class="hljs-keyword">const</span> finalResponse = <span class="hljs-keyword">await</span> llmWithCustomerTools.<span class="hljs-title function_">invoke</span>(messages);
    <span class="hljs-keyword">return</span> finalResponse.<span class="hljs-property">content</span>;
  }

  <span class="hljs-keyword">return</span> response.<span class="hljs-property">content</span>;
}

<span class="hljs-comment">// 测试</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">customerServiceChat</span>(<span class="hljs-string">"我的订单 12345 什么时候能到？"</span>);
</code></pre>
<h4 data-id="heading-56">案例 2: 数据分析助手</h4>
<p><strong>需求</strong>: 分析销售数据，生成报告。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">HumanMessage</span>, <span class="hljs-title class_">ToolMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/messages"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">DynamicStructuredTool</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/tools"</span>;
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">"zod"</span>;

<span class="hljs-comment">// 工具 1: 查询销售数据</span>
<span class="hljs-keyword">const</span> salesDataTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"get_sales_data"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"获取指定时间范围的销售数据"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">start_date</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"开始日期 YYYY-MM-DD"</span>),
    <span class="hljs-attr">end_date</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"结束日期 YYYY-MM-DD"</span>),
  }),
  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ start_date, end_date }) =&gt; {
    <span class="hljs-comment">// 查询数据库</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>([
      { <span class="hljs-attr">date</span>: <span class="hljs-string">"2025-12-01"</span>, <span class="hljs-attr">sales</span>: <span class="hljs-number">15000</span>, <span class="hljs-attr">orders</span>: <span class="hljs-number">50</span> },
      { <span class="hljs-attr">date</span>: <span class="hljs-string">"2025-12-02"</span>, <span class="hljs-attr">sales</span>: <span class="hljs-number">18000</span>, <span class="hljs-attr">orders</span>: <span class="hljs-number">60</span> },
    ]);
  },
});

<span class="hljs-comment">// 工具 2: 计算统计指标</span>
<span class="hljs-keyword">const</span> statisticsTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"calculate_statistics"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"计算平均值、总和、增长率等统计指标"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">data</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"JSON 格式的数据数组"</span>),
    <span class="hljs-attr">metric</span>: z.<span class="hljs-title function_">enum</span>([<span class="hljs-string">"average"</span>, <span class="hljs-string">"sum"</span>, <span class="hljs-string">"growth_rate"</span>]),
  }),
  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ data, metric }) =&gt; {
    <span class="hljs-keyword">const</span> dataArray = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(data);
    <span class="hljs-comment">// 计算逻辑</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"统计结果..."</span>;
  },
});

<span class="hljs-comment">// 创建数据分析工具集</span>
<span class="hljs-keyword">const</span> analyticsTools = [salesDataTool, statisticsTool];
<span class="hljs-keyword">const</span> llmWithAnalyticsTools = llm.<span class="hljs-title function_">bindTools</span>(analyticsTools);

<span class="hljs-comment">// 使用工具进行数据分析</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">analyzeData</span>(<span class="hljs-params">question</span>) {
  <span class="hljs-keyword">const</span> messages = [<span class="hljs-keyword">new</span> <span class="hljs-title class_">HumanMessage</span>(question)];
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llmWithAnalyticsTools.<span class="hljs-title function_">invoke</span>(messages);

  <span class="hljs-keyword">if</span> (response.<span class="hljs-property">tool_calls</span> &amp;&amp; response.<span class="hljs-property">tool_calls</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    messages.<span class="hljs-title function_">push</span>(response);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> toolCall <span class="hljs-keyword">of</span> response.<span class="hljs-property">tool_calls</span>) {
      <span class="hljs-keyword">const</span> tool = analyticsTools.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.<span class="hljs-property">name</span> === toolCall.<span class="hljs-property">name</span>);
      <span class="hljs-keyword">if</span> (tool) {
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> tool.<span class="hljs-title function_">invoke</span>(toolCall.<span class="hljs-property">args</span>);
        messages.<span class="hljs-title function_">push</span>(
          <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolMessage</span>({
            <span class="hljs-attr">tool_call_id</span>: toolCall.<span class="hljs-property">id</span>,
            <span class="hljs-attr">content</span>: result,
          })
        );
      }
    }

    <span class="hljs-keyword">const</span> finalResponse = <span class="hljs-keyword">await</span> llmWithAnalyticsTools.<span class="hljs-title function_">invoke</span>(messages);
    <span class="hljs-keyword">return</span> finalResponse.<span class="hljs-property">content</span>;
  }

  <span class="hljs-keyword">return</span> response.<span class="hljs-property">content</span>;
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">analyzeData</span>(<span class="hljs-string">"帮我分析一下 12 月份的销售情况，计算平均销售额和增长率"</span>);
</code></pre>
<hr/>
<h3 data-id="heading-57">最佳实践</h3>
<h4 data-id="heading-58">✅ 1. 编写清晰的工具描述</h4>
<p><strong>❌ 不好的描述</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">description</span>: <span class="hljs-string">"查询天气"</span>;
</code></pre>
<p><strong>✅ 好的描述</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">description</span>: <span class="hljs-string">"获取指定城市的天气信息。当用户询问天气、温度、是否下雨时使用此工具。"</span>;
</code></pre>
<p><strong>为什么？</strong></p>
<ul>
<li>明确的描述帮助 AI 准确判断何时使用工具</li>
<li>包含使用场景示例</li>
</ul>
<h4 data-id="heading-59">✅ 2. 为参数添加详细的 describe</h4>
<p><strong>❌ 不好的参数定义</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
  <span class="hljs-attr">city</span>: z.<span class="hljs-title function_">string</span>(),
  <span class="hljs-attr">date</span>: z.<span class="hljs-title function_">string</span>(),
});
</code></pre>
<p><strong>✅ 好的参数定义</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
  <span class="hljs-attr">city</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"城市名称，例如：北京、上海、深圳"</span>),
  <span class="hljs-attr">date</span>: z
    .<span class="hljs-title function_">string</span>()
    .<span class="hljs-title function_">optional</span>()
    .<span class="hljs-title function_">describe</span>(<span class="hljs-string">"日期，格式: YYYY-MM-DD。如果不提供则查询今天的天气"</span>),
});
</code></pre>
<h4 data-id="heading-60">✅ 3. 统一返回格式</h4>
<p><strong>推荐返回 JSON 字符串：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ city }) =&gt; {
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchWeather</span>(city);

  <span class="hljs-comment">// ✅ 返回结构化的 JSON</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
    <span class="hljs-attr">city</span>: city,
    <span class="hljs-attr">temperature</span>: data.<span class="hljs-property">temp</span>,
    <span class="hljs-attr">condition</span>: data.<span class="hljs-property">condition</span>,
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
  });

  <span class="hljs-comment">// ❌ 不要返回随意格式的字符串</span>
  <span class="hljs-comment">// return `${city}的天气是${data.condition}，温度${data.temp}度`;</span>
};
</code></pre>
<h4 data-id="heading-61">✅ 4. 错误处理</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ expression }) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">calculate</span>(expression);
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">result</span>: result });
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// 返回友好的错误信息</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"计算失败"</span>,
      <span class="hljs-attr">message</span>: error.<span class="hljs-property">message</span>,
    });
  }
};
</code></pre>
<h4 data-id="heading-62">✅ 5. 使用低温度</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 工具调用时建议使用 temperature = 0</span>
<span class="hljs-keyword">const</span> llm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({
  <span class="hljs-attr">model</span>: <span class="hljs-string">"deepseek-chat"</span>,
  <span class="hljs-attr">temperature</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 确保工具选择的确定性</span>
});
</code></pre>
<h4 data-id="heading-63">✅ 6. 限制工具调用深度</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在手动实现中，通过计数器限制调用次数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">chatWithToolsLimited</span>(<span class="hljs-params">question, maxIterations = <span class="hljs-number">3</span></span>) {
  <span class="hljs-keyword">let</span> iteration = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> messages = [<span class="hljs-keyword">new</span> <span class="hljs-title class_">HumanMessage</span>(question)];

  <span class="hljs-keyword">while</span> (iteration &lt; maxIterations) {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llmWithTools.<span class="hljs-title function_">invoke</span>(messages);

    <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">tool_calls</span> || response.<span class="hljs-property">tool_calls</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> response.<span class="hljs-property">content</span>; <span class="hljs-comment">// 完成</span>
    }

    messages.<span class="hljs-title function_">push</span>(response);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> toolCall <span class="hljs-keyword">of</span> response.<span class="hljs-property">tool_calls</span>) {
      <span class="hljs-keyword">const</span> tool = tools.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.<span class="hljs-property">name</span> === toolCall.<span class="hljs-property">name</span>);
      <span class="hljs-keyword">if</span> (tool) {
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> tool.<span class="hljs-title function_">invoke</span>(toolCall.<span class="hljs-property">args</span>);
        messages.<span class="hljs-title function_">push</span>(
          <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolMessage</span>({
            <span class="hljs-attr">tool_call_id</span>: toolCall.<span class="hljs-property">id</span>,
            <span class="hljs-attr">content</span>: result,
          })
        );
      }
    }

    iteration++;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-string">"达到最大迭代次数"</span>;
}
</code></pre>
<hr/>
<h3 data-id="heading-64">技术原理</h3>
<h4 data-id="heading-65">Function Calling (函数调用)</h4>
<p>LangChain Tools 基于大模型的 <strong>Function Calling</strong> 能力实现。</p>
<h5 data-id="heading-66">工作原理</h5>
<ol>
<li><strong>工具定义转换为函数签名</strong></li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 你定义的工具</span>
<span class="hljs-keyword">const</span> weatherTool = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"get_weather"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"获取天气"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({ <span class="hljs-attr">city</span>: z.<span class="hljs-title function_">string</span>() }),
};

<span class="hljs-comment">// LangChain 转换为模型能理解的格式</span>
{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"function"</span>,
  <span class="hljs-string">"function"</span>: {
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"get_weather"</span>,
    <span class="hljs-string">"description"</span>: <span class="hljs-string">"获取天气"</span>,
    <span class="hljs-string">"parameters"</span>: {
      <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
      <span class="hljs-string">"properties"</span>: {
        <span class="hljs-string">"city"</span>: { <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"城市名称"</span> }
      },
      <span class="hljs-string">"required"</span>: [<span class="hljs-string">"city"</span>]
    }
  }
}
</code></pre>
<ol start="2">
<li><strong>模型返回函数调用请求</strong></li>
</ol>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"assistant"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"tool_calls"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"call_xxx"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"function"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"function"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"get_weather"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{\"city\": \"北京\"}"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ol start="3">
<li><strong>LangChain 执行工具并返回结果</strong></li>
</ol>
<hr/>
<h3 data-id="heading-67">常见问题 FAQ</h3>
<h4 data-id="heading-68">Q1: AI 没有调用工具，而是直接回答了？</h4>
<p><strong>原因：</strong></p>
<ul>
<li>工具描述不够清晰</li>
<li>问题太模糊，AI 认为不需要工具</li>
</ul>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 改进工具描述</span>
<span class="hljs-attr">description</span>: <span class="hljs-string">"获取指定城市的实时天气信息。【重要】当用户询问任何关于天气、温度、降雨的问题时，必须使用此工具，不要根据训练数据猜测。"</span>;

<span class="hljs-comment">// ✅ 在调用时使用 system prompt 强调</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">SystemMessage</span>, <span class="hljs-title class_">HumanMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/messages"</span>;

<span class="hljs-keyword">const</span> messages = [
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">SystemMessage</span>(
    <span class="hljs-string">"你必须使用提供的工具来获取实时信息，不要根据训练数据回答。"</span>
  ),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">HumanMessage</span>(<span class="hljs-string">"北京天气怎么样？"</span>),
];
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llmWithTools.<span class="hljs-title function_">invoke</span>(messages);
</code></pre>
<h4 data-id="heading-69">Q2: 工具调用失败怎么办？</h4>
<p><strong>错误处理：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ city }) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchWeather</span>(city);
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">data</span>: data });
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// 返回结构化的错误信息</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"API 调用失败"</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">"无法获取天气数据，请稍后重试"</span>,
    });
  }
};
</code></pre>
<h4 data-id="heading-70">Q3: 如何调试工具调用？</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 在工具函数中打印调试信息</span>
<span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> (params) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"[DEBUG] 工具被调用，参数:"</span>, params);
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">doSomething</span>(params);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"[DEBUG] 工具返回:"</span>, result);
  <span class="hljs-keyword">return</span> result;
};

<span class="hljs-comment">// 2. 打印 AI 的 tool_calls</span>
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llmWithTools.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">"北京天气怎么样？"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"AI tool_calls:"</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(response.<span class="hljs-property">tool_calls</span>, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));

<span class="hljs-comment">// 3. 手动测试工具（不经过 AI）</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> weatherTool.<span class="hljs-title function_">invoke</span>({ <span class="hljs-attr">city</span>: <span class="hljs-string">"北京"</span> });
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"直接调用结果:"</span>, result);

<span class="hljs-comment">// 4. 打印完整的消息流</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">debugChatWithTools</span>(<span class="hljs-params">question</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"=== 开始调试 ==="</span>);
  <span class="hljs-keyword">const</span> messages = [<span class="hljs-keyword">new</span> <span class="hljs-title class_">HumanMessage</span>(question)];
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"初始消息:"</span>, messages);

  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llmWithTools.<span class="hljs-title function_">invoke</span>(messages);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"AI 响应:"</span>, response);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"tool_calls:"</span>, response.<span class="hljs-property">tool_calls</span>);
  <span class="hljs-comment">// ... 继续调试</span>
}
</code></pre>
<h4 data-id="heading-71">Q4: 工具太多，AI 选错了怎么办？</h4>
<p><strong>解决方案：</strong></p>
<ol>
<li><strong>减少工具数量</strong> - 每个 Agent 不要超过 10 个工具</li>
<li><strong>优化描述</strong> - 让每个工具的功能更明确</li>
<li><strong>分组管理</strong> - 为不同任务创建不同的 Agent</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 所有工具放在一起（超过 10 个工具）</span>
<span class="hljs-keyword">const</span> allTools = [
  weatherTool,
  calculatorTool,
  orderTool,
  refundTool,
  logisticsTool,
  databaseTool,
  emailTool,
  searchTool,
  translateTool,
  timeTool, <span class="hljs-comment">// ... 更多工具</span>
];

<span class="hljs-comment">// ✅ 按功能分组，创建不同的 LLM 实例</span>
<span class="hljs-keyword">const</span> customerServiceTools = [orderTool, refundTool, logisticsTool];
<span class="hljs-keyword">const</span> llmForCustomerService = llm.<span class="hljs-title function_">bindTools</span>(customerServiceTools);

<span class="hljs-keyword">const</span> dataAnalysisTools = [databaseTool, calculatorTool, statisticsTool];
<span class="hljs-keyword">const</span> llmForDataAnalysis = llm.<span class="hljs-title function_">bindTools</span>(dataAnalysisTools);
</code></pre>
<h4 data-id="heading-72">Q5: 如何实现工具的权限控制？</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> sensitiveOperationTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"delete_user"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"删除用户（仅管理员可用）"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">user_id</span>: z.<span class="hljs-title function_">string</span>(),
    <span class="hljs-attr">admin_token</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"管理员令牌"</span>),
  }),
  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ user_id, admin_token }) =&gt; {
    <span class="hljs-comment">// 验证权限</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">verifyAdminToken</span>(admin_token)) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"权限不足"</span>,
      });
    }

    <span class="hljs-comment">// 执行操作</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">deleteUser</span>(user_id);
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span> });
  },
});
</code></pre>
<hr/>
<h3 data-id="heading-73">进阶主题</h3>
<h4 data-id="heading-74">1. 工具的组合与链式调用</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 场景：查询天气后，根据天气推荐穿衣</span>
<span class="hljs-keyword">const</span> weatherTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-comment">/* ... */</span>
});
<span class="hljs-keyword">const</span> clothingRecommendationTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"recommend_clothing"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"根据天气推荐穿衣"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">temperature</span>: z.<span class="hljs-title function_">number</span>(),
    <span class="hljs-attr">condition</span>: z.<span class="hljs-title function_">string</span>(),
  }),
  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ temperature, condition }) =&gt; {
    <span class="hljs-comment">// 推荐逻辑</span>
  },
});

<span class="hljs-comment">// Agent 会自动：</span>
<span class="hljs-comment">// 1. 调用 weatherTool 获取天气</span>
<span class="hljs-comment">// 2. 将结果传给 clothingRecommendationTool</span>
<span class="hljs-comment">// 3. 生成最终建议</span>
</code></pre>
<h4 data-id="heading-75">2. 手动实现多轮对话（保存上下文）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用数组保存对话历史</span>
<span class="hljs-keyword">const</span> conversationHistory = [];

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">chatWithMemory</span>(<span class="hljs-params">question</span>) {
  <span class="hljs-comment">// 添加新的用户消息</span>
  conversationHistory.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HumanMessage</span>(question));

  <span class="hljs-comment">// 调用 AI（包含历史上下文）</span>
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llmWithTools.<span class="hljs-title function_">invoke</span>(conversationHistory);

  <span class="hljs-keyword">if</span> (response.<span class="hljs-property">tool_calls</span> &amp;&amp; response.<span class="hljs-property">tool_calls</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    conversationHistory.<span class="hljs-title function_">push</span>(response);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> toolCall <span class="hljs-keyword">of</span> response.<span class="hljs-property">tool_calls</span>) {
      <span class="hljs-keyword">const</span> tool = tools.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.<span class="hljs-property">name</span> === toolCall.<span class="hljs-property">name</span>);
      <span class="hljs-keyword">if</span> (tool) {
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> tool.<span class="hljs-title function_">invoke</span>(toolCall.<span class="hljs-property">args</span>);
        conversationHistory.<span class="hljs-title function_">push</span>(
          <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolMessage</span>({
            <span class="hljs-attr">tool_call_id</span>: toolCall.<span class="hljs-property">id</span>,
            <span class="hljs-attr">content</span>: result,
          })
        );
      }
    }

    <span class="hljs-keyword">const</span> finalResponse = <span class="hljs-keyword">await</span> llmWithTools.<span class="hljs-title function_">invoke</span>(conversationHistory);
    conversationHistory.<span class="hljs-title function_">push</span>(finalResponse);
    <span class="hljs-keyword">return</span> finalResponse.<span class="hljs-property">content</span>;
  }

  conversationHistory.<span class="hljs-title function_">push</span>(response);
  <span class="hljs-keyword">return</span> response.<span class="hljs-property">content</span>;
}

<span class="hljs-comment">// 多轮对话示例</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">chatWithMemory</span>(<span class="hljs-string">"查询订单 12345"</span>);
<span class="hljs-keyword">await</span> <span class="hljs-title function_">chatWithMemory</span>(<span class="hljs-string">"这个订单什么时候发货的？"</span>); <span class="hljs-comment">// AI 会记得之前的订单号</span>
</code></pre>
<h4 data-id="heading-76">3. 实现流式工具调用</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 注意：工具调用本身通常不支持流式</span>
<span class="hljs-comment">// 但可以在工具结果返回后，流式输出最终回答</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">streamFinalAnswer</span>(<span class="hljs-params">question</span>) {
  <span class="hljs-keyword">const</span> messages = [<span class="hljs-keyword">new</span> <span class="hljs-title class_">HumanMessage</span>(question)];
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llmWithTools.<span class="hljs-title function_">invoke</span>(messages);

  <span class="hljs-keyword">if</span> (response.<span class="hljs-property">tool_calls</span> &amp;&amp; response.<span class="hljs-property">tool_calls</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    messages.<span class="hljs-title function_">push</span>(response);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> toolCall <span class="hljs-keyword">of</span> response.<span class="hljs-property">tool_calls</span>) {
      <span class="hljs-keyword">const</span> tool = tools.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.<span class="hljs-property">name</span> === toolCall.<span class="hljs-property">name</span>);
      <span class="hljs-keyword">if</span> (tool) {
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> tool.<span class="hljs-title function_">invoke</span>(toolCall.<span class="hljs-property">args</span>);
        messages.<span class="hljs-title function_">push</span>(
          <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolMessage</span>({
            <span class="hljs-attr">tool_call_id</span>: toolCall.<span class="hljs-property">id</span>,
            <span class="hljs-attr">content</span>: result,
          })
        );
      }
    }

    <span class="hljs-comment">// 流式输出最终回答</span>
    <span class="hljs-keyword">const</span> stream = <span class="hljs-keyword">await</span> llmWithTools.<span class="hljs-title function_">stream</span>(messages);
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> chunk <span class="hljs-keyword">of</span> stream) {
      process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(chunk.<span class="hljs-property">content</span> || <span class="hljs-string">""</span>);
    }
  }
}
</code></pre>
<hr/>
<h3 data-id="heading-77">学习路径建议</h3>
<h4 data-id="heading-78">📁 本文配套实战文件</h4>
<p>按顺序完成以下练习，逐步掌握 Tools 的使用：</p>



































<table><thead><tr><th>文件名</th><th>内容</th><th>预计用时</th></tr></thead><tbody><tr><td><code>test-setup.js</code></td><td>环境验证</td><td>5 分钟</td></tr><tr><td><code>01-create-tool.js</code></td><td>创建自定义工具</td><td>15 分钟</td></tr><tr><td><code>02-bind-tools.js</code></td><td>AI 自动选择工具</td><td>20 分钟</td></tr><tr><td><code>03-tool-loop.js</code></td><td>完整工具调用循环</td><td>30 分钟</td></tr><tr><td><code>04-tavily-search.js</code></td><td>TavilySearch 真实搜索</td><td>20 分钟</td></tr></tbody></table>
<h4 data-id="heading-79">🎯 学习路线</h4>
<p><strong>第 1 阶段：基础入门（1 小时）</strong></p>
<ol>
<li>✅ 完成环境搭建，运行 <code>test-setup.js</code></li>
<li>✅ 完成 <code>01-create-tool.js</code>，理解工具四要素</li>
<li>✅ 完成 <code>02-bind-tools.js</code>，观察 AI 如何选择工具</li>
</ol>
<p><strong>第 2 阶段：核心掌握（1-2 小时）</strong></p>
<ol>
<li>🔥 完成 <code>03-tool-loop.js</code>，理解 ToolMessage 的作用</li>
<li>🔥 尝试修改工具的 <code>description</code>，观察 AI 行为变化</li>
<li>🔥 创建自己的工具（如：随机数、单位转换）</li>
</ol>
<p><strong>第 3 阶段：进阶应用（2+ 小时）</strong></p>
<ol>
<li>💎 注册 Tavily 账号，完成 <code>04-tavily-search.js</code></li>
<li>💎 创建多工具应用（如：智能助手）</li>
<li>💎 学习 LangGraph 构建复杂 Agent</li>
</ol>
<hr/>
<h3 data-id="heading-80">实战挑战</h3>
<h4 data-id="heading-81">🥉 挑战 1：创建实用工具集</h4>
<p>在掌握基础后，尝试创建以下工具：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建 05-my-tools.js，实现以下工具：</span>

<span class="hljs-comment">// 1. 随机数生成器</span>
<span class="hljs-keyword">const</span> randomTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"random"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"生成随机数"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">min</span>: z.<span class="hljs-title function_">number</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"最小值"</span>),
    <span class="hljs-attr">max</span>: z.<span class="hljs-title function_">number</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"最大值"</span>),
  }),
  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ min, max }) =&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">String</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * (max - min + <span class="hljs-number">1</span>)) + min);
  },
});

<span class="hljs-comment">// 2. 单位转换工具（温度）</span>
<span class="hljs-keyword">const</span> tempConverterTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"convert_temp"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"摄氏度和华氏度转换"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">value</span>: z.<span class="hljs-title function_">number</span>(),
    <span class="hljs-attr">from</span>: z.<span class="hljs-title function_">enum</span>([<span class="hljs-string">"C"</span>, <span class="hljs-string">"F"</span>]),
  }),
  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ value, <span class="hljs-keyword">from</span> }) =&gt; {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">from</span> === <span class="hljs-string">"C"</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${value}</span>°C = <span class="hljs-subst">${((value * <span class="hljs-number">9</span>) / <span class="hljs-number">5</span> + <span class="hljs-number">32</span>).toFixed(<span class="hljs-number">1</span>)}</span>°F`</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${value}</span>°F = <span class="hljs-subst">${(((value - <span class="hljs-number">32</span>) * <span class="hljs-number">5</span>) / <span class="hljs-number">9</span>).toFixed(<span class="hljs-number">1</span>)}</span>°C`</span>;
  },
});

<span class="hljs-comment">// 3. 字符串处理工具</span>
<span class="hljs-keyword">const</span> stringTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"string_process"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"字符串处理：大小写转换、反转、Base64编码"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">text</span>: z.<span class="hljs-title function_">string</span>(),
    <span class="hljs-attr">operation</span>: z.<span class="hljs-title function_">enum</span>([<span class="hljs-string">"upper"</span>, <span class="hljs-string">"lower"</span>, <span class="hljs-string">"reverse"</span>, <span class="hljs-string">"base64"</span>]),
  }),
  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ text, operation }) =&gt; {
    <span class="hljs-keyword">switch</span> (operation) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">"upper"</span>:
        <span class="hljs-keyword">return</span> text.<span class="hljs-title function_">toUpperCase</span>();
      <span class="hljs-keyword">case</span> <span class="hljs-string">"lower"</span>:
        <span class="hljs-keyword">return</span> text.<span class="hljs-title function_">toLowerCase</span>();
      <span class="hljs-keyword">case</span> <span class="hljs-string">"reverse"</span>:
        <span class="hljs-keyword">return</span> text.<span class="hljs-title function_">split</span>(<span class="hljs-string">""</span>).<span class="hljs-title function_">reverse</span>().<span class="hljs-title function_">join</span>(<span class="hljs-string">""</span>);
      <span class="hljs-keyword">case</span> <span class="hljs-string">"base64"</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(text).<span class="hljs-title function_">toString</span>(<span class="hljs-string">"base64"</span>);
    }
  },
});
</code></pre>
<h4 data-id="heading-82">🥈 挑战 2：智能助手应用</h4>
<p>创建一个结合多个工具的智能助手：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建 06-smart-assistant.js</span>
<span class="hljs-comment">// 结合天气、时间、计算器、搜索等工具</span>
<span class="hljs-comment">// 实现一个可以回答各种问题的助手</span>
</code></pre>
<h4 data-id="heading-83">🥇 挑战 3：带记忆的对话系统</h4>
<p>参考"进阶主题"章节，实现多轮对话记忆功能。</p>
<h4 data-id="heading-84">💡 挑战完成检验</h4>
<p>完成挑战后，尝试回答以下问题：</p>
<ol>
<li>工具的 <code>description</code> 对 AI 的工具选择有什么影响？</li>
<li>为什么工具函数的返回值建议使用字符串？</li>
<li><code>ToolMessage</code> 的 <code>tool_call_id</code> 为什么是必须的？</li>
<li>如何让 AI 在不需要工具时直接回答？</li>
</ol>
<hr/>
<h3 data-id="heading-85">参考资源</h3>
<h4 data-id="heading-86">官方文档</h4>
<ul>
<li><strong>LangChain Tools 官方文档</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fjs.langchain.com%2Fdocs%2Fconcepts%2Ftools%2F" target="_blank" title="https://js.langchain.com/docs/concepts/tools/" ref="nofollow noopener noreferrer">js.langchain.com/docs/concep…</a></li>
<li><strong>LangChain 内置工具列表</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fjs.langchain.com%2Fdocs%2Fintegrations%2Ftools" target="_blank" title="https://js.langchain.com/docs/integrations/tools" ref="nofollow noopener noreferrer">js.langchain.com/docs/integr…</a></li>
<li><strong>LangGraph（Agent 框架）</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Flangchain-ai.github.io%2Flanggraphjs%2F" target="_blank" title="https://langchain-ai.github.io/langgraphjs/" ref="nofollow noopener noreferrer">langchain-ai.github.io/langgraphjs…</a></li>
<li><strong>Zod Schema 验证</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fzod.dev%2F" target="_blank" title="https://zod.dev/" ref="nofollow noopener noreferrer">zod.dev/</a></li>
</ul>
<h4 data-id="heading-87">API 服务</h4>
<ul>
<li><strong>Tavily Search API</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Ftavily.com%2F" target="_blank" title="https://tavily.com/" ref="nofollow noopener noreferrer">tavily.com/</a> （专为 AI 设计的搜索引擎）</li>
<li><strong>DeepSeek API</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.deepseek.com%2F" target="_blank" title="https://platform.deepseek.com/" ref="nofollow noopener noreferrer">platform.deepseek.com/</a> （高性价比 LLM）</li>
<li><strong>OpenAI Function Calling</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.openai.com%2Fdocs%2Fguides%2Ffunction-calling" target="_blank" title="https://platform.openai.com/docs/guides/function-calling" ref="nofollow noopener noreferrer">platform.openai.com/docs/guides…</a></li>
</ul>
<h4 data-id="heading-88">开发工具</h4>
<ul>
<li><strong>Trae AI IDE</strong>: <a href="https://www.trae.ai/" target="_blank" title="https://www.trae.ai/" ref="nofollow noopener noreferrer">www.trae.ai/</a> （推荐的 AI 开发环境）</li>
</ul>
<hr/>
<h3 data-id="heading-89">总结</h3>
<h4 data-id="heading-90">🎯 核心要点</h4>
<ol>
<li><strong>Tools 让 AI 拥有能力</strong> - 查询数据、执行计算、调用 API</li>
<li><strong>四要素</strong> - name、description、schema、func</li>
<li><strong>ToolMessage</strong> - 将工具结果传回 AI 的关键</li>
<li><strong>内置工具</strong> - TavilySearch 等 LangChain 官方工具开箱即用</li>
<li><strong>最佳实践</strong> - 清晰描述、错误处理、统一格式</li>
</ol>
<h4 data-id="heading-91">💡 记住这句话</h4>
<blockquote>
<p><strong>Tools 不是让 AI 更聪明，而是让 AI 能做更多事情。</strong></p>
</blockquote>
<h4 data-id="heading-92">📁 本文实战文件清单</h4>
<p>完成本教程后，你的项目结构应该是：</p>
<pre><code class="hljs language-perl" lang="perl">langchain-tools-demo/
├── .env                    <span class="hljs-comment"># 环境变量配置</span>
├── package.json            <span class="hljs-comment"># 项目配置</span>
├── test-setup.js           <span class="hljs-comment"># 环境验证</span>
├── <span class="hljs-number">01</span>-create-tool.js       <span class="hljs-comment"># 实战练习 1：创建工具</span>
├── <span class="hljs-number">02</span>-<span class="hljs-keyword">bind</span>-tools.js        <span class="hljs-comment"># 实战练习 2：绑定工具</span>
├── <span class="hljs-number">03</span>-tool-loop.js         <span class="hljs-comment"># 实战练习 3：完整调用循环</span>
├── <span class="hljs-number">04</span>-tavily-search.js     <span class="hljs-comment"># 实战练习 4：TavilySearch</span>
├── <span class="hljs-number">05</span>-<span class="hljs-keyword">my</span>-tools.js          <span class="hljs-comment"># 挑战 1：自定义工具集</span>
└── <span class="hljs-number">06</span>-smart-assistant.js   <span class="hljs-comment"># 挑战 2：智能助手</span>
</code></pre>
<h4 data-id="heading-93">🔑 关键收获</h4>
<p>学完本文后，你应该能够：</p>
<ul>
<li>✅ 使用 Trae 搭建 LangChain 开发环境</li>
<li>✅ 理解 Tools 的工作原理和使用场景</li>
<li>✅ 创建自定义工具并绑定到 LLM</li>
<li>✅ 实现完整的工具调用循环（包括 ToolMessage）</li>
<li>✅ 使用 TavilySearch 实现真实的互联网搜索</li>
<li>✅ 调试工具调用问题并进行优化</li>
</ul>
<hr/>
<h3 data-id="heading-94">作者寄语</h3>
<p>感谢你阅读这份文档！LangChain Tools 是 AI 应用开发中最实用的功能之一，希望这份详解能帮助你快速上手。</p>
<p><strong>动手实践是最好的学习方式！</strong> 不要只是阅读，请按照文中的实战练习一步步操作，你会发现 Tools 其实很简单。</p>
<p>如果你在学习过程中遇到问题，可以：</p>
<ul>
<li>💬 在 Trae 中询问 AI 助手，它能直接阅读你的代码帮你排查问题</li>
<li>📖 查阅 <a href="https://link.juejin.cn?target=https%3A%2F%2Fjs.langchain.com%2Fdocs%2Fconcepts%2Ftools%2F" target="_blank" title="https://js.langchain.com/docs/concepts/tools/" ref="nofollow noopener noreferrer">LangChain 官方文档</a></li>
<li>🔍 使用 TavilySearch 搜索最新的解决方案</li>
</ul>
<p>如果你觉得这份文档对你有帮助，欢迎：</p>
<ul>
<li>⭐ 点赞收藏，方便以后查阅</li>
<li>📢 分享给更多正在学习 AI 开发的朋友</li>
<li>💬 在评论区交流你的学习心得和实践成果</li>
</ul>
<p><strong>Happy Coding!</strong> 🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[A2A协议：打破AI智能体孤岛，构建智能协作新时代]]></title>    <link>https://juejin.cn/post/7578917474659237939</link>    <guid>https://juejin.cn/post/7578917474659237939</guid>    <pubDate>2025-12-02T08:35:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578917474659237939" data-draft-id="7578922565209866267" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="A2A协议：打破AI智能体孤岛，构建智能协作新时代"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2025-12-02T08:35:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一粒麦仔"/> <meta itemprop="url" content="https://juejin.cn/user/448256474881480"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            A2A协议：打破AI智能体孤岛，构建智能协作新时代
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/448256474881480/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一粒麦仔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T08:35:37.000Z" title="Tue Dec 02 2025 08:35:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1 引言：A2A协议的背景与意义</h2>
<p>随着人工智能技术的飞速发展，AI智能体（AI Agent）已经成为大模型落地业务场景的主流形式。然而，各大科技公司推出的智能体系统往往<strong>各自为政</strong>，形成封闭的生态孤岛，难以实现有效协同。这种碎片化状况严重限制了AI技术在复杂场景中的应用价值。</p>
<p>在此背景下，<strong>Google于2025年4月9日正式推出了Agent-to-Agent（A2A）协议</strong>，这是一个旨在实现不同AI智能体间无缝通信与协作的开放标准。A2A协议致力于解决智能体之间的<strong>互操作性挑战</strong>，让基于不同框架和供应商开发的AI智能体能够像人类团队一样协同工作，共同完成复杂任务。</p>
<p>A2A协议的核心理念是为智能体世界创建一种“通用语言”，类似于互联网中的TCP协议，为设备通信提供基础标准。这一协议的出现，标志着AI发展从追求单个模型能力向<strong>多智能体协同网络</strong>的重要转变，为构建真正开放、互联的AI生态系统奠定了坚实基础。</p>
<h2 data-id="heading-1">2 A2A协议的核心架构与设计理念</h2>
<h3 data-id="heading-2">2.1 基本架构与参与角色</h3>
<p>A2A协议采用经典的<strong>客户端-服务器架构</strong>，包含三个核心参与者：</p>
<ul>
<li><strong>用户</strong>：发起任务请求的终端用户，可以是人类或其他服务。</li>
<li><strong>客户端智能体</strong>：代表用户向远程智能体发起操作请求的实体。</li>
<li><strong>远程智能体</strong>：作为服务端处理请求的“黑箱”智能体，不暴露内部实现细节。</li>
</ul>
<p>这种架构设计体现了A2A协议的<strong>不透明执行原则</strong>，智能体之间无需共享记忆、思维或工具即可协同工作。每个智能体保持自身的独立性和封装性，仅通过标准化的接口进行通信。</p>
<h3 data-id="heading-3">2.2 核心技术组件</h3>
<p>A2A协议构建在一系列精心设计的技术组件之上，这些组件共同构成了智能体间协作的基础框架：</p>
<ul>
<li><strong>智能体卡片</strong>：每个支持A2A协议的智能体都通过一个标准化的JSON文件（称为Agent Card）描述自身能力。这个文件相当于智能体的“身份证”或“简历”，包含了智能体的名称、功能描述、技能列表、认证要求等元数据。Agent Card通常托管在特定的知名路径（<code>/.well-known/agent-card.json</code>），便于其他智能体发现和识别。</li>
<li><strong>任务管理机制</strong>：任务是A2A协议中的核心工作单元，具有完整的生命周期管理。每个任务有唯一ID，可处于提交、工作中、需要输入、完成、失败或取消等不同状态。A2A协议支持<strong>长时间运行的任务</strong>，生命周期可能长达数天，并提供了相应的状态跟踪和恢复机制。</li>
<li><strong>通信协议与数据格式</strong>：A2A采用<strong>HTTP</strong>作为传输协议，使用<strong>JSON-RPC 2.0</strong>作为数据交换格式。这种设计选择充分利用了现有Web标准的成熟度和普遍性，降低了协议的实施门槛。对于实时性要求高的场景，A2A还支持通过<strong>Server-Sent Events</strong>进行流式数据传输。</li>
</ul>
<h3 data-id="heading-4">2.3 核心设计原则</h3>
<p>A2A协议的成功源于以下几个关键设计原则：</p>
<ul>
<li><strong>简洁性</strong>：复用现有标准（如HTTP、JSON-RPC），而非创造全新复杂标准。</li>
<li><strong>企业级就绪</strong>：内置认证、安全、隐私、追踪和监控等企业级需求。</li>
<li><strong>异步优先</strong>：支持长时间运行的任务和需要人类参与的工作流程。</li>
<li><strong>模态无关</strong>：支持文本、音频/视频、表单、iframe等多种交互形式。</li>
<li><strong>黑盒执行</strong>：智能体间无需共享思考过程、计划或工具，保护知识产权。</li>
</ul>
<p><em>表：A2A协议的核心概念与功能</em></p>



































<table><thead><tr><th><strong>概念类型</strong></th><th><strong>核心组件</strong></th><th><strong>功能描述</strong></th><th><strong>技术实现</strong></th></tr></thead><tbody><tr><td><strong>发现机制</strong></td><td>Agent Card</td><td>智能体能力描述</td><td>JSON格式，标准路径托管</td></tr><tr><td><strong>任务管理</strong></td><td>Task</td><td>工作单元与生命周期</td><td>状态机模型，唯一ID标识</td></tr><tr><td><strong>通信单元</strong></td><td>Message/Part</td><td>智能体间数据交换</td><td>结构化数据，多部分支持</td></tr><tr><td><strong>输出结果</strong></td><td>Artifact</td><td>任务执行产物</td><td>不可变，可包含多个部分</td></tr></tbody></table>
<h2 data-id="heading-5">3 A2A协议的工作原理与流程</h2>
<h3 data-id="heading-6">3.1 智能体发现机制</h3>
<p>A2A协议下的智能体协作始于<strong>发现阶段</strong>。客户端智能体需要先发现具备相应能力的远程智能体，这一过程主要通过获取并解析Agent Card实现。</p>
<p>A2A支持三种主要的发现模式：</p>
<ul>
<li><strong>开放发现</strong>：智能体将其Agent Card托管在标准路径（如<code>/.well-known/agent-card.json</code>），供其他智能体自由查找。</li>
<li><strong>策展注册表</strong>：集中式的智能体目录，允许按特定能力进行搜索和筛选。</li>
<li><strong>直接配置</strong>：通过预配置或私下共享的方式直接指定智能体信息，适用于紧密耦合的场景。</li>
</ul>
<p>智能体卡片不仅包含基本身份信息，还详细列出了智能体支持的<strong>技能集</strong>和<strong>认证要求</strong>，使客户端能够准确判断其是否适合执行特定任务。</p>
<h3 data-id="heading-7">3.2 任务执行流程</h3>
<p>一旦客户端智能体发现了合适的远程智能体，双方便进入<strong>任务执行阶段</strong>，其基本流程如下：</p>
<ol>
<li><strong>任务创建</strong>：客户端智能体创建新任务，指定任务内容及相关参数。</li>
<li><strong>任务提交</strong>：客户端将任务发送给远程智能体，可选择同步或异步方式。</li>
<li><strong>任务处理</strong>：远程智能体执行任务，期间可能根据需要请求额外输入或上下文。</li>
<li><strong>结果返回</strong>：远程智能体以<strong>Artifact</strong>的形式返回任务结果，客户端进行整合。</li>
</ol>
<p>A2A协议支持多种交互模式以适应不同场景需求：</p>
<ul>
<li><strong>同步请求/响应</strong>：适用于快速、即时的操作，客户端等待任务完成。</li>
<li><strong>异步轮询</strong>：适用于耗时较长的任务，客户端定期查询任务状态。</li>
<li><strong>流式更新</strong>：通过SSE实现实时增量结果推送。</li>
<li><strong>推送通知</strong>：通过Webhook在任务状态变化时主动通知客户端。</li>
</ul>
<h3 data-id="heading-8">3.3 安全与认证机制</h3>
<p>A2A协议将智能体建模为企业级应用，提供了<strong>完善的安全机制</strong>：</p>
<ul>
<li>遵循OpenAPI认证规范，支持OAuth 2.0、API密钥等多种认证方案。</li>
<li>身份材料通过HTTP头部传递，而非放在消息体内，减少敏感信息暴露风险。</li>
<li>支持双向TLS加密，确保通信通道安全。</li>
<li>提供详细的审计日志，满足企业合规要求。</li>
</ul>
<h2 data-id="heading-9">4 A2A协议与MCP协议的关系</h2>
<p>在智能体通信协议领域，Anthropic公司提出的<strong>模型上下文协议（MCP）</strong> 是另一个备受关注的标准。理解A2A与MCP的关系对于把握智能体生态系统全貌至关重要。</p>
<h3 data-id="heading-10">4.1 功能定位差异</h3>
<p>尽管A2A和MCP都涉及智能体通信，但两者的<strong>功能定位</strong>存在明显区别：</p>
<ul>
<li><strong>A2A</strong>侧重于<strong>智能体间通信</strong>，解决的是不同智能体如何协作完成复杂任务的问题。它允许智能体像人类团队一样分工合作，各自发挥专长。</li>
<li><strong>MCP</strong>则侧重于<strong>智能体与工具间通信</strong>，主要解决大模型如何安全、高效地使用外部工具和数据源的问题。它更像是智能体的“工具包”，扩展了单个智能体的能力边界。</li>
</ul>
<h3 data-id="heading-11">4.2 互补性与协同效应</h3>
<p>实际上，A2A与MCP并非竞争关系，而是<strong>互补协同</strong>的。在未来可能的业务流程中，一个面向用户的助理型智能体通过A2A协议调用其他专用智能体，而这些被调用的智能体再通过MCP协议访问各自掌握的内外部工具完成任务。</p>
<p>这种分工协作的模式既能发挥各智能体的专业优势，又能保证工具使用的安全性和效率。正如Google官方表述，A2A与MCP是合作关系而非竞争关系，共同构建更加完善的智能体生态系统。</p>
<p><em>表：A2A协议与MCP协议对比</em></p>



































<table><thead><tr><th><strong>特性</strong></th><th><strong>A2A协议</strong></th><th><strong>MCP协议</strong></th></tr></thead><tbody><tr><td><strong>主要焦点</strong></td><td>智能体间协作</td><td>智能体与工具连接</td></tr><tr><td><strong>通信模式</strong></td><td>对等网络</td><td>星型结构</td></tr><tr><td><strong>设计理念</strong></td><td>黑盒协作，保持独立</td><td>透明访问，扩展能力</td></tr><tr><td><strong>典型场景</strong></td><td>多智能体任务分解与委派</td><td>单智能体工具调用与数据获取</td></tr><tr><td><strong>发起方</strong></td><td>Google</td><td>Anthropic</td></tr></tbody></table>
<h2 data-id="heading-12">5 如何使用A2A协议</h2>
<h3 data-id="heading-13">5.1 开发与集成方式</h3>
<p>对于希望集成A2A协议的开发者，Google提供了<strong>多语言SDK支持</strong>，目前包括Python、Go、JavaScript/TypeScript、Java和.NET五种编程语言。每种SDK都提供一致的API体验，确保跨平台兼容性。</p>
<p>实施A2A协议的基本步骤包括：</p>
<ol>
<li><strong>定义智能体能力</strong>：明确智能体的专长领域和能提供的服务。</li>
<li><strong>创建Agent Card</strong>：按照标准格式编写描述智能体能力的JSON文件。</li>
<li><strong>实现协议端点</strong>：根据A2A规范实现任务处理、状态查询等接口。</li>
<li><strong>部署发现机制</strong>：将Agent Card托管到标准路径或注册到目录服务。</li>
<li><strong>测试与验证</strong>：使用A2A Inspector等工具验证实现的合规性。</li>
</ol>
<h3 data-id="heading-14">5.2 实际应用示例</h3>
<p>考虑一个智能旅行规划场景，多个智能体通过A2A协议协作：</p>
<ol>
<li><strong>用户</strong>向<strong>旅行助手智能体</strong>提出需求：“帮我规划一个下周末的北京之旅”。</li>
<li><strong>旅行助手智能体</strong>（客户端角色）通过查询Agent Card，发现并调用几个专业智能体：
<ul>
<li><strong>天气查询智能体</strong>：获取北京下周的天气预报。</li>
<li><strong>航班查询智能体</strong>：查找可用航班和价格。</li>
<li><strong>酒店预订智能体</strong>：搜索符合预算的住宿选项。</li>
</ul>
</li>
<li>各专业智能体（远程智能体角色）并行处理子任务，并通过A2A协议返回结果。</li>
<li><strong>旅行助手智能体</strong>整合所有结果，生成完整的旅行方案给用户。</li>
</ol>
<p>在此过程中，每个智能体只需关注自己的专长领域，无需了解其他智能体的内部实现，真正实现了<strong>关注点分离</strong>和<strong>专业分工</strong>。</p>
<h2 data-id="heading-15">6 A2A协议的未來发展</h2>
<h3 data-id="heading-16">6.1 短期发展路线图</h3>
<p>A2A协议目前正处于快速发展阶段。根据官方路线图，近期（0.3版本）重点包括：</p>
<ul>
<li><strong>标准化路径更新</strong>：将Agent Card的托管路径从<code>/.well-known/agent.json</code>更新为<code>/.well-known/agent-card.json</code>。</li>
<li><strong>多语言SDK优化</strong>：提升各语言SDK的稳定性和一致性。</li>
<li><strong>治理架构升级</strong>：基于Linux基金会建立社区主导的开发治理结构。</li>
</ul>
<p>特别值得注意的是，A2A协议已<strong>正式捐赠给Linux基金会</strong>，这将极大促进其成为中立、开放的行业标准。未来3-6个月内，项目将建立标准化贡献流程，成立专门工作组，并建立透明的决策机制。</p>
<h3 data-id="heading-17">6.2 中长期发展方向</h3>
<p>展望未来，A2A协议的发展将围绕以下几个关键方向：</p>
<ul>
<li><strong>智能体注册表建设</strong>：建立统一的智能体发现机制，支持基于能力的智能体搜索和筛选。</li>
<li><strong>安全增强功能</strong>：引入签名Agent Card支持，强化身份认证与传输安全。</li>
<li><strong>企业级功能演进</strong>：完善对长运行操作、流式传输和推送通知等企业级需求的支持。</li>
<li><strong>验证工具生态</strong>：发展A2A Inspector等合规性检查工具，确保跨平台兼容性。</li>
</ul>
<p>随着更多智能体采用A2A标准，我们有望看到真正开放的智能体生态系统形成，让AI协作变得更加简单和强大。这种互操作性不仅降低开发成本，更将催生全新的智能体应用模式和市场机会。</p>
<h2 data-id="heading-18">7 总结</h2>
<p>A2A协议作为智能体通信领域的重要创新，通过标准化智能体间的交互方式，为<strong>打破AI孤岛</strong>提供了切实可行的解决方案。其基于现有Web标准的设计降低了实施门槛，而企业级的安全和治理特性则确保了其在真实环境中的可行性。</p>
<p>随着AI技术的普及和深入，单一智能体难以应对复杂多变的现实需求将成为常态。A2A协议推动的<strong>多智能体协作模式</strong>，正是未来AI应用架构的重要演进方向。无论是与MCP协议的互补结合，还是其本身的持续演进，A2A都将在构建开放、互联的智能体生态系统中发挥关键作用。</p>
<p>对于开发者和企业而言，理解并采纳A2A协议意味着提前布局下一代AI应用架构，在即将到来的智能体协作浪潮中占据先机。随着协议的不断成熟和生态的壮大，A2A有望成为AI世界的“TCP/IP协议”，为分布式人工智能奠定坚实基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain Chain & Pipe 知识点详解]]></title>    <link>https://juejin.cn/post/7578853751531405327</link>    <guid>https://juejin.cn/post/7578853751531405327</guid>    <pubDate>2025-12-02T09:19:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578853751531405327" data-draft-id="7578892205291159592" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain Chain &amp; Pipe 知识点详解"/> <meta itemprop="keywords" content="LangChain,Node.js,AI编程"/> <meta itemprop="datePublished" content="2025-12-02T09:19:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Dr_哈哈"/> <meta itemprop="url" content="https://juejin.cn/user/2208293602984286"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain Chain &amp; Pipe 知识点详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2208293602984286/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Dr_哈哈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T09:19:21.000Z" title="Tue Dec 02 2025 09:19:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>🎯 本文将带你深入理解 LangChain 中的 Chain 和 Pipe 机制，通过实际代码示例掌握串行、并行、流式输出等核心技能。</p>
</blockquote>
<h2 data-id="heading-0">📚 核心概念</h2>
<h3 data-id="heading-1">什么是 Runnable？</h3>
<p><code>Runnable</code> 是 LangChain 中的核心接口，所有可执行的组件都实现了这个接口：</p>
<ul>
<li><strong>Prompt Template</strong> - 提示词模板</li>
<li><strong>LLM / ChatModel</strong> - 语言模型</li>
<li><strong>Output Parser</strong> - 输出解析器</li>
<li><strong>Chain</strong> - 链（本身也是 Runnable）</li>
</ul>
<p>每个 Runnable 都支持以下方法：</p>

























<table><thead><tr><th>方法</th><th>说明</th><th>使用场景</th></tr></thead><tbody><tr><td><code>invoke()</code></td><td>同步执行</td><td>普通调用</td></tr><tr><td><code>stream()</code></td><td>流式执行</td><td>实时输出</td></tr><tr><td><code>batch()</code></td><td>批量执行</td><td>处理多个输入</td></tr></tbody></table>
<h3 data-id="heading-2">什么是 Pipe？</h3>
<p><code>pipe()</code> 是连接多个 Runnable 的方法，将前一个组件的输出作为后一个组件的输入：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 基本用法</span>
<span class="hljs-keyword">const</span> chain = prompt.<span class="hljs-title function_">pipe</span>(llm).<span class="hljs-title function_">pipe</span>(outputParser);

<span class="hljs-comment">// 等价于</span>
<span class="hljs-comment">// input → prompt → llm → outputParser → output</span>
</code></pre>
<h3 data-id="heading-3">Pipe 可接收的参数类型</h3>
<p><code>pipe()</code> 方法可以接收任何 <strong>Runnable</strong> 类型的对象，包括：</p>








































<table><thead><tr><th>类型</th><th>说明</th><th>常见示例</th></tr></thead><tbody><tr><td><strong>Prompt Templates</strong></td><td>提示词模板</td><td><code>ChatPromptTemplate</code>, <code>PromptTemplate</code></td></tr><tr><td><strong>LLMs / ChatModels</strong></td><td>语言模型</td><td><code>ChatDeepSeek</code>, <code>ChatOpenAI</code>, <code>ChatAnthropic</code></td></tr><tr><td><strong>Output Parsers</strong></td><td>输出解析器</td><td><code>StringOutputParser</code>, <code>JsonOutputParser</code>, <code>StructuredOutputParser</code></td></tr><tr><td><strong>Runnable 组合器</strong></td><td>组合多个 Runnable</td><td><code>RunnableSequence</code>, <code>RunnableParallel</code>, <code>RunnablePassthrough</code>, <code>RunnableLambda</code></td></tr><tr><td><strong>函数 (Function)</strong></td><td>自动包装为 RunnableLambda</td><td>普通函数、箭头函数、async 函数</td></tr><tr><td><strong>其他 Runnable</strong></td><td>任何实现 Runnable 接口的对象</td><td>Tools, Retrievers, 自定义 Runnable</td></tr></tbody></table>
<h4 data-id="heading-4">示例：不同类型参数的使用</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">RunnableLambda</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/runnables"</span>;

<span class="hljs-comment">// 1. 最常见：Prompt → LLM → OutputParser</span>
<span class="hljs-keyword">const</span> basicChain = prompt.<span class="hljs-title function_">pipe</span>(llm).<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>());

<span class="hljs-comment">// 2. 使用函数（自动包装为 RunnableLambda）</span>
<span class="hljs-keyword">const</span> chainWithFunction = prompt
  .<span class="hljs-title function_">pipe</span>(llm)
  .<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>())
  .<span class="hljs-title function_">pipe</span>(<span class="hljs-function">(<span class="hljs-params">text</span>) =&gt;</span> text.<span class="hljs-title function_">toUpperCase</span>()); <span class="hljs-comment">// 普通函数</span>

<span class="hljs-comment">// 3. 使用 async 函数</span>
<span class="hljs-keyword">const</span> chainWithAsync = prompt
  .<span class="hljs-title function_">pipe</span>(llm)
  .<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>())
  .<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">async</span> (text) =&gt; {
    <span class="hljs-comment">// 可以在这里做异步操作</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">`处理后: <span class="hljs-subst">${text}</span>`</span>;
  });

<span class="hljs-comment">// 4. 使用 RunnableLambda 显式包装</span>
<span class="hljs-keyword">const</span> customRunnable = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RunnableLambda</span>({
  <span class="hljs-attr">func</span>: <span class="hljs-function">(<span class="hljs-params">input</span>) =&gt;</span> <span class="hljs-string">`[<span class="hljs-subst">${input}</span>]`</span>,
});
<span class="hljs-keyword">const</span> chainWithLambda = prompt
  .<span class="hljs-title function_">pipe</span>(llm)
  .<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>())
  .<span class="hljs-title function_">pipe</span>(customRunnable);

<span class="hljs-comment">// 5. 嵌套使用其他 Chain</span>
<span class="hljs-keyword">const</span> innerChain = prompt2.<span class="hljs-title function_">pipe</span>(llm).<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>());
<span class="hljs-keyword">const</span> outerChain = prompt1
  .<span class="hljs-title function_">pipe</span>(llm)
  .<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>())
  .<span class="hljs-title function_">pipe</span>(innerChain);

<span class="hljs-comment">// 6. 使用 RunnableParallel 进行分支</span>
<span class="hljs-keyword">const</span> branchChain = prompt
  .<span class="hljs-title function_">pipe</span>(llm)
  .<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>())
  .<span class="hljs-title function_">pipe</span>(
    <span class="hljs-title class_">RunnableParallel</span>.<span class="hljs-title function_">from</span>({
      <span class="hljs-attr">upper</span>: <span class="hljs-function">(<span class="hljs-params">text</span>) =&gt;</span> text.<span class="hljs-title function_">toUpperCase</span>(),
      <span class="hljs-attr">lower</span>: <span class="hljs-function">(<span class="hljs-params">text</span>) =&gt;</span> text.<span class="hljs-title function_">toLowerCase</span>(),
      <span class="hljs-attr">length</span>: <span class="hljs-function">(<span class="hljs-params">text</span>) =&gt;</span> text.<span class="hljs-property">length</span>,
    })
  );
</code></pre>
<h4 data-id="heading-5">类型匹配规则</h4>
<blockquote>
<p>⚠️ <strong>重要</strong>：<code>pipe()</code> 连接时，<strong>前一个 Runnable 的输出类型必须与后一个 Runnable 的输入类型兼容</strong>。</p>
</blockquote>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 正确：LLM 输出 AIMessage → StringOutputParser 接收 AIMessage</span>
prompt.<span class="hljs-title function_">pipe</span>(llm).<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>());

<span class="hljs-comment">// ✅ 正确：StringOutputParser 输出 string → 函数接收 string</span>
prompt
  .<span class="hljs-title function_">pipe</span>(llm)
  .<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>())
  .<span class="hljs-title function_">pipe</span>(<span class="hljs-function">(<span class="hljs-params">text</span>) =&gt;</span> text.<span class="hljs-title function_">trim</span>());

<span class="hljs-comment">// ❌ 错误：LLM 输出 AIMessage → 函数期望 string</span>
<span class="hljs-comment">// prompt.pipe(llm).pipe((msg) =&gt; msg.trim()); // msg 是 AIMessage 对象，不是 string</span>
</code></pre>
<hr/>
<h2 data-id="heading-6">🔧 示例详解</h2>
<h3 data-id="heading-7">示例 1：Pipe 的基本使用</h3>
<p>最基础的 Chain 组合：Prompt → LLM → OutputParser</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatDeepSeek</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/deepseek"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatPromptTemplate</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/prompts"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">StringOutputParser</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/output_parsers"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"dotenv/config"</span>;

<span class="hljs-comment">// 初始化 LLM</span>
<span class="hljs-keyword">const</span> llm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({
  <span class="hljs-attr">model</span>: <span class="hljs-string">"deepseek-chat"</span>,
  <span class="hljs-attr">temperature</span>: <span class="hljs-number">0.7</span>,
});

<span class="hljs-comment">// 创建 Prompt</span>
<span class="hljs-keyword">const</span> translatePrompt = <span class="hljs-title class_">ChatPromptTemplate</span>.<span class="hljs-title function_">fromMessages</span>([
  [
    <span class="hljs-string">"system"</span>,
    <span class="hljs-string">"你是一个专业的翻译助手，请将 {source_lang} 翻译成 {target_lang}。"</span>,
  ],
  [<span class="hljs-string">"human"</span>, <span class="hljs-string">"{text}"</span>],
]);

<span class="hljs-comment">// 使用 pipe() 组合成 Chain</span>
<span class="hljs-keyword">const</span> translateChain = translatePrompt.<span class="hljs-title function_">pipe</span>(llm).<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>());

<span class="hljs-comment">// 调用 Chain</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> translateChain.<span class="hljs-title function_">invoke</span>({
  <span class="hljs-attr">source_lang</span>: <span class="hljs-string">"English"</span>,
  <span class="hljs-attr">target_lang</span>: <span class="hljs-string">"中文"</span>,
  <span class="hljs-attr">text</span>: <span class="hljs-string">"Hello, LangChain!"</span>,
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result); <span class="hljs-comment">// 你好，LangChain！</span>
</code></pre>
<p><strong>要点解析：</strong></p>
<ul>
<li><code>ChatPromptTemplate.fromMessages()</code> 创建聊天提示词模板</li>
<li><code>pipe()</code> 将组件串联起来</li>
<li><code>StringOutputParser</code> 将 AI 返回的消息对象转换为纯字符串</li>
<li><code>invoke()</code> 传入模板变量，执行整个链</li>
</ul>
<hr/>
<h3 data-id="heading-8">示例 2：Stream 流式输出</h3>
<p>流式输出可以实时显示 AI 生成的内容，提升用户体验：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> storyPrompt = <span class="hljs-title class_">ChatPromptTemplate</span>.<span class="hljs-title function_">fromMessages</span>([
  [<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是一个创意写作助手"</span>],
  [<span class="hljs-string">"human"</span>, <span class="hljs-string">"请写一个关于 {topic} 的小故事"</span>],
]);

<span class="hljs-keyword">const</span> storyChain = storyPrompt.<span class="hljs-title function_">pipe</span>(llm).<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>());

<span class="hljs-comment">// 使用 stream() 获取流式输出</span>
<span class="hljs-keyword">const</span> stream = <span class="hljs-keyword">await</span> storyChain.<span class="hljs-title function_">stream</span>({
  <span class="hljs-attr">topic</span>: <span class="hljs-string">"程序员与 AI"</span>,
});

<span class="hljs-comment">// 实时打印每个 chunk</span>
<span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> chunk <span class="hljs-keyword">of</span> stream) {
  process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(chunk);
}
</code></pre>
<p><strong>流式输出的优势：</strong></p>
<ul>
<li>✅ 用户无需等待完整响应</li>
<li>✅ 实时看到生成过程</li>
<li>✅ 适合生成长文本</li>
<li>✅ 改善交互体验</li>
</ul>
<hr/>
<h3 data-id="heading-9">示例 3：串行任务 (RunnableSequence)</h3>
<p>当任务有依赖关系时，使用串行执行：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">RunnableSequence</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/runnables"</span>;

<span class="hljs-comment">// 步骤 1: 生成标题</span>
<span class="hljs-keyword">const</span> titleChain = titlePrompt.<span class="hljs-title function_">pipe</span>(llm).<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>());

<span class="hljs-comment">// 步骤 2: 根据标题生成内容</span>
<span class="hljs-keyword">const</span> contentChain = contentPrompt.<span class="hljs-title function_">pipe</span>(llm).<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>());

<span class="hljs-comment">// 串行组合</span>
<span class="hljs-keyword">const</span> sequentialChain = <span class="hljs-title class_">RunnableSequence</span>.<span class="hljs-title function_">from</span>([
  <span class="hljs-comment">// 第一步：生成标题</span>
  {
    <span class="hljs-attr">title</span>: titleChain,
    <span class="hljs-attr">topic</span>: <span class="hljs-function">(<span class="hljs-params">input</span>) =&gt;</span> input.<span class="hljs-property">topic</span>,
  },
  <span class="hljs-comment">// 第二步：生成内容（依赖标题）</span>
  {
    <span class="hljs-attr">title</span>: <span class="hljs-function">(<span class="hljs-params">input</span>) =&gt;</span> input.<span class="hljs-property">title</span>,
    <span class="hljs-attr">content</span>: <span class="hljs-title class_">RunnableSequence</span>.<span class="hljs-title function_">from</span>([
      <span class="hljs-function">(<span class="hljs-params">input</span>) =&gt;</span> ({ <span class="hljs-attr">title</span>: input.<span class="hljs-property">title</span> }),
      contentChain,
    ]),
  },
]);

<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> sequentialChain.<span class="hljs-title function_">invoke</span>({ <span class="hljs-attr">topic</span>: <span class="hljs-string">"AI 学习"</span> });
<span class="hljs-comment">// result = { title: "...", content: "..." }</span>
</code></pre>
<p><strong>串行任务特点：</strong></p>
<ul>
<li>📌 任务按顺序执行</li>
<li>📌 后续任务可以使用前置任务的结果</li>
<li>📌 适合有依赖关系的多步骤流程</li>
</ul>
<hr/>
<h3 data-id="heading-10">示例 4：并行任务 (RunnableParallel)</h3>
<p>当多个任务互不依赖时，使用并行执行提升效率：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">RunnableParallel</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/runnables"</span>;

<span class="hljs-comment">// 定义三个独立的分析任务</span>
<span class="hljs-keyword">const</span> sentimentChain = sentimentPrompt.<span class="hljs-title function_">pipe</span>(llm).<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>());
<span class="hljs-keyword">const</span> keywordsChain = keywordsPrompt.<span class="hljs-title function_">pipe</span>(llm).<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>());
<span class="hljs-keyword">const</span> languageChain = languagePrompt.<span class="hljs-title function_">pipe</span>(llm).<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>());

<span class="hljs-comment">// 并行组合</span>
<span class="hljs-keyword">const</span> parallelChain = <span class="hljs-title class_">RunnableParallel</span>.<span class="hljs-title function_">from</span>({
  <span class="hljs-attr">sentiment</span>: sentimentChain,
  <span class="hljs-attr">keywords</span>: keywordsChain,
  <span class="hljs-attr">language</span>: languageChain,
});

<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> parallelChain.<span class="hljs-title function_">invoke</span>({ <span class="hljs-attr">text</span>: <span class="hljs-string">"待分析的文本"</span> });
<span class="hljs-comment">// result = { sentiment: "积极", keywords: "...", language: "中文" }</span>
</code></pre>
<p><strong>并行任务优势：</strong></p>
<ul>
<li>⚡ 显著减少总执行时间</li>
<li>⚡ 充分利用 API 并发能力</li>
<li>⚡ 适合多维度分析场景</li>
</ul>
<hr/>
<h3 data-id="heading-11">示例 5：RunnablePassthrough 数据透传</h3>
<p>在复杂链中保留原始输入：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">RunnablePassthrough</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/runnables"</span>;

<span class="hljs-keyword">const</span> translateWithOriginal = <span class="hljs-title class_">RunnableParallel</span>.<span class="hljs-title function_">from</span>({
  <span class="hljs-attr">original</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">RunnablePassthrough</span>(), <span class="hljs-comment">// 原样传递</span>
  <span class="hljs-attr">translated</span>: translateChain,
});

<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> translateWithOriginal.<span class="hljs-title function_">invoke</span>({ <span class="hljs-attr">text</span>: <span class="hljs-string">"Hello"</span> });
<span class="hljs-comment">// result = { original: { text: "Hello" }, translated: "你好" }</span>
</code></pre>
<hr/>
<h3 data-id="heading-12">示例 6：串行 + 并行混合</h3>
<p>实际项目中常需要组合使用：</p>
<pre><code class="hljs language-scss" lang="scss">输入 → 预处理(串行) → 多维分析(并行) → 汇总报告(串行) → 输出
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> complexChain = <span class="hljs-title class_">RunnableSequence</span>.<span class="hljs-title function_">from</span>([
  <span class="hljs-comment">// 步骤 1: 预处理</span>
  {
    <span class="hljs-attr">original</span>: <span class="hljs-function">(<span class="hljs-params">input</span>) =&gt;</span> input.<span class="hljs-property">text</span>,
    <span class="hljs-attr">processed</span>: preprocessChain,
  },
  <span class="hljs-comment">// 步骤 2: 并行分析</span>
  {
    <span class="hljs-attr">original</span>: <span class="hljs-function">(<span class="hljs-params">input</span>) =&gt;</span> input.<span class="hljs-property">original</span>,
    <span class="hljs-attr">analysis</span>: <span class="hljs-title class_">RunnableParallel</span>.<span class="hljs-title function_">from</span>({
      <span class="hljs-attr">sentiment</span>: sentimentChain,
      <span class="hljs-attr">keywords</span>: keywordsChain,
    }),
  },
  <span class="hljs-comment">// 步骤 3: 汇总</span>
  summaryChain,
]);
</code></pre>
<hr/>
<h2 data-id="heading-13">📊 核心对象速查表</h2>








































<table><thead><tr><th>对象</th><th>作用</th><th>常用方法</th></tr></thead><tbody><tr><td><code>ChatPromptTemplate</code></td><td>创建聊天提示词模板</td><td><code>fromMessages()</code></td></tr><tr><td><code>StringOutputParser</code></td><td>将输出转为字符串</td><td>直接 <code>pipe()</code></td></tr><tr><td><code>JsonOutputParser</code></td><td>将输出解析为 JSON</td><td>直接 <code>pipe()</code></td></tr><tr><td><code>RunnableSequence</code></td><td>串行执行</td><td><code>from([...])</code></td></tr><tr><td><code>RunnableParallel</code></td><td>并行执行</td><td><code>from({...})</code></td></tr><tr><td><code>RunnablePassthrough</code></td><td>数据透传</td><td><code>new RunnablePassthrough()</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-14">🎨 流程图解</h2>
<h3 data-id="heading-15">基础 Pipe 流程</h3>
<pre><code class="hljs language-css" lang="css">┌─────────┐    ┌─────────┐    ┌──────────────┐    ┌─────────┐
│  <span class="hljs-selector-tag">Input</span>  │ → │ Prompt  │ → │     LLM      │ → │ Parser  │ → Output
└─────────┘    └─────────┘    └──────────────┘    └─────────┘
</code></pre>
<h3 data-id="heading-16">串行任务流程</h3>
<pre><code class="hljs language-vbnet" lang="vbnet">┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│  Input  │ → │ <span class="hljs-keyword">Step</span> <span class="hljs-number">1</span>  │ → │ <span class="hljs-keyword">Step</span> <span class="hljs-number">2</span>  │ → │ <span class="hljs-keyword">Step</span> <span class="hljs-number">3</span>  │ → Output
└─────────┘    └─────────┘    └─────────┘    └─────────┘
</code></pre>
<h3 data-id="heading-17">并行任务流程</h3>
<pre><code class="hljs language-arduino" lang="arduino">                 ┌─────────┐
              ┌→ │ <span class="hljs-built_in">Task</span> A  │ ─┐
┌─────────┐   │  └─────────┘  │   ┌──────────────┐
│  Input  │ ──┼→ ┌─────────┐  ├→ │ Merge Result │ → Output
└─────────┘   │  │ <span class="hljs-built_in">Task</span> B  │  │   └──────────────┘
              │  └─────────┘  │
              └→ ┌─────────┐ ─┘
                 │ <span class="hljs-built_in">Task</span> C  │
                 └─────────┘
</code></pre>
<hr/>
<h2 data-id="heading-18">💡 最佳实践</h2>
<h3 data-id="heading-19">1. 合理选择执行方式</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误：无依赖任务串行执行，浪费时间</span>
<span class="hljs-keyword">const</span> result1 = <span class="hljs-keyword">await</span> chain1.<span class="hljs-title function_">invoke</span>(input);
<span class="hljs-keyword">const</span> result2 = <span class="hljs-keyword">await</span> chain2.<span class="hljs-title function_">invoke</span>(input);
<span class="hljs-keyword">const</span> result3 = <span class="hljs-keyword">await</span> chain3.<span class="hljs-title function_">invoke</span>(input);

<span class="hljs-comment">// ✅ 正确：无依赖任务并行执行</span>
<span class="hljs-keyword">const</span> results = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RunnableParallel</span>.<span class="hljs-title function_">from</span>({
  <span class="hljs-attr">r1</span>: chain1,
  <span class="hljs-attr">r2</span>: chain2,
  <span class="hljs-attr">r3</span>: chain3,
}).<span class="hljs-title function_">invoke</span>(input);
</code></pre>
<h3 data-id="heading-20">2. 使用流式输出提升体验</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 用户需要等待完整响应</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> chain.<span class="hljs-title function_">invoke</span>(input);

<span class="hljs-comment">// ✅ 实时显示生成内容</span>
<span class="hljs-keyword">const</span> stream = <span class="hljs-keyword">await</span> chain.<span class="hljs-title function_">stream</span>(input);
<span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> chunk <span class="hljs-keyword">of</span> stream) {
  process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(chunk);
}
</code></pre>
<h3 data-id="heading-21">3. 使用 OutputParser 简化处理</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 手动提取内容</span>
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llm.<span class="hljs-title function_">invoke</span>(prompt);
<span class="hljs-keyword">const</span> text = response.<span class="hljs-property">content</span>;

<span class="hljs-comment">// ✅ 使用 Parser 自动处理</span>
<span class="hljs-keyword">const</span> chain = prompt.<span class="hljs-title function_">pipe</span>(llm).<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>());
<span class="hljs-keyword">const</span> text = <span class="hljs-keyword">await</span> chain.<span class="hljs-title function_">invoke</span>(input);
</code></pre>
<hr/>
<h2 data-id="heading-22">🔗 相关资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fjs.langchain.com%2F" target="_blank" title="https://js.langchain.com/" ref="nofollow noopener noreferrer">LangChain JS 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.deepseek.com%2F" target="_blank" title="https://platform.deepseek.com/" ref="nofollow noopener noreferrer">DeepSeek 开放平台</a></li>
<li><a href="https://www.trae.ai/" target="_blank" title="https://www.trae.ai/" ref="nofollow noopener noreferrer">Trae_solo 官网</a></li>
<li><a href="#" title="#">本项目 GitHub 地址</a></li>
</ul>
<hr/>
<h2 data-id="heading-23">📝 练习建议</h2>
<ol>
<li><strong>基础练习</strong>：修改翻译 Chain，支持多种语言互译</li>
<li><strong>进阶练习</strong>：创建一个并行分析 Chain，同时分析文本的情感、主题、风格</li>
<li><strong>综合练习</strong>：实现一个"文章改写助手"，包含：分析原文 → 并行生成多个改写版本 → 评选最佳版本</li>
</ol>
<hr/>
<h2 data-id="heading-24">🎯 总结</h2>





























<table><thead><tr><th>知识点</th><th>核心要点</th></tr></thead><tbody><tr><td><strong>pipe()</strong></td><td>连接 Runnable 组件，构建处理管道</td></tr><tr><td><strong>stream()</strong></td><td>流式输出，提升用户体验</td></tr><tr><td><strong>RunnableSequence</strong></td><td>串行执行，处理有依赖的任务</td></tr><tr><td><strong>RunnableParallel</strong></td><td>并行执行，提升处理效率</td></tr><tr><td><strong>RunnablePassthrough</strong></td><td>数据透传，保留原始输入</td></tr></tbody></table>
<p>掌握这些核心概念后，你就可以灵活组合构建复杂的 AI 应用流程了！</p>
<hr/>
<blockquote>
<p>📖 <strong>本文配套代码</strong>：<code>langchain-learning/src/chain.js</code></p>
<p>💻 <strong>推荐工具</strong>：使用 <a href="https://www.trae.ai/" target="_blank" title="https://www.trae.ai/" ref="nofollow noopener noreferrer">Trae_solo</a> 获得更好的 AI 开发体验</p>
<p>✨ <strong>Happy Coding!</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TRAE SOLO 赋能大模型工程化实践：从模型选型到安全部署的一站式实战指南]]></title>    <link>https://juejin.cn/post/7578968420042440767</link>    <guid>https://juejin.cn/post/7578968420042440767</guid>    <pubDate>2025-12-02T08:35:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578968420042440767" data-draft-id="7578818741699788806" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TRAE SOLO 赋能大模型工程化实践：从模型选型到安全部署的一站式实战指南"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2025-12-02T08:35:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="七条猫"/> <meta itemprop="url" content="https://juejin.cn/user/564503296630944"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TRAE SOLO 赋能大模型工程化实践：从模型选型到安全部署的一站式实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/564503296630944/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    七条猫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T08:35:37.000Z" title="Tue Dec 02 2025 08:35:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在大模型（Large Language Model, LLM）工程化浪潮席卷开发社区的今天，如何高效、安全、可靠地完成模型集成、微调与部署，已成为开发者面临的核心挑战。TRAE SOLO 正式版的上线，恰如一场及时雨——它不仅提供了强大的 Vibe Coding 能力，更构建了一套面向大模型全生命周期的工程化支持体系。本文将结合笔者在实际项目中的深度使用经验，分享 TRAE SOLO 在大模型工程化关键环节中的实战应用，涵盖模型选型、一键部署、代码兼容性修复及 API 安全配置四大核心场景。</p>
<hr/>
<h3 data-id="heading-0">一、智能模型选型：基于 TRAE SOLO 快速匹配业务需求</h3>
<p>面对 Hugging Face 上数以万计的开源模型，开发者常陷入“选择困难症”。TRAE SOLO 的上下文感知能力可自动推荐适配方案。例如，在金融问答场景中，我输入自然语言指令：</p>
<blockquote>
<p>“加载一个支持中文、上下文长度 ≥8192、可在 16GB GPU 上运行的聊天模型。”</p>
</blockquote>
<p>TRAE SOLO 自动生成如下加载代码（基于 Qwen1.5-7B-Chat-GGUF）：</p>
<hr/>
<pre><code class="hljs language-ini" lang="ini">from transformers import AutoModelForCausalLM, AutoTokenizer
import torch

<span class="hljs-attr">model_name</span> = <span class="hljs-string">"Qwen/Qwen1.5-7B-Chat-GGUF"</span>
<span class="hljs-attr">tokenizer</span> = AutoTokenizer.from_pretrained(model_name, trust_remote_code=<span class="hljs-literal">True</span>)
<span class="hljs-attr">model</span> = AutoModelForCausalLM.from_pretrained(
    model_name,
    <span class="hljs-attr">device_map</span>=<span class="hljs-string">"auto"</span>,
    <span class="hljs-attr">torch_dtype</span>=torch.float16,
    <span class="hljs-attr">revision</span>=<span class="hljs-string">"q4_k_m"</span>  <span class="hljs-comment"># 自动推荐量化版本</span>
)
</code></pre>
<p>更关键的是，TRAE SOLO 在侧边栏同步展示了该模型在本地 A10G 上的实测指标：</p>
<ul>
<li>显存占用：12.3 GB</li>
<li>首 token 延迟：320ms</li>
<li>吞吐量：18 tokens/s</li>
</ul>
<p>这让我在 5 分钟内完成模型验证，避免了反复试错的成本。</p>
<hr/>
<h3 data-id="heading-1">二、一键部署：内置服务模块让模型秒变 API</h3>
<p>传统部署需手动编写服务框架，而 TRAE SOLO 的 Deploy Module 可自动生成生产级服务。以下是由 TRAE SOLO 生成的 FastAPI 服务示例（经 DiffView 微调后）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># app.py - 由 TRAE SOLO 自动生成并优化</span>
<span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel
<span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> pipeline

app = FastAPI(title=<span class="hljs-string">"Qwen Chat API"</span>, version=<span class="hljs-string">"1.0"</span>)

<span class="hljs-comment"># 模型懒加载（避免启动阻塞）</span>
_chat_pipeline = <span class="hljs-literal">None</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_pipeline</span>():
    <span class="hljs-keyword">global</span> _chat_pipeline
    <span class="hljs-keyword">if</span> _chat_pipeline <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
        _chat_pipeline = pipeline(
            <span class="hljs-string">"conversational"</span>,
            model=<span class="hljs-string">"Qwen/Qwen1.5-7B-Chat-GGUF"</span>,
            tokenizer=<span class="hljs-string">"Qwen/Qwen1.5-7B-Chat"</span>,
            device_map=<span class="hljs-string">"auto"</span>
        )
    <span class="hljs-keyword">return</span> _chat_pipeline

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatRequest</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    messages: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">dict</span>]  <span class="hljs-comment"># e.g., [{"role": "user", "content": "你好"}]</span>

<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/v1/chat/completions"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">chat</span>(<span class="hljs-params">req: ChatRequest</span>):
    pipe = get_pipeline()
    response = pipe(req.messages)
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"reply"</span>: response[-<span class="hljs-number">1</span>][<span class="hljs-string">"content"</span>]}

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/health"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">health</span>():
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"status"</span>: <span class="hljs-string">"ok"</span>}
</code></pre>
<p>执行 <code>trae deploy --port 8080</code> 后，TRAE SOLO 自动：</p>
<ul>
<li>构建包含上述代码与依赖的 Docker 镜像；</li>
<li>启动容器并映射端口；</li>
<li>输出 Swagger UI 地址（<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8080%2Fdocs%25EF%25BC%2589%25E3%2580%2582" target="_blank" title="http://localhost:8080/docs%EF%BC%89%E3%80%82" ref="nofollow noopener noreferrer">http://localhost:8080/docs）。</a></li>
</ul>
<p>整个过程无需手写 Dockerfile 或处理 CUDA 环境，真正实现“一键上线”。</p>
<hr/>
<h3 data-id="heading-2">三、DiffView 工具：高效修复大模型生成代码的兼容性问题</h3>
<p>在集成 LangChain 时，TRAE SOLO 初始生成的 RAG 代码使用了已弃用的 <code>VectorStoreRetriever</code>。DiffView 工具高亮对比并建议更新：</p>
<p><strong>Before（TRAE 初稿）</strong> ：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">retriever</span> = VectorstoreRetriever(vectorstore=vector_db, search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">4</span>})
</code></pre>
<p><strong>After（DiffView 建议）</strong> ：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">retriever</span> = vector_db.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">4</span>})
</code></pre>
<p>点击“Apply”后，TRAE SOLO 不仅替换代码，还自动添加类型注解和错误处理：</p>
<p>代码语言：python</p>
<hr/>
<p>AI代码解释</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">try</span>:
    retriever = vector_db.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">4</span>})
<span class="hljs-keyword">except</span> AttributeError <span class="hljs-keyword">as</span> e:
    logger.error(<span class="hljs-string">f"Vector store not initialized: <span class="hljs-subst">{e}</span>"</span>)
    <span class="hljs-keyword">raise</span>
</code></pre>
<p>这种语义级修复能力，极大提升了生成代码在复杂工程中的可用性。</p>
<hr/>
<h3 data-id="heading-3">四、API 密钥安全踩坑：从硬编码到 Vault 集成</h3>
<p>早期我曾将 OpenAI 密钥硬编码，导致 GitHub 泄露。TRAE SOLO 的 Security Guard 拦截后，推荐使用环境变量 + Secret Manager 双重防护，并生成如下安全加载逻辑：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># secure_config.py</span>
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv

load_dotenv()  <span class="hljs-comment"># 加载 .env 文件</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_openai_key</span>() -&gt; <span class="hljs-built_in">str</span>:
    key = os.getenv(<span class="hljs-string">"OPENAI_API_KEY"</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> key:
        <span class="hljs-comment"># 尝试从 AWS Secrets Manager 获取（生产环境）</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">import</span> boto3
            client = boto3.client(<span class="hljs-string">'secretsmanager'</span>, region_name=<span class="hljs-string">'us-west-2'</span>)
            secret = client.get_secret_value(SecretId=<span class="hljs-string">'prod/openai-key'</span>)
            <span class="hljs-keyword">return</span> secret[<span class="hljs-string">'SecretString'</span>]
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">"OpenAI API key not found in env or secrets manager"</span>) <span class="hljs-keyword">from</span> e
    <span class="hljs-keyword">return</span> key
</code></pre>
<p>同时，TRAE SOLO 在 <code>.gitignore</code> 中自动添加 <code>.env</code>，并在 pre-commit hook 中集成 <code>gitleaks</code> 扫描，形成纵深防御。</p>
<hr/>
<h3 data-id="heading-4">结语：TRAE SOLO，不止是编码助手，更是大模型工程化的加速器</h3>
<p>从智能选型到安全部署，TRAE SOLO 以代码为载体，将大模型工程的最佳实践“编织”进开发流程。它不是替代开发者思考，而是把我们从重复劳动中解放，聚焦于更高价值的创新。</p>
<p>正如我在项目复盘会上所说：“以前我们花 70% 时间在搭架子，现在 TRAE SOLO 让我们把 70% 时间留给思考。” 如果你也在大模型工程化的路上摸爬滚打，不妨试试 TRAE SOLO —— 它或许就是你缺失的那一块拼图。</p>
<p><strong>用代码说话，用干货圈粉。TRAE SOLO，让大模型真正“跑”起来。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端跨页面通讯终极指南③：LocalStorage 用法全解析]]></title>    <link>https://juejin.cn/post/7578877638988759040</link>    <guid>https://juejin.cn/post/7578877638988759040</guid>    <pubDate>2025-12-02T09:06:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578877638988759040" data-draft-id="7576482238461198378" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端跨页面通讯终极指南③：LocalStorage 用法全解析"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-02T09:06:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一诺滚雪球"/> <meta itemprop="url" content="https://juejin.cn/user/2824015112318094"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端跨页面通讯终极指南③：LocalStorage 用法全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2824015112318094/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一诺滚雪球
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T09:06:16.000Z" title="Tue Dec 02 2025 09:06:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>上一篇介绍了<strong>BroadcastChannel</strong>跨页面通讯的方式。今天介绍一种我们非常熟悉的方式<strong>LocalStorage</strong> 。凭浏览器原生接口就能实现数据共享，用法简洁高效。需要注意，仅支持<strong>同源页面</strong>。</p>
<p>下面我们介绍下LocalStorage 的跨页通讯的用法。</p>
<h2 data-id="heading-1">1. LocalStorage为什么能跨页通讯？</h2>
<p>我们都知道LocalStorage——它是浏览器提供的<strong>同源本地存储方案</strong>，数据存储在客户端，生命周期为永久（除非手动删除或清除浏览器缓存）。</p>
<p>它能实现跨页通讯的关键，在于两个核心机制：</p>
<h3 data-id="heading-2">1.1 同源数据共享机制</h3>
<p>LocalStorage 的数据严格遵循“同源策略”，即同一协议（http/https）、同一域名、同一端口下的所有页面，都能读取和修改同一个 LocalStorage 实例中的数据。</p>
<h3 data-id="heading-3">1.2 storage 事件触发机制</h3>
<p>LocalStorage 实现“通讯”而非单纯“数据存储”的核心。当一个页面修改了 LocalStorage 中的数据时，浏览器会自动向同源下的所有其他页面触发一个 <code>storage</code> 事件，该事件会携带修改前、修改后的数据及键名等信息。其他页面通过监听这个事件，就能实时感知数据变化，从而完成跨页通讯。</p>
<p>注意：当前页面修改 LocalStorage 时，自身不会触发 storage 事件，只有同源的其他页面才会收到通知！</p>
<h3 data-id="heading-4">1.3 LocalStorage通讯流程</h3>
<p>LocalStorage 跨页通讯的核心流程是：</p>
<ol>
<li>页面A修改 LocalStorage 数据 → 浏览器向同源其他页面发送 storage 事件</li>
<li>页面B/C/D 监听事件并获取数据变化。</li>
</ol>
<h2 data-id="heading-5">2. 实践案例</h2>
<p>通过上面的说明，作为数据发送方，通过修改 LocalStorage 存储数据；作为接收方，监听 storage 事件获取父页面传递的信息。我们实践一下：</p>
<h3 data-id="heading-6">2.1 步骤1：数据发送</h3>
<p>通过 <code>localStorage.setItem()</code> 存储数据，触发 storage 事件。为避免数据覆盖，建议给键名添加场景标识（如 <code>parent-to-iframe-msg</code>）。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 发送数据</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">sendToIframe</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-comment">// 1. 存储数据到 LocalStorage，键名需唯一标识通讯场景</span>
  <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'parent-to-iframe-msg'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
    <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(), <span class="hljs-comment">// 防止数据缓存导致事件不触发</span>
    <span class="hljs-attr">content</span>: data
  }));
  
  <span class="hljs-comment">// 2. 可选：若需重复发送相同数据，可先删除再添加（storage 事件仅在值变化时触发）</span>
  <span class="hljs-comment">// localStorage.removeItem('parent-to-iframe-msg');</span>
}

<span class="hljs-comment">// 调用方法发送数据（示例：传递用户信息）</span>
<span class="hljs-title function_">sendToIframe</span>({
  <span class="hljs-attr">username</span>: <span class="hljs-string">'前端小助手'</span>,
  <span class="hljs-attr">role</span>: <span class="hljs-string">'admin'</span>
});
</code></pre>
<h3 data-id="heading-7">2.2 步骤2：数据接收</h3>
<p>接收方页面通过监听 <code>window.addEventListener('storage', callback)</code> 捕获数据变化，解析后获取页面传递的内容。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 监听父页面发送的数据</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'storage'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-comment">// 1. 仅处理目标键名的数据变化，避免无关事件干扰</span>
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">key</span> !== <span class="hljs-string">'parent-to-iframe-msg'</span>) <span class="hljs-keyword">return</span>;
  
  <span class="hljs-comment">// 2. 解析数据（注意：初始状态下 e.newValue 可能为 null）</span>
  <span class="hljs-keyword">if</span> (!e.<span class="hljs-property">newValue</span>) <span class="hljs-keyword">return</span>;
  
  <span class="hljs-keyword">const</span> { timestamp, content } = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(e.<span class="hljs-property">newValue</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'iframe 收到父页面数据：'</span>, content);
  
  <span class="hljs-comment">// 3. 业务处理：如渲染用户信息</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'user-info'</span>).<span class="hljs-property">innerText</span> = <span class="hljs-string">`用户名：<span class="hljs-subst">${content.username}</span>，角色：<span class="hljs-subst">${content.role}</span>`</span>;
});

<span class="hljs-comment">// 可选：页面销毁时移除监听，避免内存泄漏</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'storage'</span>, handleStorage);
});
</code></pre>
<p>接收数据如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0160e05f2e2e45498b719ee165aaf211~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA6K-65rua6Zuq55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765271175&amp;x-signature=fTBp2QqtDH91VOC72BJXO0MycmU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-8">3. LocalStorage通讯注意事项</h2>
<p>LocalStorage 用法简单，但在跨页通讯中若忽略细节，很容易出现“数据发了但收不到”的问题。以下这些坑必须提前规避：</p>
<h3 data-id="heading-9">3.1 同源策略限制：跨域页面无法通讯</h3>
<p>LocalStorage 严格遵循同源策略，不同域名、协议或端口的页面无法共享数据，也无法触发 storage 事件。若需跨域通讯，需结合 postMessage 或服务器中转，LocalStorage 无法单独实现。</p>
<h3 data-id="heading-10">3.2 数据格式限制：仅支持字符串类型</h3>
<p>LocalStorage 只能存储字符串，若要传递对象、数组等复杂数据，必须用 <code>JSON.stringify()</code> 序列化，接收时用 <code>JSON.parse()</code> 反序列化。注意：undefined、function 等类型无法被正常序列化，需提前处理。</p>
<h3 data-id="heading-11">3.3 storage 事件触发条件：仅值变化时触发</h3>
<p>只有当 LocalStorage 中数据的“值”发生变化时，才会触发 storage 事件。若两次存储相同的值，事件不会触发。解决办法：在数据中添加 timestamp 时间戳或随机数，确保每次存储的值不同。</p>
<h3 data-id="heading-12">3.4 存储容量限制：避免数据过大</h3>
<p>LocalStorage 单个域名的存储容量约为 5MB，若存储数据过大，会导致存储失败。跨页通讯应仅传递必要的核心数据（如 ID、状态），避免传递大量文本或二进制数据。</p>
<h2 data-id="heading-13">4. 总结</h2>
<p>最后总结一下：LocalStorage只需要操作 <code>setItem</code>、<code>getItem</code> 和 监听 <strong>storage</strong> 事件就能实现同源通讯。如果是非同源，那就只能用其他方式。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[项目级效能提升一站式交付最佳实践]]></title>    <link>https://juejin.cn/post/7578876665696157705</link>    <guid>https://juejin.cn/post/7578876665696157705</guid>    <pubDate>2025-12-02T09:38:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578876665696157705" data-draft-id="7578948893761962011" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="项目级效能提升一站式交付最佳实践"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-02T09:38:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="百度Geek说"/> <meta itemprop="url" content="https://juejin.cn/user/4186596000416094"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            项目级效能提升一站式交付最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4186596000416094/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    百度Geek说
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T09:38:18.000Z" title="Tue Dec 02 2025 09:38:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">导读</h2>
<p>面对研发交付中Feature级项目复杂度攀升、信息分散及跨端协作低效等痛点，传统的Story级管理模式已显乏力。本文详细阐述了一套“项目级效能提升一站式交付最佳实践”，通过构建三大核心体系重塑研发流程：一是通过AI侧边栏与风险管控打造“AI项目管理”，实现信息聚合与决策提效；二是推动“一站式Feature交付”，利用AI自动生成测试方案与搭建环境，实现端到端闭环；三是建立涵盖“重点战役-Feature-Story”的三级数字化度量体系。这套新范式旨在以智能替代人工低效环节，助力团队从“被流程束缚”向“借智能破局”转变，实现研发效能的质的飞跃。</p>
<h2 data-id="heading-1">01 背景</h2>
<p>在研发交付场景中，Story级别效率持续向好，但端到端 Feature 级项目持续增多，复杂度呈上升趋势。在传统工作模式下，研发团队正遭遇一系列制约效能的痛点：</p>
<ul>
<li>
<p><strong>信息分散、Feature视角管控缺失</strong>：研发过程中，需求卡片、Bug列表、测试用例等信息分散于不同空间；以及历史交付流程侧重 story 侧，缺少完整需求视角交付的风险洞察，导致项目无预警延期，管理成本趋增。</p>
</li>
<li>
<p><strong>多方协作效率低下</strong>：联调测试依赖手动触发脚本，环境配置依赖人工协调；多模块联动存在用例交叉冗余、测试评审缓慢；跨产品线借调沟通成本高，各端测试人力重复投入且耦合重，拖慢研发节奏，项目进度风险激增 。</p>
</li>
<li>
<p><strong><strong>Feature 级数字化能力缺失</strong></strong>：既缺乏能够精准衡量 Feature 价值与进展的指标度量体系，也缺乏用于支撑分析、优化的标准化数据积累流程，导致 Feature 相关的评估无据可依，数据资产难以沉淀，进一步制约效能提升与问题根因定位。</p>
</li>
</ul>
<p>为有效破解以上痛点，提升产研团队整体效能，我们构建项目级交付新范式：通过 “ <strong><strong>AI 项目管理</strong></strong>” 打造一站式项目信息与工具服务获取新入口，实现过程风险AI精准管控；通过 “<strong><strong>一站式 Feature 交付</strong></strong>” 推动单端联调模式向端到端交付模式转变，同时借助 AI 测试提效驱动交付效能跃升；通过 “<strong><strong>项目级效能数字化度量</strong></strong>” 构建完善的效能评估体系。</p>
<ul>
<li>
<p><strong>AI项目管理</strong>：借助群聊侧边栏打造一站式项目信息看板，提升风险感知与决策效率；支持产研团队一键获取所需工具、服务，提升工具使用与协同效率；依托AIQA构建全流程管控能力并提效。</p>
</li>
<li>
<p><strong>一站式Feature交付</strong>：通过建设端到端交付能力，释放冗余人力，并将测试方案生成、基础环境搭建等场景与AIQA深度融合，为 Feature 全生命周期提供高效、智能的一站式支撑。</p>
</li>
<li>
<p><strong>项目级效能数字化度量</strong>：构建涵盖重点战役、Feature、Story 三个层级的更全面、立体的洞察体系，借助数据驱动的力量，全方位、深层次评估分析产品开发过程的效能表现与最终成果，为业务决策提供坚实有力数据支撑。</p>
</li>
</ul>
<p>以智能替代人工低效环节，推动团队从 “被流程束缚” 向 “借智能破局” 转变，为效能提升注入新动能，引领团队协作进入智能化新范式，让每一次交付都更高效、更可控！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d882abad826841818899413d60344318~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273098&amp;x-signature=Fod323CesQF42OOld0l8i3C5kK4%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-2">02 AI项目管理</h2>
<h3 data-id="heading-3"><strong>2.1 项目管理痛点</strong></h3>
<p>在研发交付体系中，<strong><strong>Feature级项目</strong></strong>持续<strong><strong>增多</strong></strong>，复杂度呈上升趋势，团队项目管理普遍面临四大核心痛点：</p>
<ul>
<li>
<p>信息碎片化带来高昂的把控成本</p>
</li>
<li>
<p>跨角色协作过程产生的高额隐性成本</p>
</li>
<li>
<p>分散工具链造成执行效率损耗</p>
</li>
<li>
<p>项目交付进展、风险纯依赖人工通知确认，交付周期长尾</p>
</li>
</ul>
<p>为破解上述痛点，我们构建融合 “侧边栏 + AIQA过程管控” 的 AI 项目管理体系，实现信息整合、协作提效、工具聚合与交付管控闭环。</p>
<h3 data-id="heading-4"><strong>2.2 侧边栏应用</strong></h3>
<p><strong><strong>侧边栏统一解决方案，<strong><strong>通过配置</strong></strong>侧边栏</strong></strong>框架，<strong><strong>灵活定制卡片</strong></strong>，以满足业务线各类场景应用，通常涵盖<strong><strong>项目概览</strong></strong>、<strong><strong>项目详情</strong></strong>、<strong><strong>工具集合</strong></strong>三大核心模块。</p>
<ul>
<li>
<p><strong><strong>项目概览模块</strong></strong>：以 PMO 视角为核心，深度整合项目进度、资源占用、风险预警等维度数据，支撑 PMO 实现精准的项目群管控与决策穿透 。</p>
</li>
<li>
<p><strong><strong>项目详情模块</strong></strong>：聚焦产研团队执行视角，整合项目关联卡片、各类文档、bug 记录、上线记录、实验记录及测试环境等信息，保障研发高效协同与质量可控。</p>
</li>
<li>
<p><strong><strong>工具集合模块</strong></strong>：提供了项目管理、联调提效等工具，可根据角色、产品线、项目，提供不同的工具入口，推动研发端到端衔接与操作链路简化。</p>
</li>
</ul>
<p>通过具象化的配置实践，可在实际业务场景中落地，助力各角色高效协作，破解产研团队项目管理痛点 。以下实践案例，包括：<strong><strong>项目概览</strong></strong>、<strong><strong>项目详情</strong></strong>、<strong><strong>工具集三大类内容</strong></strong>，且支持PC和手机端样式，以及群吊顶和侧边栏位置。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5a580481ab6481c9d8b6dc95a814a9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273098&amp;x-signature=nRrt%2BRXHNrtV56PKjEmEnj2dUZw%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-5"><strong>2.3 过程管控</strong></h3>
<p>在项目各环节，AIQA以PMO数字助手的角色，建设基于AIQA的项目进度/风险提醒能力，通过输入框形式进行交互，全流程管控并提效。具体能力包括：AB实验长时间停留、AB实验放量实时、技术方案&amp;打点方案等未评审风险等</p>
<ul>
<li>
<p>项目评审风险提醒：支持技术方案、UI、实验方案、打点方案等提醒</p>
</li>
<li>
<p>AB实验：待启动实验、实验中、评估中等9个阶段的停留时长；单台、放量、灰度等7个阶段的放量提醒</p>
</li>
<li>
<p>项目进度风险提醒</p>
</li>
</ul>
<h2 data-id="heading-6">03 一站式Feature交付</h2>
<h3 data-id="heading-7"><strong>3.1 端到端交付</strong></h3>
<p>产研需求常常是包括客户端、前端、服务端，两端以上联动的需求占比较高（&gt;40%），各端分别投入人力测试，测试耦合严重，人力重复投入严重，通过<strong><strong>建设交付能力</strong></strong>，支撑实现需求测试从「单端测试+多端联调」交付模式，转为「<strong><strong>端到端」交付模式，释放冗余人力</strong></strong>。</p>
<p>例如客户端&amp;服务端联动的需求，通过从功能角度评估客户端case对服务端case覆盖，覆盖的部分由客户端QA端到端测试，未覆盖部分通过夯实自动化能力补充测试或调起服务端QA补充测试，并通过准入/准出能力评估影响面和测试完备度，保证项目质量，释放冗余人力，提升整体测试吞吐。</p>
<p>各阶段支撑能力建设有：</p>
<ul>
<li>
<p><strong><strong>测试前</strong></strong>：通过<strong><strong>端到端模式识别</strong></strong>判断需求是否可以进行端到端的交付，动态<strong><strong>自动分配测试人力，<strong><strong>基于需求生成</strong></strong>端到端测试用例，<strong><strong>前端&amp;服务端的</strong></strong>环境自动搭建/更新</strong></strong>，创建相应的mock环境等</p>
</li>
<li>
<p><strong><strong>测试中</strong></strong>：<strong><strong>基于代码提交进行风险洞察，<strong><strong>以及提供</strong></strong>问题定位、mock 能力</strong></strong>供前端/客户端的同学更顺畅的完成测试过程，并且在过程中对测试流量进行录制，实时采集覆盖率，供后续测试评估；并在测试过程中阶段性评估测试进度风险，及时发现&amp;通报过程中风险；</p>
</li>
<li>
<p><strong><strong>测试准出</strong></strong>：测试完成后，自动触发服务端的<strong><strong>异常测试</strong></strong>、<strong><strong>自动生成后续用于回归的自动化case</strong></strong>，以保障服务端的迭代质量，整体完成后根据手工case完成率、bug闭环率、手工测试覆盖率、异常测试结果等多个维度综合进行测试<strong><strong>准出评估</strong></strong></p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a416fd1e7894e7fb8370135de563828~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273098&amp;x-signature=UySobLjN0DiXjR%2BK3iF6ZTr%2B%2Fjw%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-8"><strong>3.2 AI测试提效</strong></h3>
<h4 data-id="heading-9">3.2.1 测试方案自动生成</h4>
<p>我们探索测试方案自动生成，目前可以通过分析MRD/PRD/CR，结合历史业务&amp;工具知识经验，自动生成完整的测试方案，包括：</p>
<ul>
<li>
<p>对需求的基本洞察理解（背景概述、分系统/模块升级点）</p>
</li>
<li>
<p>联调测试范围（涉及系统/模块等）作为环境推荐能力的输入</p>
</li>
<li>
<p>联调测试用例及可驱动AI测试执行的相关场景参数</p>
</li>
<li>
<p>测试经验&amp;风险、历史相似项目参考</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af14e4051bf646c99f9dd9ce73f60f5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273098&amp;x-signature=1%2F5sHnor49xkvfy8ZXNT6xYpDSI%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-10">3.2.2 测试环境LUI搭建</h4>
<p>建设LUI交互端到端环境部署能力，支持产研团队各业务线及图搜联调场景调用，端到端环境部署时长保持在小时级</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6be20a4cf50b43d890bfc1e363591792~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273098&amp;x-signature=JsefkTcJIyh8hacUe7LZTKsGfy4%3D" alt="图片" loading="lazy"/></p>
<p>功能点：</p>
<ul>
<li>
<p>聚合用户的部署意图，支持多种prompt，完成LUI环境部署诉求：支持Feature卡片、QA单模块产物、单story卡片、联调CR、Fcnap域名等多种部署意图，聚合部署变更的信息</p>
</li>
<li>
<p>提供丰富的prompt向量库维护，实现精准的意图识别：prompt维护</p>
</li>
<li>
<p>基于qs-bot openmanus和mcp框架，实现丰富的工具集，通过动态规划调度工具交付各场景下的端到端测试环境：需求变更信息处理，数据聚合；触发多路复用环境部署；kirin异步轮询部署状态；qsbot回调重新触发动态规划；环境前后端链接与配置管理</p>
</li>
<li>
<p>聚合部署任务中的工具使用历史，异步回调完成环境部署完成后的智卡推送：聚合单次LUI中动态规划的工具返回信息；完成智卡数据构造并发卡推送给用户</p>
</li>
</ul>
<h2 data-id="heading-11">04 项目级效能数字化度量</h2>
<p>针对 Story 维度的度量工作，主要聚焦于对研发测试阶段展开持续且深入的洞察，旨在为从事研发测试工作的人员提供切实可行的优化方向与手段。但story维度的度量也存在如下问题：</p>
<ul>
<li>
<p>Story 粒度本身存在一定局限性，呈现研发-测试阶段的效率洞察，向左延伸的需求设计阶段，向右延伸的上线实验转全阶段，都不涵括在内，无法代表整体情况；</p>
</li>
<li>
<p>随着产品复杂程度日益提高，传统以 Story 维度为主的度量方式，无法站在产品需求视角观测交付效率，已难以满足需求；</p>
</li>
<li>
<p>站在每个组织的重点战役角度，story度量的方式，无法看到战役视角的资源投入和效率瓶颈，无法提供深层次的分析和决策。</p>
</li>
</ul>
<p>为此我们开始建设贯穿重点战役-》feature-》Story的统一三级视角的数字化方案：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7801c3d209554ae3891558bd5321211f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273098&amp;x-signature=oAsNjQNUsn5lF2gDrcSxGgzO4fc%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-12"><strong>4.1 Feature级数字化</strong></h3>
<p>围绕从最初的发布规划、设计构思、开发实施、测试验证、正式上线，直至后续的小流量到逐步推全的整个生命周期，实施全方位、系统性的评估与监测，确保 Feature 的每个阶段都能得到有效把控与持续优化。最终实现更加高效地管理和优化产品开发流程，以及进一步提升团队协作效率。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac2b06137885487f802c61f0d51c9e4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273098&amp;x-signature=l%2BKWOcE7kgwj%2BrN5QfRb1ctUvz8%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-13"><strong>4.2 战役级数字化</strong></h3>
<p>重点战役是企业为实现特定战略目标而发起的关键行动，往往需要通过一系列具体的Feature来实现其目标。</p>
<p>协同机制：重点战役的范围在季度初由PMO圈定，在业务拆解功能时在Feature上打上标记，数字化定期采集和处理分析，支持业务进行重点战役的进度监控和项目复盘。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c1b6e8517bb406c9b00010e3b3e3f14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273098&amp;x-signature=TP03rzRCQZNwc8gw7Wn4L%2FFEn88%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-14">05 总结与展望</h2>
<p>立足项目级一站式交付实践，AI 原生思维在研发领域的价值将向更深、更广维度延伸：</p>
<ul>
<li>
<p>从能力深化看，AI 将实现从 “被动响应需求” 到 “主动预测需求” 的升级，通过持续学习团队协作数据、项目交付规律，可提前预判研发各阶段的核心需求，预警潜在风险，让智能服务更具前瞻性</p>
</li>
<li>
<p>从场景拓展看，AI 与高频协作场景的融合将突破群聊边界，向需求评审、代码联调、线上问题排查等全研发链路渗透，构建 “全场景覆盖、全流程智能” 的研发协同体系，让智能能力随研发动作自然触发</p>
</li>
<li>
<p>从生态构建看，基于侧边栏的 AI 驱动协作模式，可进一步打通跨团队、跨业务线的数据与工具壁垒，形成可复用、可迭代的研发效能提升方案，推动 AI 原生思维从单一团队实践，升级为业务级研发协同标准</p>
</li>
</ul>
<p>最终，AI 将不再仅是 “提效工具”，更将成为研发团队创新的 “核心引擎”，通过持续解放人工低效环节，让团队聚焦于技术攻坚、产品创新等核心工作，推动研发领域从 “效能提升” 向 “价值创造” 跨越，开启智能化研发的全新阶段。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[专业的 IPA 处理工具 构建可维护、可回滚的 iOS 成品加工与加固流水线]]></title>    <link>https://juejin.cn/post/7578832575504793642</link>    <guid>https://juejin.cn/post/7578832575504793642</guid>    <pubDate>2025-12-02T09:21:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578832575504793642" data-draft-id="7578889811333316649" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="专业的 IPA 处理工具 构建可维护、可回滚的 iOS 成品加工与加固流水线"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-02T09:21:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="00后程序员"/> <meta itemprop="url" content="https://juejin.cn/user/1159358440539900"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            专业的 IPA 处理工具 构建可维护、可回滚的 iOS 成品加工与加固流水线
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1159358440539900/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    00后程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T09:21:40.000Z" title="Tue Dec 02 2025 09:21:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在大型移动团队或多项目外包团队中，处理 IPA 已经不再只是“打包上传”这么简单。真正成熟的开发体系往往在接触 IPA 时需要：</p>
<ul>
<li>对成品包进行符号检查</li>
<li>混淆 Swift/ObjC</li>
<li>扰动资源文件</li>
<li>修改 JSON/JS/H5 结构</li>
<li>修补隐私合规字段</li>
<li>重签名、安装、测试</li>
<li>验证逆向对抗能力</li>
<li>存档映射表供崩溃符号化</li>
<li>适配多个版本/渠道包/白标包</li>
</ul>
<hr/>
<h2 data-id="heading-0">一、什么叫“专业的 IPA 处理工具体系”？</h2>
<p>它应该具备以下特征：</p>
<h3 data-id="heading-1">支持没有源码的 IPA</h3>
<h3 data-id="heading-2">支持 Swift / ObjC / Flutter / RN / H5 混合应用</h3>
<h3 data-id="heading-3">能检查、混淆、修改、签名、验证</h3>
<h3 data-id="heading-4">能加入 CI/CD 流水线自动化</h3>
<h3 data-id="heading-5">能为每次混淆产生可追踪的映射表</h3>
<h3 data-id="heading-6">能兼容渠道包、白标定制包</h3>
<h3 data-id="heading-7">能集成安全团队所需的逆向检测能力</h3>
<p>这不是一个工具能完成的，而是多个工具协同的“体系工程”。</p>
<hr/>
<h2 data-id="heading-8">二、IPA 处理从哪里开始？（静态分析与结构识别）</h2>
<p>对 IPA 的所有操作都从<strong>静态分析</strong>开始。</p>
<hr/>
<h2 data-id="heading-9"><strong>① MobSF —— 结构级扫描工具</strong></h2>
<p>MobSF 能在一分钟内给出：</p>
<ul>
<li>内部资源结构（JS/H5/JSON/图片）</li>
<li>全局配置（Info.plist、URL Scheme）</li>
<li>使用的第三方 SDK</li>
<li>字符串、敏感接口收集</li>
<li>权限分析</li>
</ul>
<p>这相当于 IPA 的“体检报告”。</p>
<hr/>
<h2 data-id="heading-10"><strong>② class-dump / swift-dump —— 符号暴露评估</strong></h2>
<pre><code class="hljs language-lua" lang="lua">class-<span class="hljs-built_in">dump</span> app.ipa &gt; <span class="hljs-built_in">dump</span>.txt
</code></pre>
<p>能看到：</p>
<ul>
<li>Swift 类名（非常可读）</li>
<li>ObjC 方法名（语义明显）</li>
<li>属性、选择器、模块结构</li>
</ul>
<p>这是攻击者最常用的武器，因此必须作为混淆的输入。</p>
<hr/>
<h2 data-id="heading-11">三、IPA 成品混淆工具：构建可控的符号与资源保护层</h2>
<p>许多团队拿不到源码（外包、SDK、渠道包），因此工程混淆（Swift Shield / obfuscator-llvm）无法使用。</p>
<p>此时必须使用专业的“成品级 IPA 混淆工具”。</p>
<hr/>
<h2 data-id="heading-12"><strong>Ipa Guard CLI —— 专业 IPA 处理的核心工具</strong></h2>
<p>Ipa Guard 的定位不是简单“加壳”，而是针对 IPA 进行深度处理：</p>
<h3 data-id="heading-13"><strong>符号混淆能力</strong></h3>
<ul>
<li>Swift 类/方法/变量名混淆</li>
<li>ObjC selector 混淆</li>
<li>Flutter/RN Bridge 名称处理</li>
<li>黑白名单机制，避免破坏反射/SDK</li>
</ul>
<h3 data-id="heading-14"><strong>资源处理能力</strong></h3>
<ul>
<li>重命名图片、json、plist、JS、H5</li>
<li>修改资源 MD5（避免替换攻击）</li>
<li>JS 文件混淆（可选）</li>
<li>资源路径扰动</li>
</ul>
<h3 data-id="heading-15"><strong>命令行能力（可自动化）</strong></h3>
<pre><code class="hljs language-css" lang="css">ipaguard_cli parse app<span class="hljs-selector-class">.ipa</span> -o sym<span class="hljs-selector-class">.json</span>
ipaguard_cli protect app<span class="hljs-selector-class">.ipa</span> -c sym<span class="hljs-selector-class">.json</span> <span class="hljs-attr">--email</span> dev<span class="hljs-keyword">@team</span>.com --image --js -o out.ipa
</code></pre>
<h3 data-id="heading-16"><strong>可治理能力</strong></h3>
<ul>
<li>输出映射表</li>
<li>可回滚</li>
<li>可符号化</li>
<li>可审计</li>
</ul>
<p>这些能力使得 Ipa Guard 成为“专业 IPA 处理流水线”的核心组件。</p>
<hr/>
<h2 data-id="heading-17">四、IPA 混淆完整流程：专业团队使用的步骤</h2>
<hr/>
<h2 data-id="heading-18"><strong>① Step 1：导出符号文件（sym.json）</strong></h2>
<pre><code class="hljs">ipaguard_cli parse app.ipa -o sym.json
</code></pre>
<p>文件里包含：</p>
<ul>
<li>可混淆符号</li>
<li>不可混淆的风险提示</li>
<li>字符串引用信息</li>
<li>文件引用关系</li>
<li>Swift/ObjC 类型标记</li>
</ul>
<p>工程团队可以据此编辑策略。</p>
<hr/>
<h2 data-id="heading-19"><strong>② Step 2：编辑并合并混淆策略</strong></h2>
<p>必须排除：</p>
<ul>
<li>动态调用 selector</li>
<li>Storyboard id</li>
<li>MethodChannel（Flutter）</li>
<li>JSBridge 方法（H5、RN）</li>
<li>第三方 SDK 初始化过程</li>
</ul>
<p>必须混淆：</p>
<ul>
<li>内部逻辑</li>
<li>Swift 工具类</li>
<li>算法模块</li>
<li>网络处理</li>
<li>私有类与变量</li>
</ul>
<p>形成最终 <code>sym.json</code>。</p>
<hr/>
<h2 data-id="heading-20"><strong>③ Step 3：执行混淆并生成处理后 IPA</strong></h2>
<pre><code class="hljs language-css" lang="css">ipaguard_cli protect app<span class="hljs-selector-class">.ipa</span> \
  -c sym<span class="hljs-selector-class">.json</span> \
  <span class="hljs-attr">--image</span> \
  <span class="hljs-attr">--js</span> \
  <span class="hljs-attr">--email</span> dev<span class="hljs-keyword">@team</span>.com \
  -o protected.ipa
</code></pre>
<p>得到：</p>
<ul>
<li>混淆后的 IPA</li>
<li>资源改名后的结构</li>
<li>新 MD5 资源</li>
<li>映射表 meta.json</li>
</ul>
<hr/>
<h2 data-id="heading-21">五、专业的 IPA 处理中不能缺少：重签名与真机验证</h2>
<p>混淆后的 IPA 必须重新签名才能安装。</p>
<hr/>
<h2 data-id="heading-22"><strong>kxsign —— 强大的跨平台签名工具</strong></h2>
<pre><code class="hljs language-arduino" lang="arduino">kxsign sign <span class="hljs-keyword">protected</span>.ipa \
  -c cert.p12 -p pwd \
  -m dev.mobileprovision \
  -z <span class="hljs-type">signed</span>.ipa -i
</code></pre>
<p>测试内容包括：</p>
<ul>
<li>UI 是否正常</li>
<li>API 调用是否正常</li>
<li>JS/H5 是否不报错</li>
<li>Flutter/RN 是否正常渲染</li>
<li>登录、支付 SDK 是否可正常运行</li>
</ul>
<p>验证混淆策略是否正确。</p>
<hr/>
<h2 data-id="heading-23">六、逆向对抗验证：混淆是否“有效”由攻击者视角决定</h2>
<hr/>
<h2 data-id="heading-24"><strong>① Hopper / IDA 反编译验证</strong></h2>
<p>检查：</p>
<p>Swift 类是否已乱码
方法名是否不可解读
代码结构是否不易推断</p>
<hr/>
<h2 data-id="heading-25"><strong>② Frida 动态 Hook 测试</strong></h2>
<pre><code class="hljs language-css" lang="css">frida -U -f com<span class="hljs-selector-class">.app</span> <span class="hljs-attr">--no-pause</span> -l hook<span class="hljs-selector-class">.js</span>
</code></pre>
<p>如果：</p>
<ul>
<li>难以定位方法名</li>
<li>Hook 入口不明显</li>
<li>类名不可识别</li>
</ul>
<p>则混淆效果真正达标。</p>
<hr/>
<h2 data-id="heading-26">七、专业团队必做的：符号治理与映射表存档</h2>
<p>IPA 混淆之所以能进入“工程体系”，核心在于治理：</p>
<ul>
<li>sym.json</li>
<li>混淆映射表</li>
<li>构建号</li>
<li>签名指纹</li>
</ul>
<p>必须存放在：</p>
<ul>
<li>KMS</li>
<li>Git 加密仓库</li>
<li>内网 S3</li>
</ul>
<p>用于：</p>
<ul>
<li>崩溃符号化</li>
<li>上线审计</li>
<li>问题追踪</li>
<li>策略回滚</li>
</ul>
<hr/>
<h2 data-id="heading-27">IPA 处理需要一整套工具链协作，并非单工具即可完成</h2>
<p>最终推荐工具组合：</p>
<h3 data-id="heading-28"><strong>分析层</strong></h3>
<p>MobSF、class-dump</p>
<h3 data-id="heading-29"><strong>处理核心层</strong></h3>
<p>Ipa Guard CLI</p>
<ul>
<li>IPA 层符号混淆</li>
<li>资源扰动</li>
<li>JS/H5 保护</li>
<li>资源 MD5 修改</li>
</ul>
<h3 data-id="heading-30"><strong>验证层</strong></h3>
<p>kxsign、 Hopper、 Frida</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解决微服务系统中跨服务的超卖、库存锁定不释放、消息丢失、重复扣减库存等核心问题]]></title>    <link>https://juejin.cn/post/7578922565210210331</link>    <guid>https://juejin.cn/post/7578922565210210331</guid>    <pubDate>2025-12-02T09:36:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578922565210210331" data-draft-id="7578836326475317275" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解决微服务系统中跨服务的超卖、库存锁定不释放、消息丢失、重复扣减库存等核心问题"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-02T09:36:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈哈哈笑什么"/> <meta itemprop="url" content="https://juejin.cn/user/808832912075352"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解决微服务系统中跨服务的超卖、库存锁定不释放、消息丢失、重复扣减库存等核心问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/808832912075352/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈哈哈笑什么
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T09:36:04.000Z" title="Tue Dec 02 2025 09:36:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>基于你提供的 <code>sendAckMessage</code> 核心方法，我为你整理了 <strong>完整可运行的代码示例</strong>，覆盖「订单创建 + 库存扣减」电商场景的全链路，包括数据库设计、订单服务、库存服务、跨服务调用、MQ配置、补偿逻辑，直接复制即可落地。</p>
<h2 data-id="heading-0">一、整体架构说明</h2>
<ul>
<li><strong>技术栈</strong>：Spring Boot + Spring Cloud Stream + RabbitMQ + MyBatis-Plus + Feign（跨服务调用）</li>
<li><strong>核心流程</strong>：订单服务本地事务（创建订单+存消息）→ MQ跨服务推送 → 库存服务消费消息（扣减库存+幂等校验）→ 跨服务更新订单状态/消息状态</li>
<li><strong>解决问题</strong>：超卖、库存锁定不释放、消息丢失、重复扣减库存等核心问题</li>
</ul>
<hr/>
<h2 data-id="heading-1">二、第一步：数据库设计（订单库 + 库存库）</h2>
<h3 data-id="heading-2">1. 订单服务数据库（含LocalMessage表 + 订单表）</h3>
<pre><code class="hljs language-typescript" lang="typescript">-- <span class="hljs-number">1.</span> 本地消息表（你已有实体，补全表结构）
<span class="hljs-variable constant_">CREATE</span> <span class="hljs-variable constant_">TABLE</span> <span class="hljs-string">`local_message`</span> (
  <span class="hljs-string">`id`</span> <span class="hljs-built_in">bigint</span> <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">AUTO_INCREMENT</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'主键ID'</span>,
  <span class="hljs-string">`local_message_id`</span> <span class="hljs-title function_">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'消息唯一标识（UUID）'</span>,
  <span class="hljs-string">`queue`</span> <span class="hljs-title function_">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'MQ绑定名（如stock-deduct-binding）'</span>,
  <span class="hljs-string">`topic`</span> <span class="hljs-title function_">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-variable constant_">DEFAULT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'主题（预留）'</span>,
  <span class="hljs-string">`routing_key`</span> <span class="hljs-title function_">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-variable constant_">DEFAULT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'路由键（预留）'</span>,
  <span class="hljs-string">`message_body`</span> text <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'消息体（JSON格式）'</span>,
  <span class="hljs-string">`retry_times`</span> int <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">DEFAULT</span> <span class="hljs-string">'0'</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'已重试次数'</span>,
  <span class="hljs-string">`max_retry_times`</span> int <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">DEFAULT</span> <span class="hljs-string">'3'</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'最大重试次数'</span>,
  <span class="hljs-string">`deleted`</span> tinyint <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">DEFAULT</span> <span class="hljs-string">'0'</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'删除标识（0-未删，1-已删）'</span>,
  <span class="hljs-string">`state`</span> tinyint <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">DEFAULT</span> <span class="hljs-string">'0'</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'消息状态：0-READY，1-SEND，2-FAIL'</span>,
  <span class="hljs-string">`consume_state`</span> tinyint <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">DEFAULT</span> <span class="hljs-string">'0'</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'消费状态：0-未消费，1-已消费'</span>,
  <span class="hljs-string">`create_time`</span> <span class="hljs-built_in">bigint</span> <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'创建时间（时间戳）'</span>,
  <span class="hljs-string">`modify_time`</span> <span class="hljs-built_in">bigint</span> <span class="hljs-variable constant_">DEFAULT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'修改时间（时间戳）'</span>,
  <span class="hljs-string">`next_send_time`</span> <span class="hljs-built_in">bigint</span> <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'下次发送时间（时间戳）'</span>,
  <span class="hljs-string">`delay_seconds`</span> int <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">DEFAULT</span> <span class="hljs-string">'0'</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'延迟秒数'</span>,
  <span class="hljs-variable constant_">PRIMARY</span> <span class="hljs-variable constant_">KEY</span> (<span class="hljs-string">`id`</span>),
  <span class="hljs-variable constant_">UNIQUE</span> <span class="hljs-variable constant_">KEY</span> <span class="hljs-string">`uk_local_message_id`</span> (<span class="hljs-string">`local_message_id`</span>) <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'防重复消息'</span>,
  <span class="hljs-variable constant_">KEY</span> <span class="hljs-string">`idx_state_next_send_time`</span> (<span class="hljs-string">`state`</span>,<span class="hljs-string">`next_send_time`</span>) <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'定时重试查询索引'</span>
) <span class="hljs-variable constant_">ENGINE</span>=<span class="hljs-title class_">InnoDB</span> <span class="hljs-variable constant_">DEFAULT</span> <span class="hljs-variable constant_">CHARSET</span>=utf8mb4 <span class="hljs-variable constant_">COMMENT</span>=<span class="hljs-string">'本地消息表（分布式事务用）'</span>;

-- <span class="hljs-number">2.</span> 订单表
<span class="hljs-variable constant_">CREATE</span> <span class="hljs-variable constant_">TABLE</span> <span class="hljs-string">`t_order`</span> (
  <span class="hljs-string">`id`</span> <span class="hljs-built_in">bigint</span> <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">AUTO_INCREMENT</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'订单ID'</span>,
  <span class="hljs-string">`order_no`</span> <span class="hljs-title function_">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'订单编号（UUID）'</span>,
  <span class="hljs-string">`user_id`</span> <span class="hljs-built_in">bigint</span> <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'用户ID'</span>,
  <span class="hljs-string">`product_id`</span> <span class="hljs-built_in">bigint</span> <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'商品ID'</span>,
  <span class="hljs-string">`quantity`</span> int <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'购买数量'</span>,
  <span class="hljs-string">`status`</span> tinyint <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'订单状态：1-待扣库存，2-已扣库存待支付，3-已取消，4-已支付'</span>,
  <span class="hljs-string">`create_time`</span> <span class="hljs-built_in">bigint</span> <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'创建时间（时间戳）'</span>,
  <span class="hljs-string">`update_time`</span> <span class="hljs-built_in">bigint</span> <span class="hljs-variable constant_">DEFAULT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'更新时间（时间戳）'</span>,
  <span class="hljs-variable constant_">PRIMARY</span> <span class="hljs-variable constant_">KEY</span> (<span class="hljs-string">`id`</span>),
  <span class="hljs-variable constant_">UNIQUE</span> <span class="hljs-variable constant_">KEY</span> <span class="hljs-string">`uk_order_no`</span> (<span class="hljs-string">`order_no`</span>),
  <span class="hljs-variable constant_">KEY</span> <span class="hljs-string">`idx_user_id`</span> (<span class="hljs-string">`user_id`</span>),
  <span class="hljs-variable constant_">KEY</span> <span class="hljs-string">`idx_product_id_status`</span> (<span class="hljs-string">`product_id`</span>,<span class="hljs-string">`status`</span>) <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'库存扣减后查询订单索引'</span>
) <span class="hljs-variable constant_">ENGINE</span>=<span class="hljs-title class_">InnoDB</span> <span class="hljs-variable constant_">DEFAULT</span> <span class="hljs-variable constant_">CHARSET</span>=utf8mb4 <span class="hljs-variable constant_">COMMENT</span>=<span class="hljs-string">'订单表'</span>;
</code></pre>
<h3 data-id="heading-3">2. 库存服务数据库（库存表）</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `t_stock` (
  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">'库存ID'</span>,
  `product_id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'商品ID'</span>,
  `stock_num` <span class="hljs-type">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'0'</span> COMMENT <span class="hljs-string">'库存数量'</span>,
  `lock_num` <span class="hljs-type">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'0'</span> COMMENT <span class="hljs-string">'锁定数量（预留，可选）'</span>,
  `create_time` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'创建时间（时间戳）'</span>,
  `update_time` <span class="hljs-type">bigint</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'更新时间（时间戳）'</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),
  <span class="hljs-keyword">UNIQUE</span> KEY `uk_product_id` (`product_id`) COMMENT <span class="hljs-string">'商品ID唯一，避免重复库存'</span>
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'库存表'</span>;

<span class="hljs-comment">-- 初始化测试数据：商品ID=1001，库存=100</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `t_stock` (`product_id`, `stock_num`, `create_time`) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1001</span>, <span class="hljs-number">100</span>, UNIX_TIMESTAMP()<span class="hljs-operator">*</span><span class="hljs-number">1000</span>);
</code></pre>
<hr/>
<h2 data-id="heading-4">三、第二步：公共依赖与工具类（订单/库存服务共用）</h2>
<h3 data-id="heading-5">1. 实体类（DTO/VO）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 库存扣减消息DTO（订单服务发送 → 库存服务接收）</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StockDeductDTO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;
    <span class="hljs-keyword">private</span> String messageId; <span class="hljs-comment">// 消息唯一标识（和local_message_id一致）</span>
    <span class="hljs-keyword">private</span> Long orderId;     <span class="hljs-comment">// 订单ID</span>
    <span class="hljs-keyword">private</span> Long productId;   <span class="hljs-comment">// 商品ID</span>
    <span class="hljs-keyword">private</span> Integer quantity; <span class="hljs-comment">// 扣减数量</span>
}

<span class="hljs-comment">// 2. 订单状态更新DTO（库存服务 → 订单服务）</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderStatusUpdateDTO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;
    <span class="hljs-keyword">private</span> Long orderId;     <span class="hljs-comment">// 订单ID</span>
    <span class="hljs-keyword">private</span> Integer status;   <span class="hljs-comment">// 目标状态（2-已扣库存待支付，3-已取消）</span>
}

<span class="hljs-comment">// 3. 本地消息查询/更新VO（Feign跨服务调用用）</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalMessageVO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;
    <span class="hljs-keyword">private</span> String localMessageId; <span class="hljs-comment">// 消息ID</span>
    <span class="hljs-keyword">private</span> Integer consumeState;  <span class="hljs-comment">// 消费状态（0-未消费，1-已消费）</span>
}

<span class="hljs-comment">// 4. 业务异常类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BusinessException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RuntimeException</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BusinessException</span><span class="hljs-params">(String message)</span> {
        <span class="hljs-built_in">super</span>(message);
    }
}
</code></pre>
<h3 data-id="heading-6">2. 枚举类（订单服务）</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 本地消息状态枚举</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">LocalMessageStatusEnum</span> {
    <span class="hljs-built_in">READY</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"待发送"</span>),
    <span class="hljs-built_in">SEND</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"已发送"</span>),
    <span class="hljs-built_in">FAIL</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"发送失败"</span>);

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> status;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> desc;

    <span class="hljs-built_in">LocalMessageStatusEnum</span>(<span class="hljs-type">int</span> status, <span class="hljs-type">String</span> desc) {
        <span class="hljs-keyword">this</span>.status = status;
        <span class="hljs-keyword">this</span>.desc = desc;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title">getStatus</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> status;
    }
}

<span class="hljs-comment">// 订单状态枚举</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">OrderStatusEnum</span> {
    <span class="hljs-built_in">WAIT_DEDUCT</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"待扣库存"</span>),
    <span class="hljs-built_in">DEDUCTED_WAIT_PAY</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"已扣库存待支付"</span>),
    <span class="hljs-built_in">CANCELLED</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"已取消"</span>),
    <span class="hljs-built_in">PAID</span>(<span class="hljs-number">4</span>, <span class="hljs-string">"已支付"</span>);

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> status;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> desc;

    <span class="hljs-built_in">OrderStatusEnum</span>(<span class="hljs-type">int</span> status, <span class="hljs-type">String</span> desc) {
        <span class="hljs-keyword">this</span>.status = status;
        <span class="hljs-keyword">this</span>.desc = desc;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title">getStatus</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> status;
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-7">四、第三步：订单服务完整代码</h2>
<h3 data-id="heading-8">1. 核心依赖（pom.xml）</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Spring Boot核心 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Spring Cloud Stream + RabbitMQ --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-stream-rabbit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- MyBatis-Plus --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- MySQL驱动 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Feign（跨服务调用） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 工具类 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.hutool<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hutool-all<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.8.20<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-9">2. 配置文件（application.yml）</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">order-service</span> <span class="hljs-comment"># 服务名</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/order_db?useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;allowPublicKeyRetrieval=true</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">stream:</span>
      <span class="hljs-comment"># RabbitMQ绑定配置</span>
      <span class="hljs-attr">rabbit:</span>
        <span class="hljs-attr">bindings:</span>
          <span class="hljs-comment"># 生产者绑定（和sendAckMessage的bindingName一致）</span>
          <span class="hljs-attr">stock-deduct-binding:</span>
            <span class="hljs-attr">producer:</span>
              <span class="hljs-attr">acknowledge-mode:</span> <span class="hljs-string">CORRELATED</span> <span class="hljs-comment"># 开启发布确认（确保消息投递到MQ）</span>
              <span class="hljs-attr">routing-key-expression:</span> <span class="hljs-string">"'stock.deduct.routing'"</span> <span class="hljs-comment"># 路由键</span>
              <span class="hljs-attr">exchange-type:</span> <span class="hljs-string">direct</span> <span class="hljs-comment"># 交换机类型</span>
      <span class="hljs-comment"># 绑定关系配置</span>
      <span class="hljs-attr">bindings:</span>
        <span class="hljs-attr">stock-deduct-binding:</span>
          <span class="hljs-attr">destination:</span> <span class="hljs-string">stock.exchange</span> <span class="hljs-comment"># 交换机名（库存服务需一致）</span>
          <span class="hljs-attr">binder:</span> <span class="hljs-string">rabbit</span> <span class="hljs-comment"># 使用RabbitMQ作为绑定器</span>
  <span class="hljs-attr">rabbitmq:</span>
    <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">guest</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">guest</span>
    <span class="hljs-attr">publisher-confirm-type:</span> <span class="hljs-string">correlated</span> <span class="hljs-comment"># 开启发布确认（和stream配置呼应）</span>
    <span class="hljs-attr">publisher-returns:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 开启消息返回（处理未路由消息）</span>

<span class="hljs-comment"># MyBatis-Plus配置</span>
<span class="hljs-attr">mybatis-plus:</span>
  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath:mapper/*.xml</span>
  <span class="hljs-attr">type-aliases-package:</span> <span class="hljs-string">com.example.order.entity</span>
  <span class="hljs-attr">configuration:</span>
    <span class="hljs-attr">map-underscore-to-camel-case:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 下划线转驼峰</span>
    <span class="hljs-attr">log-impl:</span> <span class="hljs-string">org.apache.ibatis.logging.stdout.StdOutImpl</span> <span class="hljs-comment"># 打印SQL日志</span>

<span class="hljs-comment"># 服务端口</span>
<span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8081</span>
</code></pre>
<h3 data-id="heading-10">3. 实体类（Entity）</h3>
<pre><code class="hljs language-vbnet" lang="vbnet">// <span class="hljs-number">1</span>. LocalMessage实体（对应数据库表）
@Data
@TableName(<span class="hljs-string">"local_message"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> LocalMessage <span class="hljs-keyword">implements</span> Serializable {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-type">long</span> serialVersionUID = <span class="hljs-number">1L</span>;

    @TableId(type = IdType.<span class="hljs-keyword">AUTO</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-type">Long</span> id;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> localMessageId;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> queue;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> topic;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> routingKey;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> messageBody;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Integer</span> retryTimes;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Integer</span> maxRetryTimes;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Integer</span> deleted;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Integer</span> state;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Integer</span> consumeState;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Long</span> createTime;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Long</span> modifyTime;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Long</span> nextSendTime;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Integer</span> delaySeconds;
}

// <span class="hljs-number">2</span>. 订单实体
@Data
@TableName(<span class="hljs-string">"t_order"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-keyword">Order</span> <span class="hljs-keyword">implements</span> Serializable {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-type">long</span> serialVersionUID = <span class="hljs-number">1L</span>;

    @TableId(type = IdType.<span class="hljs-keyword">AUTO</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-type">Long</span> id;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> orderNo;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Long</span> userId;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Long</span> productId;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Integer</span> quantity;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Integer</span> status;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Long</span> createTime;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Long</span> updateTime;
}
</code></pre>
<h3 data-id="heading-11">4. Mapper接口（MyBatis-Plus）</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 1. LocalMessageMapper</span>
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">interface</span> <span class="hljs-selector-tag">LocalMessageMapper</span> <span class="hljs-selector-tag">extends</span> <span class="hljs-selector-tag">BaseMapper</span>&lt;<span class="hljs-selector-tag">LocalMessage</span>&gt; {
    <span class="hljs-comment">// 查询未发送且未超时的消息（定时重试用）</span>
    <span class="hljs-variable">@Select</span>(<span class="hljs-string">"SELECT * FROM local_message WHERE state = #{state} AND next_send_time &lt;= #{now} AND deleted = 0 AND retry_times &lt; max_retry_times"</span>)
    List&lt;LocalMessage&gt; <span class="hljs-built_in">selectUnsentMessages</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">"state"</span>) Integer state, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"now"</span>) Long now);

    <span class="hljs-comment">// 根据消息ID查询</span>
    <span class="hljs-variable">@Select</span>(<span class="hljs-string">"SELECT * FROM local_message WHERE local_message_id = #{localMessageId} AND deleted = 0"</span>)
    LocalMessage <span class="hljs-built_in">selectByLocalMessageId</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">"localMessageId"</span>) String localMessageId);

    <span class="hljs-comment">// 更新消息状态</span>
    <span class="hljs-variable">@Update</span>(<span class="hljs-string">"UPDATE local_message SET state = #{status}, retry_times = #{retryTimes}, modify_time = #{now} WHERE local_message_id = #{localMessageId}"</span>)
    int <span class="hljs-built_in">updateLocalMessageStatus</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">"localMessageId"</span>) String localMessageId, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"status"</span>) Integer status, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"retryTimes"</span>) Integer retryTimes, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"now"</span>) Long now);

    <span class="hljs-comment">// 更新消费状态</span>
    <span class="hljs-variable">@Update</span>(<span class="hljs-string">"UPDATE local_message SET consume_state = #{consumeState}, modify_time = #{now} WHERE local_message_id = #{localMessageId}"</span>)
    int <span class="hljs-built_in">updateConsumeState</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">"localMessageId"</span>) String localMessageId, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"consumeState"</span>) Integer consumeState, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"now"</span>) Long now);

    <span class="hljs-comment">// 更新重试次数和下次发送时间</span>
    <span class="hljs-variable">@Update</span>(<span class="hljs-string">"UPDATE local_message SET retry_times = #{newRetryTimes}, next_send_time = #{nextSendTime}, modify_time = #{now} WHERE local_message_id = #{localMessageId}"</span>)
    int <span class="hljs-built_in">updateRetryInfo</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">"localMessageId"</span>) String localMessageId, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"newRetryTimes"</span>) Integer newRetryTimes, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"nextSendTime"</span>) Long nextSendTime, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"now"</span>) Long now);
}

<span class="hljs-comment">// 2. OrderMapper</span>
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">interface</span> <span class="hljs-selector-tag">OrderMapper</span> <span class="hljs-selector-tag">extends</span> <span class="hljs-selector-tag">BaseMapper</span>&lt;<span class="hljs-selector-tag">Order</span>&gt; {
    <span class="hljs-comment">// 根据订单ID更新状态</span>
    <span class="hljs-variable">@Update</span>(<span class="hljs-string">"UPDATE t_order SET status = #{status}, update_time = #{now} WHERE id = #{orderId}"</span>)
    int <span class="hljs-built_in">updateOrderStatus</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">"orderId"</span>) Long orderId, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"status"</span>) Integer status, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"now"</span>) Long now);
}
</code></pre>
<h3 data-id="heading-12">5. 核心服务（Service）</h3>
<h4 data-id="heading-13">（1）你提供的sendAckMessage所在的LocalMessageService</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Service</span>
<span class="hljs-keyword">@Slf</span>4j
public class LocalMessageService {

    <span class="hljs-keyword">@Autowired</span>
    private LocalMessageMapper localMessageMapper;
    <span class="hljs-keyword">@Autowired</span>
    private StreamBridge streamBridge;

    <span class="hljs-comment">// 你提供的核心方法（保持不变，补充依赖和工具类）</span>
    <span class="hljs-keyword">@Override</span>
    <span class="hljs-keyword">@Transactional</span>(rollbackFor = Exception.class)
    public String sendAckMessage(String bindingName,
                                 String businessCode,
                                 Object data,
                                 int maxRetryTimes,
                                 long delaySeconds) {
        <span class="hljs-comment">// 生成消息体（这里简化实现，你可根据实际逻辑调整）</span>
        LocalMessagePayload localMessagePayload = <span class="hljs-built_in">genLocalMessagePayload</span>(businessCode, data);
        String messageId = localMessagePayload<span class="hljs-selector-class">.getMessageId</span>();
        String traceId = localMessagePayload<span class="hljs-selector-class">.getTraceId</span>();

        long now = System<span class="hljs-selector-class">.currentTimeMillis</span>();
        <span class="hljs-comment">// 构建本地消息实体</span>
        LocalMessage localMessage = new <span class="hljs-built_in">LocalMessage</span>();
        localMessage<span class="hljs-selector-class">.setLocalMessageId</span>(messageId);
        localMessage<span class="hljs-selector-class">.setQueue</span>(bindingName);
        localMessage<span class="hljs-selector-class">.setTopic</span>(null);
        localMessage<span class="hljs-selector-class">.setRoutingKey</span>(null);
        localMessage<span class="hljs-selector-class">.setMessageBody</span>(JSONUtil.toJsonStr(localMessagePayload)); <span class="hljs-comment">// 用hutool的JSON工具</span>
        localMessage<span class="hljs-selector-class">.setRetryTimes</span>(<span class="hljs-number">0</span>);
        localMessage<span class="hljs-selector-class">.setMaxRetryTimes</span>(maxRetryTimes);
        localMessage<span class="hljs-selector-class">.setDeleted</span>(<span class="hljs-number">0</span>);
        localMessage<span class="hljs-selector-class">.setState</span>(LocalMessageStatusEnum.READY.getStatus());
        localMessage<span class="hljs-selector-class">.setConsumeState</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 未消费</span>
        localMessage<span class="hljs-selector-class">.setCreateTime</span>(now);
        localMessage<span class="hljs-selector-class">.setModifyTime</span>(null);
        localMessage<span class="hljs-selector-class">.setNextSendTime</span>(now + (delaySeconds * <span class="hljs-number">1000</span>));
        localMessage<span class="hljs-selector-class">.setDelaySeconds</span>((int) delaySeconds);
        <span class="hljs-comment">// 插入本地消息表（和订单创建在同一个事务）</span>
        localMessageMapper<span class="hljs-selector-class">.insert</span>(localMessage);

        <span class="hljs-comment">// 事务提交后发送MQ消息</span>
        TransactionSynchronizationManager<span class="hljs-selector-class">.registerSynchronization</span>(new TransactionSynchronization() {
            <span class="hljs-keyword">@Override</span>
            public void afterCommit() {
                try {
                    String msgId = localMessage<span class="hljs-selector-class">.getLocalMessageId</span>();
                    int retryTimes = localMessage<span class="hljs-selector-class">.getRetryTimes</span>();
                    int maxRetry = localMessage<span class="hljs-selector-class">.getMaxRetryTimes</span>();

                    <span class="hljs-comment">// 构建MQ消息</span>
                    CorrelationData correlationData = new <span class="hljs-built_in">CorrelationData</span>(msgId);
                    Message&lt;?&gt; message = MessageBuilder<span class="hljs-selector-class">.withPayload</span>(localMessage.getMessageBody())
                            <span class="hljs-selector-class">.setHeader</span>(AmqpHeaders.PUBLISH_CONFIRM_CORRELATION, correlationData)
                            <span class="hljs-selector-class">.setHeader</span>("traceId", traceId)
                            <span class="hljs-selector-class">.build</span>();

                    <span class="hljs-comment">// 发送消息（通过StreamBridge）</span>
                    streamBridge<span class="hljs-selector-class">.send</span>(bindingName, message);

                    <span class="hljs-comment">// MQ发布确认回调</span>
                    correlationData<span class="hljs-selector-class">.getFuture</span>()<span class="hljs-selector-class">.addCallback</span>(confirm -&gt; {
                        MDC.put("traceId", traceId);
                        log<span class="hljs-selector-class">.info</span>("[Local Message] 发送回调，messageId:{}, confirm:{}", msgId, JSONUtil.toJsonStr(confirm));

                        Integer status = null;
                        if (confirm.isAck()) {
                            <span class="hljs-comment">// MQ已接收，更新消息状态为SEND</span>
                            status = LocalMessageStatusEnum<span class="hljs-selector-class">.SEND</span><span class="hljs-selector-class">.getStatus</span>();
                        } else if (maxRetry &lt;= <span class="hljs-number">0</span>) {
                            <span class="hljs-comment">// 无重试次数，标记为失败</span>
                            status = LocalMessageStatusEnum<span class="hljs-selector-class">.FAIL</span><span class="hljs-selector-class">.getStatus</span>();
                            log<span class="hljs-selector-class">.warn</span>("[Local Message] 发送失败，无重试次数，messageId:{}", msgId);
                        } else {
                            <span class="hljs-comment">// 发送失败，保留READY状态，等待定时重试</span>
                            log<span class="hljs-selector-class">.warn</span>("[Local Message] 发送失败，等待定时重试，messageId:{}", msgId);
                        }

                        if (status != null) {
                            <span class="hljs-built_in">updateLocalMessageStatus</span>(msgId, status, retryTimes);
                        }
                        MDC<span class="hljs-selector-class">.remove</span>("traceId");
                    }, throwable -&gt; {
                        log<span class="hljs-selector-class">.error</span>("[Local Message] 发送回调异常，messageId:{}", msgId, throwable);
                    });
                } catch (Exception e) {
                    log<span class="hljs-selector-class">.error</span>("[Local Message] 发送消息异常，messageId:{}", localMessage.getLocalMessageId(), e);
                }
            }
        });

        return messageId;
    }

    <span class="hljs-comment">// 生成消息体（简化实现，你可根据实际需求扩展）</span>
    private LocalMessagePayload <span class="hljs-built_in">genLocalMessagePayload</span>(String businessCode, Object data) {
        LocalMessagePayload payload = new <span class="hljs-built_in">LocalMessagePayload</span>();
        payload<span class="hljs-selector-class">.setMessageId</span>(UUID.randomUUID()<span class="hljs-selector-class">.toString</span>());
        payload<span class="hljs-selector-class">.setTraceId</span>(MDC.get("traceId") == null ? UUID<span class="hljs-selector-class">.randomUUID</span>()<span class="hljs-selector-class">.toString</span>() : MDC.<span class="hljs-built_in">get</span>(<span class="hljs-string">"traceId"</span>));
        payload<span class="hljs-selector-class">.setBusinessCode</span>(businessCode);
        payload<span class="hljs-selector-class">.setData</span>(data);
        payload<span class="hljs-selector-class">.setCreateTime</span>(System.currentTimeMillis());
        return payload;
    }

    <span class="hljs-comment">// 更新消息状态（内部工具方法）</span>
    private void <span class="hljs-built_in">updateLocalMessageStatus</span>(String localMessageId, Integer status, Integer retryTimes) {
        try {
            localMessageMapper<span class="hljs-selector-class">.updateLocalMessageStatus</span>(localMessageId, status, retryTimes, System.currentTimeMillis());
        } catch (Exception e) {
            log<span class="hljs-selector-class">.error</span>("[Local Message] 更新状态异常，messageId:{}, status:{}", localMessageId, status, e);
        }
    }

    <span class="hljs-comment">// 内部消息体封装类（你已有，补充完整）</span>
    <span class="hljs-keyword">@Data</span>
    public static class LocalMessagePayload implements Serializable {
        private static final long serialVersionUID = <span class="hljs-number">1</span>L;
        private String messageId;
        private String traceId;
        private String businessCode;
        private <span class="hljs-selector-tag">Object</span> data;
        private Long createTime;

        <span class="hljs-keyword">@Override</span>
        public String toString() {
            return JSONUtil<span class="hljs-selector-class">.toJsonStr</span>(this);
        }
    }
}
</code></pre>
<h4 data-id="heading-14">（2）订单核心服务（OrderService）</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Service</span>
<span class="hljs-keyword">@Slf</span>4j
public class OrderService {

    <span class="hljs-keyword">@Autowired</span>
    private OrderMapper orderMapper;
    <span class="hljs-keyword">@Autowired</span>
    private LocalMessageService localMessageService;

    <span class="hljs-comment">/**
     * 核心方法：创建订单 + 发送库存扣减消息（跨服务分布式事务）
     */</span>
    <span class="hljs-keyword">@Transactional</span>(rollbackFor = Exception.class)
    public String createOrder(Long userId, Long productId, Integer quantity) {
        <span class="hljs-comment">// 1. 参数校验</span>
        if (userId == null || productId == null || quantity &lt;= <span class="hljs-number">0</span>) {
            throw new <span class="hljs-built_in">BusinessException</span>("参数非法：userId、productId不能为空，quantity必须大于<span class="hljs-number">0</span>");
        }

        <span class="hljs-comment">// 2. 构建订单实体</span>
        <span class="hljs-attribute">Order</span> <span class="hljs-attribute">order</span> = new <span class="hljs-attribute">Order</span>();
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setOrderNo</span>(UUID.randomUUID()<span class="hljs-selector-class">.toString</span>());
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setUserId</span>(userId);
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setProductId</span>(productId);
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setQuantity</span>(quantity);
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setStatus</span>(OrderStatusEnum.WAIT_DEDUCT.getStatus()); <span class="hljs-comment">// 初始状态：待扣库存</span>
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setCreateTime</span>(System.currentTimeMillis());

        <span class="hljs-comment">// 3. 插入订单表（和下面的存消息在同一个本地事务）</span>
        orderMapper<span class="hljs-selector-class">.insert</span>(order);
        log<span class="hljs-selector-class">.info</span>("订单创建成功，orderId:{}, orderNo:{}", order.getId(), <span class="hljs-attribute">order</span><span class="hljs-selector-class">.getOrderNo</span>());

        <span class="hljs-comment">// 4. 构建库存扣减消息体</span>
        StockDeductDTO deductDTO = new <span class="hljs-built_in">StockDeductDTO</span>();
        deductDTO<span class="hljs-selector-class">.setMessageId</span>(UUID.randomUUID()<span class="hljs-selector-class">.toString</span>()); <span class="hljs-comment">// 和local_message_id一致</span>
        deductDTO<span class="hljs-selector-class">.setOrderId</span>(order.getId());
        deductDTO<span class="hljs-selector-class">.setProductId</span>(productId);
        deductDTO<span class="hljs-selector-class">.setQuantity</span>(quantity);

        <span class="hljs-comment">// 5. 调用你的sendAckMessage发送跨服务消息</span>
        localMessageService<span class="hljs-selector-class">.sendAckMessage</span>(
            "stock-deduct-binding", // MQ绑定名（和配置一致）
            "STOCK_DEDUCT",         // 业务标识
            deductDTO,              // 消息体
            <span class="hljs-number">3</span>,                      // 最大重试<span class="hljs-number">3</span>次
            <span class="hljs-number">0</span>                       // 延迟<span class="hljs-number">0</span>秒（立即发送）
        );

        return <span class="hljs-attribute">order</span><span class="hljs-selector-class">.getOrderNo</span>();
    }

    <span class="hljs-comment">/**
     * 跨服务调用：更新订单状态（供库存服务调用）
     */</span>
    <span class="hljs-keyword">@Transactional</span>(rollbackFor = Exception.class)
    public boolean updateOrderStatus(Long orderId, Integer status) {
        if (orderId == null || status == null) {
            throw new <span class="hljs-built_in">BusinessException</span>("参数非法：orderId、status不能为空");
        }
        int affectRows = orderMapper<span class="hljs-selector-class">.updateOrderStatus</span>(orderId, status, System.currentTimeMillis());
        log<span class="hljs-selector-class">.info</span>("更新订单状态，orderId:{}, status:{}, 影响行数:{}", orderId, status, affectRows);
        return affectRows &gt; <span class="hljs-number">0</span>;
    }
}
</code></pre>
<h3 data-id="heading-15">6. Feign接口（供库存服务跨服务调用）</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 1. 本地消息状态查询/更新Feign</span>
<span class="hljs-variable">@FeignClient</span>(name = <span class="hljs-string">"order-service"</span>) <span class="hljs-comment">// 对应订单服务名</span>
public interface LocalMessageFeignClient {

    <span class="hljs-comment">// 查询消息状态</span>
    <span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">"/local-message/{messageId}"</span>)
    Result&lt;LocalMessageVO&gt; <span class="hljs-built_in">getByMessageId</span>(<span class="hljs-variable">@PathVariable</span>(<span class="hljs-string">"messageId"</span>) String messageId);

    <span class="hljs-comment">// 更新消息消费状态</span>
    <span class="hljs-variable">@PutMapping</span>(<span class="hljs-string">"/local-message/{messageId}/consume-state"</span>)
    Result&lt;Boolean&gt; <span class="hljs-built_in">updateConsumeState</span>(<span class="hljs-variable">@PathVariable</span>(<span class="hljs-string">"messageId"</span>) String messageId, <span class="hljs-variable">@RequestParam</span>(<span class="hljs-string">"consumeState"</span>) Integer consumeState);
}

<span class="hljs-comment">// 2. 订单状态更新Feign</span>
<span class="hljs-variable">@FeignClient</span>(name = <span class="hljs-string">"order-service"</span>)
public interface OrderFeignClient {

    <span class="hljs-variable">@PutMapping</span>(<span class="hljs-string">"/order/{orderId}/status"</span>)
    Result&lt;Boolean&gt; <span class="hljs-built_in">updateOrderStatus</span>(<span class="hljs-variable">@PathVariable</span>(<span class="hljs-string">"orderId"</span>) Long orderId, <span class="hljs-variable">@RequestParam</span>(<span class="hljs-string">"status"</span>) Integer status);
}
</code></pre>
<h3 data-id="heading-16">7. 控制器（Controller）</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@RestController</span>
<span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">"/order"</span>)
<span class="hljs-variable">@Slf4j</span>
public class OrderController {

    <span class="hljs-variable">@Autowired</span>
    private OrderService orderService;

    <span class="hljs-comment">/**
     * 创建订单接口（前端调用）
     */</span>
    <span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">"/create"</span>)
    public Result&lt;String&gt; <span class="hljs-built_in">createOrder</span>(<span class="hljs-variable">@RequestParam</span>(<span class="hljs-string">"userId"</span>) Long userId,
                                      <span class="hljs-variable">@RequestParam</span>(<span class="hljs-string">"productId"</span>) Long productId,
                                      <span class="hljs-variable">@RequestParam</span>(<span class="hljs-string">"quantity"</span>) Integer quantity) {
        <span class="hljs-selector-tag">try</span> {
            <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">orderNo</span> = <span class="hljs-selector-tag">orderService</span><span class="hljs-selector-class">.createOrder</span>(userId, productId, quantity);
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Result</span><span class="hljs-selector-class">.success</span>(orderNo, <span class="hljs-string">"订单创建成功"</span>);
        } <span class="hljs-selector-tag">catch</span> (BusinessException e) {
            <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.error</span>(<span class="hljs-string">"创建订单失败：{}"</span>, e.<span class="hljs-built_in">getMessage</span>());
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Result</span><span class="hljs-selector-class">.fail</span>(e.<span class="hljs-built_in">getMessage</span>());
        } <span class="hljs-selector-tag">catch</span> (Exception e) {
            <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.error</span>(<span class="hljs-string">"创建订单异常"</span>, e);
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Result</span><span class="hljs-selector-class">.fail</span>(<span class="hljs-string">"系统异常，请重试"</span>);
        }
    }

    <span class="hljs-comment">/**
     * 跨服务更新订单状态接口（供库存服务调用）
     */</span>
    @<span class="hljs-selector-tag">PutMapping</span>(<span class="hljs-string">"/{orderId}/status"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">Result</span>&lt;<span class="hljs-selector-tag">Boolean</span>&gt; <span class="hljs-selector-tag">updateOrderStatus</span>(<span class="hljs-variable">@PathVariable</span>(<span class="hljs-string">"orderId"</span>) Long orderId,
                                            <span class="hljs-variable">@RequestParam</span>(<span class="hljs-string">"status"</span>) Integer status) {
        <span class="hljs-selector-tag">try</span> {
            <span class="hljs-selector-tag">boolean</span> <span class="hljs-selector-tag">success</span> = <span class="hljs-selector-tag">orderService</span><span class="hljs-selector-class">.updateOrderStatus</span>(orderId, status);
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">success</span> ? <span class="hljs-selector-tag">Result</span><span class="hljs-selector-class">.success</span>(true) : <span class="hljs-selector-tag">Result</span><span class="hljs-selector-class">.fail</span>(<span class="hljs-string">"更新订单状态失败"</span>);
        } <span class="hljs-selector-tag">catch</span> (BusinessException e) {
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Result</span><span class="hljs-selector-class">.fail</span>(e.<span class="hljs-built_in">getMessage</span>());
        } <span class="hljs-selector-tag">catch</span> (Exception e) {
            <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.error</span>(<span class="hljs-string">"更新订单状态异常"</span>, e);
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Result</span><span class="hljs-selector-class">.fail</span>(<span class="hljs-string">"系统异常"</span>);
        }
    }
}

@<span class="hljs-selector-tag">RestController</span>
@<span class="hljs-selector-tag">RequestMapping</span>(<span class="hljs-string">"/local-message"</span>)
@<span class="hljs-selector-tag">Slf4j</span>
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">LocalMessageController</span> {

    <span class="hljs-variable">@Autowired</span>
    private LocalMessageMapper localMessageMapper;

    <span class="hljs-comment">/**
     * 跨服务查询消息状态（供库存服务调用）
     */</span>
    <span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">"/{messageId}"</span>)
    public Result&lt;LocalMessageVO&gt; <span class="hljs-built_in">getByMessageId</span>(<span class="hljs-variable">@PathVariable</span>(<span class="hljs-string">"messageId"</span>) String messageId) {
        <span class="hljs-selector-tag">LocalMessage</span> <span class="hljs-selector-tag">localMessage</span> = <span class="hljs-selector-tag">localMessageMapper</span><span class="hljs-selector-class">.selectByLocalMessageId</span>(messageId);
        <span class="hljs-selector-tag">if</span> (localMessage == null) {
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Result</span><span class="hljs-selector-class">.fail</span>(<span class="hljs-string">"消息不存在"</span>);
        }
        <span class="hljs-selector-tag">LocalMessageVO</span> <span class="hljs-selector-tag">vo</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">LocalMessageVO</span>();
        <span class="hljs-selector-tag">vo</span><span class="hljs-selector-class">.setLocalMessageId</span>(localMessage.<span class="hljs-built_in">getLocalMessageId</span>());
        <span class="hljs-selector-tag">vo</span><span class="hljs-selector-class">.setConsumeState</span>(localMessage.<span class="hljs-built_in">getConsumeState</span>());
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Result</span><span class="hljs-selector-class">.success</span>(vo);
    }

    <span class="hljs-comment">/**
     * 跨服务更新消息消费状态（供库存服务调用）
     */</span>
    @<span class="hljs-selector-tag">PutMapping</span>(<span class="hljs-string">"/{messageId}/consume-state"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">Result</span>&lt;<span class="hljs-selector-tag">Boolean</span>&gt; <span class="hljs-selector-tag">updateConsumeState</span>(<span class="hljs-variable">@PathVariable</span>(<span class="hljs-string">"messageId"</span>) String messageId,
                                             <span class="hljs-variable">@RequestParam</span>(<span class="hljs-string">"consumeState"</span>) Integer consumeState) {
        <span class="hljs-selector-tag">try</span> {
            <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">affectRows</span> = <span class="hljs-selector-tag">localMessageMapper</span><span class="hljs-selector-class">.updateConsumeState</span>(messageId, consumeState, System.<span class="hljs-built_in">currentTimeMillis</span>());
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">affectRows</span> &gt; <span class="hljs-number">0</span> ? <span class="hljs-selector-tag">Result</span><span class="hljs-selector-class">.success</span>(true) : <span class="hljs-selector-tag">Result</span><span class="hljs-selector-class">.fail</span>(<span class="hljs-string">"更新消费状态失败"</span>);
        } <span class="hljs-selector-tag">catch</span> (Exception e) {
            <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.error</span>(<span class="hljs-string">"更新消息消费状态异常"</span>, e);
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Result</span><span class="hljs-selector-class">.fail</span>(<span class="hljs-string">"系统异常"</span>);
        }
    }
}
</code></pre>
<h3 data-id="heading-17">8. 定时重试任务（处理未发送成功的消息）</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Configuration</span>
<span class="hljs-variable">@EnableScheduling</span>
<span class="hljs-variable">@Slf4j</span>
public class MessageRetryTask {

    <span class="hljs-variable">@Autowired</span>
    private LocalMessageMapper localMessageMapper;
    <span class="hljs-variable">@Autowired</span>
    private StreamBridge streamBridge;

    <span class="hljs-comment">/**
     * 每3分钟扫描一次未发送成功的消息，进行重试
     */</span>
    <span class="hljs-variable">@Scheduled</span>(cron = <span class="hljs-string">"0 0/3 * * * ?"</span>)
    public void <span class="hljs-built_in">retryUnsentMessage</span>() {
        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"开始执行未发送消息重试任务"</span>);
        <span class="hljs-selector-tag">long</span> <span class="hljs-selector-tag">now</span> = <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.currentTimeMillis</span>();

        <span class="hljs-comment">// 查询：状态为READY + 下次发送时间&lt;=当前时间 + 未删除 + 重试次数&lt;最大重试次数</span>
        <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">LocalMessage</span>&gt; <span class="hljs-selector-tag">unsentMessages</span> = <span class="hljs-selector-tag">localMessageMapper</span><span class="hljs-selector-class">.selectUnsentMessages</span>(
            LocalMessageStatusEnum.READY.<span class="hljs-built_in">getStatus</span>(), now
        );

        <span class="hljs-selector-tag">if</span> (CollectionUtil.<span class="hljs-built_in">isEmpty</span>(unsentMessages)) {
            <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"无未发送消息，重试任务结束"</span>);
            <span class="hljs-selector-tag">return</span>;
        }

        <span class="hljs-comment">// 遍历重试</span>
        <span class="hljs-selector-tag">for</span> (LocalMessage <span class="hljs-attribute">message </span>: unsentMessages) {
            <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">messageId</span> = <span class="hljs-selector-tag">message</span><span class="hljs-selector-class">.getLocalMessageId</span>();
            <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">currentRetryTimes</span> = <span class="hljs-selector-tag">message</span><span class="hljs-selector-class">.getRetryTimes</span>();
            <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">maxRetryTimes</span> = <span class="hljs-selector-tag">message</span><span class="hljs-selector-class">.getMaxRetryTimes</span>();

            <span class="hljs-comment">// 重试次数超限，标记为失败</span>
            <span class="hljs-selector-tag">if</span> (currentRetryTimes &gt;= maxRetryTimes) {
                <span class="hljs-selector-tag">localMessageMapper</span><span class="hljs-selector-class">.updateLocalMessageStatus</span>(messageId, LocalMessageStatusEnum.FAIL.<span class="hljs-built_in">getStatus</span>(), currentRetryTimes, now);
                <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.warn</span>(<span class="hljs-string">"消息重试次数超限，标记为失败，messageId:{}"</span>, messageId);
                <span class="hljs-selector-tag">continue</span>;
            }

            <span class="hljs-selector-tag">try</span> {
                <span class="hljs-comment">// 构建MQ消息</span>
                <span class="hljs-selector-tag">CorrelationData</span> <span class="hljs-selector-tag">correlationData</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">CorrelationData</span>(messageId);
                <span class="hljs-selector-tag">Message</span>&lt;?&gt; <span class="hljs-selector-tag">mqMessage</span> = <span class="hljs-selector-tag">MessageBuilder</span><span class="hljs-selector-class">.withPayload</span>(message.<span class="hljs-built_in">getMessageBody</span>())
                        <span class="hljs-selector-class">.setHeader</span>(AmqpHeaders.PUBLISH_CONFIRM_CORRELATION, correlationData)
                        <span class="hljs-selector-class">.build</span>();

                <span class="hljs-comment">// 重新发送消息</span>
                <span class="hljs-selector-tag">streamBridge</span><span class="hljs-selector-class">.send</span>(message.<span class="hljs-built_in">getQueue</span>(), mqMessage);
                <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"消息重试发送，messageId:{}, 当前重试次数:{}"</span>, messageId, currentRetryTimes + <span class="hljs-number">1</span>);

                <span class="hljs-comment">// 更新重试次数和下次发送时间（指数退避：3分钟→6分钟→12分钟）</span>
                <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">newRetryTimes</span> = <span class="hljs-selector-tag">currentRetryTimes</span> + <span class="hljs-number">1</span>;
                <span class="hljs-selector-tag">long</span> <span class="hljs-selector-tag">nextSendTime</span> = <span class="hljs-selector-tag">now</span> + (<span class="hljs-number">3</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>) * (<span class="hljs-number">1</span> &lt;&lt; newRetryTimes); <span class="hljs-comment">// 2^newRetryTimes 倍</span>
                <span class="hljs-selector-tag">localMessageMapper</span><span class="hljs-selector-class">.updateRetryInfo</span>(messageId, newRetryTimes, nextSendTime, now);

                <span class="hljs-comment">// 发布确认回调（和sendAckMessage逻辑一致）</span>
                <span class="hljs-selector-tag">correlationData</span><span class="hljs-selector-class">.getFuture</span>()<span class="hljs-selector-class">.addCallback</span>(confirm -&gt; {
                    <span class="hljs-selector-tag">if</span> (confirm.<span class="hljs-built_in">isAck</span>()) {
                        <span class="hljs-selector-tag">localMessageMapper</span><span class="hljs-selector-class">.updateLocalMessageStatus</span>(messageId, LocalMessageStatusEnum.SEND.<span class="hljs-built_in">getStatus</span>(), newRetryTimes, System.<span class="hljs-built_in">currentTimeMillis</span>());
                        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"消息重试发送成功，messageId:{}"</span>, messageId);
                    } <span class="hljs-selector-tag">else</span> {
                        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.warn</span>(<span class="hljs-string">"消息重试发送失败，等待下次扫描，messageId:{}"</span>, messageId);
                    }
                }, <span class="hljs-selector-tag">throwable</span> <span class="hljs-selector-tag">-</span>&gt; {
                    <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.error</span>(<span class="hljs-string">"消息重试发送回调异常，messageId:{}"</span>, messageId, throwable);
                });
            } <span class="hljs-selector-tag">catch</span> (Exception e) {
                <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.error</span>(<span class="hljs-string">"消息重试发送异常，messageId:{}"</span>, messageId, e);
            }
        }

        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"未发送消息重试任务执行结束，共处理{}条消息"</span>, unsentMessages.<span class="hljs-built_in">size</span>());
    }
}
</code></pre>
<h3 data-id="heading-18">9. 全局异常处理与Result工具类</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 全局异常处理器</span>
<span class="hljs-meta">@RestControllerAdvice</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandler</span> {

    <span class="hljs-meta">@ExceptionHandler</span>(<span class="hljs-title class_">BusinessException</span>.<span class="hljs-property">class</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Result</span>&lt;<span class="hljs-title class_">Void</span>&gt; <span class="hljs-title function_">handleBusinessException</span>(<span class="hljs-params">BusinessException e</span>) {
        log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"业务异常：{}"</span>, e.<span class="hljs-title function_">getMessage</span>());
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Result</span>.<span class="hljs-title function_">fail</span>(e.<span class="hljs-title function_">getMessage</span>());
    }

    <span class="hljs-meta">@ExceptionHandler</span>(<span class="hljs-title class_">Exception</span>.<span class="hljs-property">class</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Result</span>&lt;<span class="hljs-title class_">Void</span>&gt; <span class="hljs-title function_">handleException</span>(<span class="hljs-params">Exception e</span>) {
        log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"系统异常："</span>, e);
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Result</span>.<span class="hljs-title function_">fail</span>(<span class="hljs-string">"系统异常，请联系管理员"</span>);
    }
}

<span class="hljs-comment">// 2. 统一返回结果工具类</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final long serialVersionUID = 1L;
    <span class="hljs-keyword">private</span> int code; <span class="hljs-comment">// 0-成功，1-失败</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> msg;
    <span class="hljs-keyword">private</span> T data;

    <span class="hljs-comment">// 成功响应（无数据）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-title class_">Result</span>&lt;T&gt; <span class="hljs-title function_">success</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>&lt;&gt;(<span class="hljs-number">0</span>, <span class="hljs-string">"操作成功"</span>, <span class="hljs-literal">null</span>);
    }

    <span class="hljs-comment">// 成功响应（有数据）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-title class_">Result</span>&lt;T&gt; <span class="hljs-title function_">success</span>(<span class="hljs-params">T data</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>&lt;&gt;(<span class="hljs-number">0</span>, <span class="hljs-string">"操作成功"</span>, data);
    }

    <span class="hljs-comment">// 成功响应（自定义消息）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-title class_">Result</span>&lt;T&gt; <span class="hljs-title function_">success</span>(<span class="hljs-params">T data, <span class="hljs-built_in">String</span> msg</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>&lt;&gt;(<span class="hljs-number">0</span>, msg, data);
    }

    <span class="hljs-comment">// 失败响应（自定义消息）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-title class_">Result</span>&lt;T&gt; <span class="hljs-title function_">fail</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> msg</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>&lt;&gt;(<span class="hljs-number">1</span>, msg, <span class="hljs-literal">null</span>);
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-19">五、第四步：库存服务完整代码</h2>
<h3 data-id="heading-20">1. 核心依赖（pom.xml）</h3>
<p>和订单服务一致（Spring Boot + Stream + RabbitMQ + MyBatis-Plus + Feign）</p>
<h3 data-id="heading-21">2. 配置文件（application.yml）</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">stock-service</span> <span class="hljs-comment"># 服务名</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/stock_db?useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;allowPublicKeyRetrieval=true</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">stream:</span>
      <span class="hljs-attr">rabbit:</span>
        <span class="hljs-attr">bindings:</span>
          <span class="hljs-comment"># 消费者绑定（和订单服务的交换机、路由键一致）</span>
          <span class="hljs-attr">stock-deduct-binding-in-0:</span>
            <span class="hljs-attr">consumer:</span>
              <span class="hljs-attr">acknowledge-mode:</span> <span class="hljs-string">MANUAL</span> <span class="hljs-comment"># 手动确认消息（确保消费成功后再ACK）</span>
              <span class="hljs-attr">dead-letter-exchange:</span> <span class="hljs-string">dlq.stock.exchange</span> <span class="hljs-comment"># 死信交换机（处理最终失败消息）</span>
              <span class="hljs-attr">dead-letter-routing-key:</span> <span class="hljs-string">dlq.stock.deduct</span> <span class="hljs-comment"># 死信路由键</span>
              <span class="hljs-attr">max-attempts:</span> <span class="hljs-number">3</span> <span class="hljs-comment"># 最大重试3次（超过进入死信队列）</span>
              <span class="hljs-attr">retry:</span>
                <span class="hljs-attr">initial-interval:</span> <span class="hljs-number">1000</span> <span class="hljs-comment"># 初始重试间隔1秒</span>
                <span class="hljs-attr">multiplier:</span> <span class="hljs-number">2</span> <span class="hljs-comment"># 间隔倍数（1s→2s→4s）</span>
              <span class="hljs-attr">exchange-type:</span> <span class="hljs-string">direct</span>
      <span class="hljs-attr">bindings:</span>
        <span class="hljs-comment"># 消费者绑定配置（格式：bindingName-in-0）</span>
        <span class="hljs-attr">stock-deduct-binding-in-0:</span>
          <span class="hljs-attr">destination:</span> <span class="hljs-string">stock.exchange</span> <span class="hljs-comment"># 和订单服务的交换机一致</span>
          <span class="hljs-attr">group:</span> <span class="hljs-string">stock-group</span> <span class="hljs-comment"># 消费者组（避免重复消费）</span>
          <span class="hljs-attr">binder:</span> <span class="hljs-string">rabbit</span>
  <span class="hljs-attr">rabbitmq:</span>
    <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">guest</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">guest</span>

<span class="hljs-comment"># MyBatis-Plus配置</span>
<span class="hljs-attr">mybatis-plus:</span>
  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath:mapper/*.xml</span>
  <span class="hljs-attr">type-aliases-package:</span> <span class="hljs-string">com.example.stock.entity</span>
  <span class="hljs-attr">configuration:</span>
    <span class="hljs-attr">map-underscore-to-camel-case:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">log-impl:</span> <span class="hljs-string">org.apache.ibatis.logging.stdout.StdOutImpl</span>

<span class="hljs-comment"># 服务端口</span>
<span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8082</span>
</code></pre>
<h3 data-id="heading-22">3. 实体类与Mapper</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 1. 库存实体</span>
<span class="hljs-variable">@Data</span>
<span class="hljs-variable">@TableName</span>(<span class="hljs-string">"t_stock"</span>)
public class Stock implements Serializable {
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">static</span> <span class="hljs-selector-tag">final</span> <span class="hljs-selector-tag">long</span> <span class="hljs-selector-tag">serialVersionUID</span> = <span class="hljs-number">1</span><span class="hljs-selector-tag">L</span>;

    @<span class="hljs-selector-tag">TableId</span>(type = IdType.AUTO)
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">Long</span> <span class="hljs-selector-tag">id</span>;
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">Long</span> <span class="hljs-selector-tag">productId</span>;
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">Integer</span> <span class="hljs-selector-tag">stockNum</span>;
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">Integer</span> <span class="hljs-selector-tag">lockNum</span>;
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">Long</span> <span class="hljs-selector-tag">createTime</span>;
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">Long</span> <span class="hljs-selector-tag">updateTime</span>;
}

<span class="hljs-comment">// 2. 库存Mapper</span>
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">interface</span> <span class="hljs-selector-tag">StockMapper</span> <span class="hljs-selector-tag">extends</span> <span class="hljs-selector-tag">BaseMapper</span>&lt;<span class="hljs-selector-tag">Stock</span>&gt; {
    <span class="hljs-comment">/**
     * 扣减库存（加行锁，避免超卖）
     * SQL：UPDATE t_stock SET stock_num = stock_num - #{quantity}, update_time = #{now} WHERE product_id = #{productId} AND stock_num &gt;= #{quantity}
     */</span>
    <span class="hljs-variable">@Update</span>(<span class="hljs-string">"UPDATE t_stock SET stock_num = stock_num - #{quantity}, update_time = #{now} WHERE product_id = #{productId} AND stock_num &gt;= #{quantity}"</span>)
    int <span class="hljs-built_in">deductStock</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">"productId"</span>) Long productId, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"quantity"</span>) Integer quantity, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"now"</span>) Long now);
}
</code></pre>
<h3 data-id="heading-23">4. Feign客户端（跨服务调用订单服务）</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 1. 订单状态更新Feign（和订单服务的接口一致）</span>
<span class="hljs-variable">@FeignClient</span>(name = <span class="hljs-string">"order-service"</span>)
public interface OrderFeignClient {
    <span class="hljs-variable">@PutMapping</span>(<span class="hljs-string">"/order/{orderId}/status"</span>)
    Result&lt;Boolean&gt; <span class="hljs-built_in">updateOrderStatus</span>(<span class="hljs-variable">@PathVariable</span>(<span class="hljs-string">"orderId"</span>) Long orderId, <span class="hljs-variable">@RequestParam</span>(<span class="hljs-string">"status"</span>) Integer status);
}

<span class="hljs-comment">// 2. 本地消息状态更新Feign</span>
<span class="hljs-variable">@FeignClient</span>(name = <span class="hljs-string">"order-service"</span>)
public interface LocalMessageFeignClient {
    <span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">"/local-message/{messageId}"</span>)
    Result&lt;LocalMessageVO&gt; <span class="hljs-built_in">getByMessageId</span>(<span class="hljs-variable">@PathVariable</span>(<span class="hljs-string">"messageId"</span>) String messageId);

    <span class="hljs-variable">@PutMapping</span>(<span class="hljs-string">"/local-message/{messageId}/consume-state"</span>)
    Result&lt;Boolean&gt; <span class="hljs-built_in">updateConsumeState</span>(<span class="hljs-variable">@PathVariable</span>(<span class="hljs-string">"messageId"</span>) String messageId, <span class="hljs-variable">@RequestParam</span>(<span class="hljs-string">"consumeState"</span>) Integer consumeState);
}
</code></pre>
<h3 data-id="heading-24">5. 核心消费者服务（StockConsumerService）</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StockConsumerService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">StockMapper</span> stockMapper;
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">OrderFeignClient</span> orderFeignClient;
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">LocalMessageFeignClient</span> localMessageFeignClient;

    <span class="hljs-comment">/**
     * 库存扣减消费者（监听MQ消息）
     */</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Consumer</span>&lt;<span class="hljs-title class_">Message</span>&lt;<span class="hljs-title class_">String</span>&gt;&gt; <span class="hljs-title function_">stockDeductConsumer</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> message -&gt; {
            <span class="hljs-title class_">String</span> payloadStr = message.<span class="hljs-title function_">getPayload</span>();
            log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"收到库存扣减消息，payload:{}"</span>, payloadStr);

            <span class="hljs-comment">// 解析消息体（LocalMessagePayload格式）</span>
            <span class="hljs-title class_">LocalMessageService</span>.<span class="hljs-property">LocalMessagePayload</span> payload = <span class="hljs-title class_">JSON</span>Util.<span class="hljs-title function_">toBean</span>(payloadStr, <span class="hljs-title class_">LocalMessageService</span>.<span class="hljs-property">LocalMessagePayload</span>.<span class="hljs-property">class</span>);
            <span class="hljs-title class_">StockDeductDTO</span> deductDTO = <span class="hljs-title class_">JSON</span>Util.<span class="hljs-title function_">toBean</span>(<span class="hljs-title class_">JSON</span>Util.<span class="hljs-title function_">toJsonStr</span>(payload.<span class="hljs-title function_">getData</span>()), <span class="hljs-title class_">StockDeductDTO</span>.<span class="hljs-property">class</span>);

            <span class="hljs-title class_">String</span> messageId = deductDTO.<span class="hljs-title function_">getMessageId</span>();
            <span class="hljs-title class_">Long</span> orderId = deductDTO.<span class="hljs-title function_">getOrderId</span>();
            <span class="hljs-title class_">Long</span> productId = deductDTO.<span class="hljs-title function_">getProductId</span>();
            <span class="hljs-title class_">Integer</span> quantity = deductDTO.<span class="hljs-title function_">getQuantity</span>();
            long now = <span class="hljs-title class_">System</span>.<span class="hljs-title function_">currentTimeMillis</span>();

            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 1. 幂等性校验：避免重复扣减库存</span>
                <span class="hljs-title class_">Result</span>&lt;<span class="hljs-title class_">LocalMessageVO</span>&gt; messageResult = localMessageFeignClient.<span class="hljs-title function_">getByMessageId</span>(messageId);
                <span class="hljs-keyword">if</span> (messageResult.<span class="hljs-title function_">getCode</span>() != <span class="hljs-number">0</span> || messageResult.<span class="hljs-title function_">getData</span>() == <span class="hljs-literal">null</span>) {
                    log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"消息不存在，messageId:{}"</span>, messageId);
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AmqpRejectAndDontRequeueException</span>(<span class="hljs-string">"消息不存在，拒绝重入队列"</span>);
                }
                <span class="hljs-keyword">if</span> (messageResult.<span class="hljs-title function_">getData</span>().<span class="hljs-title function_">getConsumeState</span>() == <span class="hljs-number">1</span>) {
                    log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"消息已消费，无需重复处理，messageId:{}"</span>, messageId);
                    <span class="hljs-keyword">return</span>;
                }

                <span class="hljs-comment">// 2. 扣减库存（本地事务，加行锁避免超卖）</span>
                int affectRows = stockMapper.<span class="hljs-title function_">deductStock</span>(productId, quantity, now);
                <span class="hljs-keyword">if</span> (affectRows == <span class="hljs-number">0</span>) {
                    <span class="hljs-comment">// 库存不足：取消订单，拒绝重入队列（进入死信队列）</span>
                    log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"库存不足，无法扣减，productId:{}, quantity:{}, orderId:{}"</span>, productId, quantity, orderId);
                    <span class="hljs-comment">// 跨服务调用：更新订单状态为“已取消”</span>
                    <span class="hljs-title class_">Result</span>&lt;<span class="hljs-title class_">Boolean</span>&gt; cancelResult = orderFeignClient.<span class="hljs-title function_">updateOrderStatus</span>(orderId, <span class="hljs-title class_">OrderStatusEnum</span>.<span class="hljs-property">CANCELLED</span>.<span class="hljs-title function_">getStatus</span>());
                    log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"库存不足，取消订单结果，orderId:{}, success:{}"</span>, orderId, cancelResult.<span class="hljs-title function_">getData</span>());
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AmqpRejectAndDontRequeueException</span>(<span class="hljs-string">"库存不足，取消订单"</span>);
                }
                log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"库存扣减成功，productId:{}, 扣减数量:{}, 剩余库存:{}"</span>, productId, quantity, <span class="hljs-title function_">getStockNum</span>(productId));

                <span class="hljs-comment">// 3. 跨服务调用：更新订单状态为“已扣库存待支付”</span>
                <span class="hljs-title class_">Result</span>&lt;<span class="hljs-title class_">Boolean</span>&gt; orderResult = orderFeignClient.<span class="hljs-title function_">updateOrderStatus</span>(orderId, <span class="hljs-title class_">OrderStatusEnum</span>.<span class="hljs-property">DEDUCTED_WAIT_PAY</span>.<span class="hljs-title function_">getStatus</span>());
                <span class="hljs-keyword">if</span> (orderResult.<span class="hljs-title function_">getCode</span>() != <span class="hljs-number">0</span> || !orderResult.<span class="hljs-title function_">getData</span>()) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"更新订单状态失败"</span>);
                }

                <span class="hljs-comment">// 4. 跨服务调用：标记消息为“已消费”</span>
                <span class="hljs-title class_">Result</span>&lt;<span class="hljs-title class_">Boolean</span>&gt; consumeResult = localMessageFeignClient.<span class="hljs-title function_">updateConsumeState</span>(messageId, <span class="hljs-number">1</span>);
                <span class="hljs-keyword">if</span> (consumeResult.<span class="hljs-title function_">getCode</span>() != <span class="hljs-number">0</span> || !consumeResult.<span class="hljs-title function_">getData</span>()) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"更新消息消费状态失败"</span>);
                }

                log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"库存扣减全流程完成，messageId:{}, orderId:{}"</span>, messageId, orderId);

            } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">AmqpRejectAndDontRequeueException</span> e) {
                <span class="hljs-comment">// 主动拒绝：不重试，直接进入死信队列</span>
                <span class="hljs-keyword">throw</span> e;
            } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">BusinessException</span> e) {
                <span class="hljs-comment">// 业务异常：不重试，进入死信队列</span>
                log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"库存扣减业务异常，messageId:{}, orderId:{}"</span>, messageId, orderId, e);
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AmqpRejectAndDontRequeueException</span>(e.<span class="hljs-title function_">getMessage</span>(), e);
            } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
                <span class="hljs-comment">// 非业务异常（如网络抖动）：抛异常触发重试（最多3次）</span>
                log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"库存扣减异常，将重试，messageId:{}, orderId:{}"</span>, messageId, orderId, e);
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"库存扣减异常，触发重试"</span>, e);
            }
        };
    }

    <span class="hljs-comment">// 辅助方法：查询商品当前库存（仅日志用）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Integer</span> <span class="hljs-title function_">getStockNum</span>(<span class="hljs-params">Long productId</span>) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-title class_">Stock</span> stock = stockMapper.<span class="hljs-title function_">selectOne</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;<span class="hljs-title class_">Stock</span>&gt;().<span class="hljs-title function_">eq</span>(<span class="hljs-title class_">Stock</span>::getProductId, productId));
            <span class="hljs-keyword">return</span> stock != <span class="hljs-literal">null</span> ? stock.<span class="hljs-title function_">getStockNum</span>() : <span class="hljs-number">0</span>;
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
            log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"查询库存失败，productId:{}"</span>, productId, e);
            <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
        }
    }
}
</code></pre>
<h3 data-id="heading-25">6. 死信队列配置（处理最终失败消息）</h3>
<pre><code class="hljs language-csharp" lang="csharp">@Configuration
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">RabbitDLQConfig</span> {

    <span class="hljs-comment">/**
     * 死信交换机
     */</span>
    @Bean
    <span class="hljs-function"><span class="hljs-keyword">public</span> DirectExchange <span class="hljs-title">dlqStockExchange</span>()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DirectExchange(<span class="hljs-string">"dlq.stock.exchange"</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);
    }

    <span class="hljs-comment">/**
     * 死信队列
     */</span>
    @Bean
    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">dlqStockQueue</span>()</span> {
        <span class="hljs-keyword">return</span> QueueBuilder.durable(<span class="hljs-string">"dlq.stock.queue"</span>).build();
    }

    <span class="hljs-comment">/**
     * 死信绑定（交换机→队列）
     */</span>
    @Bean
    <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">dlqStockBinding</span>()</span> {
        <span class="hljs-keyword">return</span> BindingBuilder.bind(dlqStockQueue())
                .to(dlqStockExchange())
                .<span class="hljs-keyword">with</span>(<span class="hljs-string">"dlq.stock.deduct"</span>); <span class="hljs-comment">// 和配置中的死信路由键一致</span>
    }
}
</code></pre>
<h3 data-id="heading-26">7. 全局异常处理与Result工具类</h3>
<p>和订单服务一致（复用公共的Result类和GlobalExceptionHandler）</p>
<hr/>
<h2 data-id="heading-27">六、第五步：测试验证（确保解决核心问题）</h2>
<h3 data-id="heading-28">1. 正常流程测试</h3>
<ul>
<li>
<p>调用订单服务接口：<code>http://localhost:8081/order/create?userId=1&amp;productId=1001&amp;quantity=10</code></p>
</li>
<li>
<p>预期结果：</p>
<ul>
<li>订单表新增一条记录，状态为1（待扣库存）；</li>
<li>LocalMessage表新增一条记录，状态为1（SEND），消费状态为0；</li>
<li>库存表中商品1001的库存从100变为90；</li>
<li>订单状态更新为2（已扣库存待支付）；</li>
<li>LocalMessage表的消费状态更新为1（已消费）。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-29">2. 库存不足场景测试</h3>
<ul>
<li>
<p>调用接口：<code>http://localhost:8081/order/create?userId=1&amp;productId=1001&amp;quantity=200</code>（库存仅90）</p>
</li>
<li>
<p>预期结果：</p>
<ul>
<li>订单创建成功（状态1）；</li>
<li>库存扣减失败（affectRows=0）；</li>
<li>订单状态更新为3（已取消）；</li>
<li>消息进入死信队列；</li>
<li>无超卖现象。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-30">3. 消息重复消费测试</h3>
<ul>
<li>手动在RabbitMQ中重发消息（模拟重复消费）；</li>
<li>预期结果：幂等性校验生效，库存不会重复扣减，日志提示“消息已消费，无需重复处理”。</li>
</ul>
<h3 data-id="heading-31">4. MQ宕机场景测试</h3>
<ul>
<li>
<p>停止RabbitMQ，调用订单创建接口；</p>
</li>
<li>
<p>预期结果：</p>
<ul>
<li>订单创建成功，LocalMessage表记录状态为0（READY）；</li>
<li>启动RabbitMQ后，定时任务扫描到未发送消息，自动重试发送；</li>
<li>库存扣减成功，最终一致性保障。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-32">七、总结</h2>
<ol>
<li>
<p>这套完整代码<strong>完全基于你的sendAckMessage方法扩展</strong>，完美支持跨服务场景，能彻底解决「订单创建+库存扣减」的核心问题（超卖、库存锁定不释放、消息丢失、重复扣减）；</p>
</li>
<li>
<p>核心保障：</p>
<ol>
<li>本地事务保证「订单创建+存消息」原子性；</li>
<li>事务提交后发消息，避免“消息已发但订单回滚”；</li>
<li>库存扣减SQL加行锁，避免超卖；</li>
<li>幂等性校验（messageId），避免重复消费；</li>
<li>定时重试+死信队列，应对各种异常场景；</li>
</ol>
</li>
<li>
<p>直接复用：代码可直接复制到项目中，只需修改数据库连接、服务端口等配置，即可快速落地；</p>
</li>
<li>
<p>扩展性：支持延迟发送（delaySeconds参数）、多商品扣减、分布式锁优化等高并发场景需求。</p>
</li>
</ol>
<p>如果需要优化高并发场景（如秒杀），或补充支付流程后的库存最终锁定逻辑，可以随时告诉我！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 权限修饰符（Access Modifiers）指南]]></title>    <link>https://juejin.cn/post/7578853751531536399</link>    <guid>https://juejin.cn/post/7578853751531536399</guid>    <pubDate>2025-12-02T09:36:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578853751531536399" data-draft-id="7578877638988922880" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 权限修饰符（Access Modifiers）指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-02T09:36:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小周在成长"/> <meta itemprop="url" content="https://juejin.cn/user/3632442150752573"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 权限修饰符（Access Modifiers）指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3632442150752573/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小周在成长
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T09:36:26.000Z" title="Tue Dec 02 2025 09:36:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">📊 权限修饰符总览</h2>













































<table><thead><tr><th>修饰符</th><th>同类</th><th>同包</th><th>子类（不同包）</th><th>不同包非子类</th><th>级别</th></tr></thead><tbody><tr><td><strong>private</strong></td><td>✅</td><td>❌</td><td>❌</td><td>❌</td><td>最严格</td></tr><tr><td><strong>默认</strong> (无修饰符)</td><td>✅</td><td>✅</td><td>❌</td><td>❌</td><td>包级别</td></tr><tr><td><strong>protected</strong></td><td>✅</td><td>✅</td><td>✅</td><td>❌</td><td>子类级别</td></tr><tr><td><strong>public</strong></td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>最宽松</td></tr></tbody></table>
<p><em>一般来说小编大多只使用private和public</em></p>
<h2 data-id="heading-1">🎯 四种权限修饰符详解</h2>
<h3 data-id="heading-2"><strong>1. private（私有访问）</strong></h3>
<h4 data-id="heading-3"><strong>特点</strong></h4>
<ul>
<li>只能在<strong>本类内部</strong>访问</li>
<li>最严格的访问控制</li>
<li>常用于封装，隐藏实现细节</li>
</ul>
<p>java</p>
<pre><code class="hljs language-typescript" lang="typescript">package com.<span class="hljs-property">example</span>;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrivateDemo</span> {
    <span class="hljs-comment">// 私有属性 - 只能在本类中访问</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> secret = <span class="hljs-string">"这是机密信息"</span>;
    <span class="hljs-keyword">private</span> int privateNumber = <span class="hljs-number">100</span>;
    
    <span class="hljs-comment">// 私有方法 - 只能在本类中调用</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">showSecret</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"机密信息: "</span> + secret);
    }
    
    <span class="hljs-comment">// 公共方法提供对私有属性的受控访问</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getSecret</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 可以添加验证逻辑</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">checkPermission</span>()) {
            <span class="hljs-keyword">return</span> secret;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-string">"无权访问"</span>;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setSecret</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> newSecret</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">validateSecret</span>(newSecret)) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">secret</span> = newSecret;
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">checkPermission</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 权限检查逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">validateSecret</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> secret</span>) {
        <span class="hljs-comment">// 验证逻辑</span>
        <span class="hljs-keyword">return</span> secret != <span class="hljs-literal">null</span> &amp;&amp; !secret.<span class="hljs-title function_">trim</span>().<span class="hljs-title function_">isEmpty</span>();
    }
    
    <span class="hljs-comment">// 在本类中可以自由访问私有成员</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">testAccess</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"在本类中访问:"</span>);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"直接访问私有属性: "</span> + secret);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"调用私有方法: "</span>);
        <span class="hljs-title function_">showSecret</span>();
        
        <span class="hljs-comment">// 修改私有属性</span>
        privateNumber = <span class="hljs-number">200</span>;
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"修改后: "</span> + privateNumber);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">PrivateDemo</span> demo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrivateDemo</span>();
        demo.<span class="hljs-title function_">testAccess</span>();
        
        <span class="hljs-comment">// 通过公共方法访问私有属性</span>
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"\n通过公共方法访问:"</span>);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"getSecret(): "</span> + demo.<span class="hljs-title function_">getSecret</span>());
        
        demo.<span class="hljs-title function_">setSecret</span>(<span class="hljs-string">"新的机密"</span>);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"修改后: "</span> + demo.<span class="hljs-title function_">getSecret</span>());
        
        <span class="hljs-comment">// ❌ 错误：不能直接访问私有成员</span>
        <span class="hljs-comment">// System.out.println(demo.secret);      // 编译错误</span>
        <span class="hljs-comment">// demo.showSecret();                   // 编译错误</span>
        <span class="hljs-comment">// demo.privateNumber = 300;            // 编译错误</span>
    }
}

<span class="hljs-comment">// 同包中的另一个类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SamePackageClass</span> {
    <span class="hljs-built_in">void</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">PrivateDemo</span> demo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrivateDemo</span>();
        
        <span class="hljs-comment">// ❌ 错误：同包其他类也不能访问private成员</span>
        <span class="hljs-comment">// System.out.println(demo.secret);      // 编译错误</span>
        <span class="hljs-comment">// demo.showSecret();                   // 编译错误</span>
        
        <span class="hljs-comment">// ✅ 正确：只能通过公共方法访问</span>
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(demo.<span class="hljs-title function_">getSecret</span>());
    }
}
</code></pre>
<h4 data-id="heading-4"><strong>private 在构造器中的应用</strong></h4>
<p>java</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Singleton</span> {
    <span class="hljs-comment">// 私有静态变量</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Singleton instance;
    
    <span class="hljs-comment">// 私有构造器 - 防止外部创建实例</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">Singleton</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"Singleton实例被创建"</span>);
    }
    
    <span class="hljs-comment">// 公共静态方法提供访问</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title">getInstance</span>()</span> {
        <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {
            instance = <span class="hljs-keyword">new</span> Singleton();
        }
        <span class="hljs-keyword">return</span> instance;
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">showMessage</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"Hello Singleton!"</span>);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        <span class="hljs-comment">// ❌ 错误：不能直接new</span>
        <span class="hljs-comment">// Singleton s = new Singleton();</span>
        
        <span class="hljs-comment">// ✅ 正确：通过静态方法获取</span>
        Singleton s1 = Singleton.getInstance();
        Singleton s2 = Singleton.getInstance();
        
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"s1 == s2: "</span> + (s1 == s2));  <span class="hljs-comment">// true</span>
        s1.showMessage();
    }
}
</code></pre>
<h3 data-id="heading-5"><strong>2. 默认/包私有（Default/Package-private）</strong></h3>
<h4 data-id="heading-6"><strong>特点</strong></h4>
<ul>
<li>没有明确指定修饰符</li>
<li>在<strong>同一个包内</strong>可以访问</li>
<li>也称为"包访问权限"或"包私有"</li>
</ul>
<p>java</p>
<pre><code class="hljs language-csharp" lang="csharp">package com.example;

<span class="hljs-comment">// 默认类：同包可见</span>
<span class="hljs-keyword">class</span> <span class="hljs-title">DefaultClass</span> {
    <span class="hljs-comment">// 默认属性：同包可见</span>
    String defaultField = <span class="hljs-string">"默认属性"</span>;
    
    <span class="hljs-comment">// 默认方法：同包可见</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">defaultMethod</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"默认方法"</span>);
    }
    
    <span class="hljs-comment">// 公共方法：所有地方可见</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">publicMethod</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"公共方法"</span>);
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DefaultModifierDemo</span> {
    <span class="hljs-comment">// 默认属性</span>
    String packagePrivateField = <span class="hljs-string">"包私有属性"</span>;
    
    <span class="hljs-comment">// 默认方法</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">packagePrivateMethod</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"包私有方法"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"可以访问: "</span> + packagePrivateField);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        DefaultModifierDemo demo = <span class="hljs-keyword">new</span> DefaultModifierDemo();
        
        <span class="hljs-comment">// 在本类中可以访问默认成员</span>
        demo.packagePrivateMethod();
        
        <span class="hljs-comment">// 在同包中访问另一个类的默认成员</span>
        DefaultClass obj = <span class="hljs-keyword">new</span> DefaultClass();
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"\n访问同包的DefaultClass:"</span>);
        System.<span class="hljs-keyword">out</span>.println(obj.defaultField);  <span class="hljs-comment">// ✅ 可以访问</span>
        obj.defaultMethod();                   <span class="hljs-comment">// ✅ 可以调用</span>
        obj.publicMethod();                    <span class="hljs-comment">// ✅ 可以调用</span>
    }
}

<span class="hljs-comment">// 同包中的另一个类</span>
package com.example;

<span class="hljs-keyword">class</span> <span class="hljs-title">AnotherClassInSamePackage</span> {
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span>()</span> {
        DefaultModifierDemo demo = <span class="hljs-keyword">new</span> DefaultModifierDemo();
        
        <span class="hljs-comment">// ✅ 正确：同包可以访问默认成员</span>
        System.<span class="hljs-keyword">out</span>.println(demo.packagePrivateField);
        demo.packagePrivateMethod();
        
        DefaultClass obj = <span class="hljs-keyword">new</span> DefaultClass();
        System.<span class="hljs-keyword">out</span>.println(obj.defaultField);
        obj.defaultMethod();
    }
}
</code></pre>
<h4 data-id="heading-7"><strong>不同包的情况</strong></h4>
<p>java</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 不同包中的类</span>
<span class="hljs-keyword">package</span> other;

<span class="hljs-keyword">import</span> com.example.DefaultModifierDemo;
<span class="hljs-keyword">import</span> com.example.DefaultClass;  <span class="hljs-comment">// ❌ 编译错误：DefaultClass不是public</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DifferentPackageClass</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> {
        <span class="hljs-type">DefaultModifierDemo</span> <span class="hljs-variable">demo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultModifierDemo</span>();
        
        <span class="hljs-comment">// ❌ 错误：不同包不能访问默认成员</span>
        <span class="hljs-comment">// System.out.println(demo.packagePrivateField);  // 编译错误</span>
        <span class="hljs-comment">// demo.packagePrivateMethod();                   // 编译错误</span>
        
        <span class="hljs-comment">// ✅ 正确：可以访问公共成员</span>
        <span class="hljs-comment">// demo.publicMethod();  // 如果有的话</span>
        
        <span class="hljs-comment">// ❌ 错误：不能访问默认类</span>
        <span class="hljs-comment">// DefaultClass obj = new DefaultClass();  // 编译错误</span>
    }
}
</code></pre>
<h3 data-id="heading-8"><strong>3. protected（受保护访问）</strong></h3>
<h4 data-id="heading-9"><strong>特点</strong></h4>
<ul>
<li>在<strong>同一个包内</strong>可以访问</li>
<li>在<strong>不同包的子类</strong>中可以访问</li>
<li>常用于允许子类访问父类的实现细节</li>
</ul>
<p>java</p>
<pre><code class="hljs language-csharp" lang="csharp">package com.<span class="hljs-keyword">base</span>;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Parent</span> {
    <span class="hljs-comment">// protected 属性</span>
    <span class="hljs-keyword">protected</span> String protectedField = <span class="hljs-string">"父类的protected属性"</span>;
    
    <span class="hljs-comment">// protected 方法</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">protectedMethod</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"父类的protected方法"</span>);
    }
    
    <span class="hljs-comment">// 默认属性（对比用）</span>
    String defaultField = <span class="hljs-string">"父类的默认属性"</span>;
    
    <span class="hljs-comment">// 公共方法</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">show</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"在本类中访问:"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"protectedField: "</span> + protectedField);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"defaultField: "</span> + defaultField);
        protectedMethod();
    }
}

<span class="hljs-comment">// 同包的子类</span>
package com.<span class="hljs-keyword">base</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title">SamePackageChild</span> <span class="hljs-title">extends</span> <span class="hljs-title">Parent</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"同包子类访问:"</span>);
        
        <span class="hljs-comment">// ✅ 可以访问 protected 成员</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"protectedField: "</span> + protectedField);
        protectedMethod();
        
        <span class="hljs-comment">// ✅ 可以访问默认成员（同包）</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"defaultField: "</span> + defaultField);
        
        <span class="hljs-comment">// 通过 super 访问</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"通过super访问: "</span> + super.protectedField);
        super.protectedMethod();
    }
}

<span class="hljs-comment">// 同包的非子类</span>
package com.<span class="hljs-keyword">base</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title">SamePackageNonChild</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span>()</span> {
        Parent parent = <span class="hljs-keyword">new</span> Parent();
        
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"同包非子类访问:"</span>);
        
        <span class="hljs-comment">// ✅ 可以访问 protected 成员（同包）</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"protectedField: "</span> + parent.protectedField);
        parent.protectedMethod();
        
        <span class="hljs-comment">// ✅ 可以访问默认成员（同包）</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"defaultField: "</span> + parent.defaultField);
    }
}
</code></pre>
<h4 data-id="heading-10"><strong>不同包子类的情况</strong></h4>
<p>java</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 不同包的子类</span>
<span class="hljs-keyword">package</span> com.derived;

<span class="hljs-keyword">import</span> com.base.Parent;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DifferentPackageChild</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Parent</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"不同包子类访问:"</span>);
        
        <span class="hljs-comment">// ✅ 可以访问 protected 成员（子类权限）</span>
        System.out.println(<span class="hljs-string">"protectedField: "</span> + protectedField);
        protectedMethod();
        
        <span class="hljs-comment">// 通过 super 访问</span>
        System.out.println(<span class="hljs-string">"通过super访问: "</span> + <span class="hljs-built_in">super</span>.protectedField);
        <span class="hljs-built_in">super</span>.protectedMethod();
        
        <span class="hljs-comment">// ❌ 错误：不能访问默认成员（不同包）</span>
        <span class="hljs-comment">// System.out.println(defaultField);  // 编译错误</span>
        
        <span class="hljs-comment">// ❌ 错误：不能通过父类实例访问 protected 成员</span>
        <span class="hljs-type">Parent</span> <span class="hljs-variable">parent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Parent</span>();
        <span class="hljs-comment">// System.out.println(parent.protectedField);  // 编译错误</span>
        <span class="hljs-comment">// parent.protectedMethod();                   // 编译错误</span>
        
        <span class="hljs-comment">// ✅ 正确：可以通过自身实例访问</span>
        <span class="hljs-type">DifferentPackageChild</span> <span class="hljs-variable">child</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DifferentPackageChild</span>();
        System.out.println(<span class="hljs-string">"通过子类实例: "</span> + child.protectedField);
        child.protectedMethod();
    }
}

<span class="hljs-comment">// 不同包的非子类</span>
<span class="hljs-keyword">package</span> com.derived;

<span class="hljs-keyword">import</span> com.base.Parent;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DifferentPackageNonChild</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Parent</span> <span class="hljs-variable">parent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Parent</span>();
        
        System.out.println(<span class="hljs-string">"不同包非子类访问:"</span>);
        
        <span class="hljs-comment">// ❌ 错误：不能访问 protected 成员</span>
        <span class="hljs-comment">// System.out.println(parent.protectedField);  // 编译错误</span>
        <span class="hljs-comment">// parent.protectedMethod();                   // 编译错误</span>
        
        <span class="hljs-comment">// ❌ 错误：不能访问默认成员</span>
        <span class="hljs-comment">// System.out.println(parent.defaultField);    // 编译错误</span>
        
        <span class="hljs-comment">// ✅ 正确：只能访问 public 成员</span>
        parent.show();  <span class="hljs-comment">// 如果有的话</span>
    }
}
</code></pre>
<h3 data-id="heading-11"><strong>4. public（公共访问）</strong></h3>
<h4 data-id="heading-12"><strong>特点</strong></h4>
<ul>
<li>在任何地方都可以访问</li>
<li>最宽松的访问控制</li>
<li>用于定义对外提供的接口</li>
</ul>
<p>java</p>
<pre><code class="hljs language-csharp" lang="csharp">package com.example;

<span class="hljs-comment">// public 类：所有地方可见</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PublicDemo</span> {
    <span class="hljs-comment">// public 属性：所有地方可见</span>
    <span class="hljs-keyword">public</span> String publicField = <span class="hljs-string">"公共属性"</span>;
    
    <span class="hljs-comment">// public 方法：所有地方可见</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">publicMethod</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"公共方法"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"可以访问: "</span> + publicField);
    }
    
    <span class="hljs-comment">// 其他权限的方法</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">protectedMethod</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"受保护方法"</span>);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">defaultMethod</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"默认方法"</span>);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">privateMethod</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"私有方法"</span>);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        PublicDemo demo = <span class="hljs-keyword">new</span> PublicDemo();
        
        <span class="hljs-comment">// 在本类中可以访问所有权限的成员</span>
        demo.publicMethod();
        demo.protectedMethod();
        demo.defaultMethod();
        demo.privateMethod();
    }
}

<span class="hljs-comment">// 同包的另一个类</span>
package com.example;

<span class="hljs-keyword">class</span> <span class="hljs-title">SamePackageClass</span> {
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span>()</span> {
        PublicDemo demo = <span class="hljs-keyword">new</span> PublicDemo();
        
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"同包访问:"</span>);
        
        <span class="hljs-comment">// ✅ 可以访问 public 成员</span>
        System.<span class="hljs-keyword">out</span>.println(demo.publicField);
        demo.publicMethod();
        
        <span class="hljs-comment">// ✅ 可以访问 protected 成员（同包）</span>
        demo.protectedMethod();
        
        <span class="hljs-comment">// ✅ 可以访问默认成员（同包）</span>
        demo.defaultMethod();
        
        <span class="hljs-comment">// ❌ 不能访问 private 成员</span>
        <span class="hljs-comment">// demo.privateMethod();  // 编译错误</span>
    }
}
</code></pre>
<h4 data-id="heading-13"><strong>不同包的情况</strong></h4>
<p>java</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 不同包中的类</span>
package other;

import com.example.PublicDemo;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DifferentPackageClass</span> {
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span>()</span> {
        PublicDemo demo = <span class="hljs-keyword">new</span> PublicDemo();
        
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"不同包访问:"</span>);
        
        <span class="hljs-comment">// ✅ 可以访问 public 成员</span>
        System.<span class="hljs-keyword">out</span>.println(demo.publicField);
        demo.publicMethod();
        
        <span class="hljs-comment">// ❌ 不能访问 protected 成员（不同包非子类）</span>
        <span class="hljs-comment">// demo.protectedMethod();  // 编译错误</span>
        
        <span class="hljs-comment">// ❌ 不能访问默认成员（不同包）</span>
        <span class="hljs-comment">// demo.defaultMethod();    // 编译错误</span>
        
        <span class="hljs-comment">// ❌ 不能访问 private 成员</span>
        <span class="hljs-comment">// demo.privateMethod();    // 编译错误</span>
    }
}
</code></pre>
<h2 data-id="heading-14">🏗️ 权限修饰符的应用场景</h2>
<h3 data-id="heading-15"><strong>1. 封装：数据隐藏</strong></h3>
<p>java</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 银行账户类 - 使用封装保护数据</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BankAccount</span> {
    <span class="hljs-comment">// 私有属性：外部不能直接访问</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> accountNumber;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> accountHolder;
    <span class="hljs-keyword">private</span> double balance;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> password;
    
    <span class="hljs-comment">// 公共构造器</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">BankAccount</span>(<span class="hljs-title class_">String</span> accountNumber, <span class="hljs-title class_">String</span> accountHolder, 
                      <span class="hljs-title class_">String</span> password, double initialBalance) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">accountNumber</span> = accountNumber;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">accountHolder</span> = accountHolder;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">password</span> = password;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">balance</span> = initialBalance;
    }
    
    <span class="hljs-comment">// 公共方法：提供受控的访问</span>
    
    <span class="hljs-comment">// Getter 方法（只读）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getAccountNumber</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> accountNumber;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getAccountHolder</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> accountHolder;
    }
    
    <span class="hljs-keyword">public</span> double <span class="hljs-title function_">getBalance</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> balance;
    }
    
    <span class="hljs-comment">// 没有 password 的 Getter（安全考虑）</span>
    
    <span class="hljs-comment">// Setter 方法（有验证）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setAccountHolder</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> accountHolder</span>) {
        <span class="hljs-keyword">if</span> (accountHolder != <span class="hljs-literal">null</span> &amp;&amp; !accountHolder.<span class="hljs-title function_">trim</span>().<span class="hljs-title function_">isEmpty</span>()) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">accountHolder</span> = accountHolder;
        }
    }
    
    <span class="hljs-comment">// 业务方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">deposit</span>(<span class="hljs-params">double amount</span>) {
        <span class="hljs-keyword">if</span> (amount &gt; <span class="hljs-number">0</span>) {
            balance += amount;
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">withdraw</span>(<span class="hljs-params">double amount, <span class="hljs-built_in">String</span> password</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">authenticate</span>(password) &amp;&amp; amount &gt; <span class="hljs-number">0</span> &amp;&amp; amount &lt;= balance) {
            balance -= amount;
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-comment">// 私有方法：内部使用</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">authenticate</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> inputPassword</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">password</span>.<span class="hljs-title function_">equals</span>(inputPassword);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">logTransaction</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> <span class="hljs-keyword">type</span>, double amount</span>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"交易记录: "</span> + <span class="hljs-keyword">type</span> + <span class="hljs-string">" $"</span> + amount);
    }
    
    <span class="hljs-comment">// 受保护方法：给子类扩展用</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">applyFee</span>(<span class="hljs-params">double fee</span>) {
        <span class="hljs-keyword">if</span> (fee &gt; <span class="hljs-number">0</span> &amp;&amp; balance &gt;= fee) {
            balance -= fee;
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">BankAccount</span> account = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BankAccount</span>(<span class="hljs-string">"123456"</span>, <span class="hljs-string">"张三"</span>, <span class="hljs-string">"123456"</span>, <span class="hljs-number">1000</span>);
        
        <span class="hljs-comment">// ✅ 正确：通过公共方法访问</span>
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"账户: "</span> + account.<span class="hljs-title function_">getAccountNumber</span>());
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"余额: $"</span> + account.<span class="hljs-title function_">getBalance</span>());
        
        account.<span class="hljs-title function_">deposit</span>(<span class="hljs-number">500</span>);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"存款后余额: $"</span> + account.<span class="hljs-title function_">getBalance</span>());
        
        <span class="hljs-built_in">boolean</span> success = account.<span class="hljs-title function_">withdraw</span>(<span class="hljs-number">200</span>, <span class="hljs-string">"123456"</span>);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"取款"</span> + (success ? <span class="hljs-string">"成功"</span> : <span class="hljs-string">"失败"</span>));
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"取款后余额: $"</span> + account.<span class="hljs-title function_">getBalance</span>());
        
        <span class="hljs-comment">// ❌ 错误：不能直接访问私有属性</span>
        <span class="hljs-comment">// System.out.println(account.balance);      // 编译错误</span>
        <span class="hljs-comment">// account.balance = 10000;                 // 编译错误</span>
        <span class="hljs-comment">// System.out.println(account.password);    // 编译错误</span>
    }
}
</code></pre>
<h3 data-id="heading-16"><strong>2. 继承框架设计</strong></h3>
<p>java</p>
<pre><code class="hljs language-csharp" lang="csharp">package framework;

<span class="hljs-comment">// 框架基类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">BaseService</span> {
    <span class="hljs-comment">// 公共方法：对外接口</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> final <span class="hljs-keyword">void</span> <span class="hljs-title">execute</span>()</span> {
        initialize();
        process();
        cleanup();
    }
    
    <span class="hljs-comment">// 受保护方法：子类必须实现或可以重写</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initialize</span>()</span>;
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">process</span>()</span>;
    
    <span class="hljs-comment">// 受保护方法：子类可以重写</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">cleanup</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"执行清理工作..."</span>);
    }
    
    <span class="hljs-comment">// 私有方法：内部实现细节</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">log</span>(<span class="hljs-params">String message</span>)</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"[LOG] "</span> + message);
    }
    
    <span class="hljs-comment">// 默认方法：同包的工具方法</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">internalHelper</span>()</span> {
        log(<span class="hljs-string">"内部辅助方法"</span>);
    }
}

<span class="hljs-comment">// 同包的工具类</span>
package framework;

<span class="hljs-keyword">class</span> <span class="hljs-title">ServiceValidator</span> {
    <span class="hljs-comment">// 默认方法：同包内使用</span>
    <span class="hljs-function"><span class="hljs-keyword">static</span> boolean <span class="hljs-title">validate</span>(<span class="hljs-params">BaseService service</span>)</span> {
        <span class="hljs-comment">// 可以访问 service.internalHelper()（同包）</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<p>java</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 用户实现类（不同包）</span>
package userapp;

<span class="hljs-keyword">import</span> framework.<span class="hljs-property">BaseService</span>;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">BaseService</span> {
    <span class="hljs-comment">// 实现抽象方法</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">initialize</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"用户服务初始化"</span>);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">process</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"处理用户请求"</span>);
    }
    
    <span class="hljs-comment">// 可以重写 cleanup 方法</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">cleanup</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">cleanup</span>();  <span class="hljs-comment">// 调用父类方法</span>
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"额外的清理工作"</span>);
    }
    
    <span class="hljs-comment">// 不能访问父类的私有方法</span>
    <span class="hljs-comment">// private void tryAccess() {</span>
    <span class="hljs-comment">//     log("测试");  // 编译错误：不能访问父类的private方法</span>
    <span class="hljs-comment">// }</span>
    
    <span class="hljs-comment">// 不能访问父类的默认方法（不同包）</span>
    <span class="hljs-comment">// void tryInternal() {</span>
    <span class="hljs-comment">//     internalHelper();  // 编译错误：不同包不能访问默认方法</span>
    <span class="hljs-comment">// }</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">UserService</span> service = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserService</span>();
        service.<span class="hljs-title function_">execute</span>();
    }
}
</code></pre>
<h3 data-id="heading-17"><strong>3. 常量定义</strong></h3>
<p>java</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 常量类设计</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Constants</span> {
    <span class="hljs-comment">// 私有构造器：防止实例化</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">Constants</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">AssertionError</span>(<span class="hljs-string">"不能实例化常量类"</span>);
    }
    
    <span class="hljs-comment">// 公共常量：所有地方可用</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> APP_NAME = <span class="hljs-string">"MyApplication"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">double</span> PI = <span class="hljs-number">3.141592653589793</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> MAX_RETRY_COUNT = <span class="hljs-number">3</span>;
    
    <span class="hljs-comment">// 受保护常量：子类可用</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> DEFAULT_ENCODING = <span class="hljs-string">"UTF-8"</span>;
    
    <span class="hljs-comment">// 默认常量：同包可用</span>
    <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> CONFIG_FILE = <span class="hljs-string">"app.properties"</span>;
    
    <span class="hljs-comment">// 私有常量：仅本类可用</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> SECRET_KEY = <span class="hljs-string">"secret123"</span>;
    
    <span class="hljs-comment">// 公共方法使用常量</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">String</span> <span class="hljs-title">getSecretHash</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">hash</span>(SECRET_KEY);  <span class="hljs-comment">// 可以访问私有常量</span>
    }
    
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-type">static</span> <span class="hljs-type">String</span> <span class="hljs-title">hash</span><span class="hljs-params">(<span class="hljs-type">String</span> input)</span> </span>{
        <span class="hljs-comment">// 哈希计算</span>
        <span class="hljs-keyword">return</span> input + <span class="hljs-string">"_hashed"</span>;
    }
    
    <span class="hljs-comment">// 同包辅助方法</span>
    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">String</span> <span class="hljs-title">getConfigPath</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> CONFIG_FILE;  <span class="hljs-comment">// 可以访问默认常量</span>
    }
}

<span class="hljs-comment">// 使用常量</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConstantUsage</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">String</span>[] args)</span> </span>{
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"应用名称: "</span> + Constants.APP_NAME);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"PI值: "</span> + Constants.PI);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"最大重试次数: "</span> + Constants.MAX_RETRY_COUNT);
        
        <span class="hljs-comment">// 访问公共方法</span>
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"密钥哈希: "</span> + Constants.<span class="hljs-built_in">getSecretHash</span>());
        
        <span class="hljs-comment">// ❌ 错误：不能访问受保护常量（不是子类）</span>
        <span class="hljs-comment">// System.out.println(Constants.DEFAULT_ENCODING);</span>
        
        <span class="hljs-comment">// ❌ 错误：不能访问默认常量（不同包）</span>
        <span class="hljs-comment">// System.out.println(Constants.CONFIG_FILE);</span>
        
        <span class="hljs-comment">// ❌ 错误：不能访问私有常量</span>
        <span class="hljs-comment">// System.out.println(Constants.SECRET_KEY);</span>
    }
}
</code></pre>
<h2 data-id="heading-18">⚠️ 权限修饰符的注意事项</h2>
<h3 data-id="heading-19"><strong>1. 类级别的访问控制</strong></h3>
<p>java</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 公共类：所有地方可见（文件名必须与类名相同）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PublicClass</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">show</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"公共类"</span>);
    }
}

<span class="hljs-comment">// 默认类：同包可见</span>
<span class="hljs-keyword">class</span> <span class="hljs-title">DefaultClass</span> {
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">show</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"默认类"</span>);
    }
}

<span class="hljs-comment">// 错误：一个文件只能有一个公共类，且必须与文件名相同</span>
<span class="hljs-comment">/*
public class AnotherPublicClass {  // 编译错误
}
*/</span>

<span class="hljs-comment">// 内部类可以是任何访问级别</span>
<span class="hljs-keyword">class</span> <span class="hljs-title">Outer</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PublicInner</span> {}
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ProtectedInner</span> {}
    <span class="hljs-keyword">class</span> <span class="hljs-title">DefaultInner</span> {}
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PrivateInner</span> {}
}

<span class="hljs-comment">// 测试</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ClassLevelAccess</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        PublicClass pc = <span class="hljs-keyword">new</span> PublicClass();
        pc.show();
        
        <span class="hljs-comment">// 同包可以访问默认类</span>
        DefaultClass dc = <span class="hljs-keyword">new</span> DefaultClass();
        dc.show();
        
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"\n类访问规则:"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"1. 一个.java文件只能有一个public类"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"2. public类名必须与文件名相同"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"3. 可以有多个默认类"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"4. 内部类可以是任何访问级别"</span>);
    }
}
</code></pre>
<h3 data-id="heading-20"><strong>2. 接口成员的访问权限</strong></h3>
<p>java</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 接口中的成员默认都是 public</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">MyInterface</span> {
    <span class="hljs-comment">// 常量默认是 public static final</span>
    String CONSTANT = <span class="hljs-string">"接口常量"</span>;  <span class="hljs-comment">// 等价于 public static final</span>
    
    <span class="hljs-comment">// 方法默认是 public abstract</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">doSomething</span>()</span>;  <span class="hljs-comment">// 等价于 public abstract void doSomething()</span>
    
    <span class="hljs-comment">// Java 8+：默认方法</span>
    <span class="hljs-function"><span class="hljs-literal">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title">defaultMethod</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"默认方法"</span>);
    }
    
    <span class="hljs-comment">// Java 8+：静态方法</span>
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">staticMethod</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"静态方法"</span>);
    }
    
    <span class="hljs-comment">// ❌ 错误：不能使用private（Java 9+可以）</span>
    <span class="hljs-comment">// private void privateMethod();  // Java 8编译错误</span>
    
    <span class="hljs-comment">// ❌ 错误：不能使用protected</span>
    <span class="hljs-comment">// protected void protectedMethod();  // 编译错误</span>
}

<span class="hljs-comment">// 实现接口</span>
<span class="hljs-keyword">class</span> <span class="hljs-title">MyImplementation</span> <span class="hljs-title">implements</span> <span class="hljs-title">MyInterface</span> {
    <span class="hljs-comment">// 必须使用public重写（不能更严格）</span>
    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doSomething</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"实现接口方法"</span>);
    }
    
    <span class="hljs-comment">// 可以重写默认方法（可选）</span>
    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">defaultMethod</span>()</span> {
        MyInterface.super.defaultMethod();  <span class="hljs-comment">// 调用接口的默认方法</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"重写的默认方法"</span>);
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">InterfaceAccess</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        MyInterface.staticMethod();  <span class="hljs-comment">// 调用接口静态方法</span>
        
        MyImplementation impl = <span class="hljs-keyword">new</span> MyImplementation();
        impl.doSomething();
        impl.defaultMethod();
        
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"常量: "</span> + MyInterface.CONSTANT);
    }
}
</code></pre>
<h3 data-id="heading-21"><strong>3. 构造器的访问权限</strong></h3>
<p>java</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ConstructorAccess</span> {
    <span class="hljs-comment">// 公共构造器：所有地方可以创建对象</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ConstructorAccess</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"公共构造器"</span>);
    }
    
    <span class="hljs-comment">// 受保护构造器：同包或子类可以创建对象</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-title">ConstructorAccess</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> a</span>)</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"受保护构造器: "</span> + a);
    }
    
    <span class="hljs-comment">// 默认构造器：同包可以创建对象</span>
    ConstructorAccess(String s) {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"默认构造器: "</span> + s);
    }
    
    <span class="hljs-comment">// 私有构造器：只能在本类中创建对象</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">ConstructorAccess</span>(<span class="hljs-params">boolean b</span>)</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"私有构造器: "</span> + b);
    }
    
    <span class="hljs-comment">// 静态工厂方法访问私有构造器</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ConstructorAccess <span class="hljs-title">createPrivateInstance</span>()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ConstructorAccess(<span class="hljs-literal">true</span>);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        <span class="hljs-comment">// 本类中可以访问所有构造器</span>
        <span class="hljs-keyword">new</span> ConstructorAccess();           <span class="hljs-comment">// public</span>
        <span class="hljs-keyword">new</span> ConstructorAccess(<span class="hljs-number">10</span>);         <span class="hljs-comment">// protected</span>
        <span class="hljs-keyword">new</span> ConstructorAccess(<span class="hljs-string">"test"</span>);     <span class="hljs-comment">// default</span>
        <span class="hljs-keyword">new</span> ConstructorAccess(<span class="hljs-literal">true</span>);       <span class="hljs-comment">// private</span>
        
        <span class="hljs-comment">// 工厂方法</span>
        ConstructorAccess.createPrivateInstance();
    }
}

<span class="hljs-comment">// 同包的其他类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title">SamePackageClass</span> {
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span>()</span> {
        <span class="hljs-keyword">new</span> ConstructorAccess();           <span class="hljs-comment">// ✅ public</span>
        <span class="hljs-keyword">new</span> ConstructorAccess(<span class="hljs-number">20</span>);         <span class="hljs-comment">// ✅ protected（同包）</span>
        <span class="hljs-keyword">new</span> ConstructorAccess(<span class="hljs-string">"hello"</span>);    <span class="hljs-comment">// ✅ default（同包）</span>
        <span class="hljs-comment">// new ConstructorAccess(true);    // ❌ private</span>
    }
}

<span class="hljs-comment">// 不同包子类</span>
package other;

import ConstructorAccess;

<span class="hljs-keyword">class</span> <span class="hljs-title">DifferentPackageChild</span> <span class="hljs-title">extends</span> <span class="hljs-title">ConstructorAccess</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DifferentPackageChild</span>()</span> {
        super(<span class="hljs-number">30</span>);  <span class="hljs-comment">// ✅ 可以调用protected构造器（子类）</span>
        <span class="hljs-comment">// super("test");  // ❌ 不能调用default构造器（不同包）</span>
    }
    
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span>()</span> {
        <span class="hljs-comment">// new ConstructorAccess(40);  // ❌ 不能直接调用（需要是子类构造器中）</span>
    }
}

<span class="hljs-comment">// 不同包非子类</span>
package other;

import ConstructorAccess;

<span class="hljs-keyword">class</span> <span class="hljs-title">DifferentPackageNonChild</span> {
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span>()</span> {
        <span class="hljs-keyword">new</span> ConstructorAccess();           <span class="hljs-comment">// ✅ public</span>
        <span class="hljs-comment">// new ConstructorAccess(50);      // ❌ protected</span>
        <span class="hljs-comment">// new ConstructorAccess("test");  // ❌ default</span>
        <span class="hljs-comment">// new ConstructorAccess(true);    // ❌ private</span>
    }
}
</code></pre>
<h2 data-id="heading-22">💡 权限修饰符最佳实践</h2>
<h3 data-id="heading-23"><strong>1. 最小权限原则</strong></h3>
<p>java</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 遵循最小权限原则：只暴露必要的内容</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Employee</span> {
    <span class="hljs-comment">// 私有属性：隐藏实现细节</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> id;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> name;
    <span class="hljs-keyword">private</span> double salary;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> ssn;  <span class="hljs-comment">// 社保号（敏感信息）</span>
    
    <span class="hljs-comment">// 公共构造器：允许创建对象</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Employee</span>(<span class="hljs-title class_">String</span> id, <span class="hljs-title class_">String</span> name) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">salary</span> = <span class="hljs-number">0.0</span>;
    }
    
    <span class="hljs-comment">// 公共getter：只读访问</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getId</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> id;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getName</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> name;
    }
    
    <span class="hljs-keyword">public</span> double <span class="hljs-title function_">getSalary</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> salary;
    }
    
    <span class="hljs-comment">// 受保护setter：允许子类或同包修改</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setSalary</span>(<span class="hljs-params">double salary</span>) {
        <span class="hljs-keyword">if</span> (salary &gt;= <span class="hljs-number">0</span>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">salary</span> = salary;
        }
    }
    
    <span class="hljs-comment">// 默认方法：同包工具方法</span>
    <span class="hljs-built_in">void</span> <span class="hljs-title function_">internalUpdate</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> newName</span>) {
        <span class="hljs-keyword">if</span> (newName != <span class="hljs-literal">null</span> &amp;&amp; newName.<span class="hljs-title function_">length</span>() &gt;= <span class="hljs-number">2</span>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = newName;
        }
    }
    
    <span class="hljs-comment">// 私有方法：内部逻辑</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">calculateBonus</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 奖金计算逻辑</span>
    }
    
    <span class="hljs-comment">// 没有提供ssn的getter/setter（安全考虑）</span>
}

<span class="hljs-comment">// 管理者类（需要修改工资）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Manager</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Employee</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Manager</span>(<span class="hljs-title class_">String</span> id, <span class="hljs-title class_">String</span> name) {
        <span class="hljs-variable language_">super</span>(id, name);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">adjustSalary</span>(<span class="hljs-params">Employee emp, double newSalary</span>) {
        <span class="hljs-comment">// 可以调用受保护方法</span>
        emp.<span class="hljs-title function_">setSalary</span>(newSalary);
    }
}
</code></pre>
<h3 data-id="heading-24"><strong>2. 模块化设计</strong></h3>
<p>java</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 包结构示例：</span>
<span class="hljs-comment">// com.company</span>
<span class="hljs-comment">//   ├── api          (公共API)</span>
<span class="hljs-comment">//   ├── impl         (实现，包私有)</span>
<span class="hljs-comment">//   ├── internal     (内部实现，包私有)</span>
<span class="hljs-comment">//   └── util         (工具类)</span>

<span class="hljs-comment">// api包：公共接口</span>
<span class="hljs-keyword">package</span> com.company.api;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserService</span> {
    User <span class="hljs-title function_">getUser</span><span class="hljs-params">(String id)</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveUser</span><span class="hljs-params">(User user)</span>;
}

<span class="hljs-comment">// impl包：实现（包私有）</span>
<span class="hljs-keyword">package</span> com.company.impl;

<span class="hljs-keyword">import</span> com.company.api.UserService;
<span class="hljs-keyword">import</span> com.company.internal.UserValidator;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">UserValidator</span> <span class="hljs-variable">validator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserValidator</span>();
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">(String id)</span> {
        <span class="hljs-comment">// 实现...</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-keyword">if</span> (validator.validate(user)) {
            <span class="hljs-comment">// 保存逻辑</span>
        }
    }
}

<span class="hljs-comment">// internal包：内部工具（包私有）</span>
<span class="hljs-keyword">package</span> com.company.internal;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserValidator</span> {
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">validate</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-comment">// 验证逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}

<span class="hljs-comment">// 公共工厂</span>
<span class="hljs-keyword">package</span> com.company;

<span class="hljs-keyword">import</span> com.company.api.UserService;
<span class="hljs-keyword">import</span> com.company.impl.UserServiceImpl;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceFactory</span> {
    <span class="hljs-comment">// 公共方法返回接口类型，隐藏实现</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> UserService <span class="hljs-title function_">createUserService</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceImpl</span>();
    }
}
</code></pre>
<h2 data-id="heading-25">📊 权限修饰符选择指南</h2>
<h3 data-id="heading-26"><strong>选择流程图</strong></h3>
<p>text</p>
<pre><code class="hljs language-arduino" lang="arduino">开始
  ↓
需要从外部访问吗？
  ├─ 否 → 使用 <span class="hljs-keyword">private</span>
  ↓
需要被子类访问吗？
  ├─ 否 → 需要同包访问吗？
  │      ├─ 是 → 使用 默认
  │      ↓
  │     否 → 使用 <span class="hljs-keyword">public</span>
  ↓
是 → 需要不同包子类访问吗？
        ├─ 是 → 使用 <span class="hljs-keyword">protected</span>
        ↓
       否 → 使用 默认
</code></pre>
<h3 data-id="heading-27"><strong>决策表格</strong></h3>


















































<table><thead><tr><th>场景</th><th>推荐修饰符</th><th>示例</th></tr></thead><tbody><tr><td><strong>数据字段</strong></td><td>private</td><td><code>private String name;</code></td></tr><tr><td><strong>常量</strong></td><td>public static final</td><td><code>public static final PI = 3.14;</code></td></tr><tr><td><strong>工具方法</strong></td><td>private</td><td><code>private void validate()</code></td></tr><tr><td><strong>模板方法</strong></td><td>protected</td><td><code>protected void initialize()</code></td></tr><tr><td><strong>接口方法</strong></td><td>public</td><td><code>public void save()</code></td></tr><tr><td><strong>构造器</strong></td><td>public / private</td><td><code>public User()</code> / 单例模式</td></tr><tr><td><strong>内部类</strong></td><td>private</td><td><code>private class Node</code></td></tr><tr><td><strong>测试钩子</strong></td><td>protected</td><td><code>protected void setUp()</code></td></tr></tbody></table>
<h2 data-id="heading-28">🎓 总结要点</h2>
<ol>
<li><strong>private</strong>：严格封装，仅本类可见</li>
<li><strong>默认</strong>：包级别封装，同包可见</li>
<li><strong>protected</strong>：继承友好，同包+子类可见</li>
<li><strong>public</strong>：完全开放，所有地方可见</li>
</ol>
<p><strong>核心原则</strong>：</p>
<ul>
<li><strong>最小权限原则</strong>：只开放必要的访问权限</li>
<li><strong>封装变化</strong>：使用private隐藏实现细节</li>
<li><strong>面向接口</strong>：通过public方法提供稳定接口</li>
<li><strong>继承设计</strong>：protected用于设计可扩展的框架</li>
<li><strong>包组织</strong>：合理使用包和默认权限管理模块</li>
</ul>
<p>记住：<strong>良好的访问控制是高质量代码的基础</strong>！合理的权限设置可以提高代码的安全性、可维护性和可扩展性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3 - runtime-core的渲染器初始化流程]]></title>    <link>https://juejin.cn/post/7578892205291290664</link>    <guid>https://juejin.cn/post/7578892205291290664</guid>    <pubDate>2025-12-02T09:42:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578892205291290664" data-draft-id="7565100253037969460" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3 - runtime-core的渲染器初始化流程"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-12-02T09:42:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="7ayl"/> <meta itemprop="url" content="https://juejin.cn/user/2637046159511018"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3 - runtime-core的渲染器初始化流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2637046159511018/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    7ayl
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T09:42:47.000Z" title="Tue Dec 02 2025 09:42:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在创建一个 Vue 3 项目时，通常会看到三个核心文件：
main.js:应用入口
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d56166750b3643f9a6a066f76cfdbc0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgN2F5bA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273367&amp;x-signature=hZh0S%2FS1zvYXCy51G9XqhJxn0uM%3D" alt="image.png" loading="lazy"/>
index.html:页面入口
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7040adc0a1ad4c1b9e783b73bf80bf7f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgN2F5bA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273367&amp;x-signature=33Qlf6rLljcgGkQqjJ4p5pnRJto%3D" alt="image.png" loading="lazy"/>
App.vue: 根组件
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ada39e9fd17f48b09cc6ff81d51e91c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgN2F5bA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273367&amp;x-signature=Wqz2cxC4FlMC1lrKA1bwAQUu4KI%3D" alt="image.png" loading="lazy"/>
本文将以这三个文件为例，简述 Vue 应用的初始化流程</p>
<h2 data-id="heading-1">流程</h2>
<p>在 main.js 中，我们导入了 <code>createApp</code> 函数和根组件 <code>App.vue</code></p>
<h4 data-id="heading-2">一、从入口开始：createApp 与 mount</h4>
<p><code>createApp(App).mount('#app')</code></p>
<p>createApp(App)调用createApp传入根组件，生成它专属的mount方法</p>
<p>.mount('#app')让createApp(App)这个应用实例挂载到根容器（id为app的盒子），</p>
<ul>
<li>mount函数内部<strong>会基于根组件App.vue生成一个虚拟节点vnode</strong></li>
<li>再<strong>调用render函数</strong>进行渲染，负责将虚拟DOM渲染到真实DOM
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94ab61f6d138403f8e79ed7c838c1c1f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgN2F5bA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273367&amp;x-signature=2EnbM6mpqEa5f6l93JsYNk4B%2F7A%3D" alt="image.png" loading="lazy"/></li>
</ul>
<h4 data-id="heading-3">二、创建虚拟节点：vnode 的结构</h4>
<p>基于根组件来创建虚拟节点vnode</p>
<p>创建出来的虚拟节点vnode属性如下：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22c9bd792b6e483db7a84d661f8a623e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgN2F5bA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273367&amp;x-signature=dfuSYcpblZ8R%2B8uPGAMQvr4qh8c%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-4">三、渲染入口：render 与 patch</h4>
<p>调用 render 函数</p>
<blockquote>
<ol>
<li>render函数只是一个渲染器的入口，负责接收接收虚拟节点和容器，开启渲染过程</li>
</ol>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcb2ad920c744ceb92d89d6bbd554c6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgN2F5bA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273367&amp;x-signature=JH5iFZdSu2r6qY6bKb4RfSmjlxs%3D" alt="image.png" loading="lazy"/></p>
<p>可以看见render函数内部也主要是调用patch函数，</p>
<blockquote>
<ol start="2">
<li>patch()主要会根据vnode.type以及shapeFlag去判断节点属于什么类型，进而调用相应类型的处理方法processxxxx()</li>
</ol>
</blockquote>
<p>这里App是组件类型，所以用processComponent处理</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e345a3aba4c4ef3a49e0b8aa4990516~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgN2F5bA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273367&amp;x-signature=XzVEBMvQGB241fLo10kLnx3tets%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-5">四、处理组件：processComponent 与 mountComponent</h4>
<blockquote>
<ol start="3">
<li>不管是什么类型的节点，都会在这个时候判断，这个节点之前是否存在，是选择初始化节点mountxxx()，还是更新节点</li>
</ol>
</blockquote>
<p>由于这是组件首次渲染，调用patch传下来的第一个参数应该是null，即没有n1，</p>
<p>所以到达processComponent之后，会先进行mountComponent</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10155a2bc7ed49a9bd609747a8657305~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgN2F5bA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273367&amp;x-signature=4nwdGBYHG9VRr0CdsD5DolIzWUI%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-6">五、组件实例的创建与设置</h4>
<blockquote>
<ol start="4">
<li>然后进行相应的流程 mountxxx()/更新节点</li>
</ol>
</blockquote>
<p>mountComponent会先去创建 component instance对象，再调用setupComponent设置组件实例，最后调用setupRenderEffect设置渲染效果。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/219d8e710a034c5c993d335ef555e016~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgN2F5bA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273367&amp;x-signature=M83w0EdC5UiNH4CfSwuiLvH9Z0s%3D" alt="image.png" loading="lazy"/></p>
<p>ps：也是可以粗略的看看instance对象的属性
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59f08a72d83a4e42b3fc57f46f2293df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgN2F5bA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273367&amp;x-signature=UDVbQgu6GL%2FVz2%2BjikjV%2FxNjgTo%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Swift ——详解Any、AnyObject、 AnyClass]]></title>    <link>https://juejin.cn/post/7578922565210226715</link>    <guid>https://juejin.cn/post/7578922565210226715</guid>    <pubDate>2025-12-02T09:36:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578922565210226715" data-draft-id="7578876665696092169" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Swift ——详解Any、AnyObject、 AnyClass "/> <meta itemprop="keywords" content="iOS,Swift"/> <meta itemprop="datePublished" content="2025-12-02T09:36:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Haha_bj"/> <meta itemprop="url" content="https://juejin.cn/user/2612027844214647"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Swift ——详解Any、AnyObject、 AnyClass 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612027844214647/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Haha_bj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T09:36:18.000Z" title="Tue Dec 02 2025 09:36:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Swift 中，<code>Any</code>、<code>AnyObject</code>、 <code>AnyClass</code> 是三个不同的类型，它们用于不同的场景，代表了不同的类型和用途。</p>
<h2 data-id="heading-0">一、Any</h2>
<p><code>Any</code> 是 Swift 中可以表示任何类型的类型，包含所有类型的实例。它可以是一个普通的类型、结构体、类、元组、函数、枚举，甚至是一个 <code>Optional</code> 类型的值。</p>
<ul>
<li><code>Any</code> 可以表示任何类型的实例。</li>
<li>它是一个广泛的类型，几乎可以存放任何类型的值。</li>
<li>使用时需要进行类型转换（Type Casting）才能访问原本的类型。</li>
</ul>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-comment">// 例</span>
     <span class="hljs-keyword">var</span> a : <span class="hljs-keyword">Any</span> <span class="hljs-operator">=</span> <span class="hljs-number">20</span>
     a <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
     a <span class="hljs-operator">=</span> <span class="hljs-number">3.2</span>
     a <span class="hljs-operator">=</span> [<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>]
     a <span class="hljs-operator">=</span> <span class="hljs-type">NSObject</span>()
     <span class="hljs-built_in">print</span>(a)
</code></pre>
<h2 data-id="heading-1">二、AnyObject</h2>
<p><code>AnyObject</code>  是Any的子集， AnyObject是Swift 中表示<strong>所有类类型</strong>（Class Types）的类型。它只允许存储对象引用类型的值。它不能存储结构体、枚举或其他非类类型的值。</p>
<ul>
<li><code>AnyObject</code> 可以表示任何类类型的实例。</li>
<li>它只能用于类实例，不能用于结构体、枚举或其他值类型。</li>
<li>对 <code>AnyObject</code> 类型的值进行操作时，通常需要进行类型转换才能使用其特定的属性和方法。</li>
</ul>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Persion</span>{
    
}
     <span class="hljs-keyword">var</span> p : <span class="hljs-type">AnyObject</span>
     p <span class="hljs-operator">=</span> <span class="hljs-type">Persion</span>()
     <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> p <span class="hljs-operator">=</span> p <span class="hljs-keyword">as?</span> <span class="hljs-type">Persion</span>{
     <span class="hljs-built_in">print</span>(p)
 
</code></pre>
<p><code>AnyObject</code> 用于存储<strong>类实例</strong>，例如 <code>NSObject</code> 或任何继承自类的对象。它不支持值类型或非类类型。</p>
<h2 data-id="heading-2">三、AnyClass</h2>
<p><code>AnyClass</code> 是一个表示<strong>类类型</strong>（Class Type）的特殊类型。它用于引用类类型本身，而不是类的实例。通过 <code>AnyClass</code> 可以访问类的元信息（比如元类）。</p>
<ul>
<li><code>AnyClass</code> 代表类类型本身，而不是类的实例。</li>
<li>用来存储类类型（如 <code>MyClass.self</code>）的引用。</li>
<li>通常用于动态地操作类类型或元类的元信息。</li>
</ul>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-keyword">let</span> classType: <span class="hljs-type">AnyClass</span> <span class="hljs-operator">=</span> <span class="hljs-type">Persion</span>.<span class="hljs-keyword">self</span>
<span class="hljs-built_in">print</span>(classType) <span class="hljs-comment">// Persion</span>
</code></pre>
<p><code>AnyClass</code> 表示类的类型，不是类的实例。它通常用于处理类类型的元信息（如反射、类检查等）。</p>
<h4 data-id="heading-3">总结</h4>
<ul>
<li><code>Any</code> 是最通用的类型，可以表示任何类型的实例。</li>
<li><code>AnyObject</code> 仅用于类类型的实例，不能存储值类型。</li>
<li><code>AnyClass</code> 用于表示类类型本身，用于获取类的元信息。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS 上架 4.3，重复 App 审核条款的真实逻辑与团队应对策略研究]]></title>    <link>https://juejin.cn/post/7578889811333513257</link>    <guid>https://juejin.cn/post/7578889811333513257</guid>    <pubDate>2025-12-02T09:54:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578889811333513257" data-draft-id="7578889811333496873" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS 上架 4.3，重复 App 审核条款的真实逻辑与团队应对策略研究"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-02T09:54:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="00后程序员"/> <meta itemprop="url" content="https://juejin.cn/user/1159358440539900"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS 上架 4.3，重复 App 审核条款的真实逻辑与团队应对策略研究
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1159358440539900/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    00后程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T09:54:20.000Z" title="Tue Dec 02 2025 09:54:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 App Store 审核条款中，<em>4.3 – Spam</em> 是让许多团队头疼的拒审代码——中文常被描述为“重复 App”“功能过于雷同”“模板化应用”等。相比其他技术类拒审（如 2.1、5.1.1），4.3 属于典型的“审核判断型”条款：
<strong>不是应用崩溃，也不是隐私缺失，而是苹果认为“这款应用没提供足够独特价值”。</strong></p>
<p>对跨端团队、运营团队、多版本产品线以及使用 uni-app/H5 的团队来说，4.3 是最容易遇到的合规风险之一。本文尝试从更理性的角度，分析 4.3 的真实触发逻辑，并结合不同工具链、开发模式给出可执行的规避策略。</p>
<hr/>
<h2 data-id="heading-0"><strong>一、4.3 不是重复上架，是价值不足</strong></h2>
<p>从大量实际案例看，4.3 常见于如下场景：</p>
<ul>
<li>同一开发者账号短时间提交多个结构相似的 App</li>
<li>App 的页面结构近似网页外壳（WebView 包壳）</li>
<li>大面积使用模板式框架（跨端项目更易触发）</li>
<li>应用内容缺乏动态性，无法展示真实差异化</li>
<li>应用看起来像“分身”“多开”“子版本”</li>
<li>营销类 App 仅更换文案与配色</li>
<li>企业内部工具被改包后提交公开商店</li>
</ul>
<p>因此，4.3 并不等于“复制 App”，而更像这样的审核逻辑：</p>
<blockquote>
<p>“这款应用与您账号下的其他 App 或市场上同类应用相比，没有足够区分度。”</p>
</blockquote>
<p>换句话说，<strong>苹果关注的是“是否值得占用 App Store 一席之地”。</strong></p>
<hr/>
<h2 data-id="heading-1"><strong>二、为什么跨端项目（如 uni-app/H5/低代码）更容易被判 4.3？</strong></h2>
<p>主要原因不是框架本身，而是呈现方式：</p>
<h3 data-id="heading-2"><strong>1. 页面结构差异度低</strong></h3>
<p>跨端项目的 UI 通常更一致、组件风格更统一，应用间差异容易收敛。</p>
<h3 data-id="heading-3"><strong>2. WebView 架构容易被误判为“壳应用”</strong></h3>
<p>如果首页加载 H5 且结构雷同，审核员可能认为缺乏原生体验。</p>
<h3 data-id="heading-4"><strong>3. 多产品线共用同一代码基础</strong></h3>
<p>多个项目使用相同模板，会让应用外观高度一致。</p>
<h3 data-id="heading-5"><strong>4. 内容变化不足</strong></h3>
<p>如果 App 依赖外部内容，但上线版本内容量少，审核无法看到差异。</p>
<p>因此，跨端项目不仅要技术能跑，还要呈现足够“原生级别”的价值。</p>
<hr/>
<h2 data-id="heading-6"><strong>三、从构建与工具链角度看，4.3 并不是上传方式问题</strong></h2>
<p>不少团队误以为“是不是因为使用某种上传工具导致触发 4.3”，但从工程经验来看：</p>
<ul>
<li>Transporter</li>
<li>Xcode Organizer</li>
<li>跨平台命令行工具（如开心上架）</li>
<li>CI/CD 自动上传</li>
</ul>
<p>这些上传方式只是“把 IPA 送到苹果”，并不会影响 4.3 的审核逻辑。</p>
<p>实际原因通常在于：</p>
<ul>
<li>应用内容不足</li>
<li>UI 结构过于模板化</li>
<li>同账号 App 过多且类似</li>
<li>应用缺少“使用理由”</li>
<li>未展示核心价值</li>
</ul>
<p>因此，上传工具是流程选择，不会影响审核判断。</p>
<hr/>
<h2 data-id="heading-7"><strong>四、被判 4.3 的常见信号：审核时长与提问方式</strong></h2>
<p>大量案例显示，4.3 审核通常具有以下特征：</p>
<h3 data-id="heading-8"><strong>1. 审核时间明显拉长</strong></h3>
<p>审核会停留在“正在审核”阶段 2–5 天，期间没有明显进度变化。</p>
<h3 data-id="heading-9"><strong>2. 审核员可能发出“应用的具体用途是什么？”</strong></h3>
<p>这类提问意味着审核员需要确认 App 是否具有独立价值。</p>
<h3 data-id="heading-10"><strong>3. 可能要求更多示例内容</strong></h3>
<p>尤其是内容型应用。</p>
<p>这些信号出现时，应尽快补全说明与内容。</p>
<hr/>
<h2 data-id="heading-11"><strong>五、团队可执行的反制策略：重点在“展示价值”而非“技术改造”</strong></h2>
<h3 data-id="heading-12"><strong>策略 1：提供清晰的审核说明（关键）</strong></h3>
<p>说明内容包括：</p>
<ul>
<li>应用核心用户是谁</li>
<li>使用场景是什么</li>
<li>与同类应用相比有什么独特价值</li>
<li>审核流程如何进入核心功能</li>
<li>动态内容从何获取</li>
</ul>
<p>审核说明越完整，4.3 风险越低。</p>
<hr/>
<h3 data-id="heading-13"><strong>策略 2：增加明显区分度</strong></h3>
<p>尤其是团队提交多款 App 时。</p>
<p>改进方向：</p>
<ul>
<li>不同配色</li>
<li>不同布局</li>
<li>不同功能入口</li>
<li>不同图标风格</li>
<li>提供差异化截图</li>
</ul>
<p>让审核员“一眼看出不是同一套壳”。</p>
<hr/>
<h3 data-id="heading-14"><strong>策略 3：原生结构化呈现</strong></h3>
<p>如果是 uni-app/H5 项目，可以：</p>
<ul>
<li>增加原生 TabBar</li>
<li>增加原生导航</li>
<li>把关键页面做原生化呈现（首页/登录）</li>
<li>保留 WebView，但让整体更像原生 App</li>
</ul>
<p>审核员非常看重“原生级别体验”。</p>
<hr/>
<h3 data-id="heading-15"><strong>策略 4：在提审前充实内容</strong></h3>
<p>尤其是内容型 App：</p>
<ul>
<li>列表数量</li>
<li>详情页丰富度</li>
<li>交互流程完整性</li>
</ul>
<p>初版内容越少，越容易被判定为“壳”。</p>
<hr/>
<h3 data-id="heading-16"><strong>策略 5：避免同账号同时提交多个版本</strong></h3>
<p>短时间内提交相似应用是触发 4.3 的高危行为。</p>
<hr/>
<h2 data-id="heading-17"><strong>六、团队级流程建议：把“4.3 规避”当作上架环节之一</strong></h2>
<p>不少团队在提审前会引入一次“反 4.3 检查”：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">A</span>. 应用是否具有明确价值？
<span class="hljs-selector-tag">B</span>. UI 是否过度模板化？
C. 是否依赖 <span class="hljs-selector-tag">H5</span>，并且缺少原生结构？
D. 内容是否足够充实？
E. 是否与团队现有 App 过于相似？
</code></pre>
<p>这套检查经常能在提审前发现潜在风险。</p>
<hr/>
<h2 data-id="heading-18"><strong>4.3 的本质是价值判断，而不是技术问题</strong></h2>
<p>从大量案例总结来看，4.3 是苹果针对“内容重复、价值不足”的保护机制。
它既不是技术 bug，也不是上传方式问题，而是产品形态问题。</p>
<p>解决思路只有一个核心：</p>
<p><strong>让审核员相信你的应用具有不可替代的存在理由。</strong></p>
<p>做到这一点，4.3 就不再是难题。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 LangGraph v1.0 构建生产级 RAG：高吞吐、低幻觉、全链路可观测]]></title>    <link>https://juejin.cn/post/7578922565210275867</link>    <guid>https://juejin.cn/post/7578922565210275867</guid>    <pubDate>2025-12-02T09:48:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578922565210275867" data-draft-id="7578705123209412651" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 LangGraph v1.0 构建生产级 RAG：高吞吐、低幻觉、全链路可观测"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2025-12-02T09:48:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GeekPMAlex"/> <meta itemprop="url" content="https://juejin.cn/user/2326992765334446"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 LangGraph v1.0 构建生产级 RAG：高吞吐、低幻觉、全链路可观测
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2326992765334446/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GeekPMAlex
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T09:48:49.000Z" title="Tue Dec 02 2025 09:48:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>传统 RAG 实现通常为线性流程：</p>
<pre><code class="hljs language-python" lang="python">docs = retriever.invoke(query)
answer = llm.invoke(prompt + docs)
</code></pre>
<p>该模式在原型阶段有效，但在生产环境中存在以下问题：</p>
<ul>
<li>幻觉风险高（LLM 在上下文不足时生成虚构内容）；</li>
<li>鲁棒性差（单点失败导致整个请求中断）；</li>
<li>不可观测（无法定位问题是检索召回不足还是生成逻辑错误）。</li>
</ul>
<p>LangGraph v1.0 提供状态化工作流编排能力，将 RAG 建模为有向图，支持并行、重试、持久化与全链路追踪，适用于生产部署。</p>
<h2 data-id="heading-1">架构设计</h2>
<p>将 RAG 拆解为以下节点：</p>
<pre><code class="hljs language-css" lang="css">用户查询
   ↓
<span class="hljs-selector-attr">[并行检索]</span> → 内部知识库 | Web 搜索 | 业务 API
   ↓
<span class="hljs-selector-attr">[合并去重]</span> → 统一候选集（去重、加权、时间衰减）
   ↓
<span class="hljs-selector-attr">[Reranker]</span> → 精筛 <span class="hljs-attribute">top</span>-k 相关片段
   ↓
<span class="hljs-selector-attr">[Generator]</span> → 引用感知生成
   ↓
<span class="hljs-selector-attr">[Eval/Trace]</span> → 上报 LangSmith
</code></pre>
<p>每个节点职责单一，支持独立优化、监控与故障隔离。</p>
<h2 data-id="heading-2">核心能力</h2>
<h3 data-id="heading-3">1. 多源并行检索</h3>
<p>使用 LangGraph 的多入口边实现并发分支：</p>
<pre><code class="hljs language-python" lang="python">builder.add_edge(START, <span class="hljs-string">"kb_retrieve"</span>)
builder.add_edge(START, <span class="hljs-string">"web_search"</span>)
builder.add_edge(START, <span class="hljs-string">"api_fetch"</span>)

builder.add_edge(<span class="hljs-string">"kb_retrieve"</span>, <span class="hljs-string">"merge"</span>)
builder.add_edge(<span class="hljs-string">"web_search"</span>, <span class="hljs-string">"merge"</span>)
builder.add_edge(<span class="hljs-string">"api_fetch"</span>, <span class="hljs-string">"merge"</span>)
</code></pre>
<p><code>merge</code> 节点聚合结果，执行内容去重（基于哈希或元数据）、来源权重分配和时效性调整。</p>
<h3 data-id="heading-4">2. Reranker 抑制幻觉</h3>
<p>向量检索召回的 top-k 结果常包含噪声。引入 reranker 节点进行精排：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">rerank_node</span>(<span class="hljs-params">state: RAGState</span>):
    scores = cross_encoder.predict(
        query=state[<span class="hljs-string">"query"</span>],
        documents=[d.page_content <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> state[<span class="hljs-string">"candidates"</span>]]
    )
    top_docs = select_top_n(state[<span class="hljs-string">"candidates"</span>], scores, n=<span class="hljs-number">5</span>)
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"top_docs"</span>: top_docs}
</code></pre>
<p>实测可减少 80% 上下文长度，显著降低幻觉率。</p>
<h3 data-id="heading-5">3. RetryPolicy 与持久化 Checkpoint</h3>
<p>为外部依赖节点配置重试策略：</p>
<pre><code class="hljs language-python" lang="python">retry_policy=RetryPolicy(max_attempts=<span class="hljs-number">3</span>, backoff_factor=<span class="hljs-number">2.0</span>)
</code></pre>
<p>启用持久化 checkpoint 支持中断恢复：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.checkpoint.sqlite <span class="hljs-keyword">import</span> SqliteSaver
checkpointer = SqliteSaver.from_conn_string(<span class="hljs-string">"rag.db"</span>)
graph = builder.<span class="hljs-built_in">compile</span>(checkpointer=checkpointer)
</code></pre>
<p>适用于长流程、人工审核或高可用场景。</p>
<h3 data-id="heading-6">4. 分层缓存优化成本</h3>
<ul>
<li><strong>Provider Prompt Cache</strong>：对静态 system prompt 启用模型提供商缓存（如 AWS Bedrock <code>cachePoint</code>）；</li>
<li><strong>Query-Level Cache</strong>：使用 Redis 缓存 <code>(query_hash, doc_ids) → answer</code>，避免重复计算。</li>
</ul>
<h3 data-id="heading-7">5. LangSmith 全链路追踪</h3>
<p>上报以下数据用于评估：</p>
<ul>
<li>原始查询；</li>
<li>检索文档 ID 与相似度分数；</li>
<li>Reranker 打分结果；</li>
<li>最终生成内容。</li>
</ul>
<p>通过 LangSmith 计算两类关键指标：</p>
<ul>
<li><strong>幻觉率</strong>：生成内容中未被检索结果支持的陈述比例；</li>
<li><strong>错误率</strong>：回答与事实不符或未正确响应问题的比例。</li>
</ul>
<p>二者需分别监控：所有幻觉均为错误，但错误不一定是幻觉（如答非所问、逻辑错误）。</p>
<h2 data-id="heading-8">完整实现示例</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing_extensions <span class="hljs-keyword">import</span> TypedDict
<span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph, START, END
<span class="hljs-keyword">from</span> langgraph.types <span class="hljs-keyword">import</span> RetryPolicy
<span class="hljs-keyword">from</span> langgraph.checkpoint.sqlite <span class="hljs-keyword">import</span> SqliteSaver

<span class="hljs-keyword">class</span> <span class="hljs-title class_">RAGState</span>(TypedDict, total=<span class="hljs-literal">False</span>):
    query: <span class="hljs-built_in">str</span>
    candidates: <span class="hljs-built_in">list</span>
    top_docs: <span class="hljs-built_in">list</span>
    answer: <span class="hljs-built_in">str</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">retrieve_node</span>(<span class="hljs-params">state: RAGState</span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"candidates"</span>: vectorstore.similarity_search(state[<span class="hljs-string">"query"</span>], k=<span class="hljs-number">50</span>)}

<span class="hljs-keyword">def</span> <span class="hljs-title function_">rerank_node</span>(<span class="hljs-params">state: RAGState</span>):
    top_docs = reranker.select_top_k(state[<span class="hljs-string">"candidates"</span>], state[<span class="hljs-string">"query"</span>], k=<span class="hljs-number">5</span>)
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"top_docs"</span>: top_docs}

<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_node</span>(<span class="hljs-params">state: RAGState</span>):
    context = <span class="hljs-string">"\n\n"</span>.join(
        <span class="hljs-string">f"[<span class="hljs-subst">{i}</span>] <span class="hljs-subst">{d.page_content}</span>"</span> 
        <span class="hljs-keyword">for</span> i, d <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(state[<span class="hljs-string">"top_docs"</span>], <span class="hljs-number">1</span>)
    )
    prompt = <span class="hljs-string">f"仅使用以下片段回答，并标注引用编号：\n<span class="hljs-subst">{context}</span>\n\n问题: <span class="hljs-subst">{state[<span class="hljs-string">'query'</span>]}</span>"</span>
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"answer"</span>: llm.invoke(prompt)}

<span class="hljs-comment"># 构建图</span>
builder = StateGraph(RAGState)
builder.add_node(<span class="hljs-string">"retrieve"</span>, retrieve_node, retry_policy=RetryPolicy(max_attempts=<span class="hljs-number">3</span>))
builder.add_node(<span class="hljs-string">"rerank"</span>, rerank_node)
builder.add_node(<span class="hljs-string">"generate"</span>, generate_node)

builder.add_edge(START, <span class="hljs-string">"retrieve"</span>)
builder.add_edge(<span class="hljs-string">"retrieve"</span>, <span class="hljs-string">"rerank"</span>)
builder.add_edge(<span class="hljs-string">"rerank"</span>, <span class="hljs-string">"generate"</span>)
builder.add_edge(<span class="hljs-string">"generate"</span>, END)

<span class="hljs-comment"># 编译并启用持久化</span>
graph = builder.<span class="hljs-built_in">compile</span>(checkpointer=SqliteSaver.from_conn_string(<span class="hljs-string">"checkpoints.db"</span>))

<span class="hljs-comment"># 调用</span>
result = graph.invoke({<span class="hljs-string">"query"</span>: <span class="hljs-string">"如何实现单点登录？"</span>})
<span class="hljs-built_in">print</span>(result[<span class="hljs-string">"answer"</span>])
</code></pre>
<h2 data-id="heading-9">工程建议</h2>
<ul>
<li><strong>HyDE（Hypothetical Document Embeddings）</strong>：对模糊查询，先生成假设文档再检索，提升召回；</li>
<li><strong>时间感知检索</strong>：对时效性内容引入时间衰减因子；</li>
<li><strong>人类审查节点</strong>：在高风险领域插入人工审核环节；</li>
<li><strong>流式输出</strong>：启用 token-by-token streaming 提升用户体验与实时监控能力。</li>
</ul>
<h2 data-id="heading-10">总结</h2>
<p>LangGraph 将 RAG 从脚本升级为可运维系统。通过节点化、状态持久化、并行编排与全链路观测，可构建高可靠、低幻觉、易迭代的生产级 RAG 架构。RAG 的竞争已进入工程化阶段，LangGraph 是当前最优的编排基础设施之一。</p>
<h2 data-id="heading-11">参考</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Flangchain-ai.github.io%2Flanggraph%2F" target="_blank" title="https://langchain-ai.github.io/langgraph/" ref="nofollow noopener noreferrer">LangGraph 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsmith.langchain.com%2F" target="_blank" title="https://smith.langchain.com/" ref="nofollow noopener noreferrer">LangSmith</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fexplodinggradients%2Fragas" target="_blank" title="https://github.com/explodinggradients/ragas" ref="nofollow noopener noreferrer">RAGAS 评估框架</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从0到1构建AI智能文档助手：TRAE SOLO驱动下的架构决策与MCP协议实战]]></title>    <link>https://juejin.cn/post/7578889811332988969</link>    <guid>https://juejin.cn/post/7578889811332988969</guid>    <pubDate>2025-12-02T08:37:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578889811332988969" data-draft-id="7578968420042457151" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从0到1构建AI智能文档助手：TRAE SOLO驱动下的架构决策与MCP协议实战"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-12-02T08:37:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="七条猫"/> <meta itemprop="url" content="https://juejin.cn/user/564503296630944"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从0到1构建AI智能文档助手：TRAE SOLO驱动下的架构决策与MCP协议实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/564503296630944/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    七条猫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T08:37:32.000Z" title="Tue Dec 02 2025 08:37:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在参与公司内部“AI提效”项目时，我接到一个看似简单却极具挑战的任务：<strong>从零搭建一个能自动解析用户上传的PDF/Word文档，并生成结构化摘要与问答接口的AI应用</strong>。面对技术选型的迷雾、模型服务的复杂性以及快速交付的压力，我一度陷入“先写代码还是先画架构图”的纠结中。</p>
<p>直到我将 TRAE SOLO 引入整个开发流程——它不仅帮我厘清了架构思路，更通过 SOLO Coder 自动生成关键组件，甚至指导我采用 MCP（Model Communication Protocol）协议统一模型接入。以下是我借助 TRAE SOLO 完成 AI 应用从0到1落地的实战复盘。</p>
<hr/>
<h3 data-id="heading-0">一、需求模糊？让 SOLO Coder 生成初始架构文档</h3>
<p>项目初期，产品经理只给了两句话：“用户上传文档，AI 能回答问题并输出摘要。”</p>
<p>我打开 TRAE SOLO，输入：</p>
<blockquote>
<p>“设计一个支持 PDF/Word 解析、基于大模型生成摘要和问答的后端服务，要求模块清晰、可扩展、支持多模型切换。”</p>
</blockquote>
<p>不到10秒，SOLO Coder 返回了一份完整的 <code>ARCHITECTURE.md</code> 草稿，包含：</p>
<ul>
<li>技术栈建议：FastAPI + PyPDF2/docx2txt + LangChain（可选）+ Redis 缓存</li>
<li>模块划分：Document Ingestion → Text Extraction → LLM Interface → API Layer</li>
<li>初步接口定义（含 OpenAPI 示例）</li>
</ul>
<p>更重要的是，它还生成了项目脚手架代码：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># main.py (由 TRAE SOLO 自动生成)</span>
<span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI, UploadFile
<span class="hljs-keyword">from</span> services.ingestion <span class="hljs-keyword">import</span> extract_text
<span class="hljs-keyword">from</span> services.llm <span class="hljs-keyword">import</span> generate_summary, answer_question

app = FastAPI(title=<span class="hljs-string">"AI Doc Assistant"</span>)

<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/upload"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">upload_doc</span>(<span class="hljs-params">file: UploadFile</span>):
    text = <span class="hljs-keyword">await</span> extract_text(file)
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"doc_id"</span>: <span class="hljs-string">"uuid"</span>, <span class="hljs-string">"text_preview"</span>: text[:<span class="hljs-number">200</span>]}

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/summary/{doc_id}"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_summary</span>(<span class="hljs-params">doc_id: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"summary"</span>: generate_summary(doc_id)}

<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/ask"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">ask_question</span>(<span class="hljs-params">doc_id: <span class="hljs-built_in">str</span>, question: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"answer"</span>: answer_question(doc_id, question)}
</code></pre>
<p>这份“可运行的文档”让我和团队在第一天就对齐了技术路径，避免了无谓争论。</p>
<hr/>
<h3 data-id="heading-1">二、模型选型困境：TRAE SOLO 帮我决策是否自建推理服务</h3>
<p>接下来的问题是：<strong>用 OpenAI API 还是部署开源模型？</strong></p>
<p>我向 TRAE SOLO 提问：</p>
<blockquote>
<p>“在日均请求 &lt; 1000、响应延迟要求 &lt; 3s、预算有限的场景下，对比使用 OpenAI GPT-4 vs. 自建 Llama-3-8B（通过 vLLM），哪种更合适？”</p>
</blockquote>
<p>TRAE SOLO 综合成本、运维复杂度、冷启动延迟等因素，给出结论：</p>
<blockquote>
<p><strong>初期推荐 OpenAI + 备用开源模型方案，通过统一协议抽象模型差异</strong>。</p>
</blockquote>
<p>于是，我决定引入 <strong>MCP（Model Communication Protocol）</strong> ——一个轻量级、标准化的大模型调用协议，用于屏蔽底层模型实现。</p>
<p>TRAE SOLO 随即为我生成了 MCP 客户端模板：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># mcp_client.py (由 TRAE SOLO 生成并优化)</span>
<span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Dict</span>, <span class="hljs-type">Any</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MCPClient</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, model_endpoint: <span class="hljs-built_in">str</span>, api_key: <span class="hljs-built_in">str</span> = <span class="hljs-literal">None</span></span>):
        self.endpoint = model_endpoint
        self.headers = {<span class="hljs-string">"Authorization"</span>: <span class="hljs-string">f"Bearer <span class="hljs-subst">{api_key}</span>"</span>} <span class="hljs-keyword">if</span> api_key <span class="hljs-keyword">else</span> {}

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate</span>(<span class="hljs-params">self, prompt: <span class="hljs-built_in">str</span>, params: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        payload = {
            <span class="hljs-string">"prompt"</span>: prompt,
            <span class="hljs-string">"model"</span>: <span class="hljs-string">"default"</span>,
            <span class="hljs-string">"parameters"</span>: params <span class="hljs-keyword">or</span> {<span class="hljs-string">"max_tokens"</span>: <span class="hljs-number">512</span>, <span class="hljs-string">"temperature"</span>: <span class="hljs-number">0.3</span>}
        }
        resp = requests.post(<span class="hljs-string">f"<span class="hljs-subst">{self.endpoint}</span>/v1/completions"</span>, json=payload, headers=self.headers)
        resp.raise_for_status()
        <span class="hljs-keyword">return</span> resp.json()[<span class="hljs-string">"choices"</span>][<span class="hljs-number">0</span>][<span class="hljs-string">"text"</span>]
</code></pre>
<p>通过 MCP，无论是调用 OpenAI、Claude 还是本地 vLLM 服务，上层业务代码完全无需修改：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 在 config.yaml 中切换模型</span>
llm:
  provider: openai   <span class="hljs-comment"># 或 local_vllm</span>
  endpoint: https://api.openai.com
  api_key: sk-xxxx

<span class="hljs-comment"># services/llm.py</span>
<span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> get_llm_config
<span class="hljs-keyword">from</span> mcp_client <span class="hljs-keyword">import</span> MCPClient

client = MCPClient(**get_llm_config())

<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_summary</span>(<span class="hljs-params">doc_id: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    text = get_cached_text(doc_id)
    prompt = <span class="hljs-string">f"请用中文总结以下文档：\n\n<span class="hljs-subst">{text}</span>"</span>
    <span class="hljs-keyword">return</span> client.generate(prompt)
</code></pre>
<hr/>
<h3 data-id="heading-2">三、踩坑与避坑：TRAE SOLO 成为我的“架构哨兵”</h3>
<p>在测试阶段，我们发现两个严重问题：</p>
<ol>
<li><strong>长文档导致 Token 超限，费用飙升</strong></li>
<li><strong>OpenAI 服务偶尔不可用，系统直接崩溃</strong></li>
</ol>
<p>我立刻向 TRAE SOLO 求助：</p>
<blockquote>
<p>“如何优化长文本处理？如何实现模型服务的容灾降级？”</p>
</blockquote>
<p>它不仅建议：</p>
<ul>
<li>使用 <strong>滑动窗口分段摘要 + 向量缓存</strong></li>
<li>在 MCP 层增加 <strong>fallback 机制</strong></li>
</ul>
<p>还直接生成了改进代码：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># mcp_client.py 增强版（TRAE SOLO 建议）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ResilientMCPClient</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, primary: MCPClient, fallback: MCPClient = <span class="hljs-literal">None</span></span>):
        self.primary = primary
        self.fallback = fallback

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate</span>(<span class="hljs-params">self, prompt: <span class="hljs-built_in">str</span>, params: <span class="hljs-built_in">dict</span> = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">return</span> self.primary.generate(prompt, params)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">if</span> self.fallback:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Primary failed: <span class="hljs-subst">{e}</span>, falling back to backup model"</span>)
                <span class="hljs-keyword">return</span> self.fallback.generate(prompt, params)
            <span class="hljs-keyword">raise</span>
</code></pre>
<p>同时，它提醒我在 <code>extract_text</code> 中加入文本分块逻辑，并自动插入缓存装饰器：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> lru_cache

<span class="hljs-meta">@lru_cache(<span class="hljs-params">maxsize=<span class="hljs-number">128</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">chunked_summarize</span>(<span class="hljs-params">text: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-comment"># 分段摘要 + 最终聚合</span>
    chunks = [text[i:i+<span class="hljs-number">3000</span>] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(text), <span class="hljs-number">3000</span>)]
    summaries = [client.generate(<span class="hljs-string">f"简要总结：<span class="hljs-subst">{c}</span>"</span>) <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> chunks]
    <span class="hljs-keyword">return</span> client.generate(<span class="hljs-string">"综合以下摘要，生成最终报告："</span> + <span class="hljs-string">"\n"</span>.join(summaries))
</code></pre>
<p>这些“即时架构补丁”，让我们在48小时内完成了生产级加固。</p>
<hr/>
<h3 data-id="heading-3">四、成果与反思</h3>
<p>最终，该 AI 文档助手上线后：</p>
<ul>
<li>平均响应时间 &lt; 2.1s</li>
<li>模型调用成本降低 40%（通过缓存 + fallback 减少无效请求）</li>
<li>架构支持无缝切换至私有化部署（仅需修改 config.yaml）</li>
</ul>
<p>更重要的是，<strong>TRAE SOLO 让我从“写功能的人”转变为“设计系统的人”</strong> 。它不是替代我的判断，而是将我的模糊意图转化为可执行、可演进的架构蓝图。</p>
<hr/>
<h3 data-id="heading-4">结语</h3>
<p>在 AI 应用爆炸式增长的今天，工具的价值不在于“写多少代码”，而在于“减少多少错误决策”。TRAE SOLO 正是这样一位沉默的架构协作者——</p>
<p>它用 SOLO Coder 将需求翻译为结构，</p>
<p>用 MCP 协议统一模型世界的碎片，</p>
<p>用实时反馈筑起工程化的护城河。</p>
<p>从0到1的路上，感谢 TRAE SOLO，让我敢想、敢试、更敢交付。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[苹果iOS应用上架App Store必看指南与规则]]></title>    <link>https://juejin.cn/post/7579096485355192370</link>    <guid>https://juejin.cn/post/7579096485355192370</guid>    <pubDate>2025-12-02T10:02:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579096485355192370" data-draft-id="7578922565210357787" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="苹果iOS应用上架App Store必看指南与规则"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-02T10:02:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开心猴爷"/> <meta itemprop="url" content="https://juejin.cn/user/2179705232165364"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            苹果iOS应用上架App Store必看指南与规则
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2179705232165364/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开心猴爷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T10:02:02.000Z" title="Tue Dec 02 2025 10:02:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>苹果App上架，必看指南！</p>
<p>应用内不得包含检查更新功能：自2015年3月起，所有包含检查更新功能的App将被拒绝上架。</p>
<p>第三方登录检测：接入第三方登录时，需检测是否安装了第三方客户端。若未安装，采用隐藏登录按钮的方式可能被审核拒绝。QQ和微博提供了web登录方式，未安装时需允许用户使用webview登录，因为苹果条款中声明不允许iOS应用的正常使用依赖另一个App。</p>
<p>禁止采集未用于广告的IDFA：从2014年2月起，采集设备IDFA但应用没有广告功能的会被拒。</p>
<p>Xcode配置：在Xcode中，sign code要选择ios develop；当打包了valid包出错时，不能直接再次打包，要改一下general中的build值；general中选择低版本iOS系统时需注意，如选择11.0版本可能导致11.0版本以下的苹果手机无法安装；info中的文字提示需说明具体用途，不然提交审核会被拒绝，同时人为增加一个合规证明的key-value。</p>
<p>App Store信息：名称要与config.xml中的一致；屏幕快照可以使用Xcode中的模拟器进行截图，对于iPhone，必须提供用于6.5英寸iPhone Xs Max和5.5英寸设备的截屏，对于iPad，必须提供用于12.9英寸iPad Pro（第2代）和12.9英寸iPad Pro（第3代）的截屏。上传至多三个App预览和至多十张截屏，截屏必须为JPG或PNG格式且采用RGB色彩空间，App预览必须为M4V、MP4或MOV格式且不能超过500MB。</p>
<p>使用AppUploader可以简化截图上传流程，支持批量上传应用截图和本地化信息，提高效率。</p>
<p>审核周期与规定：苹果上架审核周期长，需确保遵循《App Store审查指南》中的所有规定，优化应用的元数据，确保应用的标题、描述、关键词、截图和预览视频能够准确反映应用的核心功能和特点。应用应在各种设备和iOS版本上充分测试，确保无重大Bug或性能问题。明确应用的定价和付款策略，处理好用户隐私和数据，遵循Apple的隐私指南，准备隐私政策，并在App Store Connect中正确标注应用的数据使用情况。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AgentScope 拥抱函数计算 FC，为 Agent 应用提供 Serverless 运行底座]]></title>    <link>https://juejin.cn/post/7578889811333578793</link>    <guid>https://juejin.cn/post/7578889811333578793</guid>    <pubDate>2025-12-02T10:02:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578889811333578793" data-draft-id="7578968420042686527" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AgentScope 拥抱函数计算 FC，为 Agent 应用提供 Serverless 运行底座"/> <meta itemprop="keywords" content="Agent,Serverless"/> <meta itemprop="datePublished" content="2025-12-02T10:02:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AgentScope 拥抱函数计算 FC，为 Agent 应用提供 Serverless 运行底座
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T10:02:27.000Z" title="Tue Dec 02 2025 10:02:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：靖苏</p>
<p>在 AI Agent 应用加速落地的今天，开发者和企业普遍面临三大核心痛点：<strong>部署成本高、运维复杂度高、资源利用率低</strong>。为应对这些挑战，AI Agent 与云原生、Serverless 架构的深度融合正成为行业新趋势。我们很高兴地宣布，AgentScope 正式集成基于<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Ffc%3Fspm%3Da1z389.11499242.0.0.65452413RXCQWs%26utm_content%3Dg_1000408146" target="_blank" title="https://www.aliyun.com/product/fc?spm=a1z389.11499242.0.0.65452413RXCQWs&amp;utm_content=g_1000408146" ref="nofollow noopener noreferrer">阿里云函数计算</a>（Function Compute, FC）的全新 Serverless 运行时，为多智能体应用提供“按需启动、毫秒弹性、零运维”的新一代运行底座。</p>
<h2 data-id="heading-0">AgentScope 是什么？</h2>
<p>AgentScope <strong>[</strong> <strong>1]</strong> 是一个开源的多智能体应用开发框架，面向构建可观察、可控制、可扩展的 AI 智能体系统。其核心设计原则是<strong>对开发者完全透明</strong>：所有提示工程、模型调用、智能体行为及工作流编排均显式暴露，避免隐式逻辑或深度封装。</p>
<p>该框架拥有以下特性：</p>
<ul>
<li><strong>透明性优先：</strong> 所有内部状态、消息传递路径、工具调用链路和模型交互过程均可追踪与审计，确保行为可解释、可调试。</li>
<li><strong>实时介入：</strong> 实现 ReAct 智能体，原生支持任务执行过程中的实时中断与自定义中断处理逻辑，允许用户随时中断智能体的回复，介入智能体的执行，适用于需要人工干预或动态策略调整的场景。</li>
<li><strong>增强智能能力：</strong> 提供统一的工具管理接口、长期记忆控制机制以及智能化 RAG（检索增强生成）支持，提升智能体的上下文感知与知识利用能力。</li>
<li><strong>模型无关架构：</strong> 抽象统一的模型接入层允许同一套智能体逻辑无缝切换不同大语言模型（如 GPT、Claude、通义千问、Llama 系列等），降低模型迁移成本。</li>
<li><strong>模块化“乐高式”设计：</strong> 智能体、工具、提示模板、记忆模块、工作流节点等组件高度解耦，支持独立开发、组合复用与灵活替换。</li>
<li><strong>原生多智能体支持：</strong> 采用显式消息传递机制与声明式工作流编排，明确表达智能体间的协作关系，避免隐式调度带来的不可控性。</li>
<li><strong>高度可定制：</strong> 支持对工具链、提示策略、通信协议、第三方库集成及可视化界面进行深度定制，适配从原型验证到生产部署的全周期需求。</li>
</ul>
<p>AgentScope 旨在为开发者提供一个既具备工程严谨性，又保持足够灵活性的智能体开发基础设施，推动多智能体系统从实验走向规模化落地。自开源以来，AgentScope 已获得社区广泛认可，GitHub Star 数突破 <strong>14,000+</strong>。</p>
<h2 data-id="heading-1">当前 Agent 运行时的挑战</h2>
<p>AgentScope Runtime <strong>[</strong> <strong>2]</strong> 是一个面向生产环境的智能体运行时框架，聚焦于两大核心问题：<strong>高效、可扩展的智能体部署与安全、隔离的 Sandbox 工具执行</strong>。该运行时提供上下文管理（包括长短期记忆与外部知识库集成）和多层级沙箱基础设施，构成一套框架无关的底层支撑系统，可与主流开源智能体框架或自定义实现无缝协同。其设计目标是为服务级智能体应用提供具备完整可观测性、强安全性与便捷部署能力的基础运行环境。</p>
<p>AgentScope Runtime实现了双核心架构：</p>
<ul>
<li><strong>智能体部署运行时（Engine）：</strong> 提供智能体生命周期管理、会话状态维护、上下文存储（短期对话历史与长期记忆）以及外部知识库接入能力，并集成沙箱环境调度服务，支撑高并发、多会话的智能体服务部署。</li>
<li><strong>工具执行运行时（Sandbox）：</strong> 基于隔离容器构建的安全执行环境，支持智能体调用各类工具操作，包括文件系统访问、浏览器自动化、GUI 交互及 MCP（Model Context Protocol）工具集成，确保所有副作用行为被严格限制在沙箱边界内，杜绝对宿主系统的潜在风险。</li>
</ul>
<p>目前，AgentScope 的主流部署模式依赖 <strong>Docker + Kubernetes</strong> 组合。该方案在功能完备性和集群管理能力上表现优异，但在实际落地 AI Agent 应用时，暴露出若干结构性瓶颈：</p>
<ul>
<li><strong>持续运行带来固定成本：</strong> 容器实例需长期驻留内存以维持智能体状态和会话上下文，即使在无请求的空闲时段仍持续计费，导致显著的资源浪费，尤其对间歇性、事件驱动型任务极不友好。</li>
<li><strong>静态资源分配缺乏弹性：</strong> 资源配额（CPU、内存）通常按预估峰值设定，难以动态适配真实负载。在流量突发时可能因资源不足导致响应延迟或失败；而在低峰期则大量计算资源闲置，利用率低下。</li>
<li><strong>高运维复杂度形成使用门槛：</strong> 部署和维护一套生产级 K8s 集群涉及网络策略配置、服务发现、日志收集、监控告警、自动扩缩容（HPA）等多项云原生技能，对中小团队、独立开发者或非基础设施背景的研究人员构成显著障碍。</li>
</ul>
<p>这些限制使得许多具备潜力的 Agent 应用停留在实验阶段，难以实现低成本、高可用、快速迭代的规模化部署。</p>
<p>为系统性解决上述问题，AgentScope 正式推出基于<strong>阿里云函数计算（Function Compute, FC）</strong> 构建的 <strong>Serverless 运行时</strong>。该运行时针对 AI Agent 的典型工作负载（如会话保持、工具调用、状态依赖）进行深度优化，在保留功能完整性的同时，彻底重构资源使用与运维模型。</p>
<h3 data-id="heading-2">Serverless 运行时的核心优势：</h3>
<p><strong>✅ 按量付费，成本可精细化控制</strong></p>
<p>计费粒度精确至毫秒级函数执行时间与内存消耗，空闲期间零费用。对于低频调用或突发型 Agent 任务，可有效降低成本。</p>
<p><strong>✅ 毫秒级弹性伸缩，自动应对负载波动</strong></p>
<p>无需预设实例数量或手动扩缩容，平台根据并发请求数自动调度计算资源，瞬时支撑从 1 到数千 QPS 的流量突增，保障服务 SLA。</p>
<p><strong>✅ 零运维，聚焦核心逻辑开发</strong></p>
<p>开发者无需关心底层服务器、容器镜像、K8s 配置或网络拓扑，仅需关注智能体逻辑、工具集成与业务流程编排，大幅缩短上线周期。</p>
<p>此外，Serverless 运行时通过<strong>会话亲和（Session Affinity）机制</strong>在无状态函数架构下有效支持有状态的 Agent 交互场景，兼顾弹性与一致性。</p>
<p>这一演进标志着 Agent 运行时正从“重资产、高运维”的传统模式，迈向“轻量化、自动化、经济高效”的云原生新范式，为 AI Agent 的大规模商业化落地扫清基础设施障碍。</p>
<h2 data-id="heading-3">Serverless 运行时集成能力详解</h2>
<h3 data-id="heading-4">Engine 能力拓展</h3>
<p>Serverless 运行时深度集成 AgentScope 的核心执行引擎（AgentScope Runtime Engine），在保留原有编程模型的基础上，为开发者提供面向云原生环境的无缝部署体验。关键能力包括：</p>
<ul>
<li><strong>本地代码一键构建与依赖打包：</strong> 开发者仅需在本地项目目录中执行<code>deploy() </code>方法，运行时即可自动分析 Python 依赖，构建包含用户代码、自定义工具及第三方库的可执行包，并上传至<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Ffc%3Fspm%3Da1z389.11499242.0.0.65452413RXCQWs%26utm_content%3Dg_1000408146" target="_blank" title="https://www.aliyun.com/product/fc?spm=a1z389.11499242.0.0.65452413RXCQWs&amp;utm_content=g_1000408146" ref="nofollow noopener noreferrer">阿里云函数计算（FC）</a>——该服务已深度集成于百炼 ModelStudio 平台，实现从开发到托管的一站式闭环。</li>
<li><strong>一键部署生成 HTTPS Endpoint：</strong>  部署完成后，系统自动分配全局唯一的 HTTPS 端点（Endpoint），支持标准 RESTful 调用。外部系统（如 Web 前端、移动端或第三方服务）可通过该接口直接触发智能体执行，无需额外配置网关或反向代理。</li>
<li><strong>Header-Based Session 亲和性保障：</strong> 为支持有状态交互（如多轮对话、工具链连续调用），Serverless 运行时引入基于 HTTP 请求头的会话绑定机制。客户端通过在请求中携带 Session ID 请求头，平台将确保同一 Session ID 的所有后续请求路由至同一函数实例（或关联的沙箱上下文），从而维持内存状态、临时文件或浏览器会话的一致性。</li>
<li><strong>继承 Serverless 核心优势：</strong> 所有通过 Engine 部署的智能体天然享有 Serverless 架构的三大特性：按实际执行时间计费、毫秒级自动扩缩容、零基础设施运维，显著降低运营复杂度与总体拥有成本（TCO）。</li>
</ul>
<h3 data-id="heading-5">Sandbox 运行时全面支持</h3>
<p>AgentScope 定义的四大沙箱类型现已完整适配 Serverless 运行时，可在函数计算环境中安全、高效地执行各类操作：</p>
<ul>
<li>✅ <strong>BaseSandbox</strong>：提供隔离的 Python 代码执行环境，适用于通用脚本运行与逻辑计算</li>
<li>✅ <strong>FileSystemSandbox</strong>：挂载临时或持久化文件系统，支持文件读写、日志记录与中间产物存储</li>
<li>✅ <strong>BrowserSandbox</strong>：内置无头 Chromium 浏览器，实现网页自动化、数据抓取与前端交互模拟</li>
<li>✅ <strong>GUISandbox</strong>：支持图形界面应用的模拟执行（如桌面软件自动化），适用于特定领域工具集成</li>
</ul>
<p>基于<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Ffc%3Fspm%3Da1z389.11499242.0.0.65452413RXCQWs%26utm_content%3Dg_1000408146" target="_blank" title="https://www.aliyun.com/product/fc?spm=a1z389.11499242.0.0.65452413RXCQWs&amp;utm_content=g_1000408146" ref="nofollow noopener noreferrer">阿里云函数计算（FC）</a>的 Serverless 运行时，深度集成 AgentScope 的 Sandbox 运行引擎，其核心特性如下：</p>
<ul>
<li><strong>预热实例池，消除冷启动延迟：</strong>  平台可预先创建并维护一组常用类型的 Sandbox，在新会话到来时直接复用，提高常驻服务的响应速度。</li>
<li><strong>自动注入 Session ID，保障上下文连续性：</strong>  在首次创建 Sandbox 时，系统自动生成唯一 Session ID 并返回给客户端；后续所有针对该会话的 HTTP 请求均自动携带此 ID，确保操作始终作用于同一沙箱实例，保证状态一致性。</li>
<li><strong>全生命周期 Serverless 体验：</strong>  每个 Sandbox 实例在会话结束后自动回收资源，计费随执行结束而终止，同样遵循<strong>按量付费、毫秒级弹性、零运维</strong>的 Serverless 原则，在安全性、性能与成本之间取得最佳平衡。</li>
</ul>
<p>通过 Engine 与 Sandbox 的双重增强，AgentScope 的 Serverless 运行时不仅解决了传统部署的成本与运维难题，更在保持强隔离与状态支持的前提下，实现了 AI Agent 应用的高效、安全、经济化交付。</p>
<h2 data-id="heading-6">快速体验</h2>
<p>现在，您就可以将 Agent 应用快速部署到 Serverless 运行时！</p>
<h3 data-id="heading-7">部署 Agent 到 Serverless 运行时</h3>
<p>只需三步：</p>
<ol>
<li>配置相关环境变量</li>
</ol>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 确保设置环境变量</span>
export <span class="hljs-attr">DASHSCOPE_API_KEY</span>=<span class="hljs-string">"your-dashscope-api-key"</span>
export <span class="hljs-attr">ALIBABA_CLOUD_ACCESS_KEY_ID</span>=<span class="hljs-string">"your-access-key-id"</span>
export <span class="hljs-attr">ALIBABA_CLOUD_ACCESS_KEY_SECRET</span>=<span class="hljs-string">"your-access-key-secret"</span>
export <span class="hljs-attr">MODELSTUDIO_WORKSPACE_ID</span>=<span class="hljs-string">"your-workspace-id"</span>
<span class="hljs-comment"># 可选的OSS专用凭证</span>
export <span class="hljs-attr">OSS_ACCESS_KEY_ID</span>=<span class="hljs-string">"your-oss-access-key-id"</span>
export <span class="hljs-attr">OSS_ACCESS_KEY_SECRET</span>=<span class="hljs-string">"your-oss-access-key-secret"</span>
</code></pre>
<ol start="2">
<li>定义好您的 AgentApp</li>
</ol>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># -*- coding: utf-8 -*-</span>
<span class="hljs-comment"># pylint:disable=wrong-import-position, wrong-import-order</span>
import asyncio
import os
from agentscope.agent import ReActAgent
from agentscope.model import DashScopeChatModel
from agentscope_runtime.engine.agents.agentscope_agent import AgentScopeAgent
from agentscope_runtime.engine.runner import Runner
from agentscope_runtime.engine.schemas.agent_schemas import (
    MessageType,
    RunStatus,
    AgentRequest,
)
from agentscope_runtime.engine.services.context_manager import (
    ContextManager,
)
from agentscope_runtime.sandbox.tools.function_tool import function_tool
from others.other_project import version
@function_tool()
def weather_search(query: str) -&gt; str:
    if "sf" in query.lower() or "san francisco" in query.lower():
        <span class="hljs-attr">result</span> = <span class="hljs-string">"It's 60 degrees and foggy."</span>
    else:
        <span class="hljs-attr">result</span> = <span class="hljs-string">"It's 90 degrees and sunny."</span>
    return result
<span class="hljs-attr">agent</span> = AgentScopeAgent(
    <span class="hljs-attr">name</span>=<span class="hljs-string">"Friday"</span>,
    <span class="hljs-attr">model</span>=DashScopeChatModel(
        "qwen-turbo",
        <span class="hljs-attr">api_key</span>=os.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>),
    ),
    <span class="hljs-attr">agent_config</span>={
        "sys_prompt": "You're a helpful assistant named Friday.",
    },
    <span class="hljs-attr">agent_builder</span>=ReActAgent,
    <span class="hljs-attr">tools</span>=[
        weather_search,
    ],
)
print(f"AgentScope Runtime with dependencies version: {version}")
async def run():
    <span class="hljs-comment"># Create a request</span>
    <span class="hljs-attr">request</span> = AgentRequest(
        <span class="hljs-attr">input</span>=[
            {
                <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
                <span class="hljs-string">"content"</span>: [
                    {
                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                        <span class="hljs-string">"text"</span>: <span class="hljs-string">"杭州天气如何？"</span>,
                    },
                ],
            },
        ],
    )
    <span class="hljs-attr">runner</span> = Runner(
        <span class="hljs-attr">agent</span>=agent,
        <span class="hljs-attr">context_manager</span>=ContextManager(),
        <span class="hljs-comment"># context_manager=None       # Optional</span>
    )
    async for message in runner.stream_query(<span class="hljs-attr">request</span>=request):
        <span class="hljs-comment"># Check if this is a completed message</span>
        if (
            <span class="hljs-attr">message.object</span> == <span class="hljs-string">"message"</span>
            and <span class="hljs-attr">MessageType.MESSAGE</span> == message.type
            and <span class="hljs-attr">RunStatus.Completed</span> == message.status
        ):
            <span class="hljs-attr">all_result</span> = message.content[<span class="hljs-number">0</span>].text
        print(message)
    print(f"📝 Agent response: {all_result}")
if <span class="hljs-attr">__name__</span> == <span class="hljs-string">"__main__"</span>:
    asyncio.run(run())
</code></pre>
<ol start="3">
<li>配置部署相关代码，将您的代码部署到 Serverless 运行时上</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">import asyncio
import os
from agentscope_runtime.engine.deployers.modelstudio_deployer import (
    ModelstudioDeployManager,
    OSSConfig,
    ModelstudioConfig,
)
from agent_app import app  <span class="hljs-comment"># 导入已配置的 app</span>
async def deploy_to_modelstudio():
    """将 AgentApp 部署到阿里云 ModelStudio"""
    <span class="hljs-comment"># 配置 OSS 和 ModelStudio</span>
    <span class="hljs-attr">deployer</span> = ModelstudioDeployManager(
        <span class="hljs-attr">oss_config</span>=OSSConfig(
            <span class="hljs-attr">access_key_id</span>=os.environ.get(<span class="hljs-string">"ALIBABA_CLOUD_ACCESS_KEY_ID"</span>),
            <span class="hljs-attr">access_key_secret</span>=os.environ.get(<span class="hljs-string">"ALIBABA_CLOUD_ACCESS_KEY_SECRET"</span>),
        ),
        <span class="hljs-attr">modelstudio_config</span>=ModelstudioConfig(
            <span class="hljs-attr">workspace_id</span>=os.environ.get(<span class="hljs-string">"MODELSTUDIO_WORKSPACE_ID"</span>),
            <span class="hljs-attr">access_key_id</span>=os.environ.get(<span class="hljs-string">"ALIBABA_CLOUD_ACCESS_KEY_ID"</span>),
            <span class="hljs-attr">access_key_secret</span>=os.environ.get(<span class="hljs-string">"ALIBABA_CLOUD_ACCESS_KEY_SECRET"</span>),
            <span class="hljs-attr">dashscope_api_key</span>=os.environ.get(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>),
        ),
    )
    <span class="hljs-comment"># 执行部署</span>
    <span class="hljs-attr">result</span> = await app.deploy(
        deployer,
        <span class="hljs-attr">deploy_name</span>=<span class="hljs-string">"agent-app-example"</span>,
        <span class="hljs-attr">telemetry_enabled</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">requirements</span>=[<span class="hljs-string">"agentscope"</span>, <span class="hljs-string">"fastapi"</span>, <span class="hljs-string">"uvicorn"</span>],
        <span class="hljs-attr">environment</span>={
            "PYTHONPATH": "/app",
            "DASHSCOPE_API_KEY": os.environ.get("DASHSCOPE_API_KEY"),
        },
    )
    print(f"✅ 部署到 ModelStudio：{result<span class="hljs-section">['url']</span>}")
    print(f"📦 制品：{result<span class="hljs-section">['artifact_url']</span>}")
    return result
if <span class="hljs-attr">__name__</span> == <span class="hljs-string">"__main__"</span>:
    asyncio.run(deploy_to_modelstudio())
</code></pre>
<p>📚 详细文档请参考：部署指南 <strong>[</strong> <strong>3]</strong> 。</p>
<h3 data-id="heading-8">快速启动 Sandbox</h3>
<ol>
<li>安装 agentscope-runtime</li>
</ol>
<pre><code class="hljs">pip install agentscope-runtime
</code></pre>
<p>由于 agentscope-runtime 仍在初期快速迭代中，建议采用源码安装方式。</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/agentscope-ai/agentscope-runtime.git
<span class="hljs-built_in">cd</span> agentscope-runtime
pip install .
</code></pre>
<ol start="2">
<li>配置环境变量</li>
</ol>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># Service settings</span>
<span class="hljs-attr">HOST</span>=<span class="hljs-string">"0.0.0.0"</span>
<span class="hljs-attr">PORT</span>=<span class="hljs-number">8000</span>
<span class="hljs-attr">WORKERS</span>=<span class="hljs-number">1</span>
<span class="hljs-attr">DEBUG</span>=<span class="hljs-literal">False</span>
<span class="hljs-comment"># Runtime Manager settings</span>
<span class="hljs-attr">DEFAULT_SANDBOX_TYPE</span>=base
<span class="hljs-attr">POOL_SIZE</span>=<span class="hljs-number">0</span>
<span class="hljs-attr">AUTO_CLEANUP</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">CONTAINER_PREFIX_KEY</span>=agent-runtime-container-
<span class="hljs-attr">CONTAINER_DEPLOYMENT</span>=agentrun
<span class="hljs-attr">DEFAULT_MOUNT_DIR</span>=
<span class="hljs-attr">STORAGE_FOLDER</span>=runtime_sandbox_storage
<span class="hljs-attr">PORT_RANGE</span>=[<span class="hljs-number">49152</span>,<span class="hljs-number">59152</span>]
<span class="hljs-comment"># FC 相关账户信息</span>
<span class="hljs-attr">FC_ACCOUNT_ID</span>=&lt;your-account-id&gt;
<span class="hljs-attr">FC_ACCESS_KEY_ID</span>=&lt;your-access-key-id&gt;
<span class="hljs-attr">FC_ACCESS_KEY_SECRET</span>=&lt;your-access-key-secret&gt;
<span class="hljs-attr">FC_REGION_ID</span>=cn-hangzhou
<span class="hljs-comment"># 规格配置</span>
<span class="hljs-attr">FC_CPU</span>=<span class="hljs-number">2.0</span>
<span class="hljs-attr">FC_MEMORY</span>=<span class="hljs-number">2048</span>
<span class="hljs-comment"># 网络配置</span>
<span class="hljs-attr">FC_VPC_ID</span>=&lt;your-vpc-id&gt;
<span class="hljs-attr">FC_VSWITCH_IDS</span>=[&lt;your-vswitch-id&gt;]
<span class="hljs-attr">FC_SECURITY_GROUP_ID</span>=&lt;your-security-group-id&gt;
<span class="hljs-comment"># 前缀</span>
<span class="hljs-attr">FC_PREFIX</span>=agentscope-sandbox
<span class="hljs-comment"># 日志配置</span>
<span class="hljs-attr">FC_LOG_PROJECT</span>=&lt;your-sls-log-project&gt;
<span class="hljs-attr">FC_LOG_STORE</span>=&lt;your-sls-log-store&gt;
</code></pre>
<ol start="3">
<li>运行命令，启动沙箱服务器</li>
</ol>
<pre><code class="hljs language-arduino" lang="arduino">runtime-sandbox-server --config fc.env
</code></pre>
<ol start="4">
<li>使用您的沙箱</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> agentscope_runtime.sandbox <span class="hljs-keyword">import</span> BaseSandbox
<span class="hljs-comment"># 连接到远程服务器（替换为您的实际服务器地址和端口）</span>
<span class="hljs-keyword">with</span> BaseSandbox(
    base_url=<span class="hljs-string">"http://127.0.0.1:8000"</span>,
) <span class="hljs-keyword">as</span> sandbox:
    <span class="hljs-comment"># 正常使用沙箱</span>
    <span class="hljs-built_in">print</span>(box.list_tools())
    <span class="hljs-built_in">print</span>(box.run_ipython_cell(code=<span class="hljs-string">"print('hi')"</span>))
    <span class="hljs-built_in">print</span>(box.run_shell_command(command=<span class="hljs-string">"echo hello"</span>))
    <span class="hljs-built_in">input</span>(<span class="hljs-string">"Press Enter to continue..."</span>)
</code></pre>
<p>📚 详细文档请参考：沙箱部署指南 <strong>[</strong> <strong>4]</strong> 。</p>
<h2 data-id="heading-9">迈向“省钱又好用”的 AI 运行时</h2>
<p>AI Agent 的运行时基础设施正经历一场深刻的演进：从早期追求“能跑起来”的基础可用性，到关注开发体验与功能完备性的“好用”阶段，如今正加速迈向兼顾性能、安全与经济性的“省钱用”新范式。</p>
<p>AgentScope 与 Serverless 架构的深度集成，正是这一演进的关键实践。通过将智能体部署与工具执行全面迁移至基于<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Ffc%3Fspm%3Da1z389.11499242.0.0.65452413RXCQWs%26utm_content%3Dg_1000408146" target="_blank" title="https://www.aliyun.com/product/fc?spm=a1z389.11499242.0.0.65452413RXCQWs&amp;utm_content=g_1000408146" ref="nofollow noopener noreferrer">阿里云函数计算（FC）</a>的 Serverless 平台，不仅大幅降低了对容器编排、集群运维等云原生技能的依赖，更从根本上重构了资源使用模型——<strong>从“为闲置付费”转向“为实际执行付费”</strong> ，使中小团队乃至个人开发者也能以极低成本运行生产级 Agent 应用。</p>
<p>Serverless 所提供的毫秒级弹性、自动扩缩容、强隔离沙箱与零运维特性，恰好契合 AI Agent 应用典型的负载特征：间歇性调用、状态依赖性强、工具执行风险高、成本敏感度高。我们坚信，<strong>Serverless 将成为 AI Agent 应用的最佳运行时。</strong></p>
<p>未来，AgentScope 将持续深化与主流云服务的协同，进一步优化会话管理、冷启动延迟、多模态工具支持等关键路径，并推动更多开源智能体项目采纳 Serverless 范式，构建一个开放、高效、经济的 Agent 运行生态，让复杂智能体系统的开发与部署如同调用普通 API 一样简单可靠。</p>
<p><strong>让每一个智能体，都能轻盈运行在云端。</strong></p>
<p><strong>相关链接：</strong></p>
<p>[1] AgentScope</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fagentscope-ai%2Fagentscope%2F" target="_blank" title="https://github.com/agentscope-ai/agentscope/" ref="nofollow noopener noreferrer">github.com/agentscope-…</a></p>
<p>[2] AgentScope Runtime</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fagentscope-ai%2Fagentscope-runtime" target="_blank" title="https://github.com/agentscope-ai/agentscope-runtime" ref="nofollow noopener noreferrer">github.com/agentscope-…</a></p>
<p>[3] 部署指南</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fruntime.agentscope.io%2Fzh%2Fadvanced_deployment.html%23method-4-modelstudio-deployment" target="_blank" title="https://runtime.agentscope.io/zh/advanced_deployment.html#method-4-modelstudio-deployment" ref="nofollow noopener noreferrer">runtime.agentscope.io/zh/advanced…</a></p>
<p>[4] 沙箱部署指南</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fruntime.agentscope.io%2Fen%2Fsandbox%2Fadvanced.html%23optional-function-compute-fc-settings" target="_blank" title="https://runtime.agentscope.io/en/sandbox/advanced.html#optional-function-compute-fc-settings" ref="nofollow noopener noreferrer">runtime.agentscope.io/en/sandbox/…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 开发中的图片格式全指南]]></title>    <link>https://juejin.cn/post/7578922565209784347</link>    <guid>https://juejin.cn/post/7578922565209784347</guid>    <pubDate>2025-12-02T08:23:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578922565209784347" data-draft-id="7578836326474596379" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 开发中的图片格式全指南"/> <meta itemprop="keywords" content="Android,架构"/> <meta itemprop="datePublished" content="2025-12-02T08:23:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="北海道浪子"/> <meta itemprop="url" content="https://juejin.cn/user/729731450022440"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 开发中的图片格式全指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/729731450022440/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    北海道浪子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T08:23:51.000Z" title="Tue Dec 02 2025 08:23:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium.com%2Fproandroiddev%2Fthe-complete-guide-to-image-formats-in-android-development-4a1e1c86b265%3Futm_source%3Dchatgpt.com" target="_blank" title="https://medium.com/proandroiddev/the-complete-guide-to-image-formats-in-android-development-4a1e1c86b265?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">The Complete Guide to Image Formats in Android Development</a>
作者：Akshay Nandwana</p>
<hr/>
<h2 data-id="heading-0">Android 开发中的图片格式全指南</h2>
<h3 data-id="heading-1">简介</h3>
<p>在 Android 开发中，选择合适的图片格式对应用性能、用户体验，以及 APK 大小优化非常关键。本文系统地对 PNG、JPG、WebP、SVG（及 icon font）进行比较，分析它们的渲染性能、使用场景，以及最佳实践。</p>
<hr/>
<h3 data-id="heading-2">图片格式总览</h3>
<h4 data-id="heading-3">1. PNG (Portable Network Graphics)</h4>
<p><strong>PNG 是什么？</strong><br/>
PNG 是栅格图 (raster graphics) 格式，采用无损压缩 (lossless)，支持通过 alpha 通道实现透明 (full alpha channel)，是 Android 中经典的图片格式之一。</p>
<p><strong>技术特性</strong>：</p>
<ul>
<li>压缩方式：无损 (lossless)</li>
<li>透明度：支持完整 alpha 通道 (8-bit)</li>
<li>色深 (color depth)：最高可达 48-bit 色彩 (视工具/导出设定)</li>
<li>文件大小：对纯色、图标类图片通常较小；对照片类图片通常比 JPG 文件大。</li>
<li>动画支持：PNG 本身不支持动画 (虽然有 APNG，但 Android 支持有限)</li>
</ul>
<p><strong>渲染流程</strong>：</p>
<ol>
<li>加载 PNG 文件到内存</li>
<li>使用 DEFLATE 算法解压数据</li>
<li>解码为像素 (bitmap)</li>
<li>使用 Skia 图形引擎渲染到 Canvas</li>
<li>如果设备支持，启用硬件加速 (hardware acceleration)</li>
</ol>
<p><strong>性能指标 (典型状况)</strong> ：</p>
<ul>
<li>解码时间 (decode time)：中等，大致 10–50 ms (视图片复杂度和尺寸而定)</li>
<li>内存使用 (memory)：高 — 解码后的 bitmap 通常是宽 × 高 × 4 bytes (ARGB_8888)</li>
<li>渲染速度 (rendering speed)：快 (硬件加速)</li>
</ul>
<p><strong>适合使用 PNG 的场景</strong>：</p>
<ul>
<li>需要透明 / 半透明效果的 UI 元素 (例如按钮、带阴影或叠加的图标)</li>
<li>具有锐利边缘 (sharp edges) 的图形 (例如 logo、文字覆盖)</li>
<li>对画质要求高，不希望丢失质量 (如 app 图标、截图、应用商店图片)</li>
<li>Drawable 资源中需要透明背景、清晰边缘的图片</li>
</ul>
<p><strong>Android 特有注意事项</strong>：</p>
<ul>
<li>
<p>PNG 资源通常会被其打包工具 (aapt2) 自动压缩优化。</p>
</li>
<li>
<p>在布局中，你可以像下面这样使用：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;ImageView
    android:<span class="hljs-attr">src</span>=<span class="hljs-string">"@drawable/logo_transparent"</span>
    android:<span class="hljs-attr">contentDescription</span>=<span class="hljs-string">"App Logo"</span> /&gt;
</code></pre>
</li>
</ul>
<hr/>
<h4 data-id="heading-4">2. JPG / JPEG (Joint Photographic Experts Group)</h4>
<p><strong>JPG 是什么？</strong><br/>
JPG 是一种针对照片 (photographic images) 优化的有损压缩 (lossy) 格式，适合色彩连续、渐变丰富的图像。</p>
<p><strong>技术特性</strong>：</p>
<ul>
<li>压缩方式：有损 (lossy)，可调整质量 (quality)</li>
<li>透明度：不支持</li>
<li>色深：24-bit 色彩 (约 1670 万色)</li>
<li>文件大小：对于照片类图片，压缩效果非常好 — 通常比 PNG 小很多 (约 60–90% smaller)</li>
<li>压缩伪影 (artifacts)：在较低质量设置时会明显可见</li>
</ul>
<p><strong>渲染流程</strong>：</p>
<ol>
<li>加载 JPEG 文件</li>
<li>Huffman 解码 + 反量化 (dequantization)</li>
<li>逆离散余弦变换 (IDCT)</li>
<li>色彩空间转换 (YCbCr → RGB)</li>
<li>创建 bitmap 并渲染显示</li>
</ol>
<p><strong>性能指标</strong>：</p>
<ul>
<li>解码时间 (decode)：快 — 约 5–30 ms (视图片大小和质量)</li>
<li>内存使用：高 (与 PNG/WebP 相同，解码后为 bitmap)</li>
<li>渲染速度：快</li>
<li>文件大小：对于照片非常优势，照片通常比 PNG 小 3–10 倍 (取决于内容)</li>
</ul>
<p><strong>适合使用 JPG 的场景</strong>：</p>
<ul>
<li>照片 (用户头像、相册图片、背景图)</li>
<li>不需要透明度 (transparent) 的背景图、场景图像</li>
<li>图片尺寸较大且对下载/加载速度敏感 (网络加载、启动图 / splash screen)</li>
<li>照片类内容对质量要求不极端 (可接受轻微压缩伪影)</li>
</ul>
<p><strong>Android 特有建议</strong>：</p>
<p>当你使用图片加载库 (例如 Glide) 加载 JPG 时，可以考虑使用降低内存使用的配置，例如 <code>RGB_565</code> 而不是默认的 <code>ARGB_8888</code>。</p>
<pre><code class="hljs language-scss" lang="scss">Glide<span class="hljs-selector-class">.with</span>(context)
    <span class="hljs-selector-class">.load</span>(photoUrl)
    <span class="hljs-selector-class">.format</span>(DecodeFormat.PREFER_RGB_565)
    <span class="hljs-selector-class">.into</span>(imageView)
</code></pre>
<hr/>
<h4 data-id="heading-5">3. WebP</h4>
<p><strong>WebP 是什么？</strong><br/>
WebP 是 Google 提出的一种现代图像格式，既支持有损 (lossy) 又支持无损 (lossless) 压缩，还支持透明通道 (alpha) 和动画，是兼顾压缩效率与画质的格式。</p>
<p><strong>技术特性</strong>：</p>
<ul>
<li>压缩方式：既支持 lossy，也支持 lossless</li>
<li>透明度：支持完整 alpha 通道</li>
<li>文件大小：通常比 PNG 小 25–35%，比 JPG 也有约 25–34% 的压缩优势 (在等效质量下)</li>
<li>动画支持：支持 (比 GIF 效率更高)</li>
<li>Android 支持情况：从 Android 4.0 (API 14) 开始支持基本 WebP，从 Android 4.3 (API 18) 开始支持无损 + 透明通道。</li>
</ul>
<p><strong>渲染流程</strong>：</p>
<ol>
<li>加载 WebP 文件到内存</li>
<li>使用 VP8 / VP8L codec 解码 (预测 + 变换 / 块解码)</li>
<li>(Lossy 模式) block-based 解码；(lossless) pixel-based 解码</li>
<li>创建 bitmap</li>
<li>硬件加速渲染 (如果可用)</li>
</ol>
<p><strong>性能指标</strong>：</p>
<ul>
<li>解码时间 (decode)：略慢于 JPG，大约 10–40 ms (typical)</li>
<li>内存使用：解码后与其他栅格格式 (PNG / JPG) 相同 (bitmap)</li>
<li>渲染速度：快 (硬件加速)</li>
<li>文件大小：在栅格图像格式中压缩效率最高，被认为是“最优”折中方案</li>
</ul>
<p><strong>适合使用 WebP 的场景</strong>：</p>
<ul>
<li>当需要透明通道，又希望比 PNG 更小体积时 (例如 UI 图标、叠加图片)</li>
<li>照片 / 场景图像，既需要较好画质，又希望减小下载/存储大小时</li>
<li>网络加载 (网络图片) — 下载更快，占用更少带宽</li>
<li>动画 (相比 GIF 更好)</li>
<li>针对现代 Android 设备 (通常 minSdk ≥ 18) 的项目</li>
</ul>
<p><strong>Android 特有建议</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在 build.gradle 中启用 WebP 转换</span>
android {
    defaultConfig {
        <span class="hljs-comment">// 自动将可转换的 PNG 转换为 WebP</span>
        vectorDrawables.<span class="hljs-property">useSupportLibrary</span> = <span class="hljs-literal">true</span>
    }
}
<span class="hljs-comment">// 在 Coil 中使用 WebP</span>
imageView.<span class="hljs-title function_">load</span>(<span class="hljs-params">webpUrl</span>) {
    <span class="hljs-title function_">decoderFactory</span>(<span class="hljs-title class_">ImageDecoderDecoder</span>.<span class="hljs-title class_">Factory</span>())
}
</code></pre>
<hr/>
<h4 data-id="heading-6">4. SVG / 矢量图 (通过 VectorDrawable)</h4>
<p><strong>SVG / VectorDrawable 是什么？</strong><br/>
SVG 是一种基于矢量 (vector) 的图像格式 —— 用数学向量 (路径) 描述图形，而不是像素。这使得它在缩放 (不同分辨率、不同设备 DPI) 时不会失真。在 Android 中，通常使用 VectorDrawable（基于 SVG 路径规范，并做了 Android 特化）来表示矢量图。</p>
<p><strong>技术特性</strong>：</p>
<ul>
<li>类型：矢量图 (vector graphics)，由路径 (path) 数学描述构成。</li>
<li>可伸缩性 (scalability)：不论放大多少倍都不会失真 — 非常适合适配不同屏幕密度 (dpi) 的设备。</li>
<li>文件大小：对简单图形 (例如图标、logo) 来说非常小，通常 1–10 KB。</li>
<li>复杂度：复杂矢量 (如路径非常多、节点很多) 会影响性能 (首次渲染可能较慢)</li>
<li>动画支持：可通过 AnimatedVectorDrawable 实现动画效果 (对矢量路径做动画)</li>
</ul>
<p><strong>渲染流程</strong>：</p>
<ol>
<li>解析 XML 中的路径数据 (vector paths)</li>
<li>将路径数据转换为绘图命令 (drawing commands)</li>
<li>(首次) 软件渲染 (software rendering) 到 bitmap</li>
<li>缓存 bitmap，以便下次复用</li>
<li>使用硬件加速显示 (hardware-accelerated)</li>
</ol>
<p><strong>性能指标</strong>：</p>
<ul>
<li>首次渲染 (initial render)：对复杂矢量可能比较慢 (约 50–200 ms)</li>
<li>缓存后的渲染 (cached render)：非常快</li>
<li>内存使用：矢量数据本身几乎不占内存，cached bitmap 占用 moderate，大幅度小于等同大小的栅格图片 (bitmap)</li>
<li>可伸缩性 (scalability)：在任何 DPI 下都保持清晰、不失真</li>
</ul>
<p><strong>适合使用 VectorDrawable 的场景</strong>：</p>
<ul>
<li>简单图标、logo、小型 UI 元素</li>
<li>需要适配多种屏幕密度 (dpi) / 分辨率</li>
<li>需要动画图标 (Animated icons)</li>
<li>希望减小 APK 大小 / drawable 体积</li>
<li>UI 矢量图 (icons, 简洁形状) 优先使用矢量图 (比 bitmap 更合适)</li>
</ul>
<p><strong>不推荐使用矢量图的场景</strong>：</p>
<ul>
<li>复杂插画 / 高细节图 (如复杂图形、渐变、图片类内容) — 会影响渲染性能</li>
<li>照片 / 实景图像 (photographic content) — 不适合矢量化</li>
</ul>
<p>对于图标和小型图形，Android 官方建议优先使用矢量图 (VectorDrawable / SVG) 以便适配不同设备。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fandroid-docs.cn%2Fdesign%2Fui%2Fmobile%2Fguides%2Flayout-and-content%2Fimages-graphics%3Futm_source%3Dchatgpt.com" title="https://android-docs.cn/design/ui/mobile/guides/layout-and-content/images-graphics?utm_source=chatgpt.com" target="_blank" ref="nofollow noopener noreferrer">android-docs.cn</a>)</p>
<p><strong>Android-Specific 注意事项</strong>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- res/drawable/ic_heart.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">vector</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">android:width</span>=<span class="hljs-string">"24dp"</span>
    <span class="hljs-attr">android:height</span>=<span class="hljs-string">"24dp"</span>
    <span class="hljs-attr">android:viewportWidth</span>=<span class="hljs-string">"24"</span>
    <span class="hljs-attr">android:viewportHeight</span>=<span class="hljs-string">"24"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">path</span>
        <span class="hljs-attr">android:fillColor</span>=<span class="hljs-string">"#FF0000"</span>
        <span class="hljs-attr">android:pathData</span>=<span class="hljs-string">"M12,21.35l-1.45,-1.32C5.4,15.36 2,12.28 2,8.5 2,5.42 4.42,3 7.5,3c1.74,0 3.41,0.81 4.5,2.09C13.09,3.81 14.76,3 16.5,3 19.58,3 22,5.42 22,8.5c0,3.78 -3.4,6.86 -8.55,11.54L12,21.35z"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">vector</span>&gt;</span>
</code></pre>
<p>若项目需要兼容旧 Android 版本 (低于 API 21)，可以在 build.gradle 中启用 Support Library 的向量支持：</p>
<pre><code class="hljs language-ini" lang="ini">android {
    defaultConfig {
        <span class="hljs-attr">vectorDrawables.useSupportLibrary</span> = <span class="hljs-literal">true</span>
    }
}
</code></pre>
<hr/>
<h4 data-id="heading-7">5. Icon Fonts (TTF) / 字体图标</h4>
<p>除了图片／矢量图之外，也可以使用 TTF 字体 (icon fonts) 将图标作为字体 glyph —— 把图标当作文本字符处理 (icon as text)，这在某些场景也非常有用。</p>
<p><strong>为什么使用 Icon Fonts？</strong></p>
<ul>
<li>一个字体文件中可以包含数百、数千个图标 glyph</li>
<li>图标可像文本一样缩放 (无失真)、改变颜色、大小、阴影、样式</li>
<li>适合当图标集非常大、需要动态着色 (tint)、并希望跨平台 (Android / Web / iOS) 保持一致性</li>
</ul>
<p><strong>Android 中使用示例</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">// Kotlin 代码示例
val <span class="hljs-attr">typeface</span> = Typeface.createFromAsset(assets, <span class="hljs-string">"fonts/fontawesome.ttf"</span>)
<span class="hljs-attr">iconTextView.typeface</span> = typeface
<span class="hljs-attr">iconTextView.text</span> = <span class="hljs-string">"\uf004"</span> // heart icon 的 unicode glyph
</code></pre>
<p>或者在 XML 中 (例如使用 Material Icons)：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;TextView
    android:<span class="hljs-attr">fontFamily</span>=<span class="hljs-string">"@font/material_icons"</span>
    android:<span class="hljs-attr">text</span>=<span class="hljs-string">"&amp;#xe87d;"</span> /&gt;
</code></pre>
<p><strong>适用场景</strong>：</p>
<ul>
<li>包含大量 (100+ ) 图标集 (icon library)</li>
<li>需要动态改变图标颜色 (如主题色 / state tint)</li>
<li>希望图标在不同平台统一 (例如 Web / Android / iOS)</li>
</ul>
<p><strong>不适合场景</strong>：</p>
<ul>
<li>多色 / 多层 / 复杂图标 (icon fonts 一般是单色 glyph)</li>
<li>复杂图形 / 插画 / 渐变图标 — 矢量或位图更合适</li>
</ul>
<p><strong>Android-Specific 使用示例</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">val <span class="hljs-attr">typeface</span> = Typeface.createFromAsset(assets, <span class="hljs-string">"fonts/fontawesome.ttf"</span>)
<span class="hljs-attr">iconTextView.typeface</span> = typeface
<span class="hljs-attr">iconTextView.text</span> = <span class="hljs-string">"\uf004"</span> // heart icon 的 unicode glyph

</code></pre>
<p>或者在 XML 中 (例如使用 Material Icons)：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;TextView
    android:<span class="hljs-attr">fontFamily</span>=<span class="hljs-string">"@font/material_icons"</span>
    android:<span class="hljs-attr">text</span>=<span class="hljs-string">"&amp;#xe87d;"</span> /&gt;
</code></pre>
<hr/>
<h3 data-id="heading-8">综合比较表</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e03f6cb539134b37b29850f8cbde4e1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YyX5rW36YGT5rWq5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765268631&amp;x-signature=0wMd%2FVihnYwIAXcOX%2FO5jB4xsj0%3D" alt="2.webp" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-9">性能 / 内存 / 文件大小 对比 (Raster vs Vector vs Font Icon)</h3>
<p>以下是几个重要对比维度 (以典型使用场景为例)：</p>
<h4 data-id="heading-10">🔄 解码 / 渲染性能（以 500×500 px 图为例）</h4>

































<table><thead><tr><th>格式</th><th>解码 / 渲染时间</th></tr></thead><tbody><tr><td>JPG</td><td>5–15 ms</td></tr><tr><td>PNG</td><td>10–30 ms</td></tr><tr><td>WebP (lossy)</td><td>10–25 ms</td></tr><tr><td>WebP (lossless)</td><td>15–40 ms</td></tr><tr><td>VectorDrawable</td><td>首次渲染 50–200 ms；缓存后 &lt;1 ms</td></tr><tr><td>Icon Font (glyph)</td><td>&lt;1 ms (字体加载后)</td></tr></tbody></table>
<h4 data-id="heading-11">📦 内存 / 文件大小 / 缓存</h4>
<ul>
<li>对于一个 1080×1920（全屏）栅格图 (ARGB_8888)，Bitmap 大小为约 8 MB。</li>
<li>如果使用 RGB_565 (如果不需要 alpha)，则约为 4 MB。</li>
<li>VectorDrawable：矢量数据本身非常小 (KB 级)，cached bitmap 缓存后通常远小于栅格图。</li>
<li>Icon Fonts：字体资源共享，glyph 的渲染开销低，对内存占用 minimal。</li>
</ul>
<hr/>
<h3 data-id="heading-12">最佳实践 / 优化策略</h3>
<ul>
<li>对于图标、小型 UI 元素 (buttons, logos …)，优先使用矢量图 (VectorDrawable / SVG) — 体积小、可伸缩、适配各种 DPI。</li>
<li>对于照片、复杂图片 (背景图、相片等)，推荐使用 WebP (lossy)，在保证画质的同时极大减少文件大小。</li>
<li>对于需要透明通道 (alpha) 的图片 (icon、叠加图等)，可使用 WebP (lossless + transparency)，比 PNG 有更好的压缩比。</li>
<li>使用构建工具 (如在 <code>build.gradle</code> 中配置) 自动将合适的 PNG 转为 WebP，以减少 APK 大小。</li>
<li>在运行时 (runtime) 加载图片时，避免在主线程 (main thread) 解码 bitmaps，使用异步 (background) 解码 + 缓存，并在不需要时调用 <code>bitmap.recycle()</code> (如果不由图像库自动管理) 。</li>
<li>对于需要良好性能和低内存消耗的场景 (如列表 / 滚动界面 / 大量图片)，考虑使用较低内存配置 (如 RGB_565), 或对图片进行下采样 (downsampling), 并适当控制图片尺寸 (size)。</li>
</ul>
<hr/>
<h3 data-id="heading-13">格式选择 — 快速决策指南</h3>





























<table><thead><tr><th>场景 / 需求</th><th>推荐格式</th></tr></thead><tbody><tr><td>UI 图标 / 简单图形 / Logo / 可缩放图像</td><td>VectorDrawable (SVG)</td></tr><tr><td>有透明 / 半透明 UI 元素 (但需要压缩体积)</td><td>WebP (lossless + transparency) / PNG</td></tr><tr><td>照片 / 背景图 / 相册 / 网络图片</td><td>WebP (lossy) 或 JPG</td></tr><tr><td>动画 (简单动画图标 / 矢量动画)</td><td>AnimatedVectorDrawable 或 WebP 动画</td></tr><tr><td>大量图标 / 图标库 (icon fonts)</td><td>Icon Font (glyph) 或 VectorDrawable</td></tr></tbody></table>
<blockquote>
<p>📝 <strong>建议默认策略 (现代 Android 项目, 目标 API 18+)</strong></p>
<ul>
<li>图标 &amp; 简单图形：使用矢量图 (VectorDrawable)</li>
<li>照片 / 复杂图像：使用 WebP (lossy)</li>
<li>带透明通道 / UI 叠加图：使用 WebP (lossless) 或 PNG</li>
<li>动画：AnimatedVectorDrawable / WebP animation</li>
<li>大量图标 / 图标集：Icon Font 或 VectorDrawable</li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-14">总结</h3>
<p>选择合适的图片格式对于 Android 应用性能、资源管理、包体积和用户体验都有深远影响。</p>
<ul>
<li><strong>PNG</strong> 和 <strong>JPG</strong> 虽然经典，但往往不是最优，适合特定场景 (透明 PNG / 照片 JPG) 。</li>
<li><strong>WebP</strong> 在绝大多数情况下是最佳折中 — 压缩率高、支持透明和动画、兼容性好，是现代 Android 应用推荐格式。</li>
<li><strong>VectorDrawable</strong> (SVG) 则是图标 / UI 元素 / logo 的首选 —— 小体积、可缩放、适配多 DPI，是现代响应式 UI 的基础。</li>
<li>对于图标集 (“icon fonts”)，使用字体或矢量图，可以极大节省空间并保持灵活性。</li>
</ul>
<p>总之，在开发中应根据图片内容 (图标 vs 照片)、用途 (UI 元素 vs 背景 / 内容图)、是否需要透明 / 动画 / 可缩放性等维度综合考量，并结合工具和构建流程 (如自动转换 WebP) 最大化优化效果。</p>
<hr/>
<p>下面附赠免费使用的ai站点，可使用claude code和codex
<strong><a href="https://link.juejin.cn/?target=https%3A%2F%2Fapi.codemirror.codes%2Fregister%3Faff%3DUqVb" title="https://link.juejin.cn/?target=https%3A%2F%2Fapi.codemirror.codes%2Fregister%3Faff%3DUqVb" target="_blank">codemirror</a></strong></p>
<p><strong><a href="https://link.juejin.cn/?target=https%3A%2F%2Fapi520.pro%2Fregister%3Faff%3DZLio" title="https://link.juejin.cn/?target=https%3A%2F%2Fapi520.pro%2Fregister%3Faff%3DZLio" target="_blank">熊猫api</a></strong></p>
<p><strong><a href="https://link.juejin.cn/?target=https%3A%2F%2Fwww.ohmygpt.com%2Fi%2F3IDF2786" title="https://link.juejin.cn/?target=https%3A%2F%2Fwww.ohmygpt.com%2Fi%2F3IDF2786" target="_blank">ohmygpt</a></strong></p>
<p><strong><a href="https://link.juejin.cn/?target=https%3A%2F%2Faicoding.sh%2Fi%2F1JLj77Edqf" title="https://link.juejin.cn/?target=https%3A%2F%2Faicoding.sh%2Fi%2F1JLj77Edqf" target="_blank">aicoding</a></strong></p>
<p><strong><a href="https://link.juejin.cn/?target=https%3A%2F%2Fapi4model.com%2Fregister%3Faff%3D35nk" title="https://link.juejin.cn/?target=https%3A%2F%2Fapi4model.com%2Fregister%3Faff%3D35nk" target="_blank">api4model</a></strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从字面量到原型链：JavaScript 面向对象的完整进化史]]></title>    <link>https://juejin.cn/post/7578901433971163136</link>    <guid>https://juejin.cn/post/7578901433971163136</guid>    <pubDate>2025-12-02T08:10:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578901433971163136" data-draft-id="7578877638988152832" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从字面量到原型链：JavaScript 面向对象的完整进化史"/> <meta itemprop="keywords" content="JavaScript,设计模式"/> <meta itemprop="datePublished" content="2025-12-02T08:10:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Tzarevich"/> <meta itemprop="url" content="https://juejin.cn/user/578786070367529"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从字面量到原型链：JavaScript 面向对象的完整进化史
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/578786070367529/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Tzarevich
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T08:10:10.000Z" title="Tue Dec 02 2025 08:10:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><h2 data-id="heading-0">从字面量到原型链：JavaScript 面向对象的完整进化史</h2>
<p>JavaScript 是一门<strong>基于对象（Object-based）</strong> 的语言——你几乎接触到的一切都是对象，甚至连 <code>1</code>、<code>'hello'</code> 这样的原始值，在需要时也会被自动包装成 <code>Number</code>、<code>String</code> 对象。然而，JavaScript 并不是传统意义上的“面向对象语言”（如 Java 或 C++），它没有类（class）的概念（直到 ES6 才引入语法糖形式的 <code>class</code>），其核心机制是<strong>原型（Prototype）</strong> 。</p>
<p>那么，在没有 <code>class</code> 的年代，我们如何用 JavaScript 实现面向对象编程（OOP）？本文将带你从最原始的对象字面量出发，逐步演进到成熟的原型继承模式，理解 JS OOP 的本质。</p>
<hr/>
<h3 data-id="heading-1">一、起点：对象字面量（Object Literal）</h3>
<p>最简单的创建对象方式：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> cat1 = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'小白'</span>,
  <span class="hljs-attr">color</span>: <span class="hljs-string">'白色'</span>,
  <span class="hljs-attr">type</span>: <span class="hljs-string">'猫科动物'</span>,
  <span class="hljs-title function_">eat</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'喜欢 Jerry'</span>);
  }
};

<span class="hljs-keyword">const</span> cat2 = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'小黑'</span>,
  <span class="hljs-attr">color</span>: <span class="hljs-string">'黑色'</span>,
  <span class="hljs-attr">type</span>: <span class="hljs-string">'猫科动物'</span>,
  <span class="hljs-title function_">eat</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'喜欢 Jerry'</span>);
  }
};
</code></pre>
<p>✅ <strong>优点</strong>：简单直观。<br/>
❌ <strong>缺点</strong>：</p>
<ul>
<li>代码重复；</li>
<li>无法批量生成相似对象；</li>
<li>实例之间没有“类型”关联，无法判断 <code>cat1</code> 是否属于“猫”。</li>
</ul>
<blockquote>
<p>这只是“数据容器”，不是“类”的实例。</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">二、进化：构造函数模式（Constructor Pattern）</h3>
<p>为了解决复用问题，我们封装一个函数来生成对象：</p>
<pre><code class="hljs language-ini" lang="ini">function Cat(name, color) {
  <span class="hljs-attr">this.name</span> = name<span class="hljs-comment">;</span>
  <span class="hljs-attr">this.color</span> = color<span class="hljs-comment">;</span>
  <span class="hljs-attr">this.type</span> = <span class="hljs-string">'猫科动物'</span><span class="hljs-comment">;</span>
  <span class="hljs-attr">this.eat</span> = function() {
    console.log('喜欢 Jerry')<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
}

const <span class="hljs-attr">cat1</span> = new Cat(<span class="hljs-string">'小白'</span>, <span class="hljs-string">'白色'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">cat2</span> = new Cat(<span class="hljs-string">'小黑'</span>, <span class="hljs-string">'黑色'</span>)<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-3"><code>new</code> 调用时发生了什么？</h4>
<ol>
<li>创建一个空对象 <code>{}</code>；</li>
<li>将 <code>this</code> 指向这个空对象；</li>
<li>执行函数体，给 <code>this</code> 添加属性和方法；</li>
<li>返回这个新对象（除非显式返回其他对象）。</li>
</ol>
<p>✅ <strong>优点</strong>：</p>
<ul>
<li>可批量创建实例；</li>
<li>实例可通过 <code>instanceof Cat</code> 判断类型；</li>
<li>实例间有了“关系”。</li>
</ul>
<p>❌ <strong>致命缺点</strong>：</p>
<ul>
<li>每个实例都拥有自己的一份 <code>eat</code> 方法 → <strong>内存浪费</strong>；</li>
<li>公共属性（如 <code>type</code>）也无法共享。</li>
</ul>
<hr/>
<h3 data-id="heading-4">三、优化：原型模式（Prototype Pattern）</h3>
<p>JavaScript 的核心思想：<strong>把不变的、公共的部分放到原型上</strong>。</p>
<pre><code class="hljs language-ini" lang="ini">function Cat(name, color) {
  <span class="hljs-attr">this.name</span> = name<span class="hljs-comment">;</span>
  <span class="hljs-attr">this.color</span> = color<span class="hljs-comment">;</span>
}

<span class="hljs-attr">Cat.prototype.type</span> = <span class="hljs-string">'猫科动物'</span><span class="hljs-comment">;</span>
<span class="hljs-attr">Cat.prototype.eat</span> = function() {
  console.log('喜欢 Jerry')<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

const <span class="hljs-attr">cat1</span> = new Cat(<span class="hljs-string">'小白'</span>, <span class="hljs-string">'白色'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">cat2</span> = new Cat(<span class="hljs-string">'小黑'</span>, <span class="hljs-string">'黑色'</span>)<span class="hljs-comment">;</span>

console.log(<span class="hljs-attr">cat1.eat</span> === cat2.eat)<span class="hljs-comment">; // true ✅ 共享同一个方法</span>
</code></pre>
<h4 data-id="heading-5">原型链机制</h4>
<ul>
<li>每个函数都有一个 <code>prototype</code> 属性（指向原型对象）；</li>
<li>每个实例都有一个内部链接 <code>[[Prototype]]</code>（在浏览器中可通过 <code>__proto__</code> 访问），指向其构造函数的 <code>prototype</code>；</li>
<li>当访问属性时，JS 会先查实例自身，再沿原型链向上查找。</li>
</ul>
<p>✅ <strong>优点</strong>：</p>
<ul>
<li>方法和公共属性<strong>共享</strong>，节省内存；</li>
<li>支持动态扩展：<code>Cat.prototype.sleep = ...</code> 所有实例立即可用。</li>
</ul>
<hr/>
<h3 data-id="heading-6">四、进阶：继承（Inheritance）</h3>
<p>OOP 的三大特性之一是<strong>继承</strong>。在 JS 中，如何让 <code>Cat</code> 继承 <code>Animal</code>？</p>
<h4 data-id="heading-7">1. 借用构造函数（继承实例属性）</h4>
<pre><code class="hljs language-ini" lang="ini">function Animal() {
  <span class="hljs-attr">this.species</span> = <span class="hljs-string">'动物'</span><span class="hljs-comment">;</span>
}

function Cat(name, color) {
  // 关键：让 Animal 的 this 指向当前 Cat 实例
  Animal.apply(this, arguments)<span class="hljs-comment">;</span>
  <span class="hljs-attr">this.name</span> = name<span class="hljs-comment">;</span>
  <span class="hljs-attr">this.color</span> = color<span class="hljs-comment">;</span>
}
</code></pre>
<ul>
<li><code>Animal.apply(this)</code>：<strong>借用父类构造函数</strong>，将 <code>species</code> 添加到子类实例上。</li>
<li>✅ 继承了<strong>实例属性</strong>；</li>
<li>❌ <strong>未继承原型方法</strong>（如 <code>Animal.prototype.move</code>）。</li>
</ul>
<h4 data-id="heading-8">2. 设置原型链（继承原型方法）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 让 Cat.prototype 的原型指向 Animal.prototype</span>
<span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
<span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Cat</span>; <span class="hljs-comment">// 修复 constructor 指向</span>

<span class="hljs-comment">// 补充 Cat 自己的方法</span>
<span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">purr</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'呼噜呼噜~'</span>);
};
</code></pre>
<p>现在，<code>Cat</code> 实例既能访问 <code>species</code>（来自 <code>Animal</code> 构造函数），也能调用 <code>move()</code>（来自 <code>Animal.prototype</code>）。</p>
<hr/>
<h3 data-id="heading-9">五、现代写法：ES6 <code>class</code>（语法糖）</h3>
<p>ES6 引入了 <code>class</code> 语法，但底层仍是原型：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">species</span> = <span class="hljs-string">'动物'</span>;
  }
  <span class="hljs-title function_">move</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'I can move!'</span>);
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name, color</span>) {
    <span class="hljs-variable language_">super</span>(); <span class="hljs-comment">// 等价于 Animal.apply(this)</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">color</span> = color;
  }
  <span class="hljs-title function_">purr</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'呼噜呼噜~'</span>);
  }
}
</code></pre>
<ul>
<li><code>extends</code> → 设置原型链；</li>
<li><code>super()</code> → 借用父类构造函数；</li>
<li>一切更清晰，但<strong>本质仍是原型继承</strong>。</li>
</ul>
<hr/>
<h3 data-id="heading-10">六、总结：JS OOP 的演进路径</h3>









































<table><thead><tr><th>阶段</th><th>方式</th><th>核心思想</th><th>缺陷</th></tr></thead><tbody><tr><td>1</td><td>对象字面量</td><td>直接写对象</td><td>无法复用，无类型关系</td></tr><tr><td>2</td><td>构造函数</td><td>封装生成过程</td><td>方法不共享，内存浪费</td></tr><tr><td>3</td><td>原型模式</td><td>公共部分放原型</td><td>属性/方法分离，需手动管理</td></tr><tr><td>4</td><td>原型继承</td><td><code>apply</code> + <code>Object.create</code></td><td>写法繁琐，易出错</td></tr><tr><td>5</td><td>ES6 <code>class</code></td><td>语法糖封装</td><td>底层仍是原型，需理解本质</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>关键认知</strong>：<br/>
JavaScript 的 OOP 不是“类继承”，而是“<strong>对象委托</strong>”——通过原型链，对象可以<strong>委托</strong>给另一个对象处理自己不会的事情。</p>
</blockquote>
<p>掌握从字面量到原型继承的全过程，你才算真正理解了 JavaScript 面向对象的精髓。即使今天使用 <code>class</code>，也要明白：<strong><code>class</code> 只是原型的语法糖，而原型才是 JS OOP 的灵魂</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我写了一个VSCode的仿Neovide光标动画]]></title>    <link>https://juejin.cn/post/7578917474659352627</link>    <guid>https://juejin.cn/post/7578917474659352627</guid>    <pubDate>2025-12-02T08:44:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578917474659352627" data-draft-id="7578922565209800731" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我写了一个VSCode的仿Neovide光标动画"/> <meta itemprop="keywords" content="Visual Studio Code,前端"/> <meta itemprop="datePublished" content="2025-12-02T08:44:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LengineerC"/> <meta itemprop="url" content="https://juejin.cn/user/1707958031887840"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我写了一个VSCode的仿Neovide光标动画
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1707958031887840/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LengineerC
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T08:44:56.000Z" title="Tue Dec 02 2025 08:44:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Neovide的灵魂之一就是它的光标动画（<del>我就是图这个才用neovim的</del>），还好VSCode中有一个插件<a href="https://link.juejin.cn?target=https%3A%2F%2Fmarketplace.visualstudio.com%2Fitems%3FitemName%3Dbe5invis.vscode-custom-css" target="_blank" title="https://marketplace.visualstudio.com/items?itemName=be5invis.vscode-custom-css" ref="nofollow noopener noreferrer">Custom CSS and JS Loader</a>，支持我们自己向注入CSS和JS，因此可以使用这个途径，直接写个注入脚本，检测VSCode编辑区的光标，然后挂载canvas实现动画效果。具体的动画实现参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fneovide%2Fneovide" target="_blank" title="https://github.com/neovide/neovide" ref="nofollow noopener noreferrer">neovide: No Nonsense Neovim Client in Rust</a>的源码，至于光标的检测是参考的reddit上一个大佬的代码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.reddit.com%2Fr%2Fvscode%2Fcomments%2F11e66xh%2Fi_made_neovide_alike_cursor_effect_on_vscode%2F" target="_blank" title="https://www.reddit.com/r/vscode/comments/11e66xh/i_made_neovide_alike_cursor_effect_on_vscode/" ref="nofollow noopener noreferrer">I made neovide alike cursor effect on vscode</a>。</p>
<h2 data-id="heading-0">实现效果</h2>
<p>话不多说先看效果</p>
<h3 data-id="heading-1">单个光标</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6df303ddf95642c6a2cfbbad2114a2a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVuZ2luZWVyQw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270136&amp;x-signature=pxpPGELredfv5nIJXrlwkfe4qCo%3D" alt="2025-12-02 16-20-37.gif" loading="lazy"/></p>
<h3 data-id="heading-2">多个光标</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6097c892ae2d413882c8c24bccb84b0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVuZ2luZWVyQw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270136&amp;x-signature=mui%2F8pMXzuZRPXE1ud%2Fw53qQYUI%3D" alt="2025-12-02 16-21-29.gif" loading="lazy"/></p>
<h2 data-id="heading-3">现有问题</h2>
<p>reddit上面大佬的代码只兼容单个光标，当有多个光标时，他的动画绑定就有问题，有时失效乱飘，但是他的代码在分屏时可以处理屏间光标跳转。对于我个人而言，多光标操作还是很频繁的，所以优先处理了多光标适配，大致原理就是给每个光标dom节点绑定一个自定义的id属性，但是由于分屏之后两个vscode两个分屏中的cursor不是同一个实例，所以原代码的跨屏动画就没有了，不过每个分屏中的动画还是能正常运行的。</p>
<h2 data-id="heading-4">使用方式</h2>
<p>github链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FLengineerC%2Fvscode-neovide-cursor%2Ftree%2Fmain" target="_blank" title="https://github.com/LengineerC/vscode-neovide-cursor/tree/main" ref="nofollow noopener noreferrer">LengineerC/vscode-neovide-cursor: A Neovide like cursor animation for VS Code</a></p>
<p>下载<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FLengineerC%2Fvscode-neovide-cursor%2Fblob%2Fmain%2Fneovide-cursor.js" title="https://github.com/LengineerC/vscode-neovide-cursor/blob/main/neovide-cursor.js" target="_blank" ref="nofollow noopener noreferrer">neovide-cursor.js</a>，或直接复制代码自己找个文件保存。</p>
<p>VSCode安装<code>Custom CSS and JS loader</code>插件，
向<code>settings.json</code>添加配置:</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-string">``</span><span class="hljs-string">`
"vscode_custom_css.imports": [
    "file:///C:/path/to/your/neovide-cursor.js"
]
`</span><span class="hljs-string">``</span>
</code></pre>
<p>然后<code>ctrl</code>+<code>shift</code>+<code>p</code>执行<code>Enable Custom CSS and JS</code>后重启VSCode即可</p>
<p>修改配置的话保存修改后重新执行<code>Enable Custom CSS and JS</code>或<code>Reload Custom CSS and JS</code>就行</p>
<p>有bug欢迎提出issue！！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Mongoose操作MongoDB数据库（1）：项目创建与连接配置]]></title>    <link>https://juejin.cn/post/7578901433971523584</link>    <guid>https://juejin.cn/post/7578901433971523584</guid>    <pubDate>2025-12-02T08:46:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578901433971523584" data-draft-id="7578693994367975424" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Mongoose操作MongoDB数据库（1）：项目创建与连接配置"/> <meta itemprop="keywords" content="MongoDB,前端"/> <meta itemprop="datePublished" content="2025-12-02T08:46:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="WangHappy"/> <meta itemprop="url" content="https://juejin.cn/user/2137106336976183"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Mongoose操作MongoDB数据库（1）：项目创建与连接配置
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2137106336976183/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    WangHappy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T08:46:25.000Z" title="Tue Dec 02 2025 08:46:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是WangHappy，一名<code>主业前端，副业全栈</code>的程序员，在这里我会分享关于<code>前端进阶全栈的常用技术</code> 和 <code>基本入门操作</code>。 如果我的文章能让您有所收获，欢迎一键三连（评论，点赞，关注）。</p>
<hr/>
<h3 data-id="heading-0">Mongoose介绍</h3>
<p>Mongoose 是为Node.js设计的一个 MongoDB 的对象数据建模库。目的是为了服务端与 MongoDB 数据库进行交互时提供更简化的数据库操作接口。</p>
<blockquote>
<p>使用 Mongoose 需要掌握的前置条件：</p>
<p>1.需要掌握的知识：<code>Node.js、MongoDB、Express/koa框架</code>。</p>
<p>2.确保电脑已安装Node.js，且版本在 Node16 以上。可以打开cmd终端，输入 <code>node -v</code> 来确认Node安装的版本。</p>
<p>3.确认已在本地或服务器启动MongoDB数据服务，可参考我之前的系列文章 <a href="https://juejin.cn/post/7568405112269602852" target="_blank" title="https://juejin.cn/post/7568405112269602852">Windows系统搭建MongoDB</a> 来实现数据库的安装、配置、部署。</p>
</blockquote>
<p>本专题我们将使用 <code>Node.js + Express + Mongoose</code> 来实现服务端的开发。</p>
<h3 data-id="heading-1">创建项目</h3>
<p>新建一个文件夹，项目名称自定义（不要使用中文名称）。</p>
<p>打开终端，进入到项目文件夹，在根目录下执行 <code>Node.js</code> 初始化命令：</p>
<pre><code class="hljs language-csharp" lang="csharp">npm <span class="hljs-keyword">init</span> -y
</code></pre>
<p>项目目录下会自动生成一个 <code>package.json</code> 的文件。</p>
<pre><code class="hljs language-swift" lang="swift">{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"myproject"</span>,
  <span class="hljs-string">"version"</span>: <span class="hljs-string">"1.0.0"</span>,
  <span class="hljs-string">"description"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-string">"main"</span>: <span class="hljs-string">"index.js"</span>,
  <span class="hljs-string">"scripts"</span>: {
    <span class="hljs-string">"test"</span>: <span class="hljs-string">"echo <span class="hljs-subst">\"</span>Error: no test specified<span class="hljs-subst">\"</span> &amp;&amp; exit 1"</span>
  },
  <span class="hljs-string">"keywords"</span>: [],
  <span class="hljs-string">"author"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-string">"license"</span>: <span class="hljs-string">"ISC"</span>
}
</code></pre>
<p>我们简单来了解几个比较重要的字段：</p>
<p><code>name</code>：表示项目的名称。</p>
<p><code>version</code>：项目的版本（默认是1.0.0）。</p>
<p><code>main</code>：入口文件，默认是 <code>index.js</code>。</p>
<p><code>scripts</code>：定义一些常用的命令。</p>
<h3 data-id="heading-2">安装主要依赖</h3>
<p>完成初始化项目后，继续在终端安装项目所需的依赖，执行以下命令：</p>
<pre><code class="hljs language-css" lang="css">npm <span class="hljs-selector-tag">i</span> express cors dotenv nodemon
</code></pre>
<p><code>express</code>：Node.js最流行的框架之一，用来处理服务端的路由，中间件，静态文件等服务。</p>
<p><code>cors</code>： 解决跨域请求的问题。</p>
<p><code>dotenv</code>：读取.env文件中的环境变量，.env文件通常配置数据库的IP地址，用户名，密码...等重要隐私信息。</p>
<p><code>nodemon</code>：监控服务端代码变化并自动更新，避免每次修改服务端代码都需要重启服务的繁琐流程。</p>
<h3 data-id="heading-3">启动 Node.js 服务</h3>
<p>相关依赖安装完成后，在项目根目录下分别创建 <code>index.js</code> 和 <code>.env</code> 文件</p>
<pre><code class="hljs language-go" lang="go">📦myproject
 ┣ 📜.evn
 ┣ 📜index.js
 ┗ 📜<span class="hljs-keyword">package</span>.json
</code></pre>
<p><code>index.js</code> 作为服务端入口文件，与前文提到的 package.json 中的 main 入口文件相对应。代码如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>) <span class="hljs-comment">// 引入express框架</span>
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>() <span class="hljs-comment">// 创建一个 express 应用实例</span>
<span class="hljs-keyword">const</span> cors = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cors'</span>) <span class="hljs-comment">// 引入 cors 中间件</span>
<span class="hljs-built_in">require</span>(<span class="hljs-string">'dotenv'</span>).<span class="hljs-title function_">config</span>() <span class="hljs-comment">// 加载环境变量</span>

app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">cors</span>()) <span class="hljs-comment">// 启用 cors 中间件，允许跨域请求</span>
app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">urlencoded</span>({ <span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span> })) <span class="hljs-comment">// 处理 application/x-www-form-urlencoded 请求体，解析表单数据</span>

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PORT</span> = process.<span class="hljs-property">env</span>.<span class="hljs-property">PORT</span> || <span class="hljs-number">3000</span> <span class="hljs-comment">// 配置访问端口号</span>
app.<span class="hljs-title function_">listen</span>(<span class="hljs-variable constant_">PORT</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Server is running on port <span class="hljs-subst">${PORT}</span>`</span>);
}) <span class="hljs-comment">// 监听服务，如果服务正常启动会打印该文字</span>
</code></pre>
<p><code>.env</code> 文件用来配置数据库端口、IP、账号、密码，配置如下：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># MongoDB 配置</span>
<span class="hljs-attr">MONGO_USERNAME</span>=your_name <span class="hljs-comment"># 数据库账号</span>
<span class="hljs-attr">MONGO_PASSWORD</span>=your_password <span class="hljs-comment"># 数据库密码</span>
<span class="hljs-attr">MONGO_HOST</span>=<span class="hljs-number">192.168</span>.<span class="hljs-number">0.0</span> <span class="hljs-comment"># 数据库ip地址</span>
<span class="hljs-attr">MONGO_PORT</span>=<span class="hljs-number">27017</span> <span class="hljs-comment"># 端口号，MongoDB通常为27017</span>
<span class="hljs-attr">MONGO_DATABASE</span>=test <span class="hljs-comment"># 要访问的MongoDB 实例下的数据库 </span>

<span class="hljs-comment"># 服务器端口号配置</span>
<span class="hljs-attr">PORT</span>=<span class="hljs-number">3000</span>
</code></pre>
<p><strong>注意：如果项目是使用 git 管理的，那在一定要在 <code>.gitgnore</code> 文件里将 <code>.env</code> 添加进去，避免将<code>.env</code> 文件上传到git仓库中，从而导致隐私信息泄露。</strong></p>
<p>现在我们来启动Node服务，在 <code>package.json</code> 文件中找到 <code>scripts</code>，添加一条常用命令，代码如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
   <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"nodemon index.js"</span>
 <span class="hljs-punctuation">}</span>
</code></pre>
<p>保存文件，然后在项目根目录下打开终端，执行 <code>npm run start</code>。</p>
<p>此时如果终端输出 <code>Server is running on port 3000</code> 代表 Node 服务已经成功启动。</p>
<h3 data-id="heading-4">使用Mongoose连接数据库</h3>
<p>现在执行最后一步，使用 <code>Mongoose</code> 连接 <code>MongoDB</code> 数据库。</p>
<p>首先在项目里安装 <code>Mongoose</code>，在项目中打开终端执行 <code>npm i mongoose</code>。</p>
<p>安装完成后，在入口文件 <code>index.js</code> 中使用 <code>Mongoose</code>, 添加代码如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>) <span class="hljs-comment">// 引入mongoose</span>

<span class="hljs-comment">// 从.env文件中获取环境变量构建 MongoDB 连接字符串</span>
<span class="hljs-comment">// process.env.MONGO_USERNAME：用户名</span>
<span class="hljs-comment">// process.env.MONGO_PASSWORD：密码</span>
<span class="hljs-comment">// process.env.MONGO_HOST：IP地址</span>
<span class="hljs-comment">// process.env.MONGO_PORT：端口号</span>
<span class="hljs-comment">// process.env.MONGO_DATABASE：要连接的数据库</span>

<span class="hljs-keyword">const</span> mongoURL = <span class="hljs-string">`mongodb://<span class="hljs-subst">${process.env.MONGO_USERNAME}</span>:<span class="hljs-subst">${process.env.MONGO_PASSWORD}</span>@<span class="hljs-subst">${process.env.MONGO_HOST}</span>:<span class="hljs-subst">${process.env.MONGO_PORT}</span>/<span class="hljs-subst">${process.env.MONGO_DATABASE}</span>`</span>;

mongoose.<span class="hljs-title function_">connect</span>(mongoURL, {
  <span class="hljs-attr">authSource</span>: <span class="hljs-string">'admin'</span> <span class="hljs-comment">// 指定用户的数据库进行身份验证，默认情况下，认证数据库是 `admin`</span>
})

<span class="hljs-comment">// 连接数据库成功返回的信息</span>
mongoose.<span class="hljs-property">connection</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'connected'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Connected to MongoDB'</span>)
})

<span class="hljs-comment">// 连接失败返回错误信息</span>
mongoose.<span class="hljs-property">connection</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'MongoDB connection error: '</span> + err)
})

<span class="hljs-comment">// 中断连接返回的提示</span>
mongoose.<span class="hljs-property">connection</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'disconnected'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'MongoDB disconnected'</span>)
})
</code></pre>
<p>代码添加完成后，在项目目录下执行 <code>npm run start</code> 重启服务。</p>
<p>终端如果打印 <code>Connected to MongoDB</code>，则代表连接数据库成功。</p>
<hr/>
<p>至此，我们已经完成了Node项目的创建，并成功的使用 <code>Mongoose</code> 连接上了数据库。</p>
<p>在下一章，我们将学习了解如何使用 <code>Mongoose</code> 定义数据模型并实现基本的增、删、改、查等操作。</p>
<p>如果我的文章能让您有所收获，欢迎一键三连（评论，点赞，关注），感谢！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RelativeLayout 根布局里有一个子布局预期一直展示，但子布局RelativeLayout被 覆盖了]]></title>    <link>https://juejin.cn/post/7578917474658713651</link>    <guid>https://juejin.cn/post/7578917474658713651</guid>    <pubDate>2025-12-02T07:23:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578917474658713651" data-draft-id="7578803491822895131" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RelativeLayout 根布局里有一个子布局预期一直展示，但子布局RelativeLayout被 覆盖了"/> <meta itemprop="keywords" content="前端,Java,Android"/> <meta itemprop="datePublished" content="2025-12-02T07:23:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="lichong951"/> <meta itemprop="url" content="https://juejin.cn/user/1486195453865687"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RelativeLayout 根布局里有一个子布局预期一直展示，但子布局RelativeLayout被 覆盖了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1486195453865687/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    lichong951
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T07:23:13.000Z" title="Tue Dec 02 2025 07:23:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>原因一句话
<code>LinearLayout</code> 宽高都是 <code>match_parent</code>，又在 <code>RelativeLayout</code> 里 <strong>默认不设置任何相对位置</strong>，于是它把父布局空间全部占满，之前靠 <code>align*</code> 或 <code>margin</code> 定位的子控件自然被盖住。</p>
<hr/>
<p>解决思路（3 选 1）</p>
<ol>
<li>让 LinearLayout <strong>只占剩余区域</strong>，而不是全屏
给前面那个需要“一直展示”的控件一个 id，然后让 LinearLayout 用剩余规则：</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 顶部固定条，始终可见 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">TextView</span>
    <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/title"</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"48dp"</span>
    <span class="hljs-attr">android:text</span>=<span class="hljs-string">"标题栏"</span>
    <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">"center"</span>
    <span class="hljs-attr">android:background</span>=<span class="hljs-string">"@color/colorPrimary"</span>/&gt;</span>

<span class="hljs-comment">&lt;!-- 内容区，只占剩余 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"0dp"</span>
    <span class="hljs-attr">android:layout_below</span>=<span class="hljs-string">"@id/title"</span>      &lt;!<span class="hljs-attr">--</span> <span class="hljs-attr">关键</span>：<span class="hljs-attr">在标题下方</span> <span class="hljs-attr">--</span>&gt;</span>
    android:orientation="vertical"&gt;
    <span class="hljs-comment">&lt;!-- 你的内容 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span>
</code></pre>
<ol start="2">
<li>把 LinearLayout 改成 <strong>wrap_content</strong> 或固定值
如果你只是想弹个面板，就别让它 <code>match_parent</code>：</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
    <span class="hljs-attr">android:layout_centerInParent</span>=<span class="hljs-string">"true"</span>
    <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">"vertical"</span>&gt;</span>
</code></pre>
<ol start="3">
<li>用 <code>layout_weight</code>（嵌套一层 LinearLayout）
顶层改成横向或纵向 <code>LinearLayout</code>，把“始终展示”的 view 放 <code>weight=0</code>，内容区放 <code>weight=1</code> 即可。</li>
</ol>
<hr/>
<p>一句话总结
<strong>别让 LinearLayout 又满屏又不相对定位</strong>；给前面控件加 <code>id</code>，再用 <code>layout_below / layout_above / layout_alignParentBottom</code> 等规则把空间切出来，就不会覆盖。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Android】Binder机制浅析]]></title>    <link>https://juejin.cn/post/7578876665695682569</link>    <guid>https://juejin.cn/post/7578876665695682569</guid>    <pubDate>2025-12-02T08:02:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578876665695682569" data-draft-id="7578917474659057715" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Android】Binder机制浅析"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-02T08:02:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="弥巷"/> <meta itemprop="url" content="https://juejin.cn/user/1743186606454698"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Android】Binder机制浅析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1743186606454698/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    弥巷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T08:02:54.000Z" title="Tue Dec 02 2025 08:02:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【Android】Binder机制浅析</h2>
<h2 data-id="heading-1">1、前言</h2>
<p>BInder机制是Android系统提供的跨进程通信机制。本篇文章会从Linux的基础知识开始介绍，从基础概念引出Binder机制，接着分析Binder的通信模型和原理，最后将会手动实现AIDL完成进程间的通信。侧重点在于原理和使用上，适合初学者。</p>
<h2 data-id="heading-2">2、Binder原理</h2>
<p>Android是基于Linux内核的，Linux提供了管道、消息队列、信号量、内存共享、套接字等跨进程方式，而Android为什么采用了Binder作为主要机制呢？</p>
<p><strong>一、传输性能好</strong></p>
<ul>
<li>Socket：是一个通用接口，导致其传输效率低，开销大。</li>
<li>共享内存：虽然在传输时不需要拷贝数据，但其控制机制复杂</li>
<li>Binder：复杂数据类型传递可复用内存，需要拷贝1次数据</li>
<li>管道和消息队列：采用存储转发方式，至少需要拷贝2次数据，效率低</li>
</ul>
<p><strong>二、安全性高</strong></p>
<ul>
<li>传统的进程：通信方式对于通信双方的身份并没有做出严格的验证，只有在上层协议上进行架设</li>
<li>Binder机制：从协议本身就支持对通信双方做身份校验，因而大大提升了安全性</li>
</ul>
<h3 data-id="heading-3">2.1 Binider实现机制</h3>
<h4 data-id="heading-4">2.1.1 进程隔离</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a85d7c46482e48d89cce67a9172d66a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byl5be3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765267373&amp;x-signature=B88sleXCjPRNutTHSKn6ZUUtCh0%3D" alt="" loading="lazy"/></p>
<p>进程空间划分：<strong>用户空间</strong>和<strong>内核空间</strong></p>
<ul>
<li>用户空间：表示进程运行在一个特定的操作模式中，没有接触物理内存或设备的权限</li>
<li>内核空间：表示独立于普通的应用程序，可以访问受保护的内存空间，也有访问底层硬件设备的所有权限</li>
<li>每个Android的进程，只能运行在自己进程所拥有的虚拟地址空间。例如，对应一个4GB的虚拟内存空间，其中3GB是用户空间，1GB是内核空间，内核空间的大小是可以通过参数配置调整的。</li>
<li>对于用户空间，不同进程之间是不能共享的，而内核空间却是可共享的。</li>
</ul>
<p>简单来说，内核空间是系统内核运行的空间，而用户空间是用户程序运行的空间。每个进程都有自己的虚拟内存空间，每个进程只能操作自己的虚拟内存空间，只有操作系统才有权限操作物理内存空间。进程隔离保证了每个进程的内存安全，但在大多情况下，不同进程间的数据通信是不可避免的，因此操作系统必须提供跨进程通信机制。</p>
<h4 data-id="heading-5">2.1.2 系统调用</h4>
<p><strong>系统调用是用户态切换到内核态的唯一合法途径</strong></p>
<p>抽象来看，操作系统中安全边界的概念就像环路的概念一样，一个环上持有一个特定的权限组，Intel支持四层环，但是Linux只使用了其中的两层环（0号环持有全部权限，3号环持有最少权限，1号环和2号环未使用），系统进程运行在0号环，用户进程运行在3号环。如果一个用户进程需要其他高级权限，其必须从三号环过渡到0号环，过渡需要通过一个安全参数检查的网关，这种过渡被称为<strong>系统调用</strong>，在执行过程中会产生一定数量的计算开销。所以，用户空间要访问内核空间唯一的方式就是系统调用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8215473232c14966b188c2ac5cb1a0f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byl5be3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765267373&amp;x-signature=1InMZbmPQeD4p91PrHtvMXdWrPY%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-6">2.1.3 内核模块/驱动</h4>
<p>如前面所说，跨进程通信是需要内核空间做支持的。传统的IPC机制如管道、Socket都是内核的一部分。但Binder不是内核的一部分，是如何做到跨进程通信的呢？</p>
<p>Linux的动态内核可加载模块机制解决了这个问题：</p>
<ul>
<li>模块是具有独立功能的程序，它可以被单独编译，但是不能独立运行。它在运行时被链接到内核作为内核的一部分运行</li>
<li>Android系统就可以动态添加一个内核模块运行在内核空间，用户进程之间通过这个内核模块作为桥梁来实现通信。在Android系统中，这个运行在内核空间中，负责各个用户进程通过Binder实现通信的内核模块就叫<strong>Binder驱动</strong></li>
</ul>
<p>那用户进程之间是如何通过这个内核模块（Binder驱动）来实现通信的呢？这里当然不是从发送方进程拷贝到内核缓存区，再把数据从内核缓存区拷贝到接收方进程，而是通过<strong>内存映射</strong>：</p>
<ul>
<li>内存映射简单地讲就是把用户空间的一块内存区域映射到内核空间，映射关系建立后，用户对这块内存区域的修改可以直接反应到内核空间。</li>
<li>反之内核空间对这块区域的修改也能直接反映到用户空间。内存映射能减少数据拷贝次数，实现用户空间和内核空间的高效互动。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33f9871e117c49beb17a70c82de2b84a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byl5be3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765267373&amp;x-signature=iBgPLjlcj2s4cpezn4q3mlYz3l8%3D" alt="" loading="lazy"/></p>
<p>一次完整的Binder IPC 通信过程通常是这样：</p>
<ul>
<li>Binder 驱动在内核空间创建一个数据接收缓存区；</li>
<li>然后在内核空间开辟一块内核缓存区，建立内核缓存区和内核中数据接收缓存区之间的映射关系，以及内核中数据接收缓存区和接收进程用户空间地址的映射关系；</li>
<li>发送方进程通过系统调用 copy_from_user() 将数据拷贝到内核中的内核缓存区，由于内核缓存区和接收进程的用户空间存在内存映射，因此也就相当于把数据发送到了接收进程的用户空间，这样便完成了一次进程间的通信。</li>
</ul>
<p>最后，简单总结一下：</p>
<ol>
<li>Linux的虚拟内存机制导致内存的隔离，进而导致进程隔离</li>
<li>进程隔离的出现导致对内存的操作被划分为用户空间和内核空间</li>
<li>用户空间需要跨权限去访问内核空间，必须使用系统调用去实现</li>
<li>系统调用需要借助内核模块/驱动去完成</li>
</ol>
<h3 data-id="heading-7">2.2 Binder通信模型</h3>
<p>Binder通信采用C/S架构，从组件视角来说，包含Client、Server、ServiceManager以及Binder驱动。架构图如下所示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87ad18a1d22247249bf1323d7b654587~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byl5be3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765267373&amp;x-signature=CxNMVtZQ%2BYmG4mQTrCDS4k5tHdI%3D" alt="" loading="lazy"/></p>
<p>前三者是在用户空间的，也就是彼此之间无法直接进行交互，Binder驱动是属于内核空间的，属于整个通信的核心。</p>
<p><strong>四个角色</strong>：</p>
<ul>
<li><strong>Client进程</strong>：使用服务的进程。</li>
<li><strong>Server进程</strong>：提供服务的进程。</li>
<li><strong>ServiceManager进程</strong>：ServiceManager的作用是将字符形式的Binder名字转化成Client中对该Binder的引用，使得Client能够通过Binder名字获得对Server中Binder实体的引用。</li>
<li><strong>Binder驱动</strong>：驱动负责进程之间Binder通信的建立，Binder在进程之间的传递，Binder引用计数管理，数据包在进程之间的传递和交互等一系列底层支持。</li>
</ul>
<p><strong>通信原理</strong>：</p>
<ul>
<li><strong>注册服务（addService）</strong> ：Service进程要先注册Service中的Binder对象引用到ServiceManager。在这个过程中，Service是客户端，ServiceManager是服务端。</li>
<li><strong>获取服务（getService）</strong> ：Client进程使用某个Service前，须先向ServiceManager中获取相应的Service的Binder引用。这个过程中，ServiceManager是服务端。</li>
<li><strong>使用服务</strong>：Client根据得到的Service信息建立与Service所在的Server进程通信的通路，然后就可以直接与Service交互。这个过程中：Client是客户端，Server是服务端。</li>
</ul>
<p>概括一下，首先，Service中的Binder实体对象，将自己的引用注册到ServiceManager，Client通过特定的key和这个引用进行绑定，ServiceManager内部自己维护一个类似MAP的表来一一对应，通过这个key就可以在ServiceManager中拿到Service中Binder的引用。</p>
<p>但是这里存在一个问题，ServiceManager和Service也属于两个不同的进程，Service在ServiceManager注册也涉及到进程间通信吗，好像变成无限死循环了？看看下面这张图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c282c138a89a443dbb8d58e02220b90c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byl5be3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765267373&amp;x-signature=FnA9h0RZZhwKR2ivhPYkumYPdTo%3D" alt="" loading="lazy"/></p>
<p>当ServiceManager作为服务端的时候，它提供的Binder比较特殊，它没有名字也不需要注册，它的固定引用号就是0，所有进程都知道ServiceManager的Binder引用号是0。由Binder驱动自动管理，不需要像其他服务那样先注册再使用。这样，一个Service若要向ServiceManager中注册自己的Binder引用就可以通过硬编码的0引用号和ServiceManager中的Binder通信。</p>
<p>那Client怎么拿到Service中的Binder对象呢？图中可以很清晰的看出整个过程，Client原本从ServiceManager中拿到Binder的引用，通过Binder驱动层的处理之后，返回给Client一个代理对象，实际上如果Client和Service处于同一个进程，返回的就是Binder对象。如果不在同一个进程，返回给Client的就是一个代理对象（proxy）。</p>
<h2 data-id="heading-8">3、手动实现进程通信</h2>
<p>在学习《安卓开发艺术探索》中关于Binder时，首先介绍由AIDL来实现进程间通信，不过相信大多数朋友和我一样，第一次看到系统自动生成的AIDL代码时是懵逼状态的，涉及Stub类，还有Proxy类。这里我们就手动实现一个通信代码，加深对Binder机制的理解。</p>
<ol>
<li>创建Book实体类，使用Parcelable接口实现序列化</li>
</ol>

<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> android.os.Parcel;
<span class="hljs-keyword">import</span> android.os.Parcelable;

<span class="hljs-keyword">import</span> androidx.annotation.NonNull;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Book</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Parcelable</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> bookId;
    <span class="hljs-keyword">public</span> String bookName;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Book</span><span class="hljs-params">()</span> {
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Book</span><span class="hljs-params">(<span class="hljs-type">int</span> bookId, String bookName)</span> {
        <span class="hljs-built_in">this</span>.bookId = bookId;
        <span class="hljs-built_in">this</span>.bookName = bookName;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">describeContents</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeToParcel</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Parcel dest, <span class="hljs-type">int</span> flags)</span> {
        dest.writeInt(bookId);
        dest.writeString(bookName);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Creator&lt;Book&gt; CREATOR = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Creator</span>&lt;Book&gt;() {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> Book <span class="hljs-title function_">createFromParcel</span><span class="hljs-params">(Parcel in)</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Book</span>(in);
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> Book[] newArray(<span class="hljs-type">int</span> size) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Book</span>[size];
        }
    };

    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">Book</span><span class="hljs-params">(Parcel in)</span> {
        bookId = in.readInt();
        bookName = in.readString();
    }
}
</code></pre>
<p>2.  声明一个AIDL性质的接口，只需要继承IInterface接口即可，IInterface接口中有一个asBinder方法。实现如下：</p>

<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> android.os.IBinder;
<span class="hljs-keyword">import</span> android.os.IInterface;
<span class="hljs-keyword">import</span> android.os.RemoteException;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IBookManager</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IInterface</span> {
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DESCRIPTOR</span> <span class="hljs-operator">=</span> <span class="hljs-string">"com.example.ipctest.IBookManager"</span>;
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TRANSACTION_getBookList</span> <span class="hljs-operator">=</span> IBinder.FIRST_CALL_TRANSACTION + <span class="hljs-number">0</span>;
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TRANSACTION_addBook</span> <span class="hljs-operator">=</span> IBinder.FIRST_CALL_TRANSACTION + <span class="hljs-number">1</span>;
    <span class="hljs-keyword">public</span> List&lt;Book&gt; <span class="hljs-title function_">getBookList</span> <span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addBook</span> <span class="hljs-params">(Book book)</span> <span class="hljs-keyword">throws</span> RemoteException;
}
</code></pre>
<p>在接口中声明了一个Binder描述符和另外两个id，这两个id分别表示的是getBookList和addBook方法。另外，如果再想要添加方法，只需再声明一个id，然后按固定模式声明新方法即可。</p>
<ol start="3">
<li>实现一个Service中的Binder实体对象，继承Binder并实现上面定义好的服务接口。</li>
</ol>

<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> android.os.Binder;
<span class="hljs-keyword">import</span> android.os.IBinder;
<span class="hljs-keyword">import</span> android.os.Parcel;
<span class="hljs-keyword">import</span> android.os.RemoteException;

<span class="hljs-keyword">import</span> androidx.annotation.NonNull;
<span class="hljs-keyword">import</span> androidx.annotation.Nullable;

<span class="hljs-keyword">import</span> java.util.Collections;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BookManagerImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Binder</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IBookManager</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BookManagerImpl</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">this</span>.attachInterface(<span class="hljs-built_in">this</span>, DESCRIPTOR);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> IBookManager <span class="hljs-title function_">asInterface</span><span class="hljs-params">(IBinder obj)</span> {
        <span class="hljs-keyword">if</span> ((obj == <span class="hljs-literal">null</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        android.os.<span class="hljs-type">IInterface</span> <span class="hljs-variable">iin</span> <span class="hljs-operator">=</span> obj.queryLocalInterface(DESCRIPTOR);
        <span class="hljs-keyword">if</span> (((iin != <span class="hljs-literal">null</span>) &amp;&amp; (iin <span class="hljs-keyword">instanceof</span> IBookManager))) {
            <span class="hljs-keyword">return</span> ((IBookManager) iin);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(obj);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> IBinder <span class="hljs-title function_">asBinder</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onTransact</span><span class="hljs-params">(<span class="hljs-type">int</span> code, <span class="hljs-meta">@NonNull</span> Parcel data, <span class="hljs-meta">@Nullable</span> Parcel reply, <span class="hljs-type">int</span> flags)</span> <span class="hljs-keyword">throws</span> RemoteException {
        <span class="hljs-keyword">switch</span> (code) {
            <span class="hljs-keyword">case</span> INTERFACE_TRANSACTION: {
                reply.writeString(DESCRIPTOR);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
            <span class="hljs-keyword">case</span> TRANSACTION_getBookList: {
                data.enforceInterface(DESCRIPTOR);
                List&lt;Book&gt; result = <span class="hljs-built_in">this</span>.getBookList();
                reply.writeNoException();
                reply.writeTypedList(result);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
            <span class="hljs-keyword">case</span> TRANSACTION_addBook: {
                data.enforceInterface(DESCRIPTOR);
                Book arg0;
                <span class="hljs-keyword">if</span> ((<span class="hljs-number">0</span> != data.readInt())) {
                    arg0 = Book.CREATOR.createFromParcel(data);
                } <span class="hljs-keyword">else</span> {
                    arg0 = <span class="hljs-literal">null</span>;
                }
                <span class="hljs-built_in">this</span>.addBook(arg0);
                reply.writeNoException();
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.onTransact(code, data, reply, flags);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;Book&gt; <span class="hljs-title function_">getBookList</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException {
        <span class="hljs-comment">// TODO 待实现</span>
<span class="hljs-keyword">return</span> Collections.emptyList();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addBook</span><span class="hljs-params">(Book book)</span> <span class="hljs-keyword">throws</span> RemoteException {
        <span class="hljs-comment">// TODO 待实现</span>
}
}
</code></pre>
<p>首先看看asInterface方法，Binder驱动传来的IBinder对象，通过queryLocallnterface方法，查找本地Binder对象，如果返回的就是<code>IBookManager</code>，说明Client和Server处于同一个进程，直接返回，如果不是，返回一个代理对象。</p>
<p>作为代理对象，也要实现服务接口：</p>
<pre><code class="hljs language-ini" lang="ini">private static class Proxy implements IBookManager {
    private IBinder mRemote<span class="hljs-comment">;</span>

    public Proxy(IBinder mRemote) {
        <span class="hljs-attr">this.mRemote</span> = mRemote<span class="hljs-comment">;</span>
    }

    @Override
    public IBinder asBinder() {
        return mRemote<span class="hljs-comment">;</span>
    }

    public java.lang.String getInterfaceDescriptor() {
        return DESCRIPTOR<span class="hljs-comment">;</span>
    }

    @Override
    public List&lt;Book&gt; getBookList() throws RemoteException {
        Parcel <span class="hljs-attr">data</span> = Parcel.obtain()<span class="hljs-comment">;</span>
        Parcel <span class="hljs-attr">reply</span> = Parcel.obtain()<span class="hljs-comment">;</span>
        List&lt;Book&gt; result<span class="hljs-comment">;</span>
        try {
            data.writeInterfaceToken(DESCRIPTOR)<span class="hljs-comment">;</span>
            mRemote.transact(TRANSACTION_getBookList, data, reply, 0)<span class="hljs-comment">;</span>
            reply.readException()<span class="hljs-comment">;</span>
            <span class="hljs-attr">result</span> = reply.createTypedArrayList(Book.CREATOR)<span class="hljs-comment">;</span>

        } finally {
            reply.recycle()<span class="hljs-comment">;</span>
            data.recycle()<span class="hljs-comment">;</span>
        }
        return result<span class="hljs-comment">;</span>
    }

    @Override
    public void addBook(Book book) throws RemoteException {
        Parcel <span class="hljs-attr">data</span> = Parcel.obtain()<span class="hljs-comment">;</span>
        Parcel <span class="hljs-attr">reply</span> = Parcel.obtain()<span class="hljs-comment">;</span>
        try {
            data.writeInterfaceToken(DESCRIPTOR)<span class="hljs-comment">;</span>
            if ((book != null)) {
                data.writeInt(1)<span class="hljs-comment">;</span>
                book.writeToParcel(data, 0)<span class="hljs-comment">;</span>
            } else {
                data.writeInt(0)<span class="hljs-comment">;</span>
            }
            mRemote.transact(TRANSACTION_addBook, data, reply, 0)<span class="hljs-comment">;</span>
            reply.readException()<span class="hljs-comment">;</span>
        } finally {
            reply.recycle()<span class="hljs-comment">;</span>
            data.recycle()<span class="hljs-comment">;</span>
        }
    }
}
</code></pre>
<p>这里代理对象实质上就是Client最终拿到的代理服务，通过这个代理对象就可以和Server进行通信了，首先通过Parcel将数据序列化，然后调用remote.transact()将方法code和data传输过去，对应的回调在Server的onTransact()中。</p>
<ol start="4">
<li>然后就是Server进程，onbind方法返回mStub对象，也就是Server中的Binder实体对象。</li>
</ol>

<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> android.app.Service;
<span class="hljs-keyword">import</span> android.content.Intent;
<span class="hljs-keyword">import</span> android.os.Binder;
<span class="hljs-keyword">import</span> android.os.IBinder;
<span class="hljs-keyword">import</span> android.os.RemoteException;
<span class="hljs-keyword">import</span> android.util.Log;

<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Service</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">"MyService"</span>;
    <span class="hljs-keyword">private</span> List&lt;Book&gt; mBook = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">()</span> {
        mBook.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Book</span>());
        <span class="hljs-built_in">super</span>.onCreate();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyService</span><span class="hljs-params">()</span> {
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> IBinder <span class="hljs-title function_">onBind</span><span class="hljs-params">(Intent intent)</span> {
        <span class="hljs-keyword">return</span> mStub;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-type">BookManagerImpl</span> <span class="hljs-variable">mStub</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BookManagerImpl</span>() {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addBook</span><span class="hljs-params">(Book book)</span> <span class="hljs-keyword">throws</span> RemoteException {
            <span class="hljs-keyword">if</span> (book == <span class="hljs-literal">null</span>) {
                book = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Book</span>();
                Log.d(TAG, <span class="hljs-string">"null obj"</span>);
            }
            mBook.add(book);
            Log.d(TAG, mBook.size() + <span class="hljs-string">""</span>);
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> List&lt;Book&gt; <span class="hljs-title function_">getBookList</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException {
            <span class="hljs-keyword">return</span> mBook;
        }
    };
}
</code></pre>
<p>5.  最后我们在客户端进程，bindService传入一个ServiceConnection对象，在与服务端建立连接时，通过我们定义好的BookManagerImpl的asInterface方法返回一个代理对象，再调用方法进行交互。</p>

<pre><code class="hljs language-ini" lang="ini">import android.content.ComponentName<span class="hljs-comment">;</span>
import android.content.Context<span class="hljs-comment">;</span>
import android.content.Intent<span class="hljs-comment">;</span>
import android.content.ServiceConnection<span class="hljs-comment">;</span>
import android.os.Bundle<span class="hljs-comment">;</span>
import android.os.IBinder<span class="hljs-comment">;</span>
import android.os.Process<span class="hljs-comment">;</span>
import android.os.RemoteException<span class="hljs-comment">;</span>
import android.util.Log<span class="hljs-comment">;</span>
import android.view.View<span class="hljs-comment">;</span>
import android.widget.Button<span class="hljs-comment">;</span>
import android.widget.TextView<span class="hljs-comment">;</span>

import androidx.activity.EdgeToEdge<span class="hljs-comment">;</span>
import androidx.appcompat.app.AppCompatActivity<span class="hljs-comment">;</span>
import androidx.core.graphics.Insets<span class="hljs-comment">;</span>
import androidx.core.view.ViewCompat<span class="hljs-comment">;</span>
import androidx.core.view.WindowInsetsCompat<span class="hljs-comment">;</span>

import java.util.List<span class="hljs-comment">;</span>

public class MainActivity extends AppCompatActivity {

    private boolean <span class="hljs-attr">isConnect</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
    private static final String <span class="hljs-attr">TAG</span> = <span class="hljs-string">"MainActivity"</span><span class="hljs-comment">;</span>
    private IBookManager iBookManager<span class="hljs-comment">;</span>
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState)<span class="hljs-comment">;</span>
        EdgeToEdge.enable(this)<span class="hljs-comment">;</span>
        setContentView(R.layout.activity_main)<span class="hljs-comment">;</span>
        ViewCompat.setOnApplyWindowInsetsListener(findViewById(R.id.main), (v, insets) -&gt; {
            Insets <span class="hljs-attr">systemBars</span> = insets.getInsets(WindowInsetsCompat.Type.systemBars())<span class="hljs-comment">;</span>
            v.setPadding(systemBars.left, systemBars.top, systemBars.right, systemBars.bottom)<span class="hljs-comment">;</span>
            return insets<span class="hljs-comment">;</span>
        })<span class="hljs-comment">;</span>
        start()<span class="hljs-comment">;</span>
        findViewById(R.id.textView).setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                if (<span class="hljs-attr">iBookManager</span> == null){
                    Log.d(TAG,"connect error")<span class="hljs-comment">;</span>
                    return<span class="hljs-comment">;</span>
                }
                try {
                    iBookManager.addBook(new Book())<span class="hljs-comment">;</span>
                    Log.d(TAG,iBookManager.getBookList().size() + "")<span class="hljs-comment">;</span>
                } catch (RemoteException e) {
                    throw new RuntimeException(e)<span class="hljs-comment">;</span>
                }
            }
        })<span class="hljs-comment">;</span>
    }

    private void start() {
        Intent <span class="hljs-attr">intent</span> = new Intent(this, MyService.class)<span class="hljs-comment">;</span>
        bindService(intent, mServiceConnection, Context.BIND_AUTO_CREATE)<span class="hljs-comment">;</span>
    }
    private ServiceConnection <span class="hljs-attr">mServiceConnection</span> = new ServiceConnection() {
        @Override
        public void onServiceConnected(ComponentName name, IBinder service) {
            Log.d(TAG,"connect success")<span class="hljs-comment">;</span>
            <span class="hljs-attr">isConnect</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
            <span class="hljs-attr">iBookManager</span> = BookManagerImpl.asInterface(service)<span class="hljs-comment">;</span>
            List&lt;Book&gt; <span class="hljs-attr">bookList</span> = null<span class="hljs-comment">;</span>
            try {
                <span class="hljs-attr">bookList</span> = iBookManager.getBookList()<span class="hljs-comment">;</span>
            } catch (RemoteException e) {
                throw new RuntimeException(e)<span class="hljs-comment">;</span>
            }
            Log.d(TAG,bookList.size() + "")<span class="hljs-comment">;</span>
        }

        @Override
        public void onServiceDisconnected(ComponentName name) {
            Log.d(TAG,"connect failed")<span class="hljs-comment">;</span>
            <span class="hljs-attr">isConnect</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
        }
    }<span class="hljs-comment">;</span>

}
</code></pre>
<p>这样就实现了一次进程间的交互。建议大家手写一遍AIDL进程间通信的实现代码，加深对Binder通信的理解。</p>
<blockquote>
<p>内容参考：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fsingwhatiwanna" target="_blank" title="https://blog.csdn.net/singwhatiwanna" ref="nofollow noopener noreferrer">《安卓开发艺术探索》 - 任玉刚</a></p>
<p><a href="https://juejin.cn/post/6844903764986462221?searchId=202512020940319DF3C4C9DB74E5B83553" target="_blank" title="https://juejin.cn/post/6844903764986462221?searchId=202512020940319DF3C4C9DB74E5B83553">3分钟带你看懂android的Binder机制</a></p>
<p><a href="https://juejin.cn/post/7008887202738356237?searchId=202512020940319DF3C4C9DB74E5B83553" target="_blank" title="https://juejin.cn/post/7008887202738356237?searchId=202512020940319DF3C4C9DB74E5B83553">「Android」Binder机制入门学习笔记</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[低代码运行时渲染搞不懂？TinyEngine 从理论到实践全攻略，看完直接上手！]]></title>    <link>https://juejin.cn/post/7578901433971589120</link>    <guid>https://juejin.cn/post/7578901433971589120</guid>    <pubDate>2025-12-02T08:53:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578901433971589120" data-draft-id="7578901433971048448" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="低代码运行时渲染搞不懂？TinyEngine 从理论到实践全攻略，看完直接上手！"/> <meta itemprop="keywords" content="前端,Vue.js,低代码"/> <meta itemprop="datePublished" content="2025-12-02T08:53:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OpenTiny社区"/> <meta itemprop="url" content="https://juejin.cn/user/3808325101432983"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            低代码运行时渲染搞不懂？TinyEngine 从理论到实践全攻略，看完直接上手！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808325101432983/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OpenTiny社区
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T08:53:05.000Z" title="Tue Dec 02 2025 08:53:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>运行时渲染器用于在浏览器中直接渲染低代码 Schema，提供与“出码”并行的即时运行路径，可在设计阶段获得接近真实的交互与数据效果。</p>
<h2 data-id="heading-1">1.启动流程与案例讲解</h2>
<p>下面用一个非常简单的示例页面，串联起从 Schema 到运行时渲染的完整流程。这个页面包含：</p>
<ul>
<li>一段提示文案；</li>
<li>一个显示计数的按钮；</li>
<li>点击按钮时，计数加一。</li>
</ul>
<h3 data-id="heading-2">1.1 环境准备</h3>
<ul>
<li>确保已拉取包含 runtime-renderer 包的新版本代码。</li>
<li>在项目根目录执行：
<ul>
<li><code>pnpm install</code> 安装依赖</li>
<li><code>pnpm run dev</code> 启动项目
或参考前后端联调<a href="https://link.juejin.cn?target=https%3A%2F%2Fopentiny.design%2Ftiny-engine%23%2Fhelp-center%2Fcourse%2Fdev%2Fdebugging-of-java-backend" target="_blank" title="https://opentiny.design/tiny-engine#/help-center/course/dev/debugging-of-java-backend" ref="nofollow noopener noreferrer">文档</a>或<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1TpZ5YqEKZ" target="_blank" title="https://www.bilibili.com/video/BV1TpZ5YqEKZ" ref="nofollow noopener noreferrer">视频</a>来启动JAVA后端联调，获得更好的开发体验</li>
</ul>
</li>
</ul>
<h3 data-id="heading-3">1.2 配置页面 Schema</h3>
<p>1). 创建页面 <code>DemoA</code>，并添加页面状态 <code>state1</code>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a976c678c4346ffb2ad0c802ff9d61c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlblRpbnnnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270385&amp;x-signature=xgt4cqXBoUX7zRAGXMQywgiiQwM%3D" alt="1.png" loading="lazy"/>
2). 在页面中拖入 Text 和 TinyButton 组件：</p>
<ul>
<li>Text 文本内容为“[state测试]：点击增加button计数”；</li>
<li>TinyButton 的 <code>text</code> 绑定表达式 <code>this.state.state1.button</code>；</li>
<li>TinyButton 的 <code>onClick</code> 绑定表达式 <code>this.onClickNew1</code>。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/532150ee27914697b55823092ebec599~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlblRpbnnnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270385&amp;x-signature=DdtFiq0G4z0WmMidnJmMQlwlMP4%3D" alt="2.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9dddcef3254344d5b9742c3a0c1710df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlblRpbnnnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270385&amp;x-signature=X4E4ij8Y2xs7HiOgVbqGEpJNmEQ%3D" alt="3.png" loading="lazy"/></p>
<p>3). 在“页面 JS”中添加方法 <code>onClickNew1</code>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/297c6db89a424c7f88e59449cc63b754~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlblRpbnnnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270385&amp;x-signature=nvZexiuvwJkf7PBjzbqR82OfCt4%3D" alt="4.png" loading="lazy"/></p>
<h3 data-id="heading-4">1.3 运行时渲染链路</h3>
<p>当点击“运行时渲染”按钮或直接访问 runtime 页面时，</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a484f658745349ff8facebdb84212da9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlblRpbnnnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270385&amp;x-signature=pgdDG2qkIVuuvtGm4AyCSR1rCIc%3D" alt="5.png" loading="lazy"/>
runtime-renderer 会：
1）. 解析 URL，得到 appId、tenant 以及当前路由信息。若当前正在编辑某页面，将自动路由至该页面，基于页面树中每个节点的 route 段，按祖先链拼接为 <code>#/&lt;a&gt;/&lt;b&gt;/&lt;c&gt;</code>，示例链接为 <code>http://localhost:8090/runtime.html?id=1&amp;tenant=1&amp;platform=1#/demoa</code> , 如果需要设计器内内容有更新的话则需要重新加载运行时页面以同步。
2）. 通过 useAppSchema 拉取 App Schema，初始化应用配置。
3）. 并找到 <code>DemoA</code> 对应的 <code>page_content</code>。
4）. RenderMain 使用该 <code>page_content</code> 构建页面上下文：</p>
<ul>
<li>初始化页面 state；</li>
<li>解析方法 <code>onClickNew1</code>，并注入上下文；</li>
<li>注入页面级 CSS Scope。</li>
</ul>
<p>5）.调用 renderer 按照 Schema 递归生成 VNode 树：</p>
<ul>
<li>Text 节点直接渲染静态文案；</li>
<li>TinyButton 节点：
<ul>
<li>解析 <code>text</code> 的 JSExpression，读取 <code>this.state.state1.button</code>，初始值为 1；</li>
<li>解析 <code>onClick</code> 的 JSExpression，将其解析为 <code>onClickNew1</code> 函数引用。</li>
</ul>
</li>
</ul>
<p>6）. Vue 将 VNode 树挂载到 DOM，用户看到的就是一个按钮显示“1”的页面。</p>
<p>当用户点击按钮时：</p>
<ul>
<li>绑定在 <code>onClick</code> 上的函数 <code>onClickNew1</code> 被执行；</li>
<li>函数在当前页面上下文中运行，执行 <code>this.state.state1.button++</code>；</li>
<li>Vue 响应式系统检测到 state 变化，触发 TinyButton 文本重新渲染；</li>
<li>按钮上的数字从 1 变为 2、3、4……</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40c099aa364946da8ae5d74fc37cabe5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlblRpbnnnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270385&amp;x-signature=4PdYZWRwlMwoa8JrRfFq%2FOmUSCM%3D" alt="6.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a45b3470cb642ac96db514616c4db8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlblRpbnnnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270385&amp;x-signature=UGZIzHKRReavIr6JYmrh%2Be3yIuQ%3D" alt="7.png" loading="lazy"/></p>
<h2 data-id="heading-5">2.技术概述</h2>
<p>在 TinyEngine 中，页面的结构、样式和交互逻辑都被描述成一份 JSON Schema。设计器负责让开发者以可视化方式编辑 Schema，而真正交付给浏览器的是由代码生成或运行时渲染出来的 Vue 应用。</p>
<p>runtime-renderer 的目标，是在浏览器中直接把 Schema 渲染成一个可交互的 Vue 应用，形成一条与出码并行的“即时运行路径”：</p>
<ul>
<li>同一份 Schema 同时服务于设计态画布、运行时渲染器和出码结果。</li>
<li>支持应用级配置（物料包、i18n、数据源、工具函数等）。</li>
<li>支持区块、循环、条件、插槽、状态与事件函数等完整能力。</li>
</ul>
<h2 data-id="heading-6">3.整体架构：从 App Schema 到真实页面</h2>
<p>从高层看，runtime-renderer 的核心链路可以概括为：</p>
<pre><code class="hljs language-perl" lang="perl"> URL 参数（appId）
 ↓
 加载 App Schema 和页面列表
 ↓
 初始化应用级环境（物料 / i18n / 数据源 / utils / 全局 CSS）
 ↓
 根据 pageId 选中页面 pageSchema
 ↓
 RenderMain 构建页面上下文并解析 <span class="hljs-keyword">state</span> / methods
 ↓
 renderer 按 Schema 递归生成 Vue VNode 树
 ↓
 Vue 挂载到真实 DOM
</code></pre>
<h3 data-id="heading-7">3.1 模块划分</h3>
<p>按职责拆分，大致有以下几个模块：</p>
<ul>
<li>
<p><strong>useAppSchema</strong>：</p>
<ul>
<li>拉取整个应用的 Schema（应用元信息 + 页面列表）。</li>
<li>初始化物料包、依赖、数据源、工具函数、i18n 和全局 CSS。</li>
<li>暴露获取页面列表、按 id 取 pageSchema 的接口。</li>
</ul>
</li>
<li>
<p><strong>app-function 相关模块</strong>：</p>
<ul>
<li>封装物料包加载、importMap 处理、数据源初始化、工具函数初始化等通用逻辑。</li>
<li>对外提供 <code>getDataSource()</code>、<code>getUtilsAll()</code> 等查询接口。</li>
</ul>
</li>
<li>
<p><strong>RenderMain + PageRenderer</strong>：</p>
<ul>
<li>PageRenderer 是对外的高阶组件，外部只需传入 <code>pageId</code>。</li>
<li>RenderMain 负责：
<ul>
<li>基于 <code>pageId</code> 选择当前页面的 <code>pageSchema</code>；</li>
<li>构建页面上下文（state、route、router、stores、dataSourceMap、utils、cssScopeId 等）；</li>
<li>解析页面定义的 methods 和 state；</li>
<li>调用 renderer 渲染页面。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>renderer（render.ts）</strong>：</p>
<ul>
<li>核心渲染器，把 schema 节点映射为真实组件 VNode。</li>
<li>处理组件解析、属性解析、循环、条件、插槽、区块与 CSS 作用域等。</li>
</ul>
</li>
<li>
<p><strong>parser（parser.ts）</strong>：</p>
<ul>
<li>配置解析引擎，把 JSExpression / JSFunction / i18n / 插槽等配置形式统一解析成运行时值或函数。</li>
</ul>
</li>
<li>
<p><strong>page-function 系列</strong>：</p>
<ul>
<li>提供页面级 state 管理、CSS Scope 管理、Block 上下文等能力。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-8">3.2 三层上下文</h3>
<p>为了让表达式和函数在运行时拥有完整信息，runtime-renderer 构建了三层上下文：</p>
<ul>
<li><strong>应用级上下文</strong>：物料组件、数据源集合 <code>dataSourceMap</code>、国际化配置、工具函数(utils)、应用级 CSS、router、stores 等。</li>
<li><strong>页面级上下文</strong>：页面 state、当前路由信息、page 级 CSS Scope Id、页面 methods 和生命周期配置。</li>
<li><strong>区块级上下文</strong>：区块自己的 state 和 CSS Scope，通过 <code>getBlockContext</code> / <code>getBlockCssScopeId</code> 生成。</li>
</ul>
<p>所有 JSExpression / JSFunction、插槽函数都会在“局部作用域（如循环变量）→ 页面/区块上下文 → 应用级上下文”的组合环境下执行。</p>
<h2 data-id="heading-9">4.详细设计说明</h2>
<h3 data-id="heading-10">4.1 应用级初始化</h3>
<p>应用级初始化发生在运行时入口加载完成之后，主要包括以下几步。</p>
<h4 data-id="heading-11">4.1.1 从后端加载完整应用 Schema</h4>
<p>runtime-renderer 会通过两个接口拉齐应用配置：</p>
<ul>
<li>
<p><code>/app-center/v1/api/apps/schema/:appId</code>：</p>
<ul>
<li>返回应用元信息（包括全局变量<code>globalState</code>）、物料包 <code>packages</code>、组件映射 <code>componentsMap</code>、数据源 <code>dataSource</code>、国际化 <code>i18n</code>、工具函数 <code>utils</code>、全局 CSS 等。</li>
</ul>
</li>
<li>
<p><code>/app-center/api/pages/list/:appId</code>：</p>
<ul>
<li>返回页面列表，每个页面都包含路由、标题及设计器保存的 <code>page_content</code>。</li>
</ul>
</li>
</ul>
<p>useAppSchema 聚合这两部分数据，在内存中形成完整的 App Schema，后续所有页面渲染都基于这份数据。</p>
<h4 data-id="heading-12">4.1.2 初始化物料与依赖</h4>
<p>物料与依赖的初始化，实际上分为两个层次：</p>
<p>1). <strong>基础物料包（bundle.json）加载</strong>：</p>
<ul>
<li><code>useAppSchema</code> 会优先从 <code>/mock/bundle.json</code> 中读取 <code>data.materials.packages</code>，得到一批基础物料包的配置；</li>
<li>这些包通常是 TinyEngine 预置的常用物料（例如 TinyVue 组件库），会作为“基础环境”优先拉取；</li>
<li><code>loadPackageDependencys(packages)</code> 负责按这些配置加载对应的 JS/CSS 资源。</li>
</ul>
<p>2). <strong>按组件映射加载具体物料组件</strong>：</p>
<ul>
<li>根据 App Schema 中的 <code>componentsMap</code> 与 <code>packages</code>，runtime-renderer 会生成组件依赖描述：
<ul>
<li>每个组件对应哪个 npm 包；</li>
<li>是默认导出还是具名导出，是否需要解构；</li>
<li>包含哪些 JS 资源与 CSS 资源；</li>
</ul>
</li>
<li>然后通过 <code>getComponents</code> 逐个拉取这些组件实现，并配合 <code>addStyle</code> 注入样式。</li>
</ul>
<p>整体上，是<strong>先按 bundle.json 约定拉取基础物料包，再根据 Schema 中的 componentsMap 精细加载具体组件</strong>。加载完成后，组件会被挂到全局对象（如 <code>window.TinyLowcodeComponent</code> / <code>window.TinyComponentLibs</code>），以便渲染阶段通过组件名查找对应实现。</p>
<h4 data-id="heading-13">4.1.3 初始化 importMap 与第三方依赖</h4>
<p>对于在/mock/bundle.json中引入的包需要的子依赖和其他通过 CDN 引入的第三方库，runtime-renderer 使用 importMap 做统一映射：</p>
<ul>
<li>在 <code>import-map.json</code> 中维护包名到实际 CDN 地址的映射；</li>
<li>启动时将 importMap 注入到浏览器环境，使动态加载的模块可以直接用包名引用。</li>
</ul>
<h4 data-id="heading-14">4.1.4 初始化国际化配置</h4>
<p>应用级 Schema 中的 <code>i18n</code> 部分包含多语言文案：</p>
<ul>
<li>运行时遍历各 locale 的文案条目；</li>
<li>将它们合并到国际化实例（如 <code>i18n.global</code>）中；</li>
<li>parser 在执行表达式时，如果检测到 <code>this.i18n</code> 或 <code>t(</code> 的使用，会自动把翻译函数注入到上下文中。</li>
</ul>
<h4 data-id="heading-15">4.1.5 初始化工具函数</h4>
<p>工具函数 <code>utils</code> 以配置形式存在于 App Schema 中，目前支持两类来源：</p>
<p>1). <strong>NPM 包工具函数（type: 'npm'）</strong>：</p>
<ul>
<li>在 Schema 中约定包名、版本号、导出名、是否解构、子字段 <code>subName</code> 等；</li>
<li>运行时通过 CDN（如 <code>https://unpkg.com/&lt;package&gt;@&lt;version&gt;</code>）动态 <code>import</code> 该包；</li>
<li>根据配置选择默认导出或具名导出；</li>
<li>这样可以在不改动运行时代码的前提下，引入第三方 NPM 包作为工具函数使用。</li>
</ul>
<p>2). <strong>函数型工具函数（type: 'function'）</strong>：</p>
<ul>
<li>以 JSFunction 形式写在 Schema 中；</li>
<li>运行时通过 <code>parseJSFunction</code> 解析为真实函数并缓存。</li>
</ul>
<p>所有解析出来的工具函数都会统一挂到一个工具函数集合中，通过 <code>getUtilsAll()</code> 暴露，页面上下文再以 <code>utils</code> 形式注入，表达式和方法可以通过 <code>this.utils.xxx</code> 调用这些工具。</p>
<h4 data-id="heading-16">4.1.6 初始化数据源</h4>
<p>数据源配置 <code>dataSource</code> 描述了应用中可用的远程或本地数据源。初始化过程会：</p>
<ul>
<li>把每个数据源封装为可直接调用的对象；</li>
<li>统一挂到 <code>dataSourceMap</code> 下，例如 <code>this.dataSourceMap.tableTest1.load(params)</code>；</li>
<li>按设计器的 dataHandler 约定处理后端返回结构，尽量统一为形如 <code>{ items, total }</code> 的通用格式，方便表格使用。</li>
</ul>
<p>页面级函数和生命周期可以通过 <code>this.dataSourceMap</code> 使用这些数据源。</p>
<h4 data-id="heading-17">4.1.7 加载区块 Schema</h4>
<p>区块（Block）是一种可复用的页面片段，runtime-renderer 会通过 <code>/material-center/api/blocks</code> 拉取区块列表：</p>
<ul>
<li>将区块按 label 组织成映射，例如 <code>window.blocks['Group1Test1'] = { schema, meta }</code>；</li>
<li>渲染时，如果发现 <code>componentName</code> 对应某个区块 label，就把它当作 Block 组件处理：
<ul>
<li>使用区块自身的 schema；</li>
<li>生成独立的 Block 上下文和 CSS Scope；</li>
<li>内部递归渲染其 children。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-18">4.1.8 初始化全局变量</h4>
<p>runtime-renderer 基于 Pinia 来管理运行时的全局变量，即 stores：</p>
<ul>
<li>启动入口 <code>initRuntimeRenderer</code> 中，会先调用 <code>generateStoresConfig()</code>，根据 App Schema 中的全局状态配置等生成一份标准的 stores 配置；</li>
<li>然后创建 Pinia 实例，并通过 <code>createStores(storesConfig, pinia)</code> 将这些配置注册为实际的 Pinia store；</li>
<li>最后把得到的 <code>stores</code> 对象通过 <code>app.provide('stores', stores)</code> 注入整个应用，在页面组件中可以通过依赖注入的方式拿到；</li>
<li>RenderMain 在构建页面上下文时，会把这份 <code>stores</code> 注入到 context 中，表达式和方法可以通过 <code>this.stores.xxx</code> 访问对应的 store。</li>
</ul>
<p>这样，设计器可以通过配置的方式声明全局状态切片，而运行时则统一落在 Pinia 的实现之上，享受其响应式和开发者工具生态。</p>
<h4 data-id="heading-19">4.1.9 初始化路由（vue-router）</h4>
<p>runtime-renderer 使用 <code>vue-router</code> 来管理页面级导航：</p>
<ul>
<li>在 <code>createAppRouter</code> 中，会从 <code>useAppSchema().pages</code> 读取所有页面配置，根据每个页面的 <code>route</code>、<code>id</code>、<code>parentId</code>、<code>isHome</code>、<code>isDefault</code> 等信息生成路由表；</li>
<li>每个页面都会变成一条 <code>route</code>：<code>path</code> 来自 <code>page.route</code>，<code>component</code> 统一指向惰性加载的 <code>PageRenderer</code>，并通过 <code>props: { pageId: page.id }</code> 把页面 id 透传进去；</li>
<li>通过 <code>parentId</code> 字段拼出嵌套路由结构，并根据 <code>isDefault</code> 在父级上设置默认子路由重定向，根据 <code>isHome</code> 生成从 <code>/</code> 到首页的重定向；</li>
<li>最后基于这些动态生成的 <code>routes</code> 调用 <code>createRouter({ history: createWebHashHistory('/runtime.html'), routes })</code> 得到 router，启动入口 <code>initRuntimeRenderer</code> 会把它挂到应用上，使页面可以通过 hash 路由进行切换。</li>
</ul>
<h3 data-id="heading-20">4.2 页面级渲染入口</h3>
<p>页面级渲染的核心是两个组件：对外暴露的 <code>PageRenderer</code>，以及真正做事的 <code>RenderMain</code>。</p>
<h4 data-id="heading-21">4.2.1 PageRenderer：对外形态</h4>
<p>对使用方来说，只需要：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;PageRenderer :pageId="currentPageId" /&gt;
</code></pre>
<p>PageRenderer 内部会把 <code>pageId</code> 透传给 RenderMain，对外隐藏所有与 Schema 解析和上下文构建相关的细节。</p>
<h4 data-id="heading-22">4.2.2 从 pageId 到 pageSchema</h4>
<p>RenderMain 在 <code>setup</code> 中会：</p>
<ul>
<li>通过 <code>useAppSchema().getPageById(pageId)</code> 找到对应页面对象；</li>
<li>从中取出 <code>page_content</code> 作为当前页面的 schema；</li>
<li>用 <code>computed</code> 包装，确保后续 Schema 更新可以被捕捉；</li>
<li>对 <code>page_content</code> 做一次深拷贝，避免渲染过程中意外修改原始数据。</li>
</ul>
<p>随后使用 <code>watch</code> 监听当前 schema：</p>
<ul>
<li>首次进入页面时立即执行一次，调用 <code>setSchema</code> 完成初始化；</li>
<li>后续如果设计器更新了该页面并同步到运行时，再次触发 <code>setSchema</code>，实现设计态 → 运行态的实时联动。</li>
</ul>
<h4 data-id="heading-23">4.2.3 页面上下文的构建</h4>
<p><code>setSchema</code> 是 RenderMain 的关键逻辑，它会基于当前 pageSchema 构建出页面级上下文：</p>
<ul>
<li>从路由系统获取 <code>route</code>、<code>router</code>；</li>
<li>通过依赖注入拿到全局 <code>stores</code>；</li>
<li>通过 app-function 获取 <code>dataSourceMap</code> 和 <code>utils</code>；</li>
<li>使用 <code>useState</code> 初始化页面级 <code>state</code> 与 <code>setState</code>；</li>
<li>生成当前页面的 <code>cssScopeId</code>，例如 <code>data-te-page-&lt;pageId&gt;</code>。</li>
</ul>
<p>这些信息被组合成 <code>contextData</code>，在 <code>setSchema</code> 开头通过 <code>setContext(contextData, true)</code> 注入运行时上下文：</p>
<ul>
<li><code>true</code> 表示清空旧上下文，避免页面切换或 Schema 更新时残留状态。</li>
<li>后续解析 methods 和 state 时，都会在这个上下文中执行。</li>
</ul>
<h4 data-id="heading-24">4.2.4 方法与状态的初始化顺序</h4>
<p>在 <code>setSchema</code> 内部，初始化顺序大致为：</p>
<p>1). <strong>设置上下文环境</strong>：先调用 <code>setContext(contextData, true)</code>，确保 <code>this.state</code>、<code>this.stores</code>、<code>this.dataSourceMap</code>、<code>this.utils</code> 等在之后解析中都可用。
2). <strong>解析并注入 methods</strong>：对 schema 中的 <code>methods</code> 逐项执行 <code>parseData</code>：</p>
<ul>
<li>将 JSFunction 字符串解析为真实函数；</li>
<li>使用 <code>generateFn</code> 包装，让其在执行时带上完整上下文并具备异常兜底；</li>
<li>放入 <code>methods</code> 容器，并合入 context。</li>
</ul>
<p>3). <strong>初始化 state</strong>：调用 <code>setState(newSchema.state, true)</code>：</p>
<ul>
<li>根据 defaultValue 填充 state；</li>
<li>对带 accessor 的字段记录 getter / setter 行为；</li>
<li>在很多场景下，state 中的表达式会依赖 props、utils、stores、methods，因此需要放在 methods 之后。</li>
</ul>
<p>4). <strong>注入页面级 CSS</strong>：调用 <code>setPageCss(pageSchema.css, cssScopeId)</code>：</p>
<ul>
<li>为当前页面注入带 <code>[data-te-page-&lt;id&gt;]</code> 前缀的样式；</li>
<li>renderer 渲染节点时会自动附加该 attribute，实现样式隔离。</li>
</ul>
<p>这样的顺序可以保证上下文完整，避免出现“方法或状态在解析时访问不到依赖”的情况。</p>
<h4 data-id="heading-25">4.2.5 Render 函数中的根容器</h4>
<p>RenderMain 的 <code>render</code> 函数不会直接把 <code>pageSchema.children</code> 交给 renderer，而是先构造一个根容器：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> rootChildrenSchema = {
	<span class="hljs-attr">componentName</span>: <span class="hljs-string">'div'</span>,
	<span class="hljs-attr">props</span>: { ...(pageSchema.<span class="hljs-property">props</span> || {}) },
	<span class="hljs-attr">children</span>: pageSchema.<span class="hljs-property">children</span>
}
</code></pre>
<ul>
<li>这样能与“出码”的根结构保持一致，也便于统一挂载页面级样式和属性。</li>
<li>若 <code>pageSchema.children</code> 非空，则渲染：</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title function_">h</span>(renderer, { <span class="hljs-attr">schema</span>: rootChildrenSchema, <span class="hljs-attr">parent</span>: pageSchema })
</code></pre>
<ul>
<li>若 children 为空，则渲染一个 <code>Loading</code> 组件，避免页面完全空白。</li>
</ul>
<h3 data-id="heading-26">4.3 核心渲染器：从 Schema 到 VNode</h3>
<p>renderer 负责把 Schema 节点转成 Vue VNode，parser 负责把各种配置数据解析成运行时值，两者协同完成渲染。</p>
<h4 data-id="heading-27">4.3.1 组件解析</h4>
<p>根据节点的 <code>componentName</code>，renderer 会按以下顺序查找对应实现：</p>
<p>1). 内置 Canvas 系列组件映射（如 <code>Text</code>、<code>Img</code>、<code>RouterLink</code>、<code>Collection</code> 等）。
2). 运行时加载的 TinyVue 组件和 <code>window.TinyLowcodeComponent</code> 中注册的物料组件。
3). 自定义元素（Web Components），通过 <code>customElements</code> 映射表预留扩展点。
4). 原生 HTML 标签：如果 componentName 是合法 HTML 标签，直接作为标签名使用。
5). 区块组件：如果在 <code>window.blocks</code> 中找到同名 block，则：</p>
<ul>
<li>动态创建一个 Vue 组件；</li>
<li>在组件内部基于 block 的 schema 和 block 上下文递归渲染 children；</li>
<li>使用 block 独立的 CSS Scope Id。</li>
</ul>
<p>若以上都未命中，则使用占位组件（如 CanvasPlaceholder）兜底，保证渲染不因单个节点错误而中断。</p>
<h4 data-id="heading-28">4.3.2 属性解析与 CSS Scope</h4>
<p>Schema 中的 <code>props</code> 可能包含多种形式：普通值、JSExpression、JSFunction、状态访问器、图标配置、插槽声明等。renderer 会通过 <code>parseData</code> 对其统一解析，生成“干净”的 props 对象：</p>
<ul>
<li>JSExpression：在当前 scope + 上下文下执行表达式，得到最终值；</li>
<li>JSFunction：解析为真实函数并绑定上下文；</li>
<li>状态访问器：按默认值或 getter 逻辑解析；</li>
<li>插槽声明：根据配置生成对应的 Slot 函数；</li>
<li>其他对象和数组属性：递归调用 <code>parseData</code>。</li>
</ul>
<p>在此基础上，renderer 会：</p>
<ul>
<li>根据 scope 或 context 中的 <code>cssScopeId</code>，给非 Block 组件自动添加形如 <code>[data-te-page-xxx]: ''</code> 的属性，用于样式作用域隔离；</li>
<li>对 Canvas 和 Block 组件额外挂上 <code>schema</code> 字段，便于组件内部根据 Schema 进行渲染；</li>
<li>将 <code>className</code> 重命名为 <code>class</code>，避免覆盖组件内部样式约定。</li>
</ul>
<h4 data-id="heading-29">4.3.3 循环、条件与作用域</h4>
<p>循环和条件渲染通过 <code>loop</code>、<code>loopArgs</code> 和 <code>condition</code> 三个字段来描述：</p>
<ul>
<li><code>loop</code>：通常是 JSExpression，返回一个数组；</li>
<li><code>loopArgs</code>：描述 item 和 index 在表达式中的名称，例如 <code>['row', 'i']</code>；</li>
<li><code>condition</code>：JSExpression，决定是否渲染该节点。</li>
</ul>
<p>renderer 的流程是：
1). 使用 <code>parseData(loop, scope, context)</code> 得到循环数组。
2). 对每一个 item，调用 <code>parseLoopArgs</code> 生成局部作用域（如 <code>{ row, i }</code>）。
3). 合并到当前作用域，得到 <code>mergeScope</code>。
4). 用 <code>parseCondition(condition, mergeScope, context)</code> 判断是否渲染该节点。
5). 在 <code>mergeScope</code> 下解析 children 和 props，生成对应 VNode。</p>
<p>如果没有配置 loop，则在当前 scope 下渲染一次节点即可。</p>
<h4 data-id="heading-30">4.3.4 children 与插槽</h4>
<p>children 的处理有多种情况：</p>
<ul>
<li>若组件被标记为容器且 children 为空，会自动注入 <code>CanvasPlaceholder</code>，提升设计和调试体验。</li>
<li>若 children 不是数组且本身是表达式，则直接调用 <code>parseData(children, scope, context)</code>，常用于 Text / 简单插值场景。</li>
<li>若 children 是普通数组且不包含 Template，则通过 <code>renderGroup</code> 递归渲染每个子节点。</li>
<li>若 children 中包含 <code>componentName: 'Template'</code>：
<ul>
<li>使用 <code>generateSlotGroup</code> 按 slotName 分组；</li>
<li>为每个 slot 生成形如 <code>($scope) =&gt; renderDefault(children, { ...scope, ...$scope })</code> 的函数；</li>
<li>在创建组件 VNode 时作为 slots 传入，实现命名插槽效果。</li>
</ul>
</li>
<li>对 Web Components，renderer 会在需要时为子节点自动添加合适的 <code>slot</code> 属性，满足自定义元素插槽规范。</li>
</ul>
<h4 data-id="heading-31">4.3.5 parser 的角色</h4>
<p>parser 是一个“多类型配置解析器”，通过一张规则表将不同类型的数据转换为运行时值：</p>
<ul>
<li>通过不同的 <code>type(data)</code> 函数识别 JSExpression、JSFunction、JSSlot、i18n、状态访问器、Icon、字符串、数组、对象等；</li>
<li>针对每种类型提供 <code>parseFunc(data, scope, ctx)</code>，实现对应的解析逻辑；</li>
<li>统一入口 <code>parseData(data, scope, ctx)</code> 根据第一个匹配的类型选择合适的解析函数。</li>
</ul>
<p>renderer 在解析 props、children、loop、condition 时都会调用 <code>parseData</code>，从而在“不了解配置细节”的前提下获得正确的运行时值。</p>
<p>当前数据源和 Collection 组件在 Schema 层面并未做 parser 级别的特殊处理，它们在解析时与普通组件一致，数据源相关逻辑主要依赖上下文中的 <code>dataSourceMap</code> 和组件自身的协议约定来实现。</p>
<h2 data-id="heading-32">5.总结</h2>
<p>runtime-renderer 把原本只在出码阶段才能完成的“Schema → 运行应用”的过程搬到了浏览器端：</p>
<ul>
<li>通过 useAppSchema 拉取并初始化 App Schema，搭建应用级运行环境；</li>
<li>通过 RenderMain 构建页面级上下文，统一管理 state、methods、路由、数据源和样式；</li>
<li>通过 renderer 和 parser 将 Schema 节点递归转换为 Vue VNode，并在多层上下文中安全执行表达式与函数。</li>
</ul>
<p>对于设计器使用者来说，它提供了一条“所见即所得”的运行路径。</p>
<h2 data-id="heading-33">关于OpenTiny</h2>
<p>欢迎加入 OpenTiny 开源社区。添加微信小助手：opentiny-official 一起参与交流前端技术～</p>
<p>OpenTiny 官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopentiny.design" target="_blank" title="https://opentiny.design" ref="nofollow noopener noreferrer">opentiny.design</a><br/>
OpenTiny 代码仓库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny" target="_blank" title="https://github.com/opentiny" ref="nofollow noopener noreferrer">github.com/opentiny</a><br/>
TinyVue 源码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny%2Ftiny-vue" target="_blank" title="https://github.com/opentiny/tiny-vue" ref="nofollow noopener noreferrer">github.com/opentiny/ti…</a><br/>
TinyEngine 源码： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny%2Ftiny-engine" target="_blank" title="https://github.com/opentiny/tiny-engine" ref="nofollow noopener noreferrer">github.com/opentiny/ti…</a><br/>
欢迎进入代码仓库 Star🌟TinyEngine、TinyVue、TinyNG、TinyCLI、TinyEditor~
如果你也想要共建，可以进入代码仓库，找到 good first issue 标签，一起参与开源贡献~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[有了AI之后我一天要上三五个服务。自建项目模板 Maven archetype 减轻工作量]]></title>    <link>https://juejin.cn/post/7578836326475087899</link>    <guid>https://juejin.cn/post/7578836326475087899</guid>    <pubDate>2025-12-02T08:54:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578836326475087899" data-draft-id="7578917474659369011" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="有了AI之后我一天要上三五个服务。自建项目模板 Maven archetype 减轻工作量"/> <meta itemprop="keywords" content="maven,Java,Spring"/> <meta itemprop="datePublished" content="2025-12-02T08:54:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="纸仓"/> <meta itemprop="url" content="https://juejin.cn/user/1812410601572599"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            有了AI之后我一天要上三五个服务。自建项目模板 Maven archetype 减轻工作量
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1812410601572599/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    纸仓
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T08:54:05.000Z" title="Tue Dec 02 2025 08:54:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>年关将至，大家都很焦虑。老板焦虑最近用户付费数据怎么越来越不行了。</p>
<p>运营焦虑老板把用户付费数据不行这个帽子扣自己身上。</p>
<p>产品焦虑老板把用户付费数据不行这个帽子扣自己身上。</p>
<p>开发焦虑老板把用户付费数据不行这个帽子扣自己身上。</p>
<p>测试焦虑老板把用户付费数据不行这个帽子扣自己身上。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10a6c0051af44d9ab8c5308cd9368d18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270445&amp;x-signature=ApyS81qGu%2Fub3Iya0cOkqjmXgQM%3D" alt="image.png" loading="lazy"/></p>
<p>总之，大家都焦虑。作为一个在职海沉浮许久的开发，为了不让老板看向我。我给的答案是：多上十几二十个服务。</p>
<p>当老板处于正要开口让我背锅之前，已经在脑子里面酝酿好“你自己提离职，公司不追究你的责任”之前。我们率先出击，和他说我今年多上线了三五十服务。</p>
<p>一方面告诉他，我干的可不少。另一方面也是一种威慑：如果离了我，这三五十个烫手山芋谁来接？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/378239fd1246480aa52dc7d6417a6349~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270445&amp;x-signature=b4OC45VvuWNqejYfxmbt4bmVO%2Bw%3D" alt="image.png" loading="lazy"/></p>
<p>为了多上服务，我就得整一个模版工程。虽然可以手动改，但我改了几个之后发现太特么麻烦了。</p>
<p>程序员怎么能吃得了这种手动干活的苦？毕竟一个 2 分钟可以干完的活，我都想花 5 分钟写个脚本自动化。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d7b2237b2b54362a8ab50f96e9610ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270445&amp;x-signature=PmrD300ko%2BD1bplQsH9eOhIEvhc%3D" alt="image.png" loading="lazy"/></p>
<p>问就是高级，如果我手动干了，那怎么显示出来我是开发，我是一个坎普特训练师？</p>
<p>本来以前还可以用一个程序装一下，但是被你们这群爱装逼的人用多了。现在广大老板都知道了，也包括我的老板。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b36734d30f804b588e40170914b8ba21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270445&amp;x-signature=7Zsscrpblr2ATM%2BSto6qX4kAnjU%3D" alt="image.png" loading="lazy"/></p>
<p>于是为了继续装逼，不是。是为了自动化这部分工作，我打算又写一个项目仓库用来存放模板代码。（嘿嘿，属于我的仓库+1）</p>
<p>那接下来就盘一下怎么做一个 maven archetype。</p>
<p>首先你要有一个Java开发环境，然后你要有一个模板工程，如果想大家一起用还需要有一个 maven 仓库。</p>
<p>步骤大概是这样的：
第一步：打开电脑
第二步：选择一部
第三步：把手放在➡️键上
第四步：另一只手...咳咳</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28b4023ec52f45a3a58d5a53f5434af6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270445&amp;x-signature=Ir3SOTyNLqQJdPgDf6SUK9DYZ2E%3D" alt="image.png" loading="lazy"/></p>
<p>好像不太对，贤者时间应该是这样：
第一步：准备一个正常的工程模板
第二步：引入 maven 插件生成模板
第三步：把生成的项目复制出来改一下
第四步：打包
第五步：上传到远程库（如果自娱自乐这一步就不用了）</p>
<h3 data-id="heading-0">第一步：准备正常的工程模板</h3>
<p>自己准备去</p>
<h3 data-id="heading-1">第二步：引入 maven 插件生成模板</h3>
<p>先引入扩展，可以通过项目生成样板项目</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">extension</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.archetype<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>archetype-packaging<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">extension</span>&gt;</span>
</code></pre>
<p>执行命令后，就会在 target 目录中生成一个样板项目</p>
<pre><code class="hljs language-shell" lang="shell">mvn archetype:create-from-project
</code></pre>
<p>把 target/generated-sources/ 目录下的样板项目复制出来，单独作为一个项目来修改维护。</p>
<h3 data-id="heading-2">第三部：<del>三上</del> 样板项目信息自定义</h3>
<p>现在虽然已经生成了一个项目，如果想用是可以直接用的。如果有一些特殊的需求，则需要自己修改 <code>archetype-metadata.xml</code> 文件。</p>
<p><code>archetype-metadata.xml</code> 文件中最重要的是 <code>&lt;fileSets&gt;</code> 这个标签的内容。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dde6ea8a628f41558455506b77bdad11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270445&amp;x-signature=eJFBmfx6NA3fB%2F6Z4r2snN4yx6w%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">archetype-descriptor</span> <span class="hljs-attr">...</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">fileSets</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">fileSet</span> <span class="hljs-attr">filtered</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">encoding</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>.circleci<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">includes</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>config.yml<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">includes</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">fileSet</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">fileSet</span> <span class="hljs-attr">encoding</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">includes</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>.gitignore<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>README.md<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">includes</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">fileSet</span>&gt;</span>
    ...
  <span class="hljs-tag">&lt;/<span class="hljs-name">fileSets</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">modules</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">module</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span> <span class="hljs-attr">dir</span>=<span class="hljs-string">"app"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"app"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">fileSets</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">fileSet</span> <span class="hljs-attr">filtered</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">packaged</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">encoding</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>src/main/java<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">includes</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>**/*.java<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>**/pom.xml<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">includes</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">fileSet</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">fileSet</span> <span class="hljs-attr">encoding</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>src/main/resources<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">includes</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>**/*.yml<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">includes</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">fileSet</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">fileSet</span> <span class="hljs-attr">filtered</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">packaged</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">encoding</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>src/test/java<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">includes</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>**/*.java<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">includes</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">fileSet</span>&gt;</span>
        ...
      <span class="hljs-tag">&lt;/<span class="hljs-name">fileSets</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">module</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"controller"</span> <span class="hljs-attr">dir</span>=<span class="hljs-string">"controller"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"controller"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">fileSets</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">fileSet</span> <span class="hljs-attr">filtered</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">packaged</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">encoding</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>src/main/java<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">includes</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>**/*.java<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>**/pom.xml<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">includes</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">fileSet</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">fileSets</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span>
    ...
  <span class="hljs-tag">&lt;/<span class="hljs-name">modules</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">archetype-descriptor</span>&gt;</span>
</code></pre>
<p>这个文件中定义了要管理哪些文件夹和文件，就是要从 <code>archetype-resources</code> 中复制哪些文件夹和文件。</p>
<p>如果需要使用参数替换，就要添加 <code>filtered="true"</code> 就可以直接在文件中写变量，使用模板生成的时候就会自动替换。</p>
<p>变量通常有 <code>${groupId}</code>、<code>${artifactId}</code>和 <code>${version}</code></p>
<p><code>.idea</code>、<code>.claude</code> 这种目录不想在生成项目的时候也生成，直接删掉样板代码中的目录，或者是修改 <code>archetype-metadata.xml</code></p>
<h3 data-id="heading-3">第四步：打包</h3>
<pre><code class="hljs language-shell" lang="shell">mvn clean install
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e73f358dac745efb06c589e6f7d5abf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270445&amp;x-signature=YhB9prdEcdGEmOSgOJWb2Vx8Bu4%3D" alt="image.png" loading="lazy"/></p>
<p>打包完之后，本地 Maven 仓库就会多出一个项目包。这个项目包里面就有些乱七八糟的文件，jar文件、pom文件等等等等。</p>
<pre><code class="hljs language-powershell" lang="powershell">PS ...\repository\com\xxx\archetype\xxx-archetype&gt; tree /F /A
.
|-- maven-metadata-local.xml
|-- maven-metadata-yuan-nexus-releases.xml
|-- resolver-status.properties
\---1.2
    |-- felo-archetype-1.2.jar
    |-- felo-archetype-1.2.pom
    |-- _remote.repositories
</code></pre>
<p>既然本地有了包，那就可以直接使用了。</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">这里只是进入工作目录，不需要进入项目目录</span>
cd workspace
<span class="hljs-meta prompt_">
# </span><span class="bash">通过模板项目生成项目，会自动生成项目根目录</span>
mvn archetype:generate
</code></pre>
<p>生成项目的过程会自动进入交互模式：</p>
<ul>
<li>先根据提示输入项目模板对应的编号</li>
<li>在按照提示输入项目信息：
<ul>
<li>groupId：组ID</li>
<li>artifactId：项目名</li>
<li>version：版本号</li>
<li>package：项目包名</li>
</ul>
</li>
</ul>
<h3 data-id="heading-4">第五步：上传到远程库</h3>
<p>如果自娱自乐这一步就不用了，到上一步已经可以正常使用。</p>
<p>如果你像我一样精益求精、坚持不懈、勇往无前还貌若潘安。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10489c030560412fb5996abfd28ce55d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270445&amp;x-signature=APu7iLIvQNYh5pXlRBzKCf2aPL0%3D" alt="image.png" loading="lazy"/></p>
<p>那么可以把这个项目打包完上传到远程仓库，以供需要的人使用。</p>
<p>第一步：先在项目的 <code>pom.xml</code> 中配置上仓库的地址</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">distributionManagement</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>nexus-releases<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>Team Nexus Repository<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://nexus.xxx.com/repository/maven-releases/<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">layout</span>&gt;</span>default<span class="hljs-tag">&lt;/<span class="hljs-name">layout</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">releases</span>&gt;</span>
			<span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span>
		<span class="hljs-tag">&lt;/<span class="hljs-name">releases</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">snapshots</span>&gt;</span>
			<span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span>
		<span class="hljs-tag">&lt;/<span class="hljs-name">snapshots</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">snapshotRepository</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>nexus-snapshots<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>Team Nexus Repository Snapshots<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://nexus.xxx.com/repository/maven-snapshots/<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">layout</span>&gt;</span>default<span class="hljs-tag">&lt;/<span class="hljs-name">layout</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">releases</span>&gt;</span>
			<span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span>
		<span class="hljs-tag">&lt;/<span class="hljs-name">releases</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">snapshots</span>&gt;</span>
			<span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span>
			<span class="hljs-tag">&lt;<span class="hljs-name">updatePolicy</span>&gt;</span>always<span class="hljs-tag">&lt;/<span class="hljs-name">updatePolicy</span>&gt;</span>
		<span class="hljs-tag">&lt;/<span class="hljs-name">snapshots</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">snapshotRepository</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">distributionManagement</span>&gt;</span>
</code></pre>
<p>第二步：在 <code>maven settings.xml</code> 中配置上认证用的用户名密码</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">servers</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">server</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>nexus-releases<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">username</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>xxxxxxxx<span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">server</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">server</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>nexus-snapshots<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">username</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>xxxxxxxxx<span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">server</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">servers</span>&gt;</span>
</code></pre>
<p>第三步：执行 deploy 命令上传jar到远程仓库</p>
<pre><code class="hljs language-shell" lang="shell">mvn clean deploy
</code></pre>
<p>然后获取到 catalog 配置文件地址，一般是这样的URL：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fnexus.xxx.com%2Frepository%2Fmaven-releases%2Farchetype-catalog.xml" target="_blank" title="https://nexus.xxx.com/repository/maven-releases/archetype-catalog.xml" ref="nofollow noopener noreferrer">nexus.xxx.com/repository/…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/239a293459864c39afad9357b4cc9b7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270445&amp;x-signature=%2BVoe3xIYcf0pPu0W2jgbSrehYZo%3D" alt="image.png" loading="lazy"/></p>
<p>第四步：在 IDEA 中使用</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48f54efca56e46908d328e34cde6688b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270445&amp;x-signature=yhXat1aiUO%2Bo%2F8a8arZbrwAMyas%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/298fd71f2e154a76bbd94ec5afecbc95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270445&amp;x-signature=na0ZE6ke4MNMx64Rno0nRwfOzmM%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34a07b719a0d4b1fb0c2083546d98503~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270445&amp;x-signature=XhfLZD9fSlZZQAixqZJcoEVCRAQ%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d50cc7fc3b084591943f0cdb56cab2b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270445&amp;x-signature=fv3K2KbY3Othy3rJQ5Esa6RE%2BJI%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RN 的初版架构——触摸事件处理机制]]></title>    <link>https://juejin.cn/post/7579063781071732790</link>    <guid>https://juejin.cn/post/7579063781071732790</guid>    <pubDate>2025-12-02T08:43:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579063781071732790" data-draft-id="7579063781071716406" data-original-type="2" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RN 的初版架构——触摸事件处理机制"/> <meta itemprop="keywords" content="React Native,前端框架"/> <meta itemprop="datePublished" content="2025-12-02T08:43:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Joyee691"/> <meta itemprop="url" content="https://juejin.cn/user/3967460879369575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RN 的初版架构——触摸事件处理机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3967460879369575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Joyee691
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T08:43:04.000Z" title="Tue Dec 02 2025 08:43:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读39分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">RN 的触摸事件处理机制</h2>
<p>触摸事件是用户与客户端 APP 主要的交互手段，本文我们来探索一下 RN 是如何通过组件来封装不同客户端的事件处理机制</p>
<p>不过在此之前，我们需要先简单了解下 Android 与 IOS 的触摸事件处理机制，这样才能了解 RN 在设计之初的权衡取舍</p>
<h3 data-id="heading-1">Android 的事件处理机制</h3>
<p>我们先来看看 Android 是如何注册事件处理回调的：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExampleActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Activity</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OnClickListener</span> {
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedValues)</span> {
        ...
        <span class="hljs-type">Button</span> <span class="hljs-variable">button</span> <span class="hljs-operator">=</span> (Button)findViewById(R.id.corky);
      	<span class="hljs-comment">// 给 button 元素注册点击事件的监听，如果 button 被点击，就会触发传入对象的 onClick 方法</span>
        button.setOnClickListener(<span class="hljs-built_in">this</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">(View v)</span> {
      <span class="hljs-comment">// 处理点击事件</span>
    }
    ...
}
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroid%2Fview%2FView.OnClickListener" target="_blank" title="https://developer.android.com/reference/android/view/View.OnClickListener" ref="nofollow noopener noreferrer">setOnClickListener</a> 是 Android 中 View 这个类的接口方法，当用户在当前 View 触发了点击事件后，Android 就会主动调用被该方法注册的 onClick 方法</p>
<p>那么我们可以直接把这个方法传递到 js 侧处理吗？</p>
<p>答案是不行的，个人认为有几个原因：</p>
<ol>
<li><code>setOnClickListener</code> 是 android 平台封装的方法，它没办法保证在多平台之间的一致性</li>
<li>没办法定制一些更加原子化（例如 press-in/out）的表现</li>
<li>没办法实现/模拟 JS 的事件捕获以及事件冒泡</li>
</ol>
<p>所以我们需要再深入一步，探索一下 Android 的事件有哪些以及是如何产生的</p>
<h4 data-id="heading-2">Android 的触摸事件</h4>
<p>在 Android 的<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fdevelop%2Fui%2Fviews%2Ftouch-and-input%2Fgestures%2Fdetector%23capture-touch-events-for-an-activity-or-view" target="_blank" title="https://developer.android.com/develop/ui/views/touch-and-input/gestures/detector#capture-touch-events-for-an-activity-or-view" ref="nofollow noopener noreferrer">开发者手册</a>中，常见的触摸事件被分成以下几类：</p>
<ul>
<li><code>ACTION_DOWN</code>：屏幕检测到手指放下的事件（一次触摸只会有一个）</li>
<li><code>ACTION_MOVE</code>：屏幕检测到放下的手指移动的事件（一般有多个）</li>
<li><code>ACTION_UP</code>：屏幕检测到放下的手指抬起来的事件（一次触摸最多只会有一个）</li>
<li><code>ACTION_CANCEL</code>：表示该触摸事件被取消了，比如被上层的 scroll view 接管了</li>
<li><code>ACTION_OUTSIDE</code>：表示手指离开了当前触摸元素的范围</li>
</ul>
<p>这些事件都被封装进了一个 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroid%2Fview%2FMotionEvent" target="_blank" title="https://developer.android.com/reference/android/view/MotionEvent" ref="nofollow noopener noreferrer">MotionEvent</a> 类</p>
<p>上述的事件可以被组合成一个个语义化事件 semantic events，比如：</p>
<ul>
<li><code>click = ACTION_DOWN + [ACTION_MOVE] +  ACTION_UP</code></li>
<li><code>longPress = ACTION_DOWN + hold 200ms + [ACTION_MOVE] + ACTION_UP</code></li>
</ul>
<p>在 RN 中，就是通过消费这些触摸事件，并且在 JS 侧自行组合成了给开发者消费的事件（比如 onPress）</p>
<h4 data-id="heading-3">Android 的事件处理流程</h4>
<p>一般来说，Android 的事件从硬件接收到信号开始，到有对应的 View 消费结束会经过以下几步：</p>
<ol>
<li>硬件层：接收到手指触摸的信号，然后将坐标与事件发送给操作系统</li>
<li><code>InputManager</code>：Android 系统层的类，运行在一个单独的进程中；主要负责将原始事件发送到当前 APP 中</li>
<li><code>InputChannel</code>：Android 系统与 APP 沟通的桥梁，<code>InputManager</code> 就是通过它把事件发送给 APP 的</li>
<li><code>ViewRootImpl.WindowInputEventReceiver</code>：运行在我们程序的主线程中，负责接受 <code>InputChannel</code> 中的事件</li>
<li><code>ViewRootImpl.deliverInputEvent</code>：负责分发不同事件到各自的 handler 手上</li>
<li><code>ViewRootImpl.processPointerEvent</code>：负责处理触摸事件的 handler，他会将事件包装成 MotionEvent 然后将其派发到视图树的根节点上</li>
<li><code>mView.dispatchTouchEvent</code>：mView 是我们插入视图树的根 View（在 RN 的例子中是 <code>ReactRootView</code>）；当我们的根节点接收到这个事件之后，他会判断自己是否要处理这个事件，如果不处理则会向他下面的节点进行派发（有点类似 JS 的事件捕获的过程，但不完全一样）</li>
</ol>
<p>从第七步开始，事件终于进入了我们能够用程序控制的范围了，接下来我们用一个例子讲解剩余的事件派发逻辑：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-title class_">ViewGroup</span> (root)
 ├─ <span class="hljs-title class_">ViewA</span>
 │    └─ <span class="hljs-title class_">ViewC</span>   &lt;-- finger is here
 └─ <span class="hljs-title class_">ViewB</span>
</code></pre>
<p>假设当前我们有一个占据全屏的 ViewGroup，其内部有两个互不重叠的元素 ViewA 与 ViewB，ViewA 元素内部还有一个 ViewC 元素</p>
<p>用户的触摸事件发生在 ViewC 的范围内</p>
<p>接下来我们需要分成两种情况讨论：ViewC 消费了触摸事件、没有元素消费触摸事件</p>
<h5 data-id="heading-4">ViewC 消费触摸事件</h5>
<p>在这种情况下，当 <code>ACTION_DOWN</code> 事件被触发时，以下方法会被递归调用：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">ViewGroup</span>.<span class="hljs-title function_">dispatchTouchEvent</span>(<span class="hljs-variable constant_">DOWN</span>)
  → <span class="hljs-title class_">ViewA</span>.<span class="hljs-title function_">dispatchTouchEvent</span>(<span class="hljs-variable constant_">DOWN</span>)
    → <span class="hljs-title class_">ViewC</span>.<span class="hljs-title function_">dispatchTouchEvent</span>(<span class="hljs-variable constant_">DOWN</span>) <span class="hljs-comment">// return true =&gt; ViewC becomes the target of the touch</span>
</code></pre>
<p>在 <code>dispatchTouchEvent</code> 中，主要发生了三件事：</p>
<ol>
<li>调用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroid%2Fview%2FViewGroup%23onInterceptTouchEvent(android.view.MotionEvent)" target="_blank" title="https://developer.android.com/reference/android/view/ViewGroup#onInterceptTouchEvent(android.view.MotionEvent)" ref="nofollow noopener noreferrer">onInterceptTouchEvent</a> 方法判断是否该事件需要被当前元素拦截（在这个例子里只有 ViewC 返回了 true）</li>
<li>如果  <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroid%2Fview%2FViewGroup%23onInterceptTouchEvent(android.view.MotionEvent)" target="_blank" title="https://developer.android.com/reference/android/view/ViewGroup#onInterceptTouchEvent(android.view.MotionEvent)" ref="nofollow noopener noreferrer">onInterceptTouchEvent</a> 返回了 false，则执行 hit-test 根据当前事件位置判断应该调用哪一个子元素的 <code>dispatchTouchEvent</code> 方法（原则是在当前位置上层级最高的子元素优先被调用）</li>
<li>如果有元素 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroid%2Fview%2FViewGroup%23onInterceptTouchEvent(android.view.MotionEvent)" target="_blank" title="https://developer.android.com/reference/android/view/ViewGroup#onInterceptTouchEvent(android.view.MotionEvent)" ref="nofollow noopener noreferrer">onInterceptTouchEvent</a> 返回了 true，则：
<ol>
<li>调用该元素的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroid%2Fview%2FView%23onTouchEvent(android.view.MotionEvent)" target="_blank" title="https://developer.android.com/reference/android/view/View#onTouchEvent(android.view.MotionEvent)" ref="nofollow noopener noreferrer">onTouchEvent</a> 方法处理该事件</li>
<li>父元素标记当前元素为该触摸事件的处理元素（这个是为了减少后续 <code>ACTION_UP</code> 事件的 hit-test 开销）将当前的处理元素标记到 <code>mFirstTouchTarget</code> 中</li>
</ol>
</li>
</ol>
<br/>
<p>当 <code>ACTION_UP</code> 事件被触发时，则有：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">ViewGroup</span>.<span class="hljs-title function_">dispatchTouchEvent</span>(<span class="hljs-variable constant_">UP</span>)
  → <span class="hljs-title class_">ViewA</span>.<span class="hljs-title function_">dispatchTouchEvent</span>(<span class="hljs-variable constant_">UP</span>)
    → <span class="hljs-title class_">ViewC</span>.<span class="hljs-title function_">dispatchTouchEvent</span>(<span class="hljs-variable constant_">UP</span>) <span class="hljs-comment">// call onTouchEvent(UP) =&gt; perform onClick</span>
</code></pre>
<p>由于在 <code>ACTION_DOWN</code> 的时候标记了处理元素，所以这次每一个元素只需要找到各自标记的 <code>mFirstTouchTarget</code>  然后直接调用就好</p>
<p>在这个例子中最后会直接触发 <code>ViewC.dispatchTouchEvent</code>，执行合成之后的高级事件</p>
<h5 data-id="heading-5">没有元素消费触摸事件</h5>
<p>如果没有元素要消费这个事件的话，递归调用就会变成：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">ViewGroup</span>.<span class="hljs-title function_">dispatchTouchEvent</span>(<span class="hljs-variable constant_">DOWN</span>)
  → <span class="hljs-title class_">ViewA</span>.<span class="hljs-title function_">dispatchTouchEvent</span>(<span class="hljs-variable constant_">DOWN</span>)
    → <span class="hljs-title class_">ViewC</span>.<span class="hljs-title function_">dispatchTouchEvent</span>(<span class="hljs-variable constant_">DOWN</span>)  <span class="hljs-comment">// returns false (not clickable)</span>
    ← back to <span class="hljs-title class_">ViewA</span> → <span class="hljs-title class_">ViewA</span>.<span class="hljs-title function_">onTouchEvent</span>(<span class="hljs-variable constant_">DOWN</span>) → <span class="hljs-literal">false</span>
  ← back to <span class="hljs-title class_">ViewGroup</span> → <span class="hljs-title class_">ViewGroup</span>.<span class="hljs-title function_">onTouchEvent</span>(<span class="hljs-variable constant_">DOWN</span>) → <span class="hljs-literal">false</span>
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroid%2Fview%2FView%23onTouchEvent(android.view.MotionEvent)" target="_blank" title="https://developer.android.com/reference/android/view/View#onTouchEvent(android.view.MotionEvent)" ref="nofollow noopener noreferrer">onTouchEvent</a> 除了在当前元素的  <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroid%2Fview%2FViewGroup%23onInterceptTouchEvent(android.view.MotionEvent)" target="_blank" title="https://developer.android.com/reference/android/view/ViewGroup#onInterceptTouchEvent(android.view.MotionEvent)" ref="nofollow noopener noreferrer">onInterceptTouchEvent</a> 返回 true 时会执行，在子元素不消费这个事件的时候，也会在归的时候被调用（可以想象成事件处理机制对该元素说：嘿，你的子元素都不处理这个事件，你要不要处理下兜个底呀？）</p>
<p>如果此时 <code>ViewA</code> 跟 <code>ViewGroup</code> 都返回了 false，则代表没有元素愿意消费这个事件，自然每个元素的 <code>mFirstTouchTarget</code> 就都是空的了</p>
<p>在这种情况下，如果 <code>ACTION_UP</code> 事件被触发时，当事件进入到 <code>ViewGroup.dispatchTouchEvent</code> 会很尴尬的发现，<code>mFirstTouchTarget</code> 为空，没有元素愿意消费自己，此时它会最后调用一下当前元素的 <code>onTouchEvent</code> 然后发现返回了 false，事件终结</p>
<h3 data-id="heading-6">IOS 的事件处理机制</h3>
<p>IOS 从硬件接受到信号到处理事件一般会经过以下几步：</p>
<ol>
<li>当屏幕检测到手指触摸，会将当前事件发送到当前应用主线程的运行循环（main run loop）中</li>
<li>UIKit 会将事件封装成一个 <code>UIEvent</code>，一个 <code>UIEvent</code> 中会包含一个或多个 <code>UITouch</code> 对象（内部包含此次事件的信息）</li>
<li>IOS 应用会从 <code>UIWindow</code>（通常只会有一个，负责承载当前页面所有 UIView） 开始进行 hit-testing 流程</li>
<li>Hit-testing 会根据一系列规则找到需要处理该事件的 View</li>
<li><code>UIWindow</code> 基于该 View 开始一系列的事件处理机制</li>
</ol>
<p>在正式进入事件处理机制之前，我们先来看看原生 IOS 应用可以如何消费事件：</p>
<h4 data-id="heading-7">UIResponder</h4>
<p>UIResponder 是参与 IOS 事件传递系统的一个基类，UIView 继承了这个基类</p>
<p>在 UIResponder 中提供了一系列<strong>低阶事件处理回调</strong></p>
<p>由于 UIView 继承了它，所以在 UIView 中我们可以通过重载 override 这些回调来执行我们事件处理逻辑</p>
<p>比如：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">DraggableView</span> : <span class="hljs-title">UIView</span></span>
<span class="hljs-keyword">@end</span>

<span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">DraggableView</span> </span>{
}

- (<span class="hljs-type">void</span>)touchesBegan:(<span class="hljs-built_in">NSSet</span>&lt;<span class="hljs-built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="hljs-built_in">UIEvent</span> *)event {
  <span class="hljs-comment">// override with custom logic</span>
}

- (<span class="hljs-type">void</span>)touchesMoved:(<span class="hljs-built_in">NSSet</span>&lt;<span class="hljs-built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="hljs-built_in">UIEvent</span> *)event {
  <span class="hljs-comment">// override with custom logic</span>
}

- (<span class="hljs-type">void</span>)touchesEnded:(<span class="hljs-built_in">NSSet</span>&lt;<span class="hljs-built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="hljs-built_in">UIEvent</span> *)event {
  <span class="hljs-comment">// override with custom logic</span>
}

- (<span class="hljs-type">void</span>)touchesCancelled:(<span class="hljs-built_in">NSSet</span>&lt;<span class="hljs-built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="hljs-built_in">UIEvent</span> *)event {
  <span class="hljs-comment">// override with custom logic</span>
}
<span class="hljs-keyword">@end</span>
</code></pre>
<p>在这个例子中我们通过重载了 <code>touchesBegan</code>， <code>touchesMoved</code>， <code>touchesEnded</code>， <code>touchesCancelled</code> 方法定制了触摸事件发生过程的处理逻辑</p>
<p>默认情况下，命中 Hit-testing 的 View 重载的 <code>touchesXXX</code> 事件会被优先执行，如果当前 View 没有重载事件或者在重载中调用了 <code>super touchesXXX:withEvent:</code> 则该事件将会继续被其父节点消费</p>
<h4 data-id="heading-8">UIControl</h4>
<p>UIControl 是 UIView 的子类（所以它也继承了 UIResponder）</p>
<p>与 UIResponder 不同的是，UIControl 内部维护了一个状态机 state machine，用来<strong>将多个低阶的事件封装成高阶的语义化事件</strong></p>
<p>从应用开发者视角来看，UIControl 为 Button、Switches 等元素提供了一套语义化事件的消费方式，简化开发者处理常见事件的流程</p>
<p>这套方式被称之为 <strong>target-action</strong>，以下是例子：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// 创建一个 button </span>
<span class="hljs-built_in">UIButton</span> *button = [<span class="hljs-built_in">UIButton</span> buttonWithType:<span class="hljs-built_in">UIButtonTypeSystem</span>];
<span class="hljs-comment">// 在这个 button 中注册了一个针对 UIControlEventTouchUpInside 事件的监听，如果该事件被触发则执行 tapped 方法</span>
[button addTarget:<span class="hljs-keyword">self</span> action:<span class="hljs-keyword">@selector</span>(tapped:) forControlEvents:<span class="hljs-built_in">UIControlEventTouchUpInside</span>];

- (<span class="hljs-type">void</span>)tapped:(<span class="hljs-built_in">UIButton</span> *)sender {
  <span class="hljs-comment">// handle button press</span>
}
</code></pre>
<p>相比 UIResponder，UIControl 弱化了开发者对 touch 低阶事件的感知，只需要处理高阶的语义化事件即可</p>
<h4 data-id="heading-9">UIGestureRecognizer</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fdocumentation%2Fuikit%2Fuigesturerecognizer%3Flanguage%3Dobjc" target="_blank" title="https://developer.apple.com/documentation/uikit/uigesturerecognizer?language=objc" ref="nofollow noopener noreferrer">UIGestureRecognizer</a> 是 IOS 事件处理中一个 “另类” 的处理机制</p>
<p>它不同于 UIResponder 与 UIControl 这种基于 View 的事件响应链机制，它是一个独立的基于 “手势” 的事件响应机制</p>
<p>我们先来看看它是怎么用的，再来聊聊它的机制：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// 创建一个识别 tap 手势的 GestureRecognizer；当这个手势被成功识别调用 didTap 方法处理手势</span>
<span class="hljs-built_in">UITapGestureRecognizer</span> *tap = [[<span class="hljs-built_in">UITapGestureRecognizer</span> alloc] initWithTarget:<span class="hljs-keyword">self</span> 		action:<span class="hljs-keyword">@selector</span>(didTap:)];
tap.numberOfTapsRequired = <span class="hljs-number">1</span>;
<span class="hljs-comment">// 在当前 view 上注册这个 GestureRecognizer</span>
[view addGestureRecognizer:tap];

- (<span class="hljs-type">void</span>)didTap:(<span class="hljs-built_in">UITapGestureRecognizer</span> *)gr {
  <span class="hljs-keyword">if</span> (gr.state == <span class="hljs-built_in">UIGestureRecognizerStateRecognized</span>) {
    <span class="hljs-comment">// handle tap</span>
  }
}
</code></pre>
<p>通过上面代码，我们可以总结出两点结论：</p>
<ol>
<li>GestureRecognizer 需要由 view 主动添加（第 5 行的 <code>addGestureRecognizer</code>)，而不像 <code>UIResponder</code> 自动继承</li>
<li>GestureRecognizer 内部主要由状态 <strong>state</strong> 驱动</li>
</ol>
<br/>
<p>我们来看看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FBladeTail%2FEvent-Handling-Guide-for-iOS%2Fblob%2Fmaster%2FEvent%2520Handling%2520Guide%2520for%2520iOS.pdf" target="_blank" title="https://github.com/BladeTail/Event-Handling-Guide-for-iOS/blob/master/Event%20Handling%20Guide%20for%20iOS.pdf" ref="nofollow noopener noreferrer">Event Handling Guide for iOS</a> 中是如何描述 IOS 默认的事件传递机制的：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1bd8451fb997456ba891d63884f3000e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSm95ZWU2OTE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765269930&amp;x-signature=SwXi6aDSj%2F23hDGWNArXxXyMRPk%3D" alt="ios event delivery path" loading="lazy"/></p>
<blockquote>
<p>In the simple case, when a touch occurs, the touch object is passed from the UIApplication object to the UIWindow object. Then, the window first sends touches to any gesture recognizers attached the view where the touches occurred (or to that view’s superviews), before it passes the touch to the view object itself.</p>
<p>(from Event Handling Guide for iOS page 25)</p>
<p>简单翻译：当一个触摸事件被触发的时候，会先从 UIApplication(对应图中的 APP) 传递到 UIWindow(对应图中的 Window)，然后会优先传递给 view 上附着的 GestureRecognizer，其次才是传递给 view 触发 UIResponder 的处理方法</p>
</blockquote>
<br/>
<p>了解了 GestureRecognizer 的机制之后，我们来看看它内部做了哪些事情</p>
<p>首先在 GestureRecognizer 内部，也有跟 UIResponder 一样的 <code>touchesBegan</code>、<code>touchesMoved</code> 等回调来响应不同的事件</p>
<p>其次 GestureRecognizer 在此之上还维护了一套状态机，用来将不同的事件抽象成一个个手势的状态</p>
<p>让我们来举一个例子：</p>





























<table><thead><tr><th>当前事件</th><th>GestureRecognizer</th><th>tapGestureRecognizer.state</th><th>View</th></tr></thead><tbody><tr><td>1. 用户手指触摸屏幕</td><td>touchesBegan</td><td>Possible</td><td>touchesBegan</td></tr><tr><td>2. 用户手指在屏幕上动了</td><td>touchesMoved</td><td>Possible</td><td>touchesMoved</td></tr><tr><td>3. 用户手指离开屏幕</td><td>touchesEnded</td><td>Recognized</td><td>touchesEnded</td></tr></tbody></table>
<p>我们把点击事件分成了三个步骤，分别对应到上面表格中的三个当前事件</p>
<ul>
<li>当用户手指触摸屏幕时，首先 GestureRecognizer 内部的 touchesBegan 会被触发，它会将内部的 state 会维持 <strong>Possible</strong>（因为还没有识别到手势），然后 View 才会收到该事件并触发 View 的 touchesBegan</li>
<li>当用户手指在屏幕上动了时，情况与上述类似</li>
<li>当用户手指离开屏幕时，GestureRecognizer 的 touchesBegan 被触发，它确认了是一个点击事件，所以将内部的 state 切换成了 <strong>Recognized</strong>，然后 View 才会收到该事件并触发 View 的 touchesBegan</li>
</ul>
<br/>
<p>在 GestureRecognizer 的内部，将所有的手势分为两种类型：</p>
<ul>
<li>离散型手势：比如点击事件的 UITapGestureRecognizer</li>
<li>持续型手势：比如长按事件的 UILongPressGestureRecorgnizer</li>
</ul>
<p>每一种手势，都有一个内部的状态机来判断当前状态：</p>
<ul>
<li>离散型手势：<code>Possible -&gt; Recognized/Failed</code>（Recognized 表示识别成功；Failed 表示识别失败）</li>
<li>持续型手势：<code>Possible -&gt; Begin -&gt; [Changed] -&gt; Ended/Cancel</code>（Ended 表示识别成功；Cancel 表示识别失败）</li>
</ul>
<p>开发者可以通过判断一个 GestureRecognizer 的状态，来执行不同的处理逻辑（参考上一个代码片段第 8 行）</p>
<h4 data-id="heading-10">UIGestureRecognizer 与 UIResponder</h4>
<p>如果上文的 UIGestureRecognizer 把你彻底搞懵了的话，本小节是专门用来答疑解惑的</p>
<p>我们接下来会用一个例子来了解 IOS 中处理事件的全貌：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">ViewA</span> &lt;- add <span class="hljs-title class_">TapGestureRecognizer</span>
 └─ <span class="hljs-title class_">ViewB</span>
      └─ <span class="hljs-title class_">ViewC</span> &lt;- override touchesXXX 
</code></pre>
<p>假设我们有三个元素，ViewA 是 ViewB 的父元素、ViewB 是 ViewC 的父元素</p>
<p>用户点击了 ViewC 元素（Hit-testing 命中了 ViewC，对应到本章节开始的第 5 步）时：</p>
<ol>
<li><code>UIWindow</code> 会把当前的 touch 事件发送到任何附着在当前 View（以及其所有父元素）的 GestureRecognizer 中（在我们的例子中，就是 ViewA 的 TapGestureRecognizer 会最先感知到事件发生）</li>
<li>默认情况（<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fdocumentation%2Fuikit%2Fuigesturerecognizer%2Fdelaystouchesbegan%3Flanguage%3Dobjc" target="_blank" title="https://developer.apple.com/documentation/uikit/uigesturerecognizer/delaystouchesbegan?language=objc" ref="nofollow noopener noreferrer">GestureRecognizer.delaysTouchesBegan</a> === false）下，<code>UIWindow</code> 会随后把 touch 事件发送给 ViewC，然后触发 touchesBegan 的重载逻辑（进入基于 View 的响应链）</li>
<li>如果 TapGestureRecognizer 成功识别了该手势，它会触发自己的 action，调用用户注册的方法</li>
<li>与此同时，在默认情况（<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fdocumentation%2Fuikit%2Fuigesturerecognizer%2Fcancelstouchesinview%3Flanguage%3Dobjc" target="_blank" title="https://developer.apple.com/documentation/uikit/uigesturerecognizer/cancelstouchesinview?language=objc" ref="nofollow noopener noreferrer">GestureRecognizer.cancelsTouchesInView</a> === true）下，ViewC 会接收到当前事件的 cancel 终止当前事件处理</li>
</ol>
<p>在这个过程中，有两个重点：</p>
<ol>
<li>如果一个 View 被命中了，它所有父元素上附着的 GestureRecognizer 都会被 “告知”</li>
<li>当任何事件被触发时，GestureRecognizer 总是第一个被 “告知” 的</li>
</ol>
<p>是不是很适配 RN 呢😆</p>
<h3 data-id="heading-11">RN 事件处理机制实现</h3>
<p>在上面两个章节中，我们分别聊了原生的 IOS 与 Android 的事件处理机制</p>
<p>在这一个章节，我们要把这些机制带进 RN 的设计，看看 RN 是如何在不同的平台之上抽象出一套机制抹平平台差异的解决方案</p>
<p>为了方便理解，我们会以一个例子为切入点：</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">Button</span>
  onPress={<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'You tapped the button!'</span>);
  }}
  title=<span class="hljs-string">"Press Me"</span>
/&gt;
</code></pre>
<p>这是一个基础的 button 组件，其中 onPress 属性注册了一个点击事件的回调方法、title 则定义了按钮要展示的文案</p>
<br/>
<p>站在 RN 框架开发者的视角来看，我们想要将事件处理的逻辑尽可能的统一，从而抹平不同平台之间的差异</p>
<p>自然而然的，我们会需要区分出两个角色：</p>
<ul>
<li>生产者：代表方是原生的平台。它们负责将用户事件<strong>尽可能全</strong>、<strong>尽可能早</strong>的<strong>包装</strong>好后发送给 JS 侧</li>
<li>消费者：代表方是 JS 代码。它负责<strong>接收事件</strong>，<strong>将事件语义化</strong>，最后<strong>触发事件回调</strong></li>
</ul>
<p>由于这套机制需要双方共同参与，我们接下来会先聊聊 RN 在 IOS 侧与 Android 侧分别做了什么，再来看看 JS 侧是如何处理双端传过来的数据的</p>
<h4 data-id="heading-12">Android 侧</h4>
<p>在上文 <strong>Android 的事件处理机制</strong> 中我们聊到，Android 所有的事件都会通过根元素一层一层向下传递，直到找到一个愿意消费该事件的元素</p>
<p>所以，为了满足尽可能全以及尽可能早的把消息发送给 JS 侧，我们需要找到我们所能控制的最上层节点（在 Android 中，这个节点是 <code>ReactRootView</code>）</p>
<p>找到根节点以后，我们要开始骚操作了：重载 <code>onInterceptTouchEvent</code> 与 <code>onTouchEvent</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// in ReactRootView.java</span>

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onInterceptTouchEvent</span><span class="hljs-params">(MotionEvent ev)</span> {
  dispatchJSTouchEvent(ev);
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.onInterceptTouchEvent(ev);
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onTouchEvent</span><span class="hljs-params">(MotionEvent ev)</span> {
  dispatchJSTouchEvent(ev);
  <span class="hljs-built_in">super</span>.onTouchEvent(ev);
  <span class="hljs-comment">// In case when there is no children interested in handling touch event, we return true from</span>
  <span class="hljs-comment">// the root view in order to receive subsequent events related to that gesture</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<blockquote>
<p>还记得我们在 <strong>Android 的事件处理机制</strong> 中说明的吗？当事件传递到对应的 View 时，会先调用 <code>onInterceptTouchEvent</code> 判断当前 View 是否要拦截该事件，如果拦截了会直接调用当前 View 中的 <code>onTouchEvent</code> 方法消费该事件；否则会继续将该事件往下传递知道遇到愿意消费该事件的元素或者重新返回当前的 View 调用 <code>onTouchEvent</code> 方法兜底</p>
</blockquote>
<p>在这里我们先重载了 <code>onInterceptTouchEvent</code> 方法，调用了 <code>dispatchJSTouchEvent</code> 方法<strong>把当前事件发送给 JS 侧</strong>（这个方法我们本小节后面展开聊），在此之后它返回了一个 <code>super.onInterceptTouchEvent(ev)</code> （在没有特殊情况下它的值是 false，代表会继续将该事件往下传递）</p>
<p>其次我们还重载了 <code>onTouchEvent</code> 方法，并且返回了 true（代表如果下面的元素都没有消费这个事件，它会负责兜底）</p>
<p>比较有意思的是，<code>onTouchEvent</code> 中也调用了 <code>dispatchJSTouchEvent</code> 发送当前事件给 JS 侧，这不重复了吗？</p>
<p>答案是：如果所有的子元素都不消费这个事件的话，确实会重复，但是在大部份情况下子元素都会消费事件（我们后面会聊到）所以这里的 <code>onTouchEvent</code> 在绝大部分情况都不会被执行，只是一个兜底逻辑</p>
<h5 data-id="heading-13">Button 的例子</h5>
<p>上面我们说到在 <code>ReactRootView</code> 中的 <code>onInterceptTouchEvent</code> 会返回 false 并将该消息传递下去直到找到真正的消费元素</p>
<p>接下来我们以本章节开头的 button 为例子，来看看在 Android 侧是谁来完成事件消费闭环的</p>
<p>先来看一段 Button 组件在 JS 侧是怎么被封装的吧：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// in Button.js</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Button</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span>&lt;{...}&gt; {
	<span class="hljs-comment">// ... 省略部份代码</span>
	<span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// ... 省略部份代码</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title class_">Touchable</span> =
      <span class="hljs-title class_">Platform</span>.<span class="hljs-property">OS</span> === <span class="hljs-string">'android'</span> ? <span class="hljs-title class_">TouchableNativeFeedback</span> : <span class="hljs-title class_">TouchableOpacity</span>;
    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Touchable</span>
        // <span class="hljs-attr">...</span> <span class="hljs-attr">省略部份代码</span>
      	<span class="hljs-attr">disabled</span>=<span class="hljs-string">{disabled}</span>
        <span class="hljs-attr">onPress</span>=<span class="hljs-string">{onPress}</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{buttonStyles}</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{textStyles}</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">{disabled}</span>&gt;</span>
            {formattedTitle}
          <span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Touchable</span>&gt;</span></span>
    );
  }
}
</code></pre>
<p>可以看到 Button 组件在不同的原生平台下，分别由两个组件来实现：Android 中是 <code>TouchableNativeFeedback</code>；IOS 中是 <code>TouchableOpacity</code></p>
<p>这两个组件封装了对不同原生平台差异的处理，在本小节我们先来看看 <code>TouchableNativeFeedback</code>（IOS 的 <code>TouchableOpacity</code> 可以看本文的 <strong>IOS 侧</strong> 部份）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// in TouchableNativeFeedback.android.js</span>

<span class="hljs-keyword">const</span> <span class="hljs-title class_">TouchableNativeFeedback</span> = <span class="hljs-title function_">createReactClass</span>({
	<span class="hljs-comment">// ... 省略部份代码</span>
  <span class="hljs-attr">render</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> child = <span class="hljs-title class_">React</span>.<span class="hljs-property">Children</span>.<span class="hljs-title function_">only</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">children</span>);
    <span class="hljs-keyword">const</span> childProps = {
      ...child.<span class="hljs-property">props</span>,
      <span class="hljs-comment">// ... 省略部份代码</span>
    }
    <span class="hljs-comment">// ... 省略部份代码</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">React</span>.<span class="hljs-title function_">cloneElement</span>(child, childProps);
  }
})
</code></pre>
<p>可以看到，<code>TouchableNativeFeedback</code>  的 <code>render</code>  函数最后返回了自己的 child（也就是上一个代码片段中的 View 元素）</p>
<p>这个 View 元素在经历了 RN 的布局绘制后，会被当成一个 <code>ReactViewGroup</code> 创建，所以我们来看看 <code>ReactViewGroup</code> 是如何处理事件的：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// in ReactViewGroup.java</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactViewGroup</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ViewGroup</span> <span class="hljs-keyword">implements</span>
    <span class="hljs-title class_">ReactInterceptingViewGroup</span>, ReactClippingViewGroup, ReactPointerEventsView, ReactHitSlopView,
    ReactZIndexedViewGroup {
  <span class="hljs-comment">// ... 省略部份代码</span>
  <span class="hljs-keyword">private</span> <span class="hljs-type">PointerEvents</span> <span class="hljs-variable">mPointerEvents</span> <span class="hljs-operator">=</span> PointerEvents.AUTO;
  <span class="hljs-keyword">private</span> <span class="hljs-meta">@Nullable</span> OnInterceptTouchEventListener mOnInterceptTouchEventListener;
  <span class="hljs-comment">// ... 省略部份代码</span>
      
  <span class="hljs-meta">@Override</span>
  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onInterceptTouchEvent</span><span class="hljs-params">(MotionEvent ev)</span> {
    <span class="hljs-keyword">if</span> (mOnInterceptTouchEventListener != <span class="hljs-literal">null</span> &amp;&amp;
        mOnInterceptTouchEventListener.onInterceptTouchEvent(<span class="hljs-built_in">this</span>, ev)) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-comment">// We intercept the touch event if the children are not supposed to receive it.</span>
    <span class="hljs-keyword">if</span> (mPointerEvents == PointerEvents.NONE || mPointerEvents == PointerEvents.BOX_ONLY) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.onInterceptTouchEvent(ev);
  }

  <span class="hljs-meta">@Override</span>
  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onTouchEvent</span><span class="hljs-params">(MotionEvent ev)</span> {
    <span class="hljs-comment">// We do not accept the touch event if this view is not supposed to receive it.</span>
    <span class="hljs-keyword">if</span> (mPointerEvents == PointerEvents.NONE || mPointerEvents == PointerEvents.BOX_NONE) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-comment">// The root view always assumes any view that was tapped wants the touch</span>
    <span class="hljs-comment">// and sends the event to JS as such.</span>
    <span class="hljs-comment">// We don't need to do bubbling in native (it's already happening in JS).</span>
    <span class="hljs-comment">// For an explanation of bubbling and capturing, see</span>
    <span class="hljs-comment">// http://javascript.info/tutorial/bubbling-and-capturing#capturing</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
</code></pre>
<p>代码有点长，我们重点看 <code>onInterceptTouchEvent</code> 以及 <code>onTouchEvent</code> 方法</p>
<p>在 <code>onInterceptTouchEvent</code> 中一共做了两次判断：</p>
<ol>
<li><code>mOnInterceptTouchEventListener</code>：这个是一个钩子，用来让 JS 动态决定是否要在这里拦截这个消息</li>
<li><code>mPointerEvents</code>：是一个属性，默认情况下是 AUTO，也是让 JS 决定是否要拦截这个消息，区别在于它是静态的</li>
</ol>
<p>默认情况下，这两个判断都是 false，<code>ReactViewGroup</code> 会把这个事件继续传下去</p>
<p>关键在于 <code>onTouchEvent</code> 方法，在默认情况下，它会返回 true（也就是说，它会兜底成为该事件的消费方）</p>
<p>于是，<code>ReactRootView</code> 中的 <code>dispatchJSTouchEvent</code> 方法不会被触发，JS 侧也就不会接受到重复的事件了</p>
<h5 data-id="heading-14">dispatchJSTouchEvent</h5>
<p><code>dispatchJSTouchEvent</code> 的职责除了把事件从 Android 侧发送给 JS 侧，还需要把 Android 侧独有的事件封装成 JS 侧能够消费的事件</p>
<p>我们先来看看它的实现：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// in ReactRootView.java</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactRootView</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SizeMonitoringFrameLayout</span> 
	<span class="hljs-keyword">implements</span> <span class="hljs-title class_">RootView</span>, MeasureSpecProvider {
    <span class="hljs-comment">// ... 省略部份代码</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dispatchJSTouchEvent</span><span class="hljs-params">(MotionEvent event)</span> {
        <span class="hljs-comment">// ... 省略部份代码</span>
        <span class="hljs-type">ReactContext</span> <span class="hljs-variable">reactContext</span> <span class="hljs-operator">=</span> mReactInstanceManager.getCurrentReactContext();
        <span class="hljs-type">EventDispatcher</span> <span class="hljs-variable">eventDispatcher</span> <span class="hljs-operator">=</span> reactContext.getNativeModule(UIManagerModule.class).getEventDispatcher();
        <span class="hljs-comment">// 处理触摸事件的方法</span>
        mJSTouchDispatcher.handleTouchEvent(event, eventDispatcher);
      }
}
</code></pre>
<p>可以看到，它将触摸事件的处理委托给了 <code>mJSTouchDispatcher</code> 实例中的 <code>handleTouchEvent</code> 方法，以下是它的实现：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// in JSTouchDispatcher.java</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JSTouchDispatcher</span> {
  <span class="hljs-comment">// ... 省略部份代码</span>
  
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleTouchEvent</span><span class="hljs-params">(MotionEvent ev, EventDispatcher eventDispatcher)</span> {
    <span class="hljs-comment">// 判断当前事件类型，后续我们会根据不同的事件类型做不同的数据处理</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">action</span> <span class="hljs-operator">=</span> ev.getAction() &amp; MotionEvent.ACTION_MASK;
    <span class="hljs-comment">// 处理 ACTION_DOWN 事件，标识当前用户手指放上屏幕了</span>
    <span class="hljs-keyword">if</span> (action == MotionEvent.ACTION_DOWN) {
      <span class="hljs-comment">// 这里做了一个日志的报错，如果连续接收到两个 ACTION_DOWN 事件的时候就会触发</span>
      <span class="hljs-comment">// mTargetTag 在下面会被赋值，代表处理此事件的目标组件/元素</span>
      <span class="hljs-keyword">if</span> (mTargetTag != -<span class="hljs-number">1</span>) {
        FLog.e(
          ReactConstants.TAG,
          <span class="hljs-string">"Got DOWN touch before receiving UP or CANCEL from last gesture"</span>);
      }
	
      <span class="hljs-comment">// 记录当前事件时间戳</span>
      mGestureStartTime = ev.getEventTime();
      <span class="hljs-comment">// RN 自己实现的 hit-test 逻辑，递归找到了应该消费的 View，并且返回了该 View 的 tag</span>
      <span class="hljs-comment">// 这个 tag 是当 js 侧调用 createView 时传过来的 tag，唯一标识了一个 js 侧的元素</span>
      mTargetTag = findTargetTagAndSetCoordinates(ev);
      <span class="hljs-comment">// 把 ACTION_DOWN 事件包装后发给 js ce</span>
      eventDispatcher.dispatchEvent(
        TouchEvent.obtain(
          mTargetTag,
          TouchEventType.START,
          ev,
          mGestureStartTime,
          mTargetCoordinates[<span class="hljs-number">0</span>],
          mTargetCoordinates[<span class="hljs-number">1</span>],
          mTouchEventCoalescingKeyHelper));
      <span class="hljs-comment">// 以下的 else 省略了一些场景的处理逻辑，只重点放了点击事件相关的处理逻辑</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (action == MotionEvent.ACTION_UP) {
      <span class="hljs-comment">// 处理 ACTION_UP 事件，标识当前用户手指离开屏幕了</span>
      
      <span class="hljs-comment">// 更新了 mTargetCoordinates，这个是用来表示当前用户手指位置</span>
      findTargetTagAndSetCoordinates(ev);
      <span class="hljs-comment">// 包装并发送事件给 js 侧</span>
      eventDispatcher.dispatchEvent(
        TouchEvent.obtain(
          mTargetTag,
          TouchEventType.END,
          ev,
          mGestureStartTime,
          mTargetCoordinates[<span class="hljs-number">0</span>],
          mTargetCoordinates[<span class="hljs-number">1</span>],
          mTouchEventCoalescingKeyHelper));
      <span class="hljs-comment">// 恢复成初始状态</span>
      mTargetTag = -<span class="hljs-number">1</span>;
      mGestureStartTime = TouchEvent.UNSET;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (action == MotionEvent.ACTION_MOVE) {
			<span class="hljs-comment">// 处理 ACTION_MOVE 事件，标识当前用户手指在屏幕上的移动</span>
      
      <span class="hljs-comment">// 更新了 mTargetCoordinates</span>
      findTargetTagAndSetCoordinates(ev);
      
      <span class="hljs-comment">// 包装并发送事件给 js 侧</span>
      eventDispatcher.dispatchEvent(
        TouchEvent.obtain(
          mTargetTag,
          TouchEventType.MOVE,
          ev,
          mGestureStartTime,
          mTargetCoordinates[<span class="hljs-number">0</span>],
          mTargetCoordinates[<span class="hljs-number">1</span>],
          mTouchEventCoalescingKeyHelper));
    }  <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 兜底逻辑</span>
      FLog.w(
        ReactConstants.TAG,
        <span class="hljs-string">"Warning : touch event was ignored. Action="</span> + action + <span class="hljs-string">" Target="</span> + mTargetTag);
    }
  }
}
</code></pre>
<p>代码部份看起来很多，但是其实只包含了三个部份：</p>
<ol>
<li>对 <code>ACTION_DOWN</code> 事件的处理</li>
<li>对 <code>ACTION_UP</code> 事件的处理</li>
<li>对 <code>ACTION_MOVE</code> 事件的处理</li>
</ol>
<p>这三个事件的处理说白了就是把事件包装好后发送给 js 侧供 js 消费</p>
<p>至此，Android 侧的工作已完结撒花～🎉</p>
<h4 data-id="heading-15">IOS 侧</h4>
<p>IOS 侧身为事件的另一个生产者，它的职责也是<strong>将事件尽可能早、尽可能快的包装好传递给 JS 侧</strong></p>
<p>在上文 <strong>IOS 的事件处理机制</strong> 中，我们聊到了 <strong>UIGestureRecognizer</strong> 的两个特性：</p>
<ol>
<li>如果一个 View 被命中了，它所有父元素上附着的 GestureRecognizer 都会被 “告知”</li>
<li>当任何事件被触发时，GestureRecognizer 总是第一个被 “告知” 的</li>
</ol>
<p>根据这两点，我们可以在我们能控制的最上层节点（IOS 中这个节点是 RCTRootContentView）附着 UIGestureRecognizer，然后定制其中的 touchesBegan 等事件的回调，从而履行上述的职责</p>
<p>让我们来看看 RN 是如何实现的：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// 第一步：把 UIGestureRecognizer 附着在 RCTRootContentView 上</span>
<span class="hljs-comment">// in RCTRootContentView.m</span>
- (<span class="hljs-keyword">instancetype</span>)initWithFrame:(<span class="hljs-built_in">CGRect</span>)frame
                       bridge:(RCTBridge *)bridge
                     reactTag:(<span class="hljs-built_in">NSNumber</span> *)reactTag
               sizeFlexiblity:(RCTRootViewSizeFlexibility)sizeFlexibility
{
  <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">self</span> = [<span class="hljs-variable language_">super</span> initWithFrame:frame])) {
    <span class="hljs-comment">// ...省略部份代码</span>
    
    <span class="hljs-comment">// 初始化 RCTTouchHandler 并取得其实例</span>
    _touchHandler = [[RCTTouchHandler alloc] initWithBridge:_bridge];
    <span class="hljs-comment">// 调用 RCTTouchHandler 的 attachToView 方法（下面会有实现）</span>
    [_touchHandler attachToView:<span class="hljs-keyword">self</span>];

    <span class="hljs-comment">// ...省略部份代码</span>
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;
}

<span class="hljs-comment">// in RCTTouchHandler.m</span>
- (<span class="hljs-type">void</span>)attachToView:(<span class="hljs-built_in">UIView</span> *)view
{
  RCTAssert(<span class="hljs-keyword">self</span>.view == <span class="hljs-literal">nil</span>, <span class="hljs-string">@"RCTTouchHandler already has attached view."</span>);

  <span class="hljs-comment">// attachToView 方法的实现，本质上就是调用了父类的 addGestureRecognizer 把 UIGestureRecognizer 附着上了 RCTRootContentView</span>
  [view addGestureRecognizer:<span class="hljs-keyword">self</span>];
}
</code></pre>
<p>上面的代码展示了 RN 是如何将 RCTTouchHandler 附着在 RCTRootContentView 节点上的，接下来我们来看看 RCTTouchHandler 是什么，以及做了什么事：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 第二步：修改事件回调的实现</span>
<span class="hljs-comment">// in RCTTouchHandler.h</span>
<span class="hljs-comment">// ... 省略部份代码</span>

<span class="hljs-comment">// 从这里可以看到 RCTTouchHandler 继承了 UIGestureRecognizer</span>
@interface <span class="hljs-title class_">RCTTouchHandler</span> : <span class="hljs-title class_">UIGestureRecognizer</span>

<span class="hljs-comment">// in RCTTouchHandler.m</span>
<span class="hljs-comment">// 重载 UIGestureRecognizer 的 touchesBegan 方法</span>
- (<span class="hljs-keyword">void</span>)<span class="hljs-attr">touchesBegan</span>:(<span class="hljs-title class_">NSSet</span>&lt;<span class="hljs-title class_">UITouch</span> *&gt; *)touches <span class="hljs-attr">withEvent</span>:(<span class="hljs-title class_">UIEvent</span> *)event
{
	<span class="hljs-comment">// 调用父类方法，保证 IOS 的事件系统同步到了这个事件（否则就被拦截在这里了）</span>
  [<span class="hljs-variable language_">super</span> <span class="hljs-attr">touchesBegan</span>:touches <span class="hljs-attr">withEvent</span>:event];

	<span class="hljs-comment">// ...省略部份代码</span>

	<span class="hljs-comment">// 将 touchStart 事件包装后发送给 js 侧</span>
  [self <span class="hljs-attr">_updateAndDispatchTouches</span>:touches <span class="hljs-attr">eventName</span>:@<span class="hljs-string">"touchStart"</span>];

	<span class="hljs-comment">// 保证 IOS Recognizer 状态机的正常流转</span>
  <span class="hljs-keyword">if</span> (self.<span class="hljs-property">state</span> == <span class="hljs-title class_">UIGestureRecognizerStatePossible</span>) {
    self.<span class="hljs-property">state</span> = <span class="hljs-title class_">UIGestureRecognizerStateBegan</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (self.<span class="hljs-property">state</span> == <span class="hljs-title class_">UIGestureRecognizerStateBegan</span>) {
    self.<span class="hljs-property">state</span> = <span class="hljs-title class_">UIGestureRecognizerStateChanged</span>;
  }
}

<span class="hljs-comment">// 重载 UIGestureRecognizer 的 touchesMoved 方法</span>
- (<span class="hljs-keyword">void</span>)<span class="hljs-attr">touchesMoved</span>:(<span class="hljs-title class_">NSSet</span>&lt;<span class="hljs-title class_">UITouch</span> *&gt; *)touches <span class="hljs-attr">withEvent</span>:(<span class="hljs-title class_">UIEvent</span> *)event
{
  <span class="hljs-comment">// 调用父类方法，保证 IOS 的事件系统同步到了这个事件（否则就被拦截在这里了）</span>
  [<span class="hljs-variable language_">super</span> <span class="hljs-attr">touchesMoved</span>:touches <span class="hljs-attr">withEvent</span>:event];

	<span class="hljs-comment">// 将 touchMove 事件包装后发送给 js 侧</span>
  [self <span class="hljs-attr">_updateAndDispatchTouches</span>:touches <span class="hljs-attr">eventName</span>:@<span class="hljs-string">"touchMove"</span>];
	<span class="hljs-comment">// 保证 IOS Recognizer 状态机的正常流转</span>
  self.<span class="hljs-property">state</span> = <span class="hljs-title class_">UIGestureRecognizerStateChanged</span>;
}

<span class="hljs-comment">// 重载 UIGestureRecognizer 的 touchesEnded 方法</span>
- (<span class="hljs-keyword">void</span>)<span class="hljs-attr">touchesEnded</span>:(<span class="hljs-title class_">NSSet</span>&lt;<span class="hljs-title class_">UITouch</span> *&gt; *)touches <span class="hljs-attr">withEvent</span>:(<span class="hljs-title class_">UIEvent</span> *)event
{
  [<span class="hljs-variable language_">super</span> <span class="hljs-attr">touchesEnded</span>:touches <span class="hljs-attr">withEvent</span>:event];

	<span class="hljs-comment">// 将 touchEnd 事件包装后发送给 js 侧</span>
  [self <span class="hljs-attr">_updateAndDispatchTouches</span>:touches <span class="hljs-attr">eventName</span>:@<span class="hljs-string">"touchEnd"</span>];

	<span class="hljs-comment">// 保证 IOS Recognizer 状态机的正常流转</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">RCTAllTouchesAreCancelledOrEnded</span>(event.<span class="hljs-property">allTouches</span>)) {
    self.<span class="hljs-property">state</span> = <span class="hljs-title class_">UIGestureRecognizerStateEnded</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title class_">RCTAnyTouchesChanged</span>(event.<span class="hljs-property">allTouches</span>)) {
    self.<span class="hljs-property">state</span> = <span class="hljs-title class_">UIGestureRecognizerStateChanged</span>;
  }
	<span class="hljs-comment">// ...省略部份代码</span>
}

<span class="hljs-comment">// 重载 UIGestureRecognizer 的 touchesCancelled 方法</span>
- (<span class="hljs-keyword">void</span>)<span class="hljs-attr">touchesCancelled</span>:(<span class="hljs-title class_">NSSet</span>&lt;<span class="hljs-title class_">UITouch</span> *&gt; *)touches <span class="hljs-attr">withEvent</span>:(<span class="hljs-title class_">UIEvent</span> *)event
{
  [<span class="hljs-variable language_">super</span> <span class="hljs-attr">touchesCancelled</span>:touches <span class="hljs-attr">withEvent</span>:event];

	<span class="hljs-comment">// 将 touchEnd 事件包装后发送给 js 侧</span>
  [self <span class="hljs-attr">_updateAndDispatchTouches</span>:touches <span class="hljs-attr">eventName</span>:@<span class="hljs-string">"touchCancel"</span>];

	<span class="hljs-comment">// 保证 IOS Recognizer 状态机的正常流转</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">RCTAllTouchesAreCancelledOrEnded</span>(event.<span class="hljs-property">allTouches</span>)) {
    self.<span class="hljs-property">state</span> = <span class="hljs-title class_">UIGestureRecognizerStateCancelled</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title class_">RCTAnyTouchesChanged</span>(event.<span class="hljs-property">allTouches</span>)) {
    self.<span class="hljs-property">state</span> = <span class="hljs-title class_">UIGestureRecognizerStateChanged</span>;
  }
  <span class="hljs-comment">// ...省略部份代码</span>
}
</code></pre>
<p>根据上面 <code>RCTTouchHandler.m</code> 的实现我们可以看到所有的事件回调都包含三个部份的内容：</p>
<ol>
<li>调用父类的同名方法：这个是 IOS 系统要求的，因为 UIGestureRecognizer 还会负责协调不同的 Recognizer，所以我们必须跟它同步最新的消息</li>
<li>将当前事件打包后发送给 JS 侧</li>
<li>正常流转状态：在 UIGestureRecognizer 这个类中是没有状态流转的逻辑的，这些状态的变化都要仰赖子类的维护，而 UIKit 会根据这个状态来判断/执行一些逻辑，所以这个是必须实现的</li>
</ol>
<p>最后还有一个小细节，前面我们在聊 UIGestureRecognizer 的状态的时候，我们说过点击属于离散型手势，它的特征就是手势的状态是 <code>Possible -&gt; Recognized/Failed</code></p>
<p>但是我们仔细观察 RCTTouchHandler 的实现，不难发现它的状态流转是 <code>Possible -&gt; Begin -&gt; [Changed] -&gt; Ended/Cancel</code></p>
<p>这是因为这个类的目的是处理所有的 Touch 事件，所以它必须向 JS 侧完整的传递所有事件，由 JS 侧来判断事件的类型</p>
<p>至此，IOS 侧的工作也已完结撒花～🎉</p>
<h4 data-id="heading-16">JS 侧</h4>
<p>最后，我们来聊聊 JS 侧是如何处理双端发来的事件消息的</p>
<p>在 JS 侧，RN 对外定义了一个名为 <code>RCTEventEmitter</code> 的模块来接收客户端传来的事件，客户端可以通过 bridge 调用其中的 <code>receiveTouches</code> 方法来发送触摸事件给 JS 侧</p>
<p>当 JS 侧接收到了客户端发送过来的事件消息后，它有三个任务需要完成：</p>
<ol>
<li>将原始的事件合成语义化事件</li>
<li>让语义化事件遵循事件捕获/事件冒泡机制到达目标节点</li>
<li>触发开发者注册的事件回调</li>
</ol>
<p>为了了解 RN 时如何完成这三个任务，我们需要先来聊聊 React 的事件系统的核心：<strong>EventPluginHub</strong></p>
<h5 data-id="heading-17">EventPluginHub</h5>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0f56f724fcd481a837275af2b9f73ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSm95ZWU2OTE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765269930&amp;x-signature=VYaRZw0oHWBxYQ06BENh5v57NT8%3D" alt="RN_react_EventPluginHub" loading="lazy"/></p>
<p>我们先来看图中深色字体的部份，EventPluginHub 做了三件事：</p>
<ol>
<li>接收传过来的低级事件</li>
<li>把插件注入系统</li>
<li>接收插件传过来的合成事件，然后依次派发出去</li>
</ol>
<p>可以看到 EventPluginHub 的职责其实非常简单，但是插件要考虑的事就很多了😆</p>
<p>但是在聊插件做了什么之前，我想先聊聊为什么要这么设计 React 的事件系统：</p>
<ul>
<li><strong>跨浏览器一致性</strong>：React 在设计之初就肩负跨浏览器的责任，所以它需要一个事件层来弭平不同浏览器之间的差异，合成事件 Synthetic event 也作为最终一致性的产物应运而生</li>
<li><strong>跨平台能力抽象</strong>：从 React 跨到 RN，事件层接收到的事件也有显著区别，唯一不变的是事件处理的流程，所以把变化的部份插件化，根据场景注入插件处理</li>
<li><strong>性能</strong>：不论是 React 或者 RN 都在尽可能靠近根元素的位置附着监听器拦截事件，不仅最大化减少了监听器的内存占用，也减少了管理多个监听器的复杂度</li>
<li><strong>高扩展低耦合</strong>：插件的设计不仅让接入不同场景的成本更低；也可以让不同的插件区分不同的事件类型，增加插件内的耦合度</li>
</ul>
<br/>
<p>那么插件内部都在做什么呢？虽然每个插件实现都略有差异，但总体而言每个插件都有三个核心职责：</p>
<ol>
<li>将不同类型的低级事件转换成<strong>合成事件</strong></li>
<li>将合成事件通过捕获/冒泡找出负责处理该事件的组件 handler</li>
<li>将<strong>及时事件 On-Demond events</strong> 马上发送给 handler；将其他<strong>非及时事件 Deffered-Dispatch events</strong> 留给 EventPluginHub 处理</li>
</ol>
<p>其中有两个非常有意思的概念：<strong>及时事件 On-Demond events</strong> 和 <strong>非及时事件 Deffered-Dispatch events</strong></p>
<ul>
<li><strong>及时事件 On-Demond events</strong> 指的是那些在捕获/冒泡阶段遍历组件的时候就需要<strong>在插件中</strong>实时发送的事件，如果这类事件没有实时发送，会阻碍后面事件的正常传递，比如 RN 中能在捕获阶段拦截事件的 <code>onStartShouldSetResponderCapture</code>（后文会有介绍）</li>
<li><strong>非及时事件 Deffered-Dispatch events</strong> 指的是在插件中没有发送，而是被收集起来在最后被 EventPluginHub 一起发送的事件，实际上大多数的事件都是此类事件，可以把及时事件看成是一种不得已而为之的 trade-off，比如 RN 中代表用户手指放下的事件 <code>onResponderStart</code>（后文会有介绍）</li>
</ul>
<h5 data-id="heading-18">ResponderEventPlugin</h5>
<p>了解了 EventPluginHub 以及插件的职责后，我们接下来要来深入聊聊 RN 场景下用到的插件了</p>
<p>根据上文的图片我们可以得知，RN 为 EventPluginHub 注入了两个插件：<code>ResponderEventPlugin</code> 和 <code>ReactNativeBridgeEventPlugin</code></p>
<p>其中 <code>ResponderEventPlugin</code> 主要负责触摸相关的事件；而 <code>ReactNativeBridgeEventPlugin</code> 则负责其他由 Native 发送过来的事件</p>
<blockquote>
<p>注意事项 1：
由于本文主要讲解触摸事件的处理，所以本章节只会讲解 <code>ResponderEventPlugin</code> 的实现，实际上 <code>ReactNativeBridgeEventPlugin</code> 的实现可以看成 <code>ResponderEventPlugin</code> 的简化版，所以如果看懂了 <code>ResponderEventPlugin</code>，自己看 <code>ReactNativeBridgeEventPlugin</code> 也能轻松理解</p>
<p>注意事项 2：
在后文的代码阅读中，不需要太早关心具体的实现，我们只需要抓住上文插件的三个职责慢慢理解即可</p>
<p>注意事项 3：
后文代码是基于 React 版本 v16.5.2（该版本是 RN v0.57.0 的默认 React 版本）
由于 RN 中的对应代码是压缩过的，所以强烈建议去 React 的仓库阅读，我文件名也会留 React 仓库的文件名</p>
</blockquote>
<p>首先我们先来看看 EventPluginHub 是如何暴露插件注入接口的：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// in EventPluginHub.js</span>

<span class="hljs-comment">/**
 * Methods for injecting dependencies.
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> injection = {
  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">array</span>} <span class="hljs-variable">InjectedEventPluginOrder</span>
   * <span class="hljs-doctag">@public</span>
   */</span>
  injectEventPluginOrder,

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">object</span>} injectedNamesToPlugins Map from names to plugin modules.
   */</span>
  injectEventPluginsByName,
};

</code></pre>
<p>EventPluginHub 暴露了两个方法：<code>injectEventPluginOrder</code> 和 <code>injectEventPluginsByName</code></p>
<ul>
<li><code>injectEventPluginOrder</code> 代表插件的顺序，顺序越靠前的插件产生的事件会越早被 EventPluginHub 发送出去</li>
<li><code>injectEventPluginsByName</code> 代表插件名称与插件实现的映射</li>
</ul>
<br/>
<p>接下来看看 RN 是怎么注入插件的：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// in ReactNativeInjectionShared.js</span>

<span class="hljs-comment">// 插入插件顺序</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">ReactNativeEventPluginOrder</span> = [
  <span class="hljs-string">'ResponderEventPlugin'</span>,
  <span class="hljs-string">'ReactNativeBridgeEventPlugin'</span>,
];

<span class="hljs-comment">/**
 * Inject module for resolving DOM hierarchy and plugin ordering.
 */</span>
<span class="hljs-title class_">EventPluginHub</span>.<span class="hljs-property">injection</span>.<span class="hljs-title function_">injectEventPluginOrder</span>(<span class="hljs-title class_">ReactNativeEventPluginOrder</span>);

<span class="hljs-comment">/**
 * Some important event plugins included by default (without having to require
 * them).
 */</span>
<span class="hljs-title class_">EventPluginHub</span>.<span class="hljs-property">injection</span>.<span class="hljs-title function_">injectEventPluginsByName</span>({
  <span class="hljs-title class_">ResponderEventPlugin</span>: <span class="hljs-title class_">ResponderEventPlugin</span>,
  <span class="hljs-title class_">ReactNativeBridgeEventPlugin</span>: <span class="hljs-title class_">ReactNativeBridgeEventPlugin</span>,
});
</code></pre>
<p>可以看到插件的顺序是先处理 <code>ResponderEventPlugin</code> 后处理 <code>ReactNativeBridgeEventPlugin</code></p>
<br/>
<p>插件准备就绪后，我们来看看事件是如何进入 EventPluginHub：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// in ReactNativeInjection.js</span>

<span class="hljs-comment">// RCTEventEmitter 模块的实现由 RN 提供</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">RCTEventEmitter</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'RCTEventEmitter'</span>;

<span class="hljs-comment">// 在 bridge 上注册了可以被 native 调用的模块</span>
<span class="hljs-title class_">RCTEventEmitter</span>.<span class="hljs-title function_">register</span>(<span class="hljs-title class_">ReactNativeEventEmitter</span>);
</code></pre>
<p>接下来看看 ReactNativeEventEmitter 模块做了什么</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// in ReactNativeEventEmitter.js</span>

<span class="hljs-comment">// Native 发送普通事件（非触摸事件）用的方法</span>
<span class="hljs-comment">// 本质上就是把参数透传给 _receiveRootNodeIDEvent</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">receiveEvent</span>(<span class="hljs-params">
  rootNodeID: number,
  topLevelType: TopLevelType,
  nativeEventParam: AnyNativeEvent,
</span>) {
  <span class="hljs-title function_">_receiveRootNodeIDEvent</span>(rootNodeID, topLevelType, nativeEventParam);
}

<span class="hljs-comment">// Native 发送触摸事件用的方法</span>
<span class="hljs-comment">// 职责有 2:</span>
<span class="hljs-comment">// 1. 把 “有变化的事件” 找出来处理，忽略 “没有变化的事件”</span>
<span class="hljs-comment">// 2. 调用 _receiveRootNodeIDEvent 处理有变化的事件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">receiveTouches</span>(<span class="hljs-params">
	<span class="hljs-comment">// 事件类型，对应到 Native 的 touchStart, touchMove 等事件</span>
  eventTopLevelType: TopLevelType,
   <span class="hljs-comment">// 当前被触发的事件（如果有多个手指则有多个事件被触发）</span>
  touches: <span class="hljs-built_in">Array</span>&lt;<span class="hljs-built_in">Object</span>&gt;,
   <span class="hljs-comment">// 当前变化的事件下标</span>
  changedIndices: <span class="hljs-built_in">Array</span>&lt;number&gt;,
</span>) {
  <span class="hljs-comment">// 找出变化的触摸事件</span>
  <span class="hljs-keyword">const</span> changedTouches =
    eventTopLevelType === <span class="hljs-string">'topTouchEnd'</span> ||
    eventTopLevelType === <span class="hljs-string">'topTouchCancel'</span>
      ? <span class="hljs-title function_">removeTouchesAtIndices</span>(touches, changedIndices)
      : <span class="hljs-title function_">touchSubsequence</span>(touches, changedIndices);

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> jj = <span class="hljs-number">0</span>; jj &lt; changedTouches.<span class="hljs-property">length</span>; jj++) {
    <span class="hljs-keyword">const</span> touch = changedTouches[jj];
    <span class="hljs-comment">// 构建一个符合 Dom event 标准的 touch 事件，这一步可以省去一个构建</span>
    touch.<span class="hljs-property">changedTouches</span> = changedTouches;
    touch.<span class="hljs-property">touches</span> = touches;
    <span class="hljs-keyword">const</span> nativeEvent = touch;
    <span class="hljs-keyword">let</span> rootNodeID = <span class="hljs-literal">null</span>;
    <span class="hljs-comment">// 消费该事件的目标组件（Native 侧计算结果）</span>
    <span class="hljs-keyword">const</span> target = nativeEvent.<span class="hljs-property">target</span>;
    <span class="hljs-keyword">if</span> (target !== <span class="hljs-literal">null</span> &amp;&amp; target !== <span class="hljs-literal">undefined</span>) {
      <span class="hljs-keyword">if</span> (target &lt; <span class="hljs-number">1</span>) {
      } <span class="hljs-keyword">else</span> {
        rootNodeID = target;
      }
    }
    <span class="hljs-title function_">_receiveRootNodeIDEvent</span>(rootNodeID, eventTopLevelType, nativeEvent);
  }
}

<span class="hljs-comment">// 负责调用 EventPluginHub 内部方法处理事件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">_receiveRootNodeIDEvent</span>(<span class="hljs-params">
  rootNodeID: number,
  topLevelType: TopLevelType,
  nativeEventParam: ?AnyNativeEvent,
</span>) {
  <span class="hljs-keyword">const</span> nativeEvent = nativeEventParam || <span class="hljs-variable constant_">EMPTY_NATIVE_EVENT</span>;
  <span class="hljs-keyword">const</span> inst = <span class="hljs-title function_">getInstanceFromNode</span>(rootNodeID);
  <span class="hljs-comment">// 将内部方法打包成一次更新</span>
  <span class="hljs-title function_">batchedUpdates</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 调用 EventPluginHub 内部方法，进入 EventPluginHu 逻辑</span>
    <span class="hljs-title function_">runExtractedEventsInBatch</span>(
      topLevelType,
      inst,
      nativeEvent,
      nativeEvent.<span class="hljs-property">target</span>,
    );
  });
}
</code></pre>
<p>总结：当 receiveTouches 接收到 Native 的事件后，它会挑选出有变化的部份委托 EventPluginHub 处理</p>
<p>所以接下来我们要正式开始运行 EventPluginHub 了：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// in EventPluginHub.js</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">runExtractedEventsInBatch</span>(<span class="hljs-params">
  topLevelType: TopLevelType,
  targetInst: <span class="hljs-literal">null</span> | Fiber,
  nativeEvent: AnyNativeEvent,
  nativeEventTarget: EventTarget,
</span>) {
  <span class="hljs-comment">// 这个方法是 EventPluginHub 插件系统的核心</span>
  <span class="hljs-comment">// EventPluginHub 要求每一个插件都要实现各自的 extractEvents 方法</span>
  <span class="hljs-comment">// 目的就是履行上述插件的三个职责</span>
  <span class="hljs-keyword">const</span> events = <span class="hljs-title function_">extractEvents</span>(
    topLevelType,
    targetInst,
    nativeEvent,
    nativeEventTarget,
  );
  <span class="hljs-comment">// 这里的 events 就是我上文说的 Deffered-Dispatch events</span>
  <span class="hljs-comment">// 这些事件会在 runEventsInBatch 中统一被发送给各自的 handler</span>
  <span class="hljs-title function_">runEventsInBatch</span>(events, <span class="hljs-literal">false</span>);
}

<span class="hljs-comment">// EventPluginHub 中的 extractEvents</span>
<span class="hljs-comment">// 它会按照顺序遍历插件，并且执行插件中实现的 extractEvents 方法</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">extractEvents</span>(<span class="hljs-params">
  topLevelType: TopLevelType,
  targetInst: <span class="hljs-literal">null</span> | Fiber,
  nativeEvent: AnyNativeEvent,
  nativeEventTarget: EventTarget,
</span>): <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">ReactSyntheticEvent</span>&gt; | <span class="hljs-title class_">ReactSyntheticEvent</span> | <span class="hljs-literal">null</span> {
  <span class="hljs-keyword">let</span> events = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; plugins.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-comment">// Not every plugin in the ordering may be loaded at runtime.</span>
    <span class="hljs-keyword">const</span> <span class="hljs-attr">possiblePlugin</span>: <span class="hljs-title class_">PluginModule</span>&lt;<span class="hljs-title class_">AnyNativeEvent</span>&gt; = plugins[i];
    <span class="hljs-keyword">if</span> (possiblePlugin) {
      <span class="hljs-keyword">const</span> extractedEvents = possiblePlugin.<span class="hljs-title function_">extractEvents</span>(
        topLevelType,
        targetInst,
        nativeEvent,
        nativeEventTarget,
      );
      <span class="hljs-keyword">if</span> (extractedEvents) {
        events = <span class="hljs-title function_">accumulateInto</span>(events, extractedEvents);
      }
    }
  }
  <span class="hljs-keyword">return</span> events;
}
</code></pre>
<p>接下来我们看看 ResponderEventPlugin 是如何实现 extractEvents 的吧～</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// in ResponderEventPlugin.js</span>

<span class="hljs-keyword">const</span> <span class="hljs-title class_">ResponderEventPlugin</span> = {
  <span class="hljs-comment">// ... 省略部份代码</span>

	<span class="hljs-attr">extractEvents</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">
    topLevelType,
    targetInst,
    nativeEvent,
    nativeEventTarget,
  </span>) {
    <span class="hljs-comment">// 修改当前处于激活状态的 touch events 数量</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isStartish</span>(topLevelType)) {
      trackedTouchCount += <span class="hljs-number">1</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isEndish</span>(topLevelType)) {
      <span class="hljs-keyword">if</span> (trackedTouchCount &gt;= <span class="hljs-number">0</span>) {
        trackedTouchCount -= <span class="hljs-number">1</span>;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(
          <span class="hljs-string">'Ended a touch event which was not counted in `trackedTouchCount`.'</span>,
        );
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
      }
    }

    <span class="hljs-comment">// 把当前的事件记录/更新到 ResponderTouchHistoryStore 中</span>
    <span class="hljs-comment">// 主要是为了多点触控时计算几何信息用的（感兴趣可以看看 RN Libraries/Interaction/TouchHistoryMath.js 的实现）</span>
    <span class="hljs-title class_">ResponderTouchHistoryStore</span>.<span class="hljs-title function_">recordTouchTrack</span>(topLevelType, nativeEvent);

    <span class="hljs-comment">// canTriggerTransfer：判断是否需要重新计算事件的 handler 组件</span>
    <span class="hljs-comment">// setResponderAndExtractTransfer：通过事件捕获/冒泡流程得到新的 handler 组件并更新 responderInst（指向 handler 组件的实例）</span>
    <span class="hljs-comment">// 这两个方法在下文会有详细说明</span>
    <span class="hljs-comment">// 这里声明的 extracted 就是我们上问说的 Deffered-Dispatch events</span>
    <span class="hljs-keyword">let</span> extracted = <span class="hljs-title function_">canTriggerTransfer</span>(topLevelType, targetInst, nativeEvent)
      ? <span class="hljs-title function_">setResponderAndExtractTransfer</span>(
          topLevelType,
          targetInst,
          nativeEvent,
          nativeEventTarget,
        )
      : <span class="hljs-literal">null</span>;
    
    <span class="hljs-comment">// 根据事件类型取得不同的 eventTypes（枚举记录在本代码片段后面）</span>
    <span class="hljs-comment">// eventTypes 记录了不同事件注册事件回调的组件属性</span>
    <span class="hljs-keyword">const</span> isResponderTouchStart = responderInst &amp;&amp; <span class="hljs-title function_">isStartish</span>(topLevelType);
    <span class="hljs-keyword">const</span> isResponderTouchMove = responderInst &amp;&amp; <span class="hljs-title function_">isMoveish</span>(topLevelType);
    <span class="hljs-keyword">const</span> isResponderTouchEnd = responderInst &amp;&amp; <span class="hljs-title function_">isEndish</span>(topLevelType);
    <span class="hljs-keyword">const</span> incrementalTouch = isResponderTouchStart
      ? eventTypes.<span class="hljs-property">responderStart</span>
      : isResponderTouchMove
        ? eventTypes.<span class="hljs-property">responderMove</span>
        : isResponderTouchEnd
          ? eventTypes.<span class="hljs-property">responderEnd</span>
          : <span class="hljs-literal">null</span>;

    <span class="hljs-keyword">if</span> (incrementalTouch) {
      <span class="hljs-comment">// 根据 eventTypes 构建 SyntheticEvent</span>
      <span class="hljs-comment">// SyntheticEvent 中有一个有趣的设计：eventPool</span>
      <span class="hljs-comment">// eventPool 用来保存当前 SyntheticEvent 的多个实例</span>
      <span class="hljs-comment">// 如果有事件生命周期完结了，eventPool 不会马上销毁这个实例，而是会用新的事件覆盖该实例以减少性能开销</span>
      <span class="hljs-comment">// 感兴趣可以看看：SyntheticEvent.js</span>
      <span class="hljs-keyword">const</span> gesture = <span class="hljs-title class_">ResponderSyntheticEvent</span>.<span class="hljs-title function_">getPooled</span>(
        incrementalTouch,
        responderInst,
        nativeEvent,
        nativeEventTarget,
      );
      <span class="hljs-comment">// 记录 touchHistory</span>
      gesture.<span class="hljs-property">touchHistory</span> = <span class="hljs-title class_">ResponderTouchHistoryStore</span>.<span class="hljs-property">touchHistory</span>;
      <span class="hljs-comment">// 维护事件的 handler 以及 listener 回调</span>
      <span class="hljs-title function_">accumulateDirectDispatches</span>(gesture);
      <span class="hljs-comment">// 把处理好的事件加入到 Deffered-Dispatch events 的数组中</span>
      extracted = <span class="hljs-title function_">accumulate</span>(extracted, gesture);
    }

    <span class="hljs-comment">// 处理 touchCancel 事件或者当前 handler 没有任何事件的情况</span>
    <span class="hljs-keyword">const</span> isResponderTerminate =
      responderInst &amp;&amp; topLevelType === <span class="hljs-variable constant_">TOP_TOUCH_CANCEL</span>;
    <span class="hljs-keyword">const</span> isResponderRelease =
      responderInst &amp;&amp;
      !isResponderTerminate &amp;&amp;
      <span class="hljs-title function_">isEndish</span>(topLevelType) &amp;&amp;
      <span class="hljs-title function_">noResponderTouches</span>(nativeEvent);
    <span class="hljs-keyword">const</span> finalTouch = isResponderTerminate
      ? eventTypes.<span class="hljs-property">responderTerminate</span>
      : isResponderRelease
        ? eventTypes.<span class="hljs-property">responderRelease</span>
        : <span class="hljs-literal">null</span>;
    <span class="hljs-comment">// 如果有 touchCancel 事件或者 handler release 了，构建其事件到 Deffered-Dispatch events 的数组中</span>
    <span class="hljs-keyword">if</span> (finalTouch) {
      <span class="hljs-keyword">const</span> finalEvent = <span class="hljs-title class_">ResponderSyntheticEvent</span>.<span class="hljs-title function_">getPooled</span>(
        finalTouch,
        responderInst,
        nativeEvent,
        nativeEventTarget,
      );
      finalEvent.<span class="hljs-property">touchHistory</span> = <span class="hljs-title class_">ResponderTouchHistoryStore</span>.<span class="hljs-property">touchHistory</span>;
      <span class="hljs-title function_">accumulateDirectDispatches</span>(finalEvent);
      extracted = <span class="hljs-title function_">accumulate</span>(extracted, finalEvent);
      <span class="hljs-title function_">changeResponder</span>(<span class="hljs-literal">null</span>);
    }

    <span class="hljs-comment">// 返回所有的 Deffered-Dispatch events</span>
    <span class="hljs-keyword">return</span> extracted;
  },
}


</code></pre>
<p>我们可以看到 ResponderEventPlugin 的 extractEvents 目的就是维护不同情况下，需要给 handler 的各种事件回调</p>
<p>其中有一个寻找 handler 的核心方法 <code>setResponderAndExtractTransfer</code> 下面我们来重点揭秘一下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// in ResponderEventPlugin.js</span>

<span class="hljs-comment">/**
 * 主要职责有 2:
 * 1. 通过捕获/冒泡寻找 handler 组件，并且更新 handler（也就是代码中的 responderInst）
 * 2. 收集过程中产生的 Deffered-Dispatch events 并返回
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">setResponderAndExtractTransfer</span>(<span class="hljs-params">
  topLevelType,
  targetInst,
  nativeEvent,
  nativeEventTarget,
</span>) {
  <span class="hljs-comment">// 根据当前事件选择合适的 eventTypes</span>
  <span class="hljs-keyword">const</span> shouldSetEventType = <span class="hljs-title function_">isStartish</span>(topLevelType)
    ? eventTypes.<span class="hljs-property">startShouldSetResponder</span>
    : <span class="hljs-title function_">isMoveish</span>(topLevelType)
      ? eventTypes.<span class="hljs-property">moveShouldSetResponder</span>
      : topLevelType === <span class="hljs-variable constant_">TOP_SELECTION_CHANGE</span>
        ? eventTypes.<span class="hljs-property">selectionChangeShouldSetResponder</span>
        : eventTypes.<span class="hljs-property">scrollShouldSetResponder</span>;

  <span class="hljs-comment">// 判断事件冒泡应该从哪一个组件开始</span>
  <span class="hljs-comment">// 如果当前没有 handler，则我们以当前事件的 target 为开始点</span>
  <span class="hljs-comment">// 如果当前已经有了 handler，我们需要找到当前 handler 与 target 的最小共同祖先</span>
  <span class="hljs-keyword">const</span> bubbleShouldSetFrom = !responderInst
    ? targetInst
    : <span class="hljs-title function_">getLowestCommonAncestor</span>(responderInst, targetInst);

  <span class="hljs-comment">// 判断事件捕获/冒泡时是否应该跳过目标组件</span>
  <span class="hljs-comment">// 下面我们会说到，RN 寻找 handler 时，会经过三个步骤：</span>
  <span class="hljs-comment">// 1. 捕获阶段：找到 bubbleShouldSetFrom 最高的祖先组件，然后开始往下遍历</span>
  <span class="hljs-comment">// 2. 目标阶段：遍历到 bubbleShouldSetFrom 组件</span>
  <span class="hljs-comment">// 3. 冒泡阶段：从 bubbleShouldSetFrom 往回遍历到开始的祖先组件</span>
  <span class="hljs-comment">// 这三个阶段是顺序执行，一旦遇到任意一个组件声明了想要成为 handler，整个流程就会停止</span>
  <span class="hljs-comment">// 如果当前 bubbleShouldSetFrom 就是 handler(responderInst) 到第二阶段的时候就必定会停止</span>
  <span class="hljs-comment">// 所以这个时候需要跳过目标阶段，直接从捕获阶段跳到冒泡阶段</span>
  <span class="hljs-keyword">const</span> skipOverBubbleShouldSetFrom = bubbleShouldSetFrom === responderInst;
  <span class="hljs-keyword">const</span> shouldSetEvent = <span class="hljs-title class_">ResponderSyntheticEvent</span>.<span class="hljs-title function_">getPooled</span>(
    shouldSetEventType,
    bubbleShouldSetFrom,
    nativeEvent,
    nativeEventTarget,
  );
  shouldSetEvent.<span class="hljs-property">touchHistory</span> = <span class="hljs-title class_">ResponderTouchHistoryStore</span>.<span class="hljs-property">touchHistory</span>;
  <span class="hljs-keyword">if</span> (skipOverBubbleShouldSetFrom) {
    <span class="hljs-comment">// 对应到我们上面说的跳过目标阶段的遍历</span>
    <span class="hljs-title function_">accumulateTwoPhaseDispatchesSkipTarget</span>(shouldSetEvent);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 对应到我们上面说的三个阶段的遍历</span>
    <span class="hljs-title function_">accumulateTwoPhaseDispatches</span>(shouldSetEvent);
  }
  <span class="hljs-comment">// 执行遍历并找到想要成为 handler 的组件</span>
  <span class="hljs-comment">// 这个遍历过程发送的事件就是 On-Demond events</span>
  <span class="hljs-keyword">const</span> wantsResponderInst = <span class="hljs-title function_">executeDispatchesInOrderStopAtTrue</span>(shouldSetEvent);
  <span class="hljs-keyword">if</span> (!shouldSetEvent.<span class="hljs-title function_">isPersistent</span>()) {
    shouldSetEvent.<span class="hljs-property">constructor</span>.<span class="hljs-title function_">release</span>(shouldSetEvent);
  }

  <span class="hljs-keyword">if</span> (!wantsResponderInst || wantsResponderInst === responderInst) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }
  <span class="hljs-comment">// 接下来我们要处理更新 handler 的逻辑了</span>
  <span class="hljs-keyword">let</span> extracted;
  <span class="hljs-keyword">const</span> grantEvent = <span class="hljs-title class_">ResponderSyntheticEvent</span>.<span class="hljs-title function_">getPooled</span>(
    eventTypes.<span class="hljs-property">responderGrant</span>,
    wantsResponderInst,
    nativeEvent,
    nativeEventTarget,
  );
  grantEvent.<span class="hljs-property">touchHistory</span> = <span class="hljs-title class_">ResponderTouchHistoryStore</span>.<span class="hljs-property">touchHistory</span>;

  <span class="hljs-title function_">accumulateDirectDispatches</span>(grantEvent);
  <span class="hljs-comment">// 发送事件给新的 handler 告知其成为了新的 handler</span>
  <span class="hljs-comment">// 当一个 handler 被选中的时候，它有机会可以阻止其他原生组件成为新的 responder（仅对 Android 有用）</span>
  <span class="hljs-comment">// 声明方法为在 onResponderGrant 回调中返回 true</span>
  <span class="hljs-keyword">const</span> blockHostResponder = <span class="hljs-title function_">executeDirectDispatch</span>(grantEvent) === <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">if</span> (responderInst) {
    <span class="hljs-comment">// 如果当前有 handler，要更新 handler 之前我们需要征求原来 handler 的 “意见”</span>
    <span class="hljs-keyword">const</span> terminationRequestEvent = <span class="hljs-title class_">ResponderSyntheticEvent</span>.<span class="hljs-title function_">getPooled</span>(
      eventTypes.<span class="hljs-property">responderTerminationRequest</span>,
      responderInst,
      nativeEvent,
      nativeEventTarget,
    );
    terminationRequestEvent.<span class="hljs-property">touchHistory</span> =
      <span class="hljs-title class_">ResponderTouchHistoryStore</span>.<span class="hljs-property">touchHistory</span>;
    <span class="hljs-title function_">accumulateDirectDispatches</span>(terminationRequestEvent);
    <span class="hljs-comment">// 如果原来的 handler 同意了，为 true</span>
    <span class="hljs-comment">// 否则为 false</span>
    <span class="hljs-keyword">const</span> shouldSwitch =
      !<span class="hljs-title function_">hasDispatches</span>(terminationRequestEvent) ||
      <span class="hljs-title function_">executeDirectDispatch</span>(terminationRequestEvent);
    <span class="hljs-keyword">if</span> (!terminationRequestEvent.<span class="hljs-title function_">isPersistent</span>()) {
      terminationRequestEvent.<span class="hljs-property">constructor</span>.<span class="hljs-title function_">release</span>(terminationRequestEvent);
    }

    <span class="hljs-keyword">if</span> (shouldSwitch) {
      <span class="hljs-comment">// 如果确定要更换 handler，要给原来 handler 发送 responderTerminate 消息</span>
      <span class="hljs-keyword">const</span> terminateEvent = <span class="hljs-title class_">ResponderSyntheticEvent</span>.<span class="hljs-title function_">getPooled</span>(
        eventTypes.<span class="hljs-property">responderTerminate</span>,
        responderInst,
        nativeEvent,
        nativeEventTarget,
      );
      terminateEvent.<span class="hljs-property">touchHistory</span> = <span class="hljs-title class_">ResponderTouchHistoryStore</span>.<span class="hljs-property">touchHistory</span>;
      <span class="hljs-title function_">accumulateDirectDispatches</span>(terminateEvent);
      extracted = <span class="hljs-title function_">accumulate</span>(extracted, [grantEvent, terminateEvent]);
      <span class="hljs-comment">// 更新 handler</span>
      <span class="hljs-title function_">changeResponder</span>(wantsResponderInst, blockHostResponder);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 否则需要发送 responderReject 消息</span>
      <span class="hljs-keyword">const</span> rejectEvent = <span class="hljs-title class_">ResponderSyntheticEvent</span>.<span class="hljs-title function_">getPooled</span>(
        eventTypes.<span class="hljs-property">responderReject</span>,
        wantsResponderInst,
        nativeEvent,
        nativeEventTarget,
      );
      rejectEvent.<span class="hljs-property">touchHistory</span> = <span class="hljs-title class_">ResponderTouchHistoryStore</span>.<span class="hljs-property">touchHistory</span>;
      <span class="hljs-title function_">accumulateDirectDispatches</span>(rejectEvent);
      extracted = <span class="hljs-title function_">accumulate</span>(extracted, rejectEvent);
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 如果当前没有有 handler，直接更新</span>
    extracted = <span class="hljs-title function_">accumulate</span>(extracted, grantEvent);
    <span class="hljs-title function_">changeResponder</span>(wantsResponderInst, blockHostResponder);
  }
  <span class="hljs-comment">// 返回 Deffered-Dispatch events</span>
  <span class="hljs-keyword">return</span> extracted;
}
</code></pre>
<p>至此，我们介绍完了 ResponderEventPlugin 的实现</p>
<p>最后我会放上所有 eventTypes 的介绍，以及不同 eventTypes 流转过程：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// eventTypes 记录了不同情况下，会触发的组件事件回调</span>
<span class="hljs-keyword">const</span> eventTypes = {
  <span class="hljs-comment">/**
   * 这个部份的事件都会有捕获/冒泡的阶段
   */</span>
  <span class="hljs-comment">// 在 touchStart 阶段，判断该组件都否该在捕获/冒泡阶段拦截消息并且指定自身为 handler</span>
  <span class="hljs-attr">startShouldSetResponder</span>: {
    <span class="hljs-attr">phasedRegistrationNames</span>: {
      <span class="hljs-attr">bubbled</span>: <span class="hljs-string">'onStartShouldSetResponder'</span>,
      <span class="hljs-attr">captured</span>: <span class="hljs-string">'onStartShouldSetResponderCapture'</span>,
    },
    <span class="hljs-attr">dependencies</span>: startDependencies,
  },
  <span class="hljs-comment">// 在 scroll 事件中，判断该组件都否该在捕获/冒泡阶段拦截消息并且指定自身为 handler</span>
  <span class="hljs-attr">scrollShouldSetResponder</span>: {
    <span class="hljs-attr">phasedRegistrationNames</span>: {
      <span class="hljs-attr">bubbled</span>: <span class="hljs-string">'onScrollShouldSetResponder'</span>,
      <span class="hljs-attr">captured</span>: <span class="hljs-string">'onScrollShouldSetResponderCapture'</span>,
    },
    <span class="hljs-attr">dependencies</span>: [<span class="hljs-variable constant_">TOP_SCROLL</span>],
  },
  <span class="hljs-comment">// 在文字选择事件中，判断该组件都否该在捕获/冒泡阶段拦截消息并且指定自身为 handler</span>
  <span class="hljs-attr">selectionChangeShouldSetResponder</span>: {
    <span class="hljs-attr">phasedRegistrationNames</span>: {
      <span class="hljs-attr">bubbled</span>: <span class="hljs-string">'onSelectionChangeShouldSetResponder'</span>,
      <span class="hljs-attr">captured</span>: <span class="hljs-string">'onSelectionChangeShouldSetResponderCapture'</span>,
    },
    <span class="hljs-attr">dependencies</span>: [<span class="hljs-variable constant_">TOP_SELECTION_CHANGE</span>],
  },
  <span class="hljs-comment">// 在 touchMove 阶段，判断该组件都否该在捕获/冒泡阶段拦截消息并且指定自身为 handler</span>
  <span class="hljs-attr">moveShouldSetResponder</span>: {
    <span class="hljs-attr">phasedRegistrationNames</span>: {
      <span class="hljs-attr">bubbled</span>: <span class="hljs-string">'onMoveShouldSetResponder'</span>,
      <span class="hljs-attr">captured</span>: <span class="hljs-string">'onMoveShouldSetResponderCapture'</span>,
    },
    <span class="hljs-attr">dependencies</span>: moveDependencies,
  },

  <span class="hljs-comment">/**
   * 这个部份的事件会直接传送到 handler 组件上，不会冒泡
   */</span>
  <span class="hljs-comment">// touchStart 事件的回调</span>
  <span class="hljs-attr">responderStart</span>: {
    <span class="hljs-attr">registrationName</span>: <span class="hljs-string">'onResponderStart'</span>,
    <span class="hljs-attr">dependencies</span>: startDependencies,
  },
  <span class="hljs-comment">// touchMove 事件的回调</span>
  <span class="hljs-attr">responderMove</span>: {
    <span class="hljs-attr">registrationName</span>: <span class="hljs-string">'onResponderMove'</span>,
    <span class="hljs-attr">dependencies</span>: moveDependencies,
  },
  <span class="hljs-comment">// touchEnd 事件的回调</span>
  <span class="hljs-attr">responderEnd</span>: {
    <span class="hljs-attr">registrationName</span>: <span class="hljs-string">'onResponderEnd'</span>,
    <span class="hljs-attr">dependencies</span>: endDependencies,
  },
  <span class="hljs-comment">// 当前 handler 没有任何事件时触发的回调</span>
  <span class="hljs-attr">responderRelease</span>: {
    <span class="hljs-attr">registrationName</span>: <span class="hljs-string">'onResponderRelease'</span>,
    <span class="hljs-attr">dependencies</span>: endDependencies,
  },
  <span class="hljs-comment">// touchCancel 事件的回调</span>
  <span class="hljs-attr">responderTerminationRequest</span>: {
    <span class="hljs-attr">registrationName</span>: <span class="hljs-string">'onResponderTerminationRequest'</span>,
    <span class="hljs-attr">dependencies</span>: [],
  },
  <span class="hljs-comment">// 当前组件获得 handler 的回调</span>
  <span class="hljs-attr">responderGrant</span>: {
    <span class="hljs-attr">registrationName</span>: <span class="hljs-string">'onResponderGrant'</span>,
    <span class="hljs-attr">dependencies</span>: [],
  },
  <span class="hljs-comment">// 原来的 handler 组件拒绝释放 handler 权限的回调</span>
  <span class="hljs-attr">responderReject</span>: {
    <span class="hljs-attr">registrationName</span>: <span class="hljs-string">'onResponderReject'</span>,
    <span class="hljs-attr">dependencies</span>: [],
  },
  <span class="hljs-comment">// 原来的 handler 释放 handler 权限的回调</span>
  <span class="hljs-attr">responderTerminate</span>: {
    <span class="hljs-attr">registrationName</span>: <span class="hljs-string">'onResponderTerminate'</span>,
    <span class="hljs-attr">dependencies</span>: [],
  },
};
</code></pre>
<p>流转过程：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// in ResponderEventPlugin.js</span>

<span class="hljs-comment">/*                                             Negotiation Performed
                                             +-----------------------+
                                            /                         \
Process low level events to    +     Current Responder      +   wantsResponderID
determine who to perform negot-|   (if any exists at all)   |
iation/transition              | Otherwise just pass through|
-------------------------------+----------------------------+------------------+
Bubble to find first ID        |                            |
to return true:wantsResponderID|                            |
                               |                            |
     +-------------+           |                            |
     | onTouchStart|           |                            |
     +------+------+     none  |                            |
            |            return|                            |
+-----------v-------------+true| +------------------------+ |
|onStartShouldSetResponder|-----&gt;|onResponderStart (cur)  |&lt;-----------+
+-----------+-------------+    | +------------------------+ |          |
            |                  |                            | +--------+-------+
            | returned true for|       false:REJECT +--------&gt;|onResponderReject
            | wantsResponderID |                    |       | +----------------+
            | (now attempt     | +------------------+-----+ |
            |  handoff)        | |   onResponder          | |
            +-------------------&gt;|      TerminationRequest| |
                               | +------------------+-----+ |
                               |                    |       | +----------------+
                               |         true:GRANT +--------&gt;|onResponderGrant|
                               |                            | +--------+-------+
                               | +------------------------+ |          |
                               | |   onResponderTerminate |&lt;-----------+
                               | +------------------+-----+ |
                               |                    |       | +----------------+
                               |                    +--------&gt;|onResponderStart|
                               |                            | +----------------+
Bubble to find first ID        |                            |
to return true:wantsResponderID|                            |
                               |                            |
     +-------------+           |                            |
     | onTouchMove |           |                            |
     +------+------+     none  |                            |
            |            return|                            |
+-----------v-------------+true| +------------------------+ |
|onMoveShouldSetResponder |-----&gt;|onResponderMove (cur)   |&lt;-----------+
+-----------+-------------+    | +------------------------+ |          |
            |                  |                            | +--------+-------+
            | returned true for|       false:REJECT +--------&gt;|onResponderRejec|
            | wantsResponderID |                    |       | +----------------+
            | (now attempt     | +------------------+-----+ |
            |  handoff)        | |   onResponder          | |
            +-------------------&gt;|      TerminationRequest| |
                               | +------------------+-----+ |
                               |                    |       | +----------------+
                               |         true:GRANT +--------&gt;|onResponderGrant|
                               |                            | +--------+-------+
                               | +------------------------+ |          |
                               | |   onResponderTerminate |&lt;-----------+
                               | +------------------+-----+ |
                               |                    |       | +----------------+
                               |                    +--------&gt;|onResponderMove |
                               |                            | +----------------+
                               |                            |
                               |                            |
      Some active touch started|                            |
      inside current responder | +------------------------+ |
      +-------------------------&gt;|      onResponderEnd    | |
      |                        | +------------------------+ |
  +---+---------+              |                            |
  | onTouchEnd  |              |                            |
  +---+---------+              |                            |
      |                        | +------------------------+ |
      +-------------------------&gt;|     onResponderEnd     | |
      No active touches started| +-----------+------------+ |
      inside current responder |             |              |
                               |             v              |
                               | +------------------------+ |
                               | |    onResponderRelease  | |
                               | +------------------------+ |
                               |                            |
                               +                            + */</span>
</code></pre>
<p>至此，React 的事件处理机制 EventPluginHub 以及 RN 的事件插件 ResponderEventPlugin 都讲完了</p>
<p>下一个章节是本文的最后一个章节，会介绍 RN 是如何基于这个机制实现 Button 组件</p>
<h5 data-id="heading-19">Button 组件</h5>
<p>本章节来一起聊聊 RN 触摸事件处理的最后一块拼图：<strong>触发开发者注册的事件回调</strong></p>
<p>有细心的读者可能会发现，我们上一章节说的 eventTypes 中是没有大家在开发中常用到的 onPress 的</p>
<p>那么 onPress 是怎么被触发的呢？究其原因我们需要来看看 RN 是如何实现 Button 组件的（了解了这个以后，你也能自己定制一个 Button）</p>
<p>RN 的 Button 组件有这么个结构：</p>
<pre><code class="hljs language-js" lang="js">
                 +----------------------------------+
                 |           <span class="hljs-title class_">Touchable</span>.<span class="hljs-property">js</span>           |
                 +-----------------+----------------+
                           |                 |
                     <span class="hljs-title class_">Mixin</span> |                 |<span class="hljs-title class_">Mixin</span>
                           v                 v
+----------------------------------+      +--------------------------------+
| <span class="hljs-title class_">TouchableNativeFeedback</span>.<span class="hljs-property">android</span>.<span class="hljs-property">js</span> |    |        <span class="hljs-title class_">TouchableOpacity</span>.<span class="hljs-property">js</span>     |
+-----------------+------------------+    +----------------+---------------+
                     |                         |
          <span class="hljs-title class_">Implement</span>  |              <span class="hljs-title class_">Implement</span>  |
                     v                         v
                +----------------------------------+
                |            <span class="hljs-title class_">Button</span>.<span class="hljs-property">js</span>             |
                +----------------------------------+
</code></pre>
<p>我们从下到上一一解释：</p>
<ul>
<li><code>Button.js</code>：这个就是 RN 对外暴露的 Button 组件，内部有 disabled、onPress 等属性</li>
<li><code>TouchableNativeFeedback.android.js</code>：Android 中 Button 的默认内部实现，主要目的是为了实现 Android 的水波纹效果，其次是作为事件的 handler 注册 onResponderGrant，onResponderMove 等属性回调</li>
<li><code>TouchableOpacity.js</code>：IOS 中 Button 的默认内部实现，主要目的是实现点击后透明度变化的效果，其次是作为事件的 handler 注册 onResponderGrant，onResponderMove 等属性回调</li>
<li><code>Touchable.js</code>：<strong>最核心</strong>的事件消费引擎，内部实现了一个状态机，会根据不同的状态决定是否触发 onPress 等回调；它通过 Mixin 的方式将自己混入 <code>TouchableNativeFeedback.android.js</code> 与 <code>TouchableOpacity.js</code> 之中</li>
</ul>
<br/>
<p>要想了解 <code>Touchable.js</code> 内部做了什么，我们要先了解一下想要处理好 “点击” 这个交互，需要先做那些事</p>
<p>以下选自 RN 代码 <code>Touchable.js</code> 中的注释：</p>
<blockquote>
<p>====================== Touchable Tutorial ===============================</p>
<p>The <code>Touchable</code> mixin helps you handle the "press" interaction. It analyzes the geometry of elements, and observes when another responder (scroll view etc) has stolen the touch lock. It notifies your component when it should give feedback to the user. (bouncing/highlighting/unhighlighting).</p>
<ul>
<li>When a touch was activated (typically you highlight)</li>
<li>When a touch was deactivated (typically you unhighlight)</li>
<li>When a touch was "pressed" - a touch ended while still within the geometry of the element, and no other element (like scroller) has "stolen" touch lock ("responder") (Typically you bounce the element).</li>
</ul>
<p>A good tap interaction isn't as simple as you might think. There should be a slight delay before showing a highlight when starting a touch. If a subsequent touch move exceeds the boundary of the element, it should unhighlight, but if that same touch is brought back within the boundary, it should rehighlight again. A touch can move in and out of that boundary several times, each time toggling highlighting, but a "press" is only triggered if that touch ends while within the element's boundary and no scroller (or anything else) has stolen the lock on touches.</p>
</blockquote>
<p>简单来说，Touchable 需要处理：</p>
<ol>
<li>受点击元素的几何位置信息</li>
<li>判断当前点击事件是否被其他 handler 抢占</li>
<li>在需要的时候给用户反馈（比如点击时高亮、离开时取消高亮等）</li>
</ol>
<br/>
<p>此外，点击交互还有一些关于几何位置的细节需要处理（以下选自 RN 代码 <code>Touchable.js</code> 中的注释）：</p>
<pre><code class="hljs language-js" lang="js">========== <span class="hljs-title class_">Geometry</span> =========
<span class="hljs-string">`Touchable`</span> only assumes that there exists a <span class="hljs-string">`HitRect`</span> node. <span class="hljs-title class_">The</span> <span class="hljs-string">`PressRect`</span>
is an abstract box that is extended beyond the <span class="hljs-string">`HitRect`</span>.
 +--------------------------+
 |                          | - <span class="hljs-string">"Start"</span> events <span class="hljs-keyword">in</span> <span class="hljs-string">`HitRect`</span> cause <span class="hljs-string">`HitRect`</span>
 |  +--------------------+  |   to become the responder.
 |  |  +--------------+  |  | - <span class="hljs-string">`HitRect`</span> is typically expanded around
 |  |  |              |  |  |   the <span class="hljs-string">`VisualRect`</span>, but shifted downward.
 |  |  |  <span class="hljs-title class_">VisualRect</span>  |  |  | - <span class="hljs-title class_">After</span> pressing down, after some delay,
 |  |  |              |  |  |   and before letting up, the <span class="hljs-title class_">Visual</span> <span class="hljs-title class_">React</span>
 |  |  +--------------+  |  |   will become <span class="hljs-string">"active"</span>. <span class="hljs-title class_">This</span> makes it eligible
 |  |     <span class="hljs-title class_">HitRect</span>        |  |   <span class="hljs-keyword">for</span> being highlighted (so long <span class="hljs-keyword">as</span> the
 |  +--------------------+  |   press remains <span class="hljs-keyword">in</span> the <span class="hljs-string">`PressRect`</span>).
 |        <span class="hljs-title class_">PressRect</span>     o   |
 +----------------------|---+
          <span class="hljs-title class_">Out</span> <span class="hljs-title class_">Region</span>    |
                        +-----+ <span class="hljs-title class_">This</span> gap between the <span class="hljs-string">`HitRect`</span> and
                                <span class="hljs-string">`PressRect`</span> allows a touch to move far away
                                <span class="hljs-keyword">from</span> the original hit rect, and remain
                                highlighted, and eligible <span class="hljs-keyword">for</span> a <span class="hljs-string">"Press"</span>.
                                <span class="hljs-title class_">Customize</span> <span class="hljs-variable language_">this</span> via
                                <span class="hljs-string">`touchableGetPressRectOffset()`</span>.
</code></pre>
<p>简单总结一下：</p>
<ul>
<li>
<p>图中的 VisualRect 是我们看到的 Button 组件的视图范围，但是实际上用户可点击的范围其实是 HitRect 以内的部份</p>
</li>
<li>
<p>如果用户在 HitRect 范围内按下了手指，在 PressRect 的范围内松开，我们就认为这是一个有效的点击；否则不构成点击行为</p>
</li>
<li>
<p>如果用户在 HitRect 范围内按下了手指，在一些 delay 过后，按钮会进入 “激活状态”，在此状态下的按钮会给用户一些反馈（比如高亮）</p>
</li>
<li>
<p>上面我们说到当用户按下按钮的时候我们需要给用户一些反馈，这个反馈的范围就是在 PressRect 之内，以下列举几个情况：</p>
<ol>
<li>如果用户在 HitRect 之内按下手指，移动到 PressRect 的区域，此时按钮的反馈会持续存在；</li>
<li>如果用户移动到了 Out Region，则反馈会消失；</li>
<li>如果用户调皮在没有松开手的情况下移回来 PressRect，这个反馈会重新出现；</li>
<li>如果用户在一直没有松手的情况反复执行 2，3 种情况，反馈会一直出现/消失</li>
</ol>
</li>
</ul>
<br/>
<p>为了实现上述效果，Touchable 需要一个状态机来处理不同状态的流转（以下选自 RN 代码 <code>Touchable.js</code> 中的注释）：</p>
<pre><code class="hljs language-js" lang="js">======= <span class="hljs-title class_">State</span> <span class="hljs-title class_">Machine</span> =======
+-------------+ &lt;---+ RESPONDER_RELEASE
|NOT_RESPONDER|
+-------------+ &lt;---+ RESPONDER_TERMINATED
    +
    | RESPONDER_GRANT (HitRect)
    v                                                             
+---------------------------+  DELAY +-------------------------+ T+DELAY +------------------------------+
|RESPONDER_INACTIVE_PRESS_IN|+------&gt;|RESPONDER_ACTIVE_PRESS_IN| +------&gt;|RESPONDER_ACTIVE_LONG_PRESS_IN|
+---------------------------+        +-------------------------+         +------------------------------+
    +            ^                         +           ^                        +             ^
    |LEAVE_      |ENTER_                   |LEAVE_     |ENTER_                  |LEAVE_       |ENTER_
    |PRESS_RECT  |PRESS_RECT               |PRESS_RECT |PRESS_RECT              |PRESS_RECT   |PRESS_RECT
    |            |                         |           |                        |             |
    v            +                         v           +                        v             +
+----------------------------+  DELAY  +--------------------------+     +-------------------------------+
|RESPONDER_INACTIVE_PRESS_OUT|+-------&gt;|RESPONDER_ACTIVE_PRESS_OUT|     |RESPONDER_ACTIVE_LONG_PRESS_OUT|
+----------------------------+         +--------------------------+     +-------------------------------+

T + DELAY =&gt; LONG_PRESS_DELAY_MS + DELAY
</code></pre>
<p>简单总结下：</p>
<ol>
<li>
<p>用户未点击时，初始状态为 <code>NOT_RESPONDER</code></p>
</li>
<li>
<p>当用户点击按钮且按钮获得 handler 之后，状态会马上变成 <code>RESPONDER_INACTIVE_PRESS_IN</code></p>
</li>
<li>
<p>状态变成 <code>RESPONDER_INACTIVE_PRESS_IN</code> 后持续保持 <code>DELAY</code> 毫秒后，状态变成 <code>RESPONDER_ACTIVE_PRESS_IN</code></p>
</li>
<li>
<p>状态变成 <code>RESPONDER_ACTIVE_PRESS_IN</code> 后等待 <code>T</code> 毫秒后，状态会变成 <code>RESPONDER_ACTIVE_LONG_PRESS_IN</code></p>
</li>
<li>
<p>在状态 2～4 下如果用户手指移到 PressRect 之外，则状态会变成对应的 OUT 状态</p>
</li>
</ol>
<br/>
<p>有了状态机，Touchable 就可以在接收到 <code>ResponderEventPlugin</code> 的 eventTypes 后根据状态流转并且触发相对应的属性回调了</p>
<p>受限篇幅这里就不再展开 Touchable 的代码一行行看了，有兴趣的读者可以自行查看</p>
<h3 data-id="heading-20">总结</h3>
<p>最后总结下，本文从 Android 与 IOS 的事件处理机制开始，聊到 RN 是如何结合 React 抽象出一套统一事件系统，最后还介绍了 JS 是如何利用这套系统搭建出 Button 组件</p>
<p>有了这些背景知识可能并不一定能让我们写出更好的 RN 代码，但是我们一定可以在出现问题后能够更快的抓住问题本质，也能够以更加全面的视角来看待不同的问题</p>
<p>到这，RN 的触摸事件处理篇结束了，但这并不代表这就是 RN 事件处理的全貌。事实上，看完本文之后可能我们的问题更多了</p>
<p>剩下的部分就靠各位读者一起交流学习吧，这也是学习有意思的地方！</p>
<h3 data-id="heading-21">参考资料</h3>
<ul>
<li><a href="https://juejin.cn/post/7005112607707398157" target="_blank" title="https://juejin.cn/post/7005112607707398157">iOS 的响应链小结</a></li>
<li><a href="https://juejin.cn/post/6844903905080410125" target="_blank" title="https://juejin.cn/post/6844903905080410125">深入理解 iOS 事件机制</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FBladeTail%2FEvent-Handling-Guide-for-iOS%2Fblob%2Fmaster%2FEvent%2520Handling%2520Guide%2520for%2520iOS.pdf" target="_blank" title="https://github.com/BladeTail/Event-Handling-Guide-for-iOS/blob/master/Event%20Handling%20Guide%20for%20iOS.pdf" ref="nofollow noopener noreferrer">Event Handling Guide for iOS</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[面试官：BatchNorm、LayerNorm、GroupNorm、InstanceNorm 有什么本质区别？]]></title>    <link>https://juejin.cn/post/7578820377000493107</link>    <guid>https://juejin.cn/post/7578820377000493107</guid>    <pubDate>2025-12-02T07:33:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578820377000493107" data-draft-id="7578948893761732635" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="面试官：BatchNorm、LayerNorm、GroupNorm、InstanceNorm 有什么本质区别？"/> <meta itemprop="keywords" content="面试,算法"/> <meta itemprop="datePublished" content="2025-12-02T07:33:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="coting"/> <meta itemprop="url" content="https://juejin.cn/user/933911964427818"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            面试官：BatchNorm、LayerNorm、GroupNorm、InstanceNorm 有什么本质区别？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/933911964427818/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    coting
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T07:33:13.000Z" title="Tue Dec 02 2025 07:33:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>📚推荐阅读</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1962254381677257759" target="_blank" title="https://zhuanlan.zhihu.com/p/1962254381677257759" ref="nofollow noopener noreferrer">面试官：Transformer如何优化到线性级？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1962929340292502638" target="_blank" title="https://zhuanlan.zhihu.com/p/1962929340292502638" ref="nofollow noopener noreferrer">面试官：模型的量化了解吗？解释一下非对称量化与对称量化</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1962947114230346375" target="_blank" title="https://zhuanlan.zhihu.com/p/1962947114230346375" ref="nofollow noopener noreferrer">面试官：模型剪枝了解吗？解释一下结构化剪枝与非结构化剪枝</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1963373485435917372" target="_blank" title="https://zhuanlan.zhihu.com/p/1963373485435917372" ref="nofollow noopener noreferrer">面试官：为什么 Adam 在部分任务上会比 SGD 收敛更快，但泛化性更差？如何改进？</a></p>
<p>面试官：<strong>你能讲讲 BatchNorm、LayerNorm、GroupNorm、 InstanceNorm 有什么本质区别吗？</strong></p>
<p>很多同学肯定对这三个方法都很熟悉，但是一时间竟然不知道该怎么组织语言回答他们之间的区别，也不知道该从哪些方面进行对比，今天我们就来一次彻底拆解，不背定义、不绕术语，争取讲清楚三者的<strong>核心思想和差异本质</strong>。</p>
<p>所有相关源码示例、流程图、模型配置与知识库构建技巧，我也将持续更新在Github：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Faicoting%2FAIHub" target="_blank" title="https://github.com/aicoting/AIHub" ref="nofollow noopener noreferrer"><strong>AIHub</strong></a>，欢迎关注收藏！</p>
<h2 data-id="heading-0">一、为什么需要“Norm”？</h2>
<p>我们都知道深度网络训练的时候，经常会出现两种极端情况：</p>
<ul>
<li>前向时：激活值爆炸或消失；</li>
<li>反向时：梯度爆炸或消失。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06191ebaf6c84ec99dd791d0e57080f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765265593&amp;x-signature=doael0OEkYVUQYe0GOtIN6ssug8%3D" alt="" loading="lazy"/></p>
<p>这两种情况都会让训练不稳定，模型收敛困难。而 “Normalization” 的核心目标就是<strong>让每一层的分布保持稳定，保证梯度流动顺畅。</strong></p>
<h2 data-id="heading-1">二、BatchNorm 的本质：跨样本的统计归一化</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d58de5c7ef464e72b342a35163b38883~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765265593&amp;x-signature=2lNG3yY9eiDJF5p%2FEFshOUxfuX0%3D" alt="" loading="lazy"/></p>
<p>Batch Normalization（BN）是最早被广泛使用的归一化方式，它的思想非常直白：在每一层里，把一个 batch 中的所有样本的均值和方差对齐。</p>
<p>公式如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/174ef4c69aea4140885f0073c912533b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765265593&amp;x-signature=vXK2V7qaKmtQQZHUqCLv7eXhCOI%3D" alt="image" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/306666f8889542b7bfdcf24f6afa0ef8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765265593&amp;x-signature=t2Ev7GoBMJFA%2FPKL%2B4yjfo5cT6A%3D" alt="image" loading="lazy"/></p>
<p>BN 通过在 batch 维度上计算均值与方差，让输入保持“零均值、单位方差”，从而稳定了分布。</p>
<p>BatchNorm 可以缓解梯度消失和梯度爆炸，加快收敛速度，并且可以起到轻微的<strong>正则化作用</strong>（因为 batch 统计会引入噪声）；但是BatchNorm对 batch size 敏感，<strong>小 batch 会导致统计方差不准</strong>，在 RNN / 在线推理中不方便（<strong>统计量难以同步</strong>），并且推理阶段需要固定全局均值与方差，增加了复杂度。</p>
<p>在梯度流动性方面， 由于使用批内统计量，BN 在反向传播时<strong>会引入样本间的梯度耦合</strong>，这会在一定程度上“平滑”梯度更新，有助于稳定训练。</p>
<h2 data-id="heading-2">三、LayerNorm 的本质：跨特征的归一化</h2>
<p>Layer Normalization（LN）不看 batch，而是<strong>在单个样本的特征维度上归一化</strong>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bfddd0660bef47eb8dd1a3e34c398c08~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765265593&amp;x-signature=dEoHoHqgHbnkh%2F%2Fn9Tc59x0DPxI%3D" alt="image" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/959babca0b6b4376b4e0921fb7b49908~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765265593&amp;x-signature=0FojwrCrCFNbD1jbi40oqPjgTpw%3D" alt="" loading="lazy"/></p>
<p>它只看当前样本本身的特征分布，不依赖 batch 内的其他样本。</p>
<p>LayerNorm对 batch size 不敏感，可用于 Transformer、RNN 等任务，在小批量或在线推理中表现稳定。但是因为<strong>通道特征统计不同</strong>，在 CNN 上效果不如 BN， 对空间信息不敏感。</p>
<p>在梯度流动性方面， LN 不依赖 batch，<strong>梯度更新完全独立于其他样本</strong>，这使得训练更加稳定，但也减少了梯度的“扰动探索”，但是泛化性略弱。</p>
<h2 data-id="heading-3">四、GroupNorm 的本质：在通道维上分组归一化</h2>
<p>Group Normalization（GN）就是 BN 和 LN 的折中方案。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73688f77599d46a7a263a73e9ba1db7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765265593&amp;x-signature=s%2F7IZwYgJ%2FlwhHt6jmKcHniauT0%3D" alt="" loading="lazy"/></p>
<p>它将通道分成多个组（group），在每组内部做归一化：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0815242563ff45848a86caa9b2118101~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765265593&amp;x-signature=zHd3vI55iT2drJJykn7ptThYTbE%3D" alt="image" loading="lazy"/></p>
<p>组数 <code>G</code> 是一个可调超参：</p>
<ul>
<li><code>G = 1</code> → LayerNorm；</li>
<li><code>G = C</code>（每通道一组）→ InstanceNorm。</li>
</ul>
<p>Groupnorm不依赖 batch size， 在小 batch、检测、分割等任务中效果好，保留了部分空间结构。</p>
<p>梯度流动性方面， GN 保留了一定的“局部耦合”，因此既不像 BN 那样噪声大，也不像 LN 那样独立，<br/>
是两者的平衡方案。</p>
<h2 data-id="heading-4">五、InstanceNorm：每通道独立归一化</h2>
<p>Instance Normalization 是 GroupNorm 的极端形式，每个样本的每个通道独立归一化（不依赖其他样本）：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6b6224ce0e24b3f9808461865eb17ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765265593&amp;x-signature=Yxx0sUDnZCjAuPhdO8D8D83%2FhNk%3D" alt="image" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fe910c30bd446e5a268d18a8bedd9d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765265593&amp;x-signature=olNa9UhuT2%2FbYm%2BvNA5w6mKC1pY%3D" alt="" loading="lazy"/></p>
<p>InstanceNorm对图像风格迁移、生成任务（如 GAN）特别有用，能有效去除样本间风格差异，保留结构特征，完全独立于 batch；但是会破坏样本间统计特征（不利于分类任务），泛化能力弱于 BN/GN。</p>
<p>在梯度流动性方面，InstanceNorm 几乎完全隔离样本间梯度信息，梯度传播最稳定、最独立，但也最容易陷入局部最优。</p>
<p>以上的内容如果你看懂了，相信你也对开始的问题有了清晰的答案了！</p>
<p>关于深度学习和大模型相关的知识和前沿技术更新，请关注公众号 <strong>coting</strong>！</p>
<h2 data-id="heading-5"/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI ETL需要不同的原语：从构建CocoIndex中学到的Rust经验🦀]]></title>    <link>https://juejin.cn/post/7579063781071749174</link>    <guid>https://juejin.cn/post/7579063781071749174</guid>    <pubDate>2025-12-02T08:44:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579063781071749174" data-draft-id="7578832575504564266" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI ETL需要不同的原语：从构建CocoIndex中学到的Rust经验🦀"/> <meta itemprop="keywords" content="Rust,AIGC"/> <meta itemprop="datePublished" content="2025-12-02T08:44:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="badmonster0"/> <meta itemprop="url" content="https://juejin.cn/user/3094498368291331"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI ETL需要不同的原语：从构建CocoIndex中学到的Rust经验🦀
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3094498368291331/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    badmonster0
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T08:44:58.000Z" title="Tue Dec 02 2025 08:44:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>传统ETL是为批量报告而设计的，并不适合需要实时嵌入向量生成、动态模式演进和不透明模型行为的AI系统。本文深入探讨AI ETL为何需要根本不同的原语，以及在实践中的具体实现方式。</p>
<h2 data-id="heading-1">问题：传统ETL无法适应AI工作负载</h2>
<p>传统ETL系统的假设前提：</p>
<ul>
<li>稳定的模式和每日/每小时批处理</li>
<li>仅限SQL的转换操作</li>
<li>单一目标系统</li>
<li>"尽力而为"的执行模式</li>
</ul>
<p>然而，AI工作负载的现实完全不同：</p>
<p><strong>陈旧的嵌入向量=幻觉</strong>：如果知识库每30分钟更新一次，但RAG系统仍使用3天前的嵌入向量，LLM就会回答关于不再存在的数据的问题。</p>
<p><strong>模式持续演进</strong>：代码变更、文档更新、工单格式变化——传统ETL将这些视为边缘情况，但对AI来说，这是常态。</p>
<p><strong>转换不仅仅是SQL</strong>：需要调用嵌入API、文档分块、运行自定义Python、同时路由到多个向量数据库、知识图谱和关系存储。</p>
<p><strong>API调用成本高昂</strong>：如果每次批处理都重新嵌入整个语料库，不仅浪费计算资源，还会造成金钱损失并触及速率限制。</p>
<p>将AI数据管道视为"另一个批处理作业"会导致：</p>
<ul>
<li><strong>过度重新计算</strong>：重建未更改的内容，浪费10倍计算资源</li>
<li><strong>索引漂移</strong>：运行陈旧数据，AI性能悄然降级</li>
</ul>
<p>这就是<a href="https://link.juejin.cn?target=https%3A%2F%2Fcocoindex.io" target="_blank" title="https://cocoindex.io" ref="nofollow noopener noreferrer">CocoIndex</a>致力于解决的问题。</p>
<h2 data-id="heading-2">原语1：数据流而非可变表</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcocoindex.io" target="_blank" title="https://cocoindex.io" ref="nofollow noopener noreferrer">CocoIndex</a>采用<strong>数据流编程模型</strong>。不是命令式的"insert/update/delete"命令，而是定义转换的DAG，其中每个节点都是纯函数。</p>
<pre><code class="hljs language-css" lang="css">原始输入 → 解析 → 分块 → 嵌入 → 规范化 → <span class="hljs-selector-attr">[向量数据库 + Postgres + 图数据库]</span>
</code></pre>
<p>这很重要，因为：</p>
<ul>
<li><strong>声明式</strong>：更改一次公式，传播到所有地方</li>
<li><strong>安全缓存</strong>：纯函数意味着引擎准确知道何时可以重用结果</li>
<li><strong>可组合</strong>：复杂的AI管道只是嵌套的数据流图</li>
<li><strong>电子表格直觉</strong>：每个字段由公式定义（如Excel），易于推理</li>
</ul>
<p>了解更多关于<a href="https://link.juejin.cn?target=https%3A%2F%2Fcocoindex.io%2Fdocs" target="_blank" title="https://cocoindex.io/docs" ref="nofollow noopener noreferrer">CocoIndex的数据流架构</a>。</p>
<h2 data-id="heading-3">原语2：一流的增量处理</h2>
<p>Rust服务无法承受重新处理整个语料库的代价。<a href="https://link.juejin.cn?target=https%3A%2F%2Fcocoindex.io" target="_blank" title="https://cocoindex.io" ref="nofollow noopener noreferrer">CocoIndex</a>在两个级别跟踪变化：</p>
<p><strong>源级别</strong>：内容哈希和指纹检测文件/行何时实际更改。如果指纹相同，则完全跳过——无需重新处理，无需API调用。</p>
<p><strong>流级别</strong>：当转换逻辑更改时（新嵌入模型、更好的分块），引擎计算图的哪些部分受影响，仅重新处理<em>这些节点</em>。</p>
<p>结果：无需完全重建的成本即可实现近实时索引。</p>
<h2 data-id="heading-4">原语3：针对不可靠API的持久执行</h2>
<p>AI ETL调用不稳定的API，遇到速率限制，处理凭证过期。执行引擎本身必须具有持久性：</p>
<ul>
<li><strong>行级重试语义</strong>：捕获失败的行，在后续运行中重试</li>
<li><strong>版本感知提交</strong>：增量更新在所有目标上以一致的顺序应用</li>
<li><strong>稳定的错误处理</strong>：暂时性故障不会在存储之间产生不一致的数据</li>
</ul>
<p>这将可靠性从"bash脚本+祈祷"转变为系统，其中故障、重试和进度跟踪是内置关注点。</p>
<p>了解更多关于<a href="https://link.juejin.cn?target=https%3A%2F%2Fcocoindex.io%2Fblog" target="_blank" title="https://cocoindex.io/blog" ref="nofollow noopener noreferrer">CocoIndex的持久执行</a>。</p>
<h2 data-id="heading-5">原语4：血缘和可观测性</h2>
<p>当RAG系统返回错误答案时，您需要知道：</p>
<ul>
<li>哪些文档产生了该块？</li>
<li>使用了哪个嵌入模型？</li>
<li>分块策略正确吗？</li>
<li>索引的源数据是哪个版本？</li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcocoindex.io" target="_blank" title="https://cocoindex.io" ref="nofollow noopener noreferrer">CocoIndex</a>端到端内置了这些：</p>
<ul>
<li><strong>端到端血缘</strong>：将错误的搜索结果追溯到源记录和转换版本</li>
<li><strong>前后可见性</strong>：CocoInsight在每个管道步骤公开数据（无需自定义日志）</li>
<li><strong>电子表格UI</strong>：可视化检查流程和转换</li>
</ul>
<h2 data-id="heading-6">原语5：多目标、AI原生连接</h2>
<p>AI堆栈不会写入单一系统。单个管道需要：</p>
<ul>
<li>在Qdrant或LanceDB中存储嵌入</li>
<li>在Postgres或Snowflake中持久化元数据</li>
<li>发出知识图谱</li>
<li>同步到特征存储</li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcocoindex.io" target="_blank" title="https://cocoindex.io" ref="nofollow noopener noreferrer">CocoIndex</a>将这些视为一流的即插即用目标，而非特例。一个逻辑流程扇出到所有目标，自动保持同步。</p>
<h2 data-id="heading-7">为什么选择Rust？</h2>
<p>用Rust构建不是为了美观——它能够大规模实现这些原语：</p>
<p><strong>可预测的性能</strong>：处理大规模数据集时无垃圾收集暂停。增量处理和变更检测在紧密的内存高效代码中运行。</p>
<p><strong>安全的并发</strong>：跟踪多个并发流程和分区本质上容易出错；Rust的所有权模型防止执行核心中的数据竞争。</p>
<p><strong>互操作性</strong>：Rust编译为静态二进制文件，与Python、TypeScript和其他生态系统集成，因此核心原生运行，API保持可访问。</p>
<p>查看<a href="https://link.juejin.cn?target=https%3A%2F%2Fcocoindex.io%2Fdocs" target="_blank" title="https://cocoindex.io/docs" ref="nofollow noopener noreferrer">CocoIndex架构深入分析</a>，了解Rust如何实现这些功能。</p>
<h2 data-id="heading-8">对AI团队的意义</h2>
<p>从构建<a href="https://link.juejin.cn?target=https%3A%2F%2Fcocoindex.io" target="_blank" title="https://cocoindex.io" ref="nofollow noopener noreferrer">CocoIndex</a>中得到的教训：<strong>AI ETL需要与BI ETL根本不同的原语。</strong></p>
<p>如果您目前：</p>
<ul>
<li>每天重建整个嵌入索引</li>
<li>通过grep日志调试管道故障</li>
<li>在Postgres、Qdrant和特征存储之间手动同步数据</li>
<li>希望RAG系统的知识库合理新鲜</li>
</ul>
<p>...您的运营效率仅为10%，技术债务却是100%。</p>
<p>AI ETL的新形态：</p>
<ul>
<li>✅ 持续的、指纹感知的增量处理（而非夜间批处理）</li>
<li>✅ 具有端到端血缘的声明式、可观测数据流</li>
<li>✅ 多目标同步（向量数据库、图、OLTP存储平等对待，而非事后添加）</li>
<li>✅ 针对不可靠API的持久执行</li>
<li>✅ 用于调试和可观测性的原生工具</li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcocoindex.io" target="_blank" title="https://cocoindex.io" ref="nofollow noopener noreferrer">CocoIndex</a>是这些想法的一个具体实现。但基本原则是普遍的：<strong>AI系统需要将变化、不确定性和异构性视为一流关注点的ETL原语。</strong></p>
<hr/>
<p>**您在AI数据管道中最大的痛点是什么？**您是在处理陈旧的嵌入、模式漂移，还是不断重新设计ETL作业？欢迎评论——我很想听听您的解决方案。</p>
<p><em>要了解更多关于构建可扩展AI数据基础设施的信息，请访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fcocoindex.io" target="_blank" title="https://cocoindex.io" ref="nofollow noopener noreferrer">CocoIndex</a>，查看我们的<a href="https://link.juejin.cn?target=https%3A%2F%2Fcocoindex.io%2Fblog" target="_blank" title="https://cocoindex.io/blog" ref="nofollow noopener noreferrer">技术博客</a>和<a href="https://link.juejin.cn?target=https%3A%2F%2Fcocoindex.io%2Fdocs" target="_blank" title="https://cocoindex.io/docs" ref="nofollow noopener noreferrer">文档</a>。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Samba 配置详解]]></title>    <link>https://juejin.cn/post/7578853751530258447</link>    <guid>https://juejin.cn/post/7578853751530258447</guid>    <pubDate>2025-12-02T06:53:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578853751530258447" data-draft-id="7578797337868632098" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Samba 配置详解"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-02T06:53:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="今天也很困"/> <meta itemprop="url" content="https://juejin.cn/user/1286850568007976"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Samba 配置详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1286850568007976/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    今天也很困
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T06:53:59.000Z" title="Tue Dec 02 2025 06:53:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>一、简介</strong></h2>
<p>Samba 是一款在 Linux 系统上实现 Microsoft 网络通讯协议的软件。SMB（Server Message Block，服务器消息块）是 Microsoft 的网络文件共享协议，Samba 将 SMB 协议引入 Linux，实现了跨平台文件和打印共享。后来，微软将 SMB 改名为 CIFS（Common Internet File System，公共 Internet 文件系统），并增加了许多新功能，使 Samba 的功能更加强大。</p>
<p>Samba 的核心功能是实现 <strong>跨平台文件共享和打印共享</strong>：</p>
<ul>
<li>可以在 <strong>Linux 与 Windows</strong> 系统之间共享文件</li>
<li>可以在 <strong>Linux 与 Linux</strong> 系统之间共享资源</li>
</ul>
<p>虽然 NFS（网络文件系统）在 Linux 内部共享中更为高效，但 Samba 更常用于 <strong>Linux 与 Windows</strong> 系统间的数据共享。</p>
<hr/>
<h2 data-id="heading-1"><strong>二、安装 Samba 服务</strong></h2>
<h3 data-id="heading-2"><strong>1. 安装 Samba</strong></h3>
<p>在可以联网的 Linux 系统上，可以使用 <code>yum</code> 安装：</p>
<pre><code class="hljs language-ssh" lang="ssh">yum install samba samba-client samba-swat
</code></pre>
<p>如果无法联网，可挂载系统光盘进行安装。安装过程中，依赖包（如 <code>samba-common</code>、<code>samba-winbind-clients</code>、<code>libsmbclient</code>）会自动安装。</p>
<hr/>
<h3 data-id="heading-3"><strong>2. 查看安装情况</strong></h3>
<p>安装完成后，可查看已安装的包及版本：</p>
<pre><code class="hljs language-ssh" lang="ssh">rpm -qa | grep samba
</code></pre>
<p>各包作用说明：</p>

























<table><thead><tr><th>软件包</th><th>功能说明</th></tr></thead><tbody><tr><td>samba-common-3.5.10-125.el6.x86_64</td><td>提供 Samba 配置文件及语法检查工具 <code>testparm</code></td></tr><tr><td>samba-client-3.5.10-125.el6.x86_64</td><td>客户端工具，支持 Linux 主机作为 Samba 客户端</td></tr><tr><td>samba-swat-3.5.10-125.el6.x86_64</td><td>基于 HTTPS 的 Samba Web 配置界面</td></tr><tr><td>samba-3.5.10-125.el6.x86_64</td><td>服务器端软件，提供守护程序、日志轮替及开机默认配置</td></tr></tbody></table>
<p>安装完成后，会生成配置文件目录 <code>/etc/samba</code>，以及可执行工具。<br/>
其中，核心配置文件为：</p>
<pre><code class="hljs language-bash" lang="bash">/etc/samba/smb.conf   <span class="hljs-comment"># Samba 核心配置</span>
/etc/init.d/smb       <span class="hljs-comment"># Samba 启动/关闭脚本</span>
</code></pre>
<hr/>
<h3 data-id="heading-4"><strong>3. 启动 Samba 服务</strong></h3>
<p>启动、停止或重启 Samba 服务：</p>
<pre><code class="hljs language-arduino" lang="arduino">service smb start
service smb stop
service smb restart
</code></pre>
<p>查看 Samba 服务状态：</p>
<pre><code class="hljs language-lua" lang="lua">service smb <span class="hljs-built_in">status</span>
</code></pre>
<p>设置开机自启动（3、5 级别）：</p>
<pre><code class="hljs language-csharp" lang="csharp">chkconfig --level <span class="hljs-number">35</span> smb <span class="hljs-keyword">on</span>
</code></pre>
<hr/>
<h3 data-id="heading-5"><strong>4. 配置共享目录</strong></h3>
<p>编辑 <code>/etc/samba/smb.conf</code> 文件，添加共享目录示例：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[demo]</span>
    <span class="hljs-attr">comment</span> = demo
    <span class="hljs-attr">path</span> = /usr/local/demo
    read <span class="hljs-attr">only</span> = <span class="hljs-literal">No</span>
    guest <span class="hljs-attr">ok</span> = <span class="hljs-literal">Yes</span>

</code></pre>
<blockquote>
<p><code>read only = No</code> 表示可写<br/>
<code>guest ok = Yes</code> 表示允许匿名访问</p>
</blockquote>
<hr/>
<h3 data-id="heading-6"><strong>5. 添加 Samba 用户</strong></h3>
<p>Samba 使用独立用户管理，需要将 Linux 用户添加到 Samba：</p>
<pre><code class="hljs language-css" lang="css">smbpasswd -<span class="hljs-selector-tag">a</span> root
</code></pre>
<ul>
<li>设置密码后，该用户即可访问 Samba 共享目录</li>
</ul>
<hr/>
<h3 data-id="heading-7"><strong>6. 常见问题排查</strong></h3>
<p>如果 Windows 登录 Samba 服务器后无法访问共享目录，可检查以下几项：</p>
<ol>
<li>
<p><strong>防火墙设置</strong></p>
<ul>
<li>确保 Linux 防火墙已关闭或已开放 Samba 端口（通常为 137/138/139/445）</li>
</ul>
</li>
<li>
<p><strong>Samba 配置文件</strong></p>
<ul>
<li>检查 <code>/etc/samba/smb.conf</code> 是否正确配置共享目录及权限</li>
</ul>
</li>
<li>
<p><strong>SELinux 设置</strong></p>
<ul>
<li>
<p>默认情况下，SELinux 禁止网络对 Samba 共享目录的写操作</p>
</li>
<li>
<p>临时关闭：</p>
<pre><code class="hljs">setenforce 0
</code></pre>
</li>
<li>
<p>设置为 enforcing 模式：</p>
<pre><code class="hljs">setenforce 1
</code></pre>
</li>
<li>
<p>若要彻底禁用 SELinux，可修改 <code>/etc/selinux/config</code> 或 <code>/etc/sysconfig/selinux</code>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">SELINUX</span>=disabled
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong>检查 SELinux 状态</strong>：</p>
</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">/usr/bin/sestatus -v
</code></pre>
<hr/>
<h3 data-id="heading-8"><strong>七、小结</strong></h3>
<p>通过上述步骤，你可以在 Linux 系统上安装并配置 Samba，实现 <strong>Linux 与 Windows 之间的文件共享</strong>。</p>
<p>关键点总结：</p>
<ul>
<li>核心配置文件：<code>/etc/samba/smb.conf</code></li>
<li>Samba 用户独立管理，需要使用 <code>smbpasswd</code> 添加</li>
<li>后续访问权限问题，多数与防火墙或 SELinux 设置相关</li>
</ul>
<p>Samba 是企业级环境中跨平台共享文件的重要工具，掌握基本安装与配置，对系统管理非常有帮助。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI浏览器Comet用户体验测试]]></title>    <link>https://juejin.cn/post/7578902814022926351</link>    <guid>https://juejin.cn/post/7578902814022926351</guid>    <pubDate>2025-12-02T08:25:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578902814022926351" data-draft-id="7578877638988414976" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI浏览器Comet用户体验测试"/> <meta itemprop="keywords" content="测试,AIGC"/> <meta itemprop="datePublished" content="2025-12-02T08:25:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="PetterHillWater"/> <meta itemprop="url" content="https://juejin.cn/user/4088451358280841"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI浏览器Comet用户体验测试
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4088451358280841/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    PetterHillWater
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T08:25:34.000Z" title="Tue Dec 02 2025 08:25:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一.移动Web应用 UI/UE 测试的 5 大核心痛点</h3>
<p>移动Web应用（H5/PWA）的 UI/UE 测试与传统的 PC 网页测试截然不同，也比原生 App 测试更具挑战性。</p>
<p>以下是 <strong>移动Web应用 UI/UE 测试的 5 大核心痛点</strong>，这些通常是测试人员和设计师最头疼的地方：</p>
<h4 data-id="heading-1">1. 极致的“碎片化”兼容性 (The Fragmentation Hell)</h4>
<p>这是最直观、工作量最大的痛点。移动端环境极其复杂，导致“在这个手机上完美，在那个手机上崩坏”。</p>
<ul>
<li>
<p><strong>屏幕尺寸与形态多样</strong>：从 4 英寸小屏到折叠屏，再到全面屏的圆角、刘海（Notch）、灵动岛、挖孔。</p>
<ul>
<li><em>痛点</em>：关键按钮被“刘海”遮挡，或者底部导航栏（Tabbar）被 iPhone 的 Home Indicator（底部黑条）重叠，导致无法点击（Safe Area 适配问题）。</li>
</ul>
</li>
<li>
<p><strong>浏览器内核差异</strong>：虽然现在大多是 Webkit/Blink 内核，但在细节渲染上差异巨大。</p>
<ul>
<li><em>痛点</em>：iOS Safari 的 <code>100vh</code> 高度计算问题（会将地址栏算进去导致底部内容被遮盖）；Android 各大厂商（小米、华为、OPPO）自带浏览器的魔改特性；以及<strong>微信/支付宝内置浏览器</strong>（X5内核等）的特殊兼容性问题。</li>
</ul>
</li>
<li>
<p><strong>系统级设置干扰</strong>：</p>
<ul>
<li><em>痛点</em>：用户开启了系统的“大号字体/老人模式”，导致 H5 布局错乱、文字溢出；或者用户开启了“深色模式”，而 H5 没有适配，导致白字背景也是白色，内容不可见。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-2">2. 交互体验的“触控”难题 (Touch &amp; Gesture Issues)</h4>
<p>鼠标点击极其精准，但手指触控容易误触、遮挡。</p>
<ul>
<li>
<p><strong>“胖手指”效应 (Fat Finger)</strong> ：</p>
<ul>
<li><em>痛点</em>：点击区域（Click Target）太小，用户想点“取消”却点成了“确定”。测试时需要验证 44x44pt (iOS) 或 48x48dp (Android) 的最小点击区域规范。</li>
</ul>
</li>
<li>
<p><strong>手势冲突</strong>：</p>
<ul>
<li><em>痛点</em>：H5 内部的“左滑删除”或“轮播图滑动”，容易与浏览器的“右滑后退”手势冲突，导致用户操作极其不顺畅，甚至误关闭页面。</li>
</ul>
</li>
<li>
<p><strong>软键盘的噩梦</strong>：</p>
<ul>
<li><em>痛点</em>：当用户点击输入框唤起软键盘时，Android 和 iOS 的表现不同。有的会将页面顶上去（Resize），有的会覆盖在页面上（Overlay）。最常见的问题是：<strong>软键盘弹起后，把提交按钮挡住了，或者页面布局被挤压变形。</strong></li>
</ul>
</li>
</ul>
<h4 data-id="heading-3">3. 难以模拟的“真实场景” (Real-world Context)</h4>
<p>在办公室 WiFi 环境下测试完美的页面，在地铁里可能根本没法用。</p>
<ul>
<li>
<p><strong>弱网与加载焦虑</strong>：</p>
<ul>
<li><em>痛点</em>：移动端用户耐心极低。白屏超过 3 秒用户就会流失。测试不仅要测“能不能加载”，还要测“加载过程中的骨架屏（Skeleton）体验”、“图片懒加载时的占位符”、“断网时的空状态提示”。</li>
</ul>
</li>
<li>
<p><strong>中断测试</strong>：</p>
<ul>
<li><em>痛点</em>：正在填写长表单时，突然有电话打入、闹钟响了、或者切出去回个微信。切回来后，H5 页面是自动刷新了（填的数据全丢了），还是保持原样？这种状态恢复（State Restoration）测试很容易被忽略。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-4">4. 自动化测试的“高维护成本” (Automation ROI)</h4>
<p>UI 自动化测试在移动 Web 上很难落地。</p>
<ul>
<li><strong>元素定位不稳定</strong>：移动 Web 经常为了性能做 DOM 结构的动态渲染，或者使用了混淆的 CSS Class 名，导致自动化脚本（如 Appium/Selenium）经常找不到元素。</li>
<li><strong>视觉回归难 (Visual Regression)</strong> ：不同手机渲染出的字体行高、颜色渲染可能有细微像素级差异。自动化截图对比（Screenshot Comparison）经常因为 1 个像素的偏差而报错，导致大量“假阳性”警报，测试人员疲于维护脚本。</li>
</ul>
<h4 data-id="heading-5">5. “主观感受”无法量化</h4>
<p>UI/UE 测试不仅仅是找 Bug，更多是评估“好不好用”，这很难由机器完成。</p>
<ul>
<li><strong>流畅度感知</strong>：代码逻辑没问题，但动画掉帧（FPS 低于 60），或者滑动时有“粘滞感”。</li>
<li><strong>反馈及时性</strong>：点击按钮后，如果没有立即的按压态（Active State）或 Loading 提示，用户会以为没点到而疯狂连点，导致重复提交数据。这种“手感”问题必须靠人工反复把玩才能发现。</li>
</ul>
<h3 data-id="heading-6">二、 Comet 的解决方案：从“验证代码”到“模拟感知”</h3>
<p>Comet 不仅仅是一个浏览器，它是新一代 AI 驱动的自动化体验评审专家。它标志着测试领域从“验证代码逻辑”向“模拟人类感知”的重大范式转移。<br/>
Comet 通过以下核心能力直击上述痛点：<br/>
• 像人一样“看” (Visual Cognition)：利用计算机视觉，Comet 能识别“按钮被遮挡”或“对比度太低”，而非仅仅检查 DOM 代码。<br/>
• 意图驱动与脚本自愈 (Intent-Driven &amp; Self-healing)：你只需告诉 Comet “帮我购买商品”，它会像真实用户一样寻找路径。即使开发修改了页面代码，只要视觉元素还在，Comet 就能自动修正脚本，彻底解决痛点<br/>
• 并发仿真 (Concurrent Simulation)：Comet 可瞬间并发控制 100+ 云端实例，同时模拟不同机型和网络环境，一杯咖啡的时间即可完成过去数周的兼容性测试，解决痛点。<br/>
• 基于规则的情感化审计 (Rule-based Empathetic Audit)：Comet 将尼尔森十大可用性原则（Nielsen Heuristics）及 WCAG 无障碍标准内化为检测规则，将痛点 中的主观感受转化为可量化的数据。</p>
<p><strong>Gemini 3 Pro也不可行</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fimg2024.cnblogs.com%2Fblog%2F15172%2F202512%2F15172-20251202162137830-1163953114.png" target="_blank" title="https://img2024.cnblogs.com/blog/15172/202512/15172-20251202162137830-1163953114.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d316fe398e54aea9c0b024eb317182a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGV0dGVySGlsbFdhdGVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765268734&amp;x-signature=6vnopJWCOBrDqXMPc%2Fo562bahvk%3D" alt="image" title="image" loading="lazy"/></a></p>
<p>扣子空间与minimax访问不了这个网站</p>
<h3 data-id="heading-7">三、 Comet 实战演示：Moments &amp; Feelings 应用评审</h3>
<p>为了展示 Comet 的实际工作流，我们对一款名为 "Moments &amp; Feelings" 的移动 Web 应用进行了测试。</p>
<ol>
<li>任务输入：Prompt 驱动引擎<br/>
Comet 的核心引擎基于极强的语境理解能力。以下是我们输入给 Comet 的指令（Prompt），定义了其“资深体验评审专家”的角色。</li>
<li>测试对象<br/>
应用界面截图：Moments &amp; Feelings 首页及展开页</li>
<li>Comet 输出的诊断报告 (节选)</li>
</ol>
<h4 data-id="heading-8">基础提取词版本</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fimg2024.cnblogs.com%2Fblog%2F15172%2F202512%2F15172-20251202122448739-1095117138.png" target="_blank" title="https://img2024.cnblogs.com/blog/15172/202512/15172-20251202122448739-1095117138.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/966f107c9cf54de388a6d7414ee47016~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGV0dGVySGlsbFdhdGVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765268734&amp;x-signature=myKFCiPadwLR4yxyXIo2SFideME%3D" alt="image" title="image" loading="lazy"/></a></p>
<p>反馈</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fimg2024.cnblogs.com%2Fblog%2F15172%2F202512%2F15172-20251202122450088-447061000.png" target="_blank" title="https://img2024.cnblogs.com/blog/15172/202512/15172-20251202122450088-447061000.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49d9e5bcbf8f4e3a88de3e7922655d70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGV0dGVySGlsbFdhdGVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765268734&amp;x-signature=0GrBrXerFvTfLTKKWGistB%2FkN%2FE%3D" alt="image" title="image" loading="lazy"/></a></p>
<h4 data-id="heading-9">加强提示词</h4>
<blockquote>
<p>"请基于此 Prompt，作为体验评审师，对这些截图进行专业评审。<a href="https://link.juejin.cn?target=https%3A%2F%2Fparenting-and-nurtureself.vercel.app%2F%2522" target="_blank" title="https://parenting-and-nurtureself.vercel.app/%22" ref="nofollow noopener noreferrer">parenting-and-nurtureself.vercel.app/"</a></p>
<h2 data-id="heading-10">Role: 资深移动Web应用 UI/UE 体验评审专家</h2>
<h3 data-id="heading-11">Profile</h3>
<ul>
<li><strong>角色定位</strong>: 你是一位拥有10年以上经验的资深产品设计师和用户体验专家，精通移动端（Mobile Web/H5/PWA）的设计规范（iOS HIG &amp; Material Design），擅长运用“尼尔森十大可用性原则”和“用户体验五要素”进行诊断。</li>
<li><strong>核心能力</strong>: 视觉层次分析、交互流畅度评估、信息架构梳理、文案微拷贝优化、情感化设计洞察。</li>
<li><strong>评审风格</strong>: 客观犀利、注重细节、以用户为中心、给出可落地的解决方案。</li>
</ul>
<h3 data-id="heading-12">Goals</h3>
<p>对用户提供的【移动Web应用】（通过截图、描述或代码片段）进行全方位的 UI/UE 评审，并输出一份结构清晰的《用户体验诊断报告》。</p>
<h3 data-id="heading-13">Constrains</h3>
<ul>
<li>必须基于移动端（手机竖屏）的使用场景进行评估（手指触控、屏幕尺寸限制、碎片化时间）。</li>
<li>评价需要区分“客观事实”与“主观感受”。</li>
<li>对于指出的每一个问题，必须提供具体的改进建议。</li>
</ul>
<h3 data-id="heading-14">Workflow</h3>
<ol>
<li><strong>场景代入</strong>: 设想典型用户（Persona）在特定场景下使用该产品的全流程。</li>
<li><strong>多维扫描</strong>: 从视觉、交互、功能、内容四个维度进行扫描。</li>
<li><strong>问题分级</strong>: 将发现的问题标记严重等级（P0-阻断性问题, P1-体验瑕疵, P2-视觉建议）。</li>
<li><strong>输出报告</strong>: 按照下方定义的格式输出最终评审。</li>
</ol>
<h3 data-id="heading-15">Evaluation Framework (评审维度)</h3>
<ol>
<li><strong>视觉表现 (UI)</strong>: 配色和谐度、字体排版（可读性）、留白与呼吸感、品牌一致性。</li>
<li><strong>交互体验 (UX)</strong>: 导航清晰度、操作反馈（点击/加载）、手势操作逻辑、表单易用性、误触防范。</li>
<li><strong>内容策略</strong>: 核心价值传达是否直接？文案是否人话？是否有行动召唤（CTA）？</li>
<li><strong>技术感知</strong>: 加载速度预估、异常状态处理（404/空状态）、移动端适配性。</li>
</ol>
<h3 data-id="heading-16">Output Format (请严格按照此格式输出)</h3>
<h4 data-id="heading-17">[应用/页面名称] 体验诊断报告</h4>
<h5 data-id="heading-18">1. 总体评分 (0-10分)</h5>
<ul>
<li><strong>综合得分</strong>: [X] / 10</li>
<li><strong>一句话点评</strong>: [用简练的语言概括整体感受，如：极简清新但引导不足]</li>
</ul>
<h5 data-id="heading-19">2. 体验亮点 (Highlights)</h5>
<ul>
<li>[列出1-3个做得好的地方，值得保留的设计]</li>
</ul>
<h5 data-id="heading-20">3. 核心痛点与问题 (Issues Breakdown)</h5>





























<table><thead><tr><th align="left">等级</th><th align="left">维度</th><th align="left">问题描述</th><th align="left">心理学/设计原理依据</th></tr></thead><tbody><tr><td align="left"><strong>P0</strong></td><td align="left">[交互/视觉]</td><td align="left">[具体描述问题]</td><td align="left">[例如：违反费茨定律，按钮太小难以点击]</td></tr><tr><td align="left"><strong>P1</strong></td><td align="left">[流程/内容]</td><td align="left">[具体描述问题]</td><td align="left">[例如：认知负荷过重，选项过多]</td></tr><tr><td align="left"><strong>P2</strong></td><td align="left">[美观度]</td><td align="left">[具体描述问题]</td><td align="left">[例如：色彩对比度不足，不仅耐看]</td></tr></tbody></table>
<h5 data-id="heading-21">4. 优化建议方案 (Actionable Advice)</h5>
<ul>
<li><strong>即刻改进 (Quick Wins)</strong>: [开发成本低、效果立竿见影的改动]</li>
<li><strong>长期迭代 (Strategic)</strong>: [涉及架构或风格的大改动建议]</li>
</ul>
<h5 data-id="heading-22">5. 交互细节重构 (Bonus)</h5>
<ul>
<li><em>针对当前页面最差的一个模块，用文字描述或Mermaid流程图给出具体的重构方案。</em></li>
</ul>
<hr/>
<h3 data-id="heading-23">Start</h3>
<p>请提供您需要评审的移动Web应用的<strong>截图</strong>、<strong>详细功能描述</strong>或<strong>链接</strong>（如果是公开可访问的文本内容），我将开始评审。</p>
</blockquote>
<h4 data-id="heading-24">反馈</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fimg2024.cnblogs.com%2Fblog%2F15172%2F202512%2F15172-20251202122451411-721469213.png" target="_blank" title="https://img2024.cnblogs.com/blog/15172/202512/15172-20251202122451411-721469213.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e976e0407339421198b2021c81b51703~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGV0dGVySGlsbFdhdGVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765268734&amp;x-signature=5AakGmUOjq9JmDAWiafAZajbhX8%3D" alt="image" title="image" loading="lazy"/></a></p>
<h4 data-id="heading-25">Manus</h4>
<p>也可以实现，但没有Comet报告详细，可以生成PPT报告，如下是链接</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmanus.im%2Fshare%2FXvRP6gHdVmN5ogJOoHBsxh%3Freplay%3D1" title="https://manus.im/share/XvRP6gHdVmN5ogJOoHBsxh?replay=1" target="_blank" ref="nofollow noopener noreferrer">manus.im/share/XvRP6…</a></p>
<h3 data-id="heading-26">四、 价值闭环：Comet 如何系统性解决五大核心痛点</h3>
<hr/>
<p>通过上述实战案例，我们可以清晰地看到 Comet 如何将抽象的行业痛点转化为具体的解决方案：</p>
<ol>
<li>
<p>回应痛点 1 (碎片化兼容性)：<br/>
◦ Comet 在并发测试中，能在不同尺寸屏幕上精准识别布局崩坏。</p>
</li>
<li>
<p>回应痛点 2 (交互触控难题)：<br/>
◦ 实证：报告中 P0 级问题指出的“图标尺寸过小”，正是 Comet 模拟真实用户“胖手指”效应（Fat Finger）的结果。这是传统自动化脚本通过坐标点击永远无法发现的问题。</p>
</li>
<li>
<p>回应痛点 3 (真实场景模拟)：<br/>
◦ Comet 的意图驱动测试可模拟用户在户外强光下的阅读体验（报告中 P2 级对比度问题），以及在操作中途被打断后的状态恢复能力。</p>
</li>
<li>
<p>回应痛点 4 (高维护成本)：<br/>
◦ 即便 "Moments &amp; Feelings" 更新了底层代码，只要界面视觉元素未变，Comet 的测试流程无需任何修改即可复用，实现脚本“零维护”。</p>
</li>
<li>
<p>回应痛点 5 (主观感受量化)：<br/>
◦ 实证：报告引用 “费茨定律” 和 “尼尔森原则” 来佐证“反馈不足”和“点击难”的问题。Comet 将依赖设计师直觉的“主观感受”，转化为了有理有据的“专家诊断”，直接赋能产品决策</p>
</li>
</ol>
<h3 data-id="heading-27">结论</h3>
<p>利用 <strong>AI 浏览器</strong>（或者更准确地说是<strong>AI驱动的自动化测试代理/Agent</strong>）来实现移动 Web 应用的 UI/UE 测试，标志着测试领域从“验证代码逻辑”<strong>向</strong>“模拟人类感知”的重大范式转移。</p>



































<table><thead><tr><th><strong>维度</strong></th><th><strong>传统自动化测试 (Selenium/Appium)</strong></th><th><strong>AI 驱动的测试 (AI Browsers/Agents)</strong></th></tr></thead><tbody><tr><td><strong>测试核心</strong></td><td><strong>验证代码</strong> (Check Code)</td><td><strong>模拟行为</strong> (Simulate Behavior)</td></tr><tr><td><strong>识别方式</strong></td><td>DOM 选择器、坐标</td><td>视觉识别 (Vision) + 语义理解 (Text)</td></tr><tr><td><strong>抗变能力</strong></td><td>脆弱（UI微调即报错）</td><td>强（具有自愈能力，理解意图）</td></tr><tr><td><strong>输出结果</strong></td><td>冰冷的 Pass/Fail</td><td>有温度的体验报告 + 改进建议</td></tr><tr><td><strong>核心意义</strong></td><td><strong>确保“功能可用”</strong></td><td><strong>确保“好用”且“不出错”</strong></td></tr></tbody></table>
<p>像人一样“看”：利用计算机视觉（Computer Vision），AI 能识别出“这个按钮被文字盖住了”或“颜色对比度太低看不清”。<br/>
意图驱动：你不需要告诉 AI “点击坐标 (100, 200)”，而是告诉它“帮我购买一件商品”。AI 会像真实用户一样浏览页面，寻找“购买”按钮。如果 UI 变了，只要按钮还在，AI 就能找到，这彻底解决了“脚本维护成本高”的问题。<br/>
脚本自愈 (Self-healing)：当页面结构变化导致脚本报错时，AI 能自动分析上下文，猜测“开发把 ID 改了，但应该是这个按钮”，自动修正脚本并继续执行。</p>
<p>随机探索 (Monkey Testing ++)：AI 不会只按剧本走，它可以基于对 App 功能的理解进行“探索性测试”，发现人类测试员想不到的边界路径（Edge Cases）。<br/>
模拟用户画像 (Persona Testing)：你可以给 AI 设定人设（例如：“我是个视力不好的老年人” 或 “我是个没耐心的商务人士”）。AI 跑完流程后，会基于 LLM（大语言模型）给出评价：“字体太小，我看得很吃力” 或 “弹窗太多，我很烦躁”。<br/>
情感化审计：AI 可以分析页面文案的情感色彩，判断是否对用户足够友好，是否符合品牌调性。</p>
<p>并发仿真：AI Agent 可以同时控制 100 个云端浏览器实例，模拟不同的分辨率、操作系统和网络环境，并行执行任务。</p>
<p>视觉回归自动化：AI 能瞬间对比 100 张截图，智能忽略掉无意义的像素差异（比如渲染导致的 1px 偏差），只把真正的 UI 错乱（如文字重叠、布局崩坏）标记出来给人类看。</p>
<p><strong>Comet 不是传统自动化工具的升级，而是用户体验测试的代际跨越</strong></p>



































<table><thead><tr><th><strong>维度</strong></th><th><strong>传统自动化测试 (Selenium/Appium)</strong></th><th><strong>Comet AI 解决方案</strong></th></tr></thead><tbody><tr><td><strong>测试核心</strong></td><td><strong>验证代码</strong> (Check Code)</td><td><strong>模拟行为与感知</strong> (Simulate Behavior &amp; Perception)</td></tr><tr><td><strong>识别方式</strong></td><td>脆弱的 DOM 选择器、坐标</td><td><strong>视觉识别 (Vision) + 语义理解 (Text)</strong></td></tr><tr><td><strong>抗变能力</strong></td><td>极弱（UI微调即报错）</td><td><strong>极强</strong>（具有自愈能力，理解意图，零维护）</td></tr><tr><td><strong>输出结果</strong></td><td>冰冷的 Pass/Fail 日志</td><td><strong>有温度、含设计依据的诊断报告 + 改进建议</strong></td></tr><tr><td><strong>核心价值</strong></td><td>确保“功能可用”</td><td><strong>确保“好用”、“易用”且“符合人性”</strong></td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[arthas 我愿称为最强辅助工具]]></title>    <link>https://juejin.cn/post/7578948893761847323</link>    <guid>https://juejin.cn/post/7578948893761847323</guid>    <pubDate>2025-12-02T07:40:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578948893761847323" data-draft-id="7578780780026658825" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="arthas 我愿称为最强辅助工具"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-12-02T07:40:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我家领养了个白胖胖"/> <meta itemprop="url" content="https://juejin.cn/user/1152746990351032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            arthas 我愿称为最强辅助工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1152746990351032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我家领养了个白胖胖
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T07:40:11.000Z" title="Tue Dec 02 2025 07:40:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>Arthas</strong>（注意拼写是 <strong>Arthas</strong>，不是 Arthus），是由阿里巴巴开源的一款 <strong>Java 诊断工具</strong>，专为在线排查 Java 应用问题而设计。它功能强大、使用方便，支持在不修改代码、不重启服务的情况下，对运行中的 Java 应用进行实时诊断。官网地址[<a href="https://link.juejin.cn?target=https%3A%2F%2Farthas.aliyun.com%2F" target="_blank" title="https://arthas.aliyun.com/" ref="nofollow noopener noreferrer">arthas.aliyun.com/</a>]</p>
<h2 data-id="heading-0">✅ 使用场景</h2>
<ul>
<li>线上服务 CPU 飙高，快速定位热点方法</li>
<li>接口响应慢，分析调用链耗时</li>
<li>验证线上代码是否为最新版本（通过 jad 反编译）</li>
<li>查看某个方法的实际入参/返回值（无需加日志重启）</li>
<li>排查死锁、内存泄漏、类加载问题等</li>
</ul>
<h2 data-id="heading-1">🚀 快速开始</h2>
<pre><code class="hljs language-bash" lang="bash">bash
编辑
<span class="hljs-comment"># 下载 arthas-boot.jar</span>
curl -O https://arthas.aliyun.com/arthas-boot.jar

<span class="hljs-comment"># 启动（会列出所有 Java 进程）</span>
java -jar arthas-boot.jar

<span class="hljs-comment"># 选择目标进程 PID，进入交互式命令行</span>
</code></pre>
<p>idea使用插件推荐: arthas idea</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/986cfb76c7794afb8400427e93a42a5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5a626aKG5YW75LqG5Liq55m96IOW6IOW:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266011&amp;x-signature=Z10tKkLjtpxOW6VYKywh2rufxpA%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">常用命令</h2>
<p><code>dashboard</code>    Overview of target jvm's thread, memory, gc, vm, tomcat info.</p>
<p><code>thread</code>
<code>thread 线程编号</code></p>
<p><code>jad class</code>  Decompile class 反编译类  <code>看线上代码是否已经部署最新</code></p>
<p><code>watch com.response.PriceApiResponse * '{params,returnObj,throwExp}'  -n 5  -x 3 </code>
检测方法入参/出参/异常</p>
<p><code>trace com.service.impl.AuditServiceImpl commit  -n 5 --skipJDKMethod false </code>
对方法耗时进行统计</p>
<p><code>stack com.admin.dto.request.AuditData *  -n 5 </code> 调用栈 看什么地方会调用此方法</p>
<p><code>monitor com.admin.dto.request.AuditData *  -n 10  --cycle 10 </code> 一般压测的时候使用  查看调用次数成功和失败数量</p>
<h2 data-id="heading-3">线上使用</h2>
<h3 data-id="heading-4">死循环导致cpu飙高</h3>
<p><code>thread -n 1</code> 线程使用率最高的一个 定位哪一行代码造成的cup飙高
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/329779c25f304bca8017ee9704818462~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5a626aKG5YW75LqG5Liq55m96IOW6IOW:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266011&amp;x-signature=0eL58GnC%2B41W%2FNN8JUTx6oSERyQ%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-5">死锁</h3>
<p><code>thread</code> 查看死锁线程数 BLOCKED是死锁线程数量</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd57318ee6144a08ac296bf203459849~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5a626aKG5YW75LqG5Liq55m96IOW6IOW:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266011&amp;x-signature=rFySbfCPwWNyyWWrhG%2BmmQgoov0%3D" alt="image.png" loading="lazy"/></p>
<p><code>thread -b</code> 直接查看死锁信息 抢占什么死锁资源
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/529e2d47dbfa49c281cb7833a5bd4622~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5a626aKG5YW75LqG5Liq55m96IOW6IOW:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266011&amp;x-signature=Yx9ghIouFJV0nG7ZqJS8oXI4zZc%3D" alt="image.png" loading="lazy"/>\</p>
<h3 data-id="heading-6">时空隧道</h3>
<p><code>tt -t com.admin.dto.request.AuditData * -n 5 </code> 记录方法调用</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c33b75b650f437f87d32a45b1591b85~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5a626aKG5YW75LqG5Liq55m96IOW6IOW:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266011&amp;x-signature=jVnd9c4UQDDoNoUMvSQnLLSrwFg%3D" alt="image.png" loading="lazy"/></p>
<p><code>tt -i 1000</code> 查看1000访问时候的请求参数 返回值 异常等信息
<code>tt -p -i 1000 </code> 回放重新调用 显示返回值 异常信息等</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dabe4709818047a2b6e6b0f8b6bc7936~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5a626aKG5YW75LqG5Liq55m96IOW6IOW:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266011&amp;x-signature=xJYdbJQhAut8yFwaxs6Fhri0vuc%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🔥NestJS 接口文档神器！nestjs-knife4j-plus 让 Swagger 颜值与功能双飞跃]]></title>    <link>https://juejin.cn/post/7578793960628060186</link>    <guid>https://juejin.cn/post/7578793960628060186</guid>    <pubDate>2025-12-02T07:04:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578793960628060186" data-draft-id="7578803491822600219" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🔥NestJS 接口文档神器！nestjs-knife4j-plus 让 Swagger 颜值与功能双飞跃"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-02T07:04:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Dr丶net"/> <meta itemprop="url" content="https://juejin.cn/user/3263006242251373"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🔥NestJS 接口文档神器！nestjs-knife4j-plus 让 Swagger 颜值与功能双飞跃
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3263006242251373/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Dr丶net
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T07:04:01.000Z" title="Tue Dec 02 2025 07:04:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="an-old-hope">.hljs-comment,.hljs-quote{color:#b6b18b}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#eb3c54}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#e7ce56}.hljs-attribute{color:#ee7c2b}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#4fb4d7}.hljs-section,.hljs-title{color:#78bb65}.hljs-keyword,.hljs-selector-tag{color:#b45ea4}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1c1d21;color:#c0c5ce}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作为 NestJS 开发者，你是否觉得原生 Swagger 文档不够直观？接口调试不够顺畅？今天给大家推荐一款宝藏插件 ——<strong>nestjs-knife4j-plus</strong>，让你的 API 文档瞬间升级，支持 Express 和 Fastify 双适配器，开发效率直接拉满！</p>
<h3 data-id="heading-0">✨ 核心亮点</h3>
<p>✅ <strong>双框架适配</strong>：完美支持 Express 和 Fastify 两种 HTTP 适配器，不用操心框架兼容性问题</p>
<p>✅ <strong>高颜值 UI</strong>：基于 Knife4j 打造的可视化界面，比原生 Swagger 更清晰、更易用，接口分类、参数展示一目了然</p>
<p>✅ <strong>无缝集成</strong>：与 @nestjs/swagger 深度兼容，原有 Swagger 配置无需大幅修改，快速接入</p>
<p>✅ <strong>调试友好</strong>：支持在线接口调试、参数自动填充、响应格式化，开发测试一条龙</p>
<h3 data-id="heading-1">📦 极速安装</h3>
<p>一行命令搞定基础安装，Fastify 用户额外补充依赖即可：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 基础安装（Express/Fastify通用）</span>
npm install nestjs-knife4j-plus @nestjs/swagger 
<span class="hljs-comment">// Fastify适配器需额外安装 </span>
npm install @fastify/<span class="hljs-keyword">static</span>
</code></pre>
<p>⚠️ 注意：@fastify/static 版本需与 Fastify 版本匹配，兼容性矩阵参考：</p>





























<table><thead><tr><th>@fastify/static version</th><th>Fastify version</th></tr></thead><tbody><tr><td><code>^8.x</code></td><td><code>^5.x</code></td></tr><tr><td><code>^7.x</code></td><td><code>^4.x</code></td></tr><tr><td><code>^5.x</code></td><td><code>^3.x</code></td></tr><tr><td><code>^2.x</code></td><td><code>^2.x</code></td></tr><tr><td><code>^1.x</code></td><td><code>^1.x</code></td></tr></tbody></table>
<h3 data-id="heading-2">🚀 快速上手</h3>
<p>只需在原有 Swagger 配置基础上，添加 3 行代码即可启用：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">SwaggerModule</span>, <span class="hljs-title class_">DocumentBuilder</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/swagger'</span>
<span class="hljs-keyword">import</span> { knife4jSetup } <span class="hljs-keyword">from</span> <span class="hljs-string">'nestjs-knife4j-plus'</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 原有Swagger配置不变</span>
  <span class="hljs-keyword">const</span> options = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DocumentBuilder</span>()
    .<span class="hljs-title function_">setTitle</span>(<span class="hljs-string">'Cats example'</span>)
    .<span class="hljs-title function_">setDescription</span>(<span class="hljs-string">'The cats API description'</span>)
    .<span class="hljs-title function_">setVersion</span>(<span class="hljs-string">'1.0'</span>)
    .<span class="hljs-title function_">addTag</span>(<span class="hljs-string">'cats'</span>)
    .<span class="hljs-title function_">build</span>()
  <span class="hljs-keyword">const</span> <span class="hljs-variable language_">document</span> = <span class="hljs-title class_">SwaggerModule</span>.<span class="hljs-title function_">createDocument</span>(app, options)
  <span class="hljs-title class_">SwaggerModule</span>.<span class="hljs-title function_">setup</span>(<span class="hljs-string">'api'</span>, app, <span class="hljs-variable language_">document</span>)

  <span class="hljs-comment">// 启用knife4j增强（关键代码）</span>
  <span class="hljs-title function_">knife4jSetup</span>(app, [
    {
      <span class="hljs-attr">name</span>: <span class="hljs-string">'2.0 version'</span>, <span class="hljs-comment">// 文档版本名称</span>
      <span class="hljs-attr">url</span>: <span class="hljs-string">`/api-json`</span>,    <span class="hljs-comment">// Swagger openapi JSON地址</span>
    },
  ])

  <span class="hljs-keyword">await</span> app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>)
}
</code></pre>
<p>启动项目后，访问 <code>http://127.0.0.1:3000/doc.html</code>，就能看到美化后的接口文档啦！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46d05f7d1e394a0096f86e6081556e76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRHLkuLZuZXQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765263945&amp;x-signature=ocrohcFGHW8bDoqnC7TyoTwX1pc%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">🌟 开源信息</h3>
<ul>
<li>许可证：MIT（完全开源可商用）</li>
<li>NPM 地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fnestjs-knife4j-plus" target="_blank" title="https://www.npmjs.com/package/nestjs-knife4j-plus" ref="nofollow noopener noreferrer">nestjs-knife4j-plus</a></li>
<li>源码仓库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjkhuangfu%2Fnestjs-knife4j-plus" target="_blank" title="https://github.com/jkhuangfu/nestjs-knife4j-plus" ref="nofollow noopener noreferrer">github.com/jkhuangfu/n…</a></li>
<li>特别感谢：@xiaoymin 提供的 Knife4j WebUI 支持</li>
</ul>
<p>目前插件已稳定迭代，issues 响应及时，无论是个人开发还是企业项目都能放心使用～ 赶紧安装试试，让你的 NestJS 接口文档告别单调，变得既好看又好用！</p>
<p>如果觉得有用，欢迎点赞收藏，转发给身边的 NestJS 开发者～ 有任何使用问题或建议，也可以去 GitHub 提交 issue 交流哦！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Git 的三大工作区域：工作区、暂存区、本地仓库]]></title>    <link>https://juejin.cn/post/7578948893761781787</link>    <guid>https://juejin.cn/post/7578948893761781787</guid>    <pubDate>2025-12-02T07:36:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578948893761781787" data-draft-id="7578948893761699867" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Git 的三大工作区域：工作区、暂存区、本地仓库"/> <meta itemprop="keywords" content="Git"/> <meta itemprop="datePublished" content="2025-12-02T07:36:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="系夏普"/> <meta itemprop="url" content="https://juejin.cn/user/895462143964748"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Git 的三大工作区域：工作区、暂存区、本地仓库
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/895462143964748/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    系夏普
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T07:36:34.000Z" title="Tue Dec 02 2025 07:36:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Git 的核心设计之一，就是将代码变更的管理划分为三个清晰的区域：<strong>工作区（Working Directory）→ 暂存区（Staging Area）→ 本地仓库（Local Repository）</strong> 。</p>
<hr/>
<h2 data-id="heading-0">1. 工作区（Working Directory）</h2>
<h3 data-id="heading-1">是什么？</h3>
<p>你本地电脑上能直接看到、编辑的项目文件夹（包含所有源码、文档、子目录等）。这是你日常写代码、改配置、加注释的地方。</p>
<blockquote>
<p>路径示例：<code>/Users/you/project/</code> —— 除了隐藏的 <code>.git</code> 文件夹外，其余都是工作区。</p>
</blockquote>
<h3 data-id="heading-2">特点</h3>
<ul>
<li>
<p>所有文件都处于 “当前开发状态” ，无论是否被 Git 跟踪。</p>
</li>
<li>
<p>文件按 Git 视角分为两类状态：</p>
<ul>
<li>
<p><strong>未跟踪（Untracked）</strong> ：新创建的文件，Git 从未记录过（如刚新建的 <code>readme.md</code>）。</p>
</li>
<li>
<p>已跟踪（Tracked）</p>
<p>：曾被 <strong>git add</strong> 过，Git 有其历史记录。这类文件又可分为：</p>
<ul>
<li>未修改（Unmodified）</li>
<li>已修改（Modified）</li>
<li>已暂存（Staged）</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>注意：工作区的任何修改不会自动进入版本历史，必须通过 <code>git add</code> 显式告知 Git 哪些改动需要关注。</p>
</blockquote>
<h3 data-id="heading-3">举例：</h3>
<blockquote>
<p>你的<strong>书桌</strong>——上面摊着草稿纸、涂改的段落、新写的章节……杂乱但充满创造力，尚未决定哪些内容要正式归档。</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">2.暂存区（Staging Area / Index）</h2>
<h3 data-id="heading-5">是什么？</h3>
<p>一个由 Git 内部维护的<strong>临时缓冲区</strong>，物理上存储在 <code>.git/index</code> 文件中（你看不到具体文件，但可通过命令操作）。 它是工作区与本地仓库之间的“中转站” ，用于预览和筛选即将提交的内容。</p>
<h3 data-id="heading-6">怎么进？</h3>
<p>使用 <code>git add &lt;file&gt;</code> 或 <code>git add .</code> 将工作区的修改（包括新增文件）加入暂存区。</p>
<h3 data-id="heading-7">特点</h3>
<ul>
<li>
<p>只有通过 <code>git add</code>，修改才会进入暂存区。</p>
</li>
<li>
<p>可以多次执行 <code>git add</code>，逐步构建一次提交的内容：</p>
<pre><code class="hljs language-csharp" lang="csharp">git <span class="hljs-keyword">add</span> feature.c      <span class="hljs-meta"># 先暂存功能代码</span>
git <span class="hljs-keyword">add</span> README.md      <span class="hljs-meta"># 再暂存文档更新</span>
</code></pre>
</li>
<li>
<p>如果对已暂存的文件再次修改，新改动会留在工作区，不会自动进入暂存区，需重新 <code>git add</code> 才能包含。</p>
</li>
</ul>
<blockquote>
<p>这使得你可以把“修复 bug”和“添加新功能”拆成两次独立提交，哪怕它们是在同一个文件里完成的！</p>
</blockquote>
<h3 data-id="heading-8">举例：</h3>
<blockquote>
<p>你的待寄包裹台——从书桌上挑选出几页满意的稿子，放进一个信封（暂存区），准备寄出。其他未选中的内容，仍留在桌上继续打磨。</p>
</blockquote>
<hr/>
<h2 data-id="heading-9">3.本地仓库（Local Repository）</h2>
<h3 data-id="heading-10">是什么？</h3>
<p>位于项目根目录下的 <code>.git</code> 隐藏文件夹，其中存储了项目的完整历史快照，包括：</p>
<ul>
<li>所有提交（commits）</li>
<li>分支（branches）</li>
<li>标签（tags）</li>
<li>配置信息等</li>
</ul>
<blockquote>
<p><code>.git</code> 目录就是 Git 的“大脑”，删除它就等于把项目变回普通文件夹（失去所有版本控制能力）。</p>
</blockquote>
<h3 data-id="heading-11">怎么进？</h3>
<p>执行 <code>git commit -m "提交信息"</code>，将暂存区的全部内容一次性打包，生成一个新的提交（commit），永久保存到本地仓库。</p>
<h3 data-id="heading-12">特点</h3>
<ul>
<li>每次 <code>commit</code> 会生成一个唯一的 SHA-1 哈希值（如 <code>a3f2d1b...</code>），作为该版本的身份证。</li>
<li>提交后，工作区和暂存区会“清空”（相对于这次提交而言），你可以继续开发。</li>
<li>即使你误删了工作区所有文件，只要本地仓库存在，就能通过 <code>git checkout</code> 或 <code>git restore</code> 完整恢复！</li>
</ul>
<h3 data-id="heading-13">举例：</h3>
<blockquote>
<p>你的个人档案馆——每次寄出的信</p>
</blockquote>
<h3 data-id="heading-14">如图所示：</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3639d8222b7641eda51cb6975240cac1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57O75aSP5pmu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765265794&amp;x-signature=Xrz78XLOF0BUkhJ5O1TbynYAvRU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-15">三大区域的数据流向</h2>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[ 工作区 ]</span> 
   │
   │ git add
   ▼
<span class="hljs-selector-attr">[ 暂存区 ]</span> 
   │
   │ git commit
   ▼
<span class="hljs-selector-attr">[ 本地仓库 ]</span>
   │
   │ git push
   ▼
<span class="hljs-selector-attr">[ 远程仓库 ]</span> （如 GitHub / GitLab）
</code></pre>
<ul>
<li><code>git add</code>：从工作区 → 暂存区</li>
<li><code>git commit</code>：从暂存区 → 本地仓库</li>
<li><strong><code>git commit</code> 不会提交工作区中未暂存的修改！</strong></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[视频自动翻译里的“时空折叠”：简单实用的音画同步实践]]></title>    <link>https://juejin.cn/post/7578836326475153435</link>    <guid>https://juejin.cn/post/7578836326475153435</guid>    <pubDate>2025-12-02T08:59:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578836326475153435" data-draft-id="7578917474659516467" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="视频自动翻译里的“时空折叠”：简单实用的音画同步实践"/> <meta itemprop="keywords" content="Python,AIGC,FFmpeg"/> <meta itemprop="datePublished" content="2025-12-02T08:59:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mortimer"/> <meta itemprop="url" content="https://juejin.cn/user/4441682704623992"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            视频自动翻译里的“时空折叠”：简单实用的音画同步实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4441682704623992/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mortimer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T08:59:59.000Z" title="Tue Dec 02 2025 08:59:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>做视频翻译，最容易被看到的难题是“翻译准不准”，但真正困扰工程实现的，往往是<strong>音画同步</strong>：不同语言的语速、信息密度差异巨大，导致生成的配音时长，总是和原视频“对不上”。</p>
<p>本文分享一种在 <strong>Python + FFmpeg</strong> 环境下可落地的解决方案。核心思路是用 <strong>静音剔除、双向均摊变速、动态涟漪对齐</strong>，在不借助高算力 AI（如唇型生成、深度重建）情况下，实现“够好用的自动化音画对齐”。</p>
<hr/>
<h2 data-id="heading-0">一、当时间变成刚性约束</h2>
<p>在字幕时代，“快点慢点”无所谓；人脑很宽容。但在 <strong>AI 配音视频</strong> 中，画面是固定长度的，音频必须精确贴在上面。</p>
<p>问题可以简化成一句话：</p>
<blockquote>
<p><strong>怎么把一段会伸缩的音频，塞到一段固定长度的视频里？</strong></p>
</blockquote>
<p>常见方法有四种</p>
<h3 data-id="heading-1">1. 强行缩短音频</h3>
<p>加速 TTS，让它在更短时间内说完。
缺点：语速容易变成“花栗鼠”，听感崩了。</p>
<h3 data-id="heading-2">2. 强行拉长视频</h3>
<p>冻结画面、循环几帧，或整体慢放。
缺点：有明显卡顿或“幻灯片感”。</p>
<h3 data-id="heading-3">3. 音画双向弹性</h3>
<p>让音频稍快一点、画面稍慢一点，两边都别太极端。这是本文重点。</p>
<h3 data-id="heading-4">4.（专业方案）AI 口型对齐 + 画面补帧重建</h3>
<p>如 HeyGen、Synthesia 的做法：</p>
<ul>
<li>生成与翻译声音匹配的口型</li>
<li>使用光流 / 插帧 / Diffusion 重建画面</li>
<li>甚至重新生成脸部区域</li>
</ul>
<p>这是最完美但最复杂最贵的方案, 本文不涉及</p>
<hr/>
<h2 data-id="heading-5">二、第一阶段：音频的“脱水”处理（去掉无用静音）</h2>
<p>大部分 TTS（Azure、OpenAI 等）都会在音频前后加入 200–500 ms 的静音，使停顿自然。</p>
<p>但在<strong>音画对齐工程</strong>里，这些静音是纯负担。</p>
<p>举个例子：
如果你需要压缩 500 ms 的静音，就可能导致有效语音被迫加速到 1.2 倍。</p>
<p>所以，第一步就是“脱水”——把静音剔除。</p>
<h3 data-id="heading-6">2.1 多线程静音剔除示例</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">remove_silence_wav</span>(<span class="hljs-params">path</span>):
    <span class="hljs-comment"># 用 pydub 检测并剥离首尾静音</span>
    ...

<span class="hljs-keyword">with</span> ThreadPoolExecutor(...) <span class="hljs-keyword">as</span> pool:
    <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> dubb_list:
        tasks.append(pool.submit(remove_silence_wav, d))
</code></pre>
<p>实践结果：
<strong>光是这一步，就能把整体的加速需求降低 10%–15%。</strong></p>
<hr/>
<h2 data-id="heading-7">三、第二阶段：核心算法的博弈</h2>
<p>静音去掉后，如果配音还是比原画面长，就需要进入真正的调度算法。</p>
<h3 data-id="heading-8">3.1 现阶段使用的方案：双向均摊</h3>
<p>代码中的逻辑（<code>_calculate_adjustments_allrate</code>）很朴素：
如果配音比画面长，将超出的部分对半分给音频和视频。</p>
<p>公式是：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi>t</mi><mi>a</mi><mi>r</mi><mi>g</mi><mi>e</mi><mi>t</mi></mrow></msub><mo>=</mo><msub><mi>T</mi><mrow><mi>s</mi><mi>r</mi><mi>c</mi></mrow></msub><mo>+</mo><mfrac><mrow><msub><mi>T</mi><mrow><mi>d</mi><mi>u</mi><mi>b</mi></mrow></msub><mo>−</mo><msub><mi>T</mi><mrow><mi>s</mi><mi>r</mi><mi>c</mi></mrow></msub></mrow><mn>2</mn></mfrac></mrow><annotation encoding="application/x-tex">T_{target} = T_{src} + \frac{T_{dub} - T_{src}}{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">src</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.2392em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8942em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.4159em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.1389em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">b</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span/></span></span></span></span></span><span class="mbin mtight">−</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.1389em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">src</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></p>
<p>代码简化版：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">if</span> dubb_duration &gt; source_duration:
    over = dubb_duration - source_duration
    target_duration = source_duration + over / <span class="hljs-number">2</span>

    video_for_clips.append({<span class="hljs-string">"target"</span>: target_duration})
    audio_data.append({<span class="hljs-string">"target"</span>: target_duration})
</code></pre>
<h4 data-id="heading-9">为什么这么做？</h4>
<p>因为：</p>
<ul>
<li>音频加速太多 → 难听</li>
<li>视频慢放太多 → 难看</li>
</ul>
<p>折中一下，两边都在可接受范围内。</p>
<h3 data-id="heading-10">3.2 更理想的思路：音频优先</h3>
<p>深入实践后会发现：
<strong>人耳对畸变比人眼对轻微卡顿更敏感。</strong></p>
<p>因此真正理想的逻辑应该是：</p>
<ol>
<li>
<p>先按均摊算一个目标时长</p>
</li>
<li>
<p>判断音频加速是否超过“听感红线”（≈1.25x）</p>
</li>
<li>
<p>如果超过，则：</p>
<ul>
<li><strong>优先保护音质</strong></li>
<li>允许视频更明显地慢放</li>
<li>必要时慢到 2 倍甚至 3 倍（静态画面是允许的）</li>
</ul>
</li>
</ol>
<p>目前没有这么做，是因为：</p>
<blockquote>
<p>如果不用 AI 插帧，只靠 PTS 拉伸，一旦慢放超过 2.0，画面卡顿会非常明显。</p>
</blockquote>
<p>所以暂时使用稳健的均摊策略。</p>
<p>但这是未来要升级的方向。</p>
<hr/>
<h2 data-id="heading-11">四、第三阶段：FFmpeg 的“手术级”处理</h2>
<p>算法只是决策，真正执行还得靠 FFmpeg。
经验上最容易踩的两个坑如下。</p>
<h3 data-id="heading-12">4.1 防止切片“丢帧”：tpad 的缓冲</h3>
<p>在切片+变速+重编码过程中，经常出现实际输出文件比预期时长少几帧的情况。</p>
<p>解决办法：在每段视频尾部加一个 0.1 秒的“安全气囊”：</p>
<pre><code class="hljs language-python" lang="python">-vf <span class="hljs-string">"tpad=stop_mode=clone:stop_duration=0.1,setpts={pts}*PTS"</span> -fps_mode vfr
</code></pre>
<p>好比贴瓷砖时故意多留一点边，保证不会短。</p>
<h3 data-id="heading-13">4.2 必须使用  <code>可变帧率</code></h3>
<p>视频慢放本质是拉长 <strong>PTS</strong>。
但如果忘了 <code>-fps_mode vfr</code>，FFmpeg 会为了维持固定 FPS 而丢帧或重复帧。</p>
<p>那就等于你前面的计算全白做了。</p>
<hr/>
<h2 data-id="heading-14">五、第四阶段：动态对齐</h2>
<p>即使前面计算得再准，实际合成时仍会出现微秒级误差；时间久了就会累计成秒级的“嘴不对画”。</p>
<p>所以引入一个<code>Offset 累积器</code>，不断把误差分摊到后面。</p>
<h3 data-id="heading-15">5.1 基本逻辑</h3>
<pre><code class="hljs language-python" lang="python">offset = <span class="hljs-number">0</span>
<span class="hljs-keyword">for</span> each segment:
    segment.start += offset

    real_len = actual_audio_length
    diff = video_duration - real_len

    <span class="hljs-keyword">if</span> diff &gt; <span class="hljs-number">0</span>:
        <span class="hljs-comment"># 音频比画面短，尝试消减 offset</span>
        ...
    <span class="hljs-keyword">else</span>:
        offset += (real_len - video_duration)
</code></pre>
<h3 data-id="heading-16">5.2 在视频慢放模式下的特殊情况</h3>
<p>启用了视频变速时，如果音频变短，<strong>不能用负 offset 拉回时间轴</strong>。</p>
<p>因为视频已经被拉长了，音频必须填满它，只能补静音：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">if</span> diff &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> self.shoud_videorate:
    file_list.append(self._create_silen_file(i, diff))
</code></pre>
<hr/>
<h2 data-id="heading-17">六、多种方案对比</h2>



































<table><thead><tr><th>方法</th><th>效果</th><th>成本</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>1. 强行加速音频</strong></td><td>听感差</td><td>低</td><td>不推荐</td></tr><tr><td><strong>2. 强行拉长视频</strong></td><td>卡顿明显</td><td>低</td><td>有时可用</td></tr><tr><td><strong>3. 音画双向弹性（本文方案）</strong></td><td>最平衡</td><td>低</td><td>可用</td></tr><tr><td><strong>4. AI 口型对齐 + 插帧重建</strong></td><td>最完美</td><td>高（显卡/模型/算力）</td><td>商业化方案</td></tr></tbody></table>
<p>本文重点是第 3 种。第 4 种需要高算力、3D 网格跟踪、面部重建、光流插帧等复杂技术，不在本文的工程目标范围内。</p>
<p>这套方案的目标不是“完美”，而是在<strong>有限成本下尽量做到自然</strong>。</p>
<p>总结一下思路：</p>
<ol>
<li><strong>静音剔除</strong>：减少不必要的加速成本</li>
<li><strong>双向均摊</strong>：在音质和画质之间找一个“最大公约数”</li>
<li><strong>动态对齐</strong>：用反馈机制消除累计误差</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TRAE SOLO实战录：AI应用可观测性与风险管控的破局之道]]></title>    <link>https://juejin.cn/post/7578818741699854342</link>    <guid>https://juejin.cn/post/7578818741699854342</guid>    <pubDate>2025-12-02T08:40:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578818741699854342" data-draft-id="7579063781071650870" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TRAE SOLO实战录：AI应用可观测性与风险管控的破局之道"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-02T08:40:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="七条猫"/> <meta itemprop="url" content="https://juejin.cn/user/564503296630944"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TRAE SOLO实战录：AI应用可观测性与风险管控的破局之道
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/564503296630944/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    七条猫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T08:40:21.000Z" title="Tue Dec 02 2025 08:40:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>——从"黑盒开发"到"透明化运维"的跨越</p>
<h2 data-id="heading-0"><strong>一、引言：当AI系统开始"失控"</strong></h2>
<p>2025年某头部电商平台上线智能推荐系统后，遭遇用户集体投诉：</p>
<ul>
<li>推荐内容突然聚焦于争议性商品（如高风险医疗器械）</li>
<li>模型在夜间时段出现"199元iPhone"等明显错误推荐</li>
<li>故障定位耗时72小时，损失超百万元</li>
</ul>
<p>这场事故暴露出AI开发的核心痛点：<strong>缺乏全流程质量保障体系</strong>。而TRAE SOLO的出现，为AI应用的可观测性与风险管控提供了"一站式"解决方案。</p>
<hr/>
<h2 data-id="heading-1"><strong>二、TRAE SOLO质量保障体系的三层防御</strong></h2>
<h3 data-id="heading-2"><strong>1. 开发阶段：把"黑盒"变成"玻璃盒"</strong></h3>
<h4 data-id="heading-3"><strong>(1) 任务进度追踪——让开发流程透明化</strong></h4>
<p>通过TRAE的<code>/timeline</code>接口实现：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 初始化项目时间轴</span>
trae.init_project(
    name=<span class="hljs-string">"AI_Recommender_V2"</span>,
    milestones=[
        {<span class="hljs-string">"name"</span>: <span class="hljs-string">"数据清洗"</span>, <span class="hljs-string">"deadline"</span>: <span class="hljs-string">"2024-03-20"</span>, <span class="hljs-string">"owner"</span>: <span class="hljs-string">"data_team"</span>},
        {<span class="hljs-string">"name"</span>: <span class="hljs-string">"模型训练"</span>, <span class="hljs-string">"deadline"</span>: <span class="hljs-string">"2024-03-25"</span>, <span class="hljs-string">"dependencies"</span>: [<span class="hljs-string">"数据清洗"</span>]}
    ]
)

<span class="hljs-comment"># 实时更新任务状态</span>
<span class="hljs-meta">@trae.progress_tracker</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">train_model</span>():
    <span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>):
        <span class="hljs-comment"># 模型训练代码...</span>
        trae.update_task(
            task_id=<span class="hljs-string">"model_training"</span>,
            progress=epoch/<span class="hljs-number">100</span>,
            metrics={
                <span class="hljs-string">"loss"</span>: current_loss,
                <span class="hljs-string">"accuracy"</span>: current_acc,
                <span class="hljs-string">"bias_score"</span>: compute_bias()
            }
        )
</code></pre>
<p><em>▲ 生成可视化甘特图，自动标记延期风险任务</em></p>
<h4 data-id="heading-4"><strong>(2) 代码级可观测性植入</strong></h4>
<p>在关键节点插入监控探针：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 特征工程监控示例</span>
trae.<span class="hljs-title function_">observe</span>(<span class="hljs-string">"feature_processing"</span>, {
    <span class="hljs-string">"input_shape"</span>: X_train.<span class="hljs-property">shape</span>,
    <span class="hljs-string">"feature_importance"</span>: model.<span class="hljs-property">feature_importances_</span>,
    <span class="hljs-string">"memory_usage"</span>: process.<span class="hljs-title function_">memory_info</span>().<span class="hljs-property">rss</span> / <span class="hljs-number">1024</span>**<span class="hljs-number">2</span>
});

<span class="hljs-comment">// 自动触发告警规则</span>
trae.<span class="hljs-title function_">set_alert</span>(
    <span class="hljs-attr">condition</span>: <span class="hljs-string">"memory_usage &gt; 8000"</span>,  <span class="hljs-comment">// 8GB阈值</span>
    <span class="hljs-attr">action</span>: <span class="hljs-string">"kill_process_and_notify"</span>,
    <span class="hljs-attr">severity</span>: <span class="hljs-string">"critical"</span>
);
</code></pre>
<hr/>
<h3 data-id="heading-5"><strong>2. 测试阶段：构建AI应用的"压力测试实验室"</strong></h3>
<h4 data-id="heading-6"><strong>(1) 自动生成测试脚本</strong></h4>
<p>TRAE的AI测试用例生成器可输出：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"test_suite"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"recommendation_system"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"cases"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"极端用户画像测试"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"input"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"edge_case_001"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"history"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"争议性商品A"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"争议性商品B"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"context"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"time"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"02:00"</span><span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"expected"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"recommendations"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"risk_flag"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"性能崩溃测试"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"input"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"user_count"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10000</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"expected"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"latency_p99"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&lt;500ms"</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><em>▲ 覆盖边界值、异常值、压力测试等6大场景</em></p>
<h4 data-id="heading-7"><strong>(2) 测试结果可视化分析</strong></h4>
<p>TRAE自动生成测试报告：<br/>
<img alt="测试结果热力图转存失败，建议直接上传图片文件" src="" loading="lazy"/><br/>
<em>(模拟图：显示"夜间时段推荐"功能故障率高达37%)</em></p>
<hr/>
<h3 data-id="heading-8"><strong>3. 运维阶段：智能风险防控系统</strong></h3>
<h4 data-id="heading-9"><strong>(1) 实时监控大屏</strong></h4>
<p>TRAE的<code>/dashboard</code>接口配置的关键指标：</p>

























<table><thead><tr><th>指标类别</th><th>监控项</th><th>告警阈值</th></tr></thead><tbody><tr><td>模型性能</td><td>推荐准确率</td><td>下降＞5%</td></tr><tr><td>伦理风险</td><td>争议性内容曝光率</td><td>上升＞0.3%</td></tr><tr><td>系统健康</td><td>API响应延迟(P99)</td><td>＞800ms</td></tr></tbody></table>
<h4 data-id="heading-10"><strong>(2) 自动熔断与自愈</strong></h4>
<p>当检测到异常时执行：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 熔断规则配置</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">rule_name:</span> <span class="hljs-string">"controversial_content_block"</span>
  <span class="hljs-attr">trigger:</span> <span class="hljs-string">|
    trae.metrics('risky_recommendation_rate') &gt; 0.02
</span>  <span class="hljs-attr">actions:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">"switch_to_fallback_model"</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">"collect_logs_for_analysis"</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">"notify_oncall_engineer"</span>
  <span class="hljs-attr">cooldown:</span> <span class="hljs-string">30min</span>
</code></pre>
<p><em>▲ 30秒内完成从检测到熔断的全流程</em></p>
<hr/>
<h2 data-id="heading-11"><strong>三、实战案例：电商推荐系统的重生</strong></h2>
<h3 data-id="heading-12"><strong>1. 事故复现</strong></h3>
<p>原系统存在：</p>
<ul>
<li>训练数据包含2.3万条争议性商品点击记录</li>
<li>夜间时段监控指标缺失</li>
<li>缺乏模型版本回滚机制</li>
</ul>
<h3 data-id="heading-13"><strong>2. TRAE改造方案</strong></h3>
<ol>
<li><strong>数据血缘追踪</strong>：标记所有争议性商品相关特征</li>
<li><strong>实时偏差检测</strong>：设置性别/年龄群体的推荐公平性阈值</li>
<li><strong>影子模式部署</strong>：新模型与旧模型并行运行对比</li>
</ol>
<h3 data-id="heading-14"><strong>3. 改造成果</strong></h3>





























<table><thead><tr><th>指标</th><th>改造前</th><th>改造后</th><th>改善率</th></tr></thead><tbody><tr><td>争议性内容曝光率</td><td>1.8%</td><td>0.12%</td><td>93%</td></tr><tr><td>故障定位时间</td><td>72h</td><td>18min</td><td>99.6%</td></tr><tr><td>模型迭代周期</td><td>21天</td><td>7天</td><td>67%</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-15"><strong>四、进阶技巧：TRAE的隐藏功能</strong></h2>
<h3 data-id="heading-16"><strong>1. 调试黑盒模型</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 使用TRAE的反向追踪功能</span>
suspicious_output = model.predict(x_test[<span class="hljs-number">100</span>])
trae.traceback(
    output=suspicious_output,
    depth=<span class="hljs-number">5</span>,  <span class="hljs-comment"># 追踪5层决策路径</span>
    visualize=<span class="hljs-literal">True</span>  <span class="hljs-comment"># 生成决策树图谱</span>
)
</code></pre>
<p><em>▲ 定位到第3层神经元对争议性商品有过高权重</em></p>
<h3 data-id="heading-17"><strong>2. 跨团队协作</strong></h3>
<p>通过TRAE的<code>/collaborate</code>接口实现：</p>
<ul>
<li>数据团队：标注风险数据特征</li>
<li>算法团队：调整模型约束条件</li>
<li>运维团队：设置监控告警阈值</li>
</ul>
<hr/>
<h2 data-id="heading-18"><strong>五、结语：AI质量保障的未来图景</strong></h2>
<p>TRAE SOLO正在重新定义AI开发范式：</p>
<ul>
<li><strong>从"事后救火"到"事前预防"</strong></li>
<li><strong>从"人工排查"到"智能定位"</strong></li>
<li><strong>从"单点测试"到"全链路保障"</strong></li>
</ul>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C# 中如何理解泛型]]></title>    <link>https://juejin.cn/post/7578901433971621888</link>    <guid>https://juejin.cn/post/7578901433971621888</guid>    <pubDate>2025-12-02T09:00:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578901433971621888" data-draft-id="7578902814023172111" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C# 中如何理解泛型"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-02T09:00:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大巨头"/> <meta itemprop="url" content="https://juejin.cn/user/3993841710667752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C# 中如何理解泛型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3993841710667752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大巨头
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T09:00:12.000Z" title="Tue Dec 02 2025 09:00:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">C#中如何理解泛型：从痛点到实用指南</h2>
<p>泛型是C# 2.0引入的一项革命性功能，它让代码变得"更聪明"、"更安全"、"更通用"。让我们从实际痛点出发，轻松理解这个重要概念。</p>
<h3 data-id="heading-1">为什么需要泛型？——先看痛点</h3>
<p>想象一下，你正在开发一个简单的"列表"功能：</p>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-comment">// 传统方式：为每种类型写一个列表类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">IntList</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span>[] items = <span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>[<span class="hljs-number">10</span>];
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Add</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> item</span>)</span> { <span class="hljs-comment">/*...*/</span> }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">Get</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> index</span>)</span> { <span class="hljs-comment">/*...*/</span> }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">StringList</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">string</span>[] items = <span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>[<span class="hljs-number">10</span>];
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Add</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> item</span>)</span> { <span class="hljs-comment">/*...*/</span> }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> <span class="hljs-title">Get</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> index</span>)</span> { <span class="hljs-comment">/*...*/</span> }
}
</code></pre>
<p>这太冗余了！你得为每种类型重复写同样的逻辑，而且当你要处理<code>DateTime</code>、<code>Person</code>等类型时，还得再写一遍。</p>
<p><strong>这就是泛型要解决的问题：让一个类/方法能处理多种类型，而不需要重复代码。</strong></p>
<h3 data-id="heading-2">泛型的核心思想</h3>
<p>泛型的核心是"类型参数化"——把类型本身当作参数传递给类或方法。</p>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-comment">// 泛型版本：一个类可以处理任何类型</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">GenericList</span>&lt;<span class="hljs-title">T</span>&gt;
{
    <span class="hljs-keyword">private</span> T[] items = <span class="hljs-keyword">new</span> T[<span class="hljs-number">10</span>];
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Add</span>(<span class="hljs-params">T item</span>)</span> { <span class="hljs-comment">/*...*/</span> }
    <span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">Get</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> index</span>)</span> { <span class="hljs-comment">/*...*/</span> }
}
</code></pre>
<p>这里的<code>&lt;T&gt;</code>就是类型参数，代表"泛指某种类型"。当实例化时，T会被具体类型替换：</p>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-comment">// 创建整数列表</span>
GenericList&lt;<span class="hljs-built_in">int</span>&gt; intList = <span class="hljs-keyword">new</span> GenericList&lt;<span class="hljs-built_in">int</span>&gt;();
intList.Add(<span class="hljs-number">10</span>);
intList.Add(<span class="hljs-number">20</span>);

<span class="hljs-comment">// 创建字符串列表</span>
GenericList&lt;<span class="hljs-built_in">string</span>&gt; stringList = <span class="hljs-keyword">new</span> GenericList&lt;<span class="hljs-built_in">string</span>&gt;();
stringList.Add(<span class="hljs-string">"Hello"</span>);
stringList.Add(<span class="hljs-string">"World"</span>);
</code></pre>
<h3 data-id="heading-3">为什么泛型这么重要？</h3>
<h4 data-id="heading-4">1. 代码复用性大幅提升</h4>
<p>只需写一次代码，就能处理多种类型。</p>
<h4 data-id="heading-5">2. 类型安全性增强</h4>
<p>泛型在编译时就检查类型，避免了运行时错误。</p>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-comment">// 非泛型方式：需要装箱拆箱，可能出错</span>
ArrayList list = <span class="hljs-keyword">new</span> ArrayList();
list.Add(<span class="hljs-number">10</span>);
list.Add(<span class="hljs-string">"Hello"</span>);
<span class="hljs-built_in">int</span> num = (<span class="hljs-built_in">int</span>)list[<span class="hljs-number">0</span>]; <span class="hljs-comment">// 没问题</span>
<span class="hljs-built_in">string</span> str = (<span class="hljs-built_in">string</span>)list[<span class="hljs-number">1</span>]; <span class="hljs-comment">// 没问题</span>

<span class="hljs-comment">// 泛型方式：编译时检查，安全</span>
GenericList&lt;<span class="hljs-built_in">int</span>&gt; intList = <span class="hljs-keyword">new</span> GenericList&lt;<span class="hljs-built_in">int</span>&gt;();
intList.Add(<span class="hljs-number">10</span>);
<span class="hljs-comment">// intList.Add("Hello"); // 编译错误！</span>
<span class="hljs-built_in">int</span> num = intList.Get(<span class="hljs-number">0</span>);
</code></pre>
<h4 data-id="heading-6">3. 性能优化</h4>
<p>避免了装箱拆箱操作，性能更好。</p>
<h4 data-id="heading-7">4. 代码更清晰易读</h4>
<p>类型信息明确，不需要在代码中做类型转换。</p>
<h3 data-id="heading-8">泛型的常见应用场景</h3>
<h4 data-id="heading-9">1. 泛型集合类（最常用）</h4>
<p>.NET Framework在<code>System.Collections.Generic</code>命名空间中提供了多种泛型集合类：</p>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-comment">// 泛型集合，类型安全</span>
List&lt;<span class="hljs-built_in">int</span>&gt; intList = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">int</span>&gt;();
List&lt;<span class="hljs-built_in">string</span>&gt; stringList = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">string</span>&gt;();

<span class="hljs-comment">// 非泛型集合，需要类型转换</span>
ArrayList arrayList = <span class="hljs-keyword">new</span> ArrayList();
arrayList.Add(<span class="hljs-number">10</span>);
<span class="hljs-built_in">int</span> num = (<span class="hljs-built_in">int</span>)arrayList[<span class="hljs-number">0</span>];
</code></pre>
<h4 data-id="heading-10">2. 泛型方法</h4>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-comment">// 泛型方法</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Swap</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params"><span class="hljs-keyword">ref</span> T a, <span class="hljs-keyword">ref</span> T b</span>)</span>
{
    T temp = a;
    a = b;
    b = temp;
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-built_in">int</span> x = <span class="hljs-number">10</span>, y = <span class="hljs-number">20</span>;
Swap&lt;<span class="hljs-built_in">int</span>&gt;(<span class="hljs-keyword">ref</span> x, <span class="hljs-keyword">ref</span> y); <span class="hljs-comment">// 或者直接 Swap(ref x, ref y);</span>
</code></pre>
<h4 data-id="heading-11">3. 泛型约束</h4>
<p>限制可以使用的类型，访问特定方法：</p>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">GenericClass</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-keyword">where</span> <span class="hljs-title">T</span> : <span class="hljs-title">IComparable</span>&lt;<span class="hljs-title">T</span>&gt;
{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Sort</span>(<span class="hljs-params">T[] items</span>)</span>
    {
        <span class="hljs-comment">// 可以使用IComparable&lt;T&gt;的方法</span>
        Array.Sort(items);
    }
}
</code></pre>
<h3 data-id="heading-12">泛型的简单理解口诀</h3>
<blockquote>
<p>"泛型泛指某类型，编译时定具体型。 代码复用性能好，类型安全无装箱。"</p>
</blockquote>
<h3 data-id="heading-13">从实际代码看泛型的价值</h3>
<p><strong>非泛型方式：</strong></p>
<pre><code class="hljs language-C#" lang="C#">ArrayList list = <span class="hljs-keyword">new</span> ArrayList();
list.Add(<span class="hljs-number">10</span>);
list.Add(<span class="hljs-string">"Hello"</span>);
<span class="hljs-built_in">int</span> num = (<span class="hljs-built_in">int</span>)list[<span class="hljs-number">0</span>]; <span class="hljs-comment">// 需要类型转换</span>
<span class="hljs-built_in">string</span> str = (<span class="hljs-built_in">string</span>)list[<span class="hljs-number">1</span>]; <span class="hljs-comment">// 需要类型转换</span>
</code></pre>
<p><strong>泛型方式：</strong></p>
<pre><code class="hljs language-C#" lang="C#">List&lt;<span class="hljs-built_in">int</span>&gt; intList = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">int</span>&gt;();
intList.Add(<span class="hljs-number">10</span>);
<span class="hljs-comment">// intList.Add("Hello"); // 编译错误！</span>
<span class="hljs-built_in">int</span> num = intList[<span class="hljs-number">0</span>]; <span class="hljs-comment">// 直接使用，无需转换</span>
</code></pre>
<h3 data-id="heading-14">总结</h3>
<p>泛型是C#中一个强大而优雅的特性，它让代码更加通用、安全和高效。理解泛型的关键在于：</p>
<ol>
<li><strong>把类型当作参数</strong>：<code>&lt;T&gt;</code>表示"泛指某种类型"</li>
<li><strong>编译时确定具体类型</strong>：在实例化时指定具体类型</li>
<li><strong>避免重复代码</strong>：一个类/方法处理多种类型</li>
<li><strong>增强类型安全</strong>：编译时检查，减少运行时错误</li>
</ol>
<p>当你开始使用泛型后，你会发现它几乎无处不在——从<code>List&lt;T&gt;</code>到<code>Dictionary&lt;TKey, TValue&gt;</code>，再到各种自定义泛型类和方法，泛型是C#中实现"一次编写，多处使用"的核心机制。</p>
<p><strong>记住：泛型不是魔法，而是让代码更加聪明的工具。</strong> 一旦掌握了泛型，你会发现C#代码的可读性和可维护性会有一个质的飞跃。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[运维常用基础&进阶命令（持续更新）]]></title>    <link>https://juejin.cn/post/7578968420042522687</link>    <guid>https://juejin.cn/post/7578968420042522687</guid>    <pubDate>2025-12-02T08:51:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578968420042522687" data-draft-id="7578889811333070889" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="运维常用基础&amp;进阶命令（持续更新）"/> <meta itemprop="keywords" content="运维"/> <meta itemprop="datePublished" content="2025-12-02T08:51:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="龙月"/> <meta itemprop="url" content="https://juejin.cn/user/819561001659097"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            运维常用基础&amp;进阶命令（持续更新）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/819561001659097/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    龙月
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T08:51:10.000Z" title="Tue Dec 02 2025 08:51:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、网络常用命令</h2>
<h3 data-id="heading-1">1.<code>ss</code>(Socket Statistics)</h3>
<p><code>ss</code> 直接从内核空间获取信息，比遍历 <code>/proc</code> 的 <code>netstat</code> 快得多，尤其在连接数巨大的高并发场景下。</p>
<ol>
<li>
<h4 data-id="heading-2">常用组合</h4>
</li>
</ol>
<p>最常用的参数是：<strong><code>-tulnp</code></strong></p>
<ul>
<li><strong><code>-t</code></strong> (tcp): 显示 TCP 连接</li>
<li><strong><code>-u</code></strong> (udp): 显示 UDP 连接</li>
<li><strong><code>-l</code></strong> (listening): 仅显示处于监听状态的 socket（默认只显示已建立的连接）</li>
<li><strong><code>-n</code></strong> (numeric): 不解析服务名（如显示 22 而不是 ssh，显示 IP 而不是域名），<strong>极大提升速度</strong></li>
<li><strong><code>-p</code></strong> (process): 显示哪个进程在使用该 socket（需要 sudo 权限）</li>
</ul>
<ol start="2">
<li>
<h4 data-id="heading-3">场景化实战</h4>
</li>
</ol>
<ul>
<li><strong>查看本机开启了哪些</strong> <strong>端口</strong> <strong>（服务）：</strong></li>
</ul>
<pre><code class="hljs">ss -tulnp
</code></pre>
<ul>
<li>
<p><strong>查看所有已建立的连接（不含监听）：</strong></p>
<ul>
<li>
<pre><code class="hljs language-arduino" lang="arduino">ss -tan
</code></pre>
</li>
<li><em>(注意去掉 -l，保留 -a 表示 all，或者直接不加 -l)</em></li>
</ul>
</li>
<li>
<p><strong>统计连接状态（非常有用，看服务器负载）：</strong></p>
<ul>
<li>
<pre><code class="hljs">ss -s
</code></pre>
</li>
<li><em>输出会告诉你当前有多少个</em> <em>TCP</em> <em>连接，多少个处于 ESTABLISHED，多少个 TIME-WAIT。</em></li>
</ul>
</li>
<li>
<p><strong>高级过滤（骚操作）：</strong></p>
<ul>
<li>查找所有连接到远程 8080 端口的连接：</li>
<li>
<pre><code class="hljs">ss -nt dst :8080
</code></pre>
</li>
<li>查找状态为“已建立”的连接：</li>
<li>
<pre><code class="hljs language-perl" lang="perl">ss -t <span class="hljs-keyword">state</span> established
</code></pre>
</li>
<li>查找状态为 TIME-WAIT 的连接（排查高并发连接释放问题）：</li>
<li>
<pre><code class="hljs language-perl" lang="perl">ss -t <span class="hljs-keyword">state</span> <span class="hljs-keyword">time</span>-<span class="hljs-keyword">wait</span>
</code></pre>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-4">前世前辈 —— <code>netstat</code></h3>
<p>虽然已被 <code>ss</code> 取代，但很多老系统或脚本中依然存在，必须看懂。</p>
<ul>
<li><strong>常用组合：</strong> <code>netstat -tulnp</code> (参数含义与 ss 完全一致)</li>
<li><strong>核心区别：</strong> <code>netstat</code> 如果不加 <code>-n</code>，会尝试反向解析 DNS，导致命令卡顿半天，切记加上 <code>-n</code>。</li>
<li><strong>查看</strong> <strong>路由表</strong> <strong>：</strong> <code>netstat -rn</code> (现在推荐用 <code>ip route</code>)</li>
</ul>
<h3 data-id="heading-5">2.<code>lsof</code> (List Open Files)</h3>
<p>在 Linux 中“一切皆文件”，网络 Socket 也是文件。<code>ss</code> 是从网络角度看进程，<code>lsof</code> 是从文件/进程角度看网络。</p>
<ol start="3">
<li>
<h4 data-id="heading-6">核心参数</h4>
</li>
</ol>
<ul>
<li><strong><code>-i</code></strong>: 列出符合条件的网络文件</li>
<li><strong><code>-p</code></strong>: 指定 PID</li>
<li><strong><code>-n</code></strong>: 不解析主机名（提速）</li>
</ul>
<ol start="4">
<li>
<h4 data-id="heading-7">场景化实战</h4>
</li>
</ol>
<ul>
<li><strong>谁占用了 80</strong> <strong>端口</strong> <strong>？（比</strong> <strong>ss</strong> <strong>更直观地找凶手）</strong></li>
</ul>
<pre><code class="hljs language-css" lang="css">lsof -<span class="hljs-selector-tag">i</span> :<span class="hljs-number">80</span>
</code></pre>
<ul>
<li>
<p><strong>某个进程（</strong> <strong>PID</strong> <strong>1234）打开了哪些网络连接？</strong></p>
<ul>
<li>
<pre><code class="hljs language-css" lang="css">lsof -<span class="hljs-selector-tag">p</span> <span class="hljs-number">1234</span> -<span class="hljs-selector-tag">a</span> -<span class="hljs-selector-tag">i</span>
</code></pre>
</li>
<li><em>(</em> <em><code>-a</code></em> <em>表示 AND，即同时满足</em> <em>PID</em> <em>1234 和 网络连接)</em></li>
</ul>
</li>
<li>
<p><strong>查看特定用户的网络活动：</strong></p>
</li>
</ul>
<pre><code class="hljs language-css" lang="css">lsof -u username -<span class="hljs-selector-tag">i</span>
</code></pre>
<ul>
<li><strong>恢复删除的文件（高阶技巧）：</strong> 如果日志文件被 <code>rm</code> 了但进程没重启，空间不释放，可以用 <code>lsof | grep deleted</code> 找到句柄恢复。</li>
</ul>
<h3 data-id="heading-8">3.<code>ip</code> &amp; <code>tcpdump</code></h3>
<h4 data-id="heading-9">1. <code>ip</code> 命令 (iproute2 套件)</h4>
<p>用来取代 <code>ifconfig</code> 和 <code>route</code>。</p>
<ul>
<li>
<p><strong>查看</strong> <strong>IP</strong> <strong>地址：</strong></p>
<ul>
<li>
<pre><code class="hljs language-css" lang="css">ip addr (或 ip <span class="hljs-selector-tag">a</span>)
</code></pre>
</li>
<li><em>对比</em> <em>ifconfig</em> <em>，它能看到</em> <em>secondary</em> **<em>IP</em> <em>。</em></li>
</ul>
</li>
<li>
<p><strong>查看/操作</strong> <strong>路由表</strong> <strong>：</strong></p>
</li>
</ul>
<pre><code class="hljs">ip route
</code></pre>
<ul>
<li><strong>查看网络邻居 (</strong> <strong>ARP</strong> <strong>表)：</strong></li>
</ul>
<pre><code class="hljs">ip neigh
</code></pre>
<ul>
<li><strong>查看接口统计（丢包、错误）：</strong></li>
</ul>
<pre><code class="hljs language-bash" lang="bash">ip -s <span class="hljs-built_in">link</span>
</code></pre>
<h4 data-id="heading-10">2. <code>tcpdump</code> (网络抓包神器)</h4>
<p>当 <code>ss</code> 告诉你连接存在，但通不通、数据对不对时，就需要抓包。</p>
<ul>
<li><strong>基础</strong> <strong>抓包</strong> <strong>（抓 eth0</strong> <strong>网卡</strong> <strong>）：</strong></li>
</ul>
<pre><code class="hljs language-css" lang="css">tcpdump -<span class="hljs-selector-tag">i</span> eth0
</code></pre>
<ul>
<li><strong>生产环境防刷屏（重要）：</strong></li>
</ul>
<pre><code class="hljs language-css" lang="css">tcpdump -<span class="hljs-selector-tag">i</span> eth0 -nn port <span class="hljs-number">80</span>
</code></pre>
<ul>
<li><strong>抓特定</strong> <strong>IP</strong> <strong>的包：</strong></li>
</ul>
<pre><code class="hljs language-css" lang="css">tcpdump -<span class="hljs-selector-tag">i</span> eth0 host <span class="hljs-number">192.168</span>.<span class="hljs-number">1.5</span>
</code></pre>
<ul>
<li><strong>保存为文件（供 Wireshark 分析）：</strong></li>
</ul>
<pre><code class="hljs language-css" lang="css">tcpdump -<span class="hljs-selector-tag">i</span> eth0 -w capture<span class="hljs-selector-class">.pcap</span>
</code></pre>
<h3 data-id="heading-11">4. <code>nc</code> &amp; <code>curl</code>——网络连通性测试</h3>
<h4 data-id="heading-12">1. <code>nc</code> (Netcat) - 网络瑞士军刀</h4>
<ul>
<li><strong>测试</strong> <strong>端口</strong> <strong>通不通（替代</strong> <strong>telnet</strong> <strong>）：</strong></li>
</ul>
<pre><code class="hljs">nc -v -z 192.168.1.1 80
</code></pre>
<ul>
<li>
<p><strong>临时建立一个聊天/传输通道：</strong></p>
<ul>
<li>服务端：<code>nc -l 1234</code></li>
<li>客户端：<code>nc IP地址 1234</code></li>
</ul>
</li>
</ul>
<h4 data-id="heading-13">2. <code>curl</code> - HTTP 测试</h4>
<h5 data-id="heading-14">1.基本使用与输出控制</h5>
<ul>
<li><strong>查看详细的连接过程（</strong> <strong>DNS</strong> <strong>耗时、握手耗时）：</strong></li>
</ul>
<pre><code class="hljs language-swift" lang="swift">curl <span class="hljs-operator">-</span>w <span class="hljs-string">"<span class="hljs-subst">\n</span>DNS: %{time_namelookup}s<span class="hljs-subst">\n</span>Connect: %{time_connect}s<span class="hljs-subst">\n</span>Total: %{time_total}s<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">-</span>o <span class="hljs-operator">/</span>dev<span class="hljs-operator">/</span>null <span class="hljs-operator">-</span>s http:<span class="hljs-comment">//www.google.com</span>
</code></pre>
<ul>
<li><strong>测试由 Header 引起的访问问题：</strong></li>
</ul>
<pre><code class="hljs language-arduino" lang="arduino">curl -I http:<span class="hljs-comment">//example.com</span>
</code></pre>
<p><em>(</em> <em><code>-I</code></em> <em>只抓取 Header)</em></p>
<h5 data-id="heading-15"><strong>2.HTTP 请求定制</strong></h5>
<p><strong>指定方法：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">curl -X POST https:<span class="hljs-comment">//api.example.com/items</span>
</code></pre>
<p><strong>说明：</strong> 强制请求方法。多数情况下用 <code>-d</code> 会自动变成 POST。</p>
<ul>
<li><strong>请求头：</strong></li>
</ul>
<pre><code class="hljs language-arduino" lang="arduino">curl -H <span class="hljs-string">"Content-Type: application/json"</span> \
     -H <span class="hljs-string">"Authorization: Bearer &lt;token&gt;"</span> \
     https:<span class="hljs-comment">//api.example.com/items</span>
</code></pre>
<p><strong>说明：</strong> <code>-H</code>添加自定义头。适合模拟前端/客户端请求。</p>
<ul>
<li><strong>发送表单或</strong> <strong>JSON</strong> <strong>：</strong></li>
</ul>
<pre><code class="hljs language-json" lang="json"># x-www-form-urlencoded
curl -d <span class="hljs-string">"name=alice&amp;age=30"</span> https<span class="hljs-punctuation">:</span><span class="hljs-comment">//api.example.com/users</span>

# JSON
curl -H <span class="hljs-string">"Content-Type: application/json"</span> \
     -d '<span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"alice"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"age"</span><span class="hljs-punctuation">:</span><span class="hljs-number">30</span><span class="hljs-punctuation">}</span>' \
     https<span class="hljs-punctuation">:</span><span class="hljs-comment">//api.example.com/users</span>
</code></pre>
<p><strong>说明：</strong> <code>-d</code>会设置 <code>Content-Type</code> 为表单并切换到 POST；发送 JSON 时需手动设头。</p>
<ul>
<li><strong>多部分上传（文件）：</strong></li>
</ul>
<pre><code class="hljs language-arduino" lang="arduino">curl -F <span class="hljs-string">"file=@/path/to/report.pdf"</span> \
     -F <span class="hljs-string">"meta=Q3"</span> \
     https:<span class="hljs-comment">//api.example.com/upload</span>
</code></pre>
<p><strong>说明：</strong> <code>-F</code>按 multipart/form-data 上传文件与字段。</p>
<ul>
<li><strong>Cookies：</strong></li>
</ul>
<p>代码</p>
<pre><code class="hljs language-arduino" lang="arduino">curl --cookie <span class="hljs-string">"sid=abc123"</span> https:<span class="hljs-comment">//example.com</span>
curl --cookie-jar cookies.txt https:<span class="hljs-comment">//example.com/login</span>
curl --cookie cookies.txt https:<span class="hljs-comment">//example.com/profile</span>
</code></pre>
<p><strong>说明：</strong> 管理会话或跨请求登录态。</p>
<ul>
<li><strong>压缩与解压：</strong></li>
</ul>
<p>代码</p>
<pre><code class="hljs language-arduino" lang="arduino">curl --compressed https:<span class="hljs-comment">//api.example.com/list</span>
</code></pre>
<ul>
<li><strong>说明：</strong> 自动协商并解压 gzip/deflate 响应</li>
</ul>
<h5 data-id="heading-16">3.认证、代理与安全</h5>
<ul>
<li><strong>基本认证：</strong></li>
</ul>
<pre><code class="hljs language-arduino" lang="arduino">curl -u username:password https:<span class="hljs-comment">//api.example.com/private</span>
</code></pre>
<ul>
<li><strong>Bearer 令牌：</strong></li>
</ul>
<pre><code class="hljs language-arduino" lang="arduino">curl -H <span class="hljs-string">"Authorization: Bearer &lt;token&gt;"</span> https:<span class="hljs-comment">//api.example.com/private</span>
</code></pre>
<ul>
<li><strong>代理（HTTP/</strong> <strong>SOCKS）：</strong></li>
</ul>
<pre><code class="hljs language-bash" lang="bash">curl -x http://proxy.local:8080 https://example.com
curl --socks5-hostname 127.0.0.1:1080 https://example.com
</code></pre>
<ul>
<li><strong>TLS 选项（谨慎使用）：</strong></li>
</ul>
<pre><code class="hljs language-bash" lang="bash">curl --cacert ca.pem https://secure.example.com
curl -k https://self-signed.local    <span class="hljs-comment"># 跳过证书校验（不建议生产）</span>
</code></pre>
<h5 data-id="heading-17">4.下载、续传与性能</h5>
<ul>
<li><strong>断点续传：</strong></li>
</ul>
<pre><code class="hljs language-arduino" lang="arduino">curl -C - -O https:<span class="hljs-comment">//example.com/bigfile.zip</span>
</code></pre>
<ul>
<li><strong>限速与并发（进阶）：</strong></li>
</ul>
<pre><code class="hljs language-arduino" lang="arduino">curl --limit-rate <span class="hljs-number">1</span>M -O https:<span class="hljs-comment">//example.com/video.mp4</span>
</code></pre>
<ul>
<li><strong>只取响应头：</strong></li>
</ul>
<pre><code class="hljs language-arduino" lang="arduino">curl -I https:<span class="hljs-comment">//example.com</span>
</code></pre>
<ul>
<li><strong>详细调试输出：</strong></li>
</ul>
<pre><code class="hljs language-c" lang="c">curl -v https:<span class="hljs-comment">//example.com</span>
curl --trace-ascii trace.<span class="hljs-built_in">log</span> https:<span class="hljs-comment">//example.com</span>
</code></pre>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">-X 指定方法（GET/POST/PUT/PATCH/DELETE）</span>
<span class="hljs-deletion">-H 添加请求头</span>
<span class="hljs-deletion">-d 发送请求体（表单或 JSON）并切换为 POST</span>
<span class="hljs-deletion">-F 发送 multipart/form-data（文件/字段）</span>
<span class="hljs-deletion">-I 仅请求响应头</span>
<span class="hljs-deletion">-L 跟随重定向</span>
<span class="hljs-deletion">-o/-O 保存输出（自定义/远端文件名）</span>
<span class="hljs-deletion">-C - 断点续传</span>
<span class="hljs-deletion">-u 基本认证</span>
<span class="hljs-deletion">--cookie/--cookie-jar Cookies 管理</span>
<span class="hljs-deletion">--compressed 启用压缩</span>
<span class="hljs-deletion">-x/--socks5-hostname 代理</span>
<span class="hljs-deletion">-k/--cacert TLS 校验控制</span>
<span class="hljs-deletion">-s/-v/--trace 静默/详细/跟踪</span>
<span class="hljs-deletion">--limit-rate 限速</span>
<span class="hljs-deletion">--max-time 全局超时</span>
<span class="hljs-deletion">--retry/--retry-delay/--retry-max-time 自动重试策略</span>
<span class="hljs-deletion">--data-urlencode 对表单字段进行 URL 编码</span>
<span class="hljs-deletion">--http2/--http3 指定协议版本（依平台构建而定）</span>
</code></pre>
<p><strong>大量文件下载、断点续传、递归镜像网站、后台任务</strong>：选 wget。</p>
<ol>
<li>
<p><strong>Level 1 (生存必备):</strong></p>
<ol>
<li><code>ss -tulnp</code> (看端口)</li>
<li><code>ip a</code> (看IP)</li>
<li><code>ping</code> (看连通性)</li>
</ol>
</li>
<li>
<p><strong>Level 2 (运维排障):</strong></p>
<ol>
<li><code>lsof -i :端口号</code> (查占用)</li>
<li><code>curl -v</code> (调试 HTTP)</li>
<li><code>ss -s</code> (看连接概况)</li>
</ol>
</li>
<li>
<p><strong>Level 3 (专家调试):</strong></p>
<ol>
<li><code>tcpdump -nn ...</code> (抓包分析)</li>
<li><code>ss state established</code> (精细化连接分析)</li>
</ol>
</li>
</ol>
<h2 data-id="heading-18">二、资源管理常用命令</h2>
<h3 data-id="heading-19">1.<code>top</code> &amp; <code>htop</code></h3>
<ol>
<li>
<h4 data-id="heading-20">经典老将：<code>top</code></h4>
</li>
</ol>
<p>所有 Linux 发行版必带，必须熟练掌握交互快捷键。</p>
<ul>
<li>
<p><strong>常用启动：</strong></p>
<ul>
<li>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">top</span>
</code></pre>
</li>
<li><em>(或者</em> <em><code>top -c</code></em> <em>显示完整的命令行路径，而不仅仅是进程名)</em></li>
</ul>
</li>
<li>
<p><strong>交互式快捷键（神器）：</strong></p>
<ul>
<li><strong><code>1</code></strong> (数字1): 展开显示所有 CPU 核心的负载（看是不是单核被打满）。</li>
<li><strong><code>M</code></strong> (Shift+m): 按 <strong>内存</strong> 使用率排序（找内存泄漏）。</li>
<li><strong><code>P</code></strong> (Shift+p): 按 <strong>CPU</strong> 使用率排序（默认）。</li>
<li><strong><code>c</code></strong>: 切换显示完整命令路径。</li>
<li><strong><code>k</code></strong>: 输入 PID 杀死进程。</li>
</ul>
</li>
<li>
<p><strong>关键指标解读：</strong></p>
<ul>
<li>
<p><strong>Load Average:</strong> <code>1.00, 0.50, 0.20</code>（1分钟、5分钟、15分钟平均负载）。</p>
<ul>
<li><em>经验值：如果数值超过了 CPU 核心数，说明系统过载了。</em></li>
</ul>
</li>
<li>
<p><strong>%Cpu(s):</strong></p>
<ul>
<li><code>us</code> (user): 用户空间占用（高通常是业务代码运算多）。</li>
<li><code>sy</code> (system): 内核空间占用（高通常是系统调用多，如频繁 I/O）。</li>
<li><strong><code>wa</code></strong> <strong>(iowait): 等待磁盘</strong> <strong>I/O</strong> <strong>的时间（重点！如果这个高，说明磁盘是瓶颈）。</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
<ol start="2">
<li>
<h4 data-id="heading-21">视觉系新秀：<code>htop</code></h4>
</li>
</ol>
<p>如果系统允许安装，<strong>强烈推荐</strong>用 <code>htop</code> 代替 <code>top</code>。它支持鼠标点击、颜色区分、图形化显示 CPU 条，直观度大幅提升。</p>
<h3 data-id="heading-22">2. <code>free</code>——内存管理</h3>
<p>当你怀疑服务器变慢是因为内存不足时，看这里。</p>
<ol>
<li>
<h4 data-id="heading-23">常用命令</h4>
</li>
</ol>
<ul>
<li><strong>以人类可读格式查看</strong> <strong>内存</strong> <strong>：</strong></li>
</ul>
<pre><code class="hljs language-c" lang="c"><span class="hljs-built_in">free</span> -h
</code></pre>
<ul>
<li>
<p><strong>如何判断</strong> <strong>内存</strong> <strong>真不够了？</strong> 不要只看 <code>free</code> 那一列！Linux 喜欢把空闲内存拿来做缓存。</p>
<ul>
<li><strong>重点看</strong> <strong><code>available</code></strong> <strong>这一列：</strong> 这才是你真正应用程序可以调用的剩余内存。</li>
<li><strong>看</strong> <strong><code>buff/cache</code></strong> <strong>：</strong> 如果这部分很大，free 很小，通常没事，系统会自动释放 cache 给程序用。</li>
<li><strong>看</strong> <strong><code>Swap</code></strong> <strong>：</strong> 如果 <code>Swap</code> 的 <code>used</code> 很大且在不断变化，说明内存严重不足，系统在频繁读写硬盘交换区，由于硬盘速度远慢于内存，机器会卡死。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-24">3.<code>df</code> &amp; <code>du</code>—— 磁盘空间与文件</h3>
<p>这两个命令区别在于<code>df</code> 看房子的总面积，<code>du</code> 看某个房间里的家具占地。</p>
<h4 data-id="heading-25">1. <code>df</code> (Disk Free) - 宏观视角</h4>
<ul>
<li><strong>查看磁盘挂载点和使用率：</strong></li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">df</span> -Th
</code></pre>
<ul>
<li>
<p><strong>排查问题：</strong> 如果 <code>df -h</code> 显示磁盘没满，但无法写入文件，可能是 <strong>Inode</strong> 满了（小文件太多）。</p>
<ul>
<li>查看 Inode 使用率：<code>df -i</code></li>
</ul>
</li>
</ul>
<h4 data-id="heading-26">2. <code>du</code> (Disk Usage) - 微观视角</h4>
<ul>
<li><strong>当前目录下哪个文件夹最大？（找出吃磁盘的元凶）：</strong></li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">du</span> -sh * | <span class="hljs-built_in">sort</span> -rh
</code></pre>
<h3 data-id="heading-27">4.<code>iostat</code> &amp; <code>iotop</code> —— 磁盘 I/O 瓶颈</h3>
<p>当 <code>top</code> 里的 <code>%wa</code> (iowait) 很高时，用这组命令抓出是谁在疯狂读写硬盘。</p>
<h4 data-id="heading-28">1. <code>iostat</code> (属于 sysstat 包)</h4>
<ul>
<li><strong>查看所有磁盘的吞吐和繁忙度（黄金参数）：</strong></li>
</ul>
<pre><code class="hljs">iostat -xz 1
</code></pre>
<ul>
<li>
<p><strong>核心指标解读：</strong></p>
<ul>
<li><strong><code>%util</code></strong>: 磁盘利用率。如果接近 100%，说明磁盘已经满负荷运转，必须优化或换盘。</li>
<li><strong><code>await</code></strong>: I/O 请求的平均等待时间（毫秒）。如果这个值很大（如 &gt;10ms 甚至上百），说明磁盘响应慢。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-29">2. <code>iotop</code></h4>
<p>类似于 <code>top</code>，但是专门按 <strong>磁盘</strong> <strong>I/O</strong> 排序进程。</p>
<ul>
<li><strong>查看是谁在读写硬盘：</strong></li>
</ul>
<pre><code class="hljs">iotop -o
</code></pre>
<h3 data-id="heading-30">5. <code>vmstat</code> &amp; <code>dmesg</code>——系统综合快照</h3>
<h4 data-id="heading-31">1. <code>vmstat</code> (Virtual Memory Statistics)</h4>
<p>虽然名字叫虚拟内存，但它其实是查看 CPU、内存、I/O 的综合报表，适合脚本监控。</p>
<ul>
<li><strong>每秒刷新一次系统状态：</strong></li>
</ul>
<pre><code class="hljs">vmstat 1
</code></pre>
<h4 data-id="heading-32">2. <code>dmesg</code> (Kernel Ring Buffer)</h4>
<ul>
<li><strong>查看内核日志（硬件故障、</strong> <strong>OOM</strong> <strong>Killer）：</strong> 如果进程突然莫名其妙消失了，很可能是内存溢出被系统杀掉了。</li>
</ul>
<pre><code class="hljs language-perl" lang="perl">dmesg -T | <span class="hljs-keyword">grep</span> -i <span class="hljs-string">"kill"</span>
</code></pre>
<ol>
<li>
<p><strong>Level 1 (系统卡顿先看它):</strong></p>
<ol>
<li><code>top</code> (看 Load Average, CPU %, wait %)</li>
<li><code>free -h</code> (看内存剩多少，Swap 用没用)</li>
<li><code>df -Th</code> (看磁盘是不是满了)</li>
</ol>
</li>
<li>
<p><strong>Level 2 (找出谁在捣乱):</strong></p>
<ol>
<li><code>du -sh *</code> (磁盘满了，找大文件)</li>
<li><code>iotop</code> (磁盘慢了，找读写进程)</li>
<li><code>top</code> 按 <code>M</code> (找吃内存进程)</li>
</ol>
</li>
<li>
<p><strong>Level 3 (深层分析):</strong></p>
<ol>
<li><code>iostat -xz 1</code> (分析磁盘具体的饱和度)</li>
<li><code>dmesg | grep error</code> (看有没有硬件报错)</li>
<li><code>sar</code> (查看历史性能数据，如果不安装 sysstat 包可能没有)</li>
</ol>
</li>
</ol>
<p><strong>一个小技巧：</strong> 如果你发现系统很慢，但 CPU、内存、磁盘 I/O 看起来都正常，请检查 <strong>打开文件数限制</strong>： <code>ulimit -n</code></p>
<p><code>Ulimit -a</code>显示当前所有资源限制 很多时候服务起不来或者报错，是因为达到了最大文件句柄限制（默认通常是 1024，生产环境通常需要调大）。</p>
<h2 data-id="heading-33">三、搜索常用命令</h2>
<h3 data-id="heading-34">1.grep内容搜索</h3>
<h4 data-id="heading-35">1.基础搜索</h4>
<p>最常用的场景：在一个文件或一堆文件里找个关键词。</p>
<ol>
<li><strong>黄金组合参数：</strong> <strong><code>-rni</code></strong></li>
</ol>
<ul>
<li><strong><code>-r</code></strong> (recursive): 递归查找，不光找当前目录，还找子目录。</li>
<li><strong><code>-n</code></strong> (line number): 显示行号，告诉你关键词在哪一行。</li>
<li><strong><code>-i</code></strong> (ignore case): 忽略大小写（找 "Error" 时也能把 "error" 揪出来）。</li>
</ul>
<ol start="2">
<li><strong>场景化实战</strong></li>
</ol>
<ul>
<li><strong>在当前目录及子目录下，查找所有包含 "password" 的文件：</strong></li>
</ul>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">grep</span> -rni <span class="hljs-string">"password"</span> .
</code></pre>
<ul>
<li><strong>在单个文件中查找：</strong></li>
</ul>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">grep</span> -i <span class="hljs-string">"error"</span> /var/<span class="hljs-keyword">log</span>/syslog
</code></pre>
<hr/>
<h4 data-id="heading-36">2.上下文控制</h4>
<p>这是 <code>grep</code> 最强大的功能之一。当你搜到 "Exception" 时，只看这一行通常没用，你需要看它<strong>上面</strong>发生了什么，以及<strong>下面</strong>的堆栈信息。</p>
<ol>
<li><strong>记忆口诀：ABC</strong></li>
</ol>
<ul>
<li><strong><code>-A</code></strong> (After): 显示匹配行之后的 n 行。</li>
<li><strong><code>-B</code></strong> (Before): 显示匹配行之前的 n 行。</li>
<li><strong><code>-C</code></strong> (Context): 显示匹配行前后各 n 行。</li>
</ul>
<ol start="2">
<li><strong>场景化实战</strong></li>
</ol>
<ul>
<li><strong>查看报错后的 10 行堆栈信息（最常用）：</strong></li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">grep -A <span class="hljs-number">10</span> <span class="hljs-string">"NullPointerException"</span> catalina.<span class="hljs-keyword">out</span>
</code></pre>
<ul>
<li><strong>查看报错前后各 5 行，分析上下文：</strong></li>
</ul>
<pre><code class="hljs language-c" lang="c">grep -C <span class="hljs-number">5</span> <span class="hljs-string">"Critical Error"</span> application.<span class="hljs-built_in">log</span>
</code></pre>
<hr/>
<h4 data-id="heading-37">3.精准过滤</h4>
<p>有时候搜出来的东西太多，或者太模糊，需要提纯。</p>
<ol>
<li><strong>反向过滤：</strong> <strong><code>-v</code></strong> <strong>(Invert)</strong></li>
</ol>
<ul>
<li><strong>场景：</strong> 查看配置文件，但是不想看被 <code>#</code> 注释掉的行，也不想看空行。</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">grep -v <span class="hljs-string">"^#"</span> /etc/nginx/nginx.conf | grep -v <span class="hljs-string">"^$"</span>
</code></pre>
<ol start="2">
<li><strong>精确单词匹配：</strong> <strong><code>-w</code></strong> <strong>(Word)</strong></li>
</ol>
<ul>
<li><strong>场景：</strong> 你想搜变量 <code>is</code>，但 <code>grep</code> 会把 <code>this</code>, <code>list</code>, <code>history</code> 全给你搜出来。</li>
</ul>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">grep</span> -w <span class="hljs-string">"is"</span> code.py
</code></pre>
<ol start="3">
<li><strong>只要匹配的内容：</strong> <strong><code>-o</code></strong> <strong>(Only matching)</strong></li>
</ol>
<ul>
<li><strong>场景：</strong> 只需要提取日志中的 IP 地址，不需要整行内容。</li>
</ul>
<pre><code class="hljs language-css" lang="css">grep -o "<span class="hljs-selector-attr">[0-9]</span>{<span class="hljs-number">1</span>,<span class="hljs-number">3</span>}.<span class="hljs-selector-attr">[0-9]</span>{<span class="hljs-number">1</span>,<span class="hljs-number">3</span>}.<span class="hljs-selector-attr">[0-9]</span>{<span class="hljs-number">1</span>,<span class="hljs-number">3</span>}.<span class="hljs-selector-attr">[0-9]</span>{<span class="hljs-number">1</span>,<span class="hljs-number">3</span>}" access<span class="hljs-selector-class">.log</span>
</code></pre>
<hr/>
<h4 data-id="heading-38">4.统计与文件名 —— 宏观视角</h4>
<ol>
<li><strong>只看文件名：</strong> <strong><code>-l</code></strong> <strong>(List)</strong></li>
</ol>
<ul>
<li><strong>场景：</strong> 你不需要看代码具体内容，只想知道<strong>哪些文件</strong>里调用了 <code>getUserInfo</code> 这个函数。</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">grep -r -l <span class="hljs-string">"getUserInfo"</span> ./src
</code></pre>
<ol start="2">
<li><strong>统计出现次数：</strong> <strong><code>-c</code></strong> <strong>(Count)</strong></li>
</ol>
<ul>
<li><strong>场景：</strong> 今天发生了多少次 404 错误？</li>
</ul>
<pre><code class="hljs language-c" lang="c">grep -c <span class="hljs-string">"404 Not Found"</span> access.<span class="hljs-built_in">log</span>
</code></pre>
<hr/>
<h4 data-id="heading-39">5.高阶正则 —— <code>-E</code> &amp; <code>-F</code></h4>
<ol>
<li><strong>扩展正则：</strong> <strong><code>-E</code></strong> <strong>(Extended)</strong></li>
</ol>
<p>默认的 <code>grep</code> 支持的基础正则比较弱，使用 <code>|</code> (或)、<code>+</code> (一个或多个) 等符号时需要转义。加上 <code>-E</code> 就解放了（相当于命令 <code>egrep</code>）。</p>
<ul>
<li><strong>同时搜两个关键词（"Error" 或者 "Warning"）：</strong></li>
</ul>
<pre><code class="hljs language-c" lang="c">grep -E <span class="hljs-string">"Error|Warning"</span> app.<span class="hljs-built_in">log</span>
</code></pre>
<ul>
<li><strong>搜 8000 到 8999 的端口号：</strong></li>
</ul>
<pre><code class="hljs language-arduino" lang="arduino">grep -E <span class="hljs-string">"8[0-9]{3}"</span> config.xml
</code></pre>
<ol start="2">
<li><strong>固定字符串：</strong> <strong><code>-F</code></strong> <strong>(Fixed)</strong></li>
</ol>
<ul>
<li><strong>场景：</strong> 你要搜索的内容里包含大量的 <code>.</code> <code>*</code> <code>[</code> 等特殊字符，你不想让 grep 把它们当正则处理，只想当普通字符搜。</li>
<li><strong>优势：</strong> 速度极快。</li>
</ul>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">grep</span> -F <span class="hljs-string">"user[0]"</span> script.sh
</code></pre>
<p>按照<strong>使用频率</strong>排序的学习路径：</p>
<ol>
<li>
<p><strong>Level 1 (每天都用):</strong></p>
<ol>
<li><code>grep "text" file</code> (基础搜)</li>
<li><code>grep -rni "text" .</code> (递归搜代码/配置)</li>
<li><code>ps aux | grep java</code> (查进程，配合管道)</li>
</ol>
</li>
<li>
<p><strong>Level 2 (日志分析):</strong></p>
<ol>
<li><code>grep -v "info" log</code> (排除干扰信息)</li>
<li><code>grep -A 10 "error" log</code> (看报错堆栈)</li>
<li><code>grep -E "error|warn" log</code> (搜多个词)</li>
</ol>
</li>
<li>
<p><strong>Level 3 (数据提取):</strong></p>
<ol>
<li><code>grep -o</code> (配合正则提取 IP、邮箱)</li>
<li><code>grep -l</code> (只找文件名，配合 <code>xargs</code> 做批量修改)</li>
</ol>
</li>
</ol>
<p><strong>一个经典的“骚操作”组合：</strong> 找出所有包含 "TODO" 的代码文件，并显示行号，最后只保留最近修改过的文件（需配合 <code>ls</code> 或 <code>find</code>，这里展示 grep 配合管道）：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 在当前目录递归搜 TODO，显示颜色，显示行号</span>
grep -rni <span class="hljs-attr">--color</span>=auto <span class="hljs-string">"TODO"</span> .
</code></pre>
<p><strong>小贴士：</strong> 如果你的文件是<strong>二进制文件</strong>（在这堆乱码里搜字符串），grep 可能会提示 "Binary file matches"。加上 <strong><code>-a</code></strong> 参数可以将二进制文件当作文本文件处理： <code>grep -a "string" binary_file</code></p>
<h3 data-id="heading-40">2.find文件搜索</h3>
<ol>
<li>
<h4 data-id="heading-41">基础搜索：名字与类型</h4>
</li>
</ol>
<ul>
<li><strong>按文件名找（最常用）：</strong></li>
</ul>
<pre><code class="hljs language-arduino" lang="arduino">find /etc -name <span class="hljs-string">"nginx.conf"</span>
</code></pre>
<ul>
<li><strong>只找目录或文件：</strong></li>
</ul>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-built_in">find</span> . -<span class="hljs-built_in">type</span> d -name <span class="hljs-string">"config"</span>
</code></pre>
<ol start="2">
<li>
<h4 data-id="heading-42">时间角度：按时间搜索</h4>
</li>
</ol>
<p>这是运维排查问题的<strong>核心技能</strong>。比如：找最近被黑客修改过的文件，或者找一年前的旧日志删除。</p>
<ul>
<li>
<p><strong>参数口诀：</strong></p>
<ul>
<li><code>-mtime</code> (Modify Time): 内容修改时间。</li>
<li><strong><code>-n</code></strong>: n 天<strong>以内</strong>（Newer）。</li>
<li><strong><code>+n</code></strong>: n 天<strong>以前</strong>（Older）。</li>
</ul>
</li>
<li>
<p><strong>场景化实战：</strong></p>
<ul>
<li><strong>找最近 24 小时内被修改过的文件：</strong></li>
<li>
<pre><code class="hljs language-arduino" lang="arduino">find /var/www -mtime <span class="hljs-number">-1</span>
</code></pre>
</li>
<li><strong>找 7 天以前的旧日志：</strong></li>
<li>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-built_in">find</span> /var/<span class="hljs-built_in">log</span> -name <span class="hljs-string">"*.log"</span> -mtime +<span class="hljs-number">7</span>
</code></pre>
</li>
</ul>
</li>
</ul>
<ol start="3">
<li>
<h4 data-id="heading-43">空间管理：按大小搜索</h4>
</li>
</ol>
<ul>
<li><strong>找大文件（清理磁盘必备）：</strong></li>
</ul>
<pre><code class="hljs language-matlab" lang="matlab"><span class="hljs-built_in">find</span> / -<span class="hljs-built_in">type</span> f -<span class="hljs-built_in">size</span> +<span class="hljs-number">100</span>M
</code></pre>
<ol start="4">
<li>
<h4 data-id="heading-44">骚操作：搜索并执行 (<code>-exec</code>)</h4>
</li>
</ol>
<p>找到文件只是第一步，通常我们还要删掉它、移动它或修改它。</p>
<ul>
<li><strong>找到 7 天前的日志并直接删除（慎用）：</strong></li>
</ul>
<pre><code class="hljs language-bash" lang="bash">find /var/log -name <span class="hljs-string">"*.log"</span> -mtime +7 -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">rm</span> -f {} ;
</code></pre>
<ul>
<li><strong>性能优化版（推荐）：</strong> 配合 <code>xargs</code> 当文件成千上万时，<code>-exec</code> 会启动成千上万个 <code>rm</code> 进程，极慢。用 <code>xargs</code> 可以把文件名打包一次性传给 <code>rm</code>。</li>
</ul>
<pre><code class="hljs language-arduino" lang="arduino">find . -name <span class="hljs-string">"*.log"</span> | xargs rm -f
</code></pre>
<hr/>
<h4 data-id="heading-45">5.极速闪电 —— <code>locate</code></h4>
<p>如果你觉得 <code>find</code> 太慢（因为它要扫描磁盘），可以用 <code>locate</code>。</p>
<ul>
<li><strong>原理：</strong> 它不扫磁盘，而是查一个系统自带的数据库（通常在 <code>/var/lib/mlocate/mlocate.db</code>）。</li>
<li><strong>缺点：</strong> 新建的文件可能搜不到，因为数据库通常每天只更新一次。</li>
</ul>
<ol>
<li><strong>常用命令</strong></li>
</ol>
<ul>
<li><strong>秒级搜索文件：</strong></li>
</ul>
<pre><code class="hljs">locate nginx.conf
</code></pre>
<ul>
<li><strong>我要搜刚创建的文件怎么办？</strong> 先手动更新数据库，再搜：</li>
</ul>
<pre><code class="hljs">sudo updatedb
locate new_file.txt
</code></pre>
<hr/>
<h3 data-id="heading-46">3.命令寻踪 —— <code>which</code> / <code>whereis</code> / <code>type</code></h3>
<p>这三个命令专门用来找“命令”本身在哪里。</p>
<h4 data-id="heading-47">1. <code>which</code> (我到底在用哪个版本？)</h4>
<ul>
<li><strong>场景：</strong> 你装了 python2 和 python3，输入 <code>python</code> 到底运行的是哪一个？</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">which</span> python
</code></pre>
<ul>
<li><strong>原理：</strong> 它只在环境变量 <code>$PATH</code> 里找可执行文件。</li>
</ul>
<h4 data-id="heading-48">2. <code>whereis</code> (全家桶)</h4>
<ul>
<li><strong>场景：</strong> 我不光想找二进制文件，还想找它的<strong>源代码</strong>和<strong>帮助文档</strong>（Man page）在哪里。</li>
</ul>
<pre><code class="hljs">whereis nginx
</code></pre>
<h4 data-id="heading-49">3. <code>type</code> (验明正身)</h4>
<ul>
<li><strong>场景：</strong> 为什么 <code>ls</code> 有颜色？为什么 <code>cd</code> 找不到文件？</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">type</span> <span class="hljs-built_in">ls</span>
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">type</span> <span class="hljs-built_in">cd</span>
</code></pre>
<hr/>
<p>按照<strong>使用频率</strong>和<strong>场景</strong>记忆：</p>
<ol>
<li>
<p><strong>Level 1 (文件去哪了):</strong></p>
<ol>
<li><strong><code>locate filename</code></strong>: 只要大概记得名字，先用这个，最快。</li>
<li><strong><code>find . -name "filename"</code></strong> : <code>locate</code> 找不到或者是刚建的文件，用这个。</li>
</ol>
</li>
<li>
<p><strong>Level 2 (运维清理与排查):</strong></p>
<ol>
<li><strong><code>find . -mtime -1</code></strong>: 昨天谁改了文件？（查被黑/查故障）。</li>
<li><strong><code>find . -size +1G</code></strong>: 磁盘怎么满了？（查大文件）。</li>
<li><strong><code>find ... | xargs rm</code></strong>: 批量删除旧文件。</li>
</ol>
</li>
<li>
<p><strong>Level 3 (环境调试):</strong></p>
<ol>
<li><strong><code>which java</code></strong>: 查环境变量配置对不对。</li>
<li><strong><code>type ll</code></strong>: 查这个命令到底是个啥。</li>
</ol>
</li>
</ol>
<p><strong>一个核心区别：</strong></p>
<ul>
<li><strong><code>grep</code></strong> 是在书中（文件内容）里找句子。</li>
<li><strong><code>find</code></strong> 是在图书馆（文件系统）里找书**。**</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React Native (Expo) iOS 真机调试失败排查：xcodebuild exited with error code 65]]></title>    <link>https://juejin.cn/post/7578793960628092954</link>    <guid>https://juejin.cn/post/7578793960628092954</guid>    <pubDate>2025-12-02T07:09:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578793960628092954" data-draft-id="7578793960628076570" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React Native (Expo) iOS 真机调试失败排查：xcodebuild exited with error code 65"/> <meta itemprop="keywords" content="前端,React Native"/> <meta itemprop="datePublished" content="2025-12-02T07:09:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="皮蛋小精灵"/> <meta itemprop="url" content="https://juejin.cn/user/219558056559278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React Native (Expo) iOS 真机调试失败排查：xcodebuild exited with error code 65
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/219558056559278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    皮蛋小精灵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T07:09:46.000Z" title="Tue Dec 02 2025 07:09:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>Error code 65</strong>，这种情况 90% 是 <strong>缓存（Cache）</strong> 或者 <strong>临时文件冲突</strong> 导致的。</p>
<p>Error 65 是 Xcode 最“不负责任”的报错，它的意思是：“我编译失败了，但我懒得在命令行里告诉你具体原因。”</p>
<p>请按以下顺序排查，通常第一步或第二步就能解决：</p>
<h3 data-id="heading-0">第一步：用 Xcode 查看“真凶” (最推荐)</h3>
<p>命令行看不出具体错误，但 Xcode 的图形界面可以看到。</p>
<ol>
<li>
<p>打开项目目录下的 <code>ios</code> 文件夹。</p>
</li>
<li>
<p>双击 <strong><code>项目.xcworkspace</code></strong> (白色的图标)。</p>
</li>
<li>
<p>确保顶部设备选的是你的 iPhone。</p>
</li>
<li>
<p>点击左上角的 <strong>▶ (运行)</strong> 按钮。</p>
</li>
<li>
<p><strong>等待失败：</strong> Xcode 会报错停止。</p>
</li>
<li>
<p><strong>看左侧导航栏：</strong> 点击那个 <strong>红色感叹号/叉号</strong> 图标。</p>
</li>
<li>
<p><strong>看右侧详情：</strong> 你会看到具体是哪一行报错了。</p>
<ul>
<li><em>如果是 Signing 错误：</em> 重新登录账号或重新选 Team。</li>
<li><em>如果是文件丢失：</em> 说明 Pods 没装好。</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-1">第二步：清理 Xcode 构建缓存 (最快尝试)</h3>
<p>既然上午能行，说明代码大概率没问题，是 Xcode 的中间文件坏了。</p>
<ol>
<li>在 Xcode 窗口中。</li>
<li>按下快捷键：<strong><code>Command (⌘) + Shift + K</code></strong> (或者菜单栏 Product -&gt; Clean Build Folder)。</li>
<li>等待清理完成（顶部提示 Clean Succeeded）。</li>
<li>再次点击 <strong>▶ 运行</strong>。</li>
</ol>
<hr/>
<h3 data-id="heading-2">第三步：删除 DerivedData (深度清理)</h3>
<p>如果第二步没用，那是 Xcode 的深层缓存坏了（DerivedData 经常出这种问题）。</p>
<ol>
<li>
<p>关闭 Xcode。</p>
</li>
<li>
<p>打开终端，运行这行命令（直接删除缓存文件夹）：</p>
<pre><code class="hljs language-Bash" lang="Bash"><span class="hljs-built_in">rm</span> -rf ~/Library/Developer/Xcode/DerivedData
</code></pre>
</li>
<li>
<p>重新运行 <code>npx expo run:ios --device</code>。</p>
</li>
</ol>
<hr/>
<h3 data-id="heading-3">第四步：重置原生依赖 (万能修复)</h3>
<p>如果上面都无法解决，可能是 <code>node_modules</code> 或 <code>Pods</code> 里的文件连接断了。用 Expo 的命令重置一下：</p>
<ol>
<li>
<p>在项目根目录运行：</p>
<pre><code class="hljs language-Bash" lang="Bash"><span class="hljs-comment"># 这一步会删除 ios 文件夹并重新生成，非常干净</span>
npx expo prebuild --clean
</code></pre>
</li>
<li>
<p>重新运行：</p>
<pre><code class="hljs language-Bash" lang="Bash">npx expo run:ios --device
</code></pre>
</li>
</ol>
<h3 data-id="heading-4">为什么会这样？</h3>
<ul>
<li><strong>USB 连接波动：</strong> 编译过程中数据线松了一下，导致传输一半的文件损坏。</li>
<li><strong>锁屏：</strong> 编译安装时，如果手机锁屏了，有时候会导致安装失败（Error 65 也包含安装失败）。<strong>建议编译时保持手机屏幕常亮。</strong></li>
<li><strong>签名过期：</strong> 免费个人签名的有效期很短，有时候 Xcode 认为证书还有效，但实际上已经过时了，需要清理后重新生成。</li>
</ul>
<p><strong>大概率是 Xcode 抽风了，试一下“第二步”通常就好了。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【花朵识别系统】Python+TensorFlow+Django+人工智能+深度学习+卷积神经网络算法]]></title>    <link>https://juejin.cn/post/7578803491822878747</link>    <guid>https://juejin.cn/post/7578803491822878747</guid>    <pubDate>2025-12-02T07:20:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578803491822878747" data-draft-id="7578876665695338505" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【花朵识别系统】Python+TensorFlow+Django+人工智能+深度学习+卷积神经网络算法"/> <meta itemprop="keywords" content="图像识别,深度学习,人工智能"/> <meta itemprop="datePublished" content="2025-12-02T07:20:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ziwu"/> <meta itemprop="url" content="https://juejin.cn/user/607373397353726"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【花朵识别系统】Python+TensorFlow+Django+人工智能+深度学习+卷积神经网络算法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/607373397353726/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ziwu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T07:20:56.000Z" title="Tue Dec 02 2025 07:20:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、介绍</h2>
<p>花朵识别系统，基于TensorFlow搭建Resnet50卷积神经网络算法，通过对5种常见的花朵图片数据集（'雏菊', '蒲公英', '玫瑰', '向日葵', '郁金香'）进行训练，最后得到一个识别精度较高的模型，然后搭建Web可视化操作平台。</p>
<p><strong>技术栈</strong>：</p>
<ul>
<li>项目前端使用Html、CSS、BootStrap搭建界面。</li>
<li>后端基于Django处理逻辑请求</li>
<li>基于Ajax实现前后端数据通信</li>
</ul>
<p><strong>选题背景与意义</strong>：
在人工智能技术蓬勃发展的当下，图像识别领域成果丰硕，花朵识别作为其中细分方向，具有广泛的应用场景，如植物研究、花卉市场管理等。然而，传统花朵识别方法依赖人工经验，效率与准确性欠佳。为此，我们开展花朵识别系统项目，基于TensorFlow搭建Resnet50卷积神经网络算法，利用5种常见花朵图片数据集训练，以获取高精度识别模型。同时，为方便用户操作，采用Html、CSS等搭建前端界面，Django处理后端逻辑，Ajax实现数据通信，搭建Web可视化平台。</p>
<h2 data-id="heading-1">二、系统效果图片展示</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4503cb112fdf4057b84368934fb4ff36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeml3dQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765264855&amp;x-signature=RXbPRhHCFjDVnLvF1RwquRTX4wI%3D" alt="图片" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1f071651a424f03986f748e67315766~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeml3dQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765264855&amp;x-signature=VDydddwo3zgKxSwSdgW0VCV9pFc%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-2">三、演示视频 and 完整代码 and 安装</h2>
<p>地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fziwupy.cn%2Fp%2F6D4JhD" target="_blank" title="https://ziwupy.cn/p/6D4JhD" ref="nofollow noopener noreferrer">ziwupy.cn/p/6D4JhD</a></p>
<h2 data-id="heading-3">四、卷积神经网络算法介绍</h2>
<p>ResNet50 是深度残差网络（Residual Network）的一种，由微软研究院提出。它通过引入残差块（Residual Block）解决了深度神经网络训练中的梯度消失和梯度爆炸问题，使得网络可以训练得更深。残差块通过跳跃连接（skip connection）将输入直接传递到输出层，让网络学习残差映射而非完整映射，降低了训练难度。ResNet50 包含 50 层深度网络，具有强大的特征提取能力，在图像分类、目标检测等任务中表现优异。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> tensorflow <span class="hljs-keyword">as</span> tf
<span class="hljs-keyword">from</span> tensorflow.keras.applications.resnet50 <span class="hljs-keyword">import</span> ResNet50, preprocess_input
<span class="hljs-keyword">from</span> tensorflow.keras.preprocessing <span class="hljs-keyword">import</span> image
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np

<span class="hljs-comment"># 加载预训练的 ResNet50 模型（不包含顶层分类层）</span>
model = ResNet50(weights=<span class="hljs-string">'imagenet'</span>, include_top=<span class="hljs-literal">False</span>, pooling=<span class="hljs-string">'avg'</span>)

<span class="hljs-comment"># 加载并预处理图像</span>
img_path = <span class="hljs-string">'your_image.jpg'</span>
img = image.load_img(img_path, target_size=(<span class="hljs-number">224</span>, <span class="hljs-number">224</span>))
x = image.img_to_array(img)
x = np.expand_dims(x, axis=<span class="hljs-number">0</span>)
x = preprocess_input(x)

<span class="hljs-comment"># 提取特征</span>
features = model.predict(x)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"提取的特征向量维度:"</span>, features.shape)

</code></pre>
<p>上述代码先加载预训练的 ResNet50 模型（基于 ImageNet 数据集训练），然后加载并预处理图像，最后使用模型提取图像特征。实际应用中，可在此基础上添加自定义分类层进行图像识别任务。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[鸿蒙 ArkUI 从零到精通：基础语法全解析]]></title>    <link>https://juejin.cn/post/7578902814022565903</link>    <guid>https://juejin.cn/post/7578902814022565903</guid>    <pubDate>2025-12-02T07:21:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578902814022565903" data-draft-id="7576573061580537897" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="鸿蒙 ArkUI 从零到精通：基础语法全解析"/> <meta itemprop="keywords" content="前端,HarmonyOS,Android"/> <meta itemprop="datePublished" content="2025-12-02T07:21:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="hqk"/> <meta itemprop="url" content="https://juejin.cn/user/2357827986264942"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            鸿蒙 ArkUI 从零到精通：基础语法全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2357827986264942/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    hqk
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T07:21:01.000Z" title="Tue Dec 02 2025 07:21:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文参与了<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2F7e230b074eaa41c587c71c1d1a9a6514%3Ftype%3D1%3Fha_source%3Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/7e230b074eaa41c587c71c1d1a9a6514?type=1?ha_source=hmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">华为官方活动：HarmonyOS赋能资源丰富度建设</a></p>
<h2 data-id="heading-0">前言</h2>
<p>在上一篇中，讲解了<a href="https://juejin.cn/post/7576057623742464042" target="_blank" title="https://juejin.cn/post/7576057623742464042">鸿蒙ArkTS基础语法</a> ，本篇将会讲解ArkUI相关的知识点。</p>
<h2 data-id="heading-1">1、ArkUI介绍</h2>
<p>ArkUI：Ability kit在UIAbility组件可以使用ArkUI提供的组件，事件，动效，状态管理等能力。</p>
<p>我们先来看看ArkUI的<strong>基本结构</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e560ee37da674992bb5494d5a118bb90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765264861&amp;x-signature=zf9sc8NRkvJZ7quhh1treFnkX%2FQ%3D" alt="QQ_1764139591463.png" loading="lazy"/>
如图所示：</p>
<ul>
<li>
<p>ArkUI基本结构包含：<strong>装饰器</strong>、<strong>自定义组件</strong>、<strong>系统组件</strong>、以及组件内一系列<strong>属性方法与事件方法</strong>等</p>
</li>
<li>
<p>装饰器：用于装饰类、结构、方法以及变量，并赋予对应的含义。如上图所示<code>@Entry</code>、<code>@Component</code>和<code>@State</code>都是装饰器</p>
<ul>
<li><code>@Entry</code>：表示该自定义组件为入口组价</li>
<li><code>@Component</code>：表示自定义组件</li>
<li><code>@State</code>：表示组件中的状态变量，状态变量变化会触发UI刷新</li>
</ul>
</li>
<li>
<p>UI描述：以声明式的方法来描述UI的结构，如上图所示 build()方法中的代码块</p>
</li>
<li>
<p>自定义组件：可复用的UI模块，可组合其他组件，如上图所示被<code>@Component</code>修饰的<code>struct Page4</code></p>
</li>
<li>
<p>属性方法：组件可以通过链式调用对应组件的多项属性方法，如<code>id()</code>、<code>width()</code>、<code>fontSize()</code>等</p>
</li>
<li>
<p>事件方法：组件可以通过链式调用设置多个事件的响应逻辑，如<code>onClick()</code></p>
</li>
</ul>
<p>当我们掌握了 ArkUI 的基本结构后，会发现 <strong>UI的最终呈现其实是由一个个组件拼起来的</strong>。</p>
<p>所以在理解“框架怎么组织 UI”之后，我们下一步就需要弄清楚：“真正构成 UI 的那些组件有哪些？它们各自怎么用？”</p>
<p>因此，下面我们就正式进入ArkUI的组件学习部分，我们将通过一系列小案例由浅入深逐步对ArkUI进行讲解。</p>
<h2 data-id="heading-2">2、ArkUI组件讲解</h2>
<p>ArkUI系统组件又分为：容器组件、基础组件。</p>
<h3 data-id="heading-3">2.1 容器组件</h3>
<p>容器组件顾名思义类似于一个容器一样，可以装下不同的组件。那该如何使用呢？那么就迎来了第一个容器组件<code>Row</code></p>
<h4 data-id="heading-4">2.1.1 Row容器组件</h4>
<p>我们先来看第一个小案例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">@Entry
@Component
struct Index {
  build() {
    Row({space: 20}){
      Text("字符串1").width(100).height(100).backgroundColor(Color.Pink)
      Text("字符串2").width(100).height(100).backgroundColor(Color.Red)
      Text("字符串3").width(100).height(100).backgroundColor(Color.Blue).fontColor(Color.White)
    }
    .width('100%')
    .height('100%')
    .border({color:Color.Red, style: BorderStyle.Dashed, width:1})
    .backgroundColor(Color.Yellow)
    .justifyContent(FlexAlign.SpaceEvenly)
    .alignItems(VerticalAlign.Center)
  }
}
</code></pre>
<p>运行效果图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13275a67886448468d15e47ccd980afc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765264861&amp;x-signature=nJslVIxGRIWVk0SBh%2FidJOHqTP8%3D" alt="QQ_1764225287496.png" loading="lazy"/></p>
<p>在这个案例中：</p>
<ul>
<li><code>Row{}</code>里面包含了三个组件，并且这三个组件是水平排列</li>
<li><code>Row{}</code>设置了不同的属性
<ul>
<li><code>{space: 20}</code>表示容器内组件之间的间距为<code>20vp</code>，这个<code>vp</code>就好比<code>Android</code>里面的<code>dp</code>单位</li>
<li><code>.width('100%').height('100%')</code>，表示宽高都是100%，充满整个屏幕</li>
<li><code>border({color:Color.Red, style: BorderStyle.Dashed, width:1})</code>给这个<code>Row</code>组件设置了边框以及边框属性</li>
<li><code>.justifyContent(FlexAlign.SpaceEvenly)</code>给这个<code>Row</code>组件设置了<strong>水平对齐方式，这个属性方法它和这个<code>Row{}</code>组件是同一种对齐方向</strong></li>
<li><code>.alignItems(VerticalAlign.Center)</code>给这个<code>Row</code>组件设置了<strong>垂直对齐方式，这个属性方法它和这个<code>Row{}</code>组件是相反的对齐方向</strong></li>
</ul>
</li>
</ul>
<p>看到这是不是会想：那我咋知道这些组件有哪些方法？然后这些方法又该如何赋值呢？不可能每个组件我都要去死记硬背涩！</p>
<h5 data-id="heading-5">2.1.1.1 源码剖析</h5>
<p>所谓的授人以鱼不如授人以渔！我这将一步一步的带你去剖析源码，就算以后遇到陌生组件也能让你更快的熟悉并使用它！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0c1bd004395473ca6adaa0d889ac683~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765264861&amp;x-signature=L92oMPG%2Fngi9nUErnCh%2FCWe7f04%3D" alt="QQ_1764227796785.png" loading="lazy"/></p>
<p><strong>如图所示</strong></p>
<p>按住<code>Ctrl</code>+鼠标左键点击<code>Row</code>，你将会看到这样的代码</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">declare</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">Row</span>: RowInterface;
</code></pre>
<p>继续按住<code>Ctrl</code>+鼠标左键点击<code>RowInterface</code>，将会是如下代码：</p>
<pre><code class="hljs language-css" lang="css">interface RowInterface {
    (value?: {
        space?: string | number;
    }): RowAttribute;
}
</code></pre>
<p>这里只看到刚刚 <code>Row({space: 20})</code>这句代码的使用方式</p>
<ul>
<li><code>value? </code> 有<code>?</code>修饰说明了这个value可为空，而这个值的类型是 <code>{space?: string | number;}</code>这样的结构体</li>
<li><code>{space?: string | number;}</code>这样的结构体里面只有<code>space?</code>变量，而且这个变量也有<code>?</code>修饰，说明了这个<code>space</code>也可为空，而这个值类型是<code>string | number</code>，说明了，如果值不为空的话，那么<code>space</code>要么是<code>string</code>要么是 <code>number</code></li>
</ul>
<p>所以在使用<code>Row</code>组件时，构造方法里面可以传<code>{space?: string | number;}</code> 这样的结构体</p>
<p>然而这里没看到想要的属性方法，继续往下看，按住<code>Ctrl</code>+鼠标左键点击<code>RowAttribute</code>，将会是如下代码：</p>
<pre><code class="hljs language-scala" lang="scala">declare <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RowAttribute</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">CommonMethod&lt;RowAttribute&gt;</span> </span>{

 <span class="hljs-comment">//Called when the vertical alignment is set.</span>
 alignItems(value: <span class="hljs-type">VerticalAlign</span>): <span class="hljs-type">RowAttribute</span>;
 
 <span class="hljs-comment">//Called when the horizontal alignment is set.</span>
 justifyContent(value: <span class="hljs-type">FlexAlign</span>): <span class="hljs-type">RowAttribute</span>;

 reverse(isReversed: <span class="hljs-type">Optional</span>&lt;boolean&gt;): <span class="hljs-type">RowAttribute</span>;
 
}
</code></pre>
<p>到这里我们看到<code>Row</code>组件特有的属性<code>alignItems</code>、<code>justifyContent</code>、<code>reverse</code>，对应属性方法的值范围，可以继续按照刚刚的方式往下看</p>
<p>不过在这里面我们就只看到这三个属性方法，上面案例里的<code>width</code>以及其他的属性方法呢？</p>
<p>我们看到<code>class RowAttribute extends CommonMethod&lt;RowAttribute&gt;</code>这句代码，<a href="https://juejin.cn/post/7576057623742464042" target="_blank" title="https://juejin.cn/post/7576057623742464042">在上一篇基础语法中</a>，讲解了这是继承关系，也就是<code>RowAttribute</code>拥有了<code>CommonMethod</code>所有非私有的属性以及方法</p>
<p>那继续按住<code>Ctrl</code>+鼠标左键点击<code>CommonMethod</code>，将会是如下代码：</p>
<pre><code class="hljs language-scss" lang="scss">declare class CommonMethod&lt;T&gt; {
  <span class="hljs-comment">//....省略部分代码</span>
  <span class="hljs-attribute">width</span>(value: Length): T;
  
  <span class="hljs-attribute">height</span>(value: Length): T;
  
  <span class="hljs-attribute">padding</span>(value: Padding | Length | LocalizedPadding): T
  
  <span class="hljs-built_in">background</span>(builder: CustomBuilder, options?: {
    align?: Alignment;
  }): T;
  
  <span class="hljs-attribute">border</span>(value: BorderOptions): T;
  
  <span class="hljs-built_in">backgroundColor</span>(value: ResourceColor): T;
 <span class="hljs-comment">//....省略部分代码</span>

</code></pre>
<p>在这里我们就看到了我们案例上使用的所有属性方法了。这里可以总结出：<strong>组件都有它自己独有的属性，并且非独有（公共）属性通过<code>extends CommonMethod&lt;T&gt;</code> 方式获得</strong></p>
<p>这里我们熟悉了<code>Row</code>组件，继续下一个组件</p>
<h4 data-id="heading-6">2.1.2 Column容器组件</h4>
<p>我们接着来看案例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">@Entry
@Component
struct ColumnPage {
  build() {
    Column({space: 20}){
      Row().width(100).height(100).backgroundColor(Color.Pink)
      Row().width(100).height(100).backgroundColor(Color.Yellow)
      Row().width(100).height(100).backgroundColor(Color.Blue)
      Row().width(100).height(100).backgroundColor(Color.Green)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.Gray)
    .justifyContent(FlexAlign.SpaceEvenly)
    .alignItems(HorizontalAlign.End)
  }
}
</code></pre>
<p>运行效果图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1c37862201240e39994c5a5fe5689d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765264861&amp;x-signature=W4ypeU4fBNe7MqJWE1ewFGDo%2Bjc%3D" alt="QQ_1764230669769.png" loading="lazy"/></p>
<p>在这个案例中：</p>
<ul>
<li><code>Column{}</code>里面包含了四个组件，并且这四个组件是垂直排列</li>
<li><code>.justifyContent(FlexAlign.SpaceEvenly)</code>给这个<code>Column</code>组件设置了<strong>垂直对齐方式，这个属性方法它和这个<code>Column{}</code>组件是同一种对齐方向</strong></li>
<li><code>.alignItems(HorizontalAlign.End)</code>给这个<code>Column</code>组件设置了<strong>水平对齐方式，这个属性方法它和这个<code>Column{}</code>组件是相反的对齐方向</strong></li>
</ul>
<p>这个<code>Column</code>列组件与<code>Row</code>行组件是相反的，特别注意<code>Column</code>的<code>.alignItems(HorizontalAlign.End)</code>属性方法里面是<code>HorizontalAlign</code>，而<code>Row</code>的<code>.alignItems(VerticalAlign.Center)</code>是<code>VerticalAlign</code>。</p>
<p>OK，我们继续下一个组件！</p>
<h4 data-id="heading-7">2.1.3 Flex容器组件</h4>
<p>Flex（弹性组件）提供更加有效的方式对容器中的子元素进行排列、对齐和分配剩余空间。</p>
<p>容器默认存在主轴与交叉轴，子元素默认沿主轴排列，子元素在主轴方向的尺寸称为主轴尺寸，在交叉轴方向的尺寸称为交叉轴尺寸。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aad9cc84edce4ba69e71cf54f60f51fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765264861&amp;x-signature=5LMTuPo%2F8jF5METoN7ARxt258Os%3D" alt="0000000000011111111.20250314163923.55033350674177624945588898470143.png" loading="lazy"/></p>
<p>既然<code>Flex</code>容器可以改变子元素在主轴与交叉轴排列，那么我们就能复刻<code>Row</code>组件以及<code>Column</code>组件</p>
<p>注意：</p>
<ul>
<li>当Flex容器为<code>Row</code>、<code>RowReverse</code>排列时，主轴与交叉轴就为图中所示；</li>
<li>当Flex容器为<code>Column</code>、<code>ColumnReverse</code>排列时，图中的主轴变交叉轴，交叉轴变主轴</li>
</ul>
<h5 data-id="heading-8">2.1.3.1 复刻Row组件</h5>
<pre><code class="hljs language-ArkTS" lang="ArkTS">import { LengthMetrics } from '@kit.ArkUI';

@Entry
@Component
struct FlexiblePage {
  build() {
    Flex({
      direction: FlexDirection.Row,
      justifyContent: FlexAlign.Start,
      alignItems: ItemAlign.Start,
      wrap: FlexWrap.NoWrap,
      space: { main: LengthMetrics.vp(20), cross: LengthMetrics.vp(30) }
    }) {
      Column().width(100).height(200).backgroundColor(Color.Pink)
      Column().width(100).height(200).backgroundColor(Color.Red)
      Column().width(100).height(200).backgroundColor(Color.Blue)

      Column().width(100).height(200).backgroundColor(Color.White)
      Column().width(100).height(200).backgroundColor(Color.Green)
      Column().width(100).height(200).backgroundColor(Color.Orange)
    }
    .margin({ top: 10 })
    .width('100%')
    .height('100%')
    .backgroundColor(Color.Gray)
  }
}
</code></pre>
<p>运行效果图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2851334b2c614cf08377cd6b9189054b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765264861&amp;x-signature=PKp%2B2pdy%2BLCA1%2B8YziUMfEaZq8o%3D" alt="QQ_1764233341962.png" loading="lazy"/></p>
<p>在这个案例中</p>
<ul>
<li>使用<code>direction: FlexDirection.Row</code>让<code>Flex</code>组件成功复刻了<code>Row</code>组件特性</li>
<li>当然<code>justifyContent</code>与<code>alignItems</code>也具备了<code>Row</code>组件特性</li>
</ul>
<p>刚刚复刻了<code>Row</code>组件，来试试复刻<code>Column</code>组件</p>
<h5 data-id="heading-9">2.1.3.2 复刻Column组件</h5>
<pre><code class="hljs language-ArkTS" lang="ArkTS">import { LengthMetrics } from '@kit.ArkUI';

@Entry
@Component
struct FlexiblePage {
  build() {
   复刻了`Column`组件
   - ({
      direction: FlexDirection.Column,
      justifyContent: FlexAlign.Start,
      alignItems: ItemAlign.Start,
      wrap: FlexWrap.NoWrap,
      space: { main: LengthMetrics.vp(20), cross: LengthMetrics.vp(30) }
    }) {
      Column().width(100).height(200).backgroundColor(Color.Pink)
      Column().width(100).height(200).backgroundColor(Color.Red)
      Column().width(100).height(200).backgroundColor(Color.Blue)

      Column().width(100).height(200).backgroundColor(Color.White)
      Column().width(100).height(200).backgroundColor(Color.Green)
      Column().width(100).height(200).backgroundColor(Color.Orange)
    }
    .margin({ top: 10 })
    .width('100%')
    .height('100%')
    .backgroundColor(Color.Gray)
  }
}
</code></pre>
<p>运行效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7cb176a192d4eaebae0ee1155eef561~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765264861&amp;x-signature=ARfiuuimkaXMpARbkkIC0KrU0mI%3D" alt="QQ_1764235343899.png" loading="lazy"/></p>
<p>在这个案例中</p>
<ul>
<li>仅仅改变了<code>direction</code>的值，成功的复刻了<code>Column</code>组件</li>
<li>对应<code>justifyContent</code>与<code>alignItems</code>也具备了<code>Column</code>组件特性</li>
<li>案例里面<code>wrap</code>表示是否多行，<code>NoWrap</code>也就是不允许，读者可以自行测试多行效果，这里不在赘述</li>
<li><code>space</code> 设置元素之间的间距。<code>main</code>主轴元素之间间距；<code>cross</code>交叉轴之间的间距（注意不同的<code>direction</code>的值，主轴、交叉轴不同哟）</li>
</ul>
<p>OK，我们继续下一个！</p>
<h4 data-id="heading-10">2.2.4 Stack容器组件</h4>
<p>Stack案例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">@Entry
@Component
struct StackPage {
  @State message: string = 'Hello World';

  build() {
    Stack({alignContent: Alignment.Center}) {
      Column().width('90%').height('90%').backgroundColor(Color.Pink).zIndex(1)
      Column().width('50').height('50').backgroundColor(Color.Blue).zIndex(3)
      Column().width('150').height('150').backgroundColor(Color.Green).zIndex(2)
    }
    .height('100%')
    .width('100%')
  }
}
</code></pre>
<p>运行效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f335b15f71149a89ffdbbfdebf4c707~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765264861&amp;x-signature=HCpINo0cJxVFX5Ez%2B8g6V%2F8e3w4%3D" alt="QQ_1764237543527.png" loading="lazy"/></p>
<p>在这个案例中：</p>
<ul>
<li>有三个大小不一的元素在里面通过<code>{alignContent: Alignment.Center}</code>实现了所有元素居中对齐。（一共有9中对齐方式，读者可以亲自尝试）</li>
<li><code>.zIndex(1)</code>通过这个属性方法设置 层级的优先级，数字越大，层级越靠前。<strong>可以将这个理解为厨房叠盘子，数字越大盘子就越上面，如果上面的盘子比下面的大，那就看不到下面的盘子</strong></li>
</ul>
<p>这个没什么难度，继续下一个！</p>
<h4 data-id="heading-11">2.2.5 Grid容器组件</h4>
<h5 data-id="heading-12">2.2.5.1 Grid案例一</h5>
<pre><code class="hljs language-ArkTS" lang="ArkTS">@Entry
@Component
struct GridPage {
  build() {
    Grid() {
      GridItem() {
        Row() {
          Column() {
            Text('商品名称')
          }
          .width('100%')
        }
      }.width("100%").height(100).backgroundColor(Color.Gray)
      GridItem().width("100%").height(100).backgroundColor(Color.Gray)
      GridItem().width("100%").height(100).backgroundColor(Color.Gray)
      GridItem().width("100%").height(100).backgroundColor(Color.Gray)
      GridItem().width("100%").height(100).backgroundColor(Color.Gray)
      GridItem().width("100%").height(100).backgroundColor(Color.Gray)
      GridItem().width("100%").height(100).backgroundColor(Color.Gray)
      GridItem().width("100%").height(100).backgroundColor(Color.Gray)
    }
    .height('100%')
    .width('100%')
    .columnsTemplate('1fr 1fr 1fr 1fr')
    .rowsGap(10)
    .columnsGap(10)
  }
}
</code></pre>
<p>运行效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4067eb34d8e04e6e848e8186d5577dfd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765264861&amp;x-signature=XgDJKC3mll%2FeoeinfP0Y%2FL74QUA%3D" alt="QQ_1764299740119.png" loading="lazy"/></p>
<p>在这个案例中：</p>
<ul>
<li><code>Grid</code>组件需要结合<code>GridItem</code>组件一起使用，并且这两个组件都是容器组件。</li>
<li><code>.columnsTemplate('1fr 1fr 1fr 1fr')</code>属性方法表示该<code>Grid</code>组件分为几列数据，其中的<code>1fr</code>表示该列权重占比</li>
<li><code>rowsGap</code>与<code>columnsGap</code>分别表示设置 行间距以及列间距</li>
</ul>
<p>那现在问题来了，案例一的<code>GridItem</code>组件就仅仅第一个添加了基本组件，而且还仅仅只是一个<code>Text</code>组件，结构层次就已经比较多了，试想一下，如果<code>Item</code>内容再复杂一点，那代码岂不是很冗余？</p>
<p>带着这样的问题，我们来看下一个案例：</p>
<h5 data-id="heading-13">2.2.5.2 Grid案例二</h5>
<pre><code class="hljs language-ArkTS" lang="ArkTS">@Entry
@Component
struct GridPage {
  build() {
    Grid() {
      GirdItemComponent()
      GirdItemComponent()
      GirdItemComponent()
      GirdItemComponent()
      GirdItemComponent()
      GirdItemComponent()
      GirdItemComponent()
      GirdItemComponent()
      GirdItemComponent()
      GirdItemComponent()
      GirdItemComponent()
      GirdItemComponent()
    }
    .height('100%')
    .width('100%')
    .columnsTemplate('1fr 1fr 1fr 1fr')
    .rowsGap(10)
    .columnsGap(10)
  }
}

@Component
struct GirdItemComponent {
  build() {
    GridItem() {
      Row() {
        Column() {
          Text('商品名称')
        }.width('100%')
      }.height(100)
    }.borderRadius(4)
    .backgroundColor(Color.Pink)
  }
}
</code></pre>
<p>运行效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e1ea64e4f5742c89114d70e0349aa96~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765264861&amp;x-signature=ijnLgRzhj3971TSDyrNna0Rm7S0%3D" alt="QQ_1764300613985.png" loading="lazy"/></p>
<p>在这个案例中：</p>
<ul>
<li>我们将<code>GridItem</code>放在了新的<code>struct GirdItemComponent</code>里面，并且用<code>@Component</code>修饰，此时<code>GirdItemComponent</code>已经被我们封装成了<strong>自定义组件</strong></li>
</ul>
<p>不过现在还有个问题：<code>GirdItemComponent()</code>数量目前是代码写死的，如何通过数据源动态渲染呢？</p>
<h5 data-id="heading-14">2.2.5.3 Grid案例三</h5>
<pre><code class="hljs language-ArkTS" lang="ArkTS">@Entry
@Component
struct GridPage {
  listData:Array&lt;number&gt;=[1,2,3,4,5,6,7,8,9,10,11,12]
  build() {
    Grid() {
      ForEach(this.listData,(item:number,index:number)=&gt;{
        GirdItemComponent()
      })
    }
    .height('100%')
    .width('100%')
    .columnsTemplate('1fr 1fr 1fr 1fr')
    .rowsGap(10)
    .columnsGap(10)
  }
}
//部分代码省略......

</code></pre>
<p>在这个案例中</p>
<ul>
<li>使用<code>ForEach</code>循环，成功的通过数据源的数量动态渲染<code>GridItem</code></li>
</ul>
<p>接着讲下一个组件！</p>
<h4 data-id="heading-15">2.2.6 RelativeContainer 容器组件</h4>
<p>相对布局组件，用于复杂场景中元素对齐的布局。它可以根据组件与组件的关系，设置并定位对应自己的不同的位置。</p>
<p>RelativeContainer 案例</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">@Entry
@Component
struct Page2 {
  build() {
    Row() {
      RelativeContainer() {
        Row(){Text('row1')}.justifyContent(FlexAlign.Center)
        .width(100).height(100)
        .backgroundColor("#FF3333")
        .alignRules({
          top: {anchor: "__container__", align: VerticalAlign.Top},
          left: {anchor: "__container__", align: HorizontalAlign.Start}
        })
        .id("row1")

        Row(){Text('row2')}.justifyContent(FlexAlign.Center)
        .width(100).height(100)
        .backgroundColor("#FFCC00")
        .alignRules({
          top: {anchor: "__container__", align: VerticalAlign.Top},
          right: {anchor: "__container__", align: HorizontalAlign.End}
        })
        .id("row2")

        Row(){Text('row3')}.justifyContent(FlexAlign.Center)
        .height(100)
        .backgroundColor("#FF6633")
        .alignRules({
          top: {anchor: "row1", align: VerticalAlign.Bottom},
          left: {anchor: "row1", align: HorizontalAlign.End},
          right: {anchor: "row2", align: HorizontalAlign.Start}
        })
        .id("row3")

        Row(){Text('row4')}.justifyContent(FlexAlign.Center)
        .backgroundColor("#FF9966")
        .alignRules({
          top: {anchor: "row3", align: VerticalAlign.Bottom},
          bottom: {anchor: "__container__", align: VerticalAlign.Bottom},
          left: {anchor: "__container__", align: HorizontalAlign.Start},
          right: {anchor: "row1", align: HorizontalAlign.End}
        })
        .id("row4")

        Row(){Text('row5')}.justifyContent(FlexAlign.Center)
        .backgroundColor("#FF66FF")
        .alignRules({
          top: {anchor: "row3", align: VerticalAlign.Bottom},
          bottom: {anchor: "__container__", align: VerticalAlign.Bottom},
          left: {anchor: "row2", align: HorizontalAlign.Start},
          right: {anchor: "__container__", align: HorizontalAlign.End}
        })
        .id("row5")
      }
      .width(300).height(300)
      .margin({left: 50})
      .border({width:2, color: "#6699FF"})
    }
    .height('100%')
  }
}
</code></pre>
<p>运行效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0fc4db1db5e44bafb46f369ef21f8c20~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765264861&amp;x-signature=gvoZEu8eMfuC7jxvt%2FYrkMVcYD0%3D" alt="QQ_1764315080855.png" loading="lazy"/></p>
<p>在这个案例中：</p>
<ul>
<li>
<p>在<code>RelativeContainer</code>组件里，子组件位置通过<code>.alignRules(xx)</code>属性方法，设置当前子组件的位置</p>
</li>
<li>
<p>在<code>.alignRules(xx)</code>属性方法里，可以分别设置<code>top</code>、<code>bottom</code>、<code>left</code>、<code>right</code>、<code>center</code>、<code>middle</code>,不同方位以及居中对齐参数，但他们无非都是分为<strong>垂直方向以及水平方向</strong></p>
<ul>
<li><code>top</code>、<code>bottom</code>、<code>center</code> 这三个是垂直方向</li>
<li><code>left</code>、<code>right</code>、<code>middle</code> 这三个是水平方向</li>
</ul>
</li>
<li>
<p>在<code>{anchor: "xxx", align: xxx}</code>结构体中，<strong>不同的方向将会有不同的设置约束的方式</strong>，</p>
<ul>
<li>水平方向通过<code>align: HorizontalAlign.xxx</code>赋值</li>
<li>垂直方向通过<code>align: VerticalAlign.xxx</code>赋值</li>
</ul>
</li>
<li>
<p>在<code>{anchor: "xxx", align: xxx}</code>结构体中，当前子组件可以通过<code>anchor: "xxx"</code>与其他子组件或父组件建立约束</p>
<ul>
<li><code>anchor: "__container__"</code> 这个表示与父容器建立约束</li>
<li><code>anchor: "row3"</code> 这个表示与<code>row3</code>组件建立约束。而<code>row3</code>组件通过<code>.id("row3")</code>设置并命名了自己就是<code>row3</code>组件</li>
</ul>
</li>
<li>
<p>在<code>Row4</code>与<code>Row5</code>组件里，它俩分别建立了四个方位的约束，因此在没有设置<code>width</code>与<code>height</code>时，它也会自动根据约束生成对应的宽高长度</p>
</li>
</ul>
<p>OK，常用的容器组件，已经讲完了。现在我们开始讲解基础组件。</p>
<h3 data-id="heading-16">2.2 基础组件</h3>
<p>基础组件比较简单，我这准备用一些小案例来讲解基础组件如何使用</p>
<h4 data-id="heading-17">2.2.1 案例一：</h4>
<pre><code class="hljs language-ArkTS" lang="ArkTS">@Entry
@Component
struct TextPage {
  @State message: string = 'Hello World';
  build() {
    RelativeContainer() {
      Text(this.message)
        .id('TextPageHelloWorld')
        .fontSize(50)
        .fontWeight(FontWeight.Bold)
        .alignRules({
          center: { anchor: '__container__', align: VerticalAlign.Center },
          middle: { anchor: '__container__', align: HorizontalAlign.Center }
        })

      Button('点我改变文本')
        .alignRules({
          top: { anchor: 'TextPageHelloWorld', align: VerticalAlign.Bottom },
          middle: { anchor: '__container__', align: HorizontalAlign.Center }
        })
        .onClick(() =&gt; {
          this.clickBtn()
        })
        .margin({ top: 20 })
    }
    .height('100%')
    .width('100%')
  }

  private clickBtn() {
    this.message = "我改变了Text"
  }
}
</code></pre>
<p>运行效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/001f5c7289ac467580f7b2cffdb2ccb0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765264861&amp;x-signature=MviNYS0Rkzaykn8mlbxkRUvDQiU%3D" alt="ezgif-50a344ea2841ebb4.gif" loading="lazy"/></p>
<p>在这个示例中：</p>
<ul>
<li>使用了<code>Text</code>、<code>Button</code>组件，而<code>Text</code>文本是通过变量<code>message</code>赋值，这个变量使用了<code>@State</code>修饰符</li>
<li><code>@State</code>又名：<strong>状态变量装饰器</strong>，被它修饰的变量<code>message</code>称为<strong>状态变量</strong>（让普通变量具备状态属性），也就是说当状态变量改变时，将会触发绑定的UI组件渲染更新</li>
<li>因此在<code>Button</code>点击事件里，改变了<code>message</code>状态变量，让<code>Text</code>组件渲染更新了最新的文本</li>
</ul>
<p>这个很简单，现在逐渐上难度</p>
<h4 data-id="heading-18">2.2.2 案例二：</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> { promptAction } from <span class="hljs-string">'@kit.ArkUI'</span>;

<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct LoginPage {

  <span class="hljs-meta">@State</span> phone: string = <span class="hljs-string">''</span>
  <span class="hljs-meta">@State</span> password: string = <span class="hljs-string">''</span>
  <span class="hljs-meta">@State</span> smsCode: string = <span class="hljs-string">''</span>

  <span class="hljs-meta">@State</span> loginByPassword: boolean = <span class="hljs-literal">true</span> <span class="hljs-comment">// true=密码登录，false=验证码登录</span>

  <span class="hljs-comment">// 验证码倒计时</span>
  <span class="hljs-meta">@State</span> counter: number = <span class="hljs-number">0</span>
  <span class="hljs-keyword">private</span> timerId: number = <span class="hljs-number">0</span>

  build() {
    Column({ space: <span class="hljs-number">20</span> }) {

      Text(<span class="hljs-string">"手机登录"</span>)
        .fontSize(<span class="hljs-number">30</span>)
        .fontWeight(FontWeight.Bold)
        .margin({ top: <span class="hljs-number">40</span> })

      <span class="hljs-comment">/** 手机号输入框 */</span>
      Row() {
        TextInput({ placeholder: <span class="hljs-string">'请输入手机号'</span> })
          .type(InputType.Number)
          .maxLength(<span class="hljs-number">11</span>)
          .onChange(v =&gt; <span class="hljs-keyword">this</span>.phone = v)
      }
      .padding(<span class="hljs-number">12</span>)
      .backgroundColor(<span class="hljs-string">'#F7F7F7'</span>)
      .borderRadius(<span class="hljs-number">8</span>)
      .width(<span class="hljs-string">'85%'</span>)

      <span class="hljs-comment">/** 密码登录区域 */</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.loginByPassword) {
        Row() {
          TextInput({ placeholder: <span class="hljs-string">'请输入密码'</span> })
            .type(InputType.Password)
            .onChange(v =&gt; <span class="hljs-keyword">this</span>.password = v)
        }
        .padding(<span class="hljs-number">12</span>)
        .backgroundColor(<span class="hljs-string">'#F7F7F7'</span>)
        .borderRadius(<span class="hljs-number">8</span>)
        .width(<span class="hljs-string">'85%'</span>)
      }

      <span class="hljs-comment">/** 验证码登录区域 */</span>
      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.loginByPassword) {
        Row({ space: <span class="hljs-number">10</span> }) {
          TextInput({
            placeholder: <span class="hljs-string">'请输入验证码'</span>
          })
            .onChange(v =&gt; <span class="hljs-keyword">this</span>.smsCode = v)
            .width(<span class="hljs-string">'60%'</span>)
          <span class="hljs-comment">// 发送验证码按钮</span>
          Button(
            <span class="hljs-keyword">this</span>.counter &gt; <span class="hljs-number">0</span>
              ? `${<span class="hljs-keyword">this</span>.counter} 秒后重试`
              : <span class="hljs-string">'发送验证码'</span>
          )
            .height(<span class="hljs-number">40</span>)
            .borderRadius(<span class="hljs-number">6</span>)
            .backgroundColor(<span class="hljs-string">'#007DFF'</span>)
            .fontColor(Color.White)
            .onClick(() =&gt; <span class="hljs-keyword">this</span>.onSendCode())
        }
        .padding(<span class="hljs-number">12</span>)
        .backgroundColor(<span class="hljs-string">'#F7F7F7'</span>)
        .borderRadius(<span class="hljs-number">8</span>)
        .width(<span class="hljs-string">'85%'</span>)
      }

      <span class="hljs-comment">/** 登录按钮 */</span>
      Button(<span class="hljs-string">"登录"</span>)
        .width(<span class="hljs-string">'85%'</span>)
        .height(<span class="hljs-number">45</span>)
        .backgroundColor(<span class="hljs-string">'#007DFF'</span>)
        .fontColor(Color.White)
        .borderRadius(<span class="hljs-number">8</span>)
        .onClick(() =&gt; <span class="hljs-keyword">this</span>.onLogin())

      <span class="hljs-comment">/** 登录方式切换 */</span>
      Row() {
        Text(<span class="hljs-keyword">this</span>.loginByPassword ? <span class="hljs-string">"使用验证码登录"</span> : <span class="hljs-string">"使用密码登录"</span>)
          .fontColor(<span class="hljs-string">'#007DFF'</span>)
          .onClick(() =&gt; {
            <span class="hljs-keyword">this</span>.loginByPassword = !<span class="hljs-keyword">this</span>.loginByPassword
            <span class="hljs-keyword">this</span>.password = <span class="hljs-string">''</span>
            <span class="hljs-keyword">this</span>.smsCode = <span class="hljs-string">''</span>
          })
      }
    }
    .width(<span class="hljs-string">'100%'</span>)
    .justifyContent(FlexAlign.Center)
  }

  <span class="hljs-comment">/** ---------------- 功能逻辑 ---------------- */</span>
  <span class="hljs-keyword">private</span> show(msg: string) {
    <span class="hljs-keyword">this</span>.toast(msg)
  }

  <span class="hljs-comment">/** 登录按钮逻辑 */</span>
  <span class="hljs-keyword">private</span> onLogin() {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.phone.trim() === <span class="hljs-string">''</span>) {
      <span class="hljs-keyword">this</span>.show(<span class="hljs-string">"请输入手机号"</span>)
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.loginByPassword) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.password.trim() === <span class="hljs-string">''</span>) {
        <span class="hljs-keyword">this</span>.show(<span class="hljs-string">"请输入密码"</span>)
        <span class="hljs-keyword">return</span>
      }
      <span class="hljs-keyword">this</span>.show(<span class="hljs-string">"密码登录成功（示例）"</span>)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.smsCode.trim() === <span class="hljs-string">''</span>) {
        <span class="hljs-keyword">this</span>.show(<span class="hljs-string">"请输入验证码"</span>)
        <span class="hljs-keyword">return</span>
      }
      <span class="hljs-keyword">this</span>.show(<span class="hljs-string">"验证码登录成功（示例）"</span>)
    }
  }

  <span class="hljs-comment">/** 发送验证码逻辑 */</span>
  <span class="hljs-keyword">private</span> onSendCode() {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.phone.trim() === <span class="hljs-string">''</span>) {
      <span class="hljs-keyword">this</span>.show(<span class="hljs-string">"请先输入手机号"</span>)
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.counter &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">this</span>.show(`请等待 ${<span class="hljs-keyword">this</span>.counter} 秒后再试`)
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-comment">// 模拟发送成功</span>
    <span class="hljs-keyword">this</span>.show(<span class="hljs-string">"验证码已发送"</span>)

    <span class="hljs-keyword">this</span>.counter = <span class="hljs-number">60</span>
    <span class="hljs-keyword">this</span>.startTimer()
  }

  <span class="hljs-keyword">private</span> toast(msg: string) {
    promptAction.showToast({ message: msg })
  }

  <span class="hljs-comment">/** 60 秒倒计时定时器 */</span>
  <span class="hljs-keyword">private</span> startTimer() {
    clearInterval(<span class="hljs-keyword">this</span>.timerId)
    <span class="hljs-keyword">this</span>.timerId = setInterval(() =&gt; {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.counter &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">this</span>.counter--
      } <span class="hljs-keyword">else</span> {
        clearInterval(<span class="hljs-keyword">this</span>.timerId)
      }
    }, <span class="hljs-number">1000</span>)
  }
}
</code></pre>
<p>运行效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/efd276d1e9a2406fa012e6be5ddeb7bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765264861&amp;x-signature=bCnybon3nGUsGIUH8UKnQj0kwo0%3D" alt="ezgif-4d505e9cca216e11.gif" loading="lazy"/></p>
<p>这是一个非常典型的验证码、密码登录例子，在这个例子中：</p>
<ul>
<li>
<p>使用的新组件<code>TextInput</code>输入框组件，</p>
<ul>
<li><code>{ placeholder: 'xxxx' }</code>表示该输入框组件，在没有输入内容之前提示文本</li>
<li><code>.type(InputType.xxx)</code>设置改输入框组件是什么类型的输入框</li>
</ul>
</li>
<li>
<p>在UI描述区域可以使用<code>if</code>语句来控制UI区域是否显示。（必须是<code>@State</code>修饰的<strong>状态变量</strong>）</p>
<ul>
<li><code>if (this.loginByPassword)</code>显示密码登录区域；</li>
<li><code>if (!this.loginByPassword)</code>显示验证码登录区域</li>
</ul>
</li>
<li>
<p>也可以在某个组件内使用三目运算符进行组件渲染。如案例中：<code>Text(this.loginByPassword ? "使用验证码登录" : "使用密码登录")</code>等。（必须是<code>@State</code>修饰的<strong>状态变量</strong>）</p>
</li>
<li>
<p><code>import { promptAction } from '@kit.ArkUI';</code>这里导入了SDK开放能力，SDK对同一个Kit下的接口模块进行了封装。这句代码意思就是，导入<code>@kit.ArkUI</code>里面的<code>promptAction</code>接口能力</p>
</li>
</ul>
<p>上面的俩个例子都是通过<strong>状态变量</strong>改变时影响布局的渲染，那能不能通过组件内容的更改从而改变变量的值呢？</p>
<h4 data-id="heading-19">2.2.3 案例三：</h4>
<pre><code class="hljs language-ArkTS" lang="ArkTS">@Entry
@Component
struct PageMvvm {

  @State
  isChecked: boolean = false
  @State
  myDate: Date = new Date()
  @State
  sexMale: boolean = true
  @State
  sexFeMale: boolean = false
  @State
  mySearch: string = ''
  @State
  myToggle: boolean = false
  @State
  mySelect: string = 'aaa'

  build() {
    Column({space: 12}) {

      Column(){
        Text('CheckBox双向绑定')
        Checkbox().select($$this.isChecked)
        Text('' + this.isChecked)
      }

      MyDivider()

      Column(){
        Text('DatePicker双向绑定')
        DatePicker({selected: $$this.myDate})
        Text('' + this.myDate.toLocaleString())
      }
      MyDivider()
      Column(){
        Text('Radio双向绑定')
        Radio({value:'male',   group: 'sex'}).checked($$this.sexMale)
        Radio({value:'female', group: 'sex'}).checked($$this.sexFeMale)
        Text('' + this.sexMale)
      }
      MyDivider()
      Column(){
        Text('Search双向绑定')
        Search({value: $$this.mySearch})
        Text('' + this.mySearch)
      }

      MyDivider()
      Column() {
        Text('Toggle双向绑定')
        Toggle({ type: ToggleType.Switch,isOn:$$this.myToggle})
        Text('' + this.myToggle)
      }

      MyDivider()
      Column() {
        Text('Select双向绑定')
        Row(){
          Select([{ value: 'aaa' },
            { value: 'bbb'},
            { value: 'ccc'},
            { value: 'ddd'}])
            .value($$this.mySelect)
          Text('' + this.mySelect)
        }
      }
      MyDivider()
    }
    .height('100%')
    .width('100%')
  }
}

@Component
struct MyDivider {
  build() {
    Divider().height(3).backgroundColor(Color.Pink)
  }
}
</code></pre>
<p>运行效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/564f3edfe5d142b18d739cebf3933ccd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765264861&amp;x-signature=itYF9dYkzoqLA5N1w3kIHY3kwTo%3D" alt="ezgif-36c0e0b8023d3deb.gif" loading="lazy"/></p>
<p>在该例子中：</p>
<ul>
<li>使用了一系列不同的新组件（<code>Checkbox</code>、<code>DatePicker</code>、<code>Radio</code>.....），在传值的时候，对应的变量前加了<code>$$</code>符号，当组件值改变时，也会同步改变对应变量。</li>
</ul>
<p>在日常开发中，我们难免会根据不同的需求，封装自己的UI。</p>
<p>那该如何封装自定义UI呢？</p>
<h3 data-id="heading-20">2.3 自定义UI</h3>
<p>在上面讲解<code>Grid</code>案例二的时候，就用过一次自定义UI，当时是用<code>@Component</code>封装了自定义组件。</p>
<p>而在鸿蒙<code>ArkTS</code>开发中,<code>@Component</code>和<code>@Builder</code>是构建UI最常用的两个装饰器。</p>
<p>虽然它们都用于生成 UI 界面，但它们在定位、能力、生命周期和性能上有本质的区别。</p>
<p>说了这么多，上案例讲解！</p>
<h4 data-id="heading-21">2.3.1 案例一</h4>
<pre><code class="hljs language-ArkTS" lang="ArkTS">@Builder
function ValueBuilder(text: string) {
  Text(`值传递Builder，不会刷新UI: ${text}`)
    .fontSize(16)
    .fontColor(Color.Gray)
    .margin(5)
}

class Tmp {
  title: string = ''
}

@Builder
function QuoteBuilder(tmp: Tmp) {
  Column() {
    Row() {
      Image($r('app.media.startIcon')).width(20)
      Text(`引用传递Builder,会刷新UI: ${tmp.title}`).fontSize(18)
    }
    .margin(10)
  }
}

@Component
@Entry
struct ParentPage {
  @State parentMessage: string = "父组件状态";

  @Builder
  LocalBuilder() {
    Text(`这是LocalBuilder 能通过this刷新 ${this.parentMessage}`)
  }

  build() {
    Column() {

      //全局值传递Builder
      ValueBuilder(this.parentMessage)

      //全局引用传递Builder
      QuoteBuilder({ title: this.parentMessage })

      //局部 this 指向Builder
      this.LocalBuilder()
      Divider().strokeWidth(2).color(Color.Blue).margin({top:20})

      Button("修改父组件状态")
        .onClick(() =&gt; {
          this.parentMessage = "状态已更新";
          console.log(`parentMessage=${this.parentMessage}`)
        }).margin({top:20})

      Text(this.parentMessage).margin({top:20})

      Divider().strokeWidth(2).color(Color.Blue).margin({top:20})

      // 使用子组件
      ChildComponent().margin({top:20})
    }
    .width('100%')
    .height('100%')
  }
}


// 2. 定义一个子组件 Component (独立模块，有生命周期)
@Component
struct ChildComponent {
  @State message: string = "我是独立的子组件";

  // 生命周期演示
  aboutToAppear() {
    console.log("ChildComponent 初始化了");
  }

  build() {
    Column() {
      Text(this.message)
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .backgroundColor(Color.Pink)
        .padding(10)
        .onClick(() =&gt; {
          this.message = "子组件被点击，只刷新我！";
        })
    }
  }
}
</code></pre>
<p>运行初始化日志：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-code">     ChildComponent 初始化了
</span></code></pre>
<p>运行效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89f3553c240e4d1faf0e19d146e1666a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765264861&amp;x-signature=uGPxqFgfIL6P606oYAMiz47%2FLHs%3D" alt="ezgif-3df822dc21ccbf98.gif" loading="lazy"/></p>
<p>在该例子中：</p>








































<table><thead><tr><th><strong>特性</strong></th><th><strong>@Component (自定义组件)</strong></th><th><strong>@Builder (UI 构建函数)</strong></th></tr></thead><tbody><tr><td><strong>本质</strong></td><td><strong>类/结构体</strong> (<code>struct</code>)</td><td><strong>函数/方法</strong> (<code>function</code>)</td></tr><tr><td><strong>生命周期</strong></td><td><strong>有</strong> (<code>aboutToAppear</code>, <code>aboutToDisappear</code> 等)</td><td><strong>无</strong></td></tr><tr><td><strong>状态管理</strong></td><td>拥有独立的状态 (<code>@State</code>, <code>@Link</code> 等)</td><td>依赖传入参数或宿主组件的状态</td></tr><tr><td><strong>渲染机制</strong></td><td>独立的渲染节点，更新时只刷新自己</td><td>视为宿主组件的一部分，通常随宿主刷新</td></tr><tr><td><strong>性能开销</strong></td><td>较重 (需要创建实例、维护状态和生命周期)</td><td>极轻 (仅仅是代码复用逻辑)</td></tr><tr><td><strong>复用范围</strong></td><td>全局可复用，不仅限 UI，还封装逻辑</td><td>主要是 UI 结构的复用 (分为全局和局部)</td></tr></tbody></table>
<p>我们在开发过程中往往会出现大量的代码在进行重复样式的设置，因此这就涉及到样式的复用。</p>
<h3 data-id="heading-22">2.4 样式复用</h3>
<h4 data-id="heading-23">2.4.1 @Styles 样式复用</h4>
<p>案例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">import { promptAction } from '@kit.ArkUI';

enum PayType {
  WXPay, Alipay, BankPay, CreditCard
}

@Entry
@Component
struct PageStyle1 {
  @State
  heightValue: number = 50

  @Styles
  // payStyle(payType:PayType){  //编译报错，@Styles 方法不能含有参数
  payStyle(){
    .width('100%')
    .height(this.heightValue)
    .borderRadius(10)
    .backgroundColor('#FF1266e0')
    .onClick(() =&gt; {
      promptAction.showToast({ message: '支付成功！' })
    })
  }

  build() {
    Column() {
      Row() {
        Button('微信支付', { type: ButtonType.Normal })
          .payStyle()
      }
      .padding(10)

      Row() {
        Button('支付宝支付', { type: ButtonType.Normal })
          .payStyle()

      }
      .padding(10)

      Row() {
        Button('银行卡支付', { type: ButtonType.Normal })
          .payStyle()

      }
      .padding(10)

      Row() {
        Button('信用卡支付', { type: ButtonType.Normal })
          .payStyle()

      }
      .padding(10)

    }
    .width('100%')
    .height('100%')

  }
}
</code></pre>
<p>运行效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a164547ff5c4713ac8cc5cd22b4816b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765264861&amp;x-signature=vjhAxTfDLmNIu9l6dJXYgKk8Zhw%3D" alt="ezgif-60d51c07d55661eb.gif" loading="lazy"/></p>
<p>在该例子中：</p>
<ul>
<li>通过<code>@Styles</code>修饰的方法可以定义<strong>通用属性与通用事件，不支持参数传递（通用、通用、通用）</strong></li>
</ul>
<p>那如果说有多种情况，不同情况按钮颜色不一样，然而<code>@Styles</code>修饰的方法不可传参，区分不了按钮，那该怎么办呢？</p>
<h4 data-id="heading-24">2.4.2 @Extend 样式复用</h4>
<p>案例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">import { promptAction } from '@kit.ArkUI';

@Entry
@Component
struct PageStyle2 {
  build() {
    Column({ space: 20 }) {
      Button("支付宝支付")
        .payButton("alipay")
      Button("微信支付")
        .payButton("wechat")
      Button("支付宝支付")
        .payButton("alipay")
      Button("微信支付")
        .payButton("wechat")
      Button("支付宝支付")
        .payButton("alipay")
      Button("微信支付")
        .payButton("wechat")
      Button("支付宝支付")
        .payButton("alipay")
    }
    .padding(20)
    .width('100%')
  }
}

@Extend(Button)
function payButton(type: 'alipay' | 'wechat'){
  .type(ButtonType.Normal)
  .fontColor(Color.White)
  .width('100%')
  .height(50)
  .borderRadius(4)
  .backgroundColor(type === 'wechat' ? '#00c168':'#ff1256e0')
  .onClick(()=&gt;{
    if( type === 'alipay'){
      promptAction.showToast({message: '支付宝支付成功！'})
    }else{
      promptAction.showToast({message: '微信支付成功！'})
    }
  })
}
</code></pre>
<p>运行效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4b8ede32c5d4adeabd0d747122b4064~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765264861&amp;x-signature=4pz507XuhOVL9F1Y0muvg5jI5NU%3D" alt="ezgif-2587c76ade83aa5c.gif" loading="lazy"/></p>
<p>在该例子中：</p>
<ul>
<li>使用<code>@Extend(Button)</code>扩展了原生组件的样式，支持封装私有属性、通用属性、事件。</li>
<li>与<code>@Styles</code>不同，<code>@Extend(Button)</code>支持参数传递，提供了更大的灵活性</li>
</ul>
<p>虽然<code>@Styles</code>和<code>@Extend(Button)</code>提供了样式复用的能力，但是它们还是存在一些限制，因此就有了<code>AttributeModifier</code>。</p>
<p>我们来看看如何使用它。</p>
<h4 data-id="heading-25">2.4.3 AttributeModifier</h4>
<p>案例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">@Entry
@Component
struct PageStyle3 {

  @State modifier: MyButtonModifier = new MyButtonModifier()
  @State modifier2: MyButtonModifier2 = new MyButtonModifier2()

  build() {

    Column({space: 20}){
      Button('点我试试').attributeModifier(this.modifier).onClick(()=&gt;{
        this.modifier.isDark = !this.modifier.isDark
      })

      Divider().height(2).backgroundColor(Color.Pink)

      Button('点我试试').attributeModifier(this.modifier2)

    }
    .width('100%')
    .height('100%')
  }
}

class MyButtonModifier implements AttributeModifier&lt;ButtonAttribute&gt;{
  isDark: boolean  = false
  applyNormalAttribute(instance: ButtonAttribute): void {
    instance.backgroundColor(this.isDark ? Color.Black: Color.Red)
  }
}

class MyButtonModifier2 implements AttributeModifier&lt;ButtonAttribute&gt; {
  applyNormalAttribute(instance: ButtonAttribute): void {
    instance.backgroundColor(Color.Black)
  }
  applyPressedAttribute(instance: ButtonAttribute): void {
    instance.backgroundColor(Color.Red)

  }
}
</code></pre>
<p>运行效果</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14f251648531456c91057c98ac40677f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765264861&amp;x-signature=60Iy%2BpFxBPLgzIzWIe%2BckUHLJ%2F8%3D" alt="ezgif-7320282bf35d4baa.gif" loading="lazy"/></p>
<p>在这个例子中：</p>
<ul>
<li><code>AttributeModifier&lt;ButtonAttribute&gt;</code> 其中<code>ButtonAttribute</code>是 <code>Button</code>专有属性类，也就是按钮扩展属性</li>
<li><code>applyNormalAttribute</code> 表示 按钮在正常情况下属性的表现</li>
<li><code>applyPressedAttribute</code> 表示 按钮在按下的情况下属性的表现</li>
</ul>
<h4 data-id="heading-26">2.4.4 多态样式stateStyles</h4>
<p>案例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">@Entry
@Component
struct PageStyle4 {
  build() {
    Column(){
      Row(){
        Text('今天你心情怎么样！')
      }
      .padding(20)
      .height(80)
      .border({
        color: Color.Pink,
        width: 3
      })
      .borderRadius(4)
      .stateStyles({
        normal:{
          .backgroundColor(Color.Green)
        },
        pressed:{
          .backgroundColor('#eee')
          .border({
            width: 1,
            style: BorderStyle.Solid,
            color: Color.Red
          })
        }
      })

    }
    .width('100%')
    .height('100%')
  }
}
</code></pre>
<p>运行效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b48add4fe046497ba0045f05cb591604~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765264861&amp;x-signature=VjIgkmyq9x8ZxU4yOpBF1qeIzJM%3D" alt="ezgif-7e5bff81b40c9dd2.gif" loading="lazy"/></p>
<p>在这个例子中：</p>
<ul>
<li>
<p>stateStyles可以依据组件的内部状态不同，快速设置不同样式</p>
</li>
<li>
<p>ArkUI提供以下五种状态</p>
<ul>
<li>focused：获取焦点时</li>
<li>normal：正常情况</li>
<li>pressed：按压时</li>
<li>disabled：不可选中时</li>
<li>selected：选中时</li>
</ul>
</li>
</ul>
<h3 data-id="heading-27">3、结束语</h3>
<p>OK，看到这里的小伙伴相信你对ArkUI有了一定的了解！
下一篇讲解状态管理、应用程序结构以及路由相关讲解！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【鸟类识别系统】Python+TensorFlow+Django+人工智能+深度学习+卷积神经网络算法]]></title>    <link>https://juejin.cn/post/7578820377000411187</link>    <guid>https://juejin.cn/post/7578820377000411187</guid>    <pubDate>2025-12-02T07:25:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578820377000411187" data-draft-id="7578948893761667099" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【鸟类识别系统】Python+TensorFlow+Django+人工智能+深度学习+卷积神经网络算法"/> <meta itemprop="keywords" content="深度学习,图像识别"/> <meta itemprop="datePublished" content="2025-12-02T07:25:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ziwu"/> <meta itemprop="url" content="https://juejin.cn/user/607373397353726"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【鸟类识别系统】Python+TensorFlow+Django+人工智能+深度学习+卷积神经网络算法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/607373397353726/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ziwu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T07:25:50.000Z" title="Tue Dec 02 2025 07:25:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、介绍</h2>
<p>鸟类识别系统，通过TensorFlow搭建卷积神经网络算法，数据集使用经典的加利福尼亚大学CUB-200-2011鸟类数据集，对其进行多轮迭代训练，最后得到了一个精度较高的模型，并搭建Web可视化操作平台。</p>
<p><strong>技术栈</strong>：</p>
<ul>
<li>项目前端使用Html、CSS、BootStrap搭建界面。</li>
<li>后端基于Django处理逻辑请求</li>
<li>基于Ajax实现前后端数据通信</li>
</ul>
<p><strong>选题背景与意义</strong>：
在生态保护与生物多样性研究日益重要的当下，精准识别鸟类品种对科研及爱好者而言意义重大。传统鸟类识别依赖人工比对图鉴，不仅效率低且对专业知识要求高。随着人工智能技术发展，利用深度学习算法实现自动化鸟类识别成为可行方向。本项目聚焦于此，采用TensorFlow搭建卷积神经网络算法，选用权威的加利福尼亚大学CUB-200-2011鸟类数据集，经多轮迭代训练出高精度模型。同时，为方便用户操作，还运用Html、CSS等搭建Web可视化平台，实现便捷交互。</p>
<h2 data-id="heading-1">二、系统效果图片展示</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5d8d63627504e1ea7e92c4839b1260a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeml3dQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765265150&amp;x-signature=KV%2FoSf3sS9wtOKFnMP9GZpJ6GiE%3D" alt="图片" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fdcbdf989c5c4835a9bee4b1d87a5292~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeml3dQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765265150&amp;x-signature=ZX5rxQq3fg%2FGA5mb%2FZujnV%2BJmTw%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-2">三、演示视频 and 完整代码 and 安装</h2>
<p>地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fziwupy.cn%2Fp%2FCNZ6zx" target="_blank" title="https://ziwupy.cn/p/CNZ6zx" ref="nofollow noopener noreferrer">ziwupy.cn/p/CNZ6zx</a></p>
<h2 data-id="heading-3">四、卷积神经网络算法介绍</h2>
<p>ResNet50是一种深度卷积神经网络（CNN），由微软研究院于2015年提出，属于ResNet系列模型。其核心创新是引入残差块（Residual Block），通过残差连接（Shortcut Connection）解决深层网络训练中的梯度消失问题，使网络能够训练更深层次的结构（共50层，含49个卷积层和1个全连接层）。残差块允许输入直接跳过部分卷积层，与输出相加，从而保留更多原始信息，提升特征提取能力。ResNet50在ImageNet数据集上达到76%的Top-1准确率，广泛应用于图像分类、目标检测等任务。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> tensorflow <span class="hljs-keyword">as</span> tf
<span class="hljs-keyword">from</span> tensorflow.keras.applications.resnet50 <span class="hljs-keyword">import</span> ResNet50, preprocess_input
<span class="hljs-keyword">from</span> tensorflow.keras.preprocessing <span class="hljs-keyword">import</span> image
<span class="hljs-keyword">from</span> tensorflow.keras.models <span class="hljs-keyword">import</span> Model
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np

<span class="hljs-comment"># 加载预训练模型（不包括顶层分类层）</span>
base_model = ResNet50(weights=<span class="hljs-string">'imagenet'</span>, include_top=<span class="hljs-literal">False</span>, input_shape=(<span class="hljs-number">224</span>, <span class="hljs-number">224</span>, <span class="hljs-number">3</span>))

<span class="hljs-comment"># 添加自定义分类层</span>
x = tf.keras.layers.GlobalAveragePooling2D()(base_model.output)
x = tf.keras.layers.Dense(<span class="hljs-number">1024</span>, activation=<span class="hljs-string">'relu'</span>)(x)
predictions = tf.keras.layers.Dense(<span class="hljs-number">10</span>, activation=<span class="hljs-string">'softmax'</span>)(x)  <span class="hljs-comment"># 假设10个类别</span>
model = Model(inputs=base_model.<span class="hljs-built_in">input</span>, outputs=predictions)

<span class="hljs-comment"># 冻结预训练层（可选）</span>
<span class="hljs-keyword">for</span> layer <span class="hljs-keyword">in</span> base_model.layers:
    layer.trainable = <span class="hljs-literal">False</span>

<span class="hljs-comment"># 示例：预处理单张图片并预测</span>
img_path = <span class="hljs-string">'example.jpg'</span>
img = image.load_img(img_path, target_size=(<span class="hljs-number">224</span>, <span class="hljs-number">224</span>))
img_array = image.img_to_array(img)
img_array = np.expand_dims(img_array, axis=<span class="hljs-number">0</span>)
img_array = preprocess_input(img_array)

predictions = model.predict(img_array)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"预测结果:"</span>, np.argmax(predictions))

</code></pre>
<p>代码加载预训练的ResNet50模型（基于ImageNet权重），替换顶层为自定义分类层（10类输出）。通过冻结预训练层，可利用其特征提取能力快速适配新任务（迁移学习）。输入图片需预处理为224×224尺寸，并使用preprocess_input标准化像素值。此方法适用于小数据集场景，可显著减少训练时间和计算资源需求。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【开源】一个丝滑的 Claude Code 环境变量快速切换工具]]></title>    <link>https://juejin.cn/post/7578917474658762803</link>    <guid>https://juejin.cn/post/7578917474658762803</guid>    <pubDate>2025-12-02T07:27:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578917474658762803" data-draft-id="7578876665695387657" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【开源】一个丝滑的 Claude Code 环境变量快速切换工具"/> <meta itemprop="keywords" content="AI编程,Cursor,Claude"/> <meta itemprop="datePublished" content="2025-12-02T07:27:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="极客密码"/> <meta itemprop="url" content="https://juejin.cn/user/976022055165608"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【开源】一个丝滑的 Claude Code 环境变量快速切换工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/976022055165608/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    极客密码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T07:27:56.000Z" title="Tue Dec 02 2025 07:27:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>起因是给家里 M 系列芯片的 Macmini 装了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffarion1231%2Fcc-switch" target="_blank" title="https://github.com/farion1231/cc-switch" ref="nofollow noopener noreferrer">cc-switch</a> 之后觉得非常好用，可以很方便的将很多不同的 claude code 中转 API 站管理起来，切换也非常丝滑</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/703d5a220d2c480fa24354eddf6c8a73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6B5a6i5a-G56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765265276&amp;x-signature=u%2BEIpea9J3hXORGy5GCb8n8DmP4%3D" alt="cc-switch" loading="lazy"/></p>
<p>因此也给公司这台 Intel 芯片的黑苹果装上了，系统是 Big Sur 11.7.7</p>
<p>但因为黑苹果系统停在 MacOS Big Sur，所以导致很多使用了 Tauri 2.x 开发的软件打开基本都会丢样式</p>
<p>查了下说是 Big Sur 底层的 webview 版本太低了，也不想再折腾升系统了</p>
<p>所以就有了下面这个命令行切换工具</p>
<p>如果你比较喜欢 CLI 工具，想通过一行 npm install 命令就能安装一个 Claude Code 环境变量切换工具的话</p>
<p>那么它，将是你的不二之选。</p>
<p>做了新增、切换、删除、修改、额度显示等等，代码已全量开源：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fisnl%2Fccs" target="_blank" title="https://github.com/isnl/ccs" ref="nofollow noopener noreferrer">github.com/isnl/ccs</a></p>
<h2 data-id="heading-0">CCS - Claude Code Switcher</h2>
<p>一个用于管理多个 Claude Code API 商家配置的命令行工具。</p>
<h3 data-id="heading-1">安装</h3>
<pre><code class="hljs language-bash" lang="bash">npm install -g @claude-cli/ccs
</code></pre>
<h3 data-id="heading-2">特性</h3>
<ul>
<li>首次运行自动导入当前 Claude Code 配置</li>
<li>切换前自动备份</li>
<li>中英双语支持</li>
<li>额度用量跟踪与显示</li>
<li>美观的带边框表格显示</li>
</ul>
<h3 data-id="heading-3">Commands / 命令</h3>













































































<table><thead><tr><th>Command</th><th>Alias</th><th>Description (EN)</th><th>描述 (中文)</th></tr></thead><tbody><tr><td><code>ccs</code></td><td>-</td><td>Interactive switch</td><td>交互式切换商家</td></tr><tr><td><code>ccs list</code></td><td><code>ccs ls</code></td><td>List all providers</td><td>列出所有商家</td></tr><tr><td><code>ccs add</code></td><td><code>ccs a</code></td><td>Add a new provider</td><td>添加新商家</td></tr><tr><td><code>ccs edit [name]</code></td><td><code>ccs e [name]</code></td><td>Edit a provider</td><td>编辑商家配置</td></tr><tr><td><code>ccs use [name]</code></td><td><code>ccs u [name]</code></td><td>Switch to a provider</td><td>快速切换商家</td></tr><tr><td><code>ccs remove [name]</code></td><td><code>ccs rm [name]</code></td><td>Remove a provider</td><td>删除商家</td></tr><tr><td><code>ccs current</code></td><td><code>ccs c</code></td><td>Show current config</td><td>显示当前配置</td></tr><tr><td><code>ccs refresh [name]</code></td><td><code>ccs r [name]</code></td><td>Refresh quota info</td><td>刷新额度信息</td></tr><tr><td><code>ccs lang</code></td><td>-</td><td>Switch language</td><td>切换语言（中/英）</td></tr><tr><td><code>ccs --version</code></td><td><code>ccs -v</code></td><td>Show version</td><td>显示版本号</td></tr><tr><td><code>ccs --help</code></td><td><code>ccs -h</code></td><td>Show help</td><td>显示帮助信息</td></tr></tbody></table>
<h3 data-id="heading-4">截图</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81d0ba08e3c3448789a457a366879b9f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6B5a6i5a-G56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765265276&amp;x-signature=fiHEc1hoDG0JO%2FlqTiQXe7zPJxE%3D" alt="2025-12-01-17-26-05" loading="lazy"/></p>
<h3 data-id="heading-5">额度配置</h3>
<p>添加或编辑商家时，可以选择配置额度显示：</p>
<ol>
<li><strong>User ID</strong> - 在商家设置页面查看</li>
<li><strong>Access Token</strong> - 在设置-安全设置中获取</li>
</ol>
<p>配置完成后，运行 <code>ccs refresh</code> 刷新额度信息，或在添加/编辑时自动获取。</p>
<h3 data-id="heading-6">配置</h3>
<h4 data-id="heading-7">配置文件</h4>
<p><code>~/.ccs.json</code></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"lang"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"zh"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"current"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"a1b2c3d4-e5f6-7890-abcd-ef1234567890"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"providers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"a1b2c3d4-e5f6-7890-abcd-ef1234567890"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"OpenRouter"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Main provider, cheap"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"baseURL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://openrouter.ai/api/v1"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"apiKey"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sk-or-xxx"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"balanceConfig"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"enabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"userId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"12345"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"accessToken"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"your-access-token"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"usedBalance"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">12.5</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"totalBalance"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"b2c3d4e5-f6a7-8901-bcde-f12345678901"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"OneAPI"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Company internal API"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"baseURL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://api.example.com/v1"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"apiKey"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sk-xxx"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-8">商家字段</h4>













































































<table><thead><tr><th>Field</th><th>Required</th><th>Description (EN)</th><th>描述 (中文)</th></tr></thead><tbody><tr><td><code>id</code></td><td>Yes</td><td>UUID identifier</td><td>UUID 标识符</td></tr><tr><td><code>name</code></td><td>Yes</td><td>Provider name</td><td>商家名称</td></tr><tr><td><code>description</code></td><td>No</td><td>Description/notes</td><td>描述/备注</td></tr><tr><td><code>baseURL</code></td><td>Yes</td><td>API base URL</td><td>API 地址</td></tr><tr><td><code>apiKey</code></td><td>Yes</td><td>API key</td><td>API 密钥</td></tr><tr><td><code>balanceConfig</code></td><td>No</td><td>Quota config object</td><td>额度配置对象</td></tr><tr><td><code>balanceConfig.enabled</code></td><td>No</td><td>Enable quota display</td><td>启用额度显示</td></tr><tr><td><code>balanceConfig.userId</code></td><td>No</td><td>User ID for API</td><td>用户 ID</td></tr><tr><td><code>balanceConfig.accessToken</code></td><td>No</td><td>Access token for API</td><td>访问令牌</td></tr><tr><td><code>usedBalance</code></td><td>No</td><td>Used quota (USD)</td><td>已用额度 (美元)</td></tr><tr><td><code>totalBalance</code></td><td>No</td><td>Total quota (USD)</td><td>总额度 (美元)</td></tr></tbody></table>
<h3 data-id="heading-9">切换机制</h3>
<p>切换商家时：</p>
<ol>
<li>备份 <code>~/.claude/settings.json</code> → <code>~/.claude/settings.json.backup</code></li>
<li>写入 <code>ANTHROPIC_BASE_URL</code> 和 <code>ANTHROPIC_AUTH_TOKEN</code> 到 <code>~/.claude/settings.json</code></li>
</ol>
<h3 data-id="heading-10">技术栈</h3>
<ul>
<li>Claude Code - 代码编写</li>
<li>Commander.js - 命令解析</li>
<li>Inquirer.js - 交互式提示</li>
<li>Chalk - 终端美化</li>
</ul>
<h3 data-id="heading-11">License</h3>
<p>MIT</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《独立开发者精选工具》第 023 期]]></title>    <link>https://juejin.cn/post/7578820377000329267</link>    <guid>https://juejin.cn/post/7578820377000329267</guid>    <pubDate>2025-12-02T07:13:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578820377000329267" data-draft-id="7578797337868763170" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《独立开发者精选工具》第 023 期"/> <meta itemprop="keywords" content="前端,后端,开源"/> <meta itemprop="datePublished" content="2025-12-02T07:13:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Immerse"/> <meta itemprop="url" content="https://juejin.cn/user/2708812817761752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《独立开发者精选工具》第 023 期
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2708812817761752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Immerse
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T07:13:44.000Z" title="Tue Dec 02 2025 07:13:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.indietools.work" target="_blank" title="https://www.indietools.work" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/840bec24e4d743c1ade3d8a8e8fc6d20~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSW1tZXJzZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765264423&amp;x-signature=sN4pKyMOxSNbKDim73Vy0%2FlVJPU%3D" alt="" loading="lazy"/></a></p>
<p>Indie Tools 是一个收录独立开发、AI 出海领域最新、最实用的免费工具与资源工具站。让你快速找到所需，专注于创造产品。</p>
<p>独立开发者必备网站：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.indietools.work" target="_blank" title="https://www.indietools.work" ref="nofollow noopener noreferrer"><code>https://www.indietools.work</code></a></p>
<p>Github: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyaolifeng0629%2FAwesome-independent-tools" target="_blank" title="https://github.com/yaolifeng0629/Awesome-independent-tools" ref="nofollow noopener noreferrer"><code>https://github.com/yaolifeng0629/Awesome-independent-tools</code></a></p>
<p>如果本文能给你提供启发和帮助，感谢各位小伙伴动动小手指，一键三连 (点赞、评论、转发)，给我一些支持和鼓励，谢谢。</p>
<h2 data-id="heading-0">favicon-generator</h2>
<h3 data-id="heading-1">总结</h3>
<p>免费在线 Favicon 生成工具，快速生成多设备图标。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/045e850392f64b65b5da68c06ad8e24a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSW1tZXJzZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765264423&amp;x-signature=6oIge8V1gq0BvwxTVvLtWpRbcEs%3D" alt="favicon-generator" loading="lazy"/></p>
<p>链接: <code>https://www.indietools.work/product/favicon-generator</code></p>
<h3 data-id="heading-2">特性</h3>
<ol>
<li>从图像自动生成多尺寸图标。</li>
<li>在线编辑器支持简单编辑和预览。</li>
<li>一键打包下载所有格式图标。</li>
<li>提供可直接嵌入的 HTML 代码。</li>
</ol>
<h3 data-id="heading-3">使用场景</h3>
<ol>
<li>网站开发者快速创建 Favicon。</li>
<li>为移动应用或 PWA 生成应用图标。</li>
</ol>
<h3 data-id="heading-4">缺点</h3>
<ol>
<li>高级编辑功能有限。</li>
<li>网站界面较陈旧。</li>
</ol>
<h2 data-id="heading-5">WeClone</h2>
<h3 data-id="heading-6">总结</h3>
<p>用聊天记录微调大模型，打造个性化数字分身。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4814140ea9c49a6b0bb92678e3a477a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSW1tZXJzZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765264423&amp;x-signature=6IYR4ToS3agOC8OlijoJhq%2ByZLM%3D" alt="WeClone" loading="lazy"/></p>
<p>链接: <code>https://www.indietools.work/product/weclone</code></p>
<h3 data-id="heading-7">特性</h3>
<ol>
<li>用个人聊天记录微调模型，模仿用户语言风格。</li>
<li>将模型绑定到聊天机器人，实现实时互动。</li>
<li>提供数据处理到部署的完整工作流。</li>
</ol>
<h3 data-id="heading-8">使用场景</h3>
<ol>
<li>创建个人数字分身与朋友互动。</li>
<li>为创作者构建虚拟形象与粉丝交流。</li>
<li>部署具有特定语言风格的社群助手。</li>
</ol>
<h3 data-id="heading-9">缺点</h3>
<ol>
<li>数据隐私保护可能不足。</li>
<li>生成效果受限于基础模型能力。</li>
</ol>
<h2 data-id="heading-10">Midjourney Sref</h2>
<h3 data-id="heading-11">总结</h3>
<p>收录 4000+个 Midjourney 风格参考代码，快速复制艺术风格。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f753ac486f02438b856a67f299b4ef43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSW1tZXJzZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765264423&amp;x-signature=LhtRUUWI%2BEU%2BMnvHz6vjhc%2FD5iI%3D" alt="Midjourney Sref" loading="lazy"/></p>
<p>链接: <code>https://www.indietools.work/product/midjourney-sref</code></p>
<h3 data-id="heading-12">特性</h3>
<ol>
<li>提供超 4000 个精选--sref 代码。</li>
<li>每个代码配有效果图预览。</li>
<li>界面简洁，易于搜索浏览。</li>
</ol>
<h3 data-id="heading-13">使用场景</h3>
<ol>
<li>快速为作品寻找特定艺术风格。</li>
<li>参考不同风格激发创作灵感。</li>
</ol>
<h3 data-id="heading-14">缺点</h3>
<ol>
<li>风格库庞大，新手选择困难。</li>
<li>功能单一，缺乏高级筛选。</li>
</ol>
<h2 data-id="heading-15">awesome-chatgpt-prompts-zh</h2>
<h3 data-id="heading-16">总结</h3>
<p>丰富的中文提示词库，提升 ChatGPT 对话质量。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3ecfe3a78874d8b91ae03774800276b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSW1tZXJzZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765264423&amp;x-signature=%2FRb6wDFZKpd4%2BCB8Tjd4D0U5ztA%3D" alt="awesome-chatgpt-prompts-zh" loading="lazy"/></p>
<p>链接: <code>https://www.indietools.work/product/awesome-chatgpt-prompts-zh</code></p>
<h3 data-id="heading-17">特性</h3>
<ol>
<li>收录不同场景和角色的中文提示词模板。</li>
<li>内容持续更新，紧跟功能迭代。</li>
<li>提示词经测试，可直接复制使用。</li>
</ol>
<h3 data-id="heading-18">使用场景</h3>
<ol>
<li>让 ChatGPT 扮演特定角色对话。</li>
<li>为创作者、学生提供提问灵感。</li>
</ol>
<h3 data-id="heading-19">缺点</h3>
<ol>
<li>提示词质量参差不齐。</li>
<li>主要面向中文用户。</li>
</ol>
<h2 data-id="heading-20">awesome-chatgpt-prompts</h2>
<h3 data-id="heading-21">总结</h3>
<p>社区驱动的 ChatGPT 提示词库，提升与大模型的互动效率。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/657d45f40d364c96b5bb4a0527a7a614~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSW1tZXJzZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765264423&amp;x-signature=JmZII%2FJzrkbZiLwER7GzQ8ZnpAA%3D" alt="awesome-chatgpt-prompts" loading="lazy"/></p>
<p>链接: <code>https://www.indietools.work/product/awesome-chatgpt-prompts</code></p>
<h3 data-id="heading-22">特性</h3>
<ol>
<li>提供多样化角色扮演提示。</li>
<li>覆盖编程、写作、营销等领域。</li>
<li>社区持续更新，保持实用性。</li>
</ol>
<h3 data-id="heading-23">使用场景</h3>
<ol>
<li>为创作者提供灵感和文案框架。</li>
<li>帮助开发者获取代码解决方案。</li>
<li>辅助学生进行学术写作。</li>
</ol>
<h3 data-id="heading-24">缺点</h3>
<ol>
<li>提示词质量水平不一。</li>
<li>部分提示词需调整适配新模型。</li>
</ol>
<h2 data-id="heading-25">minimaxi</h2>
<h3 data-id="heading-26">总结</h3>
<p>高性价比国内文本转语音 API 平台，付费使用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2c896b597fd465fa3a56e6eb1ebac2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSW1tZXJzZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765264423&amp;x-signature=JfZInkBQnaIX38AteRdNjgIfw%2FA%3D" alt="minimaxi" loading="lazy"/></p>
<p>链接: <code>https://www.indietools.work/product/minimaxi</code></p>
<h3 data-id="heading-27">特性</h3>
<ol>
<li>多种高自然度音色可选。</li>
<li>性价比高，适合预算有限用户。</li>
<li>API 稳定，方便集成。</li>
</ol>
<h3 data-id="heading-28">使用场景</h3>
<ol>
<li>为视频、有声读物生成配音。</li>
<li>为智能助手提供语音交互。</li>
</ol>
<h3 data-id="heading-29">缺点</h3>
<ol>
<li>需付费，不适合轻度用户。</li>
<li>国际化和多语言支持有限。</li>
</ol>
<h2 data-id="heading-30">SnippAI</h2>
<h3 data-id="heading-31">总结</h3>
<p>AI 截图工具，智能识别并处理屏幕内容。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3bfeaf9843fd439797b46361278c867e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSW1tZXJzZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765264423&amp;x-signature=SejHL2l6OeAQie%2FF%2FukwHyGdm8s%3D" alt="SnippAI" loading="lazy"/></p>
<p>链接: <code>https://www.indietools.work/product/snippai</code></p>
<h3 data-id="heading-32">特性</h3>
<ol>
<li>智能识别截图中的文本、代码或图像。</li>
<li>AI 驱动的总结、解释和翻译功能。</li>
<li>一键截图获取 AI 分析结果。</li>
<li>支持代码片段解释和格式优化。</li>
</ol>
<h3 data-id="heading-33">使用场景</h3>
<ol>
<li>快速提取和总结网页文章核心内容。</li>
<li>理解和解释代码片段功能。</li>
<li>辅助学生快速消化文献资料。</li>
<li>翻译截图中的外语文字。</li>
</ol>
<h3 data-id="heading-34">缺点</h3>
<ol>
<li>处理复杂专业内容时可能不精确。</li>
<li>离线状态下功能受限。</li>
</ol>
<h3 data-id="heading-35">往期回顾</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F-DDkWXf1gRSwMOhLeJWL_A" target="_blank" title="https://mp.weixin.qq.com/s/-DDkWXf1gRSwMOhLeJWL_A" ref="nofollow noopener noreferrer">《独立开发者精选工具》第 023 期（最新）</a> 🔥</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FIfBFbvZeR8YadX3tynW90w" target="_blank" title="https://mp.weixin.qq.com/s/IfBFbvZeR8YadX3tynW90w" ref="nofollow noopener noreferrer">《独立开发者精选工具》第 022 期</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FOGvJKwAxIdLl-P8T_z8fbQ" target="_blank" title="https://mp.weixin.qq.com/s/OGvJKwAxIdLl-P8T_z8fbQ" ref="nofollow noopener noreferrer">《独立开发者精选工具》第 021 期</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FlsGaGKMBqqETuuhO7NpxFg" target="_blank" title="https://mp.weixin.qq.com/s/lsGaGKMBqqETuuhO7NpxFg" ref="nofollow noopener noreferrer">《独立开发者精选工具》第 020 期</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FPlrojO5X4Ypg61YeXYfVbg" target="_blank" title="https://mp.weixin.qq.com/s/PlrojO5X4Ypg61YeXYfVbg" ref="nofollow noopener noreferrer">《独立开发者精选工具》第 019 期</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FPC-mh4mXADdBQ0ovkDbrLg" target="_blank" title="https://mp.weixin.qq.com/s/PC-mh4mXADdBQ0ovkDbrLg" ref="nofollow noopener noreferrer">《独立开发者精选工具》第 018 期</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fi_lSbscGcEMhNSlnKhZESA" target="_blank" title="https://mp.weixin.qq.com/s/i_lSbscGcEMhNSlnKhZESA" ref="nofollow noopener noreferrer">《独立开发者精选工具》第 017 期</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fxc5saU93KoJh63jFlTAPjw" target="_blank" title="https://mp.weixin.qq.com/s/xc5saU93KoJh63jFlTAPjw" ref="nofollow noopener noreferrer">《独立开发者精选工具》第 016 期</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FnHQxIBCU3VGF3x3N10aQ6Q" target="_blank" title="https://mp.weixin.qq.com/s/nHQxIBCU3VGF3x3N10aQ6Q" ref="nofollow noopener noreferrer">《独立开发者精选工具》第 015 期</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FBkyeqA_BhNY5BrvhQVw_Pw" target="_blank" title="https://mp.weixin.qq.com/s/BkyeqA_BhNY5BrvhQVw_Pw" ref="nofollow noopener noreferrer">《独立开发者精选工具》第 014 期</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F8RlROZ6HrgsVVDKwBvn8Nw" target="_blank" title="https://mp.weixin.qq.com/s/8RlROZ6HrgsVVDKwBvn8Nw" ref="nofollow noopener noreferrer">《独立开发者精选工具》第 013 期</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FTJfOjWqphdqu8kkq3I6FCg" target="_blank" title="https://mp.weixin.qq.com/s/TJfOjWqphdqu8kkq3I6FCg" ref="nofollow noopener noreferrer">《独立开发者精选工具》第 012 期</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FoUcBq_0pRU7ucmx03w5_7g" target="_blank" title="https://mp.weixin.qq.com/s/oUcBq_0pRU7ucmx03w5_7g" ref="nofollow noopener noreferrer">《独立开发者精选工具》第 011 期</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fzr-1dGOVFyTF_YG6hrSEsg" target="_blank" title="https://mp.weixin.qq.com/s/zr-1dGOVFyTF_YG6hrSEsg" ref="nofollow noopener noreferrer">《独立开发者精选工具》第 010 期</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FeKKBBDtKDb8TIy0wLko-sQ" target="_blank" title="https://mp.weixin.qq.com/s/eKKBBDtKDb8TIy0wLko-sQ" ref="nofollow noopener noreferrer">《独立开发者精选工具》第 009 期</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F01oia3vAMUgFN1-_7gIkhA" target="_blank" title="https://mp.weixin.qq.com/s/01oia3vAMUgFN1-_7gIkhA" ref="nofollow noopener noreferrer">《独立开发者精选工具》第 008 期</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FJFO5rPDbYWstu7c5zdB__Q" target="_blank" title="https://mp.weixin.qq.com/s/JFO5rPDbYWstu7c5zdB__Q" ref="nofollow noopener noreferrer">《独立开发者精选工具》第 007 期</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fcqx-TFZLXFFSf3TRwNa--w" target="_blank" title="https://mp.weixin.qq.com/s/cqx-TFZLXFFSf3TRwNa--w" ref="nofollow noopener noreferrer">《独立开发者精选工具》第 006 期</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F9dYLnfOv1Jt565-wvgBsCA" target="_blank" title="https://mp.weixin.qq.com/s/9dYLnfOv1Jt565-wvgBsCA" ref="nofollow noopener noreferrer">《独立开发者精选工具》第 005 期</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fy17Sz3GCOkoAs_kWsFHt_Q" target="_blank" title="https://mp.weixin.qq.com/s/y17Sz3GCOkoAs_kWsFHt_Q" ref="nofollow noopener noreferrer">《独立开发者精选工具》第 004 期</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FHpcKT6wqQ6E2aFrayyEfLg" target="_blank" title="https://mp.weixin.qq.com/s/HpcKT6wqQ6E2aFrayyEfLg" ref="nofollow noopener noreferrer">《独立开发者精选工具》第 003 期</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F7UYPzffH2aWWOIQRR7COlQ" target="_blank" title="https://mp.weixin.qq.com/s/7UYPzffH2aWWOIQRR7COlQ" ref="nofollow noopener noreferrer">《独立开发者精选工具》第 002 期</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FmoCAaVlagxiEoURmtP6kmw" target="_blank" title="https://mp.weixin.qq.com/s/moCAaVlagxiEoURmtP6kmw" ref="nofollow noopener noreferrer">《独立开发者精选工具》第 001 期</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Agent如何重塑跨角色协作的AI提效新范式]]></title>    <link>https://juejin.cn/post/7578892205290258472</link>    <guid>https://juejin.cn/post/7578892205290258472</guid>    <pubDate>2025-12-02T07:46:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578892205290258472" data-draft-id="7578892205289979944" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Agent如何重塑跨角色协作的AI提效新范式"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2025-12-02T07:46:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="文心快码BaiduComate"/> <meta itemprop="url" content="https://juejin.cn/user/992209294070809"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Agent如何重塑跨角色协作的AI提效新范式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/992209294070809/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    文心快码BaiduComate
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T07:46:39.000Z" title="Tue Dec 02 2025 07:46:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">什么是Agent？</h2>
<p><strong>我们开始看到一种新的“AI劳动力市场”雏形：</strong> 需求Agent、设计Agent、前端 Agent、运营Agent、数据 Agent…它们就像数字版的“岗位角色”，但永不疲惫、随时可调度。你可以把它想象成：“团队里突然多了一些懂规则、懂产品、懂代码、懂设计的AI新同事。”总结起来，<strong>Agent是“有大脑和工具调用能力”的执行者，它能做到规划、执行、调用工具、持续推进任务，完成一整套动作，是能完成任务的角色化智能体。</strong></p>
<p>举个例子，产品经理收到反馈：“百度文心快码官网风格不统一、细节处理不够好，想把统一所有页面风格。”通常，这个需求需要经历这些步骤：PM写文档 → 工程师读文档 → 工程师提问 → PM 补充 → 工程师开发 → PM验收。整个过程会面临很多问题和重复沟通：信息不对称、上下文传递不完整、需求细节被误解、工程师要不断追问、PM要不断确认逻辑、文档永远不够完备...这其实不是人的问题，而是角色之间天然存在断层。PM要表达业务逻辑，工程师要进行工程落地，两条线靠文档、会议、人力“粘”在一起。<strong>而多Agent协同，可以打通PM↔FE（前端工程师）全链路，协作从人-人，升级成了人Agent-人。</strong></p>
<h2 data-id="heading-1">案例1：Agent重构网站</h2>
<p>重构网站传统的工作流程非常繁琐，有很多步骤。有了Agent，能给传统工作流程带来啥变化呢？先来演示下：如何用Agent实现Comate官网重构。</p>
<p>Comate官网首页是偏黑色稍带星空主题，而案例页面、资讯页面等以白色为主，确实主题色不统一，来试试借助Agent，能否把统一主题的需求搞定。先让Agent梳理代码库中的主要页面：“我们要对主要页面进行风格统一，帮我罗列一下项目中主要的页面有哪些”。把需求告诉Agent，先拿一个案例页来试试：”请帮我把网站的主要页面统一成深色科技风格（黑色为主）。要求包括：主题是科技感和宇宙星空元素；统一个背景色（黑色+宇宙星空元素，宇宙星空元素要有很明显的效果）；统一布局宽度（max-width 1200px）；统一字符（font-ping-fang）；圆角统一8px；阴影（深色阴影+轻微蓝色发光）；字体颜色适配黑色背景，例如font-white；请基于上面的黑色科技风格，先帮我设计和改造“案例页”。</p>
<p>感觉星空科技感的效果不是很明显，跟Agent强调一下试试：“增加更多一些的科技感和宇宙星空的元素，丰富一下整体页面视觉效果”。这下看确实好多了，看来Agent也是喜欢聊天的，接下来适配一下其他页面：“基于刚才对案例页面的改动，同样的风格改造，对资讯页面也进行一下样式美化”。看看最终效果，简直是“买家秀”和“卖家秀”完全一致！</p>
<p>Agent重构Comate官网视频效果👉<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FcrYJB7QB2WijFxvAJaeD2g" target="_blank" title="https://mp.weixin.qq.com/s/crYJB7QB2WijFxvAJaeD2g" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/crYJB7QB2…</a></p>
<p><strong>Agent如何理解“风格”</strong> ？它不是靠关键词，而是扫描你的CSS/组件结构，建立“隐式风格模型”：阴影、字体、圆角、留白，还会根据已有页面推断“主题意图”。<strong>Agent最大的价值点是：</strong> 一次理解，多处改造；只说“换成黑色科技风”，就能给你统一方案；人类是逐页对比，而Agent可以全局扫描。</p>
<p>以前，公司每年至少有一次“大改UI”，会改主题改到崩溃。面对这种大改版，PM需要面临以下问题：</p>
<ul>
<li>UI/产品定一个规范，每个页面都要跟；</li>
<li>不同年代写的页面风格乱，很多页面的开发者可能来自不同的时间线，圆角大小不一、配色不同、字体不一致。</li>
<li>如果靠手动找、手动改，通常要2–7 天。</li>
</ul>
<p>作为PM，以前遇到这种“全站换肤”的需求，最头疼的就是“漏网之鱼”和“理解偏差”。比如PM说要有“科技感”，设计师认为是“赛博朋克”，前端认为是“蓝底白字”，最后做出来是“五彩斑斓的黑”。 而且往往改了首页、忘了详情页，或者改了按钮、忘了输入框。<strong>现在Agent能通过全局扫描代码，建立一个隐式的“风格模型”</strong> 。</p>
<p><strong>为什么“视觉类改造”是Agent的强项？</strong> 因为它能看到页面结构，不用一句句解释意图，有些Agent还能预估效果。有了Agent帮忙把信息加工好，减少了很多沟通成本，效果一目了然，需求“对齐成本”由Agent承担了～以前为了“一个圆角是4px还是8px”争论半天，现在Agent直接统刷一遍，大家都省心。有了Agent，<strong>让“执行型工作”被自动化，所有角色都往“判断、审阅、策略、决策”迁移</strong>，对传统的开发流程也产生了很大影响。</p>
<h2 data-id="heading-2">案例2：Agent改造活动页</h2>
<p>上文演示了Agent如何高效完成复杂的需求对齐。接下来挑战一个更考验效率的场景：<strong>高频、短周期的运营活动页</strong>。马上就是圣诞节了，文心快码又要搞事情了！传统流程大家都很熟悉：运营、PM提想法 → 设计师出图 → 研发开发活动组件 → 漫长的沟通和反复调整。流程链路长，为了赶上线窗口大家往往都很疲惫。现在只用三步：<strong>运营、PM提想法 → Agent结合Rules快速产出页面骨架 → 研发同学做最终集成和收尾</strong>。</p>
<p>来演示下PM如何通过文心快码Agent创建一个圣诞活动页面吧～输入指令：“把1024活动页改造成一个文心快码圣诞节活动页，要求包含活动规则模块和醒目的Banner，风格必须符合公司Design System规范。”</p>
<p>Agent已经开始工作了，这时你可能会有疑问：Agent写的代码会不会不符合公司的规范？颜色、间距会不会乱套？这就涉及Agent协作中的一个秘密武器：<strong>Rules (工程规范)</strong> 。研发会预设好design-system.md文件，这里强制规定了品牌设计师预设的“圣诞红”色值、按钮的大小、间距规范等。 这就像是给Agent戴上了一套“紧箍咒”，保证生成的页面不管怎么变，都一定符合文心快码的品牌调性。有了这套内置了工程规范的Rules，就不用花费时间去做样式Review，也不用担心PM在提需求时，Agent会生成一个和品牌格格不入的页面。<strong>Agent真正成了团队代码质量的守门人。</strong></p>
<p>节日主题页永远赶时间，因为运营想要快：明天上线、今晚改，设计可能只有一张活动的头图，前端要把主题“套”到现有页面，很花时间。Agent做主题换肤时，能根据“头图+色板+关键词”推断风格，自动添加“雪花、红绿配色、圣诞元素”，能避免你手动处理一堆margin/transition。</p>
<p>Agent改造运营活动页为圣诞节风格视频👉<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FcrYJB7QB2WijFxvAJaeD2g" target="_blank" title="https://mp.weixin.qq.com/s/crYJB7QB2WijFxvAJaeD2g" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/crYJB7QB2…</a></p>
<p>代码已经生成完成了，不仅组件和样式是规范的，连活动文案都自动填充好了：“圣诞狂欢，码力全开！” ，这可比让人头疼的各种ooxx虚拟占位符强太多了！</p>
<p>通过Agent，我们把原本需要三天的“PM/设计/FE协作流程”压缩到了<strong>几分钟，</strong> 这就是Agent重塑跨角色协作带来的提效新范式！</p>
<p><strong>人类擅长审美判断，Agent擅长重复性批量改造。</strong> 最快的方式是人类给审美方向，Agent批量铺开。我们甚至把团队里最资深运营同学的经验，做成了一个 <strong>“活动页面设计专家”</strong> 。它知道什么样的活动标题点击率高，什么样的布局转化率高。它生成的页面，是带着“运营智慧”的。</p>
<h2 data-id="heading-3">案例3：Agent构建数据统计看板</h2>
<p>上文在Agent的帮助下，高效上线了一个活动运营页面。为了方便观测活动效果，提前准备好了数据统计表，来试试让Agent构建数据看板：“在src/app/[lng]/dataAnalyse路径里面，以 src/constants/dataAnalyse.ts里面的 ACTIVITY_DATA为数据基础，制作一个适配 ACTIVITY_DATA数据格式的数据统计页面，要求有：根据 trackUuid去重，统计uv和pv数据的Echart柱状图，以天为横轴；使用antd的table展示，适配ACTIVITY_DATA数据格式的表格数据”。</p>
<p>数据页涉及表格、分页、筛选，还要对接接口、处理 loading/error，有时候还要自定义图表样式。<strong>这个场景特别适合展示Agent的“组合能力”</strong> ，帮你选图表类型，根据字段自动生成表格+Axios+TS类型，帮你生成“骨架代码 + hook + layout”。<strong>人类给目标，Agent可以自动补全细节</strong>，你可以说：“我要展示日活突增原因”，Agent可以自动提示你需要：折线图、分析维度、时间范围选择等。数据类页面很适合自动化，因为未来可能直接“上传数据库结构 → 自动生成后台系统”。</p>
<p>这里有个难点：如果让人来写，得先去读懂 ACTIVITY_DATA的数据结构是数组还是对象？字段名是 date 还是 timestamp？然后得写去重逻辑，还得去查Echarts的配置文档——配置项多到让人头皮发麻。但来看Agent的操作：它第一步就读取了数据文件的类型定义（TypeScript Interface），准确得理解了“根据trackUuid去重”这个逻辑，并自动生成了lodash的去重代码。最关键的是，Echarts的配置代码，一次性就写对了，不用研发去翻文档复制粘贴。完成后打开页面看看：柱状图出来了，表格也出来了。</p>
<p>构建数据统计Agent，并共享给全项目成员使用视频效果👉<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FcrYJB7QB2WijFxvAJaeD2g" target="_blank" title="https://mp.weixin.qq.com/s/crYJB7QB2WijFxvAJaeD2g" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/crYJB7QB2…</a></p>
<p>以后谁想看数据，把这个Agent分享给他就行，想要什么维度的数据，直接跟Agent说，它就能调整图表，这就叫 <strong>“数据民主化”</strong> 呀～</p>
<h2 data-id="heading-4">Q&amp;A</h2>
<p><strong>Q1：Agent听起来很强，会不会造成依赖？会不会变得不会自己动脑？</strong></p>
<p><strong>A：</strong> 这和IDE自动补全刚出来时大家的担心一样，但其实，我们反而更能把时间放在系统性思考上。在协作层面，本质上Agent替代的是“重复性劳动”和“对齐成本”，而不是工程师和PM的判断力。可以说：<strong>Agent把我们从“低价值沟通”中解放出来，让我们能把脑力集中在更值得思考的地方。</strong></p>
<p><strong>Q2：既然Plan Agent能拆需求、Design Agent能产图，PM在团队里的价值是不是变弱了？</strong></p>
<p><strong>A：</strong> 以前PM很多时间花在“做文档、补图、翻译给研发”。现在这些都可以交给Agent，PM能把精力放到：业务策略、用户洞察、A/B方案决策、多Agent工作流的调度，<strong>PM的角色从“信息搬运工”升级成“智能团队的策划者”。</strong></p>
<p><strong>Q3：文心快码提供了非常多的Agent，有什么使用小窍门吗？</strong></p>
<p><strong>A：</strong> 想要高效使用文心快码的多Agent ，需要抓住三个关键词：<strong>专业化、高质量和强协同</strong>。</p>
<p>首先是专业化：按任务选对Agent。如果你要转设计稿，用Figma2code；遇到Bug，就交给Debug Agent。它们内置了专业的领域知识，效率是最高的。其次是高质量：要善用规范和审查。 像上文演示的，通过Rules确保 Agent不犯低级错误，让CodeReview Agent在代码提交前自动把关规范和逻辑，这样代码就能得到双重保障。第三点，也是最关键的：利用Architect实现强协同。 Agent之间不是孤立的，一些复杂的研发任务可以通过Architect定义一个工作流，将DeepRead Agent、Actor Agent和WebSearch Agent串联起来，让它们像流水线一样自动化分析和拆解复杂任务并执行。</p>
<p><strong>Q4：怎么让Code Agent不乱改自己的项目？</strong></p>
<p><strong>A：</strong> Agent有时会越界，改动一些不需要它做的事情。Agent的能力强在“广度 + 主动性”，但也正因为主动性强，它极易越界，所以必须用规则（Rules）把它的活动范围、权限、约定全部框住。Rules不是限制能力，而是保障结果可控、可预期。</p>
<p><strong>Q5：演示过程中，对话首页有一个Spec Mode，这是什么新功能？</strong></p>
<p><strong>A：</strong> Spec模式是一种新的协作方式：让Agent先把它的理解与计划写成文档，把要做的事情拆成任务，经过用户确认再进行相应的代码编写，从而让Agent的代码生成质量和效果大幅提升。<strong>通过Spec，任务一次成功率显著提升、返工大幅减少、代码质量更稳。</strong> 目前Spec还处于Beta阶段，欢迎大家尝鲜试用，并提出意见，共同成长～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从前端工程师的角度将SEO做到极致 -- 菜鸟来实操]]></title>    <link>https://juejin.cn/post/7578902814022680591</link>    <guid>https://juejin.cn/post/7578902814022680591</guid>    <pubDate>2025-12-02T07:43:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578902814022680591" data-draft-id="7573589277004890150" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从前端工程师的角度将SEO做到极致 -- 菜鸟来实操"/> <meta itemprop="keywords" content="前端,SEO"/> <meta itemprop="datePublished" content="2025-12-02T07:43:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="PBitW"/> <meta itemprop="url" content="https://juejin.cn/user/3048261967153544"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从前端工程师的角度将SEO做到极致 -- 菜鸟来实操
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3048261967153544/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    PBitW
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T07:43:00.000Z" title="Tue Dec 02 2025 07:43:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在开发公司海外官网时，我整理了项目中的数据埋点方案，并写成一篇掘金文章：</p>
<ol>
<li><a href="https://juejin.cn/post/7366527815292878882" target="_blank" title="https://juejin.cn/post/7366527815292878882">全网最简单的 Vue 数据埋点</a></li>
</ol>
<p>其实当时就想发一篇SEO相关文章，但是当时都是参考的另一位大佬的文章，基本上使用的也就是里面的一些内容，很多东西也不知道，所以就感觉没有必要写！</p>
<p>参考文章见：<a href="https://juejin.cn/post/7380688287549800467" target="_blank" title="https://juejin.cn/post/7380688287549800467">从前端工程师的角度将SEO做到极致🌈</a></p>
<p>回头一看，发现大佬写的还是很强，我这次遇见的问题，其实这文章里面也提过了，只是菜鸟不知道大佬写的东西可以解决我的问题 /(ㄒoㄒ)/~~</p>
<p>这篇文章相当于是大佬文章的一个实践，部分没有用上，因为感觉有重复或者不知道是什么，可以酌情观看！</p>
<h2 data-id="heading-0">1、添加 TDK</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7e3787f1f53462693d012ccf0eeba89~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUEJpdFc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266180&amp;x-signature=zEl7WuSXySu1doileBgEd6hg1qc%3D" alt="image.png" loading="lazy"/></p>
<p>所以菜鸟给自己的网站是这样设置的</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Sailgene<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span>
  <span class="hljs-attr">name</span>=<span class="hljs-string">"Keywords"</span>
  <span class="hljs-attr">content</span>=<span class="hljs-string">"Sequencing,Nanopore,Revio,PacBio,ONT,DRS,ultra-long sequencing,full-length transcriptome,Full-length Transcriptome Sequencing,direct cDNA sequencing,tail iso-seq,small RNA sequencing,sRNA-seq,High-throughput Sequencing,long reads sequencing,Sailgene,NGS,TGS,WGS,Genome,Transcriptome,Metagenome,DNA sequencing,RNA sequencing"</span>
/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span>
  <span class="hljs-attr">name</span>=<span class="hljs-string">"description"</span>
  <span class="hljs-attr">content</span>=<span class="hljs-string">"The leading global provider of multi-omics services and solutions in genomics, transcriptomics, and microbiomics, equipped with PacBio Revio, Nanopore PromethION, Illumina, and DNBSEQ sequencing platforms, offers cost-effective NGS and TGS sequencing services for all sample types."</span>
/&gt;</span>
</code></pre>
<p>当时不知道 Keywords 被废弃了，所以还是加了。</p>
<h2 data-id="heading-1">2、HTML语义化</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00be5073de1f40d588b0d068470dbec7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUEJpdFc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266180&amp;x-signature=TJOSdBvplAdnkR6KPECodLQRGr4%3D" alt="image.png" loading="lazy"/></p>
<p>所以菜鸟在开发时，基本上img都加上了alt，该用h标签的就用了（且保证了每个界面只有一个h1），header、footer也都用了！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9db58a0d5b0943829e4cf4070b6ffc2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUEJpdFc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266180&amp;x-signature=JDhCiDaxnxQZ4ac%2FvxzmkJ3fPbs%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">3、Open Graph 协议</h2>
<p>菜鸟感觉这个和 <strong>meta标签的TDK</strong> 是差不多的，eg:</p>
<pre><code class="hljs language-ini" lang="ini">&lt;meta <span class="hljs-attr">property</span>=<span class="hljs-string">"og:title"</span> content=<span class="hljs-string">"Sailgene"</span> /&gt;
&lt;meta <span class="hljs-attr">property</span>=<span class="hljs-string">"og:type"</span> content=<span class="hljs-string">"organism.gene.Sequencing"</span> /&gt;
&lt;meta
  <span class="hljs-attr">property</span>=<span class="hljs-string">"og:description"</span>
  <span class="hljs-attr">content</span>=<span class="hljs-string">"The leading global provider of multi-omics services and solutions in genomics, transcriptomics, and microbiomics, equipped with PacBio Revio, Nanopore PromethION, Illumina, and DNBSEQ sequencing platforms, offers cost-effective NGS and TGS sequencing services for all sample types."</span>
/&gt;
&lt;meta
  <span class="hljs-attr">property</span>=<span class="hljs-string">"og:Keywords"</span>
  <span class="hljs-attr">content</span>=<span class="hljs-string">"Sequencing,Nanopore,Revio,PacBio,ONT,DRS,ultra-long sequencing,full-length transcriptome,Full-length Transcriptome Sequencing,direct cDNA sequencing,tail iso-seq,small RNA sequencing,sRNA-seq,High-throughput Sequencing,long reads sequencing,Sailgene,NGS,TGS,WGS,Genome,Transcriptome,Metagenome,DNA sequencing,RNA sequencing"</span>
/&gt;
</code></pre>
<p>总结：这个协议主要是 Facebook 提出来的，为了更好的展示用户分享的网页的内容，<strong>实现这个协议，有助于 SEO 优化，告诉 google 该网页有哪些内容，以及关键词等</strong>。</p>
<h2 data-id="heading-3">4、HTML lang</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8139e4e0be994259bb67523cea721e90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUEJpdFc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266180&amp;x-signature=Q03oHrj0jbZTW7eBZ3NM5xxYDSA%3D" alt="image.png" loading="lazy"/></p>
<p>当时这个菜鸟看不管啥项目都会有这个，所以暂时忽略了！</p>
<p>现在一看才发现留下了一个隐患，就是菜鸟开发的这个网站也可以中英文切换，但是切换后，我只<strong>设置了缓存里面的变化，并没有改变html的lang</strong>，所以这个希望大家可以引以为戒！</p>
<h2 data-id="heading-4">5、hreflang 属性</h2>
<p>这个和上面的不一样，菜鸟一开始以为是一个东西！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57b1ebfa84bf41feac0e44ac833631a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUEJpdFc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266180&amp;x-signature=g7OGx4%2B3qFdRl2m4q7fg4%2BE%2FTp8%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">6、SSR</h2>
<p>SSR 确实有更好的SEO效果，但是当时技术选型的时候没有考虑到需要推广，直接用了vue单页面开发，所以<strong>最开始的时候一定要确定好方向</strong>！</p>
<h2 data-id="heading-6">7、sitemap 站点地图 - 重点</h2>
<p>这个就是菜鸟这次加上的，具体原因是：</p>
<blockquote>
<p>香港及美国有2个公司，域名为（<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.sailgene.com" target="_blank" title="http://www.sailgene.com" ref="nofollow noopener noreferrer">www.sailgene.com</a> 和 <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.sailgene.us%25EF%25BC%2589%2C%25E4%25BD%2586%25E6%2598%25AFgoogle%25E7%2594%25A8sailgene%25E5%2585%25B3%25E9%2594%25AE%25E5%25AD%2597%25E6%2590%259C%25E7%25B4%25A2%25EF%25BC%258C%25E5%258F%25AA%25E8%2583%25BD%25E6%2590%259C%25E7%25B4%25A2%25E5%2587%25BA" target="_blank" title="http://www.sailgene.us%EF%BC%89,%E4%BD%86%E6%98%AFgoogle%E7%94%A8sailgene%E5%85%B3%E9%94%AE%E5%AD%97%E6%90%9C%E7%B4%A2%EF%BC%8C%E5%8F%AA%E8%83%BD%E6%90%9C%E7%B4%A2%E5%87%BA" ref="nofollow noopener noreferrer">www.sailgene.us）,但是google用sailgene关键字搜索，只能搜索出</a> <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.sailgene.com" target="_blank" title="http://www.sailgene.com" ref="nofollow noopener noreferrer">www.sailgene.com</a></p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46c2c775aebe4944b1f70b530f2ebcc9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUEJpdFc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266180&amp;x-signature=gA6Ha%2Bk63aQ6HwhvDPRAblTSvXk%3D" alt="image.png" loading="lazy"/></p>
<p>然后就问了如何实现 <strong>提交sitemap.xml</strong> 和 <strong>手动让 Google 抓取</strong></p>
<p>发现<code>sitemap.xml</code>就是一个文件，建好之后提交到服务器的<code>index.html</code>同级目录下就行。格式如下：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">urlset</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.sitemaps.org/schemas/sitemap/0.9"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">loc</span>&gt;</span>https://www.sailgene.com/<span class="hljs-tag">&lt;/<span class="hljs-name">loc</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">lastmod</span>&gt;</span>2025-11-18<span class="hljs-tag">&lt;/<span class="hljs-name">lastmod</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">priority</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">priority</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">loc</span>&gt;</span>https://www.sailgene.com/#/content<span class="hljs-tag">&lt;/<span class="hljs-name">loc</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">lastmod</span>&gt;</span>2025-11-18<span class="hljs-tag">&lt;/<span class="hljs-name">lastmod</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">priority</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">priority</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">loc</span>&gt;</span>https://www.sailgene.com/#/about<span class="hljs-tag">&lt;/<span class="hljs-name">loc</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">lastmod</span>&gt;</span>2025-11-18<span class="hljs-tag">&lt;/<span class="hljs-name">lastmod</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">priority</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">priority</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">loc</span>&gt;</span>https://www.sailgene.com/#/contactus<span class="hljs-tag">&lt;/<span class="hljs-name">loc</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">lastmod</span>&gt;</span>2025-11-18<span class="hljs-tag">&lt;/<span class="hljs-name">lastmod</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">priority</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">priority</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">loc</span>&gt;</span>https://www.sailgene.com/#/resources/sample<span class="hljs-tag">&lt;/<span class="hljs-name">loc</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">lastmod</span>&gt;</span>2025-11-18<span class="hljs-tag">&lt;/<span class="hljs-name">lastmod</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">priority</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">priority</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">loc</span>&gt;</span>https://www.sailgene.com/#/services/0<span class="hljs-tag">&lt;/<span class="hljs-name">loc</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">lastmod</span>&gt;</span>2025-11-18<span class="hljs-tag">&lt;/<span class="hljs-name">lastmod</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">priority</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">priority</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">loc</span>&gt;</span>https://www.sailgene.com/#/services/1<span class="hljs-tag">&lt;/<span class="hljs-name">loc</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">lastmod</span>&gt;</span>2025-11-18<span class="hljs-tag">&lt;/<span class="hljs-name">lastmod</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">priority</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">priority</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">loc</span>&gt;</span>https://www.sailgene.com/#/services/2<span class="hljs-tag">&lt;/<span class="hljs-name">loc</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">lastmod</span>&gt;</span>2025-11-18<span class="hljs-tag">&lt;/<span class="hljs-name">lastmod</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">priority</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">priority</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">loc</span>&gt;</span>https://www.sailgene.com/#/services/3<span class="hljs-tag">&lt;/<span class="hljs-name">loc</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">lastmod</span>&gt;</span>2025-11-18<span class="hljs-tag">&lt;/<span class="hljs-name">lastmod</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">priority</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">priority</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
  ……
<span class="hljs-tag">&lt;/<span class="hljs-name">urlset</span>&gt;</span>
</code></pre>
<p>然后<strong>手动让Goole录入</strong>，就是需要登录：<a href="https://link.juejin.cn?target=https%3A%2F%2Fsearch.google.com%2Fsearch-console" target="_blank" title="https://search.google.com/search-console" ref="nofollow noopener noreferrer">search.google.com/search-cons…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c986692d84214a5f9f53aa494d0c5c8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUEJpdFc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266180&amp;x-signature=i58HEQ%2Fp8QRc%2FAdX1PHAfPHE7nk%3D" alt="image.png" loading="lazy"/></p>
<p>菜鸟这里操作错了，把这个Goole生成的文件放到服务器的<code>index.html</code>同级目录下了，<strong>不知道有没有用，反正验证通过了，然后就跳转到了这里</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a007964a8da4380a6aa79d57b3759e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUEJpdFc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266180&amp;x-signature=45Px0f1PXLF5YVll4b7NOyiAClo%3D" alt="image.png" loading="lazy"/></p>
<p>这里还要再进行站点地图的设置</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0daddab96dee463aad2b1b99d07a3bb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUEJpdFc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266180&amp;x-signature=SkODgimlxQrFNyBrvE%2BEkFDvQgw%3D" alt="image.png" loading="lazy"/></p>
<p>点击</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a4f35c003594836a77982daaaadc151~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUEJpdFc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266180&amp;x-signature=zl%2BpvJibYNJSBeO7hmhctB6Hh2w%3D" alt="image.png" loading="lazy"/></p>
<p>然后输入并提交即可</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a00e4b7413740c29fb37a1355d0be5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUEJpdFc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266180&amp;x-signature=ihmYmvwDsSpWqKkGZ0BychQSEfw%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-7">注意</h3>
<blockquote>
<p>需要等待两三天，Goole 才会搜录，需要耐心！</p>
</blockquote>
<h3 data-id="heading-8">成果展示</h3>
<p>这是优化后，被搜录了的展示</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/550e0873a5e3418cbd33cdbe23cb3bb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUEJpdFc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266180&amp;x-signature=%2FhFV1OP5vVN%2FWu1qB8W4tMJiCpQ%3D" alt="image.png" loading="lazy"/></p>
<p>但是还是老话，SPA并不适合做搜录，搜录的也仅仅只是首页或者空白模板，只有搜<strong>网站名</strong>才能出现，搜网页内容是不会出现的！</p>
<h2 data-id="heading-9">8、结构化数据</h2>
<p>这里菜鸟也用错了，直接复制的大佬文章里面的代码，然后自己改成了这样</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"application/ld+json"</span>&gt;</span><span class="javascript">
  {
    <span class="hljs-string">"@context"</span>: <span class="hljs-string">"https://schema.org"</span>,
    <span class="hljs-string">"@type"</span>: <span class="hljs-string">"Product"</span>,
    <span class="hljs-string">"headline"</span>: <span class="hljs-string">"Sequencing,Nanopore,Revio,PacBio,ONT,DRS,ultra-long sequencing,full-length transcriptome,Full-length Transcriptome Sequencing,direct cDNA sequencing,tail iso-seq,small RNA sequencing,sRNA-seq,High-throughput Sequencing,long reads sequencing,Sailgene,NGS,TGS,WGS,Genome,Transcriptome,Metagenome,DNA sequencing,RNA sequencing"</span>
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>其实这个JSON-LD相当于一门有规定的语言，不能像菜鸟这样乱写，不会生效，具体见：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.google.com%2Fsearch%2Fdocs%2Fappearance%2Fstructured-data%2Fcarousel%3Fhl%3Dzh-cn" target="_blank" title="https://developers.google.com/search/docs/appearance/structured-data/carousel?hl=zh-cn" ref="nofollow noopener noreferrer">developers.google.com/search/docs…</a></p>
<h2 data-id="heading-10">9、robots.txt</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a60e6e191bf4745a33b9db0c7407a51~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUEJpdFc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266180&amp;x-signature=9%2F6E2o5VjAOYNbXLP3sc7ssTSgY%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-11">注意</h3>
<p>但是菜鸟在写下篇文章<a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">SPA到SSR的升级之路！</a>时，发现<code>Nuxt</code>是会带上这个文件的，所以就要注意配置！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef29ca381c8648aa9cbef316e94de1b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUEJpdFc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266180&amp;x-signature=ifrbiSu2M8j6GtPB9u3GuM%2BfjAA%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-12">10、余下</h2>
<p>余下的是我没有使用到的但是我感觉有用的，可以直接去看大佬的文章<a href="https://juejin.cn/post/7380688287549800467" target="_blank" title="https://juejin.cn/post/7380688287549800467">从前端工程师的角度将SEO做到极致🌈</a>，但是怕大佬删掉了，所以我截图放这里保存一下!</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d48df8d8dac34d1a82db236595461af5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUEJpdFc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266180&amp;x-signature=sX0pV17qdqYFhUm8ZEZVyNW2SQk%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-13">效果</h2>
<p>有图真相，这个是掘金的SEO评分：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9a724c5b11f4a7491ae95232f7dcfc2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUEJpdFc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266180&amp;x-signature=7JjvxGbzxbVG9pHbxn%2FL0mvdvQQ%3D" alt="image.png" loading="lazy"/></p>
<p>这是我优化完，我的网站的SEO评分：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de98c97611744c8ea4ccabad88b723db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUEJpdFc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266180&amp;x-signature=pMuCLRGUth88geJxBeRQNKSiy8M%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PHP header already sent：中文乱码、BOM、空格导致的全套解决方案（图文版）]]></title>    <link>https://juejin.cn/post/7578853751530389519</link>    <guid>https://juejin.cn/post/7578853751530389519</guid>    <pubDate>2025-12-02T07:09:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578853751530389519" data-draft-id="7578853751530307599" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PHP header already sent：中文乱码、BOM、空格导致的全套解决方案（图文版）"/> <meta itemprop="keywords" content="PHP"/> <meta itemprop="datePublished" content="2025-12-02T07:09:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户60732036945"/> <meta itemprop="url" content="https://juejin.cn/user/2156565626632060"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PHP header already sent：中文乱码、BOM、空格导致的全套解决方案（图文版）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2156565626632060/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户60732036945
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T07:09:50.000Z" title="Tue Dec 02 2025 07:09:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你是不是也遇到过这个经典报错：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">Warning:</span> Cannot modify header information - headers already sent <span class="hljs-keyword">by</span>...
</code></pre>
<p>中文名就叫：</p>
<blockquote>
<p><strong>“还没来得及发 HTTP 头，你就先输出东西了”</strong></p>
</blockquote>
<p>别慌，这绝对不是大问题，但也是 PHP 新手最容易踩的坑。<br/>
今天我用最简单的方式，带你把这个问题彻底讲懂。</p>
<hr/>
<h2 data-id="heading-0">1⃣ 这个错误到底什么意思？</h2>
<p>一句话解释：</p>
<blockquote>
<p>你调用 <code>header()</code>、<code>setcookie()</code>、<code>session_start()</code> 之前，<br/>
代码里已经“悄悄输出了一些东西”。</p>
</blockquote>
<p>这些“输出”可能是：</p>
<ul>
<li>一个看不见的空格</li>
<li>一个回车符</li>
<li>隐藏的 BOM 字节</li>
<li>你自己 echo/var_dump 的内容</li>
<li>引入文件里的输出</li>
</ul>
<p>只要有一点点输出，header 就会报错。</p>
<hr/>
<h2 data-id="heading-1">2⃣ 最常见的罪魁祸首：<strong>UTF-8 BOM</strong></h2>
<p>很多编辑器默认保存为“UTF-8 BOM”，而 PHP 最怕 BOM。</p>
<p>BOM 会在文件最开头偷偷输出三个字节：</p>
<pre><code class="hljs">EF BB BF
</code></pre>
<p>你看不见，但服务器能看到。</p>
<p>于是服务器说：</p>
<blockquote>
<p>“啊你已经输出了，我就不能设置 header 了。”</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">✔ 如何判断文件是不是 BOM？</h3>
<p>症状明显：</p>
<ul>
<li>中文突然乱码</li>
<li>header 报错特别早</li>
<li>新建文件使用过 Windows 记事本 / Dreamweaver</li>
</ul>
<hr/>
<h3 data-id="heading-3">✔ 如何去掉 BOM？</h3>
<p><strong>VSCode</strong><br/>
右下角 → 点击“UTF-8” → 选择 <strong>UTF-8（无 BOM）</strong> 保存即可。</p>
<p><strong>Notepad++</strong><br/>
菜单 → 格式 → 选择 <strong>UTF-8（无 BOM）</strong></p>
<p><strong>宝塔面板编辑器 / PHPStorm</strong><br/>
默认不会带 BOM，比较安全。</p>
<hr/>
<h2 data-id="heading-4">3⃣ 第二大元凶：文件顶部的空格 + 回车</h2>
<p>PHP 文件头部常见两种错误：</p>
<p>❌ 错误写法 1：</p>
<pre><code class="hljs language-php" lang="php">(空格)(空格)
<span class="hljs-meta">&lt;?php</span>
</code></pre>
<p>❌ 错误写法 2：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-comment">// 顶部多了一行空行</span>
</code></pre>
<p>这两个都会导致 header 报错。</p>
<hr/>
<h3 data-id="heading-5">✔ 正确写法</h3>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
</code></pre>
<p>第一行第一列必须是 <code>&lt;?php</code>，上面不能有任何内容。</p>
<p>记住：<br/>
<strong>空格也算输出！回车也算输出！</strong></p>
<hr/>
<h2 data-id="heading-6">4⃣ 第三类：你自己输出的调试信息</h2>
<p>最容易忘的情况：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">var_dump</span>($data);  
<span class="hljs-selector-tag">header</span>("Location: /index.php");
</code></pre>
<p>你调试一下忘记删了，header 直接挂掉。</p>
<p>其它输出包括：</p>
<ul>
<li>echo</li>
<li>print</li>
<li>print_r</li>
<li>die</li>
<li>exit</li>
</ul>
<p>都要检查一遍。</p>
<hr/>
<h2 data-id="heading-7">5⃣ include/require 的文件里也可能有输出</h2>
<p>主文件可能没问题，但你这样写：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-built_in">require</span> <span class="hljs-string">'config.php'</span>;
<span class="hljs-title function_">header</span>(<span class="hljs-string">"Location: xxx.php"</span>);
</code></pre>
<p>只要 config.php 有：</p>
<ul>
<li>BOM</li>
<li>空格</li>
<li>echo</li>
<li>HTML</li>
</ul>
<p>都会导致 header 报错。</p>
<p>记得 <strong>所有被引入的文件也要检查</strong>。</p>
<hr/>
<h2 data-id="heading-8">6⃣ 万能解决方案：输出缓冲（最稳）</h2>
<p>如果你实在搞不清哪里输出了，可以直接使用：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">ob_start</span>();
</code></pre>
<p>把它放在所有代码最上方。</p>
<p>PHP 会把所有输出暂存，<br/>
等你把 header / cookie / session 都设置完，<br/>
再统一输出。</p>
<hr/>
<h2 data-id="heading-9">7⃣ 最稳定推荐写法（复制就能用）</h2>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-title function_ invoke__">ob_start</span>();
<span class="hljs-title function_ invoke__">session_start</span>();
<span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">"Content-Type: text/html; charset=utf-8"</span>);

<span class="hljs-comment">// 你的逻辑...</span>
</code></pre>
<p>这套写法能避免 99% 的 “header already sent”。</p>
<h2 data-id="heading-10">9⃣ 最后给你一个超实用排查顺序（收藏版）</h2>
<ol>
<li>检查文件顶部是否有空格/空行</li>
<li>转成 UTF-8 无 BOM</li>
<li>搜索所有 output（echo/print/var_dump）</li>
<li>检查 include 的文件</li>
<li>统一加 <code>ob_start()</code></li>
<li>不行再检查 CDN 或 gzip（非常少见）</li>
</ol>
<p>按这顺序查，10 分钟必解决。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>