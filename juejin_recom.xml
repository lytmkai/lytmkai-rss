<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Webpack 与 Rollup 中 Tree-shaking 的实现原理与效果]]></title>    <link>https://juejin.cn/post/7571768210715820047</link>    <guid>https://juejin.cn/post/7571768210715820047</guid>    <pubDate>2025-11-13T09:15:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571768210715820047" data-draft-id="7571815997067640872" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Webpack 与 Rollup 中 Tree-shaking 的实现原理与效果"/> <meta itemprop="keywords" content="前端,Webpack,rollup.js"/> <meta itemprop="datePublished" content="2025-11-13T09:15:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="拉不动的猪"/> <meta itemprop="url" content="https://juejin.cn/user/1429793504759630"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Webpack 与 Rollup 中 Tree-shaking 的实现原理与效果
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1429793504759630/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    拉不动的猪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:15:22.000Z" title="Thu Nov 13 2025 09:15:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAABWVJREFUWAnlVktsVFUY/s85997pC9BOTKxRWnEKsXWlxjWJj0RWJjrFAAXjAlewYWOkgauACVu7a2IiNUEyExM3yoZE3Wmi7qgPJthJBDE6JUNpO3Mf5/j95/bOTOcBlBgXejJ37rn/Of/7O/9/iP7vQ/zTAcjnC4ry+a5ii1OkiYTpuvjvEc0Gp51uivP+ZW+QBuSW4QjW5rptAa1Ey0uOGKOxwPetVyafN6p/52/PkNBbjdAhGaGEpMRjLZTryB8+9MUSYSGNRIcBvm8kBAY9tHYlHz78nTs392xIkwv9FA3Oe33bdoX1ZZKOS0bH0CXI6RugYLW6BwIu5gskkQ4sEG0wYF25PjBzbZfSYY6kDLUmWMt7FR7Lw3xYUkaTdjxHfTPnPwav0iEGYADVa9XIRIEyxrAA0jIQxgFL22gYwF7A8/DAzNVdksJvJaTEUZ2kYnZWziN5s1ADPHneEIXByotYuMSrf9JEbbsuv7VcvbaKML8plXtQR0EdIYDqWEmtOgAomZFH8EjWSnek2ulmtljljttHbmaIHCCCHzd9MjwfsmscBeZH9Jyd10nMvz92UQrtCBKvMF06mQy0SiEdRMEGg8mN0YjAlgoDDkPrMI5qJKSkKKydpbB2CZjJkhIBvOBw2CGQgii85bpx//dMqFRKam5uvH7w+K97oe+Cl0HO68uIBH0qyEzpOMwIbZIcFq0I+9cwoElizCjk2KFI1y7Nnx614W1db58fOXIlMzs7Xn/jeDmvBV2Q0mXjGf554O/m4LZHp2N8r61WPMvLZWLdiC4GMAk5BjeeB5lhv39l6+BIbu3m760hXMDKBD08XBKzR8fr04nygnIypOOAJUx/fHrsi0Mnys+vVK+V4VUohaiyPCo2Q9DFALvF/ikw8WS4QvVZALS5ksw47/7R8ejgTPk1UFqU6/3zp8bOM7B/kdu/fkguPGU5JibW+F0sTjWOUw8DklRrg4BiLGeBqbaRLxjlT4no0InFV402RcftJz41cH/f/JnHP3kZaaF6VX/liwist9vYG5+NU9Cg3MNkt/+lU5wS8fTxq3mc7ILjDlAE4CJpe89BOWPiIjBhi9O6PI4G1jsc6RGB3lZwmS76k8H0zOKTkFboG8jS2krFKCX2fvTeaPHIBwAkMHHgncURnL3nuCSnxSopdIzN5th0BIonJ0Lf9yUA9iMkzdRWl3BixOusfDcwQVcS4UKIFwYfGPnM8wY/DyP9NFMXaTE5BU39tGkDgGZz+fJJG0oYcSaOafLcqdECY4LzfSObSzyUOgxqtyisr8SSNOOAkubWoh3TTaeA2YtFEXPnm5x81/j+6MI6JqyS25WSNU6hbCMKHG84marJbdR+vwakRhQLRuQpbzHRLjmpmijI+OmWCtq+LzWtnX5v30gHSsqmWne74DtiACi2+Wz0iXbuLt9D2cDyoPEkWOiyp5XUIwLMi/wJY1FbH5B9ONtdC1KrsD/Q0MCQAS0wccILORDW25amAeOtooAj/KQxfzF17uwTSQ1v3dJ7jnLINwdZYRDa4tPU0sHVXFo/vxFF5BqFqxRfOmgPCk4ft2NgKTCy2Y47JIEg+MIhjYsLy5I25qUYTQlCjMRHsr/UwdYwIK33UO1J5fFNB9XNO6akcywJofVmXQDP2wfrSPcI2xG5BSs3I+IosHr4EtvO1TDAu16xHQq5+ykMblfRXLbhEoFIdDTBdhldvzl+3CMg60ZktI2vNzLW6IIp0waLklot9L63yzuUp8dJd7bglPFe3hIXstBEP58/s6Ocyr4rH2+866ZNbriTzA0RSOWCwakMl1QJgculxPt8Z7O5GLdtW6bvU8R/nO1vb+hMExVAVtEAAAAASUVORK5CYII=");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAhRJREFUeAHtnLEuBFEUhs9cu7JCskEhIrZAgYZGoREPwBuIygOoPITKA6jEG/AAolFoaFCgICIKZBNiY8Pyz5rNOWe9wNz5T7N3Z2eT/b/7zZlpziat3xKWBDJoEyh5EDd3DTk5r8vV7Yc8vzbl6zvfwvSERIYHyzI90SeLc1WZrFV85PR9oi+N/YMnOT6t/3tiLAeXFqqytjrSFacDYmfvQS6u37tOiPHA7FS/bK6PmWhpj4AJRYGA9MiKzLpK6An+cqiNVmRleUhArrec6PNzt/5sttLgh0cvcvfY6Px+ZNY9I6Ax6gKErY1xmZ8ZyD0E5MJGIgsyIZsunT3g7qALJuTdAp0nWyMTsunS2QNukbpwOcRaPpvOHvxzQow2ZBvrs+nsfLL8o0QQBJFdMO1XGkEjaIQlQCMsD/YIGkEjLAEaYXmwR9AIGmEJ0AjLgz2CRtAIS4BGWB7sETSCRlgCNMLyYI+gETTCEqARlgd7BI2gEZYAjbA82CNoBI2wBGiE5cEeQSNohCVAIywP9ggaQSMsARphebBH0AgaYQnQCMsjYC5SF2agYi2fTWcPGA7VFfO0n8+mswdMyOrCNJwnpz/P6xqZkE2Xzh4w8qcLI4Hbu/dydvkWBRAAQBZk0uOOyKyzp5PARRiF1puNtR+NTh+oMCvtJ+D8F2N6j6x+PrwzG46gRTDDm5BtsAGBg0X924Qfj7i23p7HNgQAAAAASUVORK5CYII=");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAABMtJREFUeAHtXM2KFDEQzrQKruIu4mEXRFlUVLz4A4K7B99AcO8io0/gwQfxDVzFuwu+gQf34EG8iOAPKAh6EFlBFMSf/qa2uqszlVR6ZtYxM5PDJNVVSer78nU6KrHzpyxuVlwx44AY2O0T8eb9D7f5fMu9fPvdff7y0/36nbdgdhUdd+jgHnf62JxbObvgjh/d60Pu2R35ajx49Mk9frqlBk7Kw8sXF9y1K4t9cCoi7tz/4F68/tYXMIkPzpzY725dP9yA1tsjoIRpIQHogRWYZSmwJ4Reh06nI2Nd7rYEA8zAzqXAxhgq/pc1d9vHKbEX+Dr4JbzypJDc/YxXYi/wifRLeOXpU5q7n/FK7EXsnBBeeRoqd7/EHj1ZhleeiMjdz8pArRKR+0pb+UsCuK0SkftKW/kzeFmrRHCAxWzufsaJOkqExWzufpOI8EpP1jnCJCK80pN1jjCJ4ICwMigidz/jRD3bI7bZUInIfaWt/KUSuK0SEd4jqFvufgYva5UIDrCYzd3POFFHifhfV/7k8lwPw7D5mUSEV3r854ju2pK7ffOIWzk/X+Go803Lr+ooGqoiwkyP9xzRXVt0q9sE3CgJYTLqfNPyE/irpkoEe2um6ck4bSiBSeD8JBl41jY/Hgd1lIiaaeoyLlsjgUGAjEH3DB4DtUpEW2Z3Mj5GAgA8efbVvXpX/200nln5IMYvKhHDrvylcwdc9+pSNdeg46WQsP7wo2s7fpWYaPT926fw9ZiVk4BpywYJkGuvlJs4EuWS0p/HTyHh3kbzH2najM85cR0lgpPiYMtukFB26m1u5Ua+vkFkWP3Zn0KCJDg1Px6f42Wtvhrhdyz8ncanrFKCmGH1wrwDMCrh/uxPIUFTAvdHbeVPsc1fVRE+c7Ud/k6fWt7XHFlYqcqQ5wTRvWpiY4wrIZwfDUL+akDRUBXB/jCzFCH9SHCzTDRUmsro7z+cEvrHwxOZn2ZTL/pVFcEBtRLoiWXfxQ5ehvoHHx4vpIwUEuJKSMvPz5/zQq0qwmIy5m+rjBQSwnsCQYnlgwjfT72av6oifOba2qnKcOXeGVIP0rT3BALTNr8mBWSpRHAgmJSTtLGhDHwj+A9GPCbX2DNiBSRoShg0H8zl5y/njxIhJ0WntralDJmIbO+UEvz85Zwt9wj7HIDB5Ttp7RkyGbRDSqC49vOjX50P9aexmr+qInzmajvtO13H02SpyrCVMNj8dT7/4BwByDXzRIC0LWXEldA/njVfip9GpV9VERxQM0lPhrVDyrCVMJr5/fwZJ+qWewR1lSuNJ21sXxnjVgIhck5VhM/cqG1WBpIAMX4Z9Xz+eP58sFUiOBArLQcZpQ0CNCXt1HzA5OfPOFGrrwYHyKTwbNJsxolaJUJbKeo0mu/4uMeXBHBbJSK88qP5jo97fAYva5UIDgivHEXk7mecqKNEhFeOhsjdbxKR+0pb+UsCuK0qIveVtvJn8LJWieAAi9nc/YwTdZQIi9nc/SYR4ZWenSO2yZvgcwTuRYZKWBnUI3e/xF7gcmio5L4HWPlL7AVuyPol95W28me8EnuBa8J+sZjM3c94JfYCd6VxTXjaCjDLe+K9cwTuSuOa8LQUYPXvh1d3w0HC7JK8kMK0/rcJfwHkVMYgi4xhOgAAAABJRU5ErkJggg==");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Tree-shaking 是现代前端构建工具中用于消除死代码（未被使用的代码）的重要优化手段，核心原理是利用 ES6 模块的静态特性（<code>import</code>/<code>export</code>）分析代码依赖，剔除未被引用的导出内容。</p>
<h3 data-id="heading-0">一、Tree-shaking 核心前提</h3>
<p>Tree-shaking 仅对 <strong>ES6 模块（ESM）</strong>  有效，因为 ESM 具有以下静态特性：</p>
<ul>
<li>模块依赖关系在编译时确定（而非运行时）。</li>
<li><code>import</code>/<code>export</code> 语句只能出现在模块顶层，无法动态修改。</li>
</ul>
<p>CommonJS 模块（<code>require</code>/<code>module.exports</code>）因依赖关系动态化，无法被 Tree-shaking 优化。</p>
<h3 data-id="heading-1">二、Rollup 中的 Tree-shaking</h3>
<p>Rollup 是专注于 ES 模块打包的工具，Tree-shaking 是其原生核心功能，实现简洁且高效。</p>
<h4 data-id="heading-2">1. 实现原理</h4>
<p>Rollup 通过以下步骤实现 Tree-shaking：</p>
<ol>
<li><strong>依赖解析</strong>：遍历模块的 <code>import</code>/<code>export</code> 语句，构建模块依赖图。</li>
<li><strong>标记未使用代码</strong>：从入口模块出发，追踪所有被引用的导出（<code>export</code>），未被引用的导出被标记为 “死代码”。</li>
<li><strong>删除死代码</strong>：在打包阶段直接剔除标记的死代码，不生成冗余内容。</li>
</ol>
<p>Rollup 对代码的静态分析更彻底，且默认输出未被混淆的代码，因此 Tree-shaking 效果直观可见。</p>
<h4 data-id="heading-3">2. 代码示例与效果</h4>
<h5 data-id="heading-4">源文件</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils.js（ES 模块）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">add</span> = (<span class="hljs-params">a, b</span>) =&gt; a + b;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">minus</span> = (<span class="hljs-params">a, b</span>) =&gt; a - b; <span class="hljs-comment">// 未被使用的函数</span>

<span class="hljs-comment">// index.js（入口文件）</span>
<span class="hljs-keyword">import</span> { add } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils.js'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)); <span class="hljs-comment">// 仅使用 add</span>
</code></pre>
<h5 data-id="heading-5">Rollup 配置（<code>rollup.config.js</code>）</h5>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  input: <span class="hljs-string">'src/index.js'</span>,
  output: {
    file: <span class="hljs-string">'dist/bundle.js'</span>,
    format: <span class="hljs-string">'es'</span> <span class="hljs-comment">// 输出 ES 模块（保留 import/export，便于观察）</span>
  }
};
</code></pre>
<h5 data-id="heading-6">打包结果（<code>dist/bundle.js</code>）</h5>
<pre><code class="hljs language-css" lang="css">const add = (<span class="hljs-selector-tag">a</span>, <span class="hljs-selector-tag">b</span>) =&gt; <span class="hljs-selector-tag">a</span> + <span class="hljs-selector-tag">b</span>;
console<span class="hljs-selector-class">.log</span>(add(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>));
</code></pre>
<ul>
<li><strong>效果</strong>：未被使用的 <code>minus</code> 函数被完全剔除，输出代码简洁。</li>
</ul>
<h3 data-id="heading-7">三、Webpack 中的 Tree-shaking</h3>
<p>Webpack 从 v2 开始支持 Tree-shaking，但实现逻辑更复杂，受多种因素影响（如模式、压缩工具等）。</p>
<h4 data-id="heading-8">1. 实现原理</h4>
<p>Webpack 的 Tree-shaking 分为三个阶段：</p>
<ol>
<li>
<p><strong>标记阶段</strong>：</p>
<ul>
<li>解析 ES 模块的 <code>import</code>/<code>export</code>，通过 <code>ModuleConcatenationPlugin</code> 分析模块依赖。</li>
<li>对未被引用的导出标记为 <code>/* unused harmony export xxx */</code>（仅标记，不删除）。</li>
</ul>
</li>
<li>
<p><strong>删除阶段</strong>：</p>
<ul>
<li>依赖 <strong>压缩工具（如 Terser）</strong>  剔除标记的死代码。</li>
<li>仅在 <code>production</code> 模式下默认启用（开发模式为保留代码不删除）。</li>
</ul>
</li>
<li>
<p><strong>副作用处理</strong>：</p>
<ul>
<li>通过 <code>package.json</code> 的 <code>sideEffects</code> 字段标记模块是否有副作用（如全局变量修改、DOM 操作），避免误删有副作用的代码。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-9">2. 代码示例与效果</h4>
<h5 data-id="heading-10">源文件（同 Rollup 示例）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">add</span> = (<span class="hljs-params">a, b</span>) =&gt; a + b;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">minus</span> = (<span class="hljs-params">a, b</span>) =&gt; a - b; <span class="hljs-comment">// 未被使用</span>

<span class="hljs-comment">// index.js</span>
<span class="hljs-keyword">import</span> { add } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils.js'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>));
</code></pre>
<h5 data-id="heading-11">Webpack 配置（<code>webpack.config.js</code>）</h5>
<pre><code class="hljs language-css" lang="css">module<span class="hljs-selector-class">.exports</span> = {
  entry: <span class="hljs-string">'./src/index.js'</span>,
  output: {
    filename: <span class="hljs-string">'bundle.js'</span>,
    path: path.<span class="hljs-built_in">resolve</span>(__dirname, <span class="hljs-string">'dist'</span>)
  },
  mode: <span class="hljs-string">'production'</span> // 必须为 production 模式才会删除死代码
};
</code></pre>
<h5 data-id="heading-12">打包结果（<code>dist/bundle.js</code>，简化后）</h5>
<pre><code class="hljs language-arduino" lang="arduino">console.<span class="hljs-built_in">log</span>(<span class="hljs-number">3</span>); <span class="hljs-comment">// add(1,2) 被直接计算，minus 完全删除</span>
</code></pre>
<ul>
<li><strong>效果</strong>：未被使用的 <code>minus</code> 被剔除，且 <code>add</code> 函数因逻辑简单被进一步优化（直接计算结果）。</li>
</ul>
<h4 data-id="heading-13">3. 关键配置：<code>sideEffects</code></h4>
<p>如果模块存在副作用（如修改全局变量），需在 <code>package.json</code> 中声明，避免被误删：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"sideEffects"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"./src/polyfill.js"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 有副作用的模块</span>
    <span class="hljs-string">"*.css"</span> <span class="hljs-comment">// CSS 文件通常有副作用（插入样式）</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li><code>sideEffects: false</code>：表示所有模块均无副作用，可安全删除未引用代码。</li>
</ul>
<h3 data-id="heading-14">四、核心差异对比</h3>



































<table><thead><tr><th>特性</th><th>Rollup</th><th>Webpack</th></tr></thead><tbody><tr><td><strong>分析能力</strong></td><td>原生支持 ESM 静态分析，更彻底</td><td>需依赖插件（<code>ModuleConcatenationPlugin</code>），分析逻辑较复杂</td></tr><tr><td><strong>删除死代码时机</strong></td><td>打包阶段直接删除</td><td>依赖压缩工具（Terser）在优化阶段删除</td></tr><tr><td><strong>开发模式效果</strong></td><td>即使开发模式也会删除死代码</td><td>仅 <code>production</code> 模式删除（开发模式保留用于调试）</td></tr><tr><td><strong>输出可读性</strong></td><td>输出代码接近源码，Tree-shaking 效果直观</td><td>输出代码经压缩混淆，效果需反推</td></tr><tr><td><strong>适用场景</strong></td><td>库文件打包（如工具库、组件库）</td><td>应用程序打包（依赖复杂、需处理多种模块类型）</td></tr></tbody></table>
<h3 data-id="heading-15">五、总结</h3>
<ul>
<li><strong>Rollup</strong>：Tree-shaking 实现简洁高效，输出代码干净，适合库文件打包（如 React、Vue 等）。</li>
<li><strong>Webpack</strong>：Tree-shaking 需配合压缩工具和模式配置，功能更全面（支持多种模块类型、复杂依赖），适合应用程序打包。</li>
</ul>
<h3 data-id="heading-16">六、直观点</h3>
<ul>
<li>整个过程就像 “清理房间”：先摸清房间里的物品（依赖解析）→ 标记没用的垃圾（标记死代码）→ 直接扔掉垃圾（删除死代码）；</li>
<li>对比 Webpack ：Rollup 是 “边打包边扔垃圾”，Webpack 是 “先标记垃圾，最后找清洁工（Terser）扔”，所以 Rollup 的产物更直观看到剔除效果。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[kotlin-4]]></title>    <link>https://juejin.cn/post/7571678674144854026</link>    <guid>https://juejin.cn/post/7571678674144854026</guid>    <pubDate>2025-11-12T12:47:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571678674144854026" data-draft-id="7571088527678275610" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="kotlin-4"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-11-12T12:47:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风冷"/> <meta itemprop="url" content="https://juejin.cn/user/3843548379091742"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            kotlin-4
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3843548379091742/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风冷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T12:47:15.000Z" title="Wed Nov 12 2025 12:47:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    15
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>太棒了！现在让我们进入 Kotlin 最激动人心的部分——<strong>协程</strong>和<strong>现代异步编程</strong>。这将彻底改变你处理并发和异步任务的方式。</p>
<hr/>
<h3 data-id="heading-0"><strong>Kotlin 协程：重新定义异步编程</strong></h3>
<h4 data-id="heading-1"><strong>二十二、协程基础：轻量级线程</strong></h4>
<p>协程是 Kotlin 用于异步编程的解决方案，比线程更轻量、更高效。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    println(<span class="hljs-string">"主线程开始: <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
    
    <span class="hljs-comment">// 启动一个协程</span>
    GlobalScope.launch {
        println(<span class="hljs-string">"协程开始: <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
        delay(<span class="hljs-number">1000L</span>) <span class="hljs-comment">// 非阻塞延迟</span>
        println(<span class="hljs-string">"协程结束: <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
    }
    
    println(<span class="hljs-string">"主线程继续执行: <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
    Thread.sleep(<span class="hljs-number">2000L</span>) <span class="hljs-comment">// 阻塞主线程，等待协程完成</span>
    println(<span class="hljs-string">"主线程结束"</span>)
}

<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 主线程开始: main</span>
<span class="hljs-comment">// 主线程继续执行: main</span>
<span class="hljs-comment">// 协程开始: DefaultDispatcher-worker-1</span>
<span class="hljs-comment">// 协程结束: DefaultDispatcher-worker-1</span>
<span class="hljs-comment">// 主线程结束</span>
</code></pre>
<p><strong>关键概念：</strong></p>
<ul>
<li><code>launch</code>: 启动一个不返回结果的协程</li>
<li><code>delay()</code>: 非阻塞的挂起函数</li>
<li>协程运行在后台线程池，不会阻塞主线程</li>
</ul>
<h4 data-id="heading-2"><strong>二十三、挂起函数：异步操作的基石</strong></h4>
<p>挂起函数是协程的核心，用 <code>suspend</code>关键字标记。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fetchUserData</span><span class="hljs-params">(userId: <span class="hljs-type">Int</span>)</span></span>: String {
    delay(<span class="hljs-number">1000L</span>) <span class="hljs-comment">// 模拟网络请求</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"用户 <span class="hljs-variable">$userId</span> 的数据"</span>
}

<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fetchUserPosts</span><span class="hljs-params">(userId: <span class="hljs-type">Int</span>)</span></span>: String {
    delay(<span class="hljs-number">1500L</span>) <span class="hljs-comment">// 模拟数据库查询</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"用户 <span class="hljs-variable">$userId</span> 的帖子"</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> time = measureTimeMillis {
        <span class="hljs-keyword">val</span> userData = fetchUserData(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">val</span> userPosts = fetchUserPosts(<span class="hljs-number">1</span>)
        println(<span class="hljs-string">"<span class="hljs-variable">$userData</span>, <span class="hljs-variable">$userPosts</span>"</span>)
    }
    println(<span class="hljs-string">"顺序执行耗时: <span class="hljs-subst">${time}</span>ms"</span>)
}
</code></pre>
<h4 data-id="heading-3"><strong>二十四、异步并发：同时执行多个任务</strong></h4>
<p>使用 <code>async</code>和 <code>await</code>实现并发操作。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*
<span class="hljs-keyword">import</span> kotlin.system.measureTimeMillis

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> time = measureTimeMillis {
        <span class="hljs-comment">// 同时启动两个异步任务</span>
        <span class="hljs-keyword">val</span> userDataDeferred = async { fetchUserData(<span class="hljs-number">1</span>) }
        <span class="hljs-keyword">val</span> userPostsDeferred = async { fetchUserPosts(<span class="hljs-number">1</span>) }
        
        <span class="hljs-comment">// 等待两个任务都完成</span>
        <span class="hljs-keyword">val</span> userData = userDataDeferred.await()
        <span class="hljs-keyword">val</span> userPosts = userPostsDeferred.await()
        
        println(<span class="hljs-string">"<span class="hljs-variable">$userData</span>, <span class="hljs-variable">$userPosts</span>"</span>)
    }
    println(<span class="hljs-string">"并发执行耗时: <span class="hljs-subst">${time}</span>ms"</span>) <span class="hljs-comment">// 时间接近最长任务的时间</span>
}

<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 用户 1 的数据, 用户 1 的帖子</span>
<span class="hljs-comment">// 并发执行耗时: 1506ms (而不是 1000 + 1500 = 2500ms)</span>
</code></pre>
<h4 data-id="heading-4"><strong>二十五、协程上下文与调度器</strong></h4>
<p>控制协程在哪个线程上运行。</p>
<pre><code class="hljs language-scss" lang="scss">import kotlinx<span class="hljs-selector-class">.coroutines</span>.*

fun <span class="hljs-selector-tag">main</span>() = runBlocking {
    <span class="hljs-comment">// 在不同调度器上启动协程</span>
    launch { <span class="hljs-comment">// 继承父协程的上下文</span>
        <span class="hljs-built_in">println</span>("默认调度器: ${Thread.currentThread()<span class="hljs-selector-class">.name</span>}")
    }
    
    <span class="hljs-built_in">launch</span>(Dispatchers.Unconfined) { <span class="hljs-comment">// 不受限制，在第一个挂起点之前运行在调用者线程</span>
        <span class="hljs-built_in">println</span>("不受限制: ${Thread.currentThread()<span class="hljs-selector-class">.name</span>}")
    }
    
    <span class="hljs-built_in">launch</span>(Dispatchers.Default) { <span class="hljs-comment">// CPU 密集型任务</span>
        <span class="hljs-built_in">println</span>("默认调度器: ${Thread.currentThread()<span class="hljs-selector-class">.name</span>}")
    }
    
    <span class="hljs-built_in">launch</span>(Dispatchers.IO) { <span class="hljs-comment">// I/O 密集型任务</span>
        <span class="hljs-built_in">println</span>("IO 调度器: ${Thread.currentThread()<span class="hljs-selector-class">.name</span>}")
    }
    
    <span class="hljs-built_in">launch</span>(newSingleThreadContext("MyThread")) { <span class="hljs-comment">// 专用线程</span>
        <span class="hljs-built_in">println</span>("专用线程: ${Thread.currentThread()<span class="hljs-selector-class">.name</span>}")
    }
}
</code></pre>
<h4 data-id="heading-5"><strong>二十六、结构化并发：避免资源泄漏</strong></h4>
<p>使用 <code>coroutineScope</code>实现结构化并发。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-comment">// 结构化并发：所有子协程完成后，父协程才完成</span>
    <span class="hljs-keyword">val</span> result = coroutineScope {
        <span class="hljs-keyword">val</span> userData = async { fetchUserData(<span class="hljs-number">1</span>) }
        <span class="hljs-keyword">val</span> userPosts = async { fetchUserPosts(<span class="hljs-number">1</span>) }
        
        <span class="hljs-string">"结果: <span class="hljs-subst">${userData.await()}</span> + <span class="hljs-subst">${userPosts.await()}</span>"</span>
    }
    println(result)
}

<span class="hljs-comment">// 处理异常的结构化并发</span>
<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fetchDataSafely</span><span class="hljs-params">()</span></span>: Result&lt;String&gt; = coroutineScope {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = async { 
            delay(<span class="hljs-number">500L</span>)
            <span class="hljs-keyword">if</span> (System.currentTimeMillis() % <span class="hljs-number">2</span> == <span class="hljs-number">0L</span>) {
                <span class="hljs-keyword">throw</span> RuntimeException(<span class="hljs-string">"模拟错误"</span>)
            }
            <span class="hljs-string">"获取的数据"</span>
        }.await()
        Result.success(<span class="hljs-keyword">data</span>)
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        Result.failure(e)
    }
}
</code></pre>
<h4 data-id="heading-6"><strong>二十七、流（Flow）：异步数据流</strong></h4>
<p>Flow 是 Kotlin 的响应式流处理，类似 RxJava。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*
<span class="hljs-keyword">import</span> kotlinx.coroutines.flow.*

<span class="hljs-comment">// 创建流</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">simpleFlow</span><span class="hljs-params">()</span></span>: Flow&lt;<span class="hljs-built_in">Int</span>&gt; = flow {
    println(<span class="hljs-string">"流开始"</span>)
    <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.3</span>) {
        delay(<span class="hljs-number">100L</span>) <span class="hljs-comment">// 模拟异步工作</span>
        emit(i) <span class="hljs-comment">// 发射值</span>
    }
}

<span class="hljs-comment">// 流的中间操作</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">processNumbers</span><span class="hljs-params">()</span></span>: Flow&lt;String&gt; = flow {
    <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.5</span>) {
        emit(i)
    }
}.filter { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> } <span class="hljs-comment">// 过滤偶数</span>
 .map { <span class="hljs-string">"数字: <span class="hljs-variable">$it</span>"</span> }    <span class="hljs-comment">// 转换</span>
 .onEach { println(<span class="hljs-string">"处理: <span class="hljs-variable">$it</span>"</span>) } <span class="hljs-comment">// 副作用</span>

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-comment">// 收集流</span>
    simpleFlow().collect { value -&gt; 
        println(<span class="hljs-string">"收集到: <span class="hljs-variable">$value</span>"</span>) 
    }
    
    println(<span class="hljs-string">"--- 带中间操作的流 ---"</span>)
    processNumbers().collect { println(<span class="hljs-string">"最终结果: <span class="hljs-variable">$it</span>"</span>) }
}
</code></pre>
<h4 data-id="heading-7"><strong>二十八、通道（Channel）：协程间通信</strong></h4>
<p>Channel 用于协程之间的通信。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*
<span class="hljs-keyword">import</span> kotlinx.coroutines.channels.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> channel = Channel&lt;String&gt;()
    
    <span class="hljs-comment">// 生产者协程</span>
    launch {
        <span class="hljs-keyword">val</span> users = listOf(<span class="hljs-string">"Alice"</span>, <span class="hljs-string">"Bob"</span>, <span class="hljs-string">"Charlie"</span>)
        <span class="hljs-keyword">for</span> (user <span class="hljs-keyword">in</span> users) {
            channel.send(user) <span class="hljs-comment">// 发送数据</span>
            delay(<span class="hljs-number">100L</span>)
        }
        channel.close() <span class="hljs-comment">// 关闭通道</span>
    }
    
    <span class="hljs-comment">// 消费者协程</span>
    launch {
        <span class="hljs-keyword">for</span> (user <span class="hljs-keyword">in</span> channel) { <span class="hljs-comment">// 接收数据</span>
            println(<span class="hljs-string">"收到用户: <span class="hljs-variable">$user</span>"</span>)
        }
        println(<span class="hljs-string">"通道已关闭"</span>)
    }
}
</code></pre>
<h4 data-id="heading-8"><strong>二十九、实战：构建完整的异步应用</strong></h4>
<p>让我们构建一个完整的用户信息获取系统。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*
<span class="hljs-keyword">import</span> kotlinx.coroutines.flow.*
<span class="hljs-keyword">import</span> kotlin.system.measureTimeMillis

<span class="hljs-comment">// 数据类</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> email: String)
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Post</span>(<span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> userId: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> title: String, <span class="hljs-keyword">val</span> content: String)
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserProfile</span>(<span class="hljs-keyword">val</span> user: User, <span class="hljs-keyword">val</span> posts: List&lt;Post&gt;, <span class="hljs-keyword">val</span> friends: List&lt;User&gt;)

<span class="hljs-comment">// 模拟远程数据源</span>
<span class="hljs-keyword">object</span> UserRepository {
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUser</span><span class="hljs-params">(id: <span class="hljs-type">Int</span>)</span></span>: User {
        delay(<span class="hljs-number">500L</span>) <span class="hljs-comment">// 模拟网络延迟</span>
        <span class="hljs-keyword">return</span> User(id, <span class="hljs-string">"用户<span class="hljs-variable">$id</span>"</span>, <span class="hljs-string">"user<span class="hljs-variable">$id</span>@example.com"</span>)
    }
    
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUserPosts</span><span class="hljs-params">(userId: <span class="hljs-type">Int</span>)</span></span>: List&lt;Post&gt; {
        delay(<span class="hljs-number">300L</span>)
        <span class="hljs-keyword">return</span> listOf(
            Post(<span class="hljs-number">1</span>, userId, <span class="hljs-string">"标题1"</span>, <span class="hljs-string">"内容1"</span>),
            Post(<span class="hljs-number">2</span>, userId, <span class="hljs-string">"标题2"</span>, <span class="hljs-string">"内容2"</span>)
        )
    }
    
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUserFriends</span><span class="hljs-params">(userId: <span class="hljs-type">Int</span>)</span></span>: List&lt;User&gt; {
        delay(<span class="hljs-number">400L</span>)
        <span class="hljs-keyword">return</span> listOf(
            User(userId + <span class="hljs-number">1</span>, <span class="hljs-string">"朋友1"</span>, <span class="hljs-string">"friend1@example.com"</span>),
            User(userId + <span class="hljs-number">2</span>, <span class="hljs-string">"朋友2"</span>, <span class="hljs-string">"friend2@example.com"</span>)
        )
    }
}

<span class="hljs-comment">// 业务逻辑层</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUserProfile</span><span class="hljs-params">(userId: <span class="hljs-type">Int</span>)</span></span>: UserProfile = coroutineScope {
        <span class="hljs-keyword">val</span> userDeferred = async { UserRepository.getUser(userId) }
        <span class="hljs-keyword">val</span> postsDeferred = async { UserRepository.getUserPosts(userId) }
        <span class="hljs-keyword">val</span> friendsDeferred = async { UserRepository.getUserFriends(userId) }
        
        UserProfile(
            user = userDeferred.await(),
            posts = postsDeferred.await(),
            friends = friendsDeferred.await()
        )
    }
    
    <span class="hljs-comment">// 使用 Flow 实现实时更新</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUserProfileStream</span><span class="hljs-params">(userId: <span class="hljs-type">Int</span>)</span></span>: Flow&lt;UserProfile&gt; = flow {
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            <span class="hljs-keyword">val</span> profile = getUserProfile(userId)
            emit(profile)
            delay(<span class="hljs-number">5000L</span>) <span class="hljs-comment">// 每5秒更新一次</span>
        }
    }
}

<span class="hljs-comment">// UI 层（模拟）</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> userService = UserService()
    
    println(<span class="hljs-string">"=== 获取用户资料 ==="</span>)
    <span class="hljs-keyword">val</span> time = measureTimeMillis {
        <span class="hljs-keyword">val</span> profile = userService.getUserProfile(<span class="hljs-number">1</span>)
        println(<span class="hljs-string">"用户: <span class="hljs-subst">${profile.user.name}</span>"</span>)
        println(<span class="hljs-string">"帖子数量: <span class="hljs-subst">${profile.posts.size}</span>"</span>)
        println(<span class="hljs-string">"好友数量: <span class="hljs-subst">${profile.friends.size}</span>"</span>)
    }
    println(<span class="hljs-string">"耗时: <span class="hljs-subst">${time}</span>ms"</span>)
    
    println(<span class="hljs-string">"\n=== 实时数据流 ==="</span>)
    <span class="hljs-comment">// 模拟实时数据流（只收集3次）</span>
    userService.getUserProfileStream(<span class="hljs-number">1</span>)
        .take(<span class="hljs-number">3</span>) <span class="hljs-comment">// 只取3个值</span>
        .collect { profile -&gt;
            println(<span class="hljs-string">"实时更新: <span class="hljs-subst">${profile.user.name}</span> - 帖子: <span class="hljs-subst">${profile.posts.size}</span>"</span>)
        }
}
</code></pre>
<h4 data-id="heading-9"><strong>三十、异常处理与超时控制</strong></h4>
<pre><code class="hljs language-scss" lang="scss">import kotlinx<span class="hljs-selector-class">.coroutines</span>.*

fun <span class="hljs-selector-tag">main</span>() = runBlocking {
    <span class="hljs-comment">// 1. 基本的异常处理</span>
    val job = launch {
        try {
            <span class="hljs-built_in">delay</span>(<span class="hljs-number">1000</span>L)
            throw <span class="hljs-built_in">RuntimeException</span>("测试异常")
        } catch (e: Exception) {
            <span class="hljs-built_in">println</span>("捕获异常: ${e.message}")
        }
    }
    job<span class="hljs-selector-class">.join</span>()
    
    <span class="hljs-comment">// 2. 协程异常处理器</span>
    val handler = CoroutineExceptionHandler { _, exception -&gt;
        <span class="hljs-built_in">println</span>("协程异常处理器捕获: ${exception.message}")
    }
    
    val job2 = <span class="hljs-built_in">launch</span>(handler) {
        throw <span class="hljs-built_in">RuntimeException</span>("被处理器捕获的异常")
    }
    job2<span class="hljs-selector-class">.join</span>()
    
    <span class="hljs-comment">// 3. 超时控制</span>
    try {
        <span class="hljs-built_in">withTimeout</span>(<span class="hljs-number">1300</span>L) {
            repeat(<span class="hljs-number">1000</span>) { <span class="hljs-selector-tag">i</span> -&gt;
                <span class="hljs-built_in">println</span>("任务 $i")
                <span class="hljs-built_in">delay</span>(<span class="hljs-number">500</span>L)
            }
        }
    } catch (e: TimeoutCancellationException) {
        <span class="hljs-built_in">println</span>("任务超时")
    }
    
    <span class="hljs-comment">// 4. 超时返回默认值</span>
    val result = <span class="hljs-built_in">withTimeoutOrNull</span>(<span class="hljs-number">1300</span>L) {
        <span class="hljs-built_in">delay</span>(<span class="hljs-number">1000</span>L)
        "成功结果"
    } ?: <span class="hljs-string">"超时默认值"</span>
    
    <span class="hljs-built_in">println</span>(<span class="hljs-string">"结果: $result"</span>)
}
</code></pre>
<h4 data-id="heading-10"><strong>三十一、高级模式：生产者-消费者模式</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*
<span class="hljs-keyword">import</span> kotlinx.coroutines.channels.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> CoroutineScope.<span class="hljs-title">produceUsers</span><span class="hljs-params">()</span></span> = produce {
    <span class="hljs-keyword">var</span> id = <span class="hljs-number">1</span>
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        send(User(id, <span class="hljs-string">"用户<span class="hljs-variable">$id</span>"</span>, <span class="hljs-string">"user<span class="hljs-variable">$id</span>@example.com"</span>))
        delay(<span class="hljs-number">200L</span>)
        id++
        <span class="hljs-keyword">if</span> (id &gt; <span class="hljs-number">5</span>) <span class="hljs-keyword">break</span> <span class="hljs-comment">// 只生产5个用户</span>
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> CoroutineScope.<span class="hljs-title">processUser</span><span class="hljs-params">(userChannel: <span class="hljs-type">ReceiveChannel</span>&lt;<span class="hljs-type">User</span>&gt;)</span></span> = produce {
    <span class="hljs-keyword">for</span> (user <span class="hljs-keyword">in</span> userChannel) {
        delay(<span class="hljs-number">100L</span>) <span class="hljs-comment">// 模拟处理时间</span>
        send(<span class="hljs-string">"已处理: <span class="hljs-subst">${user.name}</span>"</span>)
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> userProducer = produceUsers()
    <span class="hljs-keyword">val</span> processor = processUser(userProducer)
    
    <span class="hljs-comment">// 消费处理结果</span>
    <span class="hljs-keyword">for</span> (result <span class="hljs-keyword">in</span> processor) {
        println(result)
    }
    
    println(<span class="hljs-string">"处理完成"</span>)
}
</code></pre>
<h4 data-id="heading-11"><strong>下一步学习方向</strong></h4>
<p>你现在已经掌握了 Kotlin 协程的核心概念！接下来可以探索：</p>
<ol>
<li><strong>Flow 高级操作</strong>：<code>combine</code>、<code>zip</code>、<code>flatMapLatest</code>等操作符</li>
<li><strong>状态管理</strong>：使用 <code>StateFlow</code>和 <code>SharedFlow</code></li>
<li><strong>测试协程</strong>：使用 <code>TestCoroutineDispatcher</code>和 <code>runTest</code></li>
<li><strong>Android 上的协程</strong>：与 ViewModel、Lifecycle 集成</li>
<li><strong>服务端协程</strong>：Ktor 框架的使用</li>
</ol>
<p>协程是 Kotlin 生态中最强大的特性之一，它将彻底改变你处理异步编程的方式。尝试在实际项目中使用这些模式，你会发现代码变得更加简洁和易于维护！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Day 10：08. 基于Nuxt开发博客项目-关于我页面开发]]></title>    <link>https://juejin.cn/post/7572004684178358326</link>    <guid>https://juejin.cn/post/7572004684178358326</guid>    <pubDate>2025-11-13T09:17:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572004684178358326" data-draft-id="7571808096936919081" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Day 10：08. 基于Nuxt开发博客项目-关于我页面开发"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2025-11-13T09:17:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="申阳"/> <meta itemprop="url" content="https://juejin.cn/user/4353721775165486"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Day 10：08. 基于Nuxt开发博客项目-关于我页面开发
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4353721775165486/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    申阳
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:17:38.000Z" title="Thu Nov 13 2025 09:17:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5056bca77be34136a2fa1fc117528418~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630277&amp;x-signature=3Rcu7m98lM6FTqD0mK3menEz0oA%3D" alt="PixPin_2025-11-13_17-12-30.gif" loading="lazy"/></p>
<h2 data-id="heading-0">一、前言</h2>
<p>在个人博客项目中，"关于我"页面是访客了解博主的重要窗口。一个设计合理、内容丰富的关于我页面不仅能展示个人专业能力，还能增加博客的亲和力和可信度。当然你可以完全 <code>DIY</code> 这个模块，或者也可以参考我的设计，这个页面主要包含信息卡片、个人简介、技术栈、工作经历和教育经历等模块。</p>
<p>这个是我的示例站点，在这里可以看到我目前的进度，<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.csyblog.cn%2F" target="_blank" title="https://www.csyblog.cn/" ref="nofollow noopener noreferrer">www.csyblog.cn/</a></p>
<h2 data-id="heading-1">二、信息卡片</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d36b17996cce434fa3af663b698900fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630277&amp;x-signature=FENXJuLz3jt3xYRRfX1CSyDFcEs%3D" alt="image.png" loading="lazy"/></p>
<p>实现思路很简单，就是一些基础的布局和细节样式调整，如果实现比较手生，通过咨询<code>AI</code>也很容易完成。</p>
<p>这个模块主要是展示博主头像、基本信息和社交链接。</p>
<blockquote>
<p>如果需要源码可以通过这里的联系方式联系我，我会给你当前最新的代码。因为还不够完善，所以暂时不开源。</p>
</blockquote>
<h2 data-id="heading-2">三、个人简介</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/177893abcc8549cf8c00da86f20c07df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630277&amp;x-signature=TnlHkfb4UpHnOtoeRUm3t8vI2I8%3D" alt="image.png" loading="lazy"/></p>
<p>这里其实就是个简短的自我介绍。</p>
<h2 data-id="heading-3">四、技术栈</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e65a44d240c944739749a71d20a2f85a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630277&amp;x-signature=enG9KRkB2gS4UA%2FSzzmDlH%2F4Lmw%3D" alt="image.png" loading="lazy"/></p>
<p>这个模块主要作用就是，展示一下自己的技术栈，知道的，了解的一股脑往上堆就好了。</p>
<h2 data-id="heading-4">五、工作经历&amp;教育经历</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f871f56eaad54111b2150b359a1d9081~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630277&amp;x-signature=dH5LBIZ9RPWUs2%2BFn8wPRQp59Es%3D" alt="image.png" loading="lazy"/></p>
<p>这里我建议要么就别写，要写就写真实的，这是人与人最基本的信任，没必要打肿脸充胖子，杜撰一些华丽的履历出来，到时候经不起考验，也是搬石头砸自己的脚。</p>
<h2 data-id="heading-5">六、首页修改</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/440ef09935ca4f03b523022b808bd875~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630277&amp;x-signature=s7Nwv4rg3GjjrDRQKz6kR2Dvte4%3D" alt="PixPin_2025-11-13_17-06-07.gif" loading="lazy"/></p>
<p>因为关于我页面我写了工作经验与教育背景，这和我之前首页展示的有重复，所以我找了个炫酷的标签云组件放这里。</p>
<h2 data-id="heading-6">七、总结</h2>
<p>这个页面比较简单，但是要从0到1做出来，还是花了我不少时间的。找图标，调样式，痛并快乐着。</p>
<p>下面我们就要进入真正的重头戏了，博客模块的开发。</p>
<p><strong>千里之行，始于足下。你的“个人公司”从这第一个2小时开始。欢迎在评论区分享你的进展或遇到的卡点，我会逐一查看，尽可能的帮助解决。我们下一篇文章见！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Golang 构建网络漏洞扫描器]]></title>    <link>https://juejin.cn/post/7571753301899182120</link>    <guid>https://juejin.cn/post/7571753301899182120</guid>    <pubDate>2025-11-13T08:47:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571753301899182120" data-draft-id="7571815997067558952" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Golang 构建网络漏洞扫描器"/> <meta itemprop="keywords" content="Go"/> <meta itemprop="datePublished" content="2025-11-13T08:47:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="俞凡"/> <meta itemprop="url" content="https://juejin.cn/user/290747765274222"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Golang 构建网络漏洞扫描器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/290747765274222/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    俞凡
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T08:47:46.000Z" title="Thu Nov 13 2025 08:47:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读22分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><em>本文完整介绍了如何基于 Golang 从零开始开发一个完善的网络漏洞扫描器。原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.sitepoint.com%2Fbuilding-a-network-vulnerability-scanner-with-go" title="https://www.sitepoint.com/building-a-network-vulnerability-scanner-with-go" target="_blank" ref="nofollow noopener noreferrer">Building a Network Vulnerability Scanner with Go</a></em></p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bf49b7179b94dbeb43509caad6fd7d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-e5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763628466&amp;x-signature=EzA9Y%2FliENriQ%2FqWo58Exa%2FmHtc%3D" alt="" loading="lazy"/></p>
<p>本文将用 Go 语言创建一个简单且相当可靠的网络漏洞扫描器。Go 语言非常适合网络编程，它在设计时就考虑到了并发性，并且拥有出色的标准库。</p>
<h2 data-id="heading-0">1. 项目设置</h2>
<h5 data-id="heading-1">创建漏洞扫描器</h5>
<p>我们想要开发一个简单的命令行工具，该工具能够扫描主机网络、查找开放端口、识别运行的服务并发现潜在漏洞。这个扫描器一开始会非常简单，但随着逐步添加功能，其能力会不断增强。</p>
<p>首先，我们将创建一个新的 Go 项目：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> goscan
<span class="hljs-built_in">cd</span> goscan
go mod init github.com/yourusername/goscan
</code></pre>
<p>这将为项目初始化新的Go模块，帮助我们管理依赖项。</p>
<h5 data-id="heading-2">配置包和环境</h5>
<p>扫描器将利用若干 Go 包：</p>
<pre><code class="hljs language-golang" lang="golang"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"net"</span>
    <span class="hljs-string">"os"</span>
    <span class="hljs-string">"strconv"</span>
    <span class="hljs-string">"sync"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    fmt.Println(<span class="hljs-string">"GoScan - Network Vulnerability Scanner"</span>)
}
</code></pre>
<p>这只是初始设置，但对于初始功能来说，已经足够了，我们会根据需要添加更多导入内容。像 <code>net</code> 这样的标准库包将负责处理大部分网络相关操作，而 <code>sync</code> 则会负责并发处理等。</p>
<h5 data-id="heading-3">网络扫描的伦理考量与风险</h5>
<p>在开始实现之前，首先需要探讨一下与网络扫描相关的伦理问题。在许多地区，未经授权的网络扫描是违法的，会被视为发动网络攻击的一种手段。因此，必须始终遵守以下规则：</p>
<ul>
<li><strong>许可</strong>：仅对拥有所有权或已获得明确许可进行扫描的临时网络和系统进行扫描。</li>
<li><strong>范围</strong>：为扫描设定明确的范围，并不要超出该范围。</li>
<li><strong>时间</strong>：不要进行可能导致服务中断或引发安全警报的过度扫描。</li>
<li><strong>披露</strong>：如果发现漏洞，请负责任的将其报告给相应的系统所有者。</li>
<li><strong>法律合规</strong>：了解并遵守有关网络扫描的当地法律。</li>
</ul>
<p>扫描工具的不当使用可能会导致法律诉讼、系统损坏或意外服务中断。我们的扫描器将包含诸如速率限制等防护措施，但最终责任在于用户以合乎道德的方式使用。</p>
<h2 data-id="heading-4">2. 简单端口扫描器</h2>
<p>漏洞评估基于端口扫描。每个开放端口所提供的潜在易受攻击的服务信息正是我们所要查找的内容。现在，让我们用 Go 语言编写一个简单的端口扫描器。</p>
<h5 data-id="heading-5">低级端口扫描实现</h5>
<p>端口扫描：尝试与目标主机上的每一个可能的端口建立连接。如果连接成功，则该端口是开放的；如果连接失败，则该端口是关闭的或被过滤的。对于此功能，Go 的 <code>net</code> 包已经为我们提供了支持。</p>
<p>那么，这就是我们所设计的一种简单的端口扫描器的示例：</p>
<pre><code class="hljs language-golang" lang="golang"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"net"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">scanPort</span><span class="hljs-params">(host <span class="hljs-type">string</span>, port <span class="hljs-type">int</span>, timeout time.Duration)</span></span> <span class="hljs-type">bool</span> {
    target := fmt.Sprintf(<span class="hljs-string">"%s:%d"</span>, host, port)
    conn, err := net.DialTimeout(<span class="hljs-string">"tcp"</span>, target, timeout)
    
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }
    
    conn.Close()
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    host := <span class="hljs-string">"localhost"</span> <span class="hljs-comment">// Change this to your target</span>
    timeout := time.Second * <span class="hljs-number">2</span>
    
    fmt.Printf(<span class="hljs-string">"Scanning host: %s\n"</span>, host)
    
    <span class="hljs-comment">// Scan ports 1-1024 (well-known ports)</span>
    <span class="hljs-keyword">for</span> port := <span class="hljs-number">1</span>; port &lt;= <span class="hljs-number">1024</span>; port++ {
        <span class="hljs-keyword">if</span> scanPort(host, port, timeout) {
            fmt.Printf(<span class="hljs-string">"Port %d is open\n"</span>, port)
        }
    }
    
    fmt.Println(<span class="hljs-string">"Scan complete"</span>)
}
</code></pre>
<h5 data-id="heading-6">使用 <code>net</code> 包</h5>
<p>上述代码使用了 Go 语言的 <code>net</code> 包，该包提供了网络输入/输出接口及相关函数。那么，主要的组成部分都有哪些呢？</p>
<ul>
<li><strong>net.DialTimeout</strong>：此功能会尝试在设定的超时时间内连接到 TCP 网络地址。如果连接成功，会返回连接信息以及任何可能出现的错误。</li>
<li><strong>连接处理</strong>：如果连接过程顺利，我们便知道该连接已打开，并会立即关闭该连接以释放资源。</li>
<li><strong>超时参数</strong>：设定超时时间，以避免在任何被过滤的开放端口上陷入僵局。两秒是一个不错的初始值，但可根据网络状况进行调整。</li>
</ul>
<h5 data-id="heading-7">对首次扫描进行测试</h5>
<p>现在，我们在本地主机上运行简单扫描器，那里可能有一些服务正在运行。</p>
<ul>
<li>将代码保存到名为 <code>main.go</code> 的文件中</li>
<li>用 <code>go run main.go</code> 命令运行</li>
</ul>
<p>这将显示哪些本地端口是开放的。在普通开发机器上，可能会有 80（HTTP）端口、443（HTTPS）端口，或者根据运行的服务不同，还有其他任意数量的数据库端口正在使用。</p>
<p>以下是一些可能得到的示例输出：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Scanning host: localhost
Port <span class="hljs-number">22</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">open</span>
Port <span class="hljs-number">80</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">open</span>
Port <span class="hljs-number">443</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">open</span>
Scan complete
</code></pre>
<p>使用这种基本的扫描器是可以的，但也有不少明显的缺点：</p>
<ul>
<li><strong>速度</strong>：由于是按顺序扫描端口，所以速度极其缓慢。</li>
<li><strong>信息</strong>：只是告诉我们某个端口是否开放，没有服务信息。</li>
<li><strong>覆盖范围有限</strong>：只扫描前 1024 个端口。</li>
</ul>
<p>这些限制使得难以在实际应用中使用扫描器。</p>
<h2 data-id="heading-8">3. 从这里开始改进：多线程扫描</h2>
<h5 data-id="heading-9">为何最初的版本运行缓慢</h5>
<p>第一个端口扫描器能够正常工作，但其运行速度极其缓慢，几乎无法实际使用。问题在于其采用顺序扫描方法 —— 一次扫描一个端口。当一台主机有很多关闭/过滤的端口时，会在每个端口上等待连接超时，然后再转移到下一个端口，这造成了极大的时间浪费。</p>
<p>为了展示这个问题，我们来看看基本扫描器的运行时间：</p>
<ul>
<li>对于扫描前 1024 个端口的情况，如果设置 2 秒的超时时间，最长时间将达 2048 秒（超过 34 分钟）。</li>
<li>但即便对那些已关闭的端口的连接也会立即失败，这种方法由于网络延迟的原因也是效率低下。</li>
</ul>
<p>这种逐个端口进行的扫描方式是任何真正的漏洞扫描工具的瓶颈。</p>
<h5 data-id="heading-10">添加线程支持</h5>
<p>Go 语言在利用协程和通道实现并发方面表现尤为出色。因此，我们利用这些特性尝试同时扫描多个端口，从而显著提高性能。</p>
<p>现在让我们来创建多线程端口扫描器：</p>
<pre><code class="hljs language-golang" lang="golang"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"net"</span>
    <span class="hljs-string">"sync"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-keyword">type</span> Result <span class="hljs-keyword">struct</span> {
    Port  <span class="hljs-type">int</span>
    State <span class="hljs-type">bool</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">scanPort</span><span class="hljs-params">(host <span class="hljs-type">string</span>, port <span class="hljs-type">int</span>, timeout time.Duration)</span></span> Result {
    target := fmt.Sprintf(<span class="hljs-string">"%s:%d"</span>, host, port)
    conn, err := net.DialTimeout(<span class="hljs-string">"tcp"</span>, target, timeout)
    
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> Result{Port: port, State: <span class="hljs-literal">false</span>}
    }
    
    conn.Close()
    <span class="hljs-keyword">return</span> Result{Port: port, State: <span class="hljs-literal">true</span>}
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">scanPorts</span><span class="hljs-params">(host <span class="hljs-type">string</span>, start, end <span class="hljs-type">int</span>, timeout time.Duration)</span></span> []Result {
    <span class="hljs-keyword">var</span> results []Result
    <span class="hljs-keyword">var</span> wg sync.WaitGroup
    
    <span class="hljs-comment">// Create a buffered channel to collect results</span>
    resultChan := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> Result, end-start+<span class="hljs-number">1</span>)
    
    <span class="hljs-comment">// Create a semaphore to limit concurrent goroutines</span>
    <span class="hljs-comment">// This prevents us from opening too many connections at once</span>
    semaphore := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{}, <span class="hljs-number">100</span>) <span class="hljs-comment">// Limit to 100 concurrent scans</span>
    
    <span class="hljs-comment">// Launch goroutines for each port</span>
    <span class="hljs-keyword">for</span> port := start; port &lt;= end; port++ {
        wg.Add(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(p <span class="hljs-type">int</span>)</span></span> {
            <span class="hljs-keyword">defer</span> wg.Done()
            
            <span class="hljs-comment">// Acquire semaphore</span>
            semaphore &lt;- <span class="hljs-keyword">struct</span>{}{}
            <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> { &lt;-semaphore }() <span class="hljs-comment">// Release semaphore</span>
            
            result := scanPort(host, p, timeout)
            resultChan &lt;- result
        }(port)
    }
    
    <span class="hljs-comment">// Close channel when all goroutines complete</span>
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        wg.Wait()
        <span class="hljs-built_in">close</span>(resultChan)
    }()
    
    <span class="hljs-comment">// Collect results from channel</span>
    <span class="hljs-keyword">for</span> result := <span class="hljs-keyword">range</span> resultChan {
        <span class="hljs-keyword">if</span> result.State {
            results = <span class="hljs-built_in">append</span>(results, result)
        }
    }
    
    <span class="hljs-keyword">return</span> results
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    host := <span class="hljs-string">"localhost"</span> <span class="hljs-comment">// Change this to your target</span>
    startPort := <span class="hljs-number">1</span>
    endPort := <span class="hljs-number">1024</span>
    timeout := time.Millisecond * <span class="hljs-number">500</span> 
    
    fmt.Printf(<span class="hljs-string">"Scanning %s from port %d to %d\n"</span>, host, startPort, endPort)
    startTime := time.Now()
    
    results := scanPorts(host, startPort, endPort, timeout)
    
    elapsed := time.Since(startTime)
    
    fmt.Printf(<span class="hljs-string">"\nScan completed in %s\n"</span>, elapsed)
    fmt.Printf(<span class="hljs-string">"Found %d open ports:\n"</span>, <span class="hljs-built_in">len</span>(results))
    
    <span class="hljs-keyword">for</span> _, result := <span class="hljs-keyword">range</span> results {
        fmt.Printf(<span class="hljs-string">"Port %d is open\n"</span>, result.Port)
    }
}
</code></pre>
<h5 data-id="heading-11">多线程结果</h5>
<p>现在，我们来看看改进后扫描器的性能提升以及并发机制：</p>
<ul>
<li><strong>协程</strong>：为了使扫描过程高效，我们会为需要扫描的每个端口启动一个协程，这样当我们检查一个端口时，就可以同时检查其他端口。</li>
<li><strong>等待组</strong>：同步的等待组  当我们启动协程时，希望等待它们完成。等待组有助于跟踪所有正在运行的协程，并等待它们完成。</li>
<li><strong>结果通道</strong>：我们为所有协程的结果创建了一个缓冲通道。</li>
<li><strong>信号量模式</strong>：使用信号量来限制并行进行的扫描数量,通过通道来实现,防止我们因打开过多连接而使目标系统甚至自身机器不堪重负。</li>
<li><strong>缩短超时时间</strong>：由于以并行方式运行许多此类扫描，所以使用较短的超时时间。</li>
</ul>
<p>性能差距很大。因此，当我们实现这个功能时，可以在几分钟内扫描 1024 个端口，而且肯定不会超过半小时。</p>
<p>示例输出：</p>
<pre><code class="hljs language-python" lang="python">Scanning localhost <span class="hljs-keyword">from</span> port <span class="hljs-number">1</span> to <span class="hljs-number">1024</span>
Scan completed <span class="hljs-keyword">in</span> <span class="hljs-number">3.2</span>s
Found <span class="hljs-number">3</span> <span class="hljs-built_in">open</span> ports:
Port <span class="hljs-number">22</span> <span class="hljs-keyword">is</span> <span class="hljs-built_in">open</span>
Port <span class="hljs-number">80</span> <span class="hljs-keyword">is</span> <span class="hljs-built_in">open</span>
Port <span class="hljs-number">443</span> <span class="hljs-keyword">is</span> <span class="hljs-built_in">open</span>
</code></pre>
<p>这种多线程方法对于较大的端口范围和多个主机来说具有极好的扩展性。信号量模式确保即便要扫描上千个端口，也不会耗尽系统资源。</p>
<h2 data-id="heading-12">4. 添加服务检测</h2>
<p>既然已经有了一个快速、高效的端口扫描器，接下来的步骤就是了解那些开放端口上运行的是哪些服务。这通常被称为“服务指纹识别”或“标志抓取”，是一个连接到开放端口并检查返回数据的过程。</p>
<h5 data-id="heading-13">服务旗标抓取（Banner Grabbing）实现</h5>
<p>服务旗标抓取指的是当我们打开服务并读取发送给我们的响应（即旗标信息）时的操作。因此，这是一种很好的确认服务是否运行的方法，许多服务都会在旗标中标识自身信息。</p>
<p>我们在扫描器中加入抓取旗标的功能：</p>
<pre><code class="hljs language-golang" lang="golang"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"bufio"</span>
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"net"</span>
    <span class="hljs-string">"strings"</span>
    <span class="hljs-string">"sync"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-keyword">type</span> ScanResult <span class="hljs-keyword">struct</span> {
    Port     <span class="hljs-type">int</span>
    State    <span class="hljs-type">bool</span>
    Service  <span class="hljs-type">string</span>
    Banner   <span class="hljs-type">string</span>
    Version  <span class="hljs-type">string</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">grabBanner</span><span class="hljs-params">(host <span class="hljs-type">string</span>, port <span class="hljs-type">int</span>, timeout time.Duration)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) {
    target := fmt.Sprintf(<span class="hljs-string">"%s:%d"</span>, host, port)
    conn, err := net.DialTimeout(<span class="hljs-string">"tcp"</span>, target, timeout)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>, err
    }
    <span class="hljs-keyword">defer</span> conn.Close()
    
    conn.SetReadDeadline(time.Now().Add(timeout))
    
    <span class="hljs-comment">// Some services need a trigger to send data</span>
    <span class="hljs-comment">// Send a simple HTTP request for web services</span>
    <span class="hljs-keyword">if</span> port == <span class="hljs-number">80</span> || port == <span class="hljs-number">443</span> || port == <span class="hljs-number">8080</span> || port == <span class="hljs-number">8443</span> {
        fmt.Fprintf(conn, <span class="hljs-string">"HEAD / HTTP/1.0\r\n\r\n"</span>)
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// For other services, just wait for the banner</span>
        <span class="hljs-comment">// Some services may require specific triggers</span>
    }
    
    <span class="hljs-comment">// Read the response</span>
    reader := bufio.NewReader(conn)
    banner, err := reader.ReadString(<span class="hljs-string">'\n'</span>)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>, err
    }
    
    <span class="hljs-keyword">return</span> strings.TrimSpace(banner), <span class="hljs-literal">nil</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">identifyService</span><span class="hljs-params">(port <span class="hljs-type">int</span>, banner <span class="hljs-type">string</span>)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">string</span>) {
    commonPorts := <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">string</span>{
        <span class="hljs-number">21</span>:    <span class="hljs-string">"FTP"</span>,
        <span class="hljs-number">22</span>:    <span class="hljs-string">"SSH"</span>,
        <span class="hljs-number">23</span>:    <span class="hljs-string">"Telnet"</span>,
        <span class="hljs-number">25</span>:    <span class="hljs-string">"SMTP"</span>,
        <span class="hljs-number">53</span>:    <span class="hljs-string">"DNS"</span>,
        <span class="hljs-number">80</span>:    <span class="hljs-string">"HTTP"</span>,
        <span class="hljs-number">110</span>:   <span class="hljs-string">"POP3"</span>,
        <span class="hljs-number">143</span>:   <span class="hljs-string">"IMAP"</span>,
        <span class="hljs-number">443</span>:   <span class="hljs-string">"HTTPS"</span>,
        <span class="hljs-number">3306</span>:  <span class="hljs-string">"MySQL"</span>,
        <span class="hljs-number">5432</span>:  <span class="hljs-string">"PostgreSQL"</span>,
        <span class="hljs-number">6379</span>:  <span class="hljs-string">"Redis"</span>,
        <span class="hljs-number">8080</span>:  <span class="hljs-string">"HTTP-Proxy"</span>,
        <span class="hljs-number">27017</span>: <span class="hljs-string">"MongoDB"</span>,
    }
    
    <span class="hljs-comment">// Try to identify service from common ports</span>
    service := <span class="hljs-string">"Unknown"</span>
    <span class="hljs-keyword">if</span> s, exists := commonPorts[port]; exists {
        service = s
    }
    
    version := <span class="hljs-string">"Unknown"</span>
    
    lowerBanner := strings.ToLower(banner)
    
    <span class="hljs-comment">// SSH version detection</span>
    <span class="hljs-keyword">if</span> strings.Contains(lowerBanner, <span class="hljs-string">"ssh"</span>) {
        service = <span class="hljs-string">"SSH"</span>
        parts := strings.Split(banner, <span class="hljs-string">" "</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) &gt;= <span class="hljs-number">2</span> {
            version = parts[<span class="hljs-number">1</span>]
        }
    }
    
    <span class="hljs-comment">// HTTP server detection</span>
    <span class="hljs-keyword">if</span> strings.Contains(lowerBanner, <span class="hljs-string">"http"</span>) || strings.Contains(lowerBanner, <span class="hljs-string">"apache"</span>) || 
       strings.Contains(lowerBanner, <span class="hljs-string">"nginx"</span>) {
        <span class="hljs-keyword">if</span> port == <span class="hljs-number">443</span> {
            service = <span class="hljs-string">"HTTPS"</span>
        } <span class="hljs-keyword">else</span> {
            service = <span class="hljs-string">"HTTP"</span>
        }
        
        <span class="hljs-comment">// Try to find server info in format "Server: Apache/2.4.29"</span>
        <span class="hljs-keyword">if</span> strings.Contains(banner, <span class="hljs-string">"Server:"</span>) {
            parts := strings.Split(banner, <span class="hljs-string">"Server:"</span>)
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) &gt;= <span class="hljs-number">2</span> {
                version = strings.TrimSpace(parts[<span class="hljs-number">1</span>])
            }
        }
    }
    
    <span class="hljs-keyword">return</span> service, version
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">scanPort</span><span class="hljs-params">(host <span class="hljs-type">string</span>, port <span class="hljs-type">int</span>, timeout time.Duration)</span></span> ScanResult {
    target := fmt.Sprintf(<span class="hljs-string">"%s:%d"</span>, host, port)
    conn, err := net.DialTimeout(<span class="hljs-string">"tcp"</span>, target, timeout)
    
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> ScanResult{Port: port, State: <span class="hljs-literal">false</span>}
    }
    
    conn.Close()
    
    banner, err := grabBanner(host, port, timeout)
    
    service := <span class="hljs-string">"Unknown"</span>
    version := <span class="hljs-string">"Unknown"</span>
    
    <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &amp;&amp; banner != <span class="hljs-string">""</span> {
        service, version = identifyService(port, banner)
    }
    
    <span class="hljs-keyword">return</span> ScanResult{
        Port:    port,
        State:   <span class="hljs-literal">true</span>,
        Service: service,
        Banner:  banner,
        Version: version,
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">scanPorts</span><span class="hljs-params">(host <span class="hljs-type">string</span>, start, end <span class="hljs-type">int</span>, timeout time.Duration)</span></span> []ScanResult {
    <span class="hljs-keyword">var</span> results []ScanResult
    <span class="hljs-keyword">var</span> wg sync.WaitGroup
    
    resultChan := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> ScanResult, end-start+<span class="hljs-number">1</span>)
    
    semaphore := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{}, <span class="hljs-number">100</span>)
    
    <span class="hljs-keyword">for</span> port := start; port &lt;= end; port++ {
        wg.Add(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(p <span class="hljs-type">int</span>)</span></span> {
            <span class="hljs-keyword">defer</span> wg.Done()
            
            semaphore &lt;- <span class="hljs-keyword">struct</span>{}{}
            <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> { &lt;-semaphore }()
            
            result := scanPort(host, p, timeout)
            resultChan &lt;- result
        }(port)
    }
    
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        wg.Wait()
        <span class="hljs-built_in">close</span>(resultChan)
    }()
    
    <span class="hljs-keyword">for</span> result := <span class="hljs-keyword">range</span> resultChan {
        <span class="hljs-keyword">if</span> result.State {
            results = <span class="hljs-built_in">append</span>(results, result)
        }
    }
    
    <span class="hljs-keyword">return</span> results
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    host := <span class="hljs-string">"localhost"</span>
    startPort := <span class="hljs-number">1</span>
    endPort := <span class="hljs-number">1024</span>
    timeout := time.Millisecond * <span class="hljs-number">800</span> 
    
    fmt.Printf(<span class="hljs-string">"Scanning %s from port %d to %d\n"</span>, host, startPort, endPort)
    startTime := time.Now()
    
    results := scanPorts(host, startPort, endPort, timeout)
    
    elapsed := time.Since(startTime)
    
    fmt.Printf(<span class="hljs-string">"\nScan completed in %s\n"</span>, elapsed)
    fmt.Printf(<span class="hljs-string">"Found %d open ports:\n\n"</span>, <span class="hljs-built_in">len</span>(results))
    
    fmt.Println(<span class="hljs-string">"PORT\tSERVICE\tVERSION\tBANNER"</span>)
    fmt.Println(<span class="hljs-string">"----\t-------\t-------\t------"</span>)
    <span class="hljs-keyword">for</span> _, result := <span class="hljs-keyword">range</span> results {
        bannerPreview := <span class="hljs-string">""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(result.Banner) &gt; <span class="hljs-number">30</span> {
            bannerPreview = result.Banner[:<span class="hljs-number">30</span>] + <span class="hljs-string">"..."</span>
        } <span class="hljs-keyword">else</span> {
            bannerPreview = result.Banner
        }
        
        fmt.Printf(<span class="hljs-string">"%d\t%s\t%s\t%s\n"</span>, 
            result.Port, 
            result.Service, 
            result.Version, 
            bannerPreview)
    }
}
</code></pre>
<h5 data-id="heading-14">识别正在运行的服务</h5>
<p>两种主要的服务检测策略：</p>
<ul>
<li><strong>基于端口识别</strong>：通过映射到公共端口号（例如，端口 80 是 HTTP），对服务有一个可能的猜测。</li>
<li><strong>旗标分析</strong>：获取旗标文本并查找服务标识符和版本信息。</li>
</ul>
<p>第一个函数 <code>grabBanner</code> 旨在从服务中获取第一个响应。有些服务（如 HTTP）要求发送请求并接收回复，为此我们会添加特定案例来处理这种情况。</p>
<h5 data-id="heading-15">基本版本检测</h5>
<p>版本检测对于漏洞的识别至关重要。在可能的情况下，扫描器会解析服务旗标以获取版本信息：</p>
<ul>
<li><strong>SSH</strong>：通常会以 <code>SSH-2.0-OpenSSH_7.4</code> 这样的形式提供版本信息。</li>
<li><strong>HTTP 服务器</strong>：通常会在响应头中（如 <code>Server: Apache/2.4.29</code>）返回其版本信息。</li>
<li><strong>数据库服务器</strong>：可能会在其欢迎消息中披露版本信息。</li>
</ul>
<p>现在，对于每个开放端口，输出都会返回更多信息：</p>
<pre><code class="hljs language-sql" lang="sql">Scanning localhost <span class="hljs-keyword">from</span> port <span class="hljs-number">1</span> <span class="hljs-keyword">to</span> <span class="hljs-number">1024</span>
Scan completed <span class="hljs-keyword">in</span> <span class="hljs-number">5.4</span>s
Found <span class="hljs-number">3</span> <span class="hljs-keyword">open</span> ports:

PORT    SERVICE VERSION BANNER
<span class="hljs-comment">----    ------- ------- ------</span>
<span class="hljs-number">22</span>      SSH     <span class="hljs-number">2.0</span>     SSH<span class="hljs-number">-2.0</span><span class="hljs-operator">-</span>OpenSSH_8<span class="hljs-number">.4</span>p1 Ubuntu<span class="hljs-number">-6</span>
<span class="hljs-number">80</span>      HTTP    Apache<span class="hljs-operator">/</span><span class="hljs-number">2.4</span><span class="hljs-number">.41</span> Server: Apache<span class="hljs-operator">/</span><span class="hljs-number">2.4</span><span class="hljs-number">.41</span> (Ubuntu)
<span class="hljs-number">443</span>     HTTPS   <span class="hljs-literal">Unknown</span> Connection closed <span class="hljs-keyword">by</span> foreign...
</code></pre>
<p>这种增强后的信息对于漏洞评估而言要具有更高的价值。</p>
<h2 data-id="heading-16">5. 漏洞检测实现</h2>
<p>既然能列出正在运行的服务及其版本，接下来我们将实现针对漏洞的检测。我们对服务信息进行分析，并与已知漏洞进行对比。</p>
<h5 data-id="heading-17">编写简单的漏洞测试</h5>
<p>我们将根据常见服务和版本，基于已知漏洞构建数据库。为了简便起见，我们将创建一个嵌入代码的漏洞数据库，但在实际场景中，扫描器很可能会查询外部漏洞数据库（如 CVE 或 NVD）。</p>
<p>现在进一步完善代码，使其能够检测出漏洞：</p>
<pre><code class="hljs language-golang" lang="golang"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"bufio"</span>
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"net"</span>
    <span class="hljs-string">"strings"</span>
    <span class="hljs-string">"sync"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-keyword">type</span> ScanResult <span class="hljs-keyword">struct</span> {
    Port          <span class="hljs-type">int</span>
    State         <span class="hljs-type">bool</span>
    Service       <span class="hljs-type">string</span>
    Banner        <span class="hljs-type">string</span>
    Version       <span class="hljs-type">string</span>
    Vulnerabilities []Vulnerability
}

<span class="hljs-keyword">type</span> Vulnerability <span class="hljs-keyword">struct</span> {
    ID          <span class="hljs-type">string</span>
    Description <span class="hljs-type">string</span>
    Severity    <span class="hljs-type">string</span>
    Reference   <span class="hljs-type">string</span>
}

<span class="hljs-keyword">var</span> vulnerabilityDB = []<span class="hljs-keyword">struct</span> {
    Service     <span class="hljs-type">string</span>
    Version     <span class="hljs-type">string</span>
    Vulnerability Vulnerability
}{
    {
        Service: <span class="hljs-string">"SSH"</span>,
        Version: <span class="hljs-string">"OpenSSH_7.4"</span>,
        Vulnerability: Vulnerability{
            ID:          <span class="hljs-string">"CVE-2017-15906"</span>,
            Description: <span class="hljs-string">"The process_open function in sftp-server.c in OpenSSH before 7.6 does not properly prevent write operations in read-only mode"</span>,
            Severity:    <span class="hljs-string">"Medium"</span>,
            Reference:   <span class="hljs-string">"https://nvd.nist.gov/vuln/detail/CVE-2017-15906"</span>,
        },
    },
    {
        Service: <span class="hljs-string">"HTTP"</span>,
        Version: <span class="hljs-string">"Apache/2.4.29"</span>,
        Vulnerability: Vulnerability{
            ID:          <span class="hljs-string">"CVE-2019-0211"</span>,
            Description: <span class="hljs-string">"Apache HTTP Server 2.4.17 to 2.4.38 - Local privilege escalation through mod_prefork and mod_http2"</span>,
            Severity:    <span class="hljs-string">"High"</span>,
            Reference:   <span class="hljs-string">"https://nvd.nist.gov/vuln/detail/CVE-2019-0211"</span>,
        },
    },
    {
        Service: <span class="hljs-string">"HTTP"</span>,
        Version: <span class="hljs-string">"Apache/2.4.41"</span>,
        Vulnerability: Vulnerability{
            ID:          <span class="hljs-string">"CVE-2020-9490"</span>,
            Description: <span class="hljs-string">"A specially crafted value for the 'Cache-Digest' header can cause a heap overflow in Apache HTTP Server 2.4.0-2.4.41"</span>,
            Severity:    <span class="hljs-string">"High"</span>,
            Reference:   <span class="hljs-string">"https://nvd.nist.gov/vuln/detail/CVE-2020-9490"</span>,
        },
    },
    {
        Service: <span class="hljs-string">"MySQL"</span>,
        Version: <span class="hljs-string">"5.7"</span>,
        Vulnerability: Vulnerability{
            ID:          <span class="hljs-string">"CVE-2020-2922"</span>,
            Description: <span class="hljs-string">"Vulnerability in MySQL Server allows unauthorized users to obtain sensitive information"</span>,
            Severity:    <span class="hljs-string">"Medium"</span>,
            Reference:   <span class="hljs-string">"https://nvd.nist.gov/vuln/detail/CVE-2020-2922"</span>,
        },
    },
    <span class="hljs-comment">// Add more known vulnerabilities here</span>
}

<span class="hljs-comment">// checkVulnerabilities checks if a service/version combination has known vulnerabilities</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">checkVulnerabilities</span><span class="hljs-params">(service, version <span class="hljs-type">string</span>)</span></span> []Vulnerability {
    <span class="hljs-keyword">var</span> vulnerabilities []Vulnerability
    
    <span class="hljs-keyword">for</span> _, vuln := <span class="hljs-keyword">range</span> vulnerabilityDB {
        <span class="hljs-comment">// Simple matching - in a real scanner, this would be more sophisticated</span>
        <span class="hljs-keyword">if</span> vuln.Service == service &amp;&amp; strings.Contains(version, vuln.Version) {
            vulnerabilities = <span class="hljs-built_in">append</span>(vulnerabilities, vuln.Vulnerability)
        }
    }
    
    <span class="hljs-keyword">return</span> vulnerabilities
}

<span class="hljs-comment">// grabBanner attempts to read the banner from an open port</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">grabBanner</span><span class="hljs-params">(host <span class="hljs-type">string</span>, port <span class="hljs-type">int</span>, timeout time.Duration)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) {
    target := fmt.Sprintf(<span class="hljs-string">"%s:%d"</span>, host, port)
    conn, err := net.DialTimeout(<span class="hljs-string">"tcp"</span>, target, timeout)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>, err
    }
    <span class="hljs-keyword">defer</span> conn.Close()
    
    conn.SetReadDeadline(time.Now().Add(timeout))
    

    <span class="hljs-keyword">if</span> port == <span class="hljs-number">80</span> || port == <span class="hljs-number">443</span> || port == <span class="hljs-number">8080</span> || port == <span class="hljs-number">8443</span> {
        fmt.Fprintf(conn, <span class="hljs-string">"HEAD / HTTP/1.0\r\nHost: %s\r\n\r\n"</span>, host)
    } <span class="hljs-keyword">else</span> {

    }
    
    reader := bufio.NewReader(conn)
    banner, err := reader.ReadString(<span class="hljs-string">'\n'</span>)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>, err
    }
    
    <span class="hljs-keyword">return</span> strings.TrimSpace(banner), <span class="hljs-literal">nil</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">identifyService</span><span class="hljs-params">(port <span class="hljs-type">int</span>, banner <span class="hljs-type">string</span>)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">string</span>) {
    commonPorts := <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">string</span>{
        <span class="hljs-number">21</span>:    <span class="hljs-string">"FTP"</span>,
        <span class="hljs-number">22</span>:    <span class="hljs-string">"SSH"</span>,
        <span class="hljs-number">23</span>:    <span class="hljs-string">"Telnet"</span>,
        <span class="hljs-number">25</span>:    <span class="hljs-string">"SMTP"</span>,
        <span class="hljs-number">53</span>:    <span class="hljs-string">"DNS"</span>,
        <span class="hljs-number">80</span>:    <span class="hljs-string">"HTTP"</span>,
        <span class="hljs-number">110</span>:   <span class="hljs-string">"POP3"</span>,
        <span class="hljs-number">143</span>:   <span class="hljs-string">"IMAP"</span>,
        <span class="hljs-number">443</span>:   <span class="hljs-string">"HTTPS"</span>,
        <span class="hljs-number">3306</span>:  <span class="hljs-string">"MySQL"</span>,
        <span class="hljs-number">5432</span>:  <span class="hljs-string">"PostgreSQL"</span>,
        <span class="hljs-number">6379</span>:  <span class="hljs-string">"Redis"</span>,
        <span class="hljs-number">8080</span>:  <span class="hljs-string">"HTTP-Proxy"</span>,
        <span class="hljs-number">27017</span>: <span class="hljs-string">"MongoDB"</span>,
    }
    
    service := <span class="hljs-string">"Unknown"</span>
    <span class="hljs-keyword">if</span> s, exists := commonPorts[port]; exists {
        service = s
    }
    
    version := <span class="hljs-string">"Unknown"</span>
    
    lowerBanner := strings.ToLower(banner)
    
    <span class="hljs-keyword">if</span> strings.Contains(lowerBanner, <span class="hljs-string">"ssh"</span>) {
        service = <span class="hljs-string">"SSH"</span>
        parts := strings.Split(banner, <span class="hljs-string">" "</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) &gt;= <span class="hljs-number">2</span> {
            version = parts[<span class="hljs-number">1</span>]
        }
    }
    
    <span class="hljs-keyword">if</span> strings.Contains(lowerBanner, <span class="hljs-string">"http"</span>) || strings.Contains(lowerBanner, <span class="hljs-string">"apache"</span>) || 
       strings.Contains(lowerBanner, <span class="hljs-string">"nginx"</span>) {
        <span class="hljs-keyword">if</span> port == <span class="hljs-number">443</span> {
            service = <span class="hljs-string">"HTTPS"</span>
        } <span class="hljs-keyword">else</span> {
            service = <span class="hljs-string">"HTTP"</span>
        }
        
        <span class="hljs-keyword">if</span> strings.Contains(banner, <span class="hljs-string">"Server:"</span>) {
            parts := strings.Split(banner, <span class="hljs-string">"Server:"</span>)
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) &gt;= <span class="hljs-number">2</span> {
                version = strings.TrimSpace(parts[<span class="hljs-number">1</span>])
            }
        }
    }
    
    <span class="hljs-keyword">return</span> service, version
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">scanPort</span><span class="hljs-params">(host <span class="hljs-type">string</span>, port <span class="hljs-type">int</span>, timeout time.Duration)</span></span> ScanResult {
    target := fmt.Sprintf(<span class="hljs-string">"%s:%d"</span>, host, port)
    conn, err := net.DialTimeout(<span class="hljs-string">"tcp"</span>, target, timeout)
    
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> ScanResult{Port: port, State: <span class="hljs-literal">false</span>}
    }
    
    conn.Close()
    
    banner, err := grabBanner(host, port, timeout)
    
    service := <span class="hljs-string">"Unknown"</span>
    version := <span class="hljs-string">"Unknown"</span>
    
    <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &amp;&amp; banner != <span class="hljs-string">""</span> {
        service, version = identifyService(port, banner)
    }
    
    vulnerabilities := checkVulnerabilities(service, version)
    
    <span class="hljs-keyword">return</span> ScanResult{
        Port:           port,
        State:          <span class="hljs-literal">true</span>,
        Service:        service,
        Banner:         banner,
        Version:        version,
        Vulnerabilities: vulnerabilities,
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">scanPorts</span><span class="hljs-params">(host <span class="hljs-type">string</span>, start, end <span class="hljs-type">int</span>, timeout time.Duration)</span></span> []ScanResult {
    <span class="hljs-keyword">var</span> results []ScanResult
    <span class="hljs-keyword">var</span> wg sync.WaitGroup
    
    resultChan := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> ScanResult, end-start+<span class="hljs-number">1</span>)
    
    semaphore := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{}, <span class="hljs-number">100</span>)
    
    <span class="hljs-keyword">for</span> port := start; port &lt;= end; port++ {
        wg.Add(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(p <span class="hljs-type">int</span>)</span></span> {
            <span class="hljs-keyword">defer</span> wg.Done()
            
            semaphore &lt;- <span class="hljs-keyword">struct</span>{}{}
            <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> { &lt;-semaphore }()
            
            result := scanPort(host, p, timeout)
            resultChan &lt;- result
        }(port)
    }
    
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        wg.Wait()
        <span class="hljs-built_in">close</span>(resultChan)
    }()
    
    <span class="hljs-keyword">for</span> result := <span class="hljs-keyword">range</span> resultChan {
        <span class="hljs-keyword">if</span> result.State {
            results = <span class="hljs-built_in">append</span>(results, result)
        }
    }
    
    <span class="hljs-keyword">return</span> results
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    host := <span class="hljs-string">"localhost"</span>
    startPort := <span class="hljs-number">1</span>
    endPort := <span class="hljs-number">1024</span>
    timeout := time.Second * <span class="hljs-number">1</span> 
    
    fmt.Printf(<span class="hljs-string">"Scanning %s from port %d to %d\n"</span>, host, startPort, endPort)
    startTime := time.Now()
    
    results := scanPorts(host, startPort, endPort, timeout)
    
    elapsed := time.Since(startTime)
    
    fmt.Printf(<span class="hljs-string">"\nScan completed in %s\n"</span>, elapsed)
    fmt.Printf(<span class="hljs-string">"Found %d open ports:\n\n"</span>, <span class="hljs-built_in">len</span>(results))
    
    fmt.Println(<span class="hljs-string">"PORT\tSERVICE\tVERSION"</span>)
    fmt.Println(<span class="hljs-string">"----\t-------\t-------"</span>)
    <span class="hljs-keyword">for</span> _, result := <span class="hljs-keyword">range</span> results {
        fmt.Printf(<span class="hljs-string">"%d\t%s\t%s\n"</span>, 
            result.Port, 
            result.Service, 
            result.Version)
        
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(result.Vulnerabilities) &gt; <span class="hljs-number">0</span> {
            fmt.Println(<span class="hljs-string">"  Vulnerabilities:"</span>)
            <span class="hljs-keyword">for</span> _, vuln := <span class="hljs-keyword">range</span> result.Vulnerabilities {
                fmt.Printf(<span class="hljs-string">"    [%s] %s - %s\n"</span>, 
                    vuln.Severity, 
                    vuln.ID, 
                    vuln.Description)
                fmt.Printf(<span class="hljs-string">"    Reference: %s\n\n"</span>, vuln.Reference)
            }
        }
    }
}<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"bufio"</span>
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"net"</span>
    <span class="hljs-string">"strings"</span>
    <span class="hljs-string">"sync"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-keyword">type</span> ScanResult <span class="hljs-keyword">struct</span> {
    Port          <span class="hljs-type">int</span>
    State         <span class="hljs-type">bool</span>
    Service       <span class="hljs-type">string</span>
    Banner        <span class="hljs-type">string</span>
    Version       <span class="hljs-type">string</span>
    Vulnerabilities []Vulnerability
}

<span class="hljs-keyword">type</span> Vulnerability <span class="hljs-keyword">struct</span> {
    ID          <span class="hljs-type">string</span>
    Description <span class="hljs-type">string</span>
    Severity    <span class="hljs-type">string</span>
    Reference   <span class="hljs-type">string</span>
}

<span class="hljs-keyword">var</span> vulnerabilityDB = []<span class="hljs-keyword">struct</span> {
    Service     <span class="hljs-type">string</span>
    Version     <span class="hljs-type">string</span>
    Vulnerability Vulnerability
}{
    {
        Service: <span class="hljs-string">"SSH"</span>,
        Version: <span class="hljs-string">"OpenSSH_7.4"</span>,
        Vulnerability: Vulnerability{
            ID:          <span class="hljs-string">"CVE-2017-15906"</span>,
            Description: <span class="hljs-string">"The process_open function in sftp-server.c in OpenSSH before 7.6 does not properly prevent write operations in read-only mode"</span>,
            Severity:    <span class="hljs-string">"Medium"</span>,
            Reference:   <span class="hljs-string">"https://nvd.nist.gov/vuln/detail/CVE-2017-15906"</span>,
        },
    },
    {
        Service: <span class="hljs-string">"HTTP"</span>,
        Version: <span class="hljs-string">"Apache/2.4.29"</span>,
        Vulnerability: Vulnerability{
            ID:          <span class="hljs-string">"CVE-2019-0211"</span>,
            Description: <span class="hljs-string">"Apache HTTP Server 2.4.17 to 2.4.38 - Local privilege escalation through mod_prefork and mod_http2"</span>,
            Severity:    <span class="hljs-string">"High"</span>,
            Reference:   <span class="hljs-string">"https://nvd.nist.gov/vuln/detail/CVE-2019-0211"</span>,
        },
    },
    {
        Service: <span class="hljs-string">"HTTP"</span>,
        Version: <span class="hljs-string">"Apache/2.4.41"</span>,
        Vulnerability: Vulnerability{
            ID:          <span class="hljs-string">"CVE-2020-9490"</span>,
            Description: <span class="hljs-string">"A specially crafted value for the 'Cache-Digest' header can cause a heap overflow in Apache HTTP Server 2.4.0-2.4.41"</span>,
            Severity:    <span class="hljs-string">"High"</span>,
            Reference:   <span class="hljs-string">"https://nvd.nist.gov/vuln/detail/CVE-2020-9490"</span>,
        },
    },
    {
        Service: <span class="hljs-string">"MySQL"</span>,
        Version: <span class="hljs-string">"5.7"</span>,
        Vulnerability: Vulnerability{
            ID:          <span class="hljs-string">"CVE-2020-2922"</span>,
            Description: <span class="hljs-string">"Vulnerability in MySQL Server allows unauthorized users to obtain sensitive information"</span>,
            Severity:    <span class="hljs-string">"Medium"</span>,
            Reference:   <span class="hljs-string">"https://nvd.nist.gov/vuln/detail/CVE-2020-2922"</span>,
        },
    },
    <span class="hljs-comment">// Add more known vulnerabilities here</span>
}

<span class="hljs-comment">// checkVulnerabilities checks if a service/version combination has known vulnerabilities</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">checkVulnerabilities</span><span class="hljs-params">(service, version <span class="hljs-type">string</span>)</span></span> []Vulnerability {
    <span class="hljs-keyword">var</span> vulnerabilities []Vulnerability
    
    <span class="hljs-keyword">for</span> _, vuln := <span class="hljs-keyword">range</span> vulnerabilityDB {
        <span class="hljs-comment">// Simple matching - in a real scanner, this would be more sophisticated</span>
        <span class="hljs-keyword">if</span> vuln.Service == service &amp;&amp; strings.Contains(version, vuln.Version) {
            vulnerabilities = <span class="hljs-built_in">append</span>(vulnerabilities, vuln.Vulnerability)
        }
    }
    
    <span class="hljs-keyword">return</span> vulnerabilities
}

<span class="hljs-comment">// grabBanner attempts to read the banner from an open port</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">grabBanner</span><span class="hljs-params">(host <span class="hljs-type">string</span>, port <span class="hljs-type">int</span>, timeout time.Duration)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) {
    target := fmt.Sprintf(<span class="hljs-string">"%s:%d"</span>, host, port)
    conn, err := net.DialTimeout(<span class="hljs-string">"tcp"</span>, target, timeout)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>, err
    }
    <span class="hljs-keyword">defer</span> conn.Close()
    
    conn.SetReadDeadline(time.Now().Add(timeout))
    

    <span class="hljs-keyword">if</span> port == <span class="hljs-number">80</span> || port == <span class="hljs-number">443</span> || port == <span class="hljs-number">8080</span> || port == <span class="hljs-number">8443</span> {
        fmt.Fprintf(conn, <span class="hljs-string">"HEAD / HTTP/1.0\r\nHost: %s\r\n\r\n"</span>, host)
    } <span class="hljs-keyword">else</span> {

    }
    
    reader := bufio.NewReader(conn)
    banner, err := reader.ReadString(<span class="hljs-string">'\n'</span>)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>, err
    }
    
    <span class="hljs-keyword">return</span> strings.TrimSpace(banner), <span class="hljs-literal">nil</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">identifyService</span><span class="hljs-params">(port <span class="hljs-type">int</span>, banner <span class="hljs-type">string</span>)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">string</span>) {
    commonPorts := <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">string</span>{
        <span class="hljs-number">21</span>:    <span class="hljs-string">"FTP"</span>,
        <span class="hljs-number">22</span>:    <span class="hljs-string">"SSH"</span>,
        <span class="hljs-number">23</span>:    <span class="hljs-string">"Telnet"</span>,
        <span class="hljs-number">25</span>:    <span class="hljs-string">"SMTP"</span>,
        <span class="hljs-number">53</span>:    <span class="hljs-string">"DNS"</span>,
        <span class="hljs-number">80</span>:    <span class="hljs-string">"HTTP"</span>,
        <span class="hljs-number">110</span>:   <span class="hljs-string">"POP3"</span>,
        <span class="hljs-number">143</span>:   <span class="hljs-string">"IMAP"</span>,
        <span class="hljs-number">443</span>:   <span class="hljs-string">"HTTPS"</span>,
        <span class="hljs-number">3306</span>:  <span class="hljs-string">"MySQL"</span>,
        <span class="hljs-number">5432</span>:  <span class="hljs-string">"PostgreSQL"</span>,
        <span class="hljs-number">6379</span>:  <span class="hljs-string">"Redis"</span>,
        <span class="hljs-number">8080</span>:  <span class="hljs-string">"HTTP-Proxy"</span>,
        <span class="hljs-number">27017</span>: <span class="hljs-string">"MongoDB"</span>,
    }
    
    service := <span class="hljs-string">"Unknown"</span>
    <span class="hljs-keyword">if</span> s, exists := commonPorts[port]; exists {
        service = s
    }
    
    version := <span class="hljs-string">"Unknown"</span>
    
    lowerBanner := strings.ToLower(banner)
    
    <span class="hljs-keyword">if</span> strings.Contains(lowerBanner, <span class="hljs-string">"ssh"</span>) {
        service = <span class="hljs-string">"SSH"</span>
        parts := strings.Split(banner, <span class="hljs-string">" "</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) &gt;= <span class="hljs-number">2</span> {
            version = parts[<span class="hljs-number">1</span>]
        }
    }
    
    <span class="hljs-keyword">if</span> strings.Contains(lowerBanner, <span class="hljs-string">"http"</span>) || strings.Contains(lowerBanner, <span class="hljs-string">"apache"</span>) || 
       strings.Contains(lowerBanner, <span class="hljs-string">"nginx"</span>) {
        <span class="hljs-keyword">if</span> port == <span class="hljs-number">443</span> {
            service = <span class="hljs-string">"HTTPS"</span>
        } <span class="hljs-keyword">else</span> {
            service = <span class="hljs-string">"HTTP"</span>
        }
        
        <span class="hljs-keyword">if</span> strings.Contains(banner, <span class="hljs-string">"Server:"</span>) {
            parts := strings.Split(banner, <span class="hljs-string">"Server:"</span>)
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) &gt;= <span class="hljs-number">2</span> {
                version = strings.TrimSpace(parts[<span class="hljs-number">1</span>])
            }
        }
    }
    
    <span class="hljs-keyword">return</span> service, version
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">scanPort</span><span class="hljs-params">(host <span class="hljs-type">string</span>, port <span class="hljs-type">int</span>, timeout time.Duration)</span></span> ScanResult {
    target := fmt.Sprintf(<span class="hljs-string">"%s:%d"</span>, host, port)
    conn, err := net.DialTimeout(<span class="hljs-string">"tcp"</span>, target, timeout)
    
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> ScanResult{Port: port, State: <span class="hljs-literal">false</span>}
    }
    
    conn.Close()
    
    banner, err := grabBanner(host, port, timeout)
    
    service := <span class="hljs-string">"Unknown"</span>
    version := <span class="hljs-string">"Unknown"</span>
    
    <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &amp;&amp; banner != <span class="hljs-string">""</span> {
        service, version = identifyService(port, banner)
    }
    
    vulnerabilities := checkVulnerabilities(service, version)
    
    <span class="hljs-keyword">return</span> ScanResult{
        Port:           port,
        State:          <span class="hljs-literal">true</span>,
        Service:        service,
        Banner:         banner,
        Version:        version,
        Vulnerabilities: vulnerabilities,
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">scanPorts</span><span class="hljs-params">(host <span class="hljs-type">string</span>, start, end <span class="hljs-type">int</span>, timeout time.Duration)</span></span> []ScanResult {
    <span class="hljs-keyword">var</span> results []ScanResult
    <span class="hljs-keyword">var</span> wg sync.WaitGroup
    
    resultChan := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> ScanResult, end-start+<span class="hljs-number">1</span>)
    
    semaphore := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{}, <span class="hljs-number">100</span>)
    
    <span class="hljs-keyword">for</span> port := start; port &lt;= end; port++ {
        wg.Add(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(p <span class="hljs-type">int</span>)</span></span> {
            <span class="hljs-keyword">defer</span> wg.Done()
            
            semaphore &lt;- <span class="hljs-keyword">struct</span>{}{}
            <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> { &lt;-semaphore }()
            
            result := scanPort(host, p, timeout)
            resultChan &lt;- result
        }(port)
    }
    
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        wg.Wait()
        <span class="hljs-built_in">close</span>(resultChan)
    }()
    
    <span class="hljs-keyword">for</span> result := <span class="hljs-keyword">range</span> resultChan {
        <span class="hljs-keyword">if</span> result.State {
            results = <span class="hljs-built_in">append</span>(results, result)
        }
    }
    
    <span class="hljs-keyword">return</span> results
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    host := <span class="hljs-string">"localhost"</span>
    startPort := <span class="hljs-number">1</span>
    endPort := <span class="hljs-number">1024</span>
    timeout := time.Second * <span class="hljs-number">1</span> 
    
    fmt.Printf(<span class="hljs-string">"Scanning %s from port %d to %d\n"</span>, host, startPort, endPort)
    startTime := time.Now()
    
    results := scanPorts(host, startPort, endPort, timeout)
    
    elapsed := time.Since(startTime)
    
    fmt.Printf(<span class="hljs-string">"\nScan completed in %s\n"</span>, elapsed)
    fmt.Printf(<span class="hljs-string">"Found %d open ports:\n\n"</span>, <span class="hljs-built_in">len</span>(results))
    
    fmt.Println(<span class="hljs-string">"PORT\tSERVICE\tVERSION"</span>)
    fmt.Println(<span class="hljs-string">"----\t-------\t-------"</span>)
    <span class="hljs-keyword">for</span> _, result := <span class="hljs-keyword">range</span> results {
        fmt.Printf(<span class="hljs-string">"%d\t%s\t%s\n"</span>, 
            result.Port, 
            result.Service, 
            result.Version)
        
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(result.Vulnerabilities) &gt; <span class="hljs-number">0</span> {
            fmt.Println(<span class="hljs-string">"  Vulnerabilities:"</span>)
            <span class="hljs-keyword">for</span> _, vuln := <span class="hljs-keyword">range</span> result.Vulnerabilities {
                fmt.Printf(<span class="hljs-string">"    [%s] %s - %s\n"</span>, 
                    vuln.Severity, 
                    vuln.ID, 
                    vuln.Description)
                fmt.Printf(<span class="hljs-string">"    Reference: %s\n\n"</span>, vuln.Reference)
            }
        }
    }
}
</code></pre>
<h5 data-id="heading-18">基于版本的漏洞匹配</h5>
<p>针对漏洞检测我们用简单版本匹配方法：</p>
<ul>
<li><strong>直接匹配</strong>：将服务类型和版本与漏洞数据库进行匹配。</li>
<li><strong>部分匹配</strong>：对于漏洞版本的匹配，我们会对版本字符串进行限制性检查，这样即使版本字符串包含额外信息，也能识别出存在漏洞的系统。</li>
</ul>
<p>在实际的扫描器中，匹配会更为复杂，会考虑到以下因素：</p>
<ul>
<li>版本范围（即版本 2.4.0 至 2.4.38 受影响）</li>
<li>特定配置的漏洞</li>
<li>操作系统特定的问题</li>
<li>更细致的版本比较</li>
</ul>
<h5 data-id="heading-19">报告发现的情况</h5>
<p>报告结果是漏洞检测流程中的最后一步，需要以简洁且具有可操作性的格式进行。扫描器现在：</p>
<ul>
<li>列出所有开放端口及其服务及版本信息</li>
<li>对于每个存在漏洞的服务，会显示：
<ul>
<li>漏洞标识（例如，CVE 编号）</li>
<li>漏洞描述</li>
<li>严重程度评级</li>
<li>更多信息的参考链接</li>
</ul>
</li>
</ul>
<p>示例输出：</p>
<pre><code class="hljs language-arduino" lang="arduino">Scanning localhost from port <span class="hljs-number">1</span> to <span class="hljs-number">1024</span>
Scan completed in <span class="hljs-number">6.2</span>s
Found <span class="hljs-number">3</span> open ports:

PORT    SERVICE VERSION
----    ------- -------
<span class="hljs-number">22</span>      SSH     OpenSSH_7<span class="hljs-number">.4</span>p1
  Vulnerabilities:
    [Medium] CVE<span class="hljs-number">-2017</span><span class="hljs-number">-15906</span> - The process_open function in sftp-server.c in OpenSSH before <span class="hljs-number">7.6</span> does <span class="hljs-keyword">not</span> properly prevent write operations in read-only mode
    Reference: https:<span class="hljs-comment">//nvd.nist.gov/vuln/detail/CVE-2017-15906</span>

<span class="hljs-number">80</span>      HTTP    Apache/<span class="hljs-number">2.4</span><span class="hljs-number">.41</span>
  Vulnerabilities:
    [High] CVE<span class="hljs-number">-2020</span><span class="hljs-number">-9490</span> - A specially crafted value <span class="hljs-keyword">for</span> the <span class="hljs-string">'Cache-Digest'</span> header can cause a heap overflow in Apache HTTP <span class="hljs-built_in">Server</span> <span class="hljs-number">2.4</span><span class="hljs-number">.0</span><span class="hljs-number">-2.4</span><span class="hljs-number">.41</span>
    Reference: https:<span class="hljs-comment">//nvd.nist.gov/vuln/detail/CVE-2020-9490</span>

<span class="hljs-number">443</span>     HTTPS   Unknown
</code></pre>
<p>这份详尽的漏洞数据能够帮助网络安全专家迅速找出并排序出需要解决的安全问题。</p>
<h2 data-id="heading-20">最后完善与使用方法</h2>
<p>现在已经有了一个具备服务检测和漏洞匹配功能的基本漏洞扫描器；我们对其进行完善，以便在实际应用中更具实用性。</p>
<h6 data-id="heading-21">命令行参数</h6>
<p>扫描器可以通过命令行标志进行配置，这些标志能够设定目标、端口范围以及扫描选项。使用 Go 的 <code>flag</code> 包进行配置非常简单。</p>
<p>添加命令行参数：</p>
<pre><code class="hljs language-golang" lang="golang"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"bufio"</span>
    <span class="hljs-string">"encoding/json"</span>
    <span class="hljs-string">"flag"</span>
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"net"</span>
    <span class="hljs-string">"os"</span>
    <span class="hljs-string">"strings"</span>
    <span class="hljs-string">"sync"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-keyword">type</span> ScanResult <span class="hljs-keyword">struct</span> {
    Port            <span class="hljs-type">int</span>
    State           <span class="hljs-type">bool</span>
    Service         <span class="hljs-type">string</span>
    Banner          <span class="hljs-type">string</span>
    Version         <span class="hljs-type">string</span>
    Vulnerabilities []Vulnerability
}

<span class="hljs-keyword">type</span> Vulnerability <span class="hljs-keyword">struct</span> {
    ID          <span class="hljs-type">string</span>
    Description <span class="hljs-type">string</span>
    Severity    <span class="hljs-type">string</span>
    Reference   <span class="hljs-type">string</span>
}

<span class="hljs-keyword">var</span> vulnerabilityDB = []<span class="hljs-keyword">struct</span> {
    Service       <span class="hljs-type">string</span>
    Version       <span class="hljs-type">string</span>
    Vulnerability Vulnerability
}{
    <span class="hljs-comment">// ... (same as before)</span>
}


<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    hostPtr := flag.String(<span class="hljs-string">"host"</span>, <span class="hljs-string">""</span>, <span class="hljs-string">"Target host to scan (required)"</span>)
    startPortPtr := flag.Int(<span class="hljs-string">"start"</span>, <span class="hljs-number">1</span>, <span class="hljs-string">"Starting port number"</span>)
    endPortPtr := flag.Int(<span class="hljs-string">"end"</span>, <span class="hljs-number">1024</span>, <span class="hljs-string">"Ending port number"</span>)
    timeoutPtr := flag.Int(<span class="hljs-string">"timeout"</span>, <span class="hljs-number">1000</span>, <span class="hljs-string">"Timeout in milliseconds"</span>)
    concurrencyPtr := flag.Int(<span class="hljs-string">"concurrency"</span>, <span class="hljs-number">100</span>, <span class="hljs-string">"Number of concurrent scans"</span>)
    formatPtr := flag.String(<span class="hljs-string">"format"</span>, <span class="hljs-string">"text"</span>, <span class="hljs-string">"Output format: text, json, or csv"</span>)
    verbosePtr := flag.Bool(<span class="hljs-string">"verbose"</span>, <span class="hljs-literal">false</span>, <span class="hljs-string">"Show verbose output including banners"</span>)
    outputFilePtr := flag.String(<span class="hljs-string">"output"</span>, <span class="hljs-string">""</span>, <span class="hljs-string">"Output file (default is stdout)"</span>)
    
    flag.Parse()
    
    <span class="hljs-keyword">if</span> *hostPtr == <span class="hljs-string">""</span> {
        fmt.Println(<span class="hljs-string">"Error: host is required"</span>)
        flag.Usage()
        os.Exit(<span class="hljs-number">1</span>)
    }
    
    <span class="hljs-keyword">if</span> *startPortPtr &lt; <span class="hljs-number">1</span> || *startPortPtr &gt; <span class="hljs-number">65535</span> {
        fmt.Println(<span class="hljs-string">"Error: starting port must be between 1 and 65535"</span>)
        os.Exit(<span class="hljs-number">1</span>)
    }
    <span class="hljs-keyword">if</span> *endPortPtr &lt; <span class="hljs-number">1</span> || *endPortPtr &gt; <span class="hljs-number">65535</span> {
        fmt.Println(<span class="hljs-string">"Error: ending port must be between 1 and 65535"</span>)
        os.Exit(<span class="hljs-number">1</span>)
    }
    <span class="hljs-keyword">if</span> *startPortPtr &gt; *endPortPtr {
        fmt.Println(<span class="hljs-string">"Error: starting port must be less than or equal to ending port"</span>)
        os.Exit(<span class="hljs-number">1</span>)
    }
    
    timeout := time.Duration(*timeoutPtr) * time.Millisecond
    
    <span class="hljs-keyword">var</span> outputFile *os.File
    <span class="hljs-keyword">var</span> err <span class="hljs-type">error</span>
    
    <span class="hljs-keyword">if</span> *outputFilePtr != <span class="hljs-string">""</span> {
        outputFile, err = os.Create(*outputFilePtr)
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
            fmt.Printf(<span class="hljs-string">"Error creating output file: %v\n"</span>, err)
            os.Exit(<span class="hljs-number">1</span>)
        }
        <span class="hljs-keyword">defer</span> outputFile.Close()
    } <span class="hljs-keyword">else</span> {
        outputFile = os.Stdout
    }
    
    fmt.Fprintf(outputFile, <span class="hljs-string">"Scanning %s from port %d to %d\n"</span>, *hostPtr, *startPortPtr, *endPortPtr)
    startTime := time.Now()
    
    <span class="hljs-keyword">var</span> results []ScanResult
    <span class="hljs-keyword">var</span> wg sync.WaitGroup
    
    resultChan := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> ScanResult, *endPortPtr-*startPortPtr+<span class="hljs-number">1</span>)
    
    semaphore := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{}, *concurrencyPtr)
    
    <span class="hljs-keyword">for</span> port := *startPortPtr; port &lt;= *endPortPtr; port++ {
        wg.Add(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(p <span class="hljs-type">int</span>)</span></span> {
            <span class="hljs-keyword">defer</span> wg.Done()
            
            semaphore &lt;- <span class="hljs-keyword">struct</span>{}{}
            <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> { &lt;-semaphore }()
            
            result := scanPort(*hostPtr, p, timeout)
            resultChan &lt;- result
        }(port)
    }
    
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        wg.Wait()
        <span class="hljs-built_in">close</span>(resultChan)
    }()
    
    <span class="hljs-keyword">for</span> result := <span class="hljs-keyword">range</span> resultChan {
        <span class="hljs-keyword">if</span> result.State {
            results = <span class="hljs-built_in">append</span>(results, result)
        }
    }
    
    elapsed := time.Since(startTime)
    
    <span class="hljs-keyword">switch</span> *formatPtr {
    <span class="hljs-keyword">case</span> <span class="hljs-string">"json"</span>:
        outputJSON(outputFile, results, elapsed)
    <span class="hljs-keyword">case</span> <span class="hljs-string">"csv"</span>:
        outputCSV(outputFile, results, elapsed, *verbosePtr)
    <span class="hljs-keyword">default</span>:
        outputText(outputFile, results, elapsed, *verbosePtr)
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">outputText</span><span class="hljs-params">(w *os.File, results []ScanResult, elapsed time.Duration, verbose <span class="hljs-type">bool</span>)</span></span> {
    fmt.Fprintf(w, <span class="hljs-string">"\nScan completed in %s\n"</span>, elapsed)
    fmt.Fprintf(w, <span class="hljs-string">"Found %d open ports:\n\n"</span>, <span class="hljs-built_in">len</span>(results))
    
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(results) == <span class="hljs-number">0</span> {
        fmt.Fprintf(w, <span class="hljs-string">"No open ports found.\n"</span>)
        <span class="hljs-keyword">return</span>
    }
    
    fmt.Fprintf(w, <span class="hljs-string">"PORT\tSERVICE\tVERSION\n"</span>)
    fmt.Fprintf(w, <span class="hljs-string">"----\t-------\t-------\n"</span>)
    
    <span class="hljs-keyword">for</span> _, result := <span class="hljs-keyword">range</span> results {
        fmt.Fprintf(w, <span class="hljs-string">"%d\t%s\t%s\n"</span>, 
            result.Port, 
            result.Service, 
            result.Version)
        
        <span class="hljs-keyword">if</span> verbose {
            fmt.Fprintf(w, <span class="hljs-string">"  Banner: %s\n"</span>, result.Banner)
        }
        
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(result.Vulnerabilities) &gt; <span class="hljs-number">0</span> {
            fmt.Fprintf(w, <span class="hljs-string">"  Vulnerabilities:\n"</span>)
            <span class="hljs-keyword">for</span> _, vuln := <span class="hljs-keyword">range</span> result.Vulnerabilities {
                fmt.Fprintf(w, <span class="hljs-string">"    [%s] %s - %s\n"</span>, 
                    vuln.Severity, 
                    vuln.ID, 
                    vuln.Description)
                fmt.Fprintf(w, <span class="hljs-string">"    Reference: %s\n\n"</span>, vuln.Reference)
            }
        }
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">outputJSON</span><span class="hljs-params">(w *os.File, results []ScanResult, elapsed time.Duration)</span></span> {
    output := <span class="hljs-keyword">struct</span> {
        ScanTime   <span class="hljs-type">string</span>       <span class="hljs-string">`json:"scan_time"`</span>
        ElapsedTime <span class="hljs-type">string</span>       <span class="hljs-string">`json:"elapsed_time"`</span>
        TotalPorts <span class="hljs-type">int</span>          <span class="hljs-string">`json:"total_ports"`</span>
        OpenPorts  <span class="hljs-type">int</span>          <span class="hljs-string">`json:"open_ports"`</span>
        Results    []ScanResult <span class="hljs-string">`json:"results"`</span>
    }{
        ScanTime:    time.Now().Format(time.RFC3339),
        ElapsedTime: elapsed.String(),
        TotalPorts:  <span class="hljs-number">0</span>, 
        OpenPorts:   <span class="hljs-built_in">len</span>(results),
        Results:     results,
    }
    
    encoder := json.NewEncoder(w)
    encoder.SetIndent(<span class="hljs-string">""</span>, <span class="hljs-string">"  "</span>)
    encoder.Encode(output)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">outputCSV</span><span class="hljs-params">(w *os.File, results []ScanResult, elapsed time.Duration, verbose <span class="hljs-type">bool</span>)</span></span> {
    fmt.Fprintf(w, <span class="hljs-string">"Port,Service,Version,Vulnerability ID,Severity,Description\n"</span>)
    
    <span class="hljs-keyword">for</span> _, result := <span class="hljs-keyword">range</span> results {
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(result.Vulnerabilities) == <span class="hljs-number">0</span> {
            fmt.Fprintf(w, <span class="hljs-string">"%d,%s,%s,,,\n"</span>, 
                result.Port, 
                escapeCSV(result.Service), 
                escapeCSV(result.Version))
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">for</span> _, vuln := <span class="hljs-keyword">range</span> result.Vulnerabilities {
                fmt.Fprintf(w, <span class="hljs-string">"%d,%s,%s,%s,%s,%s\n"</span>, 
                    result.Port, 
                    escapeCSV(result.Service), 
                    escapeCSV(result.Version),
                    escapeCSV(vuln.ID),
                    escapeCSV(vuln.Severity),
                    escapeCSV(vuln.Description))
            }
        }
    }
    
    fmt.Fprintf(w, <span class="hljs-string">"\n# Scan completed in %s, found %d open ports\n"</span>, 
        elapsed, <span class="hljs-built_in">len</span>(results))
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">escapeCSV</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> {
    <span class="hljs-keyword">if</span> strings.Contains(s, <span class="hljs-string">","</span>) || strings.Contains(s, <span class="hljs-string">"\""</span>) || strings.Contains(s, <span class="hljs-string">"\n"</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"\""</span> + strings.ReplaceAll(s, <span class="hljs-string">"\""</span>, <span class="hljs-string">"\"\""</span>) + <span class="hljs-string">"\""</span>
    }
    <span class="hljs-keyword">return</span> s
}
</code></pre>
<h6 data-id="heading-22">输出格式</h6>
<p>扫描器现在可以输出三种格式：</p>
<ul>
<li><strong>文本</strong>：易于阅读，易于编写，非常适合交互使用。</li>
<li><strong>JSON</strong>：结构化输出，适用于机器处理以及与其他工具的集成。</li>
<li><strong>CSV</strong>：电子表格兼容的格式，用于分析和报告。</li>
</ul>
<p>输出文本还会提供更多信息，例如如果设置了详细模式，则会提供原始旗标信息，对于调试或深入分析也非常方便。</p>
<h6 data-id="heading-23">示例用法及结果</h6>
<p>如果打算将扫描器用于不同场合，以下是一些可能的选择：</p>
<p><strong>单个主机的基本扫描：</strong></p>
<pre><code class="hljs language-go" lang="go">$ <span class="hljs-keyword">go</span> run main.<span class="hljs-keyword">go</span> -host example.com
</code></pre>
<p><strong>扫描指定端口范围：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">$ go run main.go -host example.com -start <span class="hljs-number">80</span> -end <span class="hljs-number">443</span>
</code></pre>
<p><strong>增加超时和详细信息：</strong></p>
<pre><code class="hljs language-go" lang="go">$ <span class="hljs-keyword">go</span> run main.<span class="hljs-keyword">go</span> -host example.com -verbose -timeout <span class="hljs-number">2000</span>
</code></pre>
<p><strong>以更高的并发性扫描以获得更快的结果：</strong></p>
<pre><code class="hljs language-go" lang="go">$ <span class="hljs-keyword">go</span> run main.<span class="hljs-keyword">go</span> -host example.com -concurrency <span class="hljs-number">200</span>
</code></pre>
<p>示例文本输出：</p>
<pre><code class="hljs language-arduino" lang="arduino">Scanning example.com from port <span class="hljs-number">1</span> to <span class="hljs-number">1024</span>
Scan completed in <span class="hljs-number">12.6</span>s
Found <span class="hljs-number">3</span> open ports:

PORT    SERVICE VERSION
----    ------- -------
<span class="hljs-number">22</span>      SSH     OpenSSH_7<span class="hljs-number">.4</span>p1
  Vulnerabilities:
    [Medium] CVE<span class="hljs-number">-2017</span><span class="hljs-number">-15906</span> - The process_open function in sftp-server.c in OpenSSH before <span class="hljs-number">7.6</span> does <span class="hljs-keyword">not</span> properly prevent write operations in read-only mode
    Reference: https:<span class="hljs-comment">//nvd.nist.gov/vuln/detail/CVE-2017-15906</span>

<span class="hljs-number">80</span>      HTTP    Apache/<span class="hljs-number">2.4</span><span class="hljs-number">.41</span>
  Vulnerabilities:
    [High] CVE<span class="hljs-number">-2020</span><span class="hljs-number">-9490</span> - A specially crafted value <span class="hljs-keyword">for</span> the <span class="hljs-string">'Cache-Digest'</span> header can cause a heap overflow in Apache HTTP <span class="hljs-built_in">Server</span> <span class="hljs-number">2.4</span><span class="hljs-number">.0</span><span class="hljs-number">-2.4</span><span class="hljs-number">.41</span>
    Reference: https:<span class="hljs-comment">//nvd.nist.gov/vuln/detail/CVE-2020-9490</span>

<span class="hljs-number">443</span>     HTTPS   nginx/<span class="hljs-number">1.18</span><span class="hljs-number">.0</span>：
</code></pre>
<p>JSON 输出示例：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scan_time"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-03-18T14:30:00Z"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"elapsed_time"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"12.6s"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"total_ports"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1024</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"open_ports"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"results"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"Port"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">22</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"State"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Service"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"SSH"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Banner"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"SSH-2.0-OpenSSH_7.4p1"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"OpenSSH_7.4p1"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Vulnerabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"ID"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"CVE-2017-15906"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"Description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"The process_open function in sftp-server.c in OpenSSH before 7.6 does not properly prevent write operations in read-only mode"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"Severity"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Medium"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"Reference"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://nvd.nist.gov/vuln/detail/CVE-2017-15906"</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"Port"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">80</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"State"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Service"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"HTTP"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Banner"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"HTTP/1.1 200 OK\r\nServer: Apache/2.4.41"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Apache/2.4.41"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Vulnerabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"ID"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"CVE-2020-9490"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"Description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"A specially crafted value for the 'Cache-Digest' header can cause a heap overflow in Apache HTTP Server 2.4.0-2.4.41"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"Severity"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"High"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"Reference"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://nvd.nist.gov/vuln/detail/CVE-2020-9490"</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"Port"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">443</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"State"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Service"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"HTTPS"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Banner"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"HTTP/1.1 200 OK\r\nServer: nginx/1.18.0"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"nginx/1.18.0"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Vulnerabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>我们用 Go 语言构建了一个强大的网络漏洞扫描器，这表明该语言非常适合用于安全工具。扫描器能迅速打开端口，识别端口上运行的服务，并判断是否存在已知漏洞。</p>
<p>扫描器提供了有关网络上运行的服务的有用信息，包括多线程、服务指纹识别以及多种输出格式。</p>
<p>请记住，像扫描器这样的工具只能在符合道德和法律规范的条件下使用，并且需要获得对目标系统的扫描授权。如果操作得当，定期进行漏洞扫描是良好安全态势的重要组成部分，能够帮助保护系统免受威胁。</p>
<p>可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frezmoss%2Fnetwork-vulnerability-scanner" title="https://github.com/rezmoss/network-vulnerability-scanner" target="_blank" ref="nofollow noopener noreferrer">GitHub</a> 上找到该项目的完整源代码。</p>
<hr/>
<blockquote>
<p>你好，我是俞凡，在Motorola做过研发，现在在Mavenir做技术工作，对通信、网络、后端架构、云原生、DevOps、CICD、区块链、AI等技术始终保持着浓厚的兴趣，平时喜欢阅读、思考，相信持续学习、终身成长，欢迎一起交流学习。为了方便大家以后能第一时间看到文章，请朋友们关注公众号"DeepNoMind"，并设个星标吧，如果能一键三连(转发、点赞、在看)，则能给我带来更多的支持和动力，激励我持续写下去，和大家共同成长进步！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React DevTools 组件名乱码？揭秘从开发到生产的代码变形记]]></title>    <link>https://juejin.cn/post/7571678763781652514</link>    <guid>https://juejin.cn/post/7571678763781652514</guid>    <pubDate>2025-11-12T14:34:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571678763781652514" data-draft-id="7571672422689488948" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React DevTools 组件名乱码？揭秘从开发到生产的代码变形记"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2025-11-12T14:34:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React DevTools 组件名乱码？揭秘从开发到生产的代码变形记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T14:34:55.000Z" title="Wed Nov 12 2025 14:34:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React DevTools 组件名乱码？聊聊代码压缩这件事</h2>
<p>线上打开 React DevTools，打开一看，组件树全是 <code>C0</code>、<code>$r</code>、<code>pv</code> 这种不可读的字符。</p>
<p>开发环境明明好好的，叫 <code>NavigationProvider</code>、<code>DialogPortal</code>，怎么到线上就全变了？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23fcd0708f5641e494aca20e819a15d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lmf5peg6aOO6Zuo5Lmf6Zu-5pm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763562895&amp;x-signature=9AyhGROp8t67XkehvUG1el%2BeKjw%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-1">问题出在哪</h3>
<p>简单说：<strong>生产构建时，代码被压缩了，函数名被改成了短字符。</strong></p>
<p>React DevTools 依赖函数名来显示组件名。函数名变了，显示的自然也就变了。</p>
<h4 data-id="heading-2">开发环境 vs 生产环境</h4>
<p><strong>开发环境</strong>：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}
</code></pre>
<p>React DevTools 显示：<code>NavigationProvider</code> ✅</p>
<p><strong>生产环境</strong>（压缩后）：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">pv</span>(<span class="hljs-params">{children:e}</span>){<span class="hljs-keyword">return</span> <span class="hljs-title function_">jsx</span>(<span class="hljs-title class_">Provider</span>,{<span class="hljs-attr">children</span>:e})}
</code></pre>
<p>React DevTools 显示：<code>pv</code> ❌</p>
<h3 data-id="heading-3">从开发到生产：代码都经历了什么</h3>
<p>要理解为什么会被压缩，先要知道我们写的代码是怎么变成用户访问的线上代码的。</p>
<h4 data-id="heading-4">开发模式：原汁原味</h4>
<p>用脚手架（Create React App、Vite）开发时，启动的是<strong>开发服务器</strong>。</p>
<pre><code class="hljs language-bash" lang="bash">npm run dev
<span class="hljs-comment"># 或</span>
npm start
</code></pre>
<p>这时候：</p>
<ul>
<li>代码实时编译，但<strong>不压缩</strong></li>
<li>保留完整的变量名、函数名</li>
<li>包含 Source Maps（方便调试）</li>
<li>有热更新（Hot Module Replacement）</li>
</ul>
<p>浏览器加载的代码长这样：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// http://localhost:3000/src/App.jsx</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">const</span> [location, setLocation] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}
</code></pre>
<p>清清楚楚，React DevTools 自然能读到 <code>NavigationProvider</code>。</p>
<h4 data-id="heading-5">生产构建：全面优化</h4>
<p>准备部署上线时，要执行构建命令：</p>
<pre><code class="hljs language-bash" lang="bash">npm run build
</code></pre>
<p>这一步会调用打包工具（Webpack、Vite、Rollup），做一系列优化：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[源代码&lt;br/&gt;多个 .jsx 文件] --&gt; B[编译&lt;br/&gt;JSX → JS]
    B --&gt; C[打包&lt;br/&gt;合并成少数文件]
    C --&gt; D[Tree Shaking&lt;br/&gt;删除未使用代码]
    D --&gt; E[压缩&lt;br/&gt;Minification]
    E --&gt; F[生产代码&lt;br/&gt;dist/main.abc123.js]
</code></pre>
<h5 data-id="heading-6">1. 编译（Transpilation）</h5>
<p>Babel 把 JSX 和现代 JS 语法转成浏览器能理解的代码。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 源代码</span>
&lt;<span class="hljs-title class_">Provider</span>&gt;{children}&lt;/<span class="hljs-title class_">Provider</span>&gt;

<span class="hljs-comment">// 编译后</span>
<span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-title class_">Provider</span>, <span class="hljs-literal">null</span>, children)
</code></pre>
<h5 data-id="heading-7">2. 打包（Bundling）</h5>
<p>把几十上百个文件合并成几个文件。</p>
<pre><code class="hljs language-css" lang="css">开发环境：
├── App<span class="hljs-selector-class">.jsx</span>
├── components/
│   ├── Navigation<span class="hljs-selector-class">.jsx</span>
│   ├── <span class="hljs-selector-tag">Header</span><span class="hljs-selector-class">.jsx</span>
│   └── <span class="hljs-selector-tag">Footer</span><span class="hljs-selector-class">.jsx</span>
└── utils/
    └── helpers<span class="hljs-selector-class">.js</span>

生产环境：
└── dist/
    └── <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.abc123</span><span class="hljs-selector-class">.js</span>  ← 全部合并
</code></pre>
<h5 data-id="heading-8">3. Tree Shaking</h5>
<p>删除没用到的代码。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">usedFunction</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* ... */</span> }
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">unusedFunction</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* ... */</span> }  <span class="hljs-comment">// 这个没被 import</span>

<span class="hljs-comment">// 打包后：unusedFunction 被删除</span>
</code></pre>
<h5 data-id="heading-9">4. 压缩（Minification）</h5>
<p><strong>这就是导致组件名乱码的关键步骤。</strong></p>
<p>压缩器（Terser、esbuild）把代码体积压到最小：</p>
<ul>
<li>删除空格、换行、注释</li>
<li>缩短变量名和函数名</li>
<li>简化代码逻辑</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 压缩前</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">const</span> [location, setLocation] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}

<span class="hljs-comment">// 压缩后</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">pv</span>(<span class="hljs-params">{children:e}</span>){<span class="hljs-keyword">const</span>[t,n]=<span class="hljs-title function_">useState</span>(<span class="hljs-string">"/"</span>);<span class="hljs-keyword">return</span> <span class="hljs-title function_">jsx</span>(<span class="hljs-title class_">Provider</span>,<span class="hljs-literal">null</span>,e)}
</code></pre>
<h4 data-id="heading-10">为什么生产环境要这么做</h4>
<p><strong>一个字：快。</strong></p>
<p>用户访问网站时：</p>
<ol>
<li>浏览器从服务器下载 JS 文件</li>
<li>解析代码</li>
<li>执行代码</li>
</ol>
<p><strong>如果不压缩</strong>：</p>
<ul>
<li>一个中型 React 应用，原始代码可能 2-3 MB</li>
<li>在 3G 网络下，下载要 20-30 秒</li>
<li>用户看到白屏，早跑了</li>
</ul>
<p><strong>压缩后</strong>：</p>
<ul>
<li>代码体积降到 500-800 KB</li>
<li>Gzip 压缩后可能只有 200 KB</li>
<li>下载时间缩短到 3-5 秒</li>
</ul>
<p>体积差异这么大，主要因为：</p>
<ul>
<li><strong>空格和换行</strong>：原始代码为了可读性，大量使用缩进和换行（占 20-30%）</li>
<li><strong>变量名和函数名</strong>：<code>NavigationProvider</code> → <code>pv</code> 这种压缩（占 30-40%）</li>
<li><strong>注释</strong>：开发时的注释在生产环境完全删除（占 5-10%）</li>
<li><strong>未使用的代码</strong>：Tree Shaking 删除（占 10-20%）</li>
</ul>
<p>所以，<strong>压缩是生产环境的必备步骤</strong>，不是可选项。</p>
<h4 data-id="heading-11">压缩在哪个阶段</h4>
<p>在 Webpack 或 Vite 的配置中，压缩是最后一步：</p>
<p><strong>Webpack 配置</strong>（简化版）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
    <span class="hljs-attr">mode</span>: <span class="hljs-string">'production'</span>,  <span class="hljs-comment">// 自动启用压缩</span>

    <span class="hljs-attr">optimization</span>: {
        <span class="hljs-attr">minimize</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 开启压缩</span>
        <span class="hljs-attr">minimizer</span>: [
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">TerserPlugin</span>(),  <span class="hljs-comment">// 使用 Terser 压缩</span>
        ],
    },
};
</code></pre>
<p><strong>Vite 配置</strong>（简化版）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    <span class="hljs-attr">build</span>: {
        <span class="hljs-attr">minify</span>: <span class="hljs-string">'terser'</span>,  <span class="hljs-comment">// 使用 Terser 压缩（默认是 esbuild）</span>
    },
};
</code></pre>
<p>当你执行 <code>npm run build</code>，打包工具会：</p>
<ol>
<li>编译所有源文件</li>
<li>合并成几个大文件</li>
<li><strong>最后调用压缩器处理</strong></li>
<li>输出到 <code>dist/</code> 目录</li>
</ol>
<p>压缩是<strong>构建流程的最后一步</strong>，产出的就是上线的代码。</p>
<h4 data-id="heading-12">开发和生产的环境区别</h4>













































<table><thead><tr><th>特性</th><th>开发环境</th><th>生产环境</th></tr></thead><tbody><tr><td>命令</td><td><code>npm run dev</code></td><td><code>npm run build</code></td></tr><tr><td>代码压缩</td><td>❌</td><td>✅</td></tr><tr><td>变量名</td><td><code>NavigationProvider</code></td><td><code>pv</code></td></tr><tr><td>文件体积</td><td>2-3 MB</td><td>500-800 KB</td></tr><tr><td>Source Maps</td><td>✅ 完整</td><td>❌ 或隐藏</td></tr><tr><td>调试体验</td><td>轻松</td><td>困难</td></tr><tr><td>加载速度</td><td>慢（本地不care）</td><td>快（关键指标）</td></tr></tbody></table>
<p>现在明白了：<strong>开发时你写的清晰代码，到用户那里已经面目全非</strong>。</p>
<p>而组件名乱码，就是这个"面目全非"的副作用。</p>
<h3 data-id="heading-13">为什么要压缩函数名</h3>
<p>理解了背景，再看具体的压缩逻辑就清楚了。</p>
<p><strong>减小文件体积，加快加载速度。</strong></p>
<p>压缩器做的事：</p>
<ol>
<li><strong>删除空格和换行</strong></li>
<li><strong>缩短变量名</strong>：<code>userName</code> → <code>u</code></li>
<li><strong>缩短函数名</strong>：<code>NavigationProvider</code> → <code>pv</code></li>
<li><strong>简化代码结构</strong></li>
</ol>
<p>看个真实例子：</p>
<p><strong>压缩前</strong>（15 KB）：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">const</span> [location, setLocation] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">navigate</span> = (<span class="hljs-params">path</span>) =&gt; {
        <span class="hljs-title function_">setLocation</span>(path);
    };

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Context.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">location</span>, <span class="hljs-attr">navigate</span> }}&gt;</span>
            {children}
        <span class="hljs-tag">&lt;/<span class="hljs-name">Context.Provider</span>&gt;</span></span>
    );
}
</code></pre>
<p><strong>压缩后</strong>（4 KB）：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">pv</span>(<span class="hljs-params">{children:e}</span>){<span class="hljs-keyword">const</span>[t,n]=<span class="hljs-title function_">useState</span>(<span class="hljs-string">"/"</span>);<span class="hljs-keyword">return</span> <span class="hljs-title function_">jsx</span>(<span class="hljs-title class_">Context</span>.<span class="hljs-property">Provider</span>,{<span class="hljs-attr">value</span>:{<span class="hljs-attr">location</span>:t,<span class="hljs-attr">navigate</span>:<span class="hljs-function"><span class="hljs-params">r</span>=&gt;</span><span class="hljs-title function_">n</span>(r)},<span class="hljs-attr">children</span>:e})}
</code></pre>
<p>体积直接砍掉 70%。</p>
<p>其中 <code>NavigationProvider</code> → <code>pv</code> 就省了 17 个字符。整个项目几百个函数，加起来就是几十 KB 的差异。</p>
<h3 data-id="heading-14">压缩过程详解</h3>
<p>压缩不是简单的文本替换，而是经过多个阶段的代码转换。</p>
<h4 data-id="heading-15">完整的构建流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[源代码 JSX] --&gt; B[Babel 转译]
    B --&gt; C[打包合并]
    C --&gt; D[Terser 压缩]
    D --&gt; E[生产代码]
</code></pre>
<ol>
<li><strong>Babel 转译</strong>：把 JSX 转成标准 JavaScript</li>
<li><strong>打包合并</strong>：多个文件合成一个文件</li>
<li><strong>Terser 压缩</strong>：真正的压缩发生在这一步</li>
<li><strong>输出</strong>：最终的生产代码</li>
</ol>
<p>重点看第三步，压缩器内部其实也分好几个阶段。</p>
<h4 data-id="heading-16">Terser 的压缩阶段</h4>
<h5 data-id="heading-17">阶段 1：解析（Parse）</h5>
<p>把代码转成抽象语法树（AST）。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 源代码</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}

<span class="hljs-comment">// 转成 AST（简化版）</span>
{
    <span class="hljs-attr">type</span>: <span class="hljs-string">"FunctionDeclaration"</span>,
    <span class="hljs-attr">id</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">"Identifier"</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"NavigationProvider"</span> },
    <span class="hljs-attr">params</span>: [
        {
            <span class="hljs-attr">type</span>: <span class="hljs-string">"ObjectPattern"</span>,
            <span class="hljs-attr">properties</span>: [{ <span class="hljs-attr">key</span>: <span class="hljs-string">"children"</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">"children"</span> }]
        }
    ],
    <span class="hljs-attr">body</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-string">"ReturnStatement"</span>,
        <span class="hljs-attr">argument</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">"JSXElement"</span>, ... }
    }
}
</code></pre>
<p>AST 就是代码的树状结构表示，方便后续分析和修改。</p>
<h5 data-id="heading-18">阶段 2：分析（Analyze）</h5>
<p><strong>2.1 作用域分析</strong></p>
<p>找出哪些变量名可以改，哪些不能改。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">const</span> location = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);  <span class="hljs-comment">// 局部变量，可以改</span>
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}

<span class="hljs-variable language_">window</span>.<span class="hljs-property">NavigationProvider</span> = <span class="hljs-title class_">NavigationProvider</span>;  <span class="hljs-comment">// 全局引用，不能改</span>
</code></pre>
<p>规则：</p>
<ul>
<li><strong>可以改</strong>：函数内部的局部变量、函数名（如果没被外部引用）</li>
<li><strong>不能改</strong>：全局变量、对象属性名、被 <code>eval()</code> 使用的变量</li>
</ul>
<p><strong>2.2 引用计数</strong></p>
<p>统计每个标识符出现了多少次，决定是否值得压缩。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {  <span class="hljs-comment">// NavigationProvider 出现 1 次</span>
    <span class="hljs-keyword">const</span> location = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);          <span class="hljs-comment">// location 出现 1 次</span>
    <span class="hljs-keyword">const</span> currentLocation = location;        <span class="hljs-comment">// location 出现 2 次</span>
    <span class="hljs-keyword">return</span> currentLocation;                  <span class="hljs-comment">// currentLocation 出现 1 次</span>
}
</code></pre>
<p>如果一个变量只用了 1 次，改成短名称可能不划算（比如 <code>location</code> → <code>a</code> 只省 7 个字符）。</p>
<p><strong>2.3 依赖分析</strong></p>
<p>找出变量之间的依赖关系，避免命名冲突。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">outer</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> a = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">inner</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> b = <span class="hljs-number">2</span>;  <span class="hljs-comment">// b 可以重命名为 a，因为不在同一作用域</span>
        <span class="hljs-keyword">return</span> b;
    }
    <span class="hljs-keyword">return</span> a;
}
</code></pre>
<h5 data-id="heading-19">阶段 3：转换（Transform）</h5>
<p>这是真正做压缩的阶段，分多个步骤。</p>
<p><strong>3.1 删除死代码（Dead Code Elimination）</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 压缩前</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DEBUG</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-variable constant_">DEBUG</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'debug'</span>);  <span class="hljs-comment">// 这段永远不会执行</span>
    }
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}

<span class="hljs-comment">// 压缩后</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}
</code></pre>
<p><strong>3.2 常量折叠（Constant Folding）</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 压缩前</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MAX_COUNT</span> = <span class="hljs-number">10</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DOUBLED</span> = <span class="hljs-variable constant_">MAX_COUNT</span> * <span class="hljs-number">2</span>;
<span class="hljs-keyword">if</span> (count &gt; <span class="hljs-variable constant_">DOUBLED</span>) { <span class="hljs-comment">/* ... */</span> }

<span class="hljs-comment">// 压缩后</span>
<span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">20</span>) { <span class="hljs-comment">/* ... */</span> }
</code></pre>
<p>直接算出结果，减少运行时计算。</p>
<p><strong>3.3 表达式简化</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 压缩前</span>
<span class="hljs-keyword">if</span> (isActive === <span class="hljs-literal">true</span>) { <span class="hljs-comment">/* ... */</span> }

<span class="hljs-comment">// 压缩后</span>
<span class="hljs-keyword">if</span> (isActive) { <span class="hljs-comment">/* ... */</span> }
</code></pre>
<p><strong>3.4 变量名压缩（Mangle）</strong></p>
<p>这是我们关心的重点。</p>
<p>压缩器遍历 AST，按照一定规则替换标识符：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 压缩前</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">const</span> [location, setLocation] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">navigate</span> = (<span class="hljs-params">path</span>) =&gt; <span class="hljs-title function_">setLocation</span>(path);
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">location</span>, <span class="hljs-attr">navigate</span> }}&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}

<span class="hljs-comment">// 第一轮：函数名</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">pv</span>(<span class="hljs-params">{ children }</span>) {  <span class="hljs-comment">// NavigationProvider → pv</span>
    <span class="hljs-keyword">const</span> [location, setLocation] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">navigate</span> = (<span class="hljs-params">path</span>) =&gt; <span class="hljs-title function_">setLocation</span>(path);
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">location</span>, <span class="hljs-attr">navigate</span> }}&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}

<span class="hljs-comment">// 第二轮：参数名</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">pv</span>(<span class="hljs-params">{ children: e }</span>) {  <span class="hljs-comment">// children → e</span>
    <span class="hljs-keyword">const</span> [location, setLocation] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">navigate</span> = (<span class="hljs-params">path</span>) =&gt; <span class="hljs-title function_">setLocation</span>(path);
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">location</span>, <span class="hljs-attr">navigate</span> }}&gt;</span>{e}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}

<span class="hljs-comment">// 第三轮：局部变量</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">pv</span>(<span class="hljs-params">{ children: e }</span>) {
    <span class="hljs-keyword">const</span> [t, n] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);  <span class="hljs-comment">// location → t, setLocation → n</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">r</span> = (<span class="hljs-params">o</span>) =&gt; <span class="hljs-title function_">n</span>(o);         <span class="hljs-comment">// navigate → r, path → o</span>
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">location:</span> <span class="hljs-attr">t</span>, <span class="hljs-attr">navigate:</span> <span class="hljs-attr">r</span> }}&gt;</span>{e}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}
</code></pre>
<p>注意：<strong>对象属性名不会改</strong>（<code>location:</code>、<code>navigate:</code> 保持原样），因为这些是对外的接口。</p>
<p><strong>3.5 作用域提升（Scope Hoisting）</strong></p>
<p>把多个模块合并到一个作用域，减少闭包和函数调用。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 压缩前（两个文件）</span>
<span class="hljs-comment">// utils.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">formatDate</span>(<span class="hljs-params">date</span>) { <span class="hljs-keyword">return</span> date.<span class="hljs-title function_">toString</span>(); }

<span class="hljs-comment">// app.js</span>
<span class="hljs-keyword">import</span> { formatDate } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">formatDate</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()));

<span class="hljs-comment">// 压缩后（合并）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">a</span>(<span class="hljs-params">b</span>) { <span class="hljs-keyword">return</span> b.<span class="hljs-title function_">toString</span>(); }
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">a</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()));
</code></pre>
<h5 data-id="heading-20">阶段 4：生成（Generate）</h5>
<p>把修改后的 AST 转回代码字符串。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// AST 转回代码</span>
{
    <span class="hljs-attr">type</span>: <span class="hljs-string">"FunctionDeclaration"</span>,
    <span class="hljs-attr">id</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">"pv"</span> },  <span class="hljs-comment">// 已被修改</span>
    <span class="hljs-attr">params</span>: [{ <span class="hljs-attr">name</span>: <span class="hljs-string">"e"</span> }],
    <span class="hljs-attr">body</span>: { ... }
}

<span class="hljs-comment">// 生成代码</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">pv</span>(<span class="hljs-params">e</span>){<span class="hljs-keyword">const</span>[t,n]=<span class="hljs-title function_">useState</span>(<span class="hljs-string">"/"</span>);<span class="hljs-keyword">return</span> <span class="hljs-title function_">jsx</span>(<span class="hljs-title class_">Provider</span>,{<span class="hljs-attr">value</span>:{<span class="hljs-attr">location</span>:t,<span class="hljs-attr">navigate</span>:<span class="hljs-function"><span class="hljs-params">r</span>=&gt;</span><span class="hljs-title function_">n</span>(r)},<span class="hljs-attr">children</span>:e})}
</code></pre>
<p>同时删除所有空格、换行、注释。</p>
<h4 data-id="heading-21">命名规则详解</h4>
<p>压缩器分配短名称时的优先级：</p>
<h5 data-id="heading-22">1. 单字母（52 个）</h5>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">a</span>, <span class="hljs-selector-tag">b</span>, c, ..., z
<span class="hljs-selector-tag">A</span>, <span class="hljs-selector-tag">B</span>, C, ..., Z
</code></pre>
<p>最常用的标识符会优先分配这些。</p>
<h5 data-id="heading-23">2. 美元符号和下划线（104 个）</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-variable">$a</span>, <span class="hljs-variable">$b</span>, ..., <span class="hljs-variable">$Z</span>
_a, _b, ..., _Z
</code></pre>
<p>单字母用完就加前缀。</p>
<h5 data-id="heading-24">3. 两个字母（2704 个）</h5>
<pre><code class="hljs">aa, ab, ac, ..., ZZ
</code></pre>
<p>再不够就用两个字母组合。</p>
<h5 data-id="heading-25">4. 特殊组合</h5>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-variable">$,</span> _, <span class="hljs-variable">$$</span>, <span class="hljs-variable">$_</span>, ...
</code></pre>
<p>然后是各种特殊字符组合。</p>
<p>所以你看到的 <code>pv</code>、<code>$r</code>、<code>Jt</code> 都是按照这个顺序分配的。</p>
<h4 data-id="heading-26">真实例子对比</h4>
<p>拿一段完整的代码看看每个阶段的变化：</p>
<p><strong>原始代码</strong>（150 行，5 KB）：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState, useContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">NavigationContext</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">const</span> [currentLocation, setCurrentLocation] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">navigate</span> = (<span class="hljs-params">newPath</span>) =&gt; {
        <span class="hljs-keyword">if</span> (newPath !== currentLocation) {
            <span class="hljs-title function_">setCurrentLocation</span>(newPath);
            <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">pushState</span>({}, <span class="hljs-string">''</span>, newPath);
        }
    };

    <span class="hljs-keyword">const</span> value = {
        <span class="hljs-attr">location</span>: currentLocation,
        <span class="hljs-attr">navigate</span>: navigate
    };

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">NavigationContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span>&gt;</span>
            {children}
        <span class="hljs-tag">&lt;/<span class="hljs-name">NavigationContext.Provider</span>&gt;</span></span>
    );
}
</code></pre>
<p><strong>经过 Babel</strong>（转 JSX）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState, useContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">NavigationContext</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">const</span> [currentLocation, setCurrentLocation] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">navigate</span> = (<span class="hljs-params">newPath</span>) =&gt; {
        <span class="hljs-keyword">if</span> (newPath !== currentLocation) {
            <span class="hljs-title function_">setCurrentLocation</span>(newPath);
            <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">pushState</span>({}, <span class="hljs-string">''</span>, newPath);
        }
    };

    <span class="hljs-keyword">const</span> value = {
        <span class="hljs-attr">location</span>: currentLocation,
        <span class="hljs-attr">navigate</span>: navigate
    };

    <span class="hljs-keyword">return</span> <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(
        <span class="hljs-title class_">NavigationContext</span>.<span class="hljs-property">Provider</span>,
        { <span class="hljs-attr">value</span>: value },
        children
    );
}
</code></pre>
<p><strong>经过 Terser 分析</strong>（内部记录）：</p>
<pre><code class="hljs language-diff" lang="diff">作用域分析：
<span class="hljs-deletion">- NavigationContext: 全局导出，不能改</span>
<span class="hljs-deletion">- NavigationProvider: 全局导出，不能改</span>
<span class="hljs-deletion">- children: 函数参数，可以改 → e</span>
<span class="hljs-deletion">- currentLocation: 局部变量，可以改 → t</span>
<span class="hljs-deletion">- setCurrentLocation: 局部变量，可以改 → n</span>
<span class="hljs-deletion">- navigate: 局部变量，可以改 → r</span>
<span class="hljs-deletion">- newPath: 函数参数，可以改 → o</span>
<span class="hljs-deletion">- value: 局部变量，可以改 → a（但会被内联优化掉）</span>
</code></pre>
<p><strong>经过 Terser 压缩</strong>（最终产物，1.5 KB）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span>{useState <span class="hljs-keyword">as</span> t}<span class="hljs-keyword">from</span><span class="hljs-string">"react"</span>;<span class="hljs-keyword">const</span> n=<span class="hljs-title class_">React</span>.<span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{children:e}</span>){<span class="hljs-keyword">const</span>[r,o]=<span class="hljs-title function_">t</span>(<span class="hljs-string">"/"</span>),c=<span class="hljs-function"><span class="hljs-params">i</span>=&gt;</span>{i!==r&amp;&amp;(<span class="hljs-title function_">o</span>(i),<span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">pushState</span>({},<span class="hljs-string">""</span>,i))};<span class="hljs-keyword">return</span> <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(n.<span class="hljs-property">Provider</span>,{<span class="hljs-attr">value</span>:{<span class="hljs-attr">location</span>:r,<span class="hljs-attr">navigate</span>:c}},e)}
</code></pre>
<p><strong>体积对比</strong>：</p>
<ul>
<li>原始代码：5 KB</li>
<li>Babel 转译后：5.2 KB（JSX 转换略有增加）</li>
<li>Terser 压缩后：1.5 KB（减少 70%）</li>
</ul>
<p>关键变化：</p>
<ol>
<li>删除所有空格和换行：<code>5KB → 4KB</code></li>
<li>变量名压缩：<code>4KB → 2KB</code></li>
<li>表达式简化和内联：<code>2KB → 1.5KB</code></li>
</ol>
<h4 data-id="heading-27">为什么这么激进</h4>
<p>现代 Web 应用动辄几百个组件，上千个函数。</p>
<p>如果不压缩函数名和变量名：</p>
<ul>
<li>平均每个函数名 15 字符</li>
<li>1000 个函数 = 15KB 仅用于命名</li>
<li>加上变量名，总共可能 50KB+</li>
</ul>
<p>50KB 在 3G 网络下，多加载 3-5 秒。</p>
<p>所以压缩器默认非常激进，能压缩的全压缩。</p>
<h3 data-id="heading-28">背后的原理</h3>
<h4 data-id="heading-29">函数名是怎么被替换的</h4>
<p>压缩器内部维护一个映射表：</p>
<pre><code class="hljs language-bash" lang="bash">原始名称 → 压缩后名称
NavigationProvider → pv
LocationProvider → <span class="hljs-variable">$r</span>
DialogPortal → Jt
Link → vv
</code></pre>
<p>规则很简单：</p>
<ol>
<li>按出现顺序分配短名称</li>
<li>优先用单字母（a-z, A-Z）</li>
<li>单字母用完就用两个字母（aa, ab, ...）</li>
<li>加上特殊字符（$, _）增加组合数</li>
</ol>
<p>所以你会看到 <code>a</code>、<code>$r</code>、<code>pv</code>、<code>Jt</code> 这种看起来毫无规律的名称。</p>
<h4 data-id="heading-30">React DevTools 怎么知道组件名</h4>
<p>React DevTools 获取组件名的逻辑：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[读取组件] --&gt; B{有 displayName?}
    B --&gt;|有| C[显示 displayName]
    B --&gt;|没有| D{有函数名?}
    D --&gt;|有| E[显示函数名]
    D --&gt;|没有| F[显示 Anonymous]
</code></pre>
<p>优先级：<code>displayName</code> &gt; <code>函数名</code> &gt; <code>"Anonymous"</code></p>
<p>开发环境：</p>
<ul>
<li>函数名完整保留 → DevTools 读到 <code>NavigationProvider</code></li>
</ul>
<p>生产环境：</p>
<ul>
<li>函数名被压缩成 <code>pv</code> → DevTools 只能读到 <code>pv</code></li>
<li>没设置 <code>displayName</code> → 没有备用方案</li>
</ul>
<p>所以就出现了开头那张图的情况。</p>
<h3 data-id="heading-31">为什么不是所有组件都乱码</h3>
<p>你可能注意到，有些组件名还是正常的，比如 <code>Link</code>、<code>Menu</code>、<code>Dialog</code>。</p>
<p>原因有三种：</p>
<h4 data-id="heading-32">1. 组件设置了 displayName</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">MyComponent</span> = (<span class="hljs-params"/>) =&gt; <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Hello<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
<span class="hljs-title class_">MyComponent</span>.<span class="hljs-property">displayName</span> = <span class="hljs-string">'MyComponent'</span>;
</code></pre>
<p>压缩器不会改 <code>displayName</code>（它是字符串，不是标识符）。</p>
<h4 data-id="heading-33">2. 组件来自第三方库</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Dialog</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@mui/material'</span>;
</code></pre>
<p>第三方库通常会设置 <code>displayName</code>，或者配置了保留函数名的构建选项。</p>
<h4 data-id="heading-34">3. 名称太短，碰巧没变</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Link</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* ... */</span> }
</code></pre>
<p>如果原本就叫 <code>Link</code>，压缩后可能还是 <code>Link</code>（4 个字符，不一定值得压缩）。</p>
<p>但这纯靠运气，不能依赖。</p>
<h3 data-id="heading-35">怎么解决</h3>
<p>核心思路就两个方向：</p>
<h4 data-id="heading-36">1. 告诉压缩器：别改函数名</h4>
<p>Webpack/Vite 配置中，设置 Terser 选项：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">terserOptions</span>: {
    <span class="hljs-attr">keep_fnames</span>: <span class="hljs-literal">true</span>  <span class="hljs-comment">// 保留函数名</span>
}
</code></pre>
<p>代价：包体积增加 5-10%。</p>
<h4 data-id="heading-37">2. 手动给组件加 displayName</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">NavigationProvider</span> = (<span class="hljs-params">{ children }</span>) =&gt; {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
};

<span class="hljs-title class_">NavigationProvider</span>.<span class="hljs-property">displayName</span> = <span class="hljs-string">'Navigation.Provider'</span>;
</code></pre>
<p>好处：精确控制，体积影响小。
代价：要手动维护。</p>
<h3 data-id="heading-38">该不该解决</h3>
<p><strong>内部系统/管理后台</strong>：</p>
<ul>
<li>调试需求高，体积不敏感</li>
<li>建议保留函数名，调试体验直接拉满</li>
</ul>
<p><strong>面向用户的产品</strong>：</p>
<ul>
<li>体积影响加载速度，调试主要在开发环境</li>
<li>不用管，或者只给核心组件加 displayName</li>
</ul>
<p><strong>开源组件库</strong>：</p>
<ul>
<li>用户调试需要清晰的组件名</li>
<li>建议加 displayName，或构建时保留函数名</li>
</ul>
<p>大多数情况，这不是个必须解决的问题。线上调试本来就该在 staging 环境（保留函数名），生产环境靠日志和监控。</p>
<h3 data-id="heading-39">相关资料</h3>
<ol>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fterser.org%2Fdocs%2Foptions%2F" target="_blank" title="https://terser.org/docs/options/" ref="nofollow noopener noreferrer">Terser 文档</a></strong> - 了解 <code>keep_fnames</code> 等配置</li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Flearn%2Freact-developer-tools%23why-is-my-component-called-_c" target="_blank" title="https://react.dev/learn/react-developer-tools#why-is-my-component-called-_c" ref="nofollow noopener noreferrer">React 官方：为什么我的组件叫 <code>_c</code>？</a></strong> - React 文档的解释</li>
</ol>
<hr/>
<p>搞清楚原理就好办了。遇到这种情况，知道是代码压缩导致的，而不是 React 或 DevTools 的 bug。</p>
<p>要不要解决，看具体需求。大部分时候，不用管。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[java内存泄漏问题排查和JVM调优]]></title>    <link>https://juejin.cn/post/7572016447804309530</link>    <guid>https://juejin.cn/post/7572016447804309530</guid>    <pubDate>2025-11-13T09:07:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572016447804309530" data-draft-id="7571840220703932462" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="java内存泄漏问题排查和JVM调优"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-11-13T09:07:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="海边捡石子"/> <meta itemprop="url" content="https://juejin.cn/user/2335828265144488"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            java内存泄漏问题排查和JVM调优
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2335828265144488/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    海边捡石子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:07:34.000Z" title="Thu Nov 13 2025 09:07:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Java语言本身支持垃圾自动回收，在日常编程中我们几乎没有关注过对象回收的问题。解决内存泄漏可能停留在八股文上。今天分享一次项目中内存泄漏的排查流程到最终解决。</p>
<h2 data-id="heading-0">java自带了强大的命令行工具</h2>





























<table><thead><tr><th>工具</th><th>核心功能</th><th>主要应用场景</th><th>关键命令/示例</th></tr></thead><tbody><tr><td>**<code>jcmd</code>**​</td><td><strong>多功能诊断</strong>：一个强大的“瑞士军刀”，可执行丰富的诊断命令，涵盖JVM状态查询、内存、线程、GC控制等。</td><td><strong>综合诊断与运维</strong>：获取完整JVM信息（参数、属性）、动态控制（触发GC、开启JFR）、生成线程/堆转储。</td><td><code>jcmd &lt;pid&gt; VM.flags</code>（查看JVM参数） <code>jcmd &lt;pid&gt; Thread.print</code>（生成线程转储） <code>jcmd &lt;pid&gt; GC.heap_dump</code>（生成堆转储）</td></tr><tr><td>**<code>jmap</code>**​</td><td><strong>堆内存分析</strong>：专用于Java堆内存（Heap Memory）的直方图统计和堆转储（Heap Dump）文件生成。</td><td><strong>深度内存分析</strong>：排查内存泄漏、分析堆内对象分布、生成堆转储文件供MAT等工具深度分析。</td><td><code>jmap -histo:live &lt;pid&gt;</code>（存活对象直方图） <code>jmap -dump:live,format=b,file=heap.hprof &lt;pid&gt;</code>（生成堆转储）</td></tr><tr><td>**<code>jstat</code>**​</td><td><strong>JVM统计监控</strong>：持续监控JVM各种运行时指标，特别是垃圾回收（GC）相关数据和类加载信息。</td><td><strong>实时性能监控</strong>：监控GC行为（频率、耗时）、各内存区使用率、类加载/卸载情况，用于性能调优。</td><td><code>jstat -gcutil &lt;pid&gt; &lt;interval&gt; &lt;count&gt;</code>（GC情况摘要） <code>jstat -gc &lt;pid&gt; 1000 5</code>（GC详情，每秒1次共5次）</td></tr></tbody></table>
<h2 data-id="heading-1">Java垃圾回收算法</h2>
<p>Java垃圾回收算法，分代垃圾回收算法</p>
<ul>
<li>新生代：复制算法</li>
<li>老年代：标记-清除算法和标记-整理算法</li>
</ul>
<h2 data-id="heading-2">排查思路</h2>
<p>在解决问题的时候，先了解下我们项目JVM参数信息.</p>
<pre><code class="hljs language-js" lang="js">jcmd &lt;pid&gt; <span class="hljs-variable constant_">VM</span>.<span class="hljs-property">flags</span>
-<span class="hljs-attr">XX</span>:<span class="hljs-title class_">CICompilerCount</span>=<span class="hljs-number">15</span> -<span class="hljs-attr">XX</span>:<span class="hljs-title class_">InitialHeapSize</span>=<span class="hljs-number">1031798784</span> -<span class="hljs-attr">XX</span>:<span class="hljs-title class_">MaxHeapSize</span>=<span class="hljs-number">16489906176</span> -<span class="hljs-attr">XX</span>:<span class="hljs-title class_">MaxNewSize</span>=<span class="hljs-number">5496635392</span> -<span class="hljs-attr">XX</span>:<span class="hljs-title class_">MinHeapDeltaBytes</span>=<span class="hljs-number">524288</span> -<span class="hljs-attr">XX</span>:<span class="hljs-title class_">NewSize</span>=<span class="hljs-number">343932928</span> -<span class="hljs-attr">XX</span>:<span class="hljs-title class_">OldSize</span>=<span class="hljs-number">687865856</span> -<span class="hljs-attr">XX</span>:+<span class="hljs-title class_">UseCompressedClassPointers</span> -<span class="hljs-attr">XX</span>:+<span class="hljs-title class_">UseCompressedOops</span> -<span class="hljs-attr">XX</span>:+<span class="hljs-title class_">UseFastUnorderedTimeStamps</span> -<span class="hljs-attr">XX</span>:+<span class="hljs-title class_">UseParallelGC</span>
</code></pre>
<h3 data-id="heading-3">第一种情况：</h3>
<p>项目运行在linux服务器上，进行压测，内存以肉眼可见的速度上升。
使用top命令查看进程占用内存情况。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e250f8b1505a49a49810f612f3d92c9d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rW36L655o2h55-z5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763629654&amp;x-signature=%2FJ4wiiHRmvzt6DxAYpOWoPWq4Zc%3D" alt="image.png" loading="lazy"/>
这里主要关注下<strong>RES</strong>
进程当前实际使用的、未被换出到交换空间（swap out）的<strong>物理内存</strong>。包含堆内存、非堆内存、堆外内存等。如果RES值持续上升，堆内存保持稳定，说明堆外内存在上升。</p>
<p>这个时候开始考虑使用jmap获取堆转存储。分析那些对象产生的泄漏。</p>
<h3 data-id="heading-4">常见的内存泄漏，</h3>
<p>HashMap 、队列、线程池、websocket等资源没有正确的释放，另外一种是我们的程序调用了native方法，但没有释放资源。</p>
<p>发现泄漏后，最直接的办法生成jvm对象快照。生成<strong>堆转储</strong>文件，</p>
<h3 data-id="heading-5">内存分析工具</h3>
<p><strong>MAT（Memory Analyzer Tool）</strong> ：最常用的堆分析工具，支持自动检测泄漏嫌疑人（Leak Suspects）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1572a88c2cef490da539753a84cf3faa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rW36L655o2h55-z5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763629654&amp;x-signature=1OtTQoTTSvKkemUrH5oeiqaNbWc%3D" alt="image.png" loading="lazy"/>
泄漏嫌疑直接能看到使用websocket相关操作导致的</p>
<h5 data-id="heading-6">关键分析步骤：</h5>
<ol>
<li>
<p><strong>识别 “可疑大对象”</strong> ：</p>
<ul>
<li>在 MAT 中查看 “Histogram”（直方图），按 “Retained Heap”（对象被回收后可释放的内存）排序，找出占用内存前几名的类（如某业务 POJO、集合类）。</li>
<li>关注 “Shallow Heap”（对象本身大小）小但 “Retained Heap” 大的对象（通常是集合，持有大量子对象引用）。</li>
</ul>
</li>
<li>
<p><strong>追溯引用链（支配树 / 引用树）</strong> ：</p>
<ul>
<li>对可疑对象右键选择 “Merge Shortest Paths to GC Roots”（排除弱引用 / 软引用等可被 GC 自动回收的引用类型），查看谁在 “强引用” 该对象。</li>
<li>核心是找到 “根对象”（如静态变量、线程对象、类加载器），这些对象不会被 GC 回收，若其引用链中包含本应释放的对象，则导致泄漏。</li>
</ul>
<p>例：若发现大量<code>User</code>对象被<code>HashMap</code>持有，且<code>HashMap</code>是<code>UserCache</code>类的静态变量，而<code>UserCache</code>未设置过期清理逻辑，则可定位为 “静态缓存未释放” 导致的泄漏。</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Windows搭建MongoDB(5)：Mongosh操作数据库常用命令总结]]></title>    <link>https://juejin.cn/post/7572021695293571122</link>    <guid>https://juejin.cn/post/7572021695293571122</guid>    <pubDate>2025-11-13T08:53:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572021695293571122" data-draft-id="7571726099689062419" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Windows搭建MongoDB(5)：Mongosh操作数据库常用命令总结"/> <meta itemprop="keywords" content="MongoDB"/> <meta itemprop="datePublished" content="2025-11-13T08:53:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="WangHappy"/> <meta itemprop="url" content="https://juejin.cn/user/2137106336976183"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Windows搭建MongoDB(5)：Mongosh操作数据库常用命令总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2137106336976183/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    WangHappy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T08:53:47.000Z" title="Thu Nov 13 2025 08:53:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>大家好，我是WangHappy，一名<code>主业前端，副业全栈</code>的程序员，在这里我会分享关于<code>前端进阶全栈的常用技术</code> 和 <code>基本入门操作</code>。 如果我的文章能让您有所收获，欢迎一键三连（评论，点赞，关注）。</p>
<hr/>
<p>在前端转型全栈的过程中，我们多数情况下使用 node.js 来开发服务端，而 node.js 里操作MongoDB数据库最常用的库是 mongoose，所以 mongosh 在实际开发中的使用频率并不是很高，多用于测试或查看数据库状态等场景。</p>
<p>本章只讲述 Mongosh 一些常用命令，例如：数据库基本的增、删、改、查（CRUD）和状态信息获取等操作，能够满足我们日常开发使用即可。</p>
<h3 data-id="heading-1">1.连接数据库</h3>
<p><strong>1.1 本地连接数据库</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">mongosh --dbpath <span class="hljs-string">"path/data"</span>
</code></pre>
<p><strong>1.2 远程连接数据库</strong></p>
<pre><code class="hljs language-xml" lang="xml">mongosh "mongodb://<span class="hljs-tag">&lt;<span class="hljs-name">hostname</span>&gt;</span>:<span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span>"
</code></pre>
<p>举例：<code>mongosh "mongodb://192.168.0.0:27017"</code></p>
<p><strong>1.3 远程连接数据库并使用用户名密码验证</strong></p>
<pre><code class="hljs language-xml" lang="xml">mongosh "mongodb://<span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span>:<span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>@<span class="hljs-tag">&lt;<span class="hljs-name">hostname</span>&gt;</span>:<span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span>"
</code></pre>
<p>举例：<code>mongosh "mongodb://admin:admin123@192.168.0.0:27017"</code></p>
<h3 data-id="heading-2">2.查看数据库状态</h3>
<p><strong>2.1 查看当前使用的数据库</strong></p>
<pre><code class="hljs">db
</code></pre>
<ul>
<li><strong>切换数据库</strong></li>
</ul>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">use</span> &lt;database_name&gt;
</code></pre>
<p>举例：<code>use admin</code></p>
<p>如果切换的数据库名称当前不存在，则会在 <code>insert</code> 插入数据时自动创建</p>
<blockquote>
<p>注意：是插入数据时创建，而不是使用 <code>use</code> 切换时创建。</p>
</blockquote>
<p><strong>2.2 列出MongoDB实例下所有的数据库</strong></p>
<p><code>show databases</code> 可以查看目前所有的数据库，也可以使用简写 <code>show dbs</code></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">show</span> databases
</code></pre>
<p><strong>2.3 列出当前数据库下所有集合</strong></p>
<p>理论上每个数据库下都可以包含一个或多个集合，它有点类似于我们传统关系型数据库中的 <code>表</code> 的概念。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">show</span> collections
</code></pre>
<p><strong>2.4 退出 mongosh</strong></p>
<p>使用 <code>exit</code> 可以直接退出mongosh数据库连接，也可以使用 <code>ctrl + c</code> 快捷键来退出</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">exit</span>
</code></pre>
<h3 data-id="heading-3">3.数据库的增删改查</h3>
<p><strong>3.1 插入数据</strong></p>
<p>使用 <code>insertOne</code> 插入一条数据，使用 <code>insertMany</code> 插入多条数据，代码如下：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 插入一条数据</span>
db.user.<span class="hljs-title function_ invoke__">insertOne</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">"Mike"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span> })

<span class="hljs-comment">// 插入多条数据</span>
db.user.<span class="hljs-title function_ invoke__">insertMany</span>([{ <span class="hljs-attr">name</span>: <span class="hljs-string">"Marry"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> }, { <span class="hljs-attr">name</span>: <span class="hljs-string">"Kerry"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">35</span> }])
</code></pre>
<p><strong>3.2 删除数据</strong></p>
<p>使用 <code>deleteOne</code> 删除单个文档，使用 <code>deleteMany</code> 删除多个文档</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 删除单个文档</span>
db.user.<span class="hljs-title function_ invoke__">deleteOne</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span> })

<span class="hljs-comment">// 删除年龄30岁以下的数据</span>
db.user.<span class="hljs-title function_ invoke__">deleteMany</span>({ <span class="hljs-attr">age</span>: { <span class="hljs-variable">$lt</span>: <span class="hljs-number">30</span> } })
</code></pre>
<p><strong>3.3 更新数据</strong></p>
<p>使用 <code>updateOne</code> 更新单个文档，使用 <code>updateMany</code> 更新多个文档</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 更新单个文档</span>
db.user.<span class="hljs-title function_ invoke__">updateOne</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span> }, { <span class="hljs-variable">$set</span>: { <span class="hljs-attr">age</span>: <span class="hljs-number">31</span> } })

<span class="hljs-comment">// 更新多个文档</span>
db.user.<span class="hljs-title function_ invoke__">updateMany</span>({ <span class="hljs-attr">age</span>: { <span class="hljs-variable">$lt</span>: <span class="hljs-number">30</span> } }, { <span class="hljs-variable">$set</span>: { <span class="hljs-attr">status</span>: <span class="hljs-string">"young"</span> } })
</code></pre>
<p><strong>3.4 查询数据</strong></p>
<p>使用 <code>find</code> 查询集合中所有数据</p>
<pre><code class="hljs language-lua" lang="lua">db.user.<span class="hljs-built_in">find</span>()
</code></pre>
<p>查询某个条件的文档</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 查询30岁以下的数据</span>
db.user.<span class="hljs-title function_ invoke__">find</span>({ <span class="hljs-attr">age</span>: { <span class="hljs-variable">$gte</span>: <span class="hljs-number">30</span> } })
</code></pre>
<p><strong>3.5 创建索引</strong></p>
<p>为某个字段创建索引</p>
<pre><code class="hljs language-css" lang="css">db<span class="hljs-selector-class">.user</span><span class="hljs-selector-class">.createIndex</span>({ name: <span class="hljs-number">1</span> })
</code></pre>
<p><strong>3.6 查看当前集合下的所有索引</strong></p>
<pre><code class="hljs language-scss" lang="scss">db<span class="hljs-selector-class">.users</span><span class="hljs-selector-class">.getIndexes</span>()
</code></pre>
<p>执行上述代码通常会返回两个索引，<code>_id</code> 和 <code>name</code></p>
<p><code>_id</code> 索引：是自动创建，用于确保每条数据的唯一性。</p>
<p><code>name</code> 索引：自定义索引，方便对指定字段的查询操作，例如 <code>name: 1</code> 表示按升序排列，如果改为 <code>name: -1</code> 表示降序。</p>
<h3 data-id="heading-4">4.其它命令</h3>

















<table><thead><tr><th>命令</th><th>作用</th></tr></thead><tbody><tr><td>version()</td><td>查看当前使用 <code>mongosh</code> 的版本</td></tr><tr><td>help</td><td>查看 <code>mongosh</code> 的帮助信息, 查看某个命令的帮助信息，<code>&lt;name&gt;.help()</code>, 例如：db.help()</td></tr></tbody></table>
<h3 data-id="heading-5">写在最后</h3>
<hr/>
<p>本章整理了 <code>mongosh</code> 中一些常用命令，方便大家在日常使用中参考。虽然 <code>mongosh</code> 功能强大，但像 <strong>聚合查询</strong>等更贴近业务场景的功能，我通常会通过 <code>mongoose</code> 来实现。接下来，我将继续编写关于 <code>node.js + mongoose</code> 的使用教程，并与大家分享更多实践经验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android http网络请求的那些事儿]]></title>    <link>https://juejin.cn/post/7572132100326441010</link>    <guid>https://juejin.cn/post/7572132100326441010</guid>    <pubDate>2025-11-13T08:59:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572132100326441010" data-draft-id="7572016447804080154" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android http网络请求的那些事儿"/> <meta itemprop="keywords" content="OKHttp,HTTP"/> <meta itemprop="datePublished" content="2025-11-13T08:59:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天花板之恋"/> <meta itemprop="url" content="https://juejin.cn/user/2027980375463565"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android http网络请求的那些事儿
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2027980375463565/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天花板之恋
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T08:59:51.000Z" title="Thu Nov 13 2025 08:59:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1.http协议</h3>
<p>http协议通常是基于<code>TCP/IT</code>协议之上的应用层协议，http默认端口是<code>80</code>，https默认端口是<code>443</code>。</p>
<p>http协议是无状态的协议，基于请求/响应的模型，先有请求，再有响应。</p>
<p>http请求报文包括：请求行、请求头、请求体</p>
<p>http响应报文包括：响应行、响应头、响应体</p>
<h3 data-id="heading-1">2.http请求报文结构</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1061d774eb6442d860799c0d7ffd8d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp6Iqx5p2_5LmL5oGL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763629190&amp;x-signature=0vzUkq1wpQuA8XbiHtxi4XcDFXc%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>
<p><strong>请求行</strong>：
主要包括请求方式以及请求目标的<code>URL</code>
例如：<em>POST /chapter17/user.html HTTP/1.1</em></p>
<p><code>POST</code>代表请求方式， <code>/chapter17/user.html</code>表示请求的URL</p>
</li>
<li>
<p><strong>请求头</strong>：
包含一些key-value值，主要包括Cookie值、请求体的数据类型、请求体的数据长度等例如：</p>
<p>Content-Type: application/x-www-form-urlencoded</p>
<p>Content-Length: 37</p>
<p>Cookie: token_pass=92595c118b66417c395eb125e12c3438</p>
</li>
<li>
<p><strong>请求体</strong>：
具体的数据，比如登陆时候的用户名和密码：
username=gandalf&amp;password=19920930yus</p>
</li>
</ul>
<h3 data-id="heading-2">3.http不同请求方式</h3>
<p>请求方式有多种，常见的有<code>GET</code>、<code>POST</code>和<code>HEAD</code></p>
<ul>
<li>
<p><strong>GET请求</strong>：
GET请求没有请求体，会把参数直接加在URL后面，不安全，并且有长度限制。
但请求简单，是HTTP请求中使用最多的方式。</p>
</li>
<li>
<p><strong>POST请求</strong>：
请求的参数在请求头内，较安全，且数据大小没有限制，适合提交较大的表单数据。</p>
</li>
<li>
<p><strong>HEAD请求</strong>：
跟GET相似，只是服务器只会返回响应头，通常只为了查询某个页面的状态。</p>
</li>
</ul>
<h3 data-id="heading-3">4.http响应报文结构</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71acc7d6843640139ef47c383ba9ac62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp6Iqx5p2_5LmL5oGL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763629190&amp;x-signature=pkD6QZdS8M1WokSvDtdmnevwSYA%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>
<p><strong>响应行</strong>：
主要包含状态码</p>
<p>1xx:指示信息，表示请求已接收，继续处理</p>
<p>2xx:成功，表示请求已被成功接受</p>
<p>3xx:重定向</p>
<p>4xx:客户端错误</p>
<p>5xx:服务器端错误</p>
</li>
<li>
<p><strong>响应头</strong>：
包含多个<code>key-value</code>对，主要包括：<code>Content-Type</code>响应正文的类型（MIME类型）、Set-Cookie 于会话状态相关的<code>Cookie</code>技术</p>
</li>
<li>
<p><strong>响应体</strong>：
数据内容，常用的如<code>json</code>纯文本内容、图片数据等</p>
</li>
</ul>
<h3 data-id="heading-4">5.https协议</h3>
<p>由于<code>http</code>是明文传输，信息容易被篡改和窃取，所以增加了<code>https</code>协议。</p>
<p>https协议是在http协议的基础上，对报文做了对称加密的处理，并且加密密钥只会在客户端和服务端保存，保证了信息的安全。</p>
<p>https协议的前提，是需要有一个公正权威的机构，叫<code>CA</code>机构，它内部维护了一套非对称加密的<code>公钥P</code>和<code>私钥P'</code>，公钥P会发布出来，浏览器会内置这个公钥。</p>
<p>一个网站如果要使用https协议，需要先在CA申请数字证书。</p>
<h3 data-id="heading-5">6.https协议加密过程</h3>
<p>前置条件完毕，接下来看具体的步骤：</p>
<ol>
<li>首先网站有一对<code>公钥P1</code>和<code>私钥P1’</code>，然后把包含网站公钥P1、域名等信息的数据Data提供给CA机构。</li>
<li>CA对Data做<code>Hash</code>算法得到一段<code>散列码H</code>；用P'对H做加密得到数字<code>签名S</code>；把S和Data数据打包一起就是数字证书，给到网站。</li>
<li>客户端和服务端建立http连接之后，服务端会把数字证书发给客户端。客户端会得到数字签名S和原始数据Data，然后使用CA的公钥P对S解密得到<code>散列码H</code>。</li>
<li>客户端会对Data做同样的hash算法得到<code>散列码H'</code>，判断H'和H是否相等，如果相等，则表示<code>公钥P1</code>是可信的。</li>
<li>客户端会针对此次对话随机生成一个对称加密密钥<code>SK</code>，并使用P1对SK信息做加密，传递给服务器。</li>
<li>服务器在收到客户端数据后，使用自己的私钥P1'做解码，获取到了本次的SK，并开始做加密通信。</li>
</ol>
<p>流程图如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79d62b7b541547e49296152044c889be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp6Iqx5p2_5LmL5oGL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763629190&amp;x-signature=ho94erorHsoj7cYkbMIwBz5M7Fc%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong>关键点补充</strong>：
CA的存在是为了保证客户端判断来自服务器公钥的可靠性。
前期非对称加密的一系列动作，是为了保证最后对称加密的密钥不能被第三方获取。
最后通信数据使用对称加密（<code>AES）</code>，是因为非对称加密很耗性能，而对称加密效率更高。</li>
</ul>
<h3 data-id="heading-6">7.Cookie</h3>
<p>由于<code>http/https</code>是没有状态的协议，整个过程是请求/应答模式，而有些数据的请求是需要有状态的，比如：
请求收藏列表数据，那么肯定是需要先登陆才行，否则就会提示：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">{<span class="hljs-string">"errorCode"</span>:-<span class="hljs-number">1001</span>,<span class="hljs-string">"errorMsg"</span>:<span class="hljs-string">"请先登录！"</span>}
</code></pre>
<p>因此引入了<code>Cookie</code>技术。</p>
<p>首先服务端会在响应头中带有<code>Set-Cookie </code>字段的数据，当客户端解析到这样的响应头数据时，就可以把这些数据保存在本地。</p>
<p>当客户端下次要发起请求的时候，就可以把这些Cookie写入到请求头中，这样服务端就可以清楚状态并返回正确的数据了。</p>
<p>比如我们登陆了WanAndroid账号之后，服务端返回的响应报文头包含：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Set-Cookie: JSESSIONID=354B46332F155D0823934D17025C01CB; Path=/; Secure; HttpOnly
Set-Cookie: loginUserName=gandalf; Expires=Fri, <span class="hljs-number">12</span>-Dec-<span class="hljs-number">2025</span> <span class="hljs-number">07</span>:<span class="hljs-number">00</span>:<span class="hljs-number">21</span> GMT; Path=/
Set-Cookie: token_pass=92595c118b66417c395eb125e12c3438; Expires=Fri, <span class="hljs-number">12</span>-Dec-<span class="hljs-number">2025</span> <span class="hljs-number">07</span>:<span class="hljs-number">00</span>:<span class="hljs-number">21</span> GMT; Path=/
Set-Cookie: loginUserName_wanandroid_com=gandalf; Domain=wanandroid.com; Expires=Fri, <span class="hljs-number">12</span>-Dec-<span class="hljs-number">2025</span> <span class="hljs-number">07</span>:<span class="hljs-number">00</span>:<span class="hljs-number">21</span> GMT; Path=/
Set-Cookie: token_pass_wanandroid_com=92595c118b66417c395eb125e12c3438; Domain=wanandroid.com; Expires=Fri, <span class="hljs-number">12</span>-Dec-<span class="hljs-number">2025</span> <span class="hljs-number">07</span>:<span class="hljs-number">00</span>:<span class="hljs-number">21</span> GMT; Path=/
</code></pre>
<p>当我们请求收藏数据的时候，就需要把以上的Cookie信息带上，这样就会获取到收藏列表数据了，否则就会提示“请先登录！”。</p>
<h3 data-id="heading-7">8.OkHttp</h3>
<p>Android使用http网络协议的利器，它负责处理<code>HTTP/1.1</code>、<code>HTTP/2</code>、<code>SPDY</code>的请求和响应，可以理解为一个装备精良的“快递员”。</p>
<p>OkHttp 负责处理所有网络通信的底层脏活累活：</p>
<ul>
<li>通过连接池 <code>ConnectionPool</code>，高效地复用 <code>TCP </code>连接；</li>
<li><code>socket</code>自动选择最好路线，并支持自动重连；</li>
<li>拥有队列线程池，轻松写并发，支持同步和异步两种请求方式；</li>
<li>拥有强大的拦截器机制（<code>interceptors</code>），可以轻松修改请求报文和响应报文，比如统一修改请求头、日志记录、加解密、Cookie缓存等。</li>
</ul>
<h3 data-id="heading-8">9.OkHttp的执行流程</h3>
<ol>
<li>首先需要构造一个<code>OkHttpClient</code>客户端，并且在客户端配置相关的拦截器和监听器，以便扩展自定义的操作。</li>
<li>构建<code>Request</code>请求类，包含<code>URL</code>、<code>Post</code>参数等信息。</li>
<li>然后通过OkHttpClient客户端去构建一个<code>Call</code>类型的对象，代表一次请求。Call有两个方法，一个方法是<code>execute（）</code>，表示同步执行请求；
另一个方法是<code>enqueue（）</code>，表示把请求加入队列，实际会进入到Dispatcher的<code>runningAsyncCalls</code>这样的一个队列，并等待异步执行。</li>
<li>不管是同步执行还是异步执行，在执行的时候，都会先构建一个拦截器链（<code>RealInterceptorChain</code>），它会add很多默认的或者我们自定义的拦截器。</li>
<li>一个拦截器执行完之后，会调用下一个拦截器，直到调用到最后一个<code>CallServiceInterceptor</code>并返回一个<code>Response</code>。</li>
</ol>
<h3 data-id="heading-9">10.OkHttp使用示例</h3>
<p>只使用OkHttp的情况下，如果我们要发起一次登陆请求，则代码如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 创建客户端</span>
<span class="hljs-keyword">val</span> client = OkHttpClient()

<span class="hljs-comment">// 2. 手动构建请求 (URL, 请求头, 请求体)</span>
<span class="hljs-keyword">val</span> requestBody = FormBody.Builder()
    .add(<span class="hljs-string">"username"</span>, <span class="hljs-string">"gandalf"</span>)
    .add(<span class="hljs-string">"password"</span>, <span class="hljs-string">"1234567"</span>)
    .build()

<span class="hljs-keyword">val</span> request = Request.Builder()
    .url(<span class="hljs-string">"https://api.example.com/login"</span>)
    .post(requestBody)
    .build()


<span class="hljs-comment">// 3. 发起异步请求，并手动处理回调</span>
client.newCall(request).enqueue(<span class="hljs-keyword">object</span> : Callback {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onFailure</span><span class="hljs-params">(call: <span class="hljs-type">Call</span>, e: <span class="hljs-type">IOException</span>)</span></span> {
        <span class="hljs-comment">// 处理网络失败</span>
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onResponse</span><span class="hljs-params">(call: <span class="hljs-type">Call</span>, response: <span class="hljs-type">Response</span>)</span></span> {
        <span class="hljs-comment">// 在子线程中</span>
        <span class="hljs-keyword">val</span> responseBodyString = response.body?.string()
        <span class="hljs-comment">// 4. 手动解析 JSON 字符串</span>
        <span class="hljs-keyword">val</span> user = Gson().fromJson(responseBodyString, User::<span class="hljs-keyword">class</span>.java)
        <span class="hljs-comment">// 5. 手动切换回主线程更新 UI</span>
    }
})
</code></pre>
<p>这里创建的OkHttpClient客户端是最简单的方式，如果想要添加其他配置项，比如<code>Cookie</code>的操作、<code>http日志</code>打印操作等，就需要在这里做配置：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> intercepter = HttpLoggingInterceptor().apply {
        level = HttpLoggingInterceptor.Level.BODY
    }

<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> okhttpClient = OkHttpClient.Builder()
        .readTimeout(<span class="hljs-number">30</span>, TimeUnit.SECONDS)   <span class="hljs-comment">// 读超时时间</span>
        .writeTimeout(<span class="hljs-number">30</span>, TimeUnit.SECONDS)  <span class="hljs-comment">// 写超时时间</span>
        .connectTimeout(<span class="hljs-number">30</span>, TimeUnit.SECONDS) <span class="hljs-comment">//连接超时时间</span>
        .addInterceptor(intercepter)  <span class="hljs-comment">// 添加日志打印的拦截器</span>
	.cookieJar(MyCookieJar()) <span class="hljs-comment">//添加Cookie操作</span>
        .build()
</code></pre>
<p>这里实现了CookieJar接口：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyCookieJar</span> : <span class="hljs-type">CookieJar</span> {
    <span class="hljs-comment">//Http发送请求前回调，Request中设置Cookie</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadForRequest</span><span class="hljs-params">(url: <span class="hljs-type">HttpUrl</span>)</span></span>: List&lt;Cookie&gt; {
        <span class="hljs-keyword">val</span> cookieList = mutableListOf&lt;Cookie&gt;()
        CookieManager.getInstance().getCookie(url.host)?.let {
            <span class="hljs-keyword">if</span> (it.isNotEmpty()) {
                <span class="hljs-keyword">val</span> cookies = it.split(<span class="hljs-string">";"</span>.toRegex())
                <span class="hljs-keyword">for</span> (cookie <span class="hljs-keyword">in</span> cookies) {
                    Cookie.parse(url, cookie)?.apply {
                        cookieList.add(<span class="hljs-keyword">this</span>)
                    }
                }
            }
        }
        <span class="hljs-keyword">return</span> cookieList
    }


    <span class="hljs-comment">//Http请求结束，Response中有Cookie时候回调，并在回调中实现Cookie的保存</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">saveFromResponse</span><span class="hljs-params">(
        url: <span class="hljs-type">HttpUrl</span>,
        cookies: <span class="hljs-type">List</span>&lt;<span class="hljs-type">Cookie</span>&gt;
    )</span></span> {
        <span class="hljs-keyword">val</span> cookieManager = CookieManager.getInstance()
        cookieManager.setAcceptCookie(<span class="hljs-literal">true</span>)
        <span class="hljs-keyword">for</span> (cookie <span class="hljs-keyword">in</span> cookies) {
            cookieManager.setCookie(url.toString(), cookie.toString())
        }
        cookieManager.flush()
    }
}
</code></pre>
<h3 data-id="heading-10">11. Retrofit</h3>
<p><code>Retrofit</code>是一种更高层级的封装，它让开发者更容易去描述“做什么”。而它自己会把这些业务层的逻辑转换成OkHttp能够识别的指令，具体“怎么做”的事情，就交给OkHttp去完成。</p>
<p>Retrofit的优势有如下几点：</p>
<ol>
<li><strong>API接口化</strong>：使用简单的Interface接口来定义一组业务关系API。</li>
<li><strong>注解驱动</strong>：通过 <code>@GET``````@POST</code>, <code>@Path</code>, <code>@Query</code>, <code>@Body </code>等注解，你可以清晰地描述每个请求的 URL、HTTP 方法、参数和请求体</li>
<li><strong>序列化/反序列化</strong>：通过可自由配置的转换器（<code>Converter</code>），如<code>retrofit2:converter-gson</code>，自动将 对象转换成请求体JSON，以及将响应体JSON自动转换成定义好的数据模型对象（Data Class）。</li>
<li><strong>适配协程</strong>：能将标准的网络调用无缝集成到协程框架中</li>
</ol>
<p>基本使用方式如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 在接口中声明 API</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApiService</span> {
    <span class="hljs-meta">@POST(<span class="hljs-string">"login"</span>)</span>
    <span class="hljs-meta">@FormUrlEncoded</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">login</span><span class="hljs-params">(<span class="hljs-meta">@Field(<span class="hljs-string">"username"</span>)</span> username: <span class="hljs-type">String</span>)</span></span>: User
}

<span class="hljs-comment">// 2. 创建 Retrofit 实例 (它内部会持有并使用一个 OkHttpClient)</span>
<span class="hljs-keyword">val</span> retrofit = Retrofit.Builder()
    .baseUrl(<span class="hljs-string">"https://api.example.com/"</span>)
    .client(myOkHttpClient) <span class="hljs-comment">// 把 OkHttp 引擎装进去</span>
    .addConverterFactory(GsonConverterFactory.create())
    .build()

<span class="hljs-keyword">val</span> apiService = retrofit.create(ApiService::<span class="hljs-keyword">class</span>.java)

<span class="hljs-comment">// 3. 在协程中像调用本地方法一样调用 API</span>
viewModelScope.launch {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">val</span> user = apiService.login(<span class="hljs-string">"test"</span>)  <span class="hljs-comment">// 直接得到 User 对象，不用关心 JSON 解析和线程切换</span>
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        <span class="hljs-comment">// 统一处理所有错误</span>
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么要使用 .asStateFlow() 而不是直接赋值？]]></title>    <link>https://juejin.cn/post/7572132100326539314</link>    <guid>https://juejin.cn/post/7572132100326539314</guid>    <pubDate>2025-11-13T09:18:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572132100326539314" data-draft-id="7572130072262524974" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么要使用 .asStateFlow() 而不是直接赋值？"/> <meta itemprop="keywords" content="Kotlin"/> <meta itemprop="datePublished" content="2025-11-13T09:18:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="默契之行"/> <meta itemprop="url" content="https://juejin.cn/user/3825956197501854"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么要使用 .asStateFlow() 而不是直接赋值？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3825956197501854/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    默契之行
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:18:34.000Z" title="Thu Nov 13 2025 09:18:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>记录开发过程中疑问，如果说的不对，欢迎提出修改</p>
<p>这里我使用了两个<code>MutableStateFlow</code>和两个<code>StateFlow</code>做说明，其中strList是由<code>_strList.asStateFlow()</code>赋值，而<code>str2List</code>由<code>_strList</code>直接赋值。这两种在代码运行都能正常运行，这也是为什么我对此有疑问，从而做下笔记梳理</p>
</blockquote>
<h3 data-id="heading-0">示例代码及运行结果</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _strList = MutableStateFlow&lt;List&lt;String&gt;&gt;(listOf(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>))
<span class="hljs-keyword">val</span> strList: StateFlow&lt;List&lt;String&gt;&gt; = _strList.asStateFlow()

<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _str2List = MutableStateFlow&lt;List&lt;String&gt;&gt;(listOf(<span class="hljs-string">"X"</span>, <span class="hljs-string">"Y"</span>, <span class="hljs-string">"Z"</span>))
<span class="hljs-keyword">val</span> str2List: StateFlow&lt;List&lt;String&gt;&gt; = _str2List

<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testAsStateFlow</span><span class="hljs-params">()</span></span> = runTest {
    launch {
        strList.collect { println(<span class="hljs-string">"strList 收到新值: <span class="hljs-variable">$it</span>"</span>) }
    }
    launch {
        delay(<span class="hljs-number">500</span>) 
        (strList <span class="hljs-keyword">as</span>? MutableStateFlow)?.value = listOf(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>, <span class="hljs-string">"D"</span>)
    }
    launch {
        str2List.collect { println(<span class="hljs-string">"str2List 收到新值: <span class="hljs-variable">$it</span>"</span>) }
    }
    launch {
        delay(<span class="hljs-number">500</span>)
        (str2List <span class="hljs-keyword">as</span>? MutableStateFlow)?.value = listOf(<span class="hljs-string">"A"</span>, <span class="hljs-string">"X"</span>, <span class="hljs-string">"Y"</span>, <span class="hljs-string">"Z"</span>)
    }
}
</code></pre>
<p>下面是运行结果，可以看出通过.<code>asStateFlow</code>() 赋值的<code>strList</code> 无法直接通过<code>asStateFlow</code>转换从而修改参数,而<code>str2List</code>却可以</p>
<p><strong>strList 收到新值: [A, B, C]</strong></p>
<p><strong>str2List 收到新值: [X, Y, Z]</strong></p>
<p><strong>str2List 收到新值: [A, X, Y, Z]</strong></p>
<h3 data-id="heading-1">1. 什么是 <code>MutableStateFlow</code> 和 <code>StateFlow</code>？</h3>
<ul>
<li><code>MutableStateFlow</code> 是一种可变的状态流，它允许我们通过 <code>value</code> 属性修改流中的状态。</li>
<li><code>StateFlow</code> 是一种不可变的状态流，它只暴露给外部读取状态的能力，而不能修改状态。</li>
</ul>
<p>通常，在封装状态时，我们将 <code>MutableStateFlow</code> 定义为私有属性（例如 <code>_strList</code>），而将其暴露为不可变的 <code>StateFlow</code>（例如 <code>strList</code>），这样外部代码只能读取状态，而无法修改它。</p>
<h3 data-id="heading-2">2. 为什么不建议直接赋值？</h3>
<p>在上述代码中，如果直接将 <code>_strList</code> 或 <code>_str2List</code> 作为 <code>StateFlow</code> 来暴露，会导致外部代码可以通过强制转换或直接访问 <code>_strList</code> 或 <code>_str2List</code> 来修改其值。这样可能会破坏状态的不可变性，导致不可预测的副作用或状态变更。</p>
<p>例如，在以下代码中，尝试直接修改 <code>strList</code> 的值：</p>
<pre><code class="hljs language-ini" lang="ini">(strList as? MutableStateFlow)?.<span class="hljs-attr">value</span> = listOf(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>, <span class="hljs-string">"D"</span>)
</code></pre>
<p>虽然 <code>strList</code> 是 <code>StateFlow</code> 类型，它不能直接修改，但通过强制转换为 <code>MutableStateFlow</code> 类型，代码可以绕过不可变性并直接修改 <code>value</code> 属性。这违背了状态不可变性的设计原则，容易导致不可控的状态更改。</p>
<h3 data-id="heading-3">3. <code>asStateFlow</code> 的作用</h3>
<p>使用 <code>asStateFlow()</code> 方法可以将 <code>MutableStateFlow</code> 转换为不可变的 <code>StateFlow</code>。这样，外部代码只能读取状态，而无法修改它。通过这种方式，我们可以确保状态的不可变性并防止外部代码直接更改状态。</p>
<pre><code class="hljs language-swift" lang="swift">val strList: <span class="hljs-type">StateFlow</span>&lt;<span class="hljs-type">List</span>&lt;<span class="hljs-type">String</span>&gt;&gt; <span class="hljs-operator">=</span> _strList.asStateFlow()
</code></pre>
<p>这样，外部代码只能使用 <code>strList.collect { ... }</code> 来收集状态的变化，而不能修改 <code>strList</code> 的值。这使得状态管理更加安全和可控。</p>
<h3 data-id="heading-4">4. 总结</h3>
<ul>
<li><code>MutableStateFlow</code> 提供了修改状态的能力，而 <code>StateFlow</code> 只允许读取状态。</li>
<li>使用 <code>asStateFlow()</code> 可以将 <code>MutableStateFlow</code> 转换为不可变的 <code>StateFlow</code>，从而保护状态不被外部代码直接修改。</li>
<li>通过这种方式，我们可以确保状态的不可变性，减少副作用，使代码更加健壮和可维护。</li>
</ul>
<h3 data-id="heading-5">5.延伸问题：为什么要使用 <code>asSharedFlow</code>？</h3>
<p>类似于 <code>StateFlow</code>，<code>SharedFlow</code> 也有可变和不可变的版本。<code>MutableSharedFlow</code> 允许外部代码通过 <code>emit()</code> 向流中发送事件，而 <code>SharedFlow</code> 则是一个只读流，只能被外部代码订阅和收集，不能直接修改流中的内容。</p>
<p>为了确保流的不可变性，应该使用 <code>asSharedFlow()</code> 方法将 <code>MutableSharedFlow</code> 转换为不可变的 <code>SharedFlow</code>。这样，外部代码只能订阅事件流，而不能通过 <code>emit()</code> 向流中发送事件，避免了意外修改流内容的副作用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用awesome-digital-human-live2d创建属于自己的数字人]]></title>    <link>https://juejin.cn/post/7572016447804325914</link>    <guid>https://juejin.cn/post/7572016447804325914</guid>    <pubDate>2025-11-13T09:16:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572016447804325914" data-draft-id="7571892340878458918" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用awesome-digital-human-live2d创建属于自己的数字人"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-13T09:16:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="suzumiyahr"/> <meta itemprop="url" content="https://juejin.cn/user/248966809390851"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用awesome-digital-human-live2d创建属于自己的数字人
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/248966809390851/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    suzumiyahr
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:16:11.000Z" title="Thu Nov 13 2025 09:16:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.AWESOME-DIGITAL-HUMAN是什么</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FGitHub_Trending%2Faw%2Fawesome-digital-human-live2d%2Fblob%2Fmain%2FREADME.md" target="_blank" title="https://gitcode.com/GitHub_Trending/aw/awesome-digital-human-live2d/blob/main/README.md" ref="nofollow noopener noreferrer">AWESOME-DIGITAL-HUMAN</a>是一款国产开源的数字人框架</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e332a04e0bbf4bdc95ab3334522e1ada~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3V6dW1peWFocg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630592&amp;x-signature=UkUYHJnR%2BGxUm%2FeAlDgMVtcftgE%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">2.准备工作</h2>
<p>下载源码 git clone <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwan-h%2Fawesome-digital-human-live2d.git" target="_blank" title="https://github.com/wan-h/awesome-digital-human-live2d.git" ref="nofollow noopener noreferrer">github.com/wan-h/aweso…</a>
项目目录如下：</p>
<pre><code class="hljs language-." lang=".">├── config.yaml                  # 全局配置文件
├── agents                       # agent 配置文件目录
└── engines                      # 引擎配置文件目录
    ├── asr                      # 语音识别引擎配置文件目录
    ├── llm                      # 大模型引擎配置文件目录
    └── tts                      # 文字转语音引擎配置目录
</code></pre>
<p>容器部署：docker-compose up --build -d
创建一个千问智能体，以备后用
开通腾讯tts服务，以备后用</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a88dd46cfdf5468298433442db1d779a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3V6dW1peWFocg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630592&amp;x-signature=sXrmdQcHIu2THVOE%2BJKZ%2FVgIr1I%3D" alt="image.png" loading="lazy"/></p>
<p>打开8880端口，发现项目已经成功启动了，可以修改很多配置，比如人物的模型，背景，声音，可以使用的agent等等</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2375991d638c4ec093a2d36b87aa6af7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3V6dW1peWFocg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630592&amp;x-signature=mmJHGwRIn1pKth4sDWaSl5MyZT0%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">2.项目修改</h2>
<p>修改configs\engines\tts\tencentAPI.yaml文件的相关配置，选择我们喜欢的语音</p>
<pre><code class="hljs language-NAME:" lang="NAME:">VERSION: "v0.0.1"
DESC: "接入腾讯服务"
META: {
  official: "",
  configuration: "https://console.cloud.tencent.com/tts",
  tips: "",
  fee: ""
}
PARAMETERS: [
  {
    name: "secret_id",
    description: "tencent secret_id.",
    type: "string",
    required: false,
    choices: [],
    default: "腾讯tts的  secret_id"
  },
  {
    name: "secret_key",
    description: "tencent secret_key.",
    type: "string",
    required: false,
    choices: [],
    default: "腾讯tts的 secret_key"
  },
  {
    name: "voice",
    description: "Voice for TTS.",
    type: "string",
    required: false,
    choices: [],
    default: "爱小璟"
  },
  {
    name: "volume",
    description: "Set volume, default +0%.",
    type: "float",
    required: false,
    range: [-10, 10],
    default: 0.0
  },
  {
    name: "speed",
    description: "Set speed, default +0%.",
    type: "float",
    required: false,
    range: [-2, 6],
    default: 0.0
  }
]
</code></pre>
<p>打开config_template.yaml文件，可以发现目前是不支持通义千问的，首先增加对千问的支持</p>
<pre><code class="hljs language-COMMON:" lang="COMMON:">  NAME: "Awesome-Digital-Human"
  VERSION: "v3.0.0"
  LOG_LEVEL: "DEBUG"
SERVER:
  IP: "0.0.0.0"
  PORT: 8880
  WORKSPACE_PATH: "./outputs"
  ENGINES:
    ASR: 
      SUPPORT_LIST: [ "difyAPI.yaml", "cozeAPI.yaml", "tencentAPI.yaml", "funasrStreamingAPI.yaml"]
      DEFAULT: "difyAPI.yaml"
    TTS: 
      SUPPORT_LIST: [ "edgeAPI.yaml", "tencentAPI.yaml", "difyAPI.yaml", "cozeAPI.yaml" ]
      DEFAULT: "tencentAPI.yaml"
    LLM:
      SUPPORT_LIST: []
      DEFAULT: ""
  AGENTS:
    SUPPORT_LIST: [ "repeaterAgent.yaml", "openaiAPI.yaml", "difyAgent.yaml", "fastgptAgent.yaml", "cozeAgent.yaml"]
    DEFAULT: "repeaterAgent.yaml"
</code></pre>
<p>在SUPPORT_LIST里增加qwenAgent.yaml 并设置为默认。
在configs agent目录里增加一个qwenAgent.yaml文件</p>
<pre><code class="hljs language-NAME:" lang="NAME:">VERSION: "v0.0.1"
DESC: "接入通义千问智能体（DashScope Application）"
META: {
  official: "https://bailian.console.aliyun.com/",
  configuration: "需在百炼平台创建应用并获取 App ID",
  tips: "支持多轮对话、流式输出、自动会话管理。提示词和知识库已在智能体后台配置。",
  fee: "按 DashScope 定价计费"
}
# 暴露给前端的参数选项以及默认值
PARAMETERS: [
  {
    name: "api_key",
    description: "DashScope API Key（通义千问密钥）",
    type: "string",
    required: true,
    choices: [],
    default: "你的sk"
  },
  {
    name: "app_id",
    description: "通义千问智能体 App ID（在百炼平台创建）",
    type: "string",
    required: true,
    choices: [],
    default: "你的appId"
  }
]
</code></pre>
<p>在digitalHuman\agent\core下创建qwenAgent.py文件，千问支持保存短期对话和长期对话，短期对话使用session_id或者拼接message列表均可，根据文档，在这两个字段同时存在里阿里会采用message列表的模式，此时session_id字段会失效 我们使用session_id的形式，在用户首次对话时创建session_id并传递给前端，当进行后续对话时再由前端返回，长期记忆根据用户创建memory_id存表，然后在对话中携带参数即可</p>
<pre><code class="hljs language-#" lang="#">
from ..builder import AGENTS
from ..agentBase import BaseAgent
import os
import json
from urllib.parse import urlencode
from digitalHuman.protocol import *
from digitalHuman.utils import httpxAsyncClient, logger

__all__ = ["QwenAgent"]


@AGENTS.register("Qwen")
class QwenAgent(BaseAgent):
    async def run(
        self,
        input: TextMessage,
        streaming: bool,
        **kwargs
    ):
        try:
            if not streaming:
                raise KeyError("Tongyi Agent only supports streaming mode")

            # 获取 API 参数
            api_key = kwargs.get("api_key") or os.getenv("DASHSCOPE_API_KEY")
            app_id = kwargs.get("app_id") or os.getenv("DASHSCOPE_APP_ID")
            session_id = (kwargs.get("conversation_id") or kwargs.get("session_id") or "").strip()
            memory_id  = kwargs.get("mid") or ""
            messages = kwargs.get("messages", [])

            if not api_key:
                raise ValueError(
                    "Missing 'api_key': please provide it in parameters "
                    "or set DASHSCOPE_API_KEY environment variable."
                )
            if not app_id:
                raise ValueError(
                    "Missing 'app_id': please provide it in parameters "
                    "or set DASHSCOPE_APP_ID environment variable."
                )

            prompt = input.data.strip()

            #模式判断：messages 优先级高于 session_id
            use_custom_messages = bool(messages)

            headers = {
                "Authorization": f"Bearer {api_key}",
                "Content-Type": "application/json",
                "X-DashScope-SSE": "enable"
            }

            payload = {
                "input": {},
                "parameters": {
                    "incremental_output": True
                },
                "stream": True
            }

            url = f"https://dashscope.aliyuncs.com/api/v1/apps/{app_id}/completion"
            if memory_id :
                payload["input"]["memory_id"] = memory_id 
            if use_custom_messages:
                #自定义上下文模式
                logger.info("[QwenAgent] Using custom 'messages' mode. session_id will be ignored.")
                for msg in messages:
                    if not isinstance(msg, dict) or "role" not in msg or "content" not in msg:
                        raise ValueError("Each message must be a dict with 'role' and 'content'")
                final_messages = messages.copy()
                if prompt:
                    final_messages.append({"role": "user", "content": prompt})
                payload["input"]["messages"] = final_messages
            else:
                #标准多轮对话模式
                if not prompt:
                    raise ValueError("Prompt is required when not using 'messages'.")
                logger.info(f"[QwenAgent] Using standard mode with session_id: '{session_id or '(new)'}'")
                payload["input"]["prompt"] = prompt
                if session_id:
                    url += "?" + urlencode({"session_id": session_id})
                    payload["input"]["session_id"] = session_id

            logger.info(f"[QwenAgent] Request URL: {url}")
            logger.info(f"[QwenAgent] Payload: {payload}")

            # 发起请求
            async with httpxAsyncClient.stream("POST", url, headers=headers, json=payload) as response:
                logger.info(f"[QwenAgent] Response status: {response.status_code}")
                if response.status_code != 200:
                    error_text = await response.aread()
                    try:
                        err_json = json.loads(error_text)
                        msg = err_json.get("message", error_text.decode())
                    except Exception:
                        msg = error_text.decode()
                    error_msg = f"HTTP {response.status_code}: {msg}"
                    logger.error(f"[QwenAgent] Request failed: {error_msg}")
                    yield eventStreamError(error_msg)
                    return

                got_conversation_id = False
                async for chunk in response.aiter_lines():
                    line = chunk.strip()
                    if not line or line == ":":
                        continue

                    if line.startswith("data:"):
                        data_str = line[5:].strip()
                        if data_str == "[DONE]":
                            break

                        try:
                            data = json.loads(data_str)
                        except json.JSONDecodeError as e:
                            logger.warning(f"[QwenAgent] JSON decode error: {e}, raw: {data_str}")
                            continue

                        logger.debug(f"[QwenAgent] SSE data received: {data}")

                        # 提取 conversation_id（仅在标准模式下）
                        if not got_conversation_id and not use_custom_messages:
                            cid = data.get("output", {}).get("session_id")
                            if cid:
                                if not session_id or cid != session_id:
                                    logger.info(f"[QwenAgent] New conversation_id received: {cid}")
                                    yield eventStreamConversationId(cid)
                                got_conversation_id = True

                        # 提取文本
                        text = data.get("output", {}).get("text", "")
                        if text:
                            yield eventStreamText(text)

            yield eventStreamDone()

        except Exception as e:
            logger.error(f"[QwenAgent] Exception: {e}", exc_info=True)
            yield eventStreamError(str(e))
</code></pre>
<p>阿里创建长期记忆体sdk:</p>
<pre><code class="hljs language-@staticmethod" lang="@staticmethod">    def create_client() -&gt; bailian20231229Client:
        """
        使用凭据初始化账号Client
        @return: Client
        @throws Exception
        """
        # 工程代码建议使用更安全的无AK方式，凭据配置方式请参见：https://help.aliyun.com/document_detail/378659.html。
        credential = CredentialClient()
        config = open_api_models.Config(
            credential=credential
        )
        # Endpoint 请参考 https://api.aliyun.com/product/bailian
        config.endpoint = f'bailian.cn-beijing.aliyuncs.com'
        return bailian20231229Client(config)

    @staticmethod
    async def main_async(
        args: List[str],
    ) -&gt; None:
        client = Sample.create_client()
        create_memory_node_request = bailian_20231229_models.CreateMemoryNodeRequest()
        runtime = util_models.RuntimeOptions()
        headers = {}
        try:
            # 复制代码运行请自行打印 API 的返回值
            await client.create_memory_node_with_options_async('', '', create_memory_node_request, headers, runtime)
        except Exception as error:
            # 此处仅做打印展示，请谨慎对待异常处理，在工程项目中切勿直接忽略异常。
</code></pre>
<p>需要注意incremental_output需要修改为True,否则流式输出的情况下数据会有重复。
在流式输出的情况下，如果每次返回都请求tts，会导致断句不自然甚至一字一顿的情况，比如 我 喜欢 吃这样，调整前端相关的逻辑代码，着重修改web\app(products)\sentio\hooks\chat.ts文件，主要修改逻辑就是把每次流式输出推送tts改为拼接完成后，根据标点断句分批推送tts，同时控制文字和语音的分段同时显示，使嘴型，声音和文字更加自然同步。</p>
<pre><code class="hljs language-import" lang="import">import { 
    useChatRecordStore, 
    useSentioAgentStore, 
    useSentioTtsStore,
    useSentioBasicStore,
} from "@/lib/store/sentio";
import { useTranslations } from 'next-intl';
import { CHAT_ROLE, EventResponse, STREAMING_EVENT_TYPE } from "@/lib/protocol";
import { Live2dManager } from '@/lib/live2d/live2dManager';
import { base64ToArrayBuffer, ttsTextPreprocess } from '@/lib/func';
import { convertMp3ArrayBufferToWavArrayBuffer } from "@/lib/utils/audio";
import {
    api_tts_infer,
    api_agent_stream,
} from '@/lib/api/server';
import { addToast } from "@heroui/react";
import { SENTIO_RECODER_MIN_TIME, SENTIO_RECODER_MAX_TIME } from "@/lib/constants";

export function useAudioTimer() {
    const t = useTranslations('Products.sentio');
    const startTime = useRef(new Date());
    const toast = (message: string) =&gt; {
        addToast({
            title: message,
            color: "warning",
        });
    };
    const startAudioTimer = () =&gt; {
        startTime.current = new Date();
    };
    const stopAudioTimer = (): boolean =&gt; {
        const duration = new Date().getTime() - startTime.current.getTime();
        if (duration &lt; SENTIO_RECODER_MIN_TIME) {
            toast(`${t('recordingTime')} &lt; ${SENTIO_RECODER_MIN_TIME}`);
        } else if (duration &gt; SENTIO_RECODER_MAX_TIME) {
            toast(`${t('recordingTime')} &gt; ${SENTIO_RECODER_MAX_TIME}`);
        } else {
            return true;
        }
        return false;
    };
    return { startAudioTimer, stopAudioTimer };
}

//获取 mid
function getMidFromUrl(): string | null {
    if (typeof window === 'undefined') return null;
    const params = new URLSearchParams(window.location.search);
    return params.get('mid');
}

export function useChatWithAgent() {
    const [chatting, setChatting] = useState(false);
    const { engine: agentEngine, settings: agentSettings } = useSentioAgentStore();
    const { engine: ttsEngine, settings: ttsSettings } = useSentioTtsStore();
    const { sound } = useSentioBasicStore();

    const { addChatRecord, updateLastRecord } = useChatRecordStore();
    const controller = useRef&lt;AbortController | null&gt;(null);
    const conversationId = useRef&lt;string&gt;("");
    const messageId = useRef&lt;string&gt;("");

    // 原始流式文本缓存（用于断句）
    const fullRawText = useRef&lt;string&gt;("");
    const pendingText = useRef&lt;string&gt;("");
    const lastTextUpdateTime = useRef&lt;number&gt;(0);

    // 已显示的文本（仅包含已 TTS 的内容）
    const displayedContent = useRef&lt;string&gt;("");
    const agentThinkRef = useRef&lt;string&gt;("");

    //TTS 串行队列，保证顺序
    const ttsQueue = useRef&lt;Array&lt;{ text: string }&gt;&gt;([]);
    const isProcessingTts = useRef&lt;boolean&gt;(false);

    //从 URL 获取 mid（只在初始化时读一次）
    const mid = useRef&lt;string | null&gt;(getMidFromUrl());

    const abort = () =&gt; {
        setChatting(false);
        Live2dManager.getInstance().stopAudio();
        if (controller.current) {
            controller.current.abort("abort");
            controller.current = null;
        }
        fullRawText.current = "";
        pendingText.current = "";
        displayedContent.current = "";
        lastTextUpdateTime.current = 0;
        agentThinkRef.current = "";
        ttsQueue.current = []; // 清空队列
        isProcessingTts.current = false;
    };

    const updateDisplayedContent = (newSentence: string) =&gt; {
        displayedContent.current += newSentence;
        updateLastRecord({
            role: CHAT_ROLE.AI,
            think: agentThinkRef.current,
            content: displayedContent.current
        });
    };

    //串行处理 TTS 队列
    const processNextTtsInQueue = () =&gt; {
        if (isProcessingTts.current || ttsQueue.current.length === 0 || !controller.current) {
            return;
        }

        isProcessingTts.current = true;
        const { text } = ttsQueue.current.shift()!;

        const processedText = ttsTextPreprocess(text);
        if (!processedText) {
            updateDisplayedContent(text);
            isProcessingTts.current = false;
            processNextTtsInQueue();
            return;
        }

        api_tts_infer(
            ttsEngine,
            ttsSettings,
            processedText,
            controller.current.signal
        ).then((ttsResult) =&gt; {
            if (ttsResult &amp;&amp; controller.current) {
                const audioData = base64ToArrayBuffer(ttsResult);
                convertMp3ArrayBufferToWavArrayBuffer(audioData)
                    .then((buffer) =&gt; {
                        if (controller.current) {
                            updateDisplayedContent(text);
                            Live2dManager.getInstance().pushAudioQueue(buffer);
                        }
                    })
                    .catch((err) =&gt; {
                        console.warn("Audio conversion failed:", err);
                        updateDisplayedContent(text);
                    })
                    .finally(() =&gt; {
                        isProcessingTts.current = false;
                        processNextTtsInQueue();
                    });
            } else {
                updateDisplayedContent(text);
                isProcessingTts.current = false;
                processNextTtsInQueue();
            }
        }).catch((err) =&gt; {
            console.warn("TTS failed for text:", text, err);
            updateDisplayedContent(text);
            isProcessingTts.current = false;
            processNextTtsInQueue();
        });
    };

    //入队函数（替代原来的 processTextForTTS）
    const enqueueTts = (text: string) =&gt; {
        if (!controller.current) return;

        const processedText = ttsTextPreprocess(text);
        if (!processedText) {
            // 无效文本立即显示
            updateDisplayedContent(text);
            return;
        }

        if (!sound) {
            // 无声模式直接显示
            updateDisplayedContent(text);
            return;
        }

        // 有声模式：入队等待串行处理
        ttsQueue.current.push({ text });
        processNextTtsInQueue();
    };

    //按标点断句并及时入队
    const tryProcessPendingText = () =&gt; {
        if (!pendingText.current.trim()) return;

        const now = Date.now();
        const timeSinceLastUpdate = now - lastTextUpdateTime.current;
        const charCount = pendingText.current.length;

        // 定义句子结束符（注意：必须包含中文和英文标点）
        const sentenceEndingsRegex = /[。！？!?.;；\n,，、…～]/g;
        const endings = pendingText.current.match(sentenceEndingsRegex) || [];
        const parts = pendingText.current.split(sentenceEndingsRegex);

        const completeSentences: string[] = [];
        let remaining = "";

        // 重组：除最后一个 part 外，其余都可组成完整句子
        for (let i = 0; i &lt; parts.length - 1; i++) {
            let sentence = parts[i];
            if (i &lt; endings.length) {
                sentence += endings[i]; // 把标点加回去
            }
            if (sentence.trim()) {
                completeSentences.push(sentence);
            }
        }

        // 最后一个 part 是未完成的片段（除非原文本以标点结尾）
        const lastPart = parts[parts.length - 1] || "";
        const endsWithPunctuation = sentenceEndingsRegex.test(pendingText.current.slice(-1));
        
        if (endsWithPunctuation) {
            // 如果原文本以标点结尾，则最后一部分也完整
            if (lastPart.trim()) {
                completeSentences.push(lastPart + (endings[endings.length - 1] || ''));
            }
            remaining = "";
        } else {
            // 否则保留为 pending
            remaining = lastPart;
        }

        // 是否强制 flush 剩余内容？
        const shouldFlushRemaining =
            charCount &gt;= 60 ||
            timeSinceLastUpdate &gt; 1500;

        if (shouldFlushRemaining &amp;&amp; remaining.trim()) {
            completeSentences.push(remaining);
            remaining = "";
        }

        // 处理所有完整句子
        completeSentences.forEach(sentence =&gt; {
            if (sentence.trim()) {
                enqueueTts(sentence);
            }
        });

        // 更新 pendingText
        pendingText.current = remaining;
    };

    const chatWithAgent = (
        message: string, 
        postProcess?: (conversation_id: string, message_id: string, think: string, content: string) =&gt; void
    ) =&gt; {
        addChatRecord({ role: CHAT_ROLE.HUMAN, think: "", content: message });
        addChatRecord({ role: CHAT_ROLE.AI, think: "", content: "" });

        controller.current = new AbortController();
        setChatting(true);
        fullRawText.current = "";
        pendingText.current = "";
        displayedContent.current = "";
        lastTextUpdateTime.current = 0;
        agentThinkRef.current = "";
        ttsQueue.current = [];
        isProcessingTts.current = false;

        const agentCallback = (response: EventResponse) =&gt; {
            const { event, data } = response;
            switch (event) {
                case STREAMING_EVENT_TYPE.CONVERSATION_ID:
                    conversationId.current = data;
                    break;
                case STREAMING_EVENT_TYPE.MESSAGE_ID:
                    messageId.current = data;
                    break;
                case STREAMING_EVENT_TYPE.THINK:
                    agentThinkRef.current += data;
                    updateLastRecord({
                        role: CHAT_ROLE.AI,
                        think: agentThinkRef.current,
                        content: displayedContent.current
                    });
                    break;
                case STREAMING_EVENT_TYPE.TEXT:
                    fullRawText.current += data;
                    pendingText.current += data;
                    lastTextUpdateTime.current = Date.now();

                    if (sound) {
                        tryProcessPendingText();
                    } else {
                        displayedContent.current += data;
                        updateLastRecord({
                            role: CHAT_ROLE.AI,
                            think: agentThinkRef.current,
                            content: displayedContent.current
                        });
                    }
                    break;
                case STREAMING_EVENT_TYPE.ERROR:
                    addToast({ title: data, color: "danger" });
                    break;
                case STREAMING_EVENT_TYPE.TASK:
                case STREAMING_EVENT_TYPE.DONE:
                    if (postProcess) {
                        postProcess(conversationId.current, messageId.current, agentThinkRef.current, fullRawText.current);
                    }

                    // 流结束，处理剩余文本
                    if (sound &amp;&amp; pendingText.current.trim()) {
                        enqueueTts(pendingText.current);
                        pendingText.current = "";
                    }

                    setChatting(false);
                    break;
                default:
                    break;
            }
        };

        const agentErrorCallback = (error: Error) =&gt; {
            setChatting(false);
        };

        //调用 api_agent_stream 时传入 mid
        api_agent_stream(
            agentEngine,
            agentSettings,
            message,
            conversationId.current,
            controller.current.signal,
            agentCallback,
            agentErrorCallback,
            mid.current
        );
    };

    const chat = (
        message: string,
        postProcess?: (conversation_id: string, message_id: string, think: string, content: string) =&gt; void
    ) =&gt; {
        abort();
        chatWithAgent(message, postProcess);
    };

    useEffect(() =&gt; {
        conversationId.current = "";
        return () =&gt; {
            abort();
        };
    }, [agentEngine, agentSettings]);

    return { chat, abort, chatting, conversationId, mid: mid.current };
}
</code></pre>
<p>到这里感觉完事大吉了，但是查看长期记忆列表居然没有数据，这是什么情况？经过多次实现发现自动写入记忆片段只有推理模式才能成功，但是开启推理模式等待时间过长，不适合数字人这种需要及时交互的场景，那么有没有解决的方法呢？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9ae70ec85eb4569af5dc3f43bf9b5d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3V6dW1peWFocg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630592&amp;x-signature=u1Ggiind3VEByUVaIFUw6TlTiMs%3D" alt="image.png" loading="lazy"/>
我们可以使用阿里提供的另一个接口，主动创建记忆片段。
修改qwenAgent.py文件，具体逻辑就是在千问返回信息后，异步通过接口判断当前返回的内容是否需要抽取保存到记忆中，如果需要的话通过相关sdk进行保存</p>
<pre><code class="hljs language-#" lang="#">
from ..builder import AGENTS
from ..agentBase import BaseAgent
import os
import json
import asyncio
import re
from urllib.parse import urlencode
from digitalHuman.protocol import *
from digitalHuman.utils import httpxAsyncClient, logger

# DashScope SDK 导入
try:
    from alibabacloud_bailian20231229.client import Client as bailian20231229Client
    from alibabacloud_credentials.client import Client as CredentialClient
    from alibabacloud_tea_openapi import models as open_api_models
    from alibabacloud_bailian20231229 import models as bailian_20231229_models
    from alibabacloud_tea_util import models as util_models
    from alibabacloud_credentials.models import Config as CredentialConfig
    SDK_AVAILABLE = True
except ImportError:
    logger.warning("DashScope SDK not available, memory writing disabled")
    SDK_AVAILABLE = False

__all__ = ["QwenAgent"]


@AGENTS.register("Qwen")
class QwenAgent(BaseAgent):
    
    def __init__(self, config=None, engine_type=None):
        """初始化 QwenAgent，兼容父类构造函数"""
        super().__init__(config, engine_type)
        self._sdk_client = None
        if SDK_AVAILABLE:
            self._init_sdk_client()
    
    def _init_sdk_client(self):
        """初始化 DashScope SDK 客户端 - 从环境变量读取 AK/SK"""
        try:
            access_key_id = os.getenv("DASHSCOPE_ACCESS_KEY_ID")
            access_key_secret = os.getenv("DASHSCOPE_ACCESS_KEY_SECRET")
            
            if not access_key_id or not access_key_secret:
                logger.error("DASHSCOPE_ACCESS_KEY_ID or DASHSCOPE_ACCESS_KEY_SECRET not set in environment variables")
                return
            
            credential_config = CredentialConfig(
                type='access_key',
                access_key_id=access_key_id,
                access_key_secret=access_key_secret
            )
            credential = CredentialClient(credential_config)
            
            config = open_api_models.Config(credential=credential)
            config.endpoint = 'bailian.cn-beijing.aliyuncs.com'
            self._sdk_client = bailian20231229Client(config)
            logger.info("DashScope SDK client initialized successfully")
        except Exception as e:
            logger.error(f"Failed to initialize SDK client: {e}")
            self._sdk_client = None
    
    #判断是否需要抽取记忆
    def _should_extract_memory(self, text: str) -&gt; bool:
        """轻量判断：是否可能包含可记忆信息"""
        if not text.strip():
            return False
        triggers = [
            "叫", "名字", "姓名",  # 基本信息
            "喜欢", "爱吃", "爱喝", "讨厌", "不吃", "过敏",  # 饮食
            "兴趣", "爱好", "擅长", "迷上", "喜欢玩",  # 兴趣
            "性格", "活泼", "内向", "安静", "调皮",  # 性格
            "年级", "学校", "班级",  # 基本信息
            "进步", "退步", "成绩", "考得", "学习", "作业"  # 学习（趋势）
        ]
        return any(trigger in text for trigger in triggers)
    
    # qwen-max 抽取结构化记忆
    async def _extract_memory_with_qwen_max(self, text: str, api_key: str, child_name: str = "") -&gt; dict:
        prompt = f"""
# 角色
你是一个严格的信息抽取系统，不是对话助手。你的唯一任务是从家长原话中提取结构化信息。

# 规则
1. 禁止任何解释、问候、反问、建议
2. 禁止输出 JSON 以外的任何字符（包括换行、空格、Markdown）
3. 如果没有可提取信息，必须输出：{{}}
4. 字段值必须是简洁的中文短语，不要完整句子

# 字段定义
- basic_info: "姓名，性别，年级"（如"李明，男，三年级"）
- diet_preference: "饮食偏好"（如"喜欢吃西瓜"）
- interests: "兴趣爱好"（如"喜欢画画"）
- personality: "性格特点"（如"性格活泼"）
- academic_trend: "学习趋势"（如"数学有进步"）

# 家长原话
{text}

# 你的输出（纯 JSON，无任何其他内容）：
"""
        
        try:
            resp = await httpxAsyncClient.post(
                "https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation",
                headers={"Authorization": f"Bearer {api_key}"},
                json={
                    "model": "qwen-max",
                    "input": {"prompt": prompt.strip()},
                    "parameters": {
                        "max_tokens": 200,
                        "temperature": 0.01,
                        "stop": ["\n", "。", "！", "？", "："]
                    }
                },
                timeout=10.0
            )
            if resp.status_code == 200:
                data = resp.json()
                raw_text = data.get("output", {}).get("text", "").strip()
                logger.debug(f"[MemoryExtract] Raw output: '{raw_text}'")
                
                # 尝试解析 JSON
                try:
                    return json.loads(raw_text)
                except:
                    # 尝试提取 {...}
                    match = re.search(r'\{[^{}]*\}', raw_text)
                    if match:
                        try:
                            return json.loads(match.group())
                        except:
                            pass
                if raw_text == "{}":
                    return {}
                    
                logger.warning(f"[MemoryExtract] Failed to parse: {raw_text[:100]}")
                
        except Exception as e:
            logger.error(f"[MemoryExtract] Error: {e}", exc_info=True)
        
        return {}

    #使用 SDK 写入 DashScope Memory
    async def _write_memory_node_with_sdk(self, app_id: str, memory_id: str, content: str):
        if not SDK_AVAILABLE or self._sdk_client is None:
            logger.warning("[MemoryWrite] SDK not available, skipping write")
            return
            
        if not app_id or not memory_id or not content.strip():
            logger.warning("[MemoryWrite] Skip empty app_id, memory_id or content")
            return
        
        try:
            logger.info(f"[MemoryWrite] Attempting to write via SDK - app_id: '{app_id}', memory_id: '{memory_id}', content: '{content}'")
            
            create_memory_node_request = bailian_20231229_models.CreateMemoryNodeRequest(
                content=content
            )
            runtime = util_models.RuntimeOptions()
            headers = {}
            space_id = os.getenv("DASHSCOPE_SPACE_ID")
            response = await self._sdk_client.create_memory_node_with_options_async(
                space_id, 
                memory_id, 
                create_memory_node_request, 
                headers, 
                runtime
            )
            
            logger.info(f"[MemoryWrite] SDK SUCCESS - MemoryNode ID: {response.body.memory_node_id}")
            
        except Exception as e:
            logger.error(f"[MemoryWrite] SDK EXCEPTION: {e}")

    #后台记忆更新任务
    async def _background_memory_update(self, user_input: str, app_id: str, memory_id: str, api_key: str):
        await asyncio.sleep(0.5)
        
        child_name = ""
        extracted = await self._extract_memory_with_qwen_max(user_input, api_key, child_name)
        logger.info(f"[Memory] Extracted result: {extracted}")
        
        for key, value in extracted.items():
            if value:
                pure_content = value
                logger.info(f"[Memory] Writing pure content: {pure_content}")
                await self._write_memory_node_with_sdk(app_id, memory_id, pure_content)

    async def run(
        self,
        input: TextMessage,
        streaming: bool,
        **kwargs
    ):
        try:
            if not streaming:
                raise KeyError("Tongyi Agent only supports streaming mode")

            # 获取 API 参数（从环境变量或参数）
            api_key = kwargs.get("api_key") or os.getenv("DASHSCOPE_API_KEY")
            app_id = kwargs.get("app_id") or os.getenv("DASHSCOPE_APP_ID")
            session_id = (kwargs.get("conversation_id") or kwargs.get("session_id") or "").strip()
            memory_id = kwargs.get("mid") or ""
            messages = kwargs.get("messages", [])

            if not api_key:
                raise ValueError(
                    "Missing 'api_key': please provide it in parameters "
                    "or set DASHSCOPE_API_KEY environment variable."
                )
            if not app_id:
                raise ValueError(
                    "Missing 'app_id': please provide it in parameters "
                    "or set DASHSCOPE_APP_ID environment variable."
                )

            prompt = input.data.strip()

            #模式判断：messages 优先级高于 session_id
            use_custom_messages = bool(messages)

            headers = {
                "Authorization": f"Bearer {api_key}",
                "Content-Type": "application/json",
                "X-DashScope-SSE": "enable"
            }

            payload = {
                "input": {},
                "parameters": {
                    "incremental_output": True
                },
                "stream": True
            }

            url = f"https://dashscope.aliyuncs.com/api/v1/apps/{app_id}/completion"
            if memory_id:
                payload["input"]["memory_id"] = memory_id 
            if use_custom_messages:
                logger.info("[QwenAgent] Using custom 'messages' mode. session_id will be ignored.")
                for msg in messages:
                    if not isinstance(msg, dict) or "role" not in msg or "content" not in msg:
                        raise ValueError("Each message must be a dict with 'role' and 'content'")
                final_messages = messages.copy()
                if prompt:
                    final_messages.append({"role": "user", "content": prompt})
                payload["input"]["messages"] = final_messages
            else:
                if not prompt:
                    raise ValueError("Prompt is required when not using 'messages'.")
                logger.info(f"[QwenAgent] Using standard mode with session_id: '{session_id or '(new)'}'")
                payload["input"]["prompt"] = prompt
                if session_id:
                    url += "?" + urlencode({"session_id": session_id})
                    payload["input"]["session_id"] = session_id

            logger.info(f"[QwenAgent] Request URL: {url}")
            logger.info(f"[QwenAgent] Payload: {payload}")

            #异步触发记忆抽取
            if memory_id and self._should_extract_memory(prompt):
                logger.info("[Memory] Triggering async memory extraction...")
                asyncio.create_task(
                    self._background_memory_update(prompt, app_id, memory_id, api_key)
                )

            #发起主请求（保持原有逻辑不变）
            async with httpxAsyncClient.stream("POST", url, headers=headers, json=payload) as response:
                logger.info(f"[QwenAgent] Response status: {response.status_code}")
                if response.status_code != 200:
                    error_text = await response.aread()
                    try:
                        err_json = json.loads(error_text)
                        msg = err_json.get("message", error_text.decode())
                    except Exception:
                        msg = error_text.decode()
                    error_msg = f"HTTP {response.status_code}: {msg}"
                    logger.error(f"[QwenAgent] Request failed: {error_msg}")
                    yield eventStreamError(error_msg)
                    return

                got_conversation_id = False
                async for chunk in response.aiter_lines():
                    line = chunk.strip()
                    if not line or line == ":":
                        continue

                    if line.startswith("data:"):
                        data_str = line[5:].strip()
                        if data_str == "[DONE]":
                            break

                        try:
                            data = json.loads(data_str)
                        except json.JSONDecodeError as e:
                            logger.warning(f"[QwenAgent] JSON decode error: {e}, raw: {data_str}")
                            continue

                        logger.debug(f"[QwenAgent] SSE data received: {data}")

                        if not got_conversation_id and not use_custom_messages:
                            cid = data.get("output", {}).get("session_id")
                            if cid:
                                if not session_id or cid != session_id:
                                    logger.info(f"[QwenAgent] New conversation_id received: {cid}")
                                    yield eventStreamConversationId(cid)
                                got_conversation_id = True

                        text = data.get("output", {}).get("text", "")
                        if text:
                            yield eventStreamText(text)

            yield eventStreamDone()

        except Exception as e:
            logger.error(f"[QwenAgent] Exception: {e}", exc_info=True)
            yield eventStreamError(str(e))

</code></pre>
<p>这样一个支持语音输出输入，长短期记忆的live2d数字人就完成了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74fdfc11e4524aeabe726993464f097c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3V6dW1peWFocg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630592&amp;x-signature=BPnLaTMbC0lnWRT8XyUICLzL3hg%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b1a8a2948e24dad8528704014278769~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3V6dW1peWFocg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630592&amp;x-signature=Ct9gxAtDQ91hP2Vvs2G3VbBE2rk%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Windows安装Claude Code全流程]]></title>    <link>https://juejin.cn/post/7571808096936722473</link>    <guid>https://juejin.cn/post/7571808096936722473</guid>    <pubDate>2025-11-13T08:54:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571808096936722473" data-draft-id="7571972751528099876" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Windows安装Claude Code全流程"/> <meta itemprop="keywords" content="Windows,Linux,Claude"/> <meta itemprop="datePublished" content="2025-11-13T08:54:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="撒币使我快乐"/> <meta itemprop="url" content="https://juejin.cn/user/1556564197509527"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Windows安装Claude Code全流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1556564197509527/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    撒币使我快乐
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T08:54:57.000Z" title="Thu Nov 13 2025 08:54:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这里不赘述账号申请，很多网上很多资料了。在 Windows 系统上使用 Claude Code，主要有两种官方推荐的路径：一种是利用 Windows 自带的 Linux 子系统（WSL），另一种是尝试通过 PowerShell 直接安装。此外，你也可以选择将其功能集成到 VS Code 编辑器中使用。这里我们使用第一种，因为这是目前最稳定、被广泛验证的方式。</p>
<ol>
<li><strong>启用并安装 WSL</strong>：
<ul>
<li>以<strong>管理员身份</strong>打开 PowerShell。</li>
<li>依次执行以下命令：
<pre><code class="hljs language-powershell" lang="powershell">dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart
dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart
</code></pre>
</li>
<li><strong>重启电脑</strong>使更改生效。</li>
<li>重启后，再次以管理员身份打开 PowerShell，执行 <code>wsl --install</code> 来安装默认的 Linux 发行版（通常是 Ubuntu）。过程中你需要设置一个 Linux 系统的用户名和密码。<br/>
如果这一步提示了如下报错，即使这个链接能通过浏览器打开，也需要处理网络问题<br/>
<em>无法从“<a href="https://link.juejin.cn?target=https%3A%2F%2Fraw.githubusercontent.com%2Fmicrosoft%2FWSL%2Fmaster%2Fdistributions%2FDistributionInfo.json%25E2%2580%259D" target="_blank" title="https://raw.githubusercontent.com/microsoft/WSL/master/distributions/DistributionInfo.json%E2%80%9D" ref="nofollow noopener noreferrer">raw.githubusercontent.com/microsoft/W…</a> 提取列表分发。无法解析服务器的名称或地址<br/>
错误代码: Wsl/InstallDistro/WININET_E_NAME_NOT_RESOLVED</em></li>
</ul>
</li>
<li><strong>处理网络问题方法</strong>
<ol>
<li><strong>诊断DNS解析问题</strong></li>
</ol>
<ul>
<li>
<p>按Win + R输入cmd回车打开命令行工具，执行 <code>ping raw.githubusercontent.com</code> 获取IP地址（如 <code>185.199.110.133</code>）</p>
</li>
</ul>
<ol start="2">
<li><strong>修改Hosts文件</strong></li>
</ol>
<ul>
<li>
<p>使用IDE（需管理员权限）编辑 <code>C:\Windows\System32\drivers\etc\hosts</code></p>
</li>
<li>
<p>添加行：<code>185.199.110.133 raw.githubusercontent.com</code></p>
</li>
</ul>
<ol start="3">
<li><strong>刷新DNS缓存</strong></li>
</ol>
<ul>
<li>
<p>在PowerShell中执行：<code>ipconfig /flushdns</code></p>
</li>
</ul>
<ol start="4">
<li><strong>重新执行<code>wsl --install</code></strong></li>
</ol>
<ul>
<li>执行命令并设置WSL用户名和密码</li>
</ul>
</li>
<li><strong>在 WSL 中安装 Node.js</strong>：
<ul>
<li>从开始菜单打开你安装的 Linux 发行版（如 Ubuntu）。</li>
<li>首先更新系统包并安装 Node.js（如果未安装）：
<pre><code class="hljs language-bash" lang="bash">sudo apt update &amp;&amp; sudo apt upgrade -y
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs
</code></pre>
</li>
<li>验证Node.js安装，执行：<code>node --version</code> （成功输出：<code>20.19.5</code>）</li>
</ul>
</li>
<li><strong>安装Claude Code</strong>
<pre><code class="hljs language-bash" lang="bash">npm install -g @anthropic-ai/claude-code
</code></pre>
</li>
<li>将ANTHROPIC_AUTH_TOKEN和ANTHROPIC_BASE_URL写入~/.zshrc<br/>
在Ubuntu中，使用vim命令修改~/.zshrc
<pre><code class="hljs language-bash" lang="bash">vim ~/.zshrc
</code></pre>
将如下内容写入~/.zshrc，注意将xxxx替换为自己的ANTHROPIC_AUTH_TOKEN，将ANTHROPIC_BASE_URL替换为自己的ANTHROPIC_BASE_URL
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Claude Code 环境变量</span>
<span class="hljs-built_in">export</span> ANTHROPIC_AUTH_TOKEN=xxxx
<span class="hljs-built_in">export</span> ANTHROPIC_BASE_URL=xxx
</code></pre>
立即重新加载并执行当前用户的 .zshrc 配置文件，后续如果遇到需要输入<code>/login</code>登录的场景可以执行一下完成登录
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">source</span> ~/.zshrc
</code></pre>
</li>
<li>使用Claude Code<br/>
在Ubuntu中，输入<code>claude code</code>即可启动</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[零代码+三维仿真！实现自然灾害的可视化模拟与精准预警]]></title>    <link>https://juejin.cn/post/7571768210715869199</link>    <guid>https://juejin.cn/post/7571768210715869199</guid>    <pubDate>2025-11-13T09:27:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571768210715869199" data-draft-id="7572010680896094248" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="零代码+三维仿真！实现自然灾害的可视化模拟与精准预警"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-13T09:27:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mapmost"/> <meta itemprop="url" content="https://juejin.cn/user/1679709496936343"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            零代码+三维仿真！实现自然灾害的可视化模拟与精准预警
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1679709496936343/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mapmost
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:27:17.000Z" title="Thu Nov 13 2025 09:27:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从“被动应对”到“主动预警”的蜕变</h2>
<p>传统防灾预警高度<strong>依赖专业人员经验与繁琐的数据分析</strong>，既耗时耗力，又因灾害状态瞬息万变易错过最佳预警窗口。</p>
<p>园测信科自研的**【RiskInsight平台】<strong>构建</strong>【综合风险预警模型】<strong>和</strong>【灾害链动力学模型】<strong>两大模块，围绕滑坡泥石流、洪水、森林火灾、边坡崩塌等多个灾种，提供基于真实地理环境的灾害分析，将冰冷的监测数字转换成直观生动的</strong>三维仿真场景**，并且可以按照现实情况实时推演，推动防灾减灾工作的<strong>普及化和高效化</strong>！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06339f1be579409883ca37b66e43e818~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=308%2FbePYPBjVK2JiSnOCA2SehJg%3D" alt="动图封面" loading="lazy"/></p>
<h3 data-id="heading-1">01 支持多灾种可视化的综合评价模型</h3>
<p>内置**【滑坡泥石流、溃决洪水、流域洪水、城市洪涝、边坡塌陷、森林火灾】等灾害综合评价模型，**利用GIS空间分析能力，实现实时数据驱动下的模型运行，以及在地图上的可视化模拟，从而降低决策理解门槛。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ec90003a8704e81bc7d13ebbda6d746~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=zAkCqc8cbMmMfLwUjMilTsIJnmM%3D" alt="动图封面" loading="lazy"/></p>
<ul>
<li>
<p>集成**多个综合评价模型，**提供多灾种科学分析支撑。</p>
</li>
<li>
<p><strong>实时数据驱动</strong>专业模型，灾害评估结果更贴近实际。</p>
</li>
<li>
<p>基于<strong>真实三维地理环境</strong>，<strong>直观展示模型分析结果</strong>，反映灾害发生概率，<strong>降低决策理解门槛</strong>。</p>
</li>
</ul>
<h3 data-id="heading-2">02 基于真实地理环境的动力学模型仿真模拟</h3>
<p>内置通用的**【滑坡泥石流、溃决洪水、流域洪水、城市洪涝、边坡塌陷、森林火灾】等灾害链动力学仿真分析模型**，接入真实的地理数据，可实现在三维场景中模拟灾害的演进过程（如溃决洪水的扩散过程）；</p>
<p>同时<strong>支持调整参数来对比</strong>：不同气象条件下房屋、道路、人员等承载体的受灾情况。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67295dcb1b534ebb821f911a00954e61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=3XT6qs84%2BbuLjY9hMEhMU4rPJT4%3D" alt="动图封面" loading="lazy"/></p>
<ul>
<li>
<p>内置多种灾害的动力学模型,支持<strong>实时修改模型参数</strong>，快速生成模拟场景。</p>
</li>
<li>
<p>基于真实DEM数据，<strong>可视化模拟</strong>灾害演进过程。</p>
</li>
<li>
<p>可叠加建筑物、道路、人口分布数据，<strong>动态统计</strong>灾害对关键设施的影响范围。</p>
</li>
</ul>
<h2 data-id="heading-3">零代码让精准预警触手可及</h2>
<p>灾害风险预警模型是平台的核心，面对不同的地理环境，需要业务专家据实际情况，对<strong>模型中的大量参数进行调试以获得最优的监控方案</strong>，在以往的调试过程中，需要由防灾专家与开发者多次沟通才能完成，一旦地理环境发生变化，又需要重复上述的调试过程，这样的模式不仅效率低下，更让真正懂防灾业务的人员被隔绝在技术门槛之外！</p>
<p>作为<strong>业内首个自然灾害监测预警零代码开发平台</strong>，RiskInsight通过直观的图形界面和简单的交互操作，<strong>无需编写复杂的代码就可以完成预警模型的参数调整</strong>，对开发的依赖大大降低！并且，在地理环境不断演变的情况下，<strong>可以及时地调整与验证，生成最优的监控方案。</strong></p>
<h3 data-id="heading-4">01 方式一：框选范围分析</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9176c3d1366b47059faa93687b7587ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=00tGBLqRtdAkDXd1erogE6QTybs%3D" alt="动图封面" loading="lazy"/></p>
<p><em>#该方式支持用户直接在地图上划定分析范围，操作更简便。</em></p>
<h3 data-id="heading-5">02 方式二：上传数据分析</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a9b09b5cef4470984d0fe056a1ed4c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=ai3jhm9CGQQDZTT9pIzTSidozlw%3D" alt="动图封面" loading="lazy"/></p>
<p><em>#该方式需用户自行制作数据上传，分析结果更精确。</em></p>
<h3 data-id="heading-6">03 运行模型</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45dcffa96a694a5bb1b40afcfdab0956~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=frPmnr0hm6Q28eSVhl9Dj%2BjeMOA%3D" alt="动图封面" loading="lazy"/></p>
<h2 data-id="heading-7">仿真分析案例</h2>
<h3 data-id="heading-8">● 流域洪水</h3>
<p>本模型主要用于模拟流域或区域尺度的<strong>地表水与地下水动态过程</strong>，尤其在水文循环模拟、洪水预报、干旱评估及气候变化对水资源的影响研究中应用广泛。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/076374998bb14bd39732a8ee32f9b7ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=rEp84O%2FFoEq6Q8NOHgv%2FNbKI0hc%3D" alt="动图封面" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35bf1f4f08dc42c4adf3dde8123cb8f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=xuva08%2F49LnnIdeKCtMYH6YMjt4%3D" alt="动图封面" loading="lazy"/></p>
<h3 data-id="heading-9">● 滑坡泥石流</h3>
<p>本模型是一款专注于泥石流（岩屑流、山洪泥石流）动力学模拟的专业软件工具，主要用于分析<strong>泥石流的启动、运动过程、堆积范围及对周边设施的影响</strong>，广泛应用于山地灾害风险评估、防灾减灾规划及工程防护设计领域。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9d4c142155246d8ac8c8a33e6fe470e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=MmWd7EMhN8D7p5Bp%2BTTfpudT91w%3D" alt="动图封面" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c6ac206815a4ae395ffdb960f58203f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=WhyzR7dugTxFeHp4oVc53WGcBdI%3D" alt="动图封面" loading="lazy"/></p>
<h3 data-id="heading-10">● 森林火灾</h3>
<p>本模型是野火行为研究的经典工具之一。其核心目标是通过量化火源热释放、燃料特性、气象条件及地形对火蔓延的影响，<strong>预测火线（Firefront）的推进速度与方向</strong>，为火灾防控、风险评估及应急决策提供科学依据。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc11419693d84deda32e756a35992b42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=vGnlZzDZOWV9GfwsZ8C%2FqjC98UQ%3D" alt="动图封面" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4e94ccca40442dbbf10bb32cdcaa4f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=tPrFfWe1pXyKbYseYMcXHfu1n6k%3D" alt="动图封面" loading="lazy"/></p>
<p>在后续的文章中，将为大家分享上述模型功能的开发思路，以及在开发过程中所遇到的问题和解决方案，敬请期待~</p>
<p>了解更多，请至<a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fwww.mapmost.com%2F%2523%2F" target="_blank" title="https://link.zhihu.com/?target=https%3A//www.mapmost.com/%23/" ref="nofollow noopener noreferrer">Mapmost</a>官网联系客服</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 原生应用开发实战营·京沪双城回顾 & PPT 下载]]></title>    <link>https://juejin.cn/post/7571768210715934735</link>    <guid>https://juejin.cn/post/7571768210715934735</guid>    <pubDate>2025-11-13T09:33:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571768210715934735" data-draft-id="7571751593206415412" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 原生应用开发实战营·京沪双城回顾 &amp; PPT 下载"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2025-11-13T09:33:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 原生应用开发实战营·京沪双城回顾 &amp; PPT 下载
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:33:53.000Z" title="Thu Nov 13 2025 09:33:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：盈楹&amp;望宸</p>
<p>近日，阿里云 AI 原生应用开发实战营 · 北京站&amp;上海站圆满落幕。继深圳、杭州、成都等城市之后，这两场活动吸引了 250+ 名技术从业者深度参与。</p>
<p>活动聚焦 AI Agent 领域的前沿技术与落地实践，深度分享 AI Agent 架构趋势和演进、AI 开放平台、AI 应用运行时、AI 应用托管、大模型可观测 &amp; AIOps、异步化的 Agent 事件驱动等热门技术议题，并设置了动手实操环节。</p>
<p>关注「阿里云云原生」公众号，后台回复：1111</p>
<p>免费获得北京站&amp;上海站讲师 PPT 合辑</p>
<h2 data-id="heading-0">精彩回顾丨北京站</h2>
<h3 data-id="heading-1">议题一：构建 AI 原生应用的 11 个关键要素丨王晨(望宸)阿里云智能云原生高级技术运营专家</h3>
<p>深度分享了 AI 云原生应用架构新范式，已从数字化范式演进为智能化范式，基于模型、Agent 驱动，以数据为中心，整合工具链，形成 AI 原生应用架构。AI 原生应用将具备意识、自主性、确定性、一致性。企业可以找到核心提效场景，通过 AI 原生应用架构，构建高质量数据壁垒，借助大模型大势快速迭代，同时，让数据可沉淀，行业数据可演进，评估数据可量化，反馈数据可持续。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee88b0b0a6074071869b18bf455768f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=S1QT9rzfyHKem9zlhlFm9bkPgzA%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-2">议题二：从传统应用到 AI 应用的一站式托管丨赵庆杰(卢令)阿里云智能云原生高级技术专家</h3>
<p>首先分享了传统应用运维的‘简、稳、省’优化之道，迈向智能运维时代，SAE 智能助手的核心引擎从基础问答到故障诊断，AI 能力重构云原生运维流程。企业可借助函数计算 AgentRun、AgentRun 网关、AgentRun 可观测的产品能力，跨越 Agent 生产力鸿沟，构建智能体核心基础设施，全面打通 AI 应用落地最后一公里，加速 AI 创新。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d73ad708643e4a44ab24eba6be630f88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=U0Hzzf6fHgORfWjlrrLulMMZrkU%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-3">议题三：Higress AI 开放平台：构建企业私有化 MCP/Agent 市场的实践丨刘帅(友瑾) Higress Maintainer</h3>
<p>从传统网关迈向 AI 网关，Higress 流量网关、API 网关、大模型代理、MCP 代理能力打造了 AI 网关新范式。深入分享了 Higress x HiMarket 核心原理，企业可以通过 Higress x HiMarket，实现 MCP Server 集中化治理，API 货币化等，快速构建企业级 AI 市场，同时也分享了 Higress x HiMarket 未来规划，欢迎更多用户了解 Higress x HiMarket 项目 roadmap，参与开源贡献。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0be556e1797b47a5863d8ae718d67663~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=WGa0HG2O%2FUe25hS%2B80lTTLZdgCk%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-4">议题四：大模型驱动的可观测与 AIOps 新范式丨温希道(朴象)阿里云智能云原生高级技术专家</h3>
<p>大模型时代带来全新的应用形态和运维模式，面临数据和认知两大难题，可观测数据平台借助统一接入、加工、存储能力，以及通用算子×可观测数据算子，来降低海量数据的分析难度，轻松驾驭驾驭海量、异构、实时的可观测数据。此外，通过引入统一模型（UModel），基于统一模型（UModel）重构可观测数据，打破通用大模型与运维领域知识的鸿沟，打造大模型驱动的可观测与 AIOps 新范式。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38ba97d150474df59c64aee5bfb0d772~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=THbTNJunT%2F%2BouUBNpwRLfcQUPCQ%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-5">议题五：Apache RocketMQ x AI：面向异步化 Agent 的事件驱动架构丨周礼(不铭)阿里云智能云原生高级技术专家</h3>
<p>AI 进入 Agentic AI 阶段，AgenticAI 应用将成为主流方向，讲师分享了实现异步化 Multi-Agent 的关键点，以及基于 Apache RocketMQ 的 Multi-Agent 架构。通过语义化的 Topic 以及 LiteTopic 两个方案，可以解决通信意图不透明、调度逻辑静态固化、响应路径缺失等问题。现场详细介绍了带语义的 Topic 路由、LiteTopic 在 AI 场景中的应用及实现方案、分级消费策略等产品核心竞争力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de32351ebfa142b394f1dbc8d8d216e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=ndESvBKj6yI1ivi2273aPQeJDpg%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-6">议题六：动手实操环节：AIOps 故障定位挑战赛丨温希道(朴象)阿里云智能云原生高级技术专家</h3>
<p>云计算、AIGC 与数字经济的共同推动，带来软件系统数量与复杂度的持续攀升，AIOps 已成为应对这一趋势、保障智能化与可持续发展的关键方向。2025 AI 原生编程挑战赛聚焦 AIOps 故障定位领域，欢迎选手打造智能运维 Agent，让天下没有难查的故障。现场讲师详细介绍了赛题、解题思路，并带领用户现场动手实操，互动交流热烈。欢迎大家报名参赛！<a href="https://link.juejin.cn?target=https%3A%2F%2Ftianchi.aliyun.com%2Fcompetition%2Fentrance%2F532387%3Faccounttraceid%3De0ba51491d54404cae1237b6ae6c3be6hqky" target="_blank" title="https://tianchi.aliyun.com/competition/entrance/532387?accounttraceid=e0ba51491d54404cae1237b6ae6c3be6hqky" ref="nofollow noopener noreferrer">tianchi.aliyun.com/competition…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/badbf4acfcf7435990d5d3344d1e952c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=b2oNLamIW56TTHJSL6wGcuJ7zKQ%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f763f7cc1384aedb4b3d95656c54f48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=RUcqCKSrQVx8hwwCdsVt%2BfjATZo%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-7">现场精彩瞬间</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4eb1606b88aa4acbba0fbf8f83deb27e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=MwOp8fMSXJil5PkZhrqWT9jyCe8%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e3b600c4085426193ec2e261f9b693e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=SCbDU5ECVLuRfvj%2BqI83EnNoJ%2Bk%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7e761368c5b4ae49819ab3233c84777~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=jjU9ag%2FykUT6%2FZdx962JJi0jWK4%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0204555ecdd43b8b8c54f4104db6dfd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=HpUvkINEH8yB4LMWgb76iXsiA5c%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-8">精彩回顾丨上海站</h2>
<h3 data-id="heading-9">议题一：AI 原生应用架构趋势与实践丨肖京(亦盏) 阿里云智能云原生高级技术专家</h3>
<p>当前大模型已迈过技术拐点，Agentic AI 进入规模化落地阶段。AI 原生应用以模型为基础、Agent 为驱动、数据为中心，推动系统从“机器执行”向“机器思考+执行”演进。框架选型需平衡 Agentic 自主性与业务确定性，Agent 面临开发效率、业务效果，以及稳定、性能、成本、安全的挑战。实践上建议构建以数据为核心的 Agent 平台，结合 MCP/A2A 标准与 Serverless 架构，通过 AI 网关、消息队列、可观测等提升安全性、稳定性与可维护性，实现智能化人机协作新范式。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8319c97c1d8f48268c58ddd89db27ed9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=0vR93%2BUMmjo%2BC6WYj%2F3wJ8ek2Aw%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-10">议题二：Serverless AI 应用运行时：从函数计算到函数智能丨史明伟(世如)阿里云智能云原生高级技术专家</h3>
<p>随着大语言模型与 AI Agent 快速发展，阿里云函数计算（FC）通过持续架构演进，从“无状态、极致弹性、按需付费” 到 “会话管理、安全隔离、忙闲计费”，成为构建 AI 应用原生架构核心载体。依托于函数计算 FC 毫秒级弹性，原生架构 3AZ 容灾高可用，会话隔离，多语言运行时，CPU/GPU 异构算力等 Serverless Infra 核心优势，够建 FunctionAI 开发平台，提供模型托管（FunModel）、AIGC 生图（FunArt）、智能体开发（AgentRun）和工具/MCP 开发能力，结合魔搭、百炼生态、电商和教育等场景落地经验，助力企业高效构建可扩展的 AI 应用体系。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3dd702ced41d43fda9b2426d6cbbb43c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=ohWoDoCOT%2BNfuDEyNu7vkEIiGjE%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-11">议题三：MCP 网关的企业级最佳实践丨张添翼(澄潭)阿里云智能云原生技术专家</h3>
<p>随着大模型与 AI Agent 广泛应用，模型上下文协议（MCP）成为连接 AI 与外部服务的关键。阿里云 AI 网关（Higress 企业版）通过“基础连接—进阶优化—大规模治理”三阶段演进，支持 REST-to-MCP 转换、统一代理与协议卸载，实现异构服务无缝接入；并通过认证控制、最小权限管理保障安全；在大规模场景下，提供虚拟服务组装、语义化检索与智能工具精选，缓解 LLM 上下文压力，提升调用准确率与系统性能，助力企业构建高效、安全、可扩展的 AI 集成体系。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/679de0298d864312af0cd4712c6b11bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=BqaBOFHZ%2Bq%2F%2F6YNj7F7uXJTSJ84%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-12">议题四：可见、可管、可控：阿里云 AI 应用可观测能力建设丨曹炜怿(顾思)阿里云智能云原生解决方案架构师</h3>
<p>阿里云大模型可观测方案通过“全栈监控-链路诊断-结果评估”三阶段演进，构建 AI 应用全生命周期观测体系。基于 Prometheus+ARMS+SLS 技术栈，实现模型性能分析、GPU 资源监控、Token 成本追踪等全栈指标采集；通过 OpenTelemetry 协议支持 LLM 调用链路追踪（TTFT/TPOT 分析）及 RAG 混合检索优化；创新 LLM-as-Judge 评估框架，内置 10+ 语义检测模板（合规/幻觉/相关性），结合向量索引与自定义评估，降低 AI 应用调试成本 50%。方案已在 vLLM 引擎优化、Token 黑洞定位等场景验证，助力企业实现推理效率和资源利用率的大幅提升。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a7d56337bbb4f3799d4aec94a03cb48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=JA0ZSCKpdKj%2FLGtjdFsbC9Dd1co%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-13">议题五：Apache RocketMQ for AI：全面拥抱企业级 AI 应用，引领 AI MQ 新时代丨杨文婷(文婷)阿里云智能云原生产品专家</h3>
<p>阿里云 Apache RocketMQ 推出面向 AI 应用的全新 LiteTopic 模型，支持百万级轻量主题，具备自动生命周期管理、排他消费与顺序消息能力，有效解决 AI 场景中的异步通信、流量治理与定速消费难题。该模型在 Multi-Agent 通信、分布式会话管理与算力调度中发挥关键作用，保障高并发、低延迟与系统可扩展性。RocketMQ 正战略升级为专为 AI 时代打造的 AIMQ，集成主流AI框架，并计划将 LiteTopic 开源，致力于构建企业级 AI 异步通信基础设施。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9badf6e36f514412b1c7c7124551f1ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=9Hzckh0nvq9euuIl1F1dUV8OWPo%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-14">议题六：动手实操环节：AIOps 故障定位挑战赛丨刘进步(石季) 阿里云智能云原生算法专家</h3>
<p>2025 年云原生编程挑战赛聚焦智能运维（AIOps）发展，应对云计算与 AIGC 浪潮下系统复杂度提升带来的故障定位难、运维成本高等挑战。大赛倡导融合可观测数据、开源标准与大模型技术，推动运维智能化。参赛者可通过云监控 2.0“看”根因、SPL 脚本“算”根因，或构建大模型 Agent 实现智能诊断，比赛提供完整脚手架与教程，覆盖从入门到高阶的智能运维演进路径，助力打造高效运维解决方案。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28333d2d8fea4041b3573b9317e5c182~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=Uy1kZ9vfJyqX%2FTTliSCUF2ZOTkc%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-15">现场精彩瞬间</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4f905fdcdb645d9b180379ef0797723~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=9QkJjH1dmtkvkvdLZUQzi%2BHKGZA%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8acb674ddf134b6d95ae65ac7b194534~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=s%2FHgoeOyMBardRwO8YrA5220p98%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/525fbe56fd824d1fbfa4be714fdd98f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=0GqS5uauJhC%2Bc7t5%2Frjs5MwYb0I%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bad049b076a4df2a51313673a56a09a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=aWPe8oP0wPx2JTnpj9G4W5FOar4%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11227628027d4275929d32e8fc98cfc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=oojIlgdjNmcXG9QCRKiEe%2BgivyU%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1266e3a18ae454aaac07be8dad1b020~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=X9mJbqqCT15UCMsrdf2Gqj4%2B21A%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66c63261aadc4f4eaeafbe8010f72ba2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=teiP2HCpq4cDsy7A1zg83lbRa40%3D" alt="图片" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从基本链表到侵入式链表，体会内核设计思路]]></title>    <link>https://juejin.cn/post/7571808096937066537</link>    <guid>https://juejin.cn/post/7571808096937066537</guid>    <pubDate>2025-11-13T09:27:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571808096937066537" data-draft-id="7571972751528280100" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从基本链表到侵入式链表，体会内核设计思路"/> <meta itemprop="keywords" content="C语言,后端,设计模式"/> <meta itemprop="datePublished" content="2025-11-13T09:27:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="jzhwolp"/> <meta itemprop="url" content="https://juejin.cn/user/3444121799235879"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从基本链表到侵入式链表，体会内核设计思路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3444121799235879/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    jzhwolp
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:27:14.000Z" title="Thu Nov 13 2025 09:27:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从链表到侵入式结构</h2>
<ul>
<li>以“学生信息链表”为应用场景。</li>
<li>通过对比两种链表实现，说明<strong>侵入式结构（intrusive data structure）与非侵入式结构（non-intrusive data structure）</strong> 的差异。</li>
<li>结合实际开发（内核 vs 用户态、性能 vs 可维护性）讨论各自优劣。</li>
</ul>
<p>在C语言中，链表是最常见的动态数据结构之一。通常我们会为每个节点定义一个包含数据和指针的结构体，用于存储和连接元素。然而，在系统级编程（如Linux内核）中，我们常看到另一种实现方式——“侵入式链表”。</p>
<p>二者虽然都能实现链表功能，但在设计哲学、灵活性与性能上存在显著差异。本文以“学生信息管理系统”为例，展示两种链表设计方式的不同实现与适用场景。</p>
<h3 data-id="heading-1">非侵入式链表（Non-Intrusive Linked List）</h3>
<h4 data-id="heading-2">介绍</h4>
<p>非侵入式链表将“数据”和“链表节点”分离。 链表节点结构独立于业务数据，节点仅负责维护指针关系。</p>
<h4 data-id="heading-3">示例代码</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment">#include &lt;stdio.h&gt;</span>
<span class="hljs-comment">#include &lt;stdlib.h&gt;</span>
<span class="hljs-comment">#include &lt;string.h&gt;</span>
​
typedef struct Student {
    int id<span class="hljs-comment">;</span>
    char name<span class="hljs-section">[32]</span><span class="hljs-comment">;</span>
    int age<span class="hljs-comment">;</span>
} Student<span class="hljs-comment">;</span>
​
typedef struct Node {
    Student *data<span class="hljs-comment">;</span>
    struct Node *next<span class="hljs-comment">;</span>
} Node<span class="hljs-comment">;</span>
​
Node *create_node(Student *stu) {
    Node *<span class="hljs-attr">node</span> = malloc(sizeof(Node))<span class="hljs-comment">;</span>
    node-&gt;<span class="hljs-attr">data</span> = stu<span class="hljs-comment">;</span>
    node-&gt;<span class="hljs-attr">next</span> = NULL<span class="hljs-comment">;</span>
    return node<span class="hljs-comment">;</span>
}
​
void append(Node **head, Student *stu) {
    Node *<span class="hljs-attr">new_node</span> = create_node(stu)<span class="hljs-comment">;</span>
    if (*<span class="hljs-attr">head</span> == NULL) {
        *<span class="hljs-attr">head</span> = new_node<span class="hljs-comment">;</span>
        return<span class="hljs-comment">;</span>
    }
    Node *<span class="hljs-attr">cur</span> = *head<span class="hljs-comment">;</span>
    while (cur-&gt;next) <span class="hljs-attr">cur</span> = cur-&gt;next<span class="hljs-comment">;</span>
    cur-&gt;<span class="hljs-attr">next</span> = new_node<span class="hljs-comment">;</span>
}
​
void print_list(Node *head) {
    while (head) {
        printf("ID: %d, Name: %s, Age: %d\n",
               head-&gt;data-&gt;id, head-&gt;data-&gt;name, head-&gt;data-&gt;age)<span class="hljs-comment">;</span>
        <span class="hljs-attr">head</span> = head-&gt;next<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h4 data-id="heading-4">特点与优劣</h4>
<ul>
<li>✅ 数据结构独立，可被多个链表、哈希表、树结构同时使用。</li>
<li>✅ 修改链表逻辑不会影响业务结构。</li>
<li>❌ 每个节点要单独分配内存（malloc两次），增加内存碎片与访问开销。</li>
<li>❌ 数据和节点分离，局部性（cache locality）较差</li>
</ul>
<h3 data-id="heading-5">侵入式链表（Intrusive Linked List）</h3>
<h4 data-id="heading-6">介绍</h4>
<p>侵入式结构直接将链表指针嵌入业务结构体内部。 数据本身“知道”它属于哪个链表，这种方式常用于<strong>操作系统内核（如Linux list_head）</strong> 和高性能网络框架中。</p>
<h4 data-id="heading-7">示例代码</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment">#include &lt;stdio.h&gt;</span>
<span class="hljs-comment">#include &lt;stdlib.h&gt;</span>
<span class="hljs-comment">#include &lt;string.h&gt;</span>
​
typedef struct Student {
    int id<span class="hljs-comment">;</span>
    char name<span class="hljs-section">[32]</span><span class="hljs-comment">;</span>
    int age<span class="hljs-comment">;</span>
    struct Student *next<span class="hljs-comment">; // 侵入式指针</span>
} Student<span class="hljs-comment">;</span>
​
void append(Student **head, Student *stu) {
    stu-&gt;<span class="hljs-attr">next</span> = NULL<span class="hljs-comment">;</span>
    if (*<span class="hljs-attr">head</span> == NULL) {
        *<span class="hljs-attr">head</span> = stu<span class="hljs-comment">;</span>
        return<span class="hljs-comment">;</span>
    }
    Student *<span class="hljs-attr">cur</span> = *head<span class="hljs-comment">;</span>
    while (cur-&gt;next) <span class="hljs-attr">cur</span> = cur-&gt;next<span class="hljs-comment">;</span>
    cur-&gt;<span class="hljs-attr">next</span> = stu<span class="hljs-comment">;</span>
}
​
void print_list(Student *head) {
    while (head) {
        printf("ID: %d, Name: %s, Age: %d\n",
               head-&gt;id, head-&gt;name, head-&gt;age)<span class="hljs-comment">;</span>
        <span class="hljs-attr">head</span> = head-&gt;next<span class="hljs-comment">;</span>
    }
}
​
</code></pre>
<h4 data-id="heading-8">特点和劣势</h4>
<ul>
<li>✅ 数据与节点合一，内存连续、cache 友好。</li>
<li>✅ 无需额外分配内存，减少开销。</li>
<li>✅ 更适合系统编程、内核模块、高性能场景。</li>
<li>❌ 数据结构耦合性强，不能轻易复用（一个结构体难以同时挂在多个链表上）。</li>
<li>❌ 抽象层次低，可维护性较差。</li>
</ul>
<h3 data-id="heading-9">对比与设计思考</h3>



































<table><thead><tr><th>维度</th><th>非侵入式结构</th><th>侵入式结构</th></tr></thead><tbody><tr><td><strong>内存布局</strong></td><td>数据与节点分离</td><td>数据与节点合一</td></tr><tr><td><strong>封装性</strong></td><td>强，模块独立</td><td>弱，耦合紧密</td></tr><tr><td><strong>性能</strong></td><td>较低（多次 malloc，cache miss）</td><td>高（连续访问）</td></tr><tr><td><strong>通用性</strong></td><td>可适配不同链表/容器</td><td>只能服务于特定链表</td></tr><tr><td><strong>典型场景</strong></td><td>应用层数据结构库</td><td>内核、驱动、高性能系统</td></tr></tbody></table>
<h3 data-id="heading-10">延伸：Linux 内核链表的侵入式设计</h3>
<h4 data-id="heading-11">基本数据结构与初始化</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">list_head</span> {
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">list_head</span> *next, *prev;
};
</code></pre>
<p>这就是内核侵入式链表的核心：双向循环链表的节点。任意包含 struct list_head 成员的结构就可以“挂链” —— 这是侵入式设计的本质（链表指针嵌入业务结构）。</p>
<p>常用初始化宏 / 函数：</p>
<ul>
<li>LIST_HEAD_INIT(name)：静态初始化（把 next/prev 都指回自己）。</li>
<li>LIST_HEAD(name)：在定义时同时静态初始化一个 list head。</li>
<li>INIT_LIST_HEAD(struct list_head *list)：运行时将 list-&gt;next = list-&gt;prev = list，把它变成空链表头。实现中会使用 WRITE_ONCE 保证写操作的可见性/内存序。</li>
</ul>
<h4 data-id="heading-12">插入与删除的低级实现</h4>
<p>内核在 list.h 中把对指针的实际修改抽成了 <strong>list_add()、</strong> list_del() 等内部函数，然后在上面封装 list_add() / list_add_tail() / list_del() 等接口。这种分层便于对“批量操作”或“已知邻节点”的优化。基本思想和步骤都是直接操作 next/prev 四个指针。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> __list_add(<span class="hljs-keyword">struct</span> list_head *<span class="hljs-keyword">new</span>,
                  <span class="hljs-keyword">struct</span> list_head *prev,
                  <span class="hljs-keyword">struct</span> list_head *next)
{
    <span class="hljs-keyword">if</span> (!__list_add_valid(<span class="hljs-keyword">new</span>, prev, next))
        <span class="hljs-keyword">return</span>;
    next-&gt;prev = <span class="hljs-keyword">new</span>;
    <span class="hljs-keyword">new</span>-&gt;next = next;
    <span class="hljs-keyword">new</span>-&gt;prev = prev;
    <span class="hljs-built_in">WRITE_ONCE</span>(prev-&gt;next, <span class="hljs-keyword">new</span>);
}
<span class="hljs-comment">/**
 * list_add - add a new entry
 * @new: new entry to be added
 * @head: list head to add it after
 *
 * Insert a new entry after the specified head.
 * This is good for implementing stacks.
 */</span>
<span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">list_add</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> list_head *<span class="hljs-keyword">new</span>, <span class="hljs-keyword">struct</span> list_head *head)</span>
</span>{
    __list_add(<span class="hljs-keyword">new</span>, head, head-&gt;next);
}
​
<span class="hljs-comment">/**
 * list_del - deletes entry from list.
 * @entry: the element to delete from the list.
 * Note: list_empty() on entry does not return true after this, the entry is
 * in an undefined state.
 */</span>
<span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> __list_del_entry(<span class="hljs-keyword">struct</span> list_head *entry)
{
    <span class="hljs-keyword">if</span> (!__list_del_entry_valid(entry))
        <span class="hljs-keyword">return</span>;
    __list_del(entry-&gt;prev, entry-&gt;next);
}
<span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">list_del</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> list_head *entry)</span>
</span>{
    __list_del_entry(entry);
    entry-&gt;next = LIST_POISON1;
    entry-&gt;prev = LIST_POISON2;
}
</code></pre>
<h4 data-id="heading-13">访问/类型转换</h4>
<p>侵入式链表的关键是如何从链表节点结构（struct list_head *）回到包含它的业务结构体。内核用两个组成：offsetof（标准宏）+ container_of, container_of 宏的作用是：已知某个结构体成员的指针，通过成员在结构体中的偏移量，计算出包含该成员的结构体的起始地址。简单来说，它可以让你从成员指针“反推出”结构体指针，这是 Linux 内核侵入式数据结构设计中非常常用的技巧。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a51fe14d2724607a6d4275bbccbfc07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganpod29scA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630981&amp;x-signature=%2BYYSsWtS8oxbkfbCyZHPEFXKMH8%3D" alt="container_of.png" loading="lazy"/></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-id">#define</span> <span class="hljs-built_in">container_of</span>(ptr, type, member) ({                      \
        const typeof( ((type *)<span class="hljs-number">0</span>)-&gt;member ) *__mptr = (ptr);    \
        (type *)( (char *)__mptr - <span class="hljs-built_in">offsetof</span>(type,member) );})
​
<span class="hljs-selector-id">#define</span> <span class="hljs-built_in">offsetof</span>(TYPE, MEMBER) ((size_t) &amp;((TYPE *)<span class="hljs-number">0</span>)-&gt;MEMBER)
​
</code></pre>
<h5 data-id="heading-14">代码示例</h5>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">/* student_list.c
 *
 * 单文件示例：侵入式链表 + container_of / list_entry
 * 演示：插入、遍历、在遍历中安全删除
 */</span>
​
<span class="hljs-selector-id">#include</span> &lt;stdio<span class="hljs-selector-class">.h</span>&gt;
<span class="hljs-selector-id">#include</span> &lt;stdlib<span class="hljs-selector-class">.h</span>&gt;
<span class="hljs-selector-id">#include</span> &lt;string<span class="hljs-selector-class">.h</span>&gt;
<span class="hljs-selector-id">#include</span> &lt;stddef<span class="hljs-selector-class">.h</span>&gt; <span class="hljs-comment">/* offsetof */</span>
​
<span class="hljs-comment">/* -------------------- 基本类型与宏 -------------------- */</span>
​
<span class="hljs-comment">/* 内核风格的双向循环链表节点 */</span>
struct list_head {
    struct list_head *next, *prev;
};
​
<span class="hljs-comment">/* offsetof 用标准头文件提供 */</span>
​
<span class="hljs-comment">/* 简化版 container_of（可移植）：
 * ptr: 指向 member 的指针
 * type: 包含 member 的结构体类型
 * member: 成员名
 */</span>
<span class="hljs-selector-id">#define</span> <span class="hljs-built_in">container_of</span>(ptr, type, member) \
    ((type *)((char *)(ptr) - <span class="hljs-built_in">offsetof</span>(type, member)))
​
<span class="hljs-comment">/* list_entry: 从 list_head 指针得到包含它的结构体指针 */</span>
<span class="hljs-selector-id">#define</span> <span class="hljs-built_in">list_entry</span>(ptr, type, member) \
    <span class="hljs-built_in">container_of</span>(ptr, type, member)
​
<span class="hljs-comment">/* 遍历宏：迭代 list_head 指针 */</span>
<span class="hljs-selector-id">#define</span> <span class="hljs-built_in">list_for_each</span>(pos, head) \
    for (pos = (head)-&gt;next; pos != (head); pos = pos-&gt;next)
​
<span class="hljs-comment">/* 按 entry（宿主结构体）遍历 */</span>
<span class="hljs-selector-id">#define</span> <span class="hljs-built_in">list_for_each_entry</span>(entry, head, member)                           \
    for (entry = list_entry((head)-&gt;next, <span class="hljs-built_in">typeof</span>(*entry), member);         \
         &amp;entry-&gt;member != (head);                                         \
         entry = <span class="hljs-built_in">list_entry</span>(entry-&gt;member.next, typeof(*entry), member))
​
<span class="hljs-comment">/* 安全遍历：在循环体可能删除当前元素时使用 */</span>
<span class="hljs-selector-id">#define</span> <span class="hljs-built_in">list_for_each_entry_safe</span>(entry, tmp, head, member)                 \
    for (entry = list_entry((head)-&gt;next, <span class="hljs-built_in">typeof</span>(*entry), member),         \
        tmp = <span class="hljs-built_in">list_entry</span>(entry-&gt;member.next, typeof(*entry), member);      \
         &amp;entry-&gt;member != (head);                                         \
         entry = tmp, tmp = <span class="hljs-built_in">list_entry</span>(tmp-&gt;member.next, typeof(*tmp), member))
​
<span class="hljs-comment">/* LIST 初始化（运行时） */</span>
static inline void <span class="hljs-built_in">INIT_LIST_HEAD</span>(struct list_head *list)
{
    list-&gt;next = list-&gt;prev = list;
}
​
<span class="hljs-comment">/* -------------------- 链表基本操作 -------------------- */</span>
​
<span class="hljs-comment">/* 在 head 后插入 new（头插） */</span>
static inline void <span class="hljs-built_in">__list_add</span>(struct list_head *new,
                              struct list_head *prev,
                              struct list_head *next)
{
    next-&gt;prev = new;
    new-&gt;next = next;
    new-&gt;prev = prev;
    prev-&gt;next = new;
}
​
static inline void <span class="hljs-built_in">list_add</span>(struct list_head *new, struct list_head *head)
{
    <span class="hljs-built_in">__list_add</span>(new, head, head-&gt;next);
}
​
<span class="hljs-comment">/* 在 tail 前插入 new（尾插） */</span>
static inline void <span class="hljs-built_in">list_add_tail</span>(struct list_head *new, struct list_head *head)
{
    <span class="hljs-built_in">__list_add</span>(new, head-&gt;prev, head);
}
​
<span class="hljs-comment">/* 从链表删除 entry（不重置 entry 指针） */</span>
static inline void <span class="hljs-built_in">__list_del</span>(struct list_head * prev, struct list_head * next)
{
    next-&gt;prev = prev;
    prev-&gt;next = next;
}
​
static inline void <span class="hljs-built_in">list_del</span>(struct list_head *entry)
{
    <span class="hljs-built_in">__list_del</span>(entry-&gt;prev, entry-&gt;next);
    <span class="hljs-comment">/* 注意：为了简单，这里不把 entry-&gt;next/prev 置为 POISON 值或 self */</span>
}
​
<span class="hljs-comment">/* -------------------- 学生结构 + 操作 -------------------- */</span>
​
struct student {
    int id;
    char name<span class="hljs-selector-attr">[32]</span>;
    struct list_head list; <span class="hljs-comment">/* 侵入式成员 */</span>
};
​
void <span class="hljs-built_in">add_student_tail</span>(struct list_head *head, int id, const char *name)
{
    struct student *s = <span class="hljs-built_in">malloc</span>(sizeof(*s));
    if (!s) {
        <span class="hljs-built_in">perror</span>("malloc");
        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);
    }
    s-&gt;id = id;
    <span class="hljs-built_in">strncpy</span>(s-&gt;name, name, sizeof(s-&gt;name) - <span class="hljs-number">1</span>);
    s-&gt;name<span class="hljs-selector-attr">[sizeof(s-&gt;name) - 1]</span> = '\<span class="hljs-number">0</span>';
    <span class="hljs-built_in">INIT_LIST_HEAD</span>(&amp;s-&gt;list);
    <span class="hljs-built_in">list_add_tail</span>(&amp;s-&gt;list, head);
}
​
void <span class="hljs-built_in">print_students</span>(struct list_head *head)
{
    struct list_head *pos;
    <span class="hljs-built_in">printf</span>("当前学生列表:\n");
    <span class="hljs-built_in">list_for_each</span>(pos, head) {
        struct student *s = <span class="hljs-built_in">list_entry</span>(pos, struct student, list);
        <span class="hljs-built_in">printf</span>("  id=%d, name=%s\n", s-&gt;id, s-&gt;name);
    }
}
​
<span class="hljs-comment">/* 释放链表（安全删除并 free） */</span>
void <span class="hljs-built_in">free_all_students</span>(struct list_head *head)
{
    struct student *s, *tmp;
    <span class="hljs-built_in">list_for_each_entry_safe</span>(s, tmp, head, list) {
        <span class="hljs-built_in">list_del</span>(&amp;s-&gt;list);
        <span class="hljs-built_in">free</span>(s);
    }
}
​
<span class="hljs-comment">/* -------------------- 主程序（演示） -------------------- */</span>
​
int <span class="hljs-selector-tag">main</span>(void)
{
    struct list_head student_list;
    <span class="hljs-built_in">INIT_LIST_HEAD</span>(&amp;student_list);
​
    <span class="hljs-built_in">add_student_tail</span>(&amp;student_list, <span class="hljs-number">1001</span>, "Alice");
    <span class="hljs-built_in">add_student_tail</span>(&amp;student_list, <span class="hljs-number">1002</span>, "Bob");
    <span class="hljs-built_in">add_student_tail</span>(&amp;student_list, <span class="hljs-number">1003</span>, "Charlie");
    <span class="hljs-built_in">add_student_tail</span>(&amp;student_list, <span class="hljs-number">1004</span>, "Diana");
​
    <span class="hljs-built_in">print_students</span>(&amp;student_list);
    <span class="hljs-built_in">puts</span>("");
​
    <span class="hljs-comment">/* 示范：仅有 list_head 指针时，如何用 container_of / list_entry 恢复 student 指针 */</span>
    struct list_head *node = student_list<span class="hljs-selector-class">.next-</span>&gt;next; <span class="hljs-comment">/* 指向 Bob 的节点（第二个） */</span>
    struct student *stu = <span class="hljs-built_in">container_of</span>(node, struct student, list);
    <span class="hljs-built_in">printf</span>("从节点反推到结构体：id=%d, name=%s\n\n", stu-&gt;id, stu-&gt;name);
​
    <span class="hljs-comment">/* 在遍历中安全删除：删除名字以 'C' 开头的学生 */</span>
    <span class="hljs-built_in">printf</span>("在遍历中删除 name 以 'C' 开头的学生...\n");
    struct student *<span class="hljs-selector-tag">p</span>, *<span class="hljs-selector-tag">q</span>;
    <span class="hljs-built_in">list_for_each_entry_safe</span>(p, q, &amp;student_list, list) {
        if (p-&gt;name[<span class="hljs-number">0</span>] == 'C') {
            <span class="hljs-built_in">printf</span>("  删除 %s (id=%d)\n", <span class="hljs-selector-tag">p</span>-&gt;name, <span class="hljs-selector-tag">p</span>-&gt;id);
            <span class="hljs-built_in">list_del</span>(&amp;p-&gt;list);
            <span class="hljs-built_in">free</span>(p);
        }
    }
    <span class="hljs-built_in">puts</span>("");
​
    <span class="hljs-built_in">print_students</span>(&amp;student_list);
    <span class="hljs-built_in">puts</span>("");
​
    <span class="hljs-comment">/* 清理剩余节点 */</span>
    <span class="hljs-built_in">free_all_students</span>(&amp;student_list);
    return <span class="hljs-number">0</span>;
}
​
</code></pre>
<p>编译＆＆运行</p>
<pre><code class="hljs language-ini" lang="ini">gcc -Wall -Wextra -o student_list student_list 
​
./student_list
​
当前学生列表:
  <span class="hljs-attr">id</span>=<span class="hljs-number">1001</span>, name=Alice
  <span class="hljs-attr">id</span>=<span class="hljs-number">1002</span>, name=Bob
  <span class="hljs-attr">id</span>=<span class="hljs-number">1003</span>, name=Charlie
  <span class="hljs-attr">id</span>=<span class="hljs-number">1004</span>, name=Diana
​
从节点反推到结构体：<span class="hljs-attr">id</span>=<span class="hljs-number">1002</span>, name=Bob
​
在遍历中删除 name 以 'C' 开头的学生...
  删除 Charlie (<span class="hljs-attr">id</span>=<span class="hljs-number">1003</span>)
​
当前学生列表:
  <span class="hljs-attr">id</span>=<span class="hljs-number">1001</span>, name=Alice
  <span class="hljs-attr">id</span>=<span class="hljs-number">1002</span>, name=Bob
  <span class="hljs-attr">id</span>=<span class="hljs-number">1004</span>, name=Diana
</code></pre>
<h3 data-id="heading-15">总结</h3>
<ul>
<li>想象一个书架上摆着很多书，每本书都是一个完整的“结构体”。</li>
<li>每本书里都有一个书签（成员），标记你正在看的页。</li>
<li>现在，你手里只有一张书签（就像拿到成员指针），你想知道它属于哪本书（即找到包含它的结构体）。</li>
</ul>
<p>这时：</p>
<ol start="0">
<li>offsetof 就像你知道书签在书里的位置（比如它夹在第 50 页），也就是成员在结构体中的偏移量。</li>
<li>container_of 就像你用书签的位置和它在书里的偏移量，推算出整本书的起始位置，从而拿到整本书的信息。</li>
</ol>
<p>总结形象说法</p>
<ul>
<li>offsetof = 书签在书里的位置</li>
<li>container_of = 通过书签找到整本书</li>
</ul>
<p>也就是说，从局部线索回到整体对象。</p>























































<table><thead><tr><th>特性</th><th>侵入式（Intrusive）</th><th>非侵入式（Non-Intrusive）</th></tr></thead><tbody><tr><td><strong>定义</strong></td><td>链表节点指针嵌入到业务结构体内部</td><td>链表节点独立于业务结构体，通过指针引用业务数据</td></tr><tr><td><strong>内存布局</strong></td><td>成员指针与业务数据在同一内存块内</td><td>节点结构与业务数据分开，通常节点里只保存指针</td></tr><tr><td><strong>示例</strong></td><td>Linux 内核 <code>list_head</code> + <code>task_struct</code> / <code>sk_buff</code></td><td>标准 C++ STL <code>list</code>、Java <code>LinkedList</code>、C 语言中 <code>struct node { void *data; struct node *next; }</code></td></tr><tr><td><strong>性能</strong></td><td>高：少一次内存分配，缓存友好，遍历效率高</td><td>较低：每个节点单独分配，可能导致更多内存分配和访问</td></tr><tr><td><strong>灵活性</strong></td><td>低：业务结构体必须知道链表存在，修改结构体比较困难</td><td>高：业务结构体无需关心链表，可以被多个容器复用</td></tr><tr><td><strong>可复用性</strong></td><td>低：同一对象同时挂多个链表需要多个成员指针</td><td>高：同一对象可被多个链表引用，只需多一个节点或指针</td></tr><tr><td><strong>删除/插入</strong></td><td>直接操作节点指针即可，高效</td><td>需要通过节点找到业务数据，再操作，效率略低</td></tr><tr><td><strong>安全性</strong></td><td>稍低：不小心修改指针容易破坏链表</td><td>较高：节点与数据分离，修改节点不会破坏数据结构本身</td></tr><tr><td><strong>使用场景</strong></td><td>内核、驱动、高性能系统、游戏引擎等</td><td>应用层通用数据结构、业务逻辑、标准库容器</td></tr></tbody></table>
<p>总结一句话</p>
<ul>
<li>
<p>侵入式 = “业务结构体自带链表节点，性能高但耦合紧密”。</p>
</li>
<li>
<p>非侵入式 = “链表节点独立于业务数据，灵活可复用但性能稍低”。</p>
</li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fandroid.googlesource.com%2Fkernel%2Fcommon%2F%252B%2F3f20ba7d5d1dbcd63d31e1e539a83bd3baace048%2Finclude%2Flinux%2Flist.h" target="_blank" title="https://android.googlesource.com/kernel/common/%2B/3f20ba7d5d1dbcd63d31e1e539a83bd3baace048/include/linux/list.h" ref="nofollow noopener noreferrer">linux内核链表源码链接</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我用 TRAE 翻译了J友的数字滚动组件，从原生到Vue！]]></title>    <link>https://juejin.cn/post/7572010680896110632</link>    <guid>https://juejin.cn/post/7572010680896110632</guid>    <pubDate>2025-11-13T09:36:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572010680896110632" data-draft-id="7571751593207119924" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我用 TRAE 翻译了J友的数字滚动组件，从原生到Vue！"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2025-11-13T09:36:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="李剑一"/> <meta itemprop="url" content="https://juejin.cn/user/4147782344247918"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我用 TRAE 翻译了J友的数字滚动组件，从原生到Vue！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4147782344247918/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    李剑一
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:36:07.000Z" title="Thu Nov 13 2025 09:36:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近在做自己的大屏项目，毕竟很多公司还是要求提交自己的作品的。</p>
<p>虽然做的效果一般，但是UI和UE上的体验一定要拉满，给面试官以视觉上的冲击力才是大屏的关键。</p>
<p>在掘金上看到这篇<a href="https://juejin.cn/post/7503716790615228452" target="_blank" title="https://juejin.cn/post/7503716790615228452">文章</a>写的仿百度数字滚动效果，打算比着葫芦画瓢，复刻一个Vue3版本的数字滚动组件。</p>
<p>正好现在一直在用 TRAE，复刻代码也比较简单。</p>
<h2 data-id="heading-0">效果</h2>
<p>数字滚动组件的核心部分就是延迟滚动效果，各个数字从前到后延迟滚动会造成一种非常好的视觉效果。</p>
<p>我一开始以为直接用CSS实现就齐活了，后来发现事情不是这么简单的。</p>
<ul>
<li>每位数字的滚动时间不同，做出前后延迟效果。</li>
<li>数字需要精准的滚动到所需的内容，并且滚动过程需要连贯。</li>
<li>滚动效果上带有一种惯性的感觉。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f9e3f5b48c04cbbb6ffaae6d4e74219~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5YmR5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631367&amp;x-signature=pvLK8AvU67wuHuRqMB2LGsHP920%3D" alt="屏幕录制-2025-11-13-172657.gif" loading="lazy"/></p>
<p>本来想着自己比着来一遍速度也很快，但是低估了内容的难度。</p>
<p>于是乎我打开 TRAE ，将J友的代码拷进去，输入指令：</p>
<p><strong>请帮我将上述代码转换为Vue3的组件代码，我要实现的是一个数字滚动的组件，将每个数字进行分割，最大8位数，不足8位使用0补齐8位。同时每3位增加一个逗号分隔符，每位数字都拥有自己的背景，类似于记分牌的效果。</strong></p>
<p>1，2，3.....</p>
<p>于是乎以下的代码就输出了出来！</p>
<h2 data-id="heading-1">实现代码</h2>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"num-statistic"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"num-statistic-content"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(_digit, index) in numList"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"index"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"digit-container"</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"`digit-container${index+1}`"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"digitListRefs"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"digit-list"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(_item, idx) in 10"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"idx"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"digit"</span>&gt;</span>{{ idx }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(_item, idx) in 10"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"`dup-${idx}`"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"digit"</span>&gt;</span>{{ idx }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(_item, idx) in 10"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"`dup2-${idx}`"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"digit"</span>&gt;</span>{{ idx }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"index === 1 || index === 4"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"num-split"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"`split-${index}`"</span>&gt;</span>,<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>Ps: TRAE提醒我，每个需要滚动的数字组件一定要通过 <code>v-for</code> 循环创建，即便你的数字位数是固定的。</p>
<p>因为Vue3中只有通过<code>v-for</code>定义相同的<code>ref</code>才会被归纳到一个数组中。</p>
<p>单纯的写多个<code>div</code>其<code>ref</code>相同的话，并不是数组，而是一个对象，指向最后一个<code>DOM</code>。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> props = defineProps&lt;{
    <span class="hljs-attr">num</span>: number
}&gt;()
<span class="hljs-keyword">const</span> digitListRefs = ref&lt;<span class="hljs-title class_">HTMLDivElement</span>[]&gt;([])

<span class="hljs-keyword">const</span> numList = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> numStr = <span class="hljs-title class_">String</span>(props.<span class="hljs-property">num</span>).<span class="hljs-title function_">padStart</span>(<span class="hljs-number">8</span>, <span class="hljs-string">'0'</span>);
    <span class="hljs-keyword">return</span> numStr.<span class="hljs-title function_">split</span>(<span class="hljs-string">''</span>);
});

<span class="hljs-title function_">watch</span>(numList, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">startAnimate</span>();
    })
}, {
    <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span>
})

<span class="hljs-keyword">const</span> <span class="hljs-title function_">startAnimate</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> digits = numList.<span class="hljs-property">value</span>;
    digitListRefs.<span class="hljs-property">value</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">element, i</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (element &amp;&amp; element.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.digit-list'</span>)) {
            <span class="hljs-keyword">const</span> list = element.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.digit-list'</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLElement</span>;
            <span class="hljs-keyword">const</span> targetDigit = <span class="hljs-built_in">parseInt</span>(digits[i], <span class="hljs-number">10</span>);
            <span class="hljs-keyword">const</span> targetY = -(<span class="hljs-number">20</span> + targetDigit) * <span class="hljs-number">50</span>;

            list.<span class="hljs-property">style</span>.<span class="hljs-property">transform</span> = <span class="hljs-string">`translateY(<span class="hljs-subst">${targetY}</span>px)`</span>;
        }
    });
}
</code></pre>
<p>Ps: 这里注意，我设置的数字最大8位数，逻辑上是不足8位以0补全。</p>
<h2 data-id="heading-2">完整组件代码</h2>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> {ref, defineProps, computed, watch, nextTick} <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;

<span class="hljs-keyword">const</span> props = defineProps&lt;{
    <span class="hljs-attr">num</span>: number
}&gt;()

<span class="hljs-keyword">const</span> digitListRefs = ref&lt;<span class="hljs-title class_">HTMLDivElement</span>[]&gt;([])

<span class="hljs-keyword">const</span> numList = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> numStr = <span class="hljs-title class_">String</span>(props.<span class="hljs-property">num</span>).<span class="hljs-title function_">padStart</span>(<span class="hljs-number">8</span>, <span class="hljs-string">'0'</span>);
    <span class="hljs-keyword">return</span> numStr.<span class="hljs-title function_">split</span>(<span class="hljs-string">''</span>);
});

<span class="hljs-title function_">watch</span>(numList, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">startAnimate</span>();
    })
}, {
    <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span>
})

<span class="hljs-keyword">const</span> <span class="hljs-title function_">startAnimate</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> digits = numList.<span class="hljs-property">value</span>;
    digitListRefs.<span class="hljs-property">value</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">element, i</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (element &amp;&amp; element.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.digit-list'</span>)) {
            <span class="hljs-keyword">const</span> list = element.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.digit-list'</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLElement</span>;
            <span class="hljs-keyword">const</span> targetDigit = <span class="hljs-built_in">parseInt</span>(digits[i], <span class="hljs-number">10</span>);
            <span class="hljs-keyword">const</span> targetY = -(<span class="hljs-number">20</span> + targetDigit) * <span class="hljs-number">50</span>;

            list.<span class="hljs-property">style</span>.<span class="hljs-property">transform</span> = <span class="hljs-string">`translateY(<span class="hljs-subst">${targetY}</span>px)`</span>;
        }
    });
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"num-statistic"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"num-statistic-content"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(_digit, index) in numList"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"index"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"digit-container"</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"`digit-container${index+1}`"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"digitListRefs"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"digit-list"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(_item, idx) in 10"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"idx"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"digit"</span>&gt;</span>{{ idx }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(_item, idx) in 10"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"`dup-${idx}`"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"digit"</span>&gt;</span>{{ idx }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(_item, idx) in 10"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"`dup2-${idx}`"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"digit"</span>&gt;</span>{{ idx }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"index === 1 || index === 4"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"num-split"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"`split-${index}`"</span>&gt;</span>,<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"less"</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.num-statistic-content</span> {
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">gap</span>: <span class="hljs-number">12px</span>;
}

<span class="hljs-selector-class">.digit-container1</span>,
<span class="hljs-selector-class">.digit-container2</span>,
<span class="hljs-selector-class">.digit-container3</span>,
<span class="hljs-selector-class">.digit-container4</span>,
<span class="hljs-selector-class">.digit-container5</span>,
<span class="hljs-selector-class">.digit-container6</span>,
<span class="hljs-selector-class">.digit-container7</span>,
<span class="hljs-selector-class">.digit-container8</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">36px</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">50px</span>;
    <span class="hljs-attribute">text-align</span>: center;
    <span class="hljs-attribute">line-height</span>: <span class="hljs-number">50px</span>;
    <span class="hljs-attribute">overflow</span>: hidden;
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#244193</span>;
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">24px</span>;
    <span class="hljs-attribute">font-weight</span>: bold;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;

    <span class="hljs-selector-class">.digit</span> {
        <span class="hljs-attribute">height</span>: <span class="hljs-number">50px</span>;
        <span class="hljs-attribute">display</span>: flex;
        <span class="hljs-attribute">align-items</span>: center;
        <span class="hljs-attribute">justify-content</span>: center;
    }
}

<span class="hljs-selector-class">.digit-container1</span> <span class="hljs-selector-class">.digit-list</span> {
    <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">1720ms</span> ease-in-out;
}

<span class="hljs-selector-class">.digit-container2</span> <span class="hljs-selector-class">.digit-list</span> {
    <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">1760ms</span> ease-in-out;
}

<span class="hljs-selector-class">.digit-container3</span> <span class="hljs-selector-class">.digit-list</span> {
    <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">1800ms</span> ease-in-out;
}

<span class="hljs-selector-class">.digit-container4</span> <span class="hljs-selector-class">.digit-list</span> {
    <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">1840ms</span> ease-in-out;
}

<span class="hljs-selector-class">.digit-container5</span> <span class="hljs-selector-class">.digit-list</span> {
    <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">1880ms</span> ease-in-out;
}

<span class="hljs-selector-class">.digit-container6</span> <span class="hljs-selector-class">.digit-list</span> {
    <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">1920ms</span> ease-in-out;
}

<span class="hljs-selector-class">.digit-container7</span> <span class="hljs-selector-class">.digit-list</span> {
    <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">1960ms</span> ease-in-out;
}

<span class="hljs-selector-class">.digit-container8</span> <span class="hljs-selector-class">.digit-list</span> {
    <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">2000ms</span> ease-in-out;
}

<span class="hljs-selector-class">.num-split</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">20px</span>;
    <span class="hljs-attribute">text-align</span>: center;
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">24px</span>;
    <span class="hljs-attribute">font-weight</span>: bold;
    <span class="hljs-attribute">line-height</span>: <span class="hljs-number">50px</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>最后非常感谢这位兄弟<code>@三个木base</code>的思路及源码，再次感谢！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TypeScript 5.0+ 重要新特性全面解析]]></title>    <link>https://juejin.cn/post/7572004684178473014</link>    <guid>https://juejin.cn/post/7572004684178473014</guid>    <pubDate>2025-11-13T09:39:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572004684178473014" data-draft-id="7571829879827349523" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TypeScript 5.0+ 重要新特性全面解析"/> <meta itemprop="keywords" content="TypeScript"/> <meta itemprop="datePublished" content="2025-11-13T09:39:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="西芹术士"/> <meta itemprop="url" content="https://juejin.cn/user/2700860856743672"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TypeScript 5.0+ 重要新特性全面解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2700860856743672/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    西芹术士
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:39:54.000Z" title="Thu Nov 13 2025 09:39:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文将详细介绍 TypeScript 自 5.0 版本以来的重要更新，帮助开发者了解并应用这些新特性来提升开发效率和代码质量。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">📅 TypeScript 5.0 (2023年3月)</h2>
<h3 data-id="heading-1">1. 装饰器（Decorators）正式支持</h3>
<p>TypeScript 5.0 正式支持了 ECMAScript Stage 3 的装饰器提案，这是一个里程碑式的更新。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 类装饰器</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">logged</span>(<span class="hljs-params">value: <span class="hljs-built_in">any</span>, context: ClassDecoratorContext</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">extends</span> value {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">...args: <span class="hljs-built_in">any</span>[]</span>) {
      <span class="hljs-variable language_">super</span>(...args);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`创建了 <span class="hljs-subst">${context.name}</span> 的实例`</span>);
    }
  };
}

<span class="hljs-meta">@logged</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }
}

<span class="hljs-comment">// 方法装饰器</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">log</span>(<span class="hljs-params">target: <span class="hljs-built_in">any</span>, context: ClassMethodDecoratorContext</span>) {
  <span class="hljs-keyword">const</span> methodName = <span class="hljs-title class_">String</span>(context.<span class="hljs-property">name</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-variable language_">this</span>: <span class="hljs-built_in">any</span>, ...args: <span class="hljs-built_in">any</span>[]</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`调用方法: <span class="hljs-subst">${methodName}</span>`</span>);
    <span class="hljs-keyword">return</span> target.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
  };
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Calculator</span> {
  <span class="hljs-meta">@log</span>
  <span class="hljs-title function_">add</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-keyword">return</span> a + b;
  }
}
</code></pre>
<h3 data-id="heading-2">2. const 类型参数</h3>
<p>允许在泛型中使用 <code>const</code> 修饰符，锁定类型为字面量类型。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 不使用 const</span>
<span class="hljs-function">function <span class="hljs-title">makeArray</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">arr: T[]</span>)</span> {
  <span class="hljs-keyword">return</span> arr;
}
<span class="hljs-keyword">const</span> arr1 = makeArray([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]); <span class="hljs-comment">// number[]</span>

<span class="hljs-comment">// 使用 const</span>
<span class="hljs-function">function <span class="hljs-title">makeConstArray</span>&lt;<span class="hljs-title">const</span> <span class="hljs-title">T</span>&gt;(<span class="hljs-params">arr: T[]</span>)</span> {
  <span class="hljs-keyword">return</span> arr;
}
<span class="hljs-keyword">const</span> arr2 = makeConstArray([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]); <span class="hljs-comment">// readonly [1, 2, 3]</span>
</code></pre>
<h3 data-id="heading-3">3. 枚举改进</h3>
<p>所有枚举成员现在都可以作为联合枚举使用。</p>
<pre><code class="hljs language-javascript" lang="javascript">enum <span class="hljs-title class_">Status</span> {
  <span class="hljs-title class_">Loading</span> = <span class="hljs-string">"loading"</span>,
  <span class="hljs-title class_">Success</span> = <span class="hljs-string">"success"</span>,
  <span class="hljs-title class_">Error</span> = <span class="hljs-string">"error"</span>
}

<span class="hljs-comment">// 可以直接用作类型</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleStatus</span>(<span class="hljs-params">status: Status</span>) {
  <span class="hljs-keyword">switch</span> (status) {
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">Status</span>.<span class="hljs-property">Loading</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-string">"加载中..."</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">Status</span>.<span class="hljs-property">Success</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-string">"成功！"</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">Status</span>.<span class="hljs-property">Error</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-string">"错误！"</span>;
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-4">📅 TypeScript 5.1 (2023年6月)</h2>
<h3 data-id="heading-5">1. get/set 访问器类型解耦</h3>
<p>允许 getter 和 setter 使用不同的类型，提供更灵活的 API 设计。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Thing</span> {
  <span class="hljs-meta">#size = 0;</span>

  <span class="hljs-comment">// getter 返回 number</span>
  <span class="hljs-function">get <span class="hljs-title">size</span><span class="hljs-params">()</span>: number {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.<span class="hljs-meta">#size;</span>
  }

  <span class="hljs-comment">// setter 可以接受 number | string</span>
  set <span class="hljs-built_in">size</span>(value: number | string) {
    <span class="hljs-keyword">this</span>.<span class="hljs-meta">#size = typeof value === <span class="hljs-string">'string'</span> ? parseInt(value) : value;</span>
  }
}

<span class="hljs-type">const</span> thing = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Thing</span>();
thing.size = <span class="hljs-string">"42"</span>; <span class="hljs-comment">// ✅ 可以传字符串</span>
console.<span class="hljs-built_in">log</span>(thing.size); <span class="hljs-comment">// 42 (number)</span>
</code></pre>
<h3 data-id="heading-6">2. 未定义返回函数的改进</h3>
<p>更好地处理返回 <code>undefined</code> 的函数。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 之前可能需要显式返回 undefined</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">doSomething</span>(<span class="hljs-params"/>): <span class="hljs-literal">undefined</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"做点什么"</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
}

<span class="hljs-comment">// 现在可以省略 return</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">doSomethingElse</span>(<span class="hljs-params"/>): <span class="hljs-literal">undefined</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"做点别的"</span>);
  <span class="hljs-comment">// 不需要显式 return</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-7">📅 TypeScript 5.2 (2023年8月)</h2>
<h3 data-id="heading-8">1. using 声明和显式资源管理</h3>
<p>支持 ECMAScript 的显式资源管理提案，自动清理资源。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 实现 Disposable 接口</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">FileHandle</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Disposable</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">file</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">filename: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">file</span> = filename;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`打开文件: <span class="hljs-subst">${filename}</span>`</span>);
  }

  [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">dispose</span>]() {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`关闭文件: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.file}</span>`</span>);
    <span class="hljs-comment">// 清理资源</span>
  }

  <span class="hljs-title function_">read</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`读取 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.file}</span> 的内容`</span>;
  }
}

<span class="hljs-comment">// 使用 using 声明</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">processFile</span>(<span class="hljs-params"/>) {
  using file = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileHandle</span>(<span class="hljs-string">"data.txt"</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(file.<span class="hljs-title function_">read</span>());
  <span class="hljs-comment">// 函数结束时自动调用 [Symbol.dispose]</span>
}
</code></pre>
<h3 data-id="heading-9">2. 装饰器元数据</h3>
<p>增强装饰器功能，支持元数据反射。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">setMetadata</span>(<span class="hljs-params">key: <span class="hljs-built_in">string</span>, value: <span class="hljs-built_in">any</span></span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">target: <span class="hljs-built_in">any</span>, context: DecoratorContext</span>) =&gt;</span> {
    context.<span class="hljs-property">metadata</span>[key] = value;
  };
}

<span class="hljs-meta">@setMetadata</span>(<span class="hljs-string">"version"</span>, <span class="hljs-string">"1.0"</span>)
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> {}
</code></pre>
<hr/>
<h2 data-id="heading-10">📅 TypeScript 5.3 (2023年11月)</h2>
<h3 data-id="heading-11">1. Import Attributes 支持</h3>
<p>支持导入断言的标准化语法。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 导入 JSON 文件</span>
<span class="hljs-keyword">import</span> data <span class="hljs-keyword">from</span> <span class="hljs-string">"./data.json"</span> <span class="hljs-keyword">with</span> { <span class="hljs-attr">type</span>: <span class="hljs-string">"json"</span> };

<span class="hljs-comment">// 导入 CSS 模块</span>
<span class="hljs-keyword">import</span> styles <span class="hljs-keyword">from</span> <span class="hljs-string">"./styles.css"</span> <span class="hljs-keyword">with</span> { <span class="hljs-attr">type</span>: <span class="hljs-string">"css"</span> };
</code></pre>
<h3 data-id="heading-12">2. switch(true) 收窄</h3>
<p>改进 <code>switch(true)</code> 语句中的类型收窄。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">processValue</span>(<span class="hljs-params">value: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span></span>) {
  <span class="hljs-keyword">switch</span> (<span class="hljs-literal">true</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">"string"</span>:
      <span class="hljs-comment">// value 被收窄为 string</span>
      <span class="hljs-keyword">return</span> value.<span class="hljs-title function_">toUpperCase</span>();
    <span class="hljs-keyword">case</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">"number"</span>:
      <span class="hljs-comment">// value 被收窄为 number</span>
      <span class="hljs-keyword">return</span> value.<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>);
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-13">📅 TypeScript 5.4 (2024年3月)</h2>
<h3 data-id="heading-14">1. NoInfer 工具类型</h3>
<p>防止类型推断在特定位置发生，提供更精确的类型控制。</p>
<pre><code class="hljs language-ini" lang="ini">function createMap&lt;T&gt;(
  keys: T<span class="hljs-section">[]</span>,
  defaultValue: NoInfer&lt;T&gt;
): Map&lt;T, T&gt; {
  const <span class="hljs-attr">map</span> = new Map&lt;T, T&gt;()<span class="hljs-comment">;</span>
  keys.forEach(<span class="hljs-attr">key</span> =&gt; map.set(key, defaultValue))<span class="hljs-comment">;</span>
  return map<span class="hljs-comment">;</span>
}

// T 只从 keys 推断，不从 defaultValue 推断
const <span class="hljs-attr">map1</span> = createMap([<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>], <span class="hljs-string">"default"</span>)<span class="hljs-comment">; // Map&lt;string, string&gt;</span>
const <span class="hljs-attr">map2</span> = createMap([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>], <span class="hljs-number">0</span>)<span class="hljs-comment">; // Map&lt;number, number&gt;</span>
</code></pre>
<h3 data-id="heading-15">2. Object.groupBy 和 Map.groupBy 支持</h3>
<p>支持新的 JavaScript 分组方法。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">const</span> <span class="hljs-string">people</span> <span class="hljs-string">=</span> [
  { <span class="hljs-attr">name:</span> <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">age:</span> <span class="hljs-number">25</span> },
  { <span class="hljs-attr">name:</span> <span class="hljs-string">"Bob"</span>, <span class="hljs-attr">age:</span> <span class="hljs-number">30</span> },
  { <span class="hljs-attr">name:</span> <span class="hljs-string">"Charlie"</span>, <span class="hljs-attr">age:</span> <span class="hljs-number">25</span> }
]<span class="hljs-string">;</span>

<span class="hljs-string">const</span> <span class="hljs-string">grouped</span> <span class="hljs-string">=</span> <span class="hljs-string">Object.groupBy(people,</span> <span class="hljs-string">person</span> <span class="hljs-string">=&gt;</span> <span class="hljs-string">person.age);</span>
<span class="hljs-string">//</span> { <span class="hljs-attr">25:</span> [{<span class="hljs-attr">name:</span> <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">age:</span> <span class="hljs-number">25</span>}, {<span class="hljs-attr">name:</span> <span class="hljs-string">"Charlie"</span>, <span class="hljs-attr">age:</span> <span class="hljs-number">25</span>}], 
<span class="hljs-string">//</span>   <span class="hljs-attr">30:</span> [{<span class="hljs-attr">name:</span> <span class="hljs-string">"Bob"</span>, <span class="hljs-attr">age:</span> <span class="hljs-number">30</span>}] }
</code></pre>
<hr/>
<h2 data-id="heading-16">📅 TypeScript 5.5 (2024年6月)</h2>
<h3 data-id="heading-17">1. 推断类型谓词（Inferred Type Predicates）</h3>
<p>自动推断函数是否为类型守卫，无需手动编写类型谓词。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 之前需要显式声明类型谓词</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isString</span>(<span class="hljs-params">value: <span class="hljs-built_in">unknown</span></span>): value is <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">"string"</span>;
}

<span class="hljs-comment">// 现在 TypeScript 可以自动推断</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isStringAuto</span>(<span class="hljs-params">value: <span class="hljs-built_in">unknown</span></span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">"string"</span>;
}

<span class="hljs-keyword">const</span> <span class="hljs-attr">values</span>: <span class="hljs-built_in">unknown</span>[] = [<span class="hljs-string">"hello"</span>, <span class="hljs-number">42</span>, <span class="hljs-string">"world"</span>];
<span class="hljs-comment">// TypeScript 能识别 filter 后的类型</span>
<span class="hljs-keyword">const</span> strings = values.<span class="hljs-title function_">filter</span>(isStringAuto); <span class="hljs-comment">// string[]</span>
</code></pre>
<h3 data-id="heading-18">2. 常量索引访问的控制流收窄</h3>
<p>改进对常量索引访问的类型分析。</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">function</span> processData(data: { status: <span class="hljs-string">"success"</span>; value: number } | { status: <span class="hljs-string">"error"</span>; <span class="hljs-keyword">error</span>: <span class="hljs-type">string</span> }) {
  <span class="hljs-keyword">const</span> <span class="hljs-keyword">key</span> = <span class="hljs-string">"status"</span> <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>;
  
  <span class="hljs-keyword">if</span> (data[<span class="hljs-keyword">key</span>] === <span class="hljs-string">"success"</span>) {
    // data 被正确收窄为 { status: <span class="hljs-string">"success"</span>; value: number }
    console.log(data.value);
  } <span class="hljs-keyword">else</span> {
    // data 被正确收窄为 { status: <span class="hljs-string">"error"</span>; <span class="hljs-keyword">error</span>: <span class="hljs-type">string</span> }
    console.log(data.<span class="hljs-keyword">error</span>);
  }
}
</code></pre>
<h3 data-id="heading-19">3. 正则表达式语法检查</h3>
<p>在字符串字面量中检查正则表达式语法错误。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// ❌ 编译时报错：无效的正则表达式</span>
<span class="hljs-type">const</span> invalidRegex = /[/;

<span class="hljs-comment">// ✅ 正确的正则表达式</span>
<span class="hljs-type">const</span> validRegex = /[/;
</code></pre>
<h3 data-id="heading-20">4. 数组过滤增强</h3>
<p>更智能的数组 <code>filter</code> 方法类型推断。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-attr">mixed</span>: (<span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span> | <span class="hljs-literal">null</span>)[] = [<span class="hljs-string">"hello"</span>, <span class="hljs-number">42</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">"world"</span>, <span class="hljs-literal">null</span>];

<span class="hljs-comment">// 自动推断过滤后的类型</span>
<span class="hljs-keyword">const</span> nonNull = mixed.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x !== <span class="hljs-literal">null</span>); <span class="hljs-comment">// (string | number)[]</span>
<span class="hljs-keyword">const</span> strings = mixed.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> <span class="hljs-keyword">typeof</span> x === <span class="hljs-string">"string"</span>); <span class="hljs-comment">// string[]</span>
</code></pre>
<hr/>
<h2 data-id="heading-21">📅 TypeScript 5.6 (2024年9月)</h2>
<h3 data-id="heading-22">1. 可变元组支持</h3>
<p>增强的元组类型功能，支持更灵活的元组操作。</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// 可变元组类型</span>
<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">Prefixed&lt;T</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">unknown</span>[]<span class="hljs-title">&gt;</span> </span>= [string, ...<span class="hljs-type">T</span>];

<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">Example1</span> </span>= <span class="hljs-type">Prefixed</span>&lt;[number, boolean]&gt;; <span class="hljs-comment">// [string, number, boolean]</span>
<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">Example2</span> </span>= <span class="hljs-type">Prefixed</span>&lt;[]&gt;; <span class="hljs-comment">// [string]</span>
</code></pre>
<hr/>
<h2 data-id="heading-23">📅 TypeScript 5.7 (2024年11月)</h2>
<h3 data-id="heading-24">1. ES2024 特性集成</h3>
<p>完整支持最新的 ECMAScript 2024 特性。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 支持 Promise.withResolvers</span>
<span class="hljs-keyword">const</span> { promise, resolve, reject } = <span class="hljs-title class_">Promise</span>.<span class="hljs-property">withResolvers</span>&lt;<span class="hljs-built_in">number</span>&gt;();

<span class="hljs-comment">// 支持 Array.fromAsync</span>
<span class="hljs-keyword">const</span> asyncIterable = <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span>* () {
  <span class="hljs-keyword">yield</span> <span class="hljs-number">1</span>;
  <span class="hljs-keyword">yield</span> <span class="hljs-number">2</span>;
  <span class="hljs-keyword">yield</span> <span class="hljs-number">3</span>;
};
<span class="hljs-keyword">const</span> array = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">fromAsync</span>(<span class="hljs-title function_">asyncIterable</span>());
</code></pre>
<h3 data-id="heading-25">2. 模块解析改进</h3>
<p>更好的路径重写和模块解析能力。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// tsconfig.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"@/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./src/*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"@components/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./src/components/*"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h2 data-id="heading-26">📅 TypeScript 5.8 (2025年3月)</h2>
<h3 data-id="heading-27">1. 返回表达式中的分支类型检查增强</h3>
<p>改进对返回语句中条件表达式的类型检查。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getValue</span>(<span class="hljs-params">condition: <span class="hljs-built_in">boolean</span></span>): <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span> {
  <span class="hljs-comment">// TypeScript 5.8 更精确地推断返回类型</span>
  <span class="hljs-keyword">return</span> condition 
    ? <span class="hljs-string">"string value"</span>  <span class="hljs-comment">// string</span>
    : <span class="hljs-number">42</span>;             <span class="hljs-comment">// number</span>
}
</code></pre>
<h3 data-id="heading-28">2. 稳定的 <code>--module node18</code> 标志</h3>
<p>为 Node.js 18+ 用户提供稳定的模块系统支持。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// tsconfig.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node18"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"moduleResolution"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node18"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-29">3. 直接执行支持</h3>
<p>简化 TypeScript 代码的直接执行流程，提升开发体验。</p>
<hr/>
<h2 data-id="heading-30">🎯 总结</h2>
<p>TypeScript 5.x 系列版本带来了众多重要特性：</p>
<h3 data-id="heading-31">🔑 核心亮点</h3>
<ol>
<li><strong>装饰器标准化</strong> - 正式支持 ECMAScript 装饰器</li>
<li><strong>资源管理</strong> - <code>using</code> 声明自动清理资源</li>
<li><strong>类型推断增强</strong> - 自动推断类型守卫、更好的控制流分析</li>
<li><strong>开发体验</strong> - 正则语法检查、更好的错误提示</li>
<li><strong>ECMAScript 对齐</strong> - 紧跟最新 JavaScript 标准</li>
</ol>
<h3 data-id="heading-32">📊 升级建议</h3>
<ul>
<li><strong>从 4.x 升级到 5.x</strong>: 强烈推荐，性能和类型安全性大幅提升</li>
<li><strong>渐进式采用</strong>: 新特性可以逐步引入，不会破坏现有代码</li>
<li><strong>关注装饰器</strong>: 如果使用旧版装饰器，需要迁移到新语法</li>
</ul>
<h3 data-id="heading-33">🔗 参考资源</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.typescriptlang.org%2Fdocs%2Fhandbook%2Frelease-notes%2Foverview.html" target="_blank" title="https://www.typescriptlang.org/docs/handbook/release-notes/overview.html" ref="nofollow noopener noreferrer">TypeScript 官方发布日志</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2FTypeScript" target="_blank" title="https://github.com/microsoft/TypeScript" ref="nofollow noopener noreferrer">TypeScript GitHub 仓库</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.typescriptlang.org%2Fplay" target="_blank" title="https://www.typescriptlang.org/play" ref="nofollow noopener noreferrer">TypeScript 演练场</a></li>
</ul>
<hr/>
<p><strong>你最喜欢哪个新特性？欢迎在评论区讨论！</strong> 💬</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[能让 GitHub 删除泄露的苹果源码还有 8000 多个相关仓库的 DMCA 是什么？]]></title>    <link>https://juejin.cn/post/7572002432450756617</link>    <guid>https://juejin.cn/post/7572002432450756617</guid>    <pubDate>2025-11-13T09:51:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572002432450756617" data-draft-id="7572016447804588058" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="能让 GitHub 删除泄露的苹果源码还有 8000 多个相关仓库的 DMCA 是什么？"/> <meta itemprop="keywords" content="前端,JavaScript,React.js"/> <meta itemprop="datePublished" content="2025-11-13T09:51:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冴羽"/> <meta itemprop="url" content="https://juejin.cn/user/712139234359182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            能让 GitHub 删除泄露的苹果源码还有 8000 多个相关仓库的 DMCA 是什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712139234359182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冴羽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:51:35.000Z" title="Thu Nov 13 2025 09:51:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 源码泄露</h2>
<p>上周苹果 App Store 前端源码泄露，因其生产环境忘记关闭 Sourcemap，被用户下载了源码，上传到 Github。短短几天就已经 Fork 和 Star 超 5k。</p>
<p>当然现在仓库已经被 ban 了，当你打开仓库的时候，GitHub 会提示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bec1ea4ab594ecaa1dd2d35a8e140b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763632294&amp;x-signature=Pxg4NjG37hRvG4z1T3sbXiU6Qg8%3D" alt="" loading="lazy"/></p>
<p>千万不要以为自己有 fork 就安全了，fork 的仓库也一同被删除了，据说删了 8000 多个相关仓库，足以看到当时大家凑热闹的热情 😂</p>
<h2 data-id="heading-1">2. 还想找源码？</h2>
<p>如果你还想看看泄露的代码，GitHub 可能已经不好找了，但国内的 Gitee 上依然可以找到。</p>
<p>在 Gitee 搜索 <code>apps.apple.com</code> 可以看到：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c44dbffdc9994eb4b1d67ad624f8f599~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763632294&amp;x-signature=64KttuLffBcEytf8HbqIhUj3Zzg%3D" alt="" loading="lazy"/></p>
<p>如果你想找可运行的版本，可以搜索 <code>test-apps.apple.com-main</code>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd633b2cd4cd44ba9b3985e12dd4c5bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763632294&amp;x-signature=SfoMOf2RKmzdSMDay6E1I2xO14k%3D" alt="" loading="lazy"/></p>
<p>不过说是可运行，其实只是本地起个服务静态预览：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/244729dcf28740e68611784db38cae44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763632294&amp;x-signature=nzyXhkxI7G3uIMcbuJntbpHEwyg%3D" alt="" loading="lazy"/></p>
<p>如果要从源码运行，因为仓库引用了私有包，相对来说还是难处理的。</p>
<p>关于源码，还可以阅读我的这篇《看了下昨日泄露的苹果 App Store 源码……》</p>
<h2 data-id="heading-2">3. 类似事件</h2>
<p>不过这次泄露的只是苹果 App Store 的前端源码，对业务并没有什么影响，仓库在几天后才删除。如果泄露的后端代码，那可能就要紧张很多了。</p>
<p>其实这事之前也发生过，2019 年的时候，B 站的后端源码就被泄露了，10 点上传的源码，16 点大量吃瓜群众涌入，17 点就因 DMCA 被 ban 了。这事之后，很多仿 B 站架构的项目如雨后春笋，甚至还掀起了一股学习 Go 语言的热潮 😂</p>
<p>大家在源码中更是挖了不少内容，比如用户名密码被硬编码在代码中，暗箱操作抽奖成功率，代码不规范，发现在代码里画画、写诗、画颜文字、吐槽甚至贴广告，一度导致 B 站股价下跌。</p>
<p>相比之下，苹果这次的后果很轻了，而且源码里也没什么画画、写诗，整体是比较规范有序的。</p>
<h2 data-id="heading-3">4. DMCA</h2>
<p>说回 DMCA，全称 Digital Millennium Copyright Act，中文翻译为“数字千年版权法”，又称“千禧年数字版权法”，是美国 1998 年颁布的联邦法律，旨在应对数字时代的著作权保护问题。</p>
<p>其主要目的是保护数字内容（如音乐、电影、文字、图像等）的著作权，并为在线服务提供商（如 Google 等）提供了免除因用户上传侵权内容而产生的金钱赔偿责任的安全港规则。<strong>这意味着在线服务提供商在收到版权所有者的侵权通知后，若能及时移除侵权内容，则可免受法律追责。</strong></p>
<p><strong>GitHub 有专门的仓库记录 DMCA 的公开通知：</strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgithub%2Fdmca" target="_blank" title="https://github.com/github/dmca" ref="nofollow noopener noreferrer"><strong>https://github.com/github/dmca</strong></a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23d7515169ed4fe9a92ff9a980d1155a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763632294&amp;x-signature=JTeq14xDeYUQ041FCM5PdSjmL8U%3D" alt="" loading="lazy"/></p>
<p>从中可以翻到 11 月 7 日的 apple 仓库相关的通知：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87bd1d2974c1470b8ef1009ff4612d6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763632294&amp;x-signature=y8zV3JrOfBNzdgvd%2Bt2jSJp71FQ%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[下一代桌面应用框架 - Tauri 尝鲜]]></title>    <link>https://juejin.cn/post/7571815997067935784</link>    <guid>https://juejin.cn/post/7571815997067935784</guid>    <pubDate>2025-11-13T09:51:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571815997067935784" data-draft-id="7571768210716082191" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="下一代桌面应用框架 - Tauri 尝鲜"/> <meta itemprop="keywords" content="前端框架,Electron"/> <meta itemprop="datePublished" content="2025-11-13T09:51:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="字节逆旅"/> <meta itemprop="url" content="https://juejin.cn/user/2471357871561214"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            下一代桌面应用框架 - Tauri 尝鲜
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2471357871561214/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    字节逆旅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:51:51.000Z" title="Thu Nov 13 2025 09:51:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>之前我写过一篇<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FSKmJoeDJHymMLUj1QR4V7A" target="_blank" title="https://mp.weixin.qq.com/s/SKmJoeDJHymMLUj1QR4V7A" ref="nofollow noopener noreferrer">文章</a>，介绍了<code>pake</code>这个小玩具，今天我来说一说它的亲爹<code>Tauri</code>。</p>
<hr/>
<p>做过桌面应用打包的前端同学，对 <code>Electron</code> 的名声肯定是如雷贯耳。它可以用我们熟悉的 Web 技术构建跨平台的桌面应用，VS Code、Slack、Discord 等众多知名应用都是基于它构建的。然而，<code>Electron</code> 的“缺点”也很明显：打包体积大、内存占用高，特别是在弱网传输的时候，这个毛病影响很大。。</p>
<p>接下来，我来介绍一个正在悄摸摸崛起的挑战者——<code>Tauri</code>。我掐指算过了，它会是下一代桌面应用框架！</p>
<h3 data-id="heading-0">Tauri 是什么？</h3>
<p>我先简单介绍一下 <code>tauri</code> 框架。
<code>Tauri</code> 是一个为构建更小、更快、更安全的桌面应用程序而设计的框架。它和 <code>Electron</code> 一样，允许你使用任何前端框架（如 React、Vue、Svelte 或原生 HTML/CSS/JS）来构建用户界面。
但它的核心思想与 <code>Electron</code> 有本质区别：</p>
<ol>
<li><strong>更小的体积</strong>：<code>Electron</code> 内置了一个完整的 Chromium 浏览器，所以每个应用都至少要带上 100MB+ 的基础文件。而 <code>Tauri</code> 则使用操作系统自带的 WebView（Windows 上的 Webview2，macOS 上的 WebKit，Linux 上的 WebKitGTK）。这意味着你的应用本身不包含浏览器，体积可以轻松做到 10MB 以下，甚至更小。</li>
<li><strong>更低的资源占用</strong>：由于不自带浏览器，<code>Tauri</code> 应用的内存占用和 CPU 消耗远低于 <code>Electron</code> 应用，运行起来更加轻快。</li>
<li><strong>后端使用 Rust</strong>：<code>Tauri</code> 的后端核心是用 Rust 编写的。Rust 以其高性能、内存安全和并发性著称，这为桌面应用提供了坚实、安全的后端基础。你可以通过简单的 JS API 调用 Rust 代码，处理文件系统、执行 Shell 命令等操作，既安全又高效。</li>
<li><strong>安全优先</strong>：<code>Tauri</code> 默认采用“权限最小化”原则。你需要在一个叫 <code>allowlist</code>（允许列表）的配置文件中，明确开启你的应用需要使用的 API（如文件读写、网络请求等），这大大降低了应用的安全风险。
总而言之，<code>Tauri</code> 用“借力”的方式，解决了 <code>Electron</code> 最大的体积和性能问题，同时用 Rust 提供了一个强大而安全的后端，这正是它被称为“下一代”框架的原因。目前<code>Tauri</code>版本已经到了2.0，本文后面用的也是这个版本。</li>
</ol>
<hr/>
<h3 data-id="heading-1">Windows 系统安装 Tauri</h3>
<p>接下来我带你在 <code>windows</code> 系统安装一下 <code>tauri</code> 框架，后面有空我再介绍一下在 <code>ubuntu</code> 系统中的安装方法。
在开始之前，<code>Tauri</code> 需要两个核心依赖：Rust 语言环境和 C++ 编译工具链。</p>
<h4 data-id="heading-2">1. 安装 Rust</h4>
<p><code>Tauri</code> 的后端是 Rust，所以首先需要安装 Rust。
访问官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Frust-lang.org%2Ftools%2Finstall%2F" target="_blank" title="https://rust-lang.org/tools/install/" ref="nofollow noopener noreferrer">rust-lang.org/tools/insta…</a>
下载并运行 <code>rustup-init.exe</code>，按照提示安装即可。安装完成后，它会提示你重启终端或重新加载环境变量。</p>
<h4 data-id="heading-3">2. 安装 Microsoft C++ 生成工具</h4>
<p>在 Windows 上编译 Rust 和一些原生 Node.js 模块需要 C++ 构建工具。
访问官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fvisualstudio.microsoft.com%2Fzh-hans%2Fvisual-cpp-build-tools%2F" target="_blank" title="https://visualstudio.microsoft.com/zh-hans/visual-cpp-build-tools/" ref="nofollow noopener noreferrer">visualstudio.microsoft.com/zh-hans/vis…</a>
下载“Microsoft C++ 生成工具”。在安装程序中，只用勾选“使用 C++ 的桌面开发”，然后安装即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8f0ef17883b48b6aef4975df231852c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6YCG5peF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763632882&amp;x-signature=HCc25Mxi1xkq2mEF%2F5DFzN7juN0%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-4">3. 确认环境</h4>
<p>打开一个新的终端（CMD 或 PowerShell），输入以下命令，如果都能正常显示版本号，说明环境就绪了。</p>
<pre><code class="hljs language-bash" lang="bash">rustc --version
npm --version
</code></pre>
<hr/>
<h3 data-id="heading-5">Tauri 初体验：打包一个远程 URL</h3>
<h4 data-id="heading-6">1. 准备一个前端项目</h4>
<p>我直接把一个项目复制过来，把代码管理相关文件夹删除，依赖也可以删除，然后存在一个文件夹里，就用这个项目来试下效果。</p>
<ol start="3">
<li>在项目根目录初始化 <code>npm</code> 项目：
<pre><code class="hljs language-bash" lang="bash">npm init -y
</code></pre>
这会生成一个 <code>package.json</code> 文件。</li>
</ol>
<h4 data-id="heading-7">2. 初始化 Tauri</h4>
<p>把这个实验项目用vscode打开，然后执行：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 Tauri CLI 作为开发依赖</span>
npm install -D @tauri-apps/cli@latest 
<span class="hljs-comment"># 初始化 Tauri 项目</span>
npm run tauri init
</code></pre>
<p>执行 <code>init</code> 命令时，它会问你几个问题，比如应用名称、窗口标题等，一路回车使用默认值即可。</p>
<p>这会创建一个 <code>src-tauri</code> 目录，这就是 <code>Tauri</code> 框架的后端部分。里面包含了 Rust 代码和关键的配置文件 <code>tauri.conf.json</code>。</p>
<h4 data-id="heading-8">3. 尝鲜 Tauri</h4>
<p>安装好了之后，咱先尝个鲜，把本地跑起来的应用打包进去呢？
看起来，如果只是打包一个url，这个包会相当的小。如果我把这个前端应用在服务器上用nginx部署，然后再用<code>tauri</code>打包，会不会比较有意思？
是的，这是一个非常有趣的应用场景！你可以创建一个“壳应用”，它本身不包含任何业务逻辑，只是加载一个远程的 Web 地址。这样做的好处是：</p>
<ul>
<li><strong>体积极小</strong>：应用本身只有几 MB，用户下载飞快。</li>
<li><strong>热更新</strong>：你只需要更新服务器上的网页，所有用户的桌面应用内容就自动更新了，无需重新分发安装包。
要实现这个，只需在 <code>tauri.conf.json</code> 配置文件中修改 <code>window.url</code> 字段：</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// src-tauri/tauri.conf.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"devUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://your-nginx-deployed-app.com"</span> <span class="hljs-comment">// 改成你的网址</span>
      <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>不过，这种方式的缺点是应用部署必须得配一个nginx，安装过程不够简单，有点拖泥带水。</p>
<hr/>
<h3 data-id="heading-9">Tauri 实战：打包本地前端应用</h3>
<p>所以，我依然想用tauri打包一个包含所有前端应用内容的本地包，不依赖于url。来吧！
我带你创建一个完整的前端项目并将其打包成一个独立的桌面应用。</p>
<h4 data-id="heading-10">1. 修改配置</h4>
<p>前面只是尝鲜，只用到<code>devUrl</code>这个配置。接下来将是最关键的一步！你需要根据你的项目结构，修改 <code>src-tauri/tauri.conf.json</code> 文件。我这里给出一个配置文件的模板，里面有详细说明：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"$schema"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"../node_modules/@tauri-apps/cli/config.schema.json"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"productName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Tauri Demo"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.1.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 这里要注意，会有一些格式要求，按提示改就行</span>
  <span class="hljs-attr">"identifier"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"com.tauri.demo"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"beforeDevCommand"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run dev"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"beforeBuildCommand"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pm run build"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">// 告诉 Tauri 你的前端静态文件（HTML, JS, CSS）在哪个目录</span>
    <span class="hljs-attr">"frontendDist"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"../dist"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"app"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"windows"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"label"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"main"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 给窗口一个唯一的 label</span>
        <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Tauri Demo"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"width"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">800</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"height"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">600</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"resizable"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"fullscreen"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"security"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"csp"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span> <span class="hljs-comment">// 内容安全策略，开发阶段可以设为 null</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"bundle"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"active"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"targets"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"all"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"icon"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"icons/32x32.png"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"icons/128x128.png"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"icons/128x128@2x.png"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"icons/icon.icns"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"icons/icon.ico"</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"plugins"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span> <span class="hljs-comment">// 插件配置，后面会用到</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>关键点解释</strong>：</p>
<ul>
<li><code>frontendDist</code>: 这是 Tauri 2.0 的新字段，替代了旧版的 <code>distDir</code>。它指向你构建完成后的前端资源目录。对于vue项目，直接指向根目录 <code>"../dist"</code> 即可。</li>
<li><code>beforeDevCommand</code> / <code>beforeBuildCommand</code>: 意思是在执行  <code>Tauri</code>的构建之前，会执行这些项目本身的 <code>npm run dev</code> 或 <code>npm run build</code> 脚本。</li>
<li><code>app.windows</code>: 窗口配置现在被放在 <code>app</code> 对象下。给窗口加了一个 <code>label: "main"</code>，这在权限配置时会用到。</li>
<li><code>plugins</code>: Tauri 2.0 的核心功能（如文件系统、Shell）都通过插件提供。需要在这里声明使用的插件。</li>
</ul>
<h4 data-id="heading-11">2. 开发与运行</h4>
<p>配置完成后，就可以启动开发模式了。直接运行即可：</p>
<pre><code class="hljs language-bash" lang="bash">npm run tauri dev
</code></pre>
<p>这会先执行<code>npm run dev</code>，然后编译 Rust 后端，然后直接弹出一个桌面窗口，里面加载的就是你的 <code>index.html</code> 页面。当你修改项目文件并保存时，窗口会自动刷新，这就是热重载。</p>
<h4 data-id="heading-12">3. 构建最终安装包</h4>
<p>当你对应用满意后，就可以执行构建命令了：</p>
<pre><code class="hljs language-bash" lang="bash">npm run tauri build
</code></pre>
<p>下面这张图是执行<code>npm run tauri:build</code>后的效果，它会先执行<code>npm run build</code>，构建本地的打包文件，然后再从dist文件夹下面获取静态文件并打包为最终包。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4430943ef5d040acafb88e8f7d94c346~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6YCG5peF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763632882&amp;x-signature=z3d1yFl74flVUbs4aVcBDLb8qAk%3D" alt="" loading="lazy"/></p>
<p>构建完成后，你可以在 <code>src-tauri/target/release/bundle/</code> 目录下找到生成的安装包。在 Windows 上，你会看到一个 <code>.msi</code> 安装文件和一个免安装的 <code>.exe</code> 文件。这个 <code>.exe</code> 文件就是我们的最终成果，体积非常小，可以分发给用户直接运行！</p>
<hr/>
<h3 data-id="heading-13">总结</h3>
<p><code>Tauri</code> 以其轻量、高性能和高安全性的特性，为前端开发者打开了一扇通往现代桌面应用开发的新大门。虽然生态和社区相比 <code>Electron</code> 还在成长中，但其技术理念的先进性已经吸引了大量关注。如果你正准备开发一款桌面应用，或者对 <code>Electron</code> 的性能和体积感到困扰，不妨来尝一尝 <code>Tauri</code> 这道“新菜”，相信它会给你带来惊喜！</p>
<hr/>
<p>后续，我将探索<code>Tauri</code>框架的<code>IPC</code>通信，给应用增加与后端通信的能力，敬请期待。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在Android平台上使用Three.js优雅的加载3D模型]]></title>    <link>https://juejin.cn/post/7571808096937295913</link>    <guid>https://juejin.cn/post/7571808096937295913</guid>    <pubDate>2025-11-13T09:54:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571808096937295913" data-draft-id="7571829879826989075" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在Android平台上使用Three.js优雅的加载3D模型"/> <meta itemprop="keywords" content="Android,前端,three.js"/> <meta itemprop="datePublished" content="2025-11-13T09:54:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="onthewaying"/> <meta itemprop="url" content="https://juejin.cn/user/360295542299479"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在Android平台上使用Three.js优雅的加载3D模型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/360295542299479/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    onthewaying
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:54:09.000Z" title="Thu Nov 13 2025 09:54:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、Three.js是什么？</h2>
<p>Three.js是一个基于WebGL（Web Graphics Library）的3D图形渲染库，因为浏览器里最底层的3D API是WebGL。直接写会像写 OpenGL一样复杂，繁琐。<strong>Three.js 就是 WebGL 的封装层</strong>，提供了更高层次的接口，让你用几行代码就能创建出复杂的 3D 场景。</p>
<h2 data-id="heading-1">二、Three.js的核心概念</h2>
<h3 data-id="heading-2">1.Scene（场景）</h3>
<p>这是一个容器，一个无限大的虚拟空间。你之后创建的所有物体、光源、相机都必须被添加到这个场景中。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> scene = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Scene</span>();
</code></pre>
<h3 data-id="heading-3">2.Camera（相机）</h3>
<p>它决定了我们从哪个角度、以何种视野去观察这个场景。最常用的是<strong>透视相机 PerspectiveCamera</strong>，它模拟了人眼的视觉效果（近大远小）。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> camera = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PerspectiveCamera</span>(<span class="hljs-number">75</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">1000</span>);
</code></pre>
<h3 data-id="heading-4">3.WebGLRenderer（渲染器）</h3>
<p>渲染器会根据相机的位置和视野，将场景中的内容计算并绘制到一个HTML的元素上。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> renderer = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">WebGLRenderer</span>({ <span class="hljs-attr">antialias</span>: <span class="hljs-literal">true</span> }); <span class="hljs-comment">// antialias开启抗锯齿</span>
renderer.<span class="hljs-title function_">setSize</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>);
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(renderer.<span class="hljs-property">domElement</span>); <span class="hljs-comment">// 将canvas添加到页面</span>
</code></pre>
<h3 data-id="heading-5">4.OrbitControls（控制器）</h3>
<p>控制器可以让用户用鼠标或触摸来旋转、缩放、平移相机。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> controls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrbitControls</span>(camera, renderer.<span class="hljs-property">domElement</span>);
controls.<span class="hljs-property">enableDamping</span> = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 启用阻尼效果，使旋转更平滑</span>
controls.<span class="hljs-title function_">update</span>();
</code></pre>
<h3 data-id="heading-6">5.Light光源</h3>
<p>模拟自然光照、阴影、反光等效果</p>
<ul>
<li><strong>环境光 AmbientLight：</strong>  提供一种无方向的、均匀的基础光照，确保场景中最暗的地方也不是纯黑。</li>
<li><strong>平行光 DirectionalLight：</strong>  模拟像太阳光一样的效果，从一个方向平行照射过来，可以产生阴影。</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> ambientLight = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">AmbientLight</span>(<span class="hljs-number">0xffffff</span>, <span class="hljs-number">0.5</span>); <span class="hljs-comment">// 颜色, 强度</span>
scene.<span class="hljs-title function_">add</span>(ambientLight);

<span class="hljs-keyword">const</span> directionalLight = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">DirectionalLight</span>(<span class="hljs-number">0xffffff</span>, <span class="hljs-number">1</span>);
directionalLight.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">7</span>); <span class="hljs-comment">// 设置光源位置</span>
scene.<span class="hljs-title function_">add</span>(directionalLight);
</code></pre>
<h2 data-id="heading-7">三、实战案例</h2>
<p>核心分4大块：</p>
<p>1.Android原生：作为宿主，负责创建和管理WebView，处理原生UI交互，并准备3D模型文件（可以是本地，也可以是网络上获取的）。</p>
<p>2.WebView:负责加载本地的HTML和JavaScript文件。</p>
<p>3.JavaScript Bridge (@JavascriptInterface):这是原生代码与WebView中JavaScript代码双向通信的通道。</p>
<p>4.Assets:存放我们的index.html、Three.js库文件、模型文件以及核心的渲染逻辑main.js。</p>
<p>完整代码如下：</p>
<p>index.html主要是搭建一个网页环境，用于加载和执行main.js。</p>
<pre><code class="hljs language-js" lang="js">&lt;!<span class="hljs-variable constant_">DOCTYPE</span> html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"&gt;
    &lt;title&gt;Three.js on Android&lt;/title&gt;
    &lt;style&gt;
        body { margin: 0; overflow: hidden; }
        canvas { display: block; }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;script type="importmap"&gt;
    {
        "imports": {
            "three": "https://unpkg.com/three@0.158.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/"
        }
    }
&lt;/script&gt;

&lt;script type="module" src="./main.js"&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>main.js主要处理3D场景的创建、物体添加、动画循环等核心逻辑。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'three'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">GLTFLoader</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'three/addons/loaders/GLTFLoader.js'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">OrbitControls</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'three/addons/controls/OrbitControls.js'</span>;

<span class="hljs-comment">//创建场景</span>
<span class="hljs-keyword">const</span> scene = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Scene</span>();
scene.<span class="hljs-property">background</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Color</span>(<span class="hljs-number">0xeeeeee</span>); <span class="hljs-comment">// 设置背景色</span>

<span class="hljs-comment">//创建相机</span>
<span class="hljs-keyword">const</span> camera = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PerspectiveCamera</span>(<span class="hljs-number">75</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">1000</span>); <span class="hljs-comment">// 75:场景范围</span>
camera.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>);

<span class="hljs-comment">//创建渲染器</span>
<span class="hljs-keyword">const</span> renderer = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">WebGLRenderer</span>({ <span class="hljs-attr">antialias</span>: <span class="hljs-literal">true</span> });
renderer.<span class="hljs-title function_">setSize</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>);
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(renderer.<span class="hljs-property">domElement</span>); <span class="hljs-comment">// renderer.domElement 本质是canvas</span>

<span class="hljs-comment">//添加光源</span>
<span class="hljs-keyword">const</span> ambientLight = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">AmbientLight</span>(<span class="hljs-number">0xffffff</span>, <span class="hljs-number">0.5</span>); <span class="hljs-comment">// 环境光</span>
scene.<span class="hljs-title function_">add</span>(ambientLight);

<span class="hljs-keyword">const</span> directionalLight = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">DirectionalLight</span>(<span class="hljs-number">0xffffff</span>, <span class="hljs-number">1</span>); <span class="hljs-comment">// 平行光</span>
directionalLight.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">7.5</span>);
scene.<span class="hljs-title function_">add</span>(directionalLight);

<span class="hljs-comment">//添加控制器，允许用户用手势旋转、缩放模型</span>
<span class="hljs-keyword">const</span> controls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrbitControls</span>(camera, renderer.<span class="hljs-property">domElement</span>);
controls.<span class="hljs-property">enableDamping</span> = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 启用阻尼效果，使旋转更平滑</span>
controls.<span class="hljs-title function_">update</span>();


<span class="hljs-keyword">function</span> <span class="hljs-title function_">getUrl</span>(<span class="hljs-params"/>) {
   <span class="hljs-keyword">const</span> urlString = androidBridge.<span class="hljs-title function_">getUrl</span>()
   <span class="hljs-keyword">const</span> info = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(androidBridge.<span class="hljs-title function_">getUrl</span>())
   <span class="hljs-keyword">return</span> info.<span class="hljs-property">url</span>
}

<span class="hljs-comment">//加载 3D 模型 (GLTF/GLB)</span>
<span class="hljs-keyword">const</span> loader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GLTFLoader</span>();
loader.<span class="hljs-title function_">load</span>(<span class="hljs-title function_">getUrl</span>(),
    <span class="hljs-keyword">function</span> (<span class="hljs-params">gltf</span>) {
        <span class="hljs-keyword">const</span> model = gltf.<span class="hljs-property">scene</span>;
        <span class="hljs-comment">// 调整模型大小和位置</span>
        model.<span class="hljs-property">scale</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>); <span class="hljs-comment">// 调整模型初始的大小</span>
        model.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        model.<span class="hljs-property">rotation</span>.<span class="hljs-property">y</span> += <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>; <span class="hljs-comment">// 修改模型的 rotation属性 ,GLB 模型 180 度旋转</span>
        scene.<span class="hljs-title function_">add</span>(model);
    },

    <span class="hljs-keyword">function</span> (<span class="hljs-params">xhr</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>((xhr.<span class="hljs-property">loaded</span> / xhr.<span class="hljs-property">total</span> * <span class="hljs-number">100</span>) + <span class="hljs-string">'% loaded'</span>);
        androidBridge.<span class="hljs-title function_">sendDataToAndroid</span>(xhr.<span class="hljs-property">loaded</span> / xhr.<span class="hljs-property">total</span> * <span class="hljs-number">100</span>);
    },
    
    <span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'An error happened'</span>, error);
    }
);

<span class="hljs-comment">// 动画循环 </span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">animate</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">requestAnimationFrame</span>(animate);

    controls.<span class="hljs-title function_">update</span>(); <span class="hljs-comment">// 更新控制器</span>

    renderer.<span class="hljs-title function_">render</span>(scene, camera);
}

<span class="hljs-title function_">animate</span>();

<span class="hljs-comment">//处理窗口大小变化</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, <span class="hljs-function">() =&gt;</span> {
    camera.<span class="hljs-property">aspect</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;
    camera.<span class="hljs-title function_">updateProjectionMatrix</span>();
    renderer.<span class="hljs-title function_">setSize</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>);
});
</code></pre>
<p>AndroidBridge.kt主要是把从服务器获取的3d模型url传递到main.js中，然后再从main.js中获取加载进度回调到Android原生代码中。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AndroidBridge</span> {
    private <span class="hljs-keyword">var</span> <span class="hljs-attr">info</span>: <span class="hljs-title class_">String</span>? = <span class="hljs-literal">null</span>


    private <span class="hljs-keyword">var</span> <span class="hljs-attr">progressCallback</span>: <span class="hljs-title class_">ProgressCallback</span>? = <span class="hljs-literal">null</span>

    <span class="hljs-comment">// 定义回调接口</span>
    interface <span class="hljs-title class_">ProgressCallback</span> {
        fun <span class="hljs-title function_">onProgressUpdate</span>(<span class="hljs-attr">progress</span>: <span class="hljs-title class_">Int</span>)
    }

    <span class="hljs-comment">// 设置回调</span>
    fun <span class="hljs-title function_">setProgressCallback</span>(<span class="hljs-params">callback: ProgressCallback</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">progressCallback</span> = callback
    }

    @<span class="hljs-title class_">JavascriptInterface</span>
    fun <span class="hljs-title function_">getUrl</span>(): <span class="hljs-title class_">String</span> {
        <span class="hljs-keyword">return</span> info.<span class="hljs-title function_">orEmpty</span>()
    }

    fun <span class="hljs-title function_">setUrl</span>(<span class="hljs-params">info: <span class="hljs-built_in">String</span>?</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">info</span> = info
    }

    @<span class="hljs-title class_">JavascriptInterface</span>
    fun <span class="hljs-title function_">sendDataToAndroid</span>(<span class="hljs-params">progress: Int</span>) {
        progressCallback?.<span class="hljs-title function_">onProgressUpdate</span>(progress)
    }
}
</code></pre>
<p>MainActivity.kt主要是提供webview，以及从服务器获取3D模型url，完成和js的交互。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-number">1.</span>初始化<span class="hljs-title class_">WebView</span>
val webSettings = settings
webSettings.<span class="hljs-property">javaScriptEnabled</span> = <span class="hljs-literal">true</span>
webSettings.<span class="hljs-property">allowFileAccess</span> = <span class="hljs-literal">true</span>
webSettings.<span class="hljs-property">allowFileAccessFromFileURLs</span> = <span class="hljs-literal">true</span>
webSettings.<span class="hljs-property">allowContentAccess</span> = <span class="hljs-literal">true</span>
webSettings.<span class="hljs-property">domStorageEnabled</span> = <span class="hljs-literal">true</span>
webSettings.<span class="hljs-property">builtInZoomControls</span> = <span class="hljs-literal">false</span>
webSettings.<span class="hljs-property">displayZoomControls</span> = <span class="hljs-literal">false</span>
webSettings.<span class="hljs-property">allowUniversalAccessFromFileURLs</span> = <span class="hljs-literal">true</span>
<span class="hljs-title function_">setWebChromeClient</span>(object : <span class="hljs-title class_">WebChromeClient</span>() {
    override fun <span class="hljs-title function_">onConsoleMessage</span>(<span class="hljs-attr">cm</span>: <span class="hljs-title class_">ConsoleMessage</span>): <span class="hljs-title class_">Boolean</span> {
        <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">d</span>(<span class="hljs-string">"three"</span>, cm.<span class="hljs-title function_">message</span>() + <span class="hljs-string">" at "</span> + cm.<span class="hljs-title function_">sourceId</span>() + <span class="hljs-string">":"</span> + cm.<span class="hljs-title function_">lineNumber</span>())
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    }
})
    
<span class="hljs-number">2.</span>获取3D模型url
bindViewModel {
    ai3Data.<span class="hljs-title function_">observe</span>(<span class="hljs-params"><span class="hljs-variable language_">this</span>@WebViewActivity</span>) {
        <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">TextUtils</span>.<span class="hljs-title function_">isEmpty</span>(it.<span class="hljs-property">data</span>?.<span class="hljs-property">glb_url</span>)) {
            bindView {
                val glbUrl = it.<span class="hljs-property">data</span>?.<span class="hljs-property">glb_url</span>
                val bridge = <span class="hljs-title class_">AndroidBridge</span>()
                webView.<span class="hljs-title function_">addJavascriptInterface</span>(bridge,<span class="hljs-string">"androidBridge"</span>)
                bridge.<span class="hljs-title function_">setUrl</span>(<span class="hljs-string">"{"</span>url<span class="hljs-string">":"</span>$glbUrl<span class="hljs-string">"}"</span>)
                webView.<span class="hljs-title function_">loadUrl</span>(<span class="hljs-string">"file:///android_asset/threejs/index.html"</span>)
                bridge.<span class="hljs-title function_">setProgressCallback</span>(object :<span class="hljs-title class_">AndroidBridge</span>.<span class="hljs-property">ProgressCallback</span> {
                    override fun <span class="hljs-title function_">onProgressUpdate</span>(<span class="hljs-params">progress: Int</span>) {
                        runOnUiThread {
                            <span class="hljs-keyword">if</span> (progress &lt; <span class="hljs-number">100</span>) {
                                tvStateQuest.<span class="hljs-property">text</span> = <span class="hljs-string">"glb文件加载进度$progress%"</span>
                            } <span class="hljs-keyword">else</span> {
                                tvStateQuest.<span class="hljs-property">text</span> = <span class="hljs-string">"glb文件加载进度$progress%"</span>
                                tvStateQuest.<span class="hljs-property">text</span> = <span class="hljs-string">"glb文件加载结束"</span>
                            }
                        }
                    }
                })
            }
        }
    }
}
</code></pre>
<p>以上代码就是利用WebView作为桥梁，驱动Three.js，在Android原生应用中渲染3D模型的例子。</p>
<h2 data-id="heading-8">四、Three.js还能做什么？</h2>
<p>1.网页3D游戏<br/>
2.炫酷的动画特效<br/>
3.3D图表的数据可视化<br/>
4.电商网站的3D产品展示<br/>
5.房产APP中房屋的3D展示</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain1.0智能体开发：长期记忆]]></title>    <link>https://juejin.cn/post/7572130072262688814</link>    <guid>https://juejin.cn/post/7572130072262688814</guid>    <pubDate>2025-11-13T09:51:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572130072262688814" data-draft-id="7571751593207201844" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain1.0智能体开发：长期记忆"/> <meta itemprop="keywords" content="Agent,LangChain,Python"/> <meta itemprop="datePublished" content="2025-11-13T09:51:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="FreeCode"/> <meta itemprop="url" content="https://juejin.cn/user/1282499717900794"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain1.0智能体开发：长期记忆
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1282499717900794/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    FreeCode
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:51:55.000Z" title="Thu Nov 13 2025 09:51:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><blockquote>
<p>阅读本文您将获得：</p>
<ul>
<li>LangChain长期记忆store的实现</li>
<li>LangGraph持久化功能的存储结构</li>
<li>智能体使用工具读取长期记忆</li>
<li>智能体使用工具写入长期记忆</li>
</ul>
</blockquote>
<h2 data-id="heading-0">1、概述</h2>
<p>LangChain智能体借助LangGraph的持久化功能实现长期记忆。LangChain长期记忆属于高阶的主题，使用时需具备LangGraph相关知识。</p>
<h2 data-id="heading-1">2、记忆存储</h2>
<p>LangGraph将长期记忆以JSON文档的形式存储在存储系统中。
每个记忆都归属于一个自定义命名空间（类似文件夹），并对应一个唯一键（类似文件名）。命名空间中通常包含用户ID、组织ID或其他标识，这些信息能让记忆的整理更便捷。
这种结构支持对记忆进行层级化组织，同时可通过内容筛选器实现跨命名空间检索。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.store.memory <span class="hljs-keyword">import</span> InMemoryStore

<span class="hljs-keyword">def</span> <span class="hljs-title function_">embed</span>(<span class="hljs-params">texts: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>]</span>) -&gt; <span class="hljs-built_in">list</span>[<span class="hljs-built_in">list</span>[<span class="hljs-built_in">float</span>]]:
    <span class="hljs-comment"># Replace with an actual embedding function or LangChain embeddings object</span>
    <span class="hljs-keyword">return</span> [[<span class="hljs-number">1.0</span>, <span class="hljs-number">2.0</span>] * <span class="hljs-built_in">len</span>(texts)]

<span class="hljs-comment"># InMemoryStore saves data to an in-memory dictionary. Use a DB-backed store in production use.</span>
store = InMemoryStore(index={<span class="hljs-string">"embed"</span>: embed, <span class="hljs-string">"dims"</span>: <span class="hljs-number">2</span>}) 
user_id = <span class="hljs-string">"my-user"</span>
application_context = <span class="hljs-string">"chitchat"</span>
namespace = (user_id, application_context) 
store.put( 
    namespace,
    <span class="hljs-string">"a-memory"</span>,
    {
        <span class="hljs-string">"rules"</span>: [
            <span class="hljs-string">"User likes short, direct language"</span>,
            <span class="hljs-string">"User only speaks English &amp; python"</span>,
        ],
        <span class="hljs-string">"my-key"</span>: <span class="hljs-string">"my-value"</span>,
    },
)
<span class="hljs-comment"># get the "memory" by ID</span>
item = store.get(namespace, <span class="hljs-string">"a-memory"</span>) 
<span class="hljs-comment"># search for "memories" within this namespace, filtering on content equivalence, sorted by vector similarity</span>
items = store.search( 
    namespace, <span class="hljs-built_in">filter</span>={<span class="hljs-string">"my-key"</span>: <span class="hljs-string">"my-value"</span>}, query=<span class="hljs-string">"language preferences"</span>
)
</code></pre>
<h2 data-id="heading-2">3、在工具中读取长期记忆</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass
<span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnableConfig
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool, ToolRuntime
<span class="hljs-keyword">from</span> langgraph.store.memory <span class="hljs-keyword">import</span> InMemoryStore

<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Context</span>:
    user_id: <span class="hljs-built_in">str</span>

<span class="hljs-comment"># InMemoryStore saves data to an in-memory dictionary. Use a DB-backed store in production.</span>
store = InMemoryStore() 

<span class="hljs-comment"># Write sample data to the store using the put method</span>
store.put( 
    (<span class="hljs-string">"users"</span>,),  <span class="hljs-comment"># Namespace to group related data together (users namespace for user data)</span>
    <span class="hljs-string">"user_123"</span>,  <span class="hljs-comment"># Key within the namespace (user ID as key)</span>
    {
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"John Smith"</span>,
        <span class="hljs-string">"language"</span>: <span class="hljs-string">"English"</span>,
    }  <span class="hljs-comment"># Data to store for the given user</span>
)

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_user_info</span>(<span class="hljs-params">runtime: ToolRuntime[Context]</span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""Look up user info."""</span>
    <span class="hljs-comment"># Access the store - same as that provided to `create_agent`</span>
    store = runtime.store 
    user_id = runtime.context.user_id
    <span class="hljs-comment"># Retrieve data from store - returns StoreValue object with value and metadata</span>
    user_info = store.get((<span class="hljs-string">"users"</span>,), user_id) 
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">str</span>(user_info.value) <span class="hljs-keyword">if</span> user_info <span class="hljs-keyword">else</span> <span class="hljs-string">"Unknown user"</span>

agent = create_agent(
    model=<span class="hljs-string">"claude-sonnet-4-5-20250929"</span>,
    tools=[get_user_info],
    <span class="hljs-comment"># Pass store to agent - enables agent to access store when running tools</span>
    store=store, 
    context_schema=Context
)

<span class="hljs-comment"># Run the agent</span>
agent.invoke(
    {<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"look up user information"</span>}]},
    context=Context(user_id=<span class="hljs-string">"user_123"</span>) 
)
</code></pre>
<h2 data-id="heading-3">4、在工具中写入长期记忆</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass
<span class="hljs-keyword">from</span> typing_extensions <span class="hljs-keyword">import</span> TypedDict
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool, ToolRuntime
<span class="hljs-keyword">from</span> langgraph.store.memory <span class="hljs-keyword">import</span> InMemoryStore

<span class="hljs-comment"># InMemoryStore saves data to an in-memory dictionary. Use a DB-backed store in production.</span>
store = InMemoryStore() 

<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Context</span>:
    user_id: <span class="hljs-built_in">str</span>

<span class="hljs-comment"># TypedDict defines the structure of user information for the LLM</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserInfo</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    name: <span class="hljs-built_in">str</span>

<span class="hljs-comment"># Tool that allows agent to update user information (useful for chat applications)</span>
<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">save_user_info</span>(<span class="hljs-params">user_info: UserInfo, runtime: ToolRuntime[Context]</span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""Save user info."""</span>
    <span class="hljs-comment"># Access the store - same as that provided to `create_agent`</span>
    store = runtime.store 
    user_id = runtime.context.user_id 
    <span class="hljs-comment"># Store data in the store (namespace, key, data)</span>
    store.put((<span class="hljs-string">"users"</span>,), user_id, user_info) 
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Successfully saved user info."</span>

agent = create_agent(
    model=<span class="hljs-string">"claude-sonnet-4-5-20250929"</span>,
    tools=[save_user_info],
    store=store, 
    context_schema=Context
)

<span class="hljs-comment"># Run the agent</span>
agent.invoke(
    {<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"My name is John Smith"</span>}]},
    <span class="hljs-comment"># user_id passed in context to identify whose information is being updated</span>
    context=Context(user_id=<span class="hljs-string">"user_123"</span>) 
)

<span class="hljs-comment"># You can access the store directly to get the value</span>
store.get((<span class="hljs-string">"users"</span>,), <span class="hljs-string">"user_123"</span>).value
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解决Webpack 打包报错：TypeError: Cannot assign to read only property 'exports' ？]]></title>    <link>https://juejin.cn/post/7572004684177768502</link>    <guid>https://juejin.cn/post/7572004684177768502</guid>    <pubDate>2025-11-13T08:23:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572004684177768502" data-draft-id="7571621555512950838" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解决Webpack 打包报错：TypeError: Cannot assign to read only property 'exports' ？"/> <meta itemprop="keywords" content="JavaScript,Vue.js,Webpack"/> <meta itemprop="datePublished" content="2025-11-13T08:23:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小蹦跶儿"/> <meta itemprop="url" content="https://juejin.cn/user/3245414058300238"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解决Webpack 打包报错：TypeError: Cannot assign to read only property 'exports' ？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3245414058300238/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小蹦跶儿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T08:23:22.000Z" title="Thu Nov 13 2025 08:23:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>前言：</p>
<p>做前端项目打包时，你是否遇到过这样的窘境：本地 <code>npm run dev</code> 运行一切正常，可执行 <code>npm run build</code> 打包后，生产环境控制台直接抛出 <code>TypeError: Cannot assign to read only property 'exports' of object '#&lt;Object&gt;'</code> 错误？</p>
</blockquote>
<h2 data-id="heading-0">一、背景介绍</h2>
<p>最近有个以前的老项目（<code>Vue2+webpack</code>）在正式环境出现了问题，这个项目中途一直没改动，突然有个页面打不开了。在控制台的报错信息如下图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6b2b50d0954401c8fd00114313ebabf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6Lmm6Le25YS_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763627002&amp;x-signature=tzs4YKEagByBPR5jPhKM%2BnT2m3c%3D" alt="image.png" loading="lazy"/></p>
<p>需要说明的一点，这是打包后的报错，在本地运行的时候，是没有问题的。
我把这段报错信息复制下来，如果有需要的话可以复制去研究一下。</p>
<pre><code class="hljs language-js" lang="js">vendor.0d88a535e3e863312d89.<span class="hljs-property">js</span>:<span class="hljs-number">44</span> <span class="hljs-title class_">TypeError</span>: <span class="hljs-title class_">Cannot</span> assign to read only property <span class="hljs-string">'exports'</span> <span class="hljs-keyword">of</span> object <span class="hljs-string">'#&lt;Object&gt;
    at Object.&lt;anonymous&gt; (0.d97ee341e9f7c8f3e805.js:1:14033)
    at 16Wf (0.d97ee341e9f7c8f3e805.js:1:16662)
    at n (manifest.83cbbf59a618d5d725c4.js:1:101)
    at Object.exjW (0.d97ee341e9f7c8f3e805.js:10:119646)
    at n (manifest.83cbbf59a618d5d725c4.js:1:101)
    at Object.OpaP (0.d97ee341e9f7c8f3e805.js:10:22333)
    at n (manifest.83cbbf59a618d5d725c4.js:1:101)
    at 7AuU (0.d97ee341e9f7c8f3e805.js:1:52095)
    at n (manifest.83cbbf59a618d5d725c4.js:1:101)
    at Object.sGS9 (0.d97ee341e9f7c8f3e805.js:10:181323)
</span></code></pre>
<h2 data-id="heading-1">二、解决方法</h2>
<blockquote>
<h3 data-id="heading-2">快速修复建议</h3>
<ol>
<li>首先尝试 <strong>方案一</strong> 和 <strong>方案二</strong>，检查并修正 <code>babel</code> 和 <code>webpack</code> 配置。（推荐）</li>
<li>如果你知道具体哪个文件导致问题，直接修改该文件的模块语法。</li>
</ol>
</blockquote>
<h3 data-id="heading-3">下面将具体展开描述解决步骤：</h3>
<ol>
<li>我将这个问题的报错信息直接抛给了<code>通义千问</code>，让它帮我分析问题原因，并给出解决方案。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4496d7c5a994618a8a5832617ebb6b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6Lmm6Le25YS_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763627002&amp;x-signature=2cdQnYBw%2BQgyxBFExctJtMlJVI4%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ee165c0db354b78a1db3739a73877b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6Lmm6Le25YS_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763627002&amp;x-signature=KFeEAM9OMKij0Kf0QTPy%2BlZymbg%3D" alt="image.png" loading="lazy"/></p>
<p>代码如下：</p>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-string">"presets"</span>: [
    [<span class="hljs-string">"env"</span>, {
      <span class="hljs-string">"modules"</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-string">"targets"</span>: {
        <span class="hljs-string">"browsers"</span>: [<span class="hljs-string">"&gt; 1%"</span>, <span class="hljs-string">"last 2 versions"</span>, <span class="hljs-string">"not ie &lt;= 8"</span>]
      }
    }],
    <span class="hljs-string">"stage-2"</span>
  ],
  <span class="hljs-string">"plugins"</span>: [<span class="hljs-string">"transform-runtime"</span>]
}

</code></pre>
<ol start="2">
<li>
<p>对照着我自己的代码检查之后，确保项目根目录下的<code>.babelrc</code> 或 <code>babel.config.js</code>文件包含正确的配置，没有问题，（我项目中是<code>.babelrc文件</code>）。</p>
<p>如果没有 <code>.babelrc</code> 文件，创建一个并添加上述内容。</p>
</li>
<li>
<p>然后继续看下一个方案：</p>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29209c1200af4132a8075624458fa0e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6Lmm6Le25YS_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763627002&amp;x-signature=9oGg9qKGzFqR116%2FpLCYbRY%2FAkU%3D" alt="image.png" loading="lazy"/></p>
<p>代码如下：</p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      <span class="hljs-comment">// 添加 JavaScript 文件处理规则来解决模块系统冲突问题</span>
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.js$/</span>,
        <span class="hljs-attr">loader</span>: <span class="hljs-string">'babel-loader'</span>,
        <span class="hljs-attr">exclude</span>: <span class="hljs-regexp">/(node_modules|bower_components)/</span>,
        <span class="hljs-attr">options</span>: {
          <span class="hljs-attr">presets</span>: [
            [<span class="hljs-string">'env'</span>, {
              <span class="hljs-attr">modules</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// 确保设置为 false</span>
            }]
          ]
        }
      }
    ]
  },
</code></pre>
<p>根据 <strong>方案二</strong> ，找到项目中对应的 <code>build/webpack.prod.conf.js</code>文件，看是否有上面的这段代码。</p>
<p>下图是我的项目中的代码，很尴尬，没有这部分代码……</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/497e9431d3a2457795f015eda24e6d49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6Lmm6Le25YS_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763627002&amp;x-signature=Zm2ADLUzpBSSd2BiqNflhgqZFcQ%3D" alt="image.png" loading="lazy"/></p>
<ol start="4">
<li>接着就可以将这部分代码加进去：</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc5afd22e9d34f36a3986803d8a3286b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6Lmm6Le25YS_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763627002&amp;x-signature=oc%2FNPqZ8GGHf7Z%2FzGibD07YSg8c%3D" alt="image.png" loading="lazy"/></p>
<p>代码如下，可直接复制：</p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      <span class="hljs-comment">// 添加 JavaScript 文件处理规则来解决模块系统冲突问题</span>
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.js$/</span>,
        <span class="hljs-attr">loader</span>: <span class="hljs-string">'babel-loader'</span>,
        <span class="hljs-attr">exclude</span>: <span class="hljs-regexp">/(node_modules|bower_components)/</span>,
        <span class="hljs-attr">options</span>: {
          <span class="hljs-attr">presets</span>: [
            [<span class="hljs-string">'env'</span>, {
              <span class="hljs-attr">modules</span>: <span class="hljs-literal">false</span>
            }]
          ]
        }
      },
      <span class="hljs-comment">// 保留原有的样式处理规则</span>
      ...utils.<span class="hljs-title function_">styleLoaders</span>({
        <span class="hljs-attr">sourceMap</span>: config.<span class="hljs-property">build</span>.<span class="hljs-property">productionSourceMap</span>,
        <span class="hljs-attr">extract</span>: <span class="hljs-literal">true</span>
      })
    ]
  },
</code></pre>
<p>关键点是设置 <code>"modules": false</code>，这告诉 Babel 不要转换 ES6 的 import/export 语法，让 webpack 来处理模块系统，避免 ES6 模块语法和 CommonJS 语法冲突的问题。</p>
<p>完成这些修改后，重新运行 <code>npm run build</code> 应该就能解决你遇到的错误了。</p>
<p>推荐这个方案的原因是，这样可以确保开发环境和生产环境使用相同的 <code>babel</code> 配置。这个修改就是我成功解决问题的方法。</p>
<ol start="5">
<li>AI 还给我建议说，“检查具体出错的文件“，可是根据错误堆栈，问题出现的文件名称是被编译过的，找的话就需要查找源代码中混用了 <code>import</code> 和 <code>module.exports</code> 的地方，找到之后统一使用一种模块语法即可。
由于我的出错文件是在第三方库中，所以这个方案有点麻烦，我果断放弃。</li>
</ol>
<h2 data-id="heading-4">三、问题原因</h2>
<p>核心原因正如分析所示：在同一模块中同时混用了 ES6 的 <code>import/export</code> 语法与 CommonJS 的 <code>module.exports</code> 语法，导致 webpack 处理模块时出现冲突。这是 webpack 打包后，生产环境中较为常见的问题。</p>
<p>如果是自己写的代码，可以在代码中查找并修改，统一项目中的模块语法规范即可。如果是第三方库出现的问题，就可以用本文中的方法解决，先尝试检查 <code>babel</code> 配置并确保 <code>modules: false</code> 设置正确，这通常能解决大部分此类问题。</p>
<h2 data-id="heading-5">四、总结</h2>
<p>前端打包报错往往 “现象复杂，根源简单”，遇到类似问题时，优先排查模块语法、依赖兼容性、Webpack 配置这三大方向，通常能快速找到突破口。</p>
<p>以上，希望对大家有帮助！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C++智能指针介绍]]></title>    <link>https://juejin.cn/post/7571815573932916799</link>    <guid>https://juejin.cn/post/7571815573932916799</guid>    <pubDate>2025-11-13T08:22:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571815573932916799" data-draft-id="7571678388954300435" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C++智能指针介绍"/> <meta itemprop="keywords" content="C++"/> <meta itemprop="datePublished" content="2025-11-13T08:22:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="qwepoilkjasd"/> <meta itemprop="url" content="https://juejin.cn/user/318221180214507"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C++智能指针介绍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/318221180214507/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    qwepoilkjasd
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T08:22:23.000Z" title="Thu Nov 13 2025 08:22:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>好的，非常乐意为你详细讲解 C++ 智能指针。这是现代 C++（C++11 及之后）中<strong>最重要</strong>的特性之一，它彻底改变了 C++ 的内存管理方式。</p>
<p>我们将从<strong>为什么</strong>需要它开始，然后逐一介绍三种核心的智能指针：<code>std::unique_ptr</code>、<code>std::shared_ptr</code> 和 <code>std::weak_ptr</code>。</p>
<hr/>
<h2 data-id="heading-0">🎯 1. 为什么需要智能指针？（传统指针的问题）</h2>
<p>在 C++ 中，我们经常使用 <code>new</code> 在**堆 (Heap)**上动态分配内存。</p>
<p>C++</p>
<pre><code class="hljs language-scss" lang="scss">void <span class="hljs-built_in">old_way</span>() {
    MyClass* raw_ptr = new <span class="hljs-built_in">MyClass</span>(); <span class="hljs-comment">// 1. 分配内存</span>
    raw_ptr-&gt;<span class="hljs-built_in">do_something</span>();
    <span class="hljs-comment">// ...</span>
    delete raw_ptr; <span class="hljs-comment">// 2. 必须手动释放</span>
}
</code></pre>
<p>这种“裸指针” (Raw Pointer) 的管理方式非常危险，极易出错：</p>
<ol>
<li>
<p><strong>内存泄漏 (Memory Leaks)</strong> ：</p>
<ul>
<li><strong>忘记 <code>delete</code></strong>：最常见的问题。<code>raw_ptr</code> 是一个局部变量，当 <code>old_way()</code> 函数结束时，<code>raw_ptr</code> 变量本身被销毁了，但它所<strong>指向</strong>的在“堆”上的 <code>MyClass</code> 对象<strong>依然存在</strong>，这块内存永远无法被回收。</li>
<li><strong>提前返回</strong>：如果在 <code>new</code> 和 <code>delete</code> 之间有 <code>return</code>、<code>break</code> 或 <code>continue</code>，<code>delete</code> 语句可能被跳过。</li>
<li><strong>发生异常</strong>：如果在 <code>do_something()</code> 中抛出了异常，<code>delete raw_ptr;</code> 这一行永远不会被执行，内存泄漏。</li>
</ul>
</li>
<li>
<p><strong>悬挂指针 (Dangling Pointers)</strong> ：<br/>
<strong>悬空指针</strong> ：</p>
<ul>
<li>当一个指针被 <code>delete</code> 后，它并没有自动变为 <code>nullptr</code>，它依然指向那块“已释放”的内存。如果后续代码不慎再次使用了这个指针（“Use-After-Free”），会导致未定义行为（通常是程序崩溃）。</li>
</ul>
</li>
<li>
<p><strong>所有权 (Ownership) 不明</strong>：</p>
<ul>
<li>当一个裸指针在多个函数或对象之间传递时，到底<strong>谁</strong>负责 <code>delete</code> 它？</li>
<li>如果两个模块都尝试 <code>delete</code> 同一个指针，会引发<strong>二次释放 (Double Free)</strong> ，导致程序崩溃。</li>
<li>如果谁都不 <code>delete</code>，就是内存泄漏。</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-1">💡 2. 核心思想：RAII 与智能指针</h2>
<p>为了解决这些问题，C++ 引入了<strong>智能指针 (Smart Pointers)</strong> 。</p>
<p>智能指针<strong>不是</strong>指针，它是一个<strong>对象</strong>（一个类模板）。它封装（wrap）了一个裸指针，并利用了 C++ 的一个核心特性：<strong>RAII (Resource Acquisition Is Initialization)</strong> ，即“资源获取即初始化”。</p>
<p>RAII 的核心思想：</p>
<ol>
<li>一个对象在它的<strong>构造函数</strong>中获取资源（这里是 <code>new</code> 出来的内存）。</li>
<li>这个对象在它的<strong>析构函数</strong>中释放资源（这里是 <code>delete</code> 封装的裸指针）。</li>
<li>C++ 保证，一个在<strong>栈 (Stack)上创建的对象，当它离开作用域时（例如函数返回），它的析构函数必定</strong>会被自动调用（即使发生异常，也会“栈展开”）。</li>
</ol>
<p><strong>智能指针就是这样一个 RAII 对象</strong>。你把 <code>new</code> 得到的指针交给它，你就可以“忘记”<code>delete</code> 了。当智能指针对象生命周期结束时，它会在析构函数中自动帮你 <code>delete</code> 掉它所管理的指针。</p>
<p>C++</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span> <span class="hljs-comment">// 智能指针的头文件</span></span>

<span class="hljs-type">void</span> <span class="hljs-title function_">smart_way</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// std::make_unique 是创建 unique_ptr 的推荐方式 (C++14)</span>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">unique_ptr</span>&lt;MyClass&gt; smart_ptr = <span class="hljs-built_in">std</span>::make_unique&lt;MyClass&gt;();
    
    smart_ptr-&gt;do_something();

    <span class="hljs-comment">// 当 smart_way() 函数返回时，smart_ptr 离开作用域</span>
    <span class="hljs-comment">// 它的析构函数被自动调用</span>
    <span class="hljs-comment">// 析构函数会自动执行 delete smart_ptr.get()</span>
} <span class="hljs-comment">// &lt;-- 内存在这里被自动释放，即使发生异常也一样！</span>
</code></pre>
<hr/>
<h2 data-id="heading-2">🔧 3. <code>std::unique_ptr</code> (独占指针)</h2>
<p><code>std::unique_ptr</code> 是最常用、最高效、最“轻量级”的智能指针。</p>
<ul>
<li>
<p><strong>核心概念：</strong> <strong>独占所有权 (Exclusive Ownership)</strong> 。</p>
</li>
<li>
<p><strong>含义：</strong> 在任何时刻，<strong>只有一个</strong> <code>unique_ptr</code> 可以指向某个特定的对象。它“拥有”这个对象。</p>
</li>
<li>
<p><strong>特性：</strong></p>
<ol>
<li><strong>轻量</strong>：它的大小和裸指针一样（没有额外开销），因为它不需要存储“引用计数”之类的东西。</li>
<li><strong>不可复制 (Non-Copyable)</strong> ：你不能“拷贝”一个 <code>unique_ptr</code>，因为这会违反“独占”所有权。</li>
<li><strong>可以移动 (Movable)</strong> ：你可以将所有权从一个 <code>unique_ptr</code> <strong>转移 (move)</strong> 给另一个。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-3">示例：创建、使用和转移</h3>
<p>C++</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;utility&gt;</span> <span class="hljs-comment">// for std::move</span></span>

<span class="hljs-comment">// 推荐的创建方式 (C++14)</span>
<span class="hljs-built_in">std</span>::<span class="hljs-built_in">unique_ptr</span>&lt;MyClass&gt; p1 = <span class="hljs-built_in">std</span>::make_unique&lt;MyClass&gt;();

<span class="hljs-comment">// 像裸指针一样使用</span>
p1-&gt;do_something();
<span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; (*p1).value;

<span class="hljs-comment">// 1. 编译错误：不允许复制！</span>
<span class="hljs-comment">// std::unique_ptr&lt;MyClass&gt; p2 = p1; // ERROR: copy constructor is deleted</span>

<span class="hljs-comment">// 2. 正确：转移所有权 (Move)</span>
<span class="hljs-comment">// p1 将放弃所有权，并变为空 (nullptr)</span>
<span class="hljs-built_in">std</span>::<span class="hljs-built_in">unique_ptr</span>&lt;MyClass&gt; p2 = <span class="hljs-built_in">std</span>::move(p1);

<span class="hljs-keyword">if</span> (p1 == nullptr) {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"p1 现在是空的"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
}
<span class="hljs-keyword">if</span> (p2 != nullptr) {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"p2 拥有了该对象"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
    p2-&gt;do_something();
} <span class="hljs-comment">// &lt;-- p2 在这里离开作用域，释放 MyClass 对象</span>

<span class="hljs-comment">// 3. 从函数返回 (所有权转移)</span>
<span class="hljs-built_in">std</span>::<span class="hljs-built_in">unique_ptr</span>&lt;MyClass&gt; <span class="hljs-title function_">create_object</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 工厂函数返回一个对象的所有权</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">std</span>::make_unique&lt;MyClass&gt;();
}
<span class="hljs-built_in">std</span>::<span class="hljs-built_in">unique_ptr</span>&lt;MyClass&gt; p3 = create_object();

<span class="hljs-comment">// 4. 作为参数传递 (转移所有权)</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">take_ownership</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">unique_ptr</span>&lt;MyClass&gt; p)</span> {
    p-&gt;do_something();
} <span class="hljs-comment">// &lt;-- p 在这里析构，释放对象</span>
take_ownership(<span class="hljs-built_in">std</span>::move(p3));
<span class="hljs-comment">// p3 在此之后也变为空</span>
</code></pre>
<h3 data-id="heading-4">什么时候用 <code>unique_ptr</code>？</h3>
<p><strong>答案：默认首选！</strong> 只要你不需要多个指针“共享”一个对象，就应该用 <code>unique_ptr</code>。</p>
<ul>
<li>作为类的成员变量（Pimpl 惯用法）。</li>
<li>在函数中创建并返回一个堆上对象（工厂模式）。</li>
<li>存储在 STL 容器中（例如 <code>std::vector&lt;std::unique_ptr&lt;MyClass&gt;&gt;</code>）。</li>
</ul>
<hr/>
<h2 data-id="heading-5">🤝 4. <code>std::shared_ptr</code> (共享指针)</h2>
<p><code>std::shared_ptr</code> 解决了“多个指针需要指向同一对象”的场景。</p>
<ul>
<li>
<p><strong>核心概念：</strong> <strong>共享所有权 (Shared Ownership)</strong> 。</p>
</li>
<li>
<p><strong>含义：</strong> 多个 <code>shared_ptr</code> 可以指向同一个对象。它们通过<strong>引用计数 (Reference Counting)</strong> 来管理这个对象的生命周期。</p>
</li>
<li>
<p><strong>特性：</strong></p>
<ol>
<li><strong>引用计数</strong>：内部有一个“控制块”，其中包含一个计数器。</li>
<li>每当一个 <code>shared_ptr</code> <strong>被复制</strong>（或赋值给另一个 <code>shared_ptr</code>）时，<strong>计数器 +1</strong>。</li>
<li>每当一个 <code>shared_ptr</code> <strong>被析构</strong>（或被赋新值）时，<strong>计数器 -1</strong>。</li>
<li>当<strong>计数器减到 0</strong> 时，意味着最后一个拥有该对象的 <code>shared_ptr</code> 消失了，它会在析构时 <code>delete</code> 掉被管理的对象。</li>
<li><strong>开销</strong>：比 <code>unique_ptr</code> 重。它需要额外分配“控制块”的内存，并且增减计数器必须是<strong>原子操作</strong>（线程安全），这有性能开销。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-6">示例：创建和共享</h3>
<p>C++</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span>

<span class="hljs-comment">// 推荐的创建方式 (C++11)</span>
<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;MyClass&gt; sp1 = <span class="hljs-built_in">std</span>::make_shared&lt;MyClass&gt;();
<span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"当前引用计数: "</span> &lt;&lt; sp1.use_count() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>; <span class="hljs-comment">// 输出: 1</span>

{
    <span class="hljs-comment">// 复制构造函数，sp2 也指向 sp1 的对象</span>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;MyClass&gt; sp2 = sp1;
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"当前引用计数: "</span> &lt;&lt; sp1.use_count() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>; <span class="hljs-comment">// 输出: 2</span>
    
    <span class="hljs-comment">// sp2 和 sp1 都可以使用</span>
    sp2-&gt;do_something();

} <span class="hljs-comment">// &lt;-- sp2 在这里离开作用域，析构</span>
  <span class="hljs-comment">// 引用计数 -1，变为 1</span>

<span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"当前引用计数: "</span> &lt;&lt; sp1.use_count() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>; <span class="hljs-comment">// 输出: 1</span>

<span class="hljs-comment">// 为什么用 make_shared？</span>
<span class="hljs-comment">// 1. 性能：MyClass 对象和“控制块”的内存可以一次性分配，减少内存分配次数。</span>
<span class="hljs-comment">// 2. 异常安全：避免了在 `new MyClass()` 成功但 `shared_ptr` 构造失败时导致的内存泄漏。</span>
</code></pre>
<h3 data-id="heading-7">什么时候用 <code>shared_ptr</code>？</h3>
<p>当你<strong>无法</strong>明确界定“谁是唯一的所有者”时。</p>
<ul>
<li>你希望将一个对象存储在多个数据结构中，并且希望它在“所有引用它的地方都失效”后才被销毁。</li>
<li>异步回调（例如，<code>this</code> 指针可能在回调被调用前失效，使用 <code>shared_from_this</code>）。</li>
</ul>
<hr/>
<h2 data-id="heading-8">🚫 5. <code>std::weak_ptr</code> (弱指针)</h2>
<p><code>shared_ptr</code> 有一个致命问题：<strong>循环引用 (Circular Reference)</strong> 。</p>
<h3 data-id="heading-9">问题：循环引用</h3>
<p>C++</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">NodeB</span>;</span>

<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">NodeA</span> {</span>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;NodeB&gt; b_ptr;
    ~NodeA() { <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"NodeA 析构\n"</span>; }
};

<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">NodeB</span> {</span>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;NodeA&gt; a_ptr;
    ~NodeB() { <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"NodeB 析构\n"</span>; }
};

<span class="hljs-type">void</span> <span class="hljs-title function_">circular_reference_problem</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">auto</span> a = <span class="hljs-built_in">std</span>::make_shared&lt;NodeA&gt;(); <span class="hljs-comment">// a 的计数 = 1</span>
    <span class="hljs-keyword">auto</span> b = <span class="hljs-built_in">std</span>::make_shared&lt;NodeB&gt;(); <span class="hljs-comment">// b 的计数 = 1</span>

    a-&gt;b_ptr = b; <span class="hljs-comment">// b 的计数 = 2 (a 持有 b)</span>
    b-&gt;a_ptr = a; <span class="hljs-comment">// a 的计数 = 2 (b 持有 a)</span>

} <span class="hljs-comment">// &lt;-- 函数结束，a 和 b 两个 shared_ptr 离开作用域</span>
<span class="hljs-comment">// a 的计数从 2 -&gt; 1</span>
<span class="hljs-comment">// b 的计数从 2 -&gt; 1</span>

<span class="hljs-comment">// **内存泄漏！**</span>
<span class="hljs-comment">// a 的计数是 1 (因为 b 还指着它)，所以 NodeA 不会被析构。</span>
<span class="hljs-comment">// b 的计数是 1 (因为 a 还指着它)，所以 NodeB 也不会被析构。</span>
<span class="hljs-comment">// 它们互相“续命”，导致谁也无法释放。</span>
</code></pre>
<h3 data-id="heading-10">解决方案：<code>std::weak_ptr</code></h3>
<p><code>weak_ptr</code> 是一种<strong>非拥有 (Non-owning)</strong> 的智能指针。</p>
<ul>
<li>
<p><strong>核心概念：</strong> 它只是一个“观察者”。</p>
</li>
<li>
<p><strong>含义：</strong> 它可以指向 <code>shared_ptr</code> 管理的对象，但它<strong>不会</strong>增加引用计数。</p>
</li>
<li>
<p><strong>特性：</strong></p>
<ol>
<li>它不能阻止所指向的对象被销毁。</li>
<li>你<strong>不能</strong>直接通过 <code>weak_ptr</code> 使用对象（没有 <code>-&gt;</code> 或 <code>*</code> 操作符）。</li>
<li>你需要<strong>检查</strong>它指向的对象是否还“存活”。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-11">示例：打破循环</h3>
<p>C++</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">NodeB_Fixed</span>;</span>

<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">NodeA_Fixed</span> {</span>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;NodeB_Fixed&gt; b_ptr; <span class="hljs-comment">// A 强引用 B</span>
    ~NodeA_Fixed() { <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"NodeA 析构\n"</span>; }
};

<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">NodeB_Fixed</span> {</span>
    <span class="hljs-comment">// B 弱引用 A</span>
    <span class="hljs-built_in">std</span>::weak_ptr&lt;NodeA_Fixed&gt; a_ptr; <span class="hljs-comment">// &lt;-- 关键！</span>
    ~NodeB_Fixed() { <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"NodeB 析构\n"</span>; }
};

<span class="hljs-type">void</span> <span class="hljs-title function_">circular_reference_solution</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">auto</span> a = <span class="hljs-built_in">std</span>::make_shared&lt;NodeA_Fixed&gt;(); <span class="hljs-comment">// a 计数 = 1</span>
    <span class="hljs-keyword">auto</span> b = <span class="hljs-built_in">std</span>::make_shared&lt;NodeB_Fixed&gt;(); <span class="hljs-comment">// b 计数 = 1</span>

    a-&gt;b_ptr = b; <span class="hljs-comment">// b 计数 = 2</span>
    b-&gt;a_ptr = a; <span class="hljs-comment">// a 计数 = 1 (weak_ptr 不增加计数)</span>
}
<span class="hljs-comment">// 函数结束:</span>
<span class="hljs-comment">// 1. a (shared_ptr) 离开作用域，a 计数从 1 -&gt; 0。</span>
<span class="hljs-comment">// 2. NodeA 被析构！</span>
<span class="hljs-comment">// 3. 在 NodeA 的析构函数中，a-&gt;b_ptr (shared_ptr) 被销毁。</span>
<span class="hljs-comment">// 4. b 计数从 2 -&gt; 1。</span>
<span class="hljs-comment">// 5. b (shared_ptr) 离开作用域，b 计数从 1 -&gt; 0。</span>
<span class="hljs-comment">// 6. NodeB 被析构！</span>
<span class="hljs-comment">// (顺序可能是 5-&gt;6-&gt;3-&gt;4-&gt;1-&gt;2，但结果一样)</span>
<span class="hljs-comment">// **内存被正确释放！**</span>
</code></pre>
<h3 data-id="heading-12">如何使用 <code>weak_ptr</code>？</h3>
<p>你需要先把它“锁住” (<code>.lock()</code>)，尝试获取一个临时的 <code>shared_ptr</code>：</p>
<p>C++</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 假设你有一个 weak_ptr</span>
<span class="hljs-built_in">std</span>::weak_ptr&lt;MyClass&gt; wp = ...;

<span class="hljs-comment">// 尝试提升 (lock) 为 shared_ptr</span>
<span class="hljs-keyword">if</span> (<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;MyClass&gt; sp = wp.lock()) {
    <span class="hljs-comment">// 提升成功！</span>
    <span class="hljs-comment">// 这意味着在 if 语句块内，对象是存活的</span>
    <span class="hljs-comment">// sp 保证了对象在此期间不会被释放</span>
    sp-&gt;do_something();
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 提升失败，对象已经被销毁了</span>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"对象已不存在"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
}
</code></pre>
<h3 data-id="heading-13">什么时候用 <code>weak_ptr</code>？</h3>
<ol>
<li><strong>打破 <code>shared_ptr</code> 的循环引用</strong>（如上例中的父子/A-B 关系）。</li>
<li><strong>缓存 (Caching)</strong> ：你有一个缓存系统，希望缓存的对象在“别处都不用”时自动销毁，但你又想能随时访问它。<code>std::map&lt;Key, std::weak_ptr&lt;Value&gt;&gt;</code> 就很合适。</li>
<li><strong>观察者模式</strong>：<code>Subject</code> 可以持有 <code>std::vector&lt;std::weak_ptr&lt;Observer&gt;&gt;</code>，当 <code>Observer</code> 自行销毁时，<code>Subject</code> 不需要知道，它在通知时只需检查 <code>lock()</code> 是否成功。</li>
</ol>
<hr/>
<h2 data-id="heading-14">💡 6. 智能指针最佳实践（总结）</h2>
<ol>
<li>
<p><strong>首选 <code>std::make_unique</code> (C++14)</strong> ：当你创建对象时，优先使用 <code>unique_ptr</code>。</p>
</li>
<li>
<p><strong>需要共享时才用 <code>std::make_shared</code></strong>：当你明确知道所有权需要被共享时，才使用 <code>shared_ptr</code>。</p>
</li>
<li>
<p><strong>使用 <code>weak_ptr</code> 打破 <code>shared_ptr</code> 循环</strong>：当你发现 <code>shared_ptr</code> 构成了循环（例如树结构中的“子节点指向父节点”），使用 <code>weak_ptr</code> 作为“非拥有”的一方。</p>
</li>
<li>
<p><strong>不要混用裸指针和智能指针</strong>：</p>
<ul>
<li><strong>绝对禁止</strong>：<code>MyClass* raw = new MyClass();</code></li>
<li><code>std::shared_ptr&lt;MyClass&gt; p1(raw);</code></li>
<li><code>std::shared_ptr&lt;MyClass&gt; p2(raw);</code></li>
<li>这会导致 <code>p1</code> 和 <code>p2</code> 都有各自的引用计数（都为1），它们都会在析构时尝试 <code>delete raw</code>，导致<strong>二次释放</strong>。</li>
</ul>
</li>
<li>
<p><strong>如何向函数传递智能指针？（非常重要）</strong></p>
<ul>
<li>
<p><strong>情况1：函数只是“使用”对象，不关心所有权。</strong></p>
<ul>
<li><strong>最佳实践：</strong> 传递<strong>裸指针</strong> (<code>MyClass*</code>) 或<strong>引用</strong> (<code>MyClass&amp;</code>)。</li>
<li><strong>原因：</strong> 这最快，并且解耦。调用者可以用 <code>unique_ptr</code>、<code>shared_ptr</code> 或普通栈对象。</li>
</ul>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">use_object</span><span class="hljs-params">(MyClass* obj)</span> </span>{ obj-&gt;<span class="hljs-built_in">do_something</span>(); }
<span class="hljs-comment">// 调用:</span>
<span class="hljs-built_in">use_object</span>(my_unique_ptr.<span class="hljs-built_in">get</span>());
<span class="hljs-built_in">use_object</span>(my_shared_ptr.<span class="hljs-built_in">get</span>());
</code></pre>
</li>
<li>
<p><strong>情况2：函数需要“共享”所有权（例如，把它存为成员）。</strong></p>
<ul>
<li><strong>最佳实践：</strong> 按<strong>常量引用</strong>传递 <code>shared_ptr</code>。</li>
</ul>
<p>C++</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">store_object</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;MyClass&gt;&amp; ptr)</span> {
    m_member_ptr = ptr; <span class="hljs-comment">// 复制，引用计数+1</span>
}
</code></pre>
</li>
<li>
<p><strong>情况3：函数需要“夺取”或“转移”所有权。</strong></p>
<ul>
<li><strong>最佳实践：</strong> 按<strong>值</strong>传递 <code>unique_ptr</code>（需要 <code>std::move</code>）。</li>
</ul>
<p>C++</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">take_ownership</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">unique_ptr</span>&lt;MyClass&gt; ptr)</span> {
    m_member_ptr = <span class="hljs-built_in">std</span>::move(ptr); <span class="hljs-comment">// 接收所有权</span>
}
<span class="hljs-comment">// 调用:</span>
take_ownership(<span class="hljs-built_in">std</span>::move(my_unique_ptr));
</code></pre>
</li>
</ul>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何使用LangGraph构建一个智能体]]></title>    <link>https://juejin.cn/post/7572022112102531098</link>    <guid>https://juejin.cn/post/7572022112102531098</guid>    <pubDate>2025-11-13T08:24:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572022112102531098" data-draft-id="7571731181198622756" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何使用LangGraph构建一个智能体"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2025-11-13T08:24:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ALLINAI"/> <meta itemprop="url" content="https://juejin.cn/user/4001878056639549"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何使用LangGraph构建一个智能体
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4001878056639549/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ALLINAI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T08:24:45.000Z" title="Thu Nov 13 2025 08:24:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>使用 LangGraph 构建智能体时，首先要将任务分解为称为 <strong>节点</strong> 的离散步骤。然后，需要描述每个节点不同的决策逻辑和状态转换方式。最后，通过一个 <strong>共享状态</strong> 将各个节点连接起来，每个节点都可以读写该状态。</p>
<hr/>
<p>要在 LangGraph 中实现智能体，通常需要遵循五个步骤。</p>
<h2 data-id="heading-0">第一步：将你的工作流程分解成一个个独立的步骤。</h2>
<p>首先，确定流程中的各个步骤。每个步骤都将成为一个节点（一个执行特定操作的函数）。然后，绘制这些步骤之间的连接图。</p>
<h2 data-id="heading-1">第二步：明确每个步骤需要做什么</h2>
<p>对于图中的每个节点，确定它代表什么类型的操作以及它需要什么上下文才能正常工作。</p>
<p>一般有以下4种类型的操作步骤：</p>
<ul>
<li><strong>LLM 步骤</strong>：用于某个步骤需要理解、分析、生成文本或做出推理决策时。</li>
<li><strong>数据步骤</strong>：用于某个步骤需要从外部来源检索信息时。</li>
<li><strong>动作步骤</strong>：用于某个步骤需要执行外部操作时。</li>
<li><strong>用户输入步骤</strong>：用于某个步骤需要人工干预时。</li>
</ul>
<h3 data-id="heading-2">分类详解与实例</h3>



































<table><thead><tr><th align="left">步骤类型</th><th align="left">核心职能</th><th align="left">典型节点示例</th><th align="left">所需上下文（举例）</th></tr></thead><tbody><tr><td align="left"><strong>LLM 步骤</strong><br/>（大脑）</td><td align="left"><strong>理解、推理、决策、生成</strong></td><td align="left">• <strong>分类节点</strong>：分析用户意图。<br/>• <strong>起草回复节点</strong>：生成回复内容。</td><td align="left">• 原始用户输入<br/>• 分类结果<br/>• 公司回复风格指南</td></tr><tr><td align="left"><strong>数据步骤</strong><br/>（记忆）</td><td align="left"><strong>信息检索、数据查询</strong></td><td align="left">• <strong>文档搜索节点</strong>：从知识库查找答案。<br/>• <strong>客户历史查询</strong>：从数据库获取过往记录。</td><td align="left">• 查询关键词（如订单号）<br/>• 搜索范围/权限</td></tr><tr><td align="left"><strong>动作步骤</strong><br/>（手脚）</td><td align="left"><strong>执行实际操作、改变外部状态</strong></td><td align="left">• <strong>发送回复节点</strong>：将最终回复邮件发出。<br/>• <strong>创建工单节点</strong>：在追踪系统中创建Bug工单。</td><td align="left">• 最终审定的回复内容<br/>• 目标邮箱地址<br/>• 工单详细信息</td></tr><tr><td align="left"><strong>用户输入步骤</strong><br/>（监督）</td><td align="left"><strong>引入人类判断、处理异常</strong></td><td align="left">• <strong>人工审核节点</strong>：将敏感或复杂回复交由人工审批。</td><td align="left">• 需要审核的回复草稿<br/>• 触发送审的原因（如高金额退款）</td></tr></tbody></table>
<h2 data-id="heading-3">第三步：设计你的共享状态</h2>
<p>状态是你的智能体中所有节点都可以访问的共享记忆。你可以将其想象成你的智能体在处理流程中所使用的笔记本，用来记录它在此过程中了解到的一切信息和做出的所有决定。</p>
<p>设计状态就是为你的智能体 <strong>设计数据结构</strong>。一个精心设计的“共享笔记本”（状态）是构建一个高效、可靠且易于理解的智能体工作流的基石。它决定了节点之间如何通信，以及工作流的上下文如何得以保持。</p>
<h3 data-id="heading-4">哪些数据要保存在状态中？</h3>
<p>这个数据是否需要跨步骤保持？如果需要，则将其置于状态中。如果能从其他数据中推导出，则在需要时计算，而不是将其存储在状态中。</p>
<p>💡 <strong>一个关键原则</strong>：你的状态应该存储原始数据，而不是格式化的文本。需要时，在节点内部进行格式化。</p>
<h2 data-id="heading-5">第四步：构建节点</h2>
<p>构建节点就是我们将每个步骤实现为一个函数。LangGraph 中的一个节点就是一个 Python 函数，它接收当前状态并返回更新后的状态。</p>
<h3 data-id="heading-6">如何妥善处理节点中可能发生的错误？</h3>



































<table><thead><tr><th align="left">错误类型</th><th align="left">谁来修复它</th><th align="left">修复策略</th><th align="left">何时使用</th></tr></thead><tbody><tr><td align="left">瞬态错误（网络问题、速率限制）</td><td align="left">系统（自动）</td><td align="left">重试策略</td><td align="left">临时故障，通常在重试后解决。</td></tr><tr><td align="left">LLM 可恢复错误（工具故障、解析问题）</td><td align="left">LLM</td><td align="left">将错误存储在状态中并循环返回</td><td align="left">LLM能够发现错误并调整其方法</td></tr><tr><td align="left">用户可修正的错误（信息缺失、说明不清晰）</td><td align="left">人类</td><td align="left">暂停</td><td align="left">需要用户输入才能继续</td></tr><tr><td align="left">意外错误</td><td align="left">开发者</td><td align="left">让错误冒泡吧</td><td align="left">未知问题需要Debug</td></tr></tbody></table>
<h2 data-id="heading-7">第五步：将节点连接起来</h2>
<p>现在，我们将节点连接成一个可运行的工作流图。由于我们的节点能够处理自身的路由决策，我们只需要定义几条必要的边即可。</p>
<h2 data-id="heading-8">总结一下</h2>
<p>通过以上步骤我们总结一下 LangGraph 的思维方式：</p>
<ul>
<li>将任务分解成若干个独立的步骤，每个节点专注于做好一件事。</li>
<li>状态是共享的记忆，保存了原始数据。</li>
<li>每个节点都是一个函数，输入状态，输出更新后的状态。</li>
<li>错误是流程预设的一部分，通过多种策略修复它。</li>
<li>人工干预具有最高权限，等待人工干预时暂停执行，保存所有状态。</li>
<li>只需少量的必要连接，图结构由节点自行构建出来。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《Flutter全栈开发实战指南：从零到高级》- 14 -网络请求与数据解析]]></title>    <link>https://juejin.cn/post/7571892340878606374</link>    <guid>https://juejin.cn/post/7571892340878606374</guid>    <pubDate>2025-11-13T08:11:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571892340878606374" data-draft-id="7571830282849681459" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《Flutter全栈开发实战指南：从零到高级》- 14 -网络请求与数据解析"/> <meta itemprop="keywords" content="Flutter,Dart,iOS"/> <meta itemprop="datePublished" content="2025-11-13T08:11:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="QuantumLeap丶"/> <meta itemprop="url" content="https://juejin.cn/user/1767603104125197"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《Flutter全栈开发实战指南：从零到高级》- 14 -网络请求与数据解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1767603104125197/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    QuantumLeap丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T08:11:34.000Z" title="Thu Nov 13 2025 08:11:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">网络请求与数据解析</h2>
<blockquote>
<p>在移动开发中需要与云端服务器进行频繁的数据交互，本节内容讲带你详细了解网络请求与数据解析，让你的应用真正地“活”起来。</p>
</blockquote>
<h3 data-id="heading-1">一、 为什么网络层如此重要？</h3>
<p>举个例子：你正在开发一个新闻App，那些滚动的时事新闻、视频等内容，不可能全部打包在App安装包里，它们需要从服务器实时获取。这个“获取”的过程，就是通过网络请求完成的。</p>
<p>简单来说，流程就是：<strong>App 问服务器要数据 -&gt; 服务器返回数据 -&gt; App 把数据展示出来</strong>。</p>
<p>在Flutter中，常用的两个网络请求库：<strong>官方推荐的 <code>http</code> 库</strong> 和 <strong>社区维护得 <code>dio</code> 库</strong>。我们将从两者入手，带你彻底玩转网络请求。</p>
<h3 data-id="heading-2">二、 <code>http库</code> 与 <code>dio库</code> 如何选择？</h3>
<p>选择哪个库，就像选择工具，没有绝对的好坏，只有合不合适。</p>
<h4 data-id="heading-3">1. <code>http</code> 库</h4>
<p><code>http</code> 库是Flutter团队维护的底层库，它：</p>
<ul>
<li><strong>优点</strong>：官方维护，稳定可靠；API简单直接，学习成本低。</li>
<li><strong>缺点</strong>：功能相对基础，许多高级功能（如拦截器、文件上传/下载进度等）需要自己手动实现。</li>
</ul>
<p><strong>核心方法：</strong></p>
<ul>
<li><code>get()</code>: 向指定URL发起GET请求，用于获取数据。</li>
<li><code>post()</code>: 发起POST请求，用于提交数据。</li>
<li><code>put()</code>, <code>delete()</code>, <code>head()</code> 等：对应其他HTTP方法。</li>
</ul>
<h4 data-id="heading-4">2. <code>dio</code> 库</h4>
<p><code>dio</code> 是一个强大的第三方HTTP客户端，它：</p>
<ul>
<li><strong>优点</strong>：支持<strong>拦截器</strong>、<strong>全局配置</strong>、<strong>请求取消</strong>、<strong>FormData</strong>、<strong>文件上传/下载</strong>、<strong>超时设置</strong>等。</li>
<li><strong>缺点</strong>：相对于<code>http</code>库更重一些。</li>
</ul>
<p><strong>如何选择？</strong></p>
<ul>
<li><strong>新手入门</strong>：可以从 <code>http</code> 开始，上手快。</li>
<li><strong>中大型项目</strong>：强烈推荐 <code>dio</code>，它能帮你节省大量造轮子的时间。</li>
</ul>
<p><strong>本节内容主要以 <code>dio</code> 为例进行讲解</strong>，它更符合项目开发的实际情况。</p>
<h3 data-id="heading-5">三、 引入依赖</h3>
<p>首先，在你的 <code>pubspec.yaml</code> 文件中声明依赖。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">dependencies:</span>
  <span class="hljs-attr">flutter:</span>
    <span class="hljs-attr">sdk:</span> <span class="hljs-string">flutter</span>
  <span class="hljs-attr">dio:</span> <span class="hljs-string">^5.0.0</span> 
  <span class="hljs-comment"># 用于JSON序列化</span>
  <span class="hljs-attr">json_annotation:</span> <span class="hljs-string">^4.8.0</span>

<span class="hljs-attr">dev_dependencies:</span>
  <span class="hljs-attr">flutter_test:</span>
    <span class="hljs-attr">sdk:</span> <span class="hljs-string">flutter</span>
  <span class="hljs-attr">build_runner:</span> <span class="hljs-string">^2.3.0</span>
  <span class="hljs-attr">json_serializable:</span> <span class="hljs-string">^6.5.0</span>
</code></pre>
<p>执行 <code>flutter pub get</code> 安装依赖。</p>
<h3 data-id="heading-6">四、 <code>http</code> 库</h3>
<p>虽然我们推荐使用<code>dio</code>库，但了解<code>http</code>库的基本用法仍是必要的。</p>
<p><strong>以获取一篇博客文章信息为例</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:http/http.dart'</span> <span class="hljs-keyword">as</span> http; 
<span class="hljs-keyword">import</span> <span class="hljs-string">'dart:convert'</span>; 

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HttpExample</span> </span>{
  
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-keyword">void</span>&gt; fetchPost() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 1. 发起GET请求</span>
      <span class="hljs-keyword">final</span> response = <span class="hljs-keyword">await</span> http.<span class="hljs-keyword">get</span>(
        <span class="hljs-built_in">Uri</span>.parse(<span class="hljs-string">'https://jsonplaceholder.typicode.com/posts/1'</span>),
      );

      <span class="hljs-comment">// 2. 状态码200表示成功</span>
      <span class="hljs-keyword">if</span> (response.statusCode == <span class="hljs-number">200</span>) {
        <span class="hljs-comment">// 3. 使用 dart:convert 解析返回的JSON字符串</span>
        <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; jsonData = json.decode(response.body);
        
        <span class="hljs-comment">// 4. 从解析后的Map中取出数据</span>
        <span class="hljs-built_in">String</span> title = jsonData[<span class="hljs-string">'title'</span>];
        <span class="hljs-built_in">String</span> body = jsonData[<span class="hljs-string">'body'</span>];
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'标题: <span class="hljs-subst">$title</span>'</span>);
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'内容: <span class="hljs-subst">$body</span>'</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 请求失败</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'请求失败，状态码: <span class="hljs-subst">${response.statusCode}</span>'</span>);
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'响应体: <span class="hljs-subst">${response.body}</span>'</span>);
      }
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-comment">// 捕获异常</span>
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'请求发生异常: <span class="hljs-subst">$e</span>'</span>);
    }
  }
}
</code></pre>
<p><strong>代码解读：</strong></p>
<ol>
<li><code>async</code>/<code>await</code>：网络请求是耗时操作，必须使用异步。<code>await</code> 会等待请求完成，而不会阻塞UI线程。</li>
<li><code>Uri.parse</code>：将字符串URL转换为Uri对象。</li>
<li><code>response.statusCode</code>：响应状态码，<strong>200系列表示成功</strong>。</li>
<li><code>json.decode()</code>：反序列化将JSON串转换为Dart中的 <code>Map&lt;String, dynamic&gt;</code> 或 <code>List</code>；</li>
</ol>
<h3 data-id="heading-7">五、 <code>dio</code> 库</h3>
<p>下面我们重点讲解下<code>dio</code>库：</p>
<h4 data-id="heading-8">1. Dio-发起请求</h4>
<p>我们先创建一个Dio实例并进行全局配置。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:dio/dio.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DioManager</span> </span>{
  <span class="hljs-comment">// 单例</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> DioManager _instance = DioManager._internal();
  <span class="hljs-keyword">factory</span> DioManager() =&gt; _instance;
  DioManager._internal() {
    _dio = Dio(BaseOptions(
      baseUrl: <span class="hljs-string">'https://jsonplaceholder.typicode.com'</span>, 
      connectTimeout: <span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">5</span>), <span class="hljs-comment">// 连接超时时间</span>
      receiveTimeout: <span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">3</span>), <span class="hljs-comment">// 接收数据超时时间</span>
      headers: {
        <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>, 
      },
    ));
  }

  <span class="hljs-keyword">late</span> <span class="hljs-keyword">final</span> Dio _dio;
  Dio <span class="hljs-keyword">get</span> dio =&gt; _dio;
}

<span class="hljs-comment">// GET请求</span>
<span class="hljs-keyword">void</span> fetchPostWithDio() <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// baseUrl后面拼接路径</span>
    Response response = <span class="hljs-keyword">await</span> DioManager().dio.<span class="hljs-keyword">get</span>(<span class="hljs-string">'/posts/1'</span>);
    <span class="hljs-comment">// dio会自动检查状态码，非200系列会抛异常，所以这里直接处理数据</span>
    <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; data = response.data; <span class="hljs-comment">// 这里dio帮我们自动解析了JSON</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'获取数据: <span class="hljs-subst">${data[<span class="hljs-string">'title'</span>]}</span>'</span>);
  } <span class="hljs-keyword">on</span> DioException <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'请求异常: <span class="hljs-subst">$e</span>'</span>);
    <span class="hljs-keyword">if</span> (e.response != <span class="hljs-keyword">null</span>) {
      <span class="hljs-comment">// 错误状态码</span>
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'错误状态码: <span class="hljs-subst">${e.response?.statusCode}</span>'</span>);
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'错误信息: <span class="hljs-subst">${e.response?.data}</span>'</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 抛异常</span>
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'异常: <span class="hljs-subst">${e.message}</span>'</span>);
    }
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-comment">// 未知异常</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'未知异常: <span class="hljs-subst">$e</span>'</span>);
  }
}
</code></pre>
<p><strong>Dio相比Http的优点：</strong></p>
<ul>
<li><strong>自动JSON解析</strong>：<code>response.data</code> 直接就是Map或List，无需手动 <code>json.decode</code>，太方便了！</li>
<li><strong>配置清晰</strong>：<code>BaseOptions</code> 全局配置一目了然。</li>
<li><strong>结构化异常</strong>：<code>DioException</code> 包含了丰富的错误信息。</li>
</ul>
<h4 data-id="heading-9">2. Dio-网络请求流程</h4>
<p>为了让大家更直观地理解，我们用一个流程图来展示Dio处理请求的完整过程：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant A as 客户端
    participant I as 拦截器
    participant D as Dio
    participant S as 服务端

    A-&gt;&gt;D: 发起请求
    Note right of A: await dio.get('/users')
    
    D-&gt;&gt;I: 请求拦截器
    Note right of I: 添加Token、日志等
    
    I-&gt;&gt;D: 处理后的请求
    D-&gt;&gt;S: 发送网络请求
    
    S--&gt;&gt;D: 返回响应
    D-&gt;&gt;I: 响应拦截器
    Note right of I: 解析JSON、错误处理
    
    I-&gt;&gt;D: 处理后的响应
    D--&gt;&gt;A: 返回最终结果
</code></pre>
<h4 data-id="heading-10">3. Dio-拦截器</h4>
<p>拦截器允许我们在请求发送前和响应返回后，插入自定义逻辑，对所有经过的请求和响应进行检查和加工。</p>
<p><strong>案例：自动添加认证Token</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthInterceptor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Interceptor</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> onRequest(RequestOptions options, RequestInterceptorHandler handler) {
    <span class="hljs-comment">// 请求发送前，为每个请求的Header加上Token</span>
    <span class="hljs-keyword">const</span> <span class="hljs-built_in">String</span> token = <span class="hljs-string">'your_auth_token_here'</span>;
    <span class="hljs-keyword">if</span> (token.isNotEmpty) {
      options.headers[<span class="hljs-string">'Authorization'</span>] = <span class="hljs-string">'Bearer <span class="hljs-subst">$token</span>'</span>;
    }
    
    handler.next(options);
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> onResponse(Response response, ResponseInterceptorHandler handler) {
    <span class="hljs-comment">// 响应成功处理</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'请求成功: <span class="hljs-subst">${response.requestOptions.path}</span>'</span>);
    handler.next(response);
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> onError(DioException err, ErrorInterceptorHandler handler) {
    <span class="hljs-comment">// 失败处理</span>
    <span class="hljs-comment">// 当Token过期时，自动跳转到登录页</span>
    <span class="hljs-keyword">if</span> (err.response?.statusCode == <span class="hljs-number">401</span>) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'Token已过期，请重新登录!'</span>);
      <span class="hljs-comment">// 这里可以跳转到登录页面</span>
      <span class="hljs-comment">// NavigationService.instance.navigateTo('/login');</span>
    }
 
    handler.next(err);
  }
}

<span class="hljs-comment">// 将拦截器添加到Dio实例中</span>
<span class="hljs-keyword">void</span> main() {
  <span class="hljs-keyword">final</span> dio = DioManager().dio;
  dio.interceptors.add(AuthInterceptor());
  <span class="hljs-comment">// 这里可以添加其他拦截器</span>
  dio.interceptors.add(LogInterceptor(responseBody: <span class="hljs-keyword">true</span>)); 
}
</code></pre>
<blockquote>
<p>拦截器的添加顺序就是它们的执行顺序。<code>onRequest</code> 正序执行，<code>onResponse</code> 和 <code>onError</code> 倒序执行。</p>
</blockquote>
<h3 data-id="heading-11">六、 JSON序列化与反序列化</h3>
<blockquote>
<p>这是新手最容易踩坑的地方。直接从JSON转换成Dart对象（Model），能让我们的代码更安全、更易维护。</p>
</blockquote>
<h4 data-id="heading-12">1. 为什么要序列化？</h4>
<ul>
<li><strong>类型安全</strong>：直接操作Map，编译器不知道<code>data[‘title‘]</code>是String还是int，容易写错;</li>
<li><strong>代码效率</strong>：使用点语法<code>post.title</code>访问属性，比<code>post[‘title‘]</code>更高效且有代码提示;</li>
<li><strong>可维护性</strong>：当接口字段变更时，你只需要修改一个Model类，而不是分散在各处的字符串key;;</li>
</ul>
<h4 data-id="heading-13">2. 使用 <code>json_serializable</code>自动序列化</h4>
<p>通过代码生成的方式，自动创建 <code>fromJson</code> 和 <code>toJson</code> 方法，一劳永逸。</p>
<p><strong>步骤1：创建Model类并使用注解</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// post.dart</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:json_annotation/json_annotation.dart'</span>;

<span class="hljs-comment">// 运行 `flutter pub run build_runner build` 后，会生成 post.g.dart 文件</span>
<span class="hljs-keyword">part</span> <span class="hljs-string">'post.g.dart'</span>;

<span class="hljs-comment">// 这个注解告诉生成器这个类需要生成序列化代码</span>
<span class="hljs-meta">@JsonSerializable</span>()
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Post</span> </span>{
  <span class="hljs-comment">// 使用@JsonKey可以自定义序列化行为</span>
  <span class="hljs-comment">// 例如，如果JSON字段名是`user_id`，而Dart字段是`userId`，可以这样映射：</span>
  <span class="hljs-comment">// @JsonKey(name: 'user_id')</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> userId;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> id;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> title;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> body;

  Post({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.userId,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.id,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.title,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.body,
  });

  <span class="hljs-comment">// 生成的代码会提供这两个方法</span>
  <span class="hljs-keyword">factory</span> Post.fromJson(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; json) =&gt; _$PostFromJson(json);
  <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; toJson() =&gt; _$PostToJson(<span class="hljs-keyword">this</span>);
}
</code></pre>
<p><strong>步骤2：运行代码生成命令</strong></p>
<p>在项目根目录下执行：</p>
<pre><code class="hljs language-bash" lang="bash">flutter pub run build_runner build
</code></pre>
<p>这个命令会扫描所有带有 <code>@JsonSerializable()</code> 注解的类，并生成对应的 <code>.g.dart</code> 文件（如 <code>post.g.dart</code>）。这个文件里包含了 <code>_$PostFromJson</code> 和 <code>_$PostToJson</code> 的具体实现。</p>
<p><strong>步骤3：自动生成</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 具体的请求方法中使用</span>
<span class="hljs-keyword">void</span> fetchPostModel() <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">try</span> {
    Response response = <span class="hljs-keyword">await</span> DioManager().dio.<span class="hljs-keyword">get</span>(<span class="hljs-string">'/posts/1'</span>);
    <span class="hljs-comment">// 将响应数据转换为Post对象</span>
    Post post = Post.fromJson(response.data);
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'文章标题: <span class="hljs-subst">${post.title}</span>'</span>);
  } <span class="hljs-keyword">on</span> DioException <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-comment">// ... 错误处理</span>
  }
}
</code></pre>
<p><strong><code>json_serializable</code> 的优势：</strong></p>
<ul>
<li>自动处理类型转换，避免手误；</li>
<li>通过 <code>@JsonKey</code> 注解可以处理各种复杂场景；</li>
</ul>
<h3 data-id="heading-14">七、 网络层在MVVM模式中的定位</h3>
<p>实际项目中，我们不会直接在UI页面里写网络请求代码。让我们看看网络层在MVVM架构中是如何工作的：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[View&lt;br&gt;视图层] --&gt;|调用| B[ViewModel&lt;br&gt;视图模型]
    B --&gt;|调用| C[Model&lt;br&gt;模型层]
    C --&gt;|使用| D[Dio&lt;br&gt;网络层]
    D --&gt;|返回JSON| C
    C --&gt;|转换为Model| B
    B --&gt;|更新状态| A
</code></pre>
<p><strong>各个分层职责：</strong></p>
<ul>
<li><strong>View</strong>：只关心数据的展示和用户交互；</li>
<li><strong>ViewModel</strong>：持有业务状态，处理UI逻辑，不关心数据从哪里来；</li>
<li><strong>Model</strong>：决定数据是从网络获取还是本地数据库读取，它调用网络层；</li>
<li><strong>Dio</strong>：纯粹的网络请求执行者，负责API调用、错误初步处理等；</li>
</ul>
<p><strong>这样分层的好处是：最终目的是解耦</strong>，各司其职，修改网络层不会影响业务逻辑，代码结构清晰，同事方便单元测试。</p>
<h3 data-id="heading-15">八、 错误处理</h3>
<p>一个好的应用，必须支持处理各种异常情况。</p>
<h4 data-id="heading-16">1.  <code>DioException</code></h4>
<p><code>DioException</code> 的类型 (<code>type</code>) 帮助我们准确判断错误根源。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">void</span> handleDioError(DioException e) {
  <span class="hljs-keyword">switch</span> (e.type) {
    <span class="hljs-keyword">case</span> DioExceptionType.connectionTimeout:
    <span class="hljs-keyword">case</span> DioExceptionType.sendTimeout:
    <span class="hljs-keyword">case</span> DioExceptionType.receiveTimeout:
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'超时错误，请检查网络连接是否稳定。'</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> DioExceptionType.badCertificate:
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'证书错误。'</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> DioExceptionType.badResponse:
      <span class="hljs-comment">// 服务器返回了错误状态码</span>
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'服务器错误: <span class="hljs-subst">${e.response?.statusCode}</span>'</span>);
      <span class="hljs-comment">// 可以根据不同状态码做不同处理</span>
      <span class="hljs-keyword">if</span> (e.response?.statusCode == <span class="hljs-number">404</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'请求的资源不存在(404)'</span>);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e.response?.statusCode == <span class="hljs-number">500</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'服务器内部错误(500)'</span>);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e.response?.statusCode == <span class="hljs-number">401</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'未授权，请重新登录(401)'</span>);
      }
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> DioExceptionType.cancel:
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'请求被取消。'</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> DioExceptionType.connectionError:
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'网络连接错误，请检查网络是否开启。'</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> DioExceptionType.unknown:
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'未知错误: <span class="hljs-subst">${e.message}</span>'</span>);
      <span class="hljs-keyword">break</span>;
  }
}
</code></pre>
<h4 data-id="heading-17">2. 重试机制</h4>
<p>对于因网络波动导致的失败，自动重试能大幅提升用户体验。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RetryInterceptor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Interceptor</span> </span>{
  <span class="hljs-keyword">final</span> Dio _dio;

  RetryInterceptor(<span class="hljs-keyword">this</span>._dio);

  <span class="hljs-meta">@override</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; onError(DioException err, ErrorInterceptorHandler handler) <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 只对超时和网络连接错误进行重试</span>
    <span class="hljs-keyword">if</span> (err.type == DioExceptionType.connectionTimeout ||
        err.type == DioExceptionType.receiveTimeout ||
        err.type == DioExceptionType.connectionError) {
      
      <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> retryCount = err.requestOptions.extra[<span class="hljs-string">'retry_count'</span>] ?? <span class="hljs-number">0</span>;
      <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> maxRetryCount = <span class="hljs-number">3</span>;

      <span class="hljs-keyword">if</span> (retryCount &lt; maxRetryCount) {
        <span class="hljs-comment">// 增加重试计数</span>
        err.requestOptions.extra[<span class="hljs-string">'retry_count'</span>] = retryCount + <span class="hljs-number">1</span>;
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'网络不稳定，正在尝试第<span class="hljs-subst">${retryCount + <span class="hljs-number">1</span>}</span>次重试...'</span>);

        <span class="hljs-comment">// 等待一段时间后重试</span>
        <span class="hljs-keyword">await</span> Future.delayed(<span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">1</span> * (retryCount + <span class="hljs-number">1</span>)));

        <span class="hljs-keyword">try</span> {
          <span class="hljs-comment">// 重新发送请求</span>
          <span class="hljs-keyword">final</span> Response response = <span class="hljs-keyword">await</span> _dio.fetch(err.requestOptions);
          <span class="hljs-comment">// 返回成功response</span>
          handler.resolve(response);
          <span class="hljs-keyword">return</span>;
        } <span class="hljs-keyword">catch</span> (retryError) {
          <span class="hljs-comment">// 如果失败继续传递错误</span>
          handler.next(err);
          <span class="hljs-keyword">return</span>;
        }
      }
    }
    <span class="hljs-comment">// 如果不是指定错误或已达最大重试次数，则继续传递错误</span>
    handler.next(err);
  }
}
</code></pre>
<h3 data-id="heading-18">九、 封装一个完整的网络请求库</h3>
<p>到这已经把所有的网络请求知识学完了，下面我们用学到的知识封装一个通用的网络请求工具类。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// http_client.dart</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:dio/dio.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/foundation.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HttpClient</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> HttpClient _instance = HttpClient._internal();
  <span class="hljs-keyword">factory</span> HttpClient() =&gt; _instance;

  <span class="hljs-keyword">late</span> <span class="hljs-keyword">final</span> Dio _dio;

  HttpClient._internal() {
    _dio = Dio(BaseOptions(
      baseUrl: <span class="hljs-string">'https://api.yourserver.com/v1'</span>,
      connectTimeout: <span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">10</span>),
      receiveTimeout: <span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">10</span>),
      headers: {<span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>},
    ));

    <span class="hljs-comment">// 添加拦截器</span>
    _dio.interceptors.add(LogInterceptor(
      requestBody: kDebugMode, 
      responseBody: kDebugMode,
    ));
    _dio.interceptors.add(AuthInterceptor());
    _dio.interceptors.add(RetryInterceptor(_dio));
  }

  <span class="hljs-comment">// 封装GET请求</span>
  Future&lt;Response&lt;T&gt;&gt; <span class="hljs-keyword">get</span>&lt;T&gt;(
    <span class="hljs-built_in">String</span> path, {
    <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? queryParameters,
    <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? headers,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> options = Options(headers: headers);
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> _dio.<span class="hljs-keyword">get</span>&lt;T&gt;(
        path,
        queryParameters: queryParameters,
        options: options,
      );
    } <span class="hljs-keyword">on</span> DioException {
      <span class="hljs-keyword">rethrow</span>; 
    }
  }

  <span class="hljs-comment">// 封装POST请求</span>
  Future&lt;Response&lt;T&gt;&gt; post&lt;T&gt;(
    <span class="hljs-built_in">String</span> path, {
    <span class="hljs-built_in">dynamic</span> data,
    <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? queryParameters,
    <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? headers,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> options = Options(headers: headers);
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> _dio.post&lt;T&gt;(
        path,
        data: data,
        queryParameters: queryParameters,
        options: options,
      );
    } <span class="hljs-keyword">on</span> DioException {
      <span class="hljs-keyword">rethrow</span>;
    }
  }

  <span class="hljs-comment">// 获取列表数据</span>
  Future&lt;<span class="hljs-built_in">List</span>&lt;T&gt;&gt; getList&lt;T&gt;(
    <span class="hljs-built_in">String</span> path, {
    <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? queryParameters,
    T <span class="hljs-built_in">Function</span>(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;)? fromJson,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> response = <span class="hljs-keyword">await</span> <span class="hljs-keyword">get</span>&lt;<span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">dynamic</span>&gt;&gt;(path, queryParameters: queryParameters);
    <span class="hljs-comment">// 将List&lt;dynamic&gt;转换为List&lt;T&gt;</span>
    <span class="hljs-keyword">if</span> (fromJson != <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">return</span> response.data!.map&lt;T&gt;((item) =&gt; fromJson(item <span class="hljs-keyword">as</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;)).toList();
    }
    
    <span class="hljs-keyword">return</span> response.data <span class="hljs-keyword">as</span> <span class="hljs-built_in">List</span>&lt;T&gt;;
  }

  <span class="hljs-comment">// 获取单个对象</span>
  Future&lt;T&gt; getItem&lt;T&gt;(
    <span class="hljs-built_in">String</span> path, {
    <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? queryParameters,
    <span class="hljs-keyword">required</span> T <span class="hljs-built_in">Function</span>(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;) fromJson,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> response = <span class="hljs-keyword">await</span> <span class="hljs-keyword">get</span>&lt;<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;&gt;(path, queryParameters: queryParameters);
    <span class="hljs-keyword">return</span> fromJson(response.data!);
  }
}

<span class="hljs-comment">// </span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PostRepository</span> </span>{
  <span class="hljs-keyword">final</span> HttpClient _client = HttpClient();

  Future&lt;Post&gt; getPost(<span class="hljs-built_in">int</span> id) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> response = <span class="hljs-keyword">await</span> _client.getItem(
      <span class="hljs-string">'/posts/<span class="hljs-subst">$id</span>'</span>,
      fromJson: Post.fromJson, 
    );
    <span class="hljs-keyword">return</span> response;
  }

  Future&lt;<span class="hljs-built_in">List</span>&lt;Post&gt;&gt; getPosts() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> response = <span class="hljs-keyword">await</span> _client.getList(
      <span class="hljs-string">'/posts'</span>,
      fromJson: Post.fromJson,
    );
    <span class="hljs-keyword">return</span> response;
  }

  Future&lt;Post&gt; createPost(Post post) <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// Model转JSON</span>
    <span class="hljs-keyword">final</span> response = <span class="hljs-keyword">await</span> _client.post(
      <span class="hljs-string">'/posts'</span>,
      data: post.toJson(),
    );
    <span class="hljs-keyword">return</span> Post.fromJson(response.data);
  }
}
</code></pre>
<h3 data-id="heading-19">总结</h3>
<p>又到了写总结诶的时候了，让我们用一张表格来回顾所有知识点：</p>













































<table><thead><tr><th align="left">知识点</th><th align="left">核心</th><th align="left">用途</th></tr></thead><tbody><tr><td align="left"><strong>库选择</strong></td><td align="left"><code>http</code> 轻量，<code>dio</code> 强大</td><td align="left">中大型项目首选 <code>dio</code></td></tr><tr><td align="left"><strong>异步编程</strong></td><td align="left">使用 <code>async</code>/<code>await</code> 处理耗时操作</td><td align="left">不能阻塞UI线程</td></tr><tr><td align="left"><strong>JSON序列化</strong></td><td align="left">自动生成</td><td align="left"><strong>推荐</strong> <code>json_serializable</code></td></tr><tr><td align="left"><strong>错误处理</strong></td><td align="left">区分网络异常和服务器错误</td><td align="left">精确捕获 <code>DioException</code> 并分类处理</td></tr><tr><td align="left"><strong>拦截器</strong></td><td align="left">统一处理请求/响应</td><td align="left">用于添加Token、日志、重试逻辑</td></tr><tr><td align="left"><strong>架构分层</strong></td><td align="left">MVVM</td><td align="left">分离解耦</td></tr><tr><td align="left"><strong>请求封装</strong></td><td align="left">统一封装GET/POST等基础方法</td><td align="left">提供 <code>getItem</code>, <code>getList</code> 等语义化方法</td></tr></tbody></table>
<p>网络请求在实际项目中直观重要，没有网络就没有数据，掌握好本章内容，你就能为你Flutter应用注入源源不断的活力。让我们下期见！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[“误操作导致 feat 功能未生效，尽管 merge 已完成”]]></title>    <link>https://juejin.cn/post/7571734313928015906</link>    <guid>https://juejin.cn/post/7571734313928015906</guid>    <pubDate>2025-11-13T08:29:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571734313928015906" data-draft-id="7571559178742874147" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="“误操作导致 feat 功能未生效，尽管 merge 已完成”"/> <meta itemprop="keywords" content="Git"/> <meta itemprop="datePublished" content="2025-11-13T08:29:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="山有木兮木有枝_"/> <meta itemprop="url" content="https://juejin.cn/user/3393532732927097"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            “误操作导致 feat 功能未生效，尽管 merge 已完成”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3393532732927097/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    山有木兮木有枝_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T08:29:27.000Z" title="Thu Nov 13 2025 08:29:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>场景：</p>
<blockquote>
<p><strong>假如在本地 <code>test</code> 分支合并了远程分支（比如 <code>feat</code>），但在合并过程中“放弃了某些文件的修改”（比如手动 checkout 或 restore 覆盖了冲突文件，但没正确提交或处理），导致本地 <code>test</code> 的内容和远程 <code>test</code> 不一致。现在你想再次合并，Git 却提示“Already up to date”（已经是最新），但实际上代码并不一致。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-0">🔍 问题本质</h2>
<p>Git 判断是否“需要合并”的依据是 <strong>提交历史（commit history）</strong> ，而不是文件内容。</p>
<ul>
<li>如果你本地 <code>test</code> 分支的 <strong>最新提交</strong> 已经包含了远程 <code>feat</code> 分支的所有提交（通过之前的合并），那么 Git 就认为“无需再合并”，即使你<strong>手动改过文件内容</strong>。</li>
<li>换句话说：<strong>你本地丢弃了某些变更，但 Git 的历史记录仍然认为“这些变更已经被合并过了”</strong> 。</li>
</ul>
<p>所以，<code>git merge origin/feat</code> → 提示 “Already up to date”，但文件内容却不是 <code>feat</code> 分支的样子。</p>
<hr/>
<h2 data-id="heading-1">✅ 解决方案</h2>
<h3 data-id="heading-2">✅ 方法一：<strong>重新应用 feat 分支的变更（推荐）</strong></h3>
<p>目标：让 <code>test</code> 分支真正拥有 <code>feat</code> 分支中那些被你丢弃的文件内容。</p>
<h4 data-id="heading-3">步骤：</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 确保在 test 分支</span>
git checkout <span class="hljs-built_in">test</span>

<span class="hljs-comment"># 2. 获取最新远程信息</span>
git fetch origin

<span class="hljs-comment"># 3. 直接从远程 feat 分支检出你需要的文件（覆盖当前）</span>
git checkout origin/feat -- path/to/file1 path/to/file2

<span class="hljs-comment"># 或者如果你要整个 feat 分支的全部文件（谨慎！）</span>
<span class="hljs-comment"># git checkout origin/feat -- .</span>

<span class="hljs-comment"># 4. 提交这个“修正”</span>
git add .
git commit -m <span class="hljs-string">"fix: restore files from feat branch that were dropped during merge"</span>

<span class="hljs-comment"># 5. 推送到远程 test（如果需要）</span>
git push origin <span class="hljs-built_in">test</span>
</code></pre>
<blockquote>
<p>这样做不会改变历史，只是新增一个提交来“补回”之前丢失的内容。</p>
</blockquote>
<hr/>
<h3 data-id="heading-4">✅ 方法二：<strong>撤销之前的错误合并，重新合并</strong></h3>
<p>如果之前的合并是“错误的”（因为丢弃了重要内容），可以<strong>回退那次合并提交</strong>，然后重新干净地合并。</p>
<h4 data-id="heading-5">步骤：</h4>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 1. 查看提交历史，找到错误合并的提交 ID（假设是 abc1234）</span>
git <span class="hljs-keyword">log</span> --oneline -<span class="hljs-number">10</span>

<span class="hljs-comment"># 2. 回退到合并前的状态（保留更改在工作区，方便检查）</span>
git <span class="hljs-keyword">reset</span> --hard HEAD~<span class="hljs-number">1</span>   <span class="hljs-comment"># 如果合并是上一个提交</span>

<span class="hljs-comment"># 或者更安全的方式：创建一个新分支备份当前状态</span>
git branch backup-test

<span class="hljs-comment"># 然后硬重置</span>
git <span class="hljs-keyword">reset</span> --hard &lt;合并前的提交ID&gt;

<span class="hljs-comment"># 3. 重新合并 feat</span>
git merge origin/feat

<span class="hljs-comment"># 这次认真处理冲突，不要随意丢弃修改！</span>

<span class="hljs-comment"># 4. 推送（可能需要 force，如果是共享分支请谨慎！）</span>
git <span class="hljs-keyword">push</span> --force-with-lease origin test
</code></pre>
<blockquote>
<p>⚠️ 注意：如果 <code>test</code> 是多人协作的公共分支，<strong>强制推送会重写历史</strong>，务必先沟通！</p>
</blockquote>
<hr/>
<h3 data-id="heading-6">✅ 方法三：用 <code>cherry-pick</code> 补关键提交（适用于只丢了几份文件）</h3>
<p>如果 <code>feat</code> 分支只有少数几个提交修改了关键文件，你可以单独 pick 这些提交：</p>
<pre><code class="hljs language-python" lang="python">git cherry-pick &lt;commit-<span class="hljs-built_in">id</span>-that-modified-the-file&gt;
</code></pre>
<hr/>
<h2 data-id="heading-7">🛡️ 如何避免下次再发生？</h2>
<ol>
<li><strong>不要在合并冲突时随意 <code>git checkout --theirs</code> 或手动覆盖而不提交</strong><br/>
→ 应该解决冲突后 <code>git add</code> + <code>git commit</code>。</li>
<li><strong>合并前先 <code>git status</code> 和 <code>git diff</code> 确认内容</strong></li>
<li><strong>使用 PR/MR（Pull Request / Merge Request）机制</strong><br/>
→ 在 Web 界面审查变更，避免本地误操作。</li>
<li><strong>合并后运行测试，确认功能正常</strong></li>
</ol>
<hr/>
<h2 data-id="heading-8">🔚 总结</h2>















<table><thead><tr><th>问题</th><th>原因</th><th>解法</th></tr></thead><tbody><tr><td>Git 说“Already up to date”但文件不对</td><td>合并历史存在，但文件内容被手动丢弃</td><td>① 手动检出文件并提交；② 回退合并重做</td></tr></tbody></table>
<p>最安全、最简单的做法是：<br/>
👉 <strong>用 <code>git checkout origin/feat -- 文件路径</code> 把缺失的文件补回来，然后提交推送。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【跨国数仓迁移最佳实践11】基于 MaxCompute Resource & Quota策略优化实现资源管理性能与成本最优平衡]]></title>    <link>https://juejin.cn/post/7571815997067411496</link>    <guid>https://juejin.cn/post/7571815997067411496</guid>    <pubDate>2025-11-13T08:30:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571815997067411496" data-draft-id="7571722835659014178" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【跨国数仓迁移最佳实践11】基于 MaxCompute Resource &amp; Quota策略优化实现资源管理性能与成本最优平衡"/> <meta itemprop="keywords" content="大数据"/> <meta itemprop="datePublished" content="2025-11-13T08:30:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【跨国数仓迁移最佳实践11】基于 MaxCompute Resource &amp; Quota策略优化实现资源管理性能与成本最优平衡
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T08:30:10.000Z" title="Thu Nov 13 2025 08:30:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本系列文章将围绕东南亚头部科技集团的真实迁移历程展开，逐步拆解 BigQuery 迁移至 MaxCompute 过程中的关键挑战与技术创新。本篇为第十一篇，基于 MaxCompute Resource &amp; Quota策略优化实现资源管理性能与成本最优平衡。</p>
<p>注：客户背景为东南亚头部科技集团，文中用 GoTerra 表示。</p>
<h2 data-id="heading-0">1. 背景</h2>
<p>GoTerra作为东南亚互联网头部企业，其业务生态覆盖网约车、电商、外卖、物流及金融支付等多个垂直领域，内部采用多账户架构（10+ Accounts，70+ Projects）及上百个资源额度组（Quota Group）进行精细化管理。在从BigQuery迁移至阿里云MaxCompute的过程中，对资源管理的核心诉求在于通过智能弹性资源分配策略，动态适配业务负载波动，在控制成本的同时避免资源瓶颈，实现性能与成本的最优平衡。面临以下核心挑战：</p>
<p><strong>多业务线资源协调复杂</strong></p>
<ul>
<li><strong>规模庞大</strong>：跨10+独立业务单元（Account），涉及70+项目（Project），需创建100+资源额度组（Quota Group），资源管理颗粒度极细。</li>
<li><strong>资源预留成本压力</strong>：每个Quota Group需按配置预留资源（CU），预付费模式下资源闲置与成本控制难以平衡。</li>
</ul>
<p><strong>计费模式差异带来的不确定性</strong></p>
<ul>
<li><strong>MaxCompute</strong>：预付费CU + 定时弹性资源模式，迁移前缺乏历史数据支撑，无法精准预估所需CU量，存在资源预留不足（性能瓶颈）或过度配置（成本浪费）的双重风险</li>
</ul>
<p><strong>多类型作业资源需求冲突</strong></p>
<ul>
<li><strong>ETL作业</strong>：需保障1小时内完成海量数据处理，依赖高吞吐计算资源。</li>
<li><strong>BI作业</strong>：要求10-15分钟低延迟响应，需快速分配临时资源。</li>
<li><strong>并存挑战</strong>：长周期ETL与短周期BI作业共享资源池，如何动态调度以避免资源争抢、同时满足不同SLA（服务等级协议），成为性能与成本平衡的关键难题。</li>
</ul>
<h2 data-id="heading-1">2. Resource Advisor和TopN Fair</h2>
<h3 data-id="heading-2">2.1. Resource Advisor</h3>
<h4 data-id="heading-3">2.1.1. 核心挑战</h4>
<p><strong>资源预估难题:</strong></p>
<ul>
<li>计费模式差异</li>
<li>作业类型复杂</li>
</ul>
<p><strong>多业务实体管理，每个业务实体需独立阿里云账号，SLA要求不同，导致资源购买量预期不一致：</strong></p>
<ul>
<li>超买：资源闲置浪费，挤占集群容量</li>
<li>少买：作业堆积，等资源时间长，影响业务数据产出</li>
</ul>
<p>如何在控制成本的前提下，动态适配业务负载波动，避免资源瓶颈</p>
<h4 data-id="heading-4">2.1.2. 分层资源配置策略</h4>





























<table><thead><tr><th>资源配置</th><th>用途</th><th>配置原则</th><th>计费</th></tr></thead><tbody><tr><td>预付费CU</td><td>保障全天候基线资源需求，覆盖日常稳定负载</td><td>基于历史日均负载的80%-90%预购CU适用于ETL类周期性作业（如每日定时批处理）。</td><td>按购买量计费，24h预留，计费时间24h</td></tr><tr><td>定时弹性CU(Adhoc)</td><td>适用于可预测的负载波动（如BI报表每日上午集中执行）</td><td>在业务高峰期（如早晚高峰）自动扩容资源，峰值后释放</td><td>指定时间计费按购买量计费，指定时间预留</td></tr><tr><td>AutoScaleQuota</td><td>应对突发BI作业流量</td><td>预估突发流量峰值，配置弹性上限</td><td>动态监控实时资源利用率，触发自动扩缩容。超出预付费CU+Adhoc CU部分按分钟级计费，避免突发流量导致的资源不足</td></tr></tbody></table>
<p>其中AutoScaleQuota是应对GoTerra迁移场景新增的产品类型，解决迁移过程中，业务资源需求变化快，作业性能要求高的需求：</p>
<p>分层配置策略特点：</p>
<ul>
<li>
<p><strong>灵活组合</strong>：支持预付费、分时弹性与自动弹性任意搭配，满足不同业务场景的降本增效需求</p>
</li>
<li>
<p><strong>极致成本</strong>：自动弹性部分，按实际使用量计费；相比扩缩槽等预留付费模式更加经济实惠</p>
</li>
<li>
<p><strong>开箱即用</strong>：基于负载感知的自动弹性扩缩容，配置简单</p>
</li>
<li>
<p><strong>秒级弹性</strong>：对比BigQuery限制扩缩容步长和窗口期，MaxCompute更加灵活及时</p>
</li>
<li>
<p><strong>资源稳定</strong>：基于历史数据和预测模型进行资源调度优化，保障弹性库存供给</p>
</li>
</ul>
<h4 data-id="heading-5">2.1.3. 智能资源推荐与弹性配置</h4>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2025/jpeg/27030/1755447893739-4d81b9fc-e3c2-443f-88ec-b41693951a22.jpeg" alt="img" loading="lazy"/></p>
<p>资源推荐工具（T+1动态调优）</p>
<p><strong>核心功能：</strong></p>
<ul>
<li>基于历史数据的作业运行日志与资源消耗，结合作业类型（ETL/BI）的SLA要求，预测次日CU需求。</li>
</ul>
<p><strong>技术实现：</strong></p>
<ul>
<li>数据采集：抓取作业运行时长、CPU/内存消耗、并发度等指标。</li>
<li>作业分类模型：自动识别ETL/BI作业。</li>
</ul>
<p><strong>资源预测算法：</strong></p>
<ul>
<li>线性回归：基于历史资源消耗趋势预测基线需求。</li>
<li>弹性缓冲：根据业务波动率增加10%-20%冗余量。</li>
<li>反馈优化：每日对比实际资源消耗与预测值，动态调整模型参数。</li>
</ul>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2025/png/27030/1755447804209-897f84f9-8a75-4172-a4d7-dbadc8e06fcd.png" alt="img" loading="lazy"/></p>
<h4 data-id="heading-6">2.1.4. 推荐效果</h4>
<p>GoTerra迁入MaxCompute过程中，MaxCompute进行了深度架构升级和性能优化，同时在合理的资源配置规划下，根据用户历史作业数据定期推荐用户Quota组配置和策略，每月实际产生费用约降低到BigQuery的42%。</p>
<h3 data-id="heading-7">2.2. TopN Fair</h3>
<h4 data-id="heading-8">2.2.1. 现有调度策略局限性</h4>

























<table><thead><tr><th/><th>FIFO</th><th>FAIR</th></tr></thead><tbody><tr><td>调度策略说明</td><td>对于作业优先级相同的场景，资源将优先分配至先提交的作业。对于作业优先级不同的场景，即使优先级高的作业提交时间晚于优先级低的作业，资源也将优先分配至高优先级作业。</td><td>对于作业优先级相同的场景，资源将平均分配至同一时间提交的所有作业。对于作业优先级不同的场景，资源优先平均分配给优先级较高的作业，若有剩余，再平均分配给优先级较低的作业</td></tr><tr><td>优点&amp;适用场景</td><td>保障先提交的作业优先执行，适合ETL类长时间任务</td><td>资源均分给最高优先级的所有作业，适合短时BI任务</td></tr><tr><td>缺点</td><td>小作业需等待长作业完成，导致延迟（“头阻塞”)</td><td>先提交的作业可能因资源被平分走而延长执行时间</td></tr></tbody></table>
<p>GOTO业务需求</p>
<p><strong>混合负载场景：ETL（长作业）与BI（短作业）并存</strong></p>
<p><strong>核心诉求：</strong></p>
<ul>
<li>长作业优先：先提交的ETL作业需保障足够并发资源</li>
<li>短作业友好：后提交的BI作业可短时借用资源，但不显著影响长作业进度</li>
</ul>
<h4 data-id="heading-9">2.2.2. 新策略：TopN Fair + 动态并发保障</h4>
<h6 data-id="heading-10">2.2.2.1. 核心设计目标</h6>
<ul>
<li>资源隔离：确保长作业的最低并发度（JobMinimumConcurrency）。</li>
<li>弹性资源复用：在满足长作业的前提下，允许Quota组保留部分资源给短作业动态借用。</li>
<li>优先级分层：结合作业类型（ETL/BI）和提交时间，实现混合调度。</li>
</ul>
<h6 data-id="heading-11">2.2.2.2. 关键参数定义</h6>
<ul>
<li>JobMinimumConcurrency（最低并发度）：</li>
<li>每个作业运行所需的最小并发度。</li>
<li>全局配置项，例如：JobMinimumConcurrency=10 表示每个作业至少分配10个并发单元。</li>
<li>TopN Fair策略：</li>
<li>TopN作业：按提交时间排序，在至少保障每个作业JobMinimumConcurrency并发度的情况下，挑选前N个作业分配Quota组资源</li>
</ul>
<h6 data-id="heading-12">2.2.2.3. <strong>动态N值计算公式</strong></h6>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/__latex/0a5ab9849511b050a1193e319fef1a95.svg" alt="img" loading="lazy"/></p>
<p>计算出N，如果<img src="https://intranetproxy.alipay.com/skylark/lark/__latex/1b75d0123aca04d79d5f853ed77b7409.svg" alt="img" loading="lazy"/>，则<img src="https://intranetproxy.alipay.com/skylark/lark/__latex/2e5e940745bf407dc626f3a83aaf3e1d.svg" alt="img" loading="lazy"/></p>
<p>符号解释：</p>
<ul>
<li><img src="https://intranetproxy.alipay.com/skylark/lark/__latex/246dc4d855e50ae1dc924cc0a7d9c7d8.svg" alt="img" loading="lazy"/>：第i个作业的资源需求（如CPU核数、内存）。</li>
<li>Runtime：Quota组当前可用的资源量</li>
<li><img src="https://intranetproxy.alipay.com/skylark/lark/__latex/32ffe6a546bdc55dc0a2d71bb0929934.svg" alt="img" loading="lazy"/>：当前最少可参与资源分配的作业数</li>
</ul>
<p>公式含义：
动态计算N值，确保前N个作业的累计资源需求不超过Quota组总容量的JobMinimumConcurrency倍，且至少保障<img src="https://intranetproxy.alipay.com/skylark/lark/__latex/32ffe6a546bdc55dc0a2d71bb0929934.svg" alt="img" loading="lazy"/>个作业参与资源分配，避免少量作业占满整个组；</p>
<h4 data-id="heading-13">2.2.3. 策略优势</h4>





























<table><thead><tr><th>维度</th><th>FIFO</th><th>FAIR</th><th>TopN Fair + 短作业插队</th></tr></thead><tbody><tr><td>长作业保障</td><td>强</td><td>弱</td><td>强</td></tr><tr><td>短作业支持</td><td>差</td><td>强</td><td>强</td></tr><tr><td>使用场景</td><td>ETL</td><td>BI</td><td>ETL+BI混合场景</td></tr></tbody></table>
<h4 data-id="heading-14">2.2.4. 实际效果</h4>
<p>整集群作业平均运行数下降15.7%，作业运行时Latency 95分位值下降45.7%，GoTerra用户的效果较好的Quota组，作业平均运行数下降31.3%, 作业运行时Latency 95分位值下降75.4%。</p>
<h2 data-id="heading-15">3. 结语与展望</h2>
<p>GoTerra迁移到MaxCompute后，Resource Advisor持续通过智能资源推荐优化成本，目标将总体费用控制在BigQuery的40%以内。随着新产品AutoScaleQuota上线，资源管理实现全自动化：基于业务负载动态调整配额，无需人工干预，彻底解决突发流量导致的资源不足与作业等待问题。同时，TopN Fair已在印尼集群全面上线，后续的发展方向：分析各Quota组作业执行模式，自动配置JobMinimumConcurrency并动态切换调度策略，进一步提升资源利用率。</p>
<p>在性能与成本优化的基础上，稳定性也是一个非常重要的目标，系统稳定性目标达99.99%可用性，保障GoTerra在MaxCompute上实现“低成本、高效率、强稳定”的运行体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[物流信息总滞后？快递鸟在途监控 API，毫秒级响应让物流透明不等待]]></title>    <link>https://juejin.cn/post/7572022112102580250</link>    <guid>https://juejin.cn/post/7572022112102580250</guid>    <pubDate>2025-11-13T08:32:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572022112102580250" data-draft-id="7572002432450166793" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="物流信息总滞后？快递鸟在途监控 API，毫秒级响应让物流透明不等待"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-13T08:32:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="快递鸟"/> <meta itemprop="url" content="https://juejin.cn/user/4279725171674573"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            物流信息总滞后？快递鸟在途监控 API，毫秒级响应让物流透明不等待
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4279725171674573/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    快递鸟
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T08:32:48.000Z" title="Thu Nov 13 2025 08:32:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>物流信息滞后，早已是困扰商家与用户的核心痛点 —— 用户下单后反复刷新查不到轨迹，商家客服被 “包裹到哪了” 的咨询淹没，异常包裹错过最佳处理时机，这些场景在日常物流中屡见不鲜。对商家而言，物流信息滞后不仅增加客服压力，还会导致用户信任流失、复购率下降；对用户来说，模糊的物流状态意味着焦虑与不确定性，甚至可能引发订单取消。快递鸟针对性推出在途监控 API，以 “毫秒级响应、全链路覆盖、智能预警” 为核心，彻底破解物流信息滞后难题，让物流状态实时可见、异常及时可控，重塑物流信息透明化体验。</p>
<p><strong>一、物流信息滞后的核心痛点：商家与用户的双重困扰</strong></p>
<p>物流信息滞后并非简单的 “更新慢”，而是贯穿运输全流程的连锁问题，对商家和用户造成多维度影响：</p>
<p><strong>1. 用户体验滑坡，信任持续流失</strong></p>
<p>用户下单后最关心 “包裹是否发出、何时能到”，但传统物流信息常出现 “揽收后半天无更新”“中转节点断层”“派件前突然失联” 等情况。这种不确定性让用户频繁咨询客服，甚至因焦虑取消订单；部分用户因物流信息模糊，怀疑包裹丢失或错发，直接给出差评，损害商家口碑。数据显示，超 60% 的物流相关投诉，根源都在于信息更新不及时。</p>
<p><strong>2. 商家客服承压，运营效率低下</strong></p>
<p>物流信息滞后直接导致商家客服咨询量激增，“查件” 成为客服日常工作的核心内容。客服需切换多个物流商系统逐一查询，再手动反馈给用户，不仅占用大量人力，还易出现回复不及时、信息不准确的问题；大促期间，滞后的物流信息让客服团队不堪重负，甚至影响其他售后问题的处理效率。</p>
<p><strong>3. 异常处理被动，损失不断扩大</strong></p>
<p>包裹出现中转滞留、破损、地址错误等异常时，传统模式下需等用户反馈或物流商通知，商家才能知晓。此时往往已错过最佳处理时机 —— 滞留包裹可能继续延误，破损包裹难以界定责任，最终导致用户投诉升级、理赔成本增加，甚至引发品牌信任危机。</p>
<p><strong>4. 运营决策盲目，优化无从下手</strong></p>
<p>缺乏实时、精准的物流数据支撑，商家无法准确判断物流商的实际时效、异常率等核心指标。选择物流合作方、优化发货流程、制定促销履约预案时，只能依赖经验而非数据，导致物流成本居高不下，履约体验难以提升。</p>
<p><strong>二、快递鸟在途监控 API：毫秒级响应破解滞后难题</strong></p>
<p>快递鸟在途监控 API 以技术突破为核心，通过 “实时数据同步、全链路覆盖、智能预警、数据协同” 四大优势，从根源上解决物流信息滞后问题，让物流状态 “秒级更新、全程可视”。</p>
<p><strong>1. 毫秒级数据同步，信息更新无延迟</strong></p>
<p>快递鸟在途监控 API 的核心竞争力，在于其极致的响应速度 —— 依托分布式架构与智能数据抓取技术，实现物流数据 “毫秒级同步、秒级更新”：</p>
<ul>
<li>对接 2700 + 国内外物流商的实时数据接口，包裹的揽收、中转、派送、签收等每一个节点变动，都会在毫秒内被抓取并同步至 API；</li>
<li>数据传输采用 HTTPS 加密与高速通道，确保信息从物流商系统到商家 / 用户终端的传输延迟控制在 100-300 毫秒内，远超传统物流查询工具的分钟级甚至小时级更新速度；</li>
<li>支持高并发查询，即便大促期间单日百万级订单查询，仍能保持毫秒级响应，避免查询拥堵导致的信息延迟。</li>
</ul>
<p>对用户而言，下单后可实时查看包裹动态，每一次节点变动都能即时知晓；对商家来说，客服查询物流信息时 “即查即得”，无需等待加载，响应效率提升 80%。</p>
<p><strong>2. 全链路轨迹覆盖，无信息盲区</strong></p>
<p>快递鸟在途监控 API 打破传统物流信息 “断档” 问题，实现从 “下单 - 揽收 - 中转 - 末端派送 - 签收” 的全链路轨迹覆盖，尤其适配复杂物流场景：</p>
<ul>
<li>国内物流：覆盖快递、快运、同城即时配送等场景，详细展示每个中转中心、网点的处理时间，甚至标注 “快递员正在派送”“即将送达” 等精细化状态；</li>
<li>跨境物流：同步国际运输节点与清关进度，清晰展示 “国内揽收 - 国际航班起飞 - 目的国清关 - 末端派送” 全流程，让跨境物流不再 “黑箱操作”；</li>
<li>特殊场景：生鲜冷链订单同步温湿度数据，大件物流标注 “上门搬运”“安装预约” 状态，异常订单实时标记 “滞留”“破损” 等提示，确保信息无死角。</li>
</ul>
<p><strong>3. 智能异常预警，变被动为主动</strong></p>
<p>快递鸟在途监控 API 不止于 “实时展示”，更能主动识别异常、提前预警，帮助商家抢占处理先机：</p>
<ul>
<li>预设 40 + 异常场景规则，包括揽收超时、中转滞留超 4 小时、派件失败、地址错误、温湿度异常等，系统自动监控包裹状态，一旦触发异常规则，立即通过 API 推送预警信息；</li>
<li>预警方式灵活多样，支持短信、站内信、Webhook 等多种渠道，商家可实时接收异常通知，第一时间协调物流商处理，避免问题扩大；</li>
<li>异常原因智能分析，API 会结合历史数据与物流商规则，初步判断异常原因（如 “中转中心爆仓”“地址不完整”），为商家提供处理方向参考。</li>
</ul>
<p>例如，某电商商家通过 API 发现包裹 “中转滞留超 4 小时”，立即联系物流商加急处理，最终避免了包裹延误，用户满意度未受影响 —— 这种主动干预，远比用户投诉后再处理更高效。</p>
<p><strong>4. 数据深度协同，打通全业务闭环</strong></p>
<p>快递鸟在途监控 API 并非孤立的查询工具，而是能与商家业务系统深度协同，让物流数据成为运营决策的支撑：</p>
<ul>
<li>
<p>与订单系统联动：物流状态自动同步至商家订单系统，触发对应订单状态变更（如 “已揽收”“已签收”），无需人工手动更新；</p>
</li>
<li>
<p>与客服系统集成：客服接待用户时，系统自动显示对应订单的物流轨迹，无需手动查询，响应速度提升 50%；</p>
</li>
<li>
<p>与数据分析系统对接：自动汇总物流时效、异常率、各物流商表现等多维度数据，生成可视化报表，帮助商家优化物流合作方案、调整发货策略。</p>
</li>
</ul>
<p><strong>三、典型应用场景：快递鸟 API 适配多元物流需求</strong></p>
<p>快递鸟在途监控 API 的灵活性，使其能精准适配不同行业、不同规模的物流场景，落地效果显著：</p>
<p><strong>1. 电商日常发货场景</strong></p>
<p>某服饰电商日均发货 2000 单，接入 API 后，用户在订单页即可查看实时物流轨迹，查件咨询量下降 60%；客服无需切换多个物流系统，直接在后台获取轨迹信息，工作效率提升 40%；异常包裹提前预警，售后纠纷率下降 70%，店铺 DSR 评分提升 0.4 分。</p>
<p><strong>2. 跨境电商物流场景</strong></p>
<p>某跨境美妆商家通过 API 对接国际物流商，用户可实时查看清关进度与国际运输轨迹，“清关多久”“包裹到哪国了” 的咨询量减少 55%；商家通过 API 监控清关异常，提前补充申报资料，清关延误率从 25% 降至 5%，用户复购率增长 20%。</p>
<p><strong>3. 大促峰值履约场景</strong></p>
<p>双 11 期间，某家居商家订单量激增至 10000 单 / 日，依托 API 的高并发处理能力，物流信息更新无延迟；商家通过 API 批量监控包裹状态，快速筛选异常订单并处理，大促期间物流投诉率从 30% 降至 8%，履约效率大幅提升。</p>
<p><strong>4. 生鲜冷链场景</strong></p>
<p>某生鲜平台接入 API 后，实时同步冷链包裹的温湿度数据，一旦超出预设范围立即预警，商家及时协调物流商调整温控，生鲜破损率从 12% 降至 3%；用户在订单页查看温湿度记录，对产品新鲜度更放心，复购率提升 25%。</p>
<p><strong>四、落地核心价值：商家与用户的双向共赢</strong></p>
<p><strong>1. 商家端：降本提效，构建核心竞争力</strong></p>
<ul>
<li>客服成本降低：查件咨询量下降 60%，客服团队规模可缩减 30%-50%，人力成本显著降低；</li>
<li>售后纠纷减少：异常提前预警与快速处理，物流相关投诉率下降 70%，品牌口碑持续优化；</li>
<li>运营决策科学：物流数据实时汇总分析，为物流商选择、发货优化提供依据，物流成本平均降低 10%-15%；</li>
<li>履约效率提升：全流程数据协同，订单处理效率提升 50%，大促峰值无需额外加班即可应对。</li>
</ul>
<p><strong>2. 用户端：体验升级，物流透明更安心</strong></p>
<ul>
<li>查件更便捷：在下单平台即可实时查看全链路轨迹，无需跳转第三方工具，操作简化 80%；</li>
<li>等待不焦虑：毫秒级更新 + 关键节点推送，清晰知晓包裹动态与预计送达时间，消除不确定性；</li>
<li>权益有保障：异常情况提前告知，问题及时处理，无需反复咨询客服，消费体验更顺畅；</li>
<li>信任度提升：透明、高效的物流信息展示，增强对商家的信任，复购意愿显著提升。</li>
</ul>
<p><strong>​</strong></p>
<p><strong>结语</strong></p>
<p>物流信息的透明化与实时性，早已成为衡量物流服务品质的核心标准。快递鸟在途监控 API 以 “毫秒级响应” 打破物流信息滞后的行业痛点，通过全链路覆盖、智能预警、数据协同，让物流状态从 “模糊未知” 变为 “清晰可控”，既为商家降低运营成本、提升效率，也为用户带来更安心、更便捷的物流体验。</p>
<p>在物流数字化深入发展的今天，物流信息的实时性已成为商家的核心竞争力之一。快递鸟在途监控 API 不仅是一款工具，更是商家优化物流体验、构建品牌信任的重要支撑。未来，随着 AI、物联网技术的深度融合，快递鸟还将实现更精准的时效预测、更智能的异常干预，让物流信息服务更具价值，推动行业向更高效、更透明的方向发展。物流信息总滞后？快递鸟在途监控 API，毫秒级响应让物流透明不等待</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2618. 检查是否是类的对象实例（JavaScript）]]></title>    <link>https://juejin.cn/post/7572004684178145334</link>    <guid>https://juejin.cn/post/7572004684178145334</guid>    <pubDate>2025-11-13T09:00:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572004684178145334" data-draft-id="7571815573932998719" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2618. 检查是否是类的对象实例（JavaScript）"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-13T09:00:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Bug_Constructer"/> <meta itemprop="url" content="https://juejin.cn/user/254742426830856"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2618. 检查是否是类的对象实例（JavaScript）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/254742426830856/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Bug_Constructer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:00:04.000Z" title="Thu Nov 13 2025 09:00:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><ul>
<li>题目链接：<code>https://leetcode.cn/problems/check-if-object-instance-of-class/description/</code></li>
<li>难度：简单</li>
<li>类型：JavaScript/原型链/类型判断</li>
</ul>
<h2 data-id="heading-0">题目要点</h2>
<ul>
<li>给定 <code>value</code> 与 <code>classFn</code>，判断 <code>value</code> 是否是 <code>classFn</code> 或其超类的实例。</li>
<li>需要考虑 <code>undefined</code>、<code>null</code>、非函数的 <code>classFn</code>。</li>
<li>对原始类型与其包装类（如 <code>5</code> 与 <code>Number</code>）要正确处理。</li>
</ul>
<h2 data-id="heading-1">解法一：<code>instanceof</code> + 原始类型映射（推荐）</h2>
<ul>
<li>思路：
<ul>
<li>优先用 <code>instanceof</code> 判断对象与原型链关系（内部会调用 <code>Symbol.hasInstance</code>）。</li>
<li>对原始类型做特判，使 <code>number → Number</code>、<code>string → String</code>、<code>boolean → Boolean</code>、<code>bigint → BigInt</code>、<code>symbol → Symbol</code> 返回 <code>true</code>。</li>
<li>非法输入（<code>classFn</code> 非函数或任一为 <code>null/undefined</code>）返回 <code>false</code>。</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 检查值是否为给定类或其超类的实例
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} <span class="hljs-variable">value</span> - 任意值
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} <span class="hljs-variable">classFn</span> - 目标类（构造函数）
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">boolean</span>} - 是否为实例
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">checkIfInstance</span> = (<span class="hljs-params">value, classFn</span>) =&gt; {
  <span class="hljs-keyword">if</span> (classFn == <span class="hljs-literal">null</span> || value == <span class="hljs-literal">null</span> || <span class="hljs-keyword">typeof</span> classFn !== <span class="hljs-string">'function'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> classFn) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
  <span class="hljs-keyword">const</span> t = <span class="hljs-keyword">typeof</span> value
  <span class="hljs-keyword">if</span> (classFn === <span class="hljs-title class_">Number</span>) <span class="hljs-keyword">return</span> t === <span class="hljs-string">'number'</span>
  <span class="hljs-keyword">if</span> (classFn === <span class="hljs-title class_">String</span>) <span class="hljs-keyword">return</span> t === <span class="hljs-string">'string'</span>
  <span class="hljs-keyword">if</span> (classFn === <span class="hljs-title class_">Boolean</span>) <span class="hljs-keyword">return</span> t === <span class="hljs-string">'boolean'</span>
  <span class="hljs-keyword">if</span> (classFn === <span class="hljs-title class_">BigInt</span>) <span class="hljs-keyword">return</span> t === <span class="hljs-string">'bigint'</span>
  <span class="hljs-keyword">if</span> (classFn === <span class="hljs-title class_">Symbol</span>) <span class="hljs-keyword">return</span> t === <span class="hljs-string">'symbol'</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
}
</code></pre>
<ul>
<li>
<p>复杂度：</p>
<ul>
<li><code>instanceof</code> 的原型链检查为 <code>O(h)</code>（<code>h</code> 为原型链高度）。</li>
<li>原始类型映射为 <code>O(1)</code>。</li>
</ul>
</li>
<li>
<p>边界说明：</p>
<ul>
<li><code>checkIfInstance(Date, Date) → false</code>（<code>Date</code> 是 <code>Function</code> 的实例）。</li>
<li><code>checkIfInstance(5, Number) → true</code>（与题目示例一致）。</li>
<li><code>checkIfInstance(5, Object) → false</code>（不把原始值视作 <code>Object</code> 的实例）。</li>
<li><code>checkIfInstance(null, Object) → false</code>。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-2">解法二：手写原型链遍历 + 原始类型特判</h2>
<ul>
<li>思路：
<ul>
<li>对对象与函数：沿 <code>Object.getPrototypeOf</code> 逐层向上，判断是否等于 <code>classFn.prototype</code>。</li>
<li>对原始类型：做与解法一相同的映射特判。</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 通过手写原型链判断实例关系
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} <span class="hljs-variable">value</span> - 任意值
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} <span class="hljs-variable">classFn</span> - 目标类（构造函数）
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">boolean</span>} - 是否为实例
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">checkIfInstanceByProto</span> = (<span class="hljs-params">value, classFn</span>) =&gt; {
  <span class="hljs-keyword">if</span> (classFn == <span class="hljs-literal">null</span> || <span class="hljs-keyword">typeof</span> classFn !== <span class="hljs-string">'function'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  <span class="hljs-keyword">const</span> t = <span class="hljs-keyword">typeof</span> value
  <span class="hljs-keyword">if</span> (classFn === <span class="hljs-title class_">Number</span>) <span class="hljs-keyword">return</span> t === <span class="hljs-string">'number'</span>
  <span class="hljs-keyword">if</span> (classFn === <span class="hljs-title class_">String</span>) <span class="hljs-keyword">return</span> t === <span class="hljs-string">'string'</span>
  <span class="hljs-keyword">if</span> (classFn === <span class="hljs-title class_">Boolean</span>) <span class="hljs-keyword">return</span> t === <span class="hljs-string">'boolean'</span>
  <span class="hljs-keyword">if</span> (classFn === <span class="hljs-title class_">BigInt</span>) <span class="hljs-keyword">return</span> t === <span class="hljs-string">'bigint'</span>
  <span class="hljs-keyword">if</span> (classFn === <span class="hljs-title class_">Symbol</span>) <span class="hljs-keyword">return</span> t === <span class="hljs-string">'symbol'</span>
  <span class="hljs-keyword">let</span> proto = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(value)
  <span class="hljs-keyword">const</span> target = classFn.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>
  <span class="hljs-keyword">while</span> (proto) {
    <span class="hljs-keyword">if</span> (proto === target) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    proto = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(proto)
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
}
</code></pre>
<ul>
<li>说明：与 <code>instanceof</code> 等价于遍历原型链的判断，但仍需对原始类型做特判。</li>
</ul>
<h2 data-id="heading-3">解法三：利用 <code>Symbol.hasInstance</code>（了解）</h2>
<ul>
<li>思路：
<ul>
<li><code>instanceof</code> 内部会调用 <code>classFn[Symbol.hasInstance](value)</code>，可显式使用以获得可定制的实例判断行为。</li>
<li>对多数内置类型，直接用 <code>instanceof</code> 即可；手动调用一般用于定制类。</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 基于 Symbol.hasInstance 的实例判断
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} <span class="hljs-variable">value</span> - 任意值
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} <span class="hljs-variable">classFn</span> - 目标类（构造函数）
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">boolean</span>} - 是否为实例
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">checkIfInstanceByHasInstance</span> = (<span class="hljs-params">value, classFn</span>) =&gt; {
  <span class="hljs-keyword">if</span> (classFn == <span class="hljs-literal">null</span> || value == <span class="hljs-literal">null</span> || <span class="hljs-keyword">typeof</span> classFn !== <span class="hljs-string">'function'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  <span class="hljs-keyword">const</span> hasInst = classFn[<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">hasInstance</span>]
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> hasInst === <span class="hljs-string">'function'</span> &amp;&amp; hasInst.<span class="hljs-title function_">call</span>(classFn, value)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
  <span class="hljs-keyword">const</span> t = <span class="hljs-keyword">typeof</span> value
  <span class="hljs-keyword">if</span> (classFn === <span class="hljs-title class_">Number</span>) <span class="hljs-keyword">return</span> t === <span class="hljs-string">'number'</span>
  <span class="hljs-keyword">if</span> (classFn === <span class="hljs-title class_">String</span>) <span class="hljs-keyword">return</span> t === <span class="hljs-string">'string'</span>
  <span class="hljs-keyword">if</span> (classFn === <span class="hljs-title class_">Boolean</span>) <span class="hljs-keyword">return</span> t === <span class="hljs-string">'boolean'</span>
  <span class="hljs-keyword">if</span> (classFn === <span class="hljs-title class_">BigInt</span>) <span class="hljs-keyword">return</span> t === <span class="hljs-string">'bigint'</span>
  <span class="hljs-keyword">if</span> (classFn === <span class="hljs-title class_">Symbol</span>) <span class="hljs-keyword">return</span> t === <span class="hljs-string">'symbol'</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
}
</code></pre>
<h2 data-id="heading-4">示例与验证</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {}
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> {}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'1:'</span>, <span class="hljs-title function_">checkIfInstance</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(), <span class="hljs-title class_">Date</span>))            <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'2:'</span>, <span class="hljs-title function_">checkIfInstance</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>(), <span class="hljs-title class_">Animal</span>))           <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'3:'</span>, <span class="hljs-title function_">checkIfInstance</span>(<span class="hljs-title class_">Date</span>, <span class="hljs-title class_">Date</span>))                  <span class="hljs-comment">// false</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'4:'</span>, <span class="hljs-title function_">checkIfInstance</span>(<span class="hljs-number">5</span>, <span class="hljs-title class_">Number</span>))                   <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'5:'</span>, <span class="hljs-title function_">checkIfInstance</span>(<span class="hljs-function">() =&gt;</span> {}, <span class="hljs-title class_">Function</span>))          <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'6:'</span>, <span class="hljs-title function_">checkIfInstance</span>(<span class="hljs-number">5</span>, <span class="hljs-title class_">Object</span>))                   <span class="hljs-comment">// false</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'7:'</span>, <span class="hljs-title function_">checkIfInstance</span>(<span class="hljs-literal">null</span>, <span class="hljs-title class_">Object</span>))                <span class="hljs-comment">// false</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'8:'</span>, <span class="hljs-title function_">checkIfInstance</span>(<span class="hljs-literal">undefined</span>, <span class="hljs-title class_">Number</span>))           <span class="hljs-comment">// false</span>
</code></pre>
<h2 data-id="heading-5">总结</h2>
<ul>
<li>推荐以 <code>instanceof</code> 为主，原始类型补充为辅，满足题目示例与语义直觉。</li>
<li>若需要可定制的行为，可考虑 <code>Symbol.hasInstance</code>，但一般场景不必复杂化。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[跟着TRAE SOLO学习两大搜索]]></title>    <link>https://juejin.cn/post/7571829879827234835</link>    <guid>https://juejin.cn/post/7571829879827234835</guid>    <pubDate>2025-11-13T09:02:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571829879827234835" data-draft-id="7571808096936771625" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="跟着TRAE SOLO学习两大搜索"/> <meta itemprop="keywords" content="前端,算法"/> <meta itemprop="datePublished" content="2025-11-13T09:02:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="林太白"/> <meta itemprop="url" content="https://juejin.cn/user/1874034273300919"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            跟着TRAE SOLO学习两大搜索
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1874034273300919/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    林太白
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:02:00.000Z" title="Thu Nov 13 2025 09:02:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">跟着TRAE SOLO学习两大搜索</h2>
<h3 data-id="heading-1">1.顺序搜索（Sequential Search）</h3>
<h4 data-id="heading-2">认识</h4>
<p>顺序搜索也称为线性搜索（Linear Search）。它的基本思想是从数据结构的一端开始，逐个检查每个元素，直到找到目标元素或检查完所有元素。</p>
<pre><code class="hljs language-plain" lang="plain">function sequentialSearch(arr, target) {
    for (let i = 0; i &lt; arr.length; i++) {
        if (arr[i] === target) {
            return i;
        }
    }
    return -1;
};
const arr = [4, 3, 6, 2, 5, 7, 9, 8, 1]
console.log(sequentialSearch(arr, 8)) // 7
</code></pre>
<h4 data-id="heading-3">Javascript顺序搜索实现</h4>
<h5 data-id="heading-4">基础实现</h5>
<p>基础实现比较好写，就是一个小标</p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;!<span class="hljs-variable constant_">DOCTYPE</span> html&gt;
&lt;html lang="en"&gt;

&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
    &lt;title&gt;顺序搜索 Sequential Search&lt;/title&gt;
&lt;/head&gt;

&lt;body&gt;
    &lt;script&gt;
    // 1 顺序搜索 
    function SequentialSearch(arr, target) {
        for (let i = 0; i &lt; arr.length; i++) {
            if (arr[i] == target) {
                return i;
            }
        }
        return -1;
    }
    // 功能测试
    const arr = [1, 4, 3, 6, 2, 5, 7, 9, 8];
    let target = 2;
    let result = SequentialSearch(arr, target);
    console.log(`元素 ${target} 在数组中的索引是 ${result}`);
    
    &lt;/script&gt;
&lt;/body&gt;

&lt;/html&gt;
</code></pre>
<h5 data-id="heading-5">哨兵模式（Sentinel Pattern）优化</h5>
<p>针对哨兵模式进行优化</p>
<p>也就是将上面循环中的判断条件进行减少为一个</p>
<p>【哨兵模式】将目标值作为哨兵放在了数组的末尾，确保循环一定会终止</p>
<pre><code class="hljs language-javascript" lang="javascript"> <span class="hljs-comment">// 需要同时检查两个条件:</span>
<span class="hljs-comment">// 1. arr[i] === target - 找到目标元素</span>
<span class="hljs-comment">// 2. i &lt; arr.length - 确保没有超出数组范围</span>
</code></pre>
<p>实现</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 2-优化-哨兵模式</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">SequentialSearch</span>(<span class="hljs-params">arr, target</span>) {
      <span class="hljs-comment">// 如果数组为空，直接返回-1</span>
      <span class="hljs-keyword">if</span> (arr.<span class="hljs-property">length</span> == <span class="hljs-number">0</span>) {
          <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>
      }
      <span class="hljs-comment">// 保存最后一个元素</span>
      <span class="hljs-keyword">const</span> last = arr[arr.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];
      arr[arr.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>] = target; <span class="hljs-comment">// 将最后一个元素设为哨兵</span>

      <span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">while</span> (arr[i] !== target) {
          i++
      }
      <span class="hljs-comment">// 恢复最后一个元素</span>
      arr[arr.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>] = last;
      <span class="hljs-comment">// 如果找到的位置不是最后一个元素，或者是最后一个元素且值匹配</span>
      <span class="hljs-keyword">if</span> (i &lt; arr.<span class="hljs-property">length</span> - <span class="hljs-number">1</span> || arr[arr.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>] === target){
          <span class="hljs-keyword">return</span> i
      }
      <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
 }
</code></pre>
<h5 data-id="heading-6">双向迭代优化</h5>
<p>双向迭代顺序搜索，同时从左和右开始进行搜索</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 3-双向迭代顺序搜索（从前和从后同时搜索）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Array</span>} <span class="hljs-variable">arr</span> - 待搜索的数组
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} <span class="hljs-variable">target</span> - 要查找的目标元素
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">number</span>} 目标元素的索引，如果未找到则返回-1
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">iterativeBidirectionalSearch</span>(<span class="hljs-params">arr, target</span>) {
    <span class="hljs-keyword">let</span> left = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">let</span> right = arr.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>;
    <span class="hljs-keyword">while</span> (left &lt;= right) {
        <span class="hljs-comment">// 从前向后检查</span>
        <span class="hljs-keyword">if</span> (arr[left] === target) {
            <span class="hljs-keyword">return</span> left;
        }
        <span class="hljs-comment">// 从后向前检查</span>
        <span class="hljs-keyword">if</span> (arr[right] === target) {
            <span class="hljs-keyword">return</span> right;
        }
        left++;
        right--;
    }
    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
}
</code></pre>
<h5 data-id="heading-7">概率优化--暂时没理解</h5>
<pre><code class="hljs language-javascript" lang="javascript">  <span class="hljs-comment">/**
     * 4-基于概率的迭代顺序搜索（高频元素优先）
     * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Array</span>} <span class="hljs-variable">arr</span> - 待搜索的数组
     * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} <span class="hljs-variable">target</span> - 要查找的目标元素
     * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">frequencyMap</span> - 可选的频率映射表
     * <span class="hljs-doctag">@return</span> {<span class="hljs-type">number</span>} 目标元素的索引，如果未找到则返回-1
     */</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">iterativeProbabilisticSearch</span>(<span class="hljs-params">arr, target, frequencyMap = <span class="hljs-literal">null</span></span>) {
        <span class="hljs-comment">// 如果没有提供频率映射表，则创建一个</span>
        <span class="hljs-keyword">if</span> (!frequencyMap) {
            frequencyMap = {};
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> item <span class="hljs-keyword">of</span> arr) {
                frequencyMap[item] = (frequencyMap[item] || <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>;
            }
        }
        <span class="hljs-comment">// 创建一个按频率排序的索引数组</span>
        <span class="hljs-keyword">const</span> indices = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: arr.<span class="hljs-property">length</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> i);
        indices.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span>
            (frequencyMap[arr[b]] || <span class="hljs-number">0</span>) - (frequencyMap[arr[a]] || <span class="hljs-number">0</span>)
        );

        <span class="hljs-comment">// 按照排序后的索引顺序搜索</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> i <span class="hljs-keyword">of</span> indices) {
            <span class="hljs-keyword">if</span> (arr[i] === target) {
                <span class="hljs-keyword">return</span> i;
            }
        }

        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    }

    <span class="hljs-comment">// 使用示例</span>
    <span class="hljs-keyword">const</span> myList = [<span class="hljs-number">4</span>, <span class="hljs-number">2</span>, <span class="hljs-number">7</span>, <span class="hljs-number">1</span>, <span class="hljs-number">9</span>, <span class="hljs-number">5</span>, <span class="hljs-number">7</span>, <span class="hljs-number">2</span>, <span class="hljs-number">7</span>];
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">iterativeProbabilisticSearch</span>(myList, <span class="hljs-number">7</span>)); <span class="hljs-comment">// 输出: 2</span>
</code></pre>
<h5 data-id="heading-8">缓存优化</h5>
<p>下面的优化非常的简单，但是符合V8引擎的设计</p>
<p>每次循环迭代都需要访问arr.length属性调整为  只在循环开始前访问一次arr.length并将其存储在局部变量length中</p>
<p>JavaScript引擎（如V8）对局部变量的访问速度远快于对象属性访问。这是因为：</p>
<ol>
<li>局部变量存储在寄存器或栈上，访问速度快</li>
<li>对象属性存储在堆上，需要通过属性查找机制访问，速度较慢</li>
</ol>
<p><code>这种局部变量的访问由于存储在在寄存器或栈上 访问速度明显大于存储在堆上的对象属性，以前我还一直坚持不增加多余局部变量呢</code></p>
<pre><code class="hljs language-javascript" lang="javascript">  <span class="hljs-keyword">function</span> <span class="hljs-title function_">iterativeCachedSearch</span>(<span class="hljs-params">arr, target</span>) {
      <span class="hljs-keyword">const</span> length = arr.<span class="hljs-property">length</span>; <span class="hljs-comment">// 缓存数组长度</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; length; i++) {
          <span class="hljs-keyword">if</span> (arr[i] === target) {
              <span class="hljs-keyword">return</span> i;
          }
      }
      <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
  }

  <span class="hljs-comment">// 使用示例</span>
  <span class="hljs-keyword">const</span> myList = [<span class="hljs-number">4</span>, <span class="hljs-number">2</span>, <span class="hljs-number">7</span>, <span class="hljs-number">1</span>, <span class="hljs-number">9</span>, <span class="hljs-number">5</span>];
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">iterativeCachedSearch</span>(myList, <span class="hljs-number">7</span>)); <span class="hljs-comment">// 输出: 2</span>
</code></pre>
<h3 data-id="heading-9">2.二分搜索（Binary Search）</h3>
<h4 data-id="heading-10">认识</h4>
<p><code>二分搜索</code>，也叫<code>折半搜索</code>，是一种在<code>有序数组</code>中查找特定元素的搜索算法。所以是用二分查找的前提是数组必须是<code>有序</code>的.</p>
<p>二分搜索通过不断将搜索范围减半的方式，快速定位目标元素。</p>
<h4 data-id="heading-11">工作原理</h4>
<ol>
<li>从数组的中间元素开始，如果中间元素正好是要查找的元素，则搜索过程结束</li>
<li>如果目标元素大于或小于中间元素，则在数组大于或小于中间元素的那一半中查找</li>
<li>重复上述过程，直到找到目标元素或搜索范围为空</li>
</ol>
<h4 data-id="heading-12">时间复杂度</h4>
<ul>
<li>最坏情况：O(log n)</li>
<li>平均情况：O(log n)</li>
<li>最好情况：O(1)（目标元素正好在中间）</li>
</ul>
<h4 data-id="heading-13">空间复杂度</h4>
<ul>
<li>迭代实现：O(1)</li>
<li>递归实现：O(log n)（由于递归调用栈）</li>
</ul>
<h4 data-id="heading-14">实现</h4>
<h5 data-id="heading-15">基础版本</h5>
<p>基础版本实现，这里我们先来自己手写一个简单的二分搜索模块</p>
<pre><code class="hljs language-javascript" lang="javascript">     <span class="hljs-comment">/**
     * 1-基础迭代二分搜索
     * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Array</span>} <span class="hljs-variable">arr</span> - 已排序的数组
     * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} <span class="hljs-variable">target</span> - 要查找的目标元素
     * <span class="hljs-doctag">@return</span> {<span class="hljs-type">number</span>} 目标元素的索引，如果未找到则返回-1
     */</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">binarySearch</span>(<span class="hljs-params">arr,target</span>){
        <span class="hljs-keyword">let</span> left=<span class="hljs-number">0</span>;
        <span class="hljs-keyword">let</span> right=arr.<span class="hljs-property">length</span>-<span class="hljs-number">1</span>;
        <span class="hljs-keyword">while</span>(left &lt;= right){
            <span class="hljs-keyword">const</span> mid=<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((left+ right)/<span class="hljs-number">2</span>);
            <span class="hljs-keyword">if</span>(arr[mid]===target){
                <span class="hljs-keyword">return</span> mid;<span class="hljs-comment">// 找到目标，返回索引</span>
            }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(arr[mid]&lt; target){
                left = mid +<span class="hljs-number">1</span>; <span class="hljs-comment">// 目标在右半部分</span>
            }<span class="hljs-keyword">else</span>{
                right =mid -<span class="hljs-number">1</span>;  <span class="hljs-comment">// 目标在左半部分</span>
            }
        }
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    }

    <span class="hljs-comment">// 使用示例</span>
    <span class="hljs-keyword">const</span> sortedArray = [<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">7</span>, <span class="hljs-number">9</span>, <span class="hljs-number">11</span>, <span class="hljs-number">13</span>, <span class="hljs-number">15</span>];
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">binarySearch</span>(sortedArray, <span class="hljs-number">7</span>)); <span class="hljs-comment">// 输出: 3</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">binarySearch</span>(sortedArray, <span class="hljs-number">8</span>)); <span class="hljs-comment">// 输出: -1</span>
</code></pre>
<h5 data-id="heading-16">防止整数溢出</h5>
<p>接下来我们就跟着trae优化迭代上面版本的二分搜索，有时候我们会出现一种情况</p>
<p>这里我们主要讲的就是<code>left + (right - left) / 2</code> 比 <code>(left + right) / 2</code> 更安全</p>
<pre><code class="hljs language-javascript" lang="javascript">当 left 和 right 都很大时
和可能会超过 <span class="hljs-title class_">JavaScript</span> 中 <span class="hljs-title class_">Number</span> 类型的最大安全整数（<span class="hljs-number">2</span>^<span class="hljs-number">53</span> - <span class="hljs-number">1</span>）
这会导致整数溢出，得到错误的结果
</code></pre>
<p>利用下面的写法就可以有效避免我们结果超过<code>Number.MAX_SAFE_INTEGER</code>，也就是通过先计算的方式直接避免最后结果超过最大值</p>
<pre><code class="hljs language-javascript" lang="javascript">使用 left + (right - left) / <span class="hljs-number">2</span>

<span class="hljs-comment">// 先计算 (right - left)，这个差值很小</span>
<span class="hljs-comment">// 然后加到 left 上，不会溢出</span>

<span class="hljs-comment">// left + right 会先计算，结果可能超过 Number.MAX_SAFE_INTEGER</span>
<span class="hljs-comment">// 导致溢出，得到错误的结果</span>
</code></pre>
<p>所以防止整数溢出我们更改为</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 修改前</span>
<span class="hljs-keyword">const</span> mid = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((left + right) / <span class="hljs-number">2</span>);

<span class="hljs-comment">// 修改后</span>
<span class="hljs-keyword">const</span> mid = left + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((right - left) / <span class="hljs-number">2</span>);
</code></pre>
<h5 data-id="heading-17">添加输入验证</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 添加在函数开始处</span>
<span class="hljs-comment">// 输入验证</span>
<span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(arr) || arr.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'输入必须是非空数组'</span>);
}
</code></pre>
<h5 data-id="heading-18">提前处理边界情况</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 添加在输入验证之后，循环之前</span>
<span class="hljs-comment">// 提前处理边界情况</span>
<span class="hljs-keyword">if</span> (arr[<span class="hljs-number">0</span>] === target) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
<span class="hljs-keyword">if</span> (arr[arr.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>] === target) <span class="hljs-keyword">return</span> arr.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>;

</code></pre>
<h5 data-id="heading-19">优化循环条件</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 修改前</span>
<span class="hljs-keyword">while</span> (left &lt;= right) {

<span class="hljs-comment">// 修改后</span>
<span class="hljs-keyword">while</span> (left &lt; right) {

<span class="hljs-comment">// 调整循环体内的逻辑</span>
</code></pre>
<h5 data-id="heading-20">调整循环体内的逻辑</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 修改前</span>
<span class="hljs-keyword">if</span> (arr[mid] === target) {
    <span class="hljs-keyword">return</span> mid; <span class="hljs-comment">// 找到目标，返回索引</span>
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (arr[mid] &lt; target) {
    left = mid + <span class="hljs-number">1</span>; <span class="hljs-comment">// 目标在右半部分</span>
} <span class="hljs-keyword">else</span> {
    right = mid - <span class="hljs-number">1</span>; <span class="hljs-comment">// 目标在左半部分</span>
}

<span class="hljs-comment">// 修改后</span>
<span class="hljs-keyword">if</span> (arr[mid] &lt; target) {
    left = mid + <span class="hljs-number">1</span>; <span class="hljs-comment">// 目标在右半部分</span>
} <span class="hljs-keyword">else</span> {
    right = mid; <span class="hljs-comment">// 目标在左半部分或mid就是目标</span>
}
</code></pre>
<p>最后我们优化完成以后</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">binarySearch</span>(<span class="hljs-params">arr, target</span>) {
  <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(arr) || arr.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'输入必须是非空数组'</span>);
  }
  <span class="hljs-comment">// 提前处理边界情况</span>
  <span class="hljs-keyword">if</span> (arr[<span class="hljs-number">0</span>] === target) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
  <span class="hljs-keyword">if</span> (arr[arr.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>] === target) <span class="hljs-keyword">return</span> arr.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>;
  <span class="hljs-keyword">let</span> left = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">let</span> right = arr.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>;
  <span class="hljs-comment">// 循环条件优化为 left &lt; right</span>
  <span class="hljs-keyword">while</span> (left &lt; right) {
      <span class="hljs-comment">// 防止整数溢出的中间值计算</span>
      <span class="hljs-keyword">const</span> mid = left + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((right - left) / <span class="hljs-number">2</span>);

      <span class="hljs-keyword">if</span> (arr[mid] &lt; target) {
          left = mid + <span class="hljs-number">1</span>; <span class="hljs-comment">// 目标在右半部分，排除mid</span>
      } <span class="hljs-keyword">else</span> {
          right = mid; <span class="hljs-comment">// 目标在左半部分或mid就是目标</span>
      }
  }
  <span class="hljs-comment">// 循环结束后检查left位置是否为目标</span>
  <span class="hljs-keyword">return</span> arr[left] === target ? left : -<span class="hljs-number">1</span>;
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TRAE SOLO：前端开发的新范式与实践指南]]></title>    <link>https://juejin.cn/post/7571972751528149028</link>    <guid>https://juejin.cn/post/7571972751528149028</guid>    <pubDate>2025-11-13T09:03:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571972751528149028" data-draft-id="7571972751527788580" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TRAE SOLO：前端开发的新范式与实践指南"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2025-11-13T09:03:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="zhouzhouya"/> <meta itemprop="url" content="https://juejin.cn/user/3931509312987511"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TRAE SOLO：前端开发的新范式与实践指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3931509312987511/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    zhouzhouya
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:03:18.000Z" title="Thu Nov 13 2025 09:03:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、前言：为什么前端开发者需要TRAE SOLO？</h2>
<p>从组件库的搭建的角度来简单谈下，为什么前端开发者需要TRAE SOLO呢？因为可以辅助编码，极大的提升开发效率。传统的前端开发流程中，开发者需要手动处理项目搭建、组件开发、样式设计、状态管理、路由配置等一系列繁琐工作。而TRAE SOLO通过其<strong>上下文工程（Context Engineering）</strong> 理念，将整个开发流程进行了自动化的开发，生成符合前端开发规范的代码结构。</p>
<p>此篇文章我将介绍使用 TRAE SOLO开发前端AI组件库的全过程。</p>
<h2 data-id="heading-1">二、TRAE SOLO生成AI组件库的实践</h2>
<p>前端想要完成一个复杂的组件库是极其困难的，这不仅包含框架的搭建，性能的优化，安全性的确认，基础组件，业务组件等等需求的考虑，但经过TRAE SOLO的辅助，从零构建现代化组件库也并非那么复杂的事情。</p>
<h3 data-id="heading-2">实践案例：从零构建现代化组件库</h3>
<p>此部分介绍<strong>以AI能力为核心、以工程化实践为手段</strong>的完整系统构建过程。</p>
<hr/>
<h4 data-id="heading-3"><strong>第一阶段：模型选型与适配 - “选择适配模型”</strong></h4>
<p><strong>目标</strong>：为组件库的每个AI功能（如文本总结、代码生成、智能翻译）选择最合适的模型。</p>
<ul>
<li><strong>需求分析</strong>：明确每个组件的核心指标：是追求低延迟（如代码补全），还是追求高精度（如文档总结）？</li>
<li><strong>模型筛选</strong>：利用TRAE SOLO的评估能力，在GPT-4、Claude、开源模型（如CodeLlama）中进行快速对比测试，找出在性能、成本、速度上最平衡的模型。</li>
<li><strong>决策依据</strong>：并非所有功能都需要最强大的模型。例如，简单的文本纠错可能用轻量模型，而代码生成则需选择更专业的模型。</li>
</ul>
<p><strong>输出物</strong>：一份模型选型矩阵，明确每个AI功能背后的模型供应商、版本和API端点。</p>
<hr/>
<h4 data-id="heading-4"><strong>第二阶段：服务部署与集成 - “模型服务一键上线”</strong></h4>
<p><strong>目标</strong>：将选定的模型能力封装成稳定、可复用的API服务。</p>
<ul>
<li><strong>一键部署</strong>：利用TRAE SOLO的部署模块，将每个模型服务（如 <code>text-summarization-api</code>、<code>code-generation-api</code>）快速部署为独立的微服务。</li>
<li><strong>API标准化</strong>：定义统一的API接口规范，例如所有请求体包含 <code>input</code>字段，所有响应体包含 <code>data</code>和 <code>error</code>字段。TRAE SOLO可自动生成这些样板代码。</li>
<li><strong>配置管理</strong>：通过TRAE SOLO管理不同环境（开发、测试、生产）的API配置。</li>
</ul>
<p><strong>输出物</strong>：一组已部署的、标准化的AI能力API。</p>
<hr/>
<h4 data-id="heading-5"><strong>第三阶段：前端组件开发与生成 - “生成代码”</strong></h4>
<p><strong>目标</strong>：基于上述API，开发易于使用的前端React/Vue组件。</p>
<ul>
<li><strong>组件代码生成</strong>：向TRAE SOLO描述组件功能（如：“生成一个文本总结组件，包含一个多行输入框、一个滑动条控制总结长度、一个提交按钮和异步加载状态”），让其生成高质量的、包含类型定义的组件代码。</li>
<li><strong>逻辑封装</strong>：组件内部封装了所有API调用逻辑、错误处理和状态管理，对使用者完全透明。</li>
</ul>
<p><strong>代码示例</strong></p>
<pre><code class="hljs language-ini" lang="ini">&lt;template&gt;
  &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"ai-summary-wrapper"</span>&gt;
    &lt;textarea <span class="hljs-attr">v-model</span>=<span class="hljs-string">"inputText"</span> placeholder=<span class="hljs-string">"请输入要总结的文本..."</span>&gt;&lt;/textarea&gt;
    &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"controls"</span>&gt;
      &lt;span&gt;总结强度: &lt;/span&gt;
      &lt;input <span class="hljs-attr">type</span>=<span class="hljs-string">"range"</span> v-model=<span class="hljs-string">"summaryLength"</span> min=<span class="hljs-string">"1"</span> max=<span class="hljs-string">"10"</span>&gt;
      &lt;button @<span class="hljs-attr">click</span>=<span class="hljs-string">"summarize"</span> :disabled=<span class="hljs-string">"isLoading"</span>&gt;
        {{ isLoading ? '总结中...' : '一键总结' }}
      &lt;/button&gt;
    &lt;/div&gt;
    &lt;div <span class="hljs-attr">v-if</span>=<span class="hljs-string">"error"</span> class=<span class="hljs-string">"error"</span>&gt;{{ error }}&lt;/div&gt;
    &lt;div <span class="hljs-attr">v-if</span>=<span class="hljs-string">"summary"</span> class=<span class="hljs-string">"result"</span>&gt;
      &lt;h4&gt;总结结果:&lt;/h4&gt;
      &lt;p&gt;{{ summary }}&lt;/p&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref } from 'vue'<span class="hljs-comment">;</span>
import { summaryApi } from '../apis/summaryApi'<span class="hljs-comment">; // TRAE SOLO生成的标准化API模块</span>

const <span class="hljs-attr">inputText</span> = ref(<span class="hljs-string">''</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">summaryLength</span> = ref(<span class="hljs-number">5</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">summary</span> = ref(<span class="hljs-string">''</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">isLoading</span> = ref(<span class="hljs-literal">false</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">error</span> = ref(<span class="hljs-string">''</span>)<span class="hljs-comment">;</span>

const <span class="hljs-attr">summarize</span> = async () =&gt; {
  <span class="hljs-attr">isLoading.value</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
  <span class="hljs-attr">error.value</span> = <span class="hljs-string">''</span><span class="hljs-comment">;</span>
  try {
    const <span class="hljs-attr">response</span> = await summaryApi({
      text: inputText.value,
      length: summaryLength.value
    })<span class="hljs-comment">;</span>
    <span class="hljs-attr">summary.value</span> = response.data<span class="hljs-comment">;</span>
  } catch (err) {
    <span class="hljs-attr">error.value</span> = <span class="hljs-string">'总结失败，请重试'</span><span class="hljs-comment">;</span>
  } finally {
    <span class="hljs-attr">isLoading.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
  }
}<span class="hljs-comment">;</span>
&lt;/script&gt;
</code></pre>
<hr/>
<h4 data-id="heading-6"><strong>第四阶段：质量与安全管控 - “兼容性修复”与“安全踩坑”</strong></h4>
<p><strong>目标</strong>：确保组件库的健壮性和安全性。<strong>TRAE SOLO实践</strong>：</p>
<ul>
<li>
<p><strong>DiffView工具</strong>：当AI模型API升级导致接口变更时，使用DiffView工具快速识别出响应数据结构的变化（例如从 <code>result.summary</code>变为 <code>result.content</code>），并自动修复受影响的前端组件代码。</p>
</li>
<li>
<p><strong>密钥安全管理</strong>：绝对避免在前端代码中硬编码API Key。TRAE SOLO应帮助建立最佳实践：</p>
<ol>
<li>为每个前端组件生成一个安全的“API路由代理”（如 <code>/api/summarize</code>）。</li>
<li>API Key保存在后端服务器环境变量中，前端组件通过代理路由访问AI服务，彻底隔离密钥。</li>
<li>同时，代理路由还可以实现权限校验、限流、缓存等安全策略。</li>
</ol>
</li>
</ul>
<hr/>
<h4 data-id="heading-7"><strong>第五阶段：文档、示例与发布</strong></h4>
<p><strong>目标</strong>：打造可用的产品，而不仅仅是一堆代码。</p>
<ul>
<li><strong>自动生成文档</strong>：使用TRAE SOLO为每个组件自动生成Markdown文档，包含Props、Events、Slots和用法示例。</li>
<li><strong>构建与打包</strong>：配置构建流程，将组件库打包为NPM包（<code>ai-component-lib</code>），支持按需引入和Tree Shaking。</li>
<li><strong>版本管理</strong>：遵循语义化版本控制，清晰地管理迭代。</li>
</ul>
<h4 data-id="heading-8"><strong>最后</strong></h4>
<p>通过以上五个阶段，我们成功地<strong>将图片中TRAE SOLO在“大模型工程化”方面的核心能力，应用到了一个具体的问题——“从0到1搭建AI组件库系统”上</strong>。这个方案的优势在于：</p>
<ol>
<li><strong>工程化</strong>：不只是写组件，而是构建一个可维护、可扩展的系统。</li>
<li><strong>AI驱动</strong>：每个组件的核心价值都来源于精心选择和集成的AI模型。</li>
<li><strong>安全可靠</strong>：通过工程化手段解决了API密钥安全和接口变更兼容性两大核心痛点。</li>
<li><strong>高效交付</strong>：利用TRAE SOLO的代码生成和自动化能力，极大提升了从想法到产出的效率。</li>
</ol>
<h4 data-id="heading-9"><strong>总结：TRAE SOLO重新定义了前端在AI时代的角色</strong></h4>
<p>总而言之，TRAE SOLO对于前端开发者的价值，我觉得是推动前端开发者从被动的AI集成者转变为主动的AI应用构建者。</p>
<p>当下正在进行前端组件库的设计与开发，欢迎大家讨论。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Tauri 和 enigo 你们不许再崩溃啦！]]></title>    <link>https://juejin.cn/post/7571892340878000166</link>    <guid>https://juejin.cn/post/7571892340878000166</guid>    <pubDate>2025-11-13T07:00:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571892340878000166" data-draft-id="7571786149591121971" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Tauri 和 enigo 你们不许再崩溃啦！"/> <meta itemprop="keywords" content="Rust,客户端"/> <meta itemprop="datePublished" content="2025-11-13T07:00:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="猛喝威士忌"/> <meta itemprop="url" content="https://juejin.cn/user/3837719308930574"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Tauri 和 enigo 你们不许再崩溃啦！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3837719308930574/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    猛喝威士忌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T07:00:47.000Z" title="Thu Nov 13 2025 07:00:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Rust 新手 轻喷</p>
<p>最近闲暇时间一直在开发Auto Engine这个项目（具体名字还没定，就先叫这个吧），倒也踩了不少坑，尤其是Enigo这个crate，这小子还真不省心。</p>
<p>Auto Engine是一个桌面自动化的工具，自然而然就包含了模拟键鼠的操作，基于Tauri开发，那自然而然就用到了Enigo这个crate。</p>
<p>结论：<code>enigo</code>这个库在不同OS上有一些细节需要关注</p>
<p>engio 这小子给我埋的第一个坑就是：</p>
<h2 data-id="heading-0">MacOS下的键盘模拟会崩溃</h2>
<p>虽然在Mac上开发，但因为有个具体的使用场景是Windows的，所以测试都放在了Win上，就理所应当得以为Mac上也能正常执行。更何况一开始在Mac上单独试用enigo的时候也没有发现问题。</p>
<p>但当我兴冲冲地编译完第一个Mac版的Auto Engine，点击运行后</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76a920cea38a474f8e2dfbd88b76b461~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54yb5Zad5aiB5aOr5b-M:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763622046&amp;x-signature=TsrkTpauFMuxZLVI%2BOlygj5DD34%3D" alt="image.png" loading="lazy"/>
咔！的一下！崩溃了，而且没有任何日志输出😭</p>
<p>接着一步步定位，最终定位到了这段代码上</p>
<pre><code class="hljs language-rust" lang="rust">    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">keyboard</span>(&amp;<span class="hljs-keyword">self</span>, key: Key, direction: enigo::Direction) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;(), <span class="hljs-type">String</span>&gt; {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">enigo</span> = Enigo::<span class="hljs-title function_ invoke__">new</span>(&amp;Settings::<span class="hljs-title function_ invoke__">default</span>()).<span class="hljs-title function_ invoke__">unwrap</span>();
        
        enigo
            .<span class="hljs-title function_ invoke__">key</span>(key, direction)
            .<span class="hljs-title function_ invoke__">map_err</span>(|err| <span class="hljs-built_in">format!</span>(<span class="hljs-string">"Failed to click: {err}"</span>))?;
        <span class="hljs-title function_ invoke__">Ok</span>(())
    }
</code></pre>
<p>官方example ↓</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6498214807041769c5daf3f105ea4e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54yb5Zad5aiB5aOr5b-M:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763622046&amp;x-signature=C4f6yGh9khas6SSwpf06JK%2FjA34%3D" alt="image.png" loading="lazy"/>
这应该是一个非常非常标准使用 <code>enigo</code> 的代码（我觉得），几乎和官方的example中的代码没啥区别~吧？主要是这玩意儿在WIndows上跑一点问题都没有。</p>
<p>我开始请求网友的帮助，关键词：<code>macos</code> 、<code>Tauri</code>、<code>Enigo</code>、<code>Crush</code>。</p>
<p>✅<strong>好消息：</strong> 找到两个相关的Issue，一个是来自enigo这个仓库，另一个是来自tauri这个仓库</p>
<p>❌<strong>坏消息：</strong> 两个Issue都是Open的状态</p>
<p>（我先哭会儿🥹）</p>
<p>一看到都是Open的状态，看都懒得看了，大致浏览了一下，好像是跟 <code>并发</code>、<code>多线程</code> 有关系，不过两边都不知道怎么去解决这个问题。心如死灰，那段时间我甚至打算放弃Mac平台的编译了。</p>
<p>但是人嘛终究是贱，得不到的就更加爱~，对于自己解决不掉的问题，空的时候总归会回过头看看它还在不在那；就像跟你分手的前任一样，偷偷摸摸看看她朋友圈最近过得怎么样🤡</p>
<p>虽然很小丑，但是！你别说！你还真别说！</p>
<p>当我再次翻看<strong>tauri</strong>的这条issue的时候，你猜我发现了什么！</p>
<p>（我先帖一下这Issue： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftauri-apps%2Ftauri%2Fissues%2F6421%25EF%25BC%2589" target="_blank" title="https://github.com/tauri-apps/tauri/issues/6421%EF%BC%89" ref="nofollow noopener noreferrer">github.com/tauri-apps/…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42449429f7e3446d804ad5e6768b7104~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54yb5Zad5aiB5aOr5b-M:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763622046&amp;x-signature=xDHNaGF7G1kbg6164FN%2FbJBEyTw%3D" alt="image.png" loading="lazy"/></p>
<p>这位名字叫做<code>inomata137</code>的老哥，还真给了我个偏方，把前任问题解决了🤓，我tm不是小丑了哈哈！</p>
<p>他首先甩出了两个会崩溃的案例代码，然后注意看他的第三段代码，他直接就是一个 <code>run_on_main_thread</code> 让enigo这小子 直接就是说，在tauri的 主线程 中执行~</p>
<p>无敌</p>
<p>这波非常的无敌</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vue移动端开发长按对话复制功能]]></title>    <link>https://juejin.cn/post/7571734313927262242</link>    <guid>https://juejin.cn/post/7571734313927262242</guid>    <pubDate>2025-11-13T06:38:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571734313927262242" data-draft-id="7571722835658702882" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vue移动端开发长按对话复制功能"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-13T06:38:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="搞个锤子哟"/> <meta itemprop="url" content="https://juejin.cn/user/2146682667533309"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vue移动端开发长按对话复制功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2146682667533309/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    搞个锤子哟
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T06:38:09.000Z" title="Thu Nov 13 2025 06:38:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    15
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>效果：对话框长按弹出弹框，里面有按钮，可以增加功能</p>
</blockquote>
<h2 data-id="heading-0">检测对话框长按</h2>
<ul>
<li>要额外考虑按住对话框滑动对话列表的情况</li>
<li>封装hook实现</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/hooks/useLongPressBubble.js</span>
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useLongPressBubble</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> showBubble = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
  <span class="hljs-keyword">const</span> bubblePosition = <span class="hljs-title function_">ref</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">left</span>: <span class="hljs-number">0</span> })
  <span class="hljs-keyword">const</span> bubblePlacement = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'top'</span>) <span class="hljs-comment">// 出现方位（对话框上/下）</span>
  <span class="hljs-keyword">let</span> longPressTimer = <span class="hljs-literal">null</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">LONG_PRESS_DELAY</span> = <span class="hljs-number">500</span> <span class="hljs-comment">// ms</span>
  <span class="hljs-comment">// 用于判断是否发生移动(按住对话框滑动列表时 不该显示气泡框)</span>
  <span class="hljs-keyword">let</span> touchStartX = <span class="hljs-number">0</span>
  <span class="hljs-keyword">let</span> touchStartY = <span class="hljs-number">0</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MOVE_THRESHOLD</span> = <span class="hljs-number">10</span> <span class="hljs-comment">// 像素，超过即视为滑动</span>

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">clearTimer</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">if</span> (longPressTimer) {
      <span class="hljs-built_in">clearTimeout</span>(longPressTimer)
      longPressTimer = <span class="hljs-literal">null</span>
    }
  }
  <span class="hljs-comment">// 处理 touchmove，检测滑动</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">onTouchMove</span> = (<span class="hljs-params">event</span>) =&gt; {
    <span class="hljs-keyword">if</span> (!longPressTimer) <span class="hljs-keyword">return</span> <span class="hljs-comment">// 没有定时器，无需处理</span>

    <span class="hljs-keyword">const</span> touch = event.<span class="hljs-property">touches</span>[<span class="hljs-number">0</span>]
    <span class="hljs-keyword">const</span> dx = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(touch.<span class="hljs-property">clientX</span> - touchStartX)
    <span class="hljs-keyword">const</span> dy = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(touch.<span class="hljs-property">clientY</span> - touchStartY)

    <span class="hljs-keyword">if</span> (dx &gt; <span class="hljs-variable constant_">MOVE_THRESHOLD</span> || dy &gt; <span class="hljs-variable constant_">MOVE_THRESHOLD</span>) {
      <span class="hljs-comment">// 用户在滑动，取消长按</span>
      <span class="hljs-title function_">clearTimer</span>()
    }
  }
  <span class="hljs-comment">/**
   * 开始长按检测（兼容 Touch 和 Mouse）
   * <span class="hljs-doctag">@param</span> <span class="hljs-variable">event</span> - 触发事件（TouchEvent 或 MouseEvent）
   */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">startPress</span> = (<span class="hljs-params">event</span>) =&gt; {
    <span class="hljs-title function_">clearTimer</span>()
    <span class="hljs-keyword">const</span> target = event.<span class="hljs-property">currentTarget</span>
    <span class="hljs-keyword">if</span> (!target) <span class="hljs-keyword">return</span>

    <span class="hljs-comment">// 记录起始位置（仅 touch）</span>
    <span class="hljs-keyword">if</span> (event.<span class="hljs-property">type</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'touch'</span>)) {
      <span class="hljs-keyword">const</span> touch = event.<span class="hljs-property">touches</span>[<span class="hljs-number">0</span>]
      touchStartX = touch.<span class="hljs-property">clientX</span>
      touchStartY = touch.<span class="hljs-property">clientY</span>

      <span class="hljs-comment">// 监听 move 和 end</span>
      target.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'touchmove'</span>, onTouchMove, { <span class="hljs-attr">passive</span>: <span class="hljs-literal">true</span> })
      target.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'touchend'</span>, endPress, { <span class="hljs-attr">passive</span>: <span class="hljs-literal">true</span> })
      target.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'touchcancel'</span>, endPress, { <span class="hljs-attr">passive</span>: <span class="hljs-literal">true</span> })
    }

    longPressTimer = <span class="hljs-variable language_">window</span>.<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> rect = target.<span class="hljs-title function_">getBoundingClientRect</span>()
      <span class="hljs-keyword">const</span> scrollTop = <span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollY</span>
      <span class="hljs-keyword">const</span> scrollLeft = <span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollX</span>

      <span class="hljs-comment">// 判断元素距离视口顶部的距离</span>
      <span class="hljs-keyword">const</span> elementTopFromViewport = rect.<span class="hljs-property">top</span>
      <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">GAP</span> = <span class="hljs-number">10</span> <span class="hljs-comment">// 气泡与元素的间距</span>

      <span class="hljs-keyword">let</span> top, placement

      <span class="hljs-comment">// 如果元素太靠近顶部（比如 &lt; 50px），气泡放下面</span>
      <span class="hljs-keyword">if</span> (elementTopFromViewport &lt; <span class="hljs-number">50</span>) {
        top = rect.<span class="hljs-property">bottom</span> + scrollTop + <span class="hljs-variable constant_">GAP</span>
        placement = <span class="hljs-string">'bottom'</span>
      } <span class="hljs-keyword">else</span> {
        top = rect.<span class="hljs-property">top</span> + scrollTop - <span class="hljs-number">40</span> - <span class="hljs-variable constant_">GAP</span> <span class="hljs-comment">// 气泡高度约 40px</span>
        placement = <span class="hljs-string">'top'</span>
      }
      <span class="hljs-keyword">const</span> left = rect.<span class="hljs-property">left</span> + scrollLeft + <span class="hljs-number">10</span> <span class="hljs-comment">// 水平偏移</span>
      bubblePosition.<span class="hljs-property">value</span> = { top, left }
      bubblePlacement.<span class="hljs-property">value</span> = placement
      showBubble.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>

      <span class="hljs-comment">// 清理事件监听（长按已触发） 判定时间内有滚动，就不认为是长按</span>
      <span class="hljs-title function_">cleanupTouchListeners</span>(target)
    }, <span class="hljs-variable constant_">LONG_PRESS_DELAY</span>)
  }

  <span class="hljs-comment">/**
   * 结束长按（取消定时器）
   */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">endPress</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">clearTimer</span>()
  }

  <span class="hljs-comment">// 清理 touch 事件监听</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">cleanupTouchListeners</span> = (<span class="hljs-params">el</span>) =&gt; {
    el.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'touchmove'</span>, onTouchMove)
    el.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'touchend'</span>, endPress)
    el.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'touchcancel'</span>, endPress)
  }

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">closeBubble</span> = (<span class="hljs-params"/>) =&gt; {
    showBubble.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
  }

  <span class="hljs-keyword">return</span> {
    <span class="hljs-comment">// 状态</span>
    <span class="hljs-attr">showBubble</span>: showBubble,
    <span class="hljs-attr">bubblePosition</span>: bubblePosition,
    <span class="hljs-attr">bubblePlacement</span>: bubblePlacement,

    <span class="hljs-comment">// 方法</span>
    startPress,
    endPress,
    closeBubble,
  }
}

</code></pre>
<h2 data-id="heading-1">气泡框弹出后点击外部关闭气泡</h2>
<ul>
<li>之所以不用element-plus自带的v-clickoutside是因为移动端里气泡框出来时，又长按另一个对话框/滚动页面，也要关闭气泡框。而v-clickoutside一般是在目标元素外按下又松开才会触发</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/directives/clickOutside.js</span>
<span class="hljs-comment">// element-plus里自带的clickoutside需要外部按下并松开才能触发，本命令只用触碰了绑定元素外部就会触发</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleWrapper</span> = (<span class="hljs-params">el, handler</span>) =&gt; {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params">event</span>) =&gt; {
    <span class="hljs-comment">// 如果点击的是元素本身或其子元素，则不触发</span>
    <span class="hljs-keyword">if</span> (el.<span class="hljs-title function_">contains</span>(event.<span class="hljs-property">target</span>)) {
      <span class="hljs-keyword">return</span>
    }
    <span class="hljs-title function_">handler</span>(event)
  }

  <span class="hljs-comment">// 同时监听 mouse 和 touch（兼容移动端）</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousedown'</span>, handleClick)
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'touchstart'</span>, handleClick, { <span class="hljs-attr">passive</span>: <span class="hljs-literal">true</span> })

  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'mousedown'</span>, handleClick)
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'touchstart'</span>, handleClick)
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> vClickOutside = {
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params">el, binding</span>) {
    <span class="hljs-keyword">const</span> cleanup = <span class="hljs-title function_">handleWrapper</span>(el, binding.<span class="hljs-property">value</span>)
    el.<span class="hljs-property">__clickOutsideCleanup__</span> = cleanup
  },
  <span class="hljs-title function_">unmounted</span>(<span class="hljs-params">el</span>) {
    <span class="hljs-keyword">const</span> cleanup = el.<span class="hljs-property">__clickOutsideCleanup__</span>
    <span class="hljs-keyword">if</span> (cleanup) {
      <span class="hljs-title function_">cleanup</span>()
      <span class="hljs-keyword">delete</span> el.<span class="hljs-property">__clickOutsideCleanup__</span>
    }
  },
}

</code></pre>
<h2 data-id="heading-2">在vue项目里使用</h2>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"chat-list"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 消息列表 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
      <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in messages"</span>
      <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.id"</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"message-item"</span>
      @<span class="hljs-attr">touchstart.prevent</span>=<span class="hljs-string">"startPress($event)"</span>
      @<span class="hljs-attr">mousedown.prevent</span>=<span class="hljs-string">"startPress($event)"</span>
      @<span class="hljs-attr">contextmenu.prevent</span>
      @<span class="hljs-attr">touchend</span>=<span class="hljs-string">"endPress"</span>
      @<span class="hljs-attr">mouseup</span>=<span class="hljs-string">"endPress"</span>
      @<span class="hljs-attr">mouseleave</span>=<span class="hljs-string">"endPress"</span>
    &gt;</span>
      {{ item.text }}
      
    <span class="hljs-comment">&lt;!-- 气泡框 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
      <span class="hljs-attr">v-if</span>=<span class="hljs-string">"showBubble"</span>
      <span class="hljs-attr">:class</span>=<span class="hljs-string">"['bubble', bubblePlacement]"</span>
      <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ top: bubblePosition.top + 'px', left: bubblePosition.left + 'px' }"</span>
      <span class="hljs-attr">v-click-outside</span>=<span class="hljs-string">"closeBubble"</span>
      @<span class="hljs-attr">click</span>=<span class="hljs-string">"copyText"</span>
    &gt;</span>
      复制
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { useLongPressBubble } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks/useLongPressBubble'</span>
<span class="hljs-keyword">import</span> {vClickOutside} <span class="hljs-keyword">from</span> <span class="hljs-string">'@/directives/clickOutside'</span>

<span class="hljs-keyword">const</span> messages = <span class="hljs-title function_">ref</span>([
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'你好啊！'</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'今天过得怎么样？'</span> },
])

<span class="hljs-keyword">const</span> { showBubble, bubblePosition, bubblePlacement, startPress, endPress, closeBubble } =
  <span class="hljs-title function_">useLongPressBubble</span>()

<span class="hljs-comment">// 关闭气泡的函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">closeBubble</span> = (<span class="hljs-params"/>) =&gt; {
  showBubble.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
}

<span class="hljs-comment">// 局部注册指令（适用于 &lt;script setup&gt;）</span>
<span class="hljs-title function_">defineOptions</span>({
  <span class="hljs-attr">directives</span>: {
    <span class="hljs-title class_">ClickOutside</span>: vClickOutside,
  },
})

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">copyText</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> navigator.<span class="hljs-property">clipboard</span>.<span class="hljs-title function_">writeText</span>(textToCopy.<span class="hljs-property">value</span>)
      showBubble.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'复制失败:'</span>, err)
      showBubble.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"sass"</span>&gt;</span><span class="css">
  <span class="hljs-selector-class">.bubble</span> {
    <span class="hljs-attr">--bubble-color</span>: <span class="hljs-number">#000</span>;
    <span class="hljs-attribute">position</span>: fixed;
    <span class="hljs-attribute">background</span>: <span class="hljs-built_in">var</span>(--bubble-color);
    <span class="hljs-attribute">color</span>: white;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">6px</span> <span class="hljs-number">12px</span>;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
    <span class="hljs-attribute">z-index</span>: <span class="hljs-number">1000</span>;
    <span class="hljs-attribute">cursor</span>: pointer;
    user-select: none;
    <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">6px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.2</span>);
    <span class="hljs-comment">/* 当有 .top 类时，在底部居中显示朝下的三角形 */</span>
    &amp;<span class="hljs-selector-class">.top</span><span class="hljs-selector-pseudo">::after</span> {
      <span class="hljs-attribute">content</span>: <span class="hljs-string">''</span>;
      <span class="hljs-attribute">position</span>: absolute;
      <span class="hljs-attribute">bottom</span>: -<span class="hljs-number">5px</span>; <span class="hljs-comment">/* 根据三角形高度调整，这里假设高为10px */</span>
      <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
      <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(-<span class="hljs-number">50%</span>);
      <span class="hljs-attribute">width</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">border-left</span>: <span class="hljs-number">5px</span> solid transparent;
      <span class="hljs-attribute">border-right</span>: <span class="hljs-number">5px</span> solid transparent;
      <span class="hljs-attribute">border-top</span>: <span class="hljs-number">5px</span> solid <span class="hljs-built_in">var</span>(--bubble-color); 
    }

    <span class="hljs-comment">/* 当有 .bottom 类时，在顶部居中显示朝上的三角形 */</span>
    &amp;<span class="hljs-selector-class">.bottom</span><span class="hljs-selector-pseudo">::after</span> {
      <span class="hljs-attribute">content</span>: <span class="hljs-string">''</span>;
      <span class="hljs-attribute">position</span>: absolute;
      <span class="hljs-attribute">top</span>: -<span class="hljs-number">5px</span>; <span class="hljs-comment">/* 根据三角形高度调整 */</span>
      <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
      <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(-<span class="hljs-number">50%</span>);
      <span class="hljs-attribute">width</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">border-left</span>: <span class="hljs-number">5px</span> solid transparent;
      <span class="hljs-attribute">border-right</span>: <span class="hljs-number">5px</span> solid transparent;
      <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">5px</span> solid <span class="hljs-built_in">var</span>(--bubble-color);
    }
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h3 data-id="heading-3">补充：</h3>
<ul>
<li>上面那种复制文字的方式会弹授权弹框，如果不复制复杂内容，用下面这种方式即可</li>
</ul>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">copyToClipboard</span>(text, successCB) {
  const <span class="hljs-selector-tag">textarea</span> = document<span class="hljs-selector-class">.createElement</span>('textarea')
  <span class="hljs-selector-tag">textarea</span><span class="hljs-selector-class">.value</span> = text
  <span class="hljs-selector-tag">textarea</span><span class="hljs-selector-class">.style</span><span class="hljs-selector-class">.position</span> = 'fixed' <span class="hljs-comment">// 避免滚动问题</span>
  document<span class="hljs-selector-class">.body</span><span class="hljs-selector-class">.appendChild</span>(textarea)
  <span class="hljs-selector-tag">textarea</span><span class="hljs-selector-class">.select</span>()
  try {
    const successful = document<span class="hljs-selector-class">.execCommand</span>('copy')
    if (successful) {
      <span class="hljs-built_in">messageOpen</span>('复制成功!')
      successCB &amp;&amp; <span class="hljs-built_in">successCB</span>()
    } else {
      <span class="hljs-built_in">messageError</span>('本设备不支持复制!')
    }
  } catch (err) {
    <span class="hljs-built_in">messageError</span>('复制失败' + err)
  }
  document<span class="hljs-selector-class">.body</span><span class="hljs-selector-class">.removeChild</span>(textarea) <span class="hljs-comment">// 清理</span>
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue2项目部署后更新版本提示]]></title>    <link>https://juejin.cn/post/7571815573932261439</link>    <guid>https://juejin.cn/post/7571815573932261439</guid>    <pubDate>2025-11-13T06:48:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571815573932261439" data-draft-id="7571726099690209299" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue2项目部署后更新版本提示"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-13T06:48:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Vhen"/> <meta itemprop="url" content="https://juejin.cn/user/1697279002813517"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue2项目部署后更新版本提示
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1697279002813517/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Vhen
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T06:48:11.000Z" title="Thu Nov 13 2025 06:48:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">封装插件VersionPlugin</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">NAME</span> = <span class="hljs-string">"cp-version"</span>;
<span class="hljs-keyword">class</span> <span class="hljs-title class_">VersionPlugin</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = {
      <span class="hljs-attr">versionFileName</span>: <span class="hljs-string">'version.json'</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">'检测到新版本，点击更新最新版！'</span>,
      ...options,
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">version</span> = process.<span class="hljs-property">env</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">keyName</span>] || <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>.0.0`</span>
  }
  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) {
    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">beforeRun</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-variable constant_">NAME</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'before run'</span>)
      <span class="hljs-comment">// 生成的版本 json 文件建议放置在 public 文件夹下</span>
      <span class="hljs-keyword">const</span> filePath = path.<span class="hljs-title function_">resolve</span>(
        __dirname,
        <span class="hljs-string">'../../public'</span>,
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">versionFileName</span>,
      )
      <span class="hljs-comment">// 生成文件</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">generateFile</span>(
        filePath,
<span class="hljs-string">`{
  "version": "<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.version}</span>",
  "message": "<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.options.message}</span>"
}`</span>,
      )
    })
    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">done</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-variable constant_">NAME</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'done ...'</span>)
    })
  }
  <span class="hljs-title function_">generateFile</span>(<span class="hljs-params">path, content</span>) {
    fs.<span class="hljs-title function_">writeFileSync</span>(path, content)
  }
}

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title class_">VersionPlugin</span>


</code></pre>
<h3 data-id="heading-1">配置插件</h3>
<ul>
<li>vue.config.js</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title class_">VersionPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./src/plugins/versionPlugin'</span>)

  <span class="hljs-attr">configureWebpack</span>: <span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> plugins = []
    plugins.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">VersionPlugin</span>())
    config.<span class="hljs-property">plugins</span> = [...config.<span class="hljs-property">plugins</span>, ...plugins]
  })

</code></pre>
<h3 data-id="heading-2">封装vue插件</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">MessageBox</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'element-ui'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">install</span>(<span class="hljs-params">Vue, options</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CP_VERSION</span> = <span class="hljs-string">'CP_VERSION'</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">checkVersion</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">let</span> preVersion = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-variable constant_">CP_VERSION</span>)
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/newcp/version.json?t=<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>)
      <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()

      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'@@之前版本'</span>, preVersion)
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'@@当前版本'</span>, data.<span class="hljs-property">version</span>)
      <span class="hljs-keyword">if</span> (data.<span class="hljs-property">version</span> !== preVersion) {
        <span class="hljs-title class_">MessageBox</span>.<span class="hljs-title function_">confirm</span>(data.<span class="hljs-property">message</span>, <span class="hljs-string">'温馨提示'</span>, {
          <span class="hljs-attr">confirmButtonText</span>: <span class="hljs-string">'更新版本'</span>,
          <span class="hljs-attr">showClose</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">showCancelButton</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">closeOnClickModal</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">type</span>: <span class="hljs-string">'warning'</span>,
        }).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-variable constant_">CP_VERSION</span>, data.<span class="hljs-property">version</span>)
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'@@更新版本'</span>)
          <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-title function_">reload</span>()
        })
      }
    }
    <span class="hljs-title function_">checkVersion</span>()
    <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">checkVersion</span>()
    }, <span class="hljs-number">10000</span>)
    <span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">$checkVersion</span> = checkVersion
  },
}

</code></pre>
<h3 data-id="heading-3">使用</h3>
<ul>
<li>main.js</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> checkVersionNotify <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils/checkVersionNotify.js'</span>
<span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">use</span>(checkVersionNotify)
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[鸿蒙Next系统手机使用Charles配置证书并抓包教程]]></title>    <link>https://juejin.cn/post/7571734313927426082</link>    <guid>https://juejin.cn/post/7571734313927426082</guid>    <pubDate>2025-11-13T07:00:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571734313927426082" data-draft-id="7571751593205973044" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="鸿蒙Next系统手机使用Charles配置证书并抓包教程"/> <meta itemprop="keywords" content="HarmonyOS,前端"/> <meta itemprop="datePublished" content="2025-11-13T07:00:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Keya"/> <meta itemprop="url" content="https://juejin.cn/user/870468938379671"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            鸿蒙Next系统手机使用Charles配置证书并抓包教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/870468938379671/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Keya
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T07:00:13.000Z" title="Thu Nov 13 2025 07:00:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">鸿蒙Next系统手机使用Charles配置证书并抓包教程</h2>
<h3 data-id="heading-1">准备工作</h3>
<p>在开始配置之前，请确保你已经准备好了以下工具和环境：</p>
<ol>
<li><strong>硬件设备</strong>：一部搭载鸿蒙Next系统的手机（如华为Mate 60系列）和一台电脑（Windows、macOS或Linux均可）。</li>
<li><strong>软件工具</strong>：Charles Proxy抓包工具（建议使用最新版本5.0.1及以上），可从<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.charlesproxy.com%2F" target="_blank" title="https://www.charlesproxy.com/" ref="nofollow noopener noreferrer">官网</a>下载安装。</li>
<li><strong>网络环境</strong>：确保手机和电脑连接到同一个局域网（可以是同一个Wi-Fi或电脑共享热点）。</li>
<li><strong>开发工具</strong>：安装鸿蒙开发工具包中的hdc命令行工具，用于在电脑和手机之间传输文件和执行命令。</li>
</ol>
<h3 data-id="heading-2">详细步骤</h3>
<h4 data-id="heading-3">步骤一：安装并配置Charles</h4>
<ol>
<li><strong>安装Charles</strong>：按照官方指引安装Charles到你的电脑上。安装完成后，打开Charles，你会看到如下主界面：</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fc3b184c948471f8085580eafdb6d47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2V5YQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763622013&amp;x-signature=hoAPDxhuyx6zDYJcJjiNGL6v1x4%3D" alt="Charles抓包工具主界面" loading="lazy"/></p>
<ol start="2">
<li>
<p><strong>配置代理端口</strong>：点击菜单栏中的"Proxy" -&gt; "Proxy Settings"，在弹出的窗口中设置代理端口（默认是8888），并勾选"Enable transparent HTTP proxying"选项。</p>
</li>
<li>
<p><strong>配置SSL代理</strong>：点击"Proxy" -&gt; "SSL Proxy Settings"，在"Include"栏中添加"*:443"，这样Charles就能捕获所有HTTPS流量了。</p>
</li>
</ol>
<h4 data-id="heading-4">步骤二：导出Charles根证书</h4>
<ol>
<li>
<p><strong>导出证书</strong>：在Charles中，点击菜单栏的"Help" -&gt; "SSL Proxying" -&gt; "Save Charles Root Certificate"，将证书保存为PEM格式到电脑上。</p>
</li>
<li>
<p><strong>通过hdc命令传输证书到手机</strong>：使用以下命令将证书发送到手机的Download目录：</p>
</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">hdc file send /path/to/your/charles.pem /storage/media/100/local/files/Download/charles.pem
</code></pre>
<ol start="3">
<li>
<p>可以找个存储服务器, 然后通过手机浏览器打开对应的地址直接进行下载</p>
<p>3.1 通过vscode的live server 直接启动本地服务器是一个办法
3.2 可以通过网络其他平台, 比如 文叔叔等等</p>
</li>
</ol>
<h4 data-id="heading-5">步骤三：在鸿蒙Next手机上安装证书</h4>
<ol>
<li><strong>启动证书安装器</strong>：在电脑上执行以下命令，启动手机上的证书安装器：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">hdc shell aa start -a MainAbility -b com.ohos.certmanager
</code></pre>
<ol start="2">
<li><strong>安装证书</strong>：在手机上，按照提示选择"从存储设备安装"，找到并选择刚才传输的charles.pem证书文件。安装过程中，系统会提示"此CA根目录证书不受信任"，这是正常现象，继续安装即可。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b14276bd8d5479fb9d382d2dc1712db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2V5YQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763622013&amp;x-signature=T8AdvI6%2BmFhUsUqyXOaBJhw%2FEPQ%3D" alt="Charles证书安装步骤" loading="lazy"/></p>
<h4 data-id="heading-6">步骤四：配置手机代理</h4>
<ol>
<li><strong>进入WLAN设置</strong>：在手机上打开"设置" -&gt; "WLAN"，找到并长按当前连接的Wi-Fi网络，选择"修改网络"。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/043850ce04594c9ebea6e9eaa90b37e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2V5YQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763622013&amp;x-signature=JYjJG7N5sKzGdFQNXmtDX4hdYU8%3D" alt="鸿蒙Next系统设置界面" loading="lazy"/></p>
<ol start="2">
<li><strong>设置手动代理</strong>：在网络设置页面中，点击"代理"，选择"手动"。输入电脑的IP地址和Charles的代理端口（默认8888）。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a32e4ed64e246a19699aeac546ff0db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2V5YQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763622013&amp;x-signature=3VaXH399pla6r4yP3aYC1fF3LTA%3D" alt="鸿蒙手机WiFi代理配置" loading="lazy"/></p>
<h4 data-id="heading-7">步骤五：开始抓包</h4>
<ol>
<li>
<p><strong>启动Charles抓包</strong>：在Charles中点击工具栏上的"开始录制"按钮（红色圆点），开始捕获网络请求。</p>
</li>
<li>
<p><strong>测试抓包</strong>：在手机上打开浏览器或其他应用，访问一个HTTPS网站。此时，Charles应该能显示捕获到的网络请求，包括请求头、响应内容等详细信息。</p>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/539efc0e400b4749805c716de87a0cf9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2V5YQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763622013&amp;x-signature=%2BkHZE28oHTUTKO%2BBQAgg9YcqV1k%3D" alt="HTTPS抓包成功示例" loading="lazy"/></p>
<h3 data-id="heading-8">扩展内容：鸿蒙安全模型与抓包合规</h3>
<p>鸿蒙Next系统采用了多层次的安全防护体系，包括应用沙箱隔离、证书链验证、权限精细化管理等机制。在进行抓包操作时，需要特别注意以下几点：</p>
<ol>
<li>
<p><strong>证书信任机制</strong>：鸿蒙Next默认不信任用户安装的CA证书，因此需要手动将Charles证书安装到系统的"受信任的根证书颁发机构"存储区。即使如此，部分系统应用和高安全性应用可能仍然会拒绝使用用户安装的证书。</p>
</li>
<li>
<p><strong>应用网络安全配置</strong>：鸿蒙应用可以通过配置network_security_config.xml文件来限制对用户证书的信任。如果遇到无法抓包的应用，可能需要修改其网络安全配置，添加对用户证书的信任：</p>
</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">network-security-config</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">base-config</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">trust-anchors</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">certificates</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"system"</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">certificates</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"user"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">trust-anchors</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">base-config</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">network-security-config</span>&gt;</span>
</code></pre>
<ol start="3">
<li><strong>隐私保护注意事项</strong>：抓包操作可能会获取到敏感的个人信息，如登录凭证、支付信息等。请确保你的抓包行为符合相关法律法规，仅对自己开发的应用或获得授权的应用进行抓包测试。</li>
</ol>
<h3 data-id="heading-9">注意事项</h3>
<ol>
<li>
<p><strong>证书格式要求</strong>：鸿蒙Next系统仅支持PEM格式的证书，不支持CRT格式。如果你的证书是CRT格式，需要先转换为PEM格式。</p>
</li>
<li>
<p><strong>hdc命令使用</strong>：使用hdc命令时，确保手机已开启"开发者模式"和"USB调试"功能。如果遇到"设备未连接"的错误，可以尝试重启adb服务或重新插拔USB线。</p>
</li>
<li>
<p><strong>系统版本兼容性</strong>：不同版本的鸿蒙Next系统可能在证书安装和代理设置步骤上略有差异。本文档基于鸿蒙Next 5.1.0.150版本编写，如果你使用的是其他版本，可能需要适当调整步骤。</p>
</li>
<li>
<p><strong>网络代理冲突</strong>：如果你的网络环境中存在其他代理服务器，可能会导致Charles抓包失败。建议在抓包期间关闭其他代理软件或配置。</p>
</li>
</ol>
<h3 data-id="heading-10">常见问题排查</h3>
<h4 data-id="heading-11">问题一：无法访问chls.pro/ssl下载证书</h4>
<p>如果你在手机浏览器中访问<a href="https://link.juejin.cn?target=http%3A%2F%2Fchls.pro%2Fssl%25E6%2597%25B6%25E6%2597%25A0%25E6%25B3%2595%25E4%25B8%258B%25E8%25BD%25BD%25E8%25AF%2581%25E4%25B9%25A6%25EF%25BC%258C%25E5%258F%25AF%25E4%25BB%25A5%25E5%25B0%259D%25E8%25AF%2595%25E4%25BB%25A5%25E4%25B8%258B%25E8%25A7%25A3%25E5%2586%25B3%25E6%2596%25B9%25E6%25B3%2595%25EF%25BC%259A" target="_blank" title="http://chls.pro/ssl%E6%97%B6%E6%97%A0%E6%B3%95%E4%B8%8B%E8%BD%BD%E8%AF%81%E4%B9%A6%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%B0%9D%E8%AF%95%E4%BB%A5%E4%B8%8B%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%EF%BC%9A" ref="nofollow noopener noreferrer">chls.pro/ssl时无法下载证书，…</a></p>
<ol>
<li>确保手机已正确配置代理，并且Charles正在运行。</li>
<li>在Charles中，点击"Help" -&gt; "SSL Proxying" -&gt; "Install Charles Root Certificate on a Mobile Device or Remote Browser"，然后按照提示操作。</li>
<li>如果仍然无法下载，可以手动从电脑导出证书，再通过hdc命令传输到手机。</li>
</ol>
<h4 data-id="heading-12">问题二：安装证书后仍无法抓取HTTPS请求</h4>
<p>如果已经安装了Charles证书，但仍然无法抓取HTTPS请求，可能是以下原因导致：</p>
<ol>
<li>
<p><strong>应用使用了证书固定（Certificate Pinning）</strong>：部分应用会固定服务器证书，拒绝使用用户安装的CA证书。这种情况下，需要对应用进行反编译，移除证书固定逻辑，或者使用Frida等工具在运行时绕过证书验证。</p>
</li>
<li>
<p><strong>Charles配置错误</strong>：检查Charles的SSL Proxy Settings，确保已添加"*:443"规则，并且"Enable SSL proxying"选项已勾选。</p>
</li>
<li>
<p><strong>证书未正确安装</strong>：进入手机的"设置" -&gt; "安全" -&gt; "加密与凭据" -&gt; "信任的凭据"，检查Charles证书是否在"用户"标签下，并且状态为"已启用"。</p>
</li>
</ol>
<h4 data-id="heading-13">问题三：抓包时手机无法上网</h4>
<p>如果配置代理后手机无法上网，可能是以下原因：</p>
<ol>
<li>
<p><strong>代理设置错误</strong>：检查代理服务器的IP地址和端口是否正确，确保电脑和手机在同一个局域网。</p>
</li>
<li>
<p><strong>防火墙拦截</strong>：检查电脑的防火墙设置，确保Charles的端口（默认8888）没有被防火墙阻止。</p>
</li>
<li>
<p><strong>Charles未授权</strong>：当手机第一次连接到Charles时，电脑上会弹出授权窗口，需要点击"Allow"允许连接。如果不小心点击了"Deny"，可以在Charles的"Proxy" -&gt; "Access Control Settings"中添加手机的IP地址到允许列表。</p>
</li>
</ol>
<h3 data-id="heading-14">结语</h3>
<p>通过本文的步骤，你应该已经成功在鸿蒙Next系统手机上配置好了Charles证书并实现了HTTPS抓包。抓包技术是应用开发和调试的重要工具，但同时也需要注意遵守法律法规和隐私保护原则。</p>
<p>鸿蒙Next系统的安全机制在不断强化，未来可能会对抓包行为施加更多限制。作为开发者，我们需要不断学习和适应新的技术变化，同时始终将用户隐私和数据安全放在首位。</p>
<p>希望本文对你有所帮助！如果你在配置过程中遇到其他问题，欢迎在评论区留言讨论。</p>
<hr/>
<p>End</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 深拷贝全解析：从栈与堆内存机制到安全对象复制实践]]></title>    <link>https://juejin.cn/post/7571837786250887214</link>    <guid>https://juejin.cn/post/7571837786250887214</guid>    <pubDate>2025-11-13T06:48:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571837786250887214" data-draft-id="7571837786250821678" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 深拷贝全解析：从栈与堆内存机制到安全对象复制实践"/> <meta itemprop="keywords" content="前端,JavaScript,JSON"/> <meta itemprop="datePublished" content="2025-11-13T06:48:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AAA阿giao"/> <meta itemprop="url" content="https://juejin.cn/user/473218785740627"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 深拷贝全解析：从栈与堆内存机制到安全对象复制实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/473218785740627/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AAA阿giao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T06:48:33.000Z" title="Thu Nov 13 2025 06:48:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在 JavaScript 开发中，对象的复制是一个看似简单却极易出错的问题。很多初学者甚至中级开发者都曾因“浅拷贝”导致数据意外修改而陷入调试困境。本文将从底层内存机制出发，系统讲解 <strong>栈内存与堆内存的区别</strong>、<strong>它们如何协同工作</strong>，并深入剖析 <strong>什么是真正的深拷贝</strong>，以及如何在实际开发中安全地实现它。</p>
<hr/>
<h2 data-id="heading-1">一、栈内存 vs 堆内存：程序运行的“骨架”与“血肉”</h2>
<p>要真正理解深拷贝，必须先了解 JavaScript（以及其他高级语言）是如何管理内存的。程序运行时，内存主要分为两个区域：<strong>栈（Stack）</strong> 和 <strong>堆（Heap）</strong> 。</p>
<h3 data-id="heading-2">1. 栈内存：自动管理的“储物架”</h3>
<ul>
<li>
<p><strong>特点</strong>：</p>
<ul>
<li>遵循 <strong>先进后出（LIFO, Last In First Out）</strong> 原则。</li>
<li>存储 <strong>函数调用上下文</strong>、<strong>局部变量</strong> 和 <strong>基本数据类型</strong>（如 <code>number</code>、<code>string</code>、<code>boolean</code>、<code>undefined</code>、<code>null</code>、<code>symbol</code>、<code>bigint</code>）。</li>
<li>内存分配和释放由系统 <strong>自动完成</strong>，效率极高。</li>
</ul>
</li>
<li>
<p><strong>生命周期</strong>：</p>
<ul>
<li>当一个函数被调用时，其局部变量会被压入栈中；</li>
<li>函数执行完毕后，整个栈帧被弹出，内存自动释放。</li>
</ul>
</li>
</ul>
<blockquote>
<p>✅ 举例：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function">function <span class="hljs-title">foo</span>()</span> {
  <span class="hljs-keyword">let</span> a = <span class="hljs-number">10</span>;        <span class="hljs-comment">// a 存在栈中</span>
  <span class="hljs-keyword">let</span> b = <span class="hljs-string">"hello"</span>;   <span class="hljs-comment">// b 也存在栈中</span>
}
foo(); <span class="hljs-comment">// 执行结束后，a 和 b 自动销毁</span>
</code></pre>
</blockquote>
<h3 data-id="heading-3">2. 堆内存：手动（或半自动）管理的“大仓库”</h3>
<ul>
<li>
<p><strong>特点</strong>：</p>
<ul>
<li>用于存储 <strong>复杂数据结构</strong>，如对象（Object）、数组（Array）、函数（Function）等。</li>
<li>内存分配灵活，但访问速度略慢于栈。</li>
<li>在 JavaScript 中，堆内存由 <strong>垃圾回收机制（GC）</strong> 管理，而非程序员手动释放。</li>
</ul>
</li>
<li>
<p><strong>生命周期</strong>：</p>
<ul>
<li>对象一旦创建，就存在于堆中；</li>
<li>只有当没有任何引用指向该对象时，垃圾回收器才会将其回收。</li>
</ul>
</li>
</ul>
<blockquote>
<p>✅ 举例：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">let</span> user = { name: <span class="hljs-string">"Alice"</span>, age: <span class="hljs-number">25</span> };
<span class="hljs-comment">// 对象 { name: "Alice", age: 25 } 存在于堆中</span>
<span class="hljs-comment">// 变量 user（在栈中）保存的是该对象的内存地址（引用）</span>
</code></pre>
</blockquote>
<hr/>
<h2 data-id="heading-4">二、栈与堆的协作：引用机制揭秘</h2>
<p>JavaScript 中的对象操作本质上是 <strong>通过引用进行的</strong>。这种设计极大提升了性能，但也带来了“共享副作用”的风险。</p>
<h3 data-id="heading-5">关键关系：</h3>
<ol>
<li><strong>栈存引用，堆存实体</strong><br/>
当你声明一个对象变量时，<strong>变量本身（引用）存储在栈中</strong>，而<strong>对象的实际内容存储在堆中</strong>。</li>
<li><strong>赋值即复制引用</strong><br/>
如果你将一个对象赋值给另一个变量，实际上只是复制了栈中的引用地址，两个变量指向同一个堆内存位置。</li>
</ol>
<p>❗ 危险示例（浅拷贝陷阱）：</p>
<blockquote>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">users</span> = [
  { id: <span class="hljs-number">1</span>, name: <span class="hljs-string">'张三'</span> ,hometown:<span class="hljs-string">'北京'</span>},
  { id: <span class="hljs-number">2</span>, name: <span class="hljs-string">'李四'</span> ,hometown:<span class="hljs-string">'上海'</span>},
  { id: <span class="hljs-number">3</span>, name: <span class="hljs-string">'王五'</span> ,hometown:<span class="hljs-string">'广州'</span>}
]<span class="hljs-comment">;</span>

const  <span class="hljs-attr">data</span> = users<span class="hljs-comment">; </span>

<span class="hljs-attr">data.hobbies</span> = [<span class="hljs-string">'篮球'</span>,<span class="hljs-string">'足球'</span>,<span class="hljs-string">'跑步'</span>]<span class="hljs-comment">;</span>
console.log(data, users)<span class="hljs-comment">;</span>
</code></pre>
</blockquote>
<p>此时运行代码结果如下：</p>
<p> data内容的修改同时发生在users和data上</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbab76d804984bc293903f4b56b15b01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUFB6Zi_Z2lhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763621313&amp;x-signature=P%2FRlfFXP8sNEI1ANEK526st5NX8%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<ol>
<li><strong>生命周期解耦</strong><br/>
栈中变量的销毁（如函数结束）不会立即删除堆中的对象，只有当所有引用都消失后，对象才会被 GC 回收。</li>
</ol>
<hr/>
<h2 data-id="heading-6">三、什么是深拷贝？为什么需要它？</h2>
<h3 data-id="heading-7">定义</h3>
<blockquote>
<p><strong>深拷贝（Deep Copy）</strong> 是指：<strong>递归地复制对象及其所有嵌套属性，在堆内存中创建一个全新的、完全独立的对象副本</strong>。新对象与原对象没有任何引用关联。</p>
</blockquote>
<h3 data-id="heading-8">目标</h3>
<ul>
<li>修改副本 <strong>不影响原对象</strong>；</li>
<li>副本拥有 <strong>完整的数据结构副本</strong>，包括嵌套对象、数组等。</li>
</ul>
<hr/>
<h2 data-id="heading-9">四、实现深拷贝的常用方法</h2>
<h3 data-id="heading-10">方法 1：JSON 序列化 + 反序列化（最简单但有限制）</h3>
<p>这是前端开发中最常用的“伪深拷贝”技巧：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">users</span>; 
<span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">data</span>;  
<span class="hljs-selector-tag">users</span> = <span class="hljs-selector-attr">[  { id: 1, name: <span class="hljs-string">'张三'</span> ,hometown:<span class="hljs-string">'北京'</span>},  { id: 2, name: <span class="hljs-string">'李四'</span> ,hometown:<span class="hljs-string">'上海'</span>},  { id: 3, name: <span class="hljs-string">'王五'</span> ,hometown:<span class="hljs-string">'广州'</span>}]</span>; 

<span class="hljs-comment">// 深拷贝，是指在堆内存中，重新分配一个内存空间，存储拷贝的对象，而不是引用地址。</span>
<span class="hljs-comment">// 序列化 ：把对象转换为字符串 JSON.stringify()</span>
<span class="hljs-comment">// 反序列化 ：把字符串转换为对象 JSON.parse()</span>
<span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">data</span> = <span class="hljs-selector-tag">JSON</span><span class="hljs-selector-class">.parse</span>(JSON.<span class="hljs-built_in">stringify</span>(users));

<span class="hljs-selector-tag">data</span><span class="hljs-selector-attr">[0]</span><span class="hljs-selector-attr">[<span class="hljs-string">'hobbies'</span>]</span> = <span class="hljs-selector-attr">[<span class="hljs-string">'篮球'</span>,<span class="hljs-string">'足球'</span>,<span class="hljs-string">'跑步'</span>]</span>;
<span class="hljs-selector-tag">console</span><span class="hljs-selector-class">.log</span>(data, users);
</code></pre>
<p><strong>运行结果：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b87f65fcd78448eb20729166295ef47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUFB6Zi_Z2lhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763621313&amp;x-signature=UNa5%2BOMFyCB5g6j8MMzzi1YXqVM%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>✅ <strong>优点</strong>：</p>
<ul>
<li>代码简洁，一行搞定；</li>
<li>对纯 JSON 兼容的数据结构非常有效。</li>
</ul>
<p>❌ <strong>致命缺陷</strong>：</p>

































<table><thead><tr><th>问题</th><th>说明</th></tr></thead><tbody><tr><td><strong>函数丢失</strong></td><td><code>function</code> 会被忽略（<code>JSON.stringify</code> 不处理函数）</td></tr><tr><td><strong>undefined 丢失</strong></td><td>属性值为 <code>undefined</code> 的字段会被删除</td></tr><tr><td><strong>Symbol 键丢失</strong></td><td>Symbol 作为 key 无法被序列化</td></tr><tr><td><strong>循环引用崩溃</strong></td><td>对象自引用会导致 <code>JSON.stringify</code> 报错</td></tr><tr><td><strong>Date 变字符串</strong></td><td><code>new Date()</code> 会被转为 ISO 字符串，不再是 Date 对象</td></tr><tr><td><strong>RegExp、Error 等特殊对象失效</strong></td><td>转为普通对象或空对象</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-11">方法 2：手写递归深拷贝（更健壮）</h3>
<p>为了克服 JSON 方法的局限，我们可以手动实现一个支持更多类型的深拷贝函数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 手写递归深拷贝</span>
users = [
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span> ,<span class="hljs-attr">hometown</span>:<span class="hljs-string">'北京'</span>},
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'李四'</span> ,<span class="hljs-attr">hometown</span>:<span class="hljs-string">'上海'</span>},
  { <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'王五'</span> ,<span class="hljs-attr">hometown</span>:<span class="hljs-string">'广州'</span>}
];

<span class="hljs-keyword">function</span> <span class="hljs-title function_">deepClone</span>(<span class="hljs-params">obj, hash = <span class="hljs-keyword">new</span> <span class="hljs-built_in">WeakMap</span>()</span>) {
  <span class="hljs-comment">// 处理 null 和非对象类型</span>
  <span class="hljs-keyword">if</span> (obj === <span class="hljs-literal">null</span> || <span class="hljs-keyword">typeof</span> obj !== <span class="hljs-string">"object"</span>) <span class="hljs-keyword">return</span> obj;

  <span class="hljs-comment">// 防止循环引用</span>
  <span class="hljs-keyword">if</span> (hash.<span class="hljs-title function_">has</span>(obj)) <span class="hljs-keyword">return</span> hash.<span class="hljs-title function_">get</span>(obj);

  <span class="hljs-comment">// 处理 Date</span>
  <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Date</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(obj);

  <span class="hljs-comment">// 处理 RegExp</span>
  <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">RegExp</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(obj.<span class="hljs-property">source</span>, obj.<span class="hljs-property">flags</span>);

  <span class="hljs-comment">// 处理 Array 和 Object</span>
  <span class="hljs-keyword">const</span> cloned = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(obj) ? [] : {};

  <span class="hljs-comment">// 记录引用，防止循环</span>
  hash.<span class="hljs-title function_">set</span>(obj, cloned);

  <span class="hljs-comment">// 递归拷贝所有属性（包括 Symbol）</span>
  <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">ownKeys</span>(obj).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
    cloned[key] = <span class="hljs-title function_">deepClone</span>(obj[key], hash);
  });

  <span class="hljs-keyword">return</span> cloned;
}
<span class="hljs-keyword">const</span> data = <span class="hljs-title function_">deepClone</span>(users);
data[<span class="hljs-number">0</span>][<span class="hljs-string">'hobbies'</span>] = [<span class="hljs-string">'篮球'</span>,<span class="hljs-string">'足球'</span>,<span class="hljs-string">'跑步'</span>];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data, users);
</code></pre>
<p><strong>运行结果：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1d49e180ea247de8bb92adf6681656b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUFB6Zi_Z2lhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763621313&amp;x-signature=FEg8l%2FU20%2BHd2c5HL1xBVc%2Bf2qw%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>✅ <strong>优势</strong>：</p>
<ul>
<li>支持 <code>Date</code>、<code>RegExp</code>、<code>Symbol</code> 键；</li>
<li>能处理循环引用（通过 <code>WeakMap</code> 缓存已拷贝对象）；</li>
<li>保留函数（若需要可扩展）；</li>
<li>更接近“真正”的深拷贝。</li>
</ul>
<blockquote>
<p>💡 提示：生产环境中建议使用成熟库（如 Lodash 的 <code>_.cloneDeep</code>），避免重复造轮子。</p>
</blockquote>
<hr/>
<h3 data-id="heading-12">方法 3：使用第三方库（推荐生产环境）</h3>
<ul>
<li><strong>Lodash</strong>: <code>_.cloneDeep(value)</code></li>
<li><strong>jQuery</strong>: <code>$.extend(true, {}, obj)</code>（已不推荐）</li>
<li><strong>structuredClone()</strong> （现代浏览器原生支持）</li>
</ul>
<h4 data-id="heading-13">新标准：<code>structuredClone()</code></h4>
<p>ES2022 引入了全局函数 <code>structuredClone()</code>，专为深拷贝设计：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">copy</span> = structuredClone(original)<span class="hljs-comment">;</span>
</code></pre>
<p>支持：</p>
<ul>
<li>循环引用</li>
<li><code>Date</code>、<code>RegExp</code>、<code>Map</code>、<code>Set</code>、<code>ArrayBuffer</code> 等</li>
<li><code>undefined</code>、<code>Symbol</code>（部分限制）</li>
</ul>
<p>注意：</p>
<ul>
<li>仍不支持函数、DOM 节点等；</li>
<li>需要较新浏览器（Chrome 98+，Node.js 17+）</li>
</ul>
<hr/>
<h2 data-id="heading-14">五、总结：何时用哪种拷贝？</h2>

























<table><thead><tr><th>场景</th><th>推荐方法</th></tr></thead><tbody><tr><td>简单对象，无函数/日期/循环引用</td><td><code>JSON.parse(JSON.stringify(obj))</code></td></tr><tr><td>需要兼容旧环境，且结构复杂</td><td>手写递归 or Lodash <code>_.cloneDeep</code></td></tr><tr><td>现代项目，追求标准与性能</td><td><code>structuredClone()</code></td></tr><tr><td>仅需第一层拷贝（浅拷贝）</td><td><code>{...obj}</code> 或 <code>Object.assign({}, obj)</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-15">六、结语</h2>
<p>深拷贝不仅是语法技巧，更是对 <strong>内存模型</strong> 和 <strong>数据所有权</strong> 的深刻理解。掌握栈与堆的协作机制，能帮助我们写出更安全、更高效的代码。在实际开发中，请根据数据结构的复杂度和运行环境，选择最合适的拷贝策略。</p>
<blockquote>
<p><strong>记住</strong>：<br/>
浅拷贝是“共用一本日记”，<br/>
深拷贝是“誊抄一本新日记”。<br/>
别让别人的涂改，毁了你的原始记录！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 JavaScript 的 Array.prototype.map() 方法及其经典陷阱：从原理到面试实战]]></title>    <link>https://juejin.cn/post/7571830282850107443</link>    <guid>https://juejin.cn/post/7571830282850107443</guid>    <pubDate>2025-11-13T06:52:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571830282850107443" data-draft-id="7571829822340775987" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解 JavaScript 的 Array.prototype.map() 方法及其经典陷阱：从原理到面试实战"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-11-13T06:52:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AAA阿giao"/> <meta itemprop="url" content="https://juejin.cn/user/473218785740627"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解 JavaScript 的 Array.prototype.map() 方法及其经典陷阱：从原理到面试实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/473218785740627/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AAA阿giao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T06:52:51.000Z" title="Thu Nov 13 2025 06:52:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"> 引言</h2>
<p>在现代前端开发中，<code>Array.prototype.map()</code> 是我们最常用、也最容易“误用”的数组方法之一。它简洁优雅，但若对其底层机制缺乏深入理解，很容易在看似简单的代码中踩坑——尤其是与 <code>parseInt</code> 结合使用时的经典面试题 <code>[1, 2, 3].map(parseInt)</code>。本文将从 <strong>map 的核心机制</strong>、<strong>parseInt 的行为特性</strong>、<strong>NaN 与类型判断</strong>、<strong>JavaScript 包装类原理</strong>，一直到 <strong>字符串操作与编码细节</strong>，全面剖析这一知识点，并提供最佳实践建议。</p>
<hr/>
<h2 data-id="heading-1">一、<code>map()</code> 方法的核心机制</h2>
<h3 data-id="heading-2">1.1 基本功能与语法</h3>
<p><code>map()</code> 是 ES5 引入（常被误认为是 ES6 新增）的数组实例方法，用于<strong>创建一个新数组</strong>，其元素是原数组每个元素经过回调函数处理后的返回值。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">const</span> newArray = arr.<span class="hljs-built_in">map</span>(callbackFn(element, index, <span class="hljs-built_in">array</span>), thisArg);
</code></pre>
<ul>
<li>
<p><strong><code>callbackFn</code></strong>：为每个元素执行的函数，接收三个参数：</p>
<ul>
<li><code>element</code>：当前元素</li>
<li><code>index</code>：当前索引</li>
<li><code>array</code>：原数组本身</li>
</ul>
</li>
<li>
<p><strong><code>thisArg</code>（可选）</strong> ：指定回调函数内部的 <code>this</code> 值</p>
</li>
</ul>
<blockquote>
<p>⚠️ 注意：<code>map()</code> <strong>不会修改原数组</strong>，它总是返回一个<strong>全新数组</strong>。如果不需要返回值，应使用 <code>forEach</code> 或 <code>for...of</code>。</p>
</blockquote>
<h3 data-id="heading-3">1.2 实际应用示例</h3>
<pre><code class="hljs language-ini" lang="ini">// 示例1：平方每个元素
const <span class="hljs-attr">numbers</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">9</span>]<span class="hljs-comment">;</span>
const <span class="hljs-attr">squares</span> = numbers.map(x =&gt; x * x)<span class="hljs-comment">; // [1, 16, 81]</span>

// 示例2：对象转换
const <span class="hljs-attr">users</span> = [{ name: <span class="hljs-string">'Alice'</span> }, { name: <span class="hljs-string">'Bob'</span> }]<span class="hljs-comment">;</span>
const <span class="hljs-attr">names</span> = users.map(u =&gt; u.name)<span class="hljs-comment">; // ['Alice', 'Bob']</span>

// 示例3：通用性（可用于类数组对象）
const <span class="hljs-attr">arrayLike</span> = { length: <span class="hljs-number">2</span>, <span class="hljs-number">0</span>: <span class="hljs-string">'a'</span>, <span class="hljs-number">1</span>: <span class="hljs-string">'b'</span> }<span class="hljs-comment">;</span>
const <span class="hljs-attr">result</span> = Array.prototype.map.call(arrayLike, x =&gt; x.toUpperCase())<span class="hljs-comment">;</span>
// <span class="hljs-section">['A', 'B']</span>
</code></pre>
<h3 data-id="heading-4">1.3 稀疏数组与空槽处理</h3>
<p><code>map()</code> <strong>不会遍历稀疏数组中的空槽（empty slots）</strong> ，且结果数组也会保留这些空槽：</p>
<pre><code class="hljs language-c" lang="c">console.<span class="hljs-built_in">log</span>([<span class="hljs-number">1</span>, , <span class="hljs-number">3</span>].<span class="hljs-built_in">map</span>(x =&gt; x * <span class="hljs-number">2</span>));
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// Visit 0</span>
<span class="hljs-comment">// Visit 2</span>
<span class="hljs-comment">// [2, empty, 6]</span>
</code></pre>
<hr/>
<h2 data-id="heading-5">二、<code>parseInt()</code> 的行为特性与陷阱</h2>
<h3 data-id="heading-6">2.1 <code>parseInt(string, radix)</code> 的解析规则</h3>
<ul>
<li>
<p><code>string</code>：要解析的字符串</p>
</li>
<li>
<p><code>radix</code>（可选）：进制基数，范围 <strong>2–36</strong></p>
<ul>
<li>
<p>若 <code>radix</code> 为 <code>0</code> 或未传，则根据字符串内容自动推断：</p>
<ul>
<li><code>"0x..."</code> → 十六进制</li>
<li><code>"0..."</code>（旧规范）→ 八进制（现代 JS 已废弃）</li>
<li>否则默认十进制</li>
</ul>
</li>
<li>
<p>若 <code>radix</code> 无效（如 <code>1</code>、<code>-1</code>、<code>37</code>），返回 <code>NaN</code></p>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-7">2.2 进制转换实践</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-built_in">parseInt</span>(<span class="hljs-string">'0xF'</span>, <span class="hljs-number">16</span>);   <span class="hljs-comment">// 15（十六进制）</span>
<span class="hljs-built_in">parseInt</span>(<span class="hljs-string">'10'</span>, <span class="hljs-number">8</span>);     <span class="hljs-comment">// 8（八进制）</span>
<span class="hljs-built_in">parseInt</span>(<span class="hljs-string">'8'</span>, <span class="hljs-number">8</span>);      <span class="hljs-comment">// NaN（八进制无数字 8）</span>
<span class="hljs-built_in">parseInt</span>(<span class="hljs-string">'1.9'</span>, <span class="hljs-number">10</span>);   <span class="hljs-comment">// 1（只取整数部分）</span>
</code></pre>
<hr/>
<h2 data-id="heading-8">三、经典面试题深度解析：<code>[1, 2, 3].map(parseInt)</code></h2>
<h3 data-id="heading-9">3.1 问题现象</h3>
<pre><code class="hljs language-arduino" lang="arduino">console.<span class="hljs-built_in">log</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>].<span class="hljs-built_in">map</span>(parseInt)); <span class="hljs-comment">// [1, NaN, NaN]</span>
</code></pre>
<p><strong>预期结果</strong>：<code>[1, 2, 3]</code><br/>
<strong>实际结果</strong>：<code>[1, NaN, NaN]</code></p>
<h3 data-id="heading-10">3.2 根源分析</h3>
<p><strong><code>map()</code></strong> 调用回调时会传递 <strong>三个参数</strong>： <strong><code>(element, index, array)</code></strong> 。<br/>
而 <strong><code>parseInt</code></strong> 接收 <strong>两个参数</strong>： <strong><code>(string, radix)</code></strong> 。</p>
<p>因此， <strong><code>[1, 2, 3].map(parseInt)</code></strong> 等价于：</p>
<pre><code class="hljs language-ini" lang="ini">parseInt(1, 0, <span class="hljs-section">[1,2,3]</span>)  // <span class="hljs-attr">radix</span> = <span class="hljs-number">0</span> → 默认十进制 → <span class="hljs-number">1</span>
parseInt(2, 1, <span class="hljs-section">[1,2,3]</span>)  // <span class="hljs-attr">radix</span> = <span class="hljs-number">1</span> → 非法 → NaN
parseInt(3, 2, <span class="hljs-section">[1,2,3]</span>)  // <span class="hljs-attr">radix</span> = <span class="hljs-number">2</span> → 二进制无法表示 <span class="hljs-number">3</span> → NaN
</code></pre>
<blockquote>
<p>🔍 关键点：<strong><code>index</code> 被当作了 <code>radix</code>！</strong></p>
</blockquote>
<h3 data-id="heading-11">3.3 正确解决方案</h3>
<h4 data-id="heading-12">✅ 方案1：显式封装回调函数</h4>
<pre><code class="hljs language-javascript" lang="javascript">[<span class="hljs-string">'1'</span>, <span class="hljs-string">'2'</span>, <span class="hljs-string">'3'</span>].<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">str</span> =&gt;</span> <span class="hljs-built_in">parseInt</span>(str, <span class="hljs-number">10</span>)); <span class="hljs-comment">// [1, 2, 3]</span>
</code></pre>
<h4 data-id="heading-13">✅ 方案2：使用 <code>Number</code> 构造函数（更简洁）</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[<span class="hljs-string">'1'</span>, <span class="hljs-string">'2'</span>, <span class="hljs-string">'3'</span>]</span><span class="hljs-selector-class">.map</span>(Number); <span class="hljs-comment">// [1, 2, 3]</span>
</code></pre>
<blockquote>
<p>💡 注意：<code>Number</code> 会解析浮点数和科学计数法，而 <code>parseInt</code> 只取整数部分。</p>
</blockquote>
<hr/>
<h2 data-id="heading-14">四、特殊数值：<code>NaN</code> 与 <code>Infinity</code></h2>
<h3 data-id="heading-15">4.1 <code>NaN</code> 的特性</h3>
<ul>
<li>
<p><strong>含义</strong>：Not-a-Number，表示无效的数值运算结果</p>
</li>
<li>
<p><strong>类型</strong>：<code>typeof NaN === 'number'</code></p>
</li>
<li>
<p><strong>产生场景</strong>：</p>
<ul>
<li><code>0 / 0</code></li>
<li><code>Math.sqrt(-1)</code></li>
<li><code>parseInt('abc')</code></li>
<li><code>Number('xyz')</code></li>
</ul>
</li>
</ul>
<h3 data-id="heading-16">4.2 如何正确判断 <code>NaN</code>？</h3>
<p>由于 <code>NaN !== NaN</code>，不能用 <code>==</code> 或 <code>===</code> 判断！</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">//  错误方式</span>
<span class="hljs-keyword">if</span> (value === <span class="hljs-title class_">NaN</span>) { ... }

<span class="hljs-comment">//  正确方式</span>
<span class="hljs-keyword">if</span> (<span class="hljs-title class_">Number</span>.<span class="hljs-built_in">isNaN</span>(value)) { ... }
<span class="hljs-comment">// 或（不推荐，因会尝试转换类型）</span>
<span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(value)) { ... }
</code></pre>
<blockquote>
<p>📌 <code>Number.isNaN()</code> 是 ES6 新增，只对真正的 <code>NaN</code> 返回 <code>true</code>。</p>
</blockquote>
<h3 data-id="heading-17">4.3 <code>Infinity</code> 的产生</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-number">1</span> / <span class="hljs-number">0</span>        <span class="hljs-comment">// Infinity</span>
<span class="hljs-number">-1</span> / <span class="hljs-number">0</span>       <span class="hljs-comment">// -Infinity</span>
<span class="hljs-keyword">typeof</span> Infinity <span class="hljs-comment">// "number"</span>
</code></pre>
<hr/>
<h2 data-id="heading-18">五、JavaScript 包装类机制：为什么 <code>"hello".length</code> 能工作？</h2>
<h3 data-id="heading-19">5.1 自动装箱（Auto-boxing）</h3>
<p>虽然字符串是原始类型（primitive），但当你调用其方法时，JS 引擎会<strong>临时创建一个包装对象</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-string">"hello"</span>.<span class="hljs-property">length</span>
<span class="hljs-comment">// 等价于：</span>
(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">"hello"</span>)).<span class="hljs-property">length</span>
<span class="hljs-comment">// 使用后立即销毁</span>
</code></pre>
<h3 data-id="heading-20">5.2 三步过程</h3>
<ol>
<li>创建包装对象（如 <code>new String(str)</code>）</li>
<li>调用方法或访问属性</li>
<li>销毁对象，保持原始值不可变</li>
</ol>
<blockquote>
<p>这就是为什么基本类型也能拥有方法——这是 JavaScript 面向对象设计的体现。</p>
</blockquote>
<hr/>
<h2 data-id="heading-21">六、字符串操作与 UTF-16 编码陷阱</h2>
<h3 data-id="heading-22">6.1 <code>length</code> 属性的局限性</h3>
<p>JS 使用 <strong>UTF-16 编码</strong>，<code>length</code> 返回的是<strong>编码单元数量</strong>，而非字符数：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-string">"café"</span>.length        <span class="hljs-comment">// 4（é 占 1 个单元）</span>
<span class="hljs-string">"👩‍💻"</span>.length         <span class="hljs-comment">// 5（emoji 由多个代理对组成）</span>
</code></pre>
<h3 data-id="heading-23">6.2 安全遍历字符串的方法</h3>
<p>使用 <code>Array.from()</code> 或 <code>for...of</code> 获取真实字符：</p>
<pre><code class="hljs language-csharp" lang="csharp">Array.<span class="hljs-keyword">from</span>(<span class="hljs-string">"👩‍💻"</span>).length <span class="hljs-comment">// 1</span>
[...<span class="hljs-string">"👩‍💻"</span>].length        <span class="hljs-comment">// 1</span>
</code></pre>
<h3 data-id="heading-24">6.3 <code>slice()</code> vs <code>substring()</code></h3>




















<table><thead><tr><th>方法</th><th>支持负数索引？</th><th>参数顺序错误处理</th></tr></thead><tbody><tr><td><code>slice(a,b)</code></td><td> 是</td><td>返回空字符串</td></tr><tr><td><code>substring(a,b)</code></td><td> 否（转为0）</td><td>自动交换 a 和 b</td></tr></tbody></table>
<pre><code class="hljs language-vbscript" lang="vbscript"><span class="hljs-string">"hello"</span>.slice(<span class="hljs-number">-3</span>, <span class="hljs-number">-1</span>)     // <span class="hljs-string">"ll"</span>
<span class="hljs-string">"hello"</span>.<span class="hljs-keyword">sub</span><span class="hljs-built_in">string</span>(<span class="hljs-number">-3</span>, <span class="hljs-number">-1</span>) // <span class="hljs-string">""</span>（等价于 <span class="hljs-keyword">sub</span><span class="hljs-built_in">string</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)）
</code></pre>
<blockquote>
<p>✅ 推荐使用 <code>slice</code>，功能更强大且行为更可预测。</p>
</blockquote>
<hr/>
<h2 data-id="heading-25">七、面试考察重点与学习建议</h2>
<h3 data-id="heading-26">7.1 面试官想考察什么？</h3>
<ul>
<li>是否理解 <strong>高阶函数的参数传递机制</strong></li>
<li>是否掌握 <strong>API 的底层行为</strong>（而非仅会用）</li>
<li>是否具备 <strong>调试复杂逻辑的能力</strong></li>
<li>是否了解 <strong>JavaScript 类型系统与包装类</strong></li>
</ul>
<h3 data-id="heading-27">7.2 学习建议</h3>
<ol>
<li><strong>精读 MDN 文档</strong>：官方文档是最权威的参考</li>
<li><strong>动手实验</strong>：用 <code>console.log</code> 打印每一步结果</li>
<li><strong>总结成文</strong>：写博客或笔记加深记忆</li>
<li><strong>刻意练习</strong>：反复思考类似 <code>[].map(parseInt)</code> 的陷阱</li>
</ol>
<hr/>
<h2 data-id="heading-28">八、结语</h2>
<p><code>Array.prototype.map()</code> 看似简单，却蕴含了 JavaScript 类型系统、函数调用机制、数值解析规则等多重知识。掌握它，不仅是为了写出正确的代码，更是为了理解这门语言的设计哲学。</p>
<p>下次当你看到 <code>[1, 2, 3].map(parseInt)</code> 时，希望你能自信地说出：“我知道它为什么返回 <code>[1, NaN, NaN]</code>，并且知道三种修复方法。”</p>
<blockquote>
<p>🌟 <strong>记住</strong>：真正的高手，不是不会犯错，而是知道错误为何发生，并能优雅地避免它。</p>
</blockquote>
<hr/>
<p><strong>参考资料</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FJavaScript%2FReference%2FGlobal_Objects%2FArray%2Fmap" title="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Array/map" target="_blank" ref="nofollow noopener noreferrer">MDN: Array.prototype.map()</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftc39.es%2Fecma262%2F" title="https://tc39.es/ecma262/" target="_blank" ref="nofollow noopener noreferrer">ECMAScript 规范</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[el，js，jstl什么时候进行混用]]></title>    <link>https://juejin.cn/post/7571731181198835748</link>    <guid>https://juejin.cn/post/7571731181198835748</guid>    <pubDate>2025-11-13T06:54:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571731181198835748" data-draft-id="7571742703534620708" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="el，js，jstl什么时候进行混用"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-13T06:54:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="joker学java"/> <meta itemprop="url" content="https://juejin.cn/user/3006480498043673"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            el，js，jstl什么时候进行混用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3006480498043673/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    joker学java
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T06:54:10.000Z" title="Thu Nov 13 2025 06:54:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 <strong>JSP（JavaServer Pages）</strong> 开发中，<strong>EL表达式（Expression Language）</strong> 、<strong>JSTL（JSP Standard Tag Library）</strong> 和 <strong>JavaScript（JS）</strong> 可以<strong>有限度地穿插使用</strong>，但需要遵循各自的运行环境和作用域规则。以下是具体场景和注意事项：</p>
<h2 data-id="heading-0"><strong>1. EL表达式 与 JSTL 的穿插使用</strong></h2>
<h3 data-id="heading-1"><strong>✅ 完全兼容，无缝衔接</strong></h3>
<p>EL表达式通常嵌套在JSTL标签中，用于动态计算值或判断条件：</p>
<pre><code class="hljs language-xml" lang="xml">Jsp
<span class="hljs-comment">&lt;!-- 示例1：EL在JSTL中控制循环 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">c:forEach</span> <span class="hljs-attr">items</span>=<span class="hljs-string">"${requestScope.userList}"</span> <span class="hljs-attr">var</span>=<span class="hljs-string">"user"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>${user.name} (角色: ${user.role})<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">c:forEach</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 示例2：EL在JSTL中做条件判断 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">c:if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"${not empty sessionScope.currentUser}"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">fmt:message</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"welcome.message"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">c:if</span>&gt;</span>
</code></pre>
<p><strong>注意</strong>：</p>
<ul>
<li>EL <code>${}</code> 可以直接读取JSTL标签中定义的变量（如 <code>var="user"</code>）。</li>
<li>JSTL标签属性（如 <code>&lt;c:if test="..."&gt;</code>）必须使用EL表达式。</li>
</ul>
<h2 data-id="heading-2"><strong>2. EL表达式 与 JavaScript 的穿插使用</strong></h2>
<h3 data-id="heading-3"><strong>✅ 单向传递（EL → JS）</strong></h3>
<p>EL表达式在服务器端渲染后生成静态内容，可嵌入到JS代码中：</p>
<pre><code class="hljs language-xml" lang="xml">Jsp
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-comment">// 将EL变量传递给JS（字符串需转义！）</span>
  <span class="hljs-keyword">const</span> username = <span class="hljs-string">"${fn:escapeXml(sessionScope.user.name)}"</span>;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"当前用户:"</span>, username); <span class="hljs-comment">// 服务器渲染后变为：const username = "John";</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><strong>注意</strong>：</p>
<ul>
<li><strong>必须转义</strong>：使用 <code>fn:escapeXml</code> 或 <code>JSON.stringify</code> 防止XSS攻击。</li>
<li><strong>仅限简单数据</strong>：复杂对象需转为JSON字符串：</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">Jsp
  &lt;%@ taglib <span class="hljs-attr">prefix</span>=<span class="hljs-string">"fn"</span> uri=<span class="hljs-string">"http://java.sun.com/jsp/jstl/functions"</span> %&gt;
  &lt;script&gt;
    const <span class="hljs-attr">userData</span> = <span class="hljs-variable">${not empty user ? fn:escapeXml(user.toJson()) : 'null'}</span><span class="hljs-comment">;</span>
  &lt;/script&gt;
</code></pre>
<h3 data-id="heading-4"><strong>❌ JS变量不能反向传递到EL</strong></h3>
<pre><code class="hljs language-xml" lang="xml">Jsp
<span class="hljs-comment">&lt;!-- 错误示例：JS变量无法在服务器端EL中使用 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">let</span> jsVar = <span class="hljs-string">"hello"</span>;
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>${jsVar}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span> <span class="hljs-comment">&lt;!-- 输出为空，EL无法读取JS变量 --&gt;</span>
</code></pre>
<p><strong>原因</strong>：EL在服务器端解析，JS在客户端运行，两者生命周期隔离。</p>
<h2 data-id="heading-5"><strong>3. JSTL 与 JavaScript 的穿插使用</strong></h2>
<h3 data-id="heading-6"><strong>✅ 动态生成JS代码（需谨慎）</strong></h3>
<p>JSTL可在服务器端生成JS代码块：</p>
<pre><code class="hljs language-xml" lang="xml">Jsp
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-comment">// JSTL控制JS代码生成</span>
  &lt;<span class="hljs-attr">c</span>:<span class="hljs-keyword">if</span> test=<span class="hljs-string">"${isAdmin}"</span>&gt;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"管理员模式已启用"</span>);
  &lt;/<span class="hljs-attr">c</span>:<span class="hljs-keyword">if</span>&gt;
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><strong>注意</strong>：</p>
<ul>
<li>生成的JS代码是静态的（服务器渲染后固定），无法响应前端事件。</li>
<li>避免在循环中生成大量JS代码（性能问题）。</li>
</ul>
<h3 data-id="heading-7"><strong>❌ JS不能直接调用JSTL标签</strong></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">JavaScript</span>
<span class="hljs-comment">// 错误示例：JS中无法调用JSTL</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">reloadData</span>(<span class="hljs-params"/>) {
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">c:import</span> <span class="hljs-attr">url</span>=<span class="hljs-string">"/api/data"</span> /&gt;</span></span> <span class="hljs-comment">// 无效！</span>
}
</code></pre>
<p><strong>替代方案</strong>：用AJAX请求替代JSTL的动态内容加载。</p>
<h2 data-id="heading-8"><strong>4. 三者的混合使用场景</strong></h2>
<h3 data-id="heading-9"><strong>场景：动态表格渲染（后端数据 + 前端交互）</strong></h3>
<pre><code class="hljs language-xml" lang="xml">Jsp
<span class="hljs-comment">&lt;!-- 1. JSTL循环渲染初始数据 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"userTable"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">c:forEach</span> <span class="hljs-attr">items</span>=<span class="hljs-string">"${userList}"</span> <span class="hljs-attr">var</span>=<span class="hljs-string">"user"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">tr</span> <span class="hljs-attr">data-userid</span>=<span class="hljs-string">"${user.id}"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>${user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>${user.email}<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"deleteUser(${user.id})"</span>&gt;</span>删除<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">c:forEach</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 2. JS处理前端交互 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">deleteUser</span>(<span class="hljs-params">userId</span>) {
    <span class="hljs-comment">// AJAX请求删除数据</span>
    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/deleteUser?id=<span class="hljs-subst">${userId}</span>`</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 动态删除DOM节点（不依赖JSTL）</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">`tr[data-userid="<span class="hljs-subst">${userId}</span>"]`</span>).<span class="hljs-title function_">remove</span>();
      });
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><strong>分工说明</strong>：</p>
<ul>
<li><strong>JSTL+EL</strong>：初始化页面数据。</li>
<li><strong>JS</strong>：处理后续动态交互。</li>
</ul>
<h2 data-id="heading-10"><strong>5. 关键注意事项</strong></h2>
<ol>
<li>
<p><strong>作用域隔离</strong>：</p>
<ul>
<li>EL/JSTL在服务器端运行，JS在客户端运行，变量无法直接共享。</li>
<li>需要数据传递时，通过 <strong>隐藏域</strong>、<strong>JSON序列化</strong> 或 <strong>AJAX</strong> 实现。</li>
</ul>
</li>
<li>
<p><strong>安全性</strong>：</p>
<ul>
<li>永远对EL输出到JS的数据进行转义（<code>fn:escapeXml</code> 或 <code>JSON.stringify</code>）。</li>
<li>避免拼接未经验证的EL到JS代码中（XSS漏洞高危！）。</li>
</ul>
</li>
<li>
<p><strong>性能优化</strong>：</p>
<ul>
<li>避免在JSTL循环中生成重复的JS代码。</li>
<li>复杂逻辑尽量用AJAX替代JSTL动态渲染。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-11"><strong>总结</strong></h2>









































<table><thead><tr><th><strong>组合方式</strong></th><th><strong>是否可行</strong></th><th><strong>示例场景</strong></th><th><strong>注意事项</strong></th></tr></thead><tbody><tr><td><strong>EL + JSTL</strong></td><td>✅ 完全支持</td><td>循环、条件渲染</td><td>无</td></tr><tr><td><strong>EL → JS</strong></td><td>✅ 单向传递</td><td>将后端数据嵌入JS</td><td>必须转义数据防XSS</td></tr><tr><td><strong>JS → EL</strong></td><td>❌ 不可行</td><td>-</td><td>需改用AJAX提交数据</td></tr><tr><td><strong>JSTL → JS</strong></td><td>✅ 生成静态代码</td><td>根据条件生成JS代码块</td><td>避免生成冗余代码</td></tr><tr><td><strong>JS → JSTL</strong></td><td>❌ 不可行</td><td>-</td><td>需改用AJAX + 服务器重新渲染</td></tr></tbody></table>
<p><strong>核心原则</strong>：</p>
<ul>
<li><strong>EL/JSTL</strong> 负责<strong>初始页面渲染</strong>。</li>
<li><strong>JS</strong> 负责<strong>后续动态交互</strong>。</li>
<li><strong>数据传递</strong>通过安全转义或API调用实现。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android15 Framework(1): 用户空间启动的第一个进程 Init]]></title>    <link>https://juejin.cn/post/7571753301898444840</link>    <guid>https://juejin.cn/post/7571753301898444840</guid>    <pubDate>2025-11-13T06:53:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571753301898444840" data-draft-id="7569501785380159540" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android15 Framework(1): 用户空间启动的第一个进程 Init"/> <meta itemprop="keywords" content="Android,源码阅读"/> <meta itemprop="datePublished" content="2025-11-13T06:53:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="光光跬步"/> <meta itemprop="url" content="https://juejin.cn/user/1286855157887751"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android15 Framework(1): 用户空间启动的第一个进程 Init
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1286855157887751/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    光光跬步
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T06:53:13.000Z" title="Thu Nov 13 2025 06:53:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">前言</h2>
<p>在提升Android能力的多种方式中，阅读Android源码是一种相当重要的方式，并且只有在熟悉了源码之后，我们才能处理一些需求。</p>
<p>在Android源码中，我认为首先需要阅读的就是Android系统启动流程。实际上已经有很多的文章、书籍和视频都讲过这个了，但我还是想写写Android系统启动流程的文章：一方面是对过往知识做一个总结，加深自己的理解；另一方面是分享出来，如果可以帮助到一些人也是很好的。</p>
<blockquote>
<p>注意：本文出现的源码基于Android - 15.0.0_r1。另外本文关注主要逻辑，省略部分代码。</p>
</blockquote>
<h2 data-id="heading-1">一、 Android系统启动大致流程</h2>
<p>本文是介绍init进程，那么我们先看下Android系统启动流程：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf1b9fa35016420d8afb5ee52c61f27e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763622857&amp;x-signature=tRhqpYQLFBkyZ6c9Ult8WITavgw%3D" alt="image.png" loading="lazy"/>
启动电源及系统启动 -&gt; Bootloader -&gt; Linux内核启动 -&gt; init -&gt; Zygote -&gt; SystemServer -&gt;  Launcher</p>
<h2 data-id="heading-2">二、Init进程</h2>
<p><strong>init</strong> 进程是用户空间启动的第1个进程，它会依次执行 FirstStageMain -&gt; SetupSelinux -&gt; SecondStageMain 三个阶段。 我们知道，C++中的main方法，是函数的入口，Android中也不例外，它的入口函数是：<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Fcore%2Finit%2Fmain.cpp%2353" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/system/core/init/main.cpp#53" ref="nofollow noopener noreferrer">/system/core/init/main.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)</span> </span>{
	...
    <span class="hljs-keyword">if</span> (argc &gt; <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"selinux_setup"</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">SetupSelinux</span>(argv);
        }

        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"second_stage"</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">SecondStageMain</span>(argc, argv);
        }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-built_in">FirstStageMain</span>(argc, argv);
}
</code></pre>
<p>在main函数刚进来时，会进到FirstStageMain中去。看看FirstStageMain做了什么。</p>
<h3 data-id="heading-3">2.1 FirstStageMain</h3>
<p>FirstStageMain的代码的位置：<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Fcore%2Finit%2Ffirst_stage_init.cpp%23316" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/system/core/init/first_stage_init.cpp#316" ref="nofollow noopener noreferrer">/system/core/init/first_stage_init.cpp</a><br/>
源码较长，只看比较重要的部分</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">FirstStageMain</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)</span> </span>{
    ...
    <span class="hljs-built_in">CHECKCALL</span>(<span class="hljs-built_in">mount</span>(<span class="hljs-string">"tmpfs"</span>, <span class="hljs-string">"/dev"</span>, <span class="hljs-string">"tmpfs"</span>, MS_NOSUID, <span class="hljs-string">"mode=0755"</span>));
    ...
    <span class="hljs-built_in">CHECKCALL</span>(<span class="hljs-built_in">mount</span>(<span class="hljs-string">"devpts"</span>, <span class="hljs-string">"/dev/pts"</span>, <span class="hljs-string">"devpts"</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>));
<span class="hljs-meta">#<span class="hljs-keyword">define</span> MAKE_STR(x) __STRING(x)</span>
    <span class="hljs-built_in">CHECKCALL</span>(<span class="hljs-built_in">mount</span>(<span class="hljs-string">"proc"</span>, <span class="hljs-string">"/proc"</span>, <span class="hljs-string">"proc"</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"hidepid=2,gid="</span> <span class="hljs-built_in">MAKE_STR</span>(AID_READPROC)));
<span class="hljs-meta">#<span class="hljs-keyword">undef</span> MAKE_STR</span>
    ...
    <span class="hljs-built_in">CHECKCALL</span>(<span class="hljs-built_in">mount</span>(<span class="hljs-string">"sysfs"</span>, <span class="hljs-string">"/sys"</span>, <span class="hljs-string">"sysfs"</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>));
    <span class="hljs-built_in">CHECKCALL</span>(<span class="hljs-built_in">mount</span>(<span class="hljs-string">"selinuxfs"</span>, <span class="hljs-string">"/sys/fs/selinux"</span>, <span class="hljs-string">"selinuxfs"</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>));
    
    ...
    <span class="hljs-built_in">InitKernelLogging</span>(argv);
    ...

    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* path = <span class="hljs-string">"/system/bin/init"</span>;
    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* args[] = {path, <span class="hljs-string">"selinux_setup"</span>, <span class="hljs-literal">nullptr</span>};
    ...
    <span class="hljs-built_in">execv</span>(path, <span class="hljs-built_in">const_cast</span>&lt;<span class="hljs-type">char</span>**&gt;(args));
	...
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
}

</code></pre>
<p>FirstStageMain函数主要做了挂载文件系统，创建目录，初始化Kernel log。介绍下5个重要的文件系统：</p>
<ul>
<li>tmpfs：用于存放设备节点和动态生成的设备文件，支持运行时设备管理。</li>
<li>devpts）：提供伪终端（PTY）接口，让用户空间终端／shell 能与内核终端子系统交互。</li>
<li>procfs：暴露进程和内核状态、配置信息给用户空间，可用于系统监控与参数调整。</li>
<li>sysfs：用于暴露内核设备模型、驱动和子系统的信息与控制接口，支撑硬件管理。</li>
<li>selinuxfs：提供 SELinux 安全策略与状态的接口，用于系统的强制访问控制机制。</li>
</ul>
<p>InitKernelLogging(argv)代码如下：<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Fcore%2Finit%2Ffirst_stage_init.cpp%23400" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/system/core/init/first_stage_init.cpp#400" ref="nofollow noopener noreferrer">/system/core/init/first_stage_init.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">InitKernelLogging</span><span class="hljs-params">(<span class="hljs-type">char</span>** argv)</span> </span>{
    <span class="hljs-built_in">SetFatalRebootTarget</span>();
    android::base::<span class="hljs-built_in">InitLogging</span>(argv, &amp;android::base::KernelLogger, InitAborter);
}
</code></pre>
<p>这里着重看看android::base::InitLogging(argv, &amp;android::base::KernelLogger, InitAborter)， 先看KernelLogger做了什么<br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Flibbase%2Flogging.cpp%23278" target="_blank" title="http://xrefandroid.com/android-15.0.0_r1/xref/system/libbase/logging.cpp#278" ref="nofollow noopener noreferrer">/system/libbase/logging.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">KernelLogger</span><span class="hljs-params">(android::base::LogId, android::base::LogSeverity severity, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* tag,
                  <span class="hljs-type">const</span> <span class="hljs-type">char</span>*, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* full_message)</span> </span>{
  <span class="hljs-built_in">SplitByLines</span>(full_message, KernelLogLine, severity, tag);
}
</code></pre>
<p>继续跟KernelLogLine<br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Flibbase%2Flogging.cpp%23238" target="_blank" title="http://xrefandroid.com/android-15.0.0_r1/xref/system/libbase/logging.cpp#238" ref="nofollow noopener noreferrer">/system/libbase/logging.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(__linux__)</span>
<span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">KernelLogLine</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* msg, <span class="hljs-type">int</span> length, android::base::LogSeverity severity,
   ...
  <span class="hljs-type">static</span> <span class="hljs-type">int</span> klog_fd = OpenKmsg();
  <span class="hljs-keyword">if</span> (klog_fd == <span class="hljs-number">-1</span>) <span class="hljs-keyword">return</span>;
  ...
}
</span></span></code></pre>
<p>实际上，KernelLogLine就是调用了OpenKmsg<br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Flibbase%2Flogging.cpp%23101" target="_blank" title="http://xrefandroid.com/android-15.0.0_r1/xref/system/libbase/logging.cpp#101" ref="nofollow noopener noreferrer">/system/libbase/logging.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(__linux__)</span>
<span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">OpenKmsg</span><span class="hljs-params">()</span> </span>{
<span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(__ANDROID__)</span>
    <span class="hljs-comment">// 尝试从环境变量获取预打开的文件描述符</span>
    <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> val = <span class="hljs-built_in">getenv</span>(<span class="hljs-string">"ANDROID_FILE__dev_kmsg"</span>);
    <span class="hljs-keyword">if</span> (val != <span class="hljs-literal">nullptr</span>) {
        <span class="hljs-type">int</span> fd;
        <span class="hljs-comment">// 解析环境变量值为文件描述符</span>
        <span class="hljs-keyword">if</span> (android::base::<span class="hljs-built_in">ParseInt</span>(val, &amp;fd, <span class="hljs-number">0</span>)) {
            <span class="hljs-comment">// 验证文件描述符有效性</span>
            <span class="hljs-keyword">auto</span> flags = <span class="hljs-built_in">fcntl</span>(fd, F_GETFL);
            <span class="hljs-keyword">if</span> ((flags != <span class="hljs-number">-1</span>) &amp;&amp; ((flags &amp; O_ACCMODE) == O_WRONLY)) 
                <span class="hljs-keyword">return</span> fd; <span class="hljs-comment">// 返回可用的 fd</span>
        }
    }
    <span class="hljs-comment">// init进程启动时，此时没有任何预先存在的文件描述符可继承，因此会打开/dev/kmsg</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">TEMP_FAILURE_RETRY</span>(<span class="hljs-built_in">open</span>(<span class="hljs-string">"/dev/kmsg"</span>, O_WRONLY | O_CLOEXEC));
}
</code></pre>
<p>再看看InitLogging代码<br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Flibbase%2Flogging.cpp%23346" target="_blank" title="http://xrefandroid.com/android-15.0.0_r1/xref/system/libbase/logging.cpp#346" ref="nofollow noopener noreferrer">/system/libbase/logging.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">InitLogging</span><span class="hljs-params">(<span class="hljs-type">char</span>* argv[], LogFunction&amp;&amp; logger, AbortFunction&amp;&amp; aborter)</span> </span>{
  <span class="hljs-built_in">SetLogger</span>(std::forward&lt;LogFunction&gt;(logger));
  <span class="hljs-built_in">SetAborter</span>(std::forward&lt;AbortFunction&gt;(aborter));

  <span class="hljs-keyword">if</span> (gInitialized) { <span class="hljs-comment">// gInitialized是一个静态变量，防止重复调用</span>
    <span class="hljs-keyword">return</span>;
  }

  gInitialized = <span class="hljs-literal">true</span>;

  <span class="hljs-keyword">if</span> (argv != <span class="hljs-literal">nullptr</span>) {
    <span class="hljs-comment">// 设置默认日志标签</span>
    <span class="hljs-built_in">SetDefaultTag</span>(<span class="hljs-built_in">basename</span>(argv[<span class="hljs-number">0</span>]));
  }

  <span class="hljs-comment">// 获取环境变量配置</span>
  <span class="hljs-type">const</span> <span class="hljs-type">char</span>* tags = <span class="hljs-built_in">getenv</span>(<span class="hljs-string">"ANDROID_LOG_TAGS"</span>);
  <span class="hljs-keyword">if</span> (tags == <span class="hljs-literal">nullptr</span>) {
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// 根据环境变量，设置日志级别</span>
  std::vector&lt;std::string&gt; specs = <span class="hljs-built_in">Split</span>(tags, <span class="hljs-string">" "</span>);
  <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; specs.<span class="hljs-built_in">size</span>(); ++i) {
    <span class="hljs-function">std::string <span class="hljs-title">spec</span><span class="hljs-params">(specs[i])</span></span>;
    <span class="hljs-keyword">if</span> (spec.<span class="hljs-built_in">size</span>() == <span class="hljs-number">3</span> &amp;&amp; <span class="hljs-built_in">StartsWith</span>(spec, <span class="hljs-string">"*:"</span>)) {
      <span class="hljs-keyword">switch</span> (spec[<span class="hljs-number">2</span>]) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'v'</span>:
          <span class="hljs-built_in">SetMinimumLogSeverity</span>(VERBOSE);
          <span class="hljs-keyword">continue</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'d'</span>:
          <span class="hljs-built_in">SetMinimumLogSeverity</span>(DEBUG);
          <span class="hljs-keyword">continue</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'i'</span>:
          <span class="hljs-built_in">SetMinimumLogSeverity</span>(INFO);
          <span class="hljs-keyword">continue</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'w'</span>:
          <span class="hljs-built_in">SetMinimumLogSeverity</span>(WARNING);
          <span class="hljs-keyword">continue</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'e'</span>:
          <span class="hljs-built_in">SetMinimumLogSeverity</span>(ERROR);
          <span class="hljs-keyword">continue</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'f'</span>:
          <span class="hljs-built_in">SetMinimumLogSeverity</span>(FATAL_WITHOUT_ABORT);
          <span class="hljs-keyword">continue</span>;
        <span class="hljs-comment">// liblog will even suppress FATAL if you say 's' for silent, but fatal should</span>
        <span class="hljs-comment">// never be suppressed.</span>
        <span class="hljs-keyword">case</span> <span class="hljs-string">'s'</span>:
          <span class="hljs-built_in">SetMinimumLogSeverity</span>(FATAL_WITHOUT_ABORT);
          <span class="hljs-keyword">continue</span>;
      }
    }
    <span class="hljs-built_in">LOG</span>(FATAL) &lt;&lt; <span class="hljs-string">"unsupported '"</span> &lt;&lt; spec &lt;&lt; <span class="hljs-string">"' in ANDROID_LOG_TAGS ("</span> &lt;&lt; tags
               &lt;&lt; <span class="hljs-string">")"</span>;
  }
}
</code></pre>
<p>小结一下FirstStageMain</p>
<ul>
<li>创建目录和挂载文件系统</li>
<li>初始化Kernel日志 (打开/dev/kmsg，并根据环境变量ANDROID_LOG_TAGS，设置日志级别)</li>
</ul>
<p>完成这些后，会通过execv回到Main.cpp,此时会执行SetupSelinux 阶段</p>
<h3 data-id="heading-4">2.2 SetupSelinux</h3>
<p>它负责加载并启用 SELinux 安全策略<br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Fcore%2Finit%2Fselinux.cpp%23685" target="_blank" title="http://xrefandroid.com/android-15.0.0_r1/xref/system/core/init/selinux.cpp#685" ref="nofollow noopener noreferrer">/system/core/init/selinux.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">SetupSelinux</span><span class="hljs-params">(<span class="hljs-type">char</span>** argv)</span> </span>{
    <span class="hljs-comment">// 设置 stdio 到 /dev/null</span>
    <span class="hljs-built_in">SetStdioToDevNull</span>(argv);
    
    <span class="hljs-comment">// 初始化 kernel 日志</span>
    <span class="hljs-built_in">InitKernelLogging</span>(argv);

    <span class="hljs-keyword">if</span> (REBOOT_BOOTLOADER_ON_PANIC) {
        <span class="hljs-built_in">InstallRebootSignalHandlers</span>();
    }

    boot_clock::time_point start_time = boot_clock::<span class="hljs-built_in">now</span>();

    <span class="hljs-built_in">SelinuxSetupKernelLogging</span>();

    <span class="hljs-comment">// 加载SELinux策略</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">IsMicrodroid</span>()) {
        <span class="hljs-built_in">LoadSelinuxPolicyMicrodroid</span>();
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">LoadSelinuxPolicyAndroid</span>();
    }

    <span class="hljs-comment">// 切换到 Selinux enforcement 模式</span>
    <span class="hljs-built_in">SelinuxSetEnforcement</span>();

    ...

    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* path = <span class="hljs-string">"/system/bin/init"</span>;
    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* args[] = {path, <span class="hljs-string">"second_stage"</span>, <span class="hljs-literal">nullptr</span>};
    <span class="hljs-comment">// 重新启动 init 本身，进入SecondStageMain</span>
    <span class="hljs-built_in">execv</span>(path, <span class="hljs-built_in">const_cast</span>&lt;<span class="hljs-type">char</span>**&gt;(args));

    ...
}
</code></pre>
<p>这一阶段提供了整个用户空间服务启动的安全基础：在 SELinux 策略生效之后，后续解析 .rc、启动服务、fork 应用进程，才能在预期的安全域下执行。</p>
<h3 data-id="heading-5">2.3 SecondStageMain</h3>
<p>之后便进入了我们着重关注的第二阶段初始化。<br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Fcore%2Finit%2Finit.cpp%23930" target="_blank" title="http://xrefandroid.com/android-15.0.0_r1/xref/system/core/init/init.cpp#930" ref="nofollow noopener noreferrer">/system/core/init/init.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">SecondStageMain</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)</span> </span>{
    ...
    <span class="hljs-built_in">InitKernelLogging</span>(argv);
   ...
    <span class="hljs-comment">// 初始化属性服务</span>
    <span class="hljs-built_in">PropertyInit</span>();

    <span class="hljs-comment">// 创建Epoll对象</span>
    Epoll epoll;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> result = epoll.<span class="hljs-built_in">Open</span>(); !result.<span class="hljs-built_in">ok</span>()) {
        <span class="hljs-built_in">PLOG</span>(FATAL) &lt;&lt; result.<span class="hljs-built_in">error</span>();
    }
    epoll.<span class="hljs-built_in">SetFirstCallback</span>(ReapAnyOutstandingChildren);

    <span class="hljs-comment">// 注册epoll</span>
    <span class="hljs-built_in">InstallSignalFdHandler</span>(&amp;epoll);
    <span class="hljs-built_in">InstallInitNotifier</span>(&amp;epoll);

    <span class="hljs-comment">// 开启属性服务</span>
    <span class="hljs-built_in">StartPropertyService</span>(&amp;property_fd);

    <span class="hljs-comment">// 加载init.rc文件</span>
    <span class="hljs-built_in">LoadBootScripts</span>(am, sm);
    ...
}
</code></pre>
<h4 data-id="heading-6">2.3.1 初始化属性服务</h4>
<p>我们看看PropertyInit具体是怎么初始化属性服务的，先看下PropertyInit代码
<a href="https://link.juejin.cn?target=http%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Fcore%2Finit%2Fproperty_service.cpp%231403" target="_blank" title="http://xrefandroid.com/android-15.0.0_r1/xref/system/core/init/property_service.cpp#1403" ref="nofollow noopener noreferrer">/system/core/init/property_service.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">PropertyInit</span><span class="hljs-params">()</span> </span>{
    ...

    <span class="hljs-built_in">mkdir</span>(<span class="hljs-string">"/dev/__properties__"</span>, S_IRWXU | S_IXGRP | S_IXOTH);
    <span class="hljs-built_in">CreateSerializedPropertyInfo</span>();
    <span class="hljs-comment">// 初始化属性内存区域</span>
    <span class="hljs-keyword">if</span> (__system_property_area_init()) {
        <span class="hljs-built_in">LOG</span>(FATAL) &lt;&lt; <span class="hljs-string">"Failed to initialize property area"</span>;
    }
    ...
}
</code></pre>
<p>__system_property_area_init是定义在system_property_api.cpp中的一个方法<br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fbionic%2Flibc%2Fbionic%2Fsystem_property_api.cpp%2358" target="_blank" title="http://xrefandroid.com/android-15.0.0_r1/xref/bionic/libc/bionic/system_property_api.cpp#58" ref="nofollow noopener noreferrer">/bionic/libc/bionic/system_property_api.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-type">int</span> __system_property_area_init() {
    <span class="hljs-type">bool</span> fsetxattr_fail = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> system_properties.<span class="hljs-built_in">AreaInit</span>(PROP_DIRNAME, &amp;fsetxattr_fail) &amp;&amp; !fsetxattr_fail ? <span class="hljs-number">0</span> : <span class="hljs-number">-1</span>;
}
</code></pre>
<p>只是调用了system_properties.AreaInit，继续跟这个方法，看看做了什么
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fbionic%2Flibc%2Fsystem_properties%2Fsystem_properties.cpp%23107" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/bionic/libc/system_properties/system_properties.cpp#107" ref="nofollow noopener noreferrer">/bionic/libc/system_properties/system_properties.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">SystemProperties::AreaInit</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* filename, <span class="hljs-type">bool</span>* fsetxattr_failed)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">AreaInit</span>(filename, fsetxattr_failed, <span class="hljs-literal">false</span>);
}

<span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">SystemProperties::AreaInit</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* filename, <span class="hljs-type">bool</span>* fsetxattr_failed,
                             <span class="hljs-type">bool</span> load_default_path)</span> </span>{
   ...
   <span class="hljs-keyword">if</span> (!serial_contexts-&gt;<span class="hljs-built_in">Initialize</span>(<span class="hljs-literal">true</span>, properties_filename_.<span class="hljs-built_in">c_str</span>(), fsetxattr_failed,
			load_default_path)) {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
   }
  
   ...
   <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p>继续跟serial_contexts-&gt;Initialize<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fbionic%2Flibc%2Fsystem_properties%2Fcontexts_serialized.cpp%2345" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/bionic/libc/system_properties/contexts_serialized.cpp#45" ref="nofollow noopener noreferrer">/bionic/libc/system_properties/contexts_serialized.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">ContextsSerialized::Initialize</span><span class="hljs-params">(<span class="hljs-type">bool</span> writable, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* dirname, <span class="hljs-type">bool</span>* fsetxattr_failed,
                                    <span class="hljs-type">bool</span> load_default_path)</span> </span>{
  dirname_ = dirname;
  tree_filename_ = <span class="hljs-built_in">PropertiesFilename</span>(dirname, <span class="hljs-string">"property_info"</span>);
  serial_filename_ = <span class="hljs-built_in">PropertiesFilename</span>(dirname, <span class="hljs-string">"properties_serial"</span>);

  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">InitializeProperties</span>(load_default_path)) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-keyword">if</span> (writable) {
    ...
    <span class="hljs-keyword">if</span> (open_failed || !<span class="hljs-built_in">MapSerialPropertyArea</span>(<span class="hljs-literal">true</span>, fsetxattr_failed)) {
      <span class="hljs-built_in">FreeAndUnmap</span>();
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">MapSerialPropertyArea</span>(<span class="hljs-literal">false</span>, <span class="hljs-literal">nullptr</span>)) {
      <span class="hljs-built_in">FreeAndUnmap</span>();
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p>后续执行MapSerialPropertyArea方法<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fbionic%2Flibc%2Fsystem_properties%2Fcontexts_serialized.cpp%2369" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/bionic/libc/system_properties/contexts_serialized.cpp#69" ref="nofollow noopener noreferrer">/bionic/libc/system_properties/contexts_serialized.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">ContextsSerialized::MapSerialPropertyArea</span><span class="hljs-params">(<span class="hljs-type">bool</span> access_rw, <span class="hljs-type">bool</span>* fsetxattr_failed)</span> </span>{
  <span class="hljs-keyword">if</span> (access_rw) {
    serial_prop_area_ = prop_area::<span class="hljs-built_in">map_prop_area_rw</span>(
        serial_filename_.<span class="hljs-built_in">c_str</span>(), <span class="hljs-string">"u:object_r:properties_serial:s0"</span>, fsetxattr_failed);
  } <span class="hljs-keyword">else</span> {
    serial_prop_area_ = prop_area::<span class="hljs-built_in">map_prop_area</span>(serial_filename_.<span class="hljs-built_in">c_str</span>());
  }
  <span class="hljs-keyword">return</span> serial_prop_area_;
}
</code></pre>
<p>若是可写，执行map_prop_area_rw<br/>
不可写，执行map_prop_area<br/>
先看看执行map_prop_area_rw代码<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fbionic%2Flibc%2Fsystem_properties%2Fprop_area.cpp%2355" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/bionic/libc/system_properties/prop_area.cpp#55" ref="nofollow noopener noreferrer">/bionic/libc/system_properties/prop_area.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function">prop_area* <span class="hljs-title">prop_area::map_prop_area_rw</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* filename, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* context,
                                       <span class="hljs-type">bool</span>* fsetxattr_failed)</span> </span>{
  ...
  <span class="hljs-type">void</span>* <span class="hljs-type">const</span> memory_area = <span class="hljs-built_in">mmap</span>(<span class="hljs-literal">nullptr</span>, pa_size_, PROT_READ | PROT_WRITE, MAP_SHARED, fd, <span class="hljs-number">0</span>);
  ...
}
</code></pre>
<p>这个方法就是调用了mmap做内存映射，再看看map_prop_area代码
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fbionic%2Flibc%2Fsystem_properties%2Fprop_area.cpp%23140" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/bionic/libc/system_properties/prop_area.cpp#140" ref="nofollow noopener noreferrer">/bionic/libc/system_properties/prop_area.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function">prop_area* <span class="hljs-title">prop_area::map_prop_area</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* filename)</span> </span>{
  <span class="hljs-type">int</span> fd = <span class="hljs-built_in">open</span>(filename, O_CLOEXEC | O_NOFOLLOW | O_RDONLY);
  <span class="hljs-keyword">if</span> (fd == <span class="hljs-number">-1</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;

  prop_area* map_result = <span class="hljs-built_in">map_fd_ro</span>(fd);
  <span class="hljs-built_in">close</span>(fd);

  <span class="hljs-keyword">return</span> map_result;
}

<span class="hljs-function">prop_area* <span class="hljs-title">prop_area::map_fd_ro</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">int</span> fd)</span> </span>{
  ...
  <span class="hljs-type">void</span>* <span class="hljs-type">const</span> map_result = <span class="hljs-built_in">mmap</span>(<span class="hljs-literal">nullptr</span>, pa_size_, PROT_READ, MAP_SHARED, fd, <span class="hljs-number">0</span>);
  ...
}
</code></pre>
<p>同样最终也是调用了mmap方法。</p>
<p>因此PropertyInit() 初始化属性服务，其实就是通过 <strong>mmap 系统调用</strong> 来完成属性内存区域的初始化与映射的, 建立了 <strong>/dev/<strong>properties</strong></strong> 共享内存区，供所有进程读写系统属性，如 getprop/setprop 命令操作的数据来源。</p>
<h4 data-id="heading-7">2.3.2 开启属性服务</h4>
<p><a href="https://link.juejin.cn?target=http%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Fcore%2Finit%2Fproperty_service.cpp%231548" target="_blank" title="http://xrefandroid.com/android-15.0.0_r1/xref/system/core/init/property_service.cpp#1548" ref="nofollow noopener noreferrer">/system/core/init/property_service.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">StartPropertyService</span><span class="hljs-params">(<span class="hljs-type">int</span>* epoll_socket)</span> </span>{
    <span class="hljs-comment">// 初始化属性版本</span>
    <span class="hljs-built_in">InitPropertySet</span>(<span class="hljs-string">"ro.property_service.version"</span>, <span class="hljs-string">"2"</span>);

    <span class="hljs-comment">// 创建 socketpair，用来让 init 与其属性服务线程之间做通信</span>
    <span class="hljs-type">int</span> sockets[<span class="hljs-number">2</span>];
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">socketpair</span>(AF_UNIX, SOCK_SEQPACKET | SOCK_CLOEXEC, <span class="hljs-number">0</span>, sockets) != <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">PLOG</span>(FATAL) &lt;&lt; <span class="hljs-string">"Failed to socketpair() between property_service and init"</span>;
    }
    *epoll_socket = from_init_socket = sockets[<span class="hljs-number">0</span>];
    init_socket = sockets[<span class="hljs-number">1</span>];
    
    <span class="hljs-comment">// 开启消息接收通道</span>
    <span class="hljs-built_in">StartSendingMessages</span>();

    <span class="hljs-comment">// 启动系统属性服务线程和普通属性服务线程</span>
    <span class="hljs-built_in">StartThread</span>(PROP_SERVICE_FOR_SYSTEM_NAME, <span class="hljs-number">0660</span>, AID_SYSTEM, property_service_for_system_thread,
                <span class="hljs-literal">true</span>);
    <span class="hljs-built_in">StartThread</span>(PROP_SERVICE_NAME, <span class="hljs-number">0666</span>, <span class="hljs-number">0</span>, property_service_thread, <span class="hljs-literal">false</span>);
    ...
}
</code></pre>
<p>我们先看看StartSendingMessages方法<br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Fcore%2Finit%2Fproperty_service.cpp%23151" target="_blank" title="http://xrefandroid.com/android-15.0.0_r1/xref/system/core/init/property_service.cpp#151" ref="nofollow noopener noreferrer">/system/core/init/property_service.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">StartSendingMessages</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">auto</span> lock = std::lock_guard{accept_messages_lock};
    accept_messages = <span class="hljs-literal">true</span>;
}
</code></pre>
<p>StartSendingMessages方法很简单，accept_messages是静态变量，这里使用了互斥锁来保证它的写操作，并设置为true，后续属性变更时，会判断accept_messages为true才会执行。<br/>
再看看StartThread方法<br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Fcore%2Finit%2Fproperty_service.cpp%231531" target="_blank" title="http://xrefandroid.com/android-15.0.0_r1/xref/system/core/init/property_service.cpp#1531" ref="nofollow noopener noreferrer">/system/core/init/property_service.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">StartThread</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* name, <span class="hljs-type">int</span> mode, <span class="hljs-type">int</span> gid, std::thread&amp; t, <span class="hljs-type">bool</span> listen_init)</span> </span>{
    <span class="hljs-type">int</span> fd = <span class="hljs-number">-1</span>;
    <span class="hljs-comment">// 创建一个 socket</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> result = <span class="hljs-built_in">CreateSocket</span>(name, SOCK_STREAM | SOCK_CLOEXEC | SOCK_NONBLOCK,
                                   <span class="hljs-comment">/*passcred=*/</span><span class="hljs-literal">false</span>, <span class="hljs-comment">/*should_listen=*/</span><span class="hljs-literal">false</span>, mode, <span class="hljs-comment">/*uid=*/</span><span class="hljs-number">0</span>,
                                   <span class="hljs-comment">/*gid=*/</span>gid, <span class="hljs-comment">/*socketcon=*/</span>{});
        result.<span class="hljs-built_in">ok</span>()) {
        fd = *result;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">LOG</span>(FATAL) &lt;&lt; <span class="hljs-string">"start_property_service socket creation failed: "</span> &lt;&lt; result.<span class="hljs-built_in">error</span>();
    }

    <span class="hljs-comment">// 对 fd 进行监听</span>
    <span class="hljs-built_in">listen</span>(fd, <span class="hljs-number">8</span>);

    <span class="hljs-comment">// 创建一个新线程</span>
    <span class="hljs-keyword">auto</span> new_thread = std::<span class="hljs-built_in">thread</span>(PropertyServiceThread, fd, listen_init);
    t.<span class="hljs-built_in">swap</span>(new_thread);
}
</code></pre>
<p>StartPropertyService会创建启动系统属性服务线程和普通属性服务线程,系统属性使用0660，普通属性使用0666。
这里说下Linux中各个数字代表什么权限：4 、2 和 1表示读、写、执行权限
0abc, a表示拥有者，b表示所属组，c表示其他用户。因此系统属性使用0660，表示拥有者，所属组有读写权限；普通属性使用0666表示所有用户均有读写权限。<br/>
这里使用2个线程，因为系统属性可能有敏感属性，所以使用了更严格的权限。后续创建了一个新的线程，看看PropertyServiceThread里面做了什么<br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Fcore%2Finit%2Fproperty_service.cpp%231468" target="_blank" title="http://xrefandroid.com/android-15.0.0_r1/xref/system/core/init/property_service.cpp#1468" ref="nofollow noopener noreferrer">/system/core/init/property_service.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">PropertyServiceThread</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">bool</span> listen_init)</span> </span>{
    Epoll epoll;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> result = epoll.<span class="hljs-built_in">Open</span>(); !result.<span class="hljs-built_in">ok</span>()) {
        <span class="hljs-built_in">LOG</span>(FATAL) &lt;&lt; result.<span class="hljs-built_in">error</span>();
    }

    <span class="hljs-comment">// 监听fd，当有更新时, 调用handle_property_set_fd来进行处理。</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> result = epoll.<span class="hljs-built_in">RegisterHandler</span>(fd, std::<span class="hljs-built_in">bind</span>(handle_property_set_fd, fd));
        !result.<span class="hljs-built_in">ok</span>()) {
        <span class="hljs-built_in">LOG</span>(FATAL) &lt;&lt; result.<span class="hljs-built_in">error</span>();
    }

    <span class="hljs-comment">// 监听init_socket(init_socket在StartPropertyService已经初始化了), 当更新时, 调用HandleInitSocket来进行处理。</span>
    <span class="hljs-keyword">if</span> (listen_init) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> result = epoll.<span class="hljs-built_in">RegisterHandler</span>(init_socket, HandleInitSocket); !result.<span class="hljs-built_in">ok</span>()) {
            <span class="hljs-built_in">LOG</span>(FATAL) &lt;&lt; result.<span class="hljs-built_in">error</span>();
        }
    }

    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-comment">// 进入事件等待循环</span>
        <span class="hljs-keyword">auto</span> epoll_result = epoll.<span class="hljs-built_in">Wait</span>(std::<span class="hljs-literal">nullopt</span>);
        <span class="hljs-keyword">if</span> (!epoll_result.<span class="hljs-built_in">ok</span>()) {
            <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; epoll_result.<span class="hljs-built_in">error</span>();
        }
    }
}
</code></pre>
<p>在PropertyServiceThread中监听了fd和init_socket，继续看看handle_property_set_fd里的代码<br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Fcore%2Finit%2Fproperty_service.cpp%23601" target="_blank" title="http://xrefandroid.com/android-15.0.0_r1/xref/system/core/init/property_service.cpp#601" ref="nofollow noopener noreferrer">/system/core/init/property_service.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">handle_property_set_fd</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span> </span>{
    ...
    <span class="hljs-type">uint32_t</span> cmd = <span class="hljs-number">0</span>;
    <span class="hljs-comment">// // 从 socket 中获取cmd</span>
    <span class="hljs-keyword">if</span> (!socket.<span class="hljs-built_in">RecvUint32</span>(&amp;cmd, &amp;timeout_ms)) {
        <span class="hljs-built_in">PLOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"sys_prop: error while reading command from the socket"</span>;
        socket.<span class="hljs-built_in">SendUint32</span>(PROP_ERROR_READ_CMD);
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">switch</span> (cmd) {
    <span class="hljs-comment">// 设置属性</span>
    <span class="hljs-keyword">case</span> PROP_MSG_SETPROP: {
        <span class="hljs-type">char</span> prop_name[PROP_NAME_MAX];
        <span class="hljs-type">char</span> prop_value[PROP_VALUE_MAX];

        <span class="hljs-comment">// 从 socket 中获取name, value</span>
        <span class="hljs-keyword">if</span> (!socket.<span class="hljs-built_in">RecvChars</span>(prop_name, PROP_NAME_MAX, &amp;timeout_ms) ||
            !socket.<span class="hljs-built_in">RecvChars</span>(prop_value, PROP_VALUE_MAX, &amp;timeout_ms)) {
          <span class="hljs-built_in">PLOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"sys_prop(PROP_MSG_SETPROP): error while reading name/value from the socket"</span>;
          <span class="hljs-keyword">return</span>;
        }
        ...
        
        <span class="hljs-comment">// 在HandlePropertySetNoSocket中处理</span>
        <span class="hljs-keyword">auto</span> result = <span class="hljs-built_in">HandlePropertySetNoSocket</span>(prop_name, prop_value, source_context, cr, &amp;error);
        ...

        <span class="hljs-keyword">break</span>;
      }

    <span class="hljs-comment">// 设置属性</span>
    <span class="hljs-keyword">case</span> PROP_MSG_SETPROP2: {
        std::string name;
        std::string value;
        
        <span class="hljs-comment">// 从 socket 中获取name, value</span>
        <span class="hljs-keyword">if</span> (!socket.<span class="hljs-built_in">RecvString</span>(&amp;name, &amp;timeout_ms) ||
            !socket.<span class="hljs-built_in">RecvString</span>(&amp;value, &amp;timeout_ms)) {
          <span class="hljs-built_in">PLOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"sys_prop(PROP_MSG_SETPROP2): error while reading name/value from the socket"</span>;
          socket.<span class="hljs-built_in">SendUint32</span>(PROP_ERROR_READ_DATA);
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 在HandlePropertySet中处理</span>
        <span class="hljs-keyword">auto</span> result = <span class="hljs-built_in">HandlePropertySet</span>(name, value, source_context, cr, &amp;socket, &amp;error);
        ...
        <span class="hljs-keyword">break</span>;
      }

    <span class="hljs-keyword">default</span>:
        <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"sys_prop: invalid command "</span> &lt;&lt; cmd;
        socket.<span class="hljs-built_in">SendUint32</span>(PROP_ERROR_INVALID_CMD);
        <span class="hljs-keyword">break</span>;
    }
}
</code></pre>
<p>handle_property_set_fd 根据 socket 中获取到的cmd, 调用HandlePropertySetNoSocket 或HandlePropertySet去设置属性。而 HandlePropertySetNoSocket 也会调用到 HandlePropertySet，因此我们直接看HandlePropertySet代码<br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Fcore%2Finit%2Fproperty_service.cpp%23548" target="_blank" title="http://xrefandroid.com/android-15.0.0_r1/xref/system/core/init/property_service.cpp#548" ref="nofollow noopener noreferrer">/system/core/init/property_service.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function">std::optional&lt;<span class="hljs-type">uint32_t</span>&gt; <span class="hljs-title">HandlePropertySet</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; name, <span class="hljs-type">const</span> std::string&amp; value,
                                          <span class="hljs-type">const</span> std::string&amp; source_context, <span class="hljs-type">const</span> ucred&amp; cr,
                                          SocketConnection* socket, std::string* error)</span> </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> ret = <span class="hljs-built_in">CheckPermissions</span>(name, value, source_context, cr, error); ret != PROP_SUCCESS) {
        <span class="hljs-keyword">return</span> {ret};
    }

    <span class="hljs-comment">// 控制属性</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">StartsWith</span>(name, <span class="hljs-string">"ctl."</span>)) {
        <span class="hljs-keyword">return</span> {<span class="hljs-built_in">SendControlMessage</span>(name.<span class="hljs-built_in">c_str</span>() + <span class="hljs-number">4</span>, value, cr.pid, socket, error)};
    }

    <span class="hljs-comment">// 设备重新启动属性</span>
    <span class="hljs-keyword">if</span> (name == <span class="hljs-string">"sys.powerctl"</span>) {
        std::string cmdline_path = <span class="hljs-built_in">StringPrintf</span>(<span class="hljs-string">"proc/%d/cmdline"</span>, cr.pid);
        std::string process_cmdline;
        std::string process_log_string;
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ReadFileToString</span>(cmdline_path, &amp;process_cmdline)) {
            process_log_string = <span class="hljs-built_in">StringPrintf</span>(<span class="hljs-string">" (%s)"</span>, process_cmdline.<span class="hljs-built_in">c_str</span>());
        }
        <span class="hljs-built_in">LOG</span>(INFO) &lt;&lt; <span class="hljs-string">"Received sys.powerctl='"</span> &lt;&lt; value &lt;&lt; <span class="hljs-string">"' from pid: "</span> &lt;&lt; cr.pid
                  &lt;&lt; process_log_string;
        <span class="hljs-keyword">if</span> (value == <span class="hljs-string">"reboot,userspace"</span> &amp;&amp; !<span class="hljs-built_in">is_userspace_reboot_supported</span>().<span class="hljs-built_in">value_or</span>(<span class="hljs-literal">false</span>)) {
            *error = <span class="hljs-string">"Userspace reboot is not supported by this device"</span>;
            <span class="hljs-keyword">return</span> {PROP_ERROR_INVALID_VALUE};
        }
    }

    <span class="hljs-keyword">if</span> (name == kRestoreconProperty &amp;&amp; cr.pid != <span class="hljs-number">1</span> &amp;&amp; !value.<span class="hljs-built_in">empty</span>()) {
        <span class="hljs-type">static</span> AsyncRestorecon async_restorecon;
        async_restorecon.<span class="hljs-built_in">TriggerRestorecon</span>(value);
        <span class="hljs-keyword">return</span> {PROP_SUCCESS};
    }

    <span class="hljs-comment">// 普通属性</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">PropertySet</span>(name, value, socket, error);
}
</code></pre>
<p>HandlePropertySet中，设置普通属性会调用PropertySet，继续看看PropertySet代码<br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Fcore%2Finit%2Fproperty_service.cpp%23391" target="_blank" title="http://xrefandroid.com/android-15.0.0_r1/xref/system/core/init/property_service.cpp#391" ref="nofollow noopener noreferrer">/system/core/init/property_service.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">static</span> std::optional&lt;<span class="hljs-type">uint32_t</span>&gt; <span class="hljs-title">PropertySet</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; name, <span class="hljs-type">const</span> std::string&amp; value,
                                           SocketConnection* socket, std::string* error)</span> </span>{
    <span class="hljs-type">size_t</span> valuelen = value.<span class="hljs-built_in">size</span>();

    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">IsLegalPropertyName</span>(name)) {
        *error = <span class="hljs-string">"Illegal property name"</span>;
        <span class="hljs-keyword">return</span> {PROP_ERROR_INVALID_NAME};
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> result = <span class="hljs-built_in">IsLegalPropertyValue</span>(name, value); !result.<span class="hljs-built_in">ok</span>()) {
        *error = result.<span class="hljs-built_in">error</span>().<span class="hljs-built_in">message</span>();
        <span class="hljs-keyword">return</span> {PROP_ERROR_INVALID_VALUE};
    }

    <span class="hljs-keyword">if</span> (name == <span class="hljs-string">"sys.powerctl"</span>) {
        <span class="hljs-comment">// No action here - NotifyPropertyChange will trigger the appropriate action, and since this</span>
        <span class="hljs-comment">// can come to the second thread, we mustn't call out to the __system_property_* functions</span>
        <span class="hljs-comment">// which support multiple readers but only one mutator.</span>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// __system_property_find</span>
        prop_info* pi = (prop_info*)__system_property_find(name.<span class="hljs-built_in">c_str</span>());
        <span class="hljs-keyword">if</span> (pi != <span class="hljs-literal">nullptr</span>) {
            <span class="hljs-comment">// ro.* properties are actually "write-once".</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">StartsWith</span>(name, <span class="hljs-string">"ro."</span>)) {
                *error = <span class="hljs-string">"Read-only property was already set"</span>;
                <span class="hljs-keyword">return</span> {PROP_ERROR_READ_ONLY_PROPERTY};
            }

            __system_property_update(pi, value.<span class="hljs-built_in">c_str</span>(), valuelen);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-type">int</span> rc = __system_property_add(name.<span class="hljs-built_in">c_str</span>(), name.<span class="hljs-built_in">size</span>(), value.<span class="hljs-built_in">c_str</span>(), valuelen);
            <span class="hljs-keyword">if</span> (rc &lt; <span class="hljs-number">0</span>) {
                *error = <span class="hljs-string">"__system_property_add failed"</span>;
                <span class="hljs-keyword">return</span> {PROP_ERROR_SET_FAILED};
            }
        }

        <span class="hljs-comment">// Don't write properties to disk until after we have read all default</span>
        <span class="hljs-comment">// properties to prevent them from being overwritten by default values.</span>
        <span class="hljs-type">bool</span> need_persist = <span class="hljs-built_in">StartsWith</span>(name, <span class="hljs-string">"persist."</span>) || <span class="hljs-built_in">StartsWith</span>(name, <span class="hljs-string">"next_boot."</span>);
        <span class="hljs-keyword">if</span> (socket &amp;&amp; persistent_properties_loaded &amp;&amp; need_persist) {
            <span class="hljs-keyword">if</span> (persist_write_thread) {
                persist_write_thread-&gt;<span class="hljs-built_in">Write</span>(name, value, std::<span class="hljs-built_in">move</span>(*socket));
                <span class="hljs-keyword">return</span> {};
            }
            <span class="hljs-built_in">WritePersistentProperty</span>(name, value);
        }
    }

    <span class="hljs-built_in">NotifyPropertyChange</span>(name, value);
    <span class="hljs-keyword">return</span> {PROP_SUCCESS};
}
</code></pre>
<p>[/system/core/init/property_service.cpp](<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-" target="_blank" title="https://xrefandroid.com/android-" ref="nofollow noopener noreferrer">xrefandroid.com/android-</a>
PropertySet方法中，先调用__system_property_find方法，如果已经当前属性存在，则更新它，不存在，则添加。先看看__system_property_find方法。<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fbionic%2Flibc%2Fsystem_properties%2Fsystem_properties.cpp%23162" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/bionic/libc/system_properties/system_properties.cpp#162" ref="nofollow noopener noreferrer">/bionic/libc/system_properties/system_properties.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">const</span> prop_info* <span class="hljs-title">SystemProperties::Find</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* name)</span> </span>{
  <span class="hljs-keyword">if</span> (!initialized_) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;
  }

  prop_area* pa = contexts_-&gt;<span class="hljs-built_in">GetPropAreaForName</span>(name);
  <span class="hljs-keyword">if</span> (!pa) {
    <span class="hljs-built_in">async_safe_format_log</span>(ANDROID_LOG_WARN, <span class="hljs-string">"libc"</span>, <span class="hljs-string">"Access denied finding property \"%s\""</span>, name);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;
  }

  <span class="hljs-keyword">return</span> pa-&gt;<span class="hljs-built_in">find</span>(name);
}

</code></pre>
<p>SystemProperties方法先调用了contexts_-&gt;GetPropAreaForName， 然后再调用了pa-&gt;find。contexts_是在初始化属性流程中赋值的(auto serial_contexts = new (contexts_data_) ContextsSerialized();)。通过调用ContextsSerialized返回了prop_area对象，这里就不跟进去看怎么返回prop_area对象了，我们直接看prop_area里面的find方法<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fbionic%2Flibc%2Fsystem_properties%2Fprop_area.cpp%23229" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/bionic/libc/system_properties/prop_area.cpp#229" ref="nofollow noopener noreferrer">/bionic/libc/system_properties/prop_area.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">const</span> prop_info* <span class="hljs-title">prop_area::find</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* name)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">find_property</span>(<span class="hljs-built_in">root_node</span>(), name, <span class="hljs-built_in">strlen</span>(name), <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">false</span>);
}
</code></pre>
<p>find方法直接调用了find_property方法，那么看看find_property的实现<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fbionic%2Flibc%2Fsystem_properties%2Fprop_area.cpp%23278" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/bionic/libc/system_properties/prop_area.cpp#278" ref="nofollow noopener noreferrer">/bionic/libc/system_properties/prop_area.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">const</span> prop_info* <span class="hljs-title">prop_area::find_property</span><span class="hljs-params">(prop_trie_node* <span class="hljs-type">const</span> trie, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* name,
                                          <span class="hljs-type">uint32_t</span> namelen, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* value, <span class="hljs-type">uint32_t</span> valuelen,
                                          <span class="hljs-type">bool</span> alloc_if_needed)</span> </span>{
  <span class="hljs-keyword">if</span> (!trie) <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;

  <span class="hljs-type">const</span> <span class="hljs-type">char</span>* remaining_name = name;
  prop_trie_node* current = trie;
  <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* sep = <span class="hljs-built_in">strchr</span>(remaining_name, <span class="hljs-string">'.'</span>);
    <span class="hljs-type">const</span> <span class="hljs-type">bool</span> want_subtree = (sep != <span class="hljs-literal">nullptr</span>);
    <span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> substr_size = (want_subtree) ? sep - remaining_name : <span class="hljs-built_in">strlen</span>(remaining_name);

    <span class="hljs-keyword">if</span> (!substr_size) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;
    }

    prop_trie_node* root = <span class="hljs-literal">nullptr</span>;
    <span class="hljs-type">uint_least32_t</span> children_offset = <span class="hljs-built_in">atomic_load_explicit</span>(&amp;current-&gt;children, memory_order_relaxed);
    <span class="hljs-keyword">if</span> (children_offset != <span class="hljs-number">0</span>) {
      root = <span class="hljs-built_in">to_prop_trie_node</span>(&amp;current-&gt;children);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (alloc_if_needed) {
      <span class="hljs-type">uint_least32_t</span> new_offset;
      root = <span class="hljs-built_in">new_prop_trie_node</span>(remaining_name, substr_size, &amp;new_offset);
      <span class="hljs-keyword">if</span> (root) {
        <span class="hljs-built_in">atomic_store_explicit</span>(&amp;current-&gt;children, new_offset, memory_order_release);
      }
    }

    <span class="hljs-keyword">if</span> (!root) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;
    }

    current = <span class="hljs-built_in">find_prop_trie_node</span>(root, remaining_name, substr_size, alloc_if_needed);
    <span class="hljs-keyword">if</span> (!current) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;
    }

    <span class="hljs-keyword">if</span> (!want_subtree) <span class="hljs-keyword">break</span>;

    remaining_name = sep + <span class="hljs-number">1</span>;
  }

  <span class="hljs-type">uint_least32_t</span> prop_offset = <span class="hljs-built_in">atomic_load_explicit</span>(&amp;current-&gt;prop, memory_order_relaxed);
  <span class="hljs-keyword">if</span> (prop_offset != <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">to_prop_info</span>(&amp;current-&gt;prop);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (alloc_if_needed) {
    <span class="hljs-type">uint_least32_t</span> new_offset;
    prop_info* new_info = <span class="hljs-built_in">new_prop_info</span>(name, namelen, value, valuelen, &amp;new_offset);
    <span class="hljs-keyword">if</span> (new_info) {
      <span class="hljs-built_in">atomic_store_explicit</span>(&amp;current-&gt;prop, new_offset, memory_order_release);
    }

    <span class="hljs-keyword">return</span> new_info;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;
  }
}
</code></pre>
<p>在find_property方法里面，我们就可以看到属性是通过树来存储的。__system_property_find是从树里找节点，而__system_property_add最终也会调用到find_property方法，它是往这个树里添加节点。</p>
<h4 data-id="heading-8">2.3.3 加载init.rc文件</h4>
<p>加载init.rc文件是在LoadBootScripts方法中，看看它做了什么<br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Fcore%2Finit%2Finit.cpp%23337" target="_blank" title="http://xrefandroid.com/android-15.0.0_r1/xref/system/core/init/init.cpp#337" ref="nofollow noopener noreferrer">/system/core/init/init.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">LoadBootScripts</span><span class="hljs-params">(ActionManager&amp; action_manager, ServiceList&amp; service_list)</span> </span>{
    <span class="hljs-comment">// 创建解析器</span>
    Parser parser = <span class="hljs-built_in">CreateParser</span>(action_manager, service_list);

    std::string bootscript = <span class="hljs-built_in">GetProperty</span>(<span class="hljs-string">"ro.boot.init_rc"</span>, <span class="hljs-string">""</span>);
    <span class="hljs-keyword">if</span> (bootscript.<span class="hljs-built_in">empty</span>()) {
        parser.<span class="hljs-built_in">ParseConfig</span>(<span class="hljs-string">"/system/etc/init/hw/init.rc"</span>);
        <span class="hljs-keyword">if</span> (!parser.<span class="hljs-built_in">ParseConfig</span>(<span class="hljs-string">"/system/etc/init"</span>)) {
            late_import_paths.<span class="hljs-built_in">emplace_back</span>(<span class="hljs-string">"/system/etc/init"</span>);
        }
        <span class="hljs-comment">// late_import is available only in Q and earlier release. As we don't</span>
        <span class="hljs-comment">// have system_ext in those versions, skip late_import for system_ext.</span>
        parser.<span class="hljs-built_in">ParseConfig</span>(<span class="hljs-string">"/system_ext/etc/init"</span>);
        <span class="hljs-keyword">if</span> (!parser.<span class="hljs-built_in">ParseConfig</span>(<span class="hljs-string">"/vendor/etc/init"</span>)) {
            late_import_paths.<span class="hljs-built_in">emplace_back</span>(<span class="hljs-string">"/vendor/etc/init"</span>);
        }
        <span class="hljs-keyword">if</span> (!parser.<span class="hljs-built_in">ParseConfig</span>(<span class="hljs-string">"/odm/etc/init"</span>)) {
            late_import_paths.<span class="hljs-built_in">emplace_back</span>(<span class="hljs-string">"/odm/etc/init"</span>);
        }
        <span class="hljs-keyword">if</span> (!parser.<span class="hljs-built_in">ParseConfig</span>(<span class="hljs-string">"/product/etc/init"</span>)) {
            late_import_paths.<span class="hljs-built_in">emplace_back</span>(<span class="hljs-string">"/product/etc/init"</span>);
        }
    } <span class="hljs-keyword">else</span> {
        parser.<span class="hljs-built_in">ParseConfig</span>(bootscript);
    }
}
</code></pre>
<p>首先看看 CreateParser 中的代码<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Fcore%2Finit%2Finit.cpp%23270" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/system/core/init/init.cpp#270" ref="nofollow noopener noreferrer">/system/core/init/init.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function">Parser <span class="hljs-title">CreateParser</span><span class="hljs-params">(ActionManager&amp; action_manager, ServiceList&amp; service_list)</span> </span>{
    Parser parser;

    parser.<span class="hljs-built_in">AddSectionParser</span>(<span class="hljs-string">"service"</span>, std::<span class="hljs-built_in">make_unique</span>&lt;ServiceParser&gt;(
                                               &amp;service_list, <span class="hljs-built_in">GetSubcontext</span>(), std::<span class="hljs-literal">nullopt</span>));
    parser.<span class="hljs-built_in">AddSectionParser</span>(<span class="hljs-string">"on"</span>, std::<span class="hljs-built_in">make_unique</span>&lt;ActionParser&gt;(&amp;action_manager, <span class="hljs-built_in">GetSubcontext</span>()));
    parser.<span class="hljs-built_in">AddSectionParser</span>(<span class="hljs-string">"import"</span>, std::<span class="hljs-built_in">make_unique</span>&lt;ImportParser&gt;(&amp;parser));

    <span class="hljs-keyword">return</span> parser;
}

std::map&lt;std::string, std::unique_ptr&lt;SectionParser&gt;&gt; section_parsers_;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Parser::AddSectionParser</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; name, std::unique_ptr&lt;SectionParser&gt; parser)</span> </span>{
    section_parsers_[name] = std::<span class="hljs-built_in">move</span>(parser);
}
</code></pre>
<p>CreateParser 方法创建了 ServiceParser、ActionParser、和 ImportParser，并通过 AddSectionParser 将它们按名字注册到 Parser 内部的 section_parsers_ 映射表（即键为 "service"、"on"、"import"）中。<br/>
而需要进行解析的init.rc文件，也只有这3种, 下面为init.rc简略文件<br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Fcore%2Frootdir%2Finit.rc" target="_blank" title="http://xrefandroid.com/android-15.0.0_r1/xref/system/core/rootdir/init.rc" ref="nofollow noopener noreferrer">/system/core/rootdir/init.rc</a></p>
<pre><code class="hljs language-C++" lang="C++">...
<span class="hljs-keyword">import</span> /system/etc/init/hw/init.${ro.zygote}.rc

# Cgroups are mounted right before early-init <span class="hljs-keyword">using</span> list from /etc/cgroups.json
on early-init
    # Disable sysrq from keyboard
    write /proc/sys/kernel/sysrq <span class="hljs-number">0</span>
...
service ueventd /system/bin/ueventd
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">core</span>
    critical
...
</code></pre>
<p>而ParseConfig方法里面会判断是不是目录，init.rc不是目录，会调用ParseConfigFile方法，继续看这个方法。<br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Fcore%2Finit%2Fparser.cpp%23134" target="_blank" title="http://xrefandroid.com/android-15.0.0_r1/xref/system/core/init/parser.cpp#134" ref="nofollow noopener noreferrer">/system/core/init/parser.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function">Result&lt;<span class="hljs-type">void</span>&gt; <span class="hljs-title">Parser::ParseConfigFile</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path)</span> </span>{
    ...
    <span class="hljs-comment">// 从路径中读取文件</span>
    <span class="hljs-keyword">auto</span> config_contents = <span class="hljs-built_in">ReadFile</span>(path);
    
    <span class="hljs-comment">// 解析数据</span>
    <span class="hljs-built_in">ParseData</span>(path, &amp;config_contents.<span class="hljs-built_in">value</span>());

    <span class="hljs-built_in">LOG</span>(VERBOSE) &lt;&lt; <span class="hljs-string">"(Parsing "</span> &lt;&lt; path &lt;&lt; <span class="hljs-string">" took "</span> &lt;&lt; t &lt;&lt; <span class="hljs-string">".)"</span>;
    <span class="hljs-keyword">return</span> {};
}
</code></pre>
<p>继续看看ParseData中怎么处理的<br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Fcore%2Finit%2Fparser.cpp%2345" target="_blank" title="http://xrefandroid.com/android-15.0.0_r1/xref/system/core/init/parser.cpp#45" ref="nofollow noopener noreferrer">/system/core/init/parser.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-comment">// system/core/init/parser.cpp</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Parser::ParseData</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; filename, std::string* data)</span> </span>{
    ...

    <span class="hljs-keyword">for</span> (;;) {
        <span class="hljs-keyword">switch</span> (<span class="hljs-built_in">next_token</span>(&amp;state)) {
            <span class="hljs-keyword">case</span> T_EOF:
                <span class="hljs-built_in">end_section</span>();

                <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; [section_name, section_parser] : section_parsers_) {
                    section_parser-&gt;<span class="hljs-built_in">EndFile</span>();
                }

                <span class="hljs-keyword">return</span>;
            <span class="hljs-keyword">case</span> T_NEWLINE: {
                state.line++;
                <span class="hljs-keyword">if</span> (args.<span class="hljs-built_in">empty</span>()) <span class="hljs-keyword">break</span>;
                <span class="hljs-comment">// If we have a line matching a prefix we recognize, call its callback and unset any</span>
                <span class="hljs-comment">// current section parsers.  This is meant for /sys/ and /dev/ line entries for</span>
                <span class="hljs-comment">// uevent.</span>
                <span class="hljs-keyword">auto</span> line_callback = std::<span class="hljs-built_in">find_if</span>(
                    line_callbacks_.<span class="hljs-built_in">begin</span>(), line_callbacks_.<span class="hljs-built_in">end</span>(),
                    [&amp;args](<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; c) { <span class="hljs-keyword">return</span> android::base::<span class="hljs-built_in">StartsWith</span>(args[<span class="hljs-number">0</span>], c.first); });
                <span class="hljs-keyword">if</span> (line_callback != line_callbacks_.<span class="hljs-built_in">end</span>()) {
                    <span class="hljs-built_in">end_section</span>();

                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> result = line_callback-&gt;<span class="hljs-built_in">second</span>(std::<span class="hljs-built_in">move</span>(args)); !result.<span class="hljs-built_in">ok</span>()) {
                        parse_error_count_++;
                        <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; filename &lt;&lt; <span class="hljs-string">": "</span> &lt;&lt; state.line &lt;&lt; <span class="hljs-string">": "</span> &lt;&lt; result.<span class="hljs-built_in">error</span>();
                    }
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (section_parsers_.<span class="hljs-built_in">count</span>(args[<span class="hljs-number">0</span>])) { <span class="hljs-comment">// 1</span>
                    <span class="hljs-built_in">end_section</span>();
                    section_parser = section_parsers_[args[<span class="hljs-number">0</span>]].<span class="hljs-built_in">get</span>();
                    section_start_line = state.line;
                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> result =
                                section_parser-&gt;<span class="hljs-built_in">ParseSection</span>(std::<span class="hljs-built_in">move</span>(args), filename, state.line);
                        !result.<span class="hljs-built_in">ok</span>()) {
                        parse_error_count_++;
                        <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; filename &lt;&lt; <span class="hljs-string">": "</span> &lt;&lt; state.line &lt;&lt; <span class="hljs-string">": "</span> &lt;&lt; result.<span class="hljs-built_in">error</span>();
                        section_parser = <span class="hljs-literal">nullptr</span>;
                        bad_section_found = <span class="hljs-literal">true</span>;
                    }
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (section_parser) {
                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> result = section_parser-&gt;<span class="hljs-built_in">ParseLineSection</span>(std::<span class="hljs-built_in">move</span>(args), state.line);
                        !result.<span class="hljs-built_in">ok</span>()) {
                        parse_error_count_++;
                        <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; filename &lt;&lt; <span class="hljs-string">": "</span> &lt;&lt; state.line &lt;&lt; <span class="hljs-string">": "</span> &lt;&lt; result.<span class="hljs-built_in">error</span>();
                    }
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!bad_section_found) {
                    parse_error_count_++;
                    <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; filename &lt;&lt; <span class="hljs-string">": "</span> &lt;&lt; state.line
                               &lt;&lt; <span class="hljs-string">": Invalid section keyword found"</span>;
                }
                args.<span class="hljs-built_in">clear</span>();
                <span class="hljs-keyword">break</span>;
            }
            <span class="hljs-keyword">case</span> T_TEXT:
                args.<span class="hljs-built_in">emplace_back</span>(state.text);
                <span class="hljs-keyword">break</span>;
        }
    }
}
</code></pre>
<p>需要先说明1处的 std::map 的 count()  函数用于检查指定键是否存在于映射中。<br/>
section_parsers_之前添加了on, service, import，当遍历init.rc文件时，如果是这几个字符串，section_parser = section_parsers_[args[0]].get();会拿到对应的解析器。<br/>
如Service 类型语句会使用 ServiceParser 解析<br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Fcore%2Finit%2Fservice_parser.cpp%23642" target="_blank" title="http://xrefandroid.com/android-15.0.0_r1/xref/system/core/init/service_parser.cpp#642" ref="nofollow noopener noreferrer">/system/core/init/service_parser.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function">Result&lt;<span class="hljs-type">void</span>&gt; <span class="hljs-title">ServiceParser::ParseSection</span><span class="hljs-params">(std::vector&lt;std::string&gt;&amp;&amp; args,
                                         <span class="hljs-type">const</span> std::string&amp; filename, <span class="hljs-type">int</span> line)</span> </span>{
    <span class="hljs-comment">// 判断参数是否少于3个</span>
    <span class="hljs-keyword">if</span> (args.<span class="hljs-built_in">size</span>() &lt; <span class="hljs-number">3</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Error</span>() &lt;&lt; <span class="hljs-string">"services must have a name and a program"</span>;
    }

    <span class="hljs-type">const</span> std::string&amp; name = args[<span class="hljs-number">1</span>];
    <span class="hljs-comment">// 判断 Service 的 name 有效性</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">IsValidName</span>(name)) { 
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Error</span>() &lt;&lt; <span class="hljs-string">"invalid service name '"</span> &lt;&lt; name &lt;&lt; <span class="hljs-string">"'"</span>;
    }
    ...

    <span class="hljs-comment">// 构造 Service 对象</span>
    service_ = std::<span class="hljs-built_in">make_unique</span>&lt;Service&gt;(name, restart_action_subcontext, filename, str_args);
    <span class="hljs-keyword">return</span> {};
}
</code></pre>
<p>在解析完init.rc文件之后，ParseData会在循环中执行end_section方法，代码如下：<br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Fcore%2Finit%2Fparser.cpp%2362" target="_blank" title="http://xrefandroid.com/android-15.0.0_r1/xref/system/core/init/parser.cpp#62" ref="nofollow noopener noreferrer">/system/core/init/parser.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++">    <span class="hljs-keyword">auto</span> end_section = [&amp;] {
        bad_section_found = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">if</span> (section_parser == <span class="hljs-literal">nullptr</span>) <span class="hljs-keyword">return</span>;

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> result = section_parser-&gt;<span class="hljs-built_in">EndSection</span>(); !result.<span class="hljs-built_in">ok</span>()) {
            parse_error_count_++;
            <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; filename &lt;&lt; <span class="hljs-string">": "</span> &lt;&lt; section_start_line &lt;&lt; <span class="hljs-string">": "</span> &lt;&lt; result.<span class="hljs-built_in">error</span>();
        }

        section_parser = <span class="hljs-literal">nullptr</span>;
        section_start_line = <span class="hljs-number">-1</span>;
    };
</code></pre>
<p>继续跑到对应解析器的EndSection，此处看下ServiceParser的EndSection方法<br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Fcore%2Finit%2Fservice_parser.cpp%23689" target="_blank" title="http://xrefandroid.com/android-15.0.0_r1/xref/system/core/init/service_parser.cpp#689" ref="nofollow noopener noreferrer">/system/core/init/service_parser.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function">Result&lt;<span class="hljs-type">void</span>&gt; <span class="hljs-title">ServiceParser::EndSection</span><span class="hljs-params">()</span> </span>{
    ...

    service_list_-&gt;<span class="hljs-built_in">AddService</span>(std::<span class="hljs-built_in">move</span>(service_));

    <span class="hljs-keyword">return</span> {};
}
</code></pre>
<p>实际上这里就是把构建的service对象添加到service_list_中。</p>
<p>再看看on对应解析器做了什么。<br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Fcore%2Finit%2Faction_parser.cpp%23133" target="_blank" title="http://xrefandroid.com/android-15.0.0_r1/xref/system/core/init/action_parser.cpp#133" ref="nofollow noopener noreferrer">/system/core/init/action_parser.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function">Result&lt;<span class="hljs-type">void</span>&gt; <span class="hljs-title">ActionParser::ParseSection</span><span class="hljs-params">(std::vector&lt;std::string&gt;&amp;&amp; args,
                                        <span class="hljs-type">const</span> std::string&amp; filename, <span class="hljs-type">int</span> line)</span> </span>{
    ...
    <span class="hljs-keyword">auto</span> action = std::<span class="hljs-built_in">make_unique</span>&lt;Action&gt;(<span class="hljs-literal">false</span>, action_subcontext, filename, line, event_trigger,
                                           property_triggers);

    action_ = std::<span class="hljs-built_in">move</span>(action);
    <span class="hljs-keyword">return</span> {};
}
</code></pre>
<p><a href="https://link.juejin.cn?target=http%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Fcore%2Finit%2Faction_parser.cpp%23173" target="_blank" title="http://xrefandroid.com/android-15.0.0_r1/xref/system/core/init/action_parser.cpp#173" ref="nofollow noopener noreferrer">/system/core/init/action_parser.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function">Result&lt;<span class="hljs-type">void</span>&gt; <span class="hljs-title">ActionParser::EndSection</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span> (action_ &amp;&amp; action_-&gt;<span class="hljs-built_in">NumCommands</span>() &gt; <span class="hljs-number">0</span>) {
        action_manager_-&gt;<span class="hljs-built_in">AddAction</span>(std::<span class="hljs-built_in">move</span>(action_));
    }

    <span class="hljs-keyword">return</span> {};
}
</code></pre>
<p>类似于ServiceParser, ActionParser先通过ParseSection构造action，在EndSection添加到了action_manager中。
SecondStageMain后续会在一个循环中去执行这些activon，如下：<br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Fcore%2Finit%2Finit.cpp%231103" target="_blank" title="http://xrefandroid.com/android-15.0.0_r1/xref/system/core/init/init.cpp#1103" ref="nofollow noopener noreferrer">/system/core/init/init.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++">    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        ...
        <span class="hljs-keyword">if</span> (!(prop_waiter_state.<span class="hljs-built_in">MightBeWaiting</span>() || Service::<span class="hljs-built_in">is_exec_service_running</span>())) {
            am.<span class="hljs-built_in">ExecuteOneCommand</span>();
            <span class="hljs-comment">// If there's more work to do, wake up again immediately.</span>
            <span class="hljs-keyword">if</span> (am.<span class="hljs-built_in">HasMoreCommands</span>()) {
                next_action_time = boot_clock::<span class="hljs-built_in">now</span>();
            }
        }
        ...
    }
</code></pre>
<p>代码中的am就是ActionManage，看看ExecuteOneCommand做了什么<br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Fcore%2Finit%2Faction_manager.cpp%2367" target="_blank" title="http://xrefandroid.com/android-15.0.0_r1/xref/system/core/init/action_manager.cpp#67" ref="nofollow noopener noreferrer">/system/core/init/action_manager.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ActionManager::ExecuteOneCommand</span><span class="hljs-params">()</span> </span>{
    {
        <span class="hljs-keyword">auto</span> lock = std::lock_guard{event_queue_lock_};
        <span class="hljs-comment">// 取出可执行的 Action</span>
        <span class="hljs-keyword">while</span> (current_executing_actions_.<span class="hljs-built_in">empty</span>() &amp;&amp; !event_queue_.<span class="hljs-built_in">empty</span>()) {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; action : actions_) {
                <span class="hljs-keyword">if</span> (std::<span class="hljs-built_in">visit</span>([&amp;action](<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; event) { <span class="hljs-keyword">return</span> action-&gt;<span class="hljs-built_in">CheckEvent</span>(event); },
                               event_queue_.<span class="hljs-built_in">front</span>())) {
                    current_executing_actions_.<span class="hljs-built_in">emplace</span>(action.<span class="hljs-built_in">get</span>());
                }
            }
            event_queue_.<span class="hljs-built_in">pop</span>();
        }
    }

    <span class="hljs-comment">// 执行action</span>
    action-&gt;<span class="hljs-built_in">ExecuteOneCommand</span>(current_command_);
    ...
}
</code></pre>
<p>在ExecuteOneCommand中会从event_queue_中取出可执行的aciton并且执行。</p>
<p>小结一下此处：解析init.rc文件，将service添加到service_list中，将action添加到action_manager中，后续在一个循环中执行action_manager中的action。</p>
<h4 data-id="heading-9">2.3.4 启动zygote</h4>
<p>在知道了上面这些后，再来看看init是如何启动zygote的呢？</p>
<p>zygote的rc文件是通过import导入的，会通过ImportParser导入zygote.rc。<br/>
init.zygote64.rc文件<br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Fcore%2Frootdir%2Finit.zygote64.rc" target="_blank" title="http://xrefandroid.com/android-15.0.0_r1/xref/system/core/rootdir/init.zygote64.rc" ref="nofollow noopener noreferrer">/system/core/rootdir/init.zygote64.rc</a></p>
<pre><code class="hljs language-rc" lang="rc">service zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server --socket-name=zygote
    class main
    priority -20
    user root
    group root readproc reserved_disk
    socket zygote stream 660 root system
    socket usap_pool_primary stream 660 root system
    ...
</code></pre>
<p>此处class 为 main 对应init中的<br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Fcore%2Frootdir%2Finit.rc" target="_blank" title="http://xrefandroid.com/android-15.0.0_r1/xref/system/core/rootdir/init.rc" ref="nofollow noopener noreferrer">/system/core/rootdir/init.rc</a></p>
<pre><code class="hljs language-rc" lang="rc">on nonencrypted
    class_start main
    class_start late_start
</code></pre>
<p>在SecondStageMain中的循环去执行action时，也就是上面的on语句, 执行class_start，它对应的方法是do_class_start，如下<br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Fcore%2Finit%2Fbuiltins.cpp%231320" target="_blank" title="http://xrefandroid.com/android-15.0.0_r1/xref/system/core/init/builtins.cpp#1320" ref="nofollow noopener noreferrer">/system/core/init/builtins.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-comment">// Builtin-function-map start</span>
<span class="hljs-function"><span class="hljs-type">const</span> BuiltinFunctionMap&amp; <span class="hljs-title">GetBuiltinFunctionMap</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">constexpr</span> std::<span class="hljs-type">size_t</span> kMax = std::numeric_limits&lt;std::<span class="hljs-type">size_t</span>&gt;::<span class="hljs-built_in">max</span>();
    <span class="hljs-comment">// clang-format off</span>
    <span class="hljs-type">static</span> <span class="hljs-type">const</span> BuiltinFunctionMap builtin_functions = {
        ...
        {<span class="hljs-string">"class_start"</span>,             {<span class="hljs-number">1</span>,     <span class="hljs-number">1</span>,    {<span class="hljs-literal">false</span>,  do_class_start}}},
        ...
    }
}
</code></pre>
<p>继续看看do_class_start做了什么<br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Fcore%2Finit%2Fbuiltins.cpp%23166" target="_blank" title="http://xrefandroid.com/android-15.0.0_r1/xref/system/core/init/builtins.cpp#166" ref="nofollow noopener noreferrer">/system/core/init/builtins.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">static</span> Result&lt;<span class="hljs-type">void</span>&gt; <span class="hljs-title">do_class_start</span><span class="hljs-params">(<span class="hljs-type">const</span> BuiltinArguments&amp; args)</span> </span>{
    ...
    <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; service : ServiceList::<span class="hljs-built_in">GetInstance</span>()) {
        <span class="hljs-keyword">if</span> (service-&gt;<span class="hljs-built_in">classnames</span>().<span class="hljs-built_in">count</span>(args[<span class="hljs-number">1</span>])) {
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> result = service-&gt;<span class="hljs-built_in">StartIfNotDisabled</span>(); !result.<span class="hljs-built_in">ok</span>()) {
                <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"Could not start service '"</span> &lt;&lt; service-&gt;<span class="hljs-built_in">name</span>()
                           &lt;&lt; <span class="hljs-string">"' as part of class '"</span> &lt;&lt; args[<span class="hljs-number">1</span>] &lt;&lt; <span class="hljs-string">"': "</span> &lt;&lt; result.<span class="hljs-built_in">error</span>();
            }
        }
    }
    <span class="hljs-keyword">return</span> {};
}
</code></pre>
<p>do_class_start会去遍历ServiceList，然后去调用StartIfNotDisabled方法。<br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Fcore%2Finit%2Fservice.cpp%23857" target="_blank" title="http://xrefandroid.com/android-15.0.0_r1/xref/system/core/init/service.cpp#857" ref="nofollow noopener noreferrer">/system/core/init/service.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function">Result&lt;<span class="hljs-type">void</span>&gt; <span class="hljs-title">Service::StartIfNotDisabled</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span> (!(flags_ &amp; SVC_DISABLED)) {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Start</span>();
    } <span class="hljs-keyword">else</span> {
        flags_ |= SVC_DISABLED_START;
    }
    <span class="hljs-keyword">return</span> {};
}
</code></pre>
<p>StartIfNotDisabled继续调用了Start方法。<br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Fcore%2Finit%2Fservice.cpp%23586" target="_blank" title="http://xrefandroid.com/android-15.0.0_r1/xref/system/core/init/service.cpp#586" ref="nofollow noopener noreferrer">/system/core/init/service.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function">Result&lt;<span class="hljs-type">void</span>&gt; <span class="hljs-title">Service::Start</span><span class="hljs-params">()</span> </span>{
    ...

    <span class="hljs-type">pid_t</span> pid = <span class="hljs-number">-1</span>;
    <span class="hljs-keyword">if</span> (namespaces_.flags) {
        pid = <span class="hljs-built_in">clone</span>(<span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, namespaces_.flags | SIGCHLD, <span class="hljs-literal">nullptr</span>);
    } <span class="hljs-keyword">else</span> {
        pid = fork();
    }

    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) { <span class="hljs-comment">// 1</span>
        <span class="hljs-built_in">umask</span>(<span class="hljs-number">077</span>);
        cgroups_activated.<span class="hljs-built_in">CloseWriteFd</span>();
        setsid_finished.<span class="hljs-built_in">CloseReadFd</span>();
        <span class="hljs-built_in">RunService</span>(descriptors, std::<span class="hljs-built_in">move</span>(cgroups_activated), std::<span class="hljs-built_in">move</span>(setsid_finished)); <span class="hljs-comment">// 2</span>
        _exit(<span class="hljs-number">127</span>);
    } <span class="hljs-keyword">else</span> {
        cgroups_activated.<span class="hljs-built_in">CloseReadFd</span>();
        setsid_finished.<span class="hljs-built_in">CloseWriteFd</span>();
    }

    ...
}
</code></pre>
<p>在Start方法中, 1处调用了fork函数, fork函数返回pid为0代表是子进程，继续执行2处的RunService。<br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Fcore%2Finit%2Fservice.cpp%23529" target="_blank" title="http://xrefandroid.com/android-15.0.0_r1/xref/system/core/init/service.cpp#529" ref="nofollow noopener noreferrer">/system/core/init/service.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Service::RunService</span><span class="hljs-params">(<span class="hljs-type">const</span> std::vector&lt;Descriptor&gt;&amp; descriptors,
                         InterprocessFifo cgroups_activated, InterprocessFifo setsid_finished)</span> </span>{
    ...

    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">ExpandArgsAndExecv</span>(args_, sigstop_)) {
        <span class="hljs-built_in">PLOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"cannot execv('"</span> &lt;&lt; args_[<span class="hljs-number">0</span>]
                    &lt;&lt; <span class="hljs-string">"'). See the 'Debugging init' section of init's README.md for tips"</span>;
    }
}
</code></pre>
<p>调用了ExpandArgsAndExecv方法，看看它做了什么<br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Fcore%2Finit%2Fservice.cpp%23116" target="_blank" title="http://xrefandroid.com/android-15.0.0_r1/xref/system/core/init/service.cpp#116" ref="nofollow noopener noreferrer">/system/core/init/service.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">ExpandArgsAndExecv</span><span class="hljs-params">(<span class="hljs-type">const</span> std::vector&lt;std::string&gt;&amp; args, <span class="hljs-type">bool</span> sigstop)</span> </span>{
    std::vector&lt;std::string&gt; expanded_args;
    std::vector&lt;<span class="hljs-type">char</span>*&gt; c_strings;

    expanded_args.<span class="hljs-built_in">resize</span>(args.<span class="hljs-built_in">size</span>());
    c_strings.<span class="hljs-built_in">push_back</span>(<span class="hljs-built_in">const_cast</span>&lt;<span class="hljs-type">char</span>*&gt;(args[<span class="hljs-number">0</span>].<span class="hljs-built_in">data</span>()));
    <span class="hljs-keyword">for</span> (std::<span class="hljs-type">size_t</span> i = <span class="hljs-number">1</span>; i &lt; args.<span class="hljs-built_in">size</span>(); ++i) {
        <span class="hljs-keyword">auto</span> expanded_arg = <span class="hljs-built_in">ExpandProps</span>(args[i]);
        <span class="hljs-keyword">if</span> (!expanded_arg.<span class="hljs-built_in">ok</span>()) {
            <span class="hljs-built_in">LOG</span>(FATAL) &lt;&lt; args[<span class="hljs-number">0</span>] &lt;&lt; <span class="hljs-string">": cannot expand arguments': "</span> &lt;&lt; expanded_arg.<span class="hljs-built_in">error</span>();
        }
        expanded_args[i] = *expanded_arg;
        c_strings.<span class="hljs-built_in">push_back</span>(expanded_args[i].<span class="hljs-built_in">data</span>());
    }
    c_strings.<span class="hljs-built_in">push_back</span>(<span class="hljs-literal">nullptr</span>);

    <span class="hljs-keyword">if</span> (sigstop) {
        <span class="hljs-built_in">kill</span>(<span class="hljs-built_in">getpid</span>(), SIGSTOP);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-built_in">execv</span>(c_strings[<span class="hljs-number">0</span>], c_strings.<span class="hljs-built_in">data</span>()) == <span class="hljs-number">0</span>;
}
</code></pre>
<p>这里实际上是调用了execv方法，找到/system/bin/app_process64下的可执行文件，从而启动zygote进程。</p>
<h2 data-id="heading-10">三、总结</h2>
<p>至此就分析完了init进程，每个阶段执行内容：</p>

























<table><thead><tr><th>阶段</th><th>对应文件</th><th>关键任务</th></tr></thead><tbody><tr><td>FirstStageMain</td><td>first_stage_init.cpp</td><td>挂载文件系统、进入 selinux_setup</td></tr><tr><td>SetupSelinux</td><td>selinux.cpp</td><td>加载 SELinux 策略并启用</td></tr><tr><td>SecondStageMain</td><td>init.cpp</td><td>初始化并开启属性服务、加载 rc 文件、启动 Zygote</td></tr></tbody></table>
<p>3个阶段都会去初始化初始化Kernel日志，这样做的好处是可以避免阶段依赖，也就是低耦合，高内聚。</p>
<p>当加载init.rc文件时，在ServiceParser::ParseSection方法中，会把service语句包装成std::unique_ptr，在ServiceParser::EndSection方法中添加到ServiceList，同理on语句也会添加到ActionManager，后面在一个循环中，遍历ActionManager。<br/>
在init_zygotexx.rc文件中，Zygote的class为main，当解析到nonencrypted语句时</p>
<pre><code class="hljs language-rc" lang="rc">on nonencrypted
    class_start main
    class_start late_start
</code></pre>
<p>会执行class_start，它对应的方法是do_class_start，遍历服务serviceList，从而找到对应的服务开启，调用Service::Start 方法，在这个方法中，先fork出子进程，然后执行execv, 会找到对应的可执行性文件app_process，从而启动了Zygote。</p>
<p>最后分享几个看Android系统源码的网站：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcs.android.com%2Fandroid%2Fplatform%2Fsuperproject%2Fmain%2F" target="_blank" title="https://cs.android.com/android/platform/superproject/main/" ref="nofollow noopener noreferrer">cs.android.com/android/pla…</a></li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Faospxref.com%2F" target="_blank" title="http://aospxref.com/" ref="nofollow noopener noreferrer">aospxref.com/</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidos.net.cn%2Fsourcecode" target="_blank" title="https://www.androidos.net.cn/sourcecode" ref="nofollow noopener noreferrer">Android OS 在线源代码 - https://www.androidos.net.cn</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2F" target="_blank" title="https://xrefandroid.com/" ref="nofollow noopener noreferrer">XRefAndroid - Support Android 16.0 &amp; OpenHarmony 6.0 (AndroidXRef/AospXRef)</a></li>
</ul>
<p>感谢阅读，希望本文对你有所帮助，<strong>如有任何不对的地方，欢迎大家指出</strong>。</p>
<h2 data-id="heading-11">四、参考资料</h2>
<p>《Android进阶解密》</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在 Swift 中，参数标签（argument label），用于在调用函数时提高代码的可读性。]]></title>    <link>https://juejin.cn/post/7571786149591171123</link>    <guid>https://juejin.cn/post/7571786149591171123</guid>    <pubDate>2025-11-13T06:51:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571786149591171123" data-draft-id="7571892340877852710" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在 Swift 中，参数标签（argument label），用于在调用函数时提高代码的可读性。"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-13T06:51:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="1024小神"/> <meta itemprop="url" content="https://juejin.cn/user/70007368988926"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在 Swift 中，参数标签（argument label），用于在调用函数时提高代码的可读性。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/70007368988926/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    1024小神
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T06:51:48.000Z" title="Thu Nov 13 2025 06:51:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我的开源项目PakePlus可以将网页/Vue/React项目打包为桌面/手机应用并且小于5M只需几分钟，官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpakeplus.com" target="_blank" title="https://pakeplus.com" ref="nofollow noopener noreferrer">pakeplus.com</a></p><p><img alt="" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/58d2959c31c84cbb8d5159fa8170dee1~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" width="1946" loading="lazy"/></p><p/>
<h3 data-id="heading-0">1. 函数签名分析</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">session</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">session</span>: <span class="hljs-type">ARSession</span>, <span class="hljs-params">didUpdate</span> <span class="hljs-params">frame</span>: <span class="hljs-type">ARFrame</span>)</code></pre>
<ul>
	<li>
	<p><code>func session</code>：方法名</p>
	</li>
	<li>
	<p><code>_ session: ARSession</code>：第一个参数，<code>_</code> 表示调用时省略参数标签</p>
	</li>
	<li>
	<p><code>didUpdate frame: ARFrame</code>：第二个参数，<code>didUpdate</code> 是参数标签，<code>frame</code> 是参数名</p>
	</li>
</ul>
<h3 data-id="heading-1">2. 调用时的区别</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 调用第一个参数（省略标签）</span>
<span class="hljs-built_in">session</span>(someARSession, didUpdate: someARFrame)

<span class="hljs-comment">// 如果没有 didUpdate 标签，调用会是：</span>
<span class="hljs-built_in">session</span>(someARSession, someARFrame) <span class="hljs-comment">// 可读性差</span></code></pre>
<h3 data-id="heading-2">3. <code>didUpdate</code> 的含义</h3>
<ul>
	<li>
	<p><strong>字面意思</strong>："已经更新了"</p>
	</li>
	<li>
	<p><strong>语义作用</strong>：表明这个参数代表的是"被更新的帧"</p>
	</li>
	<li>
	<p><strong>代码可读性</strong>：让调用代码读起来像自然语言</p>
	</li>
</ul>
<h3 data-id="heading-3">4. 类似的例子</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 其他常见的参数标签</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">tableView</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">tableView</span>: <span class="hljs-type">UITableView</span>, <span class="hljs-params">didSelectRowAt</span> <span class="hljs-params">indexPath</span>: <span class="hljs-type">IndexPath</span>)
<span class="hljs-keyword">func</span> <span class="hljs-title function_">textField</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">textField</span>: <span class="hljs-type">UITextField</span>, <span class="hljs-params">shouldChangeCharactersIn</span> <span class="hljs-params">range</span>: <span class="hljs-type">NSRange</span>)</code></pre>
<h3 data-id="heading-4">总结</h3>
<p><code>didUpdate</code> 是一个<strong>参数标签</strong>，它的作用是：</p>
<ul>
	<li>
	<p>提高代码可读性</p>
	</li>
	<li>
	<p>明确参数的含义（表示这是一个被更新的帧）</p>
	</li>
	<li>
	<p>遵循 Swift 的 API 设计惯例</p>
	</li>
</ul>
<p>在方法内部，你使用参数名 <code>frame</code> 来访问这个值，而在调用时使用 <code>didUpdate</code> 标签来使代码更加清晰</p>
<p/>
<p>Swift 使用参数标签的设计是为了<strong>解决多个问题</strong>，而不仅仅是技术必要性。</p>
<h2 data-id="heading-5">主要原因：</h2>
<h3 data-id="heading-6">1. 提高代码可读性</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 有标签 - 读起来像自然语言</span>
<span class="hljs-built_in">session</span>(someSession, didUpdate: currentFrame)

<span class="hljs-comment">// 无标签 - 含义不明确</span>
<span class="hljs-built_in">session</span>(someSession, currentFrame) <span class="hljs-comment">// 这个 currentFrame 是什么？</span></code></pre>
<h3 data-id="heading-7">2. 区分多个参数</h3>
<p>当方法有多个参数时，标签尤为重要：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 清晰明确</span>
<span class="hljs-selector-tag">func</span> <span class="hljs-selector-tag">calculateArea</span>(of <span class="hljs-attribute">shape</span>: String, <span class="hljs-attribute">width</span>: Double, <span class="hljs-attribute">height</span>: Double)

<span class="hljs-selector-tag">calculateArea</span>(<span class="hljs-attribute">of</span>: <span class="hljs-string">"rectangle"</span>, <span class="hljs-attribute">width</span>: <span class="hljs-number">10</span>, <span class="hljs-attribute">height</span>: <span class="hljs-number">5</span>)

<span class="hljs-comment">// 对比：没有标签会很混乱</span>
<span class="hljs-selector-tag">calculateArea</span>(<span class="hljs-string">"rectangle"</span>, <span class="hljs-number">10</span>, <span class="hljs-number">5</span>) <span class="hljs-comment">// 10 和 5 分别代表什么？</span></code></pre>
<h3 data-id="heading-8">3. 遵循 Swift API 设计准则</h3>
<p>Swift 鼓励编写"自文档化"的代码：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// Swift 风格 - 可读性强</span>
<span class="hljs-selector-tag">x</span><span class="hljs-selector-class">.addSubview</span>(y)
<span class="hljs-selector-tag">button</span><span class="hljs-selector-class">.setTitle</span>(<span class="hljs-string">"Hello"</span>, <span class="hljs-attribute">for</span>: .normal)

<span class="hljs-comment">// 对比其他语言 - 可读性较差</span>
<span class="hljs-selector-tag">x</span><span class="hljs-selector-class">.add</span>(y)
<span class="hljs-selector-tag">button</span><span class="hljs-selector-class">.setTitle</span>(<span class="hljs-string">"Hello"</span>, .normal)</code></pre>
<h3 data-id="heading-9">4. 方法重载时的清晰度</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">move</span>(<span class="hljs-params">to</span> <span class="hljs-params">position</span>: <span class="hljs-type">CGPoint</span>)
<span class="hljs-keyword">func</span> <span class="hljs-title function_">move</span>(<span class="hljs-params">by</span> <span class="hljs-params">delta</span>: <span class="hljs-type">CGVector</span>)
<span class="hljs-keyword">func</span> <span class="hljs-title function_">move</span>(<span class="hljs-params">towards</span> <span class="hljs-params">direction</span>: <span class="hljs-type">Direction</span>)

<span class="hljs-comment">// 调用时非常清晰</span>
move(to: targetPosition)
move(by: movementVector) 
move(towards: .north)</code></pre>
<h2 data-id="heading-10">在你的具体例子中：</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 当前设计：</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">session</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">session</span>: <span class="hljs-type">ARSession</span>, <span class="hljs-params">didUpdate</span> <span class="hljs-params">frame</span>: <span class="hljs-type">ARFrame</span>)

<span class="hljs-comment">// 如果去掉标签：</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">session</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">session</span>: <span class="hljs-type">ARSession</span>, <span class="hljs-params">frame</span>: <span class="hljs-type">ARFrame</span>)

<span class="hljs-comment">// 调用时：</span>
session(someSession, frame: someFrame) <span class="hljs-comment">// 含义不明确 - 是要设置帧？还是帧更新了？</span></code></pre>
<h2 data-id="heading-11">技术上的等价性</h2>
<p>实际上，你可以这样写：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 方式1：使用不同标签和参数名</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">session</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">session</span>: <span class="hljs-type">ARSession</span>, <span class="hljs-params">didUpdate</span> <span class="hljs-params">frame</span>: <span class="hljs-type">ARFrame</span>)

<span class="hljs-comment">// 方式2：标签和参数名相同</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">session</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">session</span>: <span class="hljs-type">ARSession</span>, <span class="hljs-params">frame</span>: <span class="hljs-type">ARFrame</span>)

<span class="hljs-comment">// 方式3：省略标签（不推荐）</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">session</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">session</span>: <span class="hljs-type">ARSession</span>, <span class="hljs-keyword">_</span> <span class="hljs-params">frame</span>: <span class="hljs-type">ARFrame</span>)</code></pre>
<p/>
大家好，我是1024小神，技术群 / 私活群 / 股票群 或 交朋友 都可以私信我。
如果你觉得本文有用，一键三连 (点赞、评论、关注)，就是对我最大的支持~</div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringAI 整合MCP实现联网搜索 (基于tavily)]]></title>    <link>https://juejin.cn/post/7571722835658883106</link>    <guid>https://juejin.cn/post/7571722835658883106</guid>    <pubDate>2025-11-13T06:25:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571722835658883106" data-draft-id="7571395183943745545" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringAI 整合MCP实现联网搜索 (基于tavily)"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-11-13T06:25:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="l0sgAi"/> <meta itemprop="url" content="https://juejin.cn/user/328089396327643"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringAI 整合MCP实现联网搜索 (基于tavily)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/328089396327643/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    l0sgAi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T06:25:32.000Z" title="Thu Nov 13 2025 06:25:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">使用SpringAI执行联网搜索</h2>
<p><em>本文属于我的<code>AI</code>应用学习笔记的一部分，更多内容请见：<a href="https://juejin.cn/column/7510247527553105971" target="_blank" title="https://juejin.cn/column/7510247527553105971">我的专栏</a></em></p>
<blockquote>
<p>文档参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.spring.io%2Fspring-ai%2Freference%2Fapi%2Fmcp%2Fmcp-client-boot-starter-docs.html" target="_blank" title="https://docs.spring.io/spring-ai/reference/api/mcp/mcp-client-boot-starter-docs.html" ref="nofollow noopener noreferrer">SpringAI-MCP</a></p>
<p><strong>MCP即模型上下文协议</strong>，是一种由<code>Anthropic</code>推出的开放标准，旨在统一大型语言模型（<code>LLM</code>）与外部数据源和工具之间的通信协议。它的主要目的是解决AI模型因数据孤岛限制而无法充分发挥潜力的问题，使得<code>AI</code>应用能够安全地访问和操作本地及远程数据。<code>MCP</code>就像AI世界的“<code>USB-C</code>接口”，提供了一种标准化的方法，将<code>AI</code>模型连接到各种数据源和工具，从而提高<code>AI</code>系统的可靠性和效率，通过一个统一规范的接口，就可以让大模型访问外部的工具，并执行各种智能化操作，比如帮忙回邮件、填表单等。</p>
</blockquote>
<p><strong>注意：使用SpringAI进行开发需要JDK17+，这里使用的是JDK21。</strong></p>
<p><code>SpringAI</code>是一个主流的<code>Java</code>大模型开发框架，可以简化我们的<code>AI</code>应用开发，本文将将初步介绍使用<code>SpringAI</code>集成<code>tavily</code>搜索服务，利用<code>MCP</code>实现联网搜索的方法。</p>
<p><strong>完整项目地址:<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fl0sgAi%2Fai-chat-demo" target="_blank" title="https://github.com/l0sgAi/ai-chat-demo" ref="nofollow noopener noreferrer">ai-chat-demo</a></strong></p>
<p>其中，<code>mcp-server</code>分支为本文搭建的<code>mcp</code>服务，<code>main</code>分支为<code>mcp</code>客户端应用</p>
<h4 data-id="heading-1">阅读本文前应该有的知识基础</h4>
<ul>
<li>Java基础</li>
<li>Java Web基础</li>
<li>数据库基础</li>
<li>包管理 (Maven、gradle等)</li>
<li>Spring基础、SSM整合、SpringBoot等</li>
<li>SpringAI基础，参考<a href="https://juejin.cn/column/7510247527553105971" target="_blank" title="https://juejin.cn/column/7510247527553105971">我的专栏</a>之前的文章，了解如何搭建SpringAI基础应用</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca7b0b607ffe4a9f9e1305f09f5eae29~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbDBzZ0Fp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763620849&amp;x-signature=deFjD%2Fd9qqJlKNy3vr%2FNA%2Bzqs7s%3D" alt="mcp-struct" loading="lazy"/></p>
<p><code>SpringAI</code>官方提供的架构图如上，我们的应用即<code>MCP Client</code>，调用<code>MCP Server</code>的搜索服务，即我们接下来要同时开发服务端和客户端。</p>
<hr/>
<blockquote>
<p>你可以选择任何你想用的搜索服务，并自行进行<code>MCP Server</code>开发，这里用的是<code>tavily</code></p>
</blockquote>
<h6 data-id="heading-2">1. 获取API KEY</h6>
<p>首先访问官网官方<code>API</code>平台(没有注册先登录注册)：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fapp.tavily.com%2Fhome" target="_blank" title="https://app.tavily.com/home" ref="nofollow noopener noreferrer">tavily-home</a></p>
<p>然后点击复制API KEY，接下来要用到，如下图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e03fec72b2464193acf65a67b502b179~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbDBzZ0Fp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763620849&amp;x-signature=Lr%2BsdXIfimgZf311a2e29SjUE8s%3D" alt="image.png" loading="lazy"/></p>
<h6 data-id="heading-3">2.搭建MCP-Server</h6>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fl0sgAi%2Fai-chat-demo%2Ftree%2Fmcp-server" target="_blank" title="https://github.com/l0sgAi/ai-chat-demo/tree/mcp-server" ref="nofollow noopener noreferrer">MCP-Server源代码仓库</a></p>
<p><strong>2.1 准备工作</strong></p>
<p>首先，引入<code>Maven</code>依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-starter-mcp-server-webmvc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.0-RC1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>然后，根据官方文档写配置文件：</p>
<pre><code class="hljs language-yml" lang="yml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">mcp-server</span>
  <span class="hljs-attr">ai:</span>
    <span class="hljs-attr">mcp:</span>
      <span class="hljs-attr">server:</span>
        <span class="hljs-attr">version:</span> <span class="hljs-number">1.0</span><span class="hljs-number">.0</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">mcp-server</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">ASYNC</span>
        <span class="hljs-attr">instructions:</span> <span class="hljs-string">"This server provides internet information tools and resources"</span>
        <span class="hljs-attr">sse-message-endpoint:</span> <span class="hljs-string">/mcp/search/sse</span>
        <span class="hljs-attr">capabilities:</span>
            <span class="hljs-attr">tool:</span> <span class="hljs-literal">true</span>
            <span class="hljs-attr">resource:</span> <span class="hljs-literal">true</span>
            <span class="hljs-attr">prompt:</span> <span class="hljs-literal">true</span>
            <span class="hljs-attr">completion:</span> <span class="hljs-literal">true</span>

<span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8577</span>
</code></pre>
<p>之后，编写控制器接口<code>SSE</code>，需要暴露一个端口以供消息推流，否则客户端启动报错。</p>
<p><code>SSE</code>管理器：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 统一处理sse连接
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SseEmitterManager</span> {
    <span class="hljs-comment">// 支持的同时在线人数=SESSION_LIMIT-1 有一个监控sse</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SESSION_LIMIT</span> <span class="hljs-operator">=</span> <span class="hljs-number">1001</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, SseEmitter&gt; emitterMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-comment">/**
     * 将对话请求加入队列
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">addEmitter</span><span class="hljs-params">(String sessionId, SseEmitter emitter)</span> {
        <span class="hljs-keyword">if</span> (emitterMap.size() &lt; SESSION_LIMIT) {
            emitterMap.put(sessionId, emitter);
            <span class="hljs-comment">// 推流当前线程数</span>
            <span class="hljs-built_in">this</span>.notifyThreadCount();
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">/**
     * 获取Map中的sse连接
     */</span>
    <span class="hljs-keyword">public</span> SseEmitter <span class="hljs-title function_">getEmitter</span><span class="hljs-params">(String sessionId)</span> {
        <span class="hljs-keyword">return</span> emitterMap.get(sessionId);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeEmitter</span><span class="hljs-params">(String sessionId)</span> {
        emitterMap.remove(sessionId);
        <span class="hljs-comment">// 推流当前线程数</span>
        <span class="hljs-built_in">this</span>.notifyThreadCount();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isOverLoad</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> emitterMap.size() &gt;= SESSION_LIMIT;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getEmitterCount</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> emitterMap.size();
    }
    
    <span class="hljs-comment">/**
     * 获取线程监控实例
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addThreadMonitor</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 添加一个线程监控</span>
        emitterMap.put(<span class="hljs-string">"thread-monitor"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SseEmitter</span>(<span class="hljs-number">0L</span>));
    }

    <span class="hljs-comment">/**
     * 手动发送消息，通知当前占用的线程数
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyThreadCount</span><span class="hljs-params">()</span> {
        <span class="hljs-type">SseEmitter</span> <span class="hljs-variable">sseEmitter</span> <span class="hljs-operator">=</span> emitterMap.get(<span class="hljs-string">"thread-monitor"</span>);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (emitterMap.containsKey(<span class="hljs-string">"thread-monitor"</span>)) {
                sseEmitter.send(<span class="hljs-built_in">this</span>.getEmitterCount());
            }<span class="hljs-keyword">else</span> {
                addThreadMonitor();
                sseEmitter = emitterMap.get(<span class="hljs-string">"thread-monitor"</span>);
                sseEmitter.send(<span class="hljs-built_in">this</span>.getEmitterCount());
            }
        } <span class="hljs-keyword">catch</span> (IOException e) {
            sseEmitter.completeWithError(e);
            emitterMap.remove(<span class="hljs-string">"thread-monitor"</span>); <span class="hljs-comment">// 清除失效连接</span>
        }
    }

    <span class="hljs-comment">/**
     * 将sse连接全部关闭
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">closeAll</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">for</span> (SseEmitter emitter : emitterMap.values()) {
            emitter.complete();
        }
        emitterMap.clear();
    }

}
</code></pre>
<p><code>Web</code>控制器:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-meta">@RequestMapping("/mcp/search")</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">McpController</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SseEmitterManager sseEmitterManager;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_EMITTER_ID</span> <span class="hljs-operator">=</span> <span class="hljs-string">"search-emitter"</span>;

    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 添加一个线程监控</span>
        sseEmitterManager.addThreadMonitor();
        <span class="hljs-comment">// 添加一个默认的 SSE 监听器</span>
        <span class="hljs-comment">// 注册 emitter</span>
        <span class="hljs-type">SseEmitter</span> <span class="hljs-variable">emitter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SseEmitter</span>(<span class="hljs-number">0L</span>); <span class="hljs-comment">// 永不超时</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">emitterId</span> <span class="hljs-operator">=</span> DEFAULT_EMITTER_ID; <span class="hljs-comment">// 或生成唯一ID</span>

        emitter.onCompletion(() -&gt; {
            log.info(<span class="hljs-string">"MCP SSE 连接完成"</span>);
            sseEmitterManager.removeEmitter(emitterId);
        });

        emitter.onTimeout(() -&gt; {
            log.warn(<span class="hljs-string">"MCP SSE 连接超时"</span>);
            sseEmitterManager.removeEmitter(emitterId);
        });

        emitter.onError(e -&gt; {
            log.error(<span class="hljs-string">"MCP SSE 连接错误"</span>, e);
            sseEmitterManager.removeEmitter(emitterId);
        });

        sseEmitterManager.addEmitter(emitterId, emitter);
    }

    <span class="hljs-comment">// 仅用于 SSE 通道建立</span>
    <span class="hljs-meta">@GetMapping("/sse")</span>
    <span class="hljs-keyword">public</span> SseEmitter <span class="hljs-title function_">connect</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 这里不处理query，因为客户端首次连接只是建立会话</span>
        <span class="hljs-type">SseEmitter</span> <span class="hljs-variable">emitter</span> <span class="hljs-operator">=</span> sseEmitterManager.getEmitter(DEFAULT_EMITTER_ID);
        <span class="hljs-keyword">if</span> (emitter == <span class="hljs-literal">null</span>) {
            log.warn(<span class="hljs-string">"MCP SSE 监听器未注册"</span>);
            sseEmitterManager.addEmitter(DEFAULT_EMITTER_ID, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SseEmitter</span>(<span class="hljs-number">0L</span>));
        }
        <span class="hljs-keyword">return</span> sseEmitterManager.getEmitter(DEFAULT_EMITTER_ID);
    }

}
</code></pre>
<p><strong>2.2 编写检索服务</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SearchServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SearchService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> WebClient webClient;

<span class="hljs-comment">//    private final SseEmitterManager sseEmitterManager;</span>

    <span class="hljs-comment">// 这里使用自己的tavily API KEY</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">baseUrl</span> <span class="hljs-operator">=</span> <span class="hljs-string">"https://api.tavily.com"</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">bearerToken</span> <span class="hljs-operator">=</span> <span class="hljs-string">"tvly-dev-***"</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SearchServiceImpl</span><span class="hljs-params">(
            SseEmitterManager sseEmitterManager)</span> {
<span class="hljs-comment">//        this.sseEmitterManager = sseEmitterManager;</span>
        <span class="hljs-built_in">this</span>.webClient = WebClient.builder()
                .baseUrl(baseUrl)
                .build();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Tool(name = "webSearch", description = "Searching information from the internet")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">search</span><span class="hljs-params">(
            <span class="hljs-meta">@ToolParam(description = "搜索关键词")</span>
            String query)</span> {

        <span class="hljs-keyword">if</span> (StrUtil.isBlank(query)) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"none"</span>;
        }

        <span class="hljs-comment">// 构建请求体</span>
        <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>();
        req.setQuery(query);
        req.setTopic(<span class="hljs-string">"general"</span>);
        req.setSearchDepth(<span class="hljs-string">"basic"</span>);
        req.setChunksPerSource(<span class="hljs-number">3</span>);
        req.setMaxResults(<span class="hljs-number">5</span>);
        req.setTimeRange(<span class="hljs-literal">null</span>);
        req.setDays(<span class="hljs-number">3</span>);
        req.setIncludeAnswer(<span class="hljs-literal">true</span>);
        req.setIncludeRawContent(<span class="hljs-literal">false</span>);
        req.setIncludeImages(<span class="hljs-literal">false</span>);
        req.setIncludeImageDescriptions(<span class="hljs-literal">false</span>);
        req.setIncludeDomains(Collections.emptyList());
        req.setExcludeDomains(Collections.emptyList());

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 发送请求并等待响应（同步风格）</span>
            <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">resp</span> <span class="hljs-operator">=</span> webClient.post()
                    .uri(<span class="hljs-string">"/search"</span>)
                    .header(<span class="hljs-string">"Authorization"</span>, <span class="hljs-string">"Bearer "</span> + bearerToken)
                    .header(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"application/json"</span>)
                    .bodyValue(req)
                    .retrieve()
                    .onStatus(status -&gt; status.is4xxClientError() || status.is5xxServerError(),
                            ClientResponse::createException)
                    .bodyToMono(SearchResponse.class)
                    .block(Duration.ofSeconds(<span class="hljs-number">15</span>)); <span class="hljs-comment">// 超时时间可调整</span>

            <span class="hljs-keyword">if</span> (resp == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">"No results returned."</span>;
            }

            <span class="hljs-comment">// 构建输出文本</span>
            <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
            out.append(<span class="hljs-string">"Query: "</span>).append(resp.getQuery()).append(<span class="hljs-string">"\n\n"</span>);

            <span class="hljs-keyword">if</span> (resp.getAnswer() != <span class="hljs-literal">null</span> &amp;&amp; !resp.getAnswer().isBlank()) {
                out.append(<span class="hljs-string">"Answer (summary):\n"</span>).append(resp.getAnswer()).append(<span class="hljs-string">"\n\n"</span>);
            }

            List&lt;SearchResult&gt; results = resp.getResults();
            <span class="hljs-keyword">if</span> (results == <span class="hljs-literal">null</span> || results.isEmpty()) {
                out.append(<span class="hljs-string">"No results returned."</span>);
            } <span class="hljs-keyword">else</span> {
                out.append(<span class="hljs-string">"Top results:\n"</span>);
                <span class="hljs-type">int</span> <span class="hljs-variable">idx</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
                <span class="hljs-keyword">for</span> (SearchResult r : results.stream().limit(<span class="hljs-number">5</span>).toList()) {
                    out.append(idx++).append(<span class="hljs-string">". "</span>).append(safe(r.getTitle())).append(<span class="hljs-string">"\n"</span>);
                    out.append(<span class="hljs-string">" URL: "</span>).append(safe(r.getUrl())).append(<span class="hljs-string">"\n"</span>);
                    <span class="hljs-keyword">if</span> (r.getContent() != <span class="hljs-literal">null</span> &amp;&amp; !r.getContent().isBlank()) {
                        <span class="hljs-comment">// 截断content到合理长度以免返回过长文本</span>
                        <span class="hljs-type">String</span> <span class="hljs-variable">snip</span> <span class="hljs-operator">=</span> r.getContent().length() &gt; <span class="hljs-number">400</span> ? r.getContent().substring(<span class="hljs-number">0</span>, <span class="hljs-number">400</span>) + <span class="hljs-string">"..."</span> : r.getContent();
                        out.append(<span class="hljs-string">" Snippet: "</span>).append(snip).append(<span class="hljs-string">"\n"</span>);
                    }
                    out.append(<span class="hljs-string">" Score: "</span>).append(r.getScore()).append(<span class="hljs-string">"\n\n"</span>);
                }
            }

            out.append(<span class="hljs-string">"API response_time: "</span>).append(safe(resp.getResponseTime())).append(<span class="hljs-string">"s"</span>);
            <span class="hljs-comment">// 发送结果</span>
<span class="hljs-comment">//            sseEmitterManager.getEmitter(DEFAULT_EMITTER_ID).send(out.toString(), MediaType.TEXT_PLAIN);</span>
            <span class="hljs-keyword">return</span> out.toString();
        } <span class="hljs-keyword">catch</span> (Exception ex) {
            log.error(<span class="hljs-string">"搜索服务错误: "</span>, ex);
            <span class="hljs-keyword">return</span> <span class="hljs-string">"Error: "</span> + ex.getMessage();
        }
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">safe</span><span class="hljs-params">(String s)</span> {
        <span class="hljs-keyword">return</span> s == <span class="hljs-literal">null</span> ? <span class="hljs-string">""</span> : s;
    }

    <span class="hljs-meta">@Setter</span>
    <span class="hljs-meta">@Getter</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SearchRequest</span> {
        <span class="hljs-comment">// getters / setters</span>
        <span class="hljs-keyword">private</span> String query;
        <span class="hljs-keyword">private</span> String topic;
        <span class="hljs-meta">@JsonProperty("search_depth")</span>
        <span class="hljs-keyword">private</span> String searchDepth;
        <span class="hljs-meta">@JsonProperty("chunks_per_source")</span>
        <span class="hljs-keyword">private</span> Integer chunksPerSource;
        <span class="hljs-meta">@JsonProperty("max_results")</span>
        <span class="hljs-keyword">private</span> Integer maxResults;
        <span class="hljs-meta">@JsonProperty("time_range")</span>
        <span class="hljs-keyword">private</span> Object timeRange;
        <span class="hljs-keyword">private</span> Integer days;
        <span class="hljs-meta">@JsonProperty("include_answer")</span>
        <span class="hljs-keyword">private</span> Boolean includeAnswer;
        <span class="hljs-meta">@JsonProperty("include_raw_content")</span>
        <span class="hljs-keyword">private</span> Boolean includeRawContent;
        <span class="hljs-meta">@JsonProperty("include_images")</span>
        <span class="hljs-keyword">private</span> Boolean includeImages;
        <span class="hljs-meta">@JsonProperty("include_image_descriptions")</span>
        <span class="hljs-keyword">private</span> Boolean includeImageDescriptions;
        <span class="hljs-meta">@JsonProperty("include_domains")</span>
        <span class="hljs-keyword">private</span> List&lt;String&gt; includeDomains;
        <span class="hljs-meta">@JsonProperty("exclude_domains")</span>
        <span class="hljs-keyword">private</span> List&lt;String&gt; excludeDomains;

    }

    <span class="hljs-meta">@Setter</span>
    <span class="hljs-meta">@Getter</span>
    <span class="hljs-meta">@JsonIgnoreProperties(ignoreUnknown = true)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SearchResponse</span> {
        <span class="hljs-comment">// getters / setters</span>
        <span class="hljs-keyword">private</span> String query;
        <span class="hljs-keyword">private</span> String answer;
        <span class="hljs-keyword">private</span> List&lt;String&gt; images;
        <span class="hljs-keyword">private</span> List&lt;SearchResult&gt; results;
        <span class="hljs-meta">@JsonProperty("response_time")</span>
        <span class="hljs-keyword">private</span> String responseTime;

    }

    <span class="hljs-meta">@Setter</span>
    <span class="hljs-meta">@Getter</span>
    <span class="hljs-meta">@JsonIgnoreProperties(ignoreUnknown = true)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SearchResult</span> {
        <span class="hljs-comment">// getters / setters</span>
        <span class="hljs-keyword">private</span> String title;
        <span class="hljs-keyword">private</span> String url;
        <span class="hljs-keyword">private</span> String content;
        <span class="hljs-keyword">private</span> Double score;
        <span class="hljs-meta">@JsonProperty("raw_content")</span>
        <span class="hljs-keyword">private</span> String rawContent;
    }

}
</code></pre>
<p><strong>2.3 在启动类中声明回调工具方法</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AiApplication</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(AiApplication.class, args);
    }

    <span class="hljs-comment">// 自动配置将自动将工具回调注册为 MCP 工具。</span>
    <span class="hljs-comment">// 您可以有多个 Bean 生成 ToolCallbacks。自动配置将合并它们。</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> ToolCallbackProvider <span class="hljs-title function_">searchTools</span><span class="hljs-params">(SearchService searchService)</span> {
        <span class="hljs-keyword">return</span> MethodToolCallbackProvider.builder().toolObjects(searchService).build();
    }

}
</code></pre>
<p>到此，我们完成了一个可以供<code>SpringAI MCP</code>客户端调用的<code>MCP Server</code>，你也可以在这个应用的基础上添加其它模块以丰富应用功能。</p>
<h6 data-id="heading-4">3.配置MCP-Client</h6>
<p><strong>注意：不同的模型工具调用能力不同，百炼平台的一些模型在流式输出调用<code>MCP</code>工具的时候会报错，目前经过测试，在百炼平台工具上<code>MCP</code>工具调用能力较强的模型<code>ID</code>有:</strong></p>
<ul>
<li><code>qwen-turbo-latest</code></li>
<li><code>qwen3-max</code></li>
<li><code>qwen3-235b-a22b-thinking-2507</code></li>
<li><code>qwen-plus-latest</code></li>
</ul>
<p>而下列模型在使用过程中出现不同程度的错误：</p>
<ul>
<li><code>qwen3-235b-a22b-instruct-2507</code>如果使用<code>.stream()</code>流式输出，会在调用过程中报错<code>null or empty toolName</code>，而直接使用<code>.call()</code>则不会</li>
<li><code>DeepSeek</code>系列无法调用<code>MCP Server</code>的工具</li>
</ul>
<p>以上结论在版本<code>SpringAI 1.1.0-RC1</code>测试得出，目前不确定是<code>SpringAI</code>的问题还是模型本身的问题</p>
<hr/>
<p><strong>3.1 准备工作</strong></p>
<p>引入Maven依赖</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-starter-mcp-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.0-RC1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>编写配置文件</p>
<pre><code class="hljs language-yml" lang="yml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">ai:</span>
    <span class="hljs-attr">mcp:</span>
      <span class="hljs-attr">client:</span>
        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">chat-client</span>
        <span class="hljs-attr">version:</span> <span class="hljs-number">1.0</span><span class="hljs-number">.0</span>
        <span class="hljs-attr">request-timeout:</span> <span class="hljs-string">120s</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">ASYNC</span> <span class="hljs-comment"># 类型同步SYNC或者异步ASYNC</span>
        <span class="hljs-attr">sse:</span>
          <span class="hljs-attr">connections:</span>
            <span class="hljs-attr">search:</span>
              <span class="hljs-attr">url:</span> <span class="hljs-string">http://localhost:8577/mcp/search/</span>
</code></pre>
<p><strong>3.2 测试</strong></p>
<p>编写测试类</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@SpringBootTest</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringAITests</span> {

    <span class="hljs-comment">// 自动注入的toolCallbackProvider</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> AsyncMcpToolCallbackProvider toolCallbackProvider;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">springAIStreamChatWithMemoClient</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {

        <span class="hljs-comment">// 计时器</span>
        <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">countDownLatch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">1</span>);

        <span class="hljs-type">OpenAiApi</span> <span class="hljs-variable">openAiApi</span> <span class="hljs-operator">=</span> OpenAiApi.builder()
                <span class="hljs-comment">// 百炼平台 API KEY</span>
                .apiKey(<span class="hljs-string">"sk-***"</span>)
                .baseUrl(<span class="hljs-string">"https://dashscope.aliyuncs.com/compatible-mode/v1"</span>)
                .completionsPath(<span class="hljs-string">"/chat/completions"</span>)
                .build();

        <span class="hljs-type">OpenAiChatOptions</span> <span class="hljs-variable">chatOptions</span> <span class="hljs-operator">=</span> OpenAiChatOptions.builder()
                .maxTokens(<span class="hljs-number">2048</span>)
                .temperature(<span class="hljs-number">0.85</span>)
                .topP(<span class="hljs-number">0.9</span>)
                .model(<span class="hljs-string">"qwen3-max"</span>)
                .streamUsage(<span class="hljs-literal">true</span>)
                .build();

        <span class="hljs-type">ChatModel</span> <span class="hljs-variable">chatModel</span> <span class="hljs-operator">=</span> OpenAiChatModel.builder()
                .openAiApi(openAiApi)
                .defaultOptions(chatOptions)
                .build();

        <span class="hljs-type">ChatClient</span> <span class="hljs-variable">chatClient</span> <span class="hljs-operator">=</span> ChatClient.builder(chatModel)
                <span class="hljs-comment">// 默认工具调用</span>
                .defaultTools(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTimeTools</span>())
                <span class="hljs-comment">// 默认系统提示词</span>
                .defaultSystem(<span class="hljs-string">"你是一个由losgai开发的、友善的AI助手，请保持你的语气平和、耐心、礼貌。"</span>)
                .build();

        ToolCallback[] toolCallbacks = toolCallbackProvider.getToolCallbacks();

        <span class="hljs-comment">// 反应式对话流</span>
        Flux&lt;ChatResponse&gt; responseFlux = chatClient.prompt()
                .user(<span class="hljs-string">"帮我搜索英雄联盟S15世界赛结果"</span>)
                .toolCallbacks(toolCallbacks)
                .stream()
                .chatResponse();

        <span class="hljs-comment">// 用于跟踪最后一个 ChatResponse</span>
        AtomicReference&lt;ChatResponse&gt; lastResponse = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicReference</span>&lt;&gt;();

        <span class="hljs-comment">// 订阅 Flux 实现流式输出（控制台输出或 SSE 推送）</span>
        <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();
        responseFlux.subscribe(
                token -&gt; {
                    <span class="hljs-comment">// 获取当前输出内容片段</span>
                    <span class="hljs-keyword">if</span>(token.getResult()!=<span class="hljs-literal">null</span>){
                        log.info(<span class="hljs-string">"输出内容:{}"</span>, token.getResult().getOutput().getText());
                        res.append(token.getResult().getOutput().getText());
                    }
                    <span class="hljs-comment">// 更新最后一个响应</span>
                    lastResponse.set(token);
                },
                <span class="hljs-comment">// 反应式流在报错时会直接中断</span>
                error -&gt; {
                    log.error(<span class="hljs-string">"出错："</span>, error);
                    <span class="hljs-comment">// 错误，停止倒计时</span>
                    countDownLatch.countDown();
                }, <span class="hljs-comment">// 错误处理</span>
                () -&gt; {<span class="hljs-comment">// 流结束</span>
                    log.info(<span class="hljs-string">"\n回答完毕！"</span>);
                    <span class="hljs-comment">// 从最后一个响应中获取 Token 使用信息</span>
                    <span class="hljs-type">ChatResponse</span> <span class="hljs-variable">chatResponse</span> <span class="hljs-operator">=</span> lastResponse.get();
                    <span class="hljs-keyword">if</span> (chatResponse != <span class="hljs-literal">null</span>) {
                        <span class="hljs-type">Usage</span> <span class="hljs-variable">usage</span> <span class="hljs-operator">=</span> chatResponse.getMetadata().getUsage();
                        log.info(<span class="hljs-string">"===== Token 使用统计 ====="</span>);
                        log.info(<span class="hljs-string">"输入 Token 数（Prompt Tokens）: {}"</span>, usage.getPromptTokens());
                        log.info(<span class="hljs-string">"输出 Token 数（Completion Tokens）: {}"</span>, usage.getCompletionTokens());
                        log.info(<span class="hljs-string">"总 Token 数（Total Tokens）: {}"</span>, usage.getTotalTokens());
                        log.info(<span class="hljs-string">"回复汇总：\n{}"</span>, res);
                    } <span class="hljs-keyword">else</span> {
                        log.warn(<span class="hljs-string">"未获取到 Token 使用信息，可能模型未返回或配置未启用"</span>);
                    }
                    countDownLatch.countDown();
                });

        <span class="hljs-comment">// 阻塞主线程最多60s 等待结果</span>
        countDownLatch.await(<span class="hljs-number">60</span>, TimeUnit.SECONDS);
    }
}
</code></pre>
<p>测试结果</p>
<pre><code class="hljs language-md" lang="md">com.losgai.ai.SpringAITests              : ===== Token 使用统计 =====
com.losgai.ai.SpringAITests              : 输入 Token 数（Prompt Tokens）: 2167
com.losgai.ai.SpringAITests              : 输出 Token 数（Completion Tokens）: 261
com.losgai.ai.SpringAITests              : 总 Token 数（Total Tokens）: 2428
com.losgai.ai.SpringAITests              : 回复汇总：
根据搜索结果，<span class="hljs-strong">**英雄联盟S15全球总决赛**</span>已于2025年11月在成都举行，最终结果如下：

<span class="hljs-bullet">-</span> <span class="hljs-strong">**冠军**</span>：<span class="hljs-strong">**T1战队**</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**亚军**</span>：<span class="hljs-strong">**KT战队**</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**决赛比分**</span>：<span class="hljs-strong">**T1 3:2 KT**</span>

<span class="hljs-section">### 关键亮点：</span>
<span class="hljs-bullet">1.</span> <span class="hljs-strong">**T1战队成功实现三连冠**</span>（S13、S14、S15），成为英雄联盟历史上首支达成此成就的战队。
<span class="hljs-bullet">2.</span> <span class="hljs-strong">**Faker（李相赫）斩获个人第六个世界赛冠军**</span>，进一步巩固其“传奇中单”的地位。
<span class="hljs-bullet">3.</span> <span class="hljs-strong">**FMVP（总决赛最有价值选手）**</span>：<span class="hljs-strong">**Gumayusi**</span>（T1下路选手）。

比赛过程非常激烈，双方打满五局，最终T1在决胜局中凭借出色的团队配合和战术执行拿下胜利。这场决赛不仅展现了LCK赛区的强大实力，也为全球观众奉献了一场精彩绝伦的对决！ 🏆

如果需要更多细节（如每局比赛的BP或关键操作），可以告诉我！
</code></pre>
<p>当然，我们还可以自定义增强工具调用阶段的逻辑，例如下面的<code>CustomMcpToolCallbackProvider.java</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 自定义MCP工具回调提供器，添加日志功能
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Primary</span>
<span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomMcpToolCallbackProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AsyncMcpToolCallbackProvider</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AsyncMcpToolCallbackProvider delegate;

    <span class="hljs-meta">@NotNull</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> ToolCallback[] getToolCallbacks() {
        ToolCallback[] originalCallbacks = delegate.getToolCallbacks();

        <span class="hljs-keyword">if</span> (originalCallbacks.length == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> originalCallbacks;
        }

        <span class="hljs-comment">// 包装每个工具回调，添加SSE通知</span>
        <span class="hljs-keyword">return</span> Arrays.stream(originalCallbacks)
                .map(<span class="hljs-built_in">this</span>::wrapNotification)
                .toArray(ToolCallback[]::<span class="hljs-keyword">new</span>);
    }

    <span class="hljs-keyword">private</span> ToolCallback <span class="hljs-title function_">wrapNotification</span><span class="hljs-params">(ToolCallback originalCallback)</span> {

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolCallback</span>() {

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> ToolDefinition <span class="hljs-title function_">getToolDefinition</span><span class="hljs-params">()</span> {
                <span class="hljs-type">ToolDefinition</span> <span class="hljs-variable">toolDefinition</span> <span class="hljs-operator">=</span> originalCallback.getToolDefinition();
                log.info(<span class="hljs-string">"获取工具定义: {}"</span>, toolDefinition);
                <span class="hljs-keyword">return</span> toolDefinition;
            }

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> ToolMetadata <span class="hljs-title function_">getToolMetadata</span><span class="hljs-params">()</span> {
                <span class="hljs-type">ToolMetadata</span> <span class="hljs-variable">toolMetadata</span> <span class="hljs-operator">=</span> originalCallback.getToolMetadata();
                log.info(<span class="hljs-string">"MCP工具调用开始: {}"</span>, toolMetadata);
                <span class="hljs-keyword">return</span> toolMetadata;
            }

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> String <span class="hljs-title function_">call</span><span class="hljs-params">(String toolInput, ToolContext toolContext)</span> {
                <span class="hljs-type">String</span> <span class="hljs-variable">call</span> <span class="hljs-operator">=</span> ToolCallback.<span class="hljs-built_in">super</span>.call(toolInput, toolContext);
                log.info(<span class="hljs-string">"MCP工具调用结束: {}"</span>, call);
                <span class="hljs-keyword">return</span> call;
            }

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> String <span class="hljs-title function_">call</span><span class="hljs-params">(String functionInput)</span> {
                <span class="hljs-type">String</span> <span class="hljs-variable">toolName</span> <span class="hljs-operator">=</span> getToolDefinition().name();
                <span class="hljs-keyword">if</span> (StrUtil.isBlank(functionInput)) {
                    <span class="hljs-keyword">return</span> <span class="hljs-string">"none"</span>;
                }
                <span class="hljs-keyword">try</span> {
                    log.info(<span class="hljs-string">"MCP工具调用开始: {} 参数: {}"</span>, toolName, functionInput);
                    <span class="hljs-comment">// 执行实际的工具调用</span>
                    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> originalCallback.call(functionInput);
                    log.info(<span class="hljs-string">"MCP工具调用成功: {} 结果: {}"</span>, toolName, result);

                    <span class="hljs-keyword">return</span> result;
                } <span class="hljs-keyword">catch</span> (Exception e) {
                    log.error(<span class="hljs-string">"MCP工具调用失败: {} 错误: {}"</span>, toolName, e.getMessage(), e);
                    <span class="hljs-keyword">throw</span> e;
                }
            }
        };
    }
}
</code></pre>
<p>增强的日志输出：</p>
<pre><code class="hljs language-bash" lang="bash">获取工具定义: DefaultToolDefinition[name=webSearch, description=Searching information from the internet, inputSchema={<span class="hljs-string">"type"</span>:<span class="hljs-string">"object"</span>,<span class="hljs-string">"properties"</span>:{<span class="hljs-string">"query"</span>:{<span class="hljs-string">"type"</span>:<span class="hljs-string">"string"</span>,<span class="hljs-string">"description"</span>:<span class="hljs-string">"搜索关键词"</span>}},<span class="hljs-string">"required"</span>:[<span class="hljs-string">"query"</span>],<span class="hljs-string">"additionalProperties"</span>:<span class="hljs-literal">false</span>}]
MCP工具调用开始: DefaultToolMetadata[returnDirect=<span class="hljs-literal">false</span>]
获取工具定义: DefaultToolDefinition[name=webSearch, description=Searching information from the internet, inputSchema={<span class="hljs-string">"type"</span>:<span class="hljs-string">"object"</span>,<span class="hljs-string">"properties"</span>:{<span class="hljs-string">"query"</span>:{<span class="hljs-string">"type"</span>:<span class="hljs-string">"string"</span>,<span class="hljs-string">"description"</span>:<span class="hljs-string">"搜索关键词"</span>}},<span class="hljs-string">"required"</span>:[<span class="hljs-string">"query"</span>],<span class="hljs-string">"additionalProperties"</span>:<span class="hljs-literal">false</span>}]
MCP工具调用开始: DefaultToolMetadata[returnDirect=<span class="hljs-literal">false</span>]
获取工具定义: DefaultToolDefinition[name=webSearch, description=Searching information from the internet, inputSchema={<span class="hljs-string">"type"</span>:<span class="hljs-string">"object"</span>,<span class="hljs-string">"properties"</span>:{<span class="hljs-string">"query"</span>:{<span class="hljs-string">"type"</span>:<span class="hljs-string">"string"</span>,<span class="hljs-string">"description"</span>:<span class="hljs-string">"搜索关键词"</span>}},<span class="hljs-string">"required"</span>:[<span class="hljs-string">"query"</span>],<span class="hljs-string">"additionalProperties"</span>:<span class="hljs-literal">false</span>}]
MCP工具调用开始: webSearch 参数: {<span class="hljs-string">"query"</span>: <span class="hljs-string">"英雄联盟S15世界赛结果"</span>}
MCP工具调用成功: webSearch 结果: [{<span class="hljs-string">"text"</span>:<span class="hljs-string">"\"Query: 英雄联盟S15世界赛结果\\n\\nAnswer (summary):\\nT1 won the 2025 League of Legends World Championship S15, defeating KT 3-2 in the finals. Faker earned his sixth championship title. T1 became the first team to achieve three consecutive world championships.\\n\\nTop results:\\n1. T1 夺得英雄联盟S15 总决赛冠军，成为首支「三连冠」战队 - NOWRE\\n URL: https://nowre.com/lifestyle/1004558/t1-duodeyingxionglianmeng-s15-zongjuesaiguanjunchengweishouzhisanlianguanzhandui/\\n Snippet: 在2025 英雄联盟全球总决赛成都的决赛舞台上，两支来自LCK 战队T1 和KT 打满五场，最终T1 在决胜局赢下比赛，夺得本次世界赛冠军。T1 中单选手李相赫（Faker）收获了\\n Score: 0.99979013\\n\\n2. T1夺得英雄联盟S15世界总决赛冠军，再创电竞高峰\\n URL: https://lufkindailynews.com/test/?s-news-7346505-2025-11-10-t1-clinches-championship-titles-at-league-of-legends-s15-world-finals\\n Snippet: T1夺得英雄联盟S15世界总决赛冠军，再创电竞高峰. 2025年11月10日. 赛况回顾：T1力克KT战队，稳获全球冠军. 2025年，英雄联盟全球总决赛（World\\n Score: 0.9997695\\n\\n3. 【英雄联盟世界赛】T1夺得S15冠军，Faker斩获第六冠：比起所有的 ...\\n URL: https://www.youtube.com/watch?v=DTv2svlGH_c\\n Snippet: 【英雄联盟世界赛】T1夺得S15冠军，Faker斩获第六冠：比起所有的成就和记录，我更在意今天是不是一场精彩的比赛！谢谢KT，我们共同呈现了一场精彩绝伦的比赛！\\nLPL TV\\n31400 subscribers\\n29 likes\\n4179 views\\n9 Nov 2025\\n订阅非常适合上传视频！\\n如果您设置了通知，则上传后可以立即看到它！\\n►订阅频道(Subscribe) :  https://goo.gl/bwEQRX\\n►Contact me: wilsonyang218@gmail.com\\nThank you for your coopertation.\\n14 comments\\n\\n Score: 0.9988575\\n\\n4. T1击败KT，斩获《英雄联盟》S15总决赛冠军 - 机核\\n URL: https://www.gcores.com/articles/206710\\n Snippet: 游戏库 播单 专题 预告 下载机核 APP # T1击败KT，斩获《英雄联盟》S15总决赛冠军 恭喜T1！ YT174 小时前发布于资讯 本文系用户投稿，不代表机核网观点 在成都东安湖体育公园多功能体育馆举行的《英雄联盟》2025全球总决赛现场，LCK 的两只战队迎来内战。 最终， T1战队以3比2战胜了KT 战队，斩获冠军！ Gumayusi选手获得FMVP 。 值得一提的是，这也是 T1 队史的第六座召唤师冠军奖杯，也创下了三连冠的惊人记录。此前 T1 的战绩为：S3冠军、S5冠军、S6冠军、S7亚军、S12亚军、S13冠军、S14冠军。 王冠之重，王者承担，无数斑驳星光汇聚之处即是希望！怀揣一颗炽热、真诚且纯粹的心，就能看清那象征至高荣誉奖杯之上的光辉。争者留其名，2025全球总决赛冠亚军决赛最终之战，再次恭喜 T1! 在赛场中，今年 29 岁的选手 Faker（李相赫）再度展现了自...\\n Score: 0.99843913\\n\\n5. 恭喜T1拿下英雄联盟S15世界冠军！3-2击败KT，Faker实现6冠王荣誉\\n URL: https://news.qq.com/rain/a/20251109A04ROT00\\n Snippet: # 恭喜T1拿下英雄联盟S15世界冠军！3-2击败KT，Faker实现6冠王荣誉 贝塔看比赛 2025-11-09 21:14发布于湖北游戏领域创作者 S15全球总决赛KT和T1的决赛BO5，双方打满5局之后，T1以3-2的战绩击败KT，拿下世界冠军！Faker完成6冠王的成就！ 第一局KT上单兰博，打野猴子，中单瑞兹，下路艾希加布隆；T1上单安蓓萨，打野赵信，中单岩雀，下路韦鲁斯加波比。对线期KT节奏起飞，河道击杀oner赵信，BDD瑞兹拿到一血，随后T1下路失误，KT打出1换2，上路KT野辅及时支援打出0换2，前期KT推掉了上路一血塔，拿到了2条小龙，经济领先2K。 中期双方争夺峡谷先锋，Doran安蓓萨直接开到Deokdam艾希，T1打出0换2后拉扯打厄塔汗，KT其他人想要阻止被T1团灭，T1拿下厄塔汗。28分钟双方中路混战，虽然Oner赵信开团率先被秒，但是BDD瑞兹被keria波...\\n Score: 0.9973061\\n\\nAPI response_time: 1.24s\""</span>}]
MCP工具调用结束: [{<span class="hljs-string">"text"</span>:<span class="hljs-string">"\"Query: 英雄联盟S15世界赛结果\\n\\nAnswer (summary):\\nT1 won the 2025 League of Legends World Championship S15, defeating KT 3-2 in the finals. Faker earned his sixth championship title. T1 became the first team to achieve three consecutive world championships.\\n\\nTop results:\\n1. T1 夺得英雄联盟S15 总决赛冠军，成为首支「三连冠」战队 - NOWRE\\n URL: https://nowre.com/lifestyle/1004558/t1-duodeyingxionglianmeng-s15-zongjuesaiguanjunchengweishouzhisanlianguanzhandui/\\n Snippet: 在2025 英雄联盟全球总决赛成都的决赛舞台上，两支来自LCK 战队T1 和KT 打满五场，最终T1 在决胜局赢下比赛，夺得本次世界赛冠军。T1 中单选手李相赫（Faker）收获了\\n Score: 0.99979013\\n\\n2. T1夺得英雄联盟S15世界总决赛冠军，再创电竞高峰\\n URL: https://lufkindailynews.com/test/?s-news-7346505-2025-11-10-t1-clinches-championship-titles-at-league-of-legends-s15-world-finals\\n Snippet: T1夺得英雄联盟S15世界总决赛冠军，再创电竞高峰. 2025年11月10日. 赛况回顾：T1力克KT战队，稳获全球冠军. 2025年，英雄联盟全球总决赛（World\\n Score: 0.9997695\\n\\n3. 【英雄联盟世界赛】T1夺得S15冠军，Faker斩获第六冠：比起所有的 ...\\n URL: https://www.youtube.com/watch?v=DTv2svlGH_c\\n Snippet: 【英雄联盟世界赛】T1夺得S15冠军，Faker斩获第六冠：比起所有的成就和记录，我更在意今天是不是一场精彩的比赛！谢谢KT，我们共同呈现了一场精彩绝伦的比赛！\\nLPL TV\\n31400 subscribers\\n29 likes\\n4179 views\\n9 Nov 2025\\n订阅非常适合上传视频！\\n如果您设置了通知，则上传后可以立即看到它！\\n►订阅频道(Subscribe) :  https://goo.gl/bwEQRX\\n►Contact me: wilsonyang218@gmail.com\\nThank you for your coopertation.\\n14 comments\\n\\n Score: 0.9988575\\n\\n4. T1击败KT，斩获《英雄联盟》S15总决赛冠军 - 机核\\n URL: https://www.gcores.com/articles/206710\\n Snippet: 游戏库 播单 专题 预告 下载机核 APP # T1击败KT，斩获《英雄联盟》S15总决赛冠军 恭喜T1！ YT174 小时前发布于资讯 本文系用户投稿，不代表机核网观点 在成都东安湖体育公园多功能体育馆举行的《英雄联盟》2025全球总决赛现场，LCK 的两只战队迎来内战。 最终， T1战队以3比2战胜了KT 战队，斩获冠军！ Gumayusi选手获得FMVP 。 值得一提的是，这也是 T1 队史的第六座召唤师冠军奖杯，也创下了三连冠的惊人记录。此前 T1 的战绩为：S3冠军、S5冠军、S6冠军、S7亚军、S12亚军、S13冠军、S14冠军。 王冠之重，王者承担，无数斑驳星光汇聚之处即是希望！怀揣一颗炽热、真诚且纯粹的心，就能看清那象征至高荣誉奖杯之上的光辉。争者留其名，2025全球总决赛冠亚军决赛最终之战，再次恭喜 T1! 在赛场中，今年 29 岁的选手 Faker（李相赫）再度展现了自...\\n Score: 0.99843913\\n\\n5. 恭喜T1拿下英雄联盟S15世界冠军！3-2击败KT，Faker实现6冠王荣誉\\n URL: https://news.qq.com/rain/a/20251109A04ROT00\\n Snippet: # 恭喜T1拿下英雄联盟S15世界冠军！3-2击败KT，Faker实现6冠王荣誉 贝塔看比赛 2025-11-09 21:14发布于湖北游戏领域创作者 S15全球总决赛KT和T1的决赛BO5，双方打满5局之后，T1以3-2的战绩击败KT，拿下世界冠军！Faker完成6冠王的成就！ 第一局KT上单兰博，打野猴子，中单瑞兹，下路艾希加布隆；T1上单安蓓萨，打野赵信，中单岩雀，下路韦鲁斯加波比。对线期KT节奏起飞，河道击杀oner赵信，BDD瑞兹拿到一血，随后T1下路失误，KT打出1换2，上路KT野辅及时支援打出0换2，前期KT推掉了上路一血塔，拿到了2条小龙，经济领先2K。 中期双方争夺峡谷先锋，Doran安蓓萨直接开到Deokdam艾希，T1打出0换2后拉扯打厄塔汗，KT其他人想要阻止被T1团灭，T1拿下厄塔汗。28分钟双方中路混战，虽然Oner赵信开团率先被秒，但是BDD瑞兹被keria波...\\n Score: 0.9973061\\n\\nAPI response_time: 1.24s\""</span>}]
2025-11-13T14:03:01.616+08:00  INFO 22732 --- [ai] [oundedElastic-2] c.l.a.u.CustomMcpToolCallbackProvider    : 获取工具定义: DefaultToolDefinition[name=webSearch, description=Searching information from the internet, inputSchema={<span class="hljs-string">"type"</span>:<span class="hljs-string">"object"</span>,<span class="hljs-string">"properties"</span>:{<span class="hljs-string">"query"</span>:{<span class="hljs-string">"type"</span>:<span class="hljs-string">"string"</span>,<span class="hljs-string">"description"</span>:<span class="hljs-string">"搜索关键词"</span>}},<span class="hljs-string">"required"</span>:[<span class="hljs-string">"query"</span>],<span class="hljs-string">"additionalProperties"</span>:<span class="hljs-literal">false</span>}]
</code></pre>
<p>上面的组件为工具调用阶段提供了日志，在实际应用开发中，可以考虑在这个阶段发送<code>SSE</code>状态通知等操作。</p>
<p><strong>3.3 应用集成</strong></p>
<p>修改我们的<code>ChatClientFactory.java</code>组件，新注入对应的<code>AsyncMcpToolCallbackProvider</code>或刚才自定义的<code>CustomMcpToolCallbackProvider</code>，并添加<code>.toolCallbacks</code>参数即可：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatClientFactory</span> {

    <span class="hljs-comment">// 根据配置id来分配不同的Client，复用</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Integer, ChatClient&gt; clientCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MybatisChatMemory mybatisChatMemory;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RagService ragService;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> EmbeddingStoreFactory embeddingStoreFactory;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SseEmitterManager sseEmitterManager;

<span class="hljs-comment">//        private final AsyncMcpToolCallbackProvider toolCallbackProvider;</span>

    <span class="hljs-comment">// 自定义MCP工具回调提供器，添加日志调试</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> CustomMcpToolCallbackProvider toolCallbackProvider;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">INDEX_FINDING_SYSTEM_MSG</span> <span class="hljs-operator">=</span> <span class="hljs-string">"You are an expert-level AI Routing Agent. "</span> +
            <span class="hljs-string">"Your sole task is to select the most relevant index name from a given list based on a user's question.\n"</span>
            +
            <span class="hljs-string">"\n"</span> +
            <span class="hljs-string">"Your workflow is as follows:\n"</span> +
            <span class="hljs-string">"1.  Analyze the user's question to understand its core intent and subject matter.\n"</span> +
            <span class="hljs-string">"2.  Examine each name in the "</span>Index Name List<span class="hljs-string">" to understand the data domain it represents.\n"</span>
            +
            <span class="hljs-string">"3.  Perform a semantic match to determine which index is most likely to contain the information needed to answer the user's question.\n"</span>
            +
            <span class="hljs-string">"\n"</span> +
            <span class="hljs-string">"You must strictly adhere to the following rules:\n"</span> +
            <span class="hljs-string">"-   **Unique Output**: Your response MUST be one of the index names from the list, or the string "</span><span class="hljs-number">0</span><span class="hljs-string">".\n"</span>
            +
            <span class="hljs-string">"-   **No Explanation**: Do NOT include any explanations, justifications, apologies, or any form of additional text. For example, do not say "</span>I think the best match is a<span class="hljs-string">". You must only output "</span>a<span class="hljs-string">".\n"</span>
            +
            <span class="hljs-string">"-   **Definition of "</span><span class="hljs-number">0</span><span class="hljs-string">"**: If the user's question is small talk, a greeting, completely unrelated to any of the indexes, or if you cannot determine a clear correlation, you MUST output "</span><span class="hljs-number">0</span><span class="hljs-string">".\n"</span>
            +
            <span class="hljs-string">"-   **Exact Match**: The outputted index name must be an exact, case-sensitive match to the string provided in the list.\n"</span>
            +
            <span class="hljs-string">"-   **Decisive Choice**: When multiple options seem partially relevant, choose the one that is most centrally and directly related. If you cannot make a clear best choice, default to outputting "</span><span class="hljs-number">0</span><span class="hljs-string">" to avoid incorrect routing."</span>;

    <span class="hljs-comment">/**
     * 根据 AI 配置创建或复用 ChatClient
     */</span>
    <span class="hljs-keyword">public</span> ChatClient <span class="hljs-title function_">getOrCreateClient</span><span class="hljs-params">(AiConfig aiConfig)</span> {
        <span class="hljs-keyword">return</span> clientCache.computeIfAbsent(aiConfig.getId(), k -&gt; createClient(aiConfig));
    }

    <span class="hljs-comment">/**
     * 真正创建 ChatClient 的方法
     */</span>
    <span class="hljs-keyword">private</span> ChatClient <span class="hljs-title function_">createClient</span><span class="hljs-params">(AiConfig aiConfig)</span> {
        <span class="hljs-type">OpenAiApi</span> <span class="hljs-variable">openAiApi</span> <span class="hljs-operator">=</span> OpenAiApi.builder()
                .apiKey(aiConfig.getApiKey())
                .baseUrl(aiConfig.getApiDomain())
                .completionsPath(<span class="hljs-string">"/chat/completions"</span>)
                .build();

        <span class="hljs-type">OpenAiChatOptions</span> <span class="hljs-variable">chatOptions</span> <span class="hljs-operator">=</span> OpenAiChatOptions.builder()
                .maxTokens(aiConfig.getMaxContextMsgs())
                .temperature(aiConfig.getTemperature())
                .topP(aiConfig.getSimilarityTopP())
                .model(aiConfig.getModelId())
                .streamUsage(<span class="hljs-literal">true</span>)
                .build();

        <span class="hljs-type">ChatModel</span> <span class="hljs-variable">chatModel</span> <span class="hljs-operator">=</span> OpenAiChatModel.builder()
                .openAiApi(openAiApi)
                .defaultOptions(chatOptions)
                .build();

        <span class="hljs-keyword">return</span> ChatClient.builder(chatModel)
                <span class="hljs-comment">// 默认工具调用</span>
                .defaultTools(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTimeTools</span>())
                <span class="hljs-comment">// 默认系统提示词</span>
                .defaultSystem(<span class="hljs-string">"you are a helpful ai assistant developed by losgai."</span> +
                        <span class="hljs-string">"You are connected to a Web Search Tool. "</span> +
                        <span class="hljs-string">"If the user asks something you cannot answer confidently, "</span> +
                        <span class="hljs-string">"always call the tool 'webSearch' with the query string."</span>)
                .build();
    }

    <span class="hljs-comment">/**
     * 构建流式对话响应
     */</span>
    <span class="hljs-keyword">public</span> Flux&lt;ChatResponse&gt; <span class="hljs-title function_">streamChat</span><span class="hljs-params">(
            AiConfig aiConfig,
            List&lt;String&gt; urlList,
            String userMsg,
            String conversationId)</span> {
        <span class="hljs-comment">// 状态通知的sse</span>
        <span class="hljs-keyword">if</span> (sseEmitterManager.getEmitter(conversationId) == <span class="hljs-literal">null</span>) {
            sseEmitterManager.addEmitter(conversationId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SseEmitter</span>(<span class="hljs-number">30000L</span>));
        }
        <span class="hljs-type">SseEmitter</span> <span class="hljs-variable">emitter</span> <span class="hljs-operator">=</span> sseEmitterManager.getEmitter(conversationId);
        <span class="hljs-keyword">try</span> {
            emitter.send(<span class="hljs-string">"正在连接服务器..."</span>);
        } <span class="hljs-keyword">catch</span> (IOException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
        }

        <span class="hljs-type">ChatClient</span> <span class="hljs-variable">chatClient</span> <span class="hljs-operator">=</span> getOrCreateClient(aiConfig);

        List&lt;String&gt; indexes = List.of();
        <span class="hljs-keyword">try</span> {
            indexes = ragService.getIndexes();
        } <span class="hljs-keyword">catch</span> (IOException e) {
            log.error(<span class="hljs-string">"获取向量索引列表失败！"</span>);
        }

        <span class="hljs-comment">// RAG检索</span>
        <span class="hljs-type">Advisor</span> <span class="hljs-variable">retrievalAugmentationAdvisor</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;

        <span class="hljs-keyword">if</span> (CollUtil.isNotEmpty(indexes)) {

            <span class="hljs-keyword">try</span> {
                emitter.send(<span class="hljs-string">"正在检索知识库..."</span>);
            } <span class="hljs-keyword">catch</span> (IOException e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
            }

            Set&lt;String&gt; indexSet = Set.copyOf(indexes);
            <span class="hljs-type">String</span> <span class="hljs-variable">INDEX_FINDING_USER_MSG</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Index Name List:"</span> +
                    indexes +
                    <span class="hljs-string">"User Question:"</span> +
                    userMsg;

            <span class="hljs-comment">// 首先通过大模型，选择合适的RAG索引</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">indexName</span> <span class="hljs-operator">=</span> chatClient.prompt()
                    .system(INDEX_FINDING_SYSTEM_MSG)
                    .user(INDEX_FINDING_USER_MSG)
                    .call()
                    .content();
            <span class="hljs-comment">// 索引合法，构建检索器</span>
            <span class="hljs-keyword">if</span> (indexSet.contains(indexName)) {
                <span class="hljs-comment">// 构建检索器</span>
                <span class="hljs-type">ElasticsearchVectorStore</span> <span class="hljs-variable">vectorStore</span> <span class="hljs-operator">=</span> embeddingStoreFactory
                        .createVectorStore(indexName);
                <span class="hljs-comment">// 构建召回器</span>
                retrievalAugmentationAdvisor = RetrievalAugmentationAdvisor.builder()
                        .documentRetriever(VectorStoreDocumentRetriever.builder()
                                <span class="hljs-comment">// 相似度阈值，0.5表示只有当检索结果的相似度分数 ≥ 0.50 时，才返回上层</span>
                                .similarityThreshold(<span class="hljs-number">0.1</span>)
                                <span class="hljs-comment">// 注入的向量存储</span>
                                .vectorStore(vectorStore)
                                .build())
                        .queryAugmenter(ContextualQueryAugmenter.builder()
                                <span class="hljs-comment">// 使用参数，允许查找的结果为空</span>
                                .allowEmptyContext(<span class="hljs-literal">true</span>)
                                .build())
                        .build();
            }
        } <span class="hljs-keyword">else</span> {
            log.info(<span class="hljs-string">"跳过RAG步骤"</span>);
        }

        <span class="hljs-keyword">try</span> {
            emitter.send(<span class="hljs-string">"正在检索..."</span>);
        } <span class="hljs-keyword">catch</span> (IOException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
        }

        ToolCallback[] toolCallbacks = toolCallbackProvider.getToolCallbacks();

        <span class="hljs-comment">// 多模态输入</span>
        <span class="hljs-keyword">if</span> (CollUtil.isNotEmpty(urlList) &amp;&amp; aiConfig.getModelType() == <span class="hljs-number">2</span>) {
            List&lt;Media&gt; mediaList = urlList.stream().map(url -&gt; {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-type">MimeType</span> <span class="hljs-variable">mimeType</span> <span class="hljs-operator">=</span> url.endsWith(<span class="hljs-string">"png"</span>) ? MimeTypeUtils.IMAGE_PNG
                            : MimeTypeUtils.IMAGE_JPEG;
                    <span class="hljs-keyword">return</span> Media.builder().mimeType(mimeType).data(<span class="hljs-keyword">new</span> <span class="hljs-title class_">UrlResource</span>(url)).build();
                } <span class="hljs-keyword">catch</span> (MalformedURLException e) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
                }
            }).toList();

            <span class="hljs-keyword">if</span> (retrievalAugmentationAdvisor == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> chatClient.prompt()
<span class="hljs-comment">//                        .toolCallbacks(toolCallbacks)</span>
                        .user(u -&gt; u.text(userMsg).media(mediaList.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Media</span>[<span class="hljs-number">0</span>])))
                        .advisors(MessageChatMemoryAdvisor.builder(mybatisChatMemory).build())
                        .advisors(a -&gt; a.param(ChatMemory.CONVERSATION_ID, conversationId))
                        .stream()
                        .chatResponse();
            }
            <span class="hljs-keyword">return</span> chatClient.prompt()
<span class="hljs-comment">//                    .toolCallbacks(toolCallbacks)</span>
                    .user(u -&gt; u.text(userMsg).media(mediaList.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Media</span>[<span class="hljs-number">0</span>])))
                    .advisors(MessageChatMemoryAdvisor.builder(mybatisChatMemory).build())
                    .advisors(a -&gt; a.param(ChatMemory.CONVERSATION_ID, conversationId))
                    .advisors(retrievalAugmentationAdvisor)
                    .stream()
                    .chatResponse();
        }

        <span class="hljs-keyword">if</span> (retrievalAugmentationAdvisor == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> chatClient.prompt()
                    .toolCallbacks(toolCallbacks)
                    .user(userMsg)
                    .advisors(MessageChatMemoryAdvisor.builder(mybatisChatMemory).build())
                    .advisors(a -&gt; a.param(ChatMemory.CONVERSATION_ID, conversationId))
                    .stream()
                    .chatResponse();
        }

        <span class="hljs-comment">// 普通文本</span>
        <span class="hljs-keyword">return</span> chatClient.prompt()
                .toolCallbacks(toolCallbacks)
                .user(userMsg)
                .advisors(MessageChatMemoryAdvisor.builder(mybatisChatMemory).build())
                .advisors(a -&gt; a.param(ChatMemory.CONVERSATION_ID, conversationId))
                .advisors(retrievalAugmentationAdvisor)
                .stream()
                .chatResponse();
    }
}
</code></pre>
<p>结果演示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c590db8e67f49b68dfacf08e1f1fb40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbDBzZ0Fp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763620849&amp;x-signature=qkGxxPqhm7Jpht7wr%2B5nrYrT61o%3D" alt="webSearch.png" loading="lazy"/></p>
<hr/>
<h4 data-id="heading-5">总结</h4>
<p>🎉本文介绍了使用SpringAI结合MCP实现联网搜索的方法，包括服务端和客户端的搭建，以及应用的整合。希望本文能帮到大家，如果喜欢别忘了点赞、关注、收藏，或者帮忙在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fl0sgAi%2Fai-chat-demo" target="_blank" title="https://github.com/l0sgAi/ai-chat-demo" ref="nofollow noopener noreferrer">github</a>点一个star⭐️！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 Transform 到 Transformer，用 EventBridge 与百炼构建实时智能的 ETL 数据管道]]></title>    <link>https://juejin.cn/post/7571753301898625064</link>    <guid>https://juejin.cn/post/7571753301898625064</guid>    <pubDate>2025-11-13T07:19:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571753301898625064" data-draft-id="7571734313927213090" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 Transform 到 Transformer，用 EventBridge 与百炼构建实时智能的 ETL 数据管道"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2025-11-13T07:19:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 Transform 到 Transformer，用 EventBridge 与百炼构建实时智能的 ETL 数据管道
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T07:19:02.000Z" title="Thu Nov 13 2025 07:19:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：稚柳</p>
<h2 data-id="heading-0">前言</h2>
<p>作为数据处理领域的经典模式，ETL（Extract-Transform-Load）通过提取、转换、加载三个步骤，高效地处理着各类结构化数据。然而，面对 AI 时代海量、异构、实时的“数据洪流”，传统 ETL 链路，尤其是其核心的转换（Transform）环节，正面临严峻挑战。本文将从一个初级开发者也能理解和上手的视角，探讨 AI 时代的数据处理新范式：如何利用基于 Transformer 架构的大语言模型（LLM）重塑传统数据处理中的转换（Transform）环节，并结合事件驱动架构（Event-Driven Architecture, EDA），为 AI 数据处理链路“注入实时智能”。</p>
<h2 data-id="heading-1">传统 ETL 在 AI 时代的困境：“T”不仅是“转换”，更是“痛点”</h2>
<p>ETL（Extract-Transform-Load）是数据处理的核心流程。它负责从不同数据源中提取数据，经过清洗、转换和整合后，加载到统一的数据仓库，为后续的数据分析与商业智能提供支撑。</p>
<p>我们可以将 ETL 生动地比作一个“中央厨房”：“提取（Extract）” 是采购生鲜食材（原始数据），“加载（Load）” 是将精美菜肴（可用数据）端上餐桌，而 “转换（Transform）” 则是至关重要的烹饪环节。在过去，厨房采购的多是规格统一的食材（结构化数据），依靠“老菜谱”（固定的规则代码）便能高效、稳定地完成处理。然而，AI 时代带来了形态各异、数量庞大的“山珍海味”——文本、图片、音频、视频等非结构化数据，且往往要求实时处理。这使得厨房里最关键的烹饪环节（Transform）不堪重负，那套为标准食材设计的“老菜谱”已然捉襟见肘。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1bfc4623301645688d815c95f5667224~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763623142&amp;x-signature=aoH%2BDhPn4W8esk5lUzJFEXwYsKA%3D" alt="图片" loading="lazy"/></p>
<p>以一个常见的地址信息标准化场景为例。用户输入的地址格式五花八门，可能是文本、文档、扫描图片以及客服对话等。后端系统为了便于入库与分析，必须将这些信息精准地解析为“省-市-区-街道”的标准化结构。更棘手的是，原始地址信息还可能存在错别字、信息缺失或语义模糊等问题。在传统 ETL 模式下，工程师不得不编写数千行复杂的正则表达式和判断逻辑，并维护一个庞大的地址库。这种方式不仅开发和维护成本高、扩展性差，而且难以覆盖所有非标准格式和异常情况。</p>
<p>这正是传统 ETL 在 AI 时代“力不从心”的缩影，但也只是冰山一角。在 AI 应用中，数据转换的需求远不止于此，例如：从用户评论中提取情感倾向、为非结构化文档打标签、从图片中识别特定内容等。传统基于固定规则的 Transform 工具，面对这些充满“语义”和“不确定性”的任务，几乎束手无策。最终，数据处理链路变得难以扩展、运维复杂且稳定性差，严重拖慢了 AI 应用的创新步伐。</p>
<h2 data-id="heading-2">为 ETL 更换“AI 大脑”：用 Transformer（AI）代替 Transform</h2>
<p>既然传统 Transform 难以理解数据背后的“语义”，为何不让擅长此道的 AI 来主导这个环节呢？</p>
<p>本文巧妙地运用了“Transformer”一词的双关含义：它既指代 ETL 中的“转换器”（Transform-er），更特指驱动大语言模型（LLM）的核心架构——Transformer。</p>
<p>这正是“用 Transformer 代替 Transform”的核心思想：将大语言模型（LLM）的智能直接注入 ETL 的数据转换环节。许多过去需要复杂代码才能实现的数据转换任务，如今通过与 AI 交互即可轻松完成。</p>
<p>回到我们的“中央厨房”比喻，现在负责加工菜品的，不再是一本固化的菜谱，而是一位拥有米其林星级水准、能理解并处理任何食材的全能大厨。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f9bcbae943d4a749da70ce5588098ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763623142&amp;x-signature=GxUBw1Wnk3n7ctm28mQoTbTMFX8%3D" alt="图片" loading="lazy"/></p>
<p>以前文提到的“地址信息标准化”场景为例，集成了 LLM 的数据管道能做到：</p>
<ul>
<li>结构化解析：利用大模型的语义理解能力，即使地址格式不规范、字段顺序混乱，也能准确识别出省、市、区、街道等核心要素。例如，对于“北京市海淀区中关村大街1号”，大模型能准确解析出结构化字段：省份为“北京”，城市为“北京”，区县为“海淀区”，街道为“中关村大街1号”。</li>
<li>自动识别纠错：基于大模型强大的语言知识与上下文推理，自动识别并纠正地址信息中的错别字或格式错误，再结合地理知识库，能够进一步确保纠正的准确性。例如，将“北京市海定区”纠正为“北京市海淀区”，将“中关村大街一号”标准化为“中关村大街1号”。</li>
<li>智能信息补全：借助大模型的上下文推理能力，并集成完整的地理信息数据库，能够根据已有地址信息智能补全缺失的部分。例如，通过详细地址自动推断邮政编码，根据区县信息补全城市和省份。</li>
<li>格式标准化：最终，所有解析后的信息将被统一输出为标准格式，如结构化的字段信息（省、市、区、街道、邮政编码等）和规范化的地址字符串，确保下游系统能够直接、高效地进行数据处理和分析。</li>
</ul>
<p>这样，我们就不再需要维护复杂的规则库，只需在数据流中集成大语言模型的能力，即可实现智能化的数据清洗和标准化处理。</p>
<h2 data-id="heading-3">事件驱动架构（EDA）：ETL for AI Date 的“天选载体”</h2>
<p>解决了数据“如何转换”的问题后，我们还需要一个现代化的架构来承载整个流程。相较于传统的批量处理模式，<strong>事件驱动架构（Event-Driven Architecture, EDA）</strong> 已被公认为是 AI 时代数据处理的理想选择。</p>
<p>如果说“用 Transformer 代替 Transform”是为数据管道植入“AI 大脑”，那么 <strong>EDA 就是构建这套智能系统的“神经网络”</strong>，让数据和 AI 指令高效地流动起来。它将系统中的每一次状态变化（如“新文件上传”、“新评论产生”）都视为一个独立的“事件”，实时触发相应的处理动作，并准确地将处理结果路由到指定的下游系统。</p>
<h3 data-id="heading-4">阿里云事件总线 EventBridge：AI 时代的事件中枢</h3>
<p>作为 AI 时代的企业级事件枢纽，<strong>事件总线 EventBridge</strong> 为 AI 数据处理提供强大的事件驱动能力。它能够帮你轻松构建高效、智能的 ETL 数据管道，无缝集成 AI 能力，并且原生支持<strong>实时推理</strong>和<strong>异步推理</strong>两种模式，以满足不同场景的需求。其核心价值体现在以下几个方面：</p>
<ul>
<li><strong>实时智能决策：</strong> 将 AI 推理能力无缝融入数据处理流程，使系统能对实时数据进行智能分析与决策，极大提升业务的智能化水平。</li>
<li><strong>系统解耦、灵活扩展：</strong> 数据源、AI 模型和业务系统通过 EventBridge 完全解耦，任何组件的变更都不会影响其他部分，让系统更加灵活、更易于维护和扩展。</li>
<li><strong>AI 能力沉淀与复用：</strong> 相同的 AI 推理服务可被多个业务场景复用，避免重复开发，最大化 AI 模型的价值与利用率。</li>
<li><strong>Serverless 与易用性：</strong> 作为全托管的 Serverless 服务，EventBridge 免去了繁琐的部署和运维工作。通过简单的控制台配置或 API 调用，即可快速构建和管理事件驱动的数据处理流程，并支持事件过滤、转换、路由、重试等高级能力。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/074fe845ef5749cd855b1cf5caec1876~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763623142&amp;x-signature=sTxZj0ThiLMReAD%2BPoP0eO1NfpA%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-5">核心能力：从不确定到确定的“结构化输出”</h3>
<p>在 ETL 的 “转换（Transform）” 环节中，EventBridge 允许用户直接调用大语言模型（例如通义千问或百炼大模型服务平台上的模型），甚至是更复杂的 AI Agent。</p>
<p>但问题来了：LLM 的输出具有不确定性，有时像“开盲盒”，这在要求稳定可靠的企业级应用中是无法接受的。</p>
<p>为了解决这个核心痛点，EventBridge 提供了强大的<strong>结构化输出（Structured Output）</strong> 能力，确保 AI 的每一次处理结果都以稳定、可靠的格式返回。</p>
<p>例如，当需要模型分析用户评论的情感时，我们期望的不是“我觉得这句话是积极的”这类模棱两可的文本，而是一个清晰的 JSON 对象，如：<code>{ "sentiment": "积极", "summary": "产品设计和性能出色，客户非常满意" }</code>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03e892c03cc34ae2816729bb8c374603~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763623142&amp;x-signature=%2BUiJ0UgJiIOpnNV3GrnP5rOQOuM%3D" alt="图片" loading="lazy"/></p>
<p>EventBridge 通过以下两项核心技术，产品化地实现了这一关键能力：</p>
<ul>
<li><strong>JsonSchema 原生支持：</strong> 对于支持 JsonSchema 的模型，EventBridge 会利用其原生能力，确保模型输出严格遵循用户定义的格式，实现高性能与高可靠性。</li>
<li><strong>智能提示词注入：</strong> 对于不支持 JsonSchema 的模型，EventBridge 会采用智能提示词注入技术，引导模型生成稳定、可靠的结构化输出，并确保多轮对话格式的一致性。</li>
</ul>
<p>这项能力极大地降低了在 ETL 流程中使用 AI 的门槛，为企业级应用的稳定性提供了坚实保障。</p>
<h2 data-id="heading-6">场景实践：EventBridge+百炼，让 AI 赋能数据链路</h2>
<p>我们以一个具体的场景为例，展示如何通过阿里云的事件总线 EventBridge 与大模型服务平台百炼的结合，构建 AI 赋能的数据链路。</p>
<p>通过在 EventBridge 的事件流中原生集成百炼大模型服务，使开发者可以在数据流中直接调用 AI，从而轻松、高效地完成传统 ETL 中复杂的转换（Transform）任务。</p>
<h3 data-id="heading-7">应用场景：敏感信息过滤与数据脱敏</h3>
<p>本方案将演示如何利用 AI 对实时数据流进行清洗与脱敏处理，自动发现并屏蔽业务数据中的敏感关键词，从而保障业务的数据合规性。</p>
<h4 data-id="heading-8">方案架构与实施步骤</h4>
<p>该方案的核心是利用 EventBridge 作为数据中枢，将来自不同数据源的实时数据流，分发给百炼 AI 模型进行推理，再将推理结果通过 EventBridge 路由到下游的业务系统或数据存储中。</p>
<p>下图展示了该方案的参考架构：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8566feb30ca4c25ab6fbe5f5911e6c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763623142&amp;x-signature=J9Ap26vfALDu5it%2FLP07S6jCnBQ%3D" alt="图片" loading="lazy"/></p>
<p>实施该方案主要包括以下三个步骤：</p>
<p><strong>1.  构建数据管道：</strong> 创建一个 EventBridge 事件流，作为整个数据处理的核心链路。</p>
<p><strong>2.  配置数据源与目标：</strong> 创建两个轻量消息队列，分别作为事件流的源（Source）和目标（Sink）。</p>
<p><strong>3.  集成 AI 能力：</strong> 在事件流的转换（Transform）环节，配置调用已开通的阿里云百炼大模型服务，将 AI 的智能处理能力无缝嵌入数据管道中。</p>
<p>整个流程通过在 EventBridge 控制台进行简单的点击和配置即可完成，无需编写复杂的代码来连接数据源、AI 模型和下游系统，大大提升了开发效率。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea9027c2c0a24eaf8e3a9aa3ae29976b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763623142&amp;x-signature=NFKcqaJ%2FNeRi9lprt%2BbO%2BvBK%2FBM%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-9">实现效果</h4>
<p>部署完成后，可以通过以下方式验证数据脱敏效果：从 Source（源）队列发送带有敏感信息的数据，然后在 Sink（目标）队列接收经过事件流处理后的数据。</p>
<ul>
<li>输入示例：包含敏感信息的数据，如<code>["客户张三（13812345678）反馈了一个问题..."]</code></li>
<li>输出示例：经过 AI 脱敏后的数据，如<code>["客户***（138*****5678）反馈了一个问题..."]</code></li>
</ul>
<blockquote>
<p>注：由于大模型生成结果存在随机性，实际测试时输出结果的格式可能存在差异。在生产环境中，可以结合 EventBridge 的结构化输出能力与提示词工程，获得稳定可靠的输出结果。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d3743a85a6c43888629e633432648c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763623142&amp;x-signature=nxSGGoZa4nsLssFl7vGw81Y2qm8%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-10">开发者关心的问题（Q&amp;A）</h4>
<p>问：每次数据转换都调用 LLM，成本会不会很高？</p>
<p>答：成本是大家最关心的问题。首先，EventBridge 本身是 Serverless 服务，按实际处理的事件数量付费。主要的成本来自 LLM 调用，但你可以根据场景需求灵活选择不同规模和成本的模型。对于简单任务，轻量级模型已足够，成本较低。对于非实时场景，可采用异步批量调用的方式，进一步优化成本。</p>
<p>问：LLM 推理有延迟，会影响实时性吗？</p>
<p>答：事件驱动架构的异步和解耦特性天然适合这种情况。数据源发送事件后无需等待处理结果，整个系统流程不会被阻塞。EventBridge 支持实时和异步两种推理模式，你可以根据业务对延迟的敏感度进行选择，确保用户体验不受影响。</p>
<h2 data-id="heading-11">总结</h2>
<p>用 Transformer（LLM）升级 Transform（转换），并以事件驱动架构（EDA）作为承载，是 AI 时代数据处理范式的一次“智”变。阿里云 EventBridge 与百炼的结合，为开发者提供了一条低门槛、高灵活性的路径，将强大的 AI 能力无缝融入实时数据流，让你的应用轻松实现智能化。</p>
<p>目前，该解决方案已在阿里云官网上线，欢迎点击<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fsolution%2Ftech-solution%2Fetl-for-ai-data-a-one-stop-platform-for-ai-data-processing" target="_blank" title="https://www.aliyun.com/solution/tech-solution/etl-for-ai-data-a-one-stop-platform-for-ai-data-processing" ref="nofollow noopener noreferrer">此处</a>即可部署体验～</p>
<p>钉钉搜索群号：44552972 加入 EventBridge 用户交流群，探索更多产品功能，与我们共同定义和构建 AI 数据处理的未来！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[类加载机制]]></title>    <link>https://juejin.cn/post/7572002432449806345</link>    <guid>https://juejin.cn/post/7572002432449806345</guid>    <pubDate>2025-11-13T07:27:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572002432449806345" data-draft-id="7572002432449773577" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="类加载机制"/> <meta itemprop="keywords" content="前端,客户端"/> <meta itemprop="datePublished" content="2025-11-13T07:27:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Jony_"/> <meta itemprop="url" content="https://juejin.cn/user/3403743732709767"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            类加载机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3403743732709767/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Jony_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T07:27:52.000Z" title="Thu Nov 13 2025 07:27:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>一、分类</strong></h2>
<p>类的加载都是通过 ClassLoader 来完成的，根据加载类存放在不同的位置，需要不同的ClassLoader。因此大概可以分为如下几类：</p>
<ul>
<li>Apk 中已经存在的类</li>
<li>Apk 未存在的类（插件化实现方式）</li>
</ul>
<p>针对上述的分类，Android 中有如下的 ClassLoader 实现：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3cc5a676355048fc869cf55ee1f15879~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSm9ueV8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763624739&amp;x-signature=natGKZQQG9yY%2F0w%2Bfz6DSU%2BXZOs%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>PathClassLoader：通常用来加载系统类和应用程序类，加载 Apk 中已经安装的 dex</li>
<li>DexClassLoader：加载 dex 文件，可用来加载外部的类，在 Android8.0 之后，和 PathClassLoader 没有区别</li>
</ul>
<h2 data-id="heading-1">二、双亲委托机制实现</h2>
<p>机制的流程如下：</p>
<ol>
<li>检查这个类是否被加载过，如果加载过，则直接返回</li>
<li>如果父 ClassLoader 存在，则交给父 ClassLoader 加载，否则交给 BootClassLoader 加载</li>
<li>如果父 ClassLoader 无法加载，则调用自己的 findClass 完成加载</li>
</ol>
<p>双亲委托机制的源码如下：（伪代码）</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="hljs-type">boolean</span> resolve) {
    <span class="hljs-keyword">synchronized</span> (getClassLoadingLock(name)) {
        <span class="hljs-comment">// 1. 检查是否曾加载过</span>
        Class&lt;?&gt; c = findLoadedClass(name);
        <span class="hljs-keyword">if</span> (c == <span class="hljs-literal">null</span>) {
           <span class="hljs-keyword">if</span> (parent != <span class="hljs-literal">null</span>) {
               <span class="hljs-comment">// 2. 优先让 parent 加载器去加载</span>
               c = parent.loadClass(name, <span class="hljs-literal">false</span>);
           } <span class="hljs-keyword">else</span> {
               c = findBootstrapClassOrNull(name);
           }
            <span class="hljs-keyword">if</span> (c == <span class="hljs-literal">null</span>) {
            	<span class="hljs-comment">// 3. 如果 parent 均没有加载到目标class，调用自身的 findClass() 方法去搜索</span>
                c = findClass(name);
            }
        }
        <span class="hljs-keyword">return</span> c;
    }
}
</code></pre>
<p>为什么使用双亲委托机制：</p>
<ul>
<li>避免一个类被多次加载</li>
<li>安全，确保系统类 .Class 不被篡改</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[重新思考 weapp-tailwindcss 的未来 | 掘金一周 11.13]]></title>    <link>https://juejin.cn/post/7571892340878262310</link>    <guid>https://juejin.cn/post/7571892340878262310</guid>    <pubDate>2025-11-13T07:30:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571892340878262310" data-draft-id="7571892340877656102" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="重新思考 weapp-tailwindcss 的未来 | 掘金一周 11.13"/> <meta itemprop="keywords" content="前端,后端,人工智能"/> <meta itemprop="datePublished" content="2025-11-13T07:30:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金一周"/> <meta itemprop="url" content="https://juejin.cn/user/53218623894222"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            重新思考 weapp-tailwindcss 的未来 | 掘金一周 11.13
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/53218623894222/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金一周
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T07:30:39.000Z" title="Thu Nov 13 2025 07:30:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><em>本文字数1400+ ，阅读时间大约需要 5分钟。</em></p>
<blockquote>
<p>【掘金一周】本期亮点：</p>
</blockquote>
<ul>
<li>
<p><a href="https://juejin.cn/post/7569536278254125092" target="_blank" title="https://juejin.cn/post/7569536278254125092">重新思考 weapp-tailwindcss 的未来</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7568418604812632073" target="_blank" title="https://juejin.cn/post/7568418604812632073">就因为package.json里少了个^号，我们公司赔了客户十万块</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7569777676098814002" target="_blank" title="https://juejin.cn/post/7569777676098814002">如何用Claude Code 生成顶级UI ❇️</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7568416956040560694" target="_blank" title="https://juejin.cn/post/7568416956040560694">基于百度地图JSAPI Three的城市公交客流可视化（三）——实时公交</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7568859869693837348" target="_blank" title="https://juejin.cn/post/7568859869693837348"> java深度调试技术【第四五章：多线程和幽灵代码】</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7569959427879567370" target="_blank" title="https://juejin.cn/post/7569959427879567370">Elasticsearch 避坑指南：我在项目中总结的 14 条实用经验</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7568873939033260082" target="_blank" title="https://juejin.cn/post/7568873939033260082">Jetpack Navigation 3：领航未来</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7569422202950221859" target="_blank" title="https://juejin.cn/post/7569422202950221859">AI时代程序员如何高效提问与开发工作？</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7568418604812140553" target="_blank" title="https://juejin.cn/post/7568418604812140553">大模型如何革新搜索相关性？智能升级让搜索更“懂你”｜得物技术</a></p>
</li>
</ul>
<blockquote>
<p><strong>「上榜规则」</strong>：文章发布时间在本期「掘金一周」发布时间的前一周内；且符合各个栏目的内容定位和要求。 如发现文章有抄袭、洗稿等违反社区规则的行为，将取消当期及后续上榜资格。</p>
</blockquote>
<h2 data-id="heading-0">一周“金”选</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73d5bf990a124e3a87cffb06443ad9ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5LiA5ZGo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763623839&amp;x-signature=Q8OLc6DXXnapT0d0Dm9G0Nu9iBM%3D" alt="掘金一周 文章头图 1303x734.jpg" loading="lazy"/></p>
<p><em>内容评审们会在过去的一周内对社区深度技术好文进行挖掘和筛选，优质的技术文章有机会出现在下方榜单中，排名不分先后。</em></p>
<h3 data-id="heading-1">前端</h3>
<p><a href="https://juejin.cn/post/7569536278254125092" target="_blank" title="https://juejin.cn/post/7569536278254125092">重新思考 weapp-tailwindcss 的未来</a> <a href="https://juejin.cn/user/1943592290496919/posts" target="_blank" title="https://juejin.cn/user/1943592290496919/posts">@icebreaker </a></p>
<blockquote>
<p>决定“把锅背回<strong>运行时</strong>”以后，我做的第一件事就是把入口全部进行统一：<code>twMerge</code> / <code>twJoin</code> / <code>createTailwindMerge</code> / <code>extendTailwindMerge</code> / <code>cva</code> / <code>variants</code>……统统绑进同一套 transformer 里。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7568418604812632073" target="_blank" title="https://juejin.cn/post/7568418604812632073">就因为package.json里少了个^号，我们公司赔了客户十万块</a> <a href="https://juejin.cn/user/3878732754331096/posts" target="_blank" title="https://juejin.cn/user/3878732754331096/posts">@ErpanOmer </a></p>
<blockquote>
<p>流水线执行到<code>pnpm install</code>时，<code>pnpm</code>拿着<code>lock</code>文件，忠实地去找<code>@internal/core@1.3.5</code>这个包...
<strong>“Error: Package '1.3.5' not found.”</strong> 流水线崩溃了。一个本该5分钟完成的文案更新，导致了<strong>整个服务7个小时的宕机😖</strong>。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7569777676098814002" target="_blank" title="https://juejin.cn/post/7569777676098814002">如何用Claude Code 生成顶级UI ❇️</a> <a href="https://juejin.cn/user/2173085529944110/posts" target="_blank" title="https://juejin.cn/user/2173085529944110/posts">@hi大雄</a></p>
<blockquote>
<p>众所周知，OCR 过程，出现很大UI 信息缺失，比如：具体配色数值、阴影、间距、字体等，于是你会发现，最终AI完成的效果可能都没有60% 。于是核心思路是：<strong>解决样式信息大量丢失的问题，通过减少信息代差，让AI coding 完成的UI 风格有不错的效果</strong></p>
</blockquote>
<p><a href="https://juejin.cn/post/7568416956040560694" target="_blank" title="https://juejin.cn/post/7568416956040560694">基于百度地图JSAPI Three的城市公交客流可视化（三）——实时公交</a> <a href="https://juejin.cn/user/3408905680473438/posts" target="_blank" title="https://juejin.cn/user/3408905680473438/posts"> @小左OvO</a></p>
<blockquote>
<p>一般公交车更新实时位置都是socket，这里为了方便我们使用历史行进轨迹数据traceData.json进行调试，站台我们采用glb模型，并将模型朝向路线保证视觉正确，公交车运行时需要沿路行驶并且需要正确的朝向。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7569087944159150106" target="_blank" title="https://juejin.cn/post/7569087944159150106">TemPad Dev：免费的 Figma inspect 面板是怎么实现的</a> <a href="https://juejin.cn/user/4212984285234862/posts" target="_blank" title="https://juejin.cn/user/4212984285234862/posts"> @Justineo</a></p>
<blockquote>
<p>由于 Inspect 面板在推出 Dev Mode 以后被调整到付费墙后了，而且只读模式下我们也无法运行 Figma 插件，所以我们希望通过浏览器扩展，为只读模式用户提供基础的设计交付能力。</p>
</blockquote>
<h3 data-id="heading-2">后端</h3>
<p><a href="https://juejin.cn/post/7568859869693837348" target="_blank" title="https://juejin.cn/post/7568859869693837348"> java深度调试技术【第四五章：多线程和幽灵代码】</a>  <a href="https://juejin.cn/user/465848660928872/posts" target="_blank" title="https://juejin.cn/user/465848660928872/posts">@提前退休的java猿</a></p>
<blockquote>
<p>线程池任务不捕捉异常，并且使用了<code>CountDownLatch</code> 等到任务执行完成，如果执行过程中发生异常就会出现 主线程一直被阻塞</p>
</blockquote>
<p><a href="https://juejin.cn/post/7569959427879567370" target="_blank" title="https://juejin.cn/post/7569959427879567370">Elasticsearch 避坑指南：我在项目中总结的 14 条实用经验</a> <a href="https://juejin.cn/user/3485898277388519/posts" target="_blank" title="https://juejin.cn/user/3485898277388519/posts">@一旅人</a></p>
<blockquote>
<p>刚开始接触 Elasticsearch 时，我觉得它就像个黑盒子——数据往里一扔，查询语句一写，结果就出来了。直到负责公司核心业务的搜索模块后，我才发现这个黑盒子里面藏着无数需要注意的细节。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7568812341010366515" target="_blank" title="https://juejin.cn/post/7568812341010366515">你的项目还在用MyBatis吗？或许这个框架更适合你：Easy-Query</a>
<a href="https://juejin.cn/user/4001878056904584/posts" target="_blank" title="https://juejin.cn/user/4001878056904584/posts">@SimonKing</a></p>
<blockquote>
<p>它的核心目标是让查询变得“简单”（Easy），通过极简的 <code>API</code>设计、强大的链式操作和智能的 <code>SQL</code>生成，让开发者能够以更少的代码完成复杂的数据交互任务。既能完成单表的操作，也能通过隐式结构进行<code>Join</code>关联操作等。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7569213885095673883" target="_blank" title="https://juejin.cn/post/7569213885095673883">得物管理类目配置线上化：从业务痛点到技术实现</a> <a href="https://juejin.cn/user/2392954206960247/posts" target="_blank" title="https://juejin.cn/user/2392954206960247/posts">@得物技术</a></p>
<blockquote>
<p>管理类目配置线上化项目的核心价值，不仅在于技术层面的效率提升，更在于通过自动化工具链，让业务方从 “规则提报的执行者” 转变为 “业务策略的设计者”。</p>
</blockquote>
<h3 data-id="heading-3">Android</h3>
<p><a href="https://juejin.cn/post/7568873939033260082" target="_blank" title="https://juejin.cn/post/7568873939033260082">Jetpack Navigation 3：领航未来</a> <a href="https://juejin.cn/user/941602739853453/posts" target="_blank" title="https://juejin.cn/user/941602739853453/posts">@bqliang</a></p>
<blockquote>
<p>在 Nav3 里，NavEntry 充当了路由描述符的角色，它包含了具体 key 实例、UI 内容以及其他各种配置信息，而 EntryProvider 则是负责根据 Key 来返回对应的 NavEntry。</p>
</blockquote>
<h3 data-id="heading-4">人工智能</h3>
<p><a href="https://juejin.cn/post/7569422202950221859" target="_blank" title="https://juejin.cn/post/7569422202950221859">AI时代程序员如何高效提问与开发工作？</a> <a href="https://juejin.cn/user/3817959264107757/posts" target="_blank" title="https://juejin.cn/user/3817959264107757/posts">@蓝瑟</a></p>
<blockquote>
<p>在AI辅助编程的实践中，我们需要建立系统化的方法体系。本节按照<strong>学习-&gt;理解-&gt;创造-&gt;优化</strong>的逻辑顺序，重新组织AI在编程各环节的应用技巧。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7568418604812140553" target="_blank" title="https://juejin.cn/post/7568418604812140553">大模型如何革新搜索相关性？智能升级让搜索更“懂你”｜得物技术</a> <a href="https://juejin.cn/user/2392954206960247/posts" target="_blank" title="https://juejin.cn/user/2392954206960247/posts"> @得物技术</a></p>
<blockquote>
<p>我们将端到端的相关性判断拆分为两个阶段。一阶段侧重理解用户查询，从中抽取出品牌、系列、适用人群等关键属性。二阶段则对内容进行属性解析，并逐一判断其与查询意图的一致性。</p>
</blockquote>
<h2 data-id="heading-5">社区活动日历</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c589decbd804477a753bfc1a3b8f5df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5LiA5ZGo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763623839&amp;x-signature=mSBcRly7yUnh7GK0Ff2UJWqez9g%3D" alt="掘金官方 文章头图 1303x734.jpg" loading="lazy"/></p>
<h4 data-id="heading-6">活动日历</h4>

















<table><thead><tr><th>活动名称</th><th>活动时间</th><th/><th/></tr></thead><tbody><tr><td><a href="https://juejin.cn/post/7571751304625815598" target="_blank" title="https://juejin.cn/post/7571751304625815598">🚀TRAE SOLO 实战赛</a></td><td>2025年11月13日-2025年12月16日</td><td/><td/></tr></tbody></table>
<h2 data-id="heading-7">📖 投稿专区</h2>
<blockquote>
<p>大家可以在评论区推荐认为不错的文章，并附上链接和推荐理由，有机会呈现在下一期。文章创建日期必须在下期掘金一周发布前一周以内；可以推荐自己的文章、也可以推荐他人的文章。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【浏览器插件】一键下载页面图片和文本]]></title>    <link>https://juejin.cn/post/7571768210715344911</link>    <guid>https://juejin.cn/post/7571768210715344911</guid>    <pubDate>2025-11-13T07:34:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571768210715344911" data-draft-id="7571830282849992755" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【浏览器插件】一键下载页面图片和文本"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-13T07:34:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Jolyne_"/> <meta itemprop="url" content="https://juejin.cn/user/339101640827981"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【浏览器插件】一键下载页面图片和文本
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/339101640827981/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Jolyne_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T07:34:00.000Z" title="Thu Nov 13 2025 07:34:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近我的朋友们工作上好像没事就要下载页面的图片和文本，于是我干脆写了个谷歌浏览器插件，下载当前页面所有的图片和文本，方便省事嘿嘿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e55737e14b4545b592eed6c9f715083e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSm9seW5lXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763624040&amp;x-signature=1%2B2ko9zkrBiD1VOYgJscTnoo%2BHY%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">目录结构</h2>
<pre><code class="hljs language-bash" lang="bash">image-text-plugin/
├── icons/                  <span class="hljs-comment"># 插件图标（可使用在线图标替代）</span>
│   ├── icon16.png
│   ├── icon48.png
│   └── icon128.png
├── manifest.json           <span class="hljs-comment"># 插件配置文件</span>
├── popup.html              <span class="hljs-comment"># 弹出窗口界面</span>
├── popup.js                <span class="hljs-comment"># 弹出窗口逻辑</span>
├── content.js              <span class="hljs-comment"># 页面内容处理脚本</span>
└── download.js             <span class="hljs-comment"># 页面图片处理脚本</span>
</code></pre>
<h2 data-id="heading-1">manifest.json</h2>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"manifest_version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"文本复制、图片下载"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"点击即可复制当前网页的所有文本内容到剪贴板，或者下载当前页面的所有图片"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"icons"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"16"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"icons/copy.png"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"48"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"icons/copy.png"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"128"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"icons/copy.png"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"default_popup"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"popup.html"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"default_icon"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"icons/copy.png"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"permissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"activeTab"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"scripting"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"contextMenus"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"downloads"</span><span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
</code></pre>
<p>当点击浏览器拓展程序时，要显示 <code>popup.html</code> 的内容</p>
<h2 data-id="heading-2">popup.html</h2>
<pre><code class="hljs language-html" lang="html"> <span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-tag">body</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">180px</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">15px</span>;
      <span class="hljs-attribute">font-family</span>: Arial, sans-serif;
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f8f9fa</span>;
    }
    <span class="hljs-selector-class">.container</span> {
      <span class="hljs-attribute">text-align</span>: center;
    }
    <span class="hljs-selector-id">#copyBtn</span>, <span class="hljs-selector-id">#downloadBtn</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>;
      <span class="hljs-attribute">color</span>: white;
      <span class="hljs-attribute">border</span>: none;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
      <span class="hljs-attribute">cursor</span>: pointer;
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
      <span class="hljs-attribute">font-weight</span>: bold;
      <span class="hljs-attribute">transition</span>: background-color <span class="hljs-number">0.3s</span>;
    }
    <span class="hljs-selector-id">#copyBtn</span> {
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#4285f4</span>;
    }
    <span class="hljs-selector-id">#downloadBtn</span> {
      <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">12px</span>;
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#df42f4</span>;
    }
    <span class="hljs-selector-id">#copyBtn</span><span class="hljs-selector-pseudo">:hover</span> {
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#3367d6</span>;
    }
    <span class="hljs-selector-id">#downloadBtn</span><span class="hljs-selector-pseudo">:hover</span>{
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#b42fc5</span>;
    }
    <span class="hljs-selector-id">#status</span> {
      <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">12px</span>;
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
      <span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>;
    }
    <span class="hljs-selector-class">.success</span> {
      <span class="hljs-attribute">color</span>: <span class="hljs-number">#198754</span> <span class="hljs-meta">!important</span>;
    }
    <span class="hljs-selector-class">.error</span> {
      <span class="hljs-attribute">color</span>: <span class="hljs-number">#dc3545</span> <span class="hljs-meta">!important</span>;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"copyBtn"</span>&gt;</span>复制当前页面所有文本<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"downloadBtn"</span>&gt;</span>下载当前页面所有图片<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"status"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"popup.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>两个按钮，分别复制文本、下载图片。然后再加上一个状态提示是否成功</p>
<p>并注入脚本 <code>popup.js</code></p>
<h2 data-id="heading-3">popup.js</h2>
<p>脚本的代码在页面加载完成后才执行</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"DOMContentLoaded"</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">//...</span>
});
</code></pre>
<h3 data-id="heading-4">复制文本</h3>
<p>先看复制文本的脚本</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"DOMContentLoaded"</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> copyBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"copyBtn"</span>);
  <span class="hljs-keyword">const</span> status = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"status"</span>);
  
    copyBtn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"click"</span>, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 获取当前活跃标签页</span>
      <span class="hljs-keyword">const</span> [tab] = <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">tabs</span>.<span class="hljs-title function_">query</span>({
        <span class="hljs-attr">active</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">currentWindow</span>: <span class="hljs-literal">true</span>,
      });

      <span class="hljs-comment">// 向页面注入内容脚本，获取所有文本</span>
      <span class="hljs-keyword">const</span> results = <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">scripting</span>.<span class="hljs-title function_">executeScript</span>({
        <span class="hljs-attr">target</span>: { <span class="hljs-attr">tabId</span>: tab.<span class="hljs-property">id</span> },
        <span class="hljs-attr">files</span>: [<span class="hljs-string">"content.js"</span>],
      });

      <span class="hljs-comment">// 提取文本内容</span>
      <span class="hljs-keyword">const</span> pageText = results[<span class="hljs-number">0</span>].<span class="hljs-property">result</span>;

      <span class="hljs-keyword">if</span> (!pageText.<span class="hljs-title function_">trim</span>()) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"当前页面没有可复制的文本"</span>);
      }

      <span class="hljs-comment">// 复制到剪贴板</span>
      <span class="hljs-keyword">await</span> navigator.<span class="hljs-property">clipboard</span>.<span class="hljs-title function_">writeText</span>(pageText);

      <span class="hljs-comment">// 显示成功提示</span>
      status.<span class="hljs-property">textContent</span> = <span class="hljs-string">"✅ 复制成功！"</span>;
      status.<span class="hljs-property">className</span> = <span class="hljs-string">"success"</span>;
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-comment">// 显示错误提示</span>
      status.<span class="hljs-property">textContent</span> = <span class="hljs-string">`❌ 复制失败：<span class="hljs-subst">${error.message}</span>`</span>;
      status.<span class="hljs-property">className</span> = <span class="hljs-string">"error"</span>;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"复制失败："</span>, error);
    }

    <span class="hljs-comment">// 3秒后清除提示</span>
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      status.<span class="hljs-property">textContent</span> = <span class="hljs-string">""</span>;
      status.<span class="hljs-property">className</span> = <span class="hljs-string">""</span>;
    }, <span class="hljs-number">3000</span>);
  });
  
  <span class="hljs-comment">//...</span>
  
});
</code></pre>
<p>当我们执行复制操作时，会往当前页面注入 <code>content.js</code> 的脚本，拿到执行结果</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// content.js - 保留换行的文本提取逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getAllPageTextWithLineBreaks</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> tempDoc = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">cloneNode</span>(<span class="hljs-literal">true</span>);
  
  <span class="hljs-comment">// 移除不需要的标签（脚本、样式、iframe等）</span>
  <span class="hljs-keyword">const</span> removeTags = [<span class="hljs-string">'script'</span>, <span class="hljs-string">'style'</span>, <span class="hljs-string">'noscript'</span>, <span class="hljs-string">'iframe'</span>, <span class="hljs-string">'svg'</span>, <span class="hljs-string">'canvas'</span>];
  removeTags.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">tag</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> elements = tempDoc.<span class="hljs-title function_">querySelectorAll</span>(tag);
    elements.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">el</span> =&gt;</span> el.<span class="hljs-title function_">remove</span>());
  });

  <span class="hljs-comment">// 定义需要自动换行的块级元素和重要行内元素</span>
  <span class="hljs-keyword">const</span> blockElements = [
    <span class="hljs-string">'div'</span>, <span class="hljs-string">'p'</span>, <span class="hljs-string">'h1'</span>, <span class="hljs-string">'h2'</span>, <span class="hljs-string">'h3'</span>, <span class="hljs-string">'h4'</span>, <span class="hljs-string">'h5'</span>, <span class="hljs-string">'h6'</span>,
    <span class="hljs-string">'ul'</span>, <span class="hljs-string">'ol'</span>, <span class="hljs-string">'li'</span>, <span class="hljs-string">'dl'</span>, <span class="hljs-string">'dt'</span>, <span class="hljs-string">'dd'</span>, <span class="hljs-string">'table'</span>, <span class="hljs-string">'tr'</span>, <span class="hljs-string">'td'</span>,
    <span class="hljs-string">'header'</span>, <span class="hljs-string">'footer'</span>, <span class="hljs-string">'section'</span>, <span class="hljs-string">'article'</span>, <span class="hljs-string">'nav'</span>, <span class="hljs-string">'aside'</span>,
    <span class="hljs-string">'blockquote'</span>, <span class="hljs-string">'pre'</span>, <span class="hljs-string">'address'</span>, <span class="hljs-string">'figure'</span>, <span class="hljs-string">'figcaption'</span>
  ];

  <span class="hljs-comment">// 收集所有文本节点，同时记录元素类型以添加换行</span>
  <span class="hljs-keyword">const</span> textParts = [];
  <span class="hljs-keyword">const</span> walker = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTreeWalker</span>(tempDoc.<span class="hljs-property">body</span>, <span class="hljs-title class_">NodeFilter</span>.<span class="hljs-property">SHOW_TEXT</span>, <span class="hljs-function">(<span class="hljs-params">node</span>) =&gt;</span> {
    <span class="hljs-comment">// 过滤掉纯空白文本节点</span>
    <span class="hljs-keyword">return</span> node.<span class="hljs-property">textContent</span>.<span class="hljs-title function_">trim</span>() ? <span class="hljs-title class_">NodeFilter</span>.<span class="hljs-property">FILTER_ACCEPT</span> : <span class="hljs-title class_">NodeFilter</span>.<span class="hljs-property">FILTER_REJECT</span>;
  });

  <span class="hljs-keyword">let</span> currentNode;
  <span class="hljs-keyword">let</span> prevElement = <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">while</span> (currentNode = walker.<span class="hljs-title function_">nextNode</span>()) {
    <span class="hljs-keyword">const</span> text = currentNode.<span class="hljs-property">textContent</span>.<span class="hljs-title function_">trim</span>();
    <span class="hljs-keyword">if</span> (!text) <span class="hljs-keyword">continue</span>;

    <span class="hljs-comment">// 获取当前文本节点的父元素</span>
    <span class="hljs-keyword">const</span> parentEl = currentNode.<span class="hljs-property">parentElement</span>;
    <span class="hljs-keyword">const</span> parentTag = parentEl.<span class="hljs-property">tagName</span>.<span class="hljs-title function_">toLowerCase</span>();

    <span class="hljs-comment">// 逻辑：添加换行的情况</span>
    <span class="hljs-keyword">const</span> shouldAddLineBreak = (<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 1. 如果前一个元素是块级元素，添加换行</span>
      <span class="hljs-keyword">if</span> (prevElement &amp;&amp; blockElements.<span class="hljs-title function_">includes</span>(prevElement.<span class="hljs-property">tagName</span>.<span class="hljs-title function_">toLowerCase</span>())) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      }
      <span class="hljs-comment">// 2. 如果当前父元素是块级元素，且不是第一个元素，添加换行</span>
      <span class="hljs-keyword">if</span> (blockElements.<span class="hljs-title function_">includes</span>(parentTag) &amp;&amp; textParts.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      }
      <span class="hljs-comment">// 3. 如果前一个元素和当前元素是不同的行内兄弟元素，添加换行</span>
      <span class="hljs-keyword">if</span> (prevElement &amp;&amp; 
          prevElement.<span class="hljs-property">parentElement</span> === parentEl.<span class="hljs-property">parentElement</span> &amp;&amp; 
          !blockElements.<span class="hljs-title function_">includes</span>(prevElement.<span class="hljs-property">tagName</span>.<span class="hljs-title function_">toLowerCase</span>()) &amp;&amp;
          !blockElements.<span class="hljs-title function_">includes</span>(parentTag)) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      }
      <span class="hljs-comment">// 4. 列表项特殊处理：每个li前加换行</span>
      <span class="hljs-keyword">if</span> (parentTag === <span class="hljs-string">'li'</span> &amp;&amp; textParts.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    })();

    <span class="hljs-comment">// 根据判断添加换行符</span>
    <span class="hljs-keyword">if</span> (shouldAddLineBreak) {
      <span class="hljs-comment">// 避免连续多个换行</span>
      <span class="hljs-keyword">const</span> lastPart = textParts[textParts.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];
      <span class="hljs-keyword">if</span> (!lastPart || !lastPart.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'\n\n'</span>)) {
        textParts.<span class="hljs-title function_">push</span>(<span class="hljs-string">'\n'</span>);
      }
    }

    <span class="hljs-comment">// 添加当前文本（清理内部多余空白）</span>
    <span class="hljs-keyword">const</span> cleanedText = text.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\s+/g</span>, <span class="hljs-string">' '</span>); <span class="hljs-comment">// 只清理文本内部的多余空白</span>
    textParts.<span class="hljs-title function_">push</span>(cleanedText);

    <span class="hljs-comment">// 更新前一个元素记录</span>
    prevElement = parentEl;
  }

  <span class="hljs-comment">// 合并所有部分，处理首尾换行</span>
  <span class="hljs-keyword">let</span> finalText = textParts.<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>)
    .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^\n+/</span>, <span class="hljs-string">''</span>) <span class="hljs-comment">// 移除开头的换行</span>
    .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\n+$/</span>, <span class="hljs-string">''</span>) <span class="hljs-comment">// 移除结尾的换行</span>
    .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\n{3,}/g</span>, <span class="hljs-string">'\n\n'</span>); <span class="hljs-comment">// 最多保留两个连续换行（模拟段落间距）</span>

  <span class="hljs-keyword">return</span> finalText;
}

<span class="hljs-comment">// 将结果返回给popup</span>
<span class="hljs-title function_">getAllPageTextWithLineBreaks</span>();
</code></pre>
<p>然后通过 <code>navigator.clipboard.writeText(pageText)</code> 复制文本</p>
<p>这里面主要是复制文本后，保持换行。比如文本是 <code>11 222</code> 复制出来的就是</p>
<pre><code class="hljs language-html" lang="html">11
222
</code></pre>
<p>换行的</p>
<h3 data-id="heading-5">图片下载</h3>
<p>图片下载也一样的</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"DOMContentLoaded"</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> downloadBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"downloadBtn"</span>);
  <span class="hljs-keyword">const</span> status = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"status"</span>);

  downloadBtn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"click"</span>, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 获取当前活跃标签页</span>
      <span class="hljs-keyword">const</span> [tab] = <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">tabs</span>.<span class="hljs-title function_">query</span>({
        <span class="hljs-attr">active</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">currentWindow</span>: <span class="hljs-literal">true</span>,
      });

      <span class="hljs-comment">// 向页面注入内容脚本，获取所有文本</span>
      <span class="hljs-keyword">const</span> results = <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">scripting</span>.<span class="hljs-title function_">executeScript</span>({
        <span class="hljs-attr">target</span>: { <span class="hljs-attr">tabId</span>: tab.<span class="hljs-property">id</span> },
        <span class="hljs-attr">files</span>: [<span class="hljs-string">"download.js"</span>],
      });

      <span class="hljs-comment">// 获取执行结果</span>
      <span class="hljs-keyword">if</span> (!results || !results[<span class="hljs-number">0</span>]?.<span class="hljs-property">result</span> || results[<span class="hljs-number">0</span>].<span class="hljs-property">result</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"未找到图片"</span>);
        <span class="hljs-keyword">return</span>;
      }
      status.<span class="hljs-property">textContent</span> = <span class="hljs-string">"✅ 正在下载"</span>;
      status.<span class="hljs-property">className</span> = <span class="hljs-string">"success"</span>;
      <span class="hljs-keyword">const</span> images = results[<span class="hljs-number">0</span>].<span class="hljs-property">result</span>;
      <span class="hljs-comment">// 批量下载图片</span>
      images.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">async</span> (url, index) =&gt; {
        <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">downloads</span>.<span class="hljs-title function_">download</span>({
          <span class="hljs-attr">url</span>: url,
          <span class="hljs-attr">filename</span>: <span class="hljs-string">`images/image_<span class="hljs-subst">${index + <span class="hljs-number">1</span>}</span>.jpg`</span>, <span class="hljs-comment">// 保存路径</span>
          <span class="hljs-attr">saveAs</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 不弹出保存对话框</span>
        })
        <span class="hljs-comment">// setTimeout(() =&gt; {</span>
        <span class="hljs-comment">//   chrome.downloads.download({</span>
        <span class="hljs-comment">//     url: url,</span>
        <span class="hljs-comment">//     filename: `images/image_${index + 1}.jpg`, // 保存路径</span>
        <span class="hljs-comment">//     saveAs: false, // 不弹出保存对话框</span>
        <span class="hljs-comment">//   });</span>
        <span class="hljs-comment">// }, index * 500); // 每张图片间隔 500ms，避免浏览器限制</span>
      });
      <span class="hljs-comment">// 显示成功提示</span>
      status.<span class="hljs-property">textContent</span> = <span class="hljs-string">"✅ 下载完成！"</span>;
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-comment">// 显示错误提示</span>
      status.<span class="hljs-property">textContent</span> = <span class="hljs-string">`❌ 下载失败：<span class="hljs-subst">${error.message}</span>`</span>;
      status.<span class="hljs-property">className</span> = <span class="hljs-string">"error"</span>;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"下载失败："</span>, error);
    }

    <span class="hljs-comment">// 3秒后清除提示</span>
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      status.<span class="hljs-property">textContent</span> = <span class="hljs-string">""</span>;
      status.<span class="hljs-property">className</span> = <span class="hljs-string">""</span>;
    }, <span class="hljs-number">3000</span>);
  });
});
</code></pre>
<p>点击下载图片的按钮后，执行脚本，注入 <code>download.js</code> 脚本，拿到执行结果</p>
<pre><code class="hljs language-download.js" lang="download.js">// 在页面中执行的函数，用于获取所有图片URL
function getImagesFromPage() {
  const images = Array.from(document.images)
    .map((img) =&gt; img.src)
    .filter((src) =&gt; src.startsWith("http"));

  return images;
}

getImagesFromPage();
</code></pre>
<p>然后通过 <code>chrome.downloads.download</code> 把图片都下载出来</p>
<h2 data-id="heading-6">效果演示</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a40caa5164a47bdbd849ca25dcde849~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSm9seW5lXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763624040&amp;x-signature=KdfUyvL2iX9vB8zd%2FowIrNxi8pI%3D" alt="QQ20251113-152420.gif" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[IM系统-客户端架构（一）]]></title>    <link>https://juejin.cn/post/7571742703534833700</link>    <guid>https://juejin.cn/post/7571742703534833700</guid>    <pubDate>2025-11-13T07:25:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571742703534833700" data-draft-id="7571742703534669860" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="IM系统-客户端架构（一）"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-13T07:25:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="锅拌饭"/> <meta itemprop="url" content="https://juejin.cn/user/210732593191543"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            IM系统-客户端架构（一）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/210732593191543/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    锅拌饭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T07:25:43.000Z" title="Thu Nov 13 2025 07:25:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>即时通讯系统（Instant Messaging，简称IM），允许用户通过互联网实时相互发送/接收信息。在移动互联网时代，主流软件大都内置了自己的IM系统。除了微信、飞书这样的IM应用外，还有像淘宝、京东、美团也有自己的IM客服入口，小红书、抖音等社区视频类软件，也有自己的IM社交系统入口。</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f02a87106c0b40939f9a1f0d91c5bbff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZSF5ouM6aWt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763623543&amp;x-signature=xG10hg02pfPOeZHlNpPcVNoZSxM%3D" width="300" loading="lazy"/>
<p>IM功能主要包括<strong>消息的收发、用户登录态管理、会话管理</strong>等基础功能。还有<strong>群聊会话、富文本消息、语音视频聊天</strong>等高级功能。当然对于飞书这样的办公应用，还有<strong>机器人、日历日程、开放平台、云文档</strong>等定制化功能。同时当前AI兴起，在IM中也有大量应用场景，比如<strong>AI总结文档、AI总结未读消息</strong>等功能。</p>
<p>网络上有很多IM服务端相关文章，对于客户端的技术选型、细节等描述较少。本文主要聚焦在客户端架构选型上。</p>
<h2 data-id="heading-0">一、客户端整体架构</h2>
<p>在一个公司中，可能会有多个业务方都用到了IM功能，为避免重复开发，一般会将IM业务封装为SDK，将通用业务下沉到SDK中，方便各个业务方直接使用。以字节跳动为例，正常的架构可能会如下：</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c2fe4c7f4c9474893e155008a91aab7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZSF5ouM6aWt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763623543&amp;x-signature=3XPy7otALB3o6PkEluDwRqecMmg%3D" loading="lazy"/>
<p><strong>IM服务端：</strong> 提供稳定、实时的各项服务，如消息收发、登录注册、消息同步、会话管理等功能。</p>
<p><strong>客户端网络层SDK：</strong> 这里一般指长链SDK，即<code>socket</code>层。提供数据加解密、数据压缩、数据传输，保证数据实时、安全、高效传输。</p>
<p><strong>客户端IM业务层SDK：</strong> 处理客户端的业务逻辑处理，如消息/会话同步、用户状态管理、未读数管理、数据存储、设置管理、本地缓存等能力。</p>
<h2 data-id="heading-1">二、网络选型</h2>
<p>在IM系统中，网络层的选型无疑是最重要的。在实际使用中，通常会有这四种技术：<code>短轮询</code>、<code>长轮询</code>、<code>WebSocket</code>、<code>SSE</code>。</p>
<h3 data-id="heading-2">1. 短轮询</h3>
<p>客户端定时，如每500毫秒向服务端发送<code>HTTP</code>请求，服务端处理完成后返回请求数据。<a href="https://link.juejin.cn?target=https%3A%2F%2Fbackendgarden.com%2Fnotes%2Fhttp-polling" target="_blank" title="https://backendgarden.com/notes/http-polling" ref="nofollow noopener noreferrer">HTTP Polling</a></p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2674f6880c54e3fa0dfad3aca971431~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZSF5ouM6aWt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763623543&amp;x-signature=%2BTvA5wfXXLg2nLdsDufcQeRCDAI%3D" loading="lazy"/>
<p><strong>优点：</strong> 实现简单、兼容性好</p>
<p><strong>缺点：</strong> <code>HTTP</code>多次请求浪费客户端流量，占用多个服务端端口等资源。</p>
<p><strong>实时性：</strong> 差</p>
<p><strong>适用场景：</strong> 非常少，使用频率低的页面</p>
<p>在移动端的扫描二维码页面，会采用<code>短轮询</code>方式。还有网页端的赛事比分展示页面，也可能会采用<code>短轮询</code>方式。</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/981d2248281c485380dca93d64e7af86~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZSF5ouM6aWt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763623543&amp;x-signature=bz0bacwfdKohP23iEoLEk3%2BlWlw%3D" width="400" loading="lazy"/>
<p><code>短轮询</code>开发成本极低，但是频繁调用服务端接口，对服务端的CPU和端口资源占用极大。在实际开发中使用较少。</p>
<h3 data-id="heading-3">2. 长轮询</h3>
<p>客户端发送<code>HTTP</code>请求后，服务端挂起连接直到数据更新或超时，返回响应后，客户端立即发起新请求。</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5fdc283aeee14a53b0d3b280488e0691~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZSF5ouM6aWt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763623543&amp;x-signature=kHNpVQcvdx%2F0ox%2BGUlWnTlP1ub0%3D" loading="lazy"/>
<p><strong>优点：</strong> 减少无效请求，比<code>短轮询</code>实时性好，资源消耗低</p>
<p><strong>缺点：</strong> 服务端需维护挂起连接，高并发时资源消耗仍然比较大</p>
<p><strong>实时性：</strong> 好</p>
<p><strong>适用场景：</strong> 有实时性要求，但是无法使用<code>WebSocket</code>、<code>SSE</code>的场景</p>
<p>在实际开发过程中，客户端还没有用到过这个技术。服务端的<code>Nacos</code>的配置中心使用较多，可查看文章：<a href="https://juejin.cn/post/7137124336783065125" target="_blank" title="https://juejin.cn/post/7137124336783065125">实现一个简单的长轮询</a></p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c6a875b3a8c4f2cae32be9a31e8fdaa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZSF5ouM6aWt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763623543&amp;x-signature=DhW71Ks2oG%2BIXCCr8DXCFFgBZTE%3D" width="400" loading="lazy"/>
<ul>
<li>
<p>首先客户端发起<code>长轮询</code>请求，服务端收到客户端的请求，这时会挂起客户端的请求，如果在服务端设计的30s之内都没有发生变更，服务端会响应回客户端数据没有变更，客户端会继续发送请求。</p>
</li>
<li>
<p>如果在30s之内服务数据发生了变更，服务端会推送变更的数据到客户端。</p>
</li>
</ul>
<h3 data-id="heading-4">3. Server Send Event (SSE)</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.bytebytego.com%2Fp%2Fnetwork-protocols-behind-server-push" target="_blank" title="https://blog.bytebytego.com/p/network-protocols-behind-server-push" ref="nofollow noopener noreferrer">Network Protocols behind Server Push, Online Gaming, and Emails</a></p>
<p>基于<code>HTTP</code>协议，客户端和服务端三次握手建立连接后，连接不断开，服务端可以主动推送数据流（如<code>Content-Type: text/event-stream</code>）</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/804a066541dd41be91715cd5be06710d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZSF5ouM6aWt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763623543&amp;x-signature=2UIm3wOuv0VW0zHwlwx66x94dnA%3D" loading="lazy"/>
<p><strong>优点：</strong> 基于<code>HTTP</code>，支持断线重连、内网穿透、心跳保活等功能</p>
<p><strong>缺点：</strong> 半双工，仅支持服务端主动向客户端发送数据，不支持客户端向服务端发送数据。</p>
<p><strong>实时性：</strong> 好</p>
<p><strong>适用场景：</strong> 股票行情走势图、新闻推送</p>
<p>伴随AI发展，目前一些主流的AI应用，采用的也是<code>SSE</code>。</p>
<p>在网页端问问题后，豆包和<code>deepseek</code>都有一个<code>SSE</code>连接，服务端不断向客户端返回问题结果，客户端根据服务端返回内容进行流式输出。</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd833e9007f6469cadef20abf835c348~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZSF5ouM6aWt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763623543&amp;x-signature=x8HSh3cnAZjy8PgKmJ%2B2pSnYXKA%3D" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a447811d5c44653b6f8dceee1b4b4c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZSF5ouM6aWt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763623543&amp;x-signature=L%2B50dSFDiGgWD0dFUWGR%2B8b6Wdo%3D" loading="lazy"/>
<h3 data-id="heading-5">4. WebSocket</h3>
<p>基于<code>TCP</code>的全双工协议，前期通过<code>HTTP</code>升级握手（<code>Upgrade: websocket</code>）建立持久连接，后续通过<code>TCP</code>实现双向实时通信。</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34affe5948e4417eb48873d48e71187f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZSF5ouM6aWt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763623543&amp;x-signature=ZRfQ4GKfObWqwByVnkT05QPE%2BDc%3D" loading="lazy"/>
<p><strong>优点：</strong> 全双工，客户端和服务端相互发送数据</p>
<p><strong>缺点：</strong> 实现复杂，需要单独处理重连、保活。</p>
<p><strong>实时性：</strong> 好</p>
<p><strong>适用场景：</strong> 在线游戏、直播弹幕、<code>Figma</code>协同编辑</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af6c59be82744b0fa56387400cce603d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZSF5ouM6aWt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763623543&amp;x-signature=IjPeMGJz%2FgIqMLlkavL5aeWl5BI%3D" width="300" loading="lazy"/>
<p><code>WebSocket</code>在所有方案中，功能上是最强大的，但是实现成本较高。同时<code>WebSocket</code>只有一个连接通道，所以数据量很大的时候，也会有一定的延迟。</p>
<p><strong>WebSocket建立连接的过程：</strong></p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05ae2553ff6646c0832b2f6d85c28f1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZSF5ouM6aWt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763623543&amp;x-signature=nki12wgxSfit5PIS8zba6xnjs%2BU%3D" loading="lazy"/>
<h3 data-id="heading-6">5. 总结</h3>








































<table><thead><tr><th>****</th><th><strong>短轮询</strong></th><th><strong>长轮询</strong></th><th><strong>SSE</strong></th><th><strong>WebSocket</strong></th></tr></thead><tbody><tr><td><strong>通信方向</strong></td><td>客户端→服务器</td><td>客户端→服务器</td><td>服务器→客户端</td><td>双向通信</td></tr><tr><td><strong>协议</strong></td><td>HTTP</td><td>HTTP</td><td>HTTP</td><td>WebSocket</td></tr><tr><td><strong>实时性</strong></td><td>低</td><td>中</td><td>好</td><td>好</td></tr><tr><td><strong>资源消耗</strong></td><td>高（频繁请求）</td><td>中（挂起连接）</td><td>低</td><td>低（长连接）</td></tr></tbody></table>
<p>IM应用的数据量大、实时性要求高，<code>短轮询</code>和<code>长轮询</code>显然不符合IM的要求。</p>
<p>对比<code>SSE</code>和<code>WebSocket</code>，<code>SSE</code>在开发成本上比<code>WebSocket</code>低，但是因为只支持单向通信，也不是<code>WebSocket</code>的最佳选择。而AI应用采用<code>SSE</code>的原因也很简单，因为从业务上看，AI应用的网络通信相对简单。在交互上，同一时间内一个会话只能发起一次请求，在<code>SSE</code>流式输出过程中，无法发起新的请求，或者可以发起新请求，老的请求会结束。</p>
<p>而IM应用中，在会话中，尤其是群聊会话中，在接受消息的同时，还可以多次发送消息，当然我们可以采用<code>SSE</code>+多个<code>HTTP</code>的框架，<code>SSE</code>负责服务端向客户端推送数据，<code>HTTP</code>负责客户端向服务端发送数据。但这样还是会有多个<code>HTTP</code>请求的资源浪费。</p>
<p>在IM应用中，使用<code>WebSocket</code>是最佳选择，虽然前期有一定开发成本，但是属于一劳永逸，后期复杂业务开发起来更加方便。</p>
<h2 data-id="heading-7">三、SDK选型</h2>
<h3 data-id="heading-8">1. 长连SDK</h3>
<p><strong>长连SDK</strong>目前推荐直接接入腾讯<code>Mars</code>，它更加贴合"移动互联网"、"移动平台"特性的网络解决方案，尤其针对弱网络、平台特性等有很多的相关优化策略。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F9DJxipJaaBC8yC-buHgnTQ" target="_blank" title="https://mp.weixin.qq.com/s/9DJxipJaaBC8yC-buHgnTQ" ref="nofollow noopener noreferrer">微信终端跨平台组件 mars 系列(二) - 信令传输超时设计</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTencent%2Fmars%2Fwiki" target="_blank" title="https://github.com/Tencent/mars/wiki" ref="nofollow noopener noreferrer">mars/wiki</a></p>
<p><code>mars</code> 是微信官方使用 <code>C++</code> 编写的业务性无关、平台性无关的终端基础组件，目前在微信 <code>Android</code>、<code>iOS</code>、<code>Windows</code>、<code>Mac</code>、<code>Windows Phone</code> 等多个平台中使用，并正在筹备开源，它主要包含以下几个独立的部分：</p>
<ol>
<li>
<p><code>COMM</code>：基础库，包括 <code>socket</code>、线程、消息队列、协程等基础工具；</p>
</li>
<li>
<p><code>XLOG</code>：通用日志模块，充分考虑移动终端的特点，提供高性能、高可用、安全性、容错性的日志功能；（详情点击：<a href="https://link.juejin.cn?target=http%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3NTYzODYzMg%3D%3D%26mid%3D2653577964%26idx%3D2%26sn%3D48ae92e40ae450327bc47498bd25280f%26chksm%3D84b3b0ebb3c439fd23a62625c088d1231229b4c2576cb50fdfb530751f4b70c12a404a556f30%26scene%3D21%23wechat_redirect" target="_blank" title="http://mp.weixin.qq.com/s?__biz=MzA3NTYzODYzMg==&amp;mid=2653577964&amp;idx=2&amp;sn=48ae92e40ae450327bc47498bd25280f&amp;chksm=84b3b0ebb3c439fd23a62625c088d1231229b4c2576cb50fdfb530751f4b70c12a404a556f30&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">高性能日志模块xlog</a> ）</p>
</li>
<li>
<p><code>SDT</code>：网络诊断模块；</p>
</li>
<li>
<p><code>STN</code>：信令传输网络模块，负责终端与服务器的小数据信令通道。包含了微信终端在移动网络上的大量优化经验与成果，经历了微信海量用户的考验。</p>
</li>
</ol>
<h3 data-id="heading-9">2. 业务层SDK</h3>
<p><strong>业务层SDK</strong>主要包含数据存储、会话消息同步、登录管理等逻辑。</p>
<p>主要讨论点，在于使用<code>C++</code>层SDK还是各端平台SDK。这两种方式各有利弊，最终应该结合各团队的人员分布情况决定。</p>
<ul>
<li>
<p><code>C++</code>层SDK，即将业务下沉到<code>C++</code>层，各端通过接口调用，如<code>Android</code>的<code>JNI</code>等</p>
</li>
<li>
<p>各端平台SDK，即各端将业务下沉到一个SDK中，可以快速复用，如<code>Android</code>的<code>aar</code>，<code>iOS</code>的<code>framework</code>等。</p>
</li>
</ul>
<h4 data-id="heading-10">2.1 C++层SDK</h4>
<h5 data-id="heading-11">优点</h5>
<ol>
<li>
<p><code>C++</code>层SDK比较通用，可以跨平台，一次开发多端使用，开发成本上会有一定优势。而且在聊天记录迁移等业务上，也有实用价值。</p>
</li>
<li>
<p><code>C++</code>层SDK性能更优，执行效率更高。</p>
</li>
</ol>
<h5 data-id="heading-12">缺点</h5>
<ol>
<li><strong>性能损耗</strong></li>
</ol>
<p>以<code>Android</code>平台为例，纯<code>JNI</code>调用也会有额外耗时。</p>
<ul>
<li>
<p><strong>执行环境的切换</strong>：当从<code>Java</code>代码进入本地（<code>C/C++</code>）代码时，<code>Java</code>虚拟机（<code>JVM</code>）需要执行一系列操作来切换上下文。这包括保存当前<code>Java</code>线程的状态、切换到本地代码的执行环境，然后在返回时恢复状态。这个过程本身就有固定的时间成本。</p>
</li>
<li>
<p><strong>数据类型的转换与编组</strong>：<code>Java</code>和<code>C/C++</code>使用不同的数据类型和内存模型。当参数和返回值在两者间传递时，<code>JNI</code>需要进行转换（编组）。例如，<code>Java</code>的 <code>String</code>对象需要转换为<code>C</code>风格的 <code>char*</code>指针，数组也需要被<code>JNI</code>函数处理，这可能涉及整个数据块的复制。</p>
</li>
<li>
<p><strong>JNI函数调用本身的开销</strong>：在本地代码中，每次通过 <code>JNIEnv*</code>指针调用函数（如 <code>GetFieldID</code>, <code>CallVoidMethod</code>）都是一次函数调用。与虚拟机的交互使得<code>JIT</code>编译器难以对这些调用进行内联等优化。</p>
</li>
</ul>
<ol start="2">
<li><strong>线程切换</strong></li>
</ol>
<p>从开发规范上来看，所有的<code>JNI</code>调用都要在异步线程。这会导致一些简单的运算也要切换线程，导致渲染延迟。以会话ID为例，会话ID=会话id_会话类型。这是一个很简单的拼接逻辑，在某些场景下，我们客户端只有会话id，业务上需要获取对应的会话类型。那就必须调用<code>C++</code>的反解方法，根据拼接规则，反解获取会话类型。当然还有另一种方式，就是各端将反解逻辑再实现一遍，这就背离了通用SDK的初衷，而且规则是随业务发生变化的，后续会话id还可能拼接其他后缀，每一次改动都要各端适配。</p>
<p>会话id的例子是为了说明，即使是很简单的逻辑，通过<code>JNI</code>调用也有线程切换的损耗。</p>
<p>当然，上述问题也有对应的解决方案，那就是定义两类<code>JNI</code>方法。一种是异步线程调用的，参数可以有<code>json</code>格式数据，<code>native</code>可以有耗时操作。另一种是同步调用，参数只能有基本数据类型，<code>native</code>也不能有耗时操作。</p>
<ol start="3">
<li><strong>内存增加</strong></li>
</ol>
<p>在部分业务上，为了达到快速访问效果，通常会做缓存。比如最近进入过的会话的消息，做消息缓存，下次进入可以快速显示，而不需要<code>loading</code>。<code>C++</code>层SDK一定会做消息的缓存。端上为了避免线程切换+<code>JNI</code>耗时又做一遍，会导致内存增加。</p>
<p>需要注意，以<code>Android</code>平台为例，虽然系统限制的是单个应用<code>Java</code>内存不能超过<code>512M</code>，但是对于应用占用的整体内存也有限制，不能超过<code>1.2G</code>。同时<code>Android</code>平台的<code>LowMemoryKiller</code>的清理规则中，会根据应用占用整体内存进行加权，整体内存占用多的更容易被<code>LMK</code>杀掉。所以不要忽略<code>native</code>内存带来的影响。</p>
<ol start="4">
<li><strong>平台特性丢失</strong></li>
</ol>
<ul>
<li>
<p>在性能优化中，线程治理也是重要一环。当前的线程治理方案中，无论是字节码插桩还是其他方式，都无法做到对<code>native</code>线程的治理。</p>
</li>
<li>
<p><code>Android</code>和<code>iOS</code>平台的页面切换等生命周期，都需要通过<code>JNI</code>方法将事件通知给<code>native</code>。</p>
</li>
</ul>
<ol start="5">
<li><strong>开发效率可能降低</strong></li>
</ol>
<ul>
<li>
<p>一般来说，<code>C++</code>层SDK都是有专门的团队的，那各平台与<code>C++</code>层SDK的沟通会有成本。</p>
</li>
<li>
<p>在排查问题时，也需要客户端与<code>C++</code>层SDK的配合。</p>
</li>
<li>
<p>且<code>C++</code>层SDK无法断点，一些问题定位只能通过日志排查。</p>
</li>
</ul>
<h4 data-id="heading-13">2.2 各端平台SDK</h4>
<h5 data-id="heading-14">优点</h5>
<p>对比<code>C++</code>层的缺点，即为各端平台SDK的优点。</p>
<p>无<code>JNI</code>调用损耗、简单逻辑运算无需切换线程、缓存逻辑不会重复占用内存、各种客户端性能优化方案都能生效、沟通效率高。</p>
<h5 data-id="heading-15">缺点</h5>
<ol>
<li>
<p>开发成本高，同一个功能，团队整体工时可能是<code>C++</code>层的3倍（<code>Android</code>/<code>iOS</code>/前端）</p>
</li>
<li>
<p>各端数据存储不一致，聊天记录迁移等功能可能无法实现</p>
</li>
</ol>
<h3 data-id="heading-16">总结</h3>
<p>具体选择哪种方式，应该根据各自业务团队风格选择。一般来说，业内的通用方案是采用<code>C++</code>层SDK的方案。因为人力成本&gt;技术成本。</p>
<h2 data-id="heading-17">参考文章</h2>
<p><a href="https://juejin.cn/post/6844903609138692110" target="_blank" title="https://juejin.cn/post/6844903609138692110">菜鸟学网络之 —— 长连接和短连接</a></p>
<p><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4874-1-1.html" target="_blank" title="http://www.52im.net/thread-4874-1-1.html" ref="nofollow noopener noreferrer">转转客服IM聊天系统背后的技术挑战和实践分享-IM开发/专项技术区 - 即时通讯开发者社区!</a></p>
<p><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-3780-1-1.html" target="_blank" title="http://www.52im.net/thread-3780-1-1.html" ref="nofollow noopener noreferrer">探探的IM长连接技术实践：技术选型、架构设计、性能优化-IM开发/专项技术区 - 即时通讯开发者社区!</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F9DJxipJaaBC8yC-buHgnTQ" target="_blank" title="https://mp.weixin.qq.com/s/9DJxipJaaBC8yC-buHgnTQ" ref="nofollow noopener noreferrer">微信终端跨平台组件 mars 系列(二) - 信令传输超时设计</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.dreamtobe.cn%2Fmars%2F" target="_blank" title="https://blog.dreamtobe.cn/mars/" ref="nofollow noopener noreferrer">微信Mars策略分析</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[动态代理机制]]></title>    <link>https://juejin.cn/post/7572012699626831899</link>    <guid>https://juejin.cn/post/7572012699626831899</guid>    <pubDate>2025-11-13T07:42:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572012699626831899" data-draft-id="7571892340878311462" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="动态代理机制"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-13T07:42:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Jony_"/> <meta itemprop="url" content="https://juejin.cn/user/3403743732709767"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            动态代理机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3403743732709767/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Jony_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T07:42:53.000Z" title="Thu Nov 13 2025 07:42:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、概述</h2>
<p>区别于静态代理，动态代理提供了一种手段，能够在运行时生成代理类，并针对代理对象统一处理。所有业务逻辑都收敛到了 InvocationHandler.invoke 中，避免了业务逻辑过于冗余。</p>
<h2 data-id="heading-1">二、代理类</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">newProxyInstance</span><span class="hljs-params">(ClassLoader loader,
                                      Class&lt;?&gt;[] interfaces,
                                      InvocationHandler h)</span>
        <span class="hljs-keyword">throws</span> IllegalArgumentException {
    Objects.requireNonNull(h);
    
    <span class="hljs-keyword">final</span> Class&lt;?&gt;[] intfs = interfaces.clone();
    <span class="hljs-comment">// 1. 生成带代理类</span>
    Class&lt;?&gt; cl = getProxyClass0(loader, intfs);
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">final</span> Constructor&lt;?&gt; cons = cl.getConstructor(constructorParams);
        <span class="hljs-keyword">final</span> <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">ih</span> <span class="hljs-operator">=</span> h;
        <span class="hljs-comment">// 2. 修改访问标记符</span>
        <span class="hljs-keyword">if</span> (!Modifier.isPublic(cl.getModifiers())) cons.setAccessible(<span class="hljs-literal">true</span>);
        <span class="hljs-comment">// 3. 反射创建对象</span>
        <span class="hljs-keyword">return</span> cons.newInstance(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{h});
    } <span class="hljs-keyword">catch</span> (IllegalAccessException | InstantiationException e) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InternalError</span>(e.toString(), e);
    } <span class="hljs-keyword">catch</span> (InvocationTargetException e) {
        <span class="hljs-type">Throwable</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> e.getCause();
        <span class="hljs-keyword">if</span> (t <span class="hljs-keyword">instanceof</span> RuntimeException) {
            <span class="hljs-keyword">throw</span> (RuntimeException) t;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InternalError</span>(t.toString(), t);
        }
    } <span class="hljs-keyword">catch</span> (NoSuchMethodException e) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InternalError</span>(e.toString(), e);
    }
}
</code></pre>
<p>生成代理类的源代码如上，代理类主要是通过 getProxyClass0 来生成的。而 getProxyClass0 在首次加载的时候，也是通过 ProxyClassFactory 来完成的。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Class&lt;?&gt; getProxyClass0(ClassLoader loader,
                                       Class&lt;?&gt;... interfaces) {
    <span class="hljs-keyword">if</span> (interfaces.length &gt; <span class="hljs-number">65535</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"interface limit exceeded"</span>);
    }
    <span class="hljs-comment">// 1. 首次这里取到的肯定是 null 对象，然后交给了 ProxyClassFactory 处理</span>
    <span class="hljs-keyword">return</span> proxyClassCache.get(loader, interfaces);
}
</code></pre>
<p>ProxyClassFactory 的生成代理类源码如下 ：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> Class&lt;?&gt; apply(ClassLoader loader, Class&lt;?&gt;[] interfaces) {


    Map&lt;Class&lt;?&gt;, Boolean&gt; interfaceSet = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IdentityHashMap</span>&lt;&gt;(interfaces.length);
    
    <span class="hljs-comment">// 1、代理对象接口进行校验</span>
    <span class="hljs-keyword">for</span> (Class&lt;?&gt; intf : interfaces) {
        Class&lt;?&gt; interfaceClass = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">try</span> {
            interfaceClass = Class.forName(intf.getName(), <span class="hljs-literal">false</span>, loader);
        } <span class="hljs-keyword">catch</span> (ClassNotFoundException e) {
        }
        <span class="hljs-keyword">if</span> (interfaceClass != intf) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(
                    intf + <span class="hljs-string">" is not visible from class loader"</span>);
        }
        <span class="hljs-keyword">if</span> (!interfaceClass.isInterface()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(
                    interfaceClass.getName() + <span class="hljs-string">" is not an interface"</span>);
        }
        <span class="hljs-keyword">if</span> (interfaceSet.put(interfaceClass, Boolean.TRUE) != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(
                    <span class="hljs-string">"repeated interface: "</span> + interfaceClass.getName());
        }
    }
    <span class="hljs-type">String</span> <span class="hljs-variable">proxyPkg</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;     <span class="hljs-comment">// package to define proxy class in</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">accessFlags</span> <span class="hljs-operator">=</span> Modifier.PUBLIC | Modifier.FINAL;
    <span class="hljs-comment">// 2. 代理对象包名进行校验</span>
    <span class="hljs-keyword">for</span> (Class&lt;?&gt; intf : interfaces) {
        <span class="hljs-type">int</span> <span class="hljs-variable">flags</span> <span class="hljs-operator">=</span> intf.getModifiers();
        <span class="hljs-keyword">if</span> (!Modifier.isPublic(flags)) {
            accessFlags = Modifier.FINAL;
            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> intf.getName();
            <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> name.lastIndexOf(<span class="hljs-string">'.'</span>);
            <span class="hljs-type">String</span> <span class="hljs-variable">pkg</span> <span class="hljs-operator">=</span> ((n == -<span class="hljs-number">1</span>) ? <span class="hljs-string">""</span> : name.substring(<span class="hljs-number">0</span>, n + <span class="hljs-number">1</span>));
            <span class="hljs-keyword">if</span> (proxyPkg == <span class="hljs-literal">null</span>) {
                proxyPkg = pkg;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!pkg.equals(proxyPkg)) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(
                        <span class="hljs-string">"non-public interfaces from different packages"</span>);
            }
        }
    }
    {
        <span class="hljs-comment">// 3. 生成代理对象</span>
        List&lt;Method&gt; methods = getMethods(interfaces);
        Collections.sort(methods, ORDER_BY_SIGNATURE_AND_SUBTYPE);
        validateReturnTypes(methods);
        List&lt;Class&lt;?&gt;[]&gt; exceptions = deduplicateAndGetExceptions(methods);


        Method[] methodsArray = methods.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Method</span>[methods.size()]);
        Class&lt;?&gt;[][] exceptionsArray = exceptions.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>&lt;?&gt;[exceptions.size()][]);
        <span class="hljs-type">long</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> nextUniqueNumber.getAndIncrement();
        <span class="hljs-type">String</span> <span class="hljs-variable">proxyName</span> <span class="hljs-operator">=</span> proxyPkg + proxyClassNamePrefix + num;
        <span class="hljs-keyword">return</span> generateProxy(proxyName, interfaces, loader, methodsArray,
                exceptionsArray);
    }
}
</code></pre>
<p>生成代理主要经历了如下几个步骤：</p>
<ul>
<li>代理对象校验
<ul>
<li>当前的类加载器能够加载</li>
<li>代理对象必须是接口</li>
<li>同类型接口不能被多次代理</li>
</ul>
</li>
<li>代理对象路径校验，必须是相同的包名</li>
<li>生成代理对象
<ul>
<li>递归获取代理对象的所有方法，根据接口签名和子类型进行排序</li>
<li>获取代理方法的所有的异常</li>
<li>调用 Native 方法生成代理对象：包名 + $Proxy + number</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 国际化完整指南]]></title>    <link>https://juejin.cn/post/7571837786251493422</link>    <guid>https://juejin.cn/post/7571837786251493422</guid>    <pubDate>2025-11-13T07:44:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571837786251493422" data-draft-id="7571840220704178222" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Flutter 国际化完整指南"/> <meta itemprop="keywords" content="Flutter,Android"/> <meta itemprop="datePublished" content="2025-11-13T07:44:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="清凉夏日"/> <meta itemprop="url" content="https://juejin.cn/user/3378174574203678"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Flutter 国际化完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3378174574203678/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    清凉夏日
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T07:44:15.000Z" title="Thu Nov 13 2025 07:44:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Flutter 国际化完整指南：使用 VS Code Flutter Intl 插件快速实现多语言</h2>
<p>本文将手把手教你如何在 Flutter 项目中快速实现国际化，使用 VS Code 的 <strong>Flutter Intl</strong> 插件简化多语言配置流程。</p>
<h3 data-id="heading-1">🚀 快速开始</h3>
<h4 data-id="heading-2">步骤 1：创建 Flutter 项目</h4>
<pre><code class="hljs language-bash" lang="bash">flutter create intl_demo
<span class="hljs-built_in">cd</span> intl_demo
</code></pre>
<h4 data-id="heading-3">步骤 2：配置 pubspec.yaml</h4>
<p>在 <code>pubspec.yaml</code> 中添加必要的依赖：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">dependencies:</span>
  <span class="hljs-attr">flutter:</span>
    <span class="hljs-attr">sdk:</span> <span class="hljs-string">flutter</span>
  <span class="hljs-attr">flutter_localizations:</span>    <span class="hljs-comment"># 添加 Flutter 本地化支持</span>
    <span class="hljs-attr">sdk:</span> <span class="hljs-string">flutter</span>
  <span class="hljs-attr">intl:</span> <span class="hljs-string">^0.18.1</span>            <span class="hljs-comment"># 添加 intl 包</span>

<span class="hljs-attr">dev_dependencies:</span>
  <span class="hljs-attr">flutter_test:</span>
    <span class="hljs-attr">sdk:</span> <span class="hljs-string">flutter</span>
</code></pre>
<p>保存后运行：</p>
<pre><code class="hljs language-bash" lang="bash">flutter pub get
</code></pre>
<h4 data-id="heading-4">步骤 3：安装 VS Code 插件</h4>
<p>在 VS Code 扩展商店中搜索并安装 <strong>Flutter Intl</strong> 插件。</p>
<h4 data-id="heading-5">步骤 4：初始化国际化</h4>
<ol>
<li>按下 <code>Shift + Ctrl + P</code> (Windows) 或 <code>Shift + Cmd + P</code> (Mac)</li>
<li>输入 <code>Flutter Intl: Initialize</code> 并执行</li>
<li>添加更多语言
按下 <code>Shift + Ctrl + P</code>，输入 <code>Flutter Intl: Add locale</code>，然后输入语言代码（如 <code>zh</code> 添加中文）。
这会自动生成以下目录结构：</li>
</ol>

<pre><code class="hljs language-bash" lang="bash">lib/
├── l10n/
│   ├── intl_en.arb        <span class="hljs-comment"># 英文翻译文件</span>
│   ├── intl_zh.arb        <span class="hljs-comment"># 中文翻译文件</span>
│   ├── messages_all.dart
│   └── ...
└── generated/
    └── l10n.dart          <span class="hljs-comment"># 自动生成的本地化类</span>
</code></pre>
<h3 data-id="heading-6">⚙️ 配置 MaterialApp</h3>
<p>在 <code>main.dart</code> 中配置本地化支持：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter_localizations/flutter_localizations.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'generated/l10n.dart'</span>;  <span class="hljs-comment">// 引入生成的本地化类</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">const</span> MyApp({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> MaterialApp(
      title: <span class="hljs-string">'Flutter Demo'</span>,
      <span class="hljs-comment">// 配置本地化代理</span>
      localizationsDelegates: <span class="hljs-keyword">const</span> [
        S.delegate,  <span class="hljs-comment">// 生成的本地化代理</span>
        GlobalMaterialLocalizations.delegate,  <span class="hljs-comment">// Material 组件本地化</span>
        GlobalWidgetsLocalizations.delegate,   <span class="hljs-comment">// 基础 Widget 本地化</span>
        GlobalCupertinoLocalizations.delegate, <span class="hljs-comment">// Cupertino 组件本地化</span>
      ],
      <span class="hljs-comment">// 支持的语言列表</span>
      supportedLocales: S.delegate.supportedLocales,
      theme: ThemeData(
        primarySwatch: Colors.blue,
      ),
      home: <span class="hljs-keyword">const</span> MyHomePage(),
    );
  }
}
</code></pre>
<h3 data-id="heading-7">📝 管理翻译文件</h3>
<h4 data-id="heading-8">编辑 ARB 文件</h4>
<p>在 <code>lib/l10n/</code> 目录下编辑对应的语言文件：</p>
<p><strong>intl_en.arb (英文)</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"helloWorld"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Hello World!"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"welcome"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Welcome {name}!"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"settings"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Settings"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"language"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Language"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"@welcome"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Welcome message with name parameter"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"placeholders"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>intl_zh.arb (中文)</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"helloWorld"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"你好世界！"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"welcome"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"欢迎 {name}！"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"settings"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"设置"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"language"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"语言"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-9">💡 在代码中使用</h3>
<h4 data-id="heading-10">基础用法</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'generated/l10n.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyHomePage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">const</span> MyHomePage({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(
        title: Text(S.of(context).helloWorld),
      ),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Text(S.of(context).welcome(<span class="hljs-string">'Flutter'</span>)), <span class="hljs-comment">// 带参数的翻译</span>
            Text(S.of(context).settings),
          ],
        ),
      ),
    );
  }
}
</code></pre>
<h4 data-id="heading-11">动态语言切换</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LanguageSwitcher</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">const</span> LanguageSwitcher({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> DropdownButton&lt;Locale&gt;(
      value: Localizations.localeOf(context),
      items: [
        DropdownMenuItem(
          value: <span class="hljs-keyword">const</span> Locale(<span class="hljs-string">'en'</span>),
          child: Text(S.of(context).english),
        ),
        DropdownMenuItem(
          value: <span class="hljs-keyword">const</span> Locale(<span class="hljs-string">'zh'</span>),
          child: Text(S.of(context).chinese),
        ),
      ],
      onChanged: (Locale? newLocale) {
        <span class="hljs-keyword">if</span> (newLocale != <span class="hljs-keyword">null</span>) {
          <span class="hljs-comment">// 使用 GetX 或 Provider 等状态管理来切换语言</span>
          <span class="hljs-comment">// 或者重建 MaterialApp 时传入新的 locale</span>
        }
      },
    );
  }
}
</code></pre>
<h3 data-id="heading-12">🎯 高级功能</h3>
<h4 data-id="heading-13">复数处理</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"itemCount"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{count,plural, =0{No items}=1{One item}other{{count} items}}"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>使用：</p>
<pre><code class="hljs language-dart" lang="dart">Text(S.of(context).itemCount(<span class="hljs-number">5</span>)) <span class="hljs-comment">// 显示 "5 items"</span>
</code></pre>
<h3 data-id="heading-14">📱 在开发过程中快捷操作方法</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0206523e4e9545458ef44b061096b1a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5YeJ5aSP5pel:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763624797&amp;x-signature=eF7qkgesMh0z%2BC6xuRG4GEgR9D4%3D" alt="QQ20251113-15315.gif" loading="lazy"/></p>
<p>通过这个完整的指南，你可以快速在 Flutter 项目中实现国际化支持，为用户提供更好的多语言体验！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[华为小米都在布局的多屏协同，其实Android早就有了！只是你不知道...]]></title>    <link>https://juejin.cn/post/7571837786251509806</link>    <guid>https://juejin.cn/post/7571837786251509806</guid>    <pubDate>2025-11-13T07:47:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571837786251509806" data-draft-id="7572012699626848283" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="华为小米都在布局的多屏协同，其实Android早就有了！只是你不知道..."/> <meta itemprop="keywords" content="Flutter,Android"/> <meta itemprop="datePublished" content="2025-11-13T07:47:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员老刘"/> <meta itemprop="url" content="https://juejin.cn/user/662360127965769"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            华为小米都在布局的多屏协同，其实Android早就有了！只是你不知道...
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/662360127965769/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员老刘
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T07:47:03.000Z" title="Thu Nov 13 2025 07:47:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>哈喽，我是老刘</strong></p>
<p>双11可能不少朋友在置办手机、笔记本。</p>
<p>如果你是冲着多设备协同办公去的，先别急着下单，老刘给你推荐一款我们日常工作中常用的开源工具，看看能不能满足你多设备协同的需求。</p>
<p>看完这篇文章，你将学会如何用scrcpy解锁手机的隐藏技能，彻底改变你的工作和娱乐方式！</p>
<p>接下来我们先说有哪些使用场景，最后再介绍其背后的原理。</p>
<h2 data-id="heading-0">使用场景</h2>
<h3 data-id="heading-1">1. 准备工作</h3>
<ul>
<li>
<p>下载并安装scrcpy 3.0以上版本。</p>
<p>下载完成后，根据你的操作系统选择对应的安装方式：</p>
<ul>
<li>
<p><strong>Windows</strong>：直接解压即可使用。
你可以在GitHub上找到scrcpy的最新版本。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FGenymobile%2Fscrcpy%2Freleases%2Ftag%2Fv3.3.3" target="_blank" title="https://github.com/Genymobile/scrcpy/releases/tag/v3.3.3" ref="nofollow noopener noreferrer">github.com/Genymobile/…</a></p>
</li>
<li>
<p><strong>Mac</strong>：使用Homebrew安装，命令如下：</p>
<pre><code class="hljs language-bash" lang="bash">brew install scrcpy
</code></pre>
</li>
<li>
<p><strong>Linux</strong>：通过包管理器安装，例如Ubuntu用户可以运行：</p>
<pre><code class="hljs language-bash" lang="bash">sudo apt install scrcpy
</code></pre>
</li>
</ul>
</li>
<li>
<p>确保手机和电脑通过USB连接，并开启开发者模式。</p>
<p>开启开发者模式的方法如下：</p>
<ol>
<li>打开手机的"设置"。</li>
<li>找到"关于手机"或"关于设备"。</li>
<li>连续点击"版本号"7次，直到提示"您已进入开发者模式"。</li>
<li>返回设置，进入"开发者选项"。</li>
<li>启用"USB调试"。</li>
</ol>
<p>完成以上步骤后，用数据线将手机连接到电脑，确保连接稳定。</p>
</li>
</ul>
<h3 data-id="heading-2">2. 实现屏幕镜像</h3>
<p>完成准备工作后，我们可以先体验scrcpy的基础功能——屏幕镜像。</p>
<p>只需运行以下命令：</p>
<pre><code class="hljs language-bash" lang="bash">scrcpy
</code></pre>
<p>手机屏幕就会实时投射到电脑上。</p>
<p>你可以直接用鼠标和键盘操作手机，就像操作电脑上的应用一样。</p>
<p>比如：</p>
<ul>
<li>在电脑上回复手机消息，打字速度更快。</li>
<li>用大屏幕查看手机上的图片或文档，细节更清晰。</li>
</ul>
<p>更重要的事是，这一切都非常流畅，几乎没有延迟。</p>
<p>如果你是第一次使用scrcpy，可能会惊叹于它的流畅度和高效性。</p>
<p>如果在屏幕镜像的时候希望手机本身的屏幕是关闭的，也可以使用以下命令：</p>
<pre><code class="hljs language-bash" lang="bash">scrcpy --turn-screen-off
</code></pre>
<p>总结来说，屏幕镜像是scrcpy最基础但非常实用的功能，值得一试！</p>
<h3 data-id="heading-3">3. 多设备协同操作</h3>
<p>如果你觉得屏幕镜像已经够强大了，那接下来的功能会让你更加惊喜。</p>
<p>scrcpy支持通过<code>--new-display</code>参数，为手机创建多个虚拟显示窗口。</p>
<p>每个窗口都可以独立运行一个应用，真正实现多任务协同操作。</p>
<p>下面列举几种老刘自己常用的多窗口操作场景：</p>
<ul>
<li>
<p>在一个窗口中打开阅读应用，同时在另一个窗口中打开聊天应用。
这样你可以一边阅读，一边回复消息，效率直接拉满。</p>
<pre><code class="hljs language-bash" lang="bash">scrcpy --new-display --start-app=com.tencent.weread --window-title=<span class="hljs-string">"微信读书"</span> 

scrcpy --new-display --keyboard=uhid  --display-ime-policy=<span class="hljs-built_in">local</span> --start-app=com.tencent.mm --window-title=<span class="hljs-string">"微信"</span> 
</code></pre>
<p>参数说明：</p>
<ul>
<li><code>--new-display</code>：为手机创建一个新的虚拟显示窗口。</li>
<li><code>--start-app</code>：指定要在窗口中运行的应用包名。</li>
<li><code>--window-title</code>：为窗口指定一个标题，方便识别。</li>
<li><code>--keyboard=uhid</code>：启用物理键盘输入，避免在窗口中输入时被遮挡。</li>
<li><code>--display-ime-policy=local</code>：将输入法设置为本地输入法，避免在窗口中输入时被遮挡。</li>
</ul>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72544ae342864802811cec6b10b906ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6ICB5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763624823&amp;x-signature=Bpbr51Xx%2F7sKEWW1ZVGqBNi38qc%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<p>如果你是开发者，可以通过<code>--new-display</code>参数为应用指定不同的分辨率和刷新率，方便调试应用在不同屏幕上的适配情况。</p>
<pre><code class="hljs language-bash" lang="bash">scrcpy --new-display --start-app=com.example.flutter_test_1 --window-title=<span class="hljs-string">"原始分辨率"</span> 
</code></pre>
<p><code>--new-display</code>参数默认使用手机本身的分辨率创建虚拟显示窗口。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3145b6c42244773a90782d2f83d7cea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6ICB5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763624823&amp;x-signature=CPVonfBVxAbHWTqJnjn1RfFfc3E%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-arduino" lang="arduino">```bash
scrcpy --<span class="hljs-keyword">new</span>-display=<span class="hljs-number">1080</span>x1080 --start-app=com.example.flutter_test_1 --window-title=<span class="hljs-string">"特殊分辨率"</span> 
```

通过`--<span class="hljs-keyword">new</span>-display=<span class="hljs-number">1080</span>x1080`参数，我们可以为应用创建一个<span class="hljs-number">1080</span>x1080的虚拟显示窗口。

</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f98eae083844ff19ff4bb23e7bd8b40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6ICB5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763624823&amp;x-signature=R0Ic1dm2twVF9yffneq5rkSIod8%3D" alt="" loading="lazy"/></p>
<p>比如老刘这边也经常会用这种方式给运营展示产品海报在不同手机上的显示效果。</p>
<ul>
<li>
<p>看短剧时，将窗口调整为适合视频比例的宽高比，避免画面被裁剪。
不知道大家发现没有，最近很火的短剧，在手机端和ipad上都会被裁剪，手机端一般是裁剪两边，而ipad端是裁剪上下部分。</p>
<p>这两种方式裁剪都有可能导致画面内容被裁掉一部分。</p>
<p>原因是短剧的视频比例一般是9:16，而手机端常见的分辨率是1080x2400左右，ipad常见的分辨率是3:4左右。</p>
<p>这种情况下，我们可以通过<code>--new-display=1080x1920</code>参数，为应用创建一个1080x1920的虚拟显示窗口，保证视频的画面完整显示。</p>
<p>这里用番茄读书中的短剧作为展示:</p>
<pre><code class="hljs language-bash" lang="bash">scrcpy --new-display=1080x2000 --start-app=com.dragon.read --window-title=<span class="hljs-string">"短剧"</span> 
</code></pre>
<p>这里1080x2000分辨率多出来的部分是底部选集的区域，不会影响视频的显示。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9222c372aa74481b402cb44a77c2d6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6ICB5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763624823&amp;x-signature=t9yFDvfvwZayByRlGfkqDq17SWc%3D" alt="" loading="lazy"/></p>
<p>怎么样，无论是工作还是娱乐，多设备协同操作都能让你的体验更上一层楼！</p>
<p>想象一下你可以打开多个不同分辨率的应用同时操作，是不是和直接操作电脑一样方便？</p>
<p>是不是比不少厂商的多设备协同操作功能更加强大？</p>
<p>其实不少厂商的多设备协同功能和scrcpy使用的是相同的技术。</p>
<p>有些是把底层代码拿来改了改，有些甚至直接是scrcpy外面套了个壳。</p>
<p>下面我们就来看看scrcpy为啥这么强大，它的运行原理是什么？</p>
<hr/>
<h2 data-id="heading-4">原理</h2>
<p>scrcpy 的强大之处在于它充分利用了 Android 系统的虚拟显示功能。</p>
<p>当你使用 <code>--new-display</code> 参数时，scrcpy 会通过 Android 的 DisplayManager API 创建一个新的虚拟显示器。</p>
<p>每个虚拟显示器都相当于一个独立的屏幕，系统会为其分配一个独立的显示端口。</p>
<p>你的手机可以同时运行多个应用，并将它们的画面分别投射到不同的虚拟显示器上。</p>
<p>而且 scrcpy 允许你为每个虚拟显示器设置不同的分辨率和刷新率。</p>
<p>这背后的原理是，Android 系统本身支持多显示器模式，厂商的多设备协同功能也是基于这一特性开发的。</p>
<p>scrcpy 则是将这一功能开放给了普通用户，并通过简单的命令行参数，让你可以轻松实现这些功能。</p>
<p>此外，scrcpy 的高效性得益于它的使用了串流方式，将手机屏幕内容实时编码后，通过 USB 或 Wi-Fi 传输到电脑。</p>
<p>这种方式不仅保证了画面的高质量，还能最大程度地降低延迟。现在在pc端比较流行的远程游戏方案也都基于这种串流的方式。</p>
<p>所以，无论是屏幕镜像还是多设备协同操作，scrcpy 都能提供流畅的体验。</p>
<hr/>
<h2 data-id="heading-5">总结</h2>
<p>从基础的屏幕投射到高级的多窗口操作，scrcpy 用开源的方式打破了厂商壁垒，让每个人都能拥有比官方解决方案更强大的多设备协同能力。</p>
<p>而且这一切都是免费的。</p>
<p>不需要购买昂贵的硬件设备，不需要订阅付费服务，只需要一条 USB 数据线和几个简单的命令，就能让你的手机和电脑完美融合。</p>
<p>下次再看到各种花里胡哨的多设备协同功能时，不妨想想：其实你可能早就拥有了更强大的工具，只是还不知道怎么用而已。</p>
<p>好了，如果看到这里的同学对客户端或者Flutter开发感兴趣，欢迎联系老刘，我们互相学习。
私信免费领老刘整理的《Flutter开发手册》，覆盖90%应用开发场景。
可以作为Flutter学习的知识地图。</p>
<p>—— laoliu_dev</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[git "base点"详解,顺便解释merge和rebase区别]]></title>    <link>https://juejin.cn/post/7571840220704342062</link>    <guid>https://juejin.cn/post/7571840220704342062</guid>    <pubDate>2025-11-13T07:54:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571840220704342062" data-draft-id="7571829822340988979" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="git &quot;base点&quot;详解,顺便解释merge和rebase区别"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-13T07:54:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="倚栏听风雨"/> <meta itemprop="url" content="https://juejin.cn/user/2682464103830750"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            git "base点"详解,顺便解释merge和rebase区别
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2682464103830750/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    倚栏听风雨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T07:54:49.000Z" title="Thu Nov 13 2025 07:54:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是一个非常核心的 Git 概念。我们来用一个通俗易懂的方式彻底理解它。</p>
<h3 data-id="heading-0">核心比喻：盖楼</h3>
<p>你可以把 Git 的提交历史想象成<strong>盖一栋大楼</strong>。</p>
<ul>
<li><strong>每一次 <code>git commit</code></strong> 就像是在这栋楼上<strong>新盖一层</strong>。</li>
<li><strong><code>git commit</code> 的 base 点（基点）</strong> ，就是你<strong>要往上盖新楼层的那个“当前最高层”</strong> 。</li>
</ul>
<p>没有这个基点，你就不知道新的一层该从哪里开始盖。在 Git 中，没有基点，你就不知道新的代码变更应该基于哪个历史版本来创建。</p>
<hr/>
<h3 data-id="heading-1">详细解释</h3>
<p><strong>核心理解</strong>：一个 Commit 的“父提交” 在Git中，一个 Commit 的 Base点，最直接的理解就是它的【父提交】。</p>
<h3 data-id="heading-2">1. 最简单的线性情况</h3>
<p>想象一下你的提交历史是一条直线：</p>
<pre><code class="hljs language-text" lang="text">A &lt;- B &lt;- C &lt;- D
</code></pre>
<p>在这里：</p>
<ul>
<li>提交 <code>D</code> 的 Base点 是 <code>C</code>。</li>
<li>提交 <code>C</code> 的 Base点 是 <code>B</code>。</li>
<li>提交 <code>B</code> 的 Base点 是 <code>A</code>。</li>
<li>提交 <code>A</code> 是初始提交，没有 Base点（父提交）。</li>
</ul>
<p>当你执行 <code>git commit</code> 时，Git 会：</p>
<ol>
<li>将当前<strong>暂存区</strong> 的内容与 <strong>HEAD 所指向的提交</strong>（也就是你当前所在的提交，比如 <code>C</code>）进行比较。</li>
<li>创建一个新的提交对象 <code>D</code>。</li>
<li>将 <code>D</code> 的父提交设置为 <code>C</code>。</li>
<li>将 <code>HEAD</code> 指针移动到新的提交 <code>D</code>。</li>
</ol>
<p><strong>所以，在这种情况下，你的 Base点 就是你执行 <code>git commit</code> 命令时，HEAD 指向的那个提交。</strong></p>
<h4 data-id="heading-3">2. 它是如何工作的？</h4>
<p>Git 在创建一个新的提交时，会做以下几件事：</p>
<ol>
<li>将暂存区（Staging Area）里的文件快照保存下来。</li>
<li>生成一个新的提交对象（Commit Object）。</li>
<li><strong>将这个新提交的父提交（Parent）设置为当前的 <code>HEAD</code>（也就是 base 点）。</strong></li>
<li>将 <code>HEAD</code>（以及当前分支指针）移动到這個新的提交上。</li>
</ol>
<p>这个过程形成了一个链条，每个新提交都指向上一个提交（它的 base 点）。</p>
<h3 data-id="heading-4">2. 更复杂的场景：分支与合并</h3>
<p>当存在分支和合并时，“Base点”的概念会变得更加重要和具体。</p>
<h4 data-id="heading-5">a) 创建新分支时</h4>
<p>当你基于 <code>main</code> 分支创建一个新分支 <code>feature</code> 时：</p>
<p>text</p>
<pre><code class="hljs language-css" lang="css">          E - F (feature)
         /
<span class="hljs-selector-tag">A</span> - <span class="hljs-selector-tag">B</span> - C - D (<span class="hljs-selector-tag">main</span>)
</code></pre>
<ul>
<li>分支 <code>feature</code> 是从提交 <code>C</code> 创建的。</li>
<li>因此，提交 <code>E</code> 的 Base点 是 <code>C</code>。</li>
<li>对于 <code>feature</code> 分支上的任何新提交，它们的 Base点 都是其直接的前一个提交。</li>
</ul>
<h4 data-id="heading-6">b) 合并时 - “Merge Base”</h4>
<p>这是“Base点”概念最关键的运用场景之一。当你尝试将 <code>feature</code> 分支合并回 <code>main</code> 分支时：</p>
<pre><code class="hljs language-text" lang="text">          E - F (feature)
         /
A - B - C - D (main)
</code></pre>
<p>Git 会执行一个非常聪明的操作：<strong>寻找合并基准点</strong>。</p>
<ol>
<li>
<p><strong>寻找 Merge Base</strong>：Git 会找到两个分支（<code>main</code> 和 <code>feature</code>）的“最近共同祖先”。在这个例子中，就是提交 <code>C</code>。</p>
</li>
<li>
<p><strong><code>C</code> 就是这次合并的 Base点</strong>。</p>
</li>
<li>
<p><strong>执行三方合并</strong>：Git 会进行以下比较：</p>
<ul>
<li>Base点 (<code>C</code>) 与 <code>main</code> 的当前状态 (<code>D</code>) 的差异。</li>
<li>Base点 (<code>C</code>) 与 <code>feature</code> 的当前状态 (<code>F</code>) 的差异。</li>
</ul>
</li>
<li>
<p>Git 会尝试将这两组差异合并起来，应用到一个新的提交上。如果成功，就会创建一个<strong>合并提交</strong> <code>G</code>：</p>
</li>
</ol>
<pre><code class="hljs language-text" lang="text">          E - F (feature)
         /         \
A - B - C - D ----- G (main)
</code></pre>
<ul>
<li>这个合并提交 <code>G</code> 比较特殊，它有两个父提交：<code>D</code> 和 <code>F</code>。</li>
</ul>
<h3 data-id="heading-7">3. 变基时 - “Rebase Base”</h3>
<p>变基是另一种改变 Base点 的强大操作。</p>
<p>在合并的例子中，<code>feature</code> 分支的历史是基于 <code>C</code> 的。但如果你想让历史看起来像是一条直线，你可以使用 <code>git rebase</code>。</p>
<p><strong>变基的本质就是改变一个分支的 Base点。</strong></p>
<p><strong>变基前：</strong></p>
<pre><code class="hljs language-text" lang="text">          E - F (feature)
         /
A - B - C - D (main)
</code></pre>
<p>你执行 <code>git checkout feature</code> 然后 <code>git rebase main</code>。这个过程是：</p>
<ol>
<li>Git 找到 <code>feature</code> 分支上独有的提交（<code>E</code> 和 <code>F</code>）。</li>
<li>Git 临时保存这些提交的更改（差异）。</li>
<li>Git 将 <code>feature</code> 分支的 <strong>Base点</strong> 从 <code>C</code> <strong>重置</strong> 到 <code>main</code> 分支的顶端，也就是 <code>D</code>。</li>
<li>然后，Git 在<strong>新的 Base点 (<code>D</code>)</strong>  上，依次重新应用之前保存的 <code>E</code> 和 <code>F</code> 的更改，生成两个<strong>全新的提交</strong> <code>E'</code> 和 <code>F‘</code>。</li>
</ol>
<p><strong>变基后：</strong></p>
<p>text</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">A</span> - <span class="hljs-selector-tag">B</span> - C - D - E' - F' (feature, <span class="hljs-selector-tag">main</span>)
                (新的Base点)
</code></pre>
<p>现在，<code>feature</code> 分支的 Base点 变成了 <code>D</code>，历史变成了一条整洁的直线。</p>
<h3 data-id="heading-8">Base 点的重要性体现在哪些方面？</h3>
<h4 data-id="heading-9">1. 构建提交历史</h4>
<p>Base 点是 Git 版本历史能够串联起来的根本。它确保了提交历史是一条（或多条）有向无环图（DAG）的链，你可以回溯到任何一个历史版本。</p>
<h4 data-id="heading-10">2. 分支（Branching）的核心</h4>
<p><strong>创建分支的本质，就是创建一个新的、可移动的指针，并让它指向当前的 base 点。</strong></p>
<pre><code class="hljs language-text" lang="text">          (HEAD -&gt; main)
                |
A &lt;- B &lt;- C &lt;- D
          |
        (feature)
</code></pre>
<ul>
<li>当你在提交 <code>C</code> 时执行 <code>git branch feature</code>，你就创建了一个名为 <code>feature</code> 的分支，它指向 <code>C</code>。</li>
<li>此时，<code>C</code> 是 <code>feature</code> 分支的起点（base 点）。</li>
<li>当你切换到 <code>feature</code> 分支（<code>git checkout feature</code>）后，<code>HEAD</code> 就指向了 <code>feature</code>。那么 <code>C</code> 就成了你在 <code>feature</code> 分支上第一次提交的 base 点。</li>
</ul>
<h3 data-id="heading-11">总结</h3>
<p>你可以把 <code>git commit</code> 的 <strong>base 点</strong> 理解为：</p>
<blockquote>
<p><strong>当前工作目录所基于的那个历史版本，也是新提交的“父提交”。它决定了你的新代码变更将从代码库的哪个状态开始记录，是整个版本历史形成链条的基石。</strong></p>
</blockquote>
<p>理解了这个概念，你就能更好地理解分支、合并、变基等几乎所有 Git 高级操作。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>