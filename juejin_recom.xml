<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[万字记录：信创上云，国产系统Kylin 压测容器重启，接口响应耗时过长问题排查（openjdk17）]]></title>    <link>https://juejin.cn/post/7574276404596555828</link>    <guid>https://juejin.cn/post/7574276404596555828</guid>    <pubDate>2025-11-19T15:32:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574276404596555828" data-draft-id="7574308545525530639" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="万字记录：信创上云，国产系统Kylin 压测容器重启，接口响应耗时过长问题排查（openjdk17）"/> <meta itemprop="keywords" content="JVM"/> <meta itemprop="datePublished" content="2025-11-19T15:32:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="54ping"/> <meta itemprop="url" content="https://juejin.cn/user/2084329779111320"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            万字记录：信创上云，国产系统Kylin 压测容器重启，接口响应耗时过长问题排查（openjdk17）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2084329779111320/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    54ping
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T15:32:51.000Z" title="Wed Nov 19 2025 15:32:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">信创上云，国产系统Kylin 压测容器重启，接口响应耗时过长问题排查（openjdk17）</h2>
<p>（内含 60 个 jvm 参数详解、调优思路说明）</p>
<blockquote>
<p>最近扎进信创上云的落地实战，碰到了一个棘手的问题 —— 国产操作系统搭配容器化部署后，核心接口出现了RT拉长、偶发OOM的情况。</p>
<p>搁以前，遇到这类问题常能靠扩容硬件快速化解，内存不够加内存、CPU过载扩节点，JVM调优没什么用武之地。</p>
<p>现在不一样了，都在搞节能减排...呸！降本增效那一套，裁员降薪后服务器资源也一砍再砍，“堆硬件”的简单解法行不通了。</p>
<p>反而倒逼我们沉下心，在信创上云+国产OS容器重启的特定场景里，主动排查根因、攻坚优化，这次就把整个排查过程整理出来和大家分享。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38ebef262a5c4b0bac34dbf70d12daa3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTRwaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764171171&amp;x-signature=6Qy%2BUe3j9%2BmXVIhxG4bF%2B%2FAH7Yw%3D" alt="MindMap - 信创容器重启及接口响应时间（RT）过长排查.png" loading="lazy"/></p>
<p>▶️▶️▶️ 正文开始 ▶️▶️▶️</p>
<h3 data-id="heading-1">问题一：测试环境发生重启</h3>
<h4 data-id="heading-2">一、现象描述</h4>
<p>Java 服务一开始压测，1小时内必重启。通过 "容器云平台监控" 发现：</p>
<ul>
<li>进程消失了，健康检查失败，故服务重启。</li>
<li>重启前系统资源监控显示 <code>cpu 使用率 100%</code>, <code>内存使用率 98+%</code></li>
</ul>
<h4 data-id="heading-3">二、检查日志和配置</h4>
<h5 data-id="heading-4">1. 主要检查点</h5>
<ol start="0">
<li>检查 是否生成 <code>heapdump（堆转储）</code>文件</li>
<li>检查 <code>GC 日志</code></li>
<li>检查 <code>容器编排配置</code> 文件</li>
<li>检查 <code>容器启动脚本</code></li>
</ol>
<h5 data-id="heading-5">2. 检查结果</h5>
<p>未发现堆转储（heapdump）文件，无 GC 日志；</p>
<p>——&gt; 检查容器 <code>编排配置</code> 和 <code>启动脚本</code>，</p>
<p>——&gt; 均未开启 gc 日志，启动脚本 heapdump 路径非容器挂载路径。</p>
<h5 data-id="heading-6">3. 调整 JVM 参数</h5>
<p>调整 <code>run.sh</code>, 必须包含如下 jvm 参数，</p>
<p>涉及目录路径都要用容器挂载路 <code>spec.containers.args.volumeMounts.mountPath</code></p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 发生 OOM 时，JVM 终止退出</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+ExitOnOutOfMemoryError</span> 
<span class="hljs-comment"># 发生 OOM 时生成 Java 堆转储</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+HeapDumpOnOutOfMemoryError</span> 
​
<span class="hljs-comment"># 堆转储文件保存位置</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:HeapDumpPath=/logs/</span><span class="hljs-variable">${</span><span class="hljs-variable constant_">POD_NAMESPACE</span>}/<span class="hljs-variable">${</span><span class="hljs-variable constant_">APP_NAME</span>}/heapdump_start_<span class="hljs-variable">$(</span>date +<span class="hljs-string">"%Y-%m-%d_%H%M%S"</span>).hprof 
​
<span class="hljs-comment"># JVM 发生致命错误时，日志文件保存位置</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:ErrorFile=/logs/</span><span class="hljs-variable">${</span><span class="hljs-variable constant_">POD_NAMESPACE</span>}/<span class="hljs-variable">${</span><span class="hljs-variable constant_">APP_NAME</span>}/<span class="hljs-variable">${</span><span class="hljs-variable constant_">HOSTNAME</span>}-hs_err_pid.<span class="hljs-variable">$$</span>.log 
​
<span class="hljs-comment"># 开启 gc 日志</span>
-<span class="hljs-title class_">Xlog</span><span class="hljs-symbol">:gc*</span><span class="hljs-symbol">:file=/logs/</span><span class="hljs-variable">${</span><span class="hljs-variable constant_">POD_NAMESPACE</span>}/<span class="hljs-variable">${</span><span class="hljs-variable constant_">APP_NAME</span>}/gc-%t.<span class="hljs-symbol">log:</span>hostname,time,uptime,<span class="hljs-symbol">pid:</span>filecount=<span class="hljs-number">5</span>,filesize=10M 
</code></pre>
<p>还需要在 <code>start_java_server</code> 函数中添加 <strong>日志清理</strong> 的代码：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-function"><span class="hljs-title">start_java_server</span></span>(){
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"----start java process----"</span>
  
  <span class="hljs-built_in">touch</span> /app/bin/test.log
  
  <span class="hljs-built_in">eval</span> java <span class="hljs-variable">$JAVA_OPTS</span> -jar <span class="hljs-variable">$appname</span>
  
<span class="hljs-comment">#  tail -f /app/bin/test.log # 这行代码不要了，可以直接删除</span>
  
  <span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">do</span>
    <span class="hljs-comment"># 清理两天前的 gc 日志</span>
    find <span class="hljs-string">"<span class="hljs-variable">${LOG_PATH}</span>"</span> -mtime +2 -<span class="hljs-built_in">type</span> f -name <span class="hljs-string">"*.log*"</span> -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">rm</span> {} ;
    <span class="hljs-comment"># 清理 7 天前的 kafka 故障转移日志</span>
    find <span class="hljs-string">"<span class="hljs-variable">${LOG_PATH}</span>"</span> -mtime +7 -maxdepth 1 -<span class="hljs-built_in">type</span> d -not -name <span class="hljs-string">"*<span class="hljs-variable">${HOSTNAME}</span>*"</span> -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">rm</span> -rf {} ;
    <span class="hljs-comment"># 24 小时执行一次</span>
    <span class="hljs-built_in">sleep</span> 86400
  <span class="hljs-keyword">done</span>
}
</code></pre>
<h5 data-id="heading-7">4. 部署验证</h5>
<p>重启后仍然没有 <code>heapdump</code> 文件，观察 <code>GC 日志</code>，垃圾回收正常。</p>
<h4 data-id="heading-8">三、检查 Linux 内核日志</h4>
<p>执行命令：</p>
<pre><code class="hljs language-perl" lang="perl">dmesg | <span class="hljs-keyword">grep</span> -iE <span class="hljs-string">"killed.*java"</span>
</code></pre>
<p>发现如下日志：</p>
<pre><code class="hljs language-arduino" lang="arduino">Killed process <span class="hljs-number">1939065</span> (java) total-vm:<span class="hljs-number">131428792</span>kB, anon-rss:<span class="hljs-number">869604</span>kB, file-rss:<span class="hljs-number">0</span>kB, shmem-rss:<span class="hljs-number">6678808</span>kB
</code></pre>
<h5 data-id="heading-9">1. 定位原因</h5>
<p>通过 dmesg 日志发现 java 进程被 kill，其中异常指标为：</p>
<ul>
<li><code>shmem-rss</code>: 共享内存（Shared Memory）驻留大小（Resident Set Size）约 6.37G</li>
</ul>
<h5 data-id="heading-10">2. 为什么共享内存这么高？</h5>
<p>通过查阅资料了解到 ZGC 为了实现<strong>亚毫秒级停顿</strong>，使用了<strong>多视图映射技术</strong>，这项技术<strong>重度依赖共享内存</strong>的使用。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span>
​
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-comment">// 创建一个共享内存的文件描述符</span>
    <span class="hljs-type">int</span> fd = <span class="hljs-built_in">shm_open</span>(<span class="hljs-string">"/example"</span>, O_RDWR | O_CREAT | O_EXCL, <span class="hljs-number">0600</span>);
    <span class="hljs-keyword">if</span> (fd == <span class="hljs-number">-1</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-comment">// 防止资源泄露，需要删除。执行之后共享对象仍然存活，但是不能通过名字访问</span>
    <span class="hljs-built_in">shm_unlink</span>(<span class="hljs-string">"/example"</span>); 
    
    <span class="hljs-comment">// 将共享内存对象的大小设置为4字节</span>
    <span class="hljs-type">size_t</span> size = <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint32_t</span>);
    <span class="hljs-built_in">ftruncate</span>(fd, size); 
    
    <span class="hljs-comment">// 两次调用mmap，把一个共享内存对象映射到两个虚拟地址上。</span>
    <span class="hljs-type">int</span> prot = PROT_READ | PROT_WRITE;    
    <span class="hljs-type">uint32_t</span> *add1 = <span class="hljs-built_in">mmap</span>(<span class="hljs-literal">NULL</span>, size, prot, MAP_SHARED, fd, <span class="hljs-number">0</span>);
    <span class="hljs-type">uint32_t</span> *add2 = <span class="hljs-built_in">mmap</span>(<span class="hljs-literal">NULL</span>, size, prot, MAP_SHARED, fd, <span class="hljs-number">0</span>);
    
    <span class="hljs-comment">// 关闭文件描述符</span>
    <span class="hljs-built_in">close</span>(fd);
    
    <span class="hljs-comment">// 测试，通过一个虚拟地址设置数据，两个虚拟地址得到相同的数据</span>
    *add1 = <span class="hljs-number">0xdeafbeef</span>;
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Address of add1 is: %p, value of add1 is: 0x%x\n"</span>, add1, *add1);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Address of add2 is: %p, value of add2 is: 0x%x\n"</span>, add2, *add2);
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h5 data-id="heading-11">3. 多视图映射技术</h5>
<blockquote>
<p>有兴趣的可以看看（可以跳过）</p>
</blockquote>

























<table><thead><tr><th>视图</th><th>作用</th><th>对象状态</th></tr></thead><tbody><tr><td>Marked0</td><td>标记周期0的存活对象</td><td>第一次标记后存活</td></tr><tr><td>Marked1</td><td>标记周期1的存活对象</td><td>第二次标记后存活</td></tr><tr><td>Remapped</td><td>已重定位的对象</td><td>转移完成后</td></tr></tbody></table>
<ul>
<li>并发标记（mark）</li>
</ul>

<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 传统GC：需要暂停应用来标记对象</span>
<span class="hljs-comment">// ZGC：完全并发标记，无暂停</span>
​
<span class="hljs-comment">// 标记过程：</span>
<span class="hljs-comment">// 1. 应用线程正常访问对象（通过Remapped视图）</span>
<span class="hljs-comment">// 2. GC线程并发标记，将对象指针切换到Marked0/Marked1视图</span>
<span class="hljs-comment">// 3. 应用线程无感知，继续执行</span>
</code></pre>
<ul>
<li>并发转移（relocate）</li>
</ul>

<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 传统GC：转移对象需要暂停应用</span>
<span class="hljs-comment">// ZGC：并发转移 + 指针自愈</span>
​
<span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> heap.getObject(pointer);  <span class="hljs-comment">// 正常访问</span>
<span class="hljs-comment">// 如果对象正在被转移：</span>
<span class="hljs-comment">// 1. 触发页面异常（page fault）</span>
<span class="hljs-comment">// 2. ZGC处理器将对象转移到新位置</span>
<span class="hljs-comment">// 3. 更新指针到新地址（指针自愈）</span>
<span class="hljs-comment">// 4. 应用线程继续执行，无感知</span>
</code></pre>
<ul>
<li>指针自愈（remap）</li>
</ul>

<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 指针结构（64位）</span>
<span class="hljs-selector-attr">[ 62位地址 | 2位元数据 ]</span>
​
<span class="hljs-comment">// 元数据位含义：</span>
<span class="hljs-number">00</span> → Remapped 视图
<span class="hljs-number">01</span> → Marked0   视图
<span class="hljs-number">10</span> → Marked1   视图
<span class="hljs-number">11</span> → 保留
​
<span class="hljs-comment">// 当应用访问"旧"指针时：</span>
if (指针视图 != 当前活动视图) {
    <span class="hljs-comment">// 触发指针自愈逻辑</span>
    新指针 = 查找转发表(旧指针);
    <span class="hljs-comment">// 原子性地替换指针</span>
    <span class="hljs-built_in">CAS</span>(对象指针, 旧指针, 新指针);
}
</code></pre>
<h5 data-id="heading-12">4. 调整配置</h5>
<p>这里尝试调整了各种容器编排配置、JVM 参数、Linux 系统参数，都没有效果，最后决定 <strong>放弃 ZGC</strong>，改用 <strong>G1 垃圾回收器</strong>，并补充了一些内存限制参数。</p>
<p>调整 <code>run.sh</code> 添加如下 JVM 参数：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 1C3G 容器配置参考</span>
​
<span class="hljs-comment"># 让 JVM 知道当前运行环境是容器，防止 JVM 读取宿主机的配置</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+UseContainerSupport</span> 
<span class="hljs-comment"># 这里配置容器限制内存，避免 JVM 读取宿主机配置</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:MaxRAM=</span><span class="hljs-number">3072</span> 
<span class="hljs-comment"># JVM 可以使用的最大内存 75% * MaxRAM</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:MaxRAMPercentage=</span><span class="hljs-number">75.0</span> 
​
<span class="hljs-comment"># 删除 ZGC 相关的 JVM 参数，使用 G1 垃圾回收器</span>
<span class="hljs-comment"># 使用 G1 必须删除 -Xmn 配置</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+UseG1GC</span> 
</code></pre>
<h5 data-id="heading-13">5. 部署验证</h5>
<p>不再出现重启。</p>
<h3 data-id="heading-14">问题二：生产环境发生重启</h3>
<h4 data-id="heading-15">一、现象描述</h4>
<p>Java 服务压测发生重启，通过 <code>dmesg</code> 命令查看 Linux 内核日志：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5abd95ca3aa04f8d83110cc1aab16230~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTRwaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764171171&amp;x-signature=A%2B1h8ua%2BFXhXTEGW9mXgvDTBdM8%3D" alt="cgroupOOM.jpg" loading="lazy"/></p>
<p>如图所示（<code>最底下3行</code>），<strong>发生了 OOM, java 进程被系统 kill 了</strong>，anon-rss 显示约 <code>2.97G</code>, 其中 java 进程 rss（驻留内存）785586 数据页，<code>785586 * 4kB ≈ 3G</code>.</p>
<blockquote>
<p>与先前测试环境重启现象不同，生产压测的接口也与测试环境不一样。</p>
</blockquote>
<h4 data-id="heading-16">二、测试环境复现</h4>
<p>通过相同的接口压测，立马在测试环境复现了生产环境的问题。</p>
<h5 data-id="heading-17">1. 初步分析</h5>
<p>同样是没有 heapdump 文件生成、GC 正常，但 Linux 内核日志显示 <code>Memory cgroup out of memory</code>.执行 <code>cat /proc/${PID}/cmdline | tr '\0' '\n'</code> 检查 jvm 参数，如下参数存在：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 发生 OOM 时，JVM 终止退出</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+ExitOnOutOfMemoryError</span> 
<span class="hljs-comment"># 发生 OOM 时生成 Java 堆转储</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+HeapDumpOnOutOfMemoryError</span> 
<span class="hljs-comment"># 堆转储文件保存位置</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:HeapDumpPath=/logs/</span>...
</code></pre>
<p>那么，没有发现 heapdump 文件就意味着 JVM 内存没有溢出。</p>
<h5 data-id="heading-18">2. 工具分析</h5>
<p>使用 jmc, jvisualvm, arthas 监控 JVM 内存变化，所有区域（堆、元空间、线程数、直接内存）内存一直很平稳，一直到 java 进程被杀，JVM 内存使用情况都一直在安全区域，甚至离我设置的最大值还差很多。</p>
<p>再次确认 ———— <strong>JVM 内存不存在 OOM 问题</strong>。</p>
<h5 data-id="heading-19">3. 参数调优</h5>
<p>确定了 JVM 内存不存在溢出，那就是 JVM 之外的内存发生了溢出，常见的有：</p>
<ul>
<li><code>java.nio.*</code> 库的方法调用，比如 <code>ByteBuffer.allocateDirect</code></li>
<li><code>sun.misc.Unsafe</code> 类的方法调用</li>
</ul>
<p>这些方法底层都是 使用 <code>JNI（Java Native Interface）的方式</code> 调用 C/C++ 库的函数，这部分函数的执行、内存分配、内存管理 <strong>由操作系统控制，JVM 管不到</strong>。</p>
<blockquote>
<p>调优策略 - 因为 JVM 无法管理 native 区域的内存，也监控不到，那就先把容器内存限制调大，看看到底内存能涨到多少，再调整参数。</p>
</blockquote>
<p>具体如下：</p>
<ul>
<li>
<p>内存调整到 <code>4G</code> ——&gt; 压测</p>
<ul>
<li><strong>溢出</strong></li>
</ul>
</li>
<li>
<p>缩小 heap、metaspace、thread-stack、direct 区域的内存，尽可能把空间都留给 native 区</p>
<ul>
<li><strong>还是溢出</strong></li>
</ul>
</li>
<li>
<p>优化 <code>高CPU占用</code> 的线程调用链上的方法（日志相关）：减少日志输出，调整日志相关的缓存、队列、IO 等参数</p>
<ul>
<li><strong>还是溢出</strong></li>
</ul>
</li>
<li>
<p>调整 log4j2.xml 中 kafka 相关参数，降低 cpu &amp; memory 消耗</p>
<ul>
<li><strong>还是溢出</strong></li>
</ul>
</li>
<li>
<p>调整 nio 相关参数，降低 cpu &amp; memory 消耗</p>
<ul>
<li><strong>还是溢出</strong></li>
</ul>
</li>
<li>
<p>内存调整到 <code>6G</code> 并调整日志输出级别为 ERROR ——&gt; <strong>压测 48 小时</strong></p>
<ul>
<li><strong>没有溢出，内存占用飙升到 5G 多</strong></li>
</ul>
</li>
</ul>
<h5 data-id="heading-20">4. 定位原因</h5>
<p>无论怎么调整，JVM 内存始终稳定在 2G 以内，那多出来的 3G+ 就是 JNI 产生的内存（native memory）。</p>
<p><strong>以上是重点，以下是弯路（方向不对，白费功夫，引以为戒）：</strong></p>
<ul>
<li>
<p>尝试各种命令，写了近 10 个监控脚本，试图追踪 “造成 3G+ native 内存” 的元凶</p>
<ul>
<li>失败</li>
</ul>
</li>
<li>
<p>尝试各种工具，生成堆栈、线程栈，结合监控脚本和代码分析，试图定位 “真凶”</p>
<ul>
<li>失败</li>
</ul>
</li>
</ul>
<p><strong>回到重点：</strong></p>
<ul>
<li>
<p><code>JVM memory</code> vs <code>native memory</code> = <code>1.x : 3.x</code></p>
<ul>
<li>
<p>什么样的代码能导致怎样的比例？</p>
<ul>
<li>“内存泄漏” 的代码</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>native memory</code> <strong>100% 内存泄漏了!!!</strong></p>
<ul>
<li>
<p>通过监控、线程堆栈分析：</p>
<ul>
<li>不存在会产生大量 JNI 调用的 Java API</li>
</ul>
</li>
<li>
<p>通过监控、内存堆栈分析：</p>
<ul>
<li>不存在大量跟 JNI 有关的对象或类</li>
</ul>
</li>
</ul>
</li>
<li>
<p>结合其他情况判断，<strong>可能与业务代码无关</strong>：</p>
<ul>
<li>
<p>常规生产环境、常规测试环境都没有问题</p>
</li>
<li>
<p>其他服务也有重启的现象，gateway 服务也有重启的现象，它甚至都没有业务代码</p>
<ul>
<li>如果不是业务代码的问题，那是某个<strong>第三方依赖包有问题？</strong></li>
</ul>
</li>
<li>
<p>即使停止压测，内存也不会降下来</p>
<ul>
<li><strong>native memory 区域为什么不会回收？</strong></li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>第三方依赖包有问题的概率比较小</strong>，毕竟这么夸张的内存泄漏，有问题也轮不到我发现</p>
</li>
</ul>
<h5 data-id="heading-21">5. 确定排查方向</h5>
<blockquote>
<p>既然 JVM 范围内找不出答案，索性从 JVM 之外找找看（<strong>知识盲区，整理上述分析结果，让 AI 给我提供思路</strong>）。</p>
</blockquote>
<ul>
<li>
<p>如图所示，我把 JVM 内存使用情况（需要开启参数<code>-XX:NativeMemoryTracking=summary</code>）喂给 AI 并简单描述了一下。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77dc877ff13844d89c0977d91dc65b74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTRwaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764171171&amp;x-signature=HgNNgBLhrNtuF5p0uzIMTgYmuu8%3D" alt="AI问答01-Java内存溢出.png" loading="lazy"/></p>
</li>
<li>
<p>AI 的回答，总结来说就是 <code>Metaspace</code> 的类数量很多，最可能发生溢出，还有就是监控相关的（这个忽略）
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2000d04a7b5b48e2bb50024ae41a7939~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTRwaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764171171&amp;x-signature=krPx8GIaMyqlmRuNeccgaqEbRNk%3D" alt="AI问答02-Java内存溢出-可能溢出区.png" loading="lazy"/></p>
</li>
<li>
<p>通过前面的分析，我很肯定的告诉他，<code>Metaspace</code> 不存在溢出，然后补充了详细描述：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a588b884ba3f4ba585932c4cb0cbded9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTRwaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764171171&amp;x-signature=OROKgWUiMlMM%2FMKz06MCJiM8uFM%3D" alt="AI问答03-Java内存溢出-Native内存溢出.png" loading="lazy"/></p>
</li>
<li>
<p>结论一致，就是 <code>Native Memory</code> 问题，然后给出很多排查方式，逐一验证，结果：</p>
<ul>
<li><code>gdb</code> 命令报错</li>
<li><code>lsof</code> 命令不存在</li>
<li>需要安装 <code>bpfcc-tools</code> 工具</li>
<li><code>pmap</code> 输出内容并没有什么帮助</li>
</ul>
</li>
<li>
<p>虽然很多验证不了，不过结合前面的分析，还是可以排除很多选项，最后锁定 <code>glibc arena</code> 缓存：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4cf069b0c93d426591183b3ad2f01112~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTRwaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764171171&amp;x-signature=WEITOKzbRcxDm%2BGyyiM%2Bb%2FNoR9k%3D" alt="AI问答05-Java内存溢出-JVM之外区域.png" loading="lazy"/></p>
</li>
<li>
<p>继续追问 AI，如下描述和我观察到的现象如出一辙</p>
<ul>
<li><strong>glibc 的 malloc arena 缓存、不释放</strong>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56fa6a1bb5cb4ece974f7cbf130341db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTRwaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764171171&amp;x-signature=nc7PA9rX3MaZhGKaM6I1l0AG2Z4%3D" alt="AI问答04-Java内存溢出-glibc arena缓存特征.png" loading="lazy"/></li>
</ul>
</li>
</ul>
<h4 data-id="heading-22">三、验证 jemalloc</h4>
<ul>
<li>官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjemalloc.net%2F" target="_blank" title="https://jemalloc.net/" ref="nofollow noopener noreferrer">jemalloc.net/</a></li>
<li>GitHub: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjemalloc%2Fjemalloc" target="_blank" title="https://github.com/jemalloc/jemalloc" ref="nofollow noopener noreferrer">github.com/jemalloc/je…</a></li>
<li>下载 <code>jemalloc 5.3.0 源码</code>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjemalloc%2Fjemalloc%2Freleases%2Fdownload%2F5.3.0%2Fjemalloc-5.3.0.tar.bz2" target="_blank" title="https://github.com/jemalloc/jemalloc/releases/download/5.3.0/jemalloc-5.3.0.tar.bz2" ref="nofollow noopener noreferrer">github.com/jemalloc/je…</a></li>
</ul>
<h5 data-id="heading-23">1. 编译</h5>
<pre><code class="hljs language-bash" lang="bash">tar xvf jemalloc-5.3.0.tar.bz2
<span class="hljs-built_in">cd</span> jemalloc-5.3.0
./configure --prefix=<span class="hljs-variable">$HOME</span>/.local
make -j$(<span class="hljs-built_in">nproc</span>)
make install
​
<span class="hljs-comment"># 编译完成，拷贝 libjemalloc.so.2 到 /lib64</span>
<span class="hljs-built_in">cp</span> <span class="hljs-variable">$HOME</span>/.local/lib/libjemalloc.so.2 /lib64/
</code></pre>
<h5 data-id="heading-24">2. 修改容器启动脚本</h5>
<p><code>run.sh</code> 最顶部添加：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># ===== 关键内存参数 (必须放在最顶部) =====</span>
export <span class="hljs-attr">MALLOC_ARENA_MAX</span>=<span class="hljs-number">2</span>             <span class="hljs-comment"># 1核CPU只需2个arena (默认8)</span>
export <span class="hljs-attr">MALLOC_TRIM_THRESHOLD_</span>=<span class="hljs-number">131072</span>  <span class="hljs-comment"># 128KB空闲立即归还OS (默认128KB但失效)</span>
export <span class="hljs-attr">MALLOC_MMAP_THRESHOLD_</span>=<span class="hljs-number">131072</span>  <span class="hljs-comment"># &gt;128KB分配走mmap (独立释放)</span>
export <span class="hljs-attr">MALLOC_TOP_PAD_</span>=<span class="hljs-number">0</span>              <span class="hljs-comment"># 禁用顶部填充 (防碎片)</span>
export <span class="hljs-attr">GLIBC_TUNABLES</span>=glibc.malloc.trim_threshold=<span class="hljs-number">131072</span>  <span class="hljs-comment"># 双重保险</span>
​
<span class="hljs-comment"># ===== 强制使用 jemalloc（容器环境必须） =====</span>
export <span class="hljs-attr">LD_PRELOAD</span>=/lib64/libjemalloc.so.<span class="hljs-number">2</span>
</code></pre>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
  A[Java 进程启动] --&gt; B{LD_PRELOAD 检查}
  B --&gt;|存在| C[加载 libjemalloc.so.2]
  B --&gt;|不存在| D[加载 glibc 的 malloc]
  C --&gt; E[替换符号表]
  E --&gt; F[所有 malloc/free 调用指向 jemalloc]
  D --&gt; G[所有 malloc/free 调用指向 glibc]
</code></pre>
<h5 data-id="heading-25">3. 深度优化</h5>
<p>在 <code>/etc/malloc.conf</code> 添加如下配置</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1C3G 容器黄金配置</span>
dirty_decay_ms:1000,      <span class="hljs-comment"># 1秒后归还 dirty pages</span>
muzzy_decay_ms:100,       <span class="hljs-comment"># 100ms后归还 muzzy pages</span>
background_thread:<span class="hljs-literal">true</span>,   <span class="hljs-comment"># 启用后台回收线程 (关键!)</span>
max_background_threads:1, <span class="hljs-comment"># 1核容器只需1个线程</span>
metadata_thp:auto,        <span class="hljs-comment"># 优化元数据内存</span>
tcache:<span class="hljs-literal">false</span>,             <span class="hljs-comment"># 禁用 thread cache (防 TLS 碎片)</span>
arena_bind:<span class="hljs-literal">true</span>,          <span class="hljs-comment"># 1核CPU绑定1个arena</span>
abort_conf:<span class="hljs-literal">true</span>           <span class="hljs-comment"># 配置错误时崩溃 (防静默失效)</span>
</code></pre>
<p>容器中可以在 <code>dockerfile</code> 文件中，通过如下指令实现：</p>
<pre><code class="hljs language-bash" lang="bash">USER root
RUN <span class="hljs-built_in">echo</span> <span class="hljs-string">"dirty_decay_ms:1000,muzzy_decay_ms:100,background_thread:true,max_background_threads:1,metadata_thp:auto,tcache:false,arena_bind:true,abort_conf:true"</span> &gt; /etc/malloc.conf
</code></pre>
<p>或者，在启动脚本中添加：</p>
<pre><code class="hljs language-ini" lang="ini">export <span class="hljs-attr">MALLOC_CONF</span>=<span class="hljs-string">"dirty_decay_ms:1000,muzzy_decay_ms:100,background_thread:true,max_background_threads:1,metadata_thp:auto,tcache:false,arena_bind:true,abort_conf:true"</span>
</code></pre>
<p>重新部署后，通过下面命令验证 jemalloc 是否生效</p>
<pre><code class="hljs language-perl" lang="perl">jcmd &lt;pid&gt; VM.dynlibs | <span class="hljs-keyword">grep</span> jemalloc
<span class="hljs-comment"># 有输出就表示生效</span>
</code></pre>
<h5 data-id="heading-26">4. 验证</h5>
<p>效果非常显著，内存不再无限上涨，具体如下：</p>




















<table><thead><tr><th/><th>使用 jemalloc 前</th><th>使用 jemalloc 后</th></tr></thead><tbody><tr><td>3G 容器</td><td>内存很快飙升到 3G，进程被杀</td><td>压测 24 小时，内存稳定在 2.4G 以下</td></tr><tr><td>6G 容器</td><td>内存很快飙升到 4G，持续上涨，最高达到 5G+</td><td>压测 3 小时，内存稳定在 2.4G 以下</td></tr></tbody></table>
<h3 data-id="heading-27">问题三：账户列表查询接口耗时过长</h3>
<h4 data-id="heading-28">一、现象描述</h4>
<p>这是一个非常简单的接口，仅包含一次 ESB 接口调用，预期 RT 应该在 <code>100~300ms</code>。但是 偶尔 会出现超过 <code>1000ms</code>，甚至 <code>2000~5000ms</code>。</p>
<h4 data-id="heading-29">二、日志分析</h4>
<p>通过应用日志观察，剔除“网络调用耗时过长”的交易，仍有不少 <strong>代码执行耗时（无IO）</strong> 超过 1 秒的交易。</p>
<h4 data-id="heading-30">三、分析代码</h4>
<p>结合请求响应报文分析 可能的代码长耗时点， 同一客户、相同请求参数、相同响应参数也是时快时慢，<strong>排除代码问题导致</strong>。</p>
<h4 data-id="heading-31">四、查看 GC 日志</h4>
<p>发现 Young GC 耗时异常(<code>&gt; 100ms</code>)
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48d369d63435414aa17f7bcac1b4f180~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTRwaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764171171&amp;x-signature=FR38I8xJsRQYIm%2FekSWQYDvG63c%3D" alt="YGC耗时超100ms.jpg" loading="lazy"/></p>
<p>甚至有高达 300+ ms 的
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d044a0a1f01469998ec8f024d606e31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTRwaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764171171&amp;x-signature=7hLbPBOfIoJrcef1CA92m4gnm4k%3D" alt="YGC耗时超300ms.jpg" loading="lazy"/></p>
<h4 data-id="heading-32">五、jvm 参数调整</h4>
<p>发现一个严重的配置错误：<code>-Xmn776m</code>，在 G1 / ZGC 中不能使用 Xmn 参数。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
  A[传统 GC] --&gt; B[固定分区]
  B --&gt; C[Young Gen: 1/3 堆]
  B --&gt; D[Old Gen: 2/3 堆]
  C --&gt; E[Eden + 2 Survivor]
  
  F[G1 GC] --&gt; G[Region 网格]
  G --&gt; H[动态分配 Young/Old]
  H --&gt; I[每 Region 1-32MB]
  H --&gt; J[Humongous 对象专用]
</code></pre>
<ul>
<li>
<p>在 <code>G1 GC</code> 中使用 <code>-Xmn</code> 是<strong>严重配置错误</strong>，会<strong>破坏 G1 的核心自适应机制</strong>， 导致停顿时间失控、吞吐量暴跌 40%+</p>
</li>
<li>
<p><strong>关键区别</strong>：</p>
<ul>
<li><strong>Parallel GC</strong>：<code>-Xmn</code> 直接设置 Young Gen 大小（物理分区）</li>
<li><strong>G1 GC</strong>：Young Gen 是<strong>逻辑集合</strong>，由多个 Region 动态组成</li>
<li><strong>设置 -Xmn 会强制 G1 退化为 Parallel GC 模式</strong>（丧失核心优势）</li>
<li><code>-Xmn</code> 过大，1核的 CPU 无法在 80ms 内完成回收</li>
</ul>
</li>
</ul>

<pre><code class="hljs language-css" lang="css">graph LR
  <span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[传统 GC]</span> --&gt; <span class="hljs-selector-tag">B</span><span class="hljs-selector-attr">[固定分代]</span>
  <span class="hljs-selector-tag">B</span> --&gt; C<span class="hljs-selector-attr">[Young Gen: Eden+Survivor]</span>
  <span class="hljs-selector-tag">B</span> --&gt; D<span class="hljs-selector-attr">[Old Gen: Tenured]</span>
  C --&gt;|-Xmn 控制| E<span class="hljs-selector-attr">[固定大小]</span>
  
  F<span class="hljs-selector-attr">[ZGC]</span> --&gt; G<span class="hljs-selector-attr">[单代+动态 Region]</span>
  G --&gt; H<span class="hljs-selector-attr">[Colored Pointers]</span>
  G --&gt; <span class="hljs-selector-tag">I</span><span class="hljs-selector-attr">[Load Barriers]</span>
  G --&gt; J<span class="hljs-selector-attr">[并发压缩]</span>
  H --&gt; K<span class="hljs-selector-attr">[无物理分代边界]</span>
</code></pre>
<ul>
<li>
<p><strong>在 ZGC 中设置 -Xmn 不仅无效，更是严重配置错误</strong>，会导致 JVM <strong>忽略关键内存参数</strong>，在 1C3G 容器中引发：</p>
<ul>
<li><strong>内存分配失控 → RSS 超限 OOMKilled</strong></li>
<li><strong>GC 自适应失效 → 停顿时间飙升 300%</strong></li>
</ul>
</li>
<li>
<p><strong>ZGC 核心设计</strong>：</p>
<ul>
<li><strong>无物理年轻代</strong>：所有对象在统一堆中分配</li>
<li><strong>动态 Region 管理</strong>：根据对象生命周期自动调整</li>
<li><strong>就地压缩 (In-place Relocation)</strong> ：无需 Survivor 空间</li>
</ul>
</li>
</ul>

<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[0.213s]</span><span class="hljs-selector-attr">[warning]</span><span class="hljs-selector-attr">[gc]</span> -Xmn is not supported with ZGC, ignoring
<span class="hljs-selector-attr">[0.214s]</span><span class="hljs-selector-attr">[warning]</span><span class="hljs-selector-attr">[gc]</span> Use -XX:SoftMaxHeapSize for heap sizing control
</code></pre>
<h3 data-id="heading-33">总结</h3>
<h4 data-id="heading-34">一、JVM 参数（最终版）</h4>
<ul>
<li>必须放在 JVM 参数最前面</li>
</ul>

<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 内存预碰撞</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+AlwaysPreTouch</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+TransparentHugePages</span>  <span class="hljs-comment"># 配合使用 (仅物理机有效)</span>
​
<span class="hljs-comment"># 启用 TransparentHugePages 会自动将物理内存分成若干个大小为2MB的大块，并将其映射到系统的透明大页缓存中。当JVM需要分配一块内存时，如果该内存大小小于等于2MB，则直接从系统透明大页缓存中获取；否则，会将该内存拆分成若干个小块，并分别从系统透明大页缓存中获取。这样做的效果是可以避免因内存碎片而导致的内存不足问题，同时也可以减少内存访问的延迟和抖动。</span>
</code></pre>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
  A[JVM 启动] --&gt;|默认| B[仅预分配内存指针]
  B --&gt; C[运行时首次访问]
  C --&gt; D[OS 触发 page fault]
  D --&gt; E[1C CPU 无法及时响应]
  E --&gt; F[线程阻塞 50-100ms]
  F --&gt; G[RSS 突增 → OOMKilled]
  
  A --&gt;|AlwaysPreTouch=true| H[启动时触碰所有页]
  H --&gt; I[内存连续分配]
  I --&gt; J[RSS 稳定增长]
  J --&gt; K[无运行时阻塞]
</code></pre>
<h5 data-id="heading-35">容器必配</h5>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 告知 JVM 当前运行环境为容器，避免 JVM 错误识别宿主机配置</span>
-XX:+UseContainerSupport
<span class="hljs-comment"># 告知 JVM 当前容器 cpu 核数，避免 JVM 错误识别宿主机配置</span>
-XX:<span class="hljs-attr">ActiveProcessorCount</span>=<span class="hljs-number">1</span>
<span class="hljs-comment"># 告知 JVM 当前容器内存限制，避免 JVM 错误识别宿主机配置</span>
-XX:<span class="hljs-attr">MaxRAM</span>=<span class="hljs-number">3072</span>m
<span class="hljs-comment"># JVM 最大可用内存 MaxRAM * 75%, </span>
<span class="hljs-comment"># 保守一点可以设为 70%, 留 30% 给操作系统，根据压测情况做调整</span>
-XX:<span class="hljs-attr">MaxRAMPercentage</span>=<span class="hljs-number">75.0</span>
</code></pre>
<h5 data-id="heading-36">堆（Heap）</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 最大堆、最小堆空间，一般设置为同一个值，我是因为压测都不会超过 1200m</span>
<span class="hljs-comment"># 使用 G1 或 ZGC 绝对不能设置 -Xmn (新生代大小)</span>
-Xms1320m -Xmx1720m 
</code></pre>
<h5 data-id="heading-37">栈空间（Stack）</h5>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 线程栈空间限制，必须指定</span>
<span class="hljs-comment"># 默认值是 1MB，用不到纯浪费，300 个线程就是 300MB</span>
<span class="hljs-comment"># 一般没有很深的调用栈设置 256k 即可（微服务推荐），300 个线程可节省 225MB</span>
-XX:<span class="hljs-attr">ThreadStackSize</span>=<span class="hljs-number">256</span>k
</code></pre>
<h5 data-id="heading-38">元空间（Metaspace）</h5>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 按实际情况调整，比如压测峰值 164m</span>
<span class="hljs-comment"># 如果内存充足，不希望发生 Full GC, 可以 初始值=最大值</span>
-XX:<span class="hljs-attr">MetaspaceSize</span>=<span class="hljs-number">128</span>m          <span class="hljs-comment"># 初始阈值 (接近峰值的 80%)</span>
-XX:<span class="hljs-attr">MaxMetaspaceSize</span>=<span class="hljs-number">192</span>m       <span class="hljs-comment"># 硬限制 (164MB * 1.17 = 192MB)</span>
-XX:<span class="hljs-attr">MinMetaspaceFreeRatio</span>=<span class="hljs-number">30</span>    <span class="hljs-comment"># 降低空闲比例 (加速回收)</span>
-XX:<span class="hljs-attr">MaxMetaspaceFreeRatio</span>=<span class="hljs-number">60</span>    <span class="hljs-comment"># 限制最大空闲 (防碎片)</span>
</code></pre>
<h5 data-id="heading-39">直接内存（Direct）</h5>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 必须限制，1C3G容器绝对上限：128m</span>
<span class="hljs-comment"># 扣除 75% 的JVM, 再扣除操作系统运行消耗 100+M, 系统仅剩 600+M 的可用内存，还要用于操作系统 native memory、缓存等，这里不限制很容易发生 OOMKilled</span>
-XX:<span class="hljs-attr">MaxDirectMemorySize</span>=<span class="hljs-number">128</span>m
</code></pre>
<h5 data-id="heading-40">垃圾回收（GC）</h5>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 使用 G1 或 ZGC 绝对不能设置 -Xmn (新生代大小)</span>
-XX:+UseG1GC
-XX:+UseDynamicNumberOfGCThreads <span class="hljs-comment"># 启用动态调整 (默认开启)</span>
-XX:<span class="hljs-attr">ParallelGCThreads</span>=<span class="hljs-number">2</span>          <span class="hljs-comment"># STW 线程 = 2 (1C 容器最大值)</span>
-XX:<span class="hljs-attr">ConcGCThreads</span>=<span class="hljs-number">1</span>              <span class="hljs-comment"># 并发线程 = cpu核心数</span>
-XX:<span class="hljs-attr">G1NewSizePercent</span>=<span class="hljs-number">25</span>          <span class="hljs-comment"># 新生代最小值：25% 堆</span>
-XX:<span class="hljs-attr">G1MaxNewSizePercent</span>=<span class="hljs-number">35</span>       <span class="hljs-comment"># 新生代最大值：35% 堆</span>
-XX:<span class="hljs-attr">MaxGCPauseMillis</span>=<span class="hljs-number">80</span>          <span class="hljs-comment"># GC 暂停，严格 80ms 目标</span>

<span class="hljs-comment"># 手动设置每个 region 的大小，平衡碎片与回收效率</span>
<span class="hljs-comment"># 过大：碎片率增加</span>
<span class="hljs-comment"># 过小：region 数量增加，GC 元数据膨胀，CPU 超载</span>
<span class="hljs-comment"># 1 核 CPU 无法处理 &gt;1000 个 Region 的并发标记，768 个 Region (2MB) 是 1C 容器的最佳配置</span>
-XX:<span class="hljs-attr">G1HeapRegionSize</span>=<span class="hljs-number">2</span>M

<span class="hljs-comment"># 允许 10% 空闲 (加速回收)</span>
-XX:<span class="hljs-attr">G1HeapWastePercent</span>=<span class="hljs-number">10</span>

<span class="hljs-comment"># RSet 更新占比，默认值 10, Young GC 暂停中最多 10% 用于 RSet 更新</span>
<span class="hljs-comment"># 1C3G 容器 Young GC 时间分配：</span>
<span class="hljs-comment">#     - 对象复制：65</span>
<span class="hljs-comment">#     - RSet 更新：25</span>
<span class="hljs-comment">#     - 其他开销：10</span>
<span class="hljs-comment"># 调小后，Rset 更新不完整，增加 Mixed GC 频率</span>
-XX:<span class="hljs-attr">G1RSetUpdatingPauseTimePercent</span>=<span class="hljs-number">5</span>
<span class="hljs-comment"># 控制 Mixed GC 阶段计划执行的 GC 次数</span>
<span class="hljs-comment"># 单次 Mixed GC 回收的Region数量 ≈ 需要回收的Region总数 / G1MixedGCCountTarget</span>
<span class="hljs-comment"># 调大 ==&gt; 单次 GC 停顿短，总回收时间长</span>
<span class="hljs-comment"># 调小 ==&gt; 单次 GC 停顿长，总回收时间短</span>
-XX:<span class="hljs-attr">G1MixedGCCountTarget</span>=<span class="hljs-number">8</span>

<span class="hljs-comment"># 触发 Mixed GC 的老年代使用率，默认是 45</span>
-XX:<span class="hljs-attr">InitiatingHeapOccupancyPercent</span>=<span class="hljs-number">35</span>

<span class="hljs-comment"># 可以指定 JVM 在启动时为 G1 垃圾回收器保留的堆内存百分比</span>
<span class="hljs-comment"># 好处：可以避免在垃圾回收期间出现“暂停时间过长”的问题</span>
-XX:<span class="hljs-attr">G1ReservePercent</span>=<span class="hljs-number">20</span>

<span class="hljs-comment"># gc 日志必须开，路径必须是容器挂载目录，还需在容器启动脚本中添加相关的清理脚本</span>
-Xlog:gc*:<span class="hljs-attr">file</span>=/logs/<span class="hljs-variable">${POD_NAMESPACE}</span>/<span class="hljs-variable">${APP_NAME}</span>/gc-%t.log:hostname,time,uptime,pid:filecount=<span class="hljs-number">5</span>,filesize=<span class="hljs-number">10</span>M
</code></pre>
<h5 data-id="heading-41">OOM相关（内存溢出, Out of memory）</h5>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 发生 OOM 时，立即终止（硬崩溃），除了无状态 API 服务，其他场景慎用，支付核心服务禁用</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+CrashOnOutOfMemoryError</span>
<span class="hljs-comment"># 发生 OOM 时，优雅退出（软关闭）</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+ExitOnOutOfMemoryError</span> 


<span class="hljs-comment"># 以上参数二选一，建议 -XX:+ExitOnOutOfMemoryError </span>


<span class="hljs-comment"># 发生 OOM 时生成 Java 堆转储</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+HeapDumpOnOutOfMemoryError</span> 

<span class="hljs-comment"># 堆转储文件保存位置，路径必须是容器挂载目录</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:HeapDumpPath=/logs/</span><span class="hljs-variable">${</span><span class="hljs-variable constant_">POD_NAMESPACE</span>}/<span class="hljs-variable">${</span><span class="hljs-variable constant_">APP_NAME</span>}/heapdump_start_<span class="hljs-variable">$(</span>date +<span class="hljs-string">"%Y-%m-%d_%H%M%S"</span>).hprof 

<span class="hljs-comment"># JVM 发生致命错误时，日志文件保存位置，路径必须是容器挂载目录</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:ErrorFile=/logs/</span><span class="hljs-variable">${</span><span class="hljs-variable constant_">POD_NAMESPACE</span>}/<span class="hljs-variable">${</span><span class="hljs-variable constant_">APP_NAME</span>}/<span class="hljs-variable">${</span><span class="hljs-variable constant_">HOSTNAME</span>}-hs_err_pid.<span class="hljs-variable">$$</span>.log 

<span class="hljs-comment"># 开启 NMT: 本地内存追踪</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:NativeMemoryTracking=summary</span>
<span class="hljs-comment"># 安全的诊断替代方案 (无大文件)，避免写满磁盘空间，导致节点故障</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:OnOutOfMemoryError=<span class="hljs-string">"jcmd %p VM.native_memory summary &gt; /logs/${POD_NAMESPACE}/${APP_NAME}/oom_nmt.log"</span></span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:OnOutOfMemoryError2=<span class="hljs-string">"jcmd %p VM.classloader_stats &gt; /logs/${POD_NAMESPACE}/${APP_NAME}/oom_classes.log"</span></span>
</code></pre>
<h5 data-id="heading-42">本地内存（native memory）</h5>
<pre><code class="hljs language-ruby" lang="ruby">-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:InitialCodeCacheSize=</span>64m       <span class="hljs-comment"># JIT 缓存初始值</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:ReservedCodeCacheSize=</span>128m     <span class="hljs-comment"># JIT 缓存上限</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+UseCodeCacheFlushing</span>          <span class="hljs-comment"># 启用回收</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+SegmentedCodeCache</span>            <span class="hljs-comment"># 代码缓存分段，必须开启</span>

<span class="hljs-comment"># 启用分层编译（默认开启），以下情况保持启用：</span>
<span class="hljs-comment">#   - 微服务、容器化应用</span>
<span class="hljs-comment">#   - 命令行工具、短期任务</span>
<span class="hljs-comment">#   - 需要快速响应的交互应用</span>
<span class="hljs-comment">#   - 大多数Web应用</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+TieredCompilation</span>

<span class="hljs-comment"># 禁用分层编译，启动更慢，方法需要更长时间才能被优化</span>
<span class="hljs-comment"># 适用于长期运行的服务端应用：</span>
<span class="hljs-comment">#   - 对启动时间不敏感的场景</span>
<span class="hljs-comment">#   - 需要极致峰值性能的计算任务</span>
<span class="hljs-comment">#   - 遇到分层编译相关bug时</span>
<span class="hljs-comment">#   - 需要极致峰值性能的计算任务</span>
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:-TieredCompilation</span>
</code></pre>
<h5 data-id="heading-43">反射与代理</h5>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 作用：禁用 JNI 本地方法膨胀（反射调用优化），false 表示启用膨胀</span>
<span class="hljs-comment"># 好处：提高反射性能，减少初始反射调用开销（20-30%）, 降低 Metaspace 碎片率</span>
<span class="hljs-comment"># 坏处：增加永久代/元空间使用，启动稍慢</span>
<span class="hljs-comment"># 在 1C3G 容器中，如果应用使用反射较多，可以开启，但需注意元空间内存。建议监控元空间使用情况。</span>
<span class="hljs-attr">-Dsun.reflect.noInflation</span>=<span class="hljs-literal">false</span>

<span class="hljs-comment"># 作用：不将动态代理生成的类文件保存到磁盘</span>
<span class="hljs-comment"># 好处：避免在磁盘上生成临时文件，提高性能，并减少磁盘 I/O</span>
<span class="hljs-comment"># 坏处：不便于调试动态代理问题</span>
<span class="hljs-comment"># 推荐：在生产环境可以设置为 false，避免磁盘占用。在 1C3G 容器中，通常不需要保存这些文件，所以推荐</span>
<span class="hljs-attr">-Djdk.proxy.ProxyGenerator.saveGeneratedFiles</span>=<span class="hljs-literal">false</span>
</code></pre>
<h5 data-id="heading-44">线程池与并发</h5>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 作用：设置 ForkJoinPool 公共池的最大线程数</span>
<span class="hljs-comment"># 好处：控制并行流和 CompletableFuture 等使用的公共线程池的大小，避免创建过多线程</span>
<span class="hljs-comment"># 坏处：如果并行任务较多，可能会限制并行性能</span>
<span class="hljs-comment"># 推荐：CPU 核数 * 1.5 = 1 * 1.5 → 2</span>
<span class="hljs-attr">-Djava.util.concurrent.ForkJoinPool.common.maximumPoolSize</span>=<span class="hljs-number">2</span>

<span class="hljs-comment"># 作用：限制 NIO CompletionHandler 最大数量</span>
<span class="hljs-comment"># 好处：提高 NIO 通道的并发处理能力</span>
<span class="hljs-comment"># 坏处：设置过大会占用更多内存</span>
<span class="hljs-comment"># 推荐：每个 handler 保留 64KB native 内存 → 128 * 64KB = 8.2MB</span>
<span class="hljs-attr">-Dsun.nio.ch.maxCompletionHandlers</span>=<span class="hljs-number">64</span>
</code></pre>
<h5 data-id="heading-45">Netty 优化</h5>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 作用：设置 Netty EventLoop 线程数</span>
<span class="hljs-comment"># 好处：控制 Netty 的线程数，避免线程争抢</span>
<span class="hljs-comment"># 坏处：线程数少可能在高并发时成为瓶颈</span>
<span class="hljs-comment"># 推荐：在 1 核容器中，2 个线程是合理的，因为 Netty 通常每个线程处理多个通道</span>
<span class="hljs-attr">-Dio.netty.eventLoopThreads</span>=<span class="hljs-number">2</span>

<span class="hljs-comment"># 作用：设置 Netty 使用的最大直接内存。0 表示使用 JVM 的 MaxDirectMemorySize（默认与-Xmx相同），与 -XX:MaxDirectMemorySize 冲突 → 覆盖 JVM 限制，必须限制</span>
<span class="hljs-comment"># 好处：避免 Netty 使用过多的直接内存</span>
<span class="hljs-comment"># 坏处：如果应用需要大量直接内存，可能会限制性能</span>
<span class="hljs-comment"># 推荐：MaxDirectMemorySize * 75%</span>
<span class="hljs-attr">-Dio.netty.maxDirectMemory</span>=<span class="hljs-number">96</span>

<span class="hljs-comment"># 作用：使用池化的 ByteBuf 分配器</span>
<span class="hljs-comment"># 好处：减少 direct memory 分配和回收的开销，提高性能</span>
<span class="hljs-comment"># 坏处：可能会占用更多内存，内存池需要 2 倍内存空间 → 128MB 需 256MB</span>
<span class="hljs-comment"># 推荐：在生产环境中推荐使用 pooled</span>
<span class="hljs-attr">-Dio.netty.allocator.type</span>=pooled
<span class="hljs-comment"># 如果内存紧张就用 unpooled</span>
<span class="hljs-attr">-Dio.netty.allocator.type</span>=unpooled
<span class="hljs-attr">-Dio.netty.allocator.maxOrder</span>=<span class="hljs-number">9</span>      <span class="hljs-comment"># 降低池大小</span>

<span class="hljs-comment"># 作用：禁用 Netty 的内存泄漏检测</span>
<span class="hljs-comment"># 好处：提升性能，降低 5% CPU 开销</span>
<span class="hljs-comment"># 坏处：如果存在内存泄漏，将无法检测到</span>
<span class="hljs-comment"># 推荐：在生产环境可以禁用，但如果在开发测试阶段已经通过检测，则可以禁用</span>
<span class="hljs-attr">-Dio.netty.leakDetectionLevel</span>=DISABLED
<span class="hljs-comment"># 平衡开销与安全：每 1000 次分配检查 1 次，避免泄漏无感知</span>
<span class="hljs-attr">-Dio.netty.leakDetectionLevel</span>=SIMPLE
</code></pre>
<h5 data-id="heading-46">Log4j2</h5>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 作用：使用异步日志记录器，将日志事件放入环形缓冲区，由后台线程写入</span>
<span class="hljs-comment"># 好处：减少日志记录对应用性能的影响，特别是同步日志造成的延迟</span>
<span class="hljs-comment"># 坏处：在崩溃时可能会丢失部分日志，并且需要额外的内存用于缓冲区</span>
<span class="hljs-comment"># 推荐：在 1C3G 容器中，如果日志量较大，可以使用异步日志，但需注意环形缓冲区大小和内存使用</span>
<span class="hljs-attr">-Dlog4j2.contextSelector</span>=org.apache.logging.log4j.core.async.AsyncLoggerContextSelector

<span class="hljs-comment"># 作用：AsyncLogger 等待策略</span>
<span class="hljs-comment"># 好处：比 timeout 更低的唤醒延迟</span>
<span class="hljs-comment"># 坏处：可能比 block 更高的 CPU 使用</span>
<span class="hljs-comment"># 推荐：yield 平衡性能和延迟</span>
<span class="hljs-attr">-Dlog4j2.asyncLogger.waitStrategy</span>=yield

<span class="hljs-comment"># 作用：RingBuffer 大小（条目数）</span>
<span class="hljs-comment"># 推荐：64 K 足够 1000 TPS</span>
<span class="hljs-attr">-Dlog4j2.asyncLoggerRingBufferSize</span>=<span class="hljs-number">65536</span>    <span class="hljs-comment"># 65536 * 32 字节 = 2MB</span>

<span class="hljs-comment"># 禁用 JMX 监控，容器环境必须禁用，减少 50MB 内存开销，加快启动 15%</span>
<span class="hljs-attr">-Dlog4j2.disable.jmx</span>=<span class="hljs-literal">true</span>
<span class="hljs-comment"># 避免类加载泄漏，传统的外部 web 容器需要设置为 true</span>
<span class="hljs-attr">-Dlog4j2.isWebapp</span>=<span class="hljs-literal">false</span>

<span class="hljs-comment"># 作用：启用 ThreadLocal 优化</span>
<span class="hljs-comment"># 坏处：增加 TLS 碎片，可能导致内存泄漏</span>
<span class="hljs-comment"># 推荐：必须启用以保证日志完整性</span>
<span class="hljs-attr">-Dlog4j2.enableThreadlocals</span>=<span class="hljs-literal">true</span>

<span class="hljs-comment"># 作用：设置解包（unbox）环形缓冲区的大小，用于将基本类型转换为字符串时减少对象分配。</span>
<span class="hljs-comment"># 好处：减少基本类型日志记录时的装箱操作，减少GC压力。</span>
<span class="hljs-comment"># 坏处：缓冲区大小固定，如果并发日志记录很多，可能无法覆盖所有线程。</span>
<span class="hljs-comment"># 推荐：启用无装箱（1C 容器必须）</span>
<span class="hljs-attr">-Dlog4j2.unboxRingBufferSize</span>=<span class="hljs-number">256</span>
</code></pre>
<h4 data-id="heading-47">二、错误反思</h4>
<h5 data-id="heading-48">1. 没有严格审核脚本</h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a68321787584e0abef2e7ffcae962f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTRwaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764171171&amp;x-signature=mmT5IOOQHN5W6lSg0wgkG62rwnE%3D" alt="测试脚本免责声明.jpg" loading="lazy"/></p>
<p>内含两个致命错误：</p>
<ul>
<li>CrashOnOutOfMemoryError</li>
<li>Xmn</li>
</ul>
<h5 data-id="heading-49">2. 把问题描述清楚，问题就已经解决一半了</h5>
<p>AI 让这句话的含金量更上一层楼了。</p>
<p>一开始只是一味地问，在很小的细节上提问，没有把完整的问题、现象描述清楚，浪费了很多时间。</p>
<h3 data-id="heading-50">附：开启 jmc, jvisualvm 监控的方法</h3>
<p>（生产禁止）</p>
<p>容器启动脚本 <code>run.sh</code> 添加：</p>
<pre><code class="hljs language-dart" lang="dart"># hostIp=$(ifconfig | grep -E <span class="hljs-string">"inet .* netmask .* broadcast "</span> | awk <span class="hljs-string">'{print <span class="hljs-subst">$2</span>}'</span>)
hostIp=$(ip a | grep <span class="hljs-string">"eth0"</span> -A <span class="hljs-number">3</span> | grep <span class="hljs-string">"inet "</span> | awk <span class="hljs-string">'{print <span class="hljs-subst">$2</span>}'</span> | awk -F<span class="hljs-string">"/"</span> <span class="hljs-string">'{print <span class="hljs-subst">$1</span>}'</span>)
JAVA_JMX_REMOTE=<span class="hljs-string">"-Djava.rmi.server.hostname=<span class="hljs-subst">${hostIp}</span> -Dcom.sun.management.jmxremote=true -Dcom.sun.management.jmxremote.port=7091 -Dcom.sun.management.jmxremote.rmi.port=7091 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false -XX:StartFlightRecording -XX:FlightRecorderOptions=memorysize=20M,maxchunksize=10M,stackdepth=128,repository=/<span class="hljs-subst">${LOG_PATH}</span>/jfr-temp -XX:StartFlightRecording=disk=true,maxsize=1g,dumponexit=true,name=ProdRecording,filename=/<span class="hljs-subst">${LOG_PATH}</span>/proc-xxx.jfr,settings=profile"</span>
​
JAVA_JVM=<span class="hljs-string">"<span class="hljs-subst">${JAVA_JVM}</span> <span class="hljs-subst">${JAVA_JMX_REMOTE}</span>"</span>
</code></pre>
<h3 data-id="heading-51">附：jemalloc 内存分配器</h3>
<h5 data-id="heading-52">背景</h5>
<p>在 Kubernetes（K8s）容器编排环境中，内存资源管理一直是运维人员面临的核心挑战。</p>
<p>默认内存分配器往往导致容器<strong>内存利用率低下、Pod 驱逐频繁</strong>等问题，尤其在微服务架构中，这些问题会被放大为集群级别的性能损耗。</p>
<p>容器化应用普遍面临三大内存管理难题：<strong>内存碎片化导致实际使用内存远高于应用申请量、GC 延迟引发服务响应波动、资源争用造成 Pod 频繁触发 OOM（内存溢出）</strong> 。</p>
<p>传统 <code>libc malloc</code> 分配器在多线程容器环境中表现尤为不佳，而 <code>jemalloc</code> 通过以下核心机制提供解决方案：</p>
<ul>
<li><strong>线程缓存（TCache）</strong> ：每个线程维护独立内存缓存，减少锁竞争，对应源码实现可见src/tcache.c</li>
<li><strong>分箱分配（Bin-based Allocation）</strong> ：将内存请求分类到预设大小的"箱子"，降低碎片率，关键逻辑在src/bin.c</li>
<li><strong>背景线程（Background Thread）</strong> ：异步回收未使用内存，避免应用线程阻塞</li>
</ul>
<p>jemalloc 是一个现代的内存分配器，由 Jason Evans 开发，旨在提供<strong>高性能和低碎片化</strong>的内存管理。 它最初是由 Jason Evans 于 2005 年开发的，侧重于减少内存碎片和提升多线程高并发场景下内存的分配效率。</p>
<h5 data-id="heading-53">主要特点和优势</h5>
<p>jemalloc 最大的优势在于多线程情况下的高性能以及内存碎片的减少。 与其它内存分配器（如 glibc 的 malloc）相比，它在多线程场景下内存分配性能更高，能有效减少内存碎片。 这使得 jemalloc 特别适合充分发挥现代多核处理器的并发优势。</p>
<h5 data-id="heading-54">工作原理</h5>
<p>jemalloc 采用了多种策略来优化内存分配和回收。 在内存管理方面，jemalloc 采用"整块批发，零散零售"的策略：整块批发的内存叫做 chunk（通常大小为4MB），对于小件和大件订单，则进一步拆成 run 进行分配。</p>
<p>jemalloc 自身占用的内存包括 Cache 和 Metadata 两部分，其中 Cache 又包括 Thread Cache 和 Dirty Page 两部分，这种设计有助于提高内存分配效率。</p>
<h5 data-id="heading-55">应用场景</h5>
<p>由于其出色的性能特性，jemalloc 被广泛应用于各种高性能系统中。例如，Apache Doris默认使用 jemalloc 作为通用内存分配器。 它通过独特的设计和优化，致力于减少内存碎片，提升内存分配效率，使其成为现代高性能应用的理想选择。</p>
<p>总的来说，jemalloc 是一个高效的内存分配器，通过减少内存碎片和优化多线程性能，为现代应用程序提供了更优秀的内存管理解决方案。</p>
<h5 data-id="heading-56">为什么 <code>LD_PRELOAD</code> 能全局生效？</h5>
<p><strong>动态链接器劫持原理</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
  JVM-&gt;&gt;+Linux内核: 执行 java 进程
  Linux内核-&gt;&gt;+ld.so: 加载动态链接器
  ld.so-&gt;&gt;+LD_PRELOAD: 检查环境变量
  LD_PRELOAD-&gt;&gt;+libjemalloc.so: 优先加载
  libjemalloc.so-&gt;&gt;+glibc: 替换 malloc/free 等符号
  glibc--&gt;&gt;-JVM: 所有分配走 jemalloc
  JVM-&gt;&gt;+Netty: JNI 调用
  Netty-&gt;&gt;+OpenSSL: 动态库调用
  OpenSSL-&gt;&gt;+glibc: 原本调用 malloc
  glibc--&gt;&gt;-OpenSSL: 实际走 jemalloc
</code></pre>
<ul>
<li>
<p><strong>关键点</strong>：</p>
<ul>
<li><code>LD_PRELOAD</code> 在 <strong>进程启动最早期</strong> 注入</li>
<li>覆盖所有后续的 <code>malloc/free/mmap</code> 调用</li>
<li><strong>100% 覆盖</strong> JVM + 所有 native 库（Netty/SSL/压缩库等）</li>
</ul>
</li>
</ul>
<h5 data-id="heading-57">应用案例</h5>
<p>🌟在蚂蚁集团/阿里云内部</p>
<p><strong>99.7% 的 native 内存泄漏场景通过 jemalloc + 合理参数配置解决</strong>，无需修改业务代码。 某支付系统案例：<code>4.2G RSS → 1.8G（下降 57%），GC 停顿减少 40%</code>。</p>
<p>🔑 在 2024 年阿里云容器服务中</p>
<p><strong>92% 的 1C3G 容器 OOM 问题</strong> 通过 <code>MALLOC_ARENA_MAX=2 + jemalloc</code> 解决。 <strong>永远不要相信 glibc 在容器中的默认行为</strong> —— 它为物理机设计，而非容器。</p>
<p>💡 <strong>阿里云 ARMS 实测数据</strong>： 在 1C3G 容器中替代 jemalloc prof：</p>
<ul>
<li>内存开销：<strong>45 MB</strong> (vs jemalloc prof 280 MB)</li>
<li>CPU 开销：<strong>0.8%</strong> (vs 18.3%)</li>
<li>诊断能力：Java 堆栈 + native 调用链</li>
</ul>
<p>🔑 在 2024 年蚂蚁集团生产环境审计中</p>
<p><strong>83% 的 "4G+ RSS 但 JVM 只报 2G" 问题</strong> 由 glibc arena 缓存引起，通过 <code>MALLOC_ARENA_MAX=4 + jemalloc</code> 100% 解决。</p>
<p>🔑 <strong>核心洞察</strong>： <strong>glibc 为 2000 年代的物理机设计，jemalloc 为云原生时代而生</strong>。 在 1C3G 这样的受限容器中，<strong>jemalloc 不是优化，而是生存必需</strong>。 某金融客户将 10,000+ 容器从 glibc 迁移到 jemalloc 后：</p>
<ul>
<li>月度 OOM 事件从 2,300 次 → <strong>0 次</strong></li>
<li>节省云资源成本 <strong>$47,000/月</strong></li>
</ul>
<p>🔑 <strong>终极洞察</strong>： <strong>不使用 jemalloc 时，内存溢出与否 = 应用行为 × JVM 配置 × 容器环境 的乘积</strong>。 某金融客户 500 个容器实证：</p>
<ul>
<li>通过<strong>精准配置</strong>，320 个容器无需 jemalloc 稳定运行</li>
<li>剩余 180 个（Netty/动态代理密集型）<strong>必须用 jemalloc</strong></li>
</ul>
<h3 data-id="heading-58">附：ptmalloc 内存分配器</h3>
<p>（glibc 标配）</p>
<h5 data-id="heading-59">设计哲学（为何不释放缓存？）</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
  A[内存分配请求] --&gt; B{是否在 arena 有空闲?}
  B --&gt;|是| C[直接返回]
  B --&gt;|否| D[向 OS 申请新内存]
  D --&gt; E[缓存到 arena]
  E --&gt; F[下次分配复用]
</code></pre>
<p><strong>核心原则</strong>：</p>
<ul>
<li><strong>减少系统调用</strong>：<code>sbrk</code>/<code>mmap</code> 是昂贵操作（1000+ CPU 周期）</li>
<li><strong>局部性优化</strong>：保留内存提高 cache 命中率</li>
<li><strong>碎片控制</strong>：避免频繁归还导致的外部碎片</li>
</ul>
<h5 data-id="heading-60">物理机环境的合理性</h5>



































<table><thead><tr><th>指标</th><th>物理机</th><th>容器</th><th>ptmalloc 适用性</th></tr></thead><tbody><tr><td><strong>内存总量</strong></td><td>32 GB</td><td>3 GB</td><td>❌ 完全不匹配</td></tr><tr><td><strong>进程数量</strong></td><td>10-20 个</td><td>100+ 个 (K8s)</td><td>❌ 严重高估</td></tr><tr><td><strong>生命周期</strong></td><td>数天~数月</td><td>分钟~小时 (Serverless)</td><td>❌ 设计错配</td></tr><tr><td><strong>内存回收价值</strong></td><td>低 (空闲内存无收益)</td><td>高 (超限即 OOMKilled)</td><td>❌ 价值观冲突</td></tr></tbody></table>
<blockquote>
<p><strong>Ulrich Drepper (glibc 作者) 2008 年观点</strong>： <em>"Returning memory to the OS is almost always a waste of time... The OS will just have to zero it out again when re-allocated."</em> （将内存归还 OS 几乎总是浪费时间... OS 在重新分配时又得清零）</p>
</blockquote>
<h5 data-id="heading-61">OOM 的真正触发条件</h5>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 伪代码：容器 OOM 触发逻辑</span>
if process.rss &gt; container.limit:  <span class="hljs-comment"># 硬限制 3GB</span>
    trigger_OOMKiller()
    
<span class="hljs-comment"># ptmalloc 的行为</span>
<span class="hljs-attr">ptmalloc.cache</span> = min(physical_ram * <span class="hljs-number">0.25</span>, <span class="hljs-number">16</span>GB)  <span class="hljs-comment"># 物理机策略</span>
<span class="hljs-comment"># 在 32 核 128GB 机器 → cache = 32GB</span>
<span class="hljs-comment"># 在 1C3G 容器 → 依然尝试 cache = 32GB → 立即 OOM</span>
</code></pre>
<h5 data-id="heading-62">为何有些服务不 OOM？</h5>






























<table><thead><tr><th>类型</th><th>内存行为特征</th><th>ptmalloc 适用性</th></tr></thead><tbody><tr><td><strong>批处理任务</strong></td><td>短生命周期 (秒级)</td><td>✅ 未积累缓存</td></tr><tr><td><strong>静态 Web 服务</strong></td><td>分配模式稳定 (固定大小)</td><td>✅ 缓存被重用</td></tr><tr><td><strong>数据库代理</strong></td><td>高频小对象 + 大对象混合</td><td>❌ 缓存碎片化</td></tr><tr><td><strong>AI 推理服务</strong></td><td>大块内存 (Tensor 分配)</td><td>✅ 走 mmap 路径</td></tr></tbody></table>
<blockquote>
<p>🌟 <strong>某云服务商 10,000 容器统计</strong>：</p>
<ul>
<li><strong>不 OOM 服务</strong>：分配速率稳定 + 对象大小均匀 (缓存重用率 &gt;80%)</li>
<li><strong>OOM 服务</strong>：分配速率波动 &gt; 10x + 混合大小分配 (碎片率 &gt;35%)</li>
</ul>
</blockquote>
<h5 data-id="heading-63">核心结论</h5>
<ol start="0">
<li>
<p><strong>ptmalloc 不是 bug，而是时代错配</strong></p>
<ul>
<li>为物理机设计的缓存策略，在容器中成为资源陷阱</li>
<li><strong>根本原因</strong>：glibc 2.34 之前完全无视 cgroups 限制（<code>ldd --version</code>）</li>
</ul>
</li>
<li>
<p><strong>OOM 与否取决于三要素</strong></p>
</li>
</ol>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
A[分配模式] --&gt; D[是否 OOM]
B[容器限制] --&gt; D
C[生命周期] --&gt; D
</code></pre>
<ul>
<li>稳定分配 + 足够内存 + 长生命周期 = 不 OOM</li>
<li>波动分配 + 严格限制 + 短生命周期 = 必然 OOM</li>
</ul>
<ol start="3">
<li><strong>解决方案优先级</strong></li>
</ol>
<p><code>jemalloc &gt; glibc 调优 &gt; JVM 控制 &gt; 代码改造</code></p>
<ul>
<li>1C3G 容器：<strong>jemalloc 是唯一 100% 有效方案</strong></li>
<li>物理机：glibc 调优足够</li>
</ul>
<blockquote>
<p>💡 <strong>终极建议</strong>： <strong>永远不要在 1C3G 容器中使用默认 ptmalloc</strong>。 某云厂商统计：<strong>92% 的容器 OOM 问题</strong> 通过 jemalloc + 精准 JVM 参数解决， 剩余 8% 需要代码层线程/对象池优化。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python 模块化 × LLM 工具调用：构建可扩展的智能问答系统]]></title>    <link>https://juejin.cn/post/7574230586971537414</link>    <guid>https://juejin.cn/post/7574230586971537414</guid>    <pubDate>2025-11-19T11:02:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574230586971537414" data-draft-id="7574281453706969094" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python 模块化 × LLM 工具调用：构建可扩展的智能问答系统"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-11-19T11:02:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="玉宇夕落"/> <meta itemprop="url" content="https://juejin.cn/user/3323164053734988"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python 模块化 × LLM 工具调用：构建可扩展的智能问答系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3323164053734988/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    玉宇夕落
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T11:02:56.000Z" title="Wed Nov 19 2025 11:02:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、环境搭建与依赖管理</h2>
<h3 data-id="heading-1">1.1 安装必要库</h3>
<pre><code class="hljs language-bash" lang="bash">bash
编辑
pip install openai requests python-dotenv  <span class="hljs-comment"># 推荐加入 dotenv 管理密钥</span>
</code></pre>
<ul>
<li><code>openai</code>：官方 SDK，兼容所有 OpenAI-like API（DeepSeek、Moonshot、Ollama 等）</li>
<li><code>requests</code>：发起 HTTP 请求（用于调用天气/股票 API）</li>
<li><code>python-dotenv</code>：从 <code>.env</code> 文件加载环境变量，避免密钥泄露</li>
</ul>
<h3 data-id="heading-2">1.2 配置 API 密钥（安全实践）</h3>
<p>创建 <code>.env</code> 文件：</p>
<pre><code class="hljs language-ini" lang="ini">env
编辑
<span class="hljs-attr">DEEPSEEK_API_KEY</span>=sk-<span class="hljs-number">3</span>d61560ac9f74daeaed1b8c53e2b7a5a
<span class="hljs-attr">SENIVERSE_KEY</span>=SeZYXHV7f3RJvQaZH
</code></pre>
<p>Python 中加载：</p>
<pre><code class="hljs language-arduino" lang="arduino">python
编辑
<span class="hljs-function">from dotenv <span class="hljs-keyword">import</span> load_dotenv
<span class="hljs-keyword">import</span> os

<span class="hljs-title">load_dotenv</span><span class="hljs-params">()</span>
api_key </span>= os.<span class="hljs-built_in">getenv</span>(<span class="hljs-string">"DEEPSEEK_API_KEY"</span>)
</code></pre>
<blockquote>
<p>✅ <strong>安全提示</strong>：永远不要将密钥提交到 Git！在 <code>.gitignore</code> 中加入 <code>.env</code>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-3">二、LLM 客户端初始化：兼容性设计</h2>
<pre><code class="hljs language-ini" lang="ini">python
编辑
from openai import OpenAI

<span class="hljs-attr">client</span> = OpenAI(
    <span class="hljs-attr">api_key</span>=os.getenv(<span class="hljs-string">"DEEPSEEK_API_KEY"</span>),
    <span class="hljs-attr">base_url</span>=<span class="hljs-string">"https://api.deepseek.com/v1"</span>
)
</code></pre>
<h3 data-id="heading-4">深度解析：</h3>
<ul>
<li><code>OpenAI</code> 类是 SDK 提供的统一入口，<strong>无论后端是 GPT、DeepSeek 还是本地 Ollama，接口一致</strong>。</li>
<li><code>base_url</code> 允许切换不同厂商的 OpenAI 兼容端点，实现“一次开发，多端部署”。</li>
<li>DeepSeek 的 <code>deepseek-reasoner</code> 模型特别支持 <code>reasoning_content</code> 字段（显示思维链），适合教学与调试。</li>
</ul>
<hr/>
<h2 data-id="heading-5">三、模块化核心：消息发送函数设计</h2>
<pre><code class="hljs language-ini" lang="ini">python
编辑
def send_message(messages, <span class="hljs-attr">tools</span>=None, model=<span class="hljs-string">"deepseek-reasoner"</span>):
    return client.chat.completions.create(
        <span class="hljs-attr">model</span>=model,
        <span class="hljs-attr">messages</span>=messages,
        <span class="hljs-attr">tools</span>=tools,
        <span class="hljs-attr">tool_choice</span>=<span class="hljs-string">"auto"</span> if tools else None,
        <span class="hljs-attr">temperature</span>=<span class="hljs-number">0.3</span>,  <span class="hljs-comment"># 降低随机性，提升工具调用稳定性</span>
        <span class="hljs-attr">max_tokens</span>=<span class="hljs-number">1000</span>
    )
</code></pre>
<h3 data-id="heading-6">关键参数详解：</h3>






























<table><thead><tr><th>参数</th><th>作用</th><th>建议值</th></tr></thead><tbody><tr><td><code>tools</code></td><td>告诉 LLM 可用的工具列表</td><td>列表 of Tool Schema</td></tr><tr><td><code>tool_choice</code></td><td>控制工具调用策略</td><td><code>"auto"</code>（自动）、<code>"none"</code>、<code>{"type": "function", "function": {"name": "xxx"}}</code>（强制调用）</td></tr><tr><td><code>temperature</code></td><td>控制输出随机性</td><td>工具调用场景建议 ≤0.5，避免胡乱调用</td></tr><tr><td><code>max_tokens</code></td><td>限制输出长度</td><td>防止无限生成</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>设计哲学</strong>：函数应只做一件事（发送请求），不包含业务逻辑，便于测试和复用。</p>
</blockquote>
<hr/>
<h2 data-id="heading-7">四、工具定义：OpenAI Tool Schema 深度解读</h2>
<pre><code class="hljs language-ini" lang="ini">python
编辑
<span class="hljs-attr">tools</span> = [
    {
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"function"</span>,
        <span class="hljs-string">"function"</span>: {
            <span class="hljs-string">"name"</span>: <span class="hljs-string">"get_weather"</span>,
            <span class="hljs-string">"description"</span>: <span class="hljs-string">"获取指定城市的当前天气，仅支持中国大陆城市"</span>,
            <span class="hljs-string">"parameters"</span>: {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
                <span class="hljs-string">"properties"</span>: {
                    <span class="hljs-string">"location"</span>: {
                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,
                        <span class="hljs-string">"description"</span>: <span class="hljs-string">"城市拼音或中文名，如'beijing'或'北京'"</span>
                    }
                },
                <span class="hljs-string">"required"</span>: [<span class="hljs-string">"location"</span>]
            }
        }
    }
]
</code></pre>
<h3 data-id="heading-8">Schema 各字段含义：</h3>
<ul>
<li><code>type</code>: 目前仅支持 <code>"function"</code>，未来可能扩展 <code>"retrieval"</code>、<code>"code_interpreter"</code> 等。</li>
<li><code>name</code>: 函数标识符，必须与本地 Python 函数名一致。</li>
<li><code>description</code>: <strong>极其重要！</strong>  LLM 依靠此描述判断何时调用该工具。应清晰、具体、带约束。</li>
<li><code>parameters</code>: 使用 <a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">JSON Schema</a> 描述输入格式，确保 LLM 生成合法参数。</li>
</ul>
<blockquote>
<p>📌 <strong>经验法则</strong>：<code>description</code> 越详细，调用准确率越高。例如加上“仅支持中国大陆城市”可避免用户问“纽约天气”时错误调用。</p>
</blockquote>
<hr/>
<h2 data-id="heading-9">五、本地函数实现：健壮性与错误处理</h2>
<pre><code class="hljs language-python" lang="python">python
编辑
<span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> json

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">location: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    url = <span class="hljs-string">"https://api.seniverse.com/v3/weather/now.json"</span>
    params = {
        <span class="hljs-string">"key"</span>: os.getenv(<span class="hljs-string">"SENIVERSE_KEY"</span>),
        <span class="hljs-string">"location"</span>: location,
        <span class="hljs-string">"language"</span>: <span class="hljs-string">"zh-Hans"</span>
    }
    
    <span class="hljs-keyword">try</span>:
        resp = requests.get(url, params=params, timeout=<span class="hljs-number">8</span>)
        resp.raise_for_status()  <span class="hljs-comment"># 抛出 HTTP 错误</span>
        
        data = resp.json()
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> data.get(<span class="hljs-string">"results"</span>):
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"未找到城市 '<span class="hljs-subst">{location}</span>' 的天气信息，请检查名称是否正确。"</span>
            
        r = data[<span class="hljs-string">"results"</span>][<span class="hljs-number">0</span>]
        city = r[<span class="hljs-string">"location"</span>][<span class="hljs-string">"name"</span>]
        now = r[<span class="hljs-string">"now"</span>]
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{city}</span>当前天气：<span class="hljs-subst">{now[<span class="hljs-string">'text'</span>]}</span>，气温 <span class="hljs-subst">{now[<span class="hljs-string">'temperature'</span>]}</span>℃"</span>
        
    <span class="hljs-keyword">except</span> requests.exceptions.Timeout:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"天气服务响应超时，请稍后再试。"</span>
    <span class="hljs-keyword">except</span> requests.exceptions.RequestException <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"网络请求失败：<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
    <span class="hljs-keyword">except</span> (KeyError, json.JSONDecodeError):
        <span class="hljs-keyword">return</span> <span class="hljs-string">"天气服务返回格式异常。"</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"未知错误：<span class="hljs-subst">{<span class="hljs-built_in">repr</span>(e)}</span>"</span>
</code></pre>
<h3 data-id="heading-10">错误处理层次：</h3>
<ol>
<li><strong>网络层</strong>：超时、DNS 失败、SSL 错误 → <code>requests.exceptions</code></li>
<li><strong>HTTP 层</strong>：404、500 → <code>resp.raise_for_status()</code></li>
<li><strong>数据层</strong>：JSON 解析失败、字段缺失 → <code>KeyError</code>, <code>JSONDecodeError</code></li>
<li><strong>兜底层</strong>：捕获所有异常，避免程序崩溃</li>
</ol>
<blockquote>
<p>✅ <strong>最佳实践</strong>：函数返回<strong>人类可读的字符串</strong>，而非原始数据或异常对象，便于 LLM 理解。</p>
</blockquote>
<hr/>
<h2 data-id="heading-11">六、完整工具调用流程：两阶段交互详解</h2>
<p>这是整个系统的核心逻辑，分为两个阶段：</p>
<h3 data-id="heading-12">阶段 1：LLM 决策是否调用工具</h3>
<pre><code class="hljs language-ini" lang="ini">python
编辑
<span class="hljs-attr">messages</span> = [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"上海明天会下雨吗？"</span>}]
<span class="hljs-attr">response</span> = send_message(messages, tools=tools)
<span class="hljs-attr">msg</span> = response.choices[<span class="hljs-number">0</span>].message
</code></pre>
<p>此时，<code>msg</code> 可能包含：</p>
<ul>
<li><code>content</code>: 一段文字（无需工具）</li>
<li><code>tool_calls</code>: 一个列表，每个元素包含 <code>id</code>, <code>function.name</code>, <code>function.arguments</code></li>
</ul>
<blockquote>
<p>🔍 <strong>内部机制</strong>：LLM 在生成过程中，若判断需要外部信息，会<strong>停止生成自然语言</strong>，转而输出一个结构化的函数调用请求（以特殊 token 标记）。</p>
</blockquote>
<h3 data-id="heading-13">阶段 2：执行工具并回传结果</h3>
<pre><code class="hljs language-ini" lang="ini">python
编辑
if msg.tool_calls:
    messages.append(msg)  <span class="hljs-comment"># 保存 LLM 的决策</span>
    
    for tool_call in msg.tool_calls:
        <span class="hljs-attr">func_name</span> = tool_call.function.name
        <span class="hljs-attr">args</span> = json.loads(tool_call.function.arguments)  <span class="hljs-comment"># 注意：arguments 是 JSON 字符串！</span>
        
        <span class="hljs-comment"># 动态调用函数（可用字典映射替代 if-else）</span>
        <span class="hljs-attr">available_functions</span> = {
            "get_weather": get_weather,
            "get_closing_price": get_closing_price
        }
        <span class="hljs-attr">func</span> = available_functions.get(func_name)
        <span class="hljs-attr">result</span> = func(**args) if func else <span class="hljs-string">"未知工具"</span>
        
        <span class="hljs-comment"># 将结果作为 'tool' 消息加入对话历史</span>
        messages.append({
            "role": "tool",
            "tool_call_id": tool_call.id,
            "name": func_name,
            "content": result
        })
    
    <span class="hljs-comment"># 阶段 3：LLM 整合结果生成最终回答</span>
    <span class="hljs-attr">final_resp</span> = send_message(messages)
    print(final_resp.choices<span class="hljs-section">[0]</span>.message.content)
</code></pre>
<h3 data-id="heading-14">关键细节：</h3>
<ul>
<li><code>tool_call_id</code>：用于关联“请求”与“响应”，确保多工具调用时不混淆。</li>
<li><code>role="tool"</code>：这是 OpenAI 协议规定的特殊角色，LLM 会识别此消息为函数返回值。</li>
<li><strong>对话历史必须完整保留</strong>：包括 system、user、assistant、tool 消息，否则 LLM 无法理解上下文。</li>
</ul>
<hr/>
<h2 data-id="heading-15">七、扩展：支持多工具与动态注册</h2>
<p>为支持未来新增工具（如查快递、翻译），可设计注册机制：</p>
<pre><code class="hljs language-ruby" lang="ruby">python
编辑
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ToolRegistry</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span></span>):
        <span class="hljs-variable language_">self</span>.functions = {}
        <span class="hljs-variable language_">self</span>.schemas = []
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">register</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span>, func, schema</span>):
        name = func.__name__
        <span class="hljs-variable language_">self</span>.functions[name] = func
        <span class="hljs-variable language_">self</span>.schemas.append(schema)
        <span class="hljs-keyword">return</span> func

registry = <span class="hljs-title class_">ToolRegistry</span>()

<span class="hljs-comment"># 注册天气工具</span>
<span class="hljs-variable">@registry</span>.register
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params"><span class="hljs-symbol">location:</span> str</span>) -&gt; <span class="hljs-symbol">str:</span>
    <span class="hljs-comment"># ... 实现同上 ...</span>

weather_schema = { <span class="hljs-regexp">/* 同上 */</span> }
registry.register(get_weather, weather_schema)

<span class="hljs-comment"># 调用时</span>
tools = registry.schemas
func = registry.functions[tool_call.function.name]
</code></pre>
<blockquote>
<p>🚀 此模式类似 Flask 的 <code>@app.route</code>，实现“声明式工具注册”。</p>
</blockquote>
<hr/>
<h2 data-id="heading-16">八、性能与安全考量</h2>
<h3 data-id="heading-17">8.1 性能优化</h3>
<ul>
<li><strong>缓存</strong>：对高频查询（如茅台股价）加内存缓存（<code>functools.lru_cache</code>）</li>
<li><strong>异步</strong>：使用 <code>httpx.AsyncClient</code> + <code>async/await</code> 提升并发能力</li>
<li><strong>限流</strong>：在函数内加计数器，防止恶意用户刷接口</li>
</ul>
<h3 data-id="heading-18">8.2 安全防护</h3>
<ul>
<li><strong>输入校验</strong>：对 <code>location</code> 做白名单或正则过滤，防止 SSRF（如 <code>location=http://internal.server</code>）</li>
<li><strong>沙箱执行</strong>：若工具涉及代码执行（如 <code>code_interpreter</code>），务必在隔离环境中运行</li>
<li><strong>日志审计</strong>：记录所有工具调用，便于追踪与分析</li>
</ul>
<hr/>
<h2 data-id="heading-19">九、调试技巧：如何排查工具调用失败？</h2>
<ol>
<li><strong>打印完整 messages</strong>：确认对话历史格式正确</li>
<li><strong>检查 arguments 是否合法 JSON</strong>：常见错误是 LLM 生成了非 JSON 字符串</li>
<li><strong>验证 function name 是否匹配</strong>：大小写敏感！</li>
<li><strong>查看模型是否支持 tool calling</strong>：并非所有模型都支持（如 <code>gpt-3.5-turbo-instruct</code> 不支持）</li>
</ol>
<p>示例调试代码：</p>
<pre><code class="hljs language-vbscript" lang="vbscript">python
编辑
pr<span class="hljs-built_in">int</span>(<span class="hljs-string">"LLM 返回:"</span>, msg)
<span class="hljs-keyword">if</span> msg.tool_calls:
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">call</span> <span class="hljs-keyword">in</span> msg.tool_calls:
        pr<span class="hljs-built_in">int</span>(<span class="hljs-string">"欲调用函数:"</span>, <span class="hljs-keyword">call</span>.<span class="hljs-keyword">function</span>.name)
        pr<span class="hljs-built_in">int</span>(<span class="hljs-string">"参数 (raw):"</span>, <span class="hljs-keyword">call</span>.<span class="hljs-keyword">function</span>.arguments)
        pr<span class="hljs-built_in">int</span>(<span class="hljs-string">"参数 (parsed):"</span>, json.loads(<span class="hljs-keyword">call</span>.<span class="hljs-keyword">function</span>.arguments))
</code></pre>
<hr/>
<h2 data-id="heading-20">十、总结与展望</h2>
<h3 data-id="heading-21">核心收获</h3>

























<table><thead><tr><th>维度</th><th>内容</th></tr></thead><tbody><tr><td><strong>架构</strong></td><td>两阶段交互（决策 → 执行 → 整合）是 Tool Use 的标准范式</td></tr><tr><td><strong>模块化</strong></td><td>分离 LLM 调用、工具定义、业务函数，提升可维护性</td></tr><tr><td><strong>健壮性</strong></td><td>全链路错误处理 + 输入校验 = 生产级系统</td></tr><tr><td><strong>扩展性</strong></td><td>通过注册机制，轻松新增工具</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[关于cesium的primitive的modelMatrix的应用]]></title>    <link>https://juejin.cn/post/7574270661872173094</link>    <guid>https://juejin.cn/post/7574270661872173094</guid>    <pubDate>2025-11-19T11:04:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574270661872173094" data-draft-id="7574204970746363950" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="关于cesium的primitive的modelMatrix的应用"/> <meta itemprop="keywords" content="cesium,JavaScript,前端"/> <meta itemprop="datePublished" content="2025-11-19T11:04:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="整点可乐"/> <meta itemprop="url" content="https://juejin.cn/user/1603526542767677"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            关于cesium的primitive的modelMatrix的应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1603526542767677/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    整点可乐
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T11:04:55.000Z" title="Wed Nov 19 2025 11:04:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在阅读这篇文章之前,建议先了解什么是<strong>仿射变换矩阵</strong></p>
<h2 data-id="heading-0">序. 仿射变换矩阵</h2>
<h3 data-id="heading-1">1、核心概念：什么是仿射变换？</h3>
<p>仿射变换是一类 “线性变换 + 平移” 的组合变换，具体包括：</p>
<ul>
<li><strong>线性变换</strong>：旋转（Rotation）、缩放（Scaling）、剪切（Shearing）；</li>
<li><strong>平移变换</strong>：将图形沿某个方向移动（Translation）。</li>
</ul>
<p>例如：把一张图片旋转 30° 后再向右移动 100 像素，就是一次仿射变换。</p>
<h3 data-id="heading-2">2、仿射变换矩阵的结构（以 3D 为例，Cesium 中最常用）</h3>
<p>在 3D 空间中，仿射变换矩阵是一个<strong>4×4 的矩阵</strong>（齐次坐标矩阵），结构如下（列优先存储，Cesium 默认格式）：</p>
<pre><code class="hljs language-arduino" lang="arduino">[
  a, d, g, j,  <span class="hljs-comment">// 第1列：X轴线性变换参数</span>
  b, e, h, k,  <span class="hljs-comment">// 第2列：Y轴线性变换参数</span>
  c, f, i, l,  <span class="hljs-comment">// 第3列：Z轴线性变换参数</span>
  <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>   <span class="hljs-comment">// 第4列：齐次坐标固定项（确保矩阵乘法合法性）</span>
]
</code></pre>
<ul>
<li>
<p><strong>前 3×3 子矩阵（a-i）</strong> ：负责线性变换（旋转、缩放、剪切）；</p>
<p>这里详细分解一下旋转和缩放:</p>
<p>缩放变换：由前 3×3 子矩阵的 “对角线元素” 控制</p>
</li>
</ul>
<pre><code class="hljs language-arduino" lang="arduino">  Sx,  <span class="hljs-number">0</span>,  <span class="hljs-number">0</span>,  <span class="hljs-comment">// X轴缩放因子（m00）</span>
   <span class="hljs-number">0</span>, Sy,  <span class="hljs-number">0</span>,  <span class="hljs-comment">// Y轴缩放因子（m05）</span>
   <span class="hljs-number">0</span>,  <span class="hljs-number">0</span>, Sz   <span class="hljs-comment">// Z轴缩放因子（m10）</span>
</code></pre>
<p>      旋转变换：由前 3×3 子矩阵的 “所有元素共同控制”（正交矩阵）</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 绕 Z 轴旋转（航向角 Heading，对应 yaw）,旋转角度为`θ`，矩阵元素：</span>
[
  cosθ, -sinθ, <span class="hljs-number">0</span>,  <span class="hljs-comment">// 第0列：m00=cosθ, m01=-sinθ, m02=0</span>
  sinθ,  cosθ, <span class="hljs-number">0</span>,  <span class="hljs-comment">// 第1列：m04=sinθ, m05=cosθ, m06=0</span>
  <span class="hljs-number">0</span>,      <span class="hljs-number">0</span>,   <span class="hljs-number">1</span>   <span class="hljs-comment">// 第2列：m08=0, m09=0, m10=1</span>
]

<span class="hljs-comment">// 绕 X 轴旋转（翻滚角 Roll）,旋转角度为`φ`，矩阵元素:</span>
[
  <span class="hljs-number">1</span>,   <span class="hljs-number">0</span>,    <span class="hljs-number">0</span>,   <span class="hljs-comment">// 第0列：m00=1, m01=0, m02=0</span>
  <span class="hljs-number">0</span>, cosφ, -sinφ, <span class="hljs-comment">// 第1列：m04=0, m05=cosφ, m06=-sinφ</span>
  <span class="hljs-number">0</span>, sinφ,  cosφ  <span class="hljs-comment">// 第2列：m08=0, m09=sinφ, m10=cosφ</span>
]

<span class="hljs-comment">// 绕 Y 轴旋转（俯仰角 Pitch）,旋转角度为`ψ`，矩阵元素：</span>
[
  cosψ, <span class="hljs-number">0</span>, sinψ,  <span class="hljs-comment">// 第0列：m00=cosψ, m01=0, m02=sinψ</span>
  <span class="hljs-number">0</span>,    <span class="hljs-number">1</span>,    <span class="hljs-number">0</span>,  <span class="hljs-comment">// 第1列：m04=0, m05=1, m06=0</span>
  -sinψ,<span class="hljs-number">0</span>, cosψ   <span class="hljs-comment">// 第2列：m08=-sinψ, m09=0, m10=cosψ</span>
]
</code></pre>
<ul>
<li>
<p><strong>第 4 列前 3 个元素（j, k, l）</strong> ：负责平移变换（X、Y、Z 方向的平移量）；</p>
</li>
<li>
<p><strong>最后一行（0,0,0,1）</strong> ：齐次坐标的 “标识行”，确保矩阵乘法能正确融合线性变换和平移。</p>
</li>
</ul>
<h3 data-id="heading-3">3、为什么用 4×4 矩阵？（齐次坐标的作用）</h3>
<p>线性变换（如旋转、缩放）可以用 3×3 矩阵表示，但<strong>平移无法用 3×3 矩阵单独实现</strong>（因为线性变换的原点映射后仍是原点，而平移会改变原点位置）。</p>
<p>通过引入 “齐次坐标”（3D 点用 4 个分量<code>(x, y, z, 1)</code>表示），4×4 矩阵可以<strong>统一处理线性变换和平移</strong>：</p>
<ul>
<li>对一个点<code>(x, y, z, 1)</code>应用仿射变换矩阵后，结果为：<code>x' = a*x + d*y + g*z + j``y' = b*x + e*y + h*z + k``z' = c*x + f*y + i*z + l</code>（同时满足线性变换和平移的组合效果）</li>
</ul>
<h3 data-id="heading-4">4、Cesium 中的仿射变换矩阵实例</h3>
<p>Cesium 中几乎所有模型 / 物体的位置和姿态调整，都依赖 4×4 仿射变换矩阵（如<code>modelMatrix</code>）：</p>
<p>a.  <strong>纯平移矩阵</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-string">``</span><span class="hljs-string">`
// 沿X轴平移10，Y轴平移20，Z轴平移30
const translateMatrix = Cesium.Matrix4.fromTranslation(new Cesium.Cartesian3(10, 20, 30));
`</span><span class="hljs-string">``</span>

矩阵结构为：

<span class="hljs-string">``</span><span class="hljs-string">`
[1,0,0,10,  
 0,1,0,20,  
 0,0,1,30,  
 0,0,0,1]
`</span><span class="hljs-string">``</span>
</code></pre>
<p>b.  <strong>旋转 + 平移矩阵</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-string">``</span><span class="hljs-string">`
// 以center为原点，应用HPR旋转，生成包含旋转和平移的仿射矩阵
const hprMatrix = Cesium.Transforms.headingPitchRollToFixedFrame(center, hpr);
`</span><span class="hljs-string">``</span>

其中前 <span class="hljs-number">3</span>×<span class="hljs-number">3</span> 子矩阵是旋转（线性变换），第 <span class="hljs-number">4</span> 列是 center 的坐标（平移）。
</code></pre>
<h3 data-id="heading-5">5、核心作用：统一组合多个变换</h3>
<p>仿射变换矩阵的最大价值是<strong>支持矩阵乘法组合多个变换</strong>。例如：先缩放→再旋转→最后平移，只需将三个变换矩阵按顺序相乘（注意顺序：从右到左应用）：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// Cesium中矩阵的乘法为右乘!即</span>
<span class="hljs-comment">//matA * matB,写作</span>
 Cesium.Matrix4.<span class="hljs-built_in">multiply</span>(matB, matA, <span class="hljs-keyword">new</span> Cesium.<span class="hljs-built_in">Matrix4</span>())
 
<span class="hljs-comment">// 缩放矩阵 → 旋转矩阵 → 平移矩阵</span>
<span class="hljs-type">const</span> temp = Cesium.Matrix4.<span class="hljs-built_in">multiply</span>(rotateMatrix, scaleMatrix)
<span class="hljs-type">const</span> finalMatrix = Cesium.Matrix4.<span class="hljs-built_in">multiply</span>(translateMatrix, temp);
</code></pre>
<h2 data-id="heading-6">一.平移</h2>
<h3 data-id="heading-7">1. 世界坐标平移(原点目标点皆为世界坐标)</h3>
<p>思路,获取向量差,将向量差转为平移矩阵</p>
<pre><code class="hljs language-ini" lang="ini">// origin 为原点坐标,target为目标坐标
const <span class="hljs-attr">sub</span> = Cesium.Cartesian3.subtract(target, origin, new Cesium.Cartesian3())
<span class="hljs-attr">primitive.modelMatrix</span> = Cesium.Matrix4.fromTranslation(sub)
</code></pre>
<h3 data-id="heading-8">2. 局部坐标平移(如模型向南平移200米)</h3>
<p>思路,计算出目标点世界坐标,获取向量差,将向量差转为平移矩阵</p>
<pre><code class="hljs language-ini" lang="ini">// origin 为原点坐标,local_translation为平移向量
const <span class="hljs-attr">originMatrix4</span> = Cesium.Transforms.eastNorthUpToFixedFrame(origin)<span class="hljs-comment">;</span>
// 平移向量的构建为:new Cesium.Cartesian3(东,北,上)
const <span class="hljs-attr">local_translation</span> = new Cesium.Cartesian3(<span class="hljs-number">300</span>, <span class="hljs-number">200</span>, <span class="hljs-number">100</span>)<span class="hljs-comment">; </span>
const <span class="hljs-attr">result</span> = new Cesium.Cartesian3(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
// 转换矩阵左乘局部平移向量，结果存储在 result 中，结果是世界坐标下的平移终点向量,即目标点的世界坐标
Cesium.Matrix4.multiplyByPoint(frompoint_to_world_matrix, local_translation, result)<span class="hljs-comment">; </span>
// 获取世界坐标平移向量
const <span class="hljs-attr">sub</span> = Cesium.Cartesian3.subtract(result, origin, new Cesium.Cartesian3())
// 应用平移
<span class="hljs-attr">primitive.modelMatrix</span> = Cesium.Matrix4.fromTranslation(sub)
</code></pre>
<h2 data-id="heading-9">二.旋转</h2>
<p>思路,因为Cesium的Primitive旋转中心为坐标系中心, 所以必须先来到坐标系中心,再做操作,最后返回原点</p>
<pre><code class="hljs language-arduino" lang="arduino">    <span class="hljs-comment">// 获取从坐标系中心到原点的位移矩阵</span>
    <span class="hljs-type">const</span> backMat = Cesium.Matrix4.<span class="hljs-built_in">fromTranslation</span>(origin)
    <span class="hljs-comment">// 将向量取反,用于获取相反的位移矩阵,用于前往坐标系中心</span>
    <span class="hljs-type">const</span> toVec = <span class="hljs-keyword">new</span> Cesium.<span class="hljs-built_in">Cartesian3</span>(-origin.x, -origin.y, -origin.z)
    <span class="hljs-type">const</span> toMat = Cesium.Matrix4.<span class="hljs-built_in">fromTranslation</span>(toVec)
    
    <span class="hljs-comment">// 获取旋转参数</span>
    <span class="hljs-type">const</span> hpr = <span class="hljs-keyword">new</span> Cesium.<span class="hljs-built_in">HeadingPitchRoll</span>(heading,pitch,roll)
    <span class="hljs-comment">// 因为目前模型在坐标系中心,第一个参数要写Cesium.Cartesian3.ZERO</span>
    <span class="hljs-type">const</span> rotateMatrix = Cesium.Transforms.<span class="hljs-built_in">headingPitchRollToFixedFrame</span>(Cesium.Cartesian3.ZERO, hpr, Cesium.Ellipsoid.WGS84)
    
    <span class="hljs-comment">// 获取完整矩阵,根据顺序应当 原点→中心→变换→原点,所以应当是 toMat * rotateMatrix * backMat</span>
    <span class="hljs-comment">// 注意Cesium矩阵相乘是右乘!!!!!!</span>
    <span class="hljs-type">const</span> temp = Cesium.Matrix4.<span class="hljs-built_in">multiply</span>(rotateMatrix, toMat, <span class="hljs-keyword">new</span> Cesium.<span class="hljs-built_in">Matrix4</span>())
    <span class="hljs-type">const</span> res = Cesium.Matrix4.<span class="hljs-built_in">multiply</span>(backMat, temp, <span class="hljs-keyword">new</span> Cesium.<span class="hljs-built_in">Matrix4</span>())
    Primitive.modelMatrix = res
</code></pre>
<h2 data-id="heading-10">三.缩放</h2>
<p>思路,依旧必须先来到坐标系中心,再做缩放,最后返回原点</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 省略来回位移的代码,rotateMatrix替换成scaleMat</span>
<span class="hljs-comment">// 获取缩放参数</span>
<span class="hljs-type">const</span> scaleVec = <span class="hljs-keyword">new</span> Cesium.<span class="hljs-built_in">Cartesian3</span>(<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>)
<span class="hljs-type">const</span> scaleMat = Cesium.Matrix4.<span class="hljs-built_in">fromScale</span>(scaleVec, <span class="hljs-keyword">new</span> Cesium.<span class="hljs-built_in">Matrix4</span>())
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Trae 帮我做了一个小插件后，我反而发现了它最该优化的 6 个地方]]></title>    <link>https://juejin.cn/post/7574245125028708371</link>    <guid>https://juejin.cn/post/7574245125028708371</guid>    <pubDate>2025-11-19T11:10:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574245125028708371" data-draft-id="7574230586971521030" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Trae 帮我做了一个小插件后，我反而发现了它最该优化的 6 个地方"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2025-11-19T11:10:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ouma_syu"/> <meta itemprop="url" content="https://juejin.cn/user/2728363512824729"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Trae 帮我做了一个小插件后，我反而发现了它最该优化的 6 个地方
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2728363512824729/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ouma_syu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T11:10:17.000Z" title="Wed Nov 19 2025 11:10:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">用 Trae 做 Hulk 插件之后，我发现了 6 个值得优化的地方</h2>
<p>用 Trae 生成一个“把网页背景变成绿色”的 Chrome 扩展并不算难。但做完之后你会发现：<strong>难的不是实现功能，而是让整个开发流程更顺滑、更易维护、更能复用到下一个项目。</strong></p>
<p>这篇文章总结lq我在用 Trae 搭建这个 Hulk 插件时，认为最值得优化的六个点。它们能显著提升你用 Trae 做扩展程序时的效率和体验。</p>
<hr/>
<h3 data-id="heading-1"><strong>1. Instruction 太“硬编码”，需要拆成更灵活的 Prompt 模板</strong></h3>
<p>我最开始的 instruction 写得非常具体：</p>
<ul>
<li>打开弹窗</li>
<li>显示某段提示文案</li>
<li>按下按钮后改为绿色</li>
<li>图标来自 icons 文件夹</li>
</ul>
<p>虽然 agent 确实照做了，但缺点也很明显：</p>
<ul>
<li><strong>复用性极低</strong>：下次做另一个插件还得重写一大段</li>
<li><strong>扩展性差</strong>：每一个变化都要手动改 instruction</li>
<li><strong>Agent 没有思考空间</strong>，只能完全按照文字执行</li>
</ul>
<p>为了让 Trae 更“聪明”，我后来把整个 instruction 拆成三类模板：</p>
<h4 data-id="heading-2">模板 1：功能需求 Prompt（只描述“做什么”）</h4>
<p>如：改变背景颜色、按钮文案、颜色参数等。</p>
<h4 data-id="heading-3">模板 2：工程结构 Prompt（描述“怎么组织文件”）</h4>
<p>如：固定扩展目录结构、manifest.json 模板、icons 规则。</p>
<h4 data-id="heading-4">模板 3：质量校验 Prompt（描述“应该检查什么”）</h4>
<p>如：检查权限、检查路径、补齐缺失字段、判断是否需要 background script。</p>
<p><strong>这样一来，重用率大幅提升。</strong><br/>
以后做各种小插件，只需要换几个参数，而不是重写整份 instruction。</p>
<hr/>
<h3 data-id="heading-5"><strong>2. 文件生成可以更智能，而不是“Agent 想怎么写就怎么写”</strong></h3>
<p>Trae 的文件生成机制本质是：</p>
<pre><code class="hljs">描述 → Agent 生成文件内容 → 写文件节点
</code></pre>
<p>但这样有几个常见问题：</p>
<ul>
<li>文件名可能会被误解</li>
<li>manifest.json 字段容易缺</li>
<li>popup.html 不会自动生成对应的 CSS、JS</li>
</ul>
<p>所以很有必要做一个“半自动 scaffold（脚手架）”流程：</p>
<h4 data-id="heading-6">建议：预置好插件基础结构模板</h4>
<pre><code class="hljs language-lua" lang="lua">/hulk-extension
|<span class="hljs-comment">-- manifest.json</span>
|<span class="hljs-comment">-- popup/</span>
|     |<span class="hljs-comment">-- popup.html</span>
|     |<span class="hljs-comment">-- popup.js</span>
|<span class="hljs-comment">-- icons/</span>
</code></pre>
<p>然后让 agent 只负责填内容，而不是猜结构。</p>
<p>再进一步完善：</p>
<ul>
<li>popup.html 自动补 script</li>
<li>按钮 id 与 JS 自动对应</li>
<li>manifest 自动补 permissions、icons 等</li>
</ul>
<p><strong>这样可以避免大量低级错误，并让 Agent 输出更稳定。</strong></p>
<hr/>
<h3 data-id="heading-7"><strong>3. 文案、颜色等参数不要写死，应该“变量化”处理</strong></h3>
<p>最初 instruction 中写的是：</p>
<ul>
<li>按钮文字固定</li>
<li>提示文字固定</li>
<li>目标颜色固定为“绿色”</li>
</ul>
<p>这种写法对一次性任务没问题，但对插件开发非常不友好。</p>
<h4 data-id="heading-8">🔧 建议：在 Trae 工作流程中加入参数化</h4>
<p>例如：</p>
<ul>
<li><code>targetColor = "#00FF00"</code></li>
<li><code>buttonLabel = "改变颜色"</code></li>
<li><code>popupTitle = "改变背景颜色"</code></li>
<li><code>htmlTip = "点击按钮将页面变成绿色"</code></li>
</ul>
<p>然后自动注入到 popup 页面中。</p>
<p>这样你就可以轻松扩展到：</p>
<ul>
<li>自定义颜色</li>
<li>多主题切换</li>
<li>用户选择颜色</li>
<li>记忆上次设置</li>
</ul>
<p>让同一个流程能覆盖更多功能。</p>
<hr/>
<h3 data-id="heading-9"><strong>4. Trae 可以自动生成 README，这一步不要忽略</strong></h3>
<p>很多 Chrome 插件最大的缺点就是 <strong>没有 README</strong>。<br/>
这会导致：</p>
<ul>
<li>自己过几天再看忘得一干二净</li>
<li>上传 GitHub 毫无可读性</li>
<li>想发布到 Chrome 商店还得重新写说明</li>
</ul>
<p>Trae 完全可以自动帮你生成这些内容：</p>
<ul>
<li>插件简介</li>
<li>使用方式</li>
<li>项目结构</li>
<li>权限说明</li>
<li>下一步扩展计划</li>
</ul>
<p><strong>省事、省心、省时间。</strong></p>
<hr/>
<h3 data-id="heading-10"><strong>5. 流程里缺少“自动调试提示”，第一次做插件的体验会很痛苦</strong></h3>
<p>Trae 可以生成代码，但它不能加载浏览器插件；<br/>
而初次做扩展的开发者最常遇到的问题是：</p>
<ul>
<li>为什么 popup 不显示？</li>
<li>为什么点击没反应？</li>
<li>为什么 manifest 报错？</li>
</ul>
<p>所以我给流程加了一段“自动调试 checklist”作为最后输出：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 打开 Chrome 扩展程序管理页面
<span class="hljs-bullet">2.</span> 启用开发者模式
<span class="hljs-bullet">3.</span> 加载已解压的扩展程序
<span class="hljs-bullet">4.</span> 检查 popup 是否正常弹出
<span class="hljs-bullet">5.</span> 控制台是否报错
<span class="hljs-bullet">6.</span> 颜色是否成功改变
</code></pre>
<p>这种“检查单”极其实用，尤其对新人友好。</p>
<hr/>
<h3 data-id="heading-11"><strong>6. icons 文件的校验很重要，但容易被忽略</strong></h3>
<p>指明“使用 icons 文件夹里的图标”并不代表 Agent 会：</p>
<ul>
<li>检查文件是否存在</li>
<li>名称是否规范</li>
<li>manifest 是否正确引用</li>
</ul>
<p>建议你让 Trae 自动确认：</p>
<pre><code class="hljs language-markdown" lang="markdown">icons/
<span class="hljs-bullet">  -</span> 16.png
<span class="hljs-bullet">  -</span> 48.png
<span class="hljs-bullet">  -</span> 128.png
</code></pre>
<p>并生成：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"icons"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"16"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"icons/16.png"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"48"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"icons/48.png"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"128"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"icons/128.png"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这可以避免 Chrome 一直报图标找不到的烦人问题。</p>
<hr/>
<h2 data-id="heading-12">这 6 个优化点能让 Trae 项目更加优秀</h2>








































<table><thead><tr><th>优化方向</th><th>为什么值得做？</th><th>能带来什么变化？</th></tr></thead><tbody><tr><td>Prompt 模块化</td><td>减少重复工作</td><td>每次做插件都能复用</td></tr><tr><td>文件生成智能化</td><td>降低结构问题</td><td>项目更“标准化”</td></tr><tr><td>参数化处理</td><td>提高扩展性</td><td>多功能插件轻松做</td></tr><tr><td>自动 README</td><td>文档不再遗漏</td><td>可发布、可维护</td></tr><tr><td>调试提示</td><td>快速排错</td><td>开发更顺滑</td></tr><tr><td>icons 校验</td><td>避免 manifest 错误</td><td>图标稳定显示</td></tr></tbody></table>
<p>Trae 的强大不在于让你少写多少代码，而在于帮你 <strong>把流程变得更自动化、更可复用、更可扩展</strong>。<br/>
只要把这些优化点做到位，你之后开发 Chrome 插件的效率会成倍提升。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[pwa实现动态start_url和scope等实现方案]]></title>    <link>https://juejin.cn/post/7574269207362453513</link>    <guid>https://juejin.cn/post/7574269207362453513</guid>    <pubDate>2025-11-19T11:47:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574269207362453513" data-draft-id="7574254039023534106" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="pwa实现动态start_url和scope等实现方案"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-19T11:47:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="1024小神"/> <meta itemprop="url" content="https://juejin.cn/user/70007368988926"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            pwa实现动态start_url和scope等实现方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/70007368988926/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    1024小神
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T11:47:38.000Z" title="Wed Nov 19 2025 11:47:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我的开源项目PakePlus可以将网页/Vue/React项目打包为桌面/手机应用并且小于5M只需几分钟，官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpakeplus.com" target="_blank" title="https://pakeplus.com" ref="nofollow noopener noreferrer">pakeplus.com</a></p><p><img alt="" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6efa95aecf914071a661c688fb776aad~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" width="1968" loading="lazy"/></p><p/>
<p>要想实现动态的start_url，比如定制不同的路径或者添加参数，就可以使用这段代码，但是！！！！！这个在safari中不生效，所以如果你是ipad设备或者ios设备是不生效的，这个是坑</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">transformManifest</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'transformManifest'</span>)
    <span class="hljs-keyword">const</span> url = <span class="hljs-string">'/manifest.webmanifest'</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'url'</span>, url)
    <span class="hljs-keyword">const</span> manifest = <span class="hljs-keyword">await</span> (<span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url)).<span class="hljs-title function_">json</span>()
    <span class="hljs-keyword">const</span> path = location.<span class="hljs-property">pathname</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">'/'</span>)
    <span class="hljs-keyword">const</span> newPath =
        path &amp;&amp; provideruuid &amp;&amp; stationeuuid
            ? <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">origin</span> +
              <span class="hljs-string">'?provideruuid='</span> +
              provideruuid +
              <span class="hljs-string">'&amp;stationeuuid='</span> +
              stationeuuid
            : <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'newPath'</span>, newPath)
    manifest.<span class="hljs-property">start_url</span> = newPath
    manifest.<span class="hljs-property">scope</span> = newPath
    manifest.<span class="hljs-property">id</span> = <span class="hljs-string">'/'</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'manifest'</span>, manifest)
    <span class="hljs-keyword">const</span> manifestString = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(manifest)
    <span class="hljs-keyword">const</span> blob = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Blob</span>([manifestString], { <span class="hljs-attr">type</span>: <span class="hljs-string">'application/json'</span> })
    <span class="hljs-keyword">const</span> manifestURL = <span class="hljs-variable constant_">URL</span>.<span class="hljs-title function_">createObjectURL</span>(blob)
    <span class="hljs-variable language_">document</span>
        .<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'[rel="manifest"]'</span>)
        ?.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'href'</span>, manifestURL)
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(manifestURL)
}</code></pre>
<p/>
大家好，我是1024小神，技术群 / 私活群 / 股票群 或 交朋友 都可以私信我。
如果你觉得本文有用，一键三连 (点赞、评论、关注)，就是对我最大的支持~</div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[pnpm 拉取github的n8n项目运行]]></title>    <link>https://juejin.cn/post/7574270661872386086</link>    <guid>https://juejin.cn/post/7574270661872386086</guid>    <pubDate>2025-11-19T12:05:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574270661872386086" data-draft-id="7574040813750370355" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="pnpm 拉取github的n8n项目运行"/> <meta itemprop="keywords" content="前端,AIGC"/> <meta itemprop="datePublished" content="2025-11-19T12:05:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="姜姜小妞"/> <meta itemprop="url" content="https://juejin.cn/user/3069492196290718"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            pnpm 拉取github的n8n项目运行
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3069492196290718/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    姜姜小妞
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T12:05:52.000Z" title="Wed Nov 19 2025 12:05:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前言：</p>
<blockquote>
<p>本文章旨在记录单纯通过pnpm拉取拉取github开源项目n8n并成功运行期间遇到的问题</p>
<p>已退坑多年，私信可能不及时回复，请谅解（已换用户名由“鬼小妞”改为“姜姜小妞”）</p>
</blockquote>
<p><code>请确保已安装git及nvm</code>，或移步
专栏文章<a href="https://juejin.cn/column/7122745024520912903" target="_blank" title="https://juejin.cn/column/7122745024520912903">前端环境搭建与准备</a>安装git及nvm后再回来</p>
<h2 data-id="heading-0">流程</h2>
<ul>
<li>1.<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fn8n-io%2Fn8n" target="_blank" title="https://github.com/n8n-io/n8n" ref="nofollow noopener noreferrer"><strong>在github上下载n8n项目</strong></a></li>
<li>2.<strong>切换或下载 <code>"node"</code>: "&gt;=22.16", <code>"pnpm"</code>: "&gt;=10.22.0"</strong></li>
<li>3.<strong>pnpm install安装依赖</strong>，（出错后清除pnpm缓存删除node_moudles依赖包后重试）</li>
<li>4.<strong>pnpm build 打包项目</strong>（打包出错大部分是依赖安装问题请重复执行步骤3）
<ul>
<li><code>必须打包成功后才可成功pnpm start运行项目</code></li>
</ul>
</li>
<li>5.<strong>pnpm start运行项目</strong>
<ul>
<li>出错请检查打包后是否有packages\cli\dist\config是否存在，5678端口是否被占用，全局安装的n8n依赖包是否正在启动（我是直接删除了npm全局安装路径的n8n，非当前项目依赖）</li>
</ul>
</li>
</ul>
<p>具体步骤如下：</p>
<h2 data-id="heading-1">1. 下载n8n</h2>
<p>我们可以根据自己喜好git clone下载或者下载zip后解压，两种方式下载后基本都是一样的，我使用的是zip方式会快一点。</p>
<h3 data-id="heading-2">方式1：通过git clone下载</h3>
<p>你可以直接通过git clone下载：</p>
<pre><code class="hljs language-js" lang="js">git clone <span class="hljs-attr">https</span>:<span class="hljs-comment">//github.com/n8n-io/n8n.git</span>
</code></pre>
<h3 data-id="heading-3">方式2：通过下载zip解压</h3>
<blockquote>
<p>为了避免由于网络等原因导致下载不完整或失败的问题，我们也可通过下载zip包解压方式进行。</p>
</blockquote>
<p>进入 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fn8n-io%2Fn8n" target="_blank" title="https://github.com/n8n-io/n8n" ref="nofollow noopener noreferrer">github.com/n8n-io/n8n</a> 下载zip</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b544be508ce04f50985155538d7beebc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=AAoHbT69xD8oFHflwx2TEkGOV9Y%3D" alt="image.png" loading="lazy"/></p>
<p>把下载好的压缩包（25M左右）解压到n8n-master（73.7M左右）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bfaa9960707245f3ada1f939df35eb6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=FNZHo7C%2FSTEoB6Ps5eWgTzlMsbc%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c798438271e34fb0845c6624aac17837~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=g0TG7KZ4bwo7mFCsAgnN85U9wss%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">2. 切换node版本并下载pnpm</h2>
<p>我们查看项目package.json文件可以看到，对于node和pnpm是需要固定版本及以上的，如下</p>
<blockquote>
<p>"node": "&gt;=22.16",</p>
<p>"pnpm": "&gt;=10.22.0"</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06d5087e6f714be384a294d4fb7bfd8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=1PwJZIRf7KxS77DD1oBr8r%2FmFXs%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-5">2.1 安装node 22.16.0</h3>
<p>由于我是使用nvm管理node版本，我是通过cmd管理员身份运行nvm下载node22.16.0</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b822db2501e74f63817236fa25e78bed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=Opi9XdyYC5OR9MAlCK8uuFYBXhA%3D" alt="image.png" loading="lazy"/></p>
<p>使用nvm依次输入命令行</p>
<pre><code class="hljs language-js" lang="js">nvm install <span class="hljs-number">22.16</span><span class="hljs-number">.0</span>
nvm use <span class="hljs-number">22.16</span><span class="hljs-number">.0</span>
nvm ls
</code></pre>
<p>关于使用nvm管理node版本不再介绍，请移步查看
专栏文章<a href="https://juejin.cn/column/7122745024520912903" target="_blank" title="https://juejin.cn/column/7122745024520912903">前端环境搭建与准备</a>---&gt; <a href="https://juejin.cn/post/7120267871950733320" target="_blank" title="https://juejin.cn/post/7120267871950733320"> <code>nvm安装与配置</code> </a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd8f9bcccdad497aa59a05cf62690878~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=5CBoNdJk3Q6tiC6ILXujWNMY7Q8%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-6">2.2 安装pnpm 10.22.0</h3>
<p>npm全局安装pnpm 10.22.0</p>
<pre><code class="hljs language-js" lang="js">npm install -g pnpm@<span class="hljs-number">10.22</span><span class="hljs-number">.0</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/071fd908bad745a3b622fd7d5f33ffc9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=Hk8oFuv6%2FMEn3C3fJfR5tgxVDUc%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-7">3. 项目运行前准备</h2>
<h3 data-id="heading-8">3.1 pnpm install安装模块依赖</h3>
<p>通过pnpm install进行项目依赖安装（默认国外的下载源需要网络非常好，网络差可能导致依赖下载失败）</p>
<pre><code class="hljs language-js" lang="js">pnpm install
</code></pre>
<p>如果觉得依赖安装太慢，你可以通过指定下载源（镜像）来安装（可能会存在源库中缺失某些依赖问题）</p>
<pre><code class="hljs language-js" lang="js">pnpm install --registry <span class="hljs-attr">https</span>:<span class="hljs-comment">//registry.npmmirror.com/</span>
</code></pre>
<p>依赖下载失败后，重新安装未成功的问题如图，<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e79ae91517e549cb82f700c90532b12f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=lsgx9CNjqy5bZKnMzEAIAySMzew%3D" alt="image.png" loading="lazy"/>
请按以下操作：</p>
<p>1.删除存储中未被任何项目使用的包版本</p>
<pre><code class="hljs">pnpm store prune
</code></pre>
<p>2.删除node_modules文件夹：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">rm</span> -rf node_modules
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9643fb85cb25489194a9f9adfd9ad173~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=Jw9kweuIrHy%2Fztuw%2F8S0emE1w4E%3D" alt="image.png" loading="lazy"/></p>
<p>必要时删除 pnpm-lock.yaml文件，建议暂时不要删除（有时候pnpm-lock.yaml中的版本与我们下载的版本不匹配，所以一般项目配置当中都忽略提交此文件）
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99742a06bbb94fc582a5113d76c3f817~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=vnX1o7PUQHA3gqRNA8axuupyssY%3D" alt="image.png" loading="lazy"/></p>
<p>3.重新执行强制安装命令</p>
<pre><code class="hljs language-js" lang="js">pnpm install --force
</code></pre>
<p>4.如果依赖重复安装失败，缺失部分依赖，只能手动一个个添加（我就是因为这个一直弄了很久），<code>如果重复因为以上问题如：“ELIFECYCLE  Command failed with exit code 1.”，请执行以上步骤1到4，非必要请勿进行步骤5操作</code>,一般有问题都是因为依赖包安装缺失问题。</p>
<p>5.如果强制安装后提示补丁<code>patchedDependencies</code>相关信息导致安装失败，如下图：</p>
<blockquote>
<p>一般到提示<code>patchedDependencies</code>字段的,那基本上，按照我在重复演示此流程的经验，就是依赖出错了，即使你在删除<code>patchedDependencies</code>字段内容后安装成功，后续依旧会在pnpm build打包环境出现问题。请你重新开始下载依赖安装，必要时请从github 下载n8n项目这个步骤重新开始。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5565b948d63e464294ef4d075997c3e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=bHsNuHS4%2BdiPWhKC8QBGZxrRW6c%3D" alt="image.png" loading="lazy"/></p>
<p>可以先删除package.json文件夹中的<code>patchedDependencies</code>字段内容，</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cbebd16c757483b94bf35de6253ba83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=hdS2KbOINoiAKpELwAcW1BWstk8%3D" alt="image.png" loading="lazy"/></p>
<p>删除补丁如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d013aeadb31443c4ad5af9842682326c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=XwoRRj2ELXb0yk1eVEXH42%2B7JRw%3D" alt="image.png" loading="lazy"/>
删除后：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b7ff73a03da45399d5af6a738e84ea4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=a9NbIZX9O5kKhhqLa76LyzVD2Ok%3D" alt="image.png" loading="lazy"/></p>
<p>在安装后记得恢复该字段内容。如果删除后重新安装依赖到pnpm build打包出现报错 <code>@n8n/imap#build</code>问题，那一定是依赖安装不成功导致的出错，一般到提示<code>patchedDependencies</code>字段的那基本上，我在重复演示此流程经验，就是依赖出错了，即使你在删除<code>patchedDependencies</code>字段内容后安装成功，后续依旧会在pnpm build打包环境出现问题。请你重新开始下载依赖安装，必要时请从github 下载n8n项目这个步骤重新开始。</p>
<h3 data-id="heading-9">3.2 pnpm build项目</h3>
<pre><code class="hljs language-js" lang="js">pnpm build
</code></pre>
<p>打包成功如下所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5da475ec9e549c79598705f507f1f73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=G1jOXwv2DBLNKf308Gixem2hsyA%3D" alt="image.png" loading="lazy"/></p>
<p><code>必须打包成功后有/dist/config目录文件才可成功pnpm start运行项目</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14b629cd977842a19450ed4bc661e475~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=HTqIfxfKEWhagZQ%2BtQR0%2BTmU5As%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79f2dc53ea3c452b929c2144f39d8e8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=BKtHXIqVk2Ym7f95eDx0s3TAuZI%3D" alt="image.png" loading="lazy"/></p>
<p>为何需要打包</p>
<p>当使用<code>pnpm start</code>命令运行项目后出现非模块的问题，如果出现 <code>Error: Cannot find module '../dist/config'</code>如下</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/155a5e373fad4c04a5fb8126a954e519~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=OOCL4zF%2BviGRfvptS8VVVR8Cr8I%3D" alt="image.png" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/092e8499953746a69ce182b922e5f1d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=OBH2ljY2NTk6%2Fa1YrMOucDwmkLQ%3D" alt="75ca7dbad29450afa0a185b57735e73f.png" loading="lazy"/>
是因为缺失打包文件（很无语的），<code>必须打包成功后才可成功pnpm start运行项目</code>
可以先进行打包产生build相关文件，再运行pnpm start</p>
<p><code>必须打包成功后才可成功pnpm start运行项目</code></p>
<p>如果遇到如下打包问题，
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e07dc958bf4418ab58dc8bd155281e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=Uy0aRuIAb5dOkKJB%2BTZj2c4SPqQ%3D" alt="image.png" loading="lazy"/></p>
<p>报错 <code>@n8n/imap#build</code>问题，请重新安装依赖，我试过很多次，重复操作都遇到这个问题，而后我重新重启，解压下载的n8n项目包重新下载依赖，删除依赖node_moudles包</p>
<h2 data-id="heading-10">4. 运行项目</h2>
<p><code>必须打包成功后有/dist/config目录文件才可成功pnpm start运行项目</code></p>
<pre><code class="hljs language-js" lang="js">pnpm start
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/344dc4f757a340488e5b980c876f9a5b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=ViHNZeV9BRwqXYGa0N%2BawcDeUoA%3D" alt="image.png" loading="lazy"/></p>
<p>打开运行端口就可以看到页面
<code>（首次进入页面需要进行登录注册）</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dfb12dc4913245c29a6ff469a49b28a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=VA%2BgSDScQ5hPR5g5VtWy83x3RLY%3D" alt="image.png" loading="lazy"/></p>
<p>如果运行项目出现如下问题<code>EntityMetadataNotFoundError: No metadata for "InstalledPackages" was found.</code>，请检查全局安装包或者n8n的默认端口占用情况，我之前全局安装过n8n，然后我删除之后，重新运行pnpm start命令就可以正常启动</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/897b6689071f4f138be184bda559a41f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=%2FWdYj6DKe7cB45NJeurEbaIdV%2FA%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af488980a1744e5f8a7247a16561d2a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=RSeanGEkj1DHYdyAhDQF8ySmVRk%3D" alt="image.png" loading="lazy"/></p>
<p>如果出现 <code>Error: Cannot find module '../dist/config'</code>如下</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/155a5e373fad4c04a5fb8126a954e519~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=OOCL4zF%2BviGRfvptS8VVVR8Cr8I%3D" alt="image.png" loading="lazy"/>
请先进行 pnpm build打包成功生成dist文件夹后再进行pnpm start启动项目，
<code>必须打包成功后有/dist/config目录文件才可成功pnpm start运行项目</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14b629cd977842a19450ed4bc661e475~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=HTqIfxfKEWhagZQ%2BtQR0%2BTmU5As%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79f2dc53ea3c452b929c2144f39d8e8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aec5aec5bCP5aae:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167650&amp;x-signature=BKtHXIqVk2Ym7f95eDx0s3TAuZI%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-11">5.流程复盘</h2>
<ul>
<li>1.<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fn8n-io%2Fn8n" target="_blank" title="https://github.com/n8n-io/n8n" ref="nofollow noopener noreferrer"><strong>在github上下载n8n项目</strong></a></li>
<li>2.<strong>切换或下载 <code>"node"</code>: "&gt;=22.16", <code>"pnpm"</code>: "&gt;=10.22.0"</strong></li>
<li>3.<strong>pnpm install安装依赖</strong>，（出错后清除pnpm缓存删除node_moudles依赖包后重试）</li>
<li>4.<strong>pnpm build 打包项目</strong>（打包出错大部分是依赖安装问题请重复执行步骤3）
<ul>
<li><code>必须打包成功后才可成功pnpm start运行项目</code></li>
</ul>
</li>
<li>5.<strong>pnpm start运行项目</strong>
<ul>
<li>出错请检查打包后是否有packages\cli\dist\config是否存在，5678端口是否被占用，全局安装的n8n依赖包是否正在启动（我是直接删除了npm全局安装路径的n8n，非当前项目依赖）</li>
</ul>
</li>
</ul>
<h2 data-id="heading-12">作者已退坑，私信评论不及时，请谅解</h2>
<p>个人认为docker部署会更简单，当然，如果你想就是单纯研究n8n源码，那么本篇文章出现的问题可以作为参考，如果你是想把n8n集成到项目中，最好的情况就是vue3作为壳引入n8n，建议是：
vue3+n8n+axios（请求）+CORS（跨域）+Pinia或Vuex（数据存储或共享）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[去噪扩散模型，根本不去噪？何恺明新论文回归「去噪」本质]]></title>    <link>https://juejin.cn/post/7574568258788573235</link>    <guid>https://juejin.cn/post/7574568258788573235</guid>    <pubDate>2025-11-20T01:49:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574568258788573235" data-draft-id="7574318108719693870" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="去噪扩散模型，根本不去噪？何恺明新论文回归「去噪」本质"/> <meta itemprop="keywords" content="算法,计算机视觉,深度学习"/> <meta itemprop="datePublished" content="2025-11-20T01:49:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            去噪扩散模型，根本不去噪？何恺明新论文回归「去噪」本质
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T01:49:27.000Z" title="Thu Nov 20 2025 01:49:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>导读</p>
<p>高质量的图像生成如今几乎都由扩散模型实现。从艺术创作到商业设计，从人脸生成到自然场景合成，基于扩散的生成模型已经成为多模态领域的重要基石。</p>
<p>但有没有一种可能，<strong>「去噪扩散模型」实际上并没有做到「去噪」？</strong></p>
<p>ResNet 之父、超70万引用的 AI 大神何恺明的新论文《Back to Basics: Let Denoising Generative Models Denoise》敏锐地捕捉了这一现象，并带领扩散模型回归其最初的本源。&gt;&gt;<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkzOTg3NTAyNA%3D%3D%26mid%3D2247488797%26idx%3D2%26sn%3D27701bde826862b6a70302fd32f752c0%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkzOTg3NTAyNA==&amp;mid=2247488797&amp;idx=2&amp;sn=27701bde826862b6a70302fd32f752c0&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">更多资讯可加入CV技术群获取了解哦</a></p>
<p>在如今的大模型时代，扩散模型（Diffusion Models）几乎统治了图像生成领域：从 Stable Diffusion、Flux 到各种 rectified flow，大多数方法都遵循一个“默认套路”——让神经网络预测 噪声（ε） 或 混合了噪声的数据（v）。</p>
<p>但 MIT 与何恺明（Kaiming He）给这一逻辑来了一个漂亮的反向质疑：</p>
<p>既然叫做“去噪模型”，为什么不真正让模型去预测“干净的图像”？</p>
<p>他们提出的答案就是——预测干净图像 x，才是扩散模型在高维空间中更自然、更有效的方式。</p>
<p>并由此带来了一个极简、却强大的新框架：</p>
<blockquote>
<p>JiT：Just image Transformers</p>
<p>不预训练、不对齐、不用 VAE、不用额外损失，只靠一个纯粹的 Vision Transformer 在像素层面做扩散。</p>
</blockquote>
<h2 data-id="heading-0"><strong>什么扩散模型这些年偏离了“去噪”？</strong></h2>
<p>传统扩散理论的核心思想很简单：</p>
<p>给图像加噪声，再学着把噪声去掉。</p>
<p>但在实践中，人们发现“预测噪声 ε”比预测干净图像 x 更容易，效果更强。</p>
<p>于是整个行业默认采用：</p>
<ul>
<li><strong>ε-prediction</strong></li>
<li><strong>v-prediction（流速度）</strong></li>
</ul>
<p>然而，这里隐藏着一个被忽视的问题——<strong>噪声不是“数据”。噪声是高维的、无结构的。</strong></p>
<p>论文从“流形假设（Manifold Assumption）”出发提出：</p>
<ul>
<li>真正的自然图像 位于一个低维流形上</li>
<li>但噪声 ε、速度 v 在整个高维空间中均匀分布</li>
</ul>
<p>也就是说：</p>
<p>预测一个“结构化”的干净图像很容易</p>
<p>预测一个“高维噪声”非常难</p>
<p>尤其在像素级扩散模型中，这个问题变得格外明显，例如：</p>
<ul>
<li>512×512 图像，一个 patch 就是 32×32×3 = 3072 维</li>
<li>ViT 的 hidden size 往往才 768、1024、1280…</li>
</ul>
<p>这意味着：</p>
<p><strong>网络根本没有能力同时编码如此高维的噪声信息。</strong></p>
<p>这就导致了：ε/v-prediction 在高维像素扩散中完全崩溃</p>
<p>而 MIT 和何恺明的实验验证了：<strong>只有 x-prediction（预测干净图像）能在高维条件下稳定工作。</strong></p>
<h2 data-id="heading-1"><strong>让模型直接预测干净图像（x-prediction）</strong></h2>
<p>研究最大的贡献是 非常“朴素”但非常革命性的一点：</p>
<p><strong>扩散模型本来应该做“去噪”，所以让它预测干净图像 x 才是自然的。</strong></p>
<p>何恺明团队指出，预测干净数据与预测带噪量在本质上是不同的。这一洞见基于机器学习中的流形假设（Manifold Assumption）。</p>
<p>流形假设认为，自然图像在高维像素空间中位于一个低维流形上。干净图像 𝒙 可以建模为处于流形上（on-manifold），而噪声 ϵ 或流速度 𝒗（例如 𝒗 = 𝒙 − ϵ）则本质上处于流形之外（off-manifold）。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad7c571afb2546f0a09eaa3ddd96948b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208167&amp;x-signature=2tQ%2F0Ah%2FXc6esskZZmLkpHJNaU8%3D" alt="screenshot_2025-11-19_13-35-17.png" loading="lazy"/></p>
<p>该图直观展示了干净图像位于低维流形上，而噪声和流速处于流形之外的本质差异</p>
<p>因此，让神经网络预测干净图像（即 𝒙-prediction）在本质上不同于让其预测噪声或带噪的量（即 ϵ/𝒗-prediction）。</p>
<p>这一差异在高维空间中尤为关键。当需要预测高维的噪声或带噪量时，网络需要足够的容量来保留所有相关信息；而预测干净图像时，即使容量有限的网络也能有效工作，因为它只需要保留低维流形上的信息。</p>
<p>他们的核心观点：</p>
<p> x 位于低维流形，Transformer 不需要建模高维噪声，只需要保留“图像结构”。</p>
<p> ε / v 是高维无结构分布，噪声包含 100% 的高维信息，网络必须“记住全部细节”，难度指数增长。</p>
<p>他们用一个很有说服力的玩具实验：</p>
<p>2 维真实数据被投影到 512 维空间，使用同一个小网络生成数据</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb377f42d51c42cba0eeadf3796c594f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208167&amp;x-signature=P8WSukSIHGsr%2FhaAkwB4Xx25CL8%3D" alt="screenshot_2025-11-19_13-48-39.png" loading="lazy"/></p>
<p>结果发现：</p>
<p><strong>x-prediction 在高维空间依然能恢复数据结构， ε 和 v-prediction 完全崩溃，这个现象和 ImageNet 像素扩散中的结果高度一致。</strong></p>
<h2 data-id="heading-2"><strong>JiT：纯粹、极简，却非常强大的像素级扩散模型</strong></h2>
<p>基于 x-prediction，作者提出了 <strong>JiT（Just image Transformers）</strong> ：</p>
<p>JiT 使用普通的 Vision Transformer，直接在高维像素块上进行 𝒙-prediction，无需任何预训练、额外的损失函数或复杂的架构设计。这种方法在 ImageNet 256×256 和 512×512 分辨率上取得了有竞争力的结果，而在相同设置下，传统的 ϵ-prediction 和 𝒗-prediction 则会灾难性地失败。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a0e4795f10a428a8bf7e2407fe44221~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208167&amp;x-signature=9ha6G5nWs9CCuR3dVZ%2FSbDy%2Fdv0%3D" alt="screenshot_2025-11-19_13-42-56.png" loading="lazy"/></p>
<p>简洁的ViT架构直接在像素块上进行𝒙-prediction，无需复杂设计</p>
<p>令人惊讶的是，研究还发现，在嵌入层引入瓶颈设计（降低维度）甚至能提高生成质量，这与经典流形学习的观察一致。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/405308a65f4842659badbe47cb5dd53d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208167&amp;x-signature=SCPCTa5dI6ZV%2BqSdGZ1DOIV9Qdg%3D" alt="screenshot_2025-11-19_13-43-52.png" loading="lazy"/></p>
<p>即使将768维的patch压缩到16维的小瓶颈，模型仍能有效工作，且适度瓶颈反而提升性能</p>
<h2 data-id="heading-3"><strong>实验验证：𝒙-prediction 的显著优势</strong></h2>
<p>为了验证这一理论，研究团队进行了系统的实验对比：</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb332fb2b89c4c508429ee50b5eb04af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208167&amp;x-signature=tNmd11JqMXOHIM%2BGcgeUUQjUktU%3D" alt="screenshot_2025-11-19_13-46-20.png" loading="lazy"/></p>
<p>在ImageNet 256×256数据集上，只有𝒙-prediction能够取得合理结果，而ϵ-prediction和𝒗-prediction都灾难性失败</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b55af76f6eb48a09fa282a704e0190e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208167&amp;x-signature=fpUhqzOi8yys6%2FhNvHMsNGcjG%2Bk%3D" alt="screenshot_2025-11-19_13-47-15.png" loading="lazy"/></p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0971e4a929ff4b6189f3cd779eb5e5f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208167&amp;x-signature=GU4ck4XfaFQttq8wOkF0KXfX8Js%3D" alt="screenshot_2025-11-19_13-47-22.png" loading="lazy"/></p>
<p>JiT在不同分辨率下都保持良好性能，显示其强大的扩展能力和计算效率</p>
<h2 data-id="heading-4"><strong>对AI开发平台的启示</strong></h2>
<p>这一研究使去噪扩散模型回归本源，探索一种在原始自然数据上构建基于 Transformer 的扩散模型的自洽范式。它不仅对计算机视觉领域有重要意义，也为其他涉及原始高维自然数据的领域（如蛋白质、分子或气象数据）提供了启示。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/911b45d10beb4b228fe652087ffacb0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208167&amp;x-signature=Qwn24aMRUbXh6npS3SMClTTbw6A%3D" alt="Coovally操作动图.gif" loading="lazy"/></p>
<p><strong>！！点击下方链接，立即体验Coovally！！</strong></p>
<p><strong>平台链接：</strong> <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.coovally.com" target="_blank" title="https://www.coovally.com" ref="nofollow noopener noreferrer">www.coovally.com</a></strong></p>
<p>在Coovally这样的AI开发平台中，这种简洁而强大的方法尤为值得关注。 Coovally致力于简化AI开发流程，让开发者能够更高效地构建和部署模型。何恺明团队的研究方向与这一理念不谋而合——通过减少领域特定的设计，使「Diffusion + Transformer」的通用范式能够在更广泛的领域中应用。</p>
<h2 data-id="heading-5"><strong>总结</strong></h2>
<p>何恺明团队的这项工作提醒我们，有时最有效的解决方案往往是最直接的。在追求复杂架构和额外组件的同时，不妨回归基础，重新思考问题的本质。</p>
<p>「噪声与自然数据本质不同」，神经网络的能力不是无限的，它们应该更好地利用自身的容量来建模数据而非噪声。在这一视角下，𝒙-prediction 的优越性在 hindsight 看来是自然而然的结果。</p>
<p>随着越来越多像Coovally这样的平台将这类先进技术封装成易用的工具，我们可以期待，高质量的图像生成技术将被更广泛地应用，赋能更多领域的创新和发展。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文解读深浅拷贝的理解和几种使用方法]]></title>    <link>https://juejin.cn/post/7574245125029036051</link>    <guid>https://juejin.cn/post/7574245125029036051</guid>    <pubDate>2025-11-19T12:39:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574245125029036051" data-draft-id="7574230586971291654" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文解读深浅拷贝的理解和几种使用方法"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-19T12:39:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeeAt"/> <meta itemprop="url" content="https://juejin.cn/user/1889440069849484"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文解读深浅拷贝的理解和几种使用方法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1889440069849484/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeeAt
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T12:39:02.000Z" title="Wed Nov 19 2025 12:39:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>深拷贝和浅拷贝是面试中经常被问到了，理解其原理和深浅拷贝差异以及多种深浅拷贝方法才能熟练在实际项目中使用做到游刃有余。本文将从作用原理到具体代码实现和多种使用方法进行展开解读。</p>
<h2 data-id="heading-0">深浅拷贝的理解</h2>
<h3 data-id="heading-1">浅拷贝</h3>
<p><strong>浅拷贝</strong>从字面意义上就是浅层的拷贝对象，不涉及到深层次的拷贝，也就是说只复制对象表层数据，只是为原来的对象创建新的内存，但是嵌套的引用类型（如：数组、子对象）仍然需要与原对象共享内存，修改副本的嵌套字段会同步影响原对象，进而产生污染。</p>
<p>其核心就是，由于JS的数据类型的存储机制，<code>基本类型</code>（字符串、数字等）直接存在<strong>栈</strong>内存中,<code>复杂类型</code>（对象、数组等）<strong>在栈中只存堆内存的地址引用，而堆内存才存实际的数据</strong>。浅拷贝时，只是复制栈内存而不对堆内存进行复制。
如图：</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24232a68d5eb4e3cb90e0b3a77467118~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVlQXQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764160742&amp;x-signature=%2BEu1l9Hkr%2B3i7pBF87RJIOP6%2Bns%3D" alt="image.png" width="50%" loading="lazy"/></p>
<p>极简代码理解就是：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 原始对象</span>
<span class="hljs-keyword">const</span> userInfo = { 
    <span class="hljs-attr">name</span>: <span class="hljs-string">"张三"</span>, <span class="hljs-comment">// 基本类型（直接存在栈内存里） </span>
    <span class="hljs-attr">address</span>: { <span class="hljs-attr">city</span>: <span class="hljs-string">"北京"</span> } <span class="hljs-comment">// 复杂数据类型（地址引用在栈，实际数据在堆） </span>
    };
<span class="hljs-comment">// 浅拷贝：创建新对象</span>
<span class="hljs-keyword">const</span> formData = { ...userInfo }; 
<span class="hljs-comment">// 1. 对比新对象本身的地址</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(userInfo === formData); <span class="hljs-comment">// false，说明地址不同，是新的内存</span>
<span class="hljs-comment">// 2. 对比嵌套address的地址</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(userInfo.<span class="hljs-property">address</span> === formData.<span class="hljs-property">address</span>); <span class="hljs-comment">// true，相同，说明内存共享，指向的是同一个地址</span>
<span class="hljs-comment">// 3. 修改嵌套字段，验证污染 </span>
formData.<span class="hljs-property">address</span>.<span class="hljs-property">city</span> = <span class="hljs-string">"上海"</span>; 
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(userInfo.<span class="hljs-property">address</span>.<span class="hljs-property">city</span>); <span class="hljs-comment">// 输出"上海"，说明原对象被污染了</span>
</code></pre>
<h3 data-id="heading-2">深拷贝</h3>
<p>理解了浅拷贝，深拷贝就是<strong>完全复制原始对象及所有的嵌套数据</strong>，会为原对象和所有嵌套的引用类型（如数组、子对象）创建独立的内存空间，副本与原对象彻底隔离，<strong>修改副本不会影响到原对象</strong>。</p>
<h2 data-id="heading-3">深浅拷贝的方法</h2>
<h3 data-id="heading-4">浅拷贝的5种常用方法</h3>
<p><strong>1. 对象展开运算符<code>{...obj}</code></strong>，最简洁的实现方式，适用于普通对象</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> shallowCopy = { ...userInfo };
</code></pre>
<p><strong>2.数组展开运算符</strong>,数组专属浅拷贝</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> shallowCopy = { ...originArr };
</code></pre>
<p><strong><code>3.Object.assign(target,source)</code></strong>,可以合并多个对象，仅浅拷贝源对象表层</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> shallowCopy = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({},userInfo1,userInfo2,userInfo3,....);
</code></pre>
<p><strong>4.数组<code>slice()</code></strong>，数组截取（不传参时等价于浅拷贝）</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> shallowCopy = originalArr.<span class="hljs-title function_">slice</span>();
</code></pre>
<p><strong>5.数组<code>concat()</code></strong>，拼接空数组实现浅拷贝</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> shallowArr = originalArr.<span class="hljs-title function_">concat</span>([]);
</code></pre>
<h3 data-id="heading-5">深拷贝的4种常用方法</h3>
<p><strong>1.JSON.parse(JSON.stringify(obj))</strong>,最常用（局限性：不支持函数、Symbol、Date、RegExp）</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> deepCopy = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(userInfo));
</code></pre>
<p><strong>2.递归遍历拷贝，</strong> 自定义实现（灵活处理所有类型，需手写逻辑），面试手写题常考</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">deepClone</span>(<span class="hljs-params">obj</span>){
    <span class="hljs-comment">// 类型判断 </span>
    <span class="hljs-keyword">if</span>(obj isntanceof <span class="hljs-title class_">Date</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(obj);
    <span class="hljs-keyword">if</span>(obj <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">RegExp</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(obj);
    <span class="hljs-keyword">if</span>(obj <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(obj.<span class="hljs-property">message</span>);
    <span class="hljs-keyword">if</span>(obj <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Function</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>){
        <span class="hljs-keyword">return</span> obj.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>,...args);
    };
    <span class="hljs-keyword">if</span>( obj === <span class="hljs-literal">null</span> || <span class="hljs-keyword">typeof</span> obj !== <span class="hljs-string">'object'</span>) <span class="hljs-keyword">return</span> obj;
    
    <span class="hljs-keyword">const</span> newObj = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(obj) ? [] : {};
    
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> obj){
        <span class="hljs-keyword">if</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">hasOwn</span>(obj,key)){
            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> obj[key] === <span class="hljs-string">"object"</span>){
                newObj[key] = <span class="hljs-title function_">deepClone</span>(obj[key]); <span class="hljs-comment">// 递归拷贝嵌套层</span>
            }
            <span class="hljs-keyword">else</span>{
                newObj[key] = obj[key]
            }
        }
         
    }
    <span class="hljs-keyword">return</span> newObj;
}
</code></pre>
<p><strong>3.第三方库，</strong> 稳定可靠（开发首选）</p>
<ul>
<li>Lodash中的 <code>_.cloneDeep(obj)</code>（支持所有类型，处理循环引用）</li>
<li>jQuery中的 <code>$.extend(true,{},obj)</code>（第一个参数为true表示深拷贝）</li>
</ul>
<p><strong>4.structuredClone()，</strong> 浏览器原生API，支持循环引用、Date/RegExp,但不支持函数</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Gird快速入门（手把手敲demo）]]></title>    <link>https://juejin.cn/post/7574271557939167283</link>    <guid>https://juejin.cn/post/7574271557939167283</guid>    <pubDate>2025-11-19T13:02:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574271557939167283" data-draft-id="7574244766424154121" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Gird快速入门（手把手敲demo）"/> <meta itemprop="keywords" content="前端,CSS"/> <meta itemprop="datePublished" content="2025-11-19T13:02:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="新晨437"/> <meta itemprop="url" content="https://juejin.cn/user/3957868231143133"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Gird快速入门（手把手敲demo）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3957868231143133/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    新晨437
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T13:02:44.000Z" title="Wed Nov 19 2025 13:02:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Gird 布局是 CSS 中目前最强大、最成熟的二维布局方案，它可以让您轻松创建复杂的网页结构。</p>
<p>这份快速入门指南将带您从零开始，快速掌握 Grid 的核心概念和用法。</p>
<h3 data-id="heading-0">1. 什么是 CSS Grid？</h3>
<p>CSS Grid Layout（网格布局）是一个二维的布局系统，意味着它可以同时处理<strong>行</strong>和<strong>列</strong>。这与 Flexbox（一维布局，主要处理行<em>或</em>列）形成鲜明对比。</p>
<p><strong>核心思想</strong>：将一个容器划分为一个个网格，你可以将子元素放置在这些网格的任意位置，甚至可以创建复杂的、不对称的布局。</p>
<hr/>
<h3 data-id="heading-1">2. 基本概念</h3>
<p>在开始之前，先了解两个核心概念：</p>
<ul>
<li><strong>Grid Container（网格容器）</strong>：应用了 <code>display: grid;</code> 的元素。它的所有<strong>直接子元素</strong>将成为 Grid Item。</li>
<li><strong>Grid Item（网格项目）</strong>：Grid Container 的<strong>直接子元素</strong>。</li>
</ul>

<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span> <span class="hljs-comment">&lt;!-- Grid Container --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span> <span class="hljs-comment">&lt;!-- Grid Item --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span> <span class="hljs-comment">&lt;!-- Grid Item --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span>3<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span> <span class="hljs-comment">&lt;!-- Grid Item --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-2">3. 快速启动：创建一个简单的网格</h3>
<p>让我们通过一个简单的例子，一步步创建一个 3x3 的网格。</p>
<h4 data-id="heading-3">步骤 1：定义网格容器</h4>
<p>首先，将一个元素的 <code>display</code> 属性设置为 <code>grid</code> 或 <code>inline-grid</code>。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">display</span>: grid;
}
</code></pre>
<p>现在，<code>.container</code> 就成为了一个网格容器，它的直接子元素自动成为了网格项目。</p>
<h4 data-id="heading-4">步骤 2：划分行和列（定义网格轨道）</h4>
<p>这是 Grid 布局的核心。我们使用 <code>grid-template-columns</code> 和 <code>grid-template-rows</code> 属性来定义网格的结构。</p>
<ul>
<li><code>grid-template-columns</code>：定义每一列的宽度。</li>
<li><code>grid-template-rows</code>：定义每一行的高度。</li>
</ul>
<p>让我们定义一个 3 列（每列 100px）和 3 行（每行 100px）的网格：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-number">100px</span> <span class="hljs-number">100px</span> <span class="hljs-number">100px</span>; <span class="hljs-comment">/* 三列，每列100px */</span>
  <span class="hljs-attribute">grid-template-rows</span>: <span class="hljs-number">100px</span> <span class="hljs-number">100px</span> <span class="hljs-number">100px</span>;    <span class="hljs-comment">/* 三行，每行100px */</span>
}
</code></pre>
<p><strong>更现代的写法：使用 <code>repeat()</code> 函数</strong>
当列或行很多时，<code>repeat()</code> 函数非常有用。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">3</span>, <span class="hljs-number">100px</span>); <span class="hljs-comment">/* 等同于 100px 100px 100px */</span>
  <span class="hljs-attribute">grid-template-rows</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">3</span>, <span class="hljs-number">100px</span>);
}
</code></pre>
<p><strong>灵活的写法：使用 <code>fr</code> 单位</strong>
<code>fr</code>（fraction）单位代表网格容器中的等分空间，它让布局变得非常灵活。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-number">1</span>fr <span class="hljs-number">2</span>fr <span class="hljs-number">1</span>fr; <span class="hljs-comment">/* 总宽度分为4份，第二列占2份，第一、三列各占1份 */</span>
  <span class="hljs-attribute">grid-template-rows</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">3</span>, <span class="hljs-number">100px</span>);
}
</code></pre>
<p><strong>混合使用：</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-number">200px</span> <span class="hljs-number">1</span>fr <span class="hljs-number">20%</span>; <span class="hljs-comment">/* 第一列固定200px，第三列是容器的20%，中间列占据剩余空间 */</span>
}
</code></pre>
<h4 data-id="heading-5">步骤 3：网格间隙（Gap）</h4>
<p>使用 <code>gap</code> 属性可以设置网格项目之间的间距。它是 <code>row-gap</code> 和 <code>column-gap</code> 的简写。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">3</span>, <span class="hljs-number">100px</span>);
  <span class="hljs-attribute">grid-template-rows</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">3</span>, <span class="hljs-number">100px</span>);
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">10px</span>; <span class="hljs-comment">/* 行和列的间隙都是10px */</span>
  <span class="hljs-comment">/* 或者分开写： */</span>
  <span class="hljs-comment">/* row-gap: 15px; */</span>
  <span class="hljs-comment">/* column-gap: 10px; */</span>
}
</code></pre>
<p>到此为止，一个标准的 3x3 网格就创建好了！你的 HTML 和 CSS 看起来应该是这样的：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-class">.container</span> {
      <span class="hljs-attribute">display</span>: grid;
      <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">3</span>, <span class="hljs-number">100px</span>);
      <span class="hljs-attribute">grid-template-rows</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">3</span>, <span class="hljs-number">100px</span>);
      <span class="hljs-attribute">gap</span>: <span class="hljs-number">10px</span>;
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f0f0f0</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>;
    }
    <span class="hljs-selector-class">.item</span> {
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#4CAF50</span>;
      <span class="hljs-attribute">color</span>: white;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
      <span class="hljs-attribute">text-align</span>: center;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span>3<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span>4<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span>5<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span>6<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span>7<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span>9<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-6">4. 高级操作：放置网格项目</h3>
<p>默认情况下，项目会按顺序逐行逐列填充网格。但 Grid 的强大之处在于你可以精确控制每个项目的位置。</p>
<p>我们通过 <strong>网格线（Grid Lines）</strong> 来定位项目。网格线是划分网格的线，从 1 开始编号（也从 -1 开始倒序编号）。</p>
<p><img alt="CSS Grid Lines转存失败，建议直接上传图片文件" src="" loading="lazy"/></p>
<p>使用以下属性来控制项目位置：</p>
<ul>
<li><code>grid-column-start</code></li>
<li><code>grid-column-end</code></li>
<li><code>grid-row-start</code></li>
<li><code>grid-row-end</code></li>
<li>简写：<code>grid-column</code> 和 <code>grid-row</code></li>
</ul>
<p><strong>示例：让第一个 item 横跨两列</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.item</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">1</span>) {
  <span class="hljs-attribute">grid-column-start</span>: <span class="hljs-number">1</span>;
  <span class="hljs-attribute">grid-column-end</span>: <span class="hljs-number">3</span>; <span class="hljs-comment">/* 从第1条纵线开始，到第3条纵线结束 */</span>
  <span class="hljs-comment">/* 简写： */</span>
  <span class="hljs-comment">/* grid-column: 1 / 3; */</span>
}
</code></pre>
<p><strong>示例：创建一个页面的经典布局</strong></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">header</span>&gt;</span>Header<span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">aside</span>&gt;</span>Sidebar<span class="hljs-tag">&lt;/<span class="hljs-name">aside</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">main</span>&gt;</span>Main Content<span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">footer</span>&gt;</span>Footer<span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-number">200px</span> <span class="hljs-number">1</span>fr; <span class="hljs-comment">/* 侧边栏固定宽度，主内容区自适应 */</span>
  <span class="hljs-attribute">grid-template-rows</span>: auto <span class="hljs-number">1</span>fr auto; <span class="hljs-comment">/* 页头和页脚高度由内容决定，主内容区占据剩余空间 */</span>
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>; <span class="hljs-comment">/* 让容器充满整个视口高度 */</span>
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">10px</span>;
}

<span class="hljs-selector-tag">header</span> {
  <span class="hljs-attribute">grid-column</span>: <span class="hljs-number">1</span> / -<span class="hljs-number">1</span>; <span class="hljs-comment">/* 从第1条纵线开始，到最后一条纵线结束（横跨所有列） */</span>
  <span class="hljs-attribute">background</span>: lightblue;
}

<span class="hljs-selector-tag">aside</span> {
  <span class="hljs-attribute">grid-column</span>: <span class="hljs-number">1</span> / <span class="hljs-number">2</span>; <span class="hljs-comment">/* 占据第一列 */</span>
  <span class="hljs-attribute">background</span>: lightcoral;
}

<span class="hljs-selector-tag">main</span> {
  <span class="hljs-attribute">grid-column</span>: <span class="hljs-number">2</span> / <span class="hljs-number">3</span>; <span class="hljs-comment">/* 占据第二列 */</span>
  <span class="hljs-attribute">background</span>: lightgreen;
}

<span class="hljs-selector-tag">footer</span> {
  <span class="hljs-attribute">grid-column</span>: <span class="hljs-number">1</span> / -<span class="hljs-number">1</span>; <span class="hljs-comment">/* 横跨所有列 */</span>
  <span class="hljs-attribute">background</span>: lightgray;
}
</code></pre>
<hr/>
<h3 data-id="heading-7">5. 快速总结与最佳实践</h3>
<ol>
<li><strong>启动</strong>：<code>display: grid;</code></li>
<li><strong>定义结构</strong>：
<ul>
<li><code>grid-template-columns</code>: 定义列。</li>
<li><code>grid-template-rows</code>: 定义行。</li>
<li>善用 <code>repeat()</code> 和 <code>fr</code> 单位。</li>
</ul>
</li>
<li><strong>设置间距</strong>：<code>gap</code>。</li>
<li><strong>精细控制项目</strong>：使用 <code>grid-column</code> 和 <code>grid-row</code> 基于<strong>网格线</strong>进行定位。</li>
<li><strong>命名网格线</strong>：对于复杂布局，可以给网格线起名字，让代码更易读。
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">grid-template-columns</span>: [sidebar-start] <span class="hljs-number">200px</span> [sidebar-end content-start] <span class="hljs-number">1</span>fr [content-end];
}
<span class="hljs-selector-tag">header</span> {
  <span class="hljs-attribute">grid-column</span>: sidebar-start / content-end;
}
</code></pre>
</li>
</ol>
<h3 data-id="heading-8">练习建议</h3>
<p>打开浏览器的开发者工具，在 <code>Elements</code> 或 <code>Inspector</code> 面板中，找到你的网格容器，旁边会有一个 <code>grid</code> 的标签，点击它可以在页面上可视化你的网格结构。这是学习和调试 Grid 的绝佳方式！</p>
<p>Grid 布局功能非常丰富，还包括<strong>网格区域（grid-template-areas）</strong>、对齐属性（<code>justify-items</code>, <code>align-content</code>等），但掌握了以上核心内容，你已经可以应对 90% 的布局需求了。快去动手试试吧！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3 响应式系统源码解析：Map/Set Collection 响应式核心实现]]></title>    <link>https://juejin.cn/post/7574338918489784346</link>    <guid>https://juejin.cn/post/7574338918489784346</guid>    <pubDate>2025-11-20T01:52:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574338918489784346" data-draft-id="7574568258788606003" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3 响应式系统源码解析：Map/Set Collection 响应式核心实现"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-20T01:52:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="excel"/> <meta itemprop="url" content="https://juejin.cn/user/2911162520062862"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3 响应式系统源码解析：Map/Set Collection 响应式核心实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2911162520062862/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    excel
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T01:52:53.000Z" title="Thu Nov 20 2025 01:52:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文解析 Vue3 <code>reactivity</code> 模块中 Collection(Map/Set/WeakMap/WeakSet) 的响应式处理逻辑，重点在设计思路与源码结构，而不是 API 使用。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">1. 背景：为什么 Map/Set 要单独写代码？</h2>
<p>Vue 对普通对象 <code>{}</code> 的响应式靠 <code>get/set</code> 即可，但对 Map/Set：</p>
<ul>
<li><strong>方法是函数</strong>（如 <code>.set()</code>、<code>.get()</code>）</li>
<li><strong>键可能是对象</strong></li>
<li><strong>有迭代器</strong>（<code>keys</code>、<code>values</code>、<code>entries</code>、<code>for…of</code>）</li>
<li><strong>弱集合 WeakMap/WeakSet 无法遍历</strong></li>
</ul>
<p>因此，Vue 必须提供一套专门的“仪表方法”（instrumentations）来接管所有操作。</p>
<p>这一段源码就是专门为此而设计的。</p>
<hr/>
<h2 data-id="heading-1">2. createIterableMethod —— 迭代器逻辑封装</h2>
<h4 data-id="heading-2">代码片段</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createIterableMethod</span>(<span class="hljs-params">method, isReadonly, isShallow</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">const</span> target = <span class="hljs-variable language_">this</span>[<span class="hljs-title class_">ReactiveFlags</span>.<span class="hljs-property">RAW</span>]
    <span class="hljs-keyword">const</span> rawTarget = <span class="hljs-title function_">toRaw</span>(target)
    <span class="hljs-keyword">const</span> targetIsMap = <span class="hljs-title function_">isMap</span>(rawTarget)
    <span class="hljs-keyword">const</span> isPair = method === <span class="hljs-string">'entries'</span> || (method === <span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span> &amp;&amp; targetIsMap)
    <span class="hljs-keyword">const</span> isKeyOnly = method === <span class="hljs-string">'keys'</span> &amp;&amp; targetIsMap

    <span class="hljs-keyword">const</span> innerIterator = target[method](...args)
    <span class="hljs-keyword">const</span> wrap = isShallow ? toShallow : isReadonly ? toReadonly : toReactive

    !isReadonly &amp;&amp; <span class="hljs-title function_">track</span>(
      rawTarget,
      <span class="hljs-title class_">TrackOpTypes</span>.<span class="hljs-property">ITERATE</span>,
      isKeyOnly ? <span class="hljs-variable constant_">MAP_KEY_ITERATE_KEY</span> : <span class="hljs-variable constant_">ITERATE_KEY</span>,
    )

    <span class="hljs-keyword">return</span> {
      <span class="hljs-title function_">next</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> { value, done } = innerIterator.<span class="hljs-title function_">next</span>()
        <span class="hljs-keyword">return</span> done
          ? { value, done }
          : { <span class="hljs-attr">value</span>: isPair ? [<span class="hljs-title function_">wrap</span>(value[<span class="hljs-number">0</span>]), <span class="hljs-title function_">wrap</span>(value[<span class="hljs-number">1</span>])] : <span class="hljs-title function_">wrap</span>(value), done }
      },
      [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>]() {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>
      },
    }
  }
}
</code></pre>
<hr/>
<h4 data-id="heading-3">逐段解释：</h4>
<h5 data-id="heading-4"><strong>① 获取原始对象</strong></h5>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">target</span> = this[ReactiveFlags.RAW]
const <span class="hljs-attr">rawTarget</span> = toRaw(target)
</code></pre>
<p>Map 可能是嵌套 reactive 包装，这里确保拿到真正的原对象。</p>
<h5 data-id="heading-5"><strong>② 判断返回值是 key/value/key+value</strong></h5>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">isPair</span> = method === <span class="hljs-string">'entries'</span> ...
const <span class="hljs-attr">isKeyOnly</span> = method === <span class="hljs-string">'keys'</span>
</code></pre>
<h5 data-id="heading-6"><strong>③ 执行原生迭代器</strong></h5>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">innerIterator</span> = target[method](...args)
</code></pre>
<h5 data-id="heading-7"><strong>④ 依赖收集</strong></h5>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">track</span>(rawTarget, TrackOpTypes.ITERATE, ITERATE_KEY)
</code></pre>
<p><strong>关键点</strong>：只要调用 keys、values、entries、for-of，都要追踪依赖。</p>
<p>这样当集合结构变化时才能触发更新。</p>
<h5 data-id="heading-8"><strong>⑤ 迭代器包装：将每个值转成 reactive</strong></h5>
<pre><code class="hljs language-css" lang="css">value: <span class="hljs-built_in">wrap</span>(...)
</code></pre>
<p>Map 中存的值可能是对象，Vue 自动转换成 reactive 或 readonly。</p>
<p>这一部分是最核心的“响应式迭代器”实现。</p>
<hr/>
<h2 data-id="heading-9">3. createReadonlyMethod —— 用于 readonly 集合</h2>
<h4 data-id="heading-10">代码片段</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createReadonlyMethod</span>(<span class="hljs-params"><span class="hljs-keyword">type</span></span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
    <span class="hljs-title function_">warn</span>(<span class="hljs-string">`<span class="hljs-subst">${capitalize(<span class="hljs-keyword">type</span>)}</span> operation failed: target is readonly.`</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">type</span> === <span class="hljs-title class_">TriggerOpTypes</span>.<span class="hljs-property">DELETE</span>
      ? <span class="hljs-literal">false</span>
      : <span class="hljs-keyword">type</span> === <span class="hljs-title class_">TriggerOpTypes</span>.<span class="hljs-property">CLEAR</span> ? <span class="hljs-literal">undefined</span> : <span class="hljs-variable language_">this</span>
  }
}
</code></pre>
<h4 data-id="heading-11">思路：</h4>
<ul>
<li>任何修改（set/add/delete/clear）都会提示错误</li>
<li>并返回合理的 fallback 值</li>
</ul>
<p>举例：</p>
<ul>
<li><code>delete()</code> → <code>false</code></li>
<li><code>clear()</code> → <code>undefined</code></li>
<li><code>set/add</code> → 返回 this（保持链式调用）</li>
</ul>
<hr/>
<h2 data-id="heading-12">4. createInstrumentations —— 生成 Map/Set 全量代理方法</h2>
<p>它会根据参数 <code>readonly</code> 和 <code>shallow</code> 返回不同版本的方法表。</p>
<hr/>
<h3 data-id="heading-13">（1）get(key)</h3>
<h4 data-id="heading-14">代码片段</h4>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">get</span>(<span class="hljs-keyword">key</span>) {
  <span class="hljs-keyword">const</span> target = this[ReactiveFlags.RAW]
  <span class="hljs-keyword">const</span> rawTarget = toRaw(target)
  <span class="hljs-keyword">const</span> rawKey = toRaw(<span class="hljs-keyword">key</span>)

  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">readonly</span>) {
    <span class="hljs-keyword">if</span> (hasChanged(<span class="hljs-keyword">key</span>, rawKey)) track(rawTarget, TrackOpTypes.<span class="hljs-keyword">GET</span>, <span class="hljs-keyword">key</span>)
    track(rawTarget, TrackOpTypes.<span class="hljs-keyword">GET</span>, rawKey)
  }

  <span class="hljs-keyword">const</span> { has } = getProto(rawTarget)

  <span class="hljs-keyword">const</span> wrap = shallow ? toShallow : <span class="hljs-keyword">readonly</span> ? toReadonly : toReactive

  <span class="hljs-keyword">if</span> (has.<span class="hljs-keyword">call</span>(rawTarget, <span class="hljs-keyword">key</span>)) {
    <span class="hljs-keyword">return</span> wrap(target.<span class="hljs-keyword">get</span>(<span class="hljs-keyword">key</span>))
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (has.<span class="hljs-keyword">call</span>(rawTarget, rawKey)) {
    <span class="hljs-keyword">return</span> wrap(target.<span class="hljs-keyword">get</span>(rawKey))
  }
}
</code></pre>
<h4 data-id="heading-15">关键细节：</h4>
<h5 data-id="heading-16"><strong>① key 和 rawKey 都要 track</strong></h5>
<p>原因：用户可能用 reactive(obj) 或 raw obj 作为 map key。</p>
<h5 data-id="heading-17"><strong>② 始终 wrap 返回值</strong></h5>
<p>所有 get 到的 value 必须返回 reactive/readonly 版本。</p>
<hr/>
<h3 data-id="heading-18">（2）size 属性</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">get</span> <span class="hljs-title">size</span>()</span> {
  <span class="hljs-keyword">const</span> target = <span class="hljs-keyword">this</span>[ReactiveFlags.RAW]
  !<span class="hljs-keyword">readonly</span> &amp;&amp; track(toRaw(target), TrackOpTypes.ITERATE, ITERATE_KEY)
  <span class="hljs-keyword">return</span> target.size
}
</code></pre>
<p><strong>size 依赖整个集合结构</strong>，所以也要使用 ITERATE 依赖类型。</p>
<hr/>
<h3 data-id="heading-19">（3）has(key)</h3>
<p>逻辑和 get 类似，也要对 key 与 rawKey 都进行 track。</p>
<hr/>
<h3 data-id="heading-20">（4）forEach</h3>
<p>Vue 为回调参数做响应式包装：</p>
<pre><code class="hljs language-scss" lang="scss">callback<span class="hljs-selector-class">.call</span>(thisArg, wrap(value), <span class="hljs-built_in">wrap</span>(key), observed)
</code></pre>
<p>确保：</p>
<ul>
<li>value 是 reactive</li>
<li>key 是 reactive</li>
<li>this 是 reactive</li>
</ul>
<hr/>
<h2 data-id="heading-21">5. Mutation（增删改清）操作</h2>
<p>如果不是 readonly，则提供真正的 set/add/delete/clear。</p>
<hr/>
<h3 data-id="heading-22">（1）add (for Set)</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">add</span>(value) {
  value = <span class="hljs-built_in">toRaw</span>(value)
  const hadKey = target<span class="hljs-selector-class">.has</span>(value)
  if (!hadKey) {
    target<span class="hljs-selector-class">.add</span>(value)
    <span class="hljs-built_in">trigger</span>(target, TriggerOpTypes.ADD, value, value)
  }
  return this
}
</code></pre>
<hr/>
<h3 data-id="heading-23">（2）set (for Map)</h3>
<h4 data-id="heading-24">核心逻辑</h4>
<ul>
<li>把 value 转 raw</li>
<li>判断 key 是否存在</li>
<li>触发 ADD 或 SET</li>
</ul>
<hr/>
<h3 data-id="heading-25">（3）delete</h3>
<p>触发 DELETE 类型依赖，并将旧值传递给 watcher。</p>
<hr/>
<h3 data-id="heading-26">（4）clear</h3>
<p>触发 CLEAR，且如果是 Map 会克隆 oldTarget（仅 dev）。</p>
<hr/>
<h2 data-id="heading-27">6. iterator 方法统一挂载</h2>
<pre><code class="hljs language-sql" lang="sql">[<span class="hljs-string">'keys'</span>,<span class="hljs-string">'values'</span>,<span class="hljs-string">'entries'</span>,Symbol.iterator].forEach(<span class="hljs-keyword">method</span> <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> {
  instrumentations[<span class="hljs-keyword">method</span>] <span class="hljs-operator">=</span> createIterableMethod(<span class="hljs-keyword">method</span>, readonly, shallow)
})
</code></pre>
<p>这是响应式迭代器的核心。</p>
<hr/>
<h2 data-id="heading-28">7. createInstrumentationGetter —— Proxy.get 捕获器</h2>
<p>它定义了所有 Collection 的代理行为。</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">get</span>(target, <span class="hljs-keyword">key</span>, receiver) {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">key</span> === ReactiveFlags.IS_REACTIVE) <span class="hljs-keyword">return</span> !isReadonly
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">key</span> === ReactiveFlags.IS_READONLY) <span class="hljs-keyword">return</span> isReadonly
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">key</span> === ReactiveFlags.RAW) <span class="hljs-keyword">return</span> target

  <span class="hljs-keyword">return</span> Reflect.<span class="hljs-keyword">get</span>(
    hasOwn(instrumentations, <span class="hljs-keyword">key</span>) &amp;&amp; <span class="hljs-keyword">key</span> <span class="hljs-keyword">in</span> target
      ? instrumentations
      : target,
    <span class="hljs-keyword">key</span>,
    receiver,
  )
}
</code></pre>
<h4 data-id="heading-29">逻辑：</h4>
<ol>
<li>读标识位（isReactive/isReadonly/raw）</li>
<li>如果有对应的 instrumentations 方法，则从那里取</li>
<li>否则取集合原本的方法</li>
</ol>
<hr/>
<h2 data-id="heading-30">8. 最终导出的四种 handler</h2>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">export</span> <span class="hljs-type">const</span> mutableCollectionHandlers
<span class="hljs-keyword">export</span> <span class="hljs-type">const</span> shallowCollectionHandlers
<span class="hljs-keyword">export</span> <span class="hljs-type">const</span> readonlyCollectionHandlers
<span class="hljs-keyword">export</span> <span class="hljs-type">const</span> shallowReadonlyCollectionHandlers
</code></pre>
<p>Vue 会根据：</p>
<ul>
<li>reactive()</li>
<li>shallowReactive()</li>
<li>readonly()</li>
<li>shallowReadonly()</li>
</ul>
<p>来使用不同的 handler。</p>
<hr/>
<h2 data-id="heading-31">总结</h2>
<p>这段源码是 Vue3 响应式系统中最复杂的一部分之一，核心设计理念包括：</p>
<ul>
<li><strong>以 instrumentations 表包装所有 Collection 方法</strong></li>
<li><strong>迭代器统一代理，确保 for-of / keys / values 都能被追踪</strong></li>
<li><strong>返回值自动 wrap 成 reactive 或 readonly</strong></li>
<li><strong>同时支持 raw key 与 reactive key 的一致性检查</strong></li>
<li><strong>对不同模式（shallow / readonly）进行统一抽象</strong></li>
</ul>
<p>它是 Vue 能优雅支持 Map/Set 响应式的关键。</p>
<hr/>
<p><strong>本文部分内容借助 AI 辅助生成，并由作者整理审核。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[飞书多维表格用户不要错过！重大福利🎁~]]></title>    <link>https://juejin.cn/post/7574529034647257140</link>    <guid>https://juejin.cn/post/7574529034647257140</guid>    <pubDate>2025-11-20T01:52:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574529034647257140" data-draft-id="7574327911659618304" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="飞书多维表格用户不要错过！重大福利🎁~"/> <meta itemprop="keywords" content="前端,程序员,产品"/> <meta itemprop="datePublished" content="2025-11-20T01:52:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱听书的程序员阿超"/> <meta itemprop="url" content="https://juejin.cn/user/3905881963247111"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            飞书多维表格用户不要错过！重大福利🎁~
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3905881963247111/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱听书的程序员阿超
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T01:52:45.000Z" title="Thu Nov 20 2025 01:52:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99b152fb4341494e8f4de14352f5c9f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCs5Lmm55qE56iL5bqP5ZGY6Zi_6LaF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208365&amp;x-signature=YVRMIGA6Eu9b22fbtkb0n%2Bp%2BMiE%3D" alt="image.png" loading="lazy"/>
阿超作为每天都在用飞书多维表格的重度用户，并且给多维表格开发了 20 多个好用的插件，也收到了很多的插件用户好评~</p>
<p>最近，阿超帮大家争取到了一些飞书多维表格VIP的福利🎉，真的很香~</p>
<p>新用户可以领3个月会员，原价买得花一百多，而且现在不用下软件，网页就能用，微信钉钉也能用，超级方便。</p>
<p>兑换码：New9L2m7F3z8K77</p>
<p>兑换链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Ffcna6swh3rtl.feishu.cn%2Fshare%2Fbase%2Fform%2Fshrcn8BkxqoKYeA6XyZZAB7zK73" target="_blank" title="https://fcna6swh3rtl.feishu.cn/share/base/form/shrcn8BkxqoKYeA6XyZZAB7zK73" ref="nofollow noopener noreferrer">fcna6swh3rtl.feishu.cn/share/base/…</a></p>
<p>尽快兑换，双十一活动很快就结束了，兑换完得等几天到账。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41c49254502548df9f27bc43cc0f072f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCs5Lmm55qE56iL5bqP5ZGY6Zi_6LaF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208365&amp;x-signature=M01VbNfAS75HMFxzxYQpGkRzN3A%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端开发者也能玩转大模型：使用HTTP请求调用DeepSeek全记录]]></title>    <link>https://juejin.cn/post/7574253222607568937</link>    <guid>https://juejin.cn/post/7574253222607568937</guid>    <pubDate>2025-11-19T15:27:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574253222607568937" data-draft-id="7574281453707591686" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端开发者也能玩转大模型：使用HTTP请求调用DeepSeek全记录"/> <meta itemprop="keywords" content="前端,人工智能,DeepSeek"/> <meta itemprop="datePublished" content="2025-11-19T15:27:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ohyeah"/> <meta itemprop="url" content="https://juejin.cn/user/740446536480618"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端开发者也能玩转大模型：使用HTTP请求调用DeepSeek全记录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/740446536480618/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ohyeah
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T15:27:31.000Z" title="Wed Nov 19 2025 15:27:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>无需后端支持，纯前端技术栈也能集成人工智能大模型</p>
</blockquote>
<p>作为一名前端开发者，我最近探索了一个有趣的技术方案：如何在前端项目中直接调用大型语言模型。在这个过程中，我发现了不少值得分享的经验和技巧，今天就带大家一步步实现前端调用DeepSeek大模型的全过程。</p>
<h2 data-id="heading-0">项目背景与初衷</h2>
<p>传统上，调用AI大模型通常需要后端服务的支持，前端通过API与自己的服务器交互，再由服务器调用AI服务。这样做主要是出于安全考虑，特别是为了保护API密钥。但有时候，我们只是想快速原型验证，或者构建简单的个人项目，这时候如果能直接从前端调用大模型，会大大简化开发流程。</p>
<p>我决定尝试使用纯前端技术栈调用DeepSeek大模型，并记录下整个过程。</p>
<h2 data-id="heading-1">项目初始化：从零搭建</h2>
<p>为了简化开发流程，我使用了 Trae（一种 AI 辅助开发工具）帮我快速初始化了一个基于 Vite 的前端项目。V</p>
<h3 data-id="heading-2">选择构建工具</h3>
<p>我选择了Vite作为项目构建工具，它不仅速度快，而且内置了丰富的功能，特别是对环境变量的支持，这对保护API密钥至关重要。</p>
<pre><code class="hljs language-bash" lang="bash">npm create vite@latest frontend-llm-demo
<span class="hljs-built_in">cd</span> frontend-llm-demo
npm install
</code></pre>
<h3 data-id="heading-3">项目结构设计</h3>
<p>保持简洁的项目结构：</p>
<pre><code class="hljs language-lua" lang="lua">frontend-llm-demo/
├── index.html
├── styles/
│   └── style.css
├── scripts/
│   └── app.js
└── .env.<span class="hljs-keyword">local</span>
</code></pre>
<p>其中，<code>index.html</code> 是主页面，<code>app.js</code> 负责发起 API 请求，而 <code>.env.local</code> 将用于存放敏感的 API Key。</p>
<h2 data-id="heading-4">核心实现：HTTP请求调用LLM</h2>
<h3 data-id="heading-5">构建API请求</h3>
<p>在<code>app.js</code>中，我实现了完整的API调用逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// DeepSeek API端点</span>
<span class="hljs-keyword">const</span> endpoint = <span class="hljs-string">'https://api.deepseek.com/chat/completions'</span>

<span class="hljs-comment">// 设置请求头</span>
<span class="hljs-keyword">const</span> headers = {
  <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
  <span class="hljs-string">'Authorization'</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${<span class="hljs-keyword">import</span>.meta.env.VITE_DEEPSEEK_API_KEY}</span>`</span>
}

<span class="hljs-comment">// 构建请求体</span>
<span class="hljs-keyword">const</span> payload = {
  <span class="hljs-attr">model</span>: <span class="hljs-string">'deepseek-chat'</span>,
  <span class="hljs-attr">messages</span>: [
    {
      <span class="hljs-attr">role</span>: <span class="hljs-string">'system'</span>,
      <span class="hljs-attr">content</span>: <span class="hljs-string">'You are a helpful assistant.'</span>
    },
    {
      <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>,
      <span class="hljs-attr">content</span>: <span class="hljs-string">'你好 DeepSeek'</span>
    }
  ]
}

<span class="hljs-comment">// 发送请求并处理响应</span>
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(endpoint, {
  <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
  <span class="hljs-attr">headers</span>: headers,
  <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(payload)
})

<span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data)

<span class="hljs-comment">// 将模型回复动态挂载到页面</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'reply'</span>).<span class="hljs-property">textContent</span> = data.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>].<span class="hljs-property">message</span>.<span class="hljs-property">content</span>
</code></pre>
<h3 data-id="heading-6">关键技术点解析</h3>
<h4 data-id="heading-7">1. 请求方法选择</h4>
<p>我使用了POST而非GET方法，原因有二：</p>
<ul>
<li>POST请求更安全，参数不会暴露在URL中</li>
<li>我们需要传递请求体，GET请求通常不包含请求体 而 LLM 调用需要传递复杂的 <code>messages</code> 结构，必须使用 POST</li>
</ul>
<h4 data-id="heading-8">2. 请求头设置</h4>
<p>请求头包含了两个关键信息：</p>
<ul>
<li><code>Content-Type: application/json</code> - 告诉服务器我们发送的是JSON格式数据</li>
<li><code>Authorization: Bearer ...</code> - 用于身份验证的API密钥</li>
</ul>
<h4 data-id="heading-9">3. 请求体构建</h4>
<p>请求体是一个JSON对象，包含：</p>
<ul>
<li><code>model</code> - 指定要使用的模型版本</li>
<li><code>messages</code> - 对话消息数组，包含角色和内容</li>
</ul>
<h4 data-id="heading-10">4. 数据序列化</h4>
<p>使用<code>JSON.stringify()</code>将JavaScript对象转换为JSON字符串，因为HTTP协议只能传输文本或二进制数据，不能直接传输对象。</p>
<h2 data-id="heading-11">安全考虑：保护API密钥</h2>
<h3 data-id="heading-12">环境变量的重要性</h3>
<p>直接将API密钥硬编码在前端代码中是极其危险的，任何用户都可以查看源代码获取密钥。为了解决这个问题，我使用了环境变量。</p>
<h3 data-id="heading-13">Vite环境变量配置</h3>
<p>Vite使用特殊的<code>import.meta.env</code>对象来访问环境变量。以<code>VITE_</code>开头的变量会被嵌入到客户端代码中。</p>
<ol>
<li>创建<code>.env</code>文件：</li>
</ol>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">VITE_DEEPSEEK_API_KEY</span>=your_api_key_here
</code></pre>
<ol start="2">
<li>在代码中访问：</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> apiKey = <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_DEEPSEEK_API_KEY</span>
</code></pre>
<p><strong>注意</strong>：即使使用环境变量，前端代码中的API密钥仍然可能被有心人获取。对于生产环境，最佳实践仍然是使用后端服务作为代理。</p>
<h2 data-id="heading-14">异步处理：从Promise到async/await</h2>
<h3 data-id="heading-15">传统的Promise链式调用</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">fetch</span>(endpoint, options)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.<span class="hljs-title function_">json</span>())
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
    <span class="hljs-comment">// 处理数据</span>
  })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-comment">// 错误处理</span>
  })
</code></pre>
<h3 data-id="heading-16">现代的async/await</h3>
<p>我选择了async/await语法，因为它更简洁、更易读：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(endpoint, options)
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()
  <span class="hljs-comment">// 处理数据</span>
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-comment">// 错误处理</span>
}
</code></pre>
<h2 data-id="heading-17">结果展示：动态更新DOM</h2>
<p>获取到API响应后，需要将结果显示在页面上：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'reply'</span>).<span class="hljs-property">textContent</span> = data.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>].<span class="hljs-property">message</span>.<span class="hljs-property">content</span>
</code></pre>
<p>这里使用了直接操作DOM的方式，在现代前端框架流行的今天，这种原生方法依然简单有效。</p>
<h2 data-id="heading-18">完整HTML结构</h2>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!doctype <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"color-scheme"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"light dark"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>前端调用大模型示例<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"styles/style.css"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello DeepSeek<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"reply"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./scripts/app.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h2 data-id="heading-19">开发心得与总结</h2>
<p>通过这个项目，我获得了以下几点经验：</p>
<h3 data-id="heading-20">1. 前端调用LLM的可行性</h3>
<p>事实证明，前端直接调用大模型API是完全可行的，这为快速原型开发和个人项目提供了便利。但需要注意安全性问题，不建议在生产环境中直接暴露API密钥。</p>
<h3 data-id="heading-21">2. HTTP请求的细节重要性</h3>
<p>调用外部API时，请求的每个部分都很重要：</p>
<ul>
<li>正确的端点URL</li>
<li>恰当的HTTP方法</li>
<li>必要的请求头</li>
<li>正确格式化的请求体</li>
</ul>
<h3 data-id="heading-22">3. 现代JavaScript特性的价值</h3>
<p>ES6+的特性让代码更加简洁：</p>
<ul>
<li>模板字符串</li>
<li>箭头函数</li>
<li>解构赋值</li>
<li>async/await</li>
</ul>
<h3 data-id="heading-23">4. 构建工具的重要性</h3>
<p>Vite等现代构建工具不仅提供开发服务器和打包功能，还解决了环境变量、模块化等工程化问题。</p>
<h3 data-id="heading-24">5. 安全意识的培养</h3>
<p>即使是在个人项目中，也应该养成良好的安全习惯，使用环境变量管理敏感信息。</p>
<h2 data-id="heading-25">结语</h2>
<p>前端技术日新月异，如今我们甚至可以直接在前端调用强大的人工智能模型。这个项目虽然简单，但展示了前端开发的强大能力和无限可能性。作为前端开发者，我们不应该将自己局限在传统的界面开发中，而应该积极探索前端技术的边界。</p>
<p>希望这篇文章能为想要在前端项目中集成AI能力的开发者提供一些参考和启发。前端的世界很精彩，让我们一起探索更多可能性！</p>
<hr/>
<p><em>注意：本文示例仅适用于开发和测试环境，生产环境中请务必通过后端服务调用第三方API，确保API密钥的安全性。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2.Kotlin 函数：函数进阶：可变参数 (vararg) 与局部函数]]></title>    <link>https://juejin.cn/post/7574276404595884084</link>    <guid>https://juejin.cn/post/7574276404595884084</guid>    <pubDate>2025-11-19T10:38:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574276404595884084" data-draft-id="7574250031248654370" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2.Kotlin 函数：函数进阶：可变参数 (vararg) 与局部函数"/> <meta itemprop="keywords" content="Android,Kotlin,Android Jetpack"/> <meta itemprop="datePublished" content="2025-11-19T10:38:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Android_小雨"/> <meta itemprop="url" content="https://juejin.cn/user/220360279590862"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2.Kotlin 函数：函数进阶：可变参数 (vararg) 与局部函数
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/220360279590862/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Android_小雨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T10:38:21.000Z" title="Wed Nov 19 2025 10:38:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>希望帮你在Kotlin进阶路上少走弯路，在技术上稳步提升。当然，由于个人知识储备有限，笔记中难免存在疏漏或表述不当的地方，也非常欢迎大家提出宝贵意见，一起交流进步。 —— Android_小雨</p>
</blockquote>
<p>整体目录：<a href="https://juejin.cn/spost/7573592952242602036" target="_blank" title="https://juejin.cn/spost/7573592952242602036">Kotlin 进阶不迷路：41 个核心知识点，构建完整知识体系</a></p>
<h2 data-id="heading-0">一、前言</h2>
<h3 data-id="heading-1">1.1 函数进阶的核心意义</h3>
<p>在 Kotlin 开发中，基础函数语法能满足简单场景的需求，但面对“需要处理不确定数量的参数”“函数内部有重复逻辑”等复杂场景时，就需要借助进阶函数特性来优化代码。函数进阶的核心价值在于<strong>提升代码的灵活性、复用性和可读性</strong>——既让函数能适配更多样的调用场景，又能通过合理封装减少冗余代码，让逻辑更清晰。</p>
<p>比如我们经常会遇到“计算多个数字的和”“批量打印数据”这类需求，若用基础函数只能一次次传递固定数量的参数；还有函数内部多次执行相同的校验逻辑，直接重复编写会让代码显得臃肿。而今天要讲的<strong>可变参数（vararg）<strong>和</strong>局部函数</strong>，正是解决这两类问题的“利器”。</p>
<h3 data-id="heading-2">1.2 本文核心内容预告（可变参数 + 局部函数）</h3>
<p>本文将聚焦 Kotlin 中两个高频进阶函数特性：可变参数（vararg）和局部函数。我们会从“是什么、怎么用、注意什么、在哪用”四个维度，逐步拆解每个特性的核心知识点，最后再通过结合示例展示它们的协同优势。无论你是刚接触 Kotlin 的新手，还是想优化现有代码的开发者，都能通过本文快速掌握这两个特性的实战技巧。</p>
<h2 data-id="heading-3">二、可变参数 (vararg) 详解</h2>
<h3 data-id="heading-4">2.1 什么是可变参数？（简单定义：接收任意数量同类型参数）</h3>
<p>可变参数（vararg，全称 variable number of arguments）是 Kotlin 提供的一种特殊参数类型，它允许函数<strong>接收任意数量的同类型参数</strong>。简单来说，就是调用函数时可以传递 1 个、2 个……甚至 0 个该类型的参数，函数内部会将这些参数封装成一个数组来处理。</p>
<p>比如定义一个“求和函数”，如果用基础函数只能固定参数数量（如 sum(a: Int, b: Int) 只能求两个数的和），而用可变参数就能实现“求任意个整数的和”，适配“求 2 个数、3 个数甚至 10 个数的和”等所有场景。</p>
<h3 data-id="heading-5">2.2 可变参数的基本用法（语法格式 + 基础示例）</h3>
<h4 data-id="heading-6">2.2.1 语法格式</h4>
<p>定义可变参数只需在参数类型前加上 <code>vararg</code> 关键字，格式如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> 函数名<span class="hljs-params">(<span class="hljs-keyword">vararg</span> 参数名: 参数类型)</span></span>: 返回类型 {
    <span class="hljs-comment">// 函数体中，参数名可直接当作数组使用（如参数名.size、参数名[0]）</span>
}

</code></pre>
<h4 data-id="heading-7">2.2.2 基础示例</h4>
<p>以“求任意个整数的和”为例，用可变参数实现如下，调用时可传递任意数量的整数：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 可变参数基础示例：求任意个整数的和
 * <span class="hljs-doctag">@param</span> numbers 可变参数，接收任意数量的 Int 类型参数
 * <span class="hljs-doctag">@return</span> 所有参数的和
 */</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">sumNumbers</span><span class="hljs-params">(<span class="hljs-keyword">vararg</span> numbers: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-keyword">var</span> total = <span class="hljs-number">0</span>
    <span class="hljs-comment">// 可变参数在函数内部会被当作数组处理，可通过循环遍历</span>
    <span class="hljs-keyword">for</span> (num <span class="hljs-keyword">in</span> numbers) {
        total += num
    }
    <span class="hljs-keyword">return</span> total
}

<span class="hljs-comment">// 调用示例</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 1. 传递 2 个参数</span>
    <span class="hljs-keyword">val</span> sum2 = sumNumbers(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>)
    println(<span class="hljs-string">"两个数的和：<span class="hljs-variable">$sum2</span>"</span>) <span class="hljs-comment">// 输出：两个数的和：30</span>

    <span class="hljs-comment">// 2. 传递 5 个参数</span>
    <span class="hljs-keyword">val</span> sum5 = sumNumbers(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)
    println(<span class="hljs-string">"五个数的和：<span class="hljs-variable">$sum5</span>"</span>) <span class="hljs-comment">// 输出：五个数的和：15</span>

    <span class="hljs-comment">// 3. 传递 0 个参数（返回默认值 0）</span>
    <span class="hljs-keyword">val</span> sum0 = sumNumbers()
    println(<span class="hljs-string">"零个数的和：<span class="hljs-variable">$sum0</span>"</span>) <span class="hljs-comment">// 输出：零个数的和：0</span>
}

</code></pre>
<p>从示例可以看出，可变参数让函数的调用场景变得极度灵活，无需为不同数量的参数定义多个重载函数。</p>
<h3 data-id="heading-8">2.3 可变参数的关键注意点（位置要求、与数组的配合）</h3>
<h4 data-id="heading-9">2.3.1 参数位置要求：可变参数最好放在最后</h4>
<p>Kotlin 中一个函数只能有一个可变参数，且为了避免调用时参数解析混乱，<strong>可变参数建议放在参数列表的最后一位</strong>。如果可变参数前面有其他参数，调用时需要通过“命名参数”明确区分，否则会编译报错。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 错误示例：可变参数放在非最后位置，调用时易混淆</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">printInfo</span><span class="hljs-params">(<span class="hljs-keyword">vararg</span> names: <span class="hljs-type">String</span>, prefix: <span class="hljs-type">String</span>)</span></span>: <span class="hljs-built_in">Unit</span> {
    <span class="hljs-keyword">for</span> (name <span class="hljs-keyword">in</span> names) {
        println(<span class="hljs-string">"<span class="hljs-variable">$prefix</span>：<span class="hljs-variable">$name</span>"</span>)
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 直接调用会编译报错：无法区分哪个是 prefix，哪个是 names 的参数</span>
    <span class="hljs-comment">// printInfo("张三", "李四", "前缀")</span>

    <span class="hljs-comment">// 必须用命名参数指定 prefix，才能正确调用（不推荐这种定义方式）</span>
    printInfo(<span class="hljs-string">"张三"</span>, <span class="hljs-string">"李四"</span>, prefix = <span class="hljs-string">"姓名"</span>)
}

<span class="hljs-comment">// 正确示例：可变参数放在最后一位</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">printInfo</span><span class="hljs-params">(prefix: <span class="hljs-type">String</span>, <span class="hljs-keyword">vararg</span> names: <span class="hljs-type">String</span>)</span></span>: <span class="hljs-built_in">Unit</span> {
    <span class="hljs-keyword">for</span> (name <span class="hljs-keyword">in</span> names) {
        println(<span class="hljs-string">"<span class="hljs-variable">$prefix</span>：<span class="hljs-variable">$name</span>"</span>)
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 直接按顺序调用，无需命名参数，清晰简洁</span>
    printInfo(<span class="hljs-string">"姓名"</span>, <span class="hljs-string">"张三"</span>, <span class="hljs-string">"李四"</span>, <span class="hljs-string">"王五"</span>)
    <span class="hljs-comment">// 输出：</span>
    <span class="hljs-comment">// 姓名：张三</span>
    <span class="hljs-comment">// 姓名：李四</span>
    <span class="hljs-comment">// 姓名：王五</span>
}

</code></pre>
<h4 data-id="heading-10">2.3.2 与数组的配合：用 spread 运算符（*）传递数组</h4>
<p>如果我们有一个现成的数组，想将数组中的所有元素作为可变参数传递给函数，不能直接传递数组（会被当作一个参数处理），需要在数组前加上 <code>*</code> 运算符（称为 spread 运算符，即“展开运算符”），它会将数组中的元素逐个展开为可变参数。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">sumNumbers</span><span class="hljs-params">(<span class="hljs-keyword">vararg</span> numbers: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-keyword">return</span> numbers.sum() <span class="hljs-comment">// 数组的 sum() 方法，直接求总和</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 定义一个数组</span>
    <span class="hljs-keyword">val</span> numArray = intArrayOf(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span>, <span class="hljs-number">40</span>)

    <span class="hljs-comment">// 错误示例：直接传递数组，会被当作一个参数（数组类型），编译报错</span>
    <span class="hljs-comment">// val sum = sumNumbers(numArray)</span>

    <span class="hljs-comment">// 正确示例：用 * 运算符展开数组</span>
    <span class="hljs-keyword">val</span> sum = sumNumbers(*numArray)
    println(<span class="hljs-string">"数组元素的和：<span class="hljs-variable">$sum</span>"</span>) <span class="hljs-comment">// 输出：数组元素的和：100</span>
}

</code></pre>
<p>注意：spread 运算符只能用于数组，不能用于 List 等集合；如果是 List，需要先通过 <code>toIntArray()</code> 等方法转为数组再展开。</p>
<h3 data-id="heading-11">2.4 实用场景举例（如：求和、打印多个数据）</h3>
<h4 data-id="heading-12">2.4.1 场景 1：批量处理数据（求和、求平均值）</h4>
<p>可变参数最常用的场景就是“批量处理同类型数据”，比如计算多个数字的平均值、找出最大值等。下面以“求多个浮点数的平均值”为例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 求多个浮点数的平均值
 * <span class="hljs-doctag">@param</span> nums 可变参数，接收任意数量的 Float 类型数据
 * <span class="hljs-doctag">@return</span> 平均值（若没有参数返回 0.0）
 */</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">calculateAverage</span><span class="hljs-params">(<span class="hljs-keyword">vararg</span> nums: <span class="hljs-type">Float</span>)</span></span>: <span class="hljs-built_in">Float</span> {
    <span class="hljs-keyword">if</span> (nums.isEmpty()) <span class="hljs-keyword">return</span> <span class="hljs-number">0.0f</span>
    <span class="hljs-comment">// 计算总和：nums.sum() 是数组的扩展函数</span>
    <span class="hljs-keyword">val</span> total = nums.sum()
    <span class="hljs-comment">// 平均值 = 总和 / 元素个数</span>
    <span class="hljs-keyword">return</span> total / nums.size
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> avg1 = calculateAverage(<span class="hljs-number">85.5f</span>, <span class="hljs-number">92.0f</span>, <span class="hljs-number">78.5f</span>, <span class="hljs-number">90.0f</span>)
    println(<span class="hljs-string">"4个成绩的平均值：<span class="hljs-variable">$avg1</span>"</span>) <span class="hljs-comment">// 输出：4个成绩的平均值：86.5</span>

    <span class="hljs-keyword">val</span> avg2 = calculateAverage(<span class="hljs-number">95.0f</span>, <span class="hljs-number">88.0f</span>)
    println(<span class="hljs-string">"2个成绩的平均值：<span class="hljs-variable">$avg2</span>"</span>) <span class="hljs-comment">// 输出：2个成绩的平均值：91.5</span>
}

</code></pre>
<h4 data-id="heading-13">2.4.2 场景 2：批量打印数据（带统一前缀）</h4>
<p>开发中经常需要“批量打印一组数据”，比如打印用户列表、日志列表等，用可变参数可以轻松实现“传递任意个数据，统一添加前缀后打印”：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 批量打印数据，带统一前缀
 * <span class="hljs-doctag">@param</span> prefix 每个数据的前缀
 * <span class="hljs-doctag">@param</span> data 可变参数，接收任意数量的 String 类型数据
 */</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">batchPrint</span><span class="hljs-params">(prefix: <span class="hljs-type">String</span>, <span class="hljs-keyword">vararg</span> <span class="hljs-keyword">data</span>: <span class="hljs-type">String</span>)</span></span> {
    println(<span class="hljs-string">"=== 批量打印开始 ==="</span>)
    <span class="hljs-keyword">data</span>.forEachIndexed { index, item -&gt;
        <span class="hljs-comment">// 索引从 1 开始，格式：前缀 + 序号 + 数据</span>
        println(<span class="hljs-string">"<span class="hljs-variable">$prefix</span> <span class="hljs-subst">${index + <span class="hljs-number">1</span>}</span>：<span class="hljs-variable">$item</span>"</span>)
    }
    println(<span class="hljs-string">"=== 批量打印结束 ==="</span>)
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 打印用户列表</span>
    batchPrint(<span class="hljs-string">"用户"</span>, <span class="hljs-string">"张三"</span>, <span class="hljs-string">"李四"</span>, <span class="hljs-string">"王五"</span>, <span class="hljs-string">"赵六"</span>)
    <span class="hljs-comment">// 打印日志列表</span>
    batchPrint(<span class="hljs-string">"日志"</span>, <span class="hljs-string">"系统启动成功"</span>, <span class="hljs-string">"用户登录"</span>, <span class="hljs-string">"数据同步完成"</span>)
}

</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-comment">=== 批量打印开始 ===</span>
用户 1：张三
用户 2：李四
用户 3：王五
用户 4：赵六
<span class="hljs-comment">=== 批量打印结束 ===</span>
<span class="hljs-comment">=== 批量打印开始 ===</span>
日志 1：系统启动成功
日志 2：用户登录
日志 3：数据同步完成
<span class="hljs-comment">=== 批量打印结束 ===</span>

</code></pre>
<h2 data-id="heading-14">三、局部函数 详解</h2>
<h3 data-id="heading-15">3.1 什么是局部函数？（函数内部定义的函数）</h3>
<p>局部函数（Local Function）是指在<strong>另一个函数内部定义的函数</strong>，它只在外部函数的作用域内有效，外部函数之外无法调用。简单来说，就是“函数里套函数”，局部函数专门为外部函数服务，用于封装外部函数内部的重复逻辑。</p>
<p>比如一个“用户注册”函数，内部需要多次校验“用户名不为空”“密码长度不小于 6 位”这些逻辑，如果直接重复编写校验代码会很冗余，这时就可以把校验逻辑封装成局部函数，在外部函数内部重复调用。</p>
<h3 data-id="heading-16">3.2 局部函数的基本用法（语法格式 + 基础示例）</h3>
<h4 data-id="heading-17">3.2.1 语法格式</h4>
<p>局部函数的定义语法和普通函数一致，只是位置在另一个函数的内部：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> 外部函数名<span class="hljs-params">(外部参数: 类型)</span></span>: 返回类型 {
    <span class="hljs-comment">// 外部函数的变量</span>
    <span class="hljs-keyword">val</span> 变量名 = 初始值

    <span class="hljs-comment">// 定义局部函数（仅在外部函数内部可见）</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> 局部函数名<span class="hljs-params">(局部参数: 类型)</span></span>: 返回类型 {
        <span class="hljs-comment">// 局部函数体：可访问外部函数的变量和参数</span>
    }

    <span class="hljs-comment">// 外部函数体：调用局部函数</span>
    <span class="hljs-keyword">val</span> 结果 = 局部函数名(参数值)
    <span class="hljs-keyword">return</span> 结果
}

</code></pre>
<h4 data-id="heading-18">3.2.2 基础示例</h4>
<p>以“用户注册”为例，将“校验用户名”和“校验密码”的逻辑封装成局部函数，实现代码如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 外部函数：用户注册
 * <span class="hljs-doctag">@param</span> username 用户名
 * <span class="hljs-doctag">@param</span> password 密码
 * <span class="hljs-doctag">@return</span> 注册结果（成功/失败原因）
 */</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">userRegister</span><span class="hljs-params">(username: <span class="hljs-type">String</span>, password: <span class="hljs-type">String</span>)</span></span>: String {
    <span class="hljs-comment">// 局部函数1：校验用户名（仅在 userRegister 内部可用）</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkUsername</span><span class="hljs-params">()</span></span>: String? {
        <span class="hljs-comment">// 可直接访问外部函数的参数 username</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> {
            username.isEmpty() -&gt; <span class="hljs-string">"用户名不能为空"</span>
            username.length &lt; <span class="hljs-number">3</span> -&gt; <span class="hljs-string">"用户名长度不能小于3位"</span>
            <span class="hljs-keyword">else</span> -&gt; <span class="hljs-literal">null</span> <span class="hljs-comment">// 校验通过，返回 null</span>
        }
    }

    <span class="hljs-comment">// 局部函数2：校验密码（仅在 userRegister 内部可用）</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkPassword</span><span class="hljs-params">()</span></span>: String? {
        <span class="hljs-comment">// 可直接访问外部函数的参数 password</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> {
            password.isEmpty() -&gt; <span class="hljs-string">"密码不能为空"</span>
            password.length &lt; <span class="hljs-number">6</span> -&gt; <span class="hljs-string">"密码长度不能小于6位"</span>
            !password.any { it.isDigit() } -&gt; <span class="hljs-string">"密码必须包含数字"</span>
            <span class="hljs-keyword">else</span> -&gt; <span class="hljs-literal">null</span> <span class="hljs-comment">// 校验通过，返回 null</span>
        }
    }

    <span class="hljs-comment">// 外部函数逻辑：调用局部函数进行校验</span>
    <span class="hljs-keyword">val</span> usernameError = checkUsername()
    <span class="hljs-keyword">if</span> (usernameError != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"注册失败：<span class="hljs-variable">$usernameError</span>"</span>
    }

    <span class="hljs-keyword">val</span> passwordError = checkPassword()
    <span class="hljs-keyword">if</span> (passwordError != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"注册失败：<span class="hljs-variable">$passwordError</span>"</span>
    }

    <span class="hljs-comment">// 校验通过，返回成功信息</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"注册成功！用户名：<span class="hljs-variable">$username</span>"</span>
}

<span class="hljs-comment">// 调用外部函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    println(userRegister(<span class="hljs-string">"zhangsan"</span>, <span class="hljs-string">"123456"</span>)) <span class="hljs-comment">// 输出：注册成功！用户名：zhangsan</span>
    println(userRegister(<span class="hljs-string">"zh"</span>, <span class="hljs-string">"123456"</span>)) <span class="hljs-comment">// 输出：注册失败：用户名长度不能小于3位</span>
    println(userRegister(<span class="hljs-string">"lisi"</span>, <span class="hljs-string">"12345"</span>)) <span class="hljs-comment">// 输出：注册失败：密码长度不能小于6位</span>
    println(userRegister(<span class="hljs-string">"wangwu"</span>, <span class="hljs-string">"abcdef"</span>)) <span class="hljs-comment">// 输出：注册失败：密码必须包含数字</span>
}

</code></pre>
<p>从示例可以看出，局部函数将外部函数的冗余逻辑抽离出来，让外部函数的主逻辑（注册流程）更清晰，同时局部函数可直接访问外部函数的参数，无需额外传递。</p>
<h3 data-id="heading-19">3.3 局部函数的核心特性（访问外部函数变量、封装复用）</h3>
<h4 data-id="heading-20">3.3.1 特性 1：可直接访问外部函数的变量和参数</h4>
<p>局部函数的最大特性之一是“作用域嵌套”——它可以直接访问外部函数的参数、局部变量，甚至修改外部函数的可变变量（如 var 修饰的变量）。这种特性让局部函数无需通过参数传递就能获取外部数据，简化了调用逻辑。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 外部函数：计算多个数字的平方和
 * <span class="hljs-doctag">@param</span> numbers 可变参数，接收多个整数
 * <span class="hljs-doctag">@return</span> 所有数字的平方和
 */</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">squareSum</span><span class="hljs-params">(<span class="hljs-keyword">vararg</span> numbers: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-keyword">var</span> total = <span class="hljs-number">0</span> <span class="hljs-comment">// 外部函数的可变变量</span>

    <span class="hljs-comment">// 局部函数：计算单个数字的平方，并累加到 total</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addSquare</span><span class="hljs-params">(num: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-comment">// 直接访问并修改外部函数的变量 total</span>
        total += num * num
    }

    <span class="hljs-comment">// 遍历所有数字，调用局部函数累加</span>
    numbers.forEach { addSquare(it) }
    <span class="hljs-keyword">return</span> total
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> sum1 = squareSum(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)
    println(<span class="hljs-string">"1²+2²+3² = <span class="hljs-variable">$sum1</span>"</span>) <span class="hljs-comment">// 输出：1²+2²+3² = 14</span>

    <span class="hljs-keyword">val</span> sum2 = squareSum(<span class="hljs-number">4</span>, <span class="hljs-number">5</span>)
    println(<span class="hljs-string">"4²+5² = <span class="hljs-variable">$sum2</span>"</span>) <span class="hljs-comment">// 输出：4²+5² = 41</span>
}

</code></pre>
<p>示例中，局部函数 <code>addSquare</code> 直接修改了外部函数的 <code>total</code> 变量，避免了通过返回值传递中间结果，逻辑更简洁。</p>
<h4 data-id="heading-21">3.3.2 特性 2：封装复用，隐藏内部逻辑</h4>
<p>局部函数仅在外部函数内部可见，外部无法调用，这种“隐藏性”让它非常适合封装外部函数的内部辅助逻辑——既实现了重复逻辑的复用，又不会污染外部作用域（避免定义不必要的顶层函数）。</p>
<p>比如前面的用户注册示例，校验逻辑只在注册函数中用到，封装成局部函数后，不会在其他地方被误调用，保证了代码的“高内聚”。</p>
<h3 data-id="heading-22">3.4 实用场景举例（如：校验逻辑封装、重复逻辑提取）</h3>
<h4 data-id="heading-23">3.4.1 场景 1：表单校验逻辑封装</h4>
<p>表单提交是开发中最常见的场景之一，如登录、注册、信息修改等，这类场景通常需要校验多个字段，且校验逻辑只针对当前表单。用局部函数封装校验逻辑，能让表单处理函数的主逻辑更清晰。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 外部函数：处理登录表单提交
 * <span class="hljs-doctag">@param</span> username 用户名
 * <span class="hljs-doctag">@param</span> password 密码
 * <span class="hljs-doctag">@param</span> verifyCode 验证码
 * <span class="hljs-doctag">@return</span> 提交结果
 */</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loginSubmit</span><span class="hljs-params">(username: <span class="hljs-type">String</span>, password: <span class="hljs-type">String</span>, verifyCode: <span class="hljs-type">String</span>)</span></span>: String {
    <span class="hljs-comment">// 局部函数：统一的非空校验逻辑</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkNotEmpty</span><span class="hljs-params">(value: <span class="hljs-type">String</span>, fieldName: <span class="hljs-type">String</span>)</span></span>: String? {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (value.isEmpty()) <span class="hljs-string">"<span class="hljs-variable">$fieldName</span>不能为空"</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span>
    }

    <span class="hljs-comment">// 局部函数：验证码校验逻辑</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkVerifyCode</span><span class="hljs-params">()</span></span>: String? {
        <span class="hljs-keyword">val</span> correctCode = <span class="hljs-string">"123456"</span> <span class="hljs-comment">// 实际开发中从缓存获取</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (verifyCode != correctCode) <span class="hljs-string">"验证码错误"</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span>
    }

    <span class="hljs-comment">// 1. 调用局部函数校验各字段</span>
    <span class="hljs-keyword">val</span> usernameError = checkNotEmpty(username, <span class="hljs-string">"用户名"</span>)
    <span class="hljs-keyword">if</span> (usernameError != <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"登录失败：<span class="hljs-variable">$usernameError</span>"</span>

    <span class="hljs-keyword">val</span> passwordError = checkNotEmpty(password, <span class="hljs-string">"密码"</span>)
    <span class="hljs-keyword">if</span> (passwordError != <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"登录失败：<span class="hljs-variable">$passwordError</span>"</span>

    <span class="hljs-keyword">val</span> codeError = checkVerifyCode()
    <span class="hljs-keyword">if</span> (codeError != <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"登录失败：<span class="hljs-variable">$codeError</span>"</span>

    <span class="hljs-comment">// 2. 校验通过，执行登录逻辑（模拟）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"登录成功！欢迎 <span class="hljs-variable">$username</span>"</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    println(loginSubmit(<span class="hljs-string">"zhangsan"</span>, <span class="hljs-string">"123456"</span>, <span class="hljs-string">"123456"</span>)) <span class="hljs-comment">// 登录成功</span>
    println(loginSubmit(<span class="hljs-string">""</span>, <span class="hljs-string">"123456"</span>, <span class="hljs-string">"123456"</span>)) <span class="hljs-comment">// 登录失败：用户名不能为空</span>
    println(loginSubmit(<span class="hljs-string">"lisi"</span>, <span class="hljs-string">"123456"</span>, <span class="hljs-string">"654321"</span>)) <span class="hljs-comment">// 登录失败：验证码错误</span>
}

</code></pre>
<h4 data-id="heading-24">3.4.2 场景 2：函数内部重复逻辑提取</h4>
<p>如果一个函数内部有多次重复执行的代码片段（比如重复的计算、打印逻辑），将其提取为局部函数，能大幅减少代码冗余。下面以“生成指定格式的日志”为例，日志前缀需要重复拼接，用局部函数优化：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 外部函数：模拟数据处理，并打印不同阶段的日志
 * <span class="hljs-doctag">@param</span> data 待处理的数据
 */</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">processData</span><span class="hljs-params">(<span class="hljs-keyword">data</span>: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-comment">// 局部函数：生成带时间戳的日志前缀（重复逻辑提取）</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getLogPrefix</span><span class="hljs-params">(phase: <span class="hljs-type">String</span>)</span></span>: String {
        <span class="hljs-keyword">val</span> time = System.currentTimeMillis() <span class="hljs-comment">// 获取当前时间戳</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"[<span class="hljs-variable">$time</span>] [<span class="hljs-subst">${phase}</span>]"</span>
    }

    <span class="hljs-comment">// 阶段1：数据接收</span>
    println(<span class="hljs-string">"<span class="hljs-subst">${getLogPrefix(<span class="hljs-string">"接收数据"</span>)}</span> 数据已接收：<span class="hljs-variable">$data</span>"</span>)
    <span class="hljs-comment">// 模拟处理延迟</span>
    Thread.sleep(<span class="hljs-number">100</span>)

    <span class="hljs-comment">// 阶段2：数据解析</span>
    <span class="hljs-keyword">val</span> parsedData = <span class="hljs-keyword">data</span>.uppercase() <span class="hljs-comment">// 模拟解析：转为大写</span>
    println(<span class="hljs-string">"<span class="hljs-subst">${getLogPrefix(<span class="hljs-string">"解析数据"</span>)}</span> 数据解析完成：<span class="hljs-variable">$parsedData</span>"</span>)
    Thread.sleep(<span class="hljs-number">100</span>)

    <span class="hljs-comment">// 阶段3：数据存储</span>
    println(<span class="hljs-string">"<span class="hljs-subst">${getLogPrefix(<span class="hljs-string">"存储数据"</span>)}</span> 数据存储成功"</span>)
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    processData(<span class="hljs-string">"kotlin-vararg-local-function"</span>)
}

</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[1731678900123]</span> <span class="hljs-selector-attr">[接收数据]</span> 数据已接收：kotlin-vararg-local-function
<span class="hljs-selector-attr">[1731678900225]</span> <span class="hljs-selector-attr">[解析数据]</span> 数据解析完成：KOTLIN-VARARG-LOCAL-FUNCTION
<span class="hljs-selector-attr">[1731678900326]</span> <span class="hljs-selector-attr">[存储数据]</span> 数据存储成功

</code></pre>
<p>示例中，“生成日志前缀”的逻辑被提取为局部函数 <code>getLogPrefix</code>，避免了在三个阶段重复编写“获取时间戳+拼接前缀”的代码，让代码更简洁可维护。</p>
<h2 data-id="heading-25">四、可变参数与局部函数 结合示例</h2>
<h3 data-id="heading-26">4.1 简单复合场景（如：可变参数接收数据 + 局部函数处理数据）</h3>
<p>可变参数的优势是“接收任意数量的同类型数据”，局部函数的优势是“封装函数内部重复逻辑”，两者结合可以实现“批量接收数据 + 统一处理数据”的场景。下面以“批量校验手机号格式，并返回校验结果”为例，展示两者的协同作用：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 复合场景：批量校验手机号格式
 * <span class="hljs-doctag">@param</span> phones 可变参数，接收任意数量的手机号字符串
 * <span class="hljs-doctag">@return</span> 校验结果列表（每个手机号对应一个结果）
 */</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">batchCheckPhone</span><span class="hljs-params">(<span class="hljs-keyword">vararg</span> phones: <span class="hljs-type">String</span>)</span></span>: List&lt;String&gt; {
    <span class="hljs-comment">// 局部函数：单个手机号格式校验（封装重复处理逻辑）</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkSinglePhone</span><span class="hljs-params">(phone: <span class="hljs-type">String</span>)</span></span>: String {
        <span class="hljs-comment">// 手机号正则表达式（简单匹配11位数字）</span>
        <span class="hljs-keyword">val</span> phoneRegex = <span class="hljs-string">"^1[3-9]\\d{9}$"</span>.toRegex()
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (phone.matches(phoneRegex)) {
            <span class="hljs-string">"手机号 <span class="hljs-variable">$phone</span>：格式正确"</span>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-string">"手机号 <span class="hljs-variable">$phone</span>：格式错误（需为11位有效数字）"</span>
        }
    }

    <span class="hljs-comment">// 可变参数接收数据，遍历后调用局部函数处理，收集结果</span>
    <span class="hljs-keyword">val</span> resultList = mutableListOf&lt;String&gt;()
    <span class="hljs-keyword">for</span> (phone <span class="hljs-keyword">in</span> phones) {
        <span class="hljs-keyword">val</span> result = checkSinglePhone(phone)
        resultList.add(result)
    }
    <span class="hljs-keyword">return</span> resultList
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 传递多个手机号（可变参数），获取校验结果</span>
    <span class="hljs-keyword">val</span> checkResults = batchCheckPhone(
        <span class="hljs-string">"13800138000"</span>,
        <span class="hljs-string">"1234567890"</span>,
        <span class="hljs-string">"139123456789"</span>,
        <span class="hljs-string">"18888888888"</span>
    )

    <span class="hljs-comment">// 打印校验结果</span>
    checkResults.forEach { println(it) }
}

</code></pre>
<p>运行结果：</p>
<pre><code class="hljs">手机号 13800138000：格式正确
手机号 1234567890：格式错误（需为11位有效数字）
手机号 139123456789：格式错误（需为11位有效数字）
手机号 18888888888：格式正确

</code></pre>
<p>这个示例中，可变参数 <code>phones</code> 实现了“批量接收手机号”的需求，局部函数 <code>checkSinglePhone</code> 封装了“单个手机号校验”的重复逻辑，两者结合让代码既灵活又简洁——既支持任意数量的手机号校验，又避免了重复编写校验逻辑。</p>
<h2 data-id="heading-27">五、总结与注意事项</h2>
<h3 data-id="heading-28">5.1 核心知识点回顾</h3>
<h4 data-id="heading-29">5.1.1 可变参数（vararg）</h4>
<ul>
<li><strong>定义</strong>：用 <code>vararg</code> 修饰参数，允许接收任意数量的同类型参数，函数内部当作数组处理。</li>
<li><strong>用法</strong>：调用时可直接传递多个参数，传递数组需用  运算符展开。</li>
<li><strong>关键</strong>：一个函数只能有一个可变参数，建议放在参数列表最后。</li>
</ul>
<h4 data-id="heading-30">5.1.2 局部函数</h4>
<ul>
<li><strong>定义</strong>：在函数内部定义的函数，仅在外部函数内部可见。</li>
<li><strong>特性</strong>：可直接访问/修改外部函数的变量和参数，实现内部逻辑封装复用。</li>
<li><strong>优势</strong>：减少外部函数冗余代码，隐藏内部辅助逻辑，不污染外部作用域。</li>
</ul>
<h4 data-id="heading-31">5.1.3 两者结合</h4>
<p>可变参数负责“批量接收数据”，局部函数负责“封装重复处理逻辑”，结合后可高效实现“批量数据处理”场景。</p>
<h3 data-id="heading-32">5.2 日常开发使用建议（何时用、避坑点）</h3>
<h4 data-id="heading-33">5.2.1 何时使用可变参数？</h4>
<ul>
<li>函数需要接收“不确定数量的同类型参数”时，如求和、批量打印、批量校验等场景。</li>
<li>避免定义多个参数数量不同的重载函数（如 sum2、sum3、sum4），用一个可变参数函数替代。</li>
</ul>
<h4 data-id="heading-34">5.2.2 何时使用局部函数？</h4>
<ul>
<li>外部函数内部有“重复执行的逻辑片段”时，如多次校验、重复计算、重复格式化等。</li>
<li>辅助逻辑仅在当前函数中用到，无需暴露给外部（避免定义顶层辅助函数）。</li>
</ul>
<h4 data-id="heading-35">5.2.3 避坑点</h4>
<ul>
<li><strong>可变参数避坑</strong>：① 不要将可变参数放在非最后位置，否则调用需用命名参数，易出错；② 传递数组必须加  运算符，否则会被当作单个参数。</li>
<li><strong>局部函数避坑</strong>：① 局部函数不能访问外部函数的 <code>val</code> 变量后又修改它（val 不可变）；② 避免局部函数嵌套过深（如函数里套函数再套函数），会降低代码可读性。</li>
<li><strong>通用避坑</strong>：无论使用哪种特性，都要保证代码逻辑清晰——不要为了用特性而用特性，冗余代码少、可读性高才是核心目标。</li>
</ul>
<p>可变参数和局部函数是 Kotlin 中提升代码质量的重要进阶特性，它们的用法不算复杂，但能解决很多实际开发中的痛点。建议大家在开发中根据场景灵活运用，让代码更简洁、更易维护。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[3.Kotlin 流程控制：告别 if-else 嵌套：If 表达式]]></title>    <link>https://juejin.cn/post/7574245883635449908</link>    <guid>https://juejin.cn/post/7574245883635449908</guid>    <pubDate>2025-11-19T10:41:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574245883635449908" data-draft-id="7574250031248670754" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="3.Kotlin 流程控制：告别 if-else 嵌套：If 表达式"/> <meta itemprop="keywords" content="Android Jetpack,Android,Kotlin"/> <meta itemprop="datePublished" content="2025-11-19T10:41:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Android_小雨"/> <meta itemprop="url" content="https://juejin.cn/user/220360279590862"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            3.Kotlin 流程控制：告别 if-else 嵌套：If 表达式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/220360279590862/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Android_小雨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T10:41:27.000Z" title="Wed Nov 19 2025 10:41:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>希望帮你在Kotlin进阶路上少走弯路，在技术上稳步提升。当然，由于个人知识储备有限，笔记中难免存在疏漏或表述不当的地方，也非常欢迎大家提出宝贵意见，一起交流进步。 —— Android_小雨</p>
</blockquote>
<p>整体目录：<a href="https://juejin.cn/spost/7573592952242602036" target="_blank" title="https://juejin.cn/spost/7573592952242602036">Kotlin 进阶不迷路：41 个核心知识点，构建完整知识体系</a></p>
<h2 data-id="heading-0">一、前言</h2>
<h3 data-id="heading-1">1.1 if-else 嵌套的痛点（代码冗余、可读性差）</h3>
<p>做过Java开发的同学一定对“if-else嵌套地狱”深有体会。当业务逻辑存在多个条件分支时，我们不得不层层嵌套if-else语句，最终写出的代码就像“金字塔”一样，缩进越来越深。这种代码不仅冗余啰嗦，还会严重降低可读性——后续维护者需要顺着嵌套层级逐行梳理逻辑，稍不注意就会遗漏某个分支；更麻烦的是，修改中间某个条件时，很容易因为层级混淆导致逻辑错误。</p>
<p>比如一个简单的“根据考试分数评级”的逻辑，用嵌套if-else写出来是这样的：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Java 嵌套 if-else 示例</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getGrade</span><span class="hljs-params">(<span class="hljs-type">int</span> score)</span> {
    String grade;
    <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">0</span> &amp;&amp; score &lt;= <span class="hljs-number">100</span>) {
        <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">90</span>) {
            grade = <span class="hljs-string">"优秀"</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">80</span>) {
                grade = <span class="hljs-string">"良好"</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">60</span>) {
                    grade = <span class="hljs-string">"及格"</span>;
                } <span class="hljs-keyword">else</span> {
                    grade = <span class="hljs-string">"不及格"</span>;
                }
            }
        }
    } <span class="hljs-keyword">else</span> {
        grade = <span class="hljs-string">"分数无效"</span>;
    }
    <span class="hljs-keyword">return</span> grade;
}

</code></pre>
<p>这段代码仅仅4个评级分支就嵌套了3层，若业务逻辑更复杂（如增加“良好-”“及格+”等细分等级），嵌套层级会直线增加，维护成本陡升。</p>
<h3 data-id="heading-2">1.2 Kotlin If 表达式的核心优势（简洁、可赋值）</h3>
<p>Kotlin的If语句在设计上做了一个关键优化：它不仅仅是用于流程控制的“语句”，更是可以返回值的“表达式”。这个特性直接击中了嵌套if-else的痛点，带来两大核心优势：</p>
<ul>
<li><strong>可直接赋值</strong>：If表达式的结果可以直接赋值给变量，无需像Java那样先定义变量再在分支中赋值，减少代码冗余。</li>
<li><strong>天然去嵌套</strong>：通过链式If表达式替代层级嵌套，将“金字塔”式代码拉平为“线性”代码，可读性大幅提升。</li>
</ul>
<p>还是刚才“分数评级”的例子，用Kotlin If表达式改写后，代码会变得异常简洁：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Kotlin If 表达式示例</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getGrade</span><span class="hljs-params">(score: <span class="hljs-type">Int</span>)</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (score !<span class="hljs-keyword">in</span> <span class="hljs-number">0.</span><span class="hljs-number">.100</span>) <span class="hljs-string">"分数无效"</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">90</span>) <span class="hljs-string">"优秀"</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">80</span>) <span class="hljs-string">"良好"</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">60</span>) <span class="hljs-string">"及格"</span>
    <span class="hljs-keyword">else</span> <span class="hljs-string">"不及格"</span>
}

</code></pre>
<p>没有多余的嵌套缩进，逻辑分支一目了然，这就是If表达式的魅力。</p>
<h3 data-id="heading-3">1.3 本文核心内容预告</h3>
<p>本文将从Kotlin If表达式的基础概念入手，先讲清它与Java if语句的核心差异，再通过实际场景演示如何用If表达式简化if-else嵌套，最后总结适用场景和避坑技巧。无论你是刚从Java转Kotlin的新手，还是想优化现有Kotlin代码的开发者，都能通过本文掌握用If表达式提升代码质量的实用方法。</p>
<h2 data-id="heading-4">二、Kotlin If 基础：不止是判断，更是表达式</h2>
<h3 data-id="heading-5">2.1 什么是 If 表达式？（区别于 Java 的 if 语句）</h3>
<p>在编程中，“语句”和“表达式”是两个不同的概念：<strong>语句</strong>用于执行某个操作（如Java的if语句仅控制流程，不返回值）；<strong>表达式</strong>则是一个会计算并返回结果的代码片段。Kotlin的If恰恰是后者——它在完成条件判断的同时，会返回满足条件的分支中的值，这是它与Java if语句的本质区别。</p>
<p>这个“返回值”特性是Kotlin If表达式的核心，也是它能简化嵌套的关键基础。</p>
<h3 data-id="heading-6">2.2 基本用法（简单条件判断 + 直接赋值示例）</h3>
<h4 data-id="heading-7">2.2.1 简单条件判断</h4>
<p>Kotlin If表达式的基本语法与Java if语句相似，但无需在单分支代码块外加花括号（单条语句时），且支持直接返回值：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 单分支 If 表达式</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">printGreater</span><span class="hljs-params">(a: <span class="hljs-type">Int</span>, b: <span class="hljs-type">Int</span>)</span></span> {
    <span class="hljs-comment">// If 表达式返回满足条件的值，直接用于打印</span>
    println(<span class="hljs-keyword">if</span> (a &gt; b) <span class="hljs-string">"a 大于 b"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"a 不大于 b"</span>)
}

<span class="hljs-comment">// 多分支 If 表达式</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getMax</span><span class="hljs-params">(a: <span class="hljs-type">Int</span>, b: <span class="hljs-type">Int</span>, c: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-comment">// 多分支 If 表达式，返回最大值</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (a &gt; b &amp;&amp; a &gt; c) a
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (b &gt; a &amp;&amp; b &gt; c) b
    <span class="hljs-keyword">else</span> c
}

</code></pre>
<h4 data-id="heading-8">2.2.2 直接赋值示例</h4>
<p>由于If表达式有返回值，它可以直接赋值给变量，这是Java无法直接做到的（Java需用三元运算符或先定义变量再赋值）。比如“根据性别返回问候语”：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> gender = <span class="hljs-string">"男"</span>
    <span class="hljs-comment">// If 表达式结果直接赋值给变量</span>
    <span class="hljs-keyword">val</span> greeting = <span class="hljs-keyword">if</span> (gender == <span class="hljs-string">"男"</span>) <span class="hljs-string">"先生，您好！"</span>
                   <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (gender == <span class="hljs-string">"女"</span>) <span class="hljs-string">"女士，您好！"</span>
                   <span class="hljs-keyword">else</span> <span class="hljs-string">"您好！"</span>
    println(greeting) <span class="hljs-comment">// 输出：先生，您好！</span>

    <span class="hljs-comment">// 更简洁的单分支赋值（含默认值）</span>
    <span class="hljs-keyword">val</span> age = <span class="hljs-number">25</span>
    <span class="hljs-keyword">val</span> isAdult = <span class="hljs-keyword">if</span> (age &gt;= <span class="hljs-number">18</span>) <span class="hljs-literal">true</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">false</span>
    println(isAdult) <span class="hljs-comment">// 输出：true</span>
}

</code></pre>
<p>这种“判断+赋值”一步完成的写法，比Java的“先定义变量再在分支中赋值”少了至少一行代码，且逻辑更连贯。</p>
<h3 data-id="heading-9">2.3 与 Java if 的核心差异（无需三元运算符）</h3>
<p>Java中存在“if-else语句”和“三元运算符（?:）”两种条件判断方式：简单的二选一赋值用三元运算符，复杂的流程控制用if-else。但三元运算符仅支持二分支，且嵌套时可读性极差；if-else虽支持多分支却不能直接赋值。</p>
<p>Kotlin的If表达式直接融合了两者的优势：既支持多分支判断，又能直接返回值赋值给变量，因此<strong>Kotlin中没有专门的三元运算符</strong>——If表达式完全可以替代它，且更灵活。</p>
<p>对比Java三元运算符和Kotlin If表达式：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Java 三元运算符（仅支持二分支）</span>
<span class="hljs-type">String</span> <span class="hljs-variable">greeting</span> <span class="hljs-operator">=</span> gender.equals(<span class="hljs-string">"男"</span>) ? <span class="hljs-string">"先生您好"</span> : <span class="hljs-string">"女士您好"</span>;

</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Kotlin If 表达式（支持二分支，更直观）</span>
<span class="hljs-keyword">val</span> greeting = <span class="hljs-keyword">if</span> (gender == <span class="hljs-string">"男"</span>) <span class="hljs-string">"先生您好"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"女士您好"</span>

<span class="hljs-comment">// Kotlin If 表达式支持多分支（Java需嵌套三元运算符，可读性差）</span>
<span class="hljs-keyword">val</span> greeting = <span class="hljs-keyword">if</span> (gender == <span class="hljs-string">"男"</span>) <span class="hljs-string">"先生您好"</span>
               <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (gender == <span class="hljs-string">"女"</span>) <span class="hljs-string">"女士您好"</span>
               <span class="hljs-keyword">else</span> <span class="hljs-string">"您好"</span>
<span class="hljs-comment">// Java 嵌套三元运算符（可读性差，不推荐）</span>
String greeting = gender.equals(<span class="hljs-string">"男"</span>) ? <span class="hljs-string">"先生您好"</span> : (gender.equals(<span class="hljs-string">"女"</span>) ? <span class="hljs-string">"女士您好"</span> : <span class="hljs-string">"您好"</span>);

</code></pre>
<p>可以看到，多分支场景下，Kotlin If表达式的可读性远超Java嵌套三元运算符。</p>
<h2 data-id="heading-10">三、If 表达式简化 if-else 嵌套</h2>
<h3 data-id="heading-11">3.1 嵌套场景示例（传统 if-else 写法对比）</h3>
<p>我们先看一个典型的嵌套if-else场景：“根据学生的成绩和出勤率判断是否能参加考试”。业务逻辑：</p>
<ol>
<li>首先判断出勤率是否≥90%：不满足则直接不能参加；</li>
<li>出勤率满足后，判断成绩是否≥60分：满足则可以参加，不满足则需补考。</li>
</ol>
<p>用Java嵌套if-else写法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Java 嵌套 if-else 写法</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">canTakeExam</span><span class="hljs-params">(<span class="hljs-type">double</span> attendanceRate, <span class="hljs-type">double</span> score)</span> {
    String result;
    <span class="hljs-comment">// 第一层：判断出勤率</span>
    <span class="hljs-keyword">if</span> (attendanceRate &gt;= <span class="hljs-number">0.9</span>) {
        <span class="hljs-comment">// 第二层：判断成绩</span>
        <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">60</span>) {
            result = <span class="hljs-string">"可以参加考试"</span>;
        } <span class="hljs-keyword">else</span> {
            result = <span class="hljs-string">"需参加补考"</span>;
        }
    } <span class="hljs-keyword">else</span> {
        result = <span class="hljs-string">"出勤率不足，不能参加考试"</span>;
    }
    <span class="hljs-keyword">return</span> result;
}

</code></pre>
<p>这段代码有2层嵌套，逻辑不算复杂，但已能看出缩进带来的层次感。接下来用Kotlin If表达式改写，看看如何“拉平”嵌套。</p>
<h3 data-id="heading-12">3.2 单层 If 表达式简化（二选一逻辑）</h3>
<p>对于“单条件二分支”的嵌套场景（如上述场景中“出勤率满足后判断成绩”），Kotlin If表达式可以通过“else if”将嵌套改为线性结构，消除缩进。</p>
<p>改写上述Java代码为Kotlin If表达式：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Kotlin If 表达式简化二分支嵌套</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">canTakeExam</span><span class="hljs-params">(attendanceRate: <span class="hljs-type">Double</span>, score: <span class="hljs-type">Double</span>)</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (attendanceRate &lt; <span class="hljs-number">0.9</span>) <span class="hljs-string">"出勤率不足，不能参加考试"</span>
           <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">60</span>) <span class="hljs-string">"可以参加考试"</span>
           <span class="hljs-keyword">else</span> <span class="hljs-string">"需参加补考"</span>
}

</code></pre>
<p>对比Java版本：嵌套层级从2层变为0层，代码从“金字塔”变为“水平线”，逻辑流向更清晰——先判断最严格的条件（出勤率），不满足直接返回，满足则继续判断下一个条件。</p>
<p>核心思路：<strong>将嵌套的内层条件改为外层的“else if”分支</strong>，优先处理“不满足则直接返回”的异常分支，减少嵌套。</p>
<h3 data-id="heading-13">3.3 多层 If 表达式简化（多条件分支）</h3>
<p>对于3层及以上的复杂嵌套，If表达式同样可以通过“链式else if”拉平层级。比如更复杂的“成绩评级+奖励判断”场景：</p>
<ol>
<li>先判断分数是否在0-100之间：无效分数直接返回；</li>
<li>有效分数中，90分以上：优秀+奖学金；</li>
<li>80-89分：良好+学习用品；</li>
<li>60-79分：及格+鼓励信；</li>
<li>60分以下：不及格+补考通知。</li>
</ol>
<p>Java嵌套if-else写法（3层嵌套）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Java 多层嵌套 if-else</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getScoreReward</span><span class="hljs-params">(<span class="hljs-type">int</span> score)</span> {
    String result;
    <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">0</span> &amp;&amp; score &lt;= <span class="hljs-number">100</span>) {
        <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">90</span>) {
            result = <span class="hljs-string">"优秀，获得500元奖学金"</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">80</span>) {
                result = <span class="hljs-string">"良好，获得笔记本套装"</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">60</span>) {
                    result = <span class="hljs-string">"及格，获得鼓励信"</span>;
                } <span class="hljs-keyword">else</span> {
                    result = <span class="hljs-string">"不及格，需参加补考"</span>;
                }
            }
        }
    } <span class="hljs-keyword">else</span> {
        result = <span class="hljs-string">"分数无效"</span>;
    }
    <span class="hljs-keyword">return</span> result;
}

</code></pre>
<p>用Kotlin If表达式改写（0层嵌套）：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Kotlin 链式 If 表达式简化多层嵌套</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getScoreReward</span><span class="hljs-params">(score: <span class="hljs-type">Int</span>)</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (score !<span class="hljs-keyword">in</span> <span class="hljs-number">0.</span><span class="hljs-number">.100</span>) <span class="hljs-string">"分数无效"</span>
           <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">90</span>) <span class="hljs-string">"优秀，获得500元奖学金"</span>
           <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">80</span>) <span class="hljs-string">"良好，获得笔记本套装"</span>
           <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">60</span>) <span class="hljs-string">"及格，获得鼓励信"</span>
           <span class="hljs-keyword">else</span> <span class="hljs-string">"不及格，需参加补考"</span>
}

</code></pre>
<p>改写后的代码完全消除了嵌套，每个条件分支平行排列，逻辑一目了然。即使后续增加“70-79分：良好-，获得书签”这样的分支，也只需新增一个“else if”，无需调整缩进。</p>
<h3 data-id="heading-14">3.4 关键技巧：保持表达式简洁性</h3>
<p>虽然If表达式能简化嵌套，但如果每个分支的代码逻辑过于复杂（如包含多行代码、循环、异常处理等），直接写在If表达式中会导致代码臃肿。此时需要遵循“单一职责”原则，将复杂逻辑抽离为单独的函数，保持If表达式的简洁性。</p>
<p>反例（分支逻辑复杂，If表达式臃肿）：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 反例：分支逻辑复杂，If表达式可读性差</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handleOrder</span><span class="hljs-params">(status: <span class="hljs-type">String</span>, orderId: <span class="hljs-type">String</span>)</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (status == <span class="hljs-string">"待支付"</span>) {
        <span class="hljs-comment">// 分支内包含多行逻辑，导致If表达式臃肿</span>
        <span class="hljs-keyword">val</span> currentTime = System.currentTimeMillis()
        <span class="hljs-keyword">val</span> expireTime = currentTime + <span class="hljs-number">30</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span> <span class="hljs-comment">// 30分钟后过期</span>
        <span class="hljs-string">"订单<span class="hljs-variable">$orderId</span> 待支付，过期时间：<span class="hljs-subst">${expireTime}</span>"</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (status == <span class="hljs-string">"已支付"</span>) {
        <span class="hljs-keyword">val</span> logistics = <span class="hljs-string">"顺丰快递，单号：SF123456789"</span>
        <span class="hljs-string">"订单<span class="hljs-variable">$orderId</span> 已支付，物流信息：<span class="hljs-variable">$logistics</span>"</span>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-string">"订单<span class="hljs-variable">$orderId</span> 状态异常"</span>
    }
}

</code></pre>
<p>正例（抽离复杂逻辑为函数，If表达式简洁）：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 正例：抽离分支逻辑为单独函数，If表达式简洁清晰</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handleOrder</span><span class="hljs-params">(status: <span class="hljs-type">String</span>, orderId: <span class="hljs-type">String</span>)</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (status == <span class="hljs-string">"待支付"</span>) getPendingPaymentMsg(orderId)
           <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (status == <span class="hljs-string">"已支付"</span>) getPaidMsg(orderId)
           <span class="hljs-keyword">else</span> <span class="hljs-string">"订单<span class="hljs-variable">$orderId</span> 状态异常"</span>
}

<span class="hljs-comment">// 抽离待支付逻辑</span>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getPendingPaymentMsg</span><span class="hljs-params">(orderId: <span class="hljs-type">String</span>)</span></span>: String {
    <span class="hljs-keyword">val</span> currentTime = System.currentTimeMillis()
    <span class="hljs-keyword">val</span> expireTime = currentTime + <span class="hljs-number">30</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"订单<span class="hljs-variable">$orderId</span> 待支付，过期时间：<span class="hljs-subst">${expireTime}</span>"</span>
}

<span class="hljs-comment">// 抽离已支付逻辑</span>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getPaidMsg</span><span class="hljs-params">(orderId: <span class="hljs-type">String</span>)</span></span>: String {
    <span class="hljs-keyword">val</span> logistics = <span class="hljs-string">"顺丰快递，单号：SF123456789"</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"订单<span class="hljs-variable">$orderId</span> 已支付，物流信息：<span class="hljs-variable">$logistics</span>"</span>
}

</code></pre>
<p>核心技巧：<strong>If表达式的每个分支应尽量只做“返回结果”的操作，复杂逻辑通过私有函数封装</strong>，这样既保留了If表达式去嵌套的优势，又保证了代码的可维护性。</p>
<h2 data-id="heading-15">四、If 表达式的实用场景</h2>
<h3 data-id="heading-16">4.1 变量赋值（直接通过条件返回结果）</h3>
<p>这是If表达式最常用的场景——根据条件动态给变量赋值，替代“先定义变量再在分支中赋值”的繁琐写法。比如“根据用户等级设置折扣”：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> userLevel = <span class="hljs-string">"VIP"</span> <span class="hljs-comment">// 普通用户、VIP、超级VIP</span>
    <span class="hljs-comment">// 根据用户等级赋值折扣率</span>
    <span class="hljs-keyword">val</span> discount = <span class="hljs-keyword">if</span> (userLevel == <span class="hljs-string">"超级VIP"</span>) <span class="hljs-number">0.7</span>
                   <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (userLevel == <span class="hljs-string">"VIP"</span>) <span class="hljs-number">0.8</span>
                   <span class="hljs-keyword">else</span> <span class="hljs-number">0.95</span>
    println(<span class="hljs-string">"当前折扣：<span class="hljs-subst">${discount * <span class="hljs-number">10</span>}</span>折"</span>) <span class="hljs-comment">// 输出：当前折扣：8.0折</span>

    <span class="hljs-comment">// 更复杂的条件赋值（结合范围判断）</span>
    <span class="hljs-keyword">val</span> age = <span class="hljs-number">16</span>
    <span class="hljs-keyword">val</span> ticketPrice = <span class="hljs-keyword">if</span> (age &lt; <span class="hljs-number">6</span>) <span class="hljs-number">0.0</span> <span class="hljs-comment">// 6岁以下免票</span>
                      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (age &lt; <span class="hljs-number">18</span>) <span class="hljs-number">50.0</span> <span class="hljs-comment">// 6-17岁半价</span>
                      <span class="hljs-keyword">else</span> <span class="hljs-number">100.0</span> <span class="hljs-comment">// 18岁以上全价</span>
    println(<span class="hljs-string">"门票价格：<span class="hljs-variable">$ticketPrice</span> 元"</span>) <span class="hljs-comment">// 输出：门票价格：50.0 元</span>
}

</code></pre>
<p>这种写法的优势在于“赋值逻辑集中”，变量的所有赋值分支都在一个If表达式中，后续修改时无需在代码中四处查找赋值位置。</p>
<h3 data-id="heading-17">4.2 简单逻辑判断（替代复杂嵌套）</h3>
<p>对于需要根据条件执行不同逻辑（而非赋值）的场景，If表达式同样可以简化嵌套。比如“用户登录验证”：</p>
<ol>
<li>验证用户名是否为空：为空则提示“用户名不能为空”；</li>
<li>用户名不为空时，验证密码长度是否≥6位：不足则提示“密码过短”；</li>
<li>密码符合要求时，验证用户名密码是否匹配：匹配则登录成功，否则提示“账号密码不匹配”。</li>
</ol>
<p>Java嵌套if-else写法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Java 嵌套逻辑判断</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">login</span><span class="hljs-params">(String username, String password)</span> {
    <span class="hljs-keyword">if</span> (username.isEmpty()) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"用户名不能为空"</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (password.length() &lt; <span class="hljs-number">6</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"密码过短（至少6位）"</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (username.equals(<span class="hljs-string">"admin"</span>) &amp;&amp; password.equals(<span class="hljs-string">"123456"</span>)) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">"登录成功"</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-string">"账号密码不匹配"</span>;
            }
        }
    }
}

</code></pre>
<p>Kotlin If表达式简化写法：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Kotlin If 表达式简化逻辑判断</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">login</span><span class="hljs-params">(username: <span class="hljs-type">String</span>, password: <span class="hljs-type">String</span>)</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (username.isEmpty()) <span class="hljs-string">"用户名不能为空"</span>
           <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (password.length &lt; <span class="hljs-number">6</span>) <span class="hljs-string">"密码过短（至少6位）"</span>
           <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (username == <span class="hljs-string">"admin"</span> &amp;&amp; password == <span class="hljs-string">"123456"</span>) <span class="hljs-string">"登录成功"</span>
           <span class="hljs-keyword">else</span> <span class="hljs-string">"账号密码不匹配"</span>
}

</code></pre>
<p>逻辑判断从3层嵌套变为线性分支，代码更简洁，且优先处理异常场景（用户名空、密码短），符合“提前返回”的编码规范。</p>
<h3 data-id="heading-18">4.3 与其他语法配合（如函数返回值）</h3>
<p>If表达式作为返回值时，可以与Kotlin的“单表达式函数”语法结合，进一步简化代码。单表达式函数是指函数体仅包含一个表达式，可省略花括号和return关键字，直接用等号连接函数定义和表达式。</p>
<p>比如“判断是否为偶数”的单表达式函数：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 单表达式函数 + If 表达式（极致简洁）</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isEven</span><span class="hljs-params">(num: <span class="hljs-type">Int</span>)</span></span> = <span class="hljs-keyword">if</span> (num % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) <span class="hljs-literal">true</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">false</span>

<span class="hljs-comment">// 更简洁的写法（布尔表达式可直接返回）</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isEvenSimpler</span><span class="hljs-params">(num: <span class="hljs-type">Int</span>)</span></span> = num % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    println(isEven(<span class="hljs-number">4</span>)) <span class="hljs-comment">// 输出：true</span>
    println(isEvenSimpler(<span class="hljs-number">5</span>)) <span class="hljs-comment">// 输出：false</span>
}

</code></pre>
<p>再比如结合“空安全”判断：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// If 表达式结合空安全，返回非空值</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUserName</span><span class="hljs-params">(user: <span class="hljs-type">User</span>?)</span></span>: String {
    <span class="hljs-comment">// 若user不为空则返回name，否则返回默认值</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) user.name <span class="hljs-keyword">else</span> <span class="hljs-string">"匿名用户"</span>
}

<span class="hljs-comment">// 单表达式函数简化</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUserNameSimpler</span><span class="hljs-params">(user: <span class="hljs-type">User</span>?)</span></span> = user?.name ?: <span class="hljs-string">"匿名用户"</span>

<span class="hljs-comment">// 数据类</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> name: String)

</code></pre>
<p>这里If表达式与空安全操作符（?.、?:）配合，实现了“空值处理+返回值”的简洁逻辑。</p>
<h2 data-id="heading-19">五、总结与使用建议</h2>
<h3 data-id="heading-20">5.1 核心知识点回顾（If 表达式特性、去嵌套优势）</h3>
<ul>
<li><strong>核心特性</strong>：Kotlin If是表达式而非语句，具有返回值，可直接赋值给变量或作为函数返回值；支持多分支（else if），无需三元运算符。</li>
<li><strong>去嵌套优势</strong>：通过“链式else if”将传统if-else的“金字塔”嵌套拉平为线性分支，消除缩进，提升代码可读性和可维护性。</li>
<li><strong>关键差异</strong>：与Java相比，融合了if-else的多分支能力和三元运算符的赋值能力，语法更统一。</li>
</ul>
<h3 data-id="heading-21">5.2 适用场景与避坑点（何时用、避免过度复杂）</h3>
<h4 data-id="heading-22">5.2.1 适用场景</h4>
<ol>
<li><strong>变量赋值场景</strong>：需要根据条件动态给变量赋值（替代Java的“定义变量+分支赋值”）。</li>
<li><strong>简单逻辑判断场景</strong>：包含2-5个条件分支的逻辑判断（过多分支建议用when表达式，后续文章讲解）。</li>
<li><strong>单表达式函数场景</strong>：函数逻辑仅为条件判断并返回结果，可结合单表达式函数简化代码。</li>
</ol>
<h4 data-id="heading-23">5.2.2 避坑点</h4>
<ul>
<li><strong>避免分支逻辑过于复杂</strong>：若某个分支包含多行代码、循环或异常处理，需抽离为单独函数，不要直接写在If表达式中，否则会降低可读性。</li>
<li><strong>分支数量不宜过多</strong>：当条件分支超过5个时，If表达式的链式else if会变得冗长，建议改用Kotlin的when表达式（更适合多分支场景）。</li>
<li><strong>注意代码块的返回值</strong>：若分支是代码块（用花括号包裹），需确保代码块的最后一行是返回值（Kotlin代码块的返回值为最后一行表达式的结果）。</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 注意：代码块分支需确保最后一行是返回值</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getMsg</span><span class="hljs-params">(type: <span class="hljs-type">Int</span>)</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (type == <span class="hljs-number">1</span>) {
        <span class="hljs-comment">// 代码块最后一行是返回值</span>
        <span class="hljs-keyword">val</span> prefix = <span class="hljs-string">"类型1："</span>
        <span class="hljs-string">"<span class="hljs-variable">$prefix</span> 消息内容"</span>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-string">"其他类型消息"</span>
    }
}

</code></pre>
<h3 data-id="heading-24">5.3 代码简洁性提升小技巧</h3>
<ul>
<li><strong>优先处理异常场景</strong>：在If表达式中先判断“不满足则直接返回”的异常条件，减少后续分支的嵌套（即使不用If表达式，这也是通用编码规范）。</li>
<li><strong>简化布尔表达式</strong>：若If表达式的分支是布尔值（true/false），可直接返回条件表达式，无需显式写true/false。比如 <code>val isAdult = if (age &gt;= 18) true else false</code> 可简化为 <code>val isAdult = age &gt;= 18</code>。</li>
<li><strong>结合单表达式函数</strong>：对于简单的条件返回函数，用“等号+If表达式”的单表达式函数写法，省略花括号和return。</li>
</ul>
<p>Kotlin的If表达式看似是一个简单的语法优化，却能从根本上解决传统if-else嵌套的痛点。掌握它的核心是理解“表达式有返回值”这一本质，然后在实际开发中主动用If表达式替代嵌套if-else，逐步养成简洁的编码习惯。下一篇我们将讲解Kotlin更强大的多分支控制结构——when表达式，让复杂分支逻辑更上一层楼！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[打造稳健的 Android 应用：协程异常处理的实用策略]]></title>    <link>https://juejin.cn/post/7574244766424006665</link>    <guid>https://juejin.cn/post/7574244766424006665</guid>    <pubDate>2025-11-19T11:50:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574244766424006665" data-draft-id="7569143122686836790" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="打造稳健的 Android 应用：协程异常处理的实用策略"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-19T11:50:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="潜龙勿用之化骨龙"/> <meta itemprop="url" content="https://juejin.cn/user/2313028195058471"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            打造稳健的 Android 应用：协程异常处理的实用策略
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2313028195058471/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    潜龙勿用之化骨龙
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T11:50:38.000Z" title="Wed Nov 19 2025 11:50:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>异常处理是保障应用稳健性的基石，在不同开发环境中，异常的表现与处理方式大相径庭。本文将带您解码Java、Android与Kotlin协程中的异常行为差异，剖析常见陷阱，并最终提供一套构建坚不可摧应用的最佳实践与“避坑指南”。</p>
<hr/>
<h2 data-id="heading-0"><strong>Java 与 Android 异常处理的区别</strong></h2>
<h3 data-id="heading-1"><strong>Java 异常处理</strong></h3>
<p>在 Java 中，异常是局限于发生异常的线程的。如果子线程抛出未捕获的异常，它不会影响主线程或其他线程。主线程可以继续正常运行，即使子线程遇到错误。</p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JavaThreadExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Exception in child thread"</span>);
            }).start();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.out.println(<span class="hljs-string">"Caught exception: "</span> + e.getMessage());
        }
        System.out.println(<span class="hljs-string">"Main thread continues..."</span>);
    }
}
</code></pre>
<p><strong>输出：</strong>
子线程中的异常不会被主线程的 <code>try-catch</code> 捕获，主线程继续执行。</p>
<hr/>
<h3 data-id="heading-2"><strong>Android 异常处理</strong></h3>
<p>在 Android 中，异常处理更加严格。如果子线程抛出未捕获的异常，整个应用会崩溃。这是因为未捕获的异常会传播到主进程级别，导致应用终止。Android 的这种机制旨在确保应用的稳定性。</p>
<p><strong>关键点：</strong>
在 Android 中，异常必须在发生的线程内捕获。如果未捕获异常，应用将崩溃。</p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">thread1</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">try</span> {
        thread {
            Thread.sleep(<span class="hljs-number">2000</span>)
            <span class="hljs-keyword">throw</span> Exception(<span class="hljs-string">"Exception inside thread"</span>)
        }
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        Log.e(<span class="hljs-string">"test"</span>, e.message.toString())
    }
}
</code></pre>
<p><strong>结果：</strong>
线程内部的异常无法被外部的 <code>try-catch</code> 捕获，必须在线程内部处理。</p>
<hr/>
<h2 data-id="heading-3"><strong>Kotlin 协程中的异常处理</strong></h2>
<p>Kotlin 协程引入了一种新的并发编程范式，与线程类似，协程中的异常局限于发生异常的协程。外部的 <code>try-catch</code> 无法捕获协程内部抛出的异常。</p>
<h3 data-id="heading-4"><strong>示例：</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">launch1</span><span class="hljs-params">()</span></span> = coroutineScope {
    <span class="hljs-keyword">try</span> {
        launch {
            delay(<span class="hljs-number">2000</span>)
            <span class="hljs-number">1</span> / <span class="hljs-number">0</span> <span class="hljs-comment">// 抛出异常</span>
        }
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        Log.e(<span class="hljs-string">"test"</span>, e.message.toString())
    }
}
</code></pre>
<p><strong>结果：</strong>
协程内部的异常无法被外部的 <code>try-catch</code> 捕获，必须在协程内部处理。</p>
<hr/>
<h2 data-id="heading-5"><strong>coroutineScope 与 supervisorScope 的区别</strong></h2>
<p>在使用协程时，理解 <code>coroutineScope</code> 和 <code>supervisorScope</code> 的区别对于有效的异常处理至关重要。</p>
<h3 data-id="heading-6"><strong>coroutineScope</strong></h3>
<p>在 <code>coroutineScope</code> 中，如果一个子协程失败，会取消所有其他兄弟协程。这种行为确保错误能够一致地传播和处理，但可能导致意外的取消。</p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">exampleCoroutineScope2</span><span class="hljs-params">()</span></span> = coroutineScope {
    launch {
        <span class="hljs-keyword">try</span> {
            delay(<span class="hljs-number">1000</span>)
            Log.e(<span class="hljs-string">"test"</span>, <span class="hljs-string">"Child 1 completed"</span>)
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            Log.e(<span class="hljs-string">"test"</span>, <span class="hljs-string">"Child 1 failed: <span class="hljs-subst">${e.message}</span>"</span>)
        }
    }
    launch {
        <span class="hljs-keyword">try</span> {
            delay(<span class="hljs-number">500</span>)
            <span class="hljs-keyword">throw</span> Exception(<span class="hljs-string">"Child 2 failed"</span>)
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            Log.e(<span class="hljs-string">"test"</span>, <span class="hljs-string">"Child 2 failed: <span class="hljs-subst">${e.message}</span>"</span>)
        }
    }
    launch {
        <span class="hljs-keyword">try</span> {
            delay(<span class="hljs-number">1500</span>)
            Log.e(<span class="hljs-string">"test"</span>, <span class="hljs-string">"Child 3 completed"</span>)
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            Log.e(<span class="hljs-string">"test"</span>, <span class="hljs-string">"Child 3 failed: <span class="hljs-subst">${e.message}</span>"</span>)
        }
    }
}
</code></pre>
<p><strong>结果：</strong>
如果 <code>Child 2</code> 失败，所有其他兄弟协程（<code>Child 1</code> 和 <code>Child 3</code>）都会被取消。</p>
<hr/>
<h3 data-id="heading-7"><strong>supervisorScope</strong></h3>
<p>在 <code>supervisorScope</code> 中，兄弟协程是相互独立的。如果一个协程失败，它不会影响其他协程的执行。这在需要隔离错误并确保其他任务能够继续时非常有用。</p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">exampleSupervisorScope2</span><span class="hljs-params">()</span></span> = supervisorScope {
    launch {
        <span class="hljs-keyword">try</span> {
            delay(<span class="hljs-number">1000</span>)
            Log.e(<span class="hljs-string">"test"</span>, <span class="hljs-string">"Child 1 completed"</span>)
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            Log.e(<span class="hljs-string">"test"</span>, <span class="hljs-string">"Child 1 failed: <span class="hljs-subst">${e.message}</span>"</span>)
        }
    }
    launch {
        <span class="hljs-keyword">try</span> {
            delay(<span class="hljs-number">500</span>)
            <span class="hljs-keyword">throw</span> Exception(<span class="hljs-string">"Child 2 failed"</span>)
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            Log.e(<span class="hljs-string">"test"</span>, <span class="hljs-string">"Child 2 failed: <span class="hljs-subst">${e.message}</span>"</span>)
        }
    }
    launch {
        <span class="hljs-keyword">try</span> {
            delay(<span class="hljs-number">1500</span>)
            Log.e(<span class="hljs-string">"test"</span>, <span class="hljs-string">"Child 3 completed"</span>)
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            Log.e(<span class="hljs-string">"test"</span>, <span class="hljs-string">"Child 3 failed: <span class="hljs-subst">${e.message}</span>"</span>)
        }
    }
}
</code></pre>
<p><strong>结果：</strong>
如果 <code>Child 2</code> 失败，<code>Child 1</code> 和 <code>Child 3</code> 不会受到影响，继续执行。</p>
<hr/>
<h3 data-id="heading-8"><strong>如果异常在repo处理，coroutineScope 和 supervisorScope 的区别会消失</strong></h3>
<p>在实际开发中，如果我们将异常处理集中在仓库层（Repository Layer），那么 <code>coroutineScope</code> 和 <code>supervisorScope</code> 的区别就会变得不那么重要。因为仓库层会捕获所有与数据相关的异常（如网络错误或数据库错误），并将其转化为可控的结果返回给上层（如 ViewModel 或 UI 层）。这样，无论是 <code>coroutineScope</code> 还是 <code>supervisorScope</code>，都不会因为未捕获的异常导致协程取消或传播。</p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fetchData</span><span class="hljs-params">()</span></span> = <span class="hljs-keyword">try</span> {
    repository.getData() <span class="hljs-comment">// 在仓库层处理异常</span>
} <span class="hljs-keyword">catch</span> (e: Exception) {
    Log.e(<span class="hljs-string">"test"</span>, <span class="hljs-string">"Error in repository: <span class="hljs-subst">${e.message}</span>"</span>)
    <span class="hljs-literal">null</span> <span class="hljs-comment">// 返回一个安全的结果</span>
}
</code></pre>
<p>通过这种方式，协程的异常处理逻辑被集中管理，减少了代码的复杂性，同时提高了应用的稳定性。</p>
<hr/>
<h2 data-id="heading-9"><strong>CoroutineExceptionHandler 的挑战</strong></h2>
<p>虽然 <code>CoroutineExceptionHandler</code> 提供了一种处理协程中未捕获异常的机制，但它也存在一些局限性。主要问题在于每次启动协程时都需要显式传递 <code>CoroutineExceptionHandler</code>，这会导致代码冗长且不够优雅。</p>
<h3 data-id="heading-10"><strong>为什么不推荐过度使用 CoroutineExceptionHandler？</strong></h3>
<ol>
<li><strong>复杂性：</strong> 在多个应用层中管理 <code>CoroutineExceptionHandler</code> 会导致代码分散且难以维护。</li>
<li><strong>分层架构：</strong> 更好的做法是将异常处理集中在仓库层（Repository Layer），在这里可以统一管理与数据相关的错误（如网络错误或数据库错误）。这样可以确保异常不会传播到更高的层级（如 ViewModel 或 UI 层）。</li>
</ol>
<hr/>
<h2 data-id="heading-11"><strong>异常处理的最佳实践</strong></h2>
<h3 data-id="heading-12"><strong>在repo处理异常</strong></h3>
<p>将异常处理集中在仓库层，确保与数据相关的错误能够得到有效管理。这种方法提高了代码的可维护性，同时让更高层级（如 ViewModel 和 UI 层）专注于自己的职责。</p>
<h2 data-id="heading-13"><strong>总结</strong></h2>
<p>在 Java、Android 和 Kotlin 协程中，异常处理的机制和行为各不相同。通过遵循最佳实践（如在仓库层集中处理异常、使用 <code>supervisorScope</code> 处理独立任务、在协程内部捕获异常），可以构建健壮且易于维护的应用。如果异常处理集中在仓库层，那么 <code>coroutineScope</code> 和 <code>supervisorScope</code> 的区别将变得不那么重要，因为异常已经被统一管理，协程的取消和传播逻辑不会影响应用的稳定性。理解这些细微差别将帮助开发者避免常见问题，确保应用在面对意外错误时能够保持稳定和弹性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大数据-158 Apache Kylin 3.1.1 在 Hadoop 2.9/Hive 2.3/HBase 1.3 的最小可用部署实录（含坑位与修复）]]></title>    <link>https://juejin.cn/post/7574584245109751859</link>    <guid>https://juejin.cn/post/7574584245109751859</guid>    <pubDate>2025-11-20T01:53:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574584245109751859" data-draft-id="7574289653178843174" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大数据-158 Apache Kylin 3.1.1 在 Hadoop 2.9/Hive 2.3/HBase 1.3 的最小可用部署实录（含坑位与修复）"/> <meta itemprop="keywords" content="后端,大数据,Apache Kylin"/> <meta itemprop="datePublished" content="2025-11-20T01:53:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武子康"/> <meta itemprop="url" content="https://juejin.cn/user/149189314230039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大数据-158 Apache Kylin 3.1.1 在 Hadoop 2.9/Hive 2.3/HBase 1.3 的最小可用部署实录（含坑位与修复）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189314230039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武子康
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T01:53:15.000Z" title="Thu Nov 20 2025 01:53:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TL;DR</h2>
<ul>
<li>场景：3 节点（h121/122/123）资源吃紧环境，部署 Apache Kylin 3.1.1（HBase1.x 版）。</li>
<li>结论：通过环境变量与软链补齐、修正 HADOOP_CONF_DIR、按序启动组件，成功启动并登录 Kylin（7070）。</li>
<li>产出：完整命令序列、版本矩阵（已验证）、错误速查卡（常见症状→定位→修复）。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69249ccbe6604c8dbed6e767e9173ddd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=fKY3Pa0V3tFtPQZF%2FU%2Bxht%2BSuDQ%3D" alt="大数据-158 Apache Kylin 3.1.1 在 Hadoop 2.9/Hive 2.3/HBase 1.3 的最小可用部署实录（含坑位与修复）" loading="lazy"/></p>
<h2 data-id="heading-1">版本矩阵</h2>















































<table><thead><tr><th>组件/包名</th><th>版本</th><th>已验证</th><th>说明</th></tr></thead><tbody><tr><td>Apache Kylin</td><td>3.1.1 (apache-kylin-3.1.1-bin-hbase1x)</td><td>是</td><td>来自 archive.apache.org，运行于 h122，Web 端口 7070，默认 ADMIN/KYLIN（大写）。</td></tr><tr><td>Hadoop</td><td>2.9.2</td><td>是</td><td>HADOOP_CONF_DIR=$HADOOP_HOME/etc/hadoop；先启 HDFS，再启 YARN；HADOOP_CLASSPATH=<code>hadoop classpath</code>。</td></tr><tr><td>Hive</td><td>2.3.9</td><td>是</td><td>独立启动 Metastore（9083），日志 /tmp/metastore.log。</td></tr><tr><td>HBase</td><td>1.3.1</td><td>是</td><td>hbase.zookeeper.quorum 仅填主机名；三节点协同启动。</td></tr><tr><td>Spark</td><td>2.4.5 (without-hadoop, Scala 2.12)</td><td>是</td><td>作为依赖配置软链；未跑计算作业。</td></tr><tr><td>ZooKeeper</td><td>版本未记录（三节点）</td><td>是</td><td>各节点 zkServer.sh start。</td></tr></tbody></table>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1026e620f8a64d92851fbdfe3cf5a0f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=7J7Ryn9uYG5Oz7R1DnTuTvJeSxo%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-2">依赖环境</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1176ef6460a435e9ce995de4db96437~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=vc%2Fkk6KIdtLJ2fAVhHstMgrMASo%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-3">集群规划</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/789a7aa5f7f94ca7a694f5a1a82457dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=D3z566Sg6EY2s%2F2BVhgmMB3JuA0%3D" alt="在这里插入图片描述" loading="lazy"/>
我这里就不根据上图来做了，因为我的服务器资源比较紧张，我就自由安排了。
需要注意：要求HBase的hbase.zookeeper.quorum值必须只能是 host1、host2这种，不允许host1:2181、host2:2181这种。</p>
<pre><code class="hljs language-shell" lang="shell">cd /opt/servers/hbase-1.3.1/conf
vim hbase-site.xml
</code></pre>
<p>（之前HBase实验已经做过了，配置就是这样的）</p>
<p>保险起见，放一个截图：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72c9eee4ebca41338db053725670d94d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=xn0UFvatMZgC6rMvn8l%2Ft2jzEQA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-4">项目下载</h2>
<p>下载地址如下：</p>
<pre><code class="hljs language-shell" lang="shell">https://archive.apache.org/dist/kylin/
</code></pre>
<p>这里使用的是：</p>
<pre><code class="hljs language-shell" lang="shell">https://archive.apache.org/dist/kylin/apache-kylin-3.1.1/apache-kylin-3.1.1-bin-hbase1x.tar.gz
</code></pre>
<p>你可以通过wegt或者本地下载完传到服务器上，按照需求，我这里是上传到 h122 节点上</p>
<pre><code class="hljs language-shell" lang="shell">cd /opt/software
wget https://archive.apache.org/dist/kylin/apache-kylin-3.1.1/apache-kylin-3.1.1-bin-hbase1x.tar.gz
</code></pre>
<p>等待下载完毕
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9cce3320d7b74ce09d49b200f517a541~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=1KcwoqTVohDXJcPA7anCGmsMMFQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-5">解压移动</h2>
<pre><code class="hljs language-shell" lang="shell">cd /opt/software
tar -zxvf apache-kylin-3.1.1-bin-hbase1x.tar.gz
</code></pre>
<p>运行结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab9d95ae4c0845649dcf61ce2760904b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=yrp02lkT3IboaVlnxCeGjlKefsU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>接着将其移动到servers目录，方便后续的管理：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48c4c971634e492481c5aa408978bd1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=nQL6fiumB7kKP0wCK4Dte9rqhn4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-6">环境变量</h2>
<pre><code class="hljs language-shell" lang="shell">vim /etc/profile
</code></pre>
<p>我们需要加入Kylin的环境变量：（记得刷新环境变量）</p>
<pre><code class="hljs language-shell" lang="shell">export KYLIN_HOME=/opt/servers/apache-kylin-3.1.1-bin-hbase1x
export PATH=$PATH:$KYLIN_HOME/bin
</code></pre>
<p>配置环境变量如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52d2944ad4794c00b329a904a2e3850d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=%2FZspoTWW398TSkJSpj2bFMTuNKo%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-7">依赖组件</h2>
<pre><code class="hljs language-shell" lang="shell">cd $KYLIN_HOME/conf
ln -s $HADOOP_HOME/etc/hadoop/hdfs-site.xml hdfs-site.xml
ln -s $HADOOP_HOME/etc/hadoop/core-site.xml core-site.xml
ln -s $HBASE_HOME/conf/hbase-site.xml hbase-site.xml
ln -s $HIVE_HOME/conf/hive-site.xml hive-site.xml
ln -s $SPARK_HOME/conf/spark-defaults.conf spark-defaults.conf
</code></pre>
<p>执行的结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bdd0181f029d440aad07d2de6b9427ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=%2FHODV8rtDjacQfSK6PJYacG8kro%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-8">配置环境</h2>
<p>我们需要修改 kylin.sh</p>
<pre><code class="hljs language-shell" lang="shell">cd $KYLIN_HOME/bin
vim kylin.sh
<span class="hljs-meta prompt_">
# </span><span class="bash">需要写入这些依赖 防止后续报错</span>
export HADOOP_HOME=/opt/servers/hadoop-2.9.2
export HIVE_HOME=/opt/servers/apache-hive-2.3.9-bin
export HBASE_HOME=/opt/servers/hbase-1.3.1
export SPARK_HOME=/opt/servers/spark-2.4.5-bin-without-hadoop-scala-2.12

</code></pre>
<p>配置结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2afb4f8ff5e4957894ae1d0fdf7adb2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=8Zm2q8XxEWnoko1dFftJyf3WWQs%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-9">检查依赖</h2>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">$</span><span class="bash">KYLIN_HOME/bin/check-env.sh</span>
</code></pre>
<p>我这里报错了，可能是之前的环境变量有问题：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fafede4e3c143f88d7a3b118cd93d59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=Sx8CNWTCQ7fzj13pV3a8lxa4oXw%3D" alt="在这里插入图片描述" loading="lazy"/>
我找了一圈，看到 Flink YARN 这里HADOOP_CONF_DIR可能配置错了：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">Flink YRAN</span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-built_in">export</span> HADOOP_CONF_DIR=<span class="hljs-variable">$HADOOP_HOME</span></span>
export HADOOP_CONF_DIR=$HADOOP_HOME/etc/hadoop
export YARN_CONF_DIR=$HADOOP_HOME/etc/hadoop
export HADOOP_CLASSPATH=`hadoop classpath`
</code></pre>
<p>修改完的结果为如下：（这里我暂时注释了，防止我的FlinkYRAN以后不能用了）
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dfa37adbd5fd4bb1b231eeca9b7ebc1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=WmNCPmbKH7mEboX7G3lbJ0skoog%3D" alt="在这里插入图片描述" loading="lazy"/>
重新进行测试环境，检查顺利通过，看里边还有一些和Flink、Kafka的配置等，你需要的话可以加入：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12e120f9be704d19a9bf17cf4f0f9925~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=vQxq2uqh21tWz493rOS8TqImmYs%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-10">启动集群</h2>
<h3 data-id="heading-11">ZooKeeper</h3>
<p>启动 h121 h122 h123集群模式
需要每个节点都运行</p>
<pre><code class="hljs language-shell" lang="shell">zkServer.sh start
</code></pre>
<h3 data-id="heading-12">HDFS</h3>
<p>启动 h121 h122 h123
h121运行即可，但是要检查确认</p>
<pre><code class="hljs language-shell" lang="shell">start-dfs.sh
</code></pre>
<h3 data-id="heading-13">YRAN</h3>
<p>启动 h121 h122 h123
h121运行即可，但是要检查确认</p>
<pre><code class="hljs language-shell" lang="shell">start-yarn.sh
</code></pre>
<h3 data-id="heading-14">HBase</h3>
<p>启动 h121 h122 h123
h121运行即可，但是要检查确认</p>
<pre><code class="hljs language-shell" lang="shell">start-hbase.sh
</code></pre>
<h3 data-id="heading-15">Metastore</h3>
<p>启动 h121 即可</p>
<pre><code class="hljs language-shell" lang="shell">nohup hive --service metastore &gt; /tmp/metastore.log 2&gt;&amp;1 &amp;
</code></pre>
<p>运行结果如下图：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ffb7939bc3846a0acbc1d8b84843109~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=GUYZp4KuYQDK4KkwtHkd1P2ISq4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-16">history server</h3>
<p>启动 h121 即可</p>
<pre><code class="hljs language-shell" lang="shell">mr-jobhistory-daemon.sh start historyserver
</code></pre>
<h3 data-id="heading-17">Kylin</h3>
<p>启动 h122</p>
<pre><code class="hljs language-shell" lang="shell">kylin.sh start
</code></pre>
<p>运行过程如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d81ad5eb227743e6ad53b0a2b9394802~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=4qkGuuD2QA2h51Y6x49Jaiw%2FdCU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-18">节点详情</h2>
<h3 data-id="heading-19">h121</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fb8b908b45843a5925bd165d26e8b79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=PLl7ZoB5kNiMzTfj98wqdn7bbrg%3D" alt="在这里插入图片描述" loading="lazy"/>
与上图对应一下：</p>
<ul>
<li>Metastore</li>
<li>Zookeeper</li>
<li>HBase</li>
<li>HDFS</li>
<li>JPS跳过</li>
<li>YARN</li>
<li>Hadoop</li>
</ul>
<h3 data-id="heading-20">h122</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5466bd76a6184775961315842b107e10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=hhKbCnb%2F4Ipx7BLrgcVehF1YS9I%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ul>
<li>JPS跳过</li>
<li>YRAN</li>
<li>ZooKeeper</li>
<li>HBase</li>
<li>好像是Kylin</li>
<li>HDFS</li>
</ul>
<h3 data-id="heading-21">h123</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31eca846ce374e18b1bcd0d1bf68ecbb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=Z2BjzHUcSKJNgs3FcRsvBpS4qug%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ul>
<li>YARN</li>
<li>JPS跳过</li>
<li>HBase</li>
<li>ZooKeeper</li>
<li>Hadoop</li>
<li>HDFS</li>
</ul>
<h2 data-id="heading-22">启动结果</h2>
<pre><code class="hljs language-shell" lang="shell">http://h122.wzk.icu:7070/kylin/login
</code></pre>
<p>我们访问之后可以看到如下的内容：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6aee09322c694bc786925d0f898c5513~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=wD6hWVq4fqO1pbDIbf%2BW8LRDvjM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-23">登录进入</h2>
<pre><code class="hljs language-shell" lang="shell">默认都是大写
账号 ADMIN
密码 KYLIN
</code></pre>
<p>登录进入之后，就是如下的结果：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbb21ebedce4477e95973ff719753e48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764208395&amp;x-signature=Fto7G6Rt8AaieLOVPA8BdXVMV9Q%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-24">错误速查</h2>





















































<table><thead><tr><th>症状</th><th>根因定位</th><th>修复</th><th/></tr></thead><tbody><tr><td>check-env.sh 自检失败，提示找不到 Hadoop 配置</td><td>HADOOP_CONF_DIR 指向 $HADOOP_HOME 而非 .../etc/hadoop</td><td>运行自检脚本输出 <code>export HADOOP_CONF_DIR=$HADOOP_HOME/etc/hadoop &amp;&amp; export YARN_CONF_DIR=$HADOOP_HOME/etc/hadoop &amp;&amp; export HADOOP_CLASSPATH=\</code>hadoop classpath`<code>后</code>source /etc/profile` 重新自检</td><td/></tr><tr><td>Kylin 启动后连接 HBase 报 ZK 相关异常</td><td>hbase.zookeeper.quorum 误写成 host1:2181,host2:2181</td><td>将 quorum 改为仅主机名（如 host1,host2），重启 HBase 与 Kylin</td><td/></tr><tr><td>访问 :7070 无响应/拒连</td><td>Kylin 未成功拉起；或防火墙/端口未放行</td><td>ps -ef</td><td>grep Kylin、netstat -lntp 检查服务状态与端口</td></tr><tr><td>各类 "No FileSystem for scheme: hdfs"/找不到配置</td><td>$KYLIN_HOME/conf 缺少软链到 Hadoop/HBase/Hive/Spark 配置目录</td><td>检查 $KYLIN_HOME/conf 依照文中命令补齐 core/hdfs/hbase/hive/spark 的软链并重启</td><td/></tr><tr><td>Hive Metastore 连接拒绝/NoSuchObjectException</td><td>未启动 Metastore 或 9083 被占用</td><td>检查 <code>/tmp/metastore.log</code>、`netstat -lntp</td><td>grep 9083`</td></tr><tr><td>登录失败/账号密码不对</td><td>账号密码大小写错误或自定义覆盖</td><td>使用默认大写 ADMIN/KYLIN；如改过，在 conf 内确认账号策略并重置</td><td/></tr><tr><td>启动时报 JDK 版本不兼容（常见于旧栈）</td><td>使用了非 JDK8</td><td>切换至 JDK8 并确保 JAVA_HOME 与 PATH 指向一致</td><td/></tr></tbody></table>
<h2 data-id="heading-25">其他系列</h2>
<h3 data-id="heading-26">🚀 AI篇持续更新中（长期更新）</h3>
<p><strong>AI炼丹日志-29 - 字节跳动 DeerFlow 深度研究框<em>斜体样式</em>架 私有部署 测试上手 架构研究</strong>，持续打造实用AI工具指南！
<strong>AI研究-127 Qwen2.5-Omni 深解：Thinker-Talker 双核、TMRoPE 与流式语音</strong></p>
<h3 data-id="heading-27">💻 Java篇持续更新中（长期更新）</h3>
<p><strong>Java-174 FastFDS 从单机到分布式文件存储：实战与架构取舍</strong>
MyBatis 已完结，Spring 已完结，Nginx已完结，Tomcat已完结，分布式服务已完结，Dubbo已完结，MySQL已完结，MongoDB已完结，Neo4j已完结，FastDFS 正在更新，深入浅出助你打牢基础！</p>
<h3 data-id="heading-28">📊 大数据板块已完成多项干货更新（300篇）：</h3>
<p>包括 Hadoop、Hive、Kafka、Flink、ClickHouse、Elasticsearch 等二十余项核心组件，覆盖离线+实时数仓全栈！
<strong>大数据-278 Spark MLib - 基础介绍 机器学习算法 梯度提升树 GBDT案例 详解</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C#运算符与表达式终极指南：从入门到精通的万字长文]]></title>    <link>https://juejin.cn/post/7574529034647289908</link>    <guid>https://juejin.cn/post/7574529034647289908</guid>    <pubDate>2025-11-20T01:55:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574529034647289908" data-draft-id="7573670400153092148" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C#运算符与表达式终极指南：从入门到精通的万字长文"/> <meta itemprop="keywords" content="前端,C#"/> <meta itemprop="datePublished" content="2025-11-20T01:55:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="烛阴"/> <meta itemprop="url" content="https://juejin.cn/user/950397795841032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C#运算符与表达式终极指南：从入门到精通的万字长文
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/950397795841032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    烛阴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T01:55:39.000Z" title="Thu Nov 20 2025 01:55:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、什么是运算符与表达式？</h2>
<ul>
<li><strong>运算符（Operator）</strong>：是一种特殊的符号，用于执行特定的数学、逻辑或位运算。例如 <code>+</code> 是加法运算符，<code>==</code> 是相等运算符。</li>
<li><strong>操作数（Operand）</strong>：是参与运算的数据。例如，在 <code>5 + 3</code> 中，<code>5</code> 和 <code>3</code> 就是操作数。</li>
<li><strong>表达式（Expression）</strong>：是由操作数和运算符组成的序列，其计算结果会产生一个新值。例如 <code>5 + 3</code> 是一个表达式，它的计算结果是 <code>8</code>。<code>x &gt; y</code> 也是一个表达式，它的计算结果是 <code>true</code> 或 <code>false</code>。</li>
</ul>
<p><strong>表达式是C#程序的基本执行单元。</strong> 理解它们，就是理解程序如何思考。</p>
<hr/>
<h2 data-id="heading-1">二、基础运算符</h2>
<h3 data-id="heading-2">1. 算术运算符</h3>
<p>它们负责处理基本的数学计算，与你在小学数学课上学到的几乎一样。</p>









































<table><thead><tr><th align="center">运算符</th><th align="center">名称</th><th align="left">示例</th><th align="left">结果</th></tr></thead><tbody><tr><td align="center"><code>+</code></td><td align="center">加法</td><td align="left"><code>10 + 5</code></td><td align="left"><code>15</code></td></tr><tr><td align="center"><code>-</code></td><td align="center">减法</td><td align="left"><code>10 - 5</code></td><td align="left"><code>5</code></td></tr><tr><td align="center"><code>*</code></td><td align="center">乘法</td><td align="left"><code>10 * 5</code></td><td align="left"><code>50</code></td></tr><tr><td align="center"><code>/</code></td><td align="center">除法</td><td align="left"><code>10 / 5</code></td><td align="left"><code>2</code></td></tr><tr><td align="center"><code>%</code></td><td align="center">取模 (求余数)</td><td align="left"><code>10 % 3</code></td><td align="left"><code>1</code></td></tr></tbody></table>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">int</span> a = <span class="hljs-number">10</span>;
<span class="hljs-built_in">int</span> b = <span class="hljs-number">3</span>;

Console.WriteLine(<span class="hljs-string">$"加法: <span class="hljs-subst">{a + b}</span>"</span>);       <span class="hljs-comment">// 输出: 13</span>
Console.WriteLine(<span class="hljs-string">$"减法: <span class="hljs-subst">{a - b}</span>"</span>);       <span class="hljs-comment">// 输出: 7</span>
Console.WriteLine(<span class="hljs-string">$"乘法: <span class="hljs-subst">{a * b}</span>"</span>);       <span class="hljs-comment">// 输出: 30</span>
Console.WriteLine(<span class="hljs-string">$"除法: <span class="hljs-subst">{a / b}</span>"</span>);       <span class="hljs-comment">// 输出: 3 (注意：整数除法)</span>
Console.WriteLine(<span class="hljs-string">$"取模: <span class="hljs-subst">{a % b}</span>"</span>);       <span class="hljs-comment">// 输出: 1</span>
</code></pre>
<blockquote>
<p><strong>注意事项：整数除法</strong></p>
<p>当两个整数相除时，结果也是一个整数，小数部分会被直接<strong>截断</strong>（不是四舍五入）。例如 <code>10 / 3</code> 的结果是 <code>3</code>。如果你想得到精确的小数结果，至少要有一个操作数是浮点类型。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">double</span> result = <span class="hljs-number">10.0</span> / <span class="hljs-number">3</span>; <span class="hljs-comment">// 结果是 3.333...</span>
<span class="hljs-built_in">double</span> result2 = (<span class="hljs-built_in">double</span>)<span class="hljs-number">10</span> / <span class="hljs-number">3</span>; <span class="hljs-comment">// 结果也是 3.333...</span>
</code></pre>
</blockquote>
<h3 data-id="heading-3">2. 赋值运算符</h3>
<p>赋值运算符用于给变量分配一个值。最基本的是 <code>=</code>，但C#提供了一系列复合赋值运算符，让代码更简洁。</p>








































<table><thead><tr><th align="center">运算符</th><th align="center">示例</th><th align="center">等价于</th></tr></thead><tbody><tr><td align="center"><code>=</code></td><td align="center"><code>x = 5</code></td><td align="center"><code>x = 5</code></td></tr><tr><td align="center"><code>+=</code></td><td align="center"><code>x += 5</code></td><td align="center"><code>x = x + 5</code></td></tr><tr><td align="center"><code>-=</code></td><td align="center"><code>x -= 5</code></td><td align="center"><code>x = x - 5</code></td></tr><tr><td align="center"><code>*=</code></td><td align="center"><code>x *= 5</code></td><td align="center"><code>x = x * 5</code></td></tr><tr><td align="center"><code>/=</code></td><td align="center"><code>x /= 5</code></td><td align="center"><code>x = x / 5</code></td></tr><tr><td align="center"><code>%=</code></td><td align="center"><code>x %= 5</code></td><td align="center"><code>x = x % 5</code></td></tr></tbody></table>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">int</span> score = <span class="hljs-number">100</span>;
score += <span class="hljs-number">10</span>; <span class="hljs-comment">// score 现在是 110</span>
score -= <span class="hljs-number">20</span>; <span class="hljs-comment">// score 现在是 90</span>
score *= <span class="hljs-number">2</span>;  <span class="hljs-comment">// score 现在是 180</span>
score /= <span class="hljs-number">3</span>;  <span class="hljs-comment">// score 现在是 60</span>
</code></pre>
<p>使用复合赋值运算符不仅代码更短，而且可读性更好，是专业代码的标志之一。</p>
<h3 data-id="heading-4">3. 一元运算符</h3>
<p>这些运算符只需要一个操作数。</p>



































<table><thead><tr><th align="center">运算符</th><th align="center">名称</th><th align="left">示例</th><th align="left">描述</th></tr></thead><tbody><tr><td align="center"><code>+</code></td><td align="center">正号</td><td align="left"><code>+5</code></td><td align="left">表示一个正数 (通常省略)</td></tr><tr><td align="center"><code>-</code></td><td align="center">负号</td><td align="left"><code>-5</code></td><td align="left">表示一个负数 (取反)</td></tr><tr><td align="center"><code>++</code></td><td align="center">递增</td><td align="left"><code>x++</code> 或 <code>++x</code></td><td align="left">将变量的值加1</td></tr><tr><td align="center"><code>--</code></td><td align="center">递减</td><td align="left"><code>x--</code> 或 <code>--x</code></td><td align="left">将变量的值减1</td></tr></tbody></table>
<p><code>++</code> 和 <code>--</code> 有两种形式：<strong>前缀</strong>和<strong>后缀</strong>，它们的区别在于<strong>表达式求值的时机</strong>。</p>
<ul>
<li><strong>前缀 (Prefix) <code>++x</code></strong>: 先将 <code>x</code> 的值加1，然后返回<strong>加1后</strong>的值。</li>
<li><strong>后缀 (Postfix) <code>x++</code></strong>: 先返回 <code>x</code> 的<strong>原始值</strong>，然后再将 <code>x</code> 的值加1。</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">int</span> i = <span class="hljs-number">5</span>;
<span class="hljs-built_in">int</span> j = <span class="hljs-number">5</span>;

<span class="hljs-comment">// 前缀：先自增，再赋值</span>
<span class="hljs-built_in">int</span> prefixResult = ++i; <span class="hljs-comment">// i 变成 6, prefixResult 也被赋值为 6</span>
Console.WriteLine(<span class="hljs-string">$"i: <span class="hljs-subst">{i}</span>, prefixResult: <span class="hljs-subst">{prefixResult}</span>"</span>); <span class="hljs-comment">// 输出: i: 6, prefixResult: 6</span>

<span class="hljs-comment">// 后缀：先赋值，再自增</span>
<span class="hljs-built_in">int</span> postfixResult = j++; <span class="hljs-comment">// postfixResult 被赋值为 5, 然后 j 变成 6</span>
Console.WriteLine(<span class="hljs-string">$"j: <span class="hljs-subst">{j}</span>, postfixResult: <span class="hljs-subst">{postfixResult}</span>"</span>); <span class="hljs-comment">// 输出: j: 6, postfixResult: 5</span>
</code></pre>
<hr/>
<h2 data-id="heading-5">三、逻辑与比较</h2>
<h3 data-id="heading-6">1. 关系运算符</h3>
<p>也叫比较运算符，用于比较两个操作数，其结果总是一个布尔值 (<code>true</code> 或 <code>false</code>)。</p>















































<table><thead><tr><th align="center">运算符</th><th align="center">名称</th><th align="left">示例</th><th align="center">结果为<code>true</code>的条件</th></tr></thead><tbody><tr><td align="center"><code>==</code></td><td align="center">等于</td><td align="left"><code>a == b</code></td><td align="center">a 和 b 的值相等</td></tr><tr><td align="center"><code>!=</code></td><td align="center">不等于</td><td align="left"><code>a != b</code></td><td align="center">a 和 b 的值不相等</td></tr><tr><td align="center"><code>&gt;</code></td><td align="center">大于</td><td align="left"><code>a &gt; b</code></td><td align="center">a 的值大于 b</td></tr><tr><td align="center"><code>&lt;</code></td><td align="center">小于</td><td align="left"><code>a &lt; b</code></td><td align="center">a 的值小于 b</td></tr><tr><td align="center"><code>&gt;=</code></td><td align="center">大于等于</td><td align="left"><code>a &gt;= b</code></td><td align="center">a 的值大于或等于 b</td></tr><tr><td align="center"><code>&lt;=</code></td><td align="center">小于等于</td><td align="left"><code>a &lt;= b</code></td><td align="center">a 的值小于或等于 b</td></tr></tbody></table>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">int</span> age = <span class="hljs-number">20</span>;
<span class="hljs-built_in">bool</span> isAdult = age &gt;= <span class="hljs-number">18</span>; <span class="hljs-comment">// isAdult 的值为 true</span>
<span class="hljs-built_in">bool</span> isVoter = age == <span class="hljs-number">21</span>; <span class="hljs-comment">// isVoter 的值为 false</span>
</code></pre>
<p>这些运算符是 <code>if</code> 语句、<code>while</code> 循环等所有控制流语句的核心。</p>
<h3 data-id="heading-7">2. 逻辑运算符</h3>
<p>用于组合多个布尔表达式，构建更复杂的判断逻辑。</p>

































<table><thead><tr><th align="center">运算符</th><th align="center">名称</th><th align="center">示例</th><th align="left">描述</th></tr></thead><tbody><tr><td align="center"><code>!</code></td><td align="center">逻辑非 (NOT)</td><td align="center"><code>!isValid</code></td><td align="left">如果操作数为<code>true</code>，结果为<code>false</code>；反之亦然</td></tr><tr><td align="center"><code>&amp;&amp;</code></td><td align="center">逻辑与 (AND)</td><td align="center"><code>isLogin &amp;&amp; isAdmin</code></td><td align="left">两个操作数都为<code>true</code>时，结果才为<code>true</code></td></tr><tr><td align="center">`</td><td align="center"/><td align="center">`</td><td align="left">逻辑或 (OR)</td><td>`isMember</td><td/><td>isVIP`</td><td>只要有一个操作数为<code>true</code>，结果就为<code>true</code></td></tr></tbody></table>
<p><strong>短路求值 (Short-circuiting)</strong></p>
<p><code>&amp;&amp;</code> 和 <code>||</code> 有一个非常重要的特性叫“短路”。</p>
<ul>
<li>对于 <code>expr1 &amp;&amp; expr2</code>：如果 <code>expr1</code> 的计算结果为 <code>false</code>，那么整个表达式的结果必定是 <code>false</code>，此时 <code>expr2</code> <strong>将不会被计算</strong>。</li>
<li>对于 <code>expr1 || expr2</code>：如果 <code>expr1</code> 的计算结果为 <code>true</code>，那么整个表达式的结果必定是 <code>true</code>，此时 <code>expr2</code> <strong>将不会被计算</strong>。</li>
</ul>
<p>这个特性非常有用，常用于避免空引用异常或减少不必要的计算：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">string</span> name = <span class="hljs-literal">null</span>;

<span class="hljs-comment">// 如果不使用短路，当 name 为 null 时，name.Length 会抛出 NullReferenceException</span>
<span class="hljs-comment">// if (name != null &amp; name.Length &gt; 0) { ... }  // 注意这里是 &amp;，非短路</span>

<span class="hljs-comment">// 使用短路 &amp;&amp;，当 name 为 null 时，第一个条件为 false，第二个条件根本不会执行，非常安全</span>
<span class="hljs-keyword">if</span> (name != <span class="hljs-literal">null</span> &amp;&amp; name.Length &gt; <span class="hljs-number">0</span>)
{
    Console.WriteLine(<span class="hljs-string">"Name is not empty."</span>);
}
</code></pre>
<hr/>
<h2 data-id="heading-8">四、位运算符</h2>









































<table><thead><tr><th align="center">运算符</th><th align="center">名称</th><th align="left">描述</th></tr></thead><tbody><tr><td align="center"><code>&amp;</code></td><td align="center">按位与</td><td align="left">两个操作数中，对应位都为1时，结果位才为1</td></tr><tr><td align="center">`</td><td align="center">`</td><td align="left">按位或</td><td>两个操作数中，对应位只要有一个为1，结果位就为1</td></tr><tr><td align="center"><code>^</code></td><td align="center">按位异或</td><td align="left">两个操作数中，对应位不同时，结果位为1</td></tr><tr><td align="center"><code>~</code></td><td align="center">按位取反</td><td align="left">单目运算符，将操作数的所有位反转 (0变1，1变0)</td></tr><tr><td align="center"><code>&lt;&lt;</code></td><td align="center">左移</td><td align="left">将操作数的所有位向左移动指定的位数，右侧补0</td></tr><tr><td align="center"><code>&gt;&gt;</code></td><td align="center">右移</td><td align="left">将操作数的所有位向右移动指定的位数</td></tr></tbody></table>
<p><strong>应用场景：权限管理</strong>
枚举经常与位运算符结合，用于管理一组开关状态（Flags）。</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">Flags</span>]
<span class="hljs-keyword">public</span> <span class="hljs-built_in">enum</span> Permissions
{
    None = <span class="hljs-number">0</span>,       <span class="hljs-comment">// 0000</span>
    Read = <span class="hljs-number">1</span>,       <span class="hljs-comment">// 0001</span>
    Write = <span class="hljs-number">2</span>,      <span class="hljs-comment">// 0010</span>
    Execute = <span class="hljs-number">4</span>,    <span class="hljs-comment">// 0100</span>
    All = Read | Write | Execute <span class="hljs-comment">// 0111</span>
}

Permissions userPermissions = Permissions.Read | Permissions.Write;

<span class="hljs-comment">// 检查是否包含写权限</span>
<span class="hljs-keyword">if</span> ((userPermissions &amp; Permissions.Write) == Permissions.Write)
{
    Console.WriteLine(<span class="hljs-string">"User has Write permission."</span>);
}

<span class="hljs-comment">// 添加执行权限</span>
userPermissions |= Permissions.Execute;

<span class="hljs-comment">// 移除写权限</span>
userPermissions &amp;= ~Permissions.Write;
</code></pre>
<hr/>
<h2 data-id="heading-9">五、那些强大的“语法糖”</h2>
<p>随着C#语言的演进，出现了许多新的运算符，它们极大地简化了代码，使其更具表现力和健壮性。</p>
<h3 data-id="heading-10">1. Null 合并运算符 (<code>??</code> 和 <code>??=</code>)</h3>
<p>用于处理 <code>null</code> 值的利器。</p>
<ul>
<li><strong><code>??</code> (Null-Coalescing Operator)</strong>: <code>a ?? b</code>
如果 <code>a</code> 不为 <code>null</code>，则表达式的结果是 <code>a</code>；如果 <code>a</code> 为 <code>null</code>，则结果是 <code>b</code>。</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">string</span> userName = <span class="hljs-literal">null</span>;
<span class="hljs-built_in">string</span> displayName = userName ?? <span class="hljs-string">"Guest"</span>; <span class="hljs-comment">// displayName 的值将是 "Guest"</span>

<span class="hljs-built_in">string</span> userName2 = <span class="hljs-string">"Admin"</span>;
<span class="hljs-built_in">string</span> displayName2 = userName2 ?? <span class="hljs-string">"Guest"</span>; <span class="hljs-comment">// displayName2 的值将是 "Admin"</span>
</code></pre>
<p>这完美地替代了冗长的 <code>if</code> 或三元表达式 <code>(userName != null) ? userName : "Guest"</code>。</p>
<ul>
<li><strong><code>??=</code> (Null-Coalescing Assignment Operator)</strong> (C# 8.0+)
<code>variable ??= value</code>
仅当 <code>variable</code> 为 <code>null</code> 时，才将 <code>value</code> 赋给 <code>variable</code>。</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">List&lt;<span class="hljs-built_in">int</span>&gt; numbers = <span class="hljs-literal">null</span>;
numbers ??= <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">int</span>&gt;(); <span class="hljs-comment">// 因为 numbers 是 null，所以为其创建一个新实例</span>

numbers.Add(<span class="hljs-number">1</span>);

numbers ??= <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">int</span>&gt;(); <span class="hljs-comment">// 因为 numbers 不再是 null，所以这条语句什么也不做</span>
</code></pre>
<p>这对于延迟初始化（Lazy Initialization）非常有用。</p>
<h3 data-id="heading-11">2. Null 条件运算符 (<code>?.</code> 和 <code>?[]</code>)</h3>
<p>用于优雅地避免 <code>NullReferenceException</code>，告别层层嵌套的 <code>if (obj != null)</code> 检查。</p>
<ul>
<li><strong><code>?.</code> (Null-Conditional Member Access)</strong>:
在访问对象成员（方法或属性）之前，检查对象是否为 <code>null</code>。如果是 <code>null</code>，整个表达式直接返回 <code>null</code>，而不会抛出异常。</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">string</span> street = <span class="hljs-string">""</span>;

User user = <span class="hljs-literal">null</span>; <span class="hljs-comment">// GetUser();</span>


<span class="hljs-comment">// 传统方式，需要层层检查</span>
<span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>)
{
    <span class="hljs-keyword">if</span> (user.UserAddress != <span class="hljs-literal">null</span>)
    {
        street = user.UserAddress.Street;
    }
}

<span class="hljs-comment">// 使用 ?. 运算符，一行搞定！</span>
<span class="hljs-comment">// 如果 user 或 user.UserAddress 是 null，street 将被赋值为 null</span>
<span class="hljs-built_in">string</span> streetElegant = user?.UserAddress?.Street;


<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">User</span> { <span class="hljs-keyword">public</span> Address UserAddress { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } }
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Address</span> { <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Street { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } }
</code></pre>
<ul>
<li><strong><code>?[]</code> (Null-Conditional Element Access)</strong>:
用于访问数组或索引器。</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">List&lt;<span class="hljs-built_in">string</span>&gt; names = <span class="hljs-literal">null</span>;
<span class="hljs-built_in">string</span> firstName = names?[<span class="hljs-number">0</span>]; <span class="hljs-comment">// 如果 names 为 null，firstName 为 null，不抛异常</span>
</code></pre>
<h3 data-id="heading-12">3. 条件运算符 (<code>?:</code>) - 三元表达式</h3>
<p>它是 <code>if-else</code> 语句的紧凑形式，适用于简单的条件赋值。</p>
<p><strong>语法</strong>: <code>condition ? first_expression : second_expression;</code>
如果 <code>condition</code> 为 <code>true</code>，则计算 <code>first_expression</code> 并将其作为结果；否则计算 <code>second_expression</code>。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">int</span> age = <span class="hljs-number">20</span>;
<span class="hljs-built_in">string</span> status = (age &gt;= <span class="hljs-number">18</span>) ? <span class="hljs-string">"Adult"</span> : <span class="hljs-string">"Minor"</span>; <span class="hljs-comment">// status 的值为 "Adult"</span>
</code></pre>
<h3 data-id="heading-13">4. 类型相关运算符</h3>






























<table><thead><tr><th align="center">运算符</th><th align="center">名称</th><th align="left">描述</th></tr></thead><tbody><tr><td align="center"><code>is</code></td><td align="center">类型判断</td><td align="left">检查对象是否与给定类型兼容，返回布尔值。C# 7.0+支持模式匹配。</td></tr><tr><td align="center"><code>as</code></td><td align="center">类型转换</td><td align="left">尝试将对象转换为指定类型，如果转换失败，返回<code>null</code>而不是抛出异常。</td></tr><tr><td align="center"><code>typeof</code></td><td align="center">获取类型</td><td align="left">返回一个表示类型的 <code>System.Type</code> 对象。</td></tr><tr><td align="center"><code>sizeof</code></td><td align="center">获取大小</td><td align="left">（仅限非托管类型）返回给定类型值在内存中占用的字节数。</td></tr></tbody></table>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">object</span> obj = <span class="hljs-string">"Hello World"</span>;

<span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">is</span> <span class="hljs-built_in">string</span>)
{
    Console.WriteLine(<span class="hljs-string">"It's a string."</span>);
}

<span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">is</span> <span class="hljs-built_in">string</span> s) <span class="hljs-comment">// 如果是string，则直接转换并赋值给 s</span>
{
    Console.WriteLine(<span class="hljs-string">$"The string has <span class="hljs-subst">{s.Length}</span> characters."</span>);
}

<span class="hljs-built_in">string</span> str = obj <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 转换成功，str 为 "Hello World"</span>
StringBuilder sb = obj <span class="hljs-keyword">as</span> StringBuilder; <span class="hljs-comment">// 转换失败，sb 为 null</span>
</code></pre>
<hr/>
<h2 data-id="heading-14">六、运算符的规则 - 优先级与结合性</h2>
<p>当一个表达式中包含多个运算符时，谁先计算？这就是**优先级（Precedence）<strong>和</strong>结合性（Associativity）**要解决的问题。</p>
<ul>
<li><strong>优先级</strong>：决定了不同运算符的计算顺序。例如，<code>*</code> 和 <code>/</code> 的优先级高于 <code>+</code> 和 <code>-</code>，所以 <code>2 + 3 * 4</code> 的结果是 <code>14</code> 而不是 <code>20</code>。</li>
<li><strong>结合性</strong>：当多个具有相同优先级的运算符在一起时，决定它们的计算方向。
<ul>
<li><strong>左结合性 (Left-associative)</strong>：从左到右计算。例如 <code>a - b - c</code> 等价于 <code>(a - b) - c</code>。大多数二元运算符都是左结合的。</li>
<li><strong>右结合性 (Right-associative)</strong>：从右到左计算。例如赋值运算符 <code>a = b = c</code> 等价于 <code>a = (b = c)</code>。三元运算符也是右结合的。</li>
</ul>
</li>
</ul>
<p><strong>C#运算符优先级（由高到低摘录）</strong></p>
<ol>
<li><strong>主要</strong>: <code>x.y</code>, <code>f(x)</code>, <code>a[i]</code>, <code>x++</code>, <code>x--</code>, <code>new</code>, <code>typeof</code>, <code>sizeof</code></li>
<li><strong>一元</strong>: <code>+</code>, <code>-</code>, <code>!</code>, <code>~</code>, <code>++x</code>, <code>--x</code>, <code>(T)x</code></li>
<li><strong>乘法</strong>: <code>*</code>, <code>/</code>, <code>%</code></li>
<li><strong>加法</strong>: <code>+</code>, <code>-</code></li>
<li><strong>移位</strong>: <code>&lt;&lt;</code>, <code>&gt;&gt;</code></li>
<li><strong>关系</strong>: <code>&lt;</code>, <code>&gt;</code>, <code>&lt;=</code>, <code>&gt;=</code>, <code>is</code>, <code>as</code></li>
<li><strong>相等</strong>: <code>==</code>, <code>!=</code></li>
<li><strong>位与</strong>: <code>&amp;</code></li>
<li><strong>位异或</strong>: <code>^</code></li>
<li><strong>位或</strong>: <code>|</code></li>
<li><strong>逻辑与</strong>: <code>&amp;&amp;</code></li>
<li><strong>逻辑或</strong>: <code>||</code></li>
<li><strong>Null合并</strong>: <code>??</code></li>
<li><strong>条件</strong>: <code>?:</code></li>
<li><strong>赋值与Lambda</strong>: <code>=</code>, <code>*=</code>, <code>/=</code>, <code>+=</code>, <code>-=</code>, <code>=&gt;</code></li>
</ol>
<h2 data-id="heading-15">结语</h2>
<p><strong>点个赞，关注我获取更多实用 C# 技术干货！如果觉得有用，记得收藏本文！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[让弹幕飞一会儿！一个轻量级iOS弹幕库的实现与使用]]></title>    <link>https://juejin.cn/post/7574253222606897193</link>    <guid>https://juejin.cn/post/7574253222606897193</guid>    <pubDate>2025-11-19T11:15:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574253222606897193" data-draft-id="7574281453706985478" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="让弹幕飞一会儿！一个轻量级iOS弹幕库的实现与使用"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-19T11:15:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="StarkCoder"/> <meta itemprop="url" content="https://juejin.cn/user/207173399875662"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            让弹幕飞一会儿！一个轻量级iOS弹幕库的实现与使用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/207173399875662/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    StarkCoder
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T11:15:49.000Z" title="Wed Nov 19 2025 11:15:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🚀 让弹幕飞一会儿！一个轻量级iOS弹幕库的实现与使用</h2>
<blockquote>
<p>本文完整源码地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fchengshixin%2FBarrageView" target="_blank" title="https://github.com/chengshixin/BarrageView" ref="nofollow noopener noreferrer">github.com/chengshixin…</a></p>
</blockquote>
<h3 data-id="heading-1">🎯 前言</h3>
<p>"前方高能！"、"233333"、"awsl"... 这些熟悉的弹幕是不是让你想起了在B站追番的快乐时光？弹幕已经成为现代视频应用的标配功能，它不仅能够增强用户互动，还能创造独特的社区氛围。</p>
<p>今天，我要为大家介绍一个我自己开发的轻量级iOS弹幕库——<strong>BarrageView</strong>！这个库不仅功能丰富，而且代码优雅，绝对是你在iOS应用中集成弹幕功能的不二之选！</p>
<h3 data-id="heading-2">✨ 功能特色</h3>
<h4 data-id="heading-3">🎮 四大弹幕方向</h4>
<ul>
<li><strong>从右到左</strong>：经典模式，B站同款</li>
<li><strong>从左到右</strong>：反向思维，别具一格</li>
<li><strong>从上到下</strong>：竖屏专属，瀑布流效果</li>
<li><strong>从下到上</strong>：逆流而上，视觉冲击</li>
</ul>
<h4 data-id="heading-4">🔄 两种播放模式</h4>
<ul>
<li><strong>单次播放</strong>：适合展示重要信息</li>
<li><strong>循环播放</strong>：营造持续的热闹氛围</li>
</ul>
<h4 data-id="heading-5">🎨 全面自定义</h4>
<ul>
<li>字体大小、颜色随心配</li>
<li>背景透明度自由调节</li>
<li>移动速度精准控制</li>
<li>弹幕间距智能避让</li>
</ul>
<h3 data-id="heading-6">🛠 快速上手</h3>
<h4 data-id="heading-7">基本使用</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 创建弹幕视图</span>
<span class="hljs-keyword">let</span> barrageView <span class="hljs-operator">=</span> <span class="hljs-type">BarrageView</span>(frame: <span class="hljs-type">CGRect</span>(x: <span class="hljs-number">0</span>, y: <span class="hljs-number">100</span>, width: view.bounds.width, height: <span class="hljs-number">200</span>))

<span class="hljs-comment">// 设置弹幕数据</span>
barrageView.setBarrageData([
    <span class="hljs-string">"前方高能预警！"</span>,
    <span class="hljs-string">"这个功能太棒了！"</span>,
    <span class="hljs-string">"iOS开发者福音"</span>,
    <span class="hljs-string">"已star，感谢作者"</span>
])

<span class="hljs-comment">// 开始播放</span>
barrageView.startBarrage()
</code></pre>
<h4 data-id="heading-8">高级配置</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 自定义样式和效果</span>
barrageView.setDirection(.rightToLeft)
barrageView.setPlayMode(.loop)
barrageView.setSpeed(<span class="hljs-number">80.0</span>)
barrageView.setFontSize(<span class="hljs-number">18.0</span>)
barrageView.setTextColor(.red)
barrageView.setTextBackgroundColor(<span class="hljs-type">UIColor</span>.black.withAlphaComponent(<span class="hljs-number">0.8</span>))
</code></pre>
<h3 data-id="heading-9">🔧 核心实现原理</h3>
<h4 data-id="heading-10">🎪 弹幕调度机制</h4>
<p>BarrageView采用<strong>定时器+动画</strong>的双重调度机制：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 定时器负责生成新弹幕</span>
timer <span class="hljs-operator">=</span> <span class="hljs-type">Timer</span>.scheduledTimer(withTimeInterval: <span class="hljs-number">2.0</span>, repeats: <span class="hljs-literal">true</span>) { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] <span class="hljs-keyword">_</span> <span class="hljs-keyword">in</span>
    <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.createBarrageLabel()
}

<span class="hljs-comment">// UIView动画负责移动效果</span>
<span class="hljs-type">UIView</span>.animate(withDuration: duration, delay: <span class="hljs-number">0</span>, options: .curveLinear) {
    label.frame.origin <span class="hljs-operator">=</span> endPoint
}
</code></pre>
<h4 data-id="heading-11">🚦 智能避让算法</h4>
<p>为了防止弹幕重叠，我们实现了智能的位置检测：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">isYPositionOccupied</span>(<span class="hljs-params">y</span>: <span class="hljs-type">CGFloat</span>, <span class="hljs-params">labelHeight</span>: <span class="hljs-type">CGFloat</span>) -&gt; <span class="hljs-type">Bool</span> {
    <span class="hljs-keyword">for</span> label <span class="hljs-keyword">in</span> activeLabels {
        <span class="hljs-keyword">let</span> labelMinY <span class="hljs-operator">=</span> label.frame.minY <span class="hljs-operator">-</span> <span class="hljs-number">10</span>  <span class="hljs-comment">// 预留安全间距</span>
        <span class="hljs-keyword">let</span> labelMaxY <span class="hljs-operator">=</span> label.frame.maxY <span class="hljs-operator">+</span> <span class="hljs-number">10</span>
        
        <span class="hljs-keyword">if</span> y <span class="hljs-operator">&gt;</span> labelMinY <span class="hljs-operator">&amp;&amp;</span> y <span class="hljs-operator">&lt;</span> labelMaxY {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>  <span class="hljs-comment">// 位置被占用</span>
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>  <span class="hljs-comment">// 位置可用</span>
}
</code></pre>
<h4 data-id="heading-12">⏸️ 流畅的暂停恢复</h4>
<p>通过CALayer扩展实现精准的动画控制：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">extension</span> <span class="hljs-title class_">CALayer</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">pauseAnimation</span>() {
        <span class="hljs-keyword">let</span> pausedTime <span class="hljs-operator">=</span> convertTime(<span class="hljs-type">CACurrentMediaTime</span>(), from: <span class="hljs-literal">nil</span>)
        speed <span class="hljs-operator">=</span> <span class="hljs-number">0.0</span>
        timeOffset <span class="hljs-operator">=</span> pausedTime
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">resumeAnimation</span>() {
        <span class="hljs-keyword">let</span> pausedTime <span class="hljs-operator">=</span> timeOffset
        speed <span class="hljs-operator">=</span> <span class="hljs-number">1.0</span>
        timeOffset <span class="hljs-operator">=</span> <span class="hljs-number">0.0</span>
        beginTime <span class="hljs-operator">=</span> <span class="hljs-number">0.0</span>
        <span class="hljs-keyword">let</span> timeSincePause <span class="hljs-operator">=</span> convertTime(<span class="hljs-type">CACurrentMediaTime</span>(), from: <span class="hljs-literal">nil</span>) <span class="hljs-operator">-</span> pausedTime
        beginTime <span class="hljs-operator">=</span> timeSincePause
    }
}
</code></pre>
<h3 data-id="heading-13">🎨 自定义扩展指南</h3>
<h4 data-id="heading-14">添加弹幕边框</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 在createLabel方法中扩展</span>
label.layer.borderWidth <span class="hljs-operator">=</span> <span class="hljs-number">1.0</span>
label.layer.borderColor <span class="hljs-operator">=</span> <span class="hljs-type">UIColor</span>.orange.cgColor
</code></pre>
<h4 data-id="heading-15">实现渐变背景</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> gradientLayer <span class="hljs-operator">=</span> <span class="hljs-type">CAGradientLayer</span>()
gradientLayer.colors <span class="hljs-operator">=</span> [<span class="hljs-type">UIColor</span>.red.cgColor, <span class="hljs-type">UIColor</span>.blue.cgColor]
gradientLayer.frame <span class="hljs-operator">=</span> label.bounds
label.layer.insertSublayer(gradientLayer, at: <span class="hljs-number">0</span>)
</code></pre>
<h4 data-id="heading-16">添加弹幕阴影</h4>
<pre><code class="hljs language-swift" lang="swift">label.layer.shadowColor <span class="hljs-operator">=</span> <span class="hljs-type">UIColor</span>.black.cgColor
label.layer.shadowOffset <span class="hljs-operator">=</span> <span class="hljs-type">CGSize</span>(width: <span class="hljs-number">2</span>, height: <span class="hljs-number">2</span>)
label.layer.shadowOpacity <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span>
</code></pre>
<h3 data-id="heading-17">📱 实际应用场景</h3>
<h4 data-id="heading-18">🎥 视频播放器</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 在视频播放时启动弹幕</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">videoDidStartPlaying</span>() {
    barrageView.startBarrage()
}

<span class="hljs-keyword">func</span> <span class="hljs-title function_">videoDidPause</span>() {
    barrageView.pauseBarrage()
}

<span class="hljs-keyword">func</span> <span class="hljs-title function_">videoDidResume</span>() {
    barrageView.resumeBarrage()
}
</code></pre>
<h4 data-id="heading-19">🎮 直播互动</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 收到新消息时实时添加弹幕</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">didReceiveNewMessage</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">message</span>: <span class="hljs-type">String</span>) {
    <span class="hljs-keyword">var</span> currentData <span class="hljs-operator">=</span> barrageView.barrageTexts
    currentData.append(message)
    barrageView.setBarrageData(currentData)
}
</code></pre>
<h4 data-id="heading-20">🎉 活动庆典</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 节日特效弹幕</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">setupFestivalBarrage</span>() {
    barrageView.setTextColor(.red)
    barrageView.setFontSize(<span class="hljs-number">20</span>)
    barrageView.setBarrageData(festivalWishes)
}
</code></pre>
<h3 data-id="heading-21">🚀 性能优化技巧</h3>
<h4 data-id="heading-22">内存管理</h4>
<ul>
<li>使用<code>weak self</code>避免循环引用</li>
<li>及时移除完成动画的标签</li>
<li>合理控制同时显示的弹幕数量</li>
</ul>
<h4 data-id="heading-23">动画优化</h4>
<ul>
<li>使用<code>curveLinear</code>保证匀速运动</li>
<li>避免频繁创建销毁对象</li>
<li>复用UILabel减少内存分配</li>
</ul>
<h3 data-id="heading-24">🔮 未来规划</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 支持富文本弹幕</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 添加弹幕点击事件</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 实现3D弹幕效果</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 支持弹幕轨道管理</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 添加弹幕过滤机制</li>
</ul>
<h3 data-id="heading-25">💫 结语</h3>
<p>BarrageView不仅仅是一个工具库，更是我对iOS动画和用户体验的一次深度探索。通过这个项目，我学习到了：</p>
<ul>
<li>🎯 <strong>精准的动画控制</strong>：如何让弹幕平滑移动又不失性能</li>
<li>🧠 <strong>智能的布局算法</strong>：如何避免弹幕间的"交通事故"</li>
<li>🎨 <strong>优雅的代码设计</strong>：如何构建可扩展、易维护的架构</li>
</ul>
<p>如果你对这个项目感兴趣，欢迎：</p>
<p>⭐ <strong>Star</strong> → <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fchengshixin%2FBarrageView" target="_blank" title="https://github.com/chengshixin/BarrageView" ref="nofollow noopener noreferrer">github.com/chengshixin…</a></p>
<p>🐛 <strong>提交Issue</strong> → 反馈bug或提出新功能建议</p>
<p>🔀 <strong>Pull Request</strong> → 一起让这个项目变得更好</p>
<hr/>
<p><strong>让我们的应用也拥有B站一样的弹幕文化吧！</strong> 🎊</p>
<p><em>"弹幕虽小，却能承载万千情感；代码虽简，却能创造无限可能。"</em></p>
<p><em>本文由BarrageView作者撰写，转载请注明出处。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3 源码深度解析：Computed 的完整实现机制]]></title>    <link>https://juejin.cn/post/7574357603405676594</link>    <guid>https://juejin.cn/post/7574357603405676594</guid>    <pubDate>2025-11-20T02:00:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574357603405676594" data-draft-id="7574322843049295922" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3 源码深度解析：Computed 的完整实现机制"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-20T02:00:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="excel"/> <meta itemprop="url" content="https://juejin.cn/user/2911162520062862"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3 源码深度解析：Computed 的完整实现机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2911162520062862/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    excel
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T02:00:49.000Z" title="Thu Nov 20 2025 02:00:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本系列前三篇我们已经拆解了 <code>reactive</code>、<code>collection handlers</code>、<code>effect</code> 体系，本篇继续深入 Vue3 响应式系统的第四个核心：<strong>computed 派生值</strong>。<br/>
本文依旧沿用统一结构：<strong>概念 → 架构 → 核心流程 → 源码逐段解析 → 与 effect 的关系 → 使用示例 → 扩展 → 潜在问题。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、Computed 是什么？（概念篇）</h2>
<p>在 Vue3 的响应式系统中，<code>computed</code> 属于 <strong>派生类型（Derived State）</strong> ：</p>
<ul>
<li>由其他响应式值计算得来</li>
<li>自动追踪依赖</li>
<li>自动缓存（不重复执行 getter）</li>
<li>支持可写/只读两种模式</li>
<li>与 <code>effect</code> 解耦，不再使用 effect 实现</li>
</ul>
<p>在新版实现中，computed 更像一个 <strong>“双重身份单元”</strong> ：</p>
<ul>
<li>作为 <strong>被动目标</strong>：被外部 effect 读取时，需要收集依赖（自身被依赖）</li>
<li>作为 <strong>主动订阅者</strong>：自己要订阅其他响应式源，以便在源更新时“变脏”</li>
</ul>
<p>这种结构使得 computed 更轻、更快、更可控。</p>
<hr/>
<h2 data-id="heading-1">二、Computed 的总体架构</h2>
<p>在 Vue3 中，<code>computed</code> 的主要结构如下：</p>
<pre><code class="hljs language-objectivec" lang="objectivec">ComputedRefImpl
 ├─ _value           <span class="hljs-comment">// 缓存的计算结果</span>
 ├─ fn               <span class="hljs-comment">// getter</span>
 ├─ <span class="hljs-keyword">setter</span>           <span class="hljs-comment">// 可写 computed 才有</span>
 ├─ dep              <span class="hljs-comment">// 哪些 effect 依赖 computed</span>
 ├─ deps / depsTail  <span class="hljs-comment">// computed 依赖哪些 ref/reactive（反向链）</span>
 ├─ flags            <span class="hljs-comment">// 当前 computed 是否 dirty</span>
 ├─ globalVersion    <span class="hljs-comment">// 版本号控制是否要重新计算</span>
 ├─ isSSR            <span class="hljs-comment">// SSR 模式不同逻辑</span>
</code></pre>
<p>其中最关键的是 <strong>flags（dirty） + globalVersion（版本校验）</strong><br/>
这两个共同控制 computed 的缓存刷新逻辑。</p>
<hr/>
<h2 data-id="heading-2">三、核心流程：Computed 的运行机制</h2>
<p>Vue3 中 computed 工作流程可以分为四个步骤：</p>
<hr/>
<h3 data-id="heading-3">1）初始化</h3>
<ul>
<li>创建 <code>ComputedRefImpl</code></li>
<li>记录 getter</li>
<li>若有 setter 则为可写模式</li>
<li>标记为 dirty（需要首次计算）</li>
</ul>
<hr/>
<h3 data-id="heading-4">2）首次访问 <code>.value</code></h3>
<ul>
<li>触发 <code>dep.track()</code> 收集依赖</li>
<li>触发 <code>refreshComputed(this)</code></li>
<li>执行 getter 得到新值</li>
<li>缓存 <code>_value</code></li>
<li>清除 dirty / 更新版本号</li>
</ul>
<hr/>
<h3 data-id="heading-5">3）依赖更新 → 触发 notify()</h3>
<p>如果 computed 所依赖的数据改变：</p>
<ul>
<li>computed.flags |= DIRTY</li>
<li>下一次访问 <code>.value</code> 时会重新执行 getter</li>
</ul>
<hr/>
<h3 data-id="heading-6">4）再次访问 <code>.value</code></h3>
<p>若 dirty = false 且版本号未变：</p>
<p>→ <strong>不重新计算，直接返回缓存</strong></p>
<p>若 dirty = true 或版本号变化：</p>
<p>→ <strong>重新计算</strong></p>
<hr/>
<h2 data-id="heading-7">四、源码逐段解析（与你前三篇风格完全一致）</h2>
<p>以下代码全部来自你给的源码，我将按模块拆解并解释。</p>
<hr/>
<h3 data-id="heading-8">① 依赖导入</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { isFunction } <span class="hljs-keyword">from</span> <span class="hljs-string">'@vue/shared'</span>
<span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">DebuggerEvent</span>,
  <span class="hljs-title class_">DebuggerOptions</span>,
  <span class="hljs-title class_">EffectFlags</span>,
  <span class="hljs-title class_">Subscriber</span>,
  activeSub,
  batch,
  refreshComputed,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'./effect'</span>
<span class="hljs-keyword">import</span> { warn } <span class="hljs-keyword">from</span> <span class="hljs-string">'./warning'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Dep</span>, <span class="hljs-title class_">Link</span>, globalVersion } <span class="hljs-keyword">from</span> <span class="hljs-string">'./dep'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ReactiveFlags</span>, <span class="hljs-title class_">TrackOpTypes</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./constants'</span>
</code></pre>
<h4 data-id="heading-9">解析</h4>
<ul>
<li><code>batch()</code> → 批量通知 effect，避免频繁触发</li>
<li><code>refreshComputed()</code> → computed 的核心刷新逻辑</li>
<li><code>Dep</code> → 用于记录计算属性被哪些 effect 依赖</li>
<li><code>globalVersion</code> → 全局版本号（优化）</li>
</ul>
<p>computed 不再依赖 effect，而是依赖 Dep（更轻量）。</p>
<hr/>
<h3 data-id="heading-10">② ComputedRefImpl 类定义</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ComputedRefImpl</span>&lt;T = <span class="hljs-built_in">any</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Subscriber</span> {
</code></pre>
<p>computed 自身是一个 <strong>Subscriber（订阅者）</strong><br/>
它能订阅其他 reactive/ref。</p>
<hr/>
<h3 data-id="heading-11">③ 内部字段</h3>
<pre><code class="hljs language-ini" lang="ini">_value: <span class="hljs-attr">any</span> = undefined
dep: <span class="hljs-attr">Dep</span> = new Dep(this)
<span class="hljs-attr">__v_isRef</span> = <span class="hljs-literal">true</span>
__v_isReadonly: boolean
deps?: <span class="hljs-attr">Link</span> = undefined
depsTail?: <span class="hljs-attr">Link</span> = undefined
flags: <span class="hljs-attr">EffectFlags</span> = EffectFlags.DIRTY
globalVersion: <span class="hljs-attr">number</span> = globalVersion - <span class="hljs-number">1</span>
isSSR: boolean
</code></pre>
<h4 data-id="heading-12">字段解析</h4>





























<table><thead><tr><th>字段</th><th>作用</th></tr></thead><tbody><tr><td>_value</td><td>缓存的计算结果</td></tr><tr><td>dep</td><td>谁依赖了这个 computed</td></tr><tr><td>deps</td><td>computed 依赖的响应式源（反向）</td></tr><tr><td>flags</td><td>是否 dirty，需要重新计算</td></tr><tr><td>globalVersion</td><td>避免重复计算的版本号控制</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-13">④ 构造函数</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">constructor</span>(fn, setter, isSSR) {
  <span class="hljs-keyword">this</span>[ReactiveFlags.IS_READONLY] = !setter
  <span class="hljs-keyword">this</span>.isSSR = isSSR
}
</code></pre>
<p>没有 setter → readonly computed。<br/>
这部分设计和前三篇响应式系统一致。</p>
<hr/>
<h3 data-id="heading-14">⑤ notify：依赖发生变化时触发 dirty</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">notify() {
  <span class="hljs-keyword">this</span>.flags |= EffectFlags.DIRTY

  <span class="hljs-keyword">if</span> (
    !(<span class="hljs-keyword">this</span>.flags &amp; EffectFlags.NOTIFIED) &amp;&amp;
    activeSub !== <span class="hljs-keyword">this</span>
  ) {
    batch(<span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
  }
}
</code></pre>
<h4 data-id="heading-15">原理说明</h4>
<p>当依赖更新时：</p>
<ul>
<li>标记本 computed 为 dirty</li>
<li>通过 batch 通知依赖它的 effect</li>
<li>避免 self-recursion（避免自己递归触发自己）</li>
</ul>
<p>这与上一篇 Collection 里的触发机制一致。</p>
<hr/>
<h3 data-id="heading-16">⑥ get value：读取并刷新缓存</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">get</span> value() {
  <span class="hljs-keyword">const</span> link = <span class="hljs-keyword">this</span>.dep.track()

  refreshComputed(<span class="hljs-keyword">this</span>)

  <span class="hljs-keyword">if</span> (link) {
    link.version = <span class="hljs-keyword">this</span>.dep.version
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._value
}
</code></pre>
<h4 data-id="heading-17">核心关键点（非常重要）</h4>
<ol>
<li><strong>dep.track()</strong><br/>
表示 “外部 effect 正在依赖我”</li>
<li><strong>refreshComputed(this)</strong><br/>
若 dirty 或版本号变化 → 执行 getter</li>
<li><strong>返回缓存值</strong></li>
</ol>
<p>这是 computed 靠缓存优化性能的关键。</p>
<hr/>
<h3 data-id="heading-18">⑦ set value：支持可写 computed</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">set</span> value(newValue) {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.setter) {
    <span class="hljs-keyword">this</span>.setter(newValue)
  } <span class="hljs-keyword">else</span> {
    warn(<span class="hljs-string">'Write operation failed: computed value is readonly'</span>)
  }
}
</code></pre>
<p>这个很好理解。</p>
<hr/>
<h3 data-id="heading-19">⑧ computed() 工厂函数</h3>
<pre><code class="hljs language-ini" lang="ini">export function computed(getterOrOptions, debugOptions, <span class="hljs-attr">isSSR</span> = <span class="hljs-literal">false</span>) {
  let getter
  let setter

  if (isFunction(getterOrOptions)) {
    <span class="hljs-attr">getter</span> = getterOrOptions
  } else {
    <span class="hljs-attr">getter</span> = getterOrOptions.get
    <span class="hljs-attr">setter</span> = getterOrOptions.set
  }

  const <span class="hljs-attr">cRef</span> = new ComputedRefImpl(getter, setter, isSSR)

  if (__DEV__ &amp;&amp; debugOptions &amp;&amp; !isSSR) {
    <span class="hljs-attr">cRef.onTrack</span> = debugOptions.<span class="hljs-literal">on</span>Track
    <span class="hljs-attr">cRef.onTrigger</span> = debugOptions.<span class="hljs-literal">on</span>Trigger
  }

  return cRef
}
</code></pre>
<h4 data-id="heading-20">支持两种形式</h4>
<ul>
<li>computed(getter)</li>
<li>computed({ get, set })</li>
</ul>
<p>同 Vue3 文档。</p>
<hr/>
<h2 data-id="heading-21">五、Computed 与 Effect 的关系</h2>
<p>Vue3 中：</p>

























<table><thead><tr><th>项目</th><th>Vue2</th><th>Vue3</th></tr></thead><tbody><tr><td>computed 内部实现</td><td>基于 watcher</td><td>不再使用 effect</td></tr><tr><td>依赖收集</td><td>watcher.deps</td><td>dep + version</td></tr><tr><td>缓存策略</td><td>lazy watcher</td><td>version + dirty</td></tr></tbody></table>
<p>Computed 更轻、更纯，不会参与 effect 的副作用队列。</p>
<hr/>
<h2 data-id="heading-22">六、实战示例</h2>
<pre><code class="hljs language-scss" lang="scss">const count = <span class="hljs-built_in">ref</span>(<span class="hljs-number">1</span>)

const plusOne = <span class="hljs-built_in">computed</span>(() =&gt; count<span class="hljs-selector-class">.value</span> + <span class="hljs-number">1</span>)

console<span class="hljs-selector-class">.log</span>(plusOne.value) <span class="hljs-comment">// 2</span>
count<span class="hljs-selector-class">.value</span>++
console<span class="hljs-selector-class">.log</span>(plusOne.value) <span class="hljs-comment">// 3（重新计算）</span>
</code></pre>
<p>使用体验不变，但实现更加高效。</p>
<hr/>
<h2 data-id="heading-23">七、扩展：Computed 为什么要分版本号？</h2>
<p>原因：<strong>提升性能、减少不必要计算</strong></p>
<p>例如：</p>
<p>多个 ref 改变但 getter 内只依赖其中一个时，版本号能避免无效计算。</p>
<p>Vue3 响应式系统中 version 机制广泛存在：</p>
<ul>
<li>ref</li>
<li>reactive</li>
<li>computed</li>
</ul>
<p>都依赖 version。</p>
<hr/>
<h2 data-id="heading-24">八、潜在问题与注意事项</h2>
<ol>
<li>getter 必须是纯函数（不要做副作用）</li>
<li>computed 不适合包含异步（会变成 Promise）</li>
<li>多层嵌套 computed 可能产生链式 dirty — Vue 已做优化</li>
<li>setter 写入不要和 getter 逻辑矛盾</li>
</ol>
<hr/>
<h2 data-id="heading-25">总结</h2>
<p>本篇从 computed 的整体设计、数据结构、dirty 机制、版本号策略、依赖链结构，到源码逐段拆解，完整讲解了 Vue3 计算属性的底层实现，使其风格与前三篇完全保持一致。</p>
<hr/>
<p><strong>本文部分内容借助 AI 辅助生成，并由作者整理审核。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Trae Que：用智能提示词提升编程效率的新范式]]></title>    <link>https://juejin.cn/post/7574321422400258074</link>    <guid>https://juejin.cn/post/7574321422400258074</guid>    <pubDate>2025-11-19T15:46:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574321422400258074" data-draft-id="7574289653177876518" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Trae Que：用智能提示词提升编程效率的新范式"/> <meta itemprop="keywords" content="代码规范,人工智能,JavaScript"/> <meta itemprop="datePublished" content="2025-11-19T15:46:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="San30"/> <meta itemprop="url" content="https://juejin.cn/user/1766294768060816"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Trae Que：用智能提示词提升编程效率的新范式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1766294768060816/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    San30
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T15:46:24.000Z" title="Wed Nov 19 2025 15:46:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><blockquote>
<p>在 AI 编程助手的时代，掌握正确的提示词技巧比编写代码本身更加重要。本文通过实际案例展示如何利用 Trae Que 等工具实现高效的智能代码补全。</p>
</blockquote>
<h2 data-id="heading-0">从 Copilot 到 Trae Que：AI 编程助手的演进</h2>
<p>传统的代码补全工具如 GitHub Copilot 已经改变了我们的编程方式，但它们主要基于局部上下文进行预测。而新一代的 AI 编程助手如 Trae Que、Cursor Agent 和 Claude Sonet 则将智能代码补全提升到了新的高度——它们能够理解完整的代码逻辑和架构意图。</p>
<p>目前这些工具已经能够达到 <strong>85 分</strong>的实用水平，不再是玩具，而是真正的生产力工具。</p>
<h2 data-id="heading-1">核心技巧：注释驱动的开发模式</h2>
<h3 data-id="heading-2">1. 注释即蓝图</h3>
<p>传统的开发流程是：思考 → 编码 → 注释。在 AI 编程时代，我们应该调整为：思考 → 注释 → AI 编码。</p>
<p><strong>示例对比：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 传统方式</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">findUser</span>(<span class="hljs-params">id, users</span>) {
    <span class="hljs-keyword">return</span> users.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> user.<span class="hljs-property">id</span> === id);
}

<span class="hljs-comment">// AI 时代的方式</span>
<span class="hljs-comment">/**
 * <span class="hljs-doctag">@func</span> 根据用户ID获取用户信息
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} id 用户ID
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} users 用户列表
 * <span class="hljs-doctag">@returns</span> 用户对象或undefined
 */</span>
<span class="hljs-comment">// ↑ 写完这些注释后，AI 会自动补全函数实现</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserById</span>(<span class="hljs-params">id, users</span>) {
    <span class="hljs-keyword">return</span> users.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> user.<span class="hljs-property">id</span> === id);
}
</code></pre>
<h3 data-id="heading-3">2. 类型注解的力量</h3>
<p>TypeScript 的类型系统为 AI 提供了丰富的上下文信息：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">User</span> = {
    <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 用户ID</span>
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 用户名</span>
    <span class="hljs-attr">email</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 用户邮箱</span>
    <span class="hljs-attr">status</span>: <span class="hljs-string">'ACTIVE'</span> | <span class="hljs-string">'INACTIVE'</span> <span class="hljs-comment">// 用户状态</span>
}

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@func</span> 根据ID获取用户信息，如果用户不存在则抛出错误
 * <span class="hljs-doctag">@param</span> id 用户ID
 * <span class="hljs-doctag">@param</span> users 用户列表
 * <span class="hljs-doctag">@returns</span> 用户对象
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserById</span>(<span class="hljs-params">id: <span class="hljs-built_in">string</span>, users: User[]</span>) {
    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> users.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> user.<span class="hljs-property">id</span> === id);
    <span class="hljs-keyword">if</span> (!user) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'User not found'</span>)
    }
    <span class="hljs-keyword">return</span> user;
}
</code></pre>
<p>有了这样的类型定义，AI 能够：</p>
<ul>
<li>理解数据的完整结构</li>
<li>提供准确的自动补全</li>
<li>检测潜在的类型错误</li>
<li>生成类型安全的代码</li>
</ul>
<h2 data-id="heading-4">实战案例：用户管理系统</h2>
<h3 data-id="heading-5">案例1：多维度用户查询</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@func</span> 根据用户ID获取用户信息
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} id 
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} users 
 * <span class="hljs-doctag">@returns</span> 
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserById</span>(<span class="hljs-params">id, users</span>) {
    <span class="hljs-keyword">return</span> users.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> user.<span class="hljs-property">id</span> === id);
}

<span class="hljs-comment">// 根据邮箱获取用户信息</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserByEmail</span>(<span class="hljs-params">email, users</span>) {
    <span class="hljs-keyword">return</span> users.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> user.<span class="hljs-property">email</span> === email);
}

<span class="hljs-comment">// 根据用户名获取用户信息  </span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserByUsername</span>(<span class="hljs-params">username, users</span>) {
    <span class="hljs-keyword">return</span> users.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> user.<span class="hljs-property">username</span> === username);
}
</code></pre>
<p><strong>AI 辅助效果</strong>：写完第一个函数的详细注释后，AI 能够自动推断出后续类似函数的模式和结构。</p>
<h3 data-id="heading-6">案例2：状态过滤功能</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@func</span> 查找所有非活跃用户
 * <span class="hljs-doctag">@params</span> users 用户列表  
 * <span class="hljs-doctag">@return</span> 非活跃用户列表
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getInactiveUsers</span>(<span class="hljs-params">users</span>) {
    <span class="hljs-keyword">const</span> inactiveUsers = <span class="hljs-keyword">await</span> users.<span class="hljs-title function_">filter</span>(
        <span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> user.<span class="hljs-property">status</span> === <span class="hljs-string">'INACTIVE'</span>
    )
    <span class="hljs-keyword">return</span> inactiveUsers;
}
</code></pre>
<p><strong>AI 辅助效果</strong>：清晰的注释让 AI 理解业务逻辑，自动生成正确的过滤条件。</p>
<h3 data-id="heading-7">案例3：测试数据验证</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> users = [
    {
        <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
        <span class="hljs-attr">username</span>: <span class="hljs-string">'admin'</span>,
    },
    {
        <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, 
        <span class="hljs-attr">username</span>: <span class="hljs-string">'user1'</span>,
    },
    {
        <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>,
        <span class="hljs-attr">username</span>: <span class="hljs-string">'user2'</span>,
    },
];

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(
    users.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> user.<span class="hljs-property">id</span> === <span class="hljs-number">2</span>)
);
</code></pre>
<p><strong>AI 辅助效果</strong>：基于数据结构，AI 可以建议相关的查询操作和测试用例。</p>
<h2 data-id="heading-8">高级技巧：跨文件上下文理解</h2>
<p>Trae Que 的强大之处在于它能够理解跨文件的代码关系：</p>
<h3 data-id="heading-9">场景：用户状态管理</h3>
<p>在 <code>userService.js</code> 中：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@func</span> 激活用户账户
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} userId 用户ID
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Array</span>} users 用户列表
 * <span class="hljs-doctag">@returns</span> 更新后的用户列表
 */</span>
</code></pre>
<p>在 <code>userController.js</code> 中工作时，AI 仍然记得这个函数的存在和用途，能够提供准确的调用建议。</p>
<h2 data-id="heading-10">最佳实践指南</h2>
<h3 data-id="heading-11">1. 注释要具体且有价值</h3>
<ul>
<li>✅ 好注释：<code>@func 根据用户状态和注册时间筛选有效用户</code></li>
<li>❌ 差注释：<code>@func 筛选用户</code></li>
</ul>
<h3 data-id="heading-12">2. 利用 JSDoc 标准</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 计算用户活跃度分数
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">User</span>} user 用户对象
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Date</span>} startDate 开始日期
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Date</span>} endDate 结束日期
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">number</span>} 活跃度分数(0-100)
 * <span class="hljs-doctag">@throws</span> {<span class="hljs-type">Error</span>} 当日期范围无效时
 */</span>
</code></pre>
<h3 data-id="heading-13">3. 保持代码结构清晰</h3>
<p>AI 在处理良好结构的代码时表现更好：</p>
<ul>
<li>单一职责的函数</li>
<li>一致的命名约定</li>
<li>合理的模块划分</li>
</ul>
<h3 data-id="heading-14">4. 迭代式提示</h3>
<p>如果第一次生成的结果不理想，可以：</p>
<ul>
<li>补充更多上下文信息</li>
<li>提供示例输入输出</li>
<li>指定代码风格要求</li>
</ul>
<h2 data-id="heading-15">生产力提升实测</h2>
<p>根据实际使用经验，采用 Trae Que 等工具后：</p>
<ul>
<li><strong>代码编写速度</strong>：提升 40-60%</li>
<li><strong>样板代码编写</strong>：减少 80%</li>
<li><strong>API 查阅时间</strong>：减少 70%</li>
<li><strong>错误检测</strong>：提前发现 30% 的潜在问题</li>
</ul>
<h2 data-id="heading-16">未来展望</h2>
<p>随着 AI 编程助手的不断发展，我们正在走向：</p>
<ol>
<li><strong>语义级理解</strong>：AI 不仅理解语法，更能理解业务逻辑</li>
<li><strong>架构级建议</strong>：从代码片段到系统设计的智能建议</li>
<li><strong>自动化重构</strong>：智能识别代码坏味道并提供重构方案</li>
<li><strong>团队知识传承</strong>：基于团队代码库的学习和风格适应</li>
</ol>
<h2 data-id="heading-17">结语</h2>
<p>Trae Que 代表的不仅仅是另一个代码补全工具，它标志着编程范式的转变。在这个新时代，<strong>表达意图的能力</strong>比<strong>实现细节的能力</strong>更加重要。</p>
<p>通过掌握注释驱动开发、类型注解和结构化提示词这些技巧，我们不仅是在使用工具，更是在与 AI 协作编程。这种协作关系将释放开发者的创造力，让我们能够专注于解决更有价值的复杂问题。</p>
<p>记住：在未来，最好的程序员不是最会写代码的人，而是最会与 AI 协作的人。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一个不会画图的程序员不是好的设计师]]></title>    <link>https://juejin.cn/post/7574584245109145651</link>    <guid>https://juejin.cn/post/7574584245109145651</guid>    <pubDate>2025-11-20T00:13:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574584245109145651" data-draft-id="7574271557939560499" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一个不会画图的程序员不是好的设计师"/> <meta itemprop="keywords" content="设计师,设计"/> <meta itemprop="datePublished" content="2025-11-20T00:13:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员晓凡"/> <meta itemprop="url" content="https://juejin.cn/user/1829211147871415"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一个不会画图的程序员不是好的设计师
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1829211147871415/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员晓凡
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T00:13:27.000Z" title="Thu Nov 20 2025 00:13:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是晓凡。</p>
<h3 data-id="heading-0">写在前面</h3>
<p>你有没有遇到过这样的困扰：面对一堆密密麻麻的数据、文字，看了半天还是一头雾水？</p>
<p>或者想要向别人解释一个复杂的流程，说了半天对方还是似懂非懂？</p>
<p>有时候不是我们不会表达，而是画图更直观明了。</p>
<h3 data-id="heading-1">一、ER图 (实体关系图)</h3>
<ul>
<li><strong>作用</strong>：描述数据库中实体之间的关系</li>
<li><strong>使用场景</strong>：数据库设计、系统分析阶段</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f08a5cb4e06e48c0a889fd7de32a6c91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5pmT5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202407&amp;x-signature=Loum6f%2F3GLll%2Bf8i1vluf46XfiI%3D" alt="ER图" loading="lazy"/></p>
<h3 data-id="heading-2">二、甘特图</h3>
<ul>
<li><strong>作用</strong>：展示项目进度和时间安排</li>
<li><strong>使用场景</strong>：项目管理、任务规划、进度跟踪</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbf7deb5f5a344f49a99264317fbdef5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5pmT5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202407&amp;x-signature=fYOu2gUgzGmyQlzQMiEURcNn2js%3D" alt="甘特图" loading="lazy"/></p>
<h3 data-id="heading-3">三、时间图</h3>
<ul>
<li><strong>作用</strong>：显示事件或数据随时间的变化趋势</li>
<li><strong>使用场景</strong>：数据分析、历史趋势展示、监控</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78c5adf6719b45e3b56c53d9fa045317~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5pmT5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202407&amp;x-signature=I0IppM88WAxymmF7dPIXeLaQdsA%3D" alt="时间线图" loading="lazy"/></p>
<h3 data-id="heading-4">四、树形图</h3>
<ul>
<li><strong>作用</strong>：表示层次结构关系</li>
<li><strong>使用场景</strong>：组织架构图、文件目录结构、决策树</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10cf998225af4c0cbe87708afc0cfefd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5pmT5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202407&amp;x-signature=3uCq2BfGk7ijMqsdq1Mt8%2FBFxAY%3D" alt="树形图" loading="lazy"/></p>
<h3 data-id="heading-5">五、网络拓扑图</h3>
<ul>
<li><strong>作用</strong>：展示网络设备间的连接关系</li>
<li><strong>使用场景</strong>：IT网络规划、系统运维、网络安全</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/248ff5528d5f471d890fdd35961e3726~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5pmT5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202407&amp;x-signature=RKRO%2BPiFEe59CBQLsdUGOhL77E8%3D" alt="网络拓扑图" loading="lazy"/></p>
<h3 data-id="heading-6">六、架构图</h3>
<ul>
<li><strong>作用</strong>：描述系统的整体结构和组件关系</li>
<li><strong>使用场景</strong>：软件设计、系统规划、技术文档</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49625c83fea142a0be8acff5f9b0bf1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5pmT5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202407&amp;x-signature=GjtwiwJP%2FM838VVbdyG%2F8LY60zo%3D" alt="三层架构图" loading="lazy"/></p>
<h3 data-id="heading-7">七、数据流图</h3>
<ul>
<li><strong>作用</strong>：展示数据在系统中的流动过程</li>
<li><strong>使用场景</strong>：系统分析、业务流程梳理、需求分析</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da873e36c9354dc9b97264f12090adb8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5pmT5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202407&amp;x-signature=SwGCmWWzhPHDe2RNJVFtVvuOcR4%3D" alt="数据流图" loading="lazy"/></p>
<h3 data-id="heading-8">八、状态图</h3>
<ul>
<li><strong>作用</strong>：描述对象或系统的状态变化</li>
<li><strong>使用场景</strong>：软件开发、工作流程建模、协议设计</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b6b500fd1864517b42445b59f32669c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5pmT5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202407&amp;x-signature=5bRll9VDMBDfG%2F9Dsi%2BSbGSQRr8%3D" alt="状态图" loading="lazy"/></p>
<h3 data-id="heading-9">九、泳道图</h3>
<ul>
<li><strong>作用</strong>：展示跨部门或角色的业务流程</li>
<li><strong>使用场景</strong>：业务流程优化、跨部门协作分析</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd56b3c1ff5e45f1a902f776be3b9a3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5pmT5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202407&amp;x-signature=6uzxGTxddbbAFfokC0DGcPP%2Bf%2B8%3D" alt="泳道图" loading="lazy"/></p>
<h3 data-id="heading-10">十、概念图</h3>
<ul>
<li><strong>作用</strong>：可视化展示概念间的关系</li>
<li><strong>使用场景</strong>：知识整理、教学、头脑风暴</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5d1f2dc6bb54e1791b12d9b65113da0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5pmT5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202407&amp;x-signature=ELkRUlbOBs7fjCSZ2rA%2BlZlCle8%3D" alt="概念图" loading="lazy"/></p>
<h3 data-id="heading-11">十一、鱼骨图</h3>
<ul>
<li><strong>作用</strong>：分析问题的根本原因</li>
<li><strong>使用场景</strong>：问题分析、质量改进、根因分析</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52efc4eb1bfd4e74848f184b87c2712d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5pmT5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202407&amp;x-signature=695yCqBZvF7zag44f7GiNRRRy18%3D" alt="鱼骨图" loading="lazy"/></p>
<h3 data-id="heading-12">十二、金字塔图</h3>
<ul>
<li><strong>作用</strong>：展示层次结构和重要性递减关系</li>
<li><strong>使用场景</strong>：管理体系、需求优先级排序、营销策略</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/213a335335d94b28b91503f74938cdf8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5pmT5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202407&amp;x-signature=2FCgdULal3MmqJHUdQPCZxyzVgE%3D" alt="金字塔图" loading="lazy"/></p>
<h3 data-id="heading-13">十三、漏斗图</h3>
<ul>
<li><strong>作用</strong>：展示逐步减少的过程</li>
<li><strong>使用场景</strong>：销售转化率分析、用户行为分析、营销效果评估</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0592c30f8f044326a52ab38f6daf0850~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5pmT5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202407&amp;x-signature=kJEUCP23%2FFwHw3ur%2B94OCSxvM5w%3D" alt="漏斗图" loading="lazy"/></p>
<h3 data-id="heading-14">十四、韦恩图</h3>
<ul>
<li><strong>作用</strong>：展示集合间的逻辑关系和重叠部分</li>
<li><strong>使用场景</strong>：数据分析、集合关系展示、比较分析</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87bee6822e7d48a6ac0f280a0663691d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5pmT5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202407&amp;x-signature=o1dtwx4OEGhlpi60%2BD1VrPkl17I%3D" alt="韦恩图" loading="lazy"/></p>
<h3 data-id="heading-15">十五、矩阵图</h3>
<ul>
<li><strong>作用</strong>：展示多维数据间的关系强度</li>
<li><strong>使用场景</strong>：风险评估、优先级排序、关联分析</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3153475ac4824e40997e4576949e6c95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5pmT5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202407&amp;x-signature=5z%2F4lE2AukI0guQC7uzKImYm4wo%3D" alt="矩阵图" loading="lazy"/></p>
<h3 data-id="heading-16">十六、信息图</h3>
<ul>
<li><strong>作用</strong>：综合可视化展示复杂信息</li>
<li><strong>使用场景</strong>：数据报告、宣传材料、知识传播</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript性能优化：7个90%开发者不知道的V8引擎隐藏技巧]]></title>    <link>https://juejin.cn/post/7574251313884102671</link>    <guid>https://juejin.cn/post/7574251313884102671</guid>    <pubDate>2025-11-20T00:16:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574251313884102671" data-draft-id="7574250031249424418" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript性能优化：7个90%开发者不知道的V8引擎隐藏技巧"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-20T00:16:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT_陈寒"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript性能优化：7个90%开发者不知道的V8引擎隐藏技巧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT_陈寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T00:16:54.000Z" title="Thu Nov 20 2025 00:16:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>JavaScript性能优化：7个90%开发者不知道的V8引擎隐藏技巧</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>在现代Web开发中，JavaScript的性能优化是一个永恒的话题。作为最流行的JavaScript引擎之一，V8（驱动Chrome和Node.js的核心）在背后默默执行了无数优化。然而，许多开发者对V8的内部工作机制知之甚少，导致编写的代码无法充分发挥其潜力。</p>
<p>本文将揭示7个被大多数开发者忽视的V8引擎隐藏技巧，帮助你写出更高效的JavaScript代码。这些技巧不仅基于V8的官方文档和源码分析，还结合了实际性能测试数据，确保内容的专业性和可靠性。</p>
<hr/>
<h2 data-id="heading-2">1. 隐藏类（Hidden Classes）与属性顺序的重要性</h2>
<h3 data-id="heading-3">什么是隐藏类？</h3>
<p>V8使用“隐藏类”（也称为“Shape”）来优化对象属性的访问。当对象的结构（如属性的顺序和类型）相同时，它们会共享同一个隐藏类，从而加速属性查找。</p>
<h3 data-id="heading-4">优化技巧</h3>
<ul>
<li><strong>保持属性顺序一致</strong>：动态添加属性的顺序会影响隐藏类的生成。例如：
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 不好的写法：导致多个隐藏类</span>
<span class="hljs-keyword">const</span> obj1 = {};
obj1.<span class="hljs-property">a</span> = <span class="hljs-number">1</span>;
obj1.<span class="hljs-property">b</span> = <span class="hljs-number">2</span>;

<span class="hljs-keyword">const</span> obj2 = {};
obj2.<span class="hljs-property">b</span> = <span class="hljs-number">2</span>; <span class="hljs-comment">// 顺序不同！</span>
obj2.<span class="hljs-property">a</span> = <span class="hljs-number">1</span>;

<span class="hljs-comment">// 好的写法：保持顺序一致</span>
<span class="hljs-keyword">const</span> obj3 = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">2</span> };
<span class="hljs-keyword">const</span> obj4 = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">2</span> };
</code></pre>
</li>
<li><strong>避免动态删除属性</strong>：使用<code>delete</code>操作符会破坏隐藏类，导致性能下降。如果需要移除属性，可以将其设为<code>null</code>或<code>undefined</code>。</li>
</ul>
<hr/>
<h2 data-id="heading-5">2. Inline Caching（内联缓存）与函数单态性</h2>
<h3 data-id="heading-6">Inline Caching的工作原理</h3>
<p>V8通过内联缓存（IC）来加速函数调用和属性访问。它记录最近的操作类型（如对象的隐藏类），并在下次直接复用缓存结果。</p>
<p>###如何利用单态性优化？</p>
<ul>
<li><strong>确保函数参数类型稳定</strong>：如果一个函数频繁接收不同类型的参数，V8会退化为“多态”调用，降低性能。例如：</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Bad: Mixed types trigger polymorphic calls</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>) {
<span class="hljs-keyword">return</span> a + b;
}
<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);      <span class="hljs-comment">// Monomorphic (numbers)</span>
<span class="hljs-title function_">add</span>(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>); <span class="hljs-comment">// Polymorphic (now strings)</span>

<span class="hljs-comment">// Good: Stick to one type per function</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">addNumbers</span>(<span class="hljs-params">a, b</span>) {
<span class="hljs-keyword">return</span> a + b;
}
</code></pre>
<hr/>
<p>##3.避免try-catch在热点路径中的使用</p>
<p>###为什么try-catch代价高昂？
V8对包含try-catch的函数难以优化因为它要求额外的运行时上下文切换并阻止内联等关键优化。</p>
<p>###替代方案：
-将try-catch移出循环或高频执行路径。
-对于异步错误处理优先使用Promise.catch()而非包裹await在try中。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Bad:</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">1000000</span>;i++){
 <span class="hljs-keyword">try</span>{ <span class="hljs-title function_">hotPath</span>(); }
 <span class="hljs-keyword">catch</span>(e){}
}

<span class="hljs-comment">// Good:</span>
<span class="hljs-keyword">try</span> {
 <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">1000000</span>;i++){
   <span class="hljs-title function_">hotPath</span>();
 }
} <span class="hljs-keyword">catch</span>(e){}
</code></pre>
<hr/>
<p>##4.Optimizing Arrays for V8</p>
<p>###数组类型的内部表示
V8会根据元素类型自动选择最优存储方式：
-PACKED_SMI_ELEMENTS（纯小整数）
-PACKED_DOUBLE_ELEMENTS（双精度浮点）
-PACKED_ELEMENTS（任意对象）</p>
<p>####关键优化点：
-<strong>避免混合类型数组</strong>:一旦数组包含非SMI数字或对象就无法降级到高效表示。
-<strong>预分配固定大小数组</strong>:比动态push更快因为不需要反复扩容。
-<strong>谨慎使用稀疏数组</strong>:空槽位会导致退化为字典模式。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> arr=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">100</span>);<span class="hljs-comment">//预先分配优于[]</span>
arr.<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>);<span class="hljs-comment">//初始化保证PACKED_SMI</span>

<span class="hljs-comment">//比以下高效得多：</span>
<span class="hljs-keyword">const</span> arr=[];
<span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">100</span>;i++)arr.<span class="hljs-title function_">push</span>(i);
</code></pre>
<hr/>
<p>##5.String连接的高效模式</p>
<p>###传统+=的性能陷阱
连续使用+=拼接字符串会产生大量中间字符串触发垃圾回收压力。</p>
<p>####现代解决方案：
-<strong>数组join法</strong>:仍然是最可靠的跨浏览器方法。
-<strong>模板字符串</strong>:现代JS引擎已深度优化。
-<strong>String.prototype.concat():在某些情况下比+更快</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> result=<span class="hljs-string">''</span>;
<span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>;i&lt;data.<span class="hljs-property">length</span>;i++){
 result+=data[i];<span class="hljs-comment">//Bad for large loops</span>
}

<span class="hljs-comment">// Better:</span>
<span class="hljs-keyword">const</span> parts=[];
<span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>;i&lt;data.<span class="hljs-property">length</span>;i++){
 parts.<span class="hljs-title function_">push</span>(data[i]);
}
result=parts.<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>);
</code></pre>
<hr/>
<p>##6.Optimizing Number Operations</p>
<p>###V8的数字表示体系
-V8使用31位带符号整数(SMi)和双精度浮点数两种表示。-超出SMi范围(-231~231-1)的数字会被升级为堆分配的Double对象。</p>
<p>####关键技巧：
-<strong>尽量使用31位有符号整数</strong>:算术运算最快。
-<strong>避免频繁切换数字类型</strong>:会导致不断拆箱/装箱。
-<strong>位运算仅对32位有效</strong>:|0可强制转为32位整数.</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MAX_SMI</span>=<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">2</span>,<span class="hljs-number">30</span>)-<span class="hljs-number">1</span>;<span class="hljs-comment">//最大的SMi值</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">expensiveCalc</span>(<span class="hljs-params"/>){
 <span class="hljs-keyword">let</span> sum=<span class="hljs-number">0</span>;<span class="hljs-comment">//SMi optimized</span>
 <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">10000</span>;i++){
   sum+=i;<span class="hljs-comment">//保持在SMi范围内最快 </span>
 }
 <span class="hljs-keyword">return</span> sum; 
}
</code></pre>
<hr/>
<p>##7.Leveraging Concurrent Compilation in V8</p>
<p>###后台编译机制自2017年起现代V8采用并发编译：
-解析器和编译器在工作线程上运行不影响主线程执行.</p>
<p>####如何配合此机制？
-<strong>代码分块</strong>:让编译器可以并行处理不同函数.
-<strong>避免巨型单体函数</strong>:大函数会延迟编译完成时间.
-<strong>注意TurboFan优化的触发条件</strong>:热函数需要足够调用次数.</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">//Bad:Huge monolithic function </span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">giantFunction</span>(<span class="hljs-params"/>){
 <span class="hljs-comment">//...500+ lines of code </span>
}

<span class="hljs-comment">//Better:Split into logical units </span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">taskA</span>(<span class="hljs-params"/>){<span class="hljs-comment">/*...*/</span>}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">taskB</span>(<span class="hljs-params"/>){<span class="hljs-comment">/*...*/</span>}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">workflow</span>(<span class="hljs-params"/>){
 <span class="hljs-title function_">taskA</span>();
 <span class="hljs-title function_">taskB</span>(); <span class="hljs-comment">//Each can be compiled separately </span>
}
</code></pre>
<hr/>
<p>##总结</p>
<p>理解V8引擎的这些底层机制可以让你的JavaScript代码获得数量级的性能提升从正确的数据结构选择到符合编译器优化的编码模式每个微小的改进都能在高频执行的代码路径上产生显著影响。</p>
<p>记住这些原则并非教条主义的金科玉律而是需要在具体场景中验证的工具随着V8的持续进化定期重新审视你的性能假设非常重要最好的优化策略往往是那些能够优雅地适应运行时特性的策略</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[学习 LiteLLM 的认证机制]]></title>    <link>https://juejin.cn/post/7574318108719382574</link>    <guid>https://juejin.cn/post/7574318108719382574</guid>    <pubDate>2025-11-20T00:14:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574318108719382574" data-draft-id="7574289653178040358" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="学习 LiteLLM 的认证机制"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-20T00:14:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="日习一技"/> <meta itemprop="url" content="https://juejin.cn/user/3913917125896190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            学习 LiteLLM 的认证机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3913917125896190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    日习一技
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.1 初学乍练
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.1 初学乍练" title="VIP.1 初学乍练" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T00:14:58.000Z" title="Thu Nov 20 2025 00:14:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在之前的两篇文章中，我们分别学习了 LiteLLM 的快速入门和模型管理。我们了解到，LiteLLM 不仅是一个统一的 SDK，更是一个功能强大的企业级 LLM 网关。在生产环境中，如何确保 LLM 资源的安全访问？如何为不同用户和团队分配不同的权限？如何追踪每个用户的使用情况和成本？如何精确控制成本和防止滥用？这些都是访问控制需要解决的核心问题。</p>
<p>LiteLLM 的访问控制系统采用多层次的安全架构，从基础的 API Key 认证到企业级的 JWT 认证，从简单的用户管理到复杂的团队权限体系，为不同规模的应用提供了灵活的解决方案：</p>
<p><strong>认证层次</strong>：</p>
<ul>
<li><strong>虚拟 API Key</strong>：为每个用户或团队生成唯一的虚拟 Key</li>
<li><strong>JWT Token</strong>：支持企业级 OpenID Connect (OIDC) 认证</li>
<li><strong>自定义认证</strong>：集成企业现有的身份认证系统</li>
</ul>
<p><strong>授权体系</strong>：</p>
<ul>
<li><strong>用户级权限</strong>：基于角色的访问控制（RBAC）</li>
<li><strong>团队级权限</strong>：团队成员共享模型访问权限</li>
<li><strong>组织级权限</strong>：大型企业的多层级管理</li>
</ul>
<p><strong>控制维度</strong>：</p>
<ul>
<li><strong>模型访问</strong>：控制用户可以使用的模型</li>
<li><strong>接口访问</strong>：限制可调用的 API 接口</li>
<li><strong>流量控制</strong>：请求频率和并发数限制</li>
<li><strong>成本控制</strong>：预算限制和消费追踪</li>
</ul>
<p>我们今天主要关注第一部分，来学习下 LiteLLM 的认证机制。</p>
<h2 data-id="heading-0">虚拟 Key 认证</h2>
<p>在之前的学习中，我们在调用模型接口时使用的 API Key 一直都是 <code>sk-1234</code>，这个是我们在配置文件中配置的 <strong>Master Key</strong>，也就是管理员密钥：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">general_settings:</span>
  <span class="hljs-attr">master_key:</span> <span class="hljs-string">sk-1234</span>
</code></pre>
<p>对于个人开发者来说，只用一个简单的 API Key 可能就足够了，但是对于团队或企业来说，一个 Key 无法区分不同的用户或应用，而且 Master Key 的权限过大，这时我们就需要引入 Virtual Key 的概念了。</p>
<p><strong>虚拟 Key（Virtual Key）</strong> 是 LiteLLM 最核心的认证机制，它借鉴了云服务商的 API Key 管理模式，为每个用户或应用生成独立的访问密钥。LiteLLM 的虚拟 Key 提供了一层抽象，使得：</p>
<ul>
<li>你可以为不同的用户、团队、应用生成不同的 Key</li>
<li>每个 Key 可以独立配置访问权限和预算限制</li>
<li>支持 Key 的轮换和撤销</li>
<li>所有使用行为都由 Proxy 记录和追踪</li>
</ul>
<p>接下来我们生成一个虚拟 Key 验证下。虚拟 Key 的生成需要数据库支持，因此首先配置数据库连接（昨天学习模型的动态管理时已经配过）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">general_settings:</span>
  <span class="hljs-attr">master_key:</span> <span class="hljs-string">sk-1234</span>
  <span class="hljs-attr">database_url:</span> <span class="hljs-string">"postgresql://postgres:password@127.0.0.1:5432/litellm"</span>
</code></pre>
<p>然后通过 <code>/key/generate</code> 接口生成 Key：</p>
<pre><code class="hljs language-bash" lang="bash">$ curl <span class="hljs-string">'http://127.0.0.1:4000/key/generate'</span> \
  -H <span class="hljs-string">'Authorization: Bearer sk-1234'</span> \
  -H <span class="hljs-string">'Content-Type: application/json'</span> \
  -d <span class="hljs-string">'{
    "models": ["gpt-4o"],
    "metadata": {"user": "zhangsan@example.com"}
  }'</span>
</code></pre>
<p>接口响应如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>    
  <span class="hljs-attr">"key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sk-qC5b02PjnQVdq3FPYY37wQ"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"key_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sk-...37wQ"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"models"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"gpt-4o"</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"user"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"zhangsan@example.com"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"team_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"model_max_budget"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"model_rpm_limit"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"model_tpm_limit"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"max_budget"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"max_parallel_requests"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"guardrails"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"allowed_routes"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// ...</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<blockquote>
<p>可以看到，接口响应中除了 <code>key</code> 之外，还有一些关于用户、团队、请求频率、并发限制等信息，这些内容涉及 LiteLLM 的授权体系和访问控制机制，我们后面再具体学习。</p>
</blockquote>
<p>使用这个虚拟 Key 请求 <code>/chat/completions</code> 接口：</p>
<pre><code class="hljs language-bash" lang="bash">$ curl -X POST <span class="hljs-string">'http://127.0.0.1:4000/chat/completions'</span> \
  -H <span class="hljs-string">'Authorization: Bearer sk-qC5b02PjnQVdq3FPYY37wQ'</span> \
  -H <span class="hljs-string">'Content-Type: application/json'</span> \
  -d <span class="hljs-string">'{
    "model": "gpt-4o",
    "messages": [{"role": "user", "content": "你好"}]
  }'</span>
</code></pre>
<p>接口验证正常，说明虚拟 Key 生成成功。</p>
<h3 data-id="heading-1">支持多种 Header 格式</h3>
<p>LiteLLM 的灵活设计使其能够支持多种 Header 格式，兼容不同的客户端库和工具：</p>













































<table><thead><tr><th>Header 名称</th><th>用途</th><th>优先级</th></tr></thead><tbody><tr><td><code>x-litellm-api-key</code></td><td>LiteLLM 自定义 Key</td><td>1 (最高)</td></tr><tr><td><code>Authorization</code></td><td>OpenAI 兼容格式</td><td>2</td></tr><tr><td><code>API-Key</code></td><td>Azure 风格</td><td>3</td></tr><tr><td><code>x-api-key</code></td><td>Anthropic 格式</td><td>4</td></tr><tr><td><code>x-goog-api-key</code></td><td>Google AI Studio</td><td>5</td></tr><tr><td><code>Ocp-Apim-Subscription-Key</code></td><td>Azure APIM</td><td>6</td></tr><tr><td>其他自定义 Header</td><td>配置化支持</td><td>7</td></tr></tbody></table>
<p>比如像下面这样请求也是可以的：</p>
<pre><code class="hljs language-bash" lang="bash">$ curl -X POST <span class="hljs-string">'http://127.0.0.1:4000/chat/completions'</span> \
  -H <span class="hljs-string">'x-litellm-api-key: sk-qC5b02PjnQVdq3FPYY37wQ'</span> \
  -H <span class="hljs-string">'Content-Type: application/json'</span> \
  -d <span class="hljs-string">'{
    "model": "gpt-4o",
    "messages": [{"role": "user", "content": "你好"}]
  }'</span>
</code></pre>
<p>这样的设计让 LiteLLM 可以轻松地代理来自各种来源的请求，而无需修改客户端代码。</p>
<h3 data-id="heading-2">虚拟 Key 的存储和验证</h3>
<p>为了保证安全性，虚拟 Key 在数据库中采用 <strong>哈希值存储</strong>，这样做的好处是，即使数据库被泄露，攻击者也无法直接使用 Key（因为数据库中只有哈希值）。</p>
<p>另外，LiteLLM 使用 <strong>分层缓存策略</strong> 进行虚拟 Key 的验证：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38871ce009b94ea09931d51f812e6643~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202498&amp;x-signature=tdCatIzimvMm5k4LEPlzMI3Cgck%3D" alt="api-key-verification.png" loading="lazy"/></p>
<p>通过分层缓存，大多数请求不需要访问数据库，大大提高了虚拟 Key 的验证性能。</p>
<h3 data-id="heading-3">客户端凭据透传</h3>
<p>除了传统的服务器端认证，LiteLLM 还支持让客户端直接传递自己的 API Key，这在某些场景下可能有用，比如开发者使用自己的 API Key 进行测试，或者用户希望使用自己的 API Key，但又不希望配置到 LiteLLM 里。</p>
<p>通过下面的参数启用客户端凭据透传：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">model_list:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">model_name:</span> <span class="hljs-string">gpt-4o</span>
    <span class="hljs-attr">litellm_params:</span>
      <span class="hljs-attr">model:</span> <span class="hljs-string">openai/gpt-4o</span>
      <span class="hljs-attr">api_key:</span> <span class="hljs-string">os.environ/OPENAI_API_KEY</span>
      <span class="hljs-attr">configurable_clientside_auth_params:</span> [<span class="hljs-string">"api_key"</span>, <span class="hljs-string">"api_base"</span>] <span class="hljs-comment"># 支持透传的字段</span>
</code></pre>
<p>客户端调用示例如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> openai

client = openai.OpenAI(
  api_key=<span class="hljs-string">"sk-1234"</span>,
  base_url=<span class="hljs-string">"http://localhost:4000"</span>
)

response = client.chat.completions.create(
  model=<span class="hljs-string">"gpt-4o"</span>,
  messages=[{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"Hello"</span>}],
  extra_body={
    <span class="hljs-string">"api_key"</span>: <span class="hljs-string">"sk-client-xxx"</span>,  <span class="hljs-comment"># 客户端自己的 API 密钥</span>
    <span class="hljs-string">"api_base"</span>: <span class="hljs-string">"https://api.openai.com/v1"</span>
  }
)
</code></pre>
<p>LiteLLM 会遍历 <code>configurable_clientside_auth_params</code> 参数，将客户端传递的参数和系统配置的参数进行合并。</p>
<blockquote>
<p>有意思的，客户端不仅可以传 <code>api_key</code> 或 <code>api_base</code> 等字段，甚至可以传整个 <code>model_list</code>，将 LiteLLM 的配置完全架空。</p>
</blockquote>
<h2 data-id="heading-4">JWT 认证与 OIDC 集成</h2>
<p>虽然虚拟 Key 是 LiteLLM 最核心的认证方式，但对于某些企业场景，这种认证方式可能不够灵活，企业往往已经有一套比较成熟的 <strong>身份认证系统（Identity Provider, IDP）</strong>，比如：</p>
<ul>
<li><strong>Azure AD</strong>：Microsoft 的企业身份平台</li>
<li><strong>Keycloak</strong>：开源身份和访问管理解决方案</li>
<li><strong>Google Cloud Identity</strong>：Google 的企业 SSO</li>
<li><strong>Okta</strong>：专业的身份管理服务</li>
</ul>
<p>他们更希望能直接复用这套认证机制。</p>
<p>LiteLLM 支持通过 <strong>JWT 令牌</strong> 与这些系统集成，而无需维护独立的用户数据库。</p>
<blockquote>
<p>注意，这是一个企业级特性，需要购买授权。</p>
</blockquote>
<h3 data-id="heading-5">OIDC 简介</h3>
<p>LiteLLM 和身份认证系统之间的交互遵循 <a href="https://link.juejin.cn?target=https%3A%2F%2Fopenid.net%2F" target="_blank" title="https://openid.net/" ref="nofollow noopener noreferrer">OIDC</a> 标准。</p>
<p><strong>OpenID Connect (OIDC)</strong> 是一个基于 OAuth 2.0 的身份认证协议，它在 OAuth 2.0 的基础上增加了身份层，使得应用可以验证用户的身份，它已经成为企业级应用的标准认证方式。</p>
<p>OIDC 的核心优势如下：</p>
<ul>
<li><strong>标准化</strong>：遵循 OAuth 2.0 和 OpenID Connect 规范</li>
<li><strong>单点登录</strong>：支持 SSO，用户一次登录，全组织访问</li>
<li><strong>令牌安全</strong>：JWT 令牌可以包含丰富的用户信息，支持签名和加密</li>
<li><strong>广泛支持</strong>：被所有主流云服务和身份提供商支持</li>
</ul>
<p>下面是 OIDC 规范，对此感兴趣的朋友可以看看：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fopenid.net%2Fdevelopers%2Fhow-connect-works%2F" target="_blank" title="https://openid.net/developers/how-connect-works/" ref="nofollow noopener noreferrer">openid.net/developers/…</a></li>
</ul>
<h3 data-id="heading-6">JWT 简介</h3>
<p><strong>JWT（JSON Web Token）</strong> 是一种基于 JSON 的轻量级身份认证与信息交换标准（RFC 7519），广泛用于分布式系统、API 接口、前后端分离架构中，核心作用是在客户端与服务器之间安全传递 <strong>可验证的声明</strong>（如用户身份、权限范围等），无需服务器存储会话状态。</p>
<p>在传统的会话认证（如 Session）中，服务器需要存储用户的会话信息，当用户量增大或服务分布式部署时，会面临会话同步复杂、服务器存储压力大等问题。而 JWT 通过 <strong>客户端存储令牌 + 服务器验证令牌</strong> 的模式，解决了这些痛点，其核心优势包括：</p>
<ul>
<li><strong>无状态</strong>：服务器无需存储会话数据，仅通过令牌本身即可验证合法性，降低服务器存储成本，便于服务水平扩展（多台服务器可共享认证逻辑）；</li>
<li><strong>跨域友好</strong>：JWT 基于 HTTP 头传递，天然支持跨域场景（如前后端分离、多服务间调用）；</li>
<li><strong>轻量灵活</strong>：基于 JSON 格式，体积小、传输快，且可自定义声明字段，满足不同业务需求；</li>
<li><strong>自包含</strong>：令牌本身包含了用户身份、权限等核心信息，减少服务器查询数据库的次数（无需每次认证都查用户表）；</li>
</ul>
<p>一个 JWT 令牌由三部分组成，用点号分隔：</p>
<pre><code class="hljs language-erlang" lang="erlang">eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.
eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIn0.
SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
</code></pre>
<p>分别代表：</p>
<ul>
<li><strong>Header</strong>：算法和令牌类型信息</li>
<li><strong>Payload</strong>：用户信息和声明（Claims）</li>
<li><strong>Signature</strong>：数字签名，用于验证数据完整性</li>
</ul>
<p>可以通过下面的网站验证和查看 JWT 令牌中的内容：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jwt.io%2F" target="_blank" title="https://www.jwt.io/" ref="nofollow noopener noreferrer">www.jwt.io/</a></li>
</ul>
<h3 data-id="heading-7">基于 Keycloak 的 JWT 认证实战</h3>
<p>下面我使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.keycloak.org%2F" target="_blank" title="https://www.keycloak.org/" ref="nofollow noopener noreferrer">Keycloak</a> 这款开源的身份认证系统来演示下如何在 LiteLLM 中实现 JWT 认证。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c0dc0743c894fbabb5e7fcf343ddf9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202498&amp;x-signature=gTLFhtDHdKAwl9T9IXCPPuUbJ3c%3D" alt="keycloak.png" loading="lazy"/></p>
<p>这是一款由 Red Hat 主导开发并维护的开源 <strong>身份和访问管理（IAM）</strong> 工具，旨在为现代应用（包括 Web 应用、移动应用、API 服务等）提供统一、安全且标准化的 <strong>身份认证（Authentication）</strong> 与 <strong>授权（Authorization）</strong> 能力，帮助开发者快速集成身份管理功能，无需重复造轮子。</p>
<h4 data-id="heading-8">Keycloak 环境准备</h4>
<p>首先使用下面的命令启动 Keycloak 服务：</p>
<pre><code class="hljs language-bash" lang="bash">$ docker run \
  -p 8080:8080 \
  -e KC_BOOTSTRAP_ADMIN_USERNAME=admin \
  -e KC_BOOTSTRAP_ADMIN_PASSWORD=admin \
  quay.io/keycloak/keycloak:26.4.2 start-dev
</code></pre>
<p>服务启动成功后，在浏览器访问 <code>http://localhost:8080/</code> 并使用默认的用户名和密码登录：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37903599eb7443418bfb9b57e6ac837f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202498&amp;x-signature=3zZDJ0K0%2Ba4iEB80cKMc2YBLwRU%3D" alt="keycloak-admin-ui.png" loading="lazy"/></p>
<p>点击 “Manage realms” 菜单，创建一个名为 <code>litellm</code> 的 <strong>领域（Realm）</strong>，这是 Keycloak 中最高级别的隔离单位，相当于 <strong>租户</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f779bed4fd8a49398765042a80b0d400~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202498&amp;x-signature=ZZHyvHFdSCiiYAmxAlVMqGRYTk0%3D" alt="keycloak-create-realm.png" loading="lazy"/></p>
<p>创建完成后会自动切到这个领域，然后点击 “Users” 菜单，在这个领域下创建一个用户，用户名为 <code>zhangsan</code>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93b0dff04281403584ad8708cd4cf5ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202498&amp;x-signature=86sgZr3gStRn3mmWTZ3ChoYBxbA%3D" alt="keycloak-create-user.png" loading="lazy"/></p>
<p>创建完成后进入该用户的详情，点击 “Credentials” 菜单，再点击 “Set password” 按钮，为用户设置一个长期密码（注意将 Temporary 勾掉）：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97638d1e0efb4ef9b0d92d94f9d8dd7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202498&amp;x-signature=4FOsPptmam5M3ZWP%2F3asy861CVU%3D" alt="keycloak-create-user-set-password.png" loading="lazy"/></p>
<p>然后再点击 “Clients” 菜单，创建一个客户端：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/532116b6217f4a6db499bfe25f75bb1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202498&amp;x-signature=LRdYTBKKNrf0gBGvlk7z9X%2BZrZs%3D" alt="keycloak-create-client.png" loading="lazy"/></p>
<p>其中 Client ID 命名为 <code>litellm</code>，点击 Next 进入 “Capability Config” 页面：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1eab1281a8b3464f8c05892a4660c63c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202498&amp;x-signature=NoOvXWMvhr%2B217njYuFj%2FZxgCJE%3D" alt="keycloak-create-client-capability.png" loading="lazy"/></p>
<p>将 “Client authentication” 选项开启，同时在 “Authentication flow” 中将 “Direct access grants” 开启。接着，点击 Next 进入 “Login Settings” 页面，保持默认即可，点击 Save 按钮，完成客户端的创建。</p>
<h4 data-id="heading-9">开启 JWT 认证</h4>
<p>至此 Keycloak 环境准备就绪，接下来让 LiteLLM 开启 JWT 认证。第一步，通过环境变量设置 Keycloak 的公钥端点：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 注意 `litellm` 是领域名称</span>
<span class="hljs-built_in">export</span> JWT_PUBLIC_KEY_URL=<span class="hljs-string">"http://localhost:9009/realms/litellm/protocol/openid-connect/certs"</span>
</code></pre>
<p>这个 URL 是 OpenID Connect 标准的 <strong>JWKS（JSON Web Key Set）</strong> 端点，方便客户端批量获取所需密钥，里面包含了用于验证签名或加密的公钥。</p>
<p>第二步，在配置中启用 JWT 认证：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">general_settings:</span>
  <span class="hljs-attr">master_key:</span> <span class="hljs-string">sk-1234</span>
  <span class="hljs-attr">database_url:</span> <span class="hljs-string">"postgresql://postgres:password@127.0.0.1:5432/litellm"</span>
  <span class="hljs-attr">enable_jwt_auth:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 开启 JWT 认证</span>
</code></pre>
<p>第三步，重启 LiteLLM Proxy 服务：</p>
<pre><code class="hljs language-bash" lang="bash">$ litellm -c config.yaml
</code></pre>
<p>第四步，使用 Client ID、Client Secret、用户名、密码，调用 Keycloak 获取 JWT 令牌：</p>
<pre><code class="hljs language-bash" lang="bash">$ curl -X POST \
  http://localhost:9009/realms/litellm/protocol/openid-connect/token \
  -H <span class="hljs-string">"Content-Type: application/x-www-form-urlencoded"</span> \
  -d <span class="hljs-string">"grant_type=password"</span> \
  -d <span class="hljs-string">"client_id=litellm"</span> \
  -d <span class="hljs-string">"client_secret=0CtlgEvGHU3XNjDAmwHPn5p8wT78JGEp"</span> \
  -d <span class="hljs-string">"username=zhangsan"</span> \
  -d <span class="hljs-string">"password=12345678"</span>
</code></pre>
<p>其中 Client Secret 可以在 Client 详情中找到：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/259acabf8b4141a4ac3a3f6c2eae9d2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764202498&amp;x-signature=bEMnW8vB2ja4HYUfz41qBIQSHFk%3D" alt="keycloak-clients-details.png" loading="lazy"/></p>
<p>接口返回结果如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"access_token"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eyJhbGciOiJSUzI1NiIsInR5..."</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"expires_in"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">300</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"refresh_expires_in"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1800</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"refresh_token"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eyJhbGciOiJIUzUxMiIsInR5..."</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"token_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bearer"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"not-before-policy"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"session_state"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dca8f2d7-eac4-d6e7-799b-f7b80da4d841"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scope"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"profile email"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这个 <code>access_token</code> 就是 JWT 令牌，我们可以用它来调用 <code>/chat/completions</code> 接口：</p>
<pre><code class="hljs language-bash" lang="bash">$ curl -X POST <span class="hljs-string">'http://127.0.0.1:4000/chat/completions'</span> \
  -H <span class="hljs-string">'Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5...'</span> \
  -H <span class="hljs-string">'Content-Type: application/json'</span> \
  -d <span class="hljs-string">'{
    "model": "gpt-4o",
    "messages": [{"role": "user", "content": "你好"}]
  }'</span>
</code></pre>
<p>LiteLLM 会根据从 <code>JWT_PUBLIC_KEY_URL</code> 获取的公钥对该令牌进行验证（类似数字签名的原理），这就是 LiteLLM 的 JWT 认证流程。</p>
<h2 data-id="heading-10">自定义认证</h2>
<p>虽然 LiteLLM 提供了虚拟 Key、JWT 等多种认证方式，但在某些高度定制化的场景中，你可能需要实现自己的认证逻辑。比如：</p>
<ul>
<li><strong>现有系统集成</strong>：你有一套自定义的用户认证系统</li>
<li><strong>特殊业务规则</strong>：需要根据特定条件验证用户</li>
<li><strong>外部服务集成</strong>：需要调用外部服务进行认证</li>
<li><strong>多步认证</strong>：需要组合多个认证因素</li>
</ul>
<p>LiteLLM 允许你提供自定义的认证函数，完全控制身份认证过程。其核心是实现一个异步函数，该函数接收请求和 API Key，然后返回一个认证对象：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> Request
<span class="hljs-keyword">from</span> litellm.proxy._types <span class="hljs-keyword">import</span> UserAPIKeyAuth

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">user_api_key_auth</span>(<span class="hljs-params">request: Request, api_key: <span class="hljs-built_in">str</span></span>) -&gt; UserAPIKeyAuth: 
  <span class="hljs-string">"""
  自定义认证函数

  参数:
    request: FastAPI 请求对象，包含 HTTP 请求的所有信息
    api_key: 从请求头中提取的 API Key

  返回:
    UserAPIKeyAuth: 认证成功时返回用户认证对象

  异常:
    Exception: 认证失败时抛出异常
  """</span>
  <span class="hljs-keyword">try</span>: 
    <span class="hljs-keyword">if</span> api_key.startswith(<span class="hljs-string">"my-custom-key-"</span>):
      <span class="hljs-keyword">return</span> UserAPIKeyAuth(api_key=api_key)
    <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">"Invalid API key"</span>)
  <span class="hljs-keyword">except</span>: 
    <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">"Authentication failed"</span>)
</code></pre>
<p>将上面的内容保存到 <code>custom_auth.py</code> 文件中，并放置于和 <code>config.yaml</code> 文件同级的目录下。在配置文件中指定自定义认证函数的位置：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">general_settings:</span>
  <span class="hljs-attr">master_key:</span> <span class="hljs-string">sk-1234</span>
  <span class="hljs-attr">database_url:</span> <span class="hljs-string">"postgresql://postgres:password@127.0.0.1:5432/litellm"</span>
  <span class="hljs-attr">custom_auth:</span> <span class="hljs-string">custom_auth.user_api_key_auth</span>  <span class="hljs-comment"># 模块路径.函数名</span>
</code></pre>
<p>然后重启 LiteLLM Proxy 服务，此时，任何 <code>my-custom-key-</code> 开头的 Key 都能通过验证了：</p>
<pre><code class="hljs language-bash" lang="bash">$ curl -X POST <span class="hljs-string">'http://127.0.0.1:4000/chat/completions'</span> \
  -H <span class="hljs-string">'Authorization: Bearer my-custom-key-888'</span> \
  -H <span class="hljs-string">'Content-Type: application/json'</span> \
  -d <span class="hljs-string">'{
    "model": "gpt-4o",
    "messages": [{"role": "user", "content": "你好"}]
  }'</span>
</code></pre>
<p>值得注意的是，在认证流程中，自定义认证是最优先执行的，因此如果开启了该功能，Master Key 和 虚拟 Key 就不起作用了。为了同时兼容，企业版的 LiteLLM 支持一个更灵活的混合模式：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">general_settings:</span>
  <span class="hljs-attr">custom_auth:</span> <span class="hljs-string">custom_auth.user_api_key_auth</span>
  <span class="hljs-attr">custom_auth_settings:</span>
    <span class="hljs-attr">mode:</span> <span class="hljs-string">"auto"</span>  <span class="hljs-comment"># 支持虚拟 Key 和自定义认证混用</span>
</code></pre>
<p>当自定义认证失败后，LiteLLM 会继续沿用虚拟 Key 的验证流程。</p>
<h2 data-id="heading-11">小结</h2>
<p>通过这篇文章，我们系统地学习了 LiteLLM Proxy 的认证机制，这是构建企业级 LLM 网关的核心基础。主要内容包括：</p>
<ul>
<li><strong>虚拟 Key 认证</strong>：LiteLLM 最核心的认证方式，通过为每个用户或应用生成独立的 API Key，实现细粒度的权限隔离和使用追踪；采用哈希存储和分层缓存策略确保了安全性和性能的平衡；支持多种 Header 格式使其能够兼容各种客户端和工具；</li>
<li><strong>JWT 认证与 OIDC 集成</strong>：为企业用户提供了一条与现有身份认证系统无缝集成的路径，无需在 LiteLLM 中维护独立的用户数据库，充分利用企业已有的 IAM 基础设施；</li>
<li><strong>自定义认证</strong>：完全开放的认证扩展机制，允许企业根据特定的业务规则实现复杂的认证逻辑，支持与任何现有系统的集成；企业版提供了混合模式，可以同时支持虚拟 Key 和自定义认证；</li>
</ul>
<p>LiteLLM 的认证设计体现了分层的思想：从基础的虚拟 Key 面向个人开发者和小型团队，到 JWT/OIDC 面向已有 IAM 的企业，再到自定义认证面向有特殊需求的场景。这种分层的、可扩展的设计，使得 LiteLLM 能够适应从个人项目到大规模企业级应用的各种场景。</p>
<p>在后续的学习中，我们将继续深入 LiteLLM 的权限管理和访问控制系统，学习如何为不同的用户和团队分配不同的权限，如何追踪使用情况和成本，如何设置预算限额防止滥用。敬请期待！</p>
<h2 data-id="heading-12">欢迎关注</h2>
<p>如果这篇文章对您有所帮助，欢迎关注我的同名公众号：<a href="https://link.juejin.cn?target=https%3A%2F%2Fi-study-everyday.online%2Fabout-me.html" target="_blank" title="https://i-study-everyday.online/about-me.html" ref="nofollow noopener noreferrer">日习一技，每天学一点新技术</a>。</p>
<p>我会每天花一个小时，记录下我学习的点点滴滴。内容包括但不限于：</p>
<ul>
<li>某个产品的使用小窍门</li>
<li>开源项目的实践和心得</li>
<li>技术点的简单解读</li>
</ul>
<p>目标是让大家用5分钟读完就能有所收获，不需要太费劲，但却可以轻松获取一些干货。不管你是技术新手还是老鸟，欢迎给我提建议，如果有想学习的技术，也欢迎交流！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[你的游戏没有这个怎么能够顺利出海？]]></title>    <link>https://juejin.cn/post/7574289653178105894</link>    <guid>https://juejin.cn/post/7574289653178105894</guid>    <pubDate>2025-11-20T00:37:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574289653178105894" data-draft-id="7573899782803046446" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="你的游戏没有这个怎么能够顺利出海？"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-20T00:37:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="亿元程序员"/> <meta itemprop="url" content="https://juejin.cn/user/1972988307323236"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            你的游戏没有这个怎么能够顺利出海？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972988307323236/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    亿元程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T00:37:01.000Z" title="Thu Nov 20 2025 00:37:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>点击上方亿元程序员+关注和★星标</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/299cb16684744dafae89656a99903bb7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203821&amp;x-signature=ilujT9mI1Y9zXFOvGcBFVrHuRCs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">引言</h2>
<p><strong>哈喽大家好</strong>，不知道小伙伴们最近有没有发现，如今的游戏出海，已经不是从前的粗放买量靠堆砌素材喂算法了，现在都在拼长线运营或者<code>AI</code>了。</p>
<p><strong>其中</strong><code>Supercell</code>的《荒野乱斗》就是最好的例子，上线五年了，如今成功逆袭。</p>
<p><strong>笔者想起</strong>，八年前就已经参与过游戏的多语言版本了，那时候的主流是港台（繁体）、东南亚（英文）、韩国（韩文）。</p>
<p><strong>除去</strong>接入对应的<code>SDK</code>外，最为深刻的就是翻译和本地化，那时候不需要很高端的操作，就是把游戏内所有的中文整理出来，给到专门负责翻译的人，完成后导回到游戏即可。</p>
<p><strong>其中</strong>最头疼的就是英文，两个字能变<code>10</code>多个字母，很容易导致超框，以上的处理有个“国际化”的简称，叫<code>i18n</code>。</p>
<p><strong>言归正传</strong>，今天我们就来聊聊<code>i18n</code>。</p>
<h2 data-id="heading-1">什么是i18n？</h2>
<p><strong>先简单科普一下</strong></p>
<blockquote>
<p><code>i18n</code>是国际化的简称，来源是英文单词<code>internationalization</code>的首末字符<code>i</code>和<code>n</code>，<code>18</code>为单词中间的字符数。</p>
<p><strong>在资讯领域</strong>，国际化（<code>i18n</code>）可以让产品无需做大的改变，就能够满足不同语言和地区的需要。</p>
</blockquote>
<h2 data-id="heading-2">i18n的优势是什么？</h2>
<p><strong>对程序来说</strong>，在不修改内部代码的情况下，就能根据不同语言及地区切换相应的语言界面。</p>
<p><strong>正如笔者</strong>引言所说，把文本交给翻译人员，回来后原路返回即可。</p>
<p><strong>从</strong>最开始就制定严格的规范，所有的文本都需要通过<code>i18n</code>，这样能够减少后期提取文本和导回文本的麻烦操作。</p>
<h2 data-id="heading-3">一起来看个例子</h2>
<p><strong>既然</strong><code>i18n</code>如此重要，那么我们一起来看看它在<code>Cocos</code>游戏开发中如何使用。</p>
<h3 data-id="heading-4">1.安装插件</h3>
<p><strong>首先</strong>在<code>Store</code>找到<code>i18n多语言化插件</code>，选择添加到项目即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ba7c927e27b4c2e8d6dc4ab1158732f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203821&amp;x-signature=XgylglRwvdPzCZ54aT8puW9khFA%3D" alt="" loading="lazy"/></p>
<p><strong>添加</strong>完成之后，就可以在资源管理器看到插件对应的脚本，分别对应数据、<code>Label</code>管理和<code>Sprite</code>管理。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2984acb3e8004703a35d16fdb311c9c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203821&amp;x-signature=E6XzlE38gCsdMTS7innLa1Fpcok%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">2.添加语言</h3>
<p><strong>首先</strong>通过菜单<code>扩展-&gt;I18n Setting</code>打开本地化控制面板。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54a3bf11e5f842719cc58935a9b4d7fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203821&amp;x-signature=wZpTzVLf2sctnN8Wn1swZ0LGHIs%3D" alt="" loading="lazy"/></p>
<p><strong>简单</strong>添加<code>8</code>个语言，从下到上分别为中文、俄语、韩语、日语、法语、西班牙语、英语和德语（首字母排序）。</p>
<p><strong>为什么</strong>是<code>8</code>个？因为可以和别人说你“精通”八国语言（你好，世界）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/892140f7b7ef41ffaffcb76cd110341e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203821&amp;x-signature=YymRssWPjfSa2qyJCr9r2RGvrWg%3D" alt="" loading="lazy"/></p>
<p><strong>编辑完成</strong>后，插件会自动在<code>resources\i18n</code>目录生成对应的<code>Ts</code>配置文件。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b9aa737c71c429e86900d236b3226f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203821&amp;x-signature=DNLVfReFpMXmYxejlz5a6hnuL9E%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">3.编辑中文</h3>
<p><strong>在</strong><code>zh.ts</code>中添加<code>你好，世界</code>，作为示例。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ddc9c93f7b4046bd98ccf7e4dc456acf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203821&amp;x-signature=jyJA1BGp0117tt2q%2FBZf%2BmANOc0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">4.翻译其他7种语言</h3>
<p><strong>把</strong>完成的所有中文内容，交给专业的翻译人员进行翻译，获得其余<code>7</code>种语言，我们这里简单示例就找搭子就行。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48b7b66f083a4e9280fa3b449062b6c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203821&amp;x-signature=bIEOrl%2BO5iiBahbiGpJvV%2B66itU%3D" alt="" loading="lazy"/></p>
<p><strong>还是</strong>非常靠谱的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e2eb2ec3e4c4ea89fe4c5606d918867~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203821&amp;x-signature=m0BEn5rmyk%2FWhD2le%2BUEh0LGNEs%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">5.LocalizedLabel组件</h3>
<p><strong>插件</strong>生成的<code>LocalizedLabel</code>组件，就是对<code>Label</code>的简单封装，根据<code>key</code>和语言配置获取对应的文本。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc58329c3de342b5b4bcaa8347faae93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203821&amp;x-signature=2vF0wLoAQnBlZOkCcSD70y6D00I%3D" alt="" loading="lazy"/></p>
<p><strong>直接</strong>挂到<code>Label</code>组件上，配置对应的文本的<code>key</code>即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0253d1d04d9541be82ceb25ba638cce9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203821&amp;x-signature=KVVLx8oGfuA3dD2r1thhUFDvY4E%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">6.效果演示</h3>
<p><strong>我们</strong>通过点击本地化编辑面板中不同语言的“小眼睛”，即可完成语言的切换，并且看到切换语言后的效果。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd63b17827cc4690810f76b9c26da1fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203821&amp;x-signature=yE08QY7JkL3To3aIbJPgeCnNMkY%3D" alt="" loading="lazy"/></p>
<p><strong>上面</strong>只是编辑器演示，实际需要修改默认语言，可以在脚本中修改。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9131cf818e74fec8f0a6b2e71d79c53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203821&amp;x-signature=eMSCKBSv2B%2BRpT5db2tEUrustZY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">7.进阶</h3>
<p><strong>如果</strong>一个包体内有多种语言，想要支持动态切换语言，可以通过<code>import * as i18n from 'db://i18n/LanguageData';</code>导入<code>i18n</code>，并通过<code>i18n.init('en');</code>进行语言切换，最后通过<code>i18n.updateSceneRenderers();</code>刷新即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ca0bdb886d147c18ac70c63cd24a594~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203821&amp;x-signature=%2FlcJuCW6%2BdSbO1szbYtuEpK4rNo%3D" alt="" loading="lazy"/></p>
<p><strong>此外</strong>，<code>LocalizedSprite</code>组件也是同理，对<code>Sprite</code>的简单封装。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b9e67854df947fb81528a7f6a093dca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203821&amp;x-signature=mcpVumlYqm4VFB6sTskVI%2BYH6yw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11">结语</h2>
<p><strong>当然了</strong>，并非所有的项目都需要使用这套插件，国际化的逻辑还是简单的，一般公司项目都有自己的技术积累，有自己的实现。</p>
<p><strong>其实</strong>最主要是一个规范的问题，通过语言包的限制，避免文本到处都是。但是也使得配置表比较难以配置，这个需要小伙伴们自己权衡了。</p>
<p><strong>你们使用的是什么方案？</strong></p>
<p><strong>我是"亿元程序员"，一位有着8年游戏行业经验的主程。在游戏开发中，希望能给到您帮助, 也希望通过您能帮助到大家。</strong></p>
<p>AD:笔者线上的小游戏《打螺丝闯关》《贪吃蛇掌机经典》《重力迷宫球》《填色之旅》《方块掌机经典》大家可以自行点击搜索体验。</p>
<p>实不相瞒，想要个<strong>赞</strong>和<strong>爱心</strong>！请把该文章<strong>分享</strong>给你觉得有需要的其他小伙伴。谢谢！</p>
<p>推荐专栏：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzg5NTY2MjIzMg%3D%3D%26action%3Dgetalbum%26album_id%3D3175880857546129410%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg5NTY2MjIzMg==&amp;action=getalbum&amp;album_id=3175880857546129410#wechat_redirect" ref="nofollow noopener noreferrer">知识付费专栏</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzg5NTY2MjIzMg%3D%3D%26mid%3D2247487282%26idx%3D1%26sn%3De3cb8ab6f5c0d5f804d5c29e2e90b9ad%26chksm%3Dc00daec5f77a27d33933e877464d8cde24c4c947d3755f5e8262c634634617e7c26de3953a54%26token%3D336413522%26lang%3Dzh_CN%23rd" target="_blank" title="https://mp.weixin.qq.com/s?__biz=Mzg5NTY2MjIzMg==&amp;mid=2247487282&amp;idx=1&amp;sn=e3cb8ab6f5c0d5f804d5c29e2e90b9ad&amp;chksm=c00daec5f77a27d33933e877464d8cde24c4c947d3755f5e8262c634634617e7c26de3953a54&amp;token=336413522&amp;lang=zh_CN#rd" ref="nofollow noopener noreferrer">你知道和不知道的微信小游戏常用API整理，赶紧收藏用起来~</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzg5NTY2MjIzMg%3D%3D%26action%3Dgetalbum%26album_id%3D3207702867494305797%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg5NTY2MjIzMg==&amp;action=getalbum&amp;album_id=3207702867494305797#wechat_redirect" ref="nofollow noopener noreferrer">100个Cocos实例</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzg5NTY2MjIzMg%3D%3D%26action%3Dgetalbum%26album_id%3D3073771187570999299%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg5NTY2MjIzMg==&amp;action=getalbum&amp;album_id=3073771187570999299#wechat_redirect" ref="nofollow noopener noreferrer">8年主程手把手打造Cocos独立游戏开发框架</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzg5NTY2MjIzMg%3D%3D%26action%3Dgetalbum%26album_id%3D3121583619634626562%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg5NTY2MjIzMg==&amp;action=getalbum&amp;album_id=3121583619634626562#wechat_redirect" ref="nofollow noopener noreferrer">和8年游戏主程一起学习设计模式</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3Faction%3Dgetalbum%26__biz%3DMzg5NTY2MjIzMg%3D%3D%26scene%3D1%26album_id%3D3038883468588089350%26count%3D3%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?action=getalbum&amp;__biz=Mzg5NTY2MjIzMg==&amp;scene=1&amp;album_id=3038883468588089350&amp;count=3#wechat_redirect" ref="nofollow noopener noreferrer">从零开始开发贪吃蛇小游戏到上线系列</a></p>
<p>点击下方灰色按钮+关注。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Gemini 3.0来，它带着王炸来了]]></title>    <link>https://juejin.cn/post/7574343024324083753</link>    <guid>https://juejin.cn/post/7574343024324083753</guid>    <pubDate>2025-11-20T00:37:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574343024324083753" data-draft-id="7574286569038856255" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Gemini 3.0来，它带着王炸来了"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-20T00:37:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MobotStone"/> <meta itemprop="url" content="https://juejin.cn/user/3839909554568840"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Gemini 3.0来，它带着王炸来了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3839909554568840/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MobotStone
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T00:37:43.000Z" title="Thu Nov 20 2025 00:37:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>期待半个多月，Gemini 3.0 终于登场了。</p>
<p>真正让我瞠目结舌的，却不是模型本身，而是它身后那款全新的开发工具——Google Antigravity IDE。消息一出，我的舆情监控小应用第一时间也推送了这个好消息。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c2ef0e0421946bba53f25ab42ba109b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9ib3RTdG9uZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203863&amp;x-signature=h3tKlS2Kev3IF7hE1Ejl2jKpsgo%3D" alt="" loading="lazy"/></p>
<p>老实说，哪怕这两年眼看着 AI 产品一波接一波地涌出来，谷歌这次的出手，还是有点让人猝不及防。</p>
<p>自从 2023 年底 Gemini 首次亮相，我就一直盯着谷歌在 AI 领域的每一步：模型怎么迭代、产品怎么整合、和自家生态怎么绑在一起。到了 Gemini 3，这条产品线突然加速，开始尝试一件此前从未做过的事——在发布的第一天，就把一个全新的模型直接塞进搜索里，让亿级用户当“首批内测用户”。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4eb746ac24146169714dd7690382ce5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9ib3RTdG9uZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203863&amp;x-signature=p4Wy7SvEKqMPuQJn4TMNCc4riKQ%3D" alt="" loading="lazy"/></p>
<p>更有意思的是，谷歌并不满足于“做个模型给别人用”，而是顺手又扔出来一个全新的智能编码平台：Google Antigravity。这个平台的定位很明确，就是奔着 Cursor 2.0 这类工具去的，正面对刚，毫不遮掩。</p>
<p>从第三方评测来看，Gemini 3 Pro 在 LMArena 上拿到了 1501 分，已经把前代的 1451 分甩在身后，同时也超过了目前市面上其他所有主流前沿模型。数据当然不是全部，但至少说明一件事：这不是例行公事的“小升级”，而是一次有备而来的重提速。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/514c0d55f85249c8a17df9db1c330787~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9ib3RTdG9uZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203863&amp;x-signature=qbeeI0yrDhrrKAOR6Eh5ZPiofH4%3D" alt="" loading="lazy"/></p>
<p>它已经具备了堪比博士的推理水准，既懂学术规范，也熟悉研究流程，还能在一轮对话中同时处理多达一百万个词元的上下文信息。</p>
<p>但有意思的地方，不只是“更强一点”这么简单。</p>
<p>谷歌真正动手改造的，是整个模型的能力版图——<em><strong>从实时生成可交互的视觉界面，到自主搭建一整套应用，再顺带把自己的代码拉出来测试一遍。</strong></em></p>
<h2 data-id="heading-0">什么是 Gemini 3 Pro？</h2>
<p>谷歌发布了新的基础模型 Gemini 3。今天开始，用户可以在 Gemini 应用、AI Studio、Vertex AI 和谷歌搜索中试用公开预览版。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0858e83bdef4431ca809a2ab0ac53256~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9ib3RTdG9uZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203863&amp;x-signature=zQ4BPpEOUPYuG3XjQMi9BvmTJEQ%3D" alt="" loading="lazy"/></p>
<p>谷歌说，这是他们"最智能的模型"，能够帮助用户"将任何想法变为现实"。</p>
<p>这次发布有两个版本。</p>
<ul>
<li>第一个是 Gemini 3 Pro，现在所有用户都能使用。它的推理能力、多模态理解能力和编码功能都很先进。</li>
<li>第二个是 Gemini 3 Deep Think，这是一个增强型推理模式。谷歌说，需要进行额外的安全测试，几周后才会向 Google AI Ultra 订阅用户开放。</li>
</ul>
<h2 data-id="heading-1">技术基础</h2>
<p>Gemini 3 Pro 用了一种叫“稀疏混合专家”的架构，参数规模超过1万亿——听着吓人，但实际用起来很聪明。它不会傻乎乎地每次把整个模型都拉出来干活，而是像老中医把脉一样，精准地把任务分给最对口的“专家小组”。你想啊，一家1000人的公司，开个产品讨论会，总不能把保洁阿姨和财务总监都叫来吧？Gemini 3 就是这个道理：输入一个问题，它自动挑出最懂行的子网络来处理，其他部分该休息就休息。这样既省电费（计算成本低），效果还一点不打折，性能照样顶尖。这设计真像极了我们日常：人尽其才，物尽其用。</p>
<h2 data-id="heading-2">核心能力</h2>
<ul>
<li><strong>超大记忆容量</strong>：上下文窗口有100万个词符——相当于70万单词，或者一口气聊完10本《三体》的篇幅。长对话、复杂任务？它都能稳稳记住上下文，不会前言不搭后语。</li>
<li><strong>多面手本事</strong>：文字、图片、音频、视频、代码？统统能嚼碎了消化。不是简单“支持”，是真能融会贯通，像你同时用眼睛看图、耳朵听声、脑子写代码一样自然。</li>
<li><strong>输出不缩水</strong>：每次回复最多吐出64,000个token，写篇万字长文或生成完整代码模块都不在话下。</li>
<li><strong>知识保鲜期</strong>：学到的内容更新到2025年1月，像刚出炉的面包，新鲜度刚好。</li>
</ul>
<h2 data-id="heading-3">用起来有多方便？</h2>
<p>今天起，Gemini 3 已经铺好路，你挑条顺脚的走就行：</p>
<ul>
<li><strong>Gemini App</strong>：手机点开就用，全民免费——技术普及就该这样，别搞成贵族游戏。</li>
<li><strong>Google AI Studio</strong>：开发者福音，免费额度宽松，调接口、测模型像玩玩具一样轻松。</li>
<li><strong>Vertex AI</strong>：企业级重装备，数据安全、高并发需求？交给它，省心。</li>
<li><strong>Gemini CLI</strong>：命令行极客的最爱，几行代码调用大模型，效率翻倍。</li>
<li><strong>AI Mode in Search</strong>：Google AI Pro 和 Ultra 订阅用户的彩蛋，搜索时秒变智能助手。</li>
<li><strong>Google Antigravity</strong>：全新智能体开发平台（下文细聊），让AI自主干活成为日常。</li>
</ul>
<p>Gemini 3 也已经接入了一些常用的开发与协作平台，如 Cursor、GitHub Copilot、JetBrains 和 Replit 等，可以比较自然地融入现有工作流。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6423c7aaac644ba19dcafcace90ed56e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9ib3RTdG9uZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203863&amp;x-signature=gfskiDhlwEZ8h%2F4g1fYEPIVQBI8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">工作原理</h2>
<p>和前几代相比，Gemini 3 更像是“听得懂人话”的模型。 你不必精心设计提示词，也不用和它打太多“哑谜”，只要正常说明需求，它基本都能领会你的意思，并给出相对合适的回答。</p>
<p>它被设计成可以抓住“深度和细微差别”的系统——既能读懂创意表达中的小心思，也能一层层拆解复杂问题。</p>
<p>在训练阶段，Google 给它喂了非常广泛的数据： 包括网页文档、程序代码、图片、音频、视频，以及由其他 AI 系统生成的合成数据等。</p>
<p>所有训练数据都要先经过过滤：不合规的内容会被剔除，比如色情、极端暴力，以及任何违反儿童安全相关法律的材料。</p>
<p>训练过程中，用到的是 Google 自家的张量处理单元（TPU），配合 JAX 和 ML Pathways 这套软件栈来完成大规模训练。</p>
<h2 data-id="heading-5">Gemini 3 的“深度思考模式”：不止聪明，更会思考</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/859b44ea9be04111b5c36f499c243a65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9ib3RTdG9uZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203863&amp;x-signature=zX79H0A6ppI3wQgjCs4JRoOljoo%3D" alt="" loading="lazy"/></p>
<p>现在，Gemini 3 又推出了一项杀手锏——“深度思考模式”。顾名思义，它能让模型在面对那些最烧脑、最具挑战性的问题时，展现出更强大的推理能力。</p>
<p>这项新能力，让它的“考试成绩”也实现了飞跃：</p>
<ul>
<li><strong>人类的最后考试</strong>：它的得分是<strong>41.0%</strong> （而标准版 Gemini 3 Pro 只有 37.5%）。</li>
<li><strong>GPQA钻石级测试</strong>：成功率达到了惊人的<strong>93.8%</strong> （此前是 91.9%）。</li>
<li><strong>ARC-AGI-2</strong>：在这个需要创新性问题解决能力的测试中，它的代码执行成功率高达<strong>45.1%</strong> 。这可不仅仅是记住答案，而是真正展现出了“举一反三”的创新思考能力。</li>
</ul>
<blockquote>
<p><strong>不过，这个“深度思考模式”不会一下子全部开放。谷歌会采取分阶段策略：它将首先面向安全测试人员开放体验，收集反馈。在接下来的几周内，Google AI Ultra 的订阅用户也将陆续能够尝鲜。</strong></p>
</blockquote>
<p>这种“小步快跑”的实施方式，是为了给谷歌留足充分的时间，来收集用户反馈，并确保这项增强的推理能力在大规模应用时，也能保持稳定高效。</p>
<h2 data-id="heading-6">竞争格局分析</h2>
<p>Gemini 3 Pro 的发布，正值大模型市场竞争最白热化的阶段。目前的市场环境可谓强敌环伺：</p>
<ul>
<li>OpenAI GPT-5 &amp; 5.1：于 2025 年 8 月发布，11 月进行了更新。虽然 OpenAI 号称 ChatGPT 周活用户达到 8 亿，但 8 月份的首发普遍被市场认为表现平平，缺乏惊喜。</li>
<li>Anthropic Claude Sonnet 4.5 &amp; Opus 4：以强大的推理能力著称，在开发者和企业用户中口碑极佳，具有很强的“人格化”特征。</li>
<li>xAI Grok 4.1：2025 年 11 月发布，主打卖点是相比前代大幅减少了“幻觉”问题。</li>
</ul>
<p>基准测试（Benchmarks）显示，Gemini 3 Pro 在推理和多模态任务上处于领先地位。不过，在实际应用场景中，性能差异往往因人而异。</p>
<p>从技术架构上看，Gemini 3 采用了混合专家模型（MoE）。相比 GPT 和 Claude 等密集型模型，这种架构在运行效率上更具优势。</p>
<blockquote>
<p><em><strong>但真正的竞争优势在于生态链使用。</strong></em></p>
</blockquote>
<p>技术指标固然重要，但谷歌真正的杀手锏在于生态链使用。</p>
<blockquote>
<p><em><strong>这一次，谷歌展示了什么是绝对的规模优势。</strong></em></p>
</blockquote>
<p>看看这组数据：</p>
<ul>
<li><strong>AI Overviews</strong>：月活跃用户 20 亿。</li>
<li><strong>Gemini App</strong>：月活跃用户 6.5 亿（作为对比，ChatGPT 的周活跃用户为 7 亿）。</li>
<li><strong>Google Cloud AI</strong>：超过 70% 的云客户已接入。</li>
<li><strong>开发者生态</strong>：1300 万开发者正在使用 Gemini 模型构建应用。</li>
</ul>
<p>这意味着什么？意味着谷歌可以将 Gemini 3 无缝集成到搜索、Gmail、文档、YouTube、Android 等数十个产品中。</p>
<blockquote>
<p><strong>这些产品每天都有数十亿人在使用。</strong></p>
</blockquote>
<p>目前，没有其他人工智能公司拥有丰富的生态链。</p>
<h2 data-id="heading-7">Gemini 3.0 的局限性</h2>
<p>当然，完美的模型并不存在。谷歌在模型卡（Model Card）中坦诚了 Gemini 3 存在的局限：</p>
<ul>
<li><strong>幻觉（Hallucinations）</strong> ：模型仍然可能产生错误信息，并且一本正经地当作事实陈述。</li>
<li><strong>偶发性卡顿</strong>：在处理复杂查询时，响应速度可能会变慢。</li>
<li><strong>上下文混淆</strong>：在冗长的对话中，模型有时会“忘记”之前的细节。</li>
<li><strong>安全边界</strong>：系统严格限制了涉及危险活动、色情、暴力、仇恨言论和虚假信息的生成。</li>
</ul>
<p>值得一提的是，该模型接受了谷歌迄今为止最全面的安全评估，测试方包括英国 AISI、Apollo、Vaultis、Dreadnode 等独立机构。</p>
<blockquote>
<p><strong>相比前代版本，Gemini 3 减少了“阿谀奉承”的倾向，更能抵御提示词注入（Prompt Injection）攻击，并且针对网络攻击滥用做了更好的防护。</strong></p>
</blockquote>
<h2 data-id="heading-8">最后想说的话</h2>
<p>谷歌这次的发布与以往有所不同。</p>
<blockquote>
<p><strong>Gemini 3 Pro 不仅刷榜了几乎所有基准测试，更重要的是引入了新范式：比如“生成式 UI”（Generative UI）以及 Antigravity 中的“<strong><strong>Agent</strong></strong>优先”（Agent-first）开发体验。</strong></p>
</blockquote>
<p>这是一个全球同步推进的战略举措。</p>
<p>目前的局面是：OpenAI 的 GPT-5 反响平平，Anthropic 赢得了开发者的心，而谷歌手握绝对的生态优势。</p>
<p>Antigravity 直接对标 Cursor 等代码工具，试图挑战现有的编程工作流；生成式 UI 则试图将 AI 的文本回复直接转化为交互式应用程序。</p>
<p>Gemini 时代开启已有两年。从目前的态势看，谷歌似乎暂时处于领先地位。</p>
<p>至于未来如何，时间会给出答案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[小米技术教父，离职创业了！]]></title>    <link>https://juejin.cn/post/7574269207363256329</link>    <guid>https://juejin.cn/post/7574269207363256329</guid>    <pubDate>2025-11-20T00:39:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574269207363256329" data-draft-id="7574322843048722482" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="小米技术教父，离职创业了！"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2025-11-20T00:39:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CodeSheep"/> <meta itemprop="url" content="https://juejin.cn/user/4371313961738616"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            小米技术教父，离职创业了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4371313961738616/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CodeSheep
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T00:39:31.000Z" title="Thu Nov 20 2025 00:39:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近，科技圈的又一位技术大佬被曝入局创业了。</p>
<p>没错，他就是小米的技术教父、小米前副总裁，同时也是雷军在武大念书时的下铺兄弟，并且在拍照时可以和雷军并列而坐的技术大佬崔神：</p>
<p><strong>崔宝秋</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb1de87a2f434f29ad09f736f77d6c50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203970&amp;x-signature=s3e6CjinS8aBnNyyVTtxnw7Opx0%3D" alt="崔宝秋（第一排右二）" loading="lazy"/></p>
<p>那这一次创业，据说大佬瞄准的也是当下炙手可热的「<strong>具身智能</strong>」赛道，创业方向为「<strong>家庭服务机器人</strong>」方向。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/976faa20965545f8be70e03eeb8a967e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203970&amp;x-signature=0EEXmWMiIRW7A2m0IIp6RZ7Jeww%3D" alt="" loading="lazy"/></p>
<p>并且在这次创业消息被曝之前，据传大佬已与多家顶级 VC 深入接洽，融资等进展顺利。</p>
<p><strong>说回到小米的发展历程，崔宝秋是其绕不开的一个人</strong>。</p>
<p>大家都知道，小米这个公司以产品见长。</p>
<p>提到小米产品，大家基本上都耳熟能详。从智能手机到影音数码，从家电生活到智能家居，另外各种软件、平台、云服务、OS等都在持续发力，包括现在又在全速力推新能源智能汽车，软硬件产品线可以说覆盖得非常广泛。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d3c9d5d49a74888b30e511d32cc9c15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203970&amp;x-signature=uN%2FQ4C9C55KsyemyBoCr%2F3nNWP8%3D" alt="" loading="lazy"/></p>
<p>但是说到「<strong>小米技术</strong>」，大家反而可能没有什么特别深的印象。</p>
<p>不过提到小米技术，就不得不提：<strong>小米集团技术委员会</strong>，其诞生于 2019 年初。</p>
<p>当时的 2018 年 Q4 季度，国内智能手机市场前五曾分别为：</p>
<p>华为、OPPO、VIVO、苹果、小米。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d6960606f90400eac7c06571b99a159~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203970&amp;x-signature=b9tmTdZ5kSVsap035wggBkmUTbo%3D" alt="" loading="lazy"/></p>
<p>其中前三家国产手机厂商出货量增幅均为正增长，而当时排名第 5 的小米则出现了较大跌幅。</p>
<p>彼时的雷军开始在内部会议中一直强调的一件事情就是：</p>
<p><strong>技术事关小米生死存亡</strong>。</p>
<p>在随后不久后的 2019 年 2 月，小米就专门成立了<strong>集团技术委员会</strong>，主要负责把握集团的技术方向，预研前沿技术，以及推动技术创新和成果转化。</p>
<p>小米技术委员会在小米的科技创新和产品研发中扮演着重要的角色。</p>
<p>而首任挂帅的正是小米当时的技术大牛：<strong>崔宝秋</strong>。</p>
<p>而聊起小米的技术研发，他更是绕不开的一个人。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42e257311fa84cb2bbedbee80090f3bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203970&amp;x-signature=Zi%2By%2FTASOi4wnRn1aLGdXSw82rA%3D" alt="" loading="lazy"/></p>
<p>崔宝秋和雷军都是武汉大学计算机系的同学，而且同时还是同寝室的上下铺室友。</p>
<p>在加入小米之前，崔宝秋在国外生活工作过很多年。</p>
<p>他曾在 IBM、雅虎和 LinkedIn 等知名公司负责研发，积累了丰富的技术和管理经验。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67047633f4cd42f990940b7b2d2063d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203970&amp;x-signature=rwKuHjGLlv0ovd%2FOfd%2FIqEpzxoI%3D" alt="" loading="lazy"/></p>
<p>众所周知，2012 年时候小米的手机业务初露头角。</p>
<p>同样也是这一年，崔宝秋应雷军之邀回国加入小米工作，并成为小米的首席架构师。</p>
<p>提到崔宝秋，有网友称其为“小米的技术教父”。</p>
<p>确实，崔宝秋在小米期间担任过多个重要职务，包括首席架构师、人工智能与云平台副总裁、集团技术委员会主席和集团学习发展部总经理等。</p>
<p>除此之外，他在小米期间的一个重大贡献就是主导并推动了小米「<strong>云计算-大数据-人工智能</strong>」的技术变革主线，为小米后来的技术发展奠定了基础。</p>
<p>然而，根据小米发布的内部全员信，2022 年底崔宝秋因个人原因从小米离职。</p>
<p>至此，崔神在小米的这段长达十年的职业生涯，也宣告结束了。</p>
<p>而这十年，也是小米这家公司从蓄力到发展，从厚积到薄发的十年。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/421ce1bbc3304c0f8e5802a0cb67bd7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764203970&amp;x-signature=SFrQ5Wl1LDdQUVtp1Cxd8YBBMtA%3D" alt="" loading="lazy"/></p>
<p>自 2022 年底，崔宝秋从小米集团离职后在业界似乎一直就“隐身”了，随后几年也一直没有看到他比较明显的下一步职场动向。</p>
<p>那这一次机器人创业也是崔宝秋离职小米两年多后的一个比较大的动作。</p>
<p>怎么说呢，祝福崔神，也期待后续能看到大佬更多的发展和动向。</p>
<blockquote>
<p>注：本文在GitHub开源仓库「编程之路」 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frd2coding%2FRoad2Coding" target="_blank" title="https://github.com/rd2coding/Road2Coding" ref="nofollow noopener noreferrer">github.com/rd2coding/R…</a> 中已经收录，里面有我整理的6大编程方向(岗位)的自学路线+知识点大梳理、面试考点、我的简历、几本硬核pdf笔记，以及程序员生活和感悟，欢迎star。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Prisma 7 重磅发布：告别 Rust，拥抱 TypeScript，性能提升 3 倍]]></title>    <link>https://juejin.cn/post/7574343024324149289</link>    <guid>https://juejin.cn/post/7574343024324149289</guid>    <pubDate>2025-11-20T00:45:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574343024324149289" data-draft-id="7469816262752878603" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Prisma 7 重磅发布：告别 Rust，拥抱 TypeScript，性能提升 3 倍"/> <meta itemprop="keywords" content="前端,后端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-20T00:45:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Moment"/> <meta itemprop="url" content="https://juejin.cn/user/3782764966460398"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Prisma 7 重磅发布：告别 Rust，拥抱 TypeScript，性能提升 3 倍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3782764966460398/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Moment
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T00:45:47.000Z" title="Thu Nov 20 2025 00:45:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>最近在使用 NestJs 和 NextJs 在做一个协同文档 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxun082%2FDocFlow" target="_blank" title="https://github.com/xun082/DocFlow" ref="nofollow noopener noreferrer">DocFlow</a>，如果感兴趣，欢迎 star，有任何疑问，欢迎加我微信进行咨询 <code>yunmz777</code></p>
<p>2025 年 11 月 19 日，Prisma 团队正式发布了 Prisma ORM 和 Prisma Postgres 的最新版本——Prisma 7。在过去的一年中，Prisma 团队始终将开发者体验放在首位，致力于让使用 Prisma 构建应用程序变得更加简单、高效。无论开发者使用何种开发工具，或选择在哪个平台部署，Prisma 7 都将带来卓越的开发体验。</p>
<h2 data-id="heading-0">为未来而设计</h2>
<h3 data-id="heading-1">愿景与承诺</h3>
<p>2024 年 12 月，Prisma 团队发布了 Prisma ORM 的未来发展路线图，详细阐述了他们的愿景以及实现这些目标的计划。这不仅仅是一份产品规划文档，更是 Prisma 团队对 Prisma ORM 未来发展的明确承诺，以及他们如何持续支持开发者社区的坚定决心。</p>
<p>与此同时，Prisma 团队还推出了自己的托管 Postgres 服务——Prisma Postgres。这款产品以简洁性和高性能为核心设计理念，旨在为开发者提供一个开箱即用的数据库解决方案，让开发者能够享受到与 Prisma ORM 同样出色的开发者体验。</p>
<p>随着 ORM 路线图的发布和 Prisma Postgres 的推出，Prisma 团队为构建下一代工具奠定了坚实的基础。市场反馈超出了他们的预期：ORM 的市场份额和使用量实现了显著增长，而 Prisma Postgres 在个人项目和商业应用中的采用率也令人瞩目。</p>
<h2 data-id="heading-2">重大技术突破</h2>
<h3 data-id="heading-3">从 Rust 到 TypeScript：一次大胆的架构转型</h3>
<p>在 Prisma 6.0.0 发布时，Prisma 团队承诺将带来更好的性能、更强的灵活性以及更完善的类型安全性。为了实现这些目标，他们需要做出一些根本性的改变。</p>
<h4 data-id="heading-4">为什么选择离开 Rust？</h4>
<p>Prisma 团队做出了一个看似反直觉的决定：将 Prisma Client 从 Rust 迁移到 TypeScript。对于许多人来说，这可能是一个令人困惑的选择，毕竟 Rust 以其卓越的性能而闻名。但在 Prisma 的场景下，性能只是故事的一部分。</p>
<p>使用 Rust 构建客户端的一个显著副作用是，它限制了社区贡献者的参与门槛。如果开发者没有深厚的 Rust 开发经验，想要为 ORM 做出有意义的贡献将变得非常困难。从技术角度来看，Rust 与 JavaScript 运行时之间的通信层比纯 JavaScript 实现要慢得多，同时还会在运行时层面引入额外的依赖关系。</p>
<p>Deno 团队的 Luca Casonato 对此深有感触：</p>
<blockquote>
<p>"当我们听说 Prisma 要从 Rust 迁移时，我们意识到不再需要处理原生插件 API，这将让在 Deno 中支持 Prisma 变得简单得多。我们所有人都对此感到非常兴奋！"</p>
</blockquote>
<h4 data-id="heading-5">迁移带来的显著收益</h4>
<p>迁移到纯 TypeScript 客户端为更快的运行时、更小的体积和更简单的部署流程奠定了基础。开发者不再需要担心特定运行时的兼容性问题，也不必担心像 Cloudflare Workers 这样的基础设施提供商对应用大小的限制。</p>
<p>经过持续迭代和优化，Prisma 团队取得了令人瞩目的成果：</p>
<ul>
<li>体积减少 90%：打包输出大幅缩小</li>
<li>性能提升 3 倍：查询执行速度显著加快</li>
<li>资源占用降低：CPU 和内存利用率大幅下降</li>
<li>部署更简单：Vercel Edge 和 Cloudflare Workers 的部署流程更加顺畅</li>
</ul>
<p>这些改进都有详尽的基准测试数据支持。更重要的是，开发者无需重构整个应用程序就能享受到这些好处，迁移过程非常简单直接。</p>
<p>知名开发者 Kent C. Dodds 在体验后给出了积极反馈：</p>
<blockquote>
<p>"我在几周前完成了升级，整个过程非常顺利。切换到新的无 Rust 客户端是如此简单，这真是太棒了。"</p>
</blockquote>
<h3 data-id="heading-6">生成代码的新归宿：从 node_modules 到项目源码</h3>
<h4 data-id="heading-7">工作流程的优化</h4>
<p>Prisma 团队认真听取了社区关于生成代码处理方式的反馈，并进行了重大改进。此前，Prisma 习惯在项目的 <code>node_modules</code> 目录中生成客户端代码。虽然这样做让生成的客户端看起来像普通库一样，但随着时间推移，他们发现这种方式严重影响了开发者的工作流程。</p>
<p>当客户端需要更新时，所有应用相关的进程都必须先停止，然后才能重新生成类型。这不仅打断了开发流程，还降低了开发效率。</p>
<p>现在，Prisma 默认在项目源代码目录中生成类型和 Prisma Client。这样一来，开发者现有的开发和构建工具会将其视为应用程序的一部分。当开发者修改模型并运行 <code>prisma generate</code> 时，工具和文件监视器可以立即响应这些变化，保持开发工作流程的连续性。整个 Prisma 配置现在真正成为了项目的一部分，而不再是隐藏在 <code>node_modules</code> 中的"黑盒"。</p>
<h4 data-id="heading-8">全新的配置文件系统</h4>
<p>Prisma 团队还引入了全新的 Prisma 配置文件，支持动态项目配置。这个配置文件的核心目的是将数据定义与 Prisma 的数据交互方式分离开来。</p>
<p>在此之前，项目配置分散在 Prisma schema 文件或 <code>package.json</code> 中。新的 Prisma 配置文件统一了配置管理，开发者可以在一个地方定义 schema 位置、种子脚本或数据库 URL。由于配置文件支持 JavaScript 或 TypeScript 格式，开发者可以使用 <code>dotenv</code> 等工具进行动态配置，这为开发者提供了更大的灵活性，也符合现代开发工具的标准。</p>
<h3 data-id="heading-9">类型系统的性能革命</h3>
<h4 data-id="heading-10">与 ArkType 的合作</h4>
<p>类型安全是 Prisma ORM 的核心优势之一。Prisma 团队不仅要确保提供正确的类型，还要以最高效的方式实现。为了改进类型生成系统，他们与 ArkType 的创建者 David Blass 展开了深度合作，全面评估了类型生成表现。</p>
<p>评估结果令人振奋：</p>
<ul>
<li>Schema 评估类型减少 98%：大幅降低了类型系统的复杂度</li>
<li>查询评估类型减少 45%：查询相关的类型开销显著降低</li>
<li>类型检查速度提升 70%：完整的类型检查过程更加快速</li>
</ul>
<h4 data-id="heading-11">为什么这很重要？</h4>
<p>与生态系统中的其他 ORM 相比，Prisma 生成的类型不仅评估速度更快，而且需要更少的类型定义就能为开发者提供有用的 TypeScript 信息。这意味着开发者可以更自信地构建应用程序，因为 Prisma 提供的类型安全不仅快速，而且开销更小。</p>
<h2 data-id="heading-12">Prisma Postgres：为所有人打造的数据库服务</h2>
<h3 data-id="heading-13">不仅仅是 ORM</h3>
<p>Prisma 不仅仅是一个 ORM 工具。Prisma 团队推出的托管 Postgres 数据库服务旨在解决开发者在开始使用 Prisma ORM 时面临的首要问题——如何快速获得一个可用的数据库。</p>
<h3 data-id="heading-14">技术架构优势</h3>
<p>Prisma Postgres 基于由 unikernel microVM 驱动的裸机基础设施构建。这意味着数据库服务不仅启动快速，而且能够持续保持高性能。Prisma 团队始终将开发者体验放在首位，自动处理所有复杂的运维工作，让开发者无需关心服务器配置、资源分配等底层细节。</p>
<p>所有配置和管理工作都由 Prisma 团队负责，Prisma Postgres 与 Prisma ORM 实现了原生集成，为开发者提供与 ORM 同样出色的开发者体验。</p>
<h3 data-id="heading-15">极简的启动流程</h3>
<p>开始使用 Prisma Postgres 非常简单，只需在终端运行一个命令即可。系统会自动为开发者配置数据库，并提供认领链接。对于在开发工作流程中使用 AI 代理的开发者，Prisma 还提供了专用的 API 和 MCP 服务器，可以在需要时自动创建和管理数据库。</p>
<p>Jason Lengstorf 分享了他的使用体验：</p>
<blockquote>
<p>"每当我使用 Prisma 时，我都会按照入门指南安装各种工具，然后才意识到我还需要去获取一个数据库。我总是在这个过程中感到困惑，所以能够如此轻松地创建数据库真是太棒了！"</p>
</blockquote>
<h3 data-id="heading-16">标准协议支持</h3>
<p>Prisma Postgres 并没有止步于简单的数据库托管。Prisma 团队现在采用了标准的 Postgres 连接协议，这意味着更广泛的生态系统工具都可以与数据库通信。无论是 Cloudflare Hyperdrive、TablePlus、Retool，还是其他 ORM 工具，都可以无缝使用 Prisma Postgres。</p>
<p>这一切都得益于 Prisma Postgres 基于标准 Postgres 构建，同时针对最佳使用体验进行了优化。</p>
<h2 data-id="heading-17">其他重要更新</h2>
<p>这个版本包含了大量改进和新功能，如果一一详述，这篇文章会变得非常冗长。</p>
<p>Prisma 团队花费了大量时间处理积压的问题和功能请求，解决了一些最受社区关注的需求，包括：</p>
<ul>
<li>映射枚举支持</li>
<li>更新了项目所需的最低 Node.js 和 TypeScript 版本</li>
<li>全新版本的 Prisma Studio（通过 <code>npx prisma studio</code> 访问）</li>
</ul>
<p>开发者可以在 Prisma 的更新日志中找到此版本的所有详细内容，Prisma 团队还提供了完整的迁移指南帮助开发者顺利升级。</p>
<h2 data-id="heading-18">结语</h2>
<p>对 Prisma 团队而言，Prisma 7 不仅仅是一个版本发布，更是 Prisma ORM 和 Prisma Postgres 未来发展的基石。他们希望构建的工具能够为开发者提供最佳体验，让开发者能够专注于构建和发布出色的应用程序。</p>
<p>Prisma 团队特别感谢他们令人难以置信的社区，以及所有在预发布阶段提供宝贵反馈的开发者。如果开发者正在尝试 Prisma 7，可以向 Prisma 团队反馈想法和体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手把手教你实现 Rust 迭代器]]></title>    <link>https://juejin.cn/post/7574251313884250127</link>    <guid>https://juejin.cn/post/7574251313884250127</guid>    <pubDate>2025-11-20T00:54:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574251313884250127" data-draft-id="7571355989132771343" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手把手教你实现 Rust 迭代器"/> <meta itemprop="keywords" content="Rust"/> <meta itemprop="datePublished" content="2025-11-20T00:54:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RockByte"/> <meta itemprop="url" content="https://juejin.cn/user/1046390797768519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手把手教你实现 Rust 迭代器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390797768519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RockByte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T00:54:59.000Z" title="Thu Nov 20 2025 00:54:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#5f6368;background-image:linear-gradient(90deg,rgba(240,191,213,.1) 3%,transparent 0),linear-gradient(1turn,rgba(240,191,213,.1) 3%,transparent 0);background-size:20px 20px;background-position:50%;letter-spacing:1px;word-spacing:1px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-left:50px;padding-bottom:5px;color:#5f6368}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{position:absolute;left:0;display:block;content:""}.markdown-body h1{font-size:32px;margin-bottom:5px}.markdown-body h1:before{top:0;content:"🦄";font-size:32px}.markdown-body h2{padding-bottom:24px;border-bottom:1px solid #ececec}.markdown-body h2:before{top:0;left:8px;content:"🐳";font-size:24px}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{top:-2px;left:8px;content:"🐄";font-size:20px}.markdown-body h4{font-size:16px}.markdown-body h4:before{top:-2px;left:8px;content:"🦥";font-size:18px}.markdown-body h5{font-size:14px}.markdown-body h5:before{top:-2px;left:9px;content:"🦩";font-size:16px}.markdown-body h6{font-size:12px;margin-top:5px}.markdown-body h6:before{top:-1px;left:10px;content:"🐧";font-size:14px}.markdown-body p{line-height:1.9;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid rgba(253,121,168,.5);margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#a6accd;background:#292d3e;border-radius:8px}.markdown-body a{text-decoration:none;color:#fd79a8;border-bottom:1px solid #fd79a8;padding:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(253,121,168,.1);color:#ee69a9}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body th{color:#fd79a8}.markdown-body th,.markdown-body tr:hover{background:rgba(253,121,168,.1)}.markdown-body td{min-width:120px}.markdown-body blockquote{position:relative;color:#666;padding:23px;margin:22px 0;border-left:4px solid #ee69a9;background-color:rgba(253,121,168,.1)}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;display:block;font-size:27px;color:#fd79a8;opacity:.8}.markdown-body blockquote:before{left:10px;top:0;content:"❝"}.markdown-body blockquote:after{right:10px;bottom:0;content:"❞"}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body strong{position:relative;color:#fd79a8}.markdown-body strong:before{content:"· "}.markdown-body strong:after{content:" ·"}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#fd79a8}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#ee69a9}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}</style><style data-highlight="" data-highlight-key="xcode">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.xml .hljs-meta{color:silver}.hljs-comment,.hljs-quote{color:#007400}.hljs-attribute,.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-tag{color:#aa0d91}.hljs-template-variable,.hljs-variable{color:#3f6e74}.hljs-code,.hljs-meta-string,.hljs-string{color:#c41a16}.hljs-link,.hljs-regexp{color:#0e0eff}.hljs-bullet,.hljs-number,.hljs-symbol,.hljs-title{color:#1c00cf}.hljs-meta,.hljs-section{color:#643820}.hljs-built_in,.hljs-builtin-name,.hljs-class .hljs-title,.hljs-params,.hljs-type{color:#5c2699}.hljs-attr{color:#836c28}.hljs-subst{color:#000}.hljs-formula{background-color:#eee;font-style:italic}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-selector-class,.hljs-selector-id{color:#9b703f}.hljs-doctag,.hljs-strong{font-weight:700}.hljs-emphasis{font-style:italic}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15c6522aca6c455eb033fa92e4593acb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764204899&amp;x-signature=Q632iWiQ3UHqHpydBhqxNqGUNYc%3D" alt="0.png" loading="lazy"/></p>
<p>在完成前面三篇关于 Rust 迭代器的深入学习之后，本篇文章我们尝试自己写一下 Rust 迭代器，即给我们自己的数据加上迭代器的功能。</p>
<p>如果有读者想复习之前的文章：</p>
<ul>
<li><a href="https://juejin.cn/post/7566474134688595983" target="_blank" title="https://juejin.cn/post/7566474134688595983">深入 Rust 迭代器（上）</a></li>
<li><a href="https://juejin.cn/post/7568471321954779170" target="_blank" title="https://juejin.cn/post/7568471321954779170">深入 Rust 迭代器（中）</a></li>
<li><a href="https://juejin.cn/post/7572028313930776616" target="_blank" title="https://juejin.cn/post/7572028313930776616">深入 Rust 迭代器（下）</a></li>
</ul>
<h2 data-id="heading-0">开始之前</h2>
<p>Rust 原生的 <code>Vec</code> 以及数组，已经支持迭代器相关功能了：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">a</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];

<span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> &amp;a {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, i);
}

a.<span class="hljs-title function_ invoke__">iter_mut</span>().<span class="hljs-title function_ invoke__">for_each</span>(|i| {
    *i = <span class="hljs-number">100</span>;
});

<span class="hljs-built_in">println!</span>(<span class="hljs-string">"{:?}"</span>, a);

<span class="hljs-comment">// output</span>
<span class="hljs-comment">// 1</span>
<span class="hljs-comment">// 2</span>
<span class="hljs-comment">// 3</span>
<span class="hljs-comment">// [100, 100, 100]</span>
</code></pre>
<p><em>上述代码如果将 <code>vec![1, 2, 3]</code> 改成 <code>[1, 2, 3]</code>，效果是一样的。</em></p>
<p>如果你的数据结构有基于 <code>Vec</code> 或者数组去实现迭代器，其实可以直接用 <code>Vec</code> 或者数组的迭代器，完全没有必要自己实现。</p>
<p>但是为了让我们更加了解迭代器的内部原理以及相关的实现细节，该篇文章我们尝试为自己的数据实现一个迭代器。</p>
<p>首先，你需要一个简单的类：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[derive(Debug)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Rect</span> {
    a: <span class="hljs-type">f32</span>,
    b: <span class="hljs-type">f32</span>,
    c: <span class="hljs-type">f32</span>,
    d: <span class="hljs-type">f32</span>,
}
</code></pre>
<h2 data-id="heading-1">为类实现迭代器</h2>
<p>在 <a href="https://juejin.cn/post/7566474134688595983" target="_blank" title="https://juejin.cn/post/7566474134688595983">深入 Rust 迭代器（上）</a> 文中已经知道，如果我们要为自己的数据实现一个迭代器，就需要实现 <code>Iterator</code> <code>trait</code>。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Iterator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Rect</span> {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = <span class="hljs-type">f32</span>;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">next</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>::Item&gt; {
        <span class="hljs-comment">//...</span>
    }
}
</code></pre>
<p>该 <code>trait</code> 需要实现的函数非常简单 —— <code>next</code> 即可。</p>
<p><code>next</code> 返回一个 <code>Option</code>，如果迭代器结束，直接返回 <code>None</code>。</p>
<p>为了能够实现迭代器功能，我们需要对 <code>Rect</code> 进行一点改造，添加一个迭代器下标：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[derive(Debug)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Rect</span> {
    a: <span class="hljs-type">f32</span>,
    b: <span class="hljs-type">f32</span>,
    c: <span class="hljs-type">f32</span>,
    d: <span class="hljs-type">f32</span>,

    iter_index:<span class="hljs-type">u8</span>, <span class="hljs-comment">// 用于计数当前迭代的位置</span>
}
</code></pre>
<p>然后，为 <code>Rect</code> 实现迭代器：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Iterator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Rect</span> {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = <span class="hljs-type">f32</span>;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">next</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>::Item&gt; {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">next</span> = <span class="hljs-keyword">match</span> <span class="hljs-keyword">self</span>.iter_index {
            <span class="hljs-number">0</span> =&gt; {
                <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.a)
            }
            <span class="hljs-number">1</span> =&gt; {
                <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.b)
            }
            <span class="hljs-number">2</span> =&gt; {
                <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.c)
            }
            <span class="hljs-number">3</span> =&gt; {
                <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.d)
            }
            _ =&gt; <span class="hljs-literal">None</span>,
        };

        <span class="hljs-keyword">self</span>.iter_index += <span class="hljs-number">1</span>;

        next
    }
}
</code></pre>
<p><em>现在知道为什么 <code>next</code> 需要的入参是 <code>&amp;mut self</code> 了吧！</em></p>
<p>每次调用 <code>next</code> 的时候，我们先返回当前的值，然后对迭代的下标 <code>+1</code>。</p>
<p>如果迭代结束了，则返回 <code>None</code>。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">rect</span> = Rect {
    a: <span class="hljs-number">1.0</span>,
    b: <span class="hljs-number">2.0</span>,
    c: <span class="hljs-number">3.0</span>,
    d: <span class="hljs-number">4.0</span>,
    iter_index: <span class="hljs-number">0</span>,
};

<span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> rect {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, i);
}

<span class="hljs-comment">// output</span>
<span class="hljs-comment">// 1</span>
<span class="hljs-comment">// 2</span>
<span class="hljs-comment">// 3</span>
<span class="hljs-comment">// 4</span>
</code></pre>
<p>OK，很简单。</p>
<p>但是这样写，会有两个严重问题：</p>
<ul>
<li><code>iter_index</code> 对迭代的影响很大，如果这个值设置错误，迭代就不能从头开始。</li>
<li>无法再次使用迭代，即不能再次使用 <code>for i in rect</code>。</li>
</ul>
<p>我们来看第一个问题，如果我们给 <code>iter_index</code> 为 <code>3</code>。结果就会变成：</p>
<pre><code class="hljs language-txt" lang="txt">4
</code></pre>
<p>对，只会输出一个 <code>4</code>，因为我们的 <code>next</code> 实现，是基于 <code>iter_index</code> 做的。</p>
<p>第二个问题，当我们再次使用 <code>rect</code> 进行迭代的时候：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/783ddd43b6e74cdbb4e06d6a176b1dcb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764204899&amp;x-signature=InEjz2VEKQz5Dw8Kv6n8fqBoBQ0%3D" alt="1.png" loading="lazy"/></p>
<p>会得到这样一个错误。</p>
<p>原因是，<code>for i in rect</code> 是 Rust 提供的语法糖，实际上那段代码会被编译成如下的代码：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">iter</span> = <span class="hljs-built_in">IntoIterator</span>::<span class="hljs-title function_ invoke__">into_iter</span>(collection);
<span class="hljs-keyword">loop</span> {
    <span class="hljs-keyword">match</span> iter.<span class="hljs-title function_ invoke__">next</span>() {
        <span class="hljs-title function_ invoke__">Some</span>(i) =&gt; {
            <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, i);
        }
        <span class="hljs-literal">None</span> =&gt; <span class="hljs-keyword">break</span>,
    }
}
</code></pre>
<p>查看 <code>IntoIterator::into_iter</code> 的源码，我们发现：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[inline]</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">into_iter</span>(<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> I {
    <span class="hljs-keyword">self</span>
}
</code></pre>
<p><code>IntoIterator::into_iter</code> 会获取入参的所有权，这也就是为什么不能写两次 <code>for i in rect</code> 的原因。</p>
<p>为了解决上面两个问题，我们看看正确的迭代器是如何实现的。</p>
<h2 data-id="heading-2">IntoIterator</h2>
<p>Rust 提供了一个 <code>trait</code> —— <code>IntoIterator</code>，它的作用就是<strong>把一个“可迭代的东西”（比如容器）转换成一个“迭代器”</strong>。</p>
<p>这里，我们的 <code>Rect</code> 就是一个可迭代的数据，通过实现 <code>IntoIterator</code> 就可以变成一个迭代器了。</p>
<pre><code class="hljs language-rust" lang="rust">
<span class="hljs-meta">#[derive(Debug)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Rect</span> {
    a: <span class="hljs-type">f32</span>,
    b: <span class="hljs-type">f32</span>,
    c: <span class="hljs-type">f32</span>,
    d: <span class="hljs-type">f32</span>,
    <span class="hljs-comment">// 这里去掉了 iter_index</span>
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">RectIter</span> {
    data: Rect,
    iter_index: <span class="hljs-type">u8</span>,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Iterator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">RectIter</span> {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = <span class="hljs-type">f32</span>;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">next</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>::Item&gt; {
        <span class="hljs-keyword">match</span> <span class="hljs-keyword">self</span>.iter_index {
            <span class="hljs-number">0</span> =&gt; {
                <span class="hljs-keyword">self</span>.iter_index += <span class="hljs-number">1</span>;
                <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.data.a)
            }
            <span class="hljs-number">1</span> =&gt; {
                <span class="hljs-keyword">self</span>.iter_index += <span class="hljs-number">1</span>;
                <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.data.b)
            }
            <span class="hljs-number">2</span> =&gt; {
                <span class="hljs-keyword">self</span>.iter_index += <span class="hljs-number">1</span>;
                <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.data.c)
            }
            <span class="hljs-number">3</span> =&gt; {
                <span class="hljs-keyword">self</span>.iter_index += <span class="hljs-number">1</span>;
                <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.data.d)
            }
            _ =&gt; <span class="hljs-literal">None</span>,
        }
    }
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">IntoIterator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Rect</span> {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = <span class="hljs-type">f32</span>;
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">IntoIter</span> = RectIter;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">into_iter</span>(<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span>::IntoIter {
        RectIter {
            data: <span class="hljs-keyword">self</span>,
            iter_index: <span class="hljs-number">0</span>,
        }
    }
}
</code></pre>
<p>读者会发现，我们对 <code>Rect</code> 实现了 <code>IntoIterator</code>，该 <code>trait</code> 要求返回一个 <code>IntoIter</code> 类型，<code>IntoIter</code> 实际上是 <code>type IntoIter: Iterator&lt;Item = Self::Item&gt;;</code>，也就是一个迭代器。</p>
<p>此处，我们定义了一个新的迭代器类型 <code>RectIter</code> 并实现了 <code>Iterator</code>，最后 <code>IntoIterator</code> 中的 <code>into_iter(self)</code> 返回 <code>RectIter</code>。</p>
<p>好的，现在我们来看看效果：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">rect</span> = Rect {
    a: <span class="hljs-number">1.0</span>,
    b: <span class="hljs-number">2.0</span>,
    c: <span class="hljs-number">3.0</span>,
    d: <span class="hljs-number">4.0</span>,
};

<span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> rect {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, i);
}

<span class="hljs-comment">// output</span>
<span class="hljs-comment">// 1</span>
<span class="hljs-comment">// 2</span>
<span class="hljs-comment">// 3</span>
<span class="hljs-comment">// 4</span>
</code></pre>
<p>我们不用再在 <code>Rect</code> 中定义迭代下标了，当使用迭代器的时候，<code>RectIter</code> 中的迭代下标，都会设置为 <code>0</code> 开始。</p>
<p>但是它依然没有解决重复使用的问题，也就是我们不能再次迭代 <code>Rect</code>。</p>
<h2 data-id="heading-3">迭代 &amp;</h2>
<p>我们要做的事情实际上很简单，就是为 <code>&amp;Rect</code> 提供一个迭代器，这样我们就可以针对 <code>&amp;Rect</code> 进行迭代了。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 为 &amp;Rect 创建一个迭代器结构体（借用型）</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">RectRefIterator</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    rect: &amp;<span class="hljs-symbol">'a</span> Rect,
    index: <span class="hljs-type">usize</span>,
}

<span class="hljs-comment">// 为 RectRefIterator 实现 Iterator trait</span>
<span class="hljs-keyword">impl</span>&lt;<span class="hljs-symbol">'a</span>&gt; <span class="hljs-built_in">Iterator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">RectRefIterator</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = <span class="hljs-type">f32</span>;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">next</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>::Item&gt; {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">result</span> = <span class="hljs-keyword">match</span> <span class="hljs-keyword">self</span>.index {
            <span class="hljs-number">0</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.rect.a),
            <span class="hljs-number">1</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.rect.b),
            <span class="hljs-number">2</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.rect.c),
            <span class="hljs-number">3</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.rect.d),
            _ =&gt; <span class="hljs-literal">None</span>,
        };
        <span class="hljs-keyword">self</span>.index += <span class="hljs-number">1</span>;
        result
    }
}

<span class="hljs-comment">// 为 &amp;Rect 实现 IntoIterator trait（借用型）</span>
<span class="hljs-keyword">impl</span>&lt;<span class="hljs-symbol">'a</span>&gt; <span class="hljs-built_in">IntoIterator</span> <span class="hljs-keyword">for</span> &amp;<span class="hljs-symbol">'a</span> Rect {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = <span class="hljs-type">f32</span>;
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">IntoIter</span> = RectRefIterator&lt;<span class="hljs-symbol">'a</span>&gt;;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">into_iter</span>(<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span>::IntoIter {
        RectRefIterator {
            rect: <span class="hljs-keyword">self</span>,
            index: <span class="hljs-number">0</span>,
        }
    }
}
</code></pre>
<p>我们直接定义让 <code>&amp;Rect</code> 实现 <code>IntoIterator</code> <code>trait</code>，这里的写法比较长：<code>impl&lt;'a&gt; IntoIterator for &amp;'a Rect</code>。</p>
<p><code>'a</code> 是一个生命周期标注，如果你还不熟悉生命周期标注，可以先跳过，我们可以简单的理解为如果你有引用类型，需要帮助编译器来确定这个引用能存活多长时间。</p>
<p>此时，返回的 <code>IntoIter</code> 类型我们需要重新定义一个 <code>RectRefIterator&lt;'a&gt;</code>，同样，它会持有一个 <code>&amp;'a Rect</code>，即 <code>&amp;Rect</code> 类型。</p>
<p>这样，我们就可以多次遍历了。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">rect</span> = Rect {
    a: <span class="hljs-number">1.0</span>,
    b: <span class="hljs-number">2.0</span>,
    c: <span class="hljs-number">3.0</span>,
    d: <span class="hljs-number">4.0</span>,
};

<span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> &amp;rect { <span class="hljs-comment">// 注意这里是 &amp;rect</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, i);
}

<span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> &amp;rect {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, i);
}

<span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> &amp;rect {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, i);
}
</code></pre>
<p>如果你想消耗掉 <code>rect</code>，<code>for i in rect</code> 即可。</p>
<p>那么，如果我想支持 <code>&amp;mut</code> 呢？</p>
<h2 data-id="heading-4">迭代 &amp;mut</h2>
<p><code>for i in &amp;mut rect</code> 一般这种迭代形式，是说我想在迭代的时候更改元素，例如下面这个在迭代的时候更改数组里面的值：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> &amp;<span class="hljs-keyword">mut</span> a {
    *i = <span class="hljs-number">100</span>;
}
</code></pre>
<p>好的，这应该是所有迭代器中，编写最麻烦的一个了。</p>
<p>我们尝试，按照上面那个写法，写一个迭代器试试：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">RectMutRefIterator</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    rect: &amp;<span class="hljs-symbol">'a</span> <span class="hljs-keyword">mut</span> Rect,
    index: <span class="hljs-type">usize</span>,
}

<span class="hljs-keyword">impl</span>&lt;<span class="hljs-symbol">'a</span>&gt; <span class="hljs-built_in">Iterator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">RectMutRefIterator</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = &amp;<span class="hljs-symbol">'a</span> <span class="hljs-keyword">mut</span> <span class="hljs-type">f32</span>;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">next</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>::Item&gt; {

        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">index</span> = <span class="hljs-keyword">self</span>.index;
        <span class="hljs-keyword">self</span>.index += <span class="hljs-number">1</span>;

        <span class="hljs-keyword">match</span> index {
            <span class="hljs-number">0</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>.rect.a),
            <span class="hljs-number">1</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>.rect.b),
            <span class="hljs-number">2</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>.rect.c),
            <span class="hljs-number">3</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>.rect.d),
            _ =&gt; <span class="hljs-literal">None</span>,
        }
    }
}
</code></pre>
<p>其实就是把 <code>&amp;Rect</code> 变成了 <code>&amp;mut Rect</code>。</p>
<p>但是这段代码是无法通过编译的，你会得到这样一段提示</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef5186aa630045f3b147d72129ed0b46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764204899&amp;x-signature=TZ7vjlo4Gy4d%2Ft%2BIQqjycdxyNr8%3D" alt="2.png" loading="lazy"/></p>
<p>这里简单解释一下，<code>fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt;</code> 实际上是 <code>fn next(&amp;mut self) -&gt; Option&lt;&amp;'a mut f32&gt;</code>，这个函数需要返回一个带 <code>'a</code> 生命周期的引用，但是 Rust 编译器不知道这个 <code>'a</code> 从哪儿来的，Rust 函数的生命周期标注，必须要有一个来源。</p>
<p>那么如果我们改成 <code>fn next(&amp;'a mut self)</code> ?</p>
<p>也不行，因为 <code>impl&lt;'a&gt; Iterator</code> 的函数定义不是这样的，此时，似乎陷入一个僵局了···</p>
<p>由于这个地方过于复杂，我们不再深入探讨，我先给出用正确答案的一种：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// ----------------------------------------------------</span>
<span class="hljs-comment">// 1. 自定义迭代器结构体</span>
<span class="hljs-comment">// ----------------------------------------------------</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">RectMutIterator</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    <span class="hljs-comment">// 指向 Rect 内部当前 f32 元素的原始可变指针。</span>
    ptr: *<span class="hljs-keyword">mut</span> <span class="hljs-type">f32</span>,
    <span class="hljs-comment">// 剩余的元素数量。</span>
    len: <span class="hljs-type">usize</span>,
    <span class="hljs-comment">// 生命周期标记：将迭代器的生命周期 'a 绑定到 Rect 的 &amp;mut 借用上。</span>
    _marker: PhantomData&lt;&amp;<span class="hljs-symbol">'a</span> <span class="hljs-keyword">mut</span> <span class="hljs-type">f32</span>&gt;,
}

<span class="hljs-comment">// ----------------------------------------------------</span>
<span class="hljs-comment">// 2. 针对 &amp;mut Rect 实现 IntoIterator</span>
<span class="hljs-comment">// ----------------------------------------------------</span>
<span class="hljs-keyword">impl</span> &lt;<span class="hljs-symbol">'a</span>&gt; <span class="hljs-built_in">IntoIterator</span> <span class="hljs-keyword">for</span> &amp;<span class="hljs-symbol">'a</span> <span class="hljs-keyword">mut</span> Rect {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = &amp;<span class="hljs-symbol">'a</span> <span class="hljs-keyword">mut</span> <span class="hljs-type">f32</span>;
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">IntoIter</span> = RectMutIterator&lt;<span class="hljs-symbol">'a</span>&gt;;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">into_iter</span>(<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span>::IntoIter {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">ptr_f32</span> = <span class="hljs-keyword">self</span> <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> Rect <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> <span class="hljs-type">f32</span>;

        RectMutIterator {
            ptr: ptr_f32,
            len: <span class="hljs-number">4</span>, <span class="hljs-comment">// 字段总数</span>
            _marker: PhantomData,
        }
    }
}

<span class="hljs-comment">// ----------------------------------------------------</span>
<span class="hljs-comment">// 3. 迭代器的实现</span>
<span class="hljs-comment">// ----------------------------------------------------</span>
<span class="hljs-keyword">impl</span>&lt;<span class="hljs-symbol">'a</span>&gt; <span class="hljs-built_in">Iterator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">RectMutIterator</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = &amp;<span class="hljs-symbol">'a</span> <span class="hljs-keyword">mut</span> <span class="hljs-type">f32</span>; <span class="hljs-comment">// 返回 f32 的可变引用</span>

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">next</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>::Item&gt; {
        <span class="hljs-comment">// 1. 检查是否迭代完毕</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.len == <span class="hljs-number">0</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>;
        }

        <span class="hljs-comment">// 2. 减少剩余元素计数</span>
        <span class="hljs-keyword">self</span>.len -= <span class="hljs-number">1</span>;

        <span class="hljs-comment">// 3. 核心 unsafe 逻辑</span>
        <span class="hljs-keyword">unsafe</span> {
            <span class="hljs-comment">// 获取当前元素的指针</span>
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">current_ptr</span> = <span class="hljs-keyword">self</span>.ptr;

            <span class="hljs-comment">// 将内部指针移动到下一个元素</span>
            <span class="hljs-comment">// offset(1) 是一个 safe 抽象，但它内部执行的是 unsafe 指针算术</span>
            <span class="hljs-comment">// 它确保 `self.ptr` 现在指向下一个 f32 (即下一个字段)</span>
            <span class="hljs-keyword">self</span>.ptr = <span class="hljs-keyword">self</span>.ptr.<span class="hljs-title function_ invoke__">offset</span>(<span class="hljs-number">1</span>);

            <span class="hljs-comment">// 4. 将当前的原始指针转换回安全的 &amp;mut f32 引用</span>
            <span class="hljs-comment">// 这是安全的，因为我们通过 len 和 ptr 的管理，</span>
            <span class="hljs-comment">// 确保了当前元素是独占的，且生命周期被正确绑定。</span>
            <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-keyword">mut</span> *current_ptr)
        }
    }
}
</code></pre>
<p>我们测试一下看看：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">rect</span> = Rect {
     a: <span class="hljs-number">1.0</span>,
     b: <span class="hljs-number">2.0</span>,
     c: <span class="hljs-number">3.0</span>,
     d: <span class="hljs-number">4.0</span>,
 };

<span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> &amp;<span class="hljs-keyword">mut</span> rect {
     *i += <span class="hljs-number">10.0</span>;
 }

<span class="hljs-built_in">println!</span>(<span class="hljs-string">"{:?}"</span>, rect);

<span class="hljs-comment">// output</span>
<span class="hljs-comment">// Rect { a: 11.0, b: 12.0, c: 13.0, d: 14.0 }</span>
</code></pre>
<p>结果是正确的。</p>
<p>好的，到此，几种基本的迭代器类型我们已经实现完毕了。除了 <code>&amp;mut</code> 比较复杂以外，其他两种还算是轻松。</p>
<h2 data-id="heading-5">Rust 的一些习惯</h2>
<p>实际上，Rust 中针对迭代器，还有一些习惯，我们在 <a href="https://juejin.cn/post/7566474134688595983" target="_blank" title="https://juejin.cn/post/7566474134688595983">深入 Rust 迭代器（上）</a> 提到 Rust 迭代器中，有三种等价情况：</p>
<ul>
<li><code>for i in &amp;vec</code> 等价于 <code>for i in vec.iter()</code>。</li>
<li><code>for i in &amp;mut</code> 等价于 <code>for i in vec.iter_mut()</code>。</li>
<li><code>for i in vec</code> 等价于 <code>for i in vec.into_iter()</code>。</li>
</ul>
<p>所以，我们给 <code>Rect</code> 添加一下这三个方法：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Rect</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">iter_mut</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> RectMutIterator {
        RectMutIterator {
            ptr: <span class="hljs-keyword">self</span> <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> Rect <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> <span class="hljs-type">f32</span>,
            len: <span class="hljs-number">4</span>,
            _marker: PhantomData,
        }
    }

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">iter</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> RectRefIterator {
        RectRefIterator {
            rect: <span class="hljs-keyword">self</span>,
            index: <span class="hljs-number">0</span>,
        }
    }

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">into_iter</span>(<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> RectIter {
        RectIter {
            data: <span class="hljs-keyword">self</span>,
            iter_index: <span class="hljs-number">0</span>,
        }
    }
}
</code></pre>
<p>这样，我们就可以使用迭代器适配器方法和管道了：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">rect</span> = Rect {
    a: <span class="hljs-number">1.0</span>,
    b: <span class="hljs-number">2.0</span>,
    c: <span class="hljs-number">3.0</span>,
    d: <span class="hljs-number">4.0</span>,
};

rect.<span class="hljs-title function_ invoke__">iter_mut</span>().<span class="hljs-title function_ invoke__">for_each</span>(|i| {
    *i += <span class="hljs-number">10.0</span>;
});

rect.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">for_each</span>(|a| <span class="hljs-built_in">print!</span>(<span class="hljs-string">"{:?} "</span>, a));

<span class="hljs-built_in">println!</span>();

rect.<span class="hljs-title function_ invoke__">into_iter</span>().<span class="hljs-title function_ invoke__">for_each</span>(|a| <span class="hljs-built_in">print!</span>(<span class="hljs-string">"{:?} "</span>, a));

<span class="hljs-built_in">println!</span>();

<span class="hljs-comment">// output</span>
<span class="hljs-comment">// 11.0 12.0 13.0 14.0</span>
<span class="hljs-comment">// 11.0 12.0 13.0 14.0</span>
</code></pre>
<h2 data-id="heading-6">倒序</h2>
<p>在 <a href="https://juejin.cn/post/7572028313930776616" target="_blank" title="https://juejin.cn/post/7572028313930776616">深入 Rust 迭代器（下）</a> 中，我们最后提到一个 <code>rev()</code>，也就是迭代器倒序。这里我们也实现一下，这样你就能明白那篇文章中，为什么输出结果是那样的了。</p>
<p>我们仅针对 <code>&amp;Rect</code> 实现倒序。</p>
<p>为了实现倒序，我们需要给 <code>RectRefIterator</code> 添加一个 <code>end</code> 字段，该字段和 <code>index</code> 其实效果是一样的，用于标识当前应该返回哪个数据。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">RectRefIterator</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    rect: &amp;<span class="hljs-symbol">'a</span> Rect,
    index: <span class="hljs-type">usize</span>,
    end: <span class="hljs-type">usize</span>,
}
</code></pre>
<p>接下来在所有用到 <code>RectRefIterator</code> 的地方，设置 <code>end</code> 为 <code>4</code>：</p>
<pre><code class="hljs language-rust" lang="rust">RectRefIterator {
    rect: <span class="hljs-keyword">self</span>,
    index: <span class="hljs-number">0</span>,
    end: <span class="hljs-number">4</span>,
}
</code></pre>
<p>为了能够让迭代器支持 <code>rev()</code>，我们需要实现一个 <code>DoubleEndedIterator</code> 的 <code>trait</code>，该 <code>trait</code> 只需要实现 <code>fn next_back(&amp;mut self)</code> 即可，即倒着返回数据。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span> &lt;<span class="hljs-symbol">'a</span>&gt; <span class="hljs-built_in">DoubleEndedIterator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">RectRefIterator</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">next_back</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>::Item&gt; {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">result</span> = <span class="hljs-keyword">match</span> <span class="hljs-keyword">self</span>.end {
            <span class="hljs-number">1</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.rect.a),
            <span class="hljs-number">2</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.rect.b),
            <span class="hljs-number">3</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.rect.c),
            <span class="hljs-number">4</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.rect.d),
            _ =&gt; <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>,
        };
        <span class="hljs-keyword">self</span>.end -= <span class="hljs-number">1</span>;
        result
    }
}
</code></pre>
<p>好，万事俱备，我们测试一下：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">rect</span> = Rect {
    a: <span class="hljs-number">1.0</span>,
    b: <span class="hljs-number">2.0</span>,
    c: <span class="hljs-number">3.0</span>,
    d: <span class="hljs-number">4.0</span>,
};

rect.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">rev</span>().<span class="hljs-title function_ invoke__">for_each</span>(|a| <span class="hljs-built_in">print!</span>(<span class="hljs-string">"{:?} "</span>, a));

<span class="hljs-comment">// output</span>
<span class="hljs-comment">// 4.0 3.0 2.0 1.0</span>
</code></pre>
<p>完美。</p>
<h2 data-id="heading-7">总结</h2>
<p>好的，关于 Rust 迭代器的这个系列，终于迎来了完结。</p>
<p>我们在最后这篇文章中，给自己的数据实现了迭代器功能。</p>
<p>通过我们手动编写迭代器，我们不仅学会了如何实现迭代器，也加深了对 Rust 中数据使用的理解，你会发现，Rust 始终围绕<strong>所有权</strong>、<strong>借用</strong>、<strong>可变借用</strong>来实现数据的访问。</p>
<p>这种设计不是限制，而是一种引导——它迫使我们在编写代码的时候就思考：</p>
<ul>
<li>谁拥有数据？</li>
<li>谁在读取或修改它？</li>
<li>生命周期是否安全？</li>
</ul>
<p>正是这些看似“严格”的规则，让 Rust 能在不依赖垃圾回收的情况下，既保证内存安全，又实现零成本抽象。而迭代器，正是这一哲学的完美体现：它把控制权交给开发者，又用类型系统默默守护着每一份引用的安全。</p>
<p>现在，当你再看到 <code>for x in vec</code> 时，或许不再只觉得它简洁优雅，更能体会到背后那套精密、可靠、充满智慧的机制在默默运转。</p>
<p>感谢你一路走到这里。愿你在 Rust 的旅程中，继续享受这种“被约束的自由”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python 编程实战：内存管理与垃圾回收机制]]></title>    <link>https://juejin.cn/post/7574289653178253350</link>    <guid>https://juejin.cn/post/7574289653178253350</guid>    <pubDate>2025-11-20T00:56:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574289653178253350" data-draft-id="7574269207363338249" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python 编程实战：内存管理与垃圾回收机制"/> <meta itemprop="keywords" content="后端,Python,Trae"/> <meta itemprop="datePublished" content="2025-11-20T00:56:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python 编程实战：内存管理与垃圾回收机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T00:56:57.000Z" title="Thu Nov 20 2025 00:56:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>Python 把“内存管理”做得很贴心，大部分时候你不用自己管，但作为进阶开发者，理解它的原理会让你在写高性能、长运行、数据量大的程序时更有把握。</p>
</blockquote>
<p>本篇带你一次吃透：</p>
<ul>
<li>内存是怎么分配的</li>
<li>Python 如何判断对象能不能回收</li>
<li>循环引用为什么会成为坑</li>
<li>如何手动介入优化内存</li>
</ul>
<hr/>
<h2 data-id="heading-0">1. Python 内存管理的整体设计</h2>
<p>简单一句话：</p>
<p><strong>Python 使用引用计数（Reference Counting）为主，垃圾回收（Garbage Collection）为辅，同时内置私有内存池以提升性能。</strong></p>
<p>也就是说：</p>
<ul>
<li>小对象 → Python 自己管理（小对象池）</li>
<li>大对象 → 交给操作系统</li>
<li>对象什么时候能被释放 → 主要看“引用计数”</li>
<li>引用计数无法解决的“循环引用”，交给“垃圾回收器（gc）”</li>
</ul>
<p>这套机制让 Python 运行时保持高效而稳定。</p>
<hr/>
<h2 data-id="heading-1">2. 引用计数：Python 最核心的内存判定机制</h2>
<p>每个对象都有一个引用计数（refcount）：</p>
<ul>
<li>当一个变量指向对象 → 计数 +1</li>
<li>变量重新赋值/离开作用域 → 计数 -1</li>
<li>数量变为 0 → 对象立刻释放内存</li>
</ul>
<p>例如：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> sys

a = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]
<span class="hljs-built_in">print</span>(sys.getrefcount(a))   <span class="hljs-comment"># 2 （一个是a，一个是参数传递）</span>
b = a
<span class="hljs-built_in">print</span>(sys.getrefcount(a))   <span class="hljs-comment"># 3</span>
<span class="hljs-keyword">del</span> b
<span class="hljs-built_in">print</span>(sys.getrefcount(a))   <span class="hljs-comment"># 2</span>
</code></pre>
<p>引用计数机制简单直接，“计数为 0 就释放”，所以 Python 中大多数对象释放是 <strong>即时</strong> 的。</p>
<hr/>
<h2 data-id="heading-2">3. 循环引用：引用计数搞不定的硬茬子</h2>
<p>问题来了：如果两个对象互相引用，会怎样？</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.<span class="hljs-built_in">next</span> = <span class="hljs-literal">None</span>

a = Node()
b = Node()

a.<span class="hljs-built_in">next</span> = b
b.<span class="hljs-built_in">next</span> = a
</code></pre>
<p>即便你执行：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">del</span> a
<span class="hljs-keyword">del</span> b
</code></pre>
<p>对象的引用计数依然不为 0，因为它们互相指着自己。
这种情况就需要 Python 的 <strong>GC（垃圾回收器）</strong> 出手了。</p>
<hr/>
<h2 data-id="heading-3">4. Python 的垃圾回收：处理循环引用之神</h2>
<p>Python 内存回收使用 <strong>分代垃圾回收（Generational GC）</strong>。</p>
<p>它将对象分成三代：</p>
<ul>
<li>0 代（新生代）：新创建的对象</li>
<li>1 代</li>
<li>2 代（老年代）：长时间存在的对象</li>
</ul>
<p>为什么要这样？</p>
<p>因为经验告诉我们：</p>
<blockquote>
<p>“存活越久的对象越不可能被回收。”</p>
</blockquote>
<p>GC 工作流程：</p>
<ol>
<li>重点检查 <strong>新生代对象</strong></li>
<li>如果回收效果不佳，才继续检查老年代</li>
<li>检测策略主要针对“容器类”（list, dict, set, class 等）</li>
<li>发现无法到达的引用 → 回收</li>
</ol>
<hr/>
<h2 data-id="heading-4">5. 手动使用垃圾回收模块：gc</h2>
<p>Python 提供了一个模块 <code>gc</code> 可以让你：</p>
<ul>
<li>查看当前垃圾回收状态</li>
<li>手动触发 GC</li>
<li>调试循环引用问题</li>
</ul>
<h4 data-id="heading-5">查看 GC 是否启用</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> gc
<span class="hljs-built_in">print</span>(gc.isenabled())
</code></pre>
<h4 data-id="heading-6">手动触发垃圾回收（常用于大批量数据处理）</h4>
<pre><code class="hljs language-python" lang="python">gc.collect()
</code></pre>
<h4 data-id="heading-7">调试循环引用对象（高级用法）</h4>
<pre><code class="hljs language-python" lang="python">gc.set_debug(gc.DEBUG_LEAK)
</code></pre>
<hr/>
<h2 data-id="heading-8">6. 内存优化实战技巧</h2>
<h4 data-id="heading-9">① 尽量使用生成器（节省大量内存）</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">gen</span>():
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10_000_000</span>):
        <span class="hljs-keyword">yield</span> i
</code></pre>
<p>生成器一次只产生一个元素，比列表省太多内存。</p>
<hr/>
<h4 data-id="heading-10">② 用 <code>del</code> 显式删除大型对象</h4>
<p>适合大规模数据处理：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">del</span> big_list
gc.collect()
</code></pre>
<hr/>
<h4 data-id="heading-11">③ 避免不必要的变量引用</h4>
<p>例如数据处理中：</p>
<pre><code class="hljs language-python" lang="python">df2 = df1  <span class="hljs-comment"># 共享内存！不会复制</span>
</code></pre>
<p>如需复制，务必用：</p>
<pre><code class="hljs language-python" lang="python">df2 = df1.copy()
</code></pre>
<hr/>
<h4 data-id="heading-12">④ 大量小对象：使用 <code>slots</code> 优化内存</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>:
    __slots__ = (<span class="hljs-string">"name"</span>, <span class="hljs-string">"age"</span>)
</code></pre>
<p>对象不再使用 <code>__dict__</code> 存储属性，节省 30%-50% 内存。</p>
<hr/>
<h4 data-id="heading-13">⑤ 尽量使用内建类型/库，而不是自己造轮子</h4>
<p>比如：</p>
<ul>
<li><code>list</code> append 比自己实现的链表快得多</li>
<li>numpy 数组比 Python list 省 10 倍空间</li>
</ul>
<hr/>
<h2 data-id="heading-14">7. 总结</h2>
<p>Python 的内存管理并不复杂，本质上就是：</p>
<ul>
<li>引用计数：负责即时释放</li>
<li>垃圾回收：处理循环引用</li>
<li>内存池：提升对象创建效率</li>
</ul>
<p>理解这些机制，你就能：</p>
<ul>
<li>避免内存泄漏</li>
<li>写出更快更节省资源的代码</li>
<li>在长运行项目（爬虫/服务端）中更稳定</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python 编程实战：unittest 与 pytest 测试框架]]></title>    <link>https://juejin.cn/post/7574269207363354633</link>    <guid>https://juejin.cn/post/7574269207363354633</guid>    <pubDate>2025-11-20T00:57:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574269207363354633" data-draft-id="7574318108719497262" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python 编程实战：unittest 与 pytest 测试框架"/> <meta itemprop="keywords" content="后端,Python,Trae"/> <meta itemprop="datePublished" content="2025-11-20T00:57:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python 编程实战：unittest 与 pytest 测试框架
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T00:57:43.000Z" title="Thu Nov 20 2025 00:57:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>软件开发越做越大，你会发现：</p>
<ul>
<li>需求改来改去</li>
<li>Bug 修完又冒出来</li>
<li>函数多了后自己都不敢动</li>
</ul>
<p>这个时候，自动化测试就是你的“安全网”。
Python 提供两个主流的单元测试框架：</p>
<ul>
<li><strong>unittest（官方库，自带）</strong></li>
<li><strong>pytest（第三方库，更现代）</strong></li>
</ul>
<p>这篇文章带你一次搞懂：</p>
<ul>
<li>unittest 的使用方式</li>
<li>pytest 的核心优势</li>
<li>二者对比</li>
<li>项目中怎么选</li>
<li>实例代码示范</li>
</ul>
<hr/>
<h2 data-id="heading-0">1. unittest：Python 自带的 xUnit 风格框架</h2>
<p>它的特点很“企业级”：</p>
<ul>
<li>要写测试类</li>
<li>要继承 <code>unittest.TestCase</code></li>
<li>要用固定命名规则</li>
<li>断言方式很多</li>
</ul>
<p>更像 Java、C# 那类标准单元测试体系。</p>
<hr/>
<h3 data-id="heading-1">unittest 基本示例</h3>
<p>假设我们有一个待测试的函数：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>):
    <span class="hljs-keyword">return</span> a + b
</code></pre>
<p>unittest 的写法：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> unittest
<span class="hljs-keyword">from</span> main <span class="hljs-keyword">import</span> add

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TestMath</span>(unittest.TestCase):

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_add</span>(<span class="hljs-params">self</span>):
        self.assertEqual(add(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>), <span class="hljs-number">5</span>)
        self.assertNotEqual(add(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>), <span class="hljs-number">6</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    unittest.main()
</code></pre>
<p>运行方式：</p>
<pre><code class="hljs language-bash" lang="bash">python test_math.py
</code></pre>
<hr/>
<h3 data-id="heading-2">unittest 常用断言方法</h3>

































<table><thead><tr><th>方法</th><th>描述</th></tr></thead><tbody><tr><td>assertEqual(a, b)</td><td>a == b</td></tr><tr><td>assertNotEqual(a, b)</td><td>a != b</td></tr><tr><td>assertTrue(x)</td><td>x 为 True</td></tr><tr><td>assertFalse(x)</td><td>x 为 False</td></tr><tr><td>assertIn(x, y)</td><td>x in y</td></tr><tr><td>assertRaises(err, func, args)</td><td>检查是否抛出异常</td></tr></tbody></table>
<p>unittest 比较强调规范和结构，适合大型工程。</p>
<hr/>
<h2 data-id="heading-3">2. pytest：更 Pythonic、更现代、更香</h2>
<p>pytest 是现在最流行的 Python 测试框架，它的目标就是——“简单，强大”。</p>
<p>它的特点：</p>
<ul>
<li>无需写测试类</li>
<li>无需继承任何父类</li>
<li>测试文件、函数命名即可自动发现</li>
<li>断言直接用 Python 的 <code>assert</code>（语法自然）</li>
<li>插件生态超级丰富（约 1800+）</li>
</ul>
<hr/>
<h3 data-id="heading-4">pytest 示例</h3>
<p>还是刚才的 add 函数：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_add</span>():
    <span class="hljs-keyword">assert</span> add(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>) == <span class="hljs-number">5</span>
    <span class="hljs-keyword">assert</span> add(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>) != <span class="hljs-number">6</span>
</code></pre>
<p>运行方式：</p>
<pre><code class="hljs language-bash" lang="bash">pytest
</code></pre>
<p>是不是清爽很多？</p>
<hr/>
<h2 data-id="heading-5">3. pytest 强大的功能亮点</h2>
<h4 data-id="heading-6">① 断言超智能</h4>
<p>pytest 会自动解析出详细的断言对比信息：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">assert</span> add(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>) == <span class="hljs-number">10</span>
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-ini" lang="ini">E   assert <span class="hljs-attr">5</span> == <span class="hljs-number">10</span>
E   + where <span class="hljs-attr">5</span> = add(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>)
</code></pre>
<p>调错体验直接拉满。</p>
<hr/>
<h4 data-id="heading-7">② 参数化测试（超好用）</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> pytest

<span class="hljs-meta">@pytest.mark.parametrize(<span class="hljs-params"><span class="hljs-string">"a,b,res"</span>, [
    (<span class="hljs-params"><span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span></span>),
    (<span class="hljs-params"><span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span></span>),
    (<span class="hljs-params">-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span></span>)
]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">test_add</span>(<span class="hljs-params">a, b, res</span>):
    <span class="hljs-keyword">assert</span> add(a, b) == res
</code></pre>
<p>一个函数跑多组测试数据，适用于 API 测试、算法验证。</p>
<hr/>
<h4 data-id="heading-8">③ Fixtures（依赖注入）</h4>
<p>写测试时，不用重复初始化环境：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> pytest

<span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">user</span>():
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"name"</span>: <span class="hljs-string">"Tom"</span>, <span class="hljs-string">"age"</span>: <span class="hljs-number">18</span>}

<span class="hljs-keyword">def</span> <span class="hljs-title function_">test_user</span>(<span class="hljs-params">user</span>):
    <span class="hljs-keyword">assert</span> user[<span class="hljs-string">"age"</span>] == <span class="hljs-number">18</span>
</code></pre>
<p>类似于 Django 的 test client、Flask 的 app fixture，都可以自动提供。</p>
<hr/>
<h4 data-id="heading-9">④ 覆盖率统计</h4>
<pre><code class="hljs language-bash" lang="bash">pytest --cov=myproject
</code></pre>
<p>直接生成项目的覆盖率报告。</p>
<hr/>
<h2 data-id="heading-10">4. unittest vs pytest 对比总结</h2>








































<table><thead><tr><th>对比项</th><th>unittest</th><th>pytest</th></tr></thead><tbody><tr><td>是否内置</td><td>✔ 自带</td><td>❌ 需要 pip install</td></tr><tr><td>使用风格</td><td>面向对象</td><td>更 Pythonic</td></tr><tr><td>扩展性</td><td>一般</td><td>非常强（插件丰富）</td></tr><tr><td>编写难度</td><td>偏重</td><td>偏轻松</td></tr><tr><td>自动发现</td><td>一般</td><td>很强</td></tr><tr><td>断言</td><td>专门的断言方法</td><td>直接用 assert</td></tr></tbody></table>
<p>一句话总结：</p>
<ul>
<li>做小项目 → pytest</li>
<li>想写优雅测试 → pytest</li>
<li>公司项目规范要求 unittest → unittest</li>
<li>要跟 Java/CI 流程兼容 → unittest 也没问题</li>
<li>你完全有选择权 → pytest 最爽</li>
</ul>
<hr/>
<h2 data-id="heading-11">5. 项目测试目录结构示例（pytest）</h2>
<p>推荐结构：</p>
<pre><code class="hljs language-markdown" lang="markdown">project/
<span class="hljs-code">    app/
    utils/
    tests/
        test_utils.py
        test_api.py
        conftest.py
</span></code></pre>
<p>pytest 会自动识别：</p>
<ul>
<li>名字以 <code>test_</code> 开头的文件</li>
<li>名字以 <code>test_</code> 开头的函数</li>
<li>conftest.py 中的全局 fixture</li>
</ul>
<hr/>
<h2 data-id="heading-12">6. unittest &amp; pytest 混用可以吗？</h2>
<p>完全可以。
pytest 能自动识别 unittest 的测试类并执行。</p>
<p>比如你公司的老代码用 unittest，你可以逐步迁移到 pytest，不会冲突。</p>
<hr/>
<h2 data-id="heading-13">7. 总结</h2>
<p>这篇文章帮你梳理了 Python 的两大测试框架：</p>
<ul>
<li>unittest：规范、传统、标准化</li>
<li>pytest：现代、轻松、生态强</li>
</ul>
<p>如果你问我项目里用哪个？</p>
<p><strong>99% 的情况用 pytest</strong>
因为它是真·好用，同时更适合现代 Python 工程。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文搞懂 C#.NET DateTimeOffset：时间戳、时区与偏移量全掌握]]></title>    <link>https://juejin.cn/post/7574306374916685843</link>    <guid>https://juejin.cn/post/7574306374916685843</guid>    <pubDate>2025-11-19T23:23:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574306374916685843" data-draft-id="7574320550459162665" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文搞懂 C#.NET DateTimeOffset：时间戳、时区与偏移量全掌握"/> <meta itemprop="keywords" content="C#,.NET"/> <meta itemprop="datePublished" content="2025-11-19T23:23:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="唐青枫"/> <meta itemprop="url" content="https://juejin.cn/user/3737995266234280"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文搞懂 C#.NET DateTimeOffset：时间戳、时区与偏移量全掌握
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3737995266234280/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    唐青枫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T23:23:08.000Z" title="Wed Nov 19 2025 23:23:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">简介</h3>
<p><code>DateTimeOffset</code> 是 <code>System</code> 命名空间中的结构体，用于表示特定时间点及其相对于协调世界时（<code>UTC</code>）的偏移量。相比 <code>DateTime</code>，它更适合处理跨时区场景，确保时间数据在全球化应用中的一致性和精确性。</p>
<ul>
<li>
<p>定义：<code>System.DateTimeOffset</code> 表示带有固定时区偏移量的点时间。</p>
</li>
<li>
<p>用途：既保留了 <code>UTC</code> 时间戳，也携带了相对于 <code>UTC</code> 的偏移量（<code>Offset</code>），在分布式、多时区场景下更可靠。</p>
</li>
<li>
<p>内部存储：</p>
<ul>
<li>
<p><code>DateTime _dateTime</code>（<code>Kind</code> 固定为 <code>Unspecified</code>）</p>
</li>
<li>
<p><code>TimeSpan _offset</code>（-14h 到 +14h 范围）</p>
</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">var</span> dto = <span class="hljs-keyword">new</span> DateTimeOffset(<span class="hljs-number">2025</span>, <span class="hljs-number">8</span>, <span class="hljs-number">8</span>, <span class="hljs-number">14</span>, <span class="hljs-number">30</span>, <span class="hljs-number">0</span>, TimeSpan.FromHours(+<span class="hljs-number">8</span>));
</code></pre>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[DateTimeOffset] --&gt; B[DateTime]
    A --&gt; C[Offset]
    B --&gt; D[日期部分]
    B --&gt; E[时间部分]
    C --&gt; F[UTC偏移量]
</code></pre>
<h3 data-id="heading-1">DateTimeOffset 结构详解</h3>
<h4 data-id="heading-2">内部表示</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> DateTimeOffset : IComparable, IFormattable, ... 
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> DateTime _dateTime;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">short</span> _offsetMinutes;
    
    <span class="hljs-comment">// 属性</span>
    <span class="hljs-keyword">public</span> DateTime DateTime { <span class="hljs-keyword">get</span>; }       <span class="hljs-comment">// 日期时间部分</span>
    <span class="hljs-keyword">public</span> DateTime UtcDateTime { <span class="hljs-keyword">get</span>; }    <span class="hljs-comment">// UTC 等效时间</span>
    <span class="hljs-keyword">public</span> TimeSpan Offset { <span class="hljs-keyword">get</span>; }         <span class="hljs-comment">// 偏移量</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">long</span> Ticks { <span class="hljs-keyword">get</span>; }              <span class="hljs-comment">// 自 0001-01-01 的滴答数</span>
    <span class="hljs-keyword">public</span> DateTime Date { <span class="hljs-keyword">get</span>; }           <span class="hljs-comment">// 日期部分</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> Year { <span class="hljs-keyword">get</span>; }                <span class="hljs-comment">// 年</span>
    <span class="hljs-comment">// ... 其他属性类似 DateTime</span>
}
</code></pre>
<h3 data-id="heading-3">核心API</h3>
<h4 data-id="heading-4">属性</h4>

















































<table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td><code>DateTime</code></td><td>去除偏移量的本地时间（<code>DateTimeKind.Unspecified</code>）</td></tr><tr><td><code>UtcDateTime</code></td><td>按 <code>Offset</code> 转换到 UTC 的 <code>DateTime</code>（<code>Kind.Utc</code>）</td></tr><tr><td><code>Offset</code></td><td>相对于 UTC 的偏移量（<code>TimeSpan</code>）</td></tr><tr><td><code>LocalDateTime</code></td><td>按当前系统时区再次转换的本地时间（<code>DateTimeKind.Local</code>）</td></tr><tr><td><code>Date</code></td><td><code>DateTime.Date</code> 部分，保留偏移量</td></tr><tr><td><code>Year/Month/Day</code></td><td>年、月、日</td></tr><tr><td><code>Hour/Minute/Second</code></td><td>小时、分钟、秒</td></tr><tr><td><code>Ticks</code></td><td>自 <code>0001-01-01T00:00:00</code> 起的刻度数（100 ns 为单位，不含偏移）</td></tr><tr><td><code>Now</code></td><td>当前本地时间带本地偏移（等同 <code>new DateTimeOffset(DateTime.Now)</code>）</td></tr><tr><td><code>UtcNow</code></td><td>当前 UTC 时间，偏移量为 <code>TimeSpan.Zero</code></td></tr></tbody></table>
<h4 data-id="heading-5">方法</h4>
<ul>
<li>
<p><code>Add(TimeSpan)</code>：添加时间跨度。</p>
</li>
<li>
<p><code>AddDays(double)、AddHours(double)</code> 等：添加特定单位。</p>
</li>
<li>
<p><code>Subtract(DateTimeOffset)</code>：计算时间差（返回 <code>TimeSpan</code>）。</p>
</li>
<li>
<p><code>ToString(string)</code>：格式化输出。</p>
</li>
<li>
<p><code>ToUniversalTime()</code>：转换为 <code>UTC</code>。</p>
</li>
<li>
<p><code>ToOffset(TimeSpan)</code>：转换为指定偏移。</p>
</li>
<li>
<p><code>Parse(string)、TryParse(string, out DateTimeOffset)</code>：解析字符串。</p>
</li>
</ul>
<h4 data-id="heading-6">静态方法</h4>
<ul>
<li>
<p><code>DateTimeOffset.Compare(DateTimeOffset, DateTimeOffset)</code>：比较两个时间。</p>
</li>
<li>
<p><code>DateTimeOffset.ParseExact(string, string, IFormatProvider)</code>：精确解析。</p>
</li>
</ul>
<h3 data-id="heading-7">构造与转换</h3>
<h4 data-id="heading-8">常用构造器</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 指定本地时间和偏移</span>
<span class="hljs-keyword">var</span> dto1 = <span class="hljs-keyword">new</span> DateTimeOffset(<span class="hljs-number">2025</span>,<span class="hljs-number">8</span>,<span class="hljs-number">8</span>,<span class="hljs-number">14</span>,<span class="hljs-number">30</span>,<span class="hljs-number">0</span>, TimeSpan.FromHours(+<span class="hljs-number">8</span>));

<span class="hljs-comment">// 从 DateTime 创建（注意 Kind）</span>
<span class="hljs-keyword">var</span> dtLocal = DateTime.Now;  <span class="hljs-comment">// Kind.Local</span>
<span class="hljs-keyword">var</span> dto2 = <span class="hljs-keyword">new</span> DateTimeOffset(dtLocal);

<span class="hljs-comment">// 从 UTC DateTime 创建</span>
<span class="hljs-keyword">var</span> dtUtc = DateTime.UtcNow;
<span class="hljs-keyword">var</span> dto3 = <span class="hljs-keyword">new</span> DateTimeOffset(dtUtc).ToOffset(TimeSpan.Zero);
</code></pre>
<h4 data-id="heading-9">偏移转换</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 将 dto 转到另一个时区偏移（仅改变 Offset，不更改瞬时时间）</span>
<span class="hljs-keyword">var</span> dtoTokyo = dto.ToOffset(TimeSpan.FromHours(+<span class="hljs-number">9</span>));

<span class="hljs-comment">// 获取共同的绝对时刻</span>
DateTimeOffset a = dto1, b = dtoTokyo;
<span class="hljs-built_in">bool</span> sameInstant = a.ToUniversalTime() == b.ToUniversalTime();  <span class="hljs-comment">// true</span>
</code></pre>
<h4 data-id="heading-10">与 DateTime 相互转换</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// DateTimeOffset -&gt; DateTime (Unspecified)</span>
DateTime dtUnspecified = dto.DateTime;

<span class="hljs-comment">// DateTimeOffset -&gt; UTC DateTime</span>
DateTime dtUtc = dto.UtcDateTime;

<span class="hljs-comment">// DateTimeOffset -&gt; Local DateTime</span>
DateTime dtLocal2 = dto.LocalDateTime;

<span class="hljs-comment">// DateTime -&gt; DateTimeOffset</span>
<span class="hljs-keyword">var</span> dtoFromDt = <span class="hljs-keyword">new</span> DateTimeOffset(dtUnspecified, TimeZoneInfo.Local.GetUtcOffset(dtUnspecified));
</code></pre>
<h3 data-id="heading-11">格式化与解析</h3>
<h4 data-id="heading-12">标准格式字符串</h4>








































<table><thead><tr><th>格式符</th><th>说明</th><th>示例输出</th></tr></thead><tbody><tr><td>"o"</td><td>往返格式</td><td>2023-10-05T14:30:00.0000000+08:00</td></tr><tr><td>"r"</td><td>RFC1123</td><td>Thu, 05 Oct 2023 14:30:00 +0800</td></tr><tr><td>"u"</td><td>通用可排序</td><td>2023-10-05 06:30:00Z</td></tr><tr><td>"s"</td><td>可排序</td><td>2023-10-05T14:30:00</td></tr><tr><td>"g"</td><td>常规短格式</td><td>10/5/2023 2:30 PM</td></tr><tr><td>"G"</td><td>常规长格式</td><td>10/5/2023 2:30:00 PM</td></tr></tbody></table>
<h4 data-id="heading-13">格式化</h4>
<ul>
<li>标准格式</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">dto.ToString(<span class="hljs-string">"o"</span>);  <span class="hljs-comment">// 2025-08-08T14:30:00.0000000+08:00</span>
dto.ToString(<span class="hljs-string">"u"</span>);  <span class="hljs-comment">// 2025-08-08 14:30:00Z</span>
</code></pre>
<ul>
<li>自定义格式</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">dto.ToString(<span class="hljs-string">"yyyy-MM-dd HH:mm zzz"</span>);   <span class="hljs-comment">// 2025-08-08 14:30 +08:00</span>
dto.ToString(<span class="hljs-string">"yyyy-MM-dd HH:mm K"</span>);     <span class="hljs-comment">// K 同 zzz</span>
</code></pre>
<h4 data-id="heading-14">解析</h4>
<ul>
<li><code>Parse / TryParse</code></li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">DateTimeOffset.Parse(<span class="hljs-string">"2025-08-08T14:30:00+08:00"</span>);
DateTimeOffset.TryParse(<span class="hljs-string">"2025-08-08 06:30:00Z"</span>, <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> dto);
</code></pre>
<ul>
<li><code>ParseExact / TryParseExact</code></li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">DateTimeOffset.ParseExact(<span class="hljs-string">"2025/08/08 14:30 +0800"</span>,
    <span class="hljs-string">"yyyy/MM/dd HH:mm zzz"</span>, CultureInfo.InvariantCulture);
DateTimeOffset.TryParseExact(input, 
    <span class="hljs-keyword">new</span>[]{ <span class="hljs-string">"o"</span>,<span class="hljs-string">"yyyy-MM-dd HH:mm zzz"</span>}, 
    CultureInfo.InvariantCulture, DateTimeStyles.AssumeUniversal, <span class="hljs-keyword">out</span> dto);
</code></pre>
<h3 data-id="heading-15">比较与运算</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">var</span> a = <span class="hljs-keyword">new</span> DateTimeOffset(<span class="hljs-number">2025</span>,<span class="hljs-number">8</span>,<span class="hljs-number">8</span>,<span class="hljs-number">10</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,TimeSpan.FromHours(+<span class="hljs-number">1</span>));
<span class="hljs-keyword">var</span> b = <span class="hljs-keyword">new</span> DateTimeOffset(<span class="hljs-number">2025</span>,<span class="hljs-number">8</span>,<span class="hljs-number">8</span>,<span class="hljs-number">18</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,TimeSpan.FromHours(+<span class="hljs-number">9</span>));
<span class="hljs-comment">// 绝对瞬时时间相同</span>
<span class="hljs-built_in">bool</span> eq = a.ToUniversalTime() == b.ToUniversalTime();  <span class="hljs-comment">// true</span>

<span class="hljs-comment">// 差值</span>
TimeSpan diff = b - a;  <span class="hljs-comment">// Zero</span>
</code></pre>
<ul>
<li>
<p>支持 <code>+/- TimeSpan、- DateTimeOffset</code>（结果 <code>TimeSpan</code>）</p>
</li>
<li>
<p>支持 <code>Compare(), Equals()</code>, 运算符 <code>&lt;, &gt;</code> 等基于 UTC 比较</p>
</li>
</ul>
<h3 data-id="heading-16">与 DateTime 的比较</h3>



































<table><thead><tr><th>特性</th><th><code>DateTime</code></th><th><code>DateTimeOffset</code></th></tr></thead><tbody><tr><td>时区信息</td><td>仅有 <code>Kind</code>，不含偏移量</td><td>明确定义了相对于 UTC 的偏移量</td></tr><tr><td>存储一致性</td><td>若用本地 <code>DateTime.Now</code> 存库，会丢失上下文</td><td>可存储为 ISO 8601 带偏移字符串，恢复无歧义</td></tr><tr><td>夏令时问题</td><td>依赖系统时区转换，歧义转化</td><td>偏移固定，不受夏令时影响</td></tr><tr><td>跨系统/跨语言互操作性</td><td>存 UTC 时需额外约定</td><td>标准化输出带偏移，易互操作</td></tr><tr><td>推荐用于多时区业务场景</td><td>较麻烦</td><td>首选</td></tr></tbody></table>
<h3 data-id="heading-17">资源和文档</h3>
<ul>
<li>
<p><code>DateTimeOffset</code>：<a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fen-us%2Fdotnet%2Fapi%2Fsystem.datetimeoffset" target="_blank" title="https://learn.microsoft.com/en-us/dotnet/api/system.datetimeoffset" ref="nofollow noopener noreferrer">learn.microsoft.com/en-us/dotne…</a></p>
</li>
<li>
<p><code>TimeZoneInfo</code>：<a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fen-us%2Fdotnet%2Fapi%2Fsystem.timezoneinfo" target="_blank" title="https://learn.microsoft.com/en-us/dotnet/api/system.timezoneinfo" ref="nofollow noopener noreferrer">learn.microsoft.com/en-us/dotne…</a></p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我在模力方舟的国产 GPU 上，免费跑通了 Qwen-Image]]></title>    <link>https://juejin.cn/post/7574286569038741567</link>    <guid>https://juejin.cn/post/7574286569038741567</guid>    <pubDate>2025-11-19T23:43:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574286569038741567" data-draft-id="7574306374916702227" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我在模力方舟的国产 GPU 上，免费跑通了 Qwen-Image"/> <meta itemprop="keywords" content="AIGC,人工智能"/> <meta itemprop="datePublished" content="2025-11-19T23:43:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="飞哥数智谈"/> <meta itemprop="url" content="https://juejin.cn/user/3825956195409223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我在模力方舟的国产 GPU 上，免费跑通了 Qwen-Image
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3825956195409223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    飞哥数智谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T23:43:25.000Z" title="Wed Nov 19 2025 23:43:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>好久没有自己部署 AI 模型了，恰逢“<strong>模力方舟</strong>”算力体验官上线，还能免费试用国产 GPU——既能练手，也算为国产算力生态添块砖。</p>
<h2 data-id="heading-0">操作过程</h2>
<h3 data-id="heading-1">进群领取体验券</h3>
<p>首先自然是要领券。</p>
<p>1、加入交流群，找客服即可获取 <code>100</code> 元<strong>代金券</strong>的兑换码。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwork.weixin.qq.com%2Fgm%2F6fd5d3283f5338ec538842730c524a36" target="_blank" title="https://work.weixin.qq.com/gm/6fd5d3283f5338ec538842730c524a36" ref="nofollow noopener noreferrer">work.weixin.qq.com/gm/6fd5d328…</a> (微信打开，二维码自动识别)</p>
<p>2、登录“模力方舟”，打开“控制台”，进行代金券的兑换。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28b230e126c14d4e82e2c729471df335~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764200605&amp;x-signature=J%2FW63CRxmQWvjGMx%2FZsk70Fckaw%3D" alt="" loading="lazy"/></p>
<p>我的代金券有效期：2025-11-12 16:25 至 2025-12-12 00:00，<strong>64G 显存</strong>的单颗 GPU 一小时只需要 <strong>4</strong> 元，这代金券可以部署实验好几个模型了。</p>
<h3 data-id="heading-2">开通国产 GPU 实例</h3>
<p>拿到代金券，我们就可以放心的租用算力了。</p>
<p>1、访问算力市场：<code>https://moark.com/compute</code>，选择算力，我选择了“曦云 C500/显存 64 GB”。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac4e4f0c42b4428aa5fc0dab0f30b515~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764200605&amp;x-signature=c5CZcFoVE8A%2BQZXvCNFSfPeLYkI%3D" alt="" loading="lazy"/></p>
<p>2、点击“立即租用”，进行相关配置。</p>
<ul>
<li>GPU 数量我选择了 2 颗，1颗容易发生溢出。</li>
<li>计费方式选择按量计费。</li>
<li>预装镜像选择 <code>PyTorch/2.6.0/Python 3.10/maca 3.2.1.3</code></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ebc02b9fced4fd9aa53f8382e1014d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764200605&amp;x-signature=wSKO1wpEV52AqCwYJcxWotXO0Fc%3D" alt="" loading="lazy"/></p>
<p>3、点击“下一步”进行支付。支付完成后，点击“查看资源”进入容器实例页面。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4660367a6bd425085445d13a3ebc552~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764200605&amp;x-signature=0g5y7wF%2FoH1s7z9fyi6Ww4ZIWUc%3D" alt="" loading="lazy"/></p>
<p>4、点击“工具”下的 <code>JupyterLab</code> 进入容器操作页面。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b798f0ba0ea4080ac2a0f622ea0ccad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764200605&amp;x-signature=FuuTXAeSCa6srDDeqz9oD3iQjRU%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">开发实现</h3>
<p>实例就绪后，我们可以通过 <code>JupyterLab</code> 界面进行开发实现。</p>
<p>1、在上一章节的 <code>Launcher</code> 界面选择新建 <code>Terminal</code>，进行环境安装。</p>
<pre><code class="hljs">pip install diffusers
pip install accelerate
</code></pre>
<p>2、在 <code>Launcher</code> 界面选择 <code>Python File</code> ，粘贴代码即可。</p>
<p>这段代码和官网稍微有些差距，主要是增加了生成图片的保存，方便后续查看图片。</p>
<p>至于提示词，自然是把官方提示词和想要的修仙图片一起发给 AI，让 AI 帮我提炼的。</p>
<pre><code class="hljs language-ini" lang="ini">from diffusers import DiffusionPipeline
import torch
import os

<span class="hljs-comment"># 设置环境变量以解决cuDNN问题</span>
os.environ<span class="hljs-section">['PYTORCH_CUDA_ALLOC_CONF']</span> = 'max_split_size_mb:128'

<span class="hljs-comment">#如果是沐曦的曦云C500，可使用内置的模型路径 /mnt/moark-models/Qwen-Image</span>
<span class="hljs-attr">model_name</span> = <span class="hljs-string">"/mnt/moark-models/Qwen-Image"</span>

<span class="hljs-comment"># Load the pipeline</span>
if torch.cuda.is_available():
    <span class="hljs-attr">torch_dtype</span> = torch.bfloat16
    <span class="hljs-attr">device</span> = <span class="hljs-string">"cuda"</span>
else:
    <span class="hljs-attr">torch_dtype</span> = torch.float32
    <span class="hljs-attr">device</span> = <span class="hljs-string">"cpu"</span>

<span class="hljs-attr">pipe</span> = DiffusionPipeline.from_pretrained(model_name, torch_dtype=torch_dtype)
<span class="hljs-attr">pipe</span> = pipe.to(device)


<span class="hljs-comment"># Generate image</span>
<span class="hljs-attr">prompt</span> = <span class="hljs-string">'''9:16 竖版，超写实 3D 渲染，修仙令牌风格社交资料卡。令牌主体为火焰雕花造型，顶部是一簇完整火焰，边缘环绕火焰渐变光效，左右两侧都是火焰色带交织，表面有修仙符文流光特效。
令牌中央是一位白胡子剑仙形象：白发高束发髻，插古朴剑簪，身着白色飘逸道袍，双手结印，掌心有红色火焰，背景是云海环绕的悬浮仙山、奇峰古松，仙气缭绕。
令牌信息区域：顶部金色 “模力认证” 徽章闪烁；名称为 “模力方舟(MoArk)算力体验官”，字体为仙侠风金色立体字；关注数 “2777”、被关注数 “1.2w”（被关注图标为紫色仙心）；加入时间 “仙历 2025年11月19日”；底部 “共赴仙途” 按钮为红黄渐变柔光质感。
整体画面电影级光影，令牌边缘有火焰粒子动态效果，背景是蓝天云海的修仙场景，细节逼真如近未来仙侠实机画面，科技与修仙风格融合，炫酷且富有沉浸感。'''</span>

<span class="hljs-attr">negative_prompt</span> = <span class="hljs-string">" "</span> 


<span class="hljs-attr">aspect_ratios</span> = {
    "1:1": (1328, 1328),
    "16:9": (1664, 928),
    "9:16": (928, 1664),
    "4:3": (1472, 1140),
    "3:4": (1140, 1472),
    "3:2": (1584, 1056),
    "2:3": (1056, 1584),
}

width, <span class="hljs-attr">height</span> = aspect_ratios[<span class="hljs-string">"9:16"</span>]

<span class="hljs-attr">image</span> = pipe(
    <span class="hljs-attr">prompt</span>=prompt,
    <span class="hljs-attr">negative_prompt</span>=negative_prompt,
    <span class="hljs-attr">width</span>=width,
    <span class="hljs-attr">height</span>=height,
    <span class="hljs-attr">num_inference_steps</span>=<span class="hljs-number">50</span>,
    <span class="hljs-attr">true_cfg_scale</span>=<span class="hljs-number">4.0</span>,
    <span class="hljs-attr">generator</span>=torch.Generator(device=<span class="hljs-string">"cuda"</span>).manual_seed(<span class="hljs-number">42</span>)
).images<span class="hljs-section">[0]</span>

<span class="hljs-comment"># 确保目录存在</span>
<span class="hljs-attr">output_dir</span> = <span class="hljs-string">"/data"</span>
os.makedirs(output_dir, <span class="hljs-attr">exist_ok</span>=<span class="hljs-literal">True</span>)

<span class="hljs-comment"># 保存图片</span>
<span class="hljs-attr">image_path</span> = os.path.join(output_dir, <span class="hljs-string">"cyber_social_card1.png"</span>)
image.save(image_path)
print(f"图片已保存到: {image_path}")
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3744ca60a0db4af8b87b928fcbf01ccd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764200605&amp;x-signature=TvePVLcWxCKeRSVHhCHbtGeG1BY%3D" alt="" loading="lazy"/></p>
<p>3、然后回到 <code>Terminal</code> 标签中运行 <code>Python</code> 脚本。</p>
<pre><code class="hljs">python untitled.py
</code></pre>
<p>可以看到最后日志显示图片已经生成并保存了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5a3db672b214bcab61bff6e0f5d12c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764200605&amp;x-signature=tGvEB%2FPN9fckVFvpmPQZ4UYj1LE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">最终效果</h3>
<p>给大家看下我修仙风的算力体验官名片。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8cf2160b34c841e68b049b69485e7b16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764200605&amp;x-signature=mHQDiXLVIDasOrKt8nc4oNs9cyY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">辅助命令</h2>
<p>英伟达显卡可以通过 <code>nvidia-smi</code> 查看显卡状态。</p>
<p>国产芯片也都有类似的命令，比如“沐曦”相关命令如下：</p>
<ul>
<li>查询 GPU 和 VPU 利用率：mx-smi --show-usage</li>
<li>查询显存使用情况：mx-smi --show-memory</li>
<li>查询温度：mx-smi --show-temperature</li>
<li>查看当前运行的进程：mx-smi --show-process</li>
</ul>
<h2 data-id="heading-6">结语</h2>
<p>尽管国产 GPU 在峰值性能或生态工具链上与 <code>NVIDIA</code> 仍有差距，但在基础训练/推理任务中已具备可用性。更重要的是，有模力方舟、Qwen等友商的支持，我相信国产算力未来可期。</p>
<p>也欢迎大家抓紧去白嫖哈~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL中的字符集与排序规则]]></title>    <link>https://juejin.cn/post/7574269207363158025</link>    <guid>https://juejin.cn/post/7574269207363158025</guid>    <pubDate>2025-11-19T23:46:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574269207363158025" data-draft-id="7574568258787917875" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL中的字符集与排序规则"/> <meta itemprop="keywords" content="MySQL,数据库,后端"/> <meta itemprop="datePublished" content="2025-11-19T23:46:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序新视界"/> <meta itemprop="url" content="https://juejin.cn/user/3368559359568696"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL中的字符集与排序规则
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3368559359568696/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序新视界
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T23:46:45.000Z" title="Wed Nov 19 2025 23:46:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在MySQL中，当使用字符串类型时，有两方面的知识我们需要特别关注一下：字符集和排序规则。如果使用不当，则可能会导致性能问题或在插入数据时出现一些异常情况。</p>
<p>字符集定义了对应列允许使用的字符，而排序规则是用于比较这些字符的基础规则。通常，每个类型的字符集都会有多种排序规则，但一个排序规则只能属于一个字符集。</p>
<p>这篇文章，我们就围绕MySQL中字符集以及排序规则展开，详细聊聊相关的技术点。</p>
<h2 data-id="heading-0">MySQL中的字符集</h2>
<p>MySQL支持广泛的字符集，包括GB2312、GBK、BIG5等本地字符集，以及多种Unicode字符集，如<code>utf8mb3</code> (MySQL中旧版的<code>utf8</code>)、<code>utf8mb4</code>、<code>ucs2</code>、<code>utf16</code>和<code>utf32</code>。<code>utf8mb4</code>是推荐使用的字符集，因为它能完整支持所有Unicode字符，包括表情符号和不常用的汉字。</p>
<p>可以使用下面的命令在<code>information_schema</code>数据库中查看所有字符集：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">mysql&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> information_schema.character_sets <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> character_set_name;
+--------------------+----------------------+---------------------------------+--------+
| CHARACTER_SET_NAME | DEFAULT_COLLATE_NAME | DESCRIPTION                     | MAXLEN |
+--------------------+----------------------+---------------------------------+--------+
| armscii8           | armscii8_general_ci  | ARMSCII-<span class="hljs-number">8</span> Armenian              |      <span class="hljs-number">1</span> |
| ascii              | ascii_general_ci     | US ASCII                        |      <span class="hljs-number">1</span> |
| big5               | big5_chinese_ci      | Big5 Traditional Chinese        |      <span class="hljs-number">2</span> |
| <span class="hljs-keyword">binary</span>             | <span class="hljs-keyword">binary</span>               | <span class="hljs-keyword">Binary</span> pseudo charset           |      <span class="hljs-number">1</span> |
……
……
……
| utf16              | utf16_general_ci     | UTF-<span class="hljs-number">16</span> <span class="hljs-keyword">Unicode</span>                  |      <span class="hljs-number">4</span> |
| utf16le            | utf16le_general_ci   | UTF-<span class="hljs-number">16L</span>E <span class="hljs-keyword">Unicode</span>                |      <span class="hljs-number">4</span> |
| utf32              | utf32_general_ci     | UTF-<span class="hljs-number">32</span> <span class="hljs-keyword">Unicode</span>                  |      <span class="hljs-number">4</span> |
| utf8               | utf8_general_ci      | UTF-<span class="hljs-number">8</span> <span class="hljs-keyword">Unicode</span>                   |      <span class="hljs-number">3</span> |
| utf8mb4            | utf8mb4_0900_ai_ci   | UTF-<span class="hljs-number">8</span> <span class="hljs-keyword">Unicode</span>                   |      <span class="hljs-number">4</span> |
+--------------------+----------------------+---------------------------------+--------+
</code></pre>
<p>通过上述命令可以列出当前MySQL支持的所有字符集，以及它们的默认排序规则。每种字符集都有一个默认排序规则。</p>
<p>在上述命令展示的列表底部，有两个字符集被描述为UTF-8 Unicode。<code>utf8</code>字符集的<code>MAXLEN</code>为3，而<code>utf8mb4</code>的<code>MAXLEN</code>为4。这里指的是每个字符允许的最大字节长度。</p>
<p>特别需要留意的是，<strong>根据UTF-8标准，每个字符允许使用最多4个字节，这意味着MySQL的<code>utf8</code>字符集实际上并不是真正的UTF-8，因为它只支持每字符最多3个字节。从MySQL 8开始，<code>utf8mb4</code>成为默认字符集，也是最常使用的字符集。</strong> 而<code>utf8</code>被保留用于向下兼容，应该不再使用。</p>
<h2 data-id="heading-1">如何定义字符集</h2>
<p>定义列的字符集有几种方式。如果你没有在表或列级别指定字符集，服务器默认的<code>utf8mb4</code>字符集将被应用（除非你明确声明了一个不同的服务器或数据库默认设置）。</p>
<p>我们可以通过创建一个没有字符集信息的表并读取其定义来验证这一点：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> no_charset (
  my_column <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>)
);
​
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> no_charset;
</code></pre>
<p>生成的<code>CREATE TABLE</code>语句显示了默认的字符集和排序规则已经被应用：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `no_charset` (
  `my_column` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8mb4_0900_ai_ci;
</code></pre>
<h3 data-id="heading-2">在表级别定义</h3>
<p>你可以显式地在表级别设置字符集，通过使用<code>CHARSET=[字符集]</code>语法。例如，这里我们创建一个所有字符列都使用<code>latin1</code>字符集的表：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> no_charset (
  `my_column` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>latin1;
</code></pre>
<h3 data-id="heading-3">在列级别定义</h3>
<p>你也可以在列级别设置字符集。这是最具体的设置，会覆盖任何表级别的设置：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `mixed_collations` (
  `explicitly_set` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> latin1,
  `implicitly_set` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>)
);
</code></pre>
<p>通过运行<code>SHOW CREATE TABLE mixed_collations</code>可以看到表的默认字符集是<code>utf8mb4</code>，但是显式设置的列使用了<code>latin1</code>字符集：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `mixed_collations` (
  `explicitly_set` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> latin1 <span class="hljs-keyword">COLLATE</span> latin1_swedish_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `implicitly_set` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8mb4_0900_ai_ci;
</code></pre>
<p>列级别的声明将覆盖表级别的声明，表级别的声明将覆盖数据库默认，数据库默认的字符集覆盖服务器默认。</p>
<h2 data-id="heading-4">MySQL中的排序规则</h2>
<p>字符集定义了可以存储在列中的合法字符，而排序规则则是确定如何进行字符串比较的规则。如果你在排序或比较字符串，MySQL就会使用排序规则来决定顺序以及判断字符串是否相同。</p>
<p>可以通过查询<code>information_schema</code>表来显示所有排序规则。下面的查询仅显示与<code>utf8mb4</code>字符集相关的排序规则：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">mysql&gt;</span> <span class="hljs-string">SELECT</span>
    <span class="hljs-string">-&gt;</span>   <span class="hljs-string">*</span>
    <span class="hljs-string">-&gt;</span> <span class="hljs-string">FROM</span>
    <span class="hljs-string">-&gt;</span>   <span class="hljs-string">information_schema.collations</span>
    <span class="hljs-string">-&gt;</span> <span class="hljs-string">WHERE</span>
    <span class="hljs-string">-&gt;</span>   <span class="hljs-string">character_set_name</span> <span class="hljs-string">=</span> <span class="hljs-string">'utf8mb4'</span>
    <span class="hljs-string">-&gt;</span> <span class="hljs-string">ORDER</span> <span class="hljs-string">BY</span>
    <span class="hljs-string">-&gt;</span>   <span class="hljs-string">collation_name;</span>
<span class="hljs-string">+----------------------------+--------------------+-----+------------+-------------+---------+---------------+</span>
<span class="hljs-string">|</span> <span class="hljs-string">COLLATION_NAME</span>             <span class="hljs-string">|</span> <span class="hljs-string">CHARACTER_SET_NAME</span> <span class="hljs-string">|</span> <span class="hljs-string">ID</span>  <span class="hljs-string">|</span> <span class="hljs-string">IS_DEFAULT</span> <span class="hljs-string">|</span> <span class="hljs-string">IS_COMPILED</span> <span class="hljs-string">|</span> <span class="hljs-string">SORTLEN</span> <span class="hljs-string">|</span> <span class="hljs-string">PAD_ATTRIBUTE</span> <span class="hljs-string">|</span>
<span class="hljs-string">+----------------------------+--------------------+-----+------------+-------------+---------+---------------+</span>
<span class="hljs-string">|</span> <span class="hljs-string">utf8mb4_0900_ai_ci</span>         <span class="hljs-string">|</span> <span class="hljs-string">utf8mb4</span>            <span class="hljs-string">|</span> <span class="hljs-number">255</span> <span class="hljs-string">|</span> <span class="hljs-literal">Yes</span>        <span class="hljs-string">|</span> <span class="hljs-literal">Yes</span>         <span class="hljs-string">|</span>       <span class="hljs-number">0</span> <span class="hljs-string">|</span> <span class="hljs-literal">NO</span> <span class="hljs-string">PAD</span>        <span class="hljs-string">|</span>
<span class="hljs-string">|</span> <span class="hljs-string">utf8mb4_0900_as_ci</span>         <span class="hljs-string">|</span> <span class="hljs-string">utf8mb4</span>            <span class="hljs-string">|</span> <span class="hljs-number">305</span> <span class="hljs-string">|</span>            <span class="hljs-string">|</span> <span class="hljs-literal">Yes</span>         <span class="hljs-string">|</span>       <span class="hljs-number">0</span> <span class="hljs-string">|</span> <span class="hljs-literal">NO</span> <span class="hljs-string">PAD</span>        <span class="hljs-string">|</span>
<span class="hljs-string">|</span> <span class="hljs-string">utf8mb4_0900_as_cs</span>         <span class="hljs-string">|</span> <span class="hljs-string">utf8mb4</span>            <span class="hljs-string">|</span> <span class="hljs-number">278</span> <span class="hljs-string">|</span>            <span class="hljs-string">|</span> <span class="hljs-literal">Yes</span>         <span class="hljs-string">|</span>       <span class="hljs-number">0</span> <span class="hljs-string">|</span> <span class="hljs-literal">NO</span> <span class="hljs-string">PAD</span>        <span class="hljs-string">|</span>
<span class="hljs-string">|</span> <span class="hljs-string">utf8mb4_0900_bin</span>           <span class="hljs-string">|</span> <span class="hljs-string">utf8mb4</span>            <span class="hljs-string">|</span> <span class="hljs-number">309</span> <span class="hljs-string">|</span>            <span class="hljs-string">|</span> <span class="hljs-literal">Yes</span>         <span class="hljs-string">|</span>       <span class="hljs-number">1</span> <span class="hljs-string">|</span> <span class="hljs-literal">NO</span> <span class="hljs-string">PAD</span>        <span class="hljs-string">|</span>
<span class="hljs-string">|</span> <span class="hljs-string">utf8mb4_bin</span>                <span class="hljs-string">|</span> <span class="hljs-string">utf8mb4</span>            <span class="hljs-string">|</span>  <span class="hljs-number">46</span> <span class="hljs-string">|</span>            <span class="hljs-string">|</span> <span class="hljs-literal">Yes</span>         <span class="hljs-string">|</span>       <span class="hljs-number">1</span> <span class="hljs-string">|</span> <span class="hljs-string">PAD</span> <span class="hljs-string">SPACE</span>     <span class="hljs-string">|</span>
<span class="hljs-string">……</span>
<span class="hljs-string">……</span>
<span class="hljs-string">……</span>
</code></pre>
<p>该查询将显示所有排序规则、相关字符集名称、是否为默认值以及其他信息。例如，<code>utf8mb4_0900_ai_ci</code>是<code>utf8mb4</code>字符集的默认排序规则。</p>
<h3 data-id="heading-5">排序规则的命名规则</h3>
<p>排序规则的命名通常前缀为字符集名称，后缀由排序规则的属性组合而成。</p>
<p>以下是一些主要后缀及其含义：</p>

































<table><thead><tr><th>后缀</th><th>含义</th></tr></thead><tbody><tr><td>_ai</td><td>不区分重音符</td></tr><tr><td>_as</td><td>区分重音符</td></tr><tr><td>_ci</td><td>不区分大小写</td></tr><tr><td>_cs</td><td>区分大小写</td></tr><tr><td>_ks</td><td>区分假名</td></tr><tr><td>_bin</td><td>二进制比较</td></tr></tbody></table>
<p>例如，默认排序规则<code>utf8mb4_0900_ai_ci</code>可以拆解：</p>
<ul>
<li><code>utf8mb4</code>：属于<code>utf8mb4</code>字符集；</li>
<li><code>0900</code>：使用UCA 9.0.0的权重键；</li>
<li><code>_ai</code>：不区分重音符；</li>
<li><code>_ci</code>：不区分大小写。</li>
</ul>
<p>那么，字符串比较是否区分大小写？答案是：“视具体排序规则而定！”</p>
<h3 data-id="heading-6">验证排序规则</h3>
<p>我们可以使用<code>COLLATE</code>关键字显式设置字符串的排序规则：</p>
<pre><code class="hljs language-sql" lang="sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> "MySQL" <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="hljs-operator">=</span> "mysql" <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_ai_ci;
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------------------------------------------------+</span>
<span class="hljs-operator">|</span> "MySQL" <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="hljs-operator">=</span> "mysql" <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------------------------------------------------+</span>
<span class="hljs-operator">|</span>                                                                       <span class="hljs-number">1</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------------------------------------------------+</span>
</code></pre>
<p>此查询返回结果值为1，表示MySQL认为这两个字符串相等。如果改用区分大小写的排序规则，我们会得到不同的结果：</p>
<pre><code class="hljs language-sql" lang="sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> "MySQL" <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_as_cs <span class="hljs-operator">=</span> "mysql" <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_as_cs;
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------------------------------------------------+</span>
<span class="hljs-operator">|</span> "MySQL" <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_as_cs <span class="hljs-operator">=</span> "mysql" <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_as_cs <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------------------------------------------------+</span>
<span class="hljs-operator">|</span>                                                                       <span class="hljs-number">0</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------------------------------------------------+</span>
</code></pre>
<p>此查询返回结果值为0，表明MySQL认为这两个字符串不同，因为它们大小写不同。</p>
<p>类似逻辑也适用于重音符。例如，在使用不区分重音符的排序规则时，<code>resume</code>与<code>résumé</code>会被认为是相同的。</p>
<h2 data-id="heading-7">如何定义排序规则</h2>
<p>与字符集类似，排序规则可以在表级别或列级别设置。如果未显式定义排序规则，MySQL会使用字符集的默认排序规则。</p>
<h3 data-id="heading-8">表级别定义</h3>
<p>可以在<code>CREATE TABLE</code>语句中使用<code>COLLATE</code>子句定义表的排序规则。例如，以下创建了一个所有字符列都使用<code>utf8mb4_bin</code>排序规则的表：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> table_with_collation (
  my_column <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8mb4_bin;
</code></pre>
<h3 data-id="heading-9">列级别定义</h3>
<p>也可以在列定义中设置排序规则。例如：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> table_with_collation (
  `explicitly_set` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_general_ci,
  `implicitly_set` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4;
</code></pre>
<p>此外，也可以通过<code>ALTER TABLE</code>语句修改现有表列的排序规则：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> table_with_collation
    CHANGE `explicitly_set` `explicitly_set` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>)
        <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_ai_ci;
</code></pre>
<h2 data-id="heading-10">小结</h2>
<p>理解字符集和排序规则是处理MySQL字符串数据的基础。字符集定义了列中存储的合法字符，排序规则决定了字符串比较的方式。</p>
<ul>
<li>字符集可以在列级别、表级别定义，或者继承自数据库或服务器默认值。最具体的层级（列 &gt; 表 &gt; 数据库 &gt; 服务器）将会被采用。</li>
<li>排序规则可以在列级别、表级别定义，或者继承自字符集默认。仍然是最具体的层级优先。</li>
</ul>
<p>列的字符集和排序规则会影响数据存储方式以及数据的比较和排序行为。在设计数据库时需注意这些设置，以确保行为正确并优化性能。</p>
<p>如果不确定应使用哪个字符集或排序规则，MySQL默认的<code>utf8mb4</code>字符集及其默认排序规则<code>utf8mb4_0900_ai_ci</code>通常是一个不错的选择。它们支持所有Unicode字符并提供大小写不敏感和重音符不敏感的比较功能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue高阶组件已过时？这3种新方案让你的代码更优雅]]></title>    <link>https://juejin.cn/post/7574281453708214278</link>    <guid>https://juejin.cn/post/7574281453708214278</guid>    <pubDate>2025-11-19T23:30:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574281453708214278" data-draft-id="7574281453708197894" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue高阶组件已过时？这3种新方案让你的代码更优雅"/> <meta itemprop="keywords" content="Vue.js,JavaScript,前端"/> <meta itemprop="datePublished" content="2025-11-19T23:30:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="良山有风来"/> <meta itemprop="url" content="https://juejin.cn/user/3940246036939358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue高阶组件已过时？这3种新方案让你的代码更优雅
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3940246036939358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    良山有风来
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T23:30:09.000Z" title="Wed Nov 19 2025 23:30:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>还记得那些年被高阶组件支配的恐惧吗？props命名冲突、组件嵌套过深、调试困难...每次修改组件都像在拆炸弹。如果你还在Vue 3中苦苦挣扎如何复用组件逻辑，今天这篇文章就是为你准备的。</p>
<p>我将带你彻底告别HOC的痛点，掌握3种更现代、更优雅的代码复用方案。这些方案都是基于Vue 3的Composition API，不仅解决了HOC的老问题，还能让你的代码更加清晰和可维护。</p>
<h2 data-id="heading-0">为什么说HOC在Vue 3中已经过时？</h2>
<p>先来看一个典型的高阶组件例子。假设我们需要给多个组件添加用户登录状态检查：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 传统的HOC实现</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">withAuth</span>(<span class="hljs-params">WrappedComponent</span>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">name</span>: <span class="hljs-string">`WithAuth<span class="hljs-subst">${WrappedComponent.name}</span>`</span>,
    <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">isLoggedIn</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">userInfo</span>: <span class="hljs-literal">null</span>
      }
    },
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 检查登录状态</span>
      <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">checkLoginStatus</span>()
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isLoggedIn</span> = !!user
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">userInfo</span> = user
    },
    <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 传递所有props和事件</span>
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">h</span>(<span class="hljs-title class_">WrappedComponent</span>, {
        ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">$attrs</span>,
        ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">$props</span>,
        <span class="hljs-attr">isLoggedIn</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">isLoggedIn</span>,
        <span class="hljs-attr">userInfo</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">userInfo</span>
      })
    }
  }
}

<span class="hljs-comment">// 使用HOC</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">UserProfileWithAuth</span> = <span class="hljs-title function_">withAuth</span>(<span class="hljs-title class_">UserProfile</span>)
</code></pre>
<p>这个HOC看似解决了问题，但实际上带来了不少麻烦。首先是props冲突风险，如果被包裹的组件已经有isLoggedIn这个prop，就会产生命名冲突。其次是调试困难，在Vue Devtools中你会看到一堆WithAuth前缀的组件，很难追踪原始组件。</p>
<p>最重要的是，在Vue 3的Composition API时代，我们有更好的选择。</p>
<h2 data-id="heading-1">方案一：Composition函数 - 最推荐的替代方案</h2>
<p>Composition API的核心思想就是逻辑复用，让我们看看如何用composable函数重构上面的认证逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用Composition函数</span>
<span class="hljs-keyword">import</span> { ref, onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { checkLoginStatus } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/api/auth'</span>

<span class="hljs-comment">// 将认证逻辑提取为独立的composable</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useAuth</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> isLoggedIn = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
  <span class="hljs-keyword">const</span> userInfo = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)
  <span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">true</span>)

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">checkAuth</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">try</span> {
      loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">checkLoginStatus</span>()
      isLoggedIn.<span class="hljs-property">value</span> = !!user
      userInfo.<span class="hljs-property">value</span> = user
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'认证检查失败:'</span>, error)
      isLoggedIn.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
      userInfo.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>
    } <span class="hljs-keyword">finally</span> {
      loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
    }
  }

  <span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">checkAuth</span>()
  })

  <span class="hljs-keyword">return</span> {
    isLoggedIn,
    userInfo,
    loading,
    checkAuth
  }
}

<span class="hljs-comment">// 在组件中使用</span>
<span class="hljs-keyword">import</span> { useAuth } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/composables/useAuth'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'UserProfile'</span>,
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> { isLoggedIn, userInfo, loading } = <span class="hljs-title function_">useAuth</span>()

    <span class="hljs-keyword">return</span> {
      isLoggedIn,
      userInfo,
      loading
    }
  }
}
</code></pre>
<p>这种方式的优势很明显。逻辑完全独立，不会产生props冲突。在Devtools中调试时，你能清晰地看到原始组件和响应式数据。而且这个useAuth函数可以在任何组件中复用，不需要额外的组件嵌套。</p>
<h2 data-id="heading-2">方案二：渲染函数与插槽的完美结合</h2>
<p>对于需要控制UI渲染的场景，我们可以结合渲染函数和插槽来实现更灵活的逻辑复用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用渲染函数和插槽</span>
<span class="hljs-keyword">import</span> { h } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'AuthWrapper'</span>,
  <span class="hljs-title function_">setup</span>(<span class="hljs-params">props, { slots }</span>) {
    <span class="hljs-keyword">const</span> { isLoggedIn, userInfo, loading } = <span class="hljs-title function_">useAuth</span>()

    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (loading.<span class="hljs-property">value</span>) {
        <span class="hljs-comment">// 加载状态显示加载UI</span>
        <span class="hljs-keyword">return</span> slots.<span class="hljs-property">loading</span> ? slots.<span class="hljs-title function_">loading</span>() : <span class="hljs-title function_">h</span>(<span class="hljs-string">'div'</span>, <span class="hljs-string">'加载中...'</span>)
      }

      <span class="hljs-keyword">if</span> (!isLoggedIn.<span class="hljs-property">value</span>) {
        <span class="hljs-comment">// 未登录显示登录提示</span>
        <span class="hljs-keyword">return</span> slots.<span class="hljs-property">unauthorized</span> ? slots.<span class="hljs-title function_">unauthorized</span>() : <span class="hljs-title function_">h</span>(<span class="hljs-string">'div'</span>, <span class="hljs-string">'请先登录'</span>)
      }

      <span class="hljs-comment">// 已登录状态渲染默认插槽，并传递用户数据</span>
      <span class="hljs-keyword">return</span> slots.<span class="hljs-property">default</span> ? slots.<span class="hljs-title function_">default</span>({
        <span class="hljs-attr">user</span>: userInfo.<span class="hljs-property">value</span>
      }) : <span class="hljs-literal">null</span>
    }
  }
}

<span class="hljs-comment">// 使用方式</span>
&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AuthWrapper</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">loading</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"skeleton-loader"</span>&gt;</span>正在检查登录状态...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">unauthorized</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"login-prompt"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>需要登录<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"redirectToLogin"</span>&gt;</span>立即登录<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">"{ user }"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">UserProfile</span> <span class="hljs-attr">:user</span>=<span class="hljs-string">"user"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">AuthWrapper</span>&gt;</span></span>
&lt;/template&gt;
</code></pre>
<p>这种方式保留了组件的声明式特性，同时提供了完整的UI控制能力。你可以为不同状态提供不同的UI，而且组件结构在Devtools中保持清晰。</p>
<h2 data-id="heading-3">方案三：自定义指令处理DOM相关逻辑</h2>
<p>对于需要直接操作DOM的逻辑复用，自定义指令是不错的选择：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 权限控制指令</span>
<span class="hljs-keyword">import</span> { useAuth } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/composables/useAuth'</span>

<span class="hljs-keyword">const</span> authDirective = {
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params">el, binding</span>) {
    <span class="hljs-keyword">const</span> { isLoggedIn, userInfo } = <span class="hljs-title function_">useAuth</span>()
    
    <span class="hljs-keyword">const</span> { <span class="hljs-attr">value</span>: requiredRole } = binding
    
    <span class="hljs-comment">// 如果没有登录，隐藏元素</span>
    <span class="hljs-keyword">if</span> (!isLoggedIn.<span class="hljs-property">value</span>) {
      el.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>
      <span class="hljs-keyword">return</span>
    }
    
    <span class="hljs-comment">// 如果需要特定角色但用户没有权限，隐藏元素</span>
    <span class="hljs-keyword">if</span> (requiredRole &amp;&amp; userInfo.<span class="hljs-property">value</span>?.<span class="hljs-property">role</span> !== requiredRole) {
      el.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>
    }
  },
  <span class="hljs-title function_">updated</span>(<span class="hljs-params">el, binding</span>) {
    <span class="hljs-comment">// 权限变化时重新检查</span>
    authDirective.<span class="hljs-title function_">mounted</span>(el, binding)
  }
}

<span class="hljs-comment">// 注册指令</span>
app.<span class="hljs-title function_">directive</span>(<span class="hljs-string">'auth'</span>, authDirective)

<span class="hljs-comment">// 在模板中使用</span>
&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">v-auth</span>&gt;</span>只有登录用户能看到这个按钮<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">v-auth</span>=<span class="hljs-string">"'admin'"</span>&gt;</span>只有管理员能看到这个按钮<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
&lt;/template&gt;
</code></pre>
<p>自定义指令特别适合处理这种与DOM操作相关的逻辑，代码简洁且易于理解。</p>
<h2 data-id="heading-4">实战对比：用户权限管理场景</h2>
<p>让我们通过一个完整的用户权限管理例子，对比一下HOC和新方案的差异：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 传统HOC方式 - 不推荐</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">withUserRole</span>(<span class="hljs-params">WrappedComponent, requiredRole</span>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">currentUser</span>: <span class="hljs-literal">null</span>
      }
    },
    <span class="hljs-attr">computed</span>: {
      <span class="hljs-title function_">hasPermission</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentUser</span>?.<span class="hljs-property">role</span> === requiredRole
      }
    },
    <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">hasPermission</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">h</span>(<span class="hljs-string">'div'</span>, <span class="hljs-string">'无权限访问'</span>)
      }
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">h</span>(<span class="hljs-title class_">WrappedComponent</span>, {
        ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">$attrs</span>,
        ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">$props</span>,
        <span class="hljs-attr">user</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentUser</span>
      })
    }
  }
}

<span class="hljs-comment">// Composition函数方式 - 推荐</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useUserPermission</span>(<span class="hljs-params">requiredRole</span>) {
  <span class="hljs-keyword">const</span> { userInfo } = <span class="hljs-title function_">useAuth</span>()
  <span class="hljs-keyword">const</span> hasPermission = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">return</span> userInfo.<span class="hljs-property">value</span>?.<span class="hljs-property">role</span> === requiredRole
  })
  
  <span class="hljs-keyword">return</span> {
    hasPermission,
    <span class="hljs-attr">user</span>: userInfo
  }
}

<span class="hljs-comment">// 在组件中使用</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> { hasPermission, user } = <span class="hljs-title function_">useUserPermission</span>(<span class="hljs-string">'admin'</span>)
    
    <span class="hljs-keyword">if</span> (!hasPermission.<span class="hljs-property">value</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">h</span>(<span class="hljs-string">'div'</span>, <span class="hljs-string">'无权限访问'</span>)
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">h</span>(<span class="hljs-title class_">AdminPanel</span>, { user })
  }
}
</code></pre>
<p>Composition方式不仅代码更简洁，而且类型推断更友好，测试也更容易。</p>
<h2 data-id="heading-5">迁移指南：从HOC平稳过渡</h2>
<p>如果你有现有的HOC代码需要迁移，可以按照以下步骤进行：</p>
<p>首先，识别HOC的核心逻辑。比如上面的withAuth核心就是认证状态管理。</p>
<p>然后，将核心逻辑提取为Composition函数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 将HOC逻辑转换为composable</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">withAuthHOC</span>(<span class="hljs-params">WrappedComponent</span>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">isLoggedIn</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">userInfo</span>: <span class="hljs-literal">null</span>
      }
    },
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">checkLoginStatus</span>()
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isLoggedIn</span> = !!user
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">userInfo</span> = user
    },
    <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">h</span>(<span class="hljs-title class_">WrappedComponent</span>, {
        ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">$props</span>,
        <span class="hljs-attr">isLoggedIn</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">isLoggedIn</span>,
        <span class="hljs-attr">userInfo</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">userInfo</span>
      })
    }
  }
}

<span class="hljs-comment">// 转换为</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useAuth</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> isLoggedIn = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
  <span class="hljs-keyword">const</span> userInfo = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)
  
  <span class="hljs-title function_">onMounted</span>(<span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">checkLoginStatus</span>()
    isLoggedIn.<span class="hljs-property">value</span> = !!user
    userInfo.<span class="hljs-property">value</span> = user
  })
  
  <span class="hljs-keyword">return</span> { isLoggedIn, userInfo }
}
</code></pre>
<p>最后，逐步替换项目中的HOC使用，可以先从新组件开始采用新方案，再逐步重构旧组件。</p>
<h2 data-id="heading-6">选择合适方案的决策指南</h2>
<p>面对不同的场景，该如何选择最合适的方案呢？</p>
<p>当你需要复用纯逻辑时，比如数据获取、状态管理，选择Composition函数。这是最灵活和可复用的方案。</p>
<p>当你需要复用包含UI的逻辑时，比如加载状态、空状态，选择渲染函数与插槽组合。这提供了最好的UI控制能力。</p>
<p>当你需要操作DOM时，比如权限控制隐藏、点击外部关闭，选择自定义指令。这是最符合Vue设计理念的方式。</p>
<p>记住一个原则：能用Composition函数解决的问题，就不要用组件包装。保持组件的纯粹性，让逻辑和UI分离。</p>
<h2 data-id="heading-7">拥抱Vue 3的新范式</h2>
<p>通过今天的分享，相信你已经看到了Vue 3为逻辑复用带来的全新可能性。从HOC到Composition API，不仅仅是API的变化，更是开发思维的升级。</p>
<p>HOC代表的组件包装模式已经成为过去，而基于函数的组合模式正是未来。这种转变让我们的代码更加清晰、可测试、可维护。</p>
<p>下次当你想要复用逻辑时，不妨先想一想：这个需求真的需要包装组件吗？还是可以用一个简单的Composition函数来解决？</p>
<p>希望这些方案能够帮助你写出更优雅的Vue代码。如果你在迁移过程中遇到任何问题，欢迎在评论区分享你的经历和困惑。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot DFA 实现敏感词过滤]]></title>    <link>https://juejin.cn/post/7574281453708279814</link>    <guid>https://juejin.cn/post/7574281453708279814</guid>    <pubDate>2025-11-19T23:59:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574281453708279814" data-draft-id="7574281453707214854" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot DFA 实现敏感词过滤"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-19T23:59:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风象南"/> <meta itemprop="url" content="https://juejin.cn/user/2524134428655159"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot DFA 实现敏感词过滤
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2524134428655159/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风象南
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T23:59:02.000Z" title="Wed Nov 19 2025 23:59:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>敏感词过滤系统已经成为各大平台的必备功能。无论是社交平台的内容审核、电商系统的商品管理，还是游戏系统的聊天监控，都需要高效可靠的敏感词过滤机制来维护健康的内容生态。</p>
<p>传统的字符串查找方式在处理大量敏感词时性能急剧下降，而正则表达式在匹配复杂规则时更是捉襟见肘。</p>
<p>今天，介绍一种基于 DFA（有限状态自动机）算法的高效敏感词过滤方案，通过 Trie 树数据结构实现毫秒级响应，轻松应对敏感内容的实时过滤需求。</p>
<hr/>
<h2 data-id="heading-1">为什么需要 DFA 算法？</h2>
<h4 data-id="heading-2">传统方案的性能瓶颈</h4>
<p>在敏感词过滤的实际应用中，我们面临着诸多挑战。传统的实现方式往往存在以下问题：</p>
<p>❌ <strong>暴力匹配的低效</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 时间复杂度：O(n × m × k)</span>
<span class="hljs-comment">// 随着敏感词数量增加，性能急剧下降</span>
<span class="hljs-keyword">for</span> (String word : sensitiveWords) {
    <span class="hljs-keyword">if</span> (text.contains(word)) {
        <span class="hljs-comment">// 处理敏感词</span>
    }
}
</code></pre>
<p>这种简单粗暴的方式在小规模应用中尚可接受，但当敏感词数量达到数千甚至数万时，处理一篇1000字的文章可能需要数秒时间，严重影响用户体验。</p>
<p>❌ <strong>正则表达式的局限性</strong>
虽然正则表达式提供了强大的模式匹配能力，但在敏感词过滤场景中却存在明显缺陷：</p>
<ul>
<li>构建超大的正则表达式会导致编译时间过长</li>
<li>动态添加敏感词需要重新编译正则表达式</li>
<li>内存占用随敏感词数量线性增长</li>
<li>匹配效率在复杂规则下大幅下降</li>
</ul>
<h4 data-id="heading-3">DFA 算法的优势</h4>
<p>DFA 算法通过构建状态机模型，将敏感词匹配过程转化为状态转移，带来了质的飞跃：</p>
<p>✅ <strong>线性时间复杂度</strong>: O(n) - 只需遍历文本一次，不受敏感词数量影响
✅ <strong>空间共享优化</strong>: 敏感词前缀共享存储，显著减少内存占用
✅ <strong>确定性匹配</strong>: 无需回溯，避免正则表达式的回溯开销
✅ <strong>动态扩展友好</strong>: 支持运行时添加、删除敏感词，无需重建整个数据结构</p>
<p>以实际场景为例，当敏感词库从1000个扩展到10000个时：</p>
<ul>
<li>暴力匹配算法耗时增加约10倍</li>
<li>DFA算法耗时几乎保持不变</li>
</ul>
<h2 data-id="heading-4">DFA 算法原理解析</h2>
<h4 data-id="heading-5">DFA 算法的数学本质</h4>
<p>DFA（Deterministic Finite Automaton）是一种数学模型，它定义了一个五元组 M = (Q, Σ, δ, q₀, F)：</p>
<ul>
<li><strong>Q</strong>: 有限状态集合</li>
<li><strong>Σ</strong>: 输入字母表</li>
<li><strong>δ</strong>: 状态转移函数 δ: Q × Σ → Q</li>
<li><strong>q₀</strong>: 初始状态</li>
<li><strong>F</strong>: 接受状态集合</li>
</ul>
<p>在敏感词过滤中，每个状态代表匹配到某个字符位置的状态转移路径。</p>
<h4 data-id="heading-6">Trie 树的可视化理解</h4>
<p>Trie 树是 DFA 的直观实现，也称为字典树或前缀树。让我们通过一个具体例子来理解：</p>
<p>假设有以下敏感词：["apple", "app", "application", "apply", "orange"]</p>
<p>构建的 Trie 树结构如下：</p>
<pre><code class="hljs language-css" lang="css">root
├── <span class="hljs-selector-tag">a</span>
│   └── <span class="hljs-selector-tag">p</span>
│       └── <span class="hljs-selector-tag">p</span> <span class="hljs-selector-attr">[结束]</span>  ← "app"
│           └── l
│               ├── e <span class="hljs-selector-attr">[结束]</span>  ← "apple"
│               ├── <span class="hljs-selector-tag">i</span>
│               │   └── c
│               │       └── <span class="hljs-selector-tag">a</span>
│               │           └── t
│               │               └── <span class="hljs-selector-tag">i</span>
│               │                   └── o
│               │                       └── n <span class="hljs-selector-attr">[结束]</span>  ← "application"
│               └── y <span class="hljs-selector-attr">[结束]</span>  ← "apply"
└── o
    └── r
        └── <span class="hljs-selector-tag">a</span>
            └── n
                └── g
                    └── e <span class="hljs-selector-attr">[结束]</span>  ← "orange"
</code></pre>
<p><strong>Trie 树结构的关键特征</strong>：</p>
<p><strong>1. 前缀共享优化</strong>：</p>
<ul>
<li>"app" 作为 "apple"、"application"、"apply" 的共同前缀，只存储一次</li>
<li>从 "app" 节点分支出不同的后续字符路径</li>
</ul>
<p><strong>2. 状态转移路径</strong>：</p>
<ul>
<li>每个 <code>├──</code> 和 <code>└──</code> 表示一个字符状态转移</li>
<li><code>[结束]</code> 标记表示 DFA 的接受状态（敏感词结束）</li>
</ul>
<p><strong>3. 空间效率</strong>：</p>
<ul>
<li>5个敏感词只需要存储 10 个字符节点（含重复字符）</li>
<li>如果单独存储需要 5 + 3 + 11 + 4 + 6 = 29 个字符</li>
</ul>
<p><strong>4. 查找效率</strong>：</p>
<ul>
<li>查找 "application" 只需要 11 次字符比较</li>
<li>查找 "app" 只需要 3 次字符比较且可以提前终止</li>
</ul>
<p><strong>关键特征解释</strong></p>
<p><strong>1. 前缀共享</strong>: "app" 作为 "apple"、"application"、"apply" 的前缀，只在树中存储一次</p>
<p><strong>2. 节点状态</strong>: 每个节点代表 DFA 的一个状态</p>
<p><strong>3. 边转移</strong>: 每条边代表一个字符输入引起的状态转移</p>
<p><strong>4. 接受状态</strong>: 标记 * 的节点表示敏感词的结束状态（接受状态）</p>
<p>例如，当检测文本 "I love apples" 时：</p>
<ul>
<li>从根节点开始，遇到 'a' 转移到 a 节点</li>
<li>遇到 'p' 转移到 p 节点</li>
<li>遇到 'p' 转移到 p 节点</li>
<li>遇到 'l' 转移到 l 节点</li>
<li>遇到 'e' 转移到 e 节点（到达接受状态，发现敏感词 "apple"）</li>
<li>继续检测 's' 时状态转移失败，回到初始位置继续检测</li>
</ul>
<h4 data-id="heading-7">状态转移的实际过程</h4>
<p>假设我们要在文本 "I like apples and apps" 中查找敏感词：</p>
<ol>
<li>从根节点开始，遇到 'a'，转移到 'a' 节点</li>
<li>遇到 'p'，转移到 'p' 节点</li>
<li>遇到 'p'，转移到 'p' 节点（此时检测到 "app" 是敏感词）</li>
<li>遇到 'l'，转移到 'l' 节点</li>
<li>遇到 'e'，转移到 'e' 节点（此时检测到 "apple" 是敏感词）</li>
</ol>
<p>整个过程只需要一次线性遍历，无需重复扫描或回溯。</p>
<h2 data-id="heading-8">核心实现详解</h2>
<h4 data-id="heading-9">1. Trie 节点结构设计</h4>
<p>Trie 节点是整个 DFA 算法的基础，每个节点代表一个状态：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TrieNode</span> {
    <span class="hljs-comment">// 子节点映射：字符 -&gt; Trie节点</span>
    <span class="hljs-keyword">private</span> Map&lt;Character, TrieNode&gt; children = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

    <span class="hljs-comment">// 是否为敏感词的结束节点</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">isEnd</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// 完整敏感词内容（便于输出）</span>
    <span class="hljs-keyword">private</span> String keyword;

    <span class="hljs-keyword">public</span> TrieNode <span class="hljs-title function_">getChild</span><span class="hljs-params">(<span class="hljs-type">char</span> c)</span> {
        <span class="hljs-keyword">return</span> children.get(c);
    }

    <span class="hljs-keyword">public</span> TrieNode <span class="hljs-title function_">addChild</span><span class="hljs-params">(<span class="hljs-type">char</span> c)</span> {
        <span class="hljs-keyword">return</span> children.computeIfAbsent(c, k -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">TrieNode</span>());
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasChild</span><span class="hljs-params">(<span class="hljs-type">char</span> c)</span> {
        <span class="hljs-keyword">return</span> children.containsKey(c);
    }

    <span class="hljs-comment">// getters and setters...</span>
}
</code></pre>
<h4 data-id="heading-10">2. DFA 过滤器核心实现</h4>
<p>以下是最精简的 DFA 过滤器实现，包含了核心的匹配逻辑：</p>
<pre><code class="hljs language-ini" lang="ini">public class SensitiveWordFilter {
    private TrieNode root<span class="hljs-comment">;</span>
    private int <span class="hljs-attr">minWordLength</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>

    public SensitiveWordFilter(List&lt;String&gt; sensitiveWords) {
        <span class="hljs-attr">this.root</span> = buildTrie(sensitiveWords)<span class="hljs-comment">;</span>
        <span class="hljs-attr">this.minWordLength</span> = sensitiveWords.stream()
            .mapToInt(String::length).min().orElse(1)<span class="hljs-comment">;</span>
    }

    /**
     * 构建 Trie 树
     */
    private TrieNode buildTrie(List&lt;String&gt; words) {
        TrieNode <span class="hljs-attr">root</span> = new TrieNode()<span class="hljs-comment">;</span>
        for (String word : words) {
            TrieNode <span class="hljs-attr">node</span> = root<span class="hljs-comment">;</span>
            for (char c : word.toCharArray()) {
                <span class="hljs-attr">node</span> = node.addChild(c)<span class="hljs-comment">;</span>
            }
            node.setEnd(true)<span class="hljs-comment">;</span>
            node.setKeyword(word)<span class="hljs-comment">;</span>
        }
        return root<span class="hljs-comment">;</span>
    }

    /**
     * 检查是否包含敏感词 - 核心 DFA 匹配算法
     */
    public boolean containsSensitiveWord(String text) {
        if (<span class="hljs-attr">text</span> == null || text.length() &lt; minWordLength) {
            return false<span class="hljs-comment">;</span>
        }

        char<span class="hljs-section">[]</span> <span class="hljs-attr">chars</span> = text.toCharArray()<span class="hljs-comment">;</span>
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; chars.length; i++) {</span>
            if (dfaMatch(chars, i)) {
                return true<span class="hljs-comment">;</span>
            }
        }
        return false<span class="hljs-comment">;</span>
    }

    /**
     * DFA 状态转移匹配
     */
    private boolean dfaMatch(char<span class="hljs-section">[]</span> chars, int start) {
        TrieNode <span class="hljs-attr">node</span> = root<span class="hljs-comment">;</span>

        for (int <span class="hljs-attr">i</span> = start<span class="hljs-comment">; i &lt; chars.length; i++) {</span>
            char <span class="hljs-attr">c</span> = chars[i]<span class="hljs-comment">;</span>

            if (!node.hasChild(c)) {
                break<span class="hljs-comment">; // 状态转移失败</span>
            }

            <span class="hljs-attr">node</span> = node.getChild(c)<span class="hljs-comment">;</span>

            if (node.isEnd()) {
                return true<span class="hljs-comment">; // 到达接受状态</span>
            }
        }
        return false<span class="hljs-comment">;</span>
    }

    /**
     * 查找并替换敏感词
     */
    public String filter(String text, String replacement) {
        List&lt;SensitiveWordResult&gt; <span class="hljs-attr">words</span> = findAllWords(text)<span class="hljs-comment">;</span>

        // 从后往前替换，避免索引变化问题
        StringBuilder <span class="hljs-attr">result</span> = new StringBuilder(text)<span class="hljs-comment">;</span>
        for (int <span class="hljs-attr">i</span> = words.size() - <span class="hljs-number">1</span><span class="hljs-comment">; i &gt;= 0; i--) {</span>
            SensitiveWordResult <span class="hljs-attr">word</span> = words.get(i)<span class="hljs-comment">;</span>
            String <span class="hljs-attr">stars</span> = String.valueOf(replacement != null ? replacement : <span class="hljs-string">"*"</span>)
                .repeat(word.getEnd() - word.getStart() + 1)<span class="hljs-comment">;</span>
            result.replace(word.getStart(), word.getEnd() + 1, stars)<span class="hljs-comment">;</span>
        }
        return result.toString()<span class="hljs-comment">;</span>
    }

    /**
     * 查找所有敏感词
     */
    public List&lt;SensitiveWordResult&gt; findAllWords(String text) {
        List&lt;SensitiveWordResult&gt; <span class="hljs-attr">results</span> = new ArrayList&lt;&gt;()<span class="hljs-comment">;</span>

        if (<span class="hljs-attr">text</span> == null || text.length() &lt; minWordLength) {
            return results<span class="hljs-comment">;</span>
        }

        char<span class="hljs-section">[]</span> <span class="hljs-attr">chars</span> = text.toCharArray()<span class="hljs-comment">;</span>
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; chars.length; i++) {</span>
            TrieNode <span class="hljs-attr">node</span> = root<span class="hljs-comment">;</span>
            int <span class="hljs-attr">j</span> = i<span class="hljs-comment">;</span>

            while (j &lt; chars.length &amp;&amp; node.hasChild(chars<span class="hljs-section">[j]</span>)) {
                <span class="hljs-attr">node</span> = node.getChild(chars[j])<span class="hljs-comment">;</span>
                j++<span class="hljs-comment">;</span>

                if (node.isEnd()) {
                    results.add(new SensitiveWordResult(
                        text.substring(i, j), i, j - 1))<span class="hljs-comment">;</span>
                }
            }
        }
        return results<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h4 data-id="heading-11">3. 敏感词结果封装</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SensitiveWordResult</span> {
    <span class="hljs-keyword">private</span> String word;      <span class="hljs-comment">// 敏感词内容</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> start;        <span class="hljs-comment">// 起始位置</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> end;          <span class="hljs-comment">// 结束位置</span>

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SensitiveWordResult</span><span class="hljs-params">(String word, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> end)</span> {
        <span class="hljs-built_in">this</span>.word = word;
        <span class="hljs-built_in">this</span>.start = start;
        <span class="hljs-built_in">this</span>.end = end;
    }

    <span class="hljs-comment">// getters and toString...</span>
}
</code></pre>
<h2 data-id="heading-12">实战应用场景</h2>
<h4 data-id="heading-13">即时通讯系统中的实时过滤</h4>
<p>在高并发的聊天系统中，敏感词过滤需要满足低延迟、高吞吐的要求：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatMessageFilter</span> {
    <span class="hljs-keyword">private</span> SensitiveWordFilter wordFilter;

    <span class="hljs-comment">// 异步处理敏感词检测</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">filterExecutor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);

    <span class="hljs-keyword">public</span> CompletableFuture&lt;Message&gt; <span class="hljs-title function_">filterMessageAsync</span><span class="hljs-params">(Message message)</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> message.getContent();

            <span class="hljs-keyword">if</span> (wordFilter.containsSensitiveWord(content)) {
                <span class="hljs-comment">// 实时替换</span>
                <span class="hljs-type">String</span> <span class="hljs-variable">filtered</span> <span class="hljs-operator">=</span> wordFilter.filter(content, <span class="hljs-string">"***"</span>);
                message.setContent(filtered);

                <span class="hljs-comment">// 记录敏感词统计</span>
                recordSensitiveWords(content);
            }

            <span class="hljs-keyword">return</span> message;
        }, filterExecutor);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recordSensitiveWords</span><span class="hljs-params">(String content)</span> {
        List&lt;SensitiveWordResult&gt; words = wordFilter.findAllWords(content);
        <span class="hljs-comment">// 统计敏感词出现频率，用于优化词库</span>
        updateWordFrequency(words);
    }
}
</code></pre>
<h4 data-id="heading-14">内容审核系统的多级策略</h4>
<p>不同类型的敏感词需要不同的处理策略：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ContentAuditor</span> {
    <span class="hljs-keyword">private</span> SensitiveWordFilter highRiskFilter;  <span class="hljs-comment">// 高风险词</span>
    <span class="hljs-keyword">private</span> SensitiveWordFilter mediumRiskFilter; <span class="hljs-comment">// 中风险词</span>
    <span class="hljs-keyword">private</span> SensitiveWordFilter lowRiskFilter;   <span class="hljs-comment">// 低风险词</span>

    <span class="hljs-keyword">public</span> AuditResult <span class="hljs-title function_">auditContent</span><span class="hljs-params">(String content)</span> {
        <span class="hljs-type">AuditResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuditResult</span>();

        <span class="hljs-comment">// 按风险级别检测</span>
        List&lt;SensitiveWordResult&gt; highRiskWords = highRiskFilter.findAllWords(content);
        <span class="hljs-keyword">if</span> (!highRiskWords.isEmpty()) {
            result.setStatus(AuditStatus.REJECT);
            result.setReason(<span class="hljs-string">"包含高风险敏感词"</span>);
            <span class="hljs-keyword">return</span> result;
        }

        List&lt;SensitiveWordResult&gt; mediumRiskWords = mediumRiskFilter.findAllWords(content);
        <span class="hljs-keyword">if</span> (!mediumRiskWords.isEmpty()) {
            result.setStatus(AuditStatus.MANUAL_REVIEW);
            result.setReason(<span class="hljs-string">"包含中风险敏感词，需要人工审核"</span>);
            <span class="hljs-keyword">return</span> result;
        }

        List&lt;SensitiveWordResult&gt; lowRiskWords = lowRiskFilter.findAllWords(content);
        <span class="hljs-keyword">if</span> (!lowRiskWords.isEmpty()) {
            <span class="hljs-comment">// 低风险词汇直接过滤</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">filtered</span> <span class="hljs-operator">=</span> lowRiskFilter.filter(content, <span class="hljs-string">"***"</span>);
            result.setFilteredContent(filtered);
            result.setStatus(AuditStatus.PASS_WITH_FILTER);
        } <span class="hljs-keyword">else</span> {
            result.setStatus(AuditStatus.PASS);
        }

        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<h4 data-id="heading-15">动态词库管理</h4>
<p>实际项目中，敏感词库需要动态更新：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SensitiveWordManager</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> SensitiveWordFilter filter;
    <span class="hljs-keyword">private</span> <span class="hljs-type">ScheduledExecutorService</span> <span class="hljs-variable">updateExecutor</span> <span class="hljs-operator">=</span>
        Executors.newSingleThreadScheduledExecutor();

    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> {
        loadWords();
        <span class="hljs-comment">// 定期更新词库</span>
        updateExecutor.scheduleAtFixedRate(<span class="hljs-built_in">this</span>::loadWords, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, TimeUnit.HOURS);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadWords</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 从数据库或配置中心加载最新词库</span>
            List&lt;String&gt; words = fetchLatestWords();
            <span class="hljs-type">SensitiveWordFilter</span> <span class="hljs-variable">newFilter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SensitiveWordFilter</span>(words);

            <span class="hljs-built_in">this</span>.filter = newFilter;

            log.info(<span class="hljs-string">"敏感词库更新完成，当前词数：{}"</span>, words.size());
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"词库更新失败"</span>, e);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">containsSensitiveWord</span><span class="hljs-params">(String text)</span> {
        <span class="hljs-keyword">return</span> filter != <span class="hljs-literal">null</span> &amp;&amp; filter.containsSensitiveWord(text);
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">filterText</span><span class="hljs-params">(String text)</span> {
        <span class="hljs-keyword">return</span> filter != <span class="hljs-literal">null</span> ? filter.filter(text, <span class="hljs-string">"***"</span>) : text;
    }
}
</code></pre>
<h2 data-id="heading-16">高级优化方案</h2>
<p>对于不同规模的敏感词过滤需求，基础的 DFA 算法可能需要进一步优化。以下是几种常用的高级方案：</p>
<h4 data-id="heading-17">方案1：双数组 Trie（Double-Array Trie）</h4>
<p><strong>核心思想</strong>：将 Trie 树压缩为两个数组，减小内存使用。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 双数组结构示意</span>
<span class="hljs-type">int</span>[] base = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[size];  <span class="hljs-comment">// 状态转移基础值</span>
<span class="hljs-type">int</span>[] check = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[size]; <span class="hljs-comment">// 状态转移检查值</span>

<span class="hljs-comment">// 状态转移：next_state = base[current_state] + char_code</span>
<span class="hljs-comment">// if check[next_state] == current_state: 转移成功</span>
</code></pre>
<p><strong>适用场景</strong>：词库规模较大</p>
<p><strong>优点</strong>：内存占用减少 50%-80%</p>
<p><strong>缺点</strong>：构建复杂度增加，动态更新困难</p>
<p><strong>应用</strong>：搜索引擎、大型社交平台的离线词库</p>
<h4 data-id="heading-18">方案2：AC 自动机（Aho-Corasick）</h4>
<p><strong>核心思想</strong>：在 Trie 基础上增加失败指针，实现一次遍历匹配多个模式。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AhoCorasickAutomaton</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">Node</span> <span class="hljs-variable">root</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>();

    <span class="hljs-comment">// Trie 节点结构</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span> {
        Map&lt;Character, Node&gt; children = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        Node fail;           <span class="hljs-comment">// 失败指针</span>
        List&lt;String&gt; output = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();  <span class="hljs-comment">// 输出模式</span>
    }

    <span class="hljs-comment">// 构建自动机</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">build</span><span class="hljs-params">(List&lt;String&gt; patterns)</span> {
        <span class="hljs-comment">// 1. 构建 Trie 树</span>
        <span class="hljs-keyword">for</span> (String pattern : patterns) {
            <span class="hljs-type">Node</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> root;
            <span class="hljs-keyword">for</span> (<span class="hljs-type">char</span> c : pattern.toCharArray()) {
                node = node.children.computeIfAbsent(c, k -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>());
            }
            node.output.add(pattern);
        }

        <span class="hljs-comment">// 2. 添加失败指针</span>
        Queue&lt;Node&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();

        <span class="hljs-comment">// 初始化根节点的子节点</span>
        <span class="hljs-keyword">for</span> (Node child : root.children.values()) {
            child.fail = root;
            queue.add(child);
        }

        <span class="hljs-comment">// BFS 构建失败指针</span>
        <span class="hljs-keyword">while</span> (!queue.isEmpty()) {
            <span class="hljs-type">Node</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> queue.poll();

            <span class="hljs-keyword">for</span> (Map.Entry&lt;Character, Node&gt; entry : current.children.entrySet()) {
                <span class="hljs-type">char</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> entry.getKey();
                <span class="hljs-type">Node</span> <span class="hljs-variable">child</span> <span class="hljs-operator">=</span> entry.getValue();

                <span class="hljs-comment">// 找到失败指针</span>
                <span class="hljs-type">Node</span> <span class="hljs-variable">failNode</span> <span class="hljs-operator">=</span> current.fail;
                <span class="hljs-keyword">while</span> (failNode != <span class="hljs-literal">null</span> &amp;&amp; !failNode.children.containsKey(c)) {
                    failNode = failNode.fail;
                }

                child.fail = (failNode == <span class="hljs-literal">null</span>) ? root : failNode.children.get(c);
                child.output.addAll(child.fail.output);

                queue.add(child);
            }
        }
    }

    <span class="hljs-comment">// 搜索匹配</span>
    <span class="hljs-keyword">public</span> List&lt;MatchResult&gt; <span class="hljs-title function_">search</span><span class="hljs-params">(String text)</span> {
        List&lt;MatchResult&gt; results = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-type">Node</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> root;

        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; text.length(); i++) {
            <span class="hljs-type">char</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> text.charAt(i);

            <span class="hljs-comment">// 失败指针跳转</span>
            <span class="hljs-keyword">while</span> (node != <span class="hljs-literal">null</span> &amp;&amp; !node.children.containsKey(c)) {
                node = node.fail;
            }

            node = (node == <span class="hljs-literal">null</span>) ? root : node.children.get(c);

            <span class="hljs-comment">// 输出匹配结果</span>
            <span class="hljs-keyword">for</span> (String pattern : node.output) {
                results.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MatchResult</span>(pattern, i - pattern.length() + <span class="hljs-number">1</span>, i));
            }
        }

        <span class="hljs-keyword">return</span> results;
    }

    <span class="hljs-comment">// 匹配结果</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MatchResult</span> {
        String pattern;
        <span class="hljs-type">int</span> start;
        <span class="hljs-type">int</span> end;

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">MatchResult</span><span class="hljs-params">(String pattern, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> end)</span> {
            <span class="hljs-built_in">this</span>.pattern = pattern;
            <span class="hljs-built_in">this</span>.start = start;
            <span class="hljs-built_in">this</span>.end = end;
        }
    }
}
</code></pre>
<p><strong>适用场景</strong>：多模式匹配、日志分析</p>
<p><strong>优点</strong>：可同时匹配多个敏感词，无需多次遍历</p>
<p><strong>缺点</strong>：空间复杂度较高，实现相对复杂</p>
<p><strong>应用</strong>：网络安全、内容审核系统</p>
<h4 data-id="heading-19">方案3：分片 + 布隆过滤器预筛选</h4>
<p><strong>核心思想</strong>：通过分片降低单机压力，用布隆过滤器快速过滤明显不包含敏感词的文本。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 分片处理示例</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShardedFilter</span> {
	<span class="hljs-comment">// 模拟分片</span>
    <span class="hljs-keyword">private</span> List&lt;SensitiveWordFilter&gt; shards;
    <span class="hljs-keyword">private</span> BloomFilter&lt;String&gt; preFilter;

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">containsSensitive</span><span class="hljs-params">(String text)</span> {
        <span class="hljs-comment">// 布隆过滤器预筛选</span>
        <span class="hljs-keyword">if</span> (!preFilter.mightContain(text)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// 肯定不包含敏感词</span>
        }

        <span class="hljs-comment">// 分片精确匹配</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">shardIndex</span> <span class="hljs-operator">=</span> text.hashCode() % shards.size();
        <span class="hljs-keyword">return</span> shards.get(shardIndex).containsSensitiveWord(text);
    }
}
</code></pre>
<p><strong>适用场景</strong>：高并发、大规模文本处理</p>
<p><strong>优点</strong>：支持水平扩展，预处理可过滤大量无效请求</p>
<p><strong>缺点</strong>：存在误判概率，系统复杂度增加</p>
<p><strong>应用</strong>：弹幕系统、即时通讯、微服务架构</p>
<h2 data-id="heading-20">总结</h2>
<p>DFA 算法通过 Trie 树结构，为敏感词过滤提供了一个兼具效率和准确性的解决方案。</p>
<p>在实际应用中，需要根据具体的业务场景选择合适的实现策略。</p>
<p>无论是追求极致性能的聊天系统，还是注重准确率的内容审核平台，DFA 算法都能提供坚实的基础支撑。</p>
<h2 data-id="heading-21">仓库</h2>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/yuboon</span><span class="hljs-regexp">/java-examples/tree</span><span class="hljs-regexp">/master/springboot</span>-dfa
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis（134）Redis的事件循环模型是什么？]]></title>    <link>https://juejin.cn/post/7574568258787901491</link>    <guid>https://juejin.cn/post/7574568258787901491</guid>    <pubDate>2025-11-19T22:59:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574568258787901491" data-draft-id="7574568258787885107" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis（134）Redis的事件循环模型是什么？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-19T22:59:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis（134）Redis的事件循环模型是什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T22:59:42.000Z" title="Wed Nov 19 2025 22:59:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Redis的事件循环模型是其高性能和高并发处理能力的关键。Redis使用基于reactor模式的单线程事件驱动模型来处理网络事件和文件事件。这种模型包括事件的注册、事件的分发和事件的处理。Redis源码中的<code>ae</code>库实现了其事件循环机制。</p>
<h3 data-id="heading-0">事件循环模型的主要组件</h3>
<ol>
<li><strong>事件循环</strong>：主要由<code>aeEventLoop</code>结构体表示，包含了所有需要处理的事件信息。</li>
<li><strong>文件事件</strong>：如套接字的可读/可写事件。</li>
<li><strong>时间事件</strong>：如定时任务。</li>
</ol>
<h3 data-id="heading-1">核心数据结构</h3>
<h4 data-id="heading-2"><code>aeEventLoop</code> 结构体</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">aeEventLoop</span> {</span>
    <span class="hljs-type">int</span> maxfd;   <span class="hljs-comment">/* highest file descriptor currently registered */</span>
    <span class="hljs-type">int</span> setsize; <span class="hljs-comment">/* max number of file descriptors tracked */</span>
    <span class="hljs-type">long</span> <span class="hljs-type">long</span> timeEventNextId;
    aeFileEvent *events; <span class="hljs-comment">/* Registered events */</span>
    aeFiredEvent *fired; <span class="hljs-comment">/* Fired events */</span>
    aeTimeEvent *timeEventHead;
    <span class="hljs-type">int</span> stop;
    <span class="hljs-type">void</span> *apidata; <span class="hljs-comment">/* This is used for polling API specific data */</span>
    aeBeforeSleepProc *beforesleep;
    aeBeforeSleepProc *aftersleep;
} aeEventLoop;
</code></pre>
<h3 data-id="heading-3">文件事件</h3>
<p>Redis使用<code>aeFileEvent</code>结构体来表示文件事件：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">aeFileEvent</span> {</span>
    <span class="hljs-type">int</span> mask; <span class="hljs-comment">/* one of AE_(READABLE|WRITABLE) */</span>
    aeFileProc *rfileProc;
    aeFileProc *wfileProc;
    <span class="hljs-type">void</span> *clientData;
} aeFileEvent;
</code></pre>
<h3 data-id="heading-4">时间事件</h3>
<p>时间事件通过<code>aeTimeEvent</code>结构体表示：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">aeTimeEvent</span> {</span>
    <span class="hljs-type">long</span> <span class="hljs-type">long</span> id; <span class="hljs-comment">/* time event identifier. */</span>
    <span class="hljs-type">long</span> when_sec; <span class="hljs-comment">/* seconds */</span>
    <span class="hljs-type">long</span> when_ms; <span class="hljs-comment">/* milliseconds */</span>
    aeTimeProc *timeProc;
    aeEventFinalizerProc *finalizerProc;
    <span class="hljs-type">void</span> *clientData;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">aeTimeEvent</span> *<span class="hljs-title">next</span>;</span>
} aeTimeEvent;
</code></pre>
<h3 data-id="heading-5">事件循环的主要流程</h3>
<h4 data-id="heading-6">1. 创建事件循环</h4>
<p>创建事件循环，为文件事件和时间事件分配空间：</p>
<pre><code class="hljs language-c" lang="c">aeEventLoop *<span class="hljs-title function_">aeCreateEventLoop</span><span class="hljs-params">(<span class="hljs-type">int</span> setsize)</span> {
    aeEventLoop *eventLoop;
    <span class="hljs-type">int</span> i;

    <span class="hljs-keyword">if</span> ((eventLoop = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(*eventLoop))) == <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">goto</span> err;
    eventLoop-&gt;events = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(aeFileEvent)*setsize);
    eventLoop-&gt;fired = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(aeFiredEvent)*setsize);
    <span class="hljs-keyword">if</span> (eventLoop-&gt;events == <span class="hljs-literal">NULL</span> || eventLoop-&gt;fired == <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">goto</span> err;
    eventLoop-&gt;setsize = setsize;
    eventLoop-&gt;timeEventHead = <span class="hljs-literal">NULL</span>;
    eventLoop-&gt;timeEventNextId = <span class="hljs-number">0</span>;
    eventLoop-&gt;stop = <span class="hljs-number">0</span>;
    eventLoop-&gt;maxfd = <span class="hljs-number">-1</span>;
    eventLoop-&gt;beforesleep = <span class="hljs-literal">NULL</span>;
    eventLoop-&gt;aftersleep = <span class="hljs-literal">NULL</span>;
    <span class="hljs-comment">/* 根据操作系统，初始化不同的IO多路复用机制（如epoll, kqueue等） */</span>
    <span class="hljs-keyword">if</span> (aeApiCreate(eventLoop) == <span class="hljs-number">-1</span>) <span class="hljs-keyword">goto</span> err;
    <span class="hljs-comment">/* 初始化文件事件数组 */</span>
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; setsize; i++)
        eventLoop-&gt;events[i].mask = AE_NONE;
    <span class="hljs-keyword">return</span> eventLoop;

err:
    <span class="hljs-keyword">if</span> (eventLoop) {
        <span class="hljs-built_in">free</span>(eventLoop-&gt;events);
        <span class="hljs-built_in">free</span>(eventLoop-&gt;fired);
        <span class="hljs-built_in">free</span>(eventLoop);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
}
</code></pre>
<h4 data-id="heading-7">2. 注册事件</h4>
<p>注册文件事件：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> <span class="hljs-title function_">aeCreateFileEvent</span><span class="hljs-params">(aeEventLoop *eventLoop, <span class="hljs-type">int</span> fd, <span class="hljs-type">int</span> mask,
                      aeFileProc *proc, <span class="hljs-type">void</span> *clientData)</span> {
    <span class="hljs-keyword">if</span> (fd &gt;= eventLoop-&gt;setsize) <span class="hljs-keyword">return</span> AE_ERR;
    aeFileEvent *fe = &amp;eventLoop-&gt;events[fd];

    <span class="hljs-keyword">if</span> (aeApiAddEvent(eventLoop, fd, mask) == <span class="hljs-number">-1</span>)
        <span class="hljs-keyword">return</span> AE_ERR;
    fe-&gt;mask |= mask;
    <span class="hljs-keyword">if</span> (mask &amp; AE_READABLE) fe-&gt;rfileProc = proc;
    <span class="hljs-keyword">if</span> (mask &amp; AE_WRITABLE) fe-&gt;wfileProc = proc;
    fe-&gt;clientData = clientData;
    <span class="hljs-keyword">if</span> (fd &gt; eventLoop-&gt;maxfd)
        eventLoop-&gt;maxfd = fd;
    <span class="hljs-keyword">return</span> AE_OK;
}
</code></pre>
<h4 data-id="heading-8">3. 事件处理循环</h4>
<p>在事件循环中，事件处理的主要步骤是：</p>
<ol>
<li>等待事件（调用<code>aeApiPoll</code>）。</li>
<li>处理已触发的文件事件。</li>
<li>处理时间事件。</li>
</ol>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">aeMain</span><span class="hljs-params">(aeEventLoop *eventLoop)</span> {
    eventLoop-&gt;stop = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">while</span> (!eventLoop-&gt;stop) {
        <span class="hljs-keyword">if</span> (eventLoop-&gt;beforesleep != <span class="hljs-literal">NULL</span>)
            eventLoop-&gt;beforesleep(eventLoop);
        aeProcessEvents(eventLoop, AE_ALL_EVENTS);
        <span class="hljs-keyword">if</span> (eventLoop-&gt;aftersleep != <span class="hljs-literal">NULL</span>)
            eventLoop-&gt;aftersleep(eventLoop);
    }
}

<span class="hljs-type">int</span> <span class="hljs-title function_">aeProcessEvents</span><span class="hljs-params">(aeEventLoop *eventLoop, <span class="hljs-type">int</span> flags)</span> {
    <span class="hljs-type">int</span> processed = <span class="hljs-number">0</span>, numevents;

    <span class="hljs-comment">/* 处理时间事件 */</span>
    <span class="hljs-keyword">if</span> (!(flags &amp; AE_TIME_EVENTS)) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    processed += processTimeEvents(eventLoop);

    <span class="hljs-comment">/* 处理文件事件 */</span>
    <span class="hljs-keyword">if</span> (flags &amp; AE_FILE_EVENTS) {
        numevents = aeApiPoll(eventLoop, &amp;tvp);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; numevents; j++) {
            aeFileEvent *fe = &amp;eventLoop-&gt;events[eventLoop-&gt;fired[j].fd];
            <span class="hljs-type">int</span> mask = eventLoop-&gt;fired[j].mask;
            <span class="hljs-type">int</span> fd = eventLoop-&gt;fired[j].fd;
            <span class="hljs-type">int</span> rfired = <span class="hljs-number">0</span>;

            <span class="hljs-comment">/* 处理读事件 */</span>
            <span class="hljs-keyword">if</span> (fe-&gt;mask &amp; mask &amp; AE_READABLE) {
                rfired = <span class="hljs-number">1</span>;
                fe-&gt;rfileProc(eventLoop, fd, fe-&gt;clientData, mask);
            }

            <span class="hljs-comment">/* 处理写事件 */</span>
            <span class="hljs-keyword">if</span> (fe-&gt;mask &amp; mask &amp; AE_WRITABLE) {
                <span class="hljs-keyword">if</span> (!rfired || fe-&gt;wfileProc != fe-&gt;rfileProc)
                    fe-&gt;wfileProc(eventLoop, fd, fe-&gt;clientData, mask);
            }

            processed++;
        }
    }

    <span class="hljs-keyword">return</span> processed;
}
</code></pre>
<h3 data-id="heading-9">事件处理代码示例</h3>
<p>以下是一个简单的示例，展示了如何使用Redis的事件循环模型处理文件事件：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ae.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>

<span class="hljs-comment">/* 文件事件处理函数 */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">fileEventProc</span><span class="hljs-params">(aeEventLoop *eventLoop, <span class="hljs-type">int</span> fd, <span class="hljs-type">void</span> *clientData, <span class="hljs-type">int</span> mask)</span> {
    <span class="hljs-type">char</span> buf[<span class="hljs-number">128</span>];
    <span class="hljs-type">int</span> n = read(fd, buf, <span class="hljs-keyword">sizeof</span>(buf));
    <span class="hljs-keyword">if</span> (n &gt; <span class="hljs-number">0</span>) {
        buf[n] = <span class="hljs-string">'\0'</span>;
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Read from fd %d: %s\n"</span>, fd, buf);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (n == <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"EOF on fd %d\n"</span>, fd);
        aeDeleteFileEvent(eventLoop, fd, AE_READABLE);
        close(fd);
    } <span class="hljs-keyword">else</span> {
        perror(<span class="hljs-string">"read"</span>);
    }
}

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span> {
    aeEventLoop *eventLoop = aeCreateEventLoop(<span class="hljs-number">1024</span>);

    <span class="hljs-comment">// 注册标准输入的读事件</span>
    <span class="hljs-keyword">if</span> (aeCreateFileEvent(eventLoop, STDIN_FILENO, AE_READABLE, fileEventProc, <span class="hljs-literal">NULL</span>) == AE_ERR) {
        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Could not create file event.\n"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }

    <span class="hljs-comment">// 进入事件循环</span>
    aeMain(eventLoop);

    aeDeleteEventLoop(eventLoop);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-10">总结</h3>
<p>Redis的事件循环模型是其高性能和高并发处理能力的关键。通过基于reactor模式的单线程事件驱动模型，Redis能够高效地处理网络事件和文件事件。上述代码展示了事件循环的主要流程，包括创建事件循环、注册事件、处理事件等。</p>
<p>这种模型在处理大量并发连接时具有较高的效率，同时也简化了编程模型，使得开发和维护更加容易。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis（135）Redis的网络模型是什么？]]></title>    <link>https://juejin.cn/post/7574318108719333422</link>    <guid>https://juejin.cn/post/7574318108719333422</guid>    <pubDate>2025-11-19T23:01:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574318108719333422" data-draft-id="7574322843048558642" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis（135）Redis的网络模型是什么？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-19T23:01:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis（135）Redis的网络模型是什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T23:01:02.000Z" title="Wed Nov 19 2025 23:01:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Redis的网络模型是基于单线程的事件驱动机制实现的，使用了 Reactor 模式。它主要通过一个事件循环来处理网络I/O和文件I/O。Redis的高性能很大程度上依赖于这个轻量级的网络模型，该模型允许它在单线程中高效地处理大量并发连接。</p>
<h3 data-id="heading-0">核心数据结构和组件</h3>
<h4 data-id="heading-1">1. 事件循环（Event Loop）</h4>
<p>Redis使用<code>aeEventLoop</code>结构体来管理事件循环。事件循环本质上是一个无限循环，它处理所有注册的事件（文件事件和时间事件）。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">aeEventLoop</span> {</span>
    <span class="hljs-type">int</span> maxfd;   <span class="hljs-comment">/* highest file descriptor currently registered */</span>
    <span class="hljs-type">int</span> setsize; <span class="hljs-comment">/* max number of file descriptors tracked */</span>
    <span class="hljs-type">long</span> <span class="hljs-type">long</span> timeEventNextId;
    aeFileEvent *events; <span class="hljs-comment">/* Registered events */</span>
    aeFiredEvent *fired; <span class="hljs-comment">/* Fired events */</span>
    aeTimeEvent *timeEventHead;
    <span class="hljs-type">int</span> stop;
    <span class="hljs-type">void</span> *apidata; <span class="hljs-comment">/* This is used for polling API specific data */</span>
    aeBeforeSleepProc *beforesleep;
    aeBeforeSleepProc *aftersleep;
} aeEventLoop;
</code></pre>
<h4 data-id="heading-2">2. 文件事件（File Event）</h4>
<p>文件事件表示对文件描述符的读写操作。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">aeFileEvent</span> {</span>
    <span class="hljs-type">int</span> mask; <span class="hljs-comment">/* one of AE_(READABLE|WRITABLE) */</span>
    aeFileProc *rfileProc;
    aeFileProc *wfileProc;
    <span class="hljs-type">void</span> *clientData;
} aeFileEvent;
</code></pre>
<h4 data-id="heading-3">3. 时间事件（Time Event）</h4>
<p>时间事件用于处理定时任务。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">aeTimeEvent</span> {</span>
    <span class="hljs-type">long</span> <span class="hljs-type">long</span> id; <span class="hljs-comment">/* time event identifier. */</span>
    <span class="hljs-type">long</span> when_sec; <span class="hljs-comment">/* seconds */</span>
    <span class="hljs-type">long</span> when_ms; <span class="hljs-comment">/* milliseconds */</span>
    aeTimeProc *timeProc;
    aeEventFinalizerProc *finalizerProc;
    <span class="hljs-type">void</span> *clientData;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">aeTimeEvent</span> *<span class="hljs-title">next</span>;</span>
} aeTimeEvent;
</code></pre>
<h3 data-id="heading-4">核心函数和流程</h3>
<h4 data-id="heading-5">1. 创建和初始化事件循环</h4>
<pre><code class="hljs language-c" lang="c">aeEventLoop *<span class="hljs-title function_">aeCreateEventLoop</span><span class="hljs-params">(<span class="hljs-type">int</span> setsize)</span> {
    aeEventLoop *eventLoop;
    <span class="hljs-type">int</span> i;

    <span class="hljs-keyword">if</span> ((eventLoop = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(*eventLoop))) == <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">goto</span> err;
    eventLoop-&gt;events = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(aeFileEvent) * setsize);
    eventLoop-&gt;fired = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(aeFiredEvent) * setsize);
    <span class="hljs-keyword">if</span> (eventLoop-&gt;events == <span class="hljs-literal">NULL</span> || eventLoop-&gt;fired == <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">goto</span> err;
    eventLoop-&gt;setsize = setsize;
    eventLoop-&gt;timeEventHead = <span class="hljs-literal">NULL</span>;
    eventLoop-&gt;timeEventNextId = <span class="hljs-number">0</span>;
    eventLoop-&gt;stop = <span class="hljs-number">0</span>;
    eventLoop-&gt;maxfd = <span class="hljs-number">-1</span>;
    eventLoop-&gt;beforesleep = <span class="hljs-literal">NULL</span>;
    eventLoop-&gt;aftersleep = <span class="hljs-literal">NULL</span>;

    <span class="hljs-keyword">if</span> (aeApiCreate(eventLoop) == <span class="hljs-number">-1</span>) <span class="hljs-keyword">goto</span> err;

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; setsize; i++)
        eventLoop-&gt;events[i].mask = AE_NONE;
    <span class="hljs-keyword">return</span> eventLoop;

err:
    <span class="hljs-keyword">if</span> (eventLoop) {
        <span class="hljs-built_in">free</span>(eventLoop-&gt;events);
        <span class="hljs-built_in">free</span>(eventLoop-&gt;fired);
        <span class="hljs-built_in">free</span>(eventLoop);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
}
</code></pre>
<h4 data-id="heading-6">2. 注册文件事件</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> <span class="hljs-title function_">aeCreateFileEvent</span><span class="hljs-params">(aeEventLoop *eventLoop, <span class="hljs-type">int</span> fd, <span class="hljs-type">int</span> mask,
                      aeFileProc *proc, <span class="hljs-type">void</span> *clientData)</span> {
    <span class="hljs-keyword">if</span> (fd &gt;= eventLoop-&gt;setsize) <span class="hljs-keyword">return</span> AE_ERR;
    aeFileEvent *fe = &amp;eventLoop-&gt;events[fd];

    <span class="hljs-keyword">if</span> (aeApiAddEvent(eventLoop, fd, mask) == <span class="hljs-number">-1</span>)
        <span class="hljs-keyword">return</span> AE_ERR;
    fe-&gt;mask |= mask;
    <span class="hljs-keyword">if</span> (mask &amp; AE_READABLE) fe-&gt;rfileProc = proc;
    <span class="hljs-keyword">if</span> (mask &amp; AE_WRITABLE) fe-&gt;wfileProc = proc;
    fe-&gt;clientData = clientData;
    <span class="hljs-keyword">if</span> (fd &gt; eventLoop-&gt;maxfd)
        eventLoop-&gt;maxfd = fd;
    <span class="hljs-keyword">return</span> AE_OK;
}
</code></pre>
<h4 data-id="heading-7">3. 事件循环处理函数</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">aeMain</span><span class="hljs-params">(aeEventLoop *eventLoop)</span> {
    eventLoop-&gt;stop = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">while</span> (!eventLoop-&gt;stop) {
        <span class="hljs-keyword">if</span> (eventLoop-&gt;beforesleep != <span class="hljs-literal">NULL</span>)
            eventLoop-&gt;beforesleep(eventLoop);
        aeProcessEvents(eventLoop, AE_ALL_EVENTS);
        <span class="hljs-keyword">if</span> (eventLoop-&gt;aftersleep != <span class="hljs-literal">NULL</span>)
            eventLoop-&gt;aftersleep(eventLoop);
    }
}

<span class="hljs-type">int</span> <span class="hljs-title function_">aeProcessEvents</span><span class="hljs-params">(aeEventLoop *eventLoop, <span class="hljs-type">int</span> flags)</span> {
    <span class="hljs-type">int</span> processed = <span class="hljs-number">0</span>, numevents;

    <span class="hljs-keyword">if</span> (!(flags &amp; AE_TIME_EVENTS)) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    processed += processTimeEvents(eventLoop);

    <span class="hljs-keyword">if</span> (flags &amp; AE_FILE_EVENTS) {
        numevents = aeApiPoll(eventLoop, &amp;tvp);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; numevents; j++) {
            aeFileEvent *fe = &amp;eventLoop-&gt;events[eventLoop-&gt;fired[j].fd];
            <span class="hljs-type">int</span> mask = eventLoop-&gt;fired[j].mask;
            <span class="hljs-type">int</span> fd = eventLoop-&gt;fired[j].fd;
            <span class="hljs-type">int</span> rfired = <span class="hljs-number">0</span>;

            <span class="hljs-keyword">if</span> (fe-&gt;mask &amp; mask &amp; AE_READABLE) {
                rfired = <span class="hljs-number">1</span>;
                fe-&gt;rfileProc(eventLoop, fd, fe-&gt;clientData, mask);
            }

            <span class="hljs-keyword">if</span> (fe-&gt;mask &amp; mask &amp; AE_WRITABLE) {
                <span class="hljs-keyword">if</span> (!rfired || fe-&gt;wfileProc != fe-&gt;rfileProc)
                    fe-&gt;wfileProc(eventLoop, fd, fe-&gt;clientData, mask);
            }

            processed++;
        }
    }

    <span class="hljs-keyword">return</span> processed;
}
</code></pre>
<h4 data-id="heading-8">4. 处理时间事件</h4>
<p>时间事件主要用于定时任务，通过检查当前时间和事件触发时间来决定是否执行：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">processTimeEvents</span><span class="hljs-params">(aeEventLoop *eventLoop)</span> {
    <span class="hljs-type">int</span> processed = <span class="hljs-number">0</span>;
    aeTimeEvent *te;
    <span class="hljs-type">long</span> <span class="hljs-type">long</span> maxId;
    <span class="hljs-type">time_t</span> now = time(<span class="hljs-literal">NULL</span>);

    te = eventLoop-&gt;timeEventHead;

    <span class="hljs-keyword">while</span> (te) {
        <span class="hljs-type">long</span> now_sec, now_ms;
        <span class="hljs-type">long</span> <span class="hljs-type">long</span> id;

        aeGetTime(&amp;now_sec, &amp;now_ms);

        <span class="hljs-keyword">if</span> (te-&gt;when_sec &gt; now_sec || (te-&gt;when_sec == now_sec &amp;&amp; te-&gt;when_ms &gt; now_ms)) {
            te = te-&gt;next;
            <span class="hljs-keyword">continue</span>;
        }

        id = te-&gt;id;
        <span class="hljs-type">int</span> retval = te-&gt;timeProc(eventLoop, id, te-&gt;clientData);
        processed++;

        <span class="hljs-keyword">if</span> (retval != AE_NOMORE) {
            te-&gt;when_sec = now_sec + retval / <span class="hljs-number">1000</span>;
            te-&gt;when_ms = now_ms + retval % <span class="hljs-number">1000</span>;
            <span class="hljs-keyword">if</span> (te-&gt;when_ms &gt;= <span class="hljs-number">1000</span>) {
                te-&gt;when_sec++;
                te-&gt;when_ms -= <span class="hljs-number">1000</span>;
            }
        } <span class="hljs-keyword">else</span> {
            aeDeleteTimeEvent(eventLoop, id);
        }

        te = eventLoop-&gt;timeEventHead;
    }

    <span class="hljs-keyword">return</span> processed;
}
</code></pre>
<h3 data-id="heading-9">示例使用</h3>
<p>以下是一个简单的示例，展示了如何使用Redis的网络模型处理文件事件：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ae.h"</span></span>

<span class="hljs-type">void</span> <span class="hljs-title function_">fileEventProc</span><span class="hljs-params">(aeEventLoop *eventLoop, <span class="hljs-type">int</span> fd, <span class="hljs-type">void</span> *clientData, <span class="hljs-type">int</span> mask)</span> {
    <span class="hljs-type">char</span> buf[<span class="hljs-number">128</span>];
    <span class="hljs-type">int</span> n = read(fd, buf, <span class="hljs-keyword">sizeof</span>(buf));
    <span class="hljs-keyword">if</span> (n &gt; <span class="hljs-number">0</span>) {
        buf[n] = <span class="hljs-string">'\0'</span>;
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Read from fd %d: %s\n"</span>, fd, buf);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (n == <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"EOF on fd %d\n"</span>, fd);
        aeDeleteFileEvent(eventLoop, fd, AE_READABLE);
        close(fd);
    } <span class="hljs-keyword">else</span> {
        perror(<span class="hljs-string">"read"</span>);
    }
}

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span> {
    aeEventLoop *eventLoop = aeCreateEventLoop(<span class="hljs-number">1024</span>);

    <span class="hljs-keyword">if</span> (aeCreateFileEvent(eventLoop, STDIN_FILENO, AE_READABLE, fileEventProc, <span class="hljs-literal">NULL</span>) == AE_ERR) {
        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Could not create file event.\n"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }

    aeMain(eventLoop);

    aeDeleteEventLoop(eventLoop);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-10">总结</h3>
<p>Redis的网络模型是基于单线程事件驱动机制的，使用 Reactor 模式进行事件处理。这种模型允许 Redis 在单线程环境下高效地处理大量并发连接，通过注册、处理文件事件和时间事件实现高效的 I/O 操作。这种设计不仅简化了编程模型，还显著提升了系统的性能和可维护性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2 种方法！用 n8n 自动发公众号]]></title>    <link>https://juejin.cn/post/7574308545525678095</link>    <guid>https://juejin.cn/post/7574308545525678095</guid>    <pubDate>2025-11-19T16:02:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574308545525678095" data-draft-id="7574276404596588596" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2 种方法！用 n8n 自动发公众号"/> <meta itemprop="keywords" content="工作流引擎"/> <meta itemprop="datePublished" content="2025-11-19T16:02:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="麦麦麦造"/> <meta itemprop="url" content="https://juejin.cn/user/1732486056126311"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2 种方法！用 n8n 自动发公众号
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1732486056126311/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    麦麦麦造
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T16:02:40.000Z" title="Wed Nov 19 2025 16:02:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是 <strong>MAI麦造</strong></p>
<p>前段时间有朋友找我咨询 ==n8n 中如何自动发公众号的问题==，刚好发现了一些新手可能会遇到的坑，所以这里分享一下！</p>
<blockquote>
<p>[!Note]
<strong>我用了两种方法来实现，分别是：</strong></p>
<ul>
<li>自己手动配置 http 节点，实现公众号接口。</li>
<li>使用社区节点</li>
</ul>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9db97006db4b4e3c95fafb91edcfad6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764172960&amp;x-signature=HRIS3Kzg%2FK2Wa6ptBw9T1B256yo%3D" alt="PixPin_2025-11-19_23-26-02.png" loading="lazy"/></p>
<p>各有自己适合的场景，所以根据自己的需求来选择即可。</p>
<blockquote>
<p>不过都需要用到公众号的官方接口，所以先需要在公众号后台进行一下配置！</p>
</blockquote>
<h2 data-id="heading-0">公众号后台配置</h2>
<h3 data-id="heading-1">1. 获取 开发者 ID 和 开发者密码</h3>
<p>通过<strong>设置与开发——开发接口管理——账号开发信息</strong>获取。</p>
<p>第一次可能需要申请一下。 不过基本都能过。</p>
<blockquote>
<p>[!note]
<strong>开发者密码(AppSecret)</strong> 是敏感信息，后台只会显示一次，请妥善保存，如果遗忘只能重置！</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd4d270c12064f05915e675230c7a456~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764172960&amp;x-signature=CdcyFs8EY%2F8h3AIT9vsZKdh%2BcyI%3D" alt="PixPin_2025-11-18_17-15-31.png" loading="lazy"/></p>
<h3 data-id="heading-2">2. 配置白名单</h3>
<p>由于公众号的安全限制，限制必须在白名单内的 IP 才能访问。</p>
<p>所以需要把你的 IP 添加进来。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b4a844187f147e48b4996fc6abf54fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764172960&amp;x-signature=%2BxJEEOl69IROUXQMBwDMGECTCI0%3D" alt="PixPin_2025-11-19_21-24-46.png" loading="lazy"/></p>
<p>这里需要注意一下，
建议这一步都在 n8n 中配置一个 http 节点来看你的请求 IP！</p>
<blockquote>
<p>这个方法也适合你的 n8n 通过其他方式部署，你不知道 IP 的情况。</p>
</blockquote>
<p>很多人在最后一步上传草稿的时候，出现上传不成功的问题，原因就是白名单配置不正确。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f08487c3539b4ee7ae9ffd524cd88bfc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764172960&amp;x-signature=%2Bqi%2BN2CimAvA6GfOVI9pc4wQTsc%3D" alt="PixPin_2025-11-18_17-17-44.png" loading="lazy"/></p>
<p>n8n 中配置一个网络请求节点，使用<code>GET</code>方法，URL是：<code>http://httpbin.org/ip</code></p>
<p>这样可以确保你的 n8n 的出口 IP 不会出错！</p>
<h2 data-id="heading-3">方法 1：手动配置节点</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9db75b4a5c54b52b719596be4b0a417~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764172960&amp;x-signature=lBxn8pF52rwfinKbfPcLuWdBXEk%3D" alt="PixPin_2025-11-19_21-35-18.png" loading="lazy"/></p>
<p>这个方法相对来讲复杂一些，配置的节点比较多，</p>
<p>比较适合你的 n8n 没法安装社区节点的场景。</p>
<p>这里实际需要调到公众号的 3 个接口，分别是：</p>
<ul>
<li>获取 token</li>
<li>上传封面素材</li>
<li>上传到草稿箱</li>
</ul>
<p>这里我设置了一个 mock 数据的节点，来模拟一下真实的场景。
里面总共是 3 个字段：<code>content</code>、<code>title</code>、<code>author</code></p>
<p>大家根据自己的实际情况调整。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d71b467b57ea48a585ade91e0918c12a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764172960&amp;x-signature=vu4cXmBeQZrVmBxAXrwURF4qduM%3D" alt="PixPin_2025-11-19_21-38-54.png" loading="lazy"/></p>
<p>token 是微信用来鉴权的，有过期时间，所以每次运行都要调用一次。</p>
<p>接口主要就 3 个参数：</p>
<ul>
<li><code>grant_type</code> ：值是固定的 <code>client_credential</code></li>
<li><code>appid</code> 和 <code>secret</code> ：是刚刚获取到的 <code>开发者 ID</code> 和 <code>开发者密码</code></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73e88ac81c6448e48502f8e277b6782b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764172960&amp;x-signature=TCaNycZgLjKnd54YOfj%2B%2FDURjOc%3D" alt="PixPin_2025-11-19_21-44-15.png" loading="lazy"/></p>
<p>接下来是上传封面：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03340c2df1c4402f830777fc9721572c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764172960&amp;x-signature=H2F0A4jefrpj8%2BupNiAU%2FhK2pQw%3D" alt="PixPin_2025-11-19_21-56-34.png" loading="lazy"/></p>
<p>这里总共用了 3 个节点，分别是：</p>
<ul>
<li>下载封面图。 也可以从本地路径读取</li>
<li>上传图片</li>
<li>解析上传结果，拿到 <code>media_id</code></li>
</ul>
<p>在下载封面图这里需要注意一下，因为下载完之后是一个文件,
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c96cbeca82394580ab18cbb1fdc82609~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764172960&amp;x-signature=CQ3Itj%2FZ4eaZOMTbtAWkCCoIIaU%3D" alt="PixPin_2025-11-19_22-03-27.png" loading="lazy"/></p>
<p>所以在后面一个<code>上传图片</code>的节点中，
需要选择 <code>n8n binary file</code>，
在 <code>Input Data Field Name</code> 中只需要填 <code>data</code> 即可！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3dfa36797944944aee411884cfa1a6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764172960&amp;x-signature=UaqXrykWKNykHNqzmw7Epet0Bx4%3D" alt="" loading="lazy"/></p>
<p>这个参数跟其他节点的拖拽方式不同，只能手动输入，且没有提示！</p>
<p>如果不知道这个的话，可能会花比较多的时间来调试。<br/>
<em>(本人石锤😭)</em></p>
<p>大家也可以直接使用我的模板，没这个烦恼哈哈～</p>
<p>接下来就是解析结果，拿到响应中的 <code>media_id</code>:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6290243e6674e2b963524f3d9f69d3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764172960&amp;x-signature=4TlsUyu%2BQ%2FLQ7h2JUaLRql9xvGY%3D" alt="PixPin_2025-11-19_22-10-29.png" loading="lazy"/></p>
<p>因为接口返回的是一个JSON格式的字符串，所以需要解码一下才可以拿到里面的值。</p>
<blockquote>
<p>[!TIPS]
这里有一个小技巧，可以使用了一个 Set 节点，在当中使用 JS 的表达式来做解析。<br/>
就不用配置 Code 节点了，简单又快速！</p>
</blockquote>
<p>然后就到最后一步，上传草稿了！</p>
<p>这个节点的核心就是上传的内容:
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/557ae25ab954456ea9cb843cecb1849e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764172960&amp;x-signature=y7gr6lhkDLx08BRmmdYsriInrSg%3D" alt="PixPin_2025-11-19_22-21-10.png" loading="lazy"/></p>
<p>基本格式如下:</p>
<pre><code class="hljs language-bash" lang="bash">{
   <span class="hljs-string">"articles"</span>: [
      {
         <span class="hljs-string">"title"</span>: <span class="hljs-string">"{{ <span class="hljs-subst">$('mock 数据')</span>.item.json.title }}"</span>,
         <span class="hljs-string">"author"</span>: <span class="hljs-string">"{{ <span class="hljs-subst">$('mock 数据')</span>.item.json.author }}"</span>,
         <span class="hljs-string">"content"</span>: <span class="hljs-string">"{{ <span class="hljs-subst">$('mock 数据')</span>.item.json.content }}"</span>,
         <span class="hljs-string">"thumb_media_id"</span>: <span class="hljs-string">"{{ <span class="hljs-variable">$json</span>.media_id }}"</span>,
         <span class="hljs-string">"need_open_comment"</span>:1,
         <span class="hljs-string">"only_fans_can_comment"</span>:0
      }
   ]
}
</code></pre>
<p>这里还支持更多的字段地址，具体字段看官方文档：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/448734780efa4ed6bddee4e79541b571~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764172960&amp;x-signature=h8gDy0SDjTUkJKnzQyyUYWg8XBo%3D" alt="PixPin_2025-11-19_22-23-28.png" loading="lazy"/></p>
<p>如果前面的一切都没有问题，那么节点这个运行完之后，响应结果应该大致如下：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94b3380c488e49f2b1b6289f9f2d94bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764172960&amp;x-signature=2%2FUKXr40gPk1xtbS49L1q2tO94Y%3D" alt="PixPin_2025-11-19_22-25-28.png" loading="lazy"/></p>
<p>这时候在你公众号的草稿箱中就可以看到了！
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60efbcc5be04450ca19d2d9628ac249b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764172960&amp;x-signature=K78pwLTfhFF9%2BzegZuEhfrJhmh4%3D" alt="PixPin_2025-11-19_22-26-55.png" loading="lazy"/></p>
<h2 data-id="heading-4">方法 2：使用社区节点</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/102818d63b62432b8adf5c2ae97a1aa6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764172960&amp;x-signature=xhXHY9ZQgvX%2FbctrwA3gJn%2Bl0cw%3D" alt="PixPin_2025-11-19_22-28-19.png" loading="lazy"/></p>
<p>这个节点包封装好了一系列的微信接口，包括我们要用到的 3 个接口，所以整个流程非常简单，只需要配置 4 个节点即可。</p>
<p>首先是安装它：
进到 <code>Settings</code>-&gt; <code>Community nodes</code>中，</p>
<p>输入 <strong>n8n-nodes-wechat-offiaccount</strong> 来进行安装</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6513f2dae67d4748ac4882360942ea29~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764172960&amp;x-signature=AqWa0svIZnMT7bP6i3KWZQLf5qU%3D" alt="PixPin_2025-11-19_22-32-27.png" loading="lazy"/></p>
<p>然后在面板的添加节点中搜索 <code>wechat</code> ，选择第一个：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ddcbecc887304b249ffae63fb9ee0b44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764172960&amp;x-signature=KX%2BC8u9DQBQC0uS06obUrug8M3Y%3D" alt="PixPin_2025-11-19_22-34-33.png" loading="lazy"/></p>
<p>滑动到最底下，选择 <code>授权 获取Access Token</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c77848b640af4f03a7da587744fbfafb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764172960&amp;x-signature=zLKDwD%2B8lhs9yI0UTD4juH5jge0%3D" alt="PixPin_2025-11-19_22-35-29.png" loading="lazy"/></p>
<p>这个节点中先需要配置 <code>AppID</code> 和 <code>AppSecret</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f13fc478b3404e2291f460d9cba21e6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764172960&amp;x-signature=cgazd1DNC9hBbNSRF8WpSlL05YA%3D" alt="PixPin_2025-11-19_22-36-41.png" loading="lazy"/></p>
<p>然后是下载封面图和上传素材：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91473c15215448ba86ec331ad118ca9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764172960&amp;x-signature=XuvZG%2BeM6tegOUaotbTy4jpBCQg%3D" alt="PixPin_2025-11-19_22-40-03.png" loading="lazy"/></p>
<p>下载封面图的节点和上面一样，不重复了</p>
<p>上传素材节点 选择<code>素材</code>选项下的第一个：上传永久素材</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08a174a9dc454ad8a15e0fca071bbbe8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764172960&amp;x-signature=zXlalxzvBXe5YNS8CSIRaxI%2F0rU%3D" alt="PixPin_2025-11-19_22-42-58.png" loading="lazy"/></p>
<p>这里不用改动什么，请求参数都封装好了</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f45a9f8e184e4aa093591d827866e83a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764172960&amp;x-signature=Z%2Bfrucc7dKEfE30bOzTLLnKYwQ4%3D" alt="PixPin_2025-11-19_22-44-05.png" loading="lazy"/></p>
<p>最后添加上传草稿的节点，</p>
<p>选择 <code>草稿</code> 中的 <code>新建草稿</code>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86116e284ded4d49a6a74fefc48f3b2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764172960&amp;x-signature=j%2B7PMBFKgd5oInN5b%2BFKYKl7xlw%3D" alt="PixPin_2025-11-19_22-46-22.png" loading="lazy"/></p>
<p>里面也做了很多的封装，只需要传入文章内容即可：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b47a6314c032463687214556d1f6a8e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764172960&amp;x-signature=asuak%2FLTXUUtwzY6SCqmTwbf5fo%3D" alt="PixPin_2025-11-19_22-56-40.png" loading="lazy"/></p>
<p>不过文章参数与刚刚的稍有不同，格式如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
         <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"这是我的文章标题2"</span><span class="hljs-punctuation">,</span>
         <span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"你的作者名"</span><span class="hljs-punctuation">,</span>
         <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&lt;h1&gt;这是一个大标题&lt;/h1&gt;&lt;p&gt;这里是文章的正文部分，&lt;b&gt;支持 HTML 格式&lt;/b&gt;。你可以从其他节点动态传入这段内容。&lt;/p&gt;&lt;img src='https://mmbiz.qpic.cn/mmbiz_jpg/your_image_url/0?wx_fmt=jpeg' /&gt;"</span><span class="hljs-punctuation">,</span>
         <span class="hljs-attr">"thumb_media_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"kjIYa7yRqi3jD3XlC9XxnShDNVceXTE_iRf55uv19iEOuBgfKKKvrQ3rd3pg17Kj"</span><span class="hljs-punctuation">,</span>
         <span class="hljs-attr">"need_open_comment"</span><span class="hljs-punctuation">:</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
         <span class="hljs-attr">"only_fans_can_comment"</span><span class="hljs-punctuation">:</span><span class="hljs-number">0</span>
      <span class="hljs-punctuation">}</span>
   <span class="hljs-punctuation">]</span>

</code></pre>
<p>运行成功后，结果跟刚刚是一致的
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/637750fed137484cb34df1eb70655ff9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764172960&amp;x-signature=oI49psuFJ%2FSuN3N%2BnbZMdY4Zq8M%3D" alt="PixPin_2025-11-19_22-59-08.png" loading="lazy"/></p>
<h2 data-id="heading-5">最后</h2>
<p>两种方法各种有优缺点，大家根据自己的场景来选择。</p>
<p>有空可以跟着教程自己动手实践一下。</p>
<p>或者公众号后台回复【n8n公众号】获取完整工作流 json 文件，直接接入到自己的工作流中！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Gemini 3 Pro 来了！一句话生成完整网站，AI编程能力断层领先]]></title>    <link>https://juejin.cn/post/7574308545525694479</link>    <guid>https://juejin.cn/post/7574308545525694479</guid>    <pubDate>2025-11-19T16:27:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574308545525694479" data-draft-id="7574250031249326114" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Gemini 3 Pro 来了！一句话生成完整网站，AI编程能力断层领先"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-19T16:27:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wwwzhouhui"/> <meta itemprop="url" content="https://juejin.cn/user/3428746411400537"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Gemini 3 Pro 来了！一句话生成完整网站，AI编程能力断层领先
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3428746411400537/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wwwzhouhui
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T16:27:34.000Z" title="Wed Nov 19 2025 16:27:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在AI大模型快速迭代的今天，各家厂商疯狂堆参数、拼算力，动不动就是参数翻倍，但日常用起来的感觉却大同小异。就在大家对"GPT-4.5级"、"性能提升30%"这些宣传话术感到麻木的时候，Google在2025年11月18日悄悄扔出了一个重磅炸弹——Gemini 3.0。</p>
<p>Gemini 3 Pro 是 Google DeepMind 推出的新一代旗舰模型，被官方定义为"世界上多模态理解能力最强的模型"。它不是简单的微调升级，而是从零开始在自家TPU芯片上训练的全新模型，采用稀疏混合专家架构（MoE），万亿级参数但每次查询只激活150-200亿参数。最关键的是，它引入了"Deep Think"深度思维模式，让AI学会了真正的"慢思考"。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b62b181b88f7475a8f93d5dcd0b74f58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764174454&amp;x-signature=9T2xcG0ICP1bGRjufccTdUsfRPQ%3D" alt="image-20251119235934986" loading="lazy"/></p>
<p>这2天 Gemini 3 Pro 在AI圈简直火爆了，LMArena直接干到1501分霸榜第一。今天我们就来手把手带大家体验一下这个号称"史上最强前端开发模型"的真实能力，看看它到底有多离谱。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcaa6a6b68ad4aa48a2099a1d33a7ccd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764174454&amp;x-signature=3MNGNCrhx5yNuBIq7%2BwosxFdDSE%3D" alt="image-20251119233133775" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-1">项目介绍</h2>
<h3 data-id="heading-2">✨ 核心特性</h3>
<ul>
<li><strong>🚀 原生多模态</strong>: 从训练之初就用图像、视频、音频和文本混合训练，跨模态推理能力前所未有</li>
<li><strong>🧠 Deep Think模式</strong>: 引入System 2深度思维，复杂问题会先内部多步推理再输出</li>
<li><strong>💻 Vibe Coding</strong>: 氛围编程能力，一句话就能生成完整可交互的网页应用</li>
<li><strong>👁️ 屏幕理解</strong>: ScreenSpot-Pro得分72.7%，碾压GPT-5.1的3.5%，真正能"看懂"UI</li>
<li><strong>📊 超长上下文</strong>: 100万Token上下文窗口，64K Token最大输出</li>
<li><strong>🎯 低幻觉率</strong>: 幻觉率约6.3%，对比GPT-4o的15.8%大幅降低</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a296a8316054ca1809e6eadc9868733~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764174454&amp;x-signature=SkAzQdt7QP2VwcFG2dKH9NMq11I%3D" alt="image-20251119233829993" loading="lazy"/></p>
<h3 data-id="heading-3">🏆 基准测试表现</h3>















































<table><thead><tr><th>测试项目</th><th>Gemini 3 Pro</th><th>GPT-5.1</th><th>差距</th></tr></thead><tbody><tr><td>Humanity's Last Exam</td><td><strong>37.5%</strong></td><td>26.5%</td><td>+11%</td></tr><tr><td>ARC-AGI-2 (视觉推理)</td><td><strong>31.1%</strong></td><td>17.6%</td><td>+13.5%</td></tr><tr><td>ScreenSpot-Pro (UI理解)</td><td><strong>72.7%</strong></td><td>3.5%</td><td>+69.2%</td></tr><tr><td>Video-MMMU (视频理解)</td><td><strong>87.6%</strong></td><td>80.4%</td><td>+7.2%</td></tr><tr><td>AIME 2025 (数学)</td><td><strong>95.0%</strong></td><td>94.0%</td><td>+1%</td></tr><tr><td>LiveCodeBench (编程)</td><td><strong>2439 Elo</strong></td><td>2243 Elo</td><td>+196</td></tr></tbody></table>
<p>好家伙，这个ScreenSpot-Pro的差距简直是降维打击，GPT-5.1几乎是"屏幕盲"，而Gemini 3能精准理解各种软件界面，这才是构建GUI自动化代理的核心能力。</p>
<h3 data-id="heading-4">🛠️ 技术架构</h3>
<p><strong>模型架构</strong></p>
<ul>
<li><strong>类型</strong>: 稀疏混合专家 (Sparse MoE)</li>
<li><strong>参数</strong>: 万亿级总参数，每次激活150-200亿</li>
<li><strong>训练</strong>: 自家TPU芯片从零训练</li>
</ul>
<p><strong>推理能力</strong></p>
<ul>
<li><strong>Deep Think</strong>: 推理时间计算扩展，多路径探索+自我验证</li>
<li><strong>System 2</strong>: 慢思考模式，先规划再执行</li>
</ul>
<hr/>
<h2 data-id="heading-5">功能演示</h2>
<p>话不多说，我们直接上实战案例，让大家感受一下Gemini 3 Pro到底有多强。</p>
<h3 data-id="heading-6">案例一：一键复刻数据仪表盘</h3>
<p>这是Gemini 3 Pro最让人震撼的能力之一——截图复刻。你只需要给它一张网页截图，加上简单的描述，它就能给你生成一个完整可交互的网页。</p>
<p><strong>提示词：</strong></p>
<pre><code class="hljs">复刻截图中的网页
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af392e91d2b1467bbb36da9e34b2c099~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764174454&amp;x-signature=Li5VXOy5oDjPTEmSYEVpqgBYs0I%3D" alt="微信图片_20251119003732_642_296" loading="lazy"/></p>
<p>是不是非常简单？就这么一句话，Gemini 3 Pro直接生成了一个完整的Product Performance Dashboard，包括：</p>
<ul>
<li>深色主题的仪表盘界面</li>
<li>产品洞察卡片和数据可视化</li>
<li>Freeform表格和趋势图表</li>
<li>完整的交互效果</li>
</ul>
<p>这个设计最大的特点是深邃的背景、橙色的强调色以及精细的数据可视化图表。传统的做法需要设计师画图、前端开发切图写代码，现在一句话就搞定了。</p>
<h3 data-id="heading-7">案例二：Chrome应用商店复刻</h3>
<p>再来看一个更复杂的案例——复刻Chrome应用商店。</p>
<p><strong>提示词：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">这是一个使用 React 和 Tailwind CSS 构建的 Chrome 应用商店 (Chrome Web Store) 的复刻版本。
它包含了以下核心功能和视觉元素：
<span class="hljs-bullet">1.</span> 响应式布局
<span class="hljs-bullet">2.</span> 卡片式设计
<span class="hljs-bullet">3.</span> 交互功能：搜索过滤、分类切换、悬停效果
<span class="hljs-bullet">4.</span> Mock 数据
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f27afa760a6948b2b2f85cce8c63b3f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764174454&amp;x-signature=V4R3i7XLfGb%2Bp1YC5XzsU6k1R%2Bk%3D" alt="微信图片_20251119135921_656_296" loading="lazy"/></p>
<p>看看这个效果！左侧导航栏、顶部搜索栏、主要内容区域，还有各种扩展程序的卡片，甚至连评分、用户数量这些细节都有。点击左侧导航的"扩展程序"或"主题背景"可以切换视图，搜索框也是可以实时过滤的。</p>
<h3 data-id="heading-8">案例三：SVG动画生成</h3>
<p>这个能力Gemini 3 Pro简直是断档第一，来看看这些案例：</p>
<p><strong>八缸发动机动画：</strong></p>
<pre><code class="hljs">帮我用SVG绘制一个八缸发动机的物理结构动画
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9dc9830fea4641999a4098f746148d92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764174454&amp;x-signature=MYmbn5M0tH22VVfy%2FCj6rB2YPMM%3D" alt="20251119" loading="lazy"/></p>
<p>还有经典的电风扇、咖啡机工作原理、内燃机结构，全都能做出来。</p>
<h3 data-id="heading-9">案例四：3D场景与游戏</h3>
<p><strong>3D魔方模拟：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">创建一个<span class="hljs-number">3</span>D魔方模拟，包含<span class="hljs-string">"打乱"</span>和<span class="hljs-string">"解决"</span>按钮，两个按钮都会播放流畅的动画
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f13925ad78214b6aad2266d8d19c34e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764174454&amp;x-signature=2FJd71oH5AHDkBDA75KXziHfNXE%3D" alt="20251119-2" loading="lazy"/></p>
<p><strong>3D山脉场景：</strong></p>
<pre><code class="hljs language-css" lang="css">创建一个 <span class="hljs-number">3</span>D <span class="hljs-selector-tag">HTML</span> 山脉场景，包含悬崖、河流和昼夜光照变化。支持拖动和缩放、动画过渡、真实感渐变色，并可切换等高线显示
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbce47d09da14bb89f7e822d6271edf0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764174454&amp;x-signature=sKR4mMwNMpVK0u0yOjMbf30HXYg%3D" alt="20251119-3" loading="lazy"/></p>
<h3 data-id="heading-10">案例五：Neobrutalist创意网页</h3>
<p>来看看Gemini 3 Pro的"氛围编程"能力：</p>
<p><strong>提示词：</strong></p>
<pre><code class="hljs language-csharp" lang="csharp">Make a neobrutalist webpage, make it extremely creative, <span class="hljs-keyword">as</span> far <span class="hljs-keyword">as</span> possible, push the limits
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/409e8a7582b44269bd6778c953970ca4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764174454&amp;x-signature=jfUNt%2FNDEAUbGd3rI%2Bc6%2B5BCIyw%3D" alt="image-20251119235726222" loading="lazy"/></p>
<p>总生成时间大概89秒，结果出来直接让人"卧槽"——不仅可以对话，还可以不断增加贴纸，如果不告诉我这是AI生成的，我会以为是哪个设计师的作品集。</p>
<h3 data-id="heading-11">案例六：Neo-Matrix风格网站</h3>
<p><strong>提示词：</strong></p>
<pre><code class="hljs language-scss" lang="scss">生成一个Neo-Matrix 风格的单页网站。
要求：
- 粗野主义美学与黑客帝国冷峻感极致融合
- 主色调：<span class="hljs-selector-id">#000000</span> (黑), <span class="hljs-selector-id">#00FF41</span> (矩阵绿), <span class="hljs-selector-id">#FF0000</span> (警告红), <span class="hljs-selector-id">#0000FF</span> (程序蓝)
- 核心元素：全屏数字雨背景，巨大且粗糙的命令行界面风格交互区域
- 交互：模拟系统错误或选择分支 (Red Pill/Blue Pill) 的极端用户引导
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd517dc638144b068a8f091e4539b2c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764174454&amp;x-signature=hYrTv3oMaBAzJfFpPsetmWVtv%2FY%3D" alt="20251119-6" loading="lazy"/></p>
<p>包含entry页面，还有经典的红蓝药丸交互功能。选蓝色会被嘲讽，选红色进入Matrix界面，背后还有红色的数字雨，真的是太帅了！</p>
<h3 data-id="heading-12">案例七：三大不可能任务</h3>
<p><strong>中国象棋残局游戏：</strong></p>
<p>之前没有一个AI可以用单一HTML文件做出中国象棋残局游戏，Gemini 3 Pro一次就做出来了，可以玩，有多个关卡，速度还快。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f30d1e836694efdb1b0cb7e50957d94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764174454&amp;x-signature=3wx1A0GWKaV68ss%2FG78YiIOAmAg%3D" alt="image-20251119233628865" loading="lazy"/></p>
<p><strong>AI原生操作系统：</strong></p>
<pre><code class="hljs">制作一个 AI 原生的操作系统，比Windows更美更好用
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6eabfb6894e749b08ea59a6bf2cfcda3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764174454&amp;x-signature=R4PVkznkB8Z1F%2BSEMbgeGQXKmKQ%3D" alt="image-20251119233607595" loading="lazy"/></p>
<p>果然让人眼前一亮——桌面没有任何图片和传统UI交互界面，就只有一个输入框。输入"工作模式"，桌面就变成你每天需要工作的任务、日程、项目文档；输入"娱乐模式"，就变成看剧、玩游戏、聊天的界面。这才是真正的AI原生操作系统，去App化，界面随内容和语境实时变化。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c23090ae55dc4c888b9d857fb633d7ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764174454&amp;x-signature=oe2fsmhjn%2BfFgJ5NaqmN0eU5EHg%3D" alt="image-20251119233640983" loading="lazy"/></p>
<p><strong>文献修复：</strong></p>
<p>识别破损文献的文字内容，并推理出完整内容。先用OCR识别能识别的文字，不能识别的用...，然后使用AI推理补全。这个对考古文献修复等实际工作将会有很大帮助。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7337398e7b2a4a23bd46cecf3d03c710~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764174454&amp;x-signature=mcoIsrCUAQwH0JdjjlJ8SSXoNBY%3D" alt="image-20251119233657915" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/255c46d004c84af4a25145898d1dd9d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764174454&amp;x-signature=sG4LIStmjzRlzTd9%2FwEWNnnF3hM%3D" alt="image-20251119233708962" loading="lazy"/></p>
<h3 data-id="heading-13">视频演示</h3>
<p>下面是一些实际操作的视频演示，可以更直观地感受Gemini 3 Pro的能力：</p>
<p><strong>视频1：功能演示</strong>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/525a793a1ec04b58908bdd3c25141742~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764174454&amp;x-signature=TktQyKq6cto3R1euXN0f%2B49QB9A%3D" alt="微信视频2025-11-19_221112_391" loading="lazy"/></p>
<p><strong>视频2：交互效果</strong>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e1053706e8f4ffcb9e4de560e86a5cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764174454&amp;x-signature=AhGuW%2FWzC0TJgBNRxA2LTkGjDOU%3D" alt="微信视频2025-11-19_221127_163" loading="lazy"/></p>
<p><strong>视频3：生成过程</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52c1f50a380d442e94a98194f0fec0d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764174454&amp;x-signature=dPVu75%2BTXkRuU%2FW7AjVQ8bCDpUs%3D" alt="微信视频_20251119221119" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-14">体验方式</h2>
<p>Gemini 3 Pro的体验方式已经很多了：</p>
<ul>
<li><strong>Gemini App</strong>: 官方应用，部分功能内测中</li>
<li><strong>Google AI Studio</strong>: 推荐使用Build模式，免费体验</li>
<li><strong>Gemini CLI</strong>: 命令行工具</li>
<li><strong>Antigravity</strong>: Google新推出的代理优先IDE</li>
<li><strong>Cursor/flowith</strong>: 第三方集成</li>
</ul>
<h3 data-id="heading-15">API定价</h3>




















<table><thead><tr><th>上下文范围</th><th>输入价格</th><th>输出价格</th></tr></thead><tbody><tr><td>200k以内</td><td>$2.00/百万Token</td><td>$12.00/百万Token</td></tr><tr><td>200k以上</td><td>$4.00/百万Token</td><td>$18.00/百万Token</td></tr></tbody></table>
<p>这个价格在高端模型市场中极具竞争力，而且Google AI Studio目前提供慷慨的免费额度。</p>
<hr/>
<h2 data-id="heading-16">总结</h2>
<p>今天主要带大家了解并体验了Google Gemini 3 Pro的各种惊艳能力，该模型以"原生多模态+Deep Think深度思维"为核心优势，结合Vibe Coding氛围编程理念，通过稀疏混合专家架构与推理时间计算扩展技术，形成了一套从自然语言描述到完整应用生成的全链路AI编程解决方案。通过这套能力，开发者和设计师能够高效突破传统编码门槛——借助简单的提示词描述（包括截图复刻、系统模拟、SVG动画生成），无需编写大量代码，就能快速生成完整可交互的网页应用（如本次演示的数据仪表盘、Chrome商店复刻、Neo-Matrix风格网站）。</p>
<p>无论是前端界面开发、3D场景构建，还是游戏模拟器制作、AI原生操作系统概念验证，都能通过一句话提示词完成，极大提升了开发效率和创意落地速度。在实际应用中，Gemini 3 Pro不仅在ScreenSpot-Pro屏幕理解测试中以72.7%碾压GPT-5.1的3.5%，还在Vending-Bench代理任务中取得了271%的性能优势，适配性远优于传统代码生成方案；特别是通过Deep Think模式的多路径推理和自我验证机制，有效解决了AI幻觉和逻辑陷阱的难题。</p>
<p>同时，方案具备良好的扩展性——小伙伴们可以基于此扩展更多应用场景，如企业数据可视化、教育互动演示、产品原型快速验证等，进一步发挥AI编程能力在前端开发、创意设计、产品原型等领域的应用价值。感兴趣的小伙伴可以通过Google AI Studio的Build模式进行实践，根据实际需求调整提示词描述。今天的分享就到这里结束了，我们下一篇文章见。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[企业如何平衡AI创新与风险]]></title>    <link>https://juejin.cn/post/7574271557939445811</link>    <guid>https://juejin.cn/post/7574271557939445811</guid>    <pubDate>2025-11-19T14:58:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574271557939445811" data-draft-id="7574322843048345650" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="企业如何平衡AI创新与风险"/> <meta itemprop="keywords" content="人工智能,云计算,云原生"/> <meta itemprop="datePublished" content="2025-11-19T14:58:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AKAMAI"/> <meta itemprop="url" content="https://juejin.cn/user/829502942352628"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            企业如何平衡AI创新与风险
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/829502942352628/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AKAMAI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T14:58:52.000Z" title="Wed Nov 19 2025 14:58:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>生成式AI的全球支出预计将在2025年达到6440亿美元，较2024年激增76%。这一数据传递出明确信号：企业普遍认为，若在AI应用领域落后，企业将面临生存危机。然而，尽管AI技术已无处不在，但其应用仍持续引发企业领导层的忧虑——从安全隐患到运营挑战，诸多问题亟待解决。</p>
<p>关于AI的潜在风险与弊端是否值得其宣称的巨大收益，业界始终存有疑虑。尽管创新承诺能带来客户体验与运营效率的变革性提升，但将AI深度嵌入现有运营体系所伴随的风险，亦可能引发严重后果。</p>
<h4 data-id="heading-0"><strong><strong>寻找平衡点</strong></strong></h4>
<p>技术领导者面临一项”平衡”挑战：企业如何在积极开拓AI疆土的同时，避免为自身埋下难以承受的风险隐患。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Flp%2Fforrester-enterprise-ai-report-2025%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_251119_external1_blogarticles228" target="_blank" title="https://www.akamai.com/zh/lp/forrester-enterprise-ai-report-2025?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_251119_external1_blogarticles228" ref="nofollow noopener noreferrer">由Akamai委托、Forrester进行的一项新研究</a>，就企业目前如何实现这种平衡提供了一些答案。该研究通过对400名高级AI和企业云战略决策者进行调研，揭示了组织如何在快速捕获价值的同时，建立必要的防护措施来保护其业务。</p>
<h4 data-id="heading-1"><strong><strong>企业如何确定AI场景的优先级</strong></strong></h4>
<p>Forrester的研究明确指出，企业领导者正将AI直接融入核心业务目标，使其成为业务战略的核心。即便如此，领导者们也谨慎地优先考虑低风险、高回报的应用。</p>
<p>受访者指出了推动AI投资的三大首要目标：</p>
<ul>
<li>改善客户体验（76%）</li>
<li>提高运营效率（76%）</li>
<li>加强客户留存（71%）</li>
</ul>
<p>其他研究持续表明，客户体验的改善与收入增长、客户流失减少和更强的竞争优势直接相关。</p>
<p>例如，麦肯锡公司指出："……全球最成功的高增长企业所创造的价值中，80%来自核心业务——主要是从现有客户中挖掘新收益。"</p>
<p><strong><strong>最高优先级的AI场景最贴近客户</strong></strong></p>
<p>因此，企业领导者并非因为需要保持竞争力而使用AI，而是谨慎地将这种新技术与影响收入和增长的可衡量成果挂钩。这就解释了为什么最高优先级的AI使用案例是那些最贴近客户的场景。</p>
<p>超过一半的组织正在将AI应用用于个性化（53%）、自动化客户解决流程（53%）和回答客户问题（52%）。与更具实验性的用例相比，这些应用风险相对较低，但能带来快速、有形的投资回报。</p>
<p>通过专注于直接的客户体验改善，公司可以产生回报，为进一步的探索提供资金，同时也能让团队和基础设施为更宏大的计划做好准备。</p>
<h4 data-id="heading-2"><strong><strong>采用AI的风险格局</strong></strong></h4>
<p>Forrester的研究也呼应了企业领导者从一开始就对AI存在的一些担忧。他们最关心的AI问题包括：</p>
<ul>
<li>网络安全风险</li>
<li>合规性挑战</li>
<li>声誉损害</li>
<li>财务损失</li>
</ul>
<p><strong><strong>网络安全风险</strong></strong></p>
<p>63%的受访者担心网络安全风险。AI系统引入了新的攻击面，并为威胁行为者扩大了现有的攻击面。诸如模型投毒、提示注入和数据窃取之类的威胁，已在现实场景中出现。当面向客户的应用程序依赖AI进行决策时，即使是微小的漏洞也可能级联成重大的安全漏洞。</p>
<p><strong><strong>合规性挑战</strong></strong></p>
<p>随着政府颁布新的AI驱动法规，如欧盟《人工智能法案》、美国监管框架以及特定行业指南，企业在扩展AI规模时面临着合规障碍。与传统软件不同，AI引入了可解释性、可审计性和偏见缓解等独特问题。未能达到法规要求可能导致处罚、法律风险部署停滞。</p>
<p><strong><strong>声誉损害</strong></strong></p>
<p>AI故障往往会<strong><strong>迅速曝光</strong></strong>。有偏见的推荐系统或胡言乱语的聊天机器人，随时可能登上新闻头条。客户数据隐私也可能因此泄露。对于面向客户的应用场景而言，此类失误远不止是技术问题——更会重创品牌形象。而重建用户对企业的信任，注定代价高昂。</p>
<p><strong><strong>财务损失</strong></strong></p>
<p>实施不当的AI可能导致客户流失、机会丧失和投资浪费。例如，如果零售业的AI聊天机器人提供了误导性的财务建议，公司可能不仅面临监管罚款和诉讼，还会遭遇消费者的强烈反对，这将削弱AI系统本应实现的客户留存收益。</p>
<p>这些风险的后果有可能像滚雪球一样演变成严重的业务中断，这就是为什么领导者必须谨慎采用AI，必须仔细平衡创新的风险与回报。</p>
<h4 data-id="heading-3"><strong><strong>企业如何实现这种平衡</strong></strong></h4>
<p>尽管AI的回报是否大于风险仍有待观察，但当今的企业并非无能为力。根据Forrester的研究，领导者们可以在以下方面相互借鉴：</p>
<ul>
<li>迭代式采用</li>
<li>用于AI训练和推理的托管服务</li>
<li>云原生和开源技术的采用</li>
<li>强大的供应商生态系统</li>
<li>跨职能治理</li>
</ul>
<p><strong><strong>迭代式采用</strong></strong></p>
<p>许多组织并非全力投入雄心勃勃的生成式AI项目，而是从小处着手。通过在受控的场景（如客户服务自动化）中推出AI，他们可以在不危及关键运营的情况下获得经验。这种迭代模式使他们能够负责任地进行测试、学习和扩展。</p>
<p><strong><strong>用于AI训练和推理的托管服务</strong></strong></p>
<p>构建和维护AI基础设施非常复杂，企业越来越依赖托管服务来进行模型训练和推理。这减少了运营负担，并使专业知识的获取变得更加容易。</p>
<p>通过外包高风险任务，组织在加速部署的同时也最小化了风险暴露。关键在于选择那些与自身具有相似安全和风险缓解标准的公司提供的服务。</p>
<p><strong><strong>云原生和开源技术的采用</strong></strong></p>
<p>调查数据还显示，企业正在尝试<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fglossary%2Fwhat-is-cloud-native%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_251119_external2_blogarticles228" target="_blank" title="https://www.akamai.com/zh/glossary/what-is-cloud-native?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_251119_external2_blogarticles228" ref="nofollow noopener noreferrer">云原生</a>和开源AI技术。云原生架构提供了可扩展性和弹性，而开源技术则提供了灵活性和速度，这两者对于AI采用和技术更新都是必需的。这为企业带来了架构上的灵活性，同时规避了长期受制于特定供应商的风险。</p>
<p><strong><strong>强大的供应商生态系统</strong></strong></p>
<p>鉴于AI采用的复杂性，许多组织正在优先考虑那些拥有成熟AI专业知识的供应商。这些合作伙伴不仅帮助企业应对技术问题，还帮助应对合规性、可扩展性和安全性。强大的供应商生态系统支持AI风险缓解策略。</p>
<p><strong><strong>跨职能治理</strong></strong></p>
<p>或许最重要的是，组织认识到AI治理不能仅仅由IT部门负责。领先的企业从一开始就创建涉及合规、法律和安全团队的跨职能治理框架。这种整体方法确保了AI创新符合监管要求和合乎道德的AI标准。</p>
<p>从数据中显现出的主要模式是，公司正在通过结来实现平衡；也就是说，他们正在构建脚手架，使创新和风险管理能够并行推进。</p>
<h4 data-id="heading-4"><strong><strong>基础设施与AI风险管理</strong></strong></h4>
<p>除了运营结构，平衡的AI采用还需要坚实的基础设施。事实上，根据Forrester的研究，55%的企业将技术和平台差距列为其采用AI的首要挑战。</p>
<p>传统的云平台并非为性能敏感的AI工作负载（如大规模推理）的独特需求而设计。延迟、成本效率低下以及数据本地化控制不足，都会带来风险——从客户体验下降到合规审计中更高的风险暴露。</p>
<p>企业正在通过探索专为AI性能构建的替代方案来重新思考其基础设施战略。他们通过使用为分布式工作负载、低延迟推理和内置安全而优化的平台来实现这一目标。</p>
<p>简而言之，基础设施不仅仅是AI技术的基础；它也是风险方程中的一个活跃部分。选择错误的基础设施会放大漏洞。选择正确的基础设施则可以将AI从负债转变为长期的竞争优势。</p>
<h4 data-id="heading-5"><strong><strong>现在缓解风险，为了未来创新</strong></strong></h4>
<p>企业AI的征程正在快速演变。早期的采用集中于狭窄的场景，随后生成式AI浪潮扩展到内容创作、分析和自动化。</p>
<p>现在，我们正处于下一阶段的风口浪尖：代理型AI。代理型AI构成了具有自主性的系统，能够代表人类行事，并根据现有情境做出决策。这种演进承诺带来进一步的收益，但当然也伴随着前所未有的风险。</p>
<p>AI的每个阶段都既增加了潜在收益，也提高了失败的成本。那些成功的企业，将是那些目前通过迭代采用来构建组织流畅度、投资于具有弹性且性能优化的基础设施、并从一开始就嵌入治理与合规的企业。</p>
<p>现在正是技术决策者重新评估AI解决方案和云战略，特别是其基础设施选择的时候，以确保他们能够负责任地扩展，并将道德考量放在心上。</p>
<p><strong><strong>了解更多</strong></strong></p>
<p>要更深入地了解400位高级决策者如何应对AI开发与采用，请下载完整的Forrester报告：《<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Flp%2Fforrester-enterprise-ai-report-2025%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_251119_external3_blogarticles228" target="_blank" title="https://www.akamai.com/zh/lp/forrester-enterprise-ai-report-2025?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_251119_external3_blogarticles228" ref="nofollow noopener noreferrer">企业级 AI 现状：积累经验，管控风险</a>》。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么实时更新场景下 Doris 查询性能是 ClickHouse 的 34 倍]]></title>    <link>https://juejin.cn/post/7574269207363043337</link>    <guid>https://juejin.cn/post/7574269207363043337</guid>    <pubDate>2025-11-19T15:26:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574269207363043337" data-draft-id="7574269207362977801" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么实时更新场景下 Doris 查询性能是 ClickHouse 的 34 倍"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2025-11-19T15:26:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SelectDB"/> <meta itemprop="url" content="https://juejin.cn/user/3189021726222904"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么实时更新场景下 Doris 查询性能是 ClickHouse 的 34 倍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3189021726222904/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SelectDB
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T15:26:28.000Z" title="Wed Nov 19 2025 15:26:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读24分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在当今数据驱动的商业环境中，企业越来越依赖数据分析来驱动决策。无论是用户行为分析、业务报表还是运营监控，企业都需要具备快速、高效的数据处理能力。企业在数据分析能力上的演进，往往始于 TP（事务处理）系统，随着业务发展不断探索 TP 系统的扩展方案，最终走向构建独立的 AP（分析处理）系统。</p>
<h2 data-id="heading-0">企业实时分析典型演进过程</h2>
<h3 data-id="heading-1">第一阶段：使用 TP 系统支撑事务处理和数据分析</h3>
<p>在企业信息系统建设的早期，主要存储在 OLTP（在线事务处理）系统中，比如 PostgreSQL、MySQL、SQL Server 等。因为数据“就在那儿”，最自然的方式就是直接从 TP 系统中执行 SQL 查询来获取所需分析数据：</p>
<ul>
<li>查询订单、用户、库存、交易等业务数据；</li>
<li>生成运营报表，支撑内部管理；</li>
<li>快速开发查询接口，满足临时的 BI 需求。</li>
</ul>
<p>在业务初期，数据规模有限，分析需求也相对简单，系统架构轻量，能够高效支撑当下业务，避免了多系统部署和复杂数据流带来的额外成本与运维压力。然而，随着业务快速发展，数据量迅速增长，分析场景愈发复杂，查询延迟上升，事务与分析负载相互影响，原有系统逐渐难以支撑持续扩展的业务需求。</p>
<h3 data-id="heading-2">第二阶段：探索 TP 系统的扩展方案</h3>
<p>为了在不破坏 TP 系统稳定性的前提下支撑持续扩展的业务需求，部分企业开始尝试基于 TP 的扩展方案。以下是行业中常见的做法与代表系统：</p>
<p><strong>1. 分片与分布式扩展：Citus、TiDB、Vitesse</strong></p>
<p>这些系统具备了基于关系数据库的水平扩展能力，使 TP 系统可以存储更大规模的数据并处理更高并发。</p>
<ul>
<li><strong>Citus</strong>：是 PostgreSQL 的分布式扩展插件，可将表自动切分到多个节点，实现并行处理和查询加速。</li>
<li><strong>TiDB</strong>：兼容 MySQL 协议的分布式 HTAP 数据库，事务与分析融合，适用于在线业务+报表的场景。</li>
<li><strong>Vitesse</strong>：基于 MySQL 的分布式中间件，解决数据库扩展、容错和自动化问题，常用于大规模 TP 系统。</li>
</ul>
<p><strong>2. 读写分离与多副本架构：Amazon Aurora</strong></p>
<ul>
<li><strong>Amazon Aurora</strong> 提供了高性能、弹性扩展的云数据库，并支持最多 15 个只读副本，用于分担查询压力。这类方案适用于中等复杂度的分析任务，但在海量数据和复杂查询面前，Aurora 等 TP 架构依然面临查询瓶颈。</li>
</ul>
<p>这些方案虽然在一定程度上缓解了单机性能瓶颈，但本质仍属于 TP 系统架构，难以根本解决事务与分析并存所带来的矛盾。面对大规模、多维度的聚合分析，这类系统能力有限，查询操作常常干扰写入，导致系统性能波动，影响整体稳定性。同时，架构复杂、运维门槛高，随着写入量和查询压力的持续上升，资源消耗不断加剧，系统成本快速攀升，性能瓶颈也日益显现。尤其在高吞吐数据导入和实时更新方面能力不足，限制了对业务变化的快速响应。而 TP 系统以行存为主的特性，使其在处理 TB 级以上数据的分析任务时，性能与专为分析设计的 AP 系统存在显著差距，难以胜任更复杂、更大规模的分析需求。</p>
<h3 data-id="heading-3">第三阶段：复杂分析使用 AP 系统</h3>
<p>随着数据量不断增长、分析需求日益复杂，很多企业逐渐意识到，无法再依赖原有的 TP 系统同时满足事务处理与分析需求。因此，企业通常会将一些复杂的分析查询迁移到专门的 AP 系统中，例如 Redshift、Snowflake、BigQuery 等，用于支撑大规模的数据分析任务。而对于对实时性要求高、并发量大的查询，仍会保留在 TP 系统中运行，以确保系统的快速响应和稳定性。在一些高并发场景中，数据甚至会在 AP 系统中完成加工处理后，回流到 TP 系统中，进一步支撑实时查询和业务服务。</p>
<h3 data-id="heading-4">第四阶段：拥抱 AP 系统，实现分析计算与事务的解耦</h3>
<p>随着数据规模持续扩大，事务处理系统（TP）的数据导入速度难以跟上行为数据生成的节奏，导致数据延迟持续增加。与此同时，部分复杂查询被转移到分析处理系统（AP）执行，其他分析任务仍在 TP 系统中完成，这使得系统运维难度和资源成本不断攀升，远超专门的 AP 系统。</p>
<p>下表总结了 OLTP 与 OLAP 在关键维度上的主要区别，便于理解两者在架构定位上的差异。</p>
<h3 data-id="heading-5">OLTP vs OLAP 对比</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b704c567eadc4c87be94e82bfcf419f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764170788&amp;x-signature=1HrTGzPtWI6tYx6jx0dwURwYfQo%3D" alt="OLTP vs OLAP 对比.jpeg" loading="lazy"/></p>
<p>面对这种挑战，越来越多企业开始认识到：对于实时分析场景，采用具备高并发与高性能的一体化 AP 系统来统一承载，能够大幅提升效率；而批量处理和离线分析等需求，则可以选择更适合的 AP 系统来完成。这样不仅优化了整体架构，也有效控制了成本，同时提升了数据分析能力，助力企业实现更加高效的数据驱动运营。</p>
<p>实时数据需求直接导入实时 OLAP 系统，常见做法是将事务处理系统（TP）与分析处理系统（AP）解耦，通过变更数据捕获（CDC）技术，实现 TP 系统数据的实时同步，同时行为数据也直接写入实时 OLAP。实时 OLAP 系统需具备快速更新能力和高效查询性能。该架构不仅避免了对核心业务系统的影响，还使企业能够第一时间获取并分析最新数据，广泛应用于用户行为分析、实时报表、风险监控等关键场景，显著提升了数据决策的及时性和价值。</p>
<h2 data-id="heading-6">OLAP 系统的选择：为什么是 Apache Doris？</h2>
<p>Apache Doris 适合大数据量下需要高并发查询、AdHoc 和实时数据更新的场景：</p>
<h3 data-id="heading-7">低延迟高吞吐写入</h3>
<p>支持多种数据导入方式，通过 <code>Stream Load</code> 可实现数据<strong>秒级可见</strong>、单节点写入吞吐可达<strong>百万行/秒</strong>，轻松满足海量数据的实时入库需求。</p>
<h4 data-id="heading-8">用户案例：网易云音乐</h4>
<p>网易云音乐作为知名音乐流媒体平台，每天产生大量用户行为数据、业务数据及日志数据，这些数据在异常行为跟踪、客诉问题定位、运行状态监控、性能优化等方面扮演守护者的角色。面对每日万亿级别数据的增量，<strong>网易云音乐选择使用 Apache Doris 替换 ClickHouse 构建新的日志平台，目前已稳定运行 3 个季度，规模达到 50 台服务器，2PB 数据，每天新增日志量超过万亿条，峰值写入吞吐达 6GB/s。</strong></p>
<p><strong>在低延迟高吞吐写入场景中</strong>，网易云音乐采用 Flink + Doris Connector 实现流式数据无缝对接，通过多项关键优化措施显著提升了写入性能：</p>
<ul>
<li><strong>写入流程优化</strong>：在 append 数据操作时，直接写入压缩流，无需经过 ArrayList 中转，大幅降低内存使用，TM 内存占用从 8G 降至 4G，有效避免了因 batch size 设置过高导致的 OOM 问题。</li>
<li><strong>单 tablet 导入功能</strong>：开启单 tablet 导入功能（要求表使用 random bucket 策略），极大提升写入性能，解决了写入 tablet 过多时元数据产生过多影响写入性能的问题。</li>
<li><strong>负载均衡优化</strong>：每个 batch flush 完成后随机选择 BE 节点写入数据，解决 BE 写入不均衡问题，相较之前导入性能提升 70%。</li>
<li><strong>容错能力增强</strong>：调整 failover 策略，优化重试逻辑并增加重试时间间隔，当 FE/BE 发生单点故障时能自动感知和重试恢复，保证服务高可用。</li>
</ul>
<p><strong>在元数据性能优化方面</strong>，针对 HDD 硬盘环境下 Stream Load 耗时突增问题，通过调整 3 台 Follower FE 为异步刷盘模式，实现了 4 倍性能提升，有效解决了同步元数据阶段的严重耗时问题。</p>
<p><strong>整体收益显著</strong>：查询响应整体 P99 延迟降低 30%，并发查询能力从 ClickHouse 的 200 提升至 500+，写入稳定性大幅改善，运维成本显著降低，在坏盘和宕机场景下实现自恢复能力。</p>
<p>完整阅读：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.selectdb.com%2Fblog%2F1369" target="_blank" title="https://www.selectdb.com/blog/1369" ref="nofollow noopener noreferrer">网易云音乐基于 Apache Doris 的万亿级日志平台建设实践</a></p>
<h3 data-id="heading-9">实时更新能力强</h3>
<p>配合主流数据同步工具（如 Kafka、Canal、DataX、SeaTunnel 等）可实现从 TP 系统到 Doris 的准实时数据同步。其“Merge-on-Write”的更新机制兼顾写入性能与更新效率，适配主流 CDC 场景。</p>
<h4 data-id="heading-10">用户案例 ：中通快递</h4>
<p>随着中通快递业务的持续增长，昔日双 11 的业务高峰现已成为每日常态，原有数据架构在数据时效性、查询效率、与维护成本方面，均面临着较大的挑战。为此，中通快递引入 SelectDB，借助其高效的数据更新、低延时的实时写入与优异的查询性能，在快递业务实时分析场景、BI 报表与离线分析场景、高并发分析场景中均进行了应用实践。</p>
<p><strong>在实时分析场景中，基于 SelectDB 灵活丰富的 SQL 函数公式、高吞吐量的计算能力，实现了结果表的查询加速，能够达到每秒上 2K+ 数量级的 QPS 并发查询，数据报表更新及时度大大提高。</strong></p>
<p>SelectDB 的引入满足了复杂与简单的实时分析需求。目前，SelectDB 日处理数据超过 6 亿条，数据总量超过 45 亿条，字段总量超过 200 列，并实现服务器资源节省 2/3、查询时长从 10 分钟降至秒级的数十倍提升。</p>
<p>案例回顾：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1eF6HY9Ecr%2F" target="_blank" title="https://www.bilibili.com/video/BV1eF6HY9Ecr/" ref="nofollow noopener noreferrer">中通快递基于 SelectDB 实时数仓的应用实践</a></p>
<h3 data-id="heading-11">极致的查询性能</h3>
<p>Doris 天生为分析优化，具备列式存储、向量化执行引擎、位图索引、多级缓存、物化视图等优化手段，能够支撑亚秒级的分析响应时间，并支持复杂的多维分析、聚合与 JOIN 查询。</p>
<h4 data-id="heading-12">用户案例 ：拉卡拉</h4>
<p>拉卡拉（股票代码 300773）是国内首家数字支付领域上市企业，从支付、货源、物流、金融、品牌和营销等各维度，助力商户、企业及金融机构数字化经营。随着实时交易数据规模日益增长，拉卡拉早期基于 Lambda 架构构建的数据平台面临存储成本高、实时写入性能差、复杂查询耗时久、组件维护复杂等问题。<strong>拉卡拉选择使用 Apache Doris 替换 Elasticsearch、Hive、HBase、TiDB、Oracle/MySQL 等组件，完成 OLAP 引擎的统一，实现了查询性能提升 15 倍、资源减少 52% 的显著成效。</strong></p>
<p><strong>在极致查询性能场景中</strong>，拉卡拉充分发挥了 Apache Doris 天生为分析优化的多项能力，在金融核心业务中实现了显著的性能提升：</p>
<ul>
<li><strong>风控场景查询优化</strong>：替换 Elasticsearch 后，查询响应时间从 15 秒缩短至 1 秒以内，查询性能提升 15 倍。Doris 的标准 SQL 查询接口和强大的多维分析能力，支持复杂的多表 JOIN、子查询和窗口函数等场景。</li>
<li><strong>对账单系统高并发处理</strong>：借助 Doris 优秀的并发处理和极速查询能力，支持每日亿级数据规模和百万级查询请求，查询 99 分位数响应时长控制在 2 秒以内，数据延迟可控制在 5 秒。</li>
<li><strong>倒排索引加速大表关联</strong>：通过添加倒排索引、调整分桶策略以及表结构优化，大表关联查询耗时从 200 秒缩短至 10 秒，查询效率提升超过 20 倍。</li>
<li><strong>Light Schema Change 灵活变更</strong>：相比 Elasticsearch 需要通过 Reindex 进行 Schema 变更，Doris 的 Light Schema Change 机制更加高效灵活，支持字段和索引的快速增删修改，极大提升了数据管理的便捷性和业务适应性。</li>
</ul>
<p><strong>整体收益显著</strong>：服务器数量下降 52%，开发运维效率大幅提升，通过统一的 OLAP 引擎简化了技术架构，降低了学习成本和运维复杂性。</p>
<p>完整阅读：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.selectdb.com%2Fblog%2F1387" target="_blank" title="https://www.selectdb.com/blog/1387" ref="nofollow noopener noreferrer">拉卡拉 x Apache Doris：统一金融场景 OLAP 引擎，查询提速 15 倍，资源直降 52%</a></p>
<h3 data-id="heading-13">高并发处理能力</h3>
<p>得益于 MPP 架构，Doris 可轻松扩展计算资源，支持海量用户并发访问分析报表，是支撑数据门户、运营后台、用户行为分析等实时应用场景的理想方案。</p>
<h4 data-id="heading-14">用户案例：快手</h4>
<p>快手作为知名短视频平台，OLAP 系统为内外多个场景提供数据服务，每天承载近 10 亿的查询请求。原有湖仓分离架构面临存储冗余、资源抢占、治理复杂等问题。<strong>快手通过引入 Apache Doris 湖仓一体能力替换 ClickHouse，升级为湖仓一体架构，涉及数十万张表、数百 PB 的数据增量处理。</strong></p>
<p><strong>在高并发处理场景中</strong>，Apache Doris 凭借强大的 MPP 架构和分布式查询引擎，为快手提供了卓越的并发查询支撑能力：</p>
<ul>
<li><strong>海量并发查询支撑</strong>：系统每天承载近 10 亿查询请求，覆盖 ToB 系统（商业化报表引擎、DMP、磁力金牛、电商选品）和内部系统（KwaiBI、春节/活动大屏、APP 分析、用户理解中心等）的高并发访问需求。</li>
<li><strong>智能查询路由</strong>：通过查询路由服务分析和预估查询的数据扫描量，将超大查询自动路由到 Spark 引擎，避免大查询占用过多 Doris 资源，确保高并发场景下的系统稳定性。</li>
<li><strong>物化视图透明改写</strong>：结合 Doris 的物化视图改写能力和自动物化服务，实现查询性能提升至少 6 倍，百亿级别以下数据可实现毫秒级响应，有效支撑高并发查询场景。</li>
<li><strong>缓存优化加速</strong>：通过元数据缓存和数据缓存双重优化，元数据访问平均耗时从 800 毫秒降至 50 毫秒，显著提升高并发场景下的查询响应效率。</li>
</ul>
<p><strong>整体收益</strong>：实现了统一存储和链路简化，无需数据导入即可直接访问湖仓数据，在支撑海量并发查询的同时大幅降低了运维复杂度和存储成本。</p>
<p>完整阅读：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.selectdb.com%2Fblog%2F1004" target="_blank" title="https://www.selectdb.com/blog/1004" ref="nofollow noopener noreferrer">快手：从 Clickhouse 到 Apache Doris，实现湖仓分离向湖仓一体架构升级</a></p>
<p><strong>统一数据体验</strong> Doris 提供类 SQL 的接口，兼容 MySQL 协议，易于 BI 工具对接（如 Tableau、Power BI、Superset 等），同时可通过视图、物化视图等能力，提供类似数据仓库的建模支持。</p>
<p>可以满足的典型场景包括：</p>
<ul>
<li><strong>面向用户的实时分析（Customer-Facing Analytics）</strong> 将订单、交易、行为等业务数据从数据库中捕获并同步至实时数仓（如 Apache Doris），支持用户在前端系统中秒级查看订单状态、活动参与情况、积分变化等。提升用户体验的同时，也为推荐、搜索等系统提供最新的数据支持。</li>
<li><strong>运营监控与分析</strong> 运维、客服、市场等部门可以实时查看关键指标（如系统交易量、失败率、退货率），并快速响应业务波动。CDC 保证了数据与业务系统的实时一致性，使监控结果具有可信度。</li>
<li><strong>模型训练与特征回填</strong> 将用户行为日志和业务数据同步到分析库后，ML 工程师可以基于最新数据生成训练样本、回填特征值，显著加快模型迭代速度，提升预测准确率。</li>
<li><strong>多维分析与自助 BI</strong> 将结构化业务数据实时汇聚到 OLAP 系统，结合维度模型，支持业务人员进行灵活多维分析，满足从明细到聚合的多层级洞察需求，减少对开发人员的依赖。</li>
</ul>
<h2 data-id="heading-15">ClickHouse 实时更新原理</h2>
<p>在 ClickHouse 中，虽然底层存储以追加为主，但通过 <code>ReplacingMergeTree</code> 引擎，用户可以实现类似“实时更新”的效果。其核心思想是：在写入时保留所有版本的数据，在后台合并时自动保留最新版本，从而实现数据的“更新”。</p>
<blockquote>
<p>详情<a href="https://link.juejin.cn?target=https%3A%2F%2Fclickhouse.com%2Fdocs%2Fguides%2Fdeveloper%2Fdeduplication" target="_blank" title="https://clickhouse.com/docs/guides/developer/deduplication" ref="nofollow noopener noreferrer">参考文档</a></p>
</blockquote>
<p>具体工作原理如下：</p>
<ol>
<li><strong>写入阶段</strong> 使用 <code>ReplacingMergeTree</code> 创建表时，通常会指定一个唯一标识列（如主键）和一个版本列（如 <code>update_time</code>）。每次对同一主键的数据更新时，系统不会直接覆盖旧数据，而是插入一行新版本的记录。</li>
<li><strong>合并阶段（Merge）</strong> ClickHouse 的后台合并线程会在空闲时自动执行数据文件的合并操作。对于 <code>ReplacingMergeTree</code> 表，合并过程中会根据主键值和版本列，自动保留每组主键下版本最新的记录，删除旧版本，实现最终的“更新”语义。</li>
<li><strong>查询阶段</strong> 查询过程中可能会读到尚未合并的多个版本记录，因此建议设置 <code>FINAL</code> 查询语法，如：</li>
</ol>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> my_table <span class="hljs-keyword">FINAL</span>;
</code></pre>
<h2 data-id="heading-16">Apache Doris 实时更新原理</h2>
<p>在需要频繁更新数据的场景中，可以使用 Doris 提供的 Unique Key 模型来建表，实现对同一主键的数据进行高效覆盖更新。Doris 通过一种名为标记删除（Delete Bitmap）的机制，有效提升查询性能。与 ClickHouse 查询时进行更新清理的方式不同，Doris 的标记删除机制无需在查询时实时计算删除逻辑，因此可以显著减少查询延迟，确保查询响应时间稳定在百毫秒以内，并支持高并发访问。</p>
<p>具体来说，Doris 的处理分为两个阶段：</p>
<ol>
<li><strong>写入阶段</strong> 在使用 Unique Key 创建表时，您通常会指定一个唯一标识（如主键 ID）和一个版本列（如更新时间 <code>update_time</code>）。每当新数据写入时，如果主键相同且版本更新，Doris 会自动为旧数据打上“删除标记”，这些信息随着数据一同写入底层存储。</li>
<li><strong>查询阶段</strong> 在查询过程中，Doris 会自动识别并跳过那些已被标记删除的旧数据行，无需实时对比或扫描多个版本，从而实现低延迟、高效率的数据读取。</li>
</ol>
<p>借助这套机制，Doris 能够同时满足 <strong>实时更新</strong> 和 <strong>高速查询</strong> 的双重需求，非常适合用于用户画像、订单中心、指标快照等典型更新型分析场景。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcd3c65aa91b457f8a475812b688d2d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764170788&amp;x-signature=IVmc%2F8Q2YgWLpaQ1Vy3NWTjwJb4%3D" alt="Apache Doris 实时更新原理.png" loading="lazy"/></p>
<h2 data-id="heading-17">性能对比</h2>
<p>当分析负载从 TP 或者 HTAP 演进到 AP 时，一个常见场景是将 TP 系统中的变更数据（通过 CDC）同步到 AP 系统，用于后续的报表分析和业务监控。这类场景通常涉及大量的<strong>数据更新</strong>，而不仅仅是新增数据，因此对分析系统的更新处理能力和查询性能提出了更高要求。</p>
<p>为了评估 Doris 和 ClickHouse 在这一类实时更新分析场景下的表现，我们基于典型的行业测试模型 <strong>ClickBench</strong> 和 <strong>SSB（Star Schema Benchmark）</strong> 进行了测试，分别对数据集中的 <strong>25% 和 100% 的记录进行了更新操作</strong>。</p>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdataroaring%2FClickBench%2Ftree%2Fmain%2Fclickhouse-cloud-update" target="_blank" title="https://github.com/dataroaring/ClickBench/tree/main/clickhouse-cloud-update" ref="nofollow noopener noreferrer">更新 SQL </a> 详情参考</p>
</blockquote>
<p>为确保性能对比的合理性，结合 ClickHouse Cloud 与 SelectDB Cloud 套餐配置的差异，制定了如下测试方案：ClickHouse Cloud 采用双副本，单副本分别配置为 8 核 32GB 和 16 核 64GB；SelectDB Cloud 则采用单副本 16 核 128GB 配置。通过该设计，可在整体资源层面分别实现核数对等（16 核）与内存对等（128GB）的横向对比，从而更全面地评估两者在不同资源维度下的性能表现。</p>
<p>原始数据：<a href="https://link.juejin.cn?target=https%3A%2F%2Fselectdb.feishu.cn%2Fsheets%2FGgLnslWcBhmVK8trjVpcAPTinkb" target="_blank" title="https://selectdb.feishu.cn/sheets/GgLnslWcBhmVK8trjVpcAPTinkb" ref="nofollow noopener noreferrer">ssb</a></p>
<h3 data-id="heading-18">SSB-sf100</h3>
<h4 data-id="heading-19">ClickHouse MergeTree  vs  SelectDB Duplicate Key</h4>
<ul>
<li>SelectDB （16c 128GB）的性能是 ClickHouse 32c 128GB（2 replica 每个 replica 16c 64GB）的 5 倍。</li>
<li>SelectDB （16c 128GB）的性能是 ClickHouse 16c 64GB（2 replica 每个 replica 16c 64GB）的 9.8 倍。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3cc9c7fa7ad542c78bbbe94c9539442c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764170788&amp;x-signature=L8m98pfaQLFm8DXt0OX08PONw1s%3D" alt="性能对比-1.png" loading="lazy"/></p>
<h4 data-id="heading-20">ClickHouse MergeTree  vs  ReplacingMergeTree</h4>
<ul>
<li>25% 更新比例下，ClickHouse ReplacingMergeTree 相比 MergeTree 性能下降 1.6 倍。</li>
<li>100% 更新比例下，ClickHouse ReplacingMergeTree 相比 MergeTree 性能下降 2.5 倍。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/354a89fce3764de98d3a5dc24b4d6e86~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764170788&amp;x-signature=nwZWvtbo%2BTYss0lePuNCfFsLxYk%3D" alt="性能对比 02.png" loading="lazy"/></p>
<h4 data-id="heading-21">ClickHouse ReplacingMergeTree vs SelectDB UniqueKey</h4>
<ul>
<li>SelectDB （16c 128GB）相比 ClickHouse 32c 128GB（2 replica 每个 replica 16c 64GB）</li>
<li>25% 更新比例条件下，SelectDB 的性能是 ClickHouse 的 14 倍。</li>
<li>100% 更新比例条件下，SelectDB 的性能是 ClickHouse 的 18 倍。</li>
<li>SelectDB （16c 128GB）相比 ClickHouse 16c 64GB（2 replica 每个 replica 8c 32GB）
<ul>
<li>25% 更新比例条件下，SelectDB 的性能是 ClickHouse 的 25 倍。</li>
<li>100% 更新比例条件下，SelectDB 的性能是 ClickHouse 的 34 倍。</li>
</ul>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3cfd9496a5d54ccb8cf588a283538c0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764170788&amp;x-signature=%2FQfehlDBS%2BuqGT6gjR5pPge6VYM%3D" alt="性能对比-2.png" loading="lazy"/></p>
<h3 data-id="heading-22">ClickBench</h3>
<p>原始数据：<a href="https://link.juejin.cn?target=https%3A%2F%2Fselectdb.feishu.cn%2Fsheets%2FGaKxsBKErhDKYDtBmcEc1KBRnte" target="_blank" title="https://selectdb.feishu.cn/sheets/GaKxsBKErhDKYDtBmcEc1KBRnte" ref="nofollow noopener noreferrer">clickbench</a></p>
<h4 data-id="heading-23">ClickHouse MergeTree  vs  ReplacingMergeTree</h4>
<ul>
<li>ClickBench 下 25% 更新比例 ClickHouse ReplacingMergeTree 相比 MergeTree 性能下降超过 170%。</li>
<li>ClickBench 下 100% 更新比例 ClickHouse ReplacingMergeTree 相比 MergeTree 性能下降超过 290%。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/753a869cf73e440d8d19e4b2333f6182~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764170788&amp;x-signature=W9eCtdfQfEU5AUC1ejynEtb6aMQ%3D" alt="性能对比-3.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9802ca07a8204ffaac8ae6e38d09fa6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764170788&amp;x-signature=VNCVtESSFmEN7YCj6qSp06vQgDc%3D" alt="性能对比-4.png" loading="lazy"/></p>
<h4 data-id="heading-24">ClickHouse ReplacingMergeTree vs SelectDB UniqueKey</h4>
<ul>
<li>SelectDB （16c 128GB）相比 ClickHouse 32c 128GB（2 replica 每个 replica 16c 64GB）</li>
<li>25% 更新比例条件下，查询耗时低 43%</li>
<li>100% 更新比例条件下，查询耗时低 60%</li>
<li>SelectDB （16c 128GB）相比 ClickHouse 16c 64GB（2 replica 每个 replica 8c 32GB）
<ul>
<li>25% 更新比例条件下，查询耗时低 68%。</li>
<li>100% 更新比例条件下，查询耗时低 78%。</li>
</ul>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/967b330635f74a61a749da5aeae588ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764170788&amp;x-signature=WRIIDqcgO3tUhoD74cn5UkOzZB8%3D" alt="性能对比-5.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb35845a420c4584815998cb6253f2c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764170788&amp;x-signature=Hj%2Bwengf9KGI6oKty%2FrqiQJ9ifw%3D" alt="性能对比-6.png" loading="lazy"/></p>
<h2 data-id="heading-25">用户案例</h2>
<h3 data-id="heading-26">案例一：森马服饰（MySQL）</h3>
<p>森马服饰作为中国休闲服饰和童装领域的领先企业，覆盖线上线下全渠道零售，门店总数达到 8000+ 家。为支撑全域货通中台项目，<strong>森马引入阿里云 SelectDB 替换原 Elasticsearch + 分布式 MySQL 混合架构，统一分析 16+ 核心业务，实现复杂查询 QPS 提升 400%，响应时间缩短至秒级。</strong></p>
<p><strong>在高并发处理场景中</strong>，阿里云 SelectDB 凭借 MPP 架构为森马提供了强大的并发查询支撑：</p>
<ul>
<li><strong>多场景并发支撑</strong>：同时支撑 2B 业务、2C 业务、直营店、加盟商等多场景下的高并发数据分析需求，复杂查询 QPS 达到 200+ 水平。</li>
<li><strong>资源隔离能力</strong>：基于存算分离架构，在线订单查询服务和离线聚合分析 BI 场景分别使用独立计算组，避免相互干扰，确保高并发场景下系统稳定性。</li>
<li><strong>弹性扩缩容</strong>：在直播大促等高压力时段，可快速在线扩容应对流量激增，无需停服和数据搬迁，显著提升应对突发高并发的灵活性。</li>
<li><strong>统一架构简化</strong>：替换双系统架构，统一支持简单过滤查询、海量数据聚合分析、复杂多表关联查询，无需维护复杂业务逻辑来处理高并发多表关联分析。</li>
</ul>
<p><strong>显著收益</strong>：亿级库存流水聚合查询缩短至 8 秒内，运维成本大幅降低，业务高峰期系统运行平稳，为全渠道运营提供可靠的高并发数据分析支撑。</p>
<p>完整阅读：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.selectdb.com%2Fblog%2F1409" target="_blank" title="https://www.selectdb.com/blog/1409" ref="nofollow noopener noreferrer">森马服饰从 Elasticsearch 到阿里云 SelectDB 的架构演进之路</a></p>
<h3 data-id="heading-27">案例二：天眼查（PostgreSQL）</h3>
<p>天眼查是一家数据服务公司，为用户提供超过 3 亿家企业的商业、财务和法务信息查询服务，涵盖 300+ 维度数据。随着业务增长，其尽调平台需要支持内部营销和运营团队的即席查询及用户分群等新需求。<strong>该平台使用 Apache Doris 替换了原有的 Apache Hive、MySQL、Elasticsearch 和 PostgreSQL 混合架构，实现数据写入效率提升 75%，用户分群延迟降低 70%。</strong></p>
<p><strong>在高并发处理场景中</strong>，Apache Doris 的 MPP 架构为平台提供了强大的并发查询支撑能力：</p>
<ul>
<li><strong>即席查询能力</strong>：原架构每次新需求都需要在 Hive 中开发测试数据模型，写入 MySQL 调度任务。现在 Apache Doris 拥有全量明细数据，面对新请求只需配置查询条件即可执行即席查询，仅需低代码配置即可响应新需求。</li>
<li><strong>高效用户分群</strong>：在结果集小于 500 万的用户分群场景中，Apache Doris 能够实现毫秒级响应。通过连续密集的用户 ID 映射优化，用户分群延迟降低 70%，显著提升高并发分群任务处理效率。</li>
<li><strong>统一架构简化</strong>：消除了多组件间的复杂读写操作，无需预定义用户标签，标签可基于任务条件自动生成，大幅简化用户分群流程，提高 A/B 测试的灵活性。</li>
<li><strong>稳定数据写入</strong>：支持每天近 10 亿条新数据流入，使用不同数据模型适配不同场景（MySQL 数据采用 Unique 模型，日志数据采用 Duplicate 模型，DWS 层数据采用 Aggregate 模型）。</li>
</ul>
<p><strong>显著收益</strong>：数据仓库架构更加简单，对开发者和运维人员更加友好，2 个 Apache Doris 集群承载数十 TB 数据，为客户提供实时、准确的企业信息查询服务。</p>
<p>完整阅读：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.selectdb.com%2Fblog%2F86" target="_blank" title="https://www.selectdb.com/blog/86" ref="nofollow noopener noreferrer">秒级数据写入，毫秒查询响应，天眼查基于 Apache Doris 构建统一实时数仓</a></p>
<h3 data-id="heading-28">案例三：宝舵 BOCDOP（TiDB）</h3>
<p>宝舵是宝尊集团旗下商业化独立品牌，拥有 1000 余名技术工程师，为集团 8000+ 员工和全球 450+ 品牌提供电商全渠道数据分析服务。<strong>宝舵早期基于 TiDB 构建实时数仓，随着数据量增长面临处理效率、OLAP 扩展、成本等挑战。通过引入 SelectDB 替换 TiDB，实现写入速度提升 10 倍，成本直降 30% 的显著成效。</strong></p>
<p><strong>在实时更新场景中</strong>，SelectDB 为宝舵提供了强大的实时数据处理能力，特别体现在多源数据同步方面：</p>
<ul>
<li><strong>多源异构数据实时接入</strong>：支持 100+ 业务模块的多渠道数据实时接入，通过 Canal、Mongo-Connector、OGG 等工具获取 MySQL、MongoDB、Oracle 等不同类型业务数据库的 binlog，实现秒级延迟数据同步。</li>
<li><strong>高吞吐实时写入</strong>：利用分区分桶策略与单副本写入机制，在双 11 峰值时段实现每秒百万级数据写入，最高写入速度从 20 万/分提升至 230 万/分，较传统方案提升 10 倍。</li>
<li><strong>流式数据处理</strong>：通过 Kafka + Flink + SelectDB 流式写入能力，将分散在订单、支付、物流等业务模块的数据实时汇聚，数据同步提速 30%。</li>
<li><strong>资源隔离保障</strong>：为"作战室看板"单独分配计算资源组，避免高并发查询与实时写入的资源争用，确保关键业务查询响应时间稳定在 500ms 内。</li>
</ul>
<p><strong>显著收益</strong>：在双 11 等大促期间数据量达平日 30-60 倍的情况下，实现数据供应 0 事故、报表服务可用性 99.9%，查询性能提升 66%，为多渠道电商运营提供稳定的实时数据支撑。</p>
<p>完整阅读：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.selectdb.com%2Fblog%2F1381" target="_blank" title="https://www.selectdb.com/blog/1381" ref="nofollow noopener noreferrer">SelectDB 实时分析性能突出，宝舵成本锐减与性能显著提升的双赢之旅</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Linux开发到底指什么？是什么岗位？做什么的？]]></title>    <link>https://juejin.cn/post/7574320550458654761</link>    <guid>https://juejin.cn/post/7574320550458654761</guid>    <pubDate>2025-11-19T15:50:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574320550458654761" data-draft-id="7574267813735022611" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Linux开发到底指什么？是什么岗位？做什么的？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-19T15:50:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Linux开发到底指什么？是什么岗位？做什么的？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T15:50:19.000Z" title="Wed Nov 19 2025 15:50:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在技术圈，“Linux开发”是一个高频词，但它却像一个多面体，从不同的角度看去，含义截然不同。这让很多初学者甚至从业者感到困惑。本文将为你彻底拆解“Linux开发”，厘清它的不同层面、对应的岗位以及具体工作内容。</p>
<h4 data-id="heading-0"><strong>核心：两个截然不同的层面</strong></h4>
<p>首先，你必须理解“Linux开发”一词涵盖的两个核心层面，这是解开所有疑惑的钥匙：</p>
<ol>
<li><strong>为 Linux 本身而开发——创造和维护平台</strong></li>
<li><strong>在 Linux 之上进行开发——使用平台构建应用</strong></li>
</ol>
<p>它们之间的关系，好比<strong>造车</strong>与<strong>开车</strong>。前者是工程师在设计和制造汽车（Linux系统本身），后者是司机利用汽车将乘客或货物运送到目的地（在Linux上开发应用）。</p>
<hr/>
<h3 data-id="heading-1"><strong>层面一：为 Linux 本身而开发（造车）</strong></h3>
<p>这类开发者的工作是<strong>构建和维护Linux操作系统及其核心生态</strong>。他们是系统的奠基者，是底层技术的掌控者。</p>
<p><strong>1. Linux 内核开发</strong></p>
<ul>
<li><strong>是什么？</strong> 这是最硬核、最核心的部分。开发者直接参与Linux操作系统“内核”的编码工作。内核是操作系统的心脏，负责管理CPU、内存、设备、文件系统和网络等。</li>
<li><strong>岗位名称</strong>： Linux内核开发工程师、系统软件工程师、内核维护者。</li>
<li><strong>做什么？</strong>
<ul>
<li><strong>开发设备驱动程序</strong>：让新的硬件（如显卡、网卡、传感器）能在Linux上工作。</li>
<li><strong>优化调度算法</strong>：管理CPU时间如何分配给无数个进程，提升系统性能和响应速度。</li>
<li><strong>维护文件系统</strong>：开发或改进Ext4, Btrfs, XFS等文件系统，保障数据存储的可靠与高效。</li>
<li><strong>增强网络协议栈</strong>：优化TCP/IP等网络协议的实现，应对高性能计算和超大流量场景。</li>
<li><strong>修复安全漏洞</strong>：响应社区发现的安全问题，及时提交补丁。</li>
</ul>
</li>
<li><strong>所需技能</strong>： <strong>C语言</strong>和<strong>汇编语言</strong>是绝对主力，需要对计算机体系结构、操作系统原理有极其深刻的理解。</li>
</ul>
<p><strong>2. 系统工具与桌面环境开发</strong></p>
<ul>
<li><strong>是什么？</strong> 开发构成Linux发行版（如Ubuntu, CentOS）的其他核心组件。</li>
<li><strong>岗位名称</strong>： 系统软件开发工程师、桌面应用开发工程师。</li>
<li><strong>做什么？</strong>
<ul>
<li>开发GNU核心工具集（如ls, grep, gcc）。</li>
<li>参与开发systemd（初始化系统）、Glibc（C标准库）等关键组件。</li>
<li>为GNOME、KDE等桌面环境开发应用程序和底层库。</li>
</ul>
</li>
<li><strong>所需技能</strong>： C/C++、Python，对Linux系统机制有深入理解。</li>
</ul>
<p><strong>小结</strong>：这个层面的岗位数量相对较少，但技术门槛极高，通常存在于Red Hat、Intel、Google、华为等与底层硬件和系统密切相关的巨头公司，或活跃在开源社区中。</p>
<hr/>
<h3 data-id="heading-2"><strong>层面二：在 Linux 之上进行开发（开车）</strong></h3>
<p>这是<strong>绝大多数</strong>人谈论“Linux开发”时所指的含义，也是就业市场中最主流的岗位。开发者将Linux视为一个<strong>稳定、高效、免费</strong>的开发环境和部署平台。</p>
<p><strong>1. 后端/服务端开发（最主流的领域）</strong></p>
<ul>
<li><strong>是什么？</strong> 开发运行在服务器上的应用程序，我们日常使用的网站、App的所有数据和处理逻辑，都由这些后端服务提供支持。<strong>互联网的基石就建立在Linux服务器之上。</strong></li>
<li><strong>岗位名称</strong>： 后端开发工程师、Java/Python/Go开发工程师、服务端工程师。</li>
<li><strong>做什么？</strong>
<ul>
<li>设计和实现Web API接口，为前端（网页、App）提供数据。</li>
<li>开发业务逻辑，处理用户注册、订单交易、数据查询等。</li>
<li>构建微服务架构，将复杂系统拆分为小型、独立的服务。</li>
<li>与数据库（MySQL, PostgreSQL, Redis）进行交互，优化查询性能。</li>
<li>集成消息队列（Kafka, RabbitMQ）处理异步任务。</li>
</ul>
</li>
<li><strong>为什么用Linux？</strong> 稳定（常年不关机）、高性能、强大的命令行和脚本能力、开源生态丰富、安全性好。</li>
<li><strong>所需技能</strong>：
<ul>
<li><strong>编程语言</strong>： Java, Python, Go, C++, Node.js, PHP。</li>
<li><strong>框架</strong>： Spring Boot (Java), Django/Flask (Python), Gin (Go)。</li>
<li><strong>Linux本身</strong>： 必须熟练掌握常用命令、进程管理、日志查看、性能监控（如top, iostat）。</li>
</ul>
</li>
</ul>
<p><strong>2. 嵌入式Linux开发</strong></p>
<ul>
<li><strong>是什么？</strong> 在为特定功能设计的设备（非通用计算机）中运行定制化的Linux系统，并为其开发应用程序。</li>
<li><strong>岗位名称</strong>： 嵌入式Linux开发工程师、嵌入式软件工程师。</li>
<li><strong>做什么？</strong>
<ul>
<li><strong>移植和定制Linux系统</strong>：为智能电视、路由器、工业机器人、自动驾驶汽车等特定硬件板卡，裁剪和编译一个最适合的Linux系统。</li>
<li><strong>驱动开发</strong>：编写或调试摄像头、触摸屏、传感器等外设的驱动程序。</li>
<li><strong>应用开发</strong>：开发运行在设备上的用户界面或控制程序。</li>
</ul>
</li>
<li><strong>所需技能</strong>： C/C++、操作系统知识、交叉编译、硬件基础、设备树。</li>
</ul>
<p><strong>3. DevOps / SRE（开发与运维的桥梁）</strong></p>
<ul>
<li><strong>是什么？</strong> 这是一类强调自动化和协作的岗位，目标是高效、可靠地交付和运维大规模软件系统。他们的主战场就是Linux服务器集群。</li>
<li><strong>岗位名称</strong>： DevOps工程师、SRE（站点可靠性工程师）、云平台工程师。</li>
<li><strong>做什么？</strong>
<ul>
<li>使用Ansible, SaltStack等工具自动化配置和管理成千上万台Linux服务器。</li>
<li>搭建和维护CI/CD流水线（如Jenkins, GitLab CI），实现自动化构建、测试和部署。</li>
<li>使用Docker容器封装应用，使用Kubernetes编排和管理容器集群。</li>
<li>监控系统健康状况，排查和解决线上故障。</li>
</ul>
</li>
<li><strong>所需技能</strong>： <strong>精通Linux命令和Shell/Python脚本</strong>、容器技术、CI/CD工具、云计算平台（AWS/Aliyun）。</li>
</ul>
<p><strong>4. 云计算与大数据开发</strong></p>
<ul>
<li><strong>是什么？</strong> 所有的云平台（AWS, Google Cloud, 阿里云）的底层虚拟机绝大多数是Linux。大数据框架（Hadoop, Spark）也主要运行在Linux集群上。</li>
<li><strong>岗位名称</strong>： 云计算开发工程师、大数据开发工程师。</li>
<li><strong>做什么？</strong> 开发云原生应用、构建大数据处理平台和数据管道。</li>
<li><strong>所需技能</strong>： 除了编程，还需精通Linux环境下的网络、存储、分布式系统原理。</li>
</ul>
<hr/>
<h3 data-id="heading-3"><strong>总结与对比</strong></h3>








































<table><thead><tr><th align="left">类别</th><th align="left">核心目标</th><th align="left">好比</th><th align="left">主要技术栈</th><th align="left">常见岗位</th></tr></thead><tbody><tr><td align="left"><strong>为Linux开发</strong></td><td align="left">制造和维护操作系统本身</td><td align="left"><strong>造车</strong></td><td align="left">C, 汇编, 内核原理</td><td align="left">内核开发工程师、系统软件工程师</td></tr><tr><td align="left"><strong>在Linux上开发</strong></td><td align="left"><strong>后端/服务端</strong></td><td align="left">用汽车<strong>运营网约车平台</strong></td><td align="left">Java/Python/Go, 框架, 数据库</td><td align="left">后端开发工程师</td></tr><tr><td align="left"/><td align="left"><strong>嵌入式</strong></td><td align="left">为特种车辆<strong>定制控制系统</strong></td><td align="left">C/C++, 交叉编译, 驱动开发</td><td align="left">嵌入式Linux工程师</td></tr><tr><td align="left"/><td align="left"><strong>DevOps/SRE</strong></td><td align="left">建设和管理<strong>整个城市的交通系统</strong></td><td align="left">Shell/Python, Docker, K8s, CI/CD</td><td align="left">DevOps工程师</td></tr></tbody></table>
<h4 data-id="heading-4"><strong>如何入门与准备？</strong></h4>
<p>无论你选择哪个方向，以下都是必备的通用基础：</p>
<ol>
<li><strong>将Linux作为你的主要操作系统</strong>：克服对命令行的恐惧，从Ubuntu、CentOS等发行版开始，每天使用它。</li>
<li><strong>精通Linux命令行和Bash脚本</strong>：这是Linux开发的灵魂。掌握文件操作、文本处理（grep, sed, awk）、进程管理和网络配置。</li>
<li><strong>掌握Git版本控制</strong>：这是现代软件开发的基石，毋庸置疑。</li>
<li><strong>学习一门主力编程语言</strong>：根据你的兴趣方向选择——<strong>后端选Java/Go/Python，底层/嵌入式选C/C++</strong>。</li>
<li><strong>深入理解计算机基础</strong>：操作系统、计算机网络、数据结构和算法，这些知识永远是你技术的压舱石。</li>
</ol>
<p><strong>结论：</strong></p>
<p>当你在招聘网站上看到“熟悉Linux开发”时，<strong>十有八九指的是在Linux环境下进行后端服务、DevOps或嵌入式开发的能力</strong>，而非要求你去修改Linux内核。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Windows开发：一场与指针的共舞，亦是超越它的征程]]></title>    <link>https://juejin.cn/post/7574281453707689990</link>    <guid>https://juejin.cn/post/7574281453707689990</guid>    <pubDate>2025-11-19T15:51:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574281453707689990" data-draft-id="7574281453707673606" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Windows开发：一场与指针的共舞，亦是超越它的征程"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-19T15:51:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Windows开发：一场与指针的共舞，亦是超越它的征程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T15:51:49.000Z" title="Wed Nov 19 2025 15:51:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>当人们问“Windows开发导致指针吗？”或“Windows开发到底指针么？”，这背后其实是一个混合了技术困惑和职业好奇的复杂问题。简单来说，这个问题的内核是：<strong>Windows开发是否是一个整天与令人头疼的指针打交道的岗位？</strong></p>
<p>答案是双重的：<strong>是的，深入理解指针是高级Windows开发的基石；但也不是，因为现代Windows开发已经在很大程度上帮助你管理指针，让你更专注于业务逻辑。</strong></p>
<h4 data-id="heading-0"><strong>一、解码问题：什么是“Windows开发到底指针么？”</strong></h4>
<p>这个问题通常源于以下几点认知：</p>
<ol>
<li><strong>技术传说：</strong> C/C++是Windows的“母语”，而指针是C/C++的灵魂。因此，Windows内核、驱动、高性能应用的开发者必须是玩转指针的大师。</li>
<li><strong>痛苦经历：</strong> 很多初学者或在其他领域的程序员，在接触Windows底层开发时，被野指针、内存访问违规等问题折磨得痛苦不堪，从而形成了“Windows开发 == 指针地狱”的印象。</li>
<li><strong>岗位模糊：</strong> 不清楚“Windows开发工程师”具体做什么，以为他们每天都在<code>malloc</code>和<code>free</code>之间挣扎。</li>
</ol>
<p>所以，这个问题真正的含义是：<strong>“Windows开发这个岗位，是否需要深入理解和频繁操作指针？它的工作内容到底是什么？”</strong></p>
<h4 data-id="heading-1"><strong>二、指针：Windows开发的“内功”</strong></h4>
<p>在Windows开发的某些领域，指针不仅是必需品，更是你必须精通的“内功”。</p>
<p><strong>为什么指针如此重要？</strong></p>
<ol>
<li><strong>性能与直接控制：</strong> Windows内核、图形驱动、游戏、高性能服务器等场景，需要直接操作内存地址来达到极致的性能。指针提供了这种底层能力。</li>
<li><strong>数据结构的核心：</strong> 链表、树、哈希表等复杂数据结构，其实现严重依赖于指针。</li>
<li><strong>与操作系统对话：</strong> 许多Windows API本身就大量使用指针。例如：
<ul>
<li><strong>内存管理：</strong> <code>VirtualAlloc</code>, <code>HeapAlloc</code></li>
<li><strong>字符串操作：</strong> 多字节与宽字符串（<code>LPSTR</code>, <code>LPWSTR</code>）本质上都是字符指针。</li>
<li><strong>函数回调：</strong> 很多API需要你传入一个函数指针，系统在特定事件发生时回调你的函数。</li>
<li><strong>结构体指针：</strong> API经常需要你传入或传出结构体的指针。</li>
</ul>
</li>
</ol>
<p><strong>典型场景：</strong>
如果你是一名<strong>Windows系统级开发工程师</strong>，你的工作可能是开发设备驱动、杀毒软件、文件系统过滤器等。在这里，一个错误的指针操作就可能导致系统的<strong>蓝屏死机</strong>。这时，指针就是你手中最强大也最危险的武器。</p>
<h4 data-id="heading-2"><strong>三、现代Windows开发的演变：从“亲力亲为”到“依赖框架”</strong></h4>
<p>然而，科技在进步。今天的“Windows开发”一词涵盖的范围远比过去广泛。对于大量应用层开发，指针已经从“前台明星”退居为“幕后英雄”。</p>
<ol>
<li>
<p><strong>C# 与 .NET 的崛起：</strong></p>
<ul>
<li><strong>岗位：</strong> <strong>.NET桌面开发工程师</strong>、<strong>WPF/WinForms开发工程师</strong>。</li>
<li><strong>变化：</strong> C#是一种托管语言，它使用“引用”而不是原始指针。虽然引用在概念上类似指针，但 .NET 的垃圾回收器会自动管理内存的生命周期。开发者几乎不再需要手动分配和释放内存，从而从根源上避免了野指针、内存泄漏等经典问题。</li>
<li><strong>工作内容：</strong> 使用 Visual Studio 和 XAML 设计漂亮的UI，处理按钮点击、数据绑定、网络请求等业务逻辑。</li>
</ul>
</li>
<li>
<p><strong>C++ 的现代化：</strong></p>
<ul>
<li><strong>理念：</strong> 即使是使用C++，现代最佳实践也强烈推荐使用 <strong>智能指针</strong>，如 <code>std::unique_ptr</code> 和 <code>std::shared_ptr</code>。</li>
<li><strong>作用：</strong> 智能指针通过RAII机制，在对象超出作用域时自动释放内存。这意味着你不再需要手动调用<code>delete</code>，从而极大地降低了野指针出现的风险。开发者可以更安全地享受C++的性能优势。</li>
</ul>
</li>
<li>
<p><strong>新平台与框架：</strong></p>
<ul>
<li><strong>WinUI 3：</strong> 微软最新的原生UI框架，同时支持C#和C++，倡导现代、安全的开发模式。</li>
<li><strong>.NET MAUI：</strong> 跨平台方案，进一步抽象了底层细节。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-3"><strong>四、“Windows开发”到底是什么岗位？做什么的？</strong></h4>
<p>“Windows开发工程师”不是一个单一的职位，而是一个系列。根据技术栈和领域，主要分为以下几类：</p>
<p><strong>1. 系统底层开发</strong></p>
<ul>
<li><strong>核心技术：</strong> C/C++，汇编语言，Windows Driver Kit</li>
<li><strong>指针依赖度：</strong> ⭐⭐⭐⭐⭐</li>
<li><strong>工作内容：</strong>
<ul>
<li>开发硬件设备驱动、文件系统驱动。</li>
<li>开发安全软件、系统监控工具。</li>
<li>性能分析与优化，深入Windows内核。</li>
</ul>
</li>
<li><strong>特点：</strong> 技术门槛极高，需要对操作系统原理、内存管理、指针有极其深刻的理解。</li>
</ul>
<p><strong>2. 原生桌面应用开发</strong></p>
<ul>
<li><strong>核心技术：</strong> C++ with Win32 API / MFC / WTL, COM</li>
<li><strong>指针依赖度：</strong> ⭐⭐⭐⭐</li>
<li><strong>工作内容：</strong>
<ul>
<li>开发高性能桌面软件，如大型设计软件、音视频处理软件、游戏。</li>
<li>维护传统的企业级桌面应用。</li>
</ul>
</li>
<li><strong>特点：</strong> 仍然需要熟练操作指针和手动管理内存，但对框架的使用可以减轻部分负担。</li>
</ul>
<p><strong>3. 托管桌面应用开发</strong></p>
<ul>
<li><strong>核心技术：</strong> C# with WPF / WinForms / WinUI 3</li>
<li><strong>指针依赖度：</strong> ⭐</li>
<li><strong>工作内容：</strong>
<ul>
<li>开发企业级业务应用、办公软件、工具类软件。</li>
<li>设计复杂的用户界面和数据可视化图表。</li>
<li>与后端Web API进行交互。</li>
</ul>
</li>
<li><strong>特点：</strong> 这是目前市场需求量最大的Windows开发岗位。开发者主要与“引用”和“对象”打交道，几乎不接触原始指针，生产力高。</li>
</ul>
<p><strong>4. 游戏开发</strong></p>
<ul>
<li><strong>核心技术：</strong> C++， DirectX, Unity, Unreal Engine</li>
<li><strong>指针依赖度：</strong> ⭐⭐⭐（引擎层面高，游戏逻辑层面中）</li>
<li><strong>工作内容：</strong>
<ul>
<li>在游戏引擎层面，需要大量使用指针进行资源管理和性能优化。</li>
<li>在游戏逻辑层面，现代引擎和脚本（如C# in Unity, Blueprint in Unreal）降低了对指针的直接操作。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-4"><strong>结论</strong></h3>
<p>所以，“Windows开发到底指针么？”这个问题的最终答案是：</p>
<p><strong>它取决于你选择的赛道。</strong></p>
<ul>
<li>如果你想<strong>深入Windows腹地，驾驭系统底层，追求极致的性能与控制权</strong>，那么<strong>指针是你必须精通、日夜相伴的伙伴</strong>。这条路上充满了挑战，但也充满了技术上的纯粹与力量。</li>
<li>如果你想<strong>快速构建美观、稳定、功能丰富的现代Windows应用程序</strong>，那么你可以选择C#和.NET这条道路。在这里，<strong>指针已经化身为一个可靠、自动化的后台管理系统</strong>，你只需专注于实现业务价值，而无需在指针的泥潭中跋涉。</li>
</ul>
<p>因此，当你考虑成为一名Windows开发工程师时，首先要问自己的是：<strong>“我想成为哪一种？”</strong> 答案是开放的，Windows开发的世界既容纳了底层硬核的剑术大师，也欢迎上层高效的应用构建者。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端跨标签页通信方案（下）]]></title>    <link>https://juejin.cn/post/7574321422399930394</link>    <guid>https://juejin.cn/post/7574321422399930394</guid>    <pubDate>2025-11-19T14:06:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574321422399930394" data-draft-id="7553114436405444660" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端跨标签页通信方案（下）"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-19T14:06:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="168169"/> <meta itemprop="url" content="https://juejin.cn/user/2541726614191528"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端跨标签页通信方案（下）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2541726614191528/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    168169
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T14:06:53.000Z" title="Wed Nov 19 2025 14:06:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>前情</strong></h2>
<p>平时开发很少有接触到有什么需求需要实现跨标签页通信，但最近因为一些变故，不得不重新开始找工作了，其中就有面试官问到一道题，跨标签页怎么实现数据通信，我当时只答出二种，面试完后特意重新查资料，因此有些文章</p>
<h2 data-id="heading-1"><strong>SharedWorker</strong></h2>
<p>共享工作线程可以在多个标签页之间共享数据和逻辑，通过<code>postMessage</code>通信</p>
<p>关键代码如下：</p>
<p>标签页1</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>SharedWorker0<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>SharedWorker0<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"communication"</span>&gt;</span>SharedWorker0.html 发送消息<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// 主线程</span>
    <span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SharedWorker</span>(<span class="hljs-string">'sw.js'</span>);

    <span class="hljs-comment">// 发送消息</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'communication'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
      worker.<span class="hljs-property">port</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">'Hello from Tab:SharedWorker0.html'</span>);
    });
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>标签页2</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>SharedWorker1<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>SharedWorker1<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// 主线程</span>
    <span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SharedWorker</span>(<span class="hljs-string">'sw.js'</span>);

    <span class="hljs-comment">// 接收消息</span>
    worker.<span class="hljs-property">port</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Received:SharedWorker1.html'</span>, e.<span class="hljs-property">data</span>);
    };
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>sw.js关键代码：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> connections = [];

self.<span class="hljs-property">onconnect</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> port = e.<span class="hljs-property">ports</span>[<span class="hljs-number">0</span>];
  connections.<span class="hljs-title function_">push</span>(port);
  
  port.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-comment">// 广播给所有连接的页面</span>
    connections.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> p.<span class="hljs-title function_">postMessage</span>(e.<span class="hljs-property">data</span>));
  };
};
</code></pre>
<p>动图演示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e0c0228ae4343c683796e87bfdaab57~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMTY4MTY5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764166013&amp;x-signature=aLqvm2jY6HVPZLQp2Yedxfha8AQ%3D" alt="20250923_203404.gif" loading="lazy"/></p>
<p><strong>提醒：</strong></p>
<ul>
<li>同源标签才有效</li>
<li>不同页面创建 SharedWorker 时，若指定的脚本路径不同（即使内容相同），会创建不同的 worker 实例</li>
<li>页面与 SharedWorker 之间通过 <strong>MessagePort</strong> 通信，需通过 <code>port.postMessage()</code> 发送消息，通过 <code>port.onmessage</code> 接收消息</li>
<li>SharedWorker 无法访问 DOM、<code>window</code> 对象或页面的全局变量，仅能使用 JavaScript 核心 API 和部分 Web API（如 <code>fetch</code>、<code>WebSocket</code>）</li>
<li>兼容性一般，安卓webview全系不兼容</li>
</ul>
<h2 data-id="heading-2"><strong>Service Worker</strong></h2>
<p>专门用于同源标签页通信的 API，创建一个频道后，所有加入该频道的页面都能收到消息</p>
<p>关键代码如下:</p>
<p>标签页1</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>ServiceWorker0<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>ServiceWorker0<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"sendBtn"</span>&gt;</span>发送消息<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// 注册ServiceWorker</span>
    <span class="hljs-keyword">let</span> swReg;
    navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-title function_">register</span>(<span class="hljs-string">'ServiceWorker.js'</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">reg</span> =&gt;</span> {
        swReg = reg;
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'SW注册成功'</span>);
      });
    
    <span class="hljs-comment">// 发送消息</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'sendBtn'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (swReg &amp;&amp; swReg.<span class="hljs-property">active</span>) {
        swReg.<span class="hljs-property">active</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">'来自页面0的消息'</span>);
      }
    });
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>标签页2</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>ServiceWorker1<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>ServiceWorker1<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// 注册ServiceWorker</span>
    navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-title function_">register</span>(<span class="hljs-string">'ServiceWorker.js'</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'SW注册成功'</span>));
    
    <span class="hljs-comment">// 接收消息</span>
    navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'---- Received:ServiceWorker1.html ----:'</span>,  e.<span class="hljs-property">data</span>);
    });
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>ServiceWorker.js关键代码</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 快速激活</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'install'</span>, <span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> e.<span class="hljs-title function_">waitUntil</span>(self.<span class="hljs-title function_">skipWaiting</span>()));
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'activate'</span>, <span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> e.<span class="hljs-title function_">waitUntil</span>(self.<span class="hljs-property">clients</span>.<span class="hljs-title function_">claim</span>()));

<span class="hljs-comment">// 消息转发</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>, <span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {
  self.<span class="hljs-property">clients</span>.<span class="hljs-title function_">matchAll</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">clients</span> =&gt;</span> {
    clients.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">client</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (client.<span class="hljs-property">id</span> !== e.<span class="hljs-property">source</span>.<span class="hljs-property">id</span>) {
        client.<span class="hljs-title function_">postMessage</span>(e.<span class="hljs-property">data</span>);
      }
    });
  });
});
</code></pre>
<p>演示动图如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13f8ad8243d64980881ab4376f89225e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMTY4MTY5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764166013&amp;x-signature=k99zQTEjMyCrkjJcB5vEyvaCXaw%3D" alt="20250923_212126.gif" loading="lazy"/></p>
<p><strong>提醒：</strong></p>
<ul>
<li>Service Worker 要求页面必须在 <strong>HTTPS 环境</strong> 下运行（<code>localhost</code> 除外，方便本地开发），这是出于安全考虑，防止中间人攻击篡改 Service Worker 脚本</li>
<li>Service Worker 有严格的生命周期（安装、激活、空闲、销毁），一旦注册成功会长期运行在后台，更新 Service Worker 需满足两个条件：</li>
</ul>
<ol>
<li>脚本 URL 不变但内容有差异</li>
<li>需在 <code>install</code> 事件中调用 <code>self.skipWaiting()</code>，并在 <code>activate</code> 事件中调用 <code>self.clients.claim()</code> 让新 Worker 立即生效</li>
</ol>
<ul>
<li>Service Worker 的作用域由注册路径决定，默认只能控制其所在路径及子路径下的页面，例如：<code>/sw.js</code> 可控制全站，<code>/js/sw.js</code> 默认只能控制 <code>/js/</code> 路径下的页面，可通过 <code>scope</code> 参数指定作用域，但不能超出注册文件所在路径的范围</li>
<li>可在浏览器开发者工具的 <strong>Application &gt; Service Workers</strong> 面板进行调试，
• 查看当前运行的 Service Worker 状态
• 强制更新、停止或注销 Worker
• 模拟离线环境</li>
<li>主流浏览器都支持，使用的时候可以通过<a href="https://link.juejin.cn?target=https%3A%2F%2Fjakearchibald.github.io%2Fisserviceworkerready%2F" target="_blank" title="https://jakearchibald.github.io/isserviceworkerready/" ref="nofollow noopener noreferrer">Is service worker ready?</a>，测试兼容性</li>
</ul>
<h2 data-id="heading-3"><strong>window.open + window.opener</strong></h2>
<p>如果标签页是通过<code>window.open</code>打开的，可以直接通过<code>opener</code>属性通信
父窗口，打开子窗口的页面关键代码：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>parent<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>window.open parent<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"openBtn"</span>&gt;</span>打开子窗口<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"sendBtn"</span>&gt;</span>发送消息<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"messageDisplay"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">let</span> childWindow = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">let</span> messageHandler = <span class="hljs-literal">null</span>;
    
    <span class="hljs-comment">// 打开子窗口</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'openBtn'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 如果已有窗口，先关闭</span>
      <span class="hljs-keyword">if</span> (childWindow &amp;&amp; !childWindow.<span class="hljs-property">closed</span>) {
        childWindow.<span class="hljs-title function_">close</span>();
      }
      childWindow = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">open</span>(<span class="hljs-string">'./children.html'</span>, <span class="hljs-string">'childWindow'</span>);
    });

    <span class="hljs-comment">// 发送消息</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'sendBtn'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (childWindow &amp;&amp; !childWindow.<span class="hljs-property">closed</span>) {
	      <span class="hljs-comment">// window.location.origin限制接收域名</span>
        childWindow.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">'Hello child'</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">origin</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">alert</span>(<span class="hljs-string">'请先打开子窗口'</span>);
      }
    });
    
    <span class="hljs-comment">// 接收子窗口的消息</span>
    messageHandler = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (e.<span class="hljs-property">origin</span> === <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">origin</span> &amp;&amp; e.<span class="hljs-property">source</span> !== <span class="hljs-variable language_">window</span>) {
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'messageDisplay'</span>).<span class="hljs-property">textContent</span> = <span class="hljs-string">'收到消息: '</span> + e.<span class="hljs-property">data</span>;
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'父页面收到消息:'</span>, e.<span class="hljs-property">data</span>);
      }
    };
    
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>, messageHandler);
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>通过window.open打开的子页面关键代码：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>children<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>子窗口<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"replyBtn"</span>&gt;</span>回复父窗口<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"messageDisplay"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">let</span> messageHandler = <span class="hljs-literal">null</span>;
    
    <span class="hljs-comment">// 只在页面加载完成后设置消息监听</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">onload</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 接收父页面消息</span>
      messageHandler = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (e.<span class="hljs-property">origin</span> === <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">origin</span> &amp;&amp; e.<span class="hljs-property">source</span> !== <span class="hljs-variable language_">window</span>) {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'子页面收到消息:'</span>, e.<span class="hljs-property">data</span>);
          
          <span class="hljs-comment">// 显示收到的消息</span>
          <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'messageDisplay'</span>).<span class="hljs-property">textContent</span> = <span class="hljs-string">'收到消息: '</span> + e.<span class="hljs-property">data</span>;
          
          <span class="hljs-variable language_">window</span>.<span class="hljs-property">opener</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">'子窗口已收到消息'</span>, e.<span class="hljs-property">origin</span>);
        }
      };
      
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>, messageHandler);
    };
    
    <span class="hljs-comment">// 手动回复按钮</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'replyBtn'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">opener</span>) {
        <span class="hljs-variable language_">window</span>.<span class="hljs-property">opener</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">'来自子窗口的回复'</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">origin</span>);
      }
    });
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p><strong>提醒：</strong></p>
<ul>
<li>允许跨域通信，但必须由开发者显式指定信任的源，避免恶意网站滥用</li>
<li>在事件监听的时候记得判断e.source，避免自己发送的事件自己接收了</li>
<li>若子窗口被关闭，父窗口中对它的引用（如 <code>childWindow</code>）会变成无效对象，调用其方法会报错</li>
<li>window.open使用会有一些限制，最好是在事件中使用，有的浏览器还会有权限提示，需要用户同意才行，若 <code>window.open</code> 被浏览器拦截（非用户主动触发），会返回 <code>null</code>，导致后续通信失败</li>
</ul>
<h2 data-id="heading-4">总结</h2>
<p>面试官有提到Service Worker也可以，我面试完后的查询资料尝试了这些方法，都挺顺利的，就是Service Worker折腾了一会才跑通，使用起来相比前面的一些方式，它稍微复杂一些，我觉得用于消息通信只是它的冰山一角，它有一个主要功能就是用来解决一些耗性能的计算密集任务</p>
<p>个人技术有限，如果你有更好的跨标签页通信方式，期待你的分享，你工作中有遇到这种跨标签页通信的需求么，如果有你用的是哪一种了，期待你的留言</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[只有前端 Leader 才会告诉你：那些年踩过的模块加载失败的坑（二）]]></title>    <link>https://juejin.cn/post/7574270661872812070</link>    <guid>https://juejin.cn/post/7574270661872812070</guid>    <pubDate>2025-11-19T14:18:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574270661872812070" data-draft-id="7574270661872795686" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="只有前端 Leader 才会告诉你：那些年踩过的模块加载失败的坑（二）"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-11-19T14:18:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            只有前端 Leader 才会告诉你：那些年踩过的模块加载失败的坑（二）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T14:18:51.000Z" title="Wed Nov 19 2025 14:18:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近项目准备要发布了，项目有比较多的一些代码提交和修复，发现在生产环境中，偶尔会遇到下面的错误：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">TypeError:</span> Failed <span class="hljs-keyword">to</span> fetch dynamically imported <span class="hljs-keyword">module</span>:
<span class="hljs-symbol">https:</span>//***-dev.***.internal.***.tech/assets/index-DUebgR3_.js

Failed <span class="hljs-keyword">to</span> load <span class="hljs-keyword">module</span> script: Expected a JavaScript-<span class="hljs-built_in">or</span>-Wasm <span class="hljs-keyword">module</span> script 
but the server responded <span class="hljs-keyword">with</span> a MIME type <span class="hljs-keyword">of</span> <span class="hljs-string">"text/html"</span>.
</code></pre>
<p>去做了一些调研，整理了这篇文章</p>
<h2 data-id="heading-0">🔍 问题原因分析</h2>
<h3 data-id="heading-1">1. 根本原因</h3>
<p><strong>Nginx 配置问题</strong>：当浏览器请求不存在的静态资源文件时，nginx 返回了 <code>index.html</code> 而不是 404 错误。</p>
<p>原始的nginx配置：</p>
<pre><code class="hljs language-nginx" lang="nginx">location / {
    try_files $uri $uri/ /index.html;
}
</code></pre>
<p>这个配置作用是让前端路由（比如 <code>/about</code>、<code>/user/profile</code> 这类路径）在刷新或直接访问时不会返回 404，导致所有找不到的文件（包括 <code>/assets/</code> 下的 JS 文件）都返回 <code>index.html</code>（对应MIME type: text/html），但浏览器期望的是 JavaScript 文件。</p>
<h3 data-id="heading-2">2. 触发场景</h3>
<p>我们的触发场景主要是场景A，其他两种也是可能会触发的场景</p>
<h4 data-id="heading-3">场景 A：版本更新后的缓存问题</h4>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 用户访问网站，浏览器缓存了 index.html（引用 index-ABC123.js）
<span class="hljs-bullet">2.</span> 服务器部署新版本，生成新的哈希文件 index-DEF456.js
<span class="hljs-bullet">3.</span> 用户刷新页面，浏览器使用缓存的 HTML，尝试加载已删除的 index-ABC123.js
<span class="hljs-bullet">4.</span> 文件不存在，nginx 返回 index.html
<span class="hljs-bullet">5.</span> 浏览器把 HTML 当作 JS 解析，抛出 TypeError
</code></pre>
<h4 data-id="heading-4">场景 B：部署不完整</h4>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> CI/CD 部署过程中，HTML 文件已更新
<span class="hljs-bullet">2.</span> 某些 chunk 文件因网络问题未完全上传
<span class="hljs-bullet">3.</span> 用户访问时，HTML 引用了不存在的 chunk 文件
<span class="hljs-bullet">4.</span> 触发模块加载错误
</code></pre>
<h4 data-id="heading-5">场景 C：CDN/浏览器缓存不一致</h4>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> CDN 缓存了新版本的 HTML
<span class="hljs-bullet">2.</span> 某些静态资源仍指向旧版本或缓存未更新
<span class="hljs-bullet">3.</span> 导致文件引用不匹配
</code></pre>
<h3 data-id="heading-6">3. 错误链条</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[浏览器请求 /assets/index-DUebgR3_.js] --&gt; B{文件是否存在?}
    B --&gt;|否| C[nginx 执行 try_files]
    C --&gt; D[返回 /index.html]
    D --&gt; E[MIME type: text/html]
    E --&gt; F[浏览器期望: application/javascript]
    F --&gt; G[TypeError: MIME type 不匹配]
</code></pre>
<h2 data-id="heading-7">✅ 解决方案</h2>
<h3 data-id="heading-8">方案 1：修复 Nginx 配置（核心）</h3>
<p><strong>修改内容</strong>：</p>
<pre><code class="hljs language-nginx" lang="nginx">server {
    listen       80;
    server_name  _;

    root   /usr/share/nginx/html;
    index  index.html;

    # 静态资源：找不到返回 404，不返回 index.html
    location /assets/ {
        try_files $uri =404;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # SPA 路由：只对非静态资源路径生效
    location / {
        try_files $uri $uri/ /index.html;
        # 禁用 index.html 缓存，确保用户总是获取最新版本
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # Gzip 压缩
    gzip on;
    gzip_types text/plain text/css application/javascript application/json application/xml image/svg+xml;
    gzip_min_length 1024;
}
</code></pre>
<p><strong>改进点</strong>：</p>
<ul>
<li>✅ <code>/assets/</code> 路径返回真实的 404，避免误返回 HTML</li>
<li>✅ 静态资源设置长期缓存（1年），提升性能</li>
<li>✅ <code>index.html</code> 禁用缓存，防止引用过期的静态资源</li>
<li>✅ 区分 SPA 路由和静态资源路由</li>
</ul>
<h3 data-id="heading-9">📘 SPA 加载流程详解</h3>
<h4 data-id="heading-10">单页应用的完整加载过程</h4>
<p>很多人误以为 SPA 只是"返回 index.html 就完事了"，实际上 <strong>index.html 只是入口，JS 文件才是应用的核心</strong>。</p>
<h5 data-id="heading-11">🔄 完整加载流程（6个步骤）</h5>
<pre><code class="hljs language-bash" lang="bash">用户访问: https://yourapp.com/users/123
    ↓
① 服务器返回 index.html（HTML 入口文件）
    ↓
② 浏览器解析 HTML，发现 &lt;script src=<span class="hljs-string">"/assets/index-DUebgR3_.js"</span>&gt;
    ↓
③ 浏览器自动发起第二个请求: GET /assets/index-DUebgR3_.js
    ↓                           ⚠️ 我们的错误发生在这一步，由于项目更新，打包部署了新的版本，文件的																	<span class="hljs-built_in">hash</span>值也发生了变化，但是本地之前启动项目的缓存请求的还是旧文件，期望																拿到js文件，但是由于服务端找不到，返回了html，就出现了开头的错误
④ 服务器返回 JS 文件（包含 React 应用代码）
    ↓
⑤ 浏览器执行 JS：React 启动，读取 URL (/users/123)
    ↓
⑥ React Router 匹配路由，渲染 &lt;UserProfile <span class="hljs-built_in">id</span>=<span class="hljs-string">"123"</span> /&gt; 组件
</code></pre>
<h5 data-id="heading-12">📄 index.html 和 JS 文件的关系</h5>
<p><strong>index.html 的实际内容</strong>（简化版）：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Innies<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/assets/style-ABC123.css"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"root"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>  <span class="hljs-comment">&lt;!-- ⚠️ 注意：这里是空的！ --&gt;</span>

    <span class="hljs-comment">&lt;!-- ⚠️ 关键：这行代码触发浏览器请求 JS 文件 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/assets/index-DUebgR3_.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p><strong>JS 文件包含真正的应用代码</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// /assets/index-DUebgR3_.js 的内容</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ReactDOM</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">BrowserRouter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>;

<span class="hljs-comment">// 这里才开始渲染页面内容</span>
<span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">render</span>(
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">BrowserRouter</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span>  {/* 包含所有路由、组件、业务逻辑 */}
  <span class="hljs-tag">&lt;/<span class="hljs-name">BrowserRouter</span>&gt;</span></span>,
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'root'</span>)  <span class="hljs-comment">// 找到 HTML 里的 &lt;div id="root"&gt;，开始渲染</span>
);
</code></pre>
<p><strong>关键理解</strong>：</p>
<ul>
<li><code>index.html</code> 只是一个<strong>空壳</strong>（只有一个空的 <code>&lt;div id="root"&gt;</code>）</li>
<li><strong>所有页面内容、路由、组件都在 JS 文件里</strong></li>
<li>没有 JS 文件，页面就是空白，什么都显示不出来</li>
</ul>
<h5 data-id="heading-13">⚠️ 错误发生的位置</h5>
<p><strong>本文档解决的错误发生在第③步</strong>：</p>
<p><strong>正常流程</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">③ 浏览器请求: GET /assets/index-DUebgR3_.js
    ↓
✅ 服务器返回: JavaScript 文件（Content-Type: application/javascript）
    ↓
✅ 浏览器执行 JS，React 启动
    ↓
✅ 页面渲染成功
</code></pre>
<p><strong>错误流程（修复前）</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">③ 浏览器请求: GET /assets/index-DUebgR3_.js
    ↓
❌ 服务器找不到文件（可能是旧版本文件已被删除）
    ↓
❌ Nginx 配置错误：try_files <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ /index.html
    ↓
❌ 返回: index.html 内容（Content-Type: text/html）
    ↓
❌ 浏览器期望 JavaScript，但收到 HTML
    ↓
❌ TypeError: Expected JavaScript but got MIME <span class="hljs-built_in">type</span> <span class="hljs-string">"text/html"</span>
    ↓
❌ React 无法启动，页面白屏或崩溃
</code></pre>
<h5 data-id="heading-14">📊 请求和响应对比</h5>








































<table><thead><tr><th>步骤</th><th>正常情况</th><th>错误情况（修复前）</th></tr></thead><tbody><tr><td><strong>浏览器请求</strong></td><td><code>GET /assets/index-DUebgR3_.js</code></td><td><code>GET /assets/index-DUebgR3_.js</code></td></tr><tr><td><strong>文件状态</strong></td><td>✅ 文件存在</td><td>❌ 文件不存在（旧版本）</td></tr><tr><td><strong>服务器返回</strong></td><td>JavaScript 代码</td><td>❌ index.html 内容</td></tr><tr><td><strong>Content-Type</strong></td><td><code>application/javascript</code></td><td>❌ <code>text/html</code></td></tr><tr><td><strong>浏览器行为</strong></td><td>✅ 执行 JS，渲染页面</td><td>❌ MIME type 不匹配报错</td></tr><tr><td><strong>用户体验</strong></td><td>✅ 页面正常显示</td><td>❌ 白屏或错误提示</td></tr></tbody></table>
<h5 data-id="heading-15">💡 为什么 JS 文件找不到会导致整个应用崩溃？</h5>
<p>因为 JS 文件包含：</p>
<ul>
<li>✅ React 核心代码</li>
<li>✅ 所有组件定义</li>
<li>✅ 路由配置</li>
<li>✅ 状态管理</li>
<li>✅ 业务逻辑</li>
</ul>
<p><strong>没有这个 JS 文件，index.html 只是一个空壳，无法渲染任何内容。</strong></p>
<p>这就像：</p>
<ul>
<li><code>index.html</code> = 汽车的外壳</li>
<li><code>index-DUebgR3_.js</code> = 发动机</li>
<li>没有发动机，汽车就无法启动</li>
</ul>
<h4 data-id="heading-16">🎯 为什么要区分 SPA 路由和静态资源路由？</h4>
<p><strong>问题背景</strong>：
单页应用（SPA）和传统的静态资源服务有本质区别，需要不同的处理策略。</p>
<h5 data-id="heading-17">📘 SPA 路由工作原理</h5>
<p><strong>单页应用（SPA）的核心机制</strong>：</p>
<ol>
<li>
<p><strong>服务器层面</strong>：所有 URL 路径都返回同一个 <code>index.html</code></p>
<pre><code class="hljs language-bash" lang="bash">/users/123    → 服务器返回 index.html
/dashboard    → 服务器返回 index.html
/settings     → 服务器返回 index.html
</code></pre>
</li>
<li>
<p><strong>浏览器层面</strong>：前端路由（如 React Router）解析 URL 并渲染对应组件</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// index.html 加载后，前端路由接管 URL 解析</span>
/users/<span class="hljs-number">123</span>    → <span class="hljs-title class_">React</span> <span class="hljs-title class_">Router</span> 匹配 → &lt;<span class="hljs-title class_">UserProfile</span> id=<span class="hljs-string">"123"</span> /&gt;
<span class="hljs-regexp">/dashboard    → React Router 匹配 → &lt;Dashboard /</span>&gt;
<span class="hljs-regexp">/settings     → React Router 匹配 → &lt;Settings /</span>&gt;
</code></pre>
</li>
</ol>
<p><strong>为什么 <code>/users/123</code> 需要返回 <code>index.html</code>？</strong></p>
<p>典型场景：</p>
<ul>
<li>用户直接在浏览器输入 <code>https://yourapp.com/users/123</code></li>
<li>或在 <code>/users/123</code> 页面刷新浏览器</li>
<li>服务器收到 HTTP 请求：<code>GET /users/123</code></li>
</ul>
<p><strong>如果不返回 <code>index.html</code> 会发生什么？</strong></p>
<pre><code class="hljs language-bash" lang="bash">❌ 服务器在文件系统中找不到 /users/123 文件
❌ 返回 404 错误
❌ 用户看到错误页面，应用无法加载
</code></pre>
<p><strong>返回 <code>index.html</code> 后的完整流程</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 服务器返回 index.html（包含 React 应用的启动代码）
<span class="hljs-bullet">2.</span> 浏览器加载并执行 index.html 中的 JavaScript
<span class="hljs-bullet">3.</span> React 应用启动
<span class="hljs-bullet">4.</span> React Router 读取当前 URL: /users/123
<span class="hljs-bullet">5.</span> 匹配路由规则，渲染 <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">UserProfile</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"123"</span> /&gt;</span></span> 组件
<span class="hljs-bullet">6.</span> 用户看到正确的页面 ✅
</code></pre>
<h5 data-id="heading-18">📊 路由类型对比</h5>























<table><thead><tr><th>类型</th><th>路径示例</th><th>期望行为</th><th>原因</th></tr></thead><tbody><tr><td><strong>SPA 路由</strong></td><td><code>/users/123</code><br/><code>/settings</code><br/><code>/dashboard</code></td><td>返回 <code>index.html</code></td><td>这些是前端路由，由 React Router 处理，服务器没有对应文件</td></tr><tr><td><strong>静态资源</strong></td><td><code>/assets/index-DUebgR3_.js</code><br/><code>/assets/style.css</code><br/><code>/favicon.ico</code></td><td>返回文件或 404</td><td>这些是真实的物理文件，不存在就应该报错</td></tr></tbody></table>
<p><strong>修复前的问题</strong>：</p>
<pre><code class="hljs language-nginx" lang="nginx">location / {
    try_files $uri $uri/ /index.html;  # ❌ 所有路径都用这个规则
}
</code></pre>
<p>这会导致：</p>
<ul>
<li>✅ <code>/users/123</code> → 返回 <code>index.html</code> ✓（正确）</li>
<li>❌ <code>/assets/missing.js</code> → 返回 <code>index.html</code> ✗（错误！应该返回 404）</li>
</ul>
<p><strong>修复后的方案</strong>：</p>
<pre><code class="hljs language-nginx" lang="nginx"># 规则 1：静态资源 - 严格匹配
location /assets/ {
    try_files $uri =404;  # 找不到就返回 404，绝不返回 HTML
}

# 规则 2：SPA 路由 - 兜底方案
location / {
    try_files $uri $uri/ /index.html;  # 找不到才返回 HTML
}
</code></pre>
<p><strong>工作原理</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">请求: /users/123
  ↓ 不匹配 /assets/
  ↓ 进入 location /
  ↓ <span class="hljs-variable">$uri</span> 不存在 → 返回 index.html ✅
  
请求: /assets/index-ABC.js (存在)
  ↓ 匹配 /assets/
  ↓ <span class="hljs-variable">$uri</span> 存在 → 返回文件 ✅
  
请求: /assets/index-OLD.js (不存在)
  ↓ 匹配 /assets/
  ↓ <span class="hljs-variable">$uri</span> 不存在 → 返回 404 ✅（不是 HTML！）
</code></pre>
<p><strong>核心收益</strong>：</p>
<ol>
<li><strong>类型安全</strong>：浏览器期望 JS 文件，就不会收到 HTML 文件</li>
<li><strong>快速失败</strong>：资源缺失立即返回 404，触发前端错误处理（重试/提示）</li>
<li><strong>正确缓存</strong>：静态资源和 HTML 可以设置不同的缓存策略</li>
<li><strong>问题可见</strong>：404 错误可以被监控系统捕获，便于及时发现部署问题</li>
</ol>
<h4 data-id="heading-19">⚠️ 重要说明：404 不是终极解决方案</h4>
<p><strong>返回 404 的作用</strong>：</p>
<pre><code class="hljs language-go" lang="go">❌ 修复前：返回 HTML → MIME <span class="hljs-keyword">type</span> 错误 → 用户看到技术错误 → 无法恢复
✅ 修复后：返回 <span class="hljs-number">404</span> → 触发 <span class="hljs-type">error</span> 事件 → 前端捕获错误 → 自动重试/提示用户
</code></pre>
<p><strong>404 只是让问题"正确地暴露"</strong>，真正的解决方案是 <strong>方案 3 的前端错误处理</strong>：</p>
<ul>
<li>🔄 自动重试加载（处理临时网络问题）</li>
<li>🔄 自动刷新页面（清除过期缓存）</li>
<li>💬 友好的用户提示（引导用户清除缓存）</li>
</ul>
<p><strong>完整的解决链条</strong>：</p>
<pre><code class="hljs language-css" lang="css">文件不存在 
  ↓
nginx 返回 <span class="hljs-number">404</span>（不是 <span class="hljs-selector-tag">HTML</span>）
  ↓
浏览器触发 error 事件
  ↓
前端错误处理器捕获
  ↓
自动重试（<span class="hljs-number">2</span>次）或提示用户清除缓存
  ↓
问题解决 ✅
</code></pre>
<p><strong>三个方案的角色</strong>：</p>

























<table><thead><tr><th>方案</th><th>角色</th><th>作用</th></tr></thead><tbody><tr><td><strong>方案 1 (Nginx)</strong></td><td>🚦 正确的错误信号</td><td>让错误以正确的方式暴露（404 而非 HTML）</td></tr><tr><td><strong>方案 2 (Vite)</strong></td><td>🛡️ 减少问题发生</td><td>优化构建，减少 chunk 文件数量和依赖复杂度</td></tr><tr><td><strong>方案 3 (前端)</strong></td><td>🔧 自动修复</td><td>捕获错误并自动恢复，用户无感知或有友好提示</td></tr></tbody></table>
<p><strong>根本性的预防措施</strong>（见后文"预防措施"章节）：</p>
<ul>
<li>✅ 禁用 <code>index.html</code> 缓存</li>
<li>✅ 原子性部署（避免文件不完整）</li>
<li>✅ 保留旧版本静态资源（避免缓存引用失效）</li>
</ul>
<h3 data-id="heading-20">方案 2：优化 Vite 构建配置</h3>
<p><strong>修改内容</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(<span class="hljs-function">(<span class="hljs-params">{ mode }</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">build</span>: {
      <span class="hljs-attr">rollupOptions</span>: {
        <span class="hljs-attr">output</span>: {
          <span class="hljs-attr">manualChunks</span>: {
            <span class="hljs-comment">// 拆分大型依赖，减少单个文件失败的影响</span>
            <span class="hljs-string">'react-vendor'</span>: [<span class="hljs-string">'react'</span>, <span class="hljs-string">'react-dom'</span>, <span class="hljs-string">'react-router-dom'</span>],
            <span class="hljs-string">'ui-vendor'</span>: [<span class="hljs-string">'@zhiman/design'</span>, <span class="hljs-string">'framer-motion'</span>, <span class="hljs-string">'lucide-react'</span>],
          },
        },
      },
      <span class="hljs-attr">assetsDir</span>: <span class="hljs-string">'assets'</span>,
      <span class="hljs-attr">chunkSizeWarningLimit</span>: <span class="hljs-number">1000</span>,
    },
    <span class="hljs-comment">// ... 其他配置</span>
  };
});
</code></pre>
<p><strong>改进点</strong>：</p>
<ul>
<li>✅ 合理拆分 chunk，避免单个巨大文件</li>
<li>✅ 减少动态导入失败的影响范围</li>
<li>✅ 提升首屏加载速度</li>
</ul>
<h3 data-id="heading-21">方案 3：添加前端错误处理</h3>
<p><strong>新增文件</strong>：<code>src/utils/moduleLoadErrorHandler.ts</code></p>
<p><strong>核心功能</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">setupModuleLoadErrorHandler</span>(<span class="hljs-params"/>): <span class="hljs-built_in">void</span> {
  <span class="hljs-comment">// 监听全局错误</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
    <span class="hljs-comment">// 检测模块加载错误</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isModuleLoadError</span>(event.<span class="hljs-property">message</span>)) {
      <span class="hljs-comment">// 自动重试（最多 2 次）</span>
      <span class="hljs-keyword">if</span> (reloadCount &lt; <span class="hljs-variable constant_">MAX_RELOAD_ATTEMPTS</span>) {
        sessionStorage.<span class="hljs-title function_">setItem</span>(<span class="hljs-variable constant_">RELOAD_KEY</span>, <span class="hljs-title class_">String</span>(reloadCount + <span class="hljs-number">1</span>));
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-title function_">reload</span>(), <span class="hljs-number">500</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 显示友好的错误提示</span>
        <span class="hljs-title function_">showErrorUI</span>();
      }
    }
  });
}
</code></pre>
<p><strong>特性</strong>：</p>
<ul>
<li>✅ 自动检测模块加载失败</li>
<li>✅ 智能重试机制（最多 2 次）</li>
<li>✅ 友好的用户提示界面</li>
<li>✅ 一键清除缓存并重新加载</li>
<li>✅ 防止无限重载循环</li>
</ul>
<p><strong>使用方式</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/main.tsx</span>
<span class="hljs-keyword">import</span> { setupModuleLoadErrorHandler } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils/moduleLoadErrorHandler'</span>;

<span class="hljs-title function_">setupModuleLoadErrorHandler</span>();
</code></pre>
<h2 data-id="heading-22">📊 效果对比</h2>
<h3 data-id="heading-23">修复前</h3>
<pre><code class="hljs">用户体验：❌ 白屏 / 加载失败
错误信息：❌ 技术性错误提示
恢复方式：❌ 用户需要手动清除缓存
影响范围：❌ 版本更新时频繁出现
</code></pre>
<h3 data-id="heading-24">修复后</h3>
<pre><code class="hljs">用户体验：✅ 自动重试 / 友好提示
错误信息：✅ 用户友好的提示界面
恢复方式：✅ 自动重试 + 一键清除缓存
影响范围：✅ 大幅减少错误发生率
</code></pre>
<ul>
<li>
<h2 data-id="heading-25">💡 总结与建议</h2>
<h3 data-id="heading-26">问题本质</h3>
<p>说白了就是：<strong>旧文件找不到了，Nginx 配置有问题，返回了错的东西。</strong></p>
<p>用户浏览器缓存的旧 HTML 里写着"去加载 <code>index-ABC123.js</code>"，但服务器上这个文件早删了。正常情况应该返回 404，但 Nginx 配置写错了，返回了一个 HTML 页面。浏览器期望拿到 JS 文件，结果拿到 HTML，直接懵了，抛错。</p>
<h3 data-id="heading-27">解决思路很简单</h3>
<p><strong>核心就一句话：让 Nginx 该返回 404 就返回 404，别瞎返回 HTML。然后前端监听到 404 错误，自动刷新页面就行了。</strong></p>
<p>三个方案其实就是围绕这个思路：</p>
<ol>
<li><strong>改 Nginx</strong>：找不到文件就老老实实返回 404，别整那些花里胡哨的</li>
<li><strong>前端兜底</strong>：监听加载失败，自动重试或者刷新页面，用户基本无感</li>
<li><strong>优化打包</strong>：把文件拆小点，减少出问题的概率</li>
</ol>
<h3 data-id="heading-28">为什么这么简单的问题会困扰这么久？</h3>
<p>因为大多数人（包括我们一开始）都把 Nginx 配置写成了：</p>
<p>nginx</p>
<pre><code class="hljs language-nginx" lang="nginx">location / {
    try_files $uri $uri/ /index.html;  # 啥都找不到就返回 HTML
}
</code></pre>
<p>这个配置的本意是支持 SPA 前端路由，但副作用是<strong>连静态资源文件找不到也返回 HTML</strong>，这就埋了个大坑。</p>
<h3 data-id="heading-29">三个方案的优先级</h3>
<p>如果时间紧迫，只能先做一个，建议顺序是：</p>
<ol>
<li><strong>先改 Nginx</strong>（5分钟搞定，治本）</li>
<li><strong>再加前端兜底</strong>（半小时搞定，救急）</li>
<li><strong>最后优化构建</strong>（锦上添花，可选）</li>
</ol>
<h3 data-id="heading-30">一些踩坑经验</h3>
<p><strong>关于 Nginx 配置：</strong></p>
<ul>
<li>静态资源目录（<code>/assets/</code>）要单独配置，找不到就返回 404</li>
<li>测试方法：直接浏览器访问一个不存在的 <code>/assets/xxx.js</code>，看返回的是不是 404</li>
<li>别偷懒，该分开配置就分开配置</li>
</ul>
<p><strong>关于缓存策略：</strong></p>
<ul>
<li><code>index.html</code> 千万别缓存，或者设置较短时间的缓存，</li>
<li>这是问题的根源</li>
<li>静态资源随便缓存，文件名带 hash，不会冲突</li>
<li>CDN 的缓存规则要和 Nginx 保持一致</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[剑指offer-39、平衡⼆叉树]]></title>    <link>https://juejin.cn/post/7574270661872844838</link>    <guid>https://juejin.cn/post/7574270661872844838</guid>    <pubDate>2025-11-19T14:21:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574270661872844838" data-draft-id="7572497847770628123" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="剑指offer-39、平衡⼆叉树"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-11-19T14:21:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            剑指offer-39、平衡⼆叉树
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T14:21:34.000Z" title="Wed Nov 19 2025 14:21:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">题⽬描述</h2>
<p>输⼊⼀棵节点数为 n ⼆叉树，判断该⼆叉树是否是平衡⼆叉树。</p>
<p>在这⾥，我们只需要考虑其平衡性，不需要考虑其是不是排序⼆叉树</p>
<p>平衡⼆叉树（ Balanced Binary Tree ），具有以下性质：它是⼀棵空树或它的左右两个⼦树的⾼度差的绝对值不超过 1 ，并且左右两个⼦树都是⼀棵平衡⼆叉树。</p>
<p>样例解释：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/115a10d767fd4113a84ccf6e865756fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764166894&amp;x-signature=lLsSiREZJAeRrD02LbjeWUOVvqk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">思路及解答</h2>
<h3 data-id="heading-2">自顶向下递归（基础解法）</h3>
<p>平衡树意味着我们需要对⽐任何在同⼀个根下的左右⼦树的⾼度差，还记得之前我们计算树的⾼度么，使⽤递归⽅式来解决，其实这道题与算⾼度差不多，只是两边⾼度需要算出⼀个差值。</p>
<p>算法的主要思想：</p>
<ul>
<li>不断对⽐每两个节点的左右⼦树的最⼤⾼度差，注意取差的绝对值，需要⼩于等于1</li>
<li>对⽐完左右⼦树之后，需要递归左⼦树以及右⼦树进⾏分别判断，都满⾜才是平衡树</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution79</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">IsBalanced_Solution</span><span class="hljs-params">(TreeNode root)</span> {
        <span class="hljs-keyword">if</span> (root == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        <span class="hljs-comment">// 当前左右⼦树是否平衡以及左右⼦树分别是否平衡</span>
        <span class="hljs-keyword">return</span> Math.abs(depth(root.left) - depth(root.right)) &lt;= <span class="hljs-number">1</span> &amp;&amp;
            IsBalanced_Solution(root.left) &amp;&amp; IsBalanced_Solution(root.right);
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">depth</span><span class="hljs-params">(TreeNode root)</span> {
        <span class="hljs-keyword">if</span> (root == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }
        <span class="hljs-comment">// 递归获取深度</span>
        <span class="hljs-keyword">return</span> Math.max(depth(root.left), depth(root.right)) + <span class="hljs-number">1</span>;
    }
}
</code></pre>
<ul>
<li>时间复杂度 O(nlogn) ：最差情况下，需要遍历树所有节点判断是否平衡，需要O(n)。但是判断每个节点最⼤⾼度需要递归左右⼦树，需要占⽤ O(log2n) ，所以总共占⽤ O(Nlog2n)</li>
<li>空间复杂度 O(n) ：最差情况下，也就是树退化为链表时，递归需要使⽤ O(n) 的栈空间，严格意义上递归栈也需要空间。</li>
</ul>
<h3 data-id="heading-3">自底向上递归（优化解法）</h3>
<p>上⾯的计算，仔细观察就会发现会有很多重复计算的过程，⽐如下⾯的数，计算⼦树深度的时候，计算 1 的左⼦树，和计算 2 的，基本都重复了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c16cee843a1642648ddf18e1ea8e828b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764166894&amp;x-signature=%2B3VOdWzJvB2Zjxio%2FjJBNkPK4eI%3D" alt="" loading="lazy"/></p>
<p>应该如何避免这种重复计算呢？前⾯的是⾃顶向下的⽅式，因为每个节点都得把⼦树计算⼀遍才需要重复，如果我们从下往上计算，那不就避免了重复计算。后序遍历，先判断子树平衡性，再判断当前节点，对⽐逻辑如下：</p>
<ul>
<li>如果当前节点为空，⾼度为0</li>
<li>如果当前节点的左⼦树的⾼度为-1，那么说明不平衡，否则，需要计算右⼦树⾼度，同样需要不等于-1，如果两者的差不符合⼩于等于1，那么说明它们不平衡，返回-1。通过这样 -1 异常值就会⼀路返回，到最初的调⽤处，得到不平衡的结果。</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution79</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">IsBalanced_Solution</span><span class="hljs-params">(TreeNode root)</span> {
        <span class="hljs-comment">// 空树</span>
        <span class="hljs-keyword">if</span> (root == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> getHeight(root) != -<span class="hljs-number">1</span>;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getHeight</span><span class="hljs-params">(TreeNode root)</span> {
        <span class="hljs-keyword">if</span> (root == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<span class="hljs-comment">//空节点高度为0</span>
        }
        <span class="hljs-comment">// 左⼦树的⾼度</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">left</span> <span class="hljs-operator">=</span> getHeight(root.left);
        <span class="hljs-keyword">if</span> (left &lt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;<span class="hljs-comment">//左子树不平衡，直接返回</span>
        }
        <span class="hljs-comment">// 右⼦树的⾼度</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">right</span> <span class="hljs-operator">=</span> getHeight(root.right);
        <span class="hljs-keyword">if</span> (right &lt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;<span class="hljs-comment">//右子树不平衡，直接返回</span>
        }
        
        <span class="hljs-comment">// 检查当前节点是否平衡</span>
        <span class="hljs-keyword">return</span> Math.abs(left - right) &gt; <span class="hljs-number">1</span> ? -<span class="hljs-number">1</span> : <span class="hljs-number">1</span> + Math.max(left, right);
    }
}
</code></pre>
<ul>
<li>时间复杂度 O(n) ：每个节点计算⼀次</li>
<li>空间复杂度 O(n) ：递归需要使⽤额外堆栈空间</li>
</ul>
<p>笔试面试时，建议首选这个方式，效率最优，代码简洁</p>
<h3 data-id="heading-4">封装信息法（面向对象思路）</h3>
<p>通过自定义类同时返回高度和平衡信息，代码结构更清晰。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BalanceInfo</span> {
    <span class="hljs-type">boolean</span> isBalanced;
    <span class="hljs-type">int</span> height;
    
    BalanceInfo(<span class="hljs-type">boolean</span> isBalanced, <span class="hljs-type">int</span> height) {
        <span class="hljs-built_in">this</span>.isBalanced = isBalanced;
        <span class="hljs-built_in">this</span>.height = height;
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isBalanced</span><span class="hljs-params">(TreeNode root)</span> {
        <span class="hljs-keyword">return</span> checkBalance(root).isBalanced;
    }
    
    <span class="hljs-keyword">private</span> BalanceInfo <span class="hljs-title function_">checkBalance</span><span class="hljs-params">(TreeNode node)</span> {
        <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BalanceInfo</span>(<span class="hljs-literal">true</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// 空节点平衡且高度为0</span>
        }
        
        <span class="hljs-comment">// 递归检查左右子树</span>
        <span class="hljs-type">BalanceInfo</span> <span class="hljs-variable">leftInfo</span> <span class="hljs-operator">=</span> checkBalance(node.left);
        <span class="hljs-type">BalanceInfo</span> <span class="hljs-variable">rightInfo</span> <span class="hljs-operator">=</span> checkBalance(node.right);
        
        <span class="hljs-comment">// 如果子树不平衡，直接返回</span>
        <span class="hljs-keyword">if</span> (!leftInfo.isBalanced || !rightInfo.isBalanced) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BalanceInfo</span>(<span class="hljs-literal">false</span>, -<span class="hljs-number">1</span>); <span class="hljs-comment">// 高度值此时不重要</span>
        }
        
        <span class="hljs-comment">// 检查当前节点是否平衡</span>
        <span class="hljs-keyword">if</span> (Math.abs(leftInfo.height - rightInfo.height) &gt; <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BalanceInfo</span>(<span class="hljs-literal">false</span>, -<span class="hljs-number">1</span>);
        }
        
        <span class="hljs-comment">// 返回当前节点的平衡信息和高高度</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">currentHeight</span> <span class="hljs-operator">=</span> Math.max(leftInfo.height, rightInfo.height) + <span class="hljs-number">1</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BalanceInfo</span>(<span class="hljs-literal">true</span>, currentHeight);
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TypeScript 简史：它是怎么拯救我的烂代码的]]></title>    <link>https://juejin.cn/post/7574321422399963162</link>    <guid>https://juejin.cn/post/7574321422399963162</guid>    <pubDate>2025-11-19T14:25:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574321422399963162" data-draft-id="7574289653177679910" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" TypeScript 简史：它是怎么拯救我的烂代码的"/> <meta itemprop="keywords" content="TypeScript,JavaScript"/> <meta itemprop="datePublished" content="2025-11-19T14:25:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             TypeScript 简史：它是怎么拯救我的烂代码的
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T14:25:04.000Z" title="Wed Nov 19 2025 14:25:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">看烂代码的场景</h2>
<p>接手老旧 JavaScript 项目的时候，盯着屏幕上的一行代码发呆，这种绝望你一定体会过：</p>
<p>JavaScript</p>
<pre><code class="hljs language-kotlin" lang="kotlin">function process(<span class="hljs-keyword">data</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">data</span>.value + <span class="hljs-number">10</span>; <span class="hljs-comment">// 此时 data 是 undefined，程序崩了</span>
}
</code></pre>
<p>看着这个 <code>data</code>，我满脑子都是问号：</p>
<ul>
<li>它是对象还是数字？</li>
<li>到底是谁传进来的？</li>
<li>我要是改了它，会不会导致隔壁模块的页面挂掉？</li>
<li>为什么明明是字符串 <code>'10'</code>，结果拼成了 <code>'1010'</code>？</li>
</ul>
<p>这时候我就在想，要是代码能自己告诉我“我是谁，我从哪里来，我要去哪里”，该多好。</p>
<p>这就是 TypeScript 诞生的意义。它不是微软为了炫技造的轮子，而是为了解决 JavaScript 在大规模应用中“失控”的必然选择。</p>
<hr/>
<h2 data-id="heading-1">为什么我们需要 TypeScript？</h2>
<h3 data-id="heading-2">JavaScript 的“娘胎顽疾”</h3>
<p>JavaScript 诞生的时候，Brendan Eich 只用了 10 天。这事儿说穿了挺传奇，但也留下了隐患。</p>
<p>当时的场景很简单：验证一下表单，改改页面背景色。所以它的设计哲学是 <strong>“怎么方便怎么来”</strong> ：</p>
<p>JavaScript</p>
<pre><code class="hljs language-ini" lang="ini">var <span class="hljs-attr">data</span> = <span class="hljs-string">"hello"</span><span class="hljs-comment">;</span>
<span class="hljs-attr">data</span> = <span class="hljs-number">123</span><span class="hljs-comment">;           // 随便改类型，没事</span>
<span class="hljs-attr">data.abcd</span> = <span class="hljs-string">"what?"</span><span class="hljs-comment">;  // 随便加属性，也不报错</span>
</code></pre>
<p>这种“自由”在写几十行代码时是天堂，但在写几十万行代码时就是地狱。</p>
<h3 data-id="heading-3">事情是怎么失控的？</h3>
<p>随着 <strong>Ajax</strong> 和 <strong>Node.js</strong> 的出现，前端不再是画页面的，而是写应用程序的。</p>
<p>想想也是，当代码量从 500 行变成 50,000 行，团队从 1 个人变成 20 个人：</p>
<ul>
<li>你写的 <code>getUser(id)</code>，同事调用时传了个对象。</li>
<li>后端 API 偷偷改了一个字段名，前端只有等到用户点击报错了才知道。</li>
<li>重构？别逗了，改一行代码，心里都要祈祷半天。</li>
</ul>
<p>问题的根源在于 <strong>JavaScript 是动态弱类型</strong>。它在运行前完全不知道自己错了，非要等到撞了南墙（报错）才回头。</p>
<hr/>
<h2 data-id="heading-4">它是怎么解决问题的？</h2>
<h3 data-id="heading-5">核心思路：给 JS 穿上铠甲</h3>
<p>TypeScript 的原理说穿了挺简单：<strong>它就是给 JavaScript 加上了类型约束，但在运行前又把这些约束脱得干干净净。</strong></p>
<p>看个流程图就明白了：</p>
<p>代码段</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[TypeScript源码] --&gt;|编译/检查| B(类型检查器)
    B -- 报错 --&gt; C[修复代码]
    B -- 通过 --&gt; D[抹除类型信息]
    D --&gt; E[纯净的JavaScript]
    E --&gt; F[浏览器/Node运行]
</code></pre>
<h3 data-id="heading-6">巧妙的“超集”策略</h3>
<p>微软的大神 Anders Hejlsberg（这也是 C# 之父）非常聪明。他知道如果搞一门新语言，开发者肯定不买账（看看 Google 的 Dart 就知道了）。</p>
<p>所以他搞了个 <strong>“超集（Superset）”</strong> 策略：</p>
<ol>
<li><strong>向后兼容</strong>：任何合法的 JavaScript 代码，直接粘贴进 TypeScript 文件，它都能跑。你不需要重写代码。</li>
<li><strong>类型擦除</strong>：TS 编译后就是普通的 JS。浏览器根本不知道 TS 的存在，不用装任何插件。</li>
</ol>
<p>TypeScript</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// TypeScript 写法</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">return</span> a + b;
}

<span class="hljs-comment">// 编译出来的 JavaScript（类型全没了）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>) {
    <span class="hljs-keyword">return</span> a + b;
}
</code></pre>
<p>这招“瞒天过海”非常高明，既让你爽了（有类型检查），又让浏览器爽了（只认 JS）。</p>
<hr/>
<h2 data-id="heading-7">为什么 TS 能赢？（深度分析）</h2>
<p>在 TS 出来之前，Google 的 Closure 和 Dart，甚至 Facebook 的 Flow 都尝试过解决这个问题。为什么最后是 TypeScript 统一了江湖？</p>
<h3 data-id="heading-8">对比分析</h3>
<p>我们来看看这张技术演进图：</p>
<p>代码段</p>
<pre><code class="hljs language-mermaid" lang="mermaid">timeline
    title 前端类型探索之路
    2009 : Closure Compiler : 注释太繁琐
    2009 : CoffeeScript : 语法糖，无类型
    2011 : Dart : 甚至想换掉JS虚拟机
    2012 : TypeScript 诞生 : 拥抱JS，做超集
    2014 : Angular 宣布采用 TS
    2016 : VS Code 崛起
    2023 : 统治地位确立
</code></pre>
<h3 data-id="heading-9">TypeScript 胜出的关键点</h3>
<ol>
<li>
<p>工具链的降维打击</p>
<p>这点必须得吹一下 VS Code。VS Code 是用 TS 写的，它对 TS 的支持简直是原生级的。</p>
<ul>
<li><strong>智能补全</strong>：你打个点 <code>.</code>，属性全出来了，不用去翻文档。</li>
<li><strong>重构神器</strong>：按 F2 重命名一个变量，整个项目几百个文件里的引用全改好了。</li>
</ul>
</li>
<li>
<p>渐进式的温柔</p>
<p>CoffeeScript 和 Dart 要求你“学会新语法，忘掉旧习惯”。</p>
<p>TypeScript 说：“没事，你先用 any 凑合着，等有空了再补类型。”这种低门槛让很多老项目敢于尝试迁移。</p>
</li>
<li>
<p>生态圈的马太效应</p>
<p>现在你装个第三方库，如果没有自带 TypeScript 类型定义（d.ts），大家都会觉得这个库“不正规”。Angular、Vue3、React 全部深度拥抱 TS。</p>
</li>
</ol>
<h3 data-id="heading-10">潜在的坑</h3>
<p>当然，TS 也不是银弹，这里要注意几个软肋：</p>
<ul>
<li><strong>AnyScript 现象</strong>：很多新手遇到类型报错就写 <code>any</code>，结果写成了“带编译过程的 JavaScript”，完全失去了类型的意义。</li>
<li><strong>体操级类型</strong>：有时候为了描述一个复杂的动态结构，类型定义写得比业务逻辑还长，人称“类型体操”。</li>
<li><strong>编译时间</strong>：项目大了以后，<code>tsc</code> 跑一遍确实挺慢的（虽然现在有了 SWC/Esbuild 等加速方案）。</li>
</ul>
<hr/>
<h2 data-id="heading-11">写在最后</h2>
<p>TypeScript 的成功告诉我们要顺势而为。它没有试图颠覆 JavaScript，而是承认了 JS 的混乱，然后提供了一套工具来管理这种混乱。</p>
<p>下次当你接手一个全是 <code>any</code> 的 TS 项目时，你会知道：</p>
<ul>
<li>这哥们儿可能是在迁移初期。</li>
<li>或者他只是单纯的懒。</li>
<li><strong>最重要的</strong>：至少你还能重构，因为编译器会教你做人。</li>
</ul>
<p>如果你的团队还在用纯 JS 裸奔，<strong>赶紧试试 TS 吧</strong>。哪怕只是为了那个“点一下能出属性提示”的爽快感，也值了。</p>
<hr/>
<p><strong>相关文档</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.typescriptlang.org%2Fdocs%2F" target="_blank" title="https://www.typescriptlang.org/docs/" ref="nofollow noopener noreferrer">TypeScript 官方手册</a> - 最权威的文档。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fbasarat.gitbook.io%2Ftypescript%2F" target="_blank" title="https://basarat.gitbook.io/typescript/" ref="nofollow noopener noreferrer">TypeScript Deep Dive</a> - 很多底层原理讲得很透。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 Flink 到 Doris 的实时数据写入实践——基于 Flink CDC 构建更实时高效的数据集成链路]]></title>    <link>https://juejin.cn/post/7574244766424465417</link>    <guid>https://juejin.cn/post/7574244766424465417</guid>    <pubDate>2025-11-19T14:35:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574244766424465417" data-draft-id="7574270661872746534" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 Flink 到 Doris 的实时数据写入实践——基于 Flink CDC 构建更实时高效的数据集成链路"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2025-11-19T14:35:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SelectDB"/> <meta itemprop="url" content="https://juejin.cn/user/3189021726222904"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 Flink 到 Doris 的实时数据写入实践——基于 Flink CDC 构建更实时高效的数据集成链路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3189021726222904/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SelectDB
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T14:35:21.000Z" title="Wed Nov 19 2025 14:35:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Flink-Doris-Connector 作为 Apache Flink 与 Doris 之间的桥梁，打通了实时数据同步、维表关联与高效写入的关键链路。本文将深入解析 Flink-Doris-Connector 三大典型场景中的设计与实现，并结合 Flink CDC 详细介绍了整库同步的解决方案，助力构建更加高效、稳定的实时数据处理体系。</p>
<h2 data-id="heading-0">一、Apache Doris 简介</h2>
<p>Apache Doris 是一款基于 MPP 架构的高性能、实时的分析型数据库，整体架构精简，只有 FE 、BE 两个系统模块。其中 FE 主要负责接入请求、查询解析、元数据管理和任务调度，BE 主要负责查询执行和数据存储。Apache Doris 支持标准 SQL 并且完全兼容 MySQL 协议，可以通过各类支持 MySQL 协议的客户端工具和 BI 软件访问存储在 Apache  Doris 中的数据库。</p>
<p>在典型的数据集成和处理链路中，往往会对 TP 数据库、用户行为日志、时序性数据以及本地文件等数据源进行采集，经由数据集成工具或者 ETL 工具处理后写入至实时数仓 Apache Doris 中，并由 Doris 对下游数据应用提供查询和分析，例如典型的 BI 报表分析、OLAP 多维分析、Ad-hoc 即席查询以及日志检索分析等多种数据应用场景。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/405407dd99ad46cdb8441a721b3ee8e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167721&amp;x-signature=M672N75c%2B%2F8T3mTUtXqmqhqluEI%3D" alt="Apache Doris 简介 .PNG" loading="lazy"/></p>
<p>Flink-Doris-Connector 是 Apache Doris 与 Apache Flink 在实时数据处理 ETL 的结合，依托 Flink 提供的实时计算能力，构建高效的数据处理和分析链路。Flink-Doris-Connector 的使用场景主要分为三种：</p>
<ol>
<li><strong>Scan</strong>：通常用来做数据同步或是跟其他数据源的联合分析；</li>
<li><strong>Lookup Join</strong>：将实时流中的数据和 Doris 中的维度表进行 Join；</li>
<li><strong>Real-time ETL</strong>：使用 Flink 清洗数据再实时写入 Doris 中。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e6c4300c02a41afb3c62f22d7150902~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167721&amp;x-signature=osqqy1D7DXJ8L8uL9P5irAfJW6g%3D" alt="Apache Doris 简介 -2.PNG" loading="lazy"/></p>
<h2 data-id="heading-1">二、Flink-Doris-Connector 典型场景的设计与实现</h2>
<p>本章节结合 Scan、Lookup Join、Write 这三种场景，介绍 Flink-Doris-Connector 的设计与实现。</p>
<h3 data-id="heading-2">01 Scan 场景</h3>
<p>Scan 场景指将 Doris 中的存量数据快速提取出来，当从 Doris 中读取大量数据时，使用传统的 JDBC 方法可能会面临性能瓶颈。因此 Flink-Doris-Connector 中可以借助 Doris Source ，充分利用 Doris 的分布式架构和 Flink 的并行处理能力，从而实现了更高效的数据同步。</p>
<h4 data-id="heading-3">Doris Source 读取流程</h4>
<ul>
<li>Job Manager 向 FE 端发起请求查询计划，FE 会返回要查询的数据对应的 BE 以及 Tablet；</li>
<li>根据不同的 BE，将请求分发给不同的 TaskManager；</li>
<li>通过 Task Manager 直接读取每个 BE 上对应 Tablet 的数据。</li>
</ul>
<p>通过这种方式，我们可以利用 Flink 分布式处理的能力从而提高整个数据同步的效率。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e68bd5321f74e3fbf4d6d2c790a2e26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167721&amp;x-signature=aVV07P%2BPiS3ZFL9J87euX01YYw8%3D" alt="Doris Source 读取流程.PNG" loading="lazy"/></p>
<h3 data-id="heading-4">02 Lookup Join 场景</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0e7362f40c64379b74978b4fc3e5d99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167721&amp;x-signature=AuKUSritBtH1w9okDh6uTaV8pzM%3D" alt="Lookup Join 场景.PNG" loading="lazy"/></p>
<p>对于维度表存储在 Doris 中的场景，可通过 Lookup Join 实现对实时流数据与 Doris 维度表的关联查询。</p>
<h4 data-id="heading-5">JDBC Connector</h4>
<p>Doris 支持 MySQL 协议，所以可以直接使用 JDBC Connector 进行 Lookup Join，但是这一方式存在一定的局限：</p>
<ul>
<li>Jdbc Connector 中的 Lookup Join 是同步查询的操作，会导致实时流中每条数据都要等待 Doris 查询的结果，增加了延迟。</li>
<li>仅支持单条数据查询，在上游数据量吞吐较高时，容易造成性能瓶颈和反压。</li>
</ul>
<h4 data-id="heading-6">Flink-Doris-Connector 的优化</h4>
<p>因此针对 Lookup Join 场景 ，Flink-Doris-Connector 实现了异步 Lookup Join 和攒批查询的优化：</p>
<ul>
<li><strong>支持异步 Lookup Join：</strong> 异步 Lookup Join 意味着实时流中的数据不需要显式等待每条记录的查询结果，可以大大的降低延迟性。</li>
<li><strong>支持攒批查询：</strong> 将实时流的数据追加到队列 Queue 中，后台通过监听线程 Watcher，将队列里面的数据取出来再推送到查询执行的 Worker 线程池中，Worker 线程会将收到的这一批数据拼接成一个 Union All 的查询，同时向 Doris 发起 Query 查询。</li>
</ul>
<p>通过异步 Lookup join 以及攒批查询，可以在上游数据量比较大的时候大幅度提高维表关联吞吐量，保障了数据读取与处理的高效性。</p>
<h3 data-id="heading-7">03 实时 ETL 场景</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76eae7d3e54b4d55909c5b74fd6e6544~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167721&amp;x-signature=z5GrSjZ0Gecy9Tk%2FHfj2dzg0nLE%3D" alt="实时 ETL 场景.png" loading="lazy"/></p>
<p>对于实时写入来说，Doris Sink 的写入是基于 Stream Load 的导入方式去实现的。Stream Load 是 Apache Doris 中最为常见的数据导入方式之一，支持通过 HTTP 协议将本地文件或数据流导入到 Doris 中。主要流程如下：</p>
<ul>
<li>Sink 端在接收到数据后会开启一个 Stream Load 的长链接请求。在 Checkpoint 期间，它会将接收到的数据以 Chunk 的形式持续发送到 Doris 中。</li>
<li>Checkpoint 时，会对刚才发起的 Stream Load 的请求进行提交，提交完成后，数据才会可见。</li>
</ul>
<h4 data-id="heading-8">如何保证数据写入的 Exactly-Once 语义</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d8570e53ec247cbbddaa4af740123bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167721&amp;x-signature=Xw3pxFrGaXyM6vvmHXULQX9Rd3A%3D" alt="如何保证数据写入的 Exactly-Once 语义 .png" loading="lazy"/></p>
<p>那么，如何保证数据写入期间，端到端数据的精确一次性？</p>
<p>以 Kafka 同步到 Drois 的 Checkpoint 过程为例：</p>
<ol>
<li>Checkpoint 时，Source 端会接收到 Checkpoint Barrier；</li>
<li>Source 端接收到 Barrier 后，首先会对自身做一个快照，同时会将 Checkpoint Barrier 下发到 Sink 端；</li>
<li>Sink 端接收到 Barrier 后，执行 Pre-commit 提交，成功后数据就会完整写入到 Doris，由于此处执行的是预提交，所以在 Doris 上，此时对用户来说数据是不可见的；</li>
<li>将 Pre-Commit 成功的事务 ID 保存到状态中；</li>
<li>所有的算子 Checkpoint 都做完后，Job Manager 会下发本次 Checkpoint 完成的通知；</li>
<li>Sink 端会对刚才 Pre-commit 成功的事务进行一次提交。</li>
</ol>
<p>通过这种两阶段提交，就可以实现端到端的精确一次性。</p>
<h4 data-id="heading-9">实时性与 Exactly-Once</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82131d3ca6c2492d838abfbe76e25a5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167721&amp;x-signature=acV40oP24VbY%2F4psUOd9wFN13N0%3D" alt="实时性与 Exactly-Once.png" loading="lazy"/></p>
<p>上面提到，Doris Sink 端的写入与 Checkpoint 绑定，数据写入 Doris 的延迟性取决于 Checkpoint 的间隔。但在一些用户的场景下，希望数据可以实时写入，但是 Checkpoint 不能做的太频繁，同时对于一些作业来说，如果 Checkpoint 太频繁会消耗大量资源，针对该情况，Flink-Doris-Connector 引入了攒批机制，以平衡实时性与资源消耗之间的矛盾。</p>
<p>攒批的实现原理是 Sink 端接收上游数据之后，不会立即将每条数据单独写入 Doris，而是先在内存中进行缓存，然后通过对应参数设置，将缓存数据提交到 Doris 中。结合攒批写入和 Doris 中的主键模型，可以确保数据写入的幂等性。</p>
<p>通过引入攒批机制，既满足了用户对数据实时写入的需求，又避免了频繁 Checkpoint 带来的资源消耗问题，从而实现性能与效率的优化。</p>
<h2 data-id="heading-10">三、基于 Flink CDC 的整库同步方案</h2>
<p>以上是对 Flink-Doris-Connector 的典型场景和实现原理介绍，接下来我们来看它在实际业务中的一个重要应用——整库同步。相比底层实现，整库同步更偏向具体使用场景。下面我们基于前面介绍的能力，进一步探讨如何通过 Flink CDC 实现 TP 数据库到 Doris 的高效、自动化同步。</p>
<h3 data-id="heading-11">01 整库同步痛点</h3>
<p>在数据迁移过程中，用户通常希望可以尽快将数据迁移到 Doris 中，然而在同步 TP 数据库时，整库同步往往面临以下几点挑战：</p>
<ul>
<li><strong>建表：</strong>
<ul>
<li><strong>存量表的快速批量创建</strong>：TP 数据库中往往存在成千上万的表，这些表的结构各异，对于存量表而言需要逐一在 Doris 中创建对应的表结构；</li>
<li><strong>同步任务开启后，新增表的自动创建与同步：</strong> 为了保证数据的完整性和实时性，同步工具需要实时监控 TP 数据库的变化，并自动在 Doris 中创建和同步新表。</li>
</ul>
</li>
<li><strong>元数据映射：</strong> 上下游之间字段元数据的便捷映射，包括字段类型的转换、字段名称的对应修改等。</li>
<li><strong>DDL 自动同步：</strong> 增加、删除列等操作会导致数据库结构发生变化，进而影响到数据同步。因此，同步工具需要能够实时捕获 DDL 并动态地更新 Doris 表结构，以确保数据的准确性和一致性。</li>
<li><strong>开箱即用：</strong> 零代码，低门槛，理想的同步工具只需进行简单配置，即可实现数据的迁移和同步。</li>
</ul>
<h3 data-id="heading-12">02 基于 Flink CDC 实现整库同步</h3>
<p>在数据抽取方面，Flink-Doris-Connector 借用了 Flink CDC 的特性能力：</p>
<ul>
<li>增量快照读取
<ul>
<li>无锁读取与并发读取：不论存量数据量多大，都可以通过横向提高 Flink 的并发提升数据读取速度。</li>
<li>断点续传：当存量数据比较大时，可能面临同步中断的情况，CDC 支持中断任务的衔接同步。</li>
</ul>
</li>
<li>丰富数据源支持，Flink CDC 支持多种数据库，如 MySQL、Oracle、SQLServer 等。</li>
<li>无缝对接 Flink 现有生态，方便与 Flink 已有Source 和 Sink 结合使用。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3181c0a740ae4cbda4ef13cd18655325~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167721&amp;x-signature=aYk64I1YtcQ4diV3fkm07t1T%2FME%3D" alt="基于 Flink CDC 实现整库同步.png" loading="lazy"/></p>
<h4 data-id="heading-13">一键建表与元数据自动映射</h4>
<p>Flink-Doris-Connector 中集成了 Flink CDC 等能力，可以让用户只提交一个操作，就能进行整库同步的操作。其主要原理是 Flink CDC Source 在接收到上游的数据源之后，会进行分流处理，不同的表用不同的 Sink。同时在最新的 Connector 版本中，也支持单个 Sink 同步多张表，支持新增表的创建和同步。</p>
<p>集成 Flink CDC 的功能后，<strong>用户仅需通过 Flink-Doris-Connector 提交任务，就可以在 Doris 自动创建所需的表，而无需配置上下游表之间的显式关联，实现数据快速同步</strong>。</p>
<p>当 Flink 任务启动后，Doris-Flink-Connector 将自动识别对应的 Doris 表是否存在。如果表不存在，Doris Flink Connector 会自动创建表，并根据 Table 名称进行分流，从而实现下游多个表的 Sink 接入；如果表存在，则直接启动同步任务。</p>
<p>这一改进，不仅简化了配置流程，还使得新增表的创建和同步更加便捷，从而提升数据处理的整体效率。</p>
<h4 data-id="heading-14">Light Schema Change 与 DDL 自动同步</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3fd014e95def4cf2b17fb6fe68eba079~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167721&amp;x-signature=gUaz1InCjgSev3YVtCry%2FyU1Myw%3D" alt="Light Schema Change 与 DDL 自动同步.png" loading="lazy"/></p>
<p>在 Apache Doris 1.2 版本之前，Schema Change 操作比较繁琐，需要手动增改数据列。在上游 TP 数据库发生表结构变更时，需要暂停数据同步任务、待 Doris 中的 Schema Change 完成后再重启任务。</p>
<p>自 Apache Doris 1.2 版本起，我们引入了轻量级的 Light Schema Change 机制，极大地简化了操作流程，常见的增减列场景其处理速度可达毫秒级。Light Schema Change 机制原理如下：</p>
<ul>
<li><strong>Schema Change：</strong>
<ul>
<li>客户端向 FE 发起增减列的请求；</li>
<li>FE 在接收到请求后，修改当前元数据，并将最新的 Schema 持久化；</li>
<li>FE 向客户端同步 Schema Change 的结果；</li>
</ul>
</li>
<li><strong>Data Load：</strong>
<ul>
<li>当后续导入任务发起时，FE 将导入任务与最新的 Schema 信息发送给 BE；</li>
<li>在数据写入过程中，BE 的每个 Rowset 都会存储当前导入的 Schema 信息；</li>
</ul>
</li>
<li><strong>Query：</strong>
<ul>
<li>FE 将查询计划与最新的 Schema 一起发送给 BE；</li>
<li>BE 使用最新 Schema 执行查询计划；</li>
</ul>
</li>
<li><strong>Compaction：</strong>
<ul>
<li>在 BE 中，对参与合并的 Rowset 版本进行比较；</li>
<li>根据最新的  Schema Change 信息进行数据合并。</li>
</ul>
</li>
</ul>
<p>经测试，与早期的 Schema Change 相比，Light Schema Change 的数据同步性能有了数百倍的提升，</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a25ef456fb1441fd96615e59e9065338~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167721&amp;x-signature=th5MjuitLDWkHEBRO1kd63FUYHg%3D" alt="Light Schema Change 与 DDL 自动同步-2.png" loading="lazy"/></p>
<p>Light Schema Change 与 Flink-Doris-Connector 的结合，通过 Flink CDC 可以实现 DDL 的自动同步，具体步骤如下：</p>
<ol>
<li>Source 端捕获上游 Schema Change 信息，开启 DDL 变更同步；</li>
<li>Doris Sink 端识别并解析 DDL 操作（加减列）；</li>
<li>Table 校验，判断是否可以进行 Light Schema Change；</li>
<li>发起 Schema Change 操作；</li>
</ol>
<p>基于这一实现，Doris 能自动获取到 DDL 语句并在毫秒级即可完成 Schema Change 操作，在上游 TP 数据库发生表结构变更时，数据同步任务无需暂停。</p>
<h4 data-id="heading-15">开箱即用：MySQL 整库同步示例</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/766f5b42f09441f3a2b7e4edb7d5a6bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167721&amp;x-signature=QNg9CvYsdH8mmiSzQP3TJ6CJRwo%3D" alt="开箱即用：MySQL 整库同步示例.png" loading="lazy"/></p>
<p>对于用户来讲，只要有 Flink 客户端，通过上图的操作就可以提交整库同步作业。支持传入 Flink 的配置，比如并发设置、Checkpoint 间隔等，也支持正则表达式去配置需要同步的表， 同时可以将 Flink CDC Source 和 Doris Sink 的配置直接透传给具体的 Connector。通过这种方式，用户可以很便捷地提交整库同步作业。</p>
<h3 data-id="heading-16">03 Flink-Doris-Connector 核心优势</h3>
<p>基于以上优化，可以完美解决用户的痛点：</p>
<ol>
<li>自动建表，即存量表与增量表的自动创建，无需用户提前在 Doris 中预先创建对应的表结构；</li>
<li>自动映射上下游字段，无需手动写入上下游字段间的匹配规则，节省大量人力成本；</li>
<li>增减列无感同步，及时获取上游 DDL 语句并自动在 Doris 中实现毫秒级 Schema Change，无需停服、数据同步任务平稳运行；</li>
<li>开箱即用，降低学习成本，更专注业务本身。</li>
</ol>
<h3 data-id="heading-17">04 最佳实践</h3>
<p>在生产环境中，若作业数量较多，直接采用上述提交方式的作业管理复杂度较高。通常建议借助任务托管平台（如 StreamPark），实现对作业的统一创建、监控与运维，从而提升任务管理效率与系统稳定性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9a43559eded4d3caf2c7d97fd6245d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167721&amp;x-signature=05x7PrmqiBDi28vbX6IqECRwpjo%3D" alt="最佳实践.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0db4a5efa79b4eb2a9c50b1239026f7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764167721&amp;x-signature=lt50R0WcgO%2BPDCX7NkX3%2BSPQkmo%3D" alt="最佳实践-2.png" loading="lazy"/></p>
<h2 data-id="heading-18">四、未来规划</h2>
<p>未来，基于 Flink-Doris-Connector 的能力规划如下：</p>
<ol>
<li>支持实时读取。目前 Doris Source 只是把数据 Scan 出来，是一个有界流的读取，后续会支持 CDC 的场景，可以使用 Flink 来对 Doris 中的数据进行流式的读取。</li>
<li>Sink 一流多表。目前Flink-Doris-Connector支持单个 Sink 同步多张表，但是 Stream Load 的导入方式还是只支持单个表的导入。所以在表特别多的时候，需要在 Sink 端维护大量 StreamLoad 的连接，在后续会做到单个 Stream Load 的连接支持多张表的写入。</li>
<li>整库同步方面，支持更多的上游数据源，满足更多数据同步场景。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🎨 新来的外包，在大群分享了它的限流算法的实现]]></title>    <link>https://juejin.cn/post/7574270661872631846</link>    <guid>https://juejin.cn/post/7574270661872631846</guid>    <pubDate>2025-11-19T13:29:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574270661872631846" data-draft-id="7574254039023763482" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🎨 新来的外包，在大群分享了它的限流算法的实现"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-19T13:29:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="有态度的下等马"/> <meta itemprop="url" content="https://juejin.cn/user/448256476727662"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🎨 新来的外包，在大群分享了它的限流算法的实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/448256476727662/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    有态度的下等马
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T13:29:43.000Z" title="Wed Nov 19 2025 13:29:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0fccab2fa5b3487b8b35ea367414ee75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764165026&amp;x-signature=9EONJsKQiwidlHXLvty%2F1mOeneo%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">1. 令牌桶按用户维度限流</h2>
<p>前文<a href="https://juejin.cn/post/7568124427822825512" target="_blank" title="https://juejin.cn/post/7568124427822825512"><code>golang/x/time/rate</code></a>演示了基于<code>整体</code>请求速率的令牌桶限流；<br/>
那基于<code>用户id、ip、apikey</code>请求速率的限流(更贴近生产的需求)， 阁下又该如何应对？</p>
<p>那这个问题就从<code>全局速率</code>变成了按照<code>用户维度（group by userid）</code>来做限流，那么</p>
<ul>
<li>早先的全局的rateLimiter就要变成 userid:rateLimiter的键值对,select count( * ) from table ---&gt; select userid, count(*) from  table group by userid</li>
<li>使用缓存组件来存储维度键值对: 缓存的剔除机制来清理不再访问的键值对 （30min过期，10min周期清理内存）。</li>
</ul>

<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">var</span> userLimiters = cache.New(time.Minute*<span class="hljs-number">30</span>, <span class="hljs-number">10</span>) <span class="hljs-comment">// 10 items per minute</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">limiterForUser</span><span class="hljs-params">(userID <span class="hljs-type">string</span>)</span></span> *rate.Limiter {
	<span class="hljs-keyword">if</span> v, found := userLimiters.Get(userID); found {
		<span class="hljs-keyword">return</span> v.(*rate.Limiter)
	}

	l := rate.NewLimiter(rate.Every(time.Minute/<span class="hljs-number">60</span>), <span class="hljs-number">10</span>)
	userLimiters.Set(userID, l, cache.DefaultExpiration)
	<span class="hljs-keyword">return</span> l
}

<span class="hljs-comment">// 更细化的限流： 针对同一用户的请求次数限速， 增加了细粒度的用户维度，需要维护 用户与对应限速器的映射关系</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">userRatelimitMiddleware</span><span class="hljs-params">(c *gin.Context)</span></span> {
	userID := c.GetString(<span class="hljs-string">"userID"</span>)  <span class="hljs-comment">//  从每个请求context的key中取得信息， 这个key对于req context是排他性的</span>
	<span class="hljs-keyword">if</span> userID == <span class="hljs-string">""</span> {
		c.AbortWithStatusJSON(http.StatusUnauthorized, gin.H{<span class="hljs-string">"error"</span>: <span class="hljs-string">"Unauthorized"</span>})
		<span class="hljs-keyword">return</span>
	}
	<span class="hljs-keyword">if</span> userID == <span class="hljs-string">""</span> {
		userID = c.GetString(<span class="hljs-string">"x-api-key"</span>)
	}

	<span class="hljs-keyword">if</span> userID == <span class="hljs-string">""</span> {
		userID = c.ClientIP()
	}
	limiter := limiterForUser(userID) <span class="hljs-comment">// 通过userid维度找到对应的限速器</span>
	<span class="hljs-keyword">if</span> !limiter.Allow() {
		c.AbortWithStatusJSON(http.StatusTooManyRequests, gin.H{<span class="hljs-string">"error"</span>: <span class="hljs-string">"Too many requests"</span>})
		<span class="hljs-keyword">return</span>
	}
	c.Next()
}
</code></pre>
<h2 data-id="heading-1">2. redis 作为限流器外置存储</h2>
<p>这个思路也是极其常见的行为： redis可以成为用户令牌桶的全局中心存储： 当多个负载层需要读写用户限流器时，与redis交互。</p>
<p>本次通过golang的实战，深入理解基于redis的令牌桶限流器的算法实现。</p>
<p>①  请求到达负载层，被负载层识别为userid=junio</p>
<p>②  负载层请求redis获取该用户的token bucket的当前状态:
<code>hget userbucket:junio tokens last_time</code></p>
<p>③  基于当前时间<code>now</code>和<code>last_time</code>，计算流逝的时间，再根据rate计算这一阶段下发了多少tokens:<code>delta=(now-last_time) * r/1000</code>，加上redis原始记录的<code>token</code>,就是本次请求时bucket中能用的tokens， 注意：令牌数量最多不能超过cap</p>
<p>④ 如果tokens&gt;=1, 表示桶中有令牌，可放行请求，tokens数量减1</p>
<p>⑤ 最后将本次处理完后的 tokens和<code>last_time=now</code>写入原用户令牌桶
<code>hset  userbucket:junio  tokens  20 last_time 990</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c02de3fafff04c10a34f558eccb3fbc2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764165026&amp;x-signature=fNn9f5DXGXEs1iZ3SeRRomm02io%3D" alt="" loading="lazy"/>
使用redis 中的hashmap存储用户的tokenbucket状态，应用存在<code>读取redis- 计算- 回写redis</code>过程，使用redis lua的脚本执行三个动作，以保证线程安全。</p>
<blockquote>
<p>为什么lua脚本能保证线程安全呢？<br/>
主要得益于 Redis 的单线程架构和原子性执行机制： 加载并执行lua脚本时所有的redis操作作为一个整体完成； 整个脚本执行期间没有其他命令可以插入。</p>
</blockquote>
<pre><code class="hljs language-ini" lang="ini">// 读取- 计算 - 重新赋值都在一个 lua 脚本里面
var <span class="hljs-attr">redisScript</span> = `
	local <span class="hljs-attr">key</span> = KEYS[<span class="hljs-number">1</span>]
	local <span class="hljs-attr">capacity</span> = tonumber(ARGV[<span class="hljs-number">1</span>])
	local <span class="hljs-attr">rate</span> = tonumber(ARGV[<span class="hljs-number">2</span>])
	local <span class="hljs-attr">now</span> = tonumber(ARGV[<span class="hljs-number">3</span>])
	local <span class="hljs-attr">tokens</span> =  tonumber(redis.call(<span class="hljs-string">'hget'</span>, key, <span class="hljs-string">'tokens'</span>) or <span class="hljs-string">'-1'</span>)
	local <span class="hljs-attr">last_time</span> = tonumber(redis.call(<span class="hljs-string">'hget'</span>, key, <span class="hljs-string">'last_time'</span>) or  <span class="hljs-string">'-1'</span>)

	if <span class="hljs-attr">tokens</span>  == -<span class="hljs-number">1</span> or last_time == -<span class="hljs-number">1</span> then
		<span class="hljs-attr">tokens</span> = capacity
		<span class="hljs-attr">last_time</span> = now
	else
		local <span class="hljs-attr">elapsed</span> = now - last_time
        if elapsed &lt; 0 
			then <span class="hljs-attr">elapsed</span> = <span class="hljs-number">0</span>
		end
		local <span class="hljs-attr">delta</span>  = elapsed * rate / <span class="hljs-number">1000</span>
		<span class="hljs-attr">tokens</span> = tokens + delta
		if tokens &gt; capacity then
			<span class="hljs-attr">tokens</span> = capacity
		end
        <span class="hljs-attr">last_time</span> = now
	end
	local <span class="hljs-attr">allow</span> = <span class="hljs-number">0</span>
	if tokens &gt;= 1 then
		<span class="hljs-attr">allow</span> = <span class="hljs-number">1</span>
		<span class="hljs-attr">tokens</span>= tokens - <span class="hljs-number">1</span>
	else	
		<span class="hljs-attr">allow</span> = <span class="hljs-number">0</span>
	end

	redis.call('hset', key, 'tokens', tokens)
	redis.call('hset', key, 'last_time', last_time)
    redis.call('PEXPIRE', key,  math.max(1000, 2 * math.ceil((capacity / rate) * 5000)))
	return allow
`
</code></pre>
<p>注意</p>
<ul>
<li>上面还使用的redis expire机制： redis expire不是滑动过期，但是每次被请求触发执行的时候就重新设置TTL， 表现为“滑动过期”。</li>
<li>除了hset/hget ,还有hmget可用，另外这些操作还有配套的TTL指令，eg：<code>hset key EXAT  1740470400 FIELDS 2 field1 "Hello" field2 "World"</code>。</li>
</ul>
<p>golang应用层的写法如下：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *RedisLimiter)</span></span> Allow(c *gin.Context, userid <span class="hljs-type">string</span>) <span class="hljs-type">bool</span> {
	key := r.keyprefix + userid <span class="hljs-comment">// 定位这个用户的token bucket</span>
	now := time.Now().UnixMilli()
	<span class="hljs-comment">// Check if the key exists in Redis</span>
	rCmd := r.redis.Eval(redisScript, []<span class="hljs-type">string</span>{key}, r.<span class="hljs-built_in">cap</span>, r.rate, now)
	res, err := rCmd.Result()
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Printf(<span class="hljs-string">"get from redis failure. "</span>, err)
		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
	}
	<span class="hljs-keyword">if</span> allow, ok := res.(<span class="hljs-type">int64</span>); ok { <span class="hljs-comment">// 注意：lua返回的0,1 值对应golang的int64</span>
		log.Printf(<span class="hljs-string">"%v %v \n"</span>, allow, res)
		<span class="hljs-keyword">return</span> allow == <span class="hljs-number">1</span>
	} <span class="hljs-keyword">else</span> {
		log.Printf(<span class="hljs-string">"get from redis failure. "</span>, err)
		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
	}
}
</code></pre>
<hr/>
<h2 data-id="heading-2">3. 总结展望</h2>
<p>至此限流第二弹结束了，本文紧接掘金爆文<a href="https://juejin.cn/post/7568124427822825512" target="_blank" title="https://juejin.cn/post/7568124427822825512">🎨 新来的外包，限流算法用的这么6</a>，进一步讲述了<br/>
① 实现根据特定业务维度的限流： 从全局限流器转换成针对业务维度的键值对限流器；</p>
<p>② redis作为限流计数器的外置存储，令牌桶算法在redis上实现原理：核心是使用hashmap存储当前请求用户的令牌桶状态（current_tokens, last_time）, 落地时注意使用lua脚本避免竞态条件。</p>
<p>后面35+外包er针对限流设计还会再更新几个彩蛋， 期待一键三连，交个朋友， 35+报团不迷路。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>