<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[GBASE南大通用技术分享：GBase 8c数据库集群部署服务器时间一致性配置解析（下）]]></title>    <link>https://juejin.cn/post/7574739133946888234</link>    <guid>https://juejin.cn/post/7574739133946888234</guid>    <pubDate>2025-11-21T06:17:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574739133946888234" data-draft-id="7574821757665132585" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GBASE南大通用技术分享：GBase 8c数据库集群部署服务器时间一致性配置解析（下）"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2025-11-21T06:17:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GBASE"/> <meta itemprop="url" content="https://juejin.cn/user/4364376217774956"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GBASE南大通用技术分享：GBase 8c数据库集群部署服务器时间一致性配置解析（下）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4364376217774956/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GBASE
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T06:17:26.000Z" title="Fri Nov 21 2025 06:17:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0"><strong>2. CentOS/RHEL 系统</strong></h3>
<h4 data-id="heading-1"><strong>步骤 1：安装 chrony</strong></h4>
<p>bash：运行</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># CentOS 7/RHEL 7</span>
sudo yum install chrony -y
<span class="hljs-comment"># CentOS 8/RHEL 8+</span>
sudo dnf install chrony -y
</code></pre>
<h4 data-id="heading-2"><strong>步骤 2：配置 chrony（同 Ubuntu）</strong></h4>
<p>编辑配置文件 <code>/etc/chrony.conf</code>：</p>
<p>bash：</p>
<pre><code class="hljs language-bash" lang="bash">sudo vim /etc/chrony.conf
</code></pre>
<ul>
<li>
<p>替换上游服务器：</p>
<p> </p>
<pre><code class="hljs language-vbscript" lang="vbscript"><span class="hljs-built_in">server</span> ntp.aliyun.com iburst
<span class="hljs-built_in">server</span> time.nist.gov iburst  # 美国NIST服务器（备用）
</code></pre>
<p> </p>
</li>
<li>
<p>允许局域网客户端（例如 10.0.0.0/24 网段）：</p>
<pre><code class="hljs">allow 10.0.0.0/24
</code></pre>
<p> </p>
</li>
</ul>
<h4 data-id="heading-3"><strong>步骤 3：重启服务并设置自启</strong></h4>
<p>bash：</p>
<pre><code class="hljs language-bash" lang="bash">sudo systemctl restart chronyd
sudo systemctl <span class="hljs-built_in">enable</span> chronyd
</code></pre>
<h4 data-id="heading-4"><strong>步骤 4：验证</strong></h4>
<p>bash：</p>
<pre><code class="hljs language-bash" lang="bash">chronyc sources -v  <span class="hljs-comment"># 查看同步状态</span>
chronyc tracking    <span class="hljs-comment"># 查看本地时间同步详情</span>
</code></pre>
<h3 data-id="heading-5"><strong>3. 传统 ntp 服务</strong></h3>
<p>若需使用传统 <code>ntp</code> 服务（而非 chrony），步骤如下：</p>
<h4 data-id="heading-6"><strong>Ubuntu/Debian 安装 ntp：</strong></h4>
<p>bash：</p>
<pre><code class="hljs">sudo apt install ntp -y
</code></pre>
<p>配置文件：<code>/etc/ntp.conf</code>，添加上游服务器和允许的客户端（同 chrony 配置逻辑），然后重启服务：</p>
<p>bash：</p>
<pre><code class="hljs">sudo systemctl restart ntp
</code></pre>
<h4 data-id="heading-7"><strong>CentOS/RHEL 安装 ntp：</strong></h4>
<p>bash：</p>
<pre><code class="hljs language-bash" lang="bash">sudo yum install ntp -y  <span class="hljs-comment"># CentOS 7</span>
sudo systemctl restart ntpd
sudo systemctl <span class="hljs-built_in">enable</span> ntpd
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[徽标（Badge）的实现与优化铁壁猿版（简易版）]]></title>    <link>https://juejin.cn/post/7574967214127677466</link>    <guid>https://juejin.cn/post/7574967214127677466</guid>    <pubDate>2025-11-21T08:35:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574967214127677466" data-draft-id="7574728397374488628" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="徽标（Badge）的实现与优化铁壁猿版（简易版）"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-21T08:35:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="西西西西胡萝卜鸡"/> <meta itemprop="url" content="https://juejin.cn/user/2918532014943187"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            徽标（Badge）的实现与优化铁壁猿版（简易版）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2918532014943187/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    西西西西胡萝卜鸡
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T08:35:19.000Z" title="Fri Nov 21 2025 08:35:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文基于vue3+ts+tailwindcss，从逻辑拆解到代码细节带你实现一个简易版的右上角提示徽标组件</p>
</blockquote>
<h2 data-id="heading-0">一、需求分析与TS类型定义</h2>
<p>在实现组件前我们先明确Badge的能力范围，并通过TS将其规范化，这个步骤是我们实现所有组件都必须要有的，根据这一步骤再像拼积木一样一点一点“搭起来”。</p>
<p>首先在badge组件文件夹下创建一个types.ts，导出组件的各个api来控制每一个细节</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BadgeProps</span>{
    value?:<span class="hljs-built_in">number</span>|<span class="hljs-built_in">string</span>      <span class="hljs-comment">//显示的值（数字或文本）</span>
    max?:<span class="hljs-built_in">number</span>               <span class="hljs-comment">//最大显示值，超过显示max+</span>
    <span class="hljs-keyword">type</span>?:<span class="hljs-string">'primary'</span>|<span class="hljs-string">'success'</span>|<span class="hljs-string">'warning'</span>|<span class="hljs-string">'danger'</span>|<span class="hljs-string">'info'</span> <span class="hljs-comment">//其实就是默认可选集中常见颜色</span>
    color?:<span class="hljs-built_in">string</span>             <span class="hljs-comment">//自定义文本颜色</span>
    backgroundColor?:<span class="hljs-built_in">string</span>   <span class="hljs-comment">//自定义背景色</span>
    isDot?:<span class="hljs-built_in">boolean</span>            <span class="hljs-comment">//是否为小圆点（简洁版不显示文字）</span>
    hidden?:<span class="hljs-built_in">boolean</span>           <span class="hljs-comment">//是否隐藏（比如已读情况）</span>
    showZero?:<span class="hljs-built_in">boolean</span>         <span class="hljs-comment">//这个主要用于处理需要显示0的情况，少见但是还是要有</span>
}
</code></pre>
<p><strong>特别说明</strong>：这里的types是一个典型的联合类型（ts）,保证types只能是这五种，既限制了错误，又给予编译器完美的提示</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">BadgeType</span>=<span class="hljs-string">'primary'</span>|<span class="hljs-string">'success'</span>|<span class="hljs-string">'warning'</span>|<span class="hljs-string">'danger'</span>|<span class="hljs-string">'info'</span>
</code></pre>
<h2 data-id="heading-1">二、组件实现总体思路</h2>
<p>要写好一个Badge，需要处理以下核心部分：</p>
<h3 data-id="heading-2">1.内容逻辑</h3>
<ul>
<li>isDot和显示数字要做出那些判断？</li>
<li>需要实现哪些部分的计算？</li>
<li>需要考虑哪些类型特殊判断（检查如非0、null等）？</li>
</ul>
<h3 data-id="heading-3">2.显示条件</h3>
<ul>
<li>hidden是否隐藏</li>
<li>内容为空时是否显示</li>
</ul>
<h3 data-id="heading-4">3.样式逻辑</h3>
<ul>
<li>type类型切换颜色</li>
<li>自定义颜色与默认的优先级</li>
<li>根据内容长度决定尺寸</li>
<li>默认位置为右上角</li>
</ul>
<h3 data-id="heading-5">4.动画体验</h3>
<ul>
<li>显示/隐藏使用缩放过渡</li>
</ul>
<p>拆解完问题后，下面按模块实现</p>
<h2 data-id="heading-6">三、内容逻辑：displayValue</h2>
<p>内容逻辑决定当前Badge应该显示什么内容。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> displayValue=<span class="hljs-title function_">computed</span>(<span class="hljs-function">()=&gt;</span>{
    <span class="hljs-keyword">if</span>(props.<span class="hljs-property">isDot</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>   <span class="hljs-comment">//点状不需要考虑数字逻辑</span>
    <span class="hljs-keyword">const</span> val=props.<span class="hljs-property">value</span>       <span class="hljs-comment">//获取值</span>
    <span class="hljs-keyword">if</span>(val===<span class="hljs-string">''</span>||val===<span class="hljs-literal">null</span>||val===<span class="hljs-literal">undefined</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span><span class="hljs-comment">//特殊值返回空</span>
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> val===<span class="hljs-string">'number'</span>){
        <span class="hljs-keyword">if</span>(val&lt;<span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'0'</span>                           <span class="hljs-comment">//负值（特殊值）返回0</span>
        <span class="hljs-keyword">if</span>(val===<span class="hljs-number">0</span>&amp;&amp;!props.<span class="hljs-property">showZero</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>         <span class="hljs-comment">//是否显示0</span>
        <span class="hljs-keyword">if</span>(val&gt;props.<span class="hljs-property">max</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${props.max}</span>+`</span>       <span class="hljs-comment">//超出正常值显示max+</span>
        <span class="hljs-keyword">return</span> val.<span class="hljs-title function_">toString</span>()                          <span class="hljs-comment">//正常值正常返回</span>
    }
    <span class="hljs-keyword">return</span> val.<span class="hljs-title function_">toString</span>()
})
</code></pre>
<p>这一块逻辑清晰地处理了 Badge 最常见的展示需求。</p>
<h2 data-id="heading-7">四、显示控制：shouldShow</h2>
<p>Badge有一些特殊场景需要隐藏，例如消息已读、需要动画时先不显示等。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> shouldShow=<span class="hljs-title function_">computed</span>(<span class="hljs-function">()=&gt;</span>{
    <span class="hljs-keyword">if</span>(props.<span class="hljs-property">hidden</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    <span class="hljs-keyword">if</span>(props.<span class="hljs-property">isDot</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    <span class="hljs-keyword">return</span> displayValue.<span class="hljs-property">value</span>!==<span class="hljs-string">''</span>
})
</code></pre>
<p>这一层的逻辑避免了空内容闪烁问题。</p>
<h2 data-id="heading-8">五、样式处理：类型+自定义颜色+动态大小</h2>
<h5 data-id="heading-9">1.类型class（typeClasses）</h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> typeClasses=<span class="hljs-title function_">computed</span>(<span class="hljs-function">()=&gt;</span>{
<span class="hljs-comment">//自定义优先级高于默认</span>
    <span class="hljs-keyword">if</span>(props.<span class="hljs-property">color</span>||props.<span class="hljs-property">backgroundColor</span>){
        <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>
    }
<span class="hljs-comment">//默认就根据types来获取对应颜色</span>
    <span class="hljs-keyword">const</span> types={
        <span class="hljs-attr">primary</span>:<span class="hljs-string">'bg-blue-500 text-white'</span>,
        <span class="hljs-attr">success</span>: <span class="hljs-string">'bg-green-500 text-white'</span>,
        <span class="hljs-attr">warning</span>: <span class="hljs-string">'bg-yellow-500 text-white'</span>,
        <span class="hljs-attr">danger</span>: <span class="hljs-string">'bg-red-500 text-white'</span>,
        <span class="hljs-attr">info</span>: <span class="hljs-string">'bg-gray-500 text-white'</span>,
    }
    <span class="hljs-keyword">return</span> types[props.<span class="hljs-property">type</span>]
})
</code></pre>
<h5 data-id="heading-10">2.自定义样式</h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> customStyle=<span class="hljs-title function_">computed</span>(<span class="hljs-function">()=&gt;</span>{
    <span class="hljs-keyword">const</span> <span class="hljs-attr">style</span>:<span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>,<span class="hljs-built_in">string</span>&gt;={}
    <span class="hljs-keyword">if</span>(props.<span class="hljs-property">color</span>) style.<span class="hljs-property">color</span>=props.<span class="hljs-property">color</span>
    <span class="hljs-keyword">if</span>(props.<span class="hljs-property">backgroundColor</span>) style.<span class="hljs-property">backgroundColor</span>=props.<span class="hljs-property">backgroundColor</span>
    <span class="hljs-keyword">return</span> style
})
</code></pre>
<h5 data-id="heading-11">3.尺寸逻辑（sizeClasses）</h5>
<p>Badge的宽应随内容长度自动变化，比如9+、99+长度或者是点。这个逻辑保证badge不会因为数字长度不好看。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> sizeClasses=<span class="hljs-title function_">computed</span>(<span class="hljs-function">()=&gt;</span>{
    <span class="hljs-comment">//设置属于点的小盒子宽度</span>
    <span class="hljs-keyword">if</span>(props.<span class="hljs-property">isDot</span>){
        <span class="hljs-keyword">return</span> <span class="hljs-string">'w-2 h-2 min-w-0'</span>
    }
    <span class="hljs-comment">//设置字长不同的盒子自适应</span>
    <span class="hljs-keyword">const</span> content=displayValue.<span class="hljs-property">value</span>
    <span class="hljs-keyword">if</span>(content.<span class="hljs-property">length</span>===<span class="hljs-number">1</span>){
        <span class="hljs-keyword">return</span> <span class="hljs-string">'w-5 h-5 min-w-[20px]'</span>
    }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(content.<span class="hljs-property">length</span>===<span class="hljs-number">2</span>){
        <span class="hljs-keyword">return</span> <span class="hljs-string">'w-6 h-5 min-w-[24px]'</span>
    }<span class="hljs-keyword">else</span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">'h-5 min-w-[24px] px-1'</span>
    }
    
})
</code></pre>
<h2 data-id="heading-12">六、Badge模板</h2>
<p>Badge会自动叠加在插槽内容的右上角，并带有平滑缩放动画</p>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"relative inline-block"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">slot</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">Transition</span>
      <span class="hljs-attr">enter-active-class</span>=<span class="hljs-string">"transition-all duration-200 ease-out"</span>
      <span class="hljs-attr">enter-from-class</span>=<span class="hljs-string">"opacity-0 transform scale-0"</span>
      <span class="hljs-attr">enter-to-class</span>=<span class="hljs-string">"opacity-100 transform scale-100"</span>
      <span class="hljs-attr">leave-active-class</span>=<span class="hljs-string">"transition-all duration-200 ease-in"</span>
      <span class="hljs-attr">leave-from-class</span>=<span class="hljs-string">"opacity-100 transform scale-100"</span>
      <span class="hljs-attr">leave-to-class</span>=<span class="hljs-string">"opacity-0 transform scale-0"</span>
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>
        <span class="hljs-attr">v-if</span>=<span class="hljs-string">"shouldShow"</span>
        <span class="hljs-attr">:class</span>=<span class="hljs-string">"[
          'text-white',
          'absolute top-0 right-0 transform translate-x-1/2 -translate-y-1/2 flex items-center justify-center rounded-full text-xs font-medium leading-none z-10',
          typeClasses,
          sizeClasses,
          props.isDot ? '' : 'border-2 border-white',
        ]"</span>
        <span class="hljs-attr">:style</span>=<span class="hljs-string">"customStyle"</span>
      &gt;</span>
        {{ displayValue }}
      <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Transition</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

</code></pre>
<h2 data-id="heading-13"><strong>七、细节优化与思考</strong></h2>
<p><strong>1. 负数显示为 0</strong>：避免出现 <code>-1 条消息</code> 这种不符合直觉的结果。</p>
<p><strong>2. 超出最大值显示 max+</strong>：限制宽度，防止 UI 崩坏：</p>
<pre><code class="hljs">99+  ✔
12999  ✘
</code></pre>
<p><strong>3. 自定义颜色优先级更高</strong>：使 Badge 可高度定制：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;Badge <span class="hljs-attr">backgroundColor</span>=<span class="hljs-string">"#ff8800"</span> color=<span class="hljs-string">"#fff"</span> /&gt;
</code></pre>
<p><strong>4. 小圆点模式省略所有内容检查</strong>：非常适合在线状态指示。</p>
<p><strong>5. 过渡动画提升体验</strong>：从 "出现/消失" 变为 "缩放展开"，更柔和自然。</p>
<h2 data-id="heading-14">八、使用实例</h2>
<p>这样我们就完成一个简易的徽标组件，下面在外面的父组件这样使用就可以啦！</p>
<pre><code class="hljs language-js" lang="js">&lt;<span class="hljs-title class_">Badge</span> :value=<span class="hljs-string">"3"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"relative px-3 py-1 bg-gray-200 rounded"</span>&gt;</span>消息<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Badge</span>&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Badge</span> <span class="hljs-attr">:isDot</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"success"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"w-8 h-8 bg-gray-300 rounded-full"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Badge</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Badge</span> <span class="hljs-attr">:value</span>=<span class="hljs-string">"120"</span> <span class="hljs-attr">:max</span>=<span class="hljs-string">"99"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"danger"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">Badge</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Badge</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"New"</span> <span class="hljs-attr">backgroundColor</span>=<span class="hljs-string">"#f60"</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"#fff"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">Badge</span>&gt;</span></span>

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[分布式锁工具类]]></title>    <link>https://juejin.cn/post/7574958975159697451</link>    <guid>https://juejin.cn/post/7574958975159697451</guid>    <pubDate>2025-11-21T08:40:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574958975159697451" data-draft-id="7574892669374627894" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="分布式锁工具类"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-21T08:40:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小夏coding"/> <meta itemprop="url" content="https://juejin.cn/user/2403977616186251"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            分布式锁工具类
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2403977616186251/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小夏coding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T08:40:39.000Z" title="Fri Nov 21 2025 08:40:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">业务背景：</h2>
<p>在多节点部署、事件回调或定时任务并发执行的场景中，需要同一份业务数据只被处理一次，否则会导致重复推送、资源竞争或脏数据。传统 synchronized 或数据库锁难以满足跨进程、跨机器的互斥需求。通常的做法都是使用Redisson 加一个分布式锁。</p>
<p>每次加分布式锁要写一堆代码，特别的麻烦，而且由于不断有新人进组，导致加分布式锁的代码并不规范，会导致加锁的异常处理存在安全风险，因此就封装了一个工具类给项目组成员使用，通过这个工具类，一来可以避免每次加锁写很多的代码，二来通过工具类可以保证加锁的安全性。</p>
<h2 data-id="heading-1">技术设计</h2>
<p>1、分布式锁还是使用Redisson来作为核心技术组件；</p>
<p>2、由于加锁时有一些参数需要调用方传入，如果放在方法里面作为参数会导致参数过多，因此封装了一个LockCallOptions类作为参数信息类，并为参数提供默认值，大部分情况下只需要使用默认值即可。这些参数信息有：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-string">`lockKey`</span>：加锁的键值；
<span class="hljs-string">`lockSeconds`</span>：锁过期时间，默认 <span class="hljs-number">5</span> 秒，可自定义（需在 <span class="hljs-number">1</span>~<span class="hljs-number">1000</span> 秒区间）。
<span class="hljs-string">`errorLogMsg`</span>：加锁和业务执行时如果抛出异常会打印日志，这个参数表示打印的日志信息内容。
<span class="hljs-string">`throwWhenLockFail`</span>：未抢到锁时是否抛异常，默认 <span class="hljs-literal">true</span>。
<span class="hljs-string">`throwMsgWhenLockFail`</span>：未抢到锁时如果抛出异常，内容就是这个参数。
LockCallOptions再实现一个checkParams方法检查参数值的合法性。
</code></pre>
<p>3、业务方法可以使用java的函数来实现，比如Function等，但由于业务方法需要传入的参数可能不同，比如有的不传参数，有的一个参数，有的两个参数，因此可以实现多个方法，分别用Supplier、Function、BiFunction来实现。</p>
<p>如果有更多参数怎么办，第一种办法是继续函数式接口，然后再实现一个方法，比如针对三个参数的可以定义这个函数式接口：</p>
<pre><code class="hljs language-csharp" lang="csharp">@FunctionalInterface
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">ThreeFunction</span>&lt;<span class="hljs-title">T</span>, <span class="hljs-title">U</span>, <span class="hljs-title">V</span>, <span class="hljs-title">R</span>&gt; {

    <span class="hljs-function">R <span class="hljs-title">apply</span>(<span class="hljs-params">T t, U u, V v</span>)</span>;
}
</code></pre>
<p>还有一种方式是可以定义一个map，将所有的参数都推入这个map，然后在工具类方法中从map中取参数；</p>
<h2 data-id="heading-2">关键代码</h2>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> RedissonClient <span class="hljs-title">getRedissonClient</span>()</span> {
    RedissonClient result = SpringContextHolder.getBean(RedissonClient.<span class="hljs-keyword">class</span>);
    <span class="hljs-keyword">if</span> (Objects.isNull(result)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">"获取分布式锁失败"</span>);
    }

    <span class="hljs-keyword">return</span> result;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;R&gt; <span class="hljs-function">R <span class="hljs-title">callWithLock</span>(<span class="hljs-params">LockCallOptions options, Supplier&lt;R&gt; bizFunc</span>)</span> {
    <span class="hljs-comment">//参数检查</span>
    options.check();

    RLock <span class="hljs-keyword">lock</span> = <span class="hljs-literal">null</span>;
    boolean locked = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">lock</span> = getRedissonClient().getLock(options.getLockKey());
        locked = <span class="hljs-keyword">lock</span>.tryLock(options.getLockSeconds(), TimeUnit.SECONDS);
        <span class="hljs-keyword">if</span> (!locked) {
            <span class="hljs-comment">//没获取到锁则丢弃</span>
            log.error(<span class="hljs-string">"获取分布式锁失败，键值key: {}"</span>, options.getLockKey());
            <span class="hljs-keyword">if</span> (options.getThrowWhenLockFail()) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(options.getThrowMsgWhenLockFail());
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }

        <span class="hljs-comment">//业务处理</span>
        <span class="hljs-keyword">return</span> bizFunc.<span class="hljs-keyword">get</span>();
    }  <span class="hljs-keyword">catch</span> (Exception ex) {
        log.error(<span class="hljs-string">"{}: 异常信息：{}"</span>, options.getErrorLogMsg(), ex.getMessage(), ex);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-keyword">if</span> (locked &amp;&amp; <span class="hljs-keyword">lock</span> != <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-keyword">lock</span>.isHeldByCurrentThread()) {
            <span class="hljs-keyword">lock</span>.unlock();
        }
    }
}
</code></pre>
<h2 data-id="heading-3">使用示例</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">"lcok:%s:%s"</span>, type, userId);
<span class="hljs-type">LockCallOptions</span> <span class="hljs-variable">callOptions</span> <span class="hljs-operator">=</span> LockCallOptions.builder()
        .lockKey(lockKey)
        .errorLogMsg(<span class="hljs-string">"业务处理异常"</span>)
        .throwWhenLockFail(<span class="hljs-literal">false</span>)
        .build();
LockUtils.callWithLock(callOptions, () -&gt; handler.process(requestData));
</code></pre>
<p><strong>注意：</strong></p>
<p>LockCallOptions的定义如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Builder</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LockCallOptions</span> {

    <span class="hljs-comment">// 锁的键值</span>
    <span class="hljs-keyword">private</span> String lockKey;

    <span class="hljs-comment">//锁的秒数   </span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> <span class="hljs-variable">lockSeconds</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;

    <span class="hljs-comment">//加锁异常时记录的错误日志信息    </span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">errorLogMsg</span> <span class="hljs-operator">=</span> <span class="hljs-string">"加锁执行方法异常"</span>;

    <span class="hljs-comment">// 加锁失败时是否抛异常    </span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">Boolean</span> <span class="hljs-variable">throwWhenLockFail</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;

    <span class="hljs-comment">// 加锁失败时抛异常信息内容（throwWhenLockFail = true时才会使用这个值）    </span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">throwMsgWhenLockFail</span> <span class="hljs-operator">=</span> <span class="hljs-string">"请稍后重试"</span>;
}
</code></pre>
<p>由于使用了@Builder注解，在使用LockCallOptions.builder().build()时发现创建的LockCallOptions对象并没有上面定义时指定的默认值，要解决这个办法就是在有默认值的属性定义上加上注解：@Builder.Default即可解决。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[续集：Vite 字体插件重构之路 —— 从“能用”到“生产级稳定”]]></title>    <link>https://juejin.cn/post/7574967214127775770</link>    <guid>https://juejin.cn/post/7574967214127775770</guid>    <pubDate>2025-11-21T08:45:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574967214127775770" data-draft-id="7574991051434622986" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="续集：Vite 字体插件重构之路 —— 从“能用”到“生产级稳定”"/> <meta itemprop="keywords" content="JavaScript,Vue.js,Vite"/> <meta itemprop="datePublished" content="2025-11-21T08:45:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="特级业务专家"/> <meta itemprop="url" content="https://juejin.cn/user/2101921961481512"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            续集：Vite 字体插件重构之路 —— 从“能用”到“生产级稳定”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2101921961481512/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    特级业务专家
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T08:45:57.000Z" title="Fri Nov 21 2025 08:45:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">续集：Vite 字体插件重构之路 —— 从“能用”到“生产级稳定”</h2>
<blockquote>
<p><strong>前言</strong>：
在上一篇文章《把 16MB 中文字体压到 400KB：我写了一个 Vite 字体子集插件》中，我分享了如何通过自研插件 <code>@fe-fast/vite-plugin-font-subset</code> 解决中文字体体积过大的问题。</p>
<p>文章发出后，不少朋友试用并反馈了意见。更重要的是，在实际生产环境的复杂构建链路中，我发现 v0.1 版本存在一些设计上的“硬伤”。</p>
<p>开源不仅仅是发布代码，更是一个持续迭代的过程。今天这篇“续集”，就来聊聊这次 v0.3.x 重构背后的故事：<strong>如何解决路径 404 问题、生命周期竞态，以及如何更优雅地接入 Vite 构建流。</strong></p>
</blockquote>
<h3 data-id="heading-1">一、遇到的问题：本地跑得欢，上线 404</h3>
<p>在 v0.1 版本中，我的实现逻辑非常简单粗暴：</p>
<ol>
<li>插件运行，调用 <code>subset-font</code> 生成 <code>.woff2</code> 文件。</li>
<li>使用 <code>fs.writeFileSync</code> 直接把文件写到 <code>src/assets/fonts/subset</code> 目录下。</li>
<li>生成一个 <code>font.css</code>，里面写着 <code>src: url('./subset/xxx.woff2')</code>。</li>
<li>用户手动引入这个 CSS。</li>
</ol>
<p><strong>看起来没问题？但在真实项目中，这个方案有两个致命缺陷：</strong></p>
<h4 data-id="heading-2">1. 路径引用的“相对论”陷阱</h4>
<p>当我们在开发环境（<code>vite dev</code>）时，文件都在本地磁盘上，相对路径 <code>url('./subset/...')</code> 能正常工作。
但在 <code>vite build</code> 生产构建时，Vite 会把 CSS 内联到 HTML 中，或者打包成独立的 CSS 文件放在 <code>assets</code> 目录深处。
一旦目录结构发生变化（例如设置了 <code>base: '/app/'</code>），原本写死的相对路径就会失效，导致浏览器报 <strong>404 Not Found</strong>。</p>
<h4 data-id="heading-3">2. “脏”文件与构建副作用</h4>
<p>直接用 <code>fs</code> 模块往 <code>src</code> 目录写文件，是一种“副作用”很强的做法：</p>
<ul>
<li>这些生成的临时文件会被 Git 识别，污染工作区。</li>
<li>它们没有经过 Vite 的资源处理管道（Asset Pipeline），导致文件名没有 Hash（缓存问题），也不会出现在 <code>manifest.json</code> 中。</li>
</ul>
<h3 data-id="heading-4">二、重构核心：拥抱 Vite/Rollup 标准流</h3>
<p>为了解决上述问题，我决定对插件进行彻底重构。核心目标是：<strong>不再手动写磁盘，而是把资源“交给” Vite 处理。</strong></p>
<h4 data-id="heading-5">1. 弃用 <code>fs.write</code>，改用 <code>emitFile</code></h4>
<p>Vite（基于 Rollup）提供了一个标准的 API <code>this.emitFile</code>，专门用于在构建过程中发射文件。</p>
<p><strong>Before (v0.1):</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 坏味道：直接操作磁盘，脱离构建流</span>
fs.<span class="hljs-title function_">writeFileSync</span>(outputPath, subsetBuffer);
</code></pre>
<p><strong>After (v0.3):</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 最佳实践：告诉构建工具“我有一个文件要打包”</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">emitFile</span>({
  <span class="hljs-attr">type</span>: <span class="hljs-string">'asset'</span>,
  <span class="hljs-attr">fileName</span>: <span class="hljs-string">'assets/fonts/my-font.woff2'</span>,
  <span class="hljs-attr">source</span>: subsetBuffer
});
</code></pre>
<p>这样做的好处是，Vite 会自动处理这些文件，把它们放到正确的 <code>dist</code> 目录，并且我们可以利用 Vite 的机制来处理路径。</p>
<h4 data-id="heading-6">2. 解决生命周期的“竞态问题”</h4>
<p>在重构过程中，我踩了一个深坑：<strong>生命周期执行顺序</strong>。</p>
<p>我最初想在 <code>transformIndexHtml</code> 钩子（处理 HTML 时）去注入 CSS 标签。但是，字体子集化是一个耗时操作（CPU 密集型），如果放在错误的钩子执行，会导致 HTML 已经处理完了，字体还没生成好。</p>
<p><strong>最终的架构方案：</strong></p>
<ul>
<li>
<p><strong><code>buildStart</code> 阶段</strong>：
这是构建开始的最早阶段。我在这里执行最耗时的“字体子集化”和“字符扫描”工作。计算出所有的 Hash 文件名，准备好要发射的数据。
<em>为什么在这里？</em> 确保后续任何钩子执行时，数据都已经准备就绪。</p>
</li>
<li>
<p><strong><code>generateBundle</code> 阶段</strong>：
在这里统一调用 <code>emitFile</code> 发射所有字体文件和生成的 CSS 文件。</p>
</li>
<li>
<p><strong><code>transformIndexHtml</code> 阶段</strong>：
因为在 <code>buildStart</code> 阶段我们已经计算好了最终的文件名（包含 Hash），所以在这里可以直接生成 <code>&lt;link rel="stylesheet"&gt;</code> 标签并注入到 HTML 的 <code>&lt;head&gt;</code> 中。</p>
</li>
</ul>
<h4 data-id="heading-7">3. 自动注入：从“手动挡”变“自动挡”</h4>
<p>v0.1 版本需要用户手动在 <code>main.ts</code> 里 <code>import './subset/font.css'</code>。
现在，得益于对 <code>transformIndexHtml</code> 的利用，插件默认开启 <code>injectCss: true</code>。</p>
<p><strong>用户什么都不用做</strong>，构建完成后，<code>index.html</code> 里会自动多出一行：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/assets/fonts/font-a1b2c3d4.css"</span>&gt;</span>
</code></pre>
<p>这不仅省事，更重要的是<strong>路径绝对正确</strong>。插件会根据 Vite 配置的 <code>base</code> 自动拼接路径，无论你部署在根目录还是子目录，都能完美加载。</p>
<h3 data-id="heading-8">三、代码细节：一个小 Bug 的教训</h3>
<p>在 v0.3.1 的迭代中，我还修复了一个变量作用域的小 Bug。</p>
<p><strong>Bug 现场：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误代码</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">processFont</span>(...)
<span class="hljs-comment">// 这里试图解构 fontPath，但 processFont 返回值里漏传了这个字段</span>
<span class="hljs-keyword">const</span> { fontPath } = result 
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(path.<span class="hljs-title function_">basename</span>(fontPath)) <span class="hljs-comment">// -&gt; undefined</span>
</code></pre>
<p><strong>修复与优化：</strong>
在 v0.3.3 中，我不仅修复了变量传递，还反思了一下：<strong>为什么需要传递这个变量？</strong>
其实 <code>cssEntry</code> 对象里已经包含了 <code>relativePath</code>，完全可以通过它推导出文件名。于是我删除了冗余的 <code>fontPath</code> 返回值，让数据流更清晰。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 优化后：减少冗余数据传递</span>
<span class="hljs-keyword">const</span> { cssEntry } = result
<span class="hljs-comment">// 直接从已有数据推导</span>
<span class="hljs-keyword">const</span> fileName = path.<span class="hljs-title function_">basename</span>(cssEntry.<span class="hljs-property">relativePath</span>)
</code></pre>
<p><em>这提醒我们：重构不仅是改架构，更是清理冗余逻辑的好时机。</em></p>
<h3 data-id="heading-9">四、v0.3.x 版本的新特性总结</h3>
<p>经过这次“伤筋动骨”的重构，<code>@fe-fast/vite-plugin-font-subset</code> 现在具备了生产级的能力：</p>
<ol>
<li><strong>零配置自动注入</strong>：默认自动生成 CSS 并注入 HTML，无需手动 import。</li>
<li><strong>构建产物纯净</strong>：不再污染 <code>src</code> 源码目录，所有产物直接进入 <code>dist</code>。</li>
<li><strong>路径安全</strong>：完美支持 Vite 的 <code>base</code> 配置，支持 CDN 部署路径。</li>
<li><strong>Hash 缓存友好</strong>：生成的文件名带有内容 Hash，利于浏览器长效缓存。</li>
</ol>
<h3 data-id="heading-10">五、写在最后</h3>
<p>从 v0.1 到 v0.3，代码量增加了不少，但使用者的心智负担却降低了。</p>
<p>做开源项目往往就是这样：<strong>把复杂留给自己，把简单留给用户。</strong>
最初只是为了解决自己项目的 16MB 字体问题，现在它已经变成了一个更加健壮的通用解决方案。</p>
<p>如果你也在使用 Vite 开发中文项目，深受字体体积困扰，欢迎尝试一下这个插件，也欢迎在 GitHub 上提 Issue 或 PR，我们一起把它打磨得更好。</p>
<blockquote>
<p><strong>GitHub</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwilliam-xue%2Fvite-plugin-font-subset" target="_blank" title="https://github.com/william-xue/vite-plugin-font-subset" ref="nofollow noopener noreferrer">github.com/william-xue…</a>
<strong>NPM</strong>: <code>npm install @fe-fast/vite-plugin-font-subset -D</code></p>
</blockquote>
<hr/>
<p><strong>下一阶段计划：</strong>
目前插件主要针对 Build 阶段优化。接下来我可能会探索一下如何在 Dev 开发阶段提供更好的体验（比如利用缓存避免重复构建），敬请期待！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[百万QPS防刷赞系统设计实录：从TRAE SOLO生成到生产级改造]]></title>    <link>https://juejin.cn/post/7574916588718293034</link>    <guid>https://juejin.cn/post/7574916588718293034</guid>    <pubDate>2025-11-21T07:47:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574916588718293034" data-draft-id="7574734686494375972" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="百万QPS防刷赞系统设计实录：从TRAE SOLO生成到生产级改造"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2025-11-21T07:47:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="zhouzhouya"/> <meta itemprop="url" content="https://juejin.cn/user/3931509312987511"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            百万QPS防刷赞系统设计实录：从TRAE SOLO生成到生产级改造
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3931509312987511/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    zhouzhouya
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T07:47:05.000Z" title="Fri Nov 21 2025 07:47:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>想看看TRAE SOLO到底有多强大，正好脑子里闪过一个防刷赞系统，于是开始构思，防刷赞系统是什么？防刷赞系统主要应用于<strong>营销活动、内容平台、社交网络</strong>等场景，需要保护点赞功能的真实性和公正性。在电商平台、短视频平台、社交媒体等应用中，点赞功能非常重要，直接影响内容推荐、热门排行和商业价值，好了，说做就做，拿出TRAE SOLO，直接开始进行实践。</p>
<h2 data-id="heading-1">TRAE SOLO在实践时能做什么</h2>
<p>在开始进行实践前，我需要思考下，TRAE SOLO应该帮我做哪些事情，</p>
<h4 data-id="heading-2"><strong>技术要求上，需要考虑此系统的：</strong></h4>
<p><strong>1.高并发处理能力：</strong> 特别是在热点内容出现时，QPS（每秒查询率）可能达到数十万甚至上百万次。系统必须具备强大的并发处理能力和水平扩展能力。</p>
<p><strong>2.数据一致性要求：</strong>
系统需要保证<strong>强一致性</strong>确保一个用户对同一目标只能点赞一次，防止重复统计和数据不一致问题。这要求系统具备幂等性处理和分布式事务能力。</p>
<p><strong>3. 实时性要求：</strong>
用户点赞操作需要<strong>秒级响应</strong>，从用户点击到界面反馈的端到端延迟必须控制在200ms以内，否则会影响用户体验</p>
<h4 data-id="heading-3"><strong>安全威胁背景，需要考虑此系统的：</strong></h4>
<p><strong>1. 攻击手段多样化</strong></p>
<ul>
<li><strong>自动化脚本</strong>：防止有些黑客使用机器人程序进行批量点赞。</li>
<li><strong>IP池轮换</strong>：通过代理IP池绕过IP限制。</li>
<li><strong>设备指纹伪造</strong>：修改设备信息绕过设备限制。</li>
<li><strong>分布式攻击</strong>：利用僵尸网络进行大规模攻击。</li>
</ul>
<p><strong>2. 黑产产业链成熟</strong>
很多人为了赚钱想尽一切办法，使用写好的脚本，使刷赞目前形成了完整的产业链。包括账号注册、设备伪装、IP代理、自动化工具等环节，攻击成本低但防御成本高。</p>
<p>简化放刷赞系统，暂时只考虑以上提及的两部分，开始使用TRAE SOLO完成后续步骤。</p>
<h2 data-id="heading-4">具体实践步骤</h2>
<h4 data-id="heading-5"><strong>第一步：向TRAE SOLO下达精准的“初始指令”</strong></h4>
<p>“请作为一名首席架构师，基于以下核心需求，设计并生成一个高性能防刷赞系统的完整代码：</p>
<p><strong>系统核心目标</strong></p>
<ol>
<li>高并发处理：支持百万QPS的点赞请求。</li>
<li>强一致性：确保用户对同一内容仅能点赞一次，绝对防止重复。</li>
<li>低延迟：端到端响应时间控制在200毫秒内。</li>
<li>安全风控：有效防御自动化脚本、IP池轮换、设备指纹伪造、分布式攻击等多样化威胁。
【技术指示】</li>
</ol>
<ul>
<li>前端：Vue 3 + TypeScript + Vite</li>
<li>后端：Node.js + Express</li>
<li>缓存/数据库：Redis + PostgreSQL</li>
<li>风控：自研轻量级规则引擎
请输出完整的项目结构、API接口代码、数据库Schema及安全风控核心算法。</li>
</ul>
<p>指令下达完成后，只需要静静等待即可，经过TRAE SOLO给的提示操作，TRAE SOLO生成了一个结构清晰、技术选型合理的项目脚手架。</p>
<h4 data-id="heading-6"><strong>第二步：生成架构与核心代码，应对技术挑战</strong></h4>
<h5 data-id="heading-7"><strong>1. 应对高并发：生成异步削峰与缓存代码</strong></h5>
<p>TRAE SOLO会识别“百万QPS”的需求，并自动编写以下关键代码：</p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">// TRAE SOLO 可能生成的核心代码示例 - 点赞接口</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Redis</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'ioredis'</span>;
<span class="hljs-keyword">const</span> redis = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Redis</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">REDIS_URL</span>);

<span class="hljs-comment">// 使用Redis Pipeline批量处理，极大提升吞吐量</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">likeContent</span>(<span class="hljs-params">userId, contentId</span>) {
  <span class="hljs-keyword">const</span> pipeline = redis.<span class="hljs-title function_">pipeline</span>();
  <span class="hljs-keyword">const</span> key = <span class="hljs-string">`like:<span class="hljs-subst">${contentId}</span>`</span>;
  <span class="hljs-keyword">const</span> userKey = <span class="hljs-string">`user_like:<span class="hljs-subst">${userId}</span>:<span class="hljs-subst">${contentId}</span>`</span>;

<span class="hljs-comment">// 1. 检查是否已点赞 (原子操作)</span>
  <span class="hljs-keyword">const</span> alreadyLiked = <span class="hljs-keyword">await</span> pipeline.<span class="hljs-title function_">sismember</span>(key, userId).<span class="hljs-title function_">exec</span>();
  <span class="hljs-keyword">if</span> (alreadyLiked) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Already liked'</span>);
  }
<span class="hljs-comment">// 2. 记录点赞 (事务处理)</span>
pipeline.<span class="hljs-title function_">multi</span>()
   .<span class="hljs-title function_">sadd</span>(key, userId) <span class="hljs-comment">// 添加到内容点赞集合</span>
   .<span class="hljs-title function_">setex</span>(userKey, <span class="hljs-number">86400</span>, <span class="hljs-string">'1'</span>) <span class="hljs-comment">// 设置用户点赞标记，24小时过期</span>
   .<span class="hljs-title function_">incr</span>(<span class="hljs-string">`like_count:<span class="hljs-subst">${contentId}</span>`</span>) <span class="hljs-comment">// 点赞数+1</span>
   .<span class="hljs-title function_">exec</span>();
}

</code></pre>
<p>生成代码之后。我对此代码进行审查，基本满足处理<strong>高并发</strong>的需求。</p>
<h5 data-id="heading-8"><strong>2. 保证强一致性：生成幂等性处理与分布式锁</strong></h5>
<p>针对“防止重复统计”，TRAE SOLO会注入防重逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 幂等性处理 - 确保同一请求仅处理一次</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">likeContentWithIdempotency</span>(<span class="hljs-params">userId, contentId, requestId</span>) {
  <span class="hljs-keyword">const</span> idempotencyKey = <span class="hljs-string">`idempotency:<span class="hljs-subst">${requestId}</span>`</span>;
  
  <span class="hljs-comment">// 使用SETNX实现分布式锁，防止并发重复请求</span>
  <span class="hljs-keyword">const</span> lockAcquired = <span class="hljs-keyword">await</span> redis.<span class="hljs-title function_">setnx</span>(idempotencyKey, <span class="hljs-string">'processing'</span>);
  <span class="hljs-keyword">if</span> (!lockAcquired) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Request processing'</span>);
  }
  <span class="hljs-keyword">await</span> redis.<span class="hljs-title function_">expire</span>(idempotencyKey, <span class="hljs-number">30</span>); <span class="hljs-comment">// 30秒自动过期</span>
  
  <span class="hljs-comment">// ... 核心点赞逻辑</span>
}
</code></pre>
<h5 data-id="heading-9"><strong>3. 满足实时性：生成轻量级API与高效查询</strong></h5>
<p>为确保“200毫秒响应”，TRAE SOLO会设计最简API：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 极简查询接口，所有数据在Redis中完成</span>
app.<span class="hljs-keyword">get</span>(<span class="hljs-string">'/api/content/:id/like-count'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
  <span class="hljs-keyword">const</span> count = <span class="hljs-keyword">await</span> redis.<span class="hljs-keyword">get</span>(`like_count:${req.<span class="hljs-keyword">params</span>.id}`);
  res.json({ count: parseInt(count) || <span class="hljs-number">0</span> });
});

</code></pre>
<h4 data-id="heading-10"><strong>第三步：集成风控规则，抵御安全威胁</strong></h4>
<p>针对上述提到的<strong>多样化攻击手段</strong>，提示TRAE SOLO生成动态规则引擎。</p>
<h5 data-id="heading-11"><strong>风控核心代码示例</strong>：</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// TRAE SOLO生成的风控规则引擎核心</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AntiSpamService</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">checkLikeSafety</span>(<span class="hljs-params">userId, ip, deviceFingerprint</span>) {
    <span class="hljs-keyword">const</span> rules = [
      <span class="hljs-comment">// 规则1: IP频率限制 (防IP池轮换/分布式攻击)</span>
      { <span class="hljs-attr">key</span>: <span class="hljs-string">`ip:<span class="hljs-subst">${ip}</span>`</span>, <span class="hljs-attr">limit</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">window</span>: <span class="hljs-number">3600</span> }, <span class="hljs-comment">// 1小时内最多100次</span>
      
      <span class="hljs-comment">// 规则2: 用户频率限制 (防自动化脚本)</span>
      { <span class="hljs-attr">key</span>: <span class="hljs-string">`user:<span class="hljs-subst">${userId}</span>`</span>, <span class="hljs-attr">limit</span>: <span class="hljs-number">60</span>, <span class="hljs-attr">window</span>: <span class="hljs-number">3600</span> },
      
      <span class="hljs-comment">// 规则3: 设备指纹限制 (防设备指纹伪造)</span>
      { <span class="hljs-attr">key</span>: <span class="hljs-string">`device:<span class="hljs-subst">${deviceFingerprint}</span>`</span>, <span class="hljs-attr">limit</span>: <span class="hljs-number">50</span>, <span class="hljs-attr">window</span>: <span class="hljs-number">3600</span> }
    ];

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> rule <span class="hljs-keyword">of</span> rules) {
      <span class="hljs-keyword">const</span> count = <span class="hljs-keyword">await</span> redis.<span class="hljs-title function_">incr</span>(rule.<span class="hljs-property">key</span>);
      <span class="hljs-keyword">if</span> (count === <span class="hljs-number">1</span>) <span class="hljs-keyword">await</span> redis.<span class="hljs-title function_">expire</span>(rule.<span class="hljs-property">key</span>, rule.<span class="hljs-property">window</span>);
      <span class="hljs-keyword">if</span> (count &gt; rule.<span class="hljs-property">limit</span>) {
        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reportSuspiciousActivity</span>(userId, ip, <span class="hljs-string">'FREQUENCY_OVERFLOW'</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// 触发风控</span>
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 安全</span>
  }
}


</code></pre>
<h4 data-id="heading-12"><strong>总结</strong></h4>
<p>通过以上步骤，我们借助TRAE SOLO将防刷赞系统，系统性地转化为一个具备可用性的防刷赞系统。它不仅解决了<strong>高并发、强一致性、低延迟</strong>的技术挑战，还通过动态风控规则有效抵御了<strong>多样化、产业化的安全威胁</strong>。</p>
<p>TRAE SOLO在此过程中的角色远不止代码生成器，它更是一个<strong>架构顾问、安全专家和自动化工程师</strong>，将抽象的需求和威胁分析，转化为可执行、可维护的高质量代码，极大提升了复杂系统开发的效率与可靠性。</p>
<h2 data-id="heading-13">TRAE SOLO的强大性是什么</h2>
<p>TRAE SOLO的强大性体现在“加速”而非“替代”。它并不能凭空变出这样一个完美的系统，而在于它如何<strong>重塑我们构建防刷赞系统这种复杂系统的流程和效率</strong>。静思考过后，我觉得TRAE SOLO的“不断强大”依赖于“强大的使用者”。
重新定义了“强大”的协作模式，它能<strong>将我们构建这种系统的能力，提升了一个数量级</strong>。</p>
<p>此文章对防刷赞系统的设计并不全面，后续会根据具体情况不断完善。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[openGauss进阶：使用DBeaver可视化管理与实战]]></title>    <link>https://juejin.cn/post/7574972697676365860</link>    <guid>https://juejin.cn/post/7574972697676365860</guid>    <pubDate>2025-11-21T07:51:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574972697676365860" data-draft-id="7574958975159369771" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="openGauss进阶：使用DBeaver可视化管理与实战"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2025-11-21T07:51:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="倔强的石头_"/> <meta itemprop="url" content="https://juejin.cn/user/3168119757484368"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            openGauss进阶：使用DBeaver可视化管理与实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3168119757484368/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    倔强的石头_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T07:51:28.000Z" title="Fri Nov 21 2025 07:51:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>@[toc]</p>
<h2 data-id="heading-0">一、引言</h2>
<p>在上一篇文章中，我们成功地在CentOS 7.9上部署了openGauss数据库，并通过<code>gsql</code>命令行验证了其基本功能。命令行虽然直接高效，但在处理复杂SQL、进行数据分析和日常管理时，图形化界面（GUI）工具往往能提供更直观、更便捷的操作体验。本篇将使用通用且强大的数据库客户端——DBeaver（Community Edition）进行演示。</p>
<p>本文将承接上文，详细介绍如何安装和使用DBeaver来连接openGauss数据库，并通过实际操作，演示如何利用它进行数据库的可视化管理、复杂SQL查询及基础特性验证。无论您是数据库管理员（DBA）还是初级开发者，本文都将帮助您更高效地玩转openGauss。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c5ed74f945c4a908d5e5f4027d20f87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316288&amp;x-signature=bpArnXmFD5w4X%2Fu7kXS%2Fww9P1CE%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">二、DBeaver 简介</h2>
<p>DBeaver是一款跨平台的通用数据库客户端，支持包括PostgreSQL在内的众多数据库。openGauss兼容PostgreSQL生态，因此使用DBeaver的PostgreSQL驱动即可稳定连接与操作openGauss。DBeaver提供丰富的特性，适合日常开发与DBA管理。</p>
<h3 data-id="heading-2">主要功能</h3>
<ul>
<li><strong>连接管理</strong>：集中管理多个连接，支持会话复用与独立会话。</li>
<li><strong>对象浏览器</strong>：树状结构展示模式、表、视图、函数等对象。</li>
<li><strong>SQL编辑器</strong>：语法高亮、代码补全、格式化、结果集可视化与导出。</li>
<li><strong>数据导入/导出</strong>：支持CSV、JSON等格式的数据导入与导出。</li>
<li><strong>事务与会话控制</strong>：支持自动提交与手动事务，便于并发与隔离性实验。</li>
</ul>
<h2 data-id="heading-3">三、安装与配置DBeaver</h2>
<p>DBeaver是一款客户端工具，您需要在本地的Windows、macOS或Linux开发机上安装。本篇以“CentOS 7.9 + openGauss 极简版（simpleInstall）”为后端环境为例，演示从本地开发机远程连接到服务器。</p>
<h3 data-id="heading-4">3.1下载 DBeaver（社区版）</h3>
<p>访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fdbeaver.io%2Fdownload%2F" target="_blank" title="https://dbeaver.io/download/" ref="nofollow noopener noreferrer">DBeaver官方下载页面</a>下载适配您的操作系统的安装包
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7e04927f37e4890a70ae437e34f290c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316288&amp;x-signature=4xgV7HpPbz5MhjP59qJfs5a5PJw%3D" alt="c3769cdfcdc5f86e322786b52023bbcc.png" loading="lazy"/></p>
<h3 data-id="heading-5">3.2 安装 DBeaver</h3>
<p>以Windows为例，双击下载的<code>.exe</code>文件，按照安装向导提示完成安装</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0675f6fe485d4442a6288b36adc7c266~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316288&amp;x-signature=87U5mPQuXX95NjNDzfK8Kk8a43M%3D" alt="image.png" loading="lazy"/></p>
<p>安装界面中的组件含义如下（以社区版为例）：</p>



































<table><thead><tr><th>组件名称</th><th>功能说明</th><th>是否必选</th></tr></thead><tbody><tr><td><strong>DBeaver Community</strong></td><td>DBeaver 主程序（核心功能，包括数据库连接、SQL 编辑、数据管理等）。</td><td>✅ 必选</td></tr><tr><td><strong>Include Java</strong></td><td>安装 DBeaver 自带的 Java 运行环境（JRE）。</td><td>❗ 可选</td></tr><tr><td><strong>Reset Settings</strong></td><td>安装后将 DBeaver 配置重置为默认（如界面布局、连接配置等）。</td><td>❌ 不推荐</td></tr><tr><td><strong>Associate .SQL files</strong></td><td>将 <code>.sql</code> 文件与 DBeaver 关联，双击 SQL 文件默认用 DBeaver 打开。</td><td>❗ 可选</td></tr><tr><td><strong>Associate SQLite database files</strong></td><td>将 SQLite 数据库文件（<code>.db</code>）与 DBeaver 关联。</td><td>❗ 可选</td></tr></tbody></table>
<h3 data-id="heading-6">3.3 环境要求与驱动说明</h3>
<ul>
<li>DBeaver依赖 <code>JRE 1.8+</code>。Windows安装版自带JRE（在刚刚安装时选择组件），免安装版需自行安装JRE。</li>
<li>openGauss可直接使用DBeaver内置的PostgreSQL驱动进行连接；如遇兼容问题，可按官方指南手动添加openGauss JDBC驱动（详见后文“可选方案”）。</li>
</ul>
<h3 data-id="heading-7">3.4 创建数据库连接</h3>
<p>安装完成后，启动DBeaver。首次使用时，我们需要创建一个到openGauss服务器的连接：</p>
<ol>
<li>
<p>点击顶部菜单 <code>数据库 -&gt; 新建数据库连接</code>。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f8f1864b5ad426d913b1dfb17441cbc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316288&amp;x-signature=7nTPvVEicf5MnCQHS5HOzUwD%2B6w%3D" alt="17922c2e0ac4a49a81d08e9ae6771fb7.png" loading="lazy"/></p>
</li>
<li>
<p>方案A（推荐）：在数据库列表中选择 <code>PostgreSQL</code> 驱动。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1644a099a1414527a50ce7b5affe8387~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316288&amp;x-signature=HFfMy0luapq6ZRIsKsaHSTAINlQ%3D" alt="image.png" loading="lazy"/></p>
</li>
<li>
<p>方案B（可选）：若已按官方指南添加了 openGauss JDBC 驱动，则在列表中选择该自定义驱动。[0]</p>
</li>
<li>
<p>在弹出的连接配置窗口中，填写以下信息：</p>
<ul>
<li><code>Host</code>：您在华为云上部署的openGauss服务器的公网IP地址。</li>
<li><code>Port</code>：默认为 <code>5432</code>。</li>
<li><code>Database</code>：例如 <code>postgres</code>。</li>
<li><code>Username</code>：安装时创建的 <code>omm</code> 用户或其他用户。</li>
<li><code>Password</code>：对应的用户密码。</li>
</ul>
</li>
<li>
<p>首次使用可能提示下载PostgreSQL驱动，点击确认。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49cef5f17be64a81ad1d49139bacc1b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316288&amp;x-signature=bWJW0ZjMl8z5TR7SmxOo7C%2FoCtc%3D" alt="image.png" loading="lazy"/></p>
</li>
<li>
<p>点击“Test Connection”进行测试，成功后点击“Finish”保存配置。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73b40287d17741d487edcef9c859bdcd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316288&amp;x-signature=MuU%2BPqIaEic3qDbeaCiZh%2BAHrlE%3D" alt="image.png" loading="lazy"/></p>
</li>
</ol>
<p>连接成功后，您将在左侧的对象浏览器（Database Navigator）中看到数据库的完整结构。</p>
<h3 data-id="heading-8">3.5 远程连接前的必要准备（与极简版匹配）</h3>
<p>极简版安装默认仅在本机监听，若从本地 DBeaver 远程连接，需要完成以下准备（在服务器的<code>omm</code>用户下执行）：</p>
<ol>
<li>调整监听地址（<code>postgresql.conf</code>）：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">vi /opt/opengauss/data/single_node/postgresql.conf
<span class="hljs-comment"># 将 listen_addresses 改为允许远程（推荐为'*'，或指定内网/公网IP）</span>
listen_addresses = <span class="hljs-string">'*'</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/015a703b4cd349ae8849caa510f3d3ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316288&amp;x-signature=c7406qKQYUuh5bqF7VFXIwRNdNk%3D" alt="image.png" loading="lazy"/></p>
<ol start="2">
<li>允许远程客户端访问（<code>pg_hba.conf</code>）：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">vi /opt/opengauss/data/single_node/pg_hba.conf
<span class="hljs-comment"># 在文件末尾添加一行（按需收敛网段）</span>
host    all     all     0.0.0.0/0       md5
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a7085640b774863a039645665ae449a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316288&amp;x-signature=GmNWROPcpa%2BUo0B9Dx12J1We2Yg%3D" alt="image.png" loading="lazy"/></p>
<ol start="3">
<li>重启数据库使配置生效：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">gs_ctl restart -D /opt/opengauss/data/single_node -Z single_node
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b85991ba719e4a6d80b122f8e4850cff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316288&amp;x-signature=9y3O5sFi2cOKl3fbJ6gP07TDfXQ%3D" alt="image.png" loading="lazy"/></p>
<ol start="4">
<li>检查端口监听（确保5432启动）：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">ss -ltnp | grep 5432
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d1292c3b05b446abe5f24c2618cf5c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316288&amp;x-signature=BO9LonoomfacGb%2B2REB4a194Gw8%3D" alt="image.png" loading="lazy"/></p>
<ol start="5">
<li>云服务器安全组/防火墙：</li>
</ol>
<ul>
<li>在云控制台开放<code>TCP 5432</code>入站规则到您的开发机IP段。</li>
<li>若之前在入门篇中关闭了<code>firewalld</code>，通常无需额外开放系统防火墙，但仍需确认云安全组规则。</li>
</ul>
<p>完成以上准备后，回到 DBeaver 测试连接即可。</p>
<h3 data-id="heading-9">3.6连接参数示例</h3>
<p>若您按入门篇极简版安装并设置了示例密码<code>Gauss@123456</code>，可参考如下参数：</p>
<pre><code class="hljs language-text" lang="text">主机：&lt;您的服务器公网IP&gt;
端口：5432
数据库：postgres
用户：omm
密码：Gauss@123456
</code></pre>
<h3 data-id="heading-10">3.7使用 openGauss JDBC 驱动（可选方案）</h3>
<p>当内置PostgreSQL驱动在您的openGauss版本上出现兼容性问题时，可按官方指南添加openGauss JDBC驱动：[0]</p>
<ol>
<li>菜单 <code>Database -&gt; Driver Manager</code>，点击“New”。</li>
<li>添加JDBC驱动文件（从openGauss官网获取JDBC驱动Jar）。</li>
<li>选择JDBC Driver类：<code>org.postgresql.Driver</code>。</li>
<li>设置URL模板：<code>jdbc:postgresql://{host}:{port}/{database}</code>，并勾选“Embed”。[0]</li>
<li>保存驱动后，在“新建连接”时选择该自定义驱动，按前述参数填写并测试连接。</li>
<li>如数据库仅能通过SSH访问，可在连接属性中配置 <code>SSH Tunnel</code>（Connection settings -&gt; SSH）。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7270a1a322f4783ac0a2b1ed4b10a8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316288&amp;x-signature=xWscr9Q1O5OdFRZPV9zBGhQ82j4%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-11">四、使用DBeaver进行数据库实战</h2>
<p>现在，让我们通过几个实际场景，体验DBeaver带来的便捷。</p>
<h3 data-id="heading-12">4.1 可视化数据查询与编辑</h3>
<p>在上一篇文章中，我们创建了一个<code>test</code>表。现在，我们可以在DBeaver中轻松地对它进行操作。</p>
<ol>
<li>在对象浏览器中，依次展开连接 -&gt; <code>Schemas -&gt; public -&gt; Tables</code>，找到<code>test</code>表。</li>
<li>右键点击<code>test</code>表，选择“View Data”。DBeaver会执行查询并在新的数据编辑器标签页中以表格形式展示数据。</li>
<li>您可以直接在结果表格中修改数据，然后点击工具栏上的“Save”按钮，DBeaver会自动生成对应的<code>UPDATE</code>语句并执行。</li>
<li>同样，也可以通过工具栏按钮插入或删除行。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53c4c07b10a64b339b3f181890c8cf72~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316288&amp;x-signature=PaiqUsek1WOCI1adz8kbmfrvkKU%3D" alt="image.png" loading="lazy"/></li>
</ol>
<h3 data-id="heading-13">4.2 编写和执行复杂SQL</h3>
<p>DBeaver的SQL编辑器是其核心功能之一。让我们来尝试一个稍复杂的查询。[0]</p>
<p>假设我们需要分析一个“订单”表（<code>orders</code>）和一个“用户”表（<code>users</code>），找出消费总额最高的前10位用户。</p>
<p>首先，我们创建并填充一些示例数据。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建用户表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users (
    user_id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    user_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>)
);

<span class="hljs-comment">-- 创建订单表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    order_id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    user_id <span class="hljs-type">INT</span>,
    order_amount <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>),
    order_date <span class="hljs-type">DATE</span>
);

<span class="hljs-comment">-- 插入示例数据</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">'Alice'</span>), (<span class="hljs-number">2</span>, <span class="hljs-string">'Bob'</span>), (<span class="hljs-number">3</span>, <span class="hljs-string">'Charlie'</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">101</span>, <span class="hljs-number">1</span>, <span class="hljs-number">150.00</span>, <span class="hljs-string">'2023-10-01'</span>), (<span class="hljs-number">102</span>, <span class="hljs-number">2</span>, <span class="hljs-number">200.50</span>, <span class="hljs-string">'2023-10-02'</span>), (<span class="hljs-number">103</span>, <span class="hljs-number">1</span>, <span class="hljs-number">75.25</span>, <span class="hljs-string">'2023-10-03'</span>);
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d20e2973a6743ffa73d04bec0338f44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316288&amp;x-signature=y%2BeEloNZtGd59ngXQI6yLECvKuo%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d330175f5a94591826e3d795d0485b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316288&amp;x-signature=ZeRJsjx5cd07bj50vQuZGAx1Ntg%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e896efdf80ea4f1e95c41fb5a7be3f3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316288&amp;x-signature=WfqsrbzZ%2Bt2A%2BQsbDS8VJIawshs%3D" alt="image.png" loading="lazy"/></p>
<p>现在，我们可以在SQL编辑器中编写<code>JOIN</code>和<code>GROUP BY</code>查询。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> 
    u.user_name,
    <span class="hljs-built_in">SUM</span>(o.order_amount) <span class="hljs-keyword">AS</span> total_spent
<span class="hljs-keyword">FROM</span> 
    users u
<span class="hljs-keyword">JOIN</span> 
    orders o <span class="hljs-keyword">ON</span> u.user_id <span class="hljs-operator">=</span> o.user_id
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> 
    u.user_name
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> 
    total_spent <span class="hljs-keyword">DESC</span>
LIMIT <span class="hljs-number">10</span>;
</code></pre>
<p>在编写过程中，你会体验到DBeaver的代码补全与格式化功能。按下<code>Ctrl+Enter</code>或点击编辑器工具栏的“Execute”按钮，查询结果会立即显示在下方的结果面板。也可按<code>F3</code>打开或切换到SQL编辑器。</p>
<h3 data-id="heading-14">4.3 验证基础特性：事务处理</h3>
<p>数据库的事务特性（ACID）是保证数据一致性的基石。我们可以通过DBeaver来直观地验证openGauss的事务处理能力。</p>
<p>在DBeaver中关闭自动提交、并打开两个独立会话的SQL编辑器，模拟并发事务场景。</p>
<p>准备：在SQL编辑器工具栏取消勾选“Auto-commit”，确保使用显式事务；并在同一连接上通过“Open New SQL Console”打开两个控制台，或复制连接以获得两个独立会话。</p>
<p><strong>窗口1：</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 开始一个事务</span>
<span class="hljs-keyword">START</span> TRANSACTION;

<span class="hljs-comment">-- 更新Alice的用户名</span>
<span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> user_name <span class="hljs-operator">=</span> <span class="hljs-string">'Alice_new'</span> <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;

<span class="hljs-comment">-- 在本事务中查询，可以看到修改后的结果</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
</code></pre>
<p><strong>窗口2：</strong></p>
<p>在窗口1执行<code>UPDATE</code>后，但在执行<code>COMMIT</code>或<code>ROLLBACK</code>之前，在窗口2中执行查询。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 在另一个会话中查询，由于事务未提交，看到的是旧数据</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
</code></pre>
<p>您会发现，窗口2查询到的仍然是<code>Alice</code>，而不是<code>Alice_new</code>。这体现了事务的隔离性。</p>
<p>现在，回到<strong>窗口1</strong>，在编辑器工具栏点击“Commit”或执行：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 提交事务</span>
<span class="hljs-keyword">COMMIT</span>;
</code></pre>
<p>再次在<strong>窗口2</strong>中执行查询，您会看到用户名已经变成了<code>Alice_new</code>。若需回滚，可点击“Rollback”。</p>
<h3 data-id="heading-15">4.4 常见远程连接失败排查</h3>
<ul>
<li>确认数据库已启动：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">gs_ctl status -D /opt/opengauss/data/single_node
</code></pre>
<ul>
<li>端口未监听：检查<code>postgresql.conf</code>的<code>listen_addresses</code>是否为<code>'*'</code>；重新启动后用<code>ss -ltnp | grep 5432</code>确认。</li>
<li>认证失败：检查<code>pg_hba.conf</code>是否有匹配的<code>host</code>规则，认证方式为<code>md5</code>；密码是否正确。</li>
<li>外网不可达：检查云安全组入站规则是否开放<code>5432</code>到您的本地IP范围。</li>
</ul>
<h3 data-id="heading-16">4.5 常见客户端驱动问题排查（DBeaver）</h3>
<ul>
<li>报错 <code>javax.xml.bind.DatatypeConverter</code> 类型转换错误：
<ul>
<li>现象：执行连接或查询时抛出<code>javax.xml.bind</code>相关异常。</li>
<li>解决：在添加JDBC驱动Jar时额外加入<code>jaxb-api</code>包（例如<code>javax.xml.bind:jaxb-api:2.2.2</code>）。</li>
</ul>
</li>
<li>报错 <code>No suitable driver found for jdbc:postgresql://...</code>：
<ul>
<li>现象：测试连接失败，提示未找到合适的驱动。</li>
<li>解决：在自定义驱动中不要勾选“Use legacy JDBC instantiation”；确认已选择正确的Driver类与URL模板。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-17">五、openGauss 安全性与优势补充（基于本次实战）</h2>
<p>openGauss 在安全性上秉承“安全缺省（secure-by-default）”的设计理念，本次连接排查过程中触达的多项机制正体现了这种优势。以下结合实战现象，归纳其关键安全特性与使用建议。</p>
<ul>
<li>安全默认策略（防止弱配置被远程利用）
<ul>
<li>初始用户远程登录禁止：当使用安装时的初始超级用户（如 <code>omm</code>）从远程登录时，服务器会直接拒绝，报错类似于 <code>FATAL: Forbid remote connection with initial user.</code>。这能有效降低默认高权限账户被远程暴力尝试或泄露后的风险。建议在服务器本机使用初始用户进行运维，并为业务创建独立账户用于远程访问：</li>
</ul>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26b72b535e17454298e19d3f481210db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316288&amp;x-signature=E%2FMNubR%2BQyLG0N3Sdhkj4jUjlUs%3D" alt="d76ea1e97709d50f602bc02a8d55cf15.png" loading="lazy"/></p>
<pre><code class="hljs language-sql" lang="sql">```<span class="hljs-keyword">sql</span>
<span class="hljs-comment">-- 在服务器本机以初始用户登录后创建业务账户</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> dbuser <span class="hljs-keyword">WITH</span> PASSWORD <span class="hljs-string">'S@fePwd_2025'</span>;
<span class="hljs-comment">-- 仅在确有需要时再授予更高权限</span>
<span class="hljs-comment">-- ALTER USER dbuser SYSADMIN;</span>
```
</code></pre>
<ul>
<li>
<p>远程 trust 认证禁止：远程连接命中 <code>trust</code> 规则时会被明确拒绝，常见报错为 <code>FATAL: Forbid remote connection with trust method!</code>。这迫使远程访问必须进行口令或更强认证，减少误用与错配带来的潜在风险。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/711ff28a45da4f41bdb2162534ca4a93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316288&amp;x-signature=api%2FjA%2Bon9PCEsExH6nAaYWj6CI%3D" alt="f756de60b788ba641b22edca86dcb57c.png" loading="lazy"/></p>
</li>
<li>
<p>细粒度访问控制（可按网段/IP 精准授权）</p>
<ul>
<li>通过 <code>pg_hba.conf</code> 对不同来源、用户、数据库设定认证方式，规则按“自上而下”匹配，靠前规则优先。推荐为远程访问使用 <code>sha256</code> 或至少 <code>md5</code>，并按需收敛到具体 IP 段：
# IPv4 与 IPv6 的远程访问示例（建议收敛网段）
host  all  all  0.0.0.0/0    sha256
host  all  all  ::0/0        sha256
# 仅允许某公网 IP 的更严格示例
host  all  all  218.12.13.160/32  sha256</li>
<li>远程 <code>trust</code> 不应启用；本机访问可以保留 <code>local/127.0.0.1/::1</code> 的 <code>trust</code> 以便便捷运维。</li>
</ul>
</li>
<li>
<p>强口令与加密策略（与认证方式协同）</p>
<ul>
<li>支持设置 <code>password_encryption_type=2</code>（SHA-256）。当切换加密策略后，需要为相关用户“重置密码”，以新的策略生成密文；否则可能出现认证失败或握手异常（例如客户端报 <code>EOF Exception</code>）。</li>
<li>与 <code>pg_hba.conf</code> 规则保持一致：若采用 <code>sha256</code>，远程规则也应为 <code>sha256</code>，避免命中 <code>md5</code> 或其他不一致导致的失败。</li>
</ul>
</li>
<li>
<p>网络与 SSL 行为（避免握手错配）</p>
<ul>
<li><code>listen_addresses='*'</code> 或指定监听 IP，确保对外服务可达；</li>
<li>若服务器 <code>ssl=off</code>，客户端需使用 <code>sslmode=disable</code>；若服务器启用 SSL，则在客户端改为 <code>sslmode=require</code> 并正确配置证书。以 DBeaver 为例，也可在 JDBC URL 里直接带参数：
jdbc:opengauss://:5432/?sslmode=disable&amp;preferQueryMode=simple</li>
</ul>
</li>
<li>
<p>可观测性与热加载（降低维护成本）</p>
<ul>
<li>日志会明确记录拒绝原因，如 <code>no pg_hba.conf entry</code>、<code>password authentication failed</code>、<code>Forbid remote connection with initial user</code> 等，便于快速定位；</li>
<li>通过 <code>gs_ctl reload</code> 可在不重启的情况下加载 <code>pg_hba.conf/postgresql.conf</code> 的部分变更，提升运维效率。</li>
</ul>
</li>
<li>
<p>生态兼容优势（客户端与驱动）</p>
<ul>
<li>兼容 PostgreSQL 生态，DBeaver 等主流客户端可稳定使用；</li>
<li>使用 openGauss JDBC 驱动或内置 PostgreSQL 驱动，配合属性如 <code>preferQueryMode=simple</code>、<code>BCmptMode=true</code>，可在多版本场景下获得更好的兼容体验。</li>
</ul>
</li>
</ul>
<p>小结：openGauss 的安全默认策略与可配置认证机制，使其在对外服务时具备更高的安全基线，同时保留足够的灵活性供运维人员按需收敛授权范围与加密策略。这些特性在企业生产环境中能有效降低误配置风险并提升合规性。</p>
<h2 data-id="heading-18">六、总结与展望</h2>
<p>通过本文的介绍，您应该已经掌握了如何使用DBeaver来高效地管理和开发openGauss数据库。DBeaver将繁琐的命令行操作简化为直观的图形化点击，无论是数据查询、SQL开发还是特性验证，都变得更加轻松。</p>
<p>然而，对于应用开发者而言，更关心的是如何在代码中与数据库进行交互。在下一篇，也是本系列的最后一篇文章中，我们将以Python语言为例，深入探讨如何通过编程方式连接openGauss，并结合“用户管理系统”和“订单支付流程”等具体业务场景，编写包含CRUD（增删改查）和事务处理的完整代码示例，敬请期待！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[约课小程序增加候补功能]]></title>    <link>https://juejin.cn/post/7574803558878281743</link>    <guid>https://juejin.cn/post/7574803558878281743</guid>    <pubDate>2025-11-21T08:47:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574803558878281743" data-draft-id="7571156741396938767" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="约课小程序增加候补功能"/> <meta itemprop="keywords" content="前端,小程序·云开发,微信小程序"/> <meta itemprop="datePublished" content="2025-11-21T08:47:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="gongzemin"/> <meta itemprop="url" content="https://juejin.cn/user/3931509311681192"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            约课小程序增加候补功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3931509311681192/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    gongzemin
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T08:47:00.000Z" title="Fri Nov 21 2025 08:47:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>先前写了一个<a href="https://juejin.cn/post/7469648317317038115" target="_blank" title="https://juejin.cn/post/7469648317317038115">约课小程序</a>，最近想增加候补功能。举个例子，课程容量20人，预约满了后，用户可以选择候补，加入候补队列。一旦有人取消预约，系统将自动按候补顺序递补名额。</p>
<p>我们先梳理下候补要修改的逻辑</p>






























<table><thead><tr><th>功能模块</th><th>详细说明</th><th>关键点</th></tr></thead><tbody><tr><td>✅ 按钮状态智能判断</td><td>根据课程状态和用户预约情况动态显示按钮</td><td><strong>预约</strong>：课程未满员<br/><strong>候补</strong>：课程已满员（确认预约 &gt;= 容量）<br/><strong>取消预约</strong>：用户已正式预约<br/><strong>取消候补(第X位)</strong>：用户在候补列表中</td></tr><tr><td>✅ 候补队列管理</td><td>完整的候补排队机制</td><td>按预约时间顺序自动排队<br/>显示候补位置（第1位、第2位...）<br/>候补用户不消耗次数</td></tr><tr><td>✅ 自动提升机制</td><td>候补自动转正式预约流程</td><td>有人取消正式预约时触发<br/>候补第一位自动转为确认预约<br/>自动扣除该用户的次数<br/>其他候补用户位置自动前移</td></tr><tr><td>✅ 数据结构变更</td><td>reservations 表添加新字段</td><td><code>status</code>: "confirmed" | "waitlist"（预约状态）<br/><code>waitlist_position</code>: Number（候补位置，仅候补时有值）</td></tr></tbody></table>
<p>我们想要的效果，如果课程预约已满，那么就显示候补按钮；如果已经成功候补，那么就显示候补中，并且告知用户候补排名</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c846c76a34f43ebbebc848e226663d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29uZ3plbWlu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764319619&amp;x-signature=l%2FjeS%2FMpZYNgQEnr0Vt7E22gP%2Fg%3D" alt="image.png" loading="lazy"/></p>
<p>我们主要分为以下几部分</p>
<ul>
<li>修改用户预约表: 新增预约状态、候补位置字段</li>
<li>修改后端: 预约/取消预约逻辑; 新增/取消候补 候补位置</li>
<li>修改前端: 显示候补、已候补按钮 候补排名</li>
</ul>
<h5 data-id="heading-0">修改用户预约表: 新增预约状态、候补位置字段</h5>
<p>这是我们的<code>user-reserve</code>表结构，user-reserve.schema.json文件，我们需要增加2个字段<code>status</code>, <code> waitlist_position</code></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"bsonType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"object"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"permission"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"read"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"create"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"update"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"delete"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"properties"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ID，系统自动生成"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    ...
    <span class="hljs-attr">"status"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"bsonType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"预约状态"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"预约状态：confirmed(已确认) / waitlist(候补)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"enum"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"confirmed"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"waitlist"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"defaultValues"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"confirmed"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"waitlist_position"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"bsonType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"int"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"候补位置"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"如果是候补状态，记录候补顺序位置"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h5 data-id="heading-1">后端预约的逻辑</h5>
<ul>
<li><strong>查询预约那节课的可容纳人数</strong>：  因为我们现在要判断用户是否需要候补，我们需要获取课程的<code>capacity</code>，每节课的可容纳人数，去查询<code>class-schedule</code>表，如下面代码，我们查询后获取capacity字段</li>
</ul>

<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">classInfo</span> = await db
        .collection("class-schedule")
        .doc(queryClassId)
        .get()<span class="hljs-comment">;</span>
if (!classInfo.data.length) {
    return {
      code: 404,
      message: "未找到课程信息",
    }<span class="hljs-comment">;</span>
}
uniCloud.logger.info("classInfo", classInfo)<span class="hljs-comment">;</span>
const <span class="hljs-attr">classData</span> = classInfo.data[<span class="hljs-number">0</span>]<span class="hljs-comment">;</span>
const <span class="hljs-attr">classCapacity</span> = classData.capacity || <span class="hljs-number">10</span><span class="hljs-comment">;</span>
uniCloud.logger.info("params", queryClassId, clickDate)<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li><strong>查询预约那节课的已预约人数</strong>： 我们查询<code>user-reserve</code>用户预约表，因为我们的课表是每周周而复始的，不同星期同一时间段的课表ID是一样的，所以我们查询的时候，要加上日期（上课的那天），这样就查不出历史上课数据了，免得受历史数据影响，而且我们设置了查询上课那天的一整天，这样也不会漏数据了</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 传给bookCourse方法的参数</span>
<span class="hljs-keyword">const</span> { userId, avatar, queryClassId, clickDate, cardId, cardType } =
  params;
<span class="hljs-keyword">const</span> db = uniCloud.<span class="hljs-title function_">database</span>();
<span class="hljs-keyword">const</span> _ = db.<span class="hljs-property">command</span>;
<span class="hljs-comment">// 获取当天的起始时间 clickDate就是上课那天（预约时候点击日历对应的那天）</span>
<span class="hljs-keyword">const</span> startOfDay = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(clickDate);
startOfDay.<span class="hljs-title function_">setHours</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// 设置为当天 00:00:00.000</span>

<span class="hljs-comment">// 获取当天的结束时间</span>
<span class="hljs-keyword">const</span> endOfDay = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(clickDate);
endOfDay.<span class="hljs-title function_">setHours</span>(<span class="hljs-number">23</span>, <span class="hljs-number">59</span>, <span class="hljs-number">59</span>, <span class="hljs-number">999</span>); <span class="hljs-comment">// 设置为当天 23:59:59.999</span>
<span class="hljs-keyword">const</span> confirmedCount = (
    <span class="hljs-keyword">await</span> db
      .<span class="hljs-title function_">collection</span>(<span class="hljs-string">"user-reserve"</span>)
      .<span class="hljs-title function_">where</span>({
        <span class="hljs-attr">class_id</span>: queryClassId,
        <span class="hljs-attr">reserve_class_date</span>: _.<span class="hljs-title function_">gte</span>(startOfDay).<span class="hljs-title function_">and</span>(db.<span class="hljs-property">command</span>.<span class="hljs-title function_">lte</span>(endOfDay)),
        <span class="hljs-attr">canceled</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">status</span>: <span class="hljs-string">"confirmed"</span>,
      })
      .<span class="hljs-title function_">count</span>()
  ).<span class="hljs-property">total</span>;
</code></pre>
<ul>
<li><strong>查询用户是否已预约</strong>： 可能先前取消过，再次预约，数据库里还存有预约记录；如果先前没取消，前端逻辑没问题的话，那显示的就是取消预约、取消候补，就不会走这个逻辑</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 3. 检查用户是否已有预约</span>
<span class="hljs-keyword">const</span> existingReservation = <span class="hljs-keyword">await</span> db
.<span class="hljs-title function_">collection</span>(<span class="hljs-string">"user-reserve"</span>)
.<span class="hljs-title function_">where</span>({
  <span class="hljs-attr">user_id</span>: userId,
  <span class="hljs-attr">class_id</span>: queryClassId,
  <span class="hljs-attr">reserve_class_date</span>: _.<span class="hljs-title function_">gte</span>(startOfDay).<span class="hljs-title function_">and</span>(db.<span class="hljs-property">command</span>.<span class="hljs-title function_">lte</span>(endOfDay)), <span class="hljs-comment">// 筛选上课日期今天及以后的 同一个日期不存在相同课程ID的课 不然过去预约了 现在就无法预约</span>
})
.<span class="hljs-title function_">get</span>();
</code></pre>
<ul>
<li><strong>查询用户是否已预约</strong>：如果用户先前预约过，我们先判断是不是需要候补，如果需要候补，我们还要计算候补排名；如果不需要候补，就是成功预约，我们用.update()更新那条用户数据，如果是次卡，我们要减去1次</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"> if (existingReservation.data.length &gt; 0) {
    const <span class="hljs-attr">reservation</span> = existingReservation.data[<span class="hljs-number">0</span>]<span class="hljs-comment">;</span>
    if (!reservation.canceled) {
      return {
        code: 400,
        message: "该课程已预约，无需重复预约",
      }<span class="hljs-comment">;</span>
    }

    // 曾取消过 → 恢复预约
    const <span class="hljs-attr">newStatus</span> =
      confirmedCount &lt; classCapacity ? "confirmed" : "waitlist"<span class="hljs-comment">;</span>

    // 如果是候补状态,需要计算候补位置
    let <span class="hljs-attr">updateData</span> = {
      canceled: false,
      reserve_class_date: clickDate,
      reserve_time: Date.now(),
      status: newStatus,
    }<span class="hljs-comment">;</span>

    if (<span class="hljs-attr">newStatus</span> === <span class="hljs-string">"waitlist"</span>) {
      // 获取当前候补队列人数
      const <span class="hljs-attr">waitlistCount</span> = (
        await db
          .collection("user-reserve")
          .where({
            class_id: queryClassId,
            reserve_class_date: _.gte(startOfDay).and(
              db.command.lte(endOfDay)
            ),
            status: "waitlist",
            canceled: false,
          })
          .count()
      ).total<span class="hljs-comment">;</span>

      <span class="hljs-attr">updateData.waitlist_position</span> = waitlistCount + <span class="hljs-number">1</span><span class="hljs-comment">;</span>
    } else {
      // 如果是确认状态,清空候补位置
      <span class="hljs-attr">updateData.waitlist_position</span> = null<span class="hljs-comment">;</span>
    }

    await db
      .collection("user-reserve")
      .doc(reservation._id)
      .update(updateData)<span class="hljs-comment">;</span>

    uniCloud.logger.info(
      "恢复预约状态",
      newStatus,
      updateData.waitlist_position
    )<span class="hljs-comment">;</span>

    // 扣减次卡(仅确认状态)
    if (<span class="hljs-attr">cardType</span> === <span class="hljs-string">"sessionCard"</span> &amp;&amp; newStatus === <span class="hljs-string">"confirmed"</span>) {
      await db
        .collection("user-membership-card")
        .doc(cardId)
        .update({
          remainingSessions: _.inc(-1),
        })<span class="hljs-comment">;</span>
    }

    return {
      code: 200,
      message:
        <span class="hljs-attr">newStatus</span> === <span class="hljs-string">"confirmed"</span> ? <span class="hljs-string">"预约成功"</span> : <span class="hljs-string">"课程已满,已进入候补名单"</span>,
      status: newStatus,
      waitlist_position: updateData.waitlist_position, // 返回候补位置信息
    }<span class="hljs-comment">;</span>
  }
</code></pre>
<p>如果用户先前没有预约过，那就是新预约；我们同样先判断是不是要候补，候补计算候补排名，如果不是候补，成功预约，更新次卡</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 4. 新预约</span>
<span class="hljs-keyword">let</span> newReservationData = {
    <span class="hljs-attr">user_id</span>: userId,
    <span class="hljs-attr">class_id</span>: queryClassId,
    <span class="hljs-attr">reserve_class_date</span>: clickDate,
    <span class="hljs-attr">reserve_time</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
    <span class="hljs-attr">canceled</span>: <span class="hljs-literal">false</span>,
};

<span class="hljs-keyword">if</span> (confirmedCount &gt;= classCapacity) {
    <span class="hljs-keyword">const</span> waitlistCount = (
      <span class="hljs-keyword">await</span> db
        .<span class="hljs-title function_">collection</span>(<span class="hljs-string">"user-reserve"</span>)
        .<span class="hljs-title function_">where</span>({
          <span class="hljs-attr">class_id</span>: queryClassId,
          <span class="hljs-attr">reserve_class_date</span>: _.<span class="hljs-title function_">gte</span>(startOfDay).<span class="hljs-title function_">and</span>(
            db.<span class="hljs-property">command</span>.<span class="hljs-title function_">lte</span>(endOfDay)
          ),
          <span class="hljs-attr">status</span>: <span class="hljs-string">"waitlist"</span>,
        })
        .<span class="hljs-title function_">count</span>()
    ).<span class="hljs-property">total</span>;
    uniCloud.<span class="hljs-property">logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"waitlistCount"</span>, waitlistCount);

    newReservationData.<span class="hljs-property">status</span> = <span class="hljs-string">"waitlist"</span>;
    newReservationData.<span class="hljs-property">waitlist_position</span> = waitlistCount + <span class="hljs-number">1</span>;
} <span class="hljs-keyword">else</span> {
    newReservationData.<span class="hljs-property">status</span> = <span class="hljs-string">"confirmed"</span>;
    newReservationData.<span class="hljs-property">waitlist_position</span> = <span class="hljs-literal">null</span>;
}

<span class="hljs-keyword">const</span> addRes = <span class="hljs-keyword">await</span> db
.<span class="hljs-title function_">collection</span>(<span class="hljs-string">"user-reserve"</span>)
.<span class="hljs-title function_">add</span>(newReservationData);

<span class="hljs-comment">// 5. 扣减次卡</span>
<span class="hljs-keyword">if</span> (
cardType === <span class="hljs-string">"sessionCard"</span> &amp;&amp;
newReservationData.<span class="hljs-property">status</span> === <span class="hljs-string">"confirmed"</span>
) {
<span class="hljs-keyword">await</span> db
  .<span class="hljs-title function_">collection</span>(<span class="hljs-string">"user-membership-card"</span>)
  .<span class="hljs-title function_">doc</span>(cardId)
  .<span class="hljs-title function_">update</span>({
    <span class="hljs-attr">remainingSessions</span>: _.<span class="hljs-title function_">inc</span>(-<span class="hljs-number">1</span>),
  });
}
</code></pre>
<blockquote>
<p>上面就是预约的逻辑，判断预约/候补, 逻辑好像有点冗余；因为用户点击按钮的时候，那个按钮就有文字预约/候补，直接做为参数传过来就行</p>
</blockquote>
<p>我们这样相当于双保险，以防前端判断逻辑出现问题，我们后端也能校验，确保预约/候补 逻辑正确</p>
<h5 data-id="heading-2">前端按钮文案 预约/候补 取消预约/取消候补 判断</h5>
<p>我们先回顾下我们课表逻辑，</p>
<pre><code class="hljs language-bash" lang="bash">管理员创建课程模板（循环课表）
   ↓
每周复用这些模板
   ↓
用户预约时，我们有预约课程的具体日期
   ↓
通过 class_id + reserve_class_date 来唯一标识<span class="hljs-string">"某天的某节课"</span>
</code></pre>
<h6 data-id="heading-3">每天课表的渲染逻辑</h6>
<p>当用户点击某天的时候，我们知道某天对应是周几，我们查询课表<code>class-schedule</code>，根据对应的周几，就可以渲染出那天对应的排课安排</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchCourses</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">if</span> (!loading) {
      loading = <span class="hljs-literal">true</span>;
      <span class="hljs-comment">// uni.showLoading({ title: "加载中...", mask: true });</span>
    }
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> db.<span class="hljs-title function_">collection</span>(<span class="hljs-string">"class-schedule"</span>).<span class="hljs-title function_">get</span>();
    <span class="hljs-keyword">if</span> (res.<span class="hljs-property">result</span>?.<span class="hljs-property">errCode</span> === <span class="hljs-number">0</span>) {
      courseList.<span class="hljs-property">value</span> = res.<span class="hljs-property">result</span>.<span class="hljs-property">data</span> || [];
    } <span class="hljs-keyword">else</span> {
      uni.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">"课程加载失败"</span>, <span class="hljs-attr">icon</span>: <span class="hljs-string">"none"</span> });
    }
  } <span class="hljs-keyword">catch</span> (error) {
    uni.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">"网络异常"</span>, <span class="hljs-attr">icon</span>: <span class="hljs-string">"none"</span> });
  } <span class="hljs-keyword">finally</span> {
    <span class="hljs-keyword">if</span> (loading) {
      loading = <span class="hljs-literal">false</span>;
      <span class="hljs-comment">// uni.hideLoading();</span>
    }
  }
};

<span class="hljs-comment">// 数据过滤：根据指定的星期过滤课程</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">filterCoursesByDay</span> = (<span class="hljs-params">day</span>) =&gt;
  courseList.<span class="hljs-property">value</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">course</span>) =&gt;</span> course.<span class="hljs-property">day</span> === day);
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43daceebf5bb46ce90ea1874a72da2ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29uZ3plbWlu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764319619&amp;x-signature=sTTD26YAYNn%2FIEB6HpzYaT0ivXQ%3D" alt="image.png" loading="lazy"/></p>
<p>我们课表卡片上有显示，预约用户列表；我们用联合查询，查询用户预约表<code>user-reserve</code>, <code>user-reserve</code>表里面的<code>user_id</code>字段关联<code>users</code>表，这样用户预约的那条记录里就有用户的详细信息了，就是说可以获得预约用户的用户头像了</p>
<h6 data-id="heading-4">判断当前用户这节课是否已预约/已候补</h6>
<p>dayCourses.value是每一天的课程</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 筛选并格式化课程数据</span>
dayCourses.<span class="hljs-property">value</span> = <span class="hljs-title function_">filterCoursesByDay</span>(targetDay).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> ({
    ...item,
    <span class="hljs-attr">time</span>: <span class="hljs-title function_">formatCourseTime</span>(item.<span class="hljs-property">startTime</span>, item.<span class="hljs-property">endTime</span>),
    <span class="hljs-attr">isReserved</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">reservedUsers</span>: [],
}));
</code></pre>
<p>每天的课程信息，我们循环处理每节课，根据<strong>课程ID和课程日期</strong>查询每节课的预约信息</p>
<p><strong>利用课程预约信息列表里用户ID是否和当前用户的ID一样，就可以判断当前用户是否已经预约/候补</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> course <span class="hljs-keyword">of</span> dayCourses.<span class="hljs-property">value</span>) {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getReserveRecords</span>(course, props.<span class="hljs-property">clickDate</span>); <span class="hljs-comment">// 获取预约用户信息</span>
    <span class="hljs-keyword">if</span> (res.<span class="hljs-property">result</span>.<span class="hljs-property">errCode</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">if</span> (res.<span class="hljs-property">result</span>.<span class="hljs-property">data</span>.<span class="hljs-property">length</span>) {
        <span class="hljs-keyword">const</span> reserveRecords = res.<span class="hljs-property">result</span>.<span class="hljs-property">data</span>;
        <span class="hljs-comment">// 保存预约记录（包括用户信息等）</span>
        course.<span class="hljs-property">reserveRecords</span> = reserveRecords;
        <span class="hljs-comment">// 因为是联合查询 所以这个user_id是一个数组</span>
        <span class="hljs-comment">// 判断当前用户这节课是否已预约</span>
        course.<span class="hljs-property">isReserved</span> = reserveRecords.<span class="hljs-title function_">some</span>(
          <span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span>
            item.<span class="hljs-property">user_id</span>?.[<span class="hljs-number">0</span>]?.<span class="hljs-property">_id</span> === storedUserInfo.<span class="hljs-property">value</span>.<span class="hljs-property">userId</span> &amp;&amp;
            item.<span class="hljs-property">status</span> === <span class="hljs-string">"confirmed"</span>
        );
        <span class="hljs-comment">// 判断当前用户这节课是否已候补</span>
        course.<span class="hljs-property">isWaited</span> = reserveRecords.<span class="hljs-title function_">some</span>(
          <span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span>
            item.<span class="hljs-property">user_id</span>?.[<span class="hljs-number">0</span>]?.<span class="hljs-property">_id</span> === storedUserInfo.<span class="hljs-property">value</span>.<span class="hljs-property">userId</span> &amp;&amp;
            item.<span class="hljs-property">status</span> === <span class="hljs-string">"waitlist"</span>
        );
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"course---"</span>, course);
      } <span class="hljs-keyword">else</span> {
        course.<span class="hljs-property">isReserved</span> = <span class="hljs-literal">false</span>;
        course.<span class="hljs-property">isWaited</span> = <span class="hljs-literal">false</span>;
        course.<span class="hljs-property">reservedUsers</span> = [];
      }
    }
}
</code></pre>
<p>下面这个方法作用： 精准查询某节课在指定日期的所有有效预约记录（包括候补），并把用户的头像，联表带出来，按预约时间倒序排列，获取预约/候补用户列表</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">getReserveRecords</span> = (<span class="hljs-params">course, targetDate</span>) =&gt; {
  <span class="hljs-comment">// 获取当天的起始时间</span>
  <span class="hljs-keyword">const</span> startOfDay = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(targetDate);
  startOfDay.<span class="hljs-title function_">setHours</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// 设置为当天 00:00:00.000</span>

  <span class="hljs-comment">// 获取当天的结束时间</span>
  <span class="hljs-keyword">const</span> endOfDay = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(targetDate);
  endOfDay.<span class="hljs-title function_">setHours</span>(<span class="hljs-number">23</span>, <span class="hljs-number">59</span>, <span class="hljs-number">59</span>, <span class="hljs-number">999</span>); <span class="hljs-comment">// 设置为当天 23:59:59.999</span>

  <span class="hljs-keyword">let</span> reserveTemp = db
    .<span class="hljs-title function_">collection</span>(<span class="hljs-string">"user-reserve"</span>)
    .<span class="hljs-title function_">where</span>({
      <span class="hljs-attr">class_id</span>: course.<span class="hljs-property">_id</span>,
      <span class="hljs-attr">canceled</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 增加canceled为false的条件</span>
      <span class="hljs-attr">reserve_class_date</span>: db.<span class="hljs-property">command</span>
        .<span class="hljs-title function_">gte</span>(startOfDay)
        .<span class="hljs-title function_">and</span>(db.<span class="hljs-property">command</span>.<span class="hljs-title function_">lte</span>(endOfDay)), <span class="hljs-comment">// 日期范围查询})</span>
    })
    .<span class="hljs-title function_">getTemp</span>();
  <span class="hljs-keyword">let</span> userTemp = db.<span class="hljs-title function_">collection</span>(<span class="hljs-string">"users"</span>).<span class="hljs-title function_">field</span>(<span class="hljs-string">"_id, avatar"</span>).<span class="hljs-title function_">getTemp</span>();

  <span class="hljs-comment">// 不能加 .limit(course.capacity) 因为还有候补的 不然导致用户预约了 不显示</span>
  <span class="hljs-keyword">return</span> db
    .<span class="hljs-title function_">collection</span>(reserveTemp, userTemp)
    .<span class="hljs-title function_">orderBy</span>(<span class="hljs-string">"reserve_time desc"</span>)
    .<span class="hljs-title function_">get</span>();
};
</code></pre>
<p>在我们的课程卡片组件，<code>course-card.vue</code>，我们要显示按钮文案，用户头像列表</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 计算确认预约的用户</span>
<span class="hljs-keyword">const</span> confirmedUsers = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> (
    props.<span class="hljs-property">courseInfo</span>.<span class="hljs-property">reserveRecords</span>?.<span class="hljs-title function_">filter</span>(
      <span class="hljs-function">(<span class="hljs-params">record</span>) =&gt;</span> record.<span class="hljs-property">status</span> === <span class="hljs-string">"confirmed"</span>
    ) || []
  );
});

<span class="hljs-comment">// 计算候补用户</span>
<span class="hljs-keyword">const</span> waitlistUsers = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> (
    props.<span class="hljs-property">courseInfo</span>.<span class="hljs-property">reserveRecords</span>?.<span class="hljs-title function_">filter</span>(
      <span class="hljs-function">(<span class="hljs-params">record</span>) =&gt;</span> record.<span class="hljs-property">status</span> === <span class="hljs-string">"waitlist"</span>
    ) || []
  );
});

<span class="hljs-comment">// 确认预约人数</span>
<span class="hljs-keyword">const</span> confirmedCount = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> confirmedUsers.<span class="hljs-property">value</span>.<span class="hljs-property">length</span>);

<span class="hljs-comment">// 候补人数</span>
<span class="hljs-keyword">const</span> waitlistCount = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> waitlistUsers.<span class="hljs-property">value</span>.<span class="hljs-property">length</span>);

<span class="hljs-comment">// 课程是否已满</span>
<span class="hljs-keyword">const</span> isFull = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> confirmedCount.<span class="hljs-property">value</span> &gt;= (props.<span class="hljs-property">courseInfo</span>?.<span class="hljs-property">capacity</span> || <span class="hljs-number">20</span>);
});

<span class="hljs-comment">// 当前用户的预约状态 confirmed waitlist</span>
<span class="hljs-keyword">const</span> userReservationStatus = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> currentUserReserve = props.<span class="hljs-property">courseInfo</span>.<span class="hljs-property">reserveRecords</span>?.<span class="hljs-title function_">find</span>(
    <span class="hljs-function">(<span class="hljs-params">record</span>) =&gt;</span> record.<span class="hljs-property">user_id</span>?.[<span class="hljs-number">0</span>]?.<span class="hljs-property">_id</span> === userInfo.<span class="hljs-property">userId</span>
  );
  <span class="hljs-keyword">return</span> currentUserReserve?.<span class="hljs-property">status</span> || <span class="hljs-literal">null</span>;
});
</code></pre>
<p>看下我们的课程卡片需要展示的信息，基本上都满足了
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97617d5764bf4bdeaa7c08533021445e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29uZ3plbWlu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764319619&amp;x-signature=WdhIU3NSg8h4HR2FiGI3kudu%2FmQ%3D" alt="image.png" loading="lazy"/>
我们把按钮抽离出来了一个组件<code>card-reserve-button.vue</code>， 我们只需要一个view标签，来显示按钮的8种状态</p>
<pre><code class="hljs language-Vue" lang="Vue">&lt;template&gt;
  &lt;view class="reserve-btn" :class="buttonClass"&gt;
    {{ buttonText }}
  &lt;/view&gt;
&lt;/template&gt;
</code></pre>
<p>按钮的8种状态</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 按钮文本</span>
<span class="hljs-keyword">const</span> buttonText = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> textMap = {
    <span class="hljs-attr">courseCancelled</span>: <span class="hljs-string">"已取消"</span>,
    <span class="hljs-attr">userConfirmed</span>: <span class="hljs-string">"已预约"</span>,
    <span class="hljs-attr">userWaitlist</span>: <span class="hljs-string">"候补中"</span>,
    <span class="hljs-attr">ended</span>: <span class="hljs-string">"已结束"</span>,
    <span class="hljs-attr">ongoing</span>: <span class="hljs-string">"进行中"</span>,
    <span class="hljs-attr">waitlistAvailable</span>: <span class="hljs-string">"候补"</span>,
    <span class="hljs-attr">reserveAvailable</span>: <span class="hljs-string">"预约"</span>,
    <span class="hljs-attr">notOpenYet</span>: <span class="hljs-string">"暂未开放预约"</span>,
  };
  <span class="hljs-keyword">return</span> textMap[buttonStatus.<span class="hljs-property">value</span>] || <span class="hljs-string">"预约"</span>;
});
</code></pre>
<p>看下按钮文案显示的逻辑</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 当前用户的预约状态</span>
<span class="hljs-keyword">const</span> buttonStatus = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 1. 优先判断是否已取消</span>
  <span class="hljs-keyword">if</span> (props.<span class="hljs-property">isCourseCancelled</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"courseCancelled"</span>;
  }

  <span class="hljs-comment">// 2. 判断用户预约状态</span>
  <span class="hljs-keyword">if</span> (userReservationStatus.<span class="hljs-property">value</span> === <span class="hljs-string">"confirmed"</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"userConfirmed"</span>;
  }
  <span class="hljs-keyword">if</span> (userReservationStatus.<span class="hljs-property">value</span> === <span class="hljs-string">"waitlist"</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"userWaitlist"</span>;
  }

  <span class="hljs-comment">// 3. 判断时间状态</span>
  <span class="hljs-keyword">const</span> currentMinutes = now.<span class="hljs-property">value</span>.<span class="hljs-title function_">getHours</span>() * <span class="hljs-number">60</span> + now.<span class="hljs-property">value</span>.<span class="hljs-title function_">getMinutes</span>();
  <span class="hljs-keyword">const</span> diffDays = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(
    (props.<span class="hljs-property">clickDate</span>.<span class="hljs-title function_">getTime</span>() - today.<span class="hljs-property">value</span>.<span class="hljs-title function_">getTime</span>()) / (<span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">24</span>)
  );

  <span class="hljs-keyword">if</span> (diffDays &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"ended"</span>;
  }

  <span class="hljs-keyword">if</span> (diffDays === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">if</span> (currentMinutes &gt; endTime) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">"ended"</span>;
    }
    <span class="hljs-keyword">if</span> (currentMinutes &gt;= startTime &amp;&amp; currentMinutes &lt;= endTime) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">"ongoing"</span>;
    }
    <span class="hljs-keyword">return</span> isFull.<span class="hljs-property">value</span> ? <span class="hljs-string">"waitlistAvailable"</span> : <span class="hljs-string">"reserveAvailable"</span>;
  }

  <span class="hljs-keyword">if</span> (diffDays &gt; <span class="hljs-number">0</span> &amp;&amp; diffDays &lt;= <span class="hljs-number">2</span>) {
    <span class="hljs-keyword">if</span> (diffDays === <span class="hljs-number">2</span>) {
      <span class="hljs-keyword">if</span> (now.<span class="hljs-property">value</span> &gt;= today12PM.<span class="hljs-property">value</span>) {
        <span class="hljs-keyword">return</span> isFull.<span class="hljs-property">value</span> ? <span class="hljs-string">"waitlistAvailable"</span> : <span class="hljs-string">"reserveAvailable"</span>;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"notOpenYet"</span>;
      }
    }
    <span class="hljs-keyword">return</span> isFull.<span class="hljs-property">value</span> ? <span class="hljs-string">"waitlistAvailable"</span> : <span class="hljs-string">"reserveAvailable"</span>;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-string">"notOpenYet"</span>;
});
</code></pre>
<p>代码逻辑解释</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">## 状态判断逻辑（按优先级）</span>

<span class="hljs-section">### 1. 课程状态检查（最高优先级）</span>
<span class="hljs-bullet">-</span> 课程被取消 → <span class="hljs-code">`courseCancelled`</span>

<span class="hljs-section">### 2. 用户预约状态检查</span>
<span class="hljs-bullet">-</span> 用户已确认预约 → <span class="hljs-code">`userConfirmed`</span>
<span class="hljs-bullet">-</span> 用户在候补名单 → <span class="hljs-code">`userWaitlist`</span>

<span class="hljs-section">### 3. 时间相对位置检查</span>
计算课程日期与今天的天数差 <span class="hljs-code">`diffDays = (课程日期 - 今天) / 天`</span>

<span class="hljs-section">### 4. 根据时间位置判断</span>

<span class="hljs-section">#### 4.1 过去的日期 (diffDays &lt; 0)</span>
→ <span class="hljs-code">`ended`</span>

<span class="hljs-section">#### 4.2 今天的课程 (diffDays = 0)</span>
<span class="hljs-bullet">-</span> 当前时间 &gt; 课程结束时间 → <span class="hljs-code">`ended`</span>
<span class="hljs-bullet">-</span> 课程开始时间 ≤ 当前时间 ≤ 课程结束时间 → <span class="hljs-code">`ongoing`</span>
<span class="hljs-bullet">-</span> 今天但还未开始 → 满员 ? <span class="hljs-code">`waitlistAvailable`</span> : <span class="hljs-code">`reserveAvailable`</span>

<span class="hljs-section">#### 4.3 明天的课程 (diffDays = 1)</span>
→ 满员 ? <span class="hljs-code">`waitlistAvailable`</span> : <span class="hljs-code">`reserveAvailable`</span>

<span class="hljs-section">#### 4.4 后天的课程 (diffDays = 2)</span>
<span class="hljs-bullet">-</span> 现在时间 ≥ 今天12:00 → 满员 ? <span class="hljs-code">`waitlistAvailable`</span> : <span class="hljs-code">`reserveAvailable`</span>
<span class="hljs-bullet">-</span> 现在时间 &lt; 今天12:00 → <span class="hljs-code">`notOpenYet`</span>

<span class="hljs-section">#### 4.5 三天后的课程 (diffDays &gt; 2)</span>
→ <span class="hljs-code">`notOpenYet`</span>
</code></pre>
<p>按钮状态说明</p>



























































<table><thead><tr><th>状态</th><th>说明</th><th>可点击</th><th>优先级</th></tr></thead><tbody><tr><td><code>courseCancelled</code></td><td>课程因人数不足被取消</td><td>(跳转详情)</td><td>1</td></tr><tr><td><code>userConfirmed</code></td><td>用户已确认预约</td><td>(跳转详情)</td><td>2</td></tr><tr><td><code>userWaitlist</code></td><td>用户在候补名单</td><td>(跳转详情)</td><td>2</td></tr><tr><td><code>ended</code></td><td>课程已结束</td><td>(跳转详情)</td><td>3</td></tr><tr><td><code>ongoing</code></td><td>课程正在进行中</td><td>(跳转详情)</td><td>3</td></tr><tr><td><code>waitlistAvailable</code></td><td>可以候补（满员）</td><td>✅ (预约)</td><td>4</td></tr><tr><td><code>reserveAvailable</code></td><td>可以预约（有名额）</td><td>✅ (预约)</td><td>4</td></tr><tr><td><code>notOpenYet</code></td><td>暂未开放预约</td><td>(跳转详情)</td><td>4</td></tr></tbody></table>
<p>课程卡片和课程详情页的按钮不一样，比如课程卡片如果显示<strong>已预约</strong>，那么课程详情页就要显示<strong>取消预约</strong>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef4788bf81bf4387b60c065e299ccdfa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29uZ3plbWlu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764319619&amp;x-signature=XudwbU2kpmHqkkLkNoyx2cqVZzM%3D" alt="image.png" loading="lazy"/></p>
<p>如果有候补，要显示候补信息
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f53150b2ebda4ce69298904c00c8d3c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29uZ3plbWlu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764319619&amp;x-signature=ClXxP0OSp77GbXPAegy%2FHChDqiA%3D" alt="image.png" loading="lazy"/></p>
<p>代码已经提交到waitlist分支，完整逻辑看<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">源码</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot 4.0 正式发布，真学不动了！]]></title>    <link>https://juejin.cn/post/7574749664492781602</link>    <guid>https://juejin.cn/post/7574749664492781602</guid>    <pubDate>2025-11-21T08:49:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574749664492781602" data-draft-id="7574749664492765218" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot 4.0 正式发布，真学不动了！"/> <meta itemprop="keywords" content="Java,Spring Boot"/> <meta itemprop="datePublished" content="2025-11-21T08:49:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JavaGuide"/> <meta itemprop="url" content="https://juejin.cn/user/166781497383294"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot 4.0 正式发布，真学不动了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/166781497383294/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JavaGuide
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T08:49:08.000Z" title="Fri Nov 21 2025 08:49:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>好家伙，就在昨晚，Spring Boot 团队悄悄地把 4.0.0 正式版发布了！这是 Spring Boot 真正意义上的新一代起点。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23d80d4ad67248b6b0100dd423a5ab4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764319748&amp;x-signature=32ERRNleV0VuoWdq6SqktCwKV5Q%3D" alt="" loading="lazy"/></p>
<p>Spring Boot 4.0 基于 Spring Framework 7.0，带来了模块化更彻底的代码库、对 Java 25 的原生支持、全面拥抱 JSpecify 空安全体系、API 版本管理，以及一大波开发者期待已久的新特性。</p>
<p>话不多说，我们直击重点，看看这次更新到底有多香。概览：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/047377e438b84901a78c858ec14b8121~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764319748&amp;x-signature=OD1GSkiyiUmRzoYnX79eBLwQfnc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0"><strong>新特性概览</strong></h2>
<h3 data-id="heading-1"><strong>HTTP Service Clients（终于来了！）</strong></h3>
<p>你是否已经厌倦了编写冗长的 <code>RestTemplate</code> 或 <code>WebClient</code> 样板代码？</p>
<p>现在，你再也不用手写 HTTP 调用的实现类了，直接写一个接口就行：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 只需定义一个接口，Spring Boot会自动为你创建实现</span>
<span class="hljs-variable">@HttpExchange</span>(url = <span class="hljs-string">"https://echo.zuplo.io"</span>)
public interface EchoService {

    <span class="hljs-variable">@PostExchange</span>
    Map&lt;?, ?&gt; <span class="hljs-built_in">echo</span>(<span class="hljs-variable">@RequestBody</span> Map&lt;String, String&gt; message);
}
</code></pre>
<p>Spring Boot 4.0 为其提供了完整的自动配置和属性支持。这意味着，<strong>后端服务间的调用，从此将变得像本地方法调用一样简洁、直观</strong>，极大地降低了微服务开发的复杂性。</p>
<h3 data-id="heading-2"><strong>原生 API 版本管理</strong></h3>
<p>API 版本管理是后端开发中一个棘手但又无法回避的问题。现在，Spring Boot 为 Spring MVC 和 WebFlux 提供了原生的 API 版本控制支持。</p>
<p>通过简单的 <code>spring.mvc.apiversion.*</code>或 <code>spring.webflux.apiversion.*</code> 属性配置，或注入自定义的 <code>ApiVersionResolver</code> 等 Bean，你就可以轻松地实现基于 URL 路径、请求头或参数的版本控制策略。</p>
<h3 data-id="heading-3"><strong>支持 Gradle 9</strong></h3>
<p>Spring Boot 4.0 支持使用 Gradle 9 构建 Spring Boot 应用程序，同时仍然支持 Gradle 8.x（8.14 或更高版本）。</p>
<h3 data-id="heading-4"><strong>全面拥抱 JSpecify 空安全体系</strong></h3>
<p>Spring Boot 4.0 全面拥抱 JSpecify 空安全体系，核心变化只有一句话：<strong>默认非空（<code>@NullMarked</code>）+ 明确标注可空（<code>@Nullable</code>）</strong>，让空指针从“运行时炸弹”变成“编译期报错”。</p>
<p>在类或包上加一个 <code>@NullMarked</code>，里面所有引用类型默认都是非空的，只有明确标了 <code>@Nullable</code> 的才可能为 null。这样：</p>
<ul>
<li>方法签名一目了然：返回值、参数到底会不会 null；</li>
<li>配合 NullAway 后，漏检查的地方直接编译失败；</li>
<li>零运行时开销，完全兼容现有代码；</li>
<li>比 Optional 更轻量、更适合做大规模重构。</li>
</ul>
<h3 data-id="heading-5"><strong>全面拥抱 Java 25</strong></h3>
<p>新版本正式提供对 Java 25 的顶级支持（LTS 版本 Java 17 依然兼容）。</p>
<p>当你在 <code>application.properties</code> 中开启虚拟线程 (<code>spring.threads.virtual.enabled=true</code>) 时，自动配置的 JDK HttpClient 将会默认使用虚拟线程，让你的 IO 密集型应用能够轻松获得巨大的性能提升。</p>
<h3 data-id="heading-6"><strong>依赖版本大跃进</strong></h3>
<p>Spring Boot 4.0 迎来了一次“全家桶”式的依赖升级：<strong>Spring Framework 7.0、Jackson 3.0、Hibernate 7.1、Tomcat 11、Jetty 12、Kafka 4.1、Kotlin 2.2.20</strong>……</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ffa8abaa5bf4b6599d4d1d65fa5585e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764319748&amp;x-signature=kp5H2OyxwdIM%2BriQSztyEuVTs0w%3D" alt="" loading="lazy"/></p>
<p>几乎所有核心和第三方组件都同步到了最新稳定版。这相当于给你的整个技术栈做了一次“集体换代”，带来了性能、安全性和新特性的全面提升。</p>
<h3 data-id="heading-7"><strong>Redis 静态主从支持</strong></h3>
<p>Lettuce 用户有福了！现在只需一行 <code>spring.data.redis.masterreplica.nodes</code> 配置，就能轻松搞定静态主从模式，不再强制依赖 Sentinel 或 Cluster。</p>
<p>这是我让 AI 总结的：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c3abe68cd474fcc8d1b52f2e4e3334a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764319748&amp;x-signature=wR7p1iZIQtxm9joInfTKbvSPRsQ%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb805bba7ce94fe183e3794daf400160~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764319748&amp;x-signature=tua4MYhL9fQKSxQVyjqqtbAXMqQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8"><strong>移除 Undertow</strong></h3>
<p>Spring Boot 4.0 完全移除了对 Undertow 的内嵌支持——不仅删掉了 <strong>spring-boot-starter-undertow</strong>，也不再提供任何 Undertow 相关的自动配置。移除的根本原因是：Spring Boot 4.0 基线升级到 Servlet 6.1（也就是说必须支持 Servlet 6.1 才能留在 starter 列表里），而截至 2025-10 官方发布说明时，Undertow 尚未兼容该版本。</p>
<p>这些新特性很多我都已经同步更新到了<a href="https://link.juejin.cn?target=https%3A%2F%2Fjavaguide.cn%2Fzhuanlan%2Fjava-mian-shi-zhi-bei.html" target="_blank" title="https://javaguide.cn/zhuanlan/java-mian-shi-zhi-bei.html" ref="nofollow noopener noreferrer">《Java 面试指北》</a>（后端面试指南）中，保证内容与时俱进！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b913dca776604bad9cf8b5627fdc7007~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764319748&amp;x-signature=0%2BctyfHh4YD%2FRnZNPZ8aVBkcE0M%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7ee48d1f04a49c79e158954196a79c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764319748&amp;x-signature=rk8EItKyn4JOHHXlDyQwYX4fquc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9"><strong>升级建议</strong></h2>
<p>4.0 是大版本，升级比平时麻烦一点。官方的强烈建议是：如果你现在还在 3.3、3.4 甚至更老的版本 → 先升到 3.5 再升 4.0。这条路径能帮你少踩 90% 的坑，强烈建议别跳过！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f599d3003de54ae6be883c8570f8bcdf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764319748&amp;x-signature=LAY2EHToZj2%2BZPY0sWuh%2FcLjSpU%3D" alt="" loading="lazy"/></p>
<p>详细的迁移指南可以参考官方文档：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fspring-projects%2Fspring-boot%2Fwiki%2FSpring-Boot-4.0-Migration-Guide" target="_blank" title="https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-4.0-Migration-Guide" ref="nofollow noopener noreferrer">github.com/spring-proj…</a></strong> 。</p>
<h2 data-id="heading-10"><strong>总结</strong></h2>
<p>Spring Boot 4.0.0 正式发布，基于 Spring Framework 7.0，全面支持 Java 25（含虚拟线程优化）。核心新特性包括：HTTP Service Clients 简化远程调用；原生 API 版本管理；全面采用 JSpecify 空安全体系（默认非空，编译期防 NPE）；关键依赖升级至 Jackson 3.0、Tomcat 11、Hibernate 7.1 等；支持 Gradle 9；Redis 静态主从配置；移除 Undertow。</p>
<p>如果要升级的话，建议先迁移到 3.5 版本再升级。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[开源项目|不一样的思维导图]]></title>    <link>https://juejin.cn/post/7574803558878314511</link>    <guid>https://juejin.cn/post/7574803558878314511</guid>    <pubDate>2025-11-21T08:54:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574803558878314511" data-draft-id="7574749664492814370" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="开源项目|不一样的思维导图"/> <meta itemprop="keywords" content="后端,人工智能"/> <meta itemprop="datePublished" content="2025-11-21T08:54:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="周末程序猿"/> <meta itemprop="url" content="https://juejin.cn/user/3245414056989757"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            开源项目|不一样的思维导图
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3245414056989757/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    周末程序猿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T08:54:25.000Z" title="Fri Nov 21 2025 08:54:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近在参加公司的 <code>Agent</code> 比赛，尝试将一个想法用完整的 <code>Vibe Coding</code> 流程来实现，经过一些曲折，最后完成了，比传统Coding的效率的确提升了5倍左右，先介绍项目，最后再写开发总结。</p>
<h2 data-id="heading-0">1. 思维导图介绍</h2>
<p>体验地址： <a href="https://link.juejin.cn?target=https%3A%2F%2Fmind.su007.club%2F" target="_blank" title="https://mind.su007.club/" ref="nofollow noopener noreferrer">mind.su007.club/</a><br/>
项目github地址： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flinkxzhou%2FSimpleMind" target="_blank" title="https://github.com/linkxzhou/SimpleMind" ref="nofollow noopener noreferrer">github.com/linkxzhou/S…</a></p>
<h3 data-id="heading-1">1.1 功能介绍</h3>
<p>之前使用过市场上各种思维导图，虽然很多搭载了AI的功能，但是基本上都需要自己写提示词，其实使用思维导图往往是想整理思路，如果能将自己的思路再用提示词整理一遍，其实已经不需要思维导图了，所以开发脑图的目的是为了让使用者沉浸式思路，AI辅助续写。<br/>
基于以上思考，开发这块产品首先用户需要设置的东西要少，界面要简单，所以首页是这样的：</p>
<ul>
<li>PC浏览器上：</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa96fc71647246a280b08e5840009f84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764320064&amp;x-signature=swVY6qbyZ5TmA5R1AksVgRpB37k%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>手机端：</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5d2cab13f5d4d4d825db644bf79e117~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764320064&amp;x-signature=mI0NJiTTM%2FWDTjIYfR9r72QtD7s%3D" alt="图片" loading="lazy"/></p>
<p>为了减少用户对功能的焦虑，<code>toolbar</code> 只提供常用的功能：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e76578b3c59c46158346ef84eaf5f6f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764320064&amp;x-signature=TJKR0CCzUfj%2BKRlUQ1cmm15NsYU%3D" alt="图片" loading="lazy"/></p>
<p>设置中的功能主要功能包括：</p>
<ul>
<li>AI的通用设置</li>
<li>布局：支持思维导图，逻辑结构图，组织结构图，目录组织图，时间轴，鱼骨图</li>
<li>生成节点数</li>
<li>私有知识库</li>
<li>导入JSON等</li>
<li>导出JSON，图片等</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d12ef35564d74a0fa25580f9136bb580~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764320064&amp;x-signature=4BooCDIOiCi97MYKx2b2jDRYywM%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-2">1.2 模版列表</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b010618f80184ae3943fea0b8d3a3a62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764320064&amp;x-signature=lcqnaWuGA6J1PUmWC1MGLduaJpY%3D" alt="图片" loading="lazy"/></p>
<p>模版列表的目的是方便用户不需要关心提示词，比如读书笔记，在思维导图中是有一种通用的模式，充分利用大模型已有的知识，整理思考方式，当前功能后续会扩充更多的思考模版，目前支持：</p>
<ul>
<li>读书笔记</li>
<li>第一性原理分析问题</li>
</ul>
<h3 data-id="heading-3">1.3 提示词</h3>
<p>对于知识整理，提示词比较重要，为了大家方便复现生成，所以生成过程中会展示提示词，比如《如何制造火箭？》</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91e721acd8fa482d9780417dda5873bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764320064&amp;x-signature=l2Vb0O%2FSRWXK0IsYBLltYW9lzrI%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-4">2. 总结</h2>
<h3 data-id="heading-5">2.1 <code>Vibe Coding</code> 还是 <code>Spec Coding</code> 开发方式对比</h3>
<ul>
<li>Andrej Karpathy在2025年初提出的 "Vibe Coding" 概念，强调 "忘记代码存在，专注创意表达" 的开发模式，是一种直觉驱动的快速原型方法，通过自然语言与AI对话，以极高的速度将模糊想法转化为可运行代码。</li>
<li>"Spec Coding" 则是一种规范驱动的可控工程方法，强调在编码前通过结构化的文档明确需求和设计，再让AI在严格约束下生成代码。</li>
</ul>
<p>以上两种编程方式各有利弊，对于团队协作和需要长期维护的系统，必须要有一套规范化的工程文件，比如 <code>requirements.md、design.md、tasks.md</code>，定义清楚功能边界，设计边界，任务边界等，所以 "Spec Coding" 是必须的。<br/>
对于创意探索和MVP验证，不在乎质量，只是为了做原型验证，"Vibe Coding" 能快速搭建工程。不过我个人用AI开发一些工具经验而言，无论什么项目，其实都可以从 "Vibe Coding"，当你完整探索了这个项目的边界的时候，再转向 "Spec Coding"，对于工程开发人员这个可能是比较自然的过程。</p>
<p>就像《黑客与画家》一书中描述程序员和画家的相似之处在于不断修改你工程，让其更丰富，除非重构型的项目，一般项目开始定义的功能拆解，AI可能比我们想的功能更丰富。<br/>
所以想使用 <code>Vibe Coding</code> 开发，不断探索边界，然后将边界框定好了以后，整理规范化的工程文件，对项目进行重构，进入 <code>Spec Coding</code>，这个也是我开发思维导图的方式。</p>
<h3 data-id="heading-6">2.2 <code>Code is cheap, show me the product</code></h3>
<p>之前一直说：<code>Code is cheap, show me the talk</code>，其实产品才是 <code>AI</code> 时代最应该关注的。<br/>
现在利用 <code>CodeBuddy</code>, <code>Codex</code>，<code>TRAE</code> 等编程工具，10分钟就可以实现一个完整的 <code>Demo</code>，但是要将这个 <code>Demo</code> 打造成一款伟大的产品却很难。<br/>
虽然做过很多小的demo，这个方面没有发言权，不过我觉得我会一直遵循精益求精的原则，不断是完善一个工具。</p>
<h3 data-id="heading-7">2.3 如何减少代码出错的概率</h3>
<p>之前写过很多 <code>Prompt</code> 技巧，这里就不说了，这里总结项目减少出错可能在于框架的选择：</p>
<ul>
<li>优先选择开源社区通用的框架，比如前端使用 <code>vue</code> + <code>ant-design</code>，首先模型已经有相关知识，出错的概率比较少，另一个组件比较丰富，复用的组件越多，使用的代码就越少，出错的概率就越小；</li>
<li>作为一个后端开发，个人经验是，如果能用前端实现的，就必要用到后端功能，即使必须要用后端，可以优先考虑 <code>Supabase</code>, <code>FireBase</code> 等 <code>BaaS</code> 框架解决后端问题；</li>
<li>不要将功能堆到一个文件中，单个文件不建议超过 500 行，如果超过就尝试将功能拆解出来，毕竟现在的大模型上下文太大，会遇到各种幻觉问题；</li>
<li>尽量写好 <code>requirements.md、design.md</code>，这样能定义功能边界，防止模型太过于发散导致重构的困难加大；</li>
<li>....</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[可验证性是极限]]></title>    <link>https://juejin.cn/post/7574816159754747955</link>    <guid>https://juejin.cn/post/7574816159754747955</guid>    <pubDate>2025-11-21T07:55:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574816159754747955" data-draft-id="7574775334681821194" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="可验证性是极限"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2025-11-21T07:55:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="是魔丸啊"/> <meta itemprop="url" content="https://juejin.cn/user/3217622495411292"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            可验证性是极限
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3217622495411292/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    是魔丸啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T07:55:29.000Z" title="Fri Nov 21 2025 07:55:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=http%3A%2F%2Falperenkeles.com%2Fposts%2Fverifiability-is-the-limit%2F" target="_blank" title="http://alperenkeles.com/posts/verifiability-is-the-limit/" ref="nofollow noopener noreferrer">转载</a></p>
<p>在过去 5 年中，LLM 在软件工程社区引发了巨大动荡，大部分讨论都围绕着一个核心问题：<strong>我们这个职业的未来是什么？</strong></p>
<p>一系列具有不同程度人工干预和控制的竞争范式已经出现：一方面是几乎无需人工参与的 agents，最近流行的"vibe coding"理念不鼓励手动修改代码，而是通过 LLM 与代码库交互；实现独立模块或功能的聊天机器人，有时甚至使用代码解释功能运行代码；另一方面是预测用户意图的编码助手，充当"强化版自动完成"。</p>
<p>关于这些模型的极限、实用性和潜力，存在诸多不同观点。一些人相信，这些模型将在前所未有的时间和资源投入下发展到人类水平能力，并将能够自动化构建生产级软件系统；而怀疑者则贬低这些模型，声称其生成的代码平庸且琐碎，无法扩展到任何生产环境。</p>
<p>我并非在此争论模型本身的极限或能力，有比我更优秀的专家具备深厚的理论知识和实践经验。然而，我将论证以下观点。</p>
<p><strong>世界上的每一件软件都必须相对于某种正确性标准而"正确"。在 LLM 出现之前，我们的时间被分配在编写、阅读和验证代码上。有了 LLM，我们能够将代码编写阶段卸载给 LLM，但验证过程无法被卸载，只能被推到不同的层面。</strong></p>
<p>外界有人争论正确性只是一小部分领域的事务，比如火箭或密码学。别搞错，正确性所需的严格程度会变化，但对正确性的要求不会改变。软件<strong>总是</strong>为某种目的而创建，无论是消费和转换数据，向用户提供信息，还是允许用户交互并创建新数据。正确性是指创建的软件符合创建者意图的概念，而创建者<strong>必须</strong>验证这种符合性。</p>
<p>在不太关键的应用和领域中，正确性是一个<strong>试验</strong>问题。如果我制作一个网站来展示关于我举办的派对的信息，我会检查网站是否显示了我希望的所有相关信息。如果只是和朋友的派对，这样就足够了。如果是工作派对，我除了在电脑上测试外，还会在手机上尝试，甚至可能请几个使用不同设备的朋友检查，确保一切正常。</p>
<p>即使在上述例子中，正确性的重要性也是上下文相关的。随着领域和规模的变化，我们验证正确性的机制也会改变。当我们创建商业应用软件时，会聘请"<strong>测试</strong>"（QA）专家来测试程序中的许多路径，以发现意外行为，即所谓的<strong>缺陷</strong>。典型公司除了<strong>测试</strong>外，还会花费大量时间<strong>测试</strong>代码，测试的严格程度随用户数量、资金规模、应用领域关键性的变化而变化。小型 SaaS 公司可能只编写一些集成测试来检查特定场景，或为某些组件实现单元测试，而 AWS 则会数学证明每天处理 PB 级数据的 S3 实现的正确性。</p>
<p>那么，基于目前的讨论，LLM 应该能够生成不需要严格正确性的代码库。也许它甚至可以生成测试，或为其编写的代码编写证明，对吗？也许 LLM 真的能从流程中移除人类，作为一组协作的 agents 工作；即使不是现在，也许在未来可以。我在讨论中多次听到这种论点。问题在于，我们没有考虑到<strong>代码的可验证性</strong>。我们谈论了严格性和规模，但严格性作为领域 LLM 适应性的参数是不够的，我们需要讨论 LLM 生成的代码如何被验证，这也包括测试代码。</p>
<p>让我们退一步思考 UI 编程（主要与前端开发相关）。许多从业者的经验表明，LLM 能够在单个提示中生成整个前端应用程序，甚至基于餐巾纸上的草图。我们看到像 V0 这样的专门工具专注于 UI 生成。然而，它们在其他领域并不那么成功，或至少没有普及。关于这种现象的一个流行观点是，LLM 是在公共代码库上训练的，UI 编程占据这些代码的很大比例。然而，这无法解释为什么 LLM 在 Web 服务器应用程序（主要与后端开发相关）中不那么受欢迎，这些应用可能与 UI 编程同样普遍，甚至在代码中具有更少的多样性和更多的结构。</p>
<p>尽管关于前端和后端流行度差异有一些心理学解释，主要是创建炫酷且令人印象深刻的 UI 比创建能吸引同等注意力的后端更容易，因此关于前后端比较的流行性或可用性的轶事证据不应被赋予太多可信度，<strong>我假设 UI 比我们编写代码的任何其他领域都更容易验证</strong>。</p>
<p>UI 的验证几乎字面上就是"查看"。当我们查看网页时，我们几乎立即识别出生成的代码与我们的意图之间的偏差，并能向 LLM 提供即时反馈。Web 服务器的验证需要设置一组测试输入，将其发送到服务器，可能创建一些临时状态，并检查输出是否符合我们的预期。事实上，这比尝试更容易编写测试，而编写 UI 测试是一个困扰业界 30 年的长期痛点，至今尚未解决。</p>
<p>上周"vibe coding games"的兴起似乎源于同一根源。生成的游戏虽然令人印象深刻，但其验证可以通过尝试实现。通常在没有持久状态的单服务器上实现，游戏通过降低用户体验或删除导致问题的功能来回避复杂的网络或性能问题，而不是解决这些问题本身。这并非说这不是有效的选择，但这种选择的原因不是因为这些问题不重要，而是因为它们更难验证正确性，需要自定义测试基础设施或领域知识。</p>
<p>回到标题，<strong>可验证性是极限。</strong></p>
<p><strong>这是告诉我们什么无法通过 LLM 实现的极限，它无法通过 agent 方法解决。</strong> 安全 agent 理论上可以为应用程序添加安全检查，但如果不以打算生成代码的人的身份验证这些检查，它们就是无价值的。测试 agent 可以为程序添加测试，但在我们验证测试是否符合我们的意图之前，测试本身是无意义的。</p>
<p>到目前为止，我通过理论化 LLM 和我们生产软件的方式阐述了我的观点。<strong>现在，我应该分享我认为我们应该做什么。</strong></p>
<p>如果可验证性是极限，如果它是使用 LLM 编程的瓶颈，那么自然的问题就是<strong>我们如何提高这个极限，我们如何使验证更容易？</strong></p>
<p>我相信我们需要采取的第一步是放弃无限强大和可扩展的软件 agent 意识形态。如果可验证性真的是极限，那么再多的 agents 也无法解决问题。在我看来，我们需要更好的验证工具和界面。例如，与其让程序员阅读 LLM 生成的测试，不如将生成的测试总结为人类可读的格式，当然，总结也存在信息丢失的风险。我们应该更多地依赖声明式随机测试方法，如基于属性的测试，程序员定义一个应该在所有可能输入上成立的谓词，并通过生成随机输入并传递给程序来测试这个谓词。这种方法已在许多领域用于增强程序可靠性，但尚未被软件工程社区广泛采用。这种方法的优点是，拥有一个通用谓词比多个单元测试更容易检查和理解，此外还有增强的测试强度。</p>
<p>我们需要增加讨论正确性时使用的词汇量。我们需要对性能、安全性、可访问性、灵活性有更广泛的理解，以及如何衡量程序的这些质量，以便我们知道在应用程序中寻找什么，并拥有验证这些质量的机制。在当前状态下，正确性通常被归因于功能正确性，主要意味着"输入输出符合预期"，而应用程序的大多数其他期望被归类为"非功能属性"，软件工程社区在很大程度上忽视了正确地衡量和验证它们。</p>
<p><strong>让我用一个预测来总结。</strong> 很长时间以来，我一直相信 LLM 不会成为优秀的程序员，即使有进一步改进。在它们在竞赛编程中取得成功后，我的观点发生了转变，也许作为一个改过自新的竞赛程序员，那是我的李世石时刻。<strong>我现在，虽然暂时地，相信 LLM 确实可以在所有拥有完美预言机的领域取得成功。</strong></p>
<p>重要的是要理解，这并不意味着 LLM 将成为产生 100x 代码的神，因为实际上软件工程有用的几乎所有领域都没有完美预言机。完美预言机是一种反馈机制，每次都给你"正确/错误"的答案，它们几乎只出现在游戏中，因为现实世界通常没有完美的正确性模型。赢得或输掉一场游戏是完美预言机，创建能在竞赛编程竞赛中通过评判的程序也是如此。</p>
<p>即使是编程中最形式化的方面，用户可以证明代码正确的定理证明器，也不是完美预言机，因为它们无法告诉你是否在证明的中间步骤上走在正确的道路上，只在你的证明正确或遇到困难时提供信息。我希望这个不完美的预言机足以赢得证明这场游戏，LLM 在自动化证明方面会比我们更优秀。如果这一天到来，我们的下一个工作可能是创造新的定理，要求 LLM 生成代码和证明，并将这样的系统安全可靠地扩展到生产级代码库。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型平民化：3块钱、2小时，MiniMind开源项目全解析]]></title>    <link>https://juejin.cn/post/7574972697676562468</link>    <guid>https://juejin.cn/post/7574972697676562468</guid>    <pubDate>2025-11-21T08:16:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574972697676562468" data-draft-id="7574916588718440490" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型平民化：3块钱、2小时，MiniMind开源项目全解析"/> <meta itemprop="keywords" content="Agent,程序员,LLM"/> <meta itemprop="datePublished" content="2025-11-21T08:16:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大模型教程"/> <meta itemprop="url" content="https://juejin.cn/user/1145012233707299"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型平民化：3块钱、2小时，MiniMind开源项目全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1145012233707299/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大模型教程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T08:16:50.000Z" title="Fri Nov 21 2025 08:16:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p>印象里大模型参数动辄千亿万亿，训练成本更是天文数字，感觉像是普通人遥不可及的“屠龙之术”。但今天想跟你们聊个有意思的反例，一个叫 MiniMind 的开源项目，它反其道而行之，主打一个“大道至简”。</p>
<p>这个项目的目标听起来有点不可思议：只花3块钱的服务器成本，用2个小时，就能从零开始训练一个属于你自己的语言模型。当然，这里的“2小时”是在NVIDIA 3090这种还算不错的个人显卡上测试的，“3块钱”也是指租用这块显卡的云服务费用。即便如此，这个门槛也低得让人心动。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eae132211ee745f396415f32ae26b6cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764317810&amp;x-signature=h%2FnoJRX4t8AcvrMNliTvOBekcBU%3D" alt="" loading="lazy"/></p>
<p>这几年AI圈子实在太浮躁，各种框架和工具库把一切都封装得严严实实。比如用<code>transformers</code>库，十几行代码就能跑完一个模型的训练流程。这当然很方便，但给我的感觉就像是坐在飞船的头等舱里，速度是快，可你永远不知道这飞船的引擎是怎么造的。MiniMind的作者显然也有同感，他觉得“用乐高拼出一架飞机，远比坐在头等舱里飞行更让人兴奋”。</p>
<p>所以，这个项目最大的特点就是“透明”。它把大模型训练的全过程，包括数据清洗、预训练、监督微调、强化学习等等，全部用最基础的PyTorch代码从头实现了一遍，几乎不依赖那些高度抽象的第三方库。这相当于把大模型的“黑盒子”拆开，把里面的零件一个个摆在你面前，让你看清楚、摸明白。对于想真正入门LLM的人来说，这简直是一份宝藏级的教程。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec20ae8582d9485181f9add8e4b7dbe7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764317810&amp;x-signature=879%2BYk8TK7h6sj%2FMVeOm78s%2B%2F4A%3D" alt="" loading="lazy"/></p>
<p>MiniMind训练出来的模型有多大呢？最小的版本只有25.8M，作为对比，几年前的GPT-3模型体积是它的7000多倍。这意味着，你不仅能在自己的普通电脑上训练它，还能轻松地部署和运行它。</p>
<p>当然，这么小的模型，你不能指望它有GPT-4的智商。但它的意义不在于挑战巨头，而在于“祛魅”。它让你亲身体验一个语言模型是如何从一堆杂乱的文本数据中“学会”知识，再通过对话练习“学会”交流的。</p>
<p>整个过程大概分几步。首先是<strong>预训练</strong>，就像让一个刚出生的婴儿去读海量的书籍报刊，虽然它还不懂怎么说话，但脑子里已经装满了各种知识。MiniMind用的是一份约1.6GB的高质量中文语料，让模型在这个阶段埋头“学习接龙”，比如看到“秦始皇”，它得学会接“是中国的第一位皇帝”。</p>
<p>然后是<strong>监督微调（SFT）</strong> 。模型学富五车但不会聊天，怎么办？就给它看大量的对话范例，告诉它看到“问题”后面要跟“回答”。这个过程就像教一个书呆子社交礼仪，让他知道聊天的基本格式。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c179c011a69407ab978c4e937ecc9d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764317810&amp;x-signature=Gkl%2Fmg4Lj7zxWhM%2FaAtuyl5tpYY%3D" alt="" loading="lazy"/></p>
<p>再往后，还有更高级的玩法，比如<strong>强化学习（RLHF/RLAIF）</strong> 。简单说，就是让模型知道什么样的回答是“好”的，什么样的回答是“坏”的。比如用DPO（直接偏好优化）方法，你给模型看一对答案，告诉它哪个更受人类喜欢，模型就会慢慢调整自己的说话风格，变得更讨人喜欢。MiniMind甚至还从零实现了PPO、GRPO这些更前沿的强化学习算法，用一个AI“裁判”来给模型的回答打分，引导它进化。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de919692ab2740c1875aad6688175936~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764317810&amp;x-signature=kNttsrxV%2Bxx9T1l2udusCfe7%2Ff4%3D" alt="" loading="lazy"/></p>
<p>那么，花3块钱训练出来的模型效果到底怎么样？项目作者也坦诚地给出了测试结果。在一些客观的中文评测榜单上，比如C-Eval，MiniMind的得分基本在25%上下徘徊。要知道，四选一的选择题，瞎猜的正确率就是25%。所以，从“智商”上说，它确实只是个“宝宝”。</p>
<p>但在实际对话中，它已经能有模有样地回答一些基本问题了。比如你问它“介绍一下自己”，它会说“我是一个人工智能，被设计用来帮助用户解答问题”。你让它推荐杭州美食，它也能说出几个像样的菜名。虽然偶尔会犯傻，比如问它美国历史，它可能会蹦出一段不知所云的中文。但考虑到它的体量和训练成本，能做到这样已经相当不错了。</p>
<p>我个人觉得，MiniMind这个项目最有价值的地方，不是它最终训练出的模型有多强，而是它提供了一个可动手、低成本的实验平台。它证明了理解和构建一个语言模型，并不一定需要庞大的算力和资金。它更像一个“厨房”，备齐了所有食材和厨具，鼓励你自己下厨，而不是永远只当一个点外卖的食客。</p>
<p>现在，这个项目已经兼容了像<code>llama.cpp</code>、<code>ollama</code>这些流行的本地推理框架，你可以很方便地把自己训练的模型跑在个人电脑上，甚至把它打包成一个API服务，接入各种聊天界面。</p>
<p>总而言之，如果你也对AI的底层原理感到好奇，厌倦了那些云里雾里的概念，想亲手“拼”一个属于自己的语言模型，那MiniMind绝对值得你花上一个下午去研究一下。毕竟，能用一杯奶茶的钱，换来一次深入AI核心腹地的机会，这笔买卖怎么看都挺划算的。</p>
<h2 data-id="heading-0">学习资源推荐</h2>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[跨平台开发地图：客户端技术选型指南 | 2025年11月 |（Valdi 加入战场）]]></title>    <link>https://juejin.cn/post/7574916588718489642</link>    <guid>https://juejin.cn/post/7574916588718489642</guid>    <pubDate>2025-11-21T08:27:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574916588718489642" data-draft-id="7574958975159599147" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="跨平台开发地图：客户端技术选型指南 | 2025年11月 |（Valdi 加入战场）"/> <meta itemprop="keywords" content="Flutter,客户端,React Native"/> <meta itemprop="datePublished" content="2025-11-21T08:27:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员老刘"/> <meta itemprop="url" content="https://juejin.cn/user/662360127965769"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            跨平台开发地图：客户端技术选型指南 | 2025年11月 |（Valdi 加入战场）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/662360127965769/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员老刘
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T08:27:44.000Z" title="Fri Nov 21 2025 08:27:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读28分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>哈喽，我是老刘</strong></p>
<p>2024年全球移动应用下载量突破2570亿次，但开发者面对的现实是：平台越来越多、成本翻倍、体验难统一。iOS/Android/鸿蒙/桌面端/Web/小程序，各有一套开发与设计规范，原生很难在多设备上做到一致。</p>
<p>跨平台是机会，却更是选择题：Flutter讲性能、React Native讲生态、uni-app讲覆盖、KMP讲原生。</p>
<p>如何做好这道选择题，把有限的资源发挥出最大的效率？</p>
<p>老刘每个月为大家画出最新的跨平台技术选型地图，帮你快速做决策。</p>
<p>本月很多跨平台框架都有更新，另外新框架<strong>Valdi</strong>加入战场，为跨平台开发带来了新的可能性。</p>
<hr/>
<h2 data-id="heading-0">一、2025年跨平台技术趋势</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/737dbad8190640a692b5c0320f462962~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6ICB5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764318464&amp;x-signature=Kt1jKlr6EarAYoyh56HqrqpwEZI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>第一个变化：性能差距在缩小</strong></p>
<p>现在Flutter的自渲染引擎已经能达到60fps的流畅度。</p>
<p>uni-app x的UTS编译技术，直接把代码转成原生Kotlin和Swift。</p>
<p>跨平台方案与原生的性能差距已经小到用户感知不到的程度。</p>
<p><strong>第二个变化：大厂开始重注跨平台</strong></p>
<p>2024年5月，微软正式停止Xamarin支持，全力推.NET MAUI。</p>
<p>同一时间，Google官方开始支持Kotlin Multiplatform。</p>
<p><strong>第三个变化：AI加持下的开发效率暴增</strong></p>
<p>现在用Claude Code、Cursor等工具写Flutter代码，效率比以前高了3倍。</p>
<p>特别是UI界面，直接传入设计图就能生成可用的代码。</p>
<p>跨平台开发的学习门槛大幅降低。</p>
<h3 data-id="heading-1">最新技术动态</h3>
<h4 data-id="heading-2">React Native 新架构全面启用</h4>
<p><strong>React Native 0.82 里程碑版本</strong></p>
<p>React Native 0.82 - A New Era: <a href="https://link.juejin.cn?target=https%3A%2F%2Freactnative.dev%2Fblog" target="_blank" title="https://reactnative.dev/blog" ref="nofollow noopener noreferrer">reactnative.dev/blog</a></p>
<ul>
<li>2025年10月8日发布，完全基于新架构运行</li>
<li>0.82.1 已在10月推送</li>
<li>0.83 作为下一小版本尚未在11月正式 GA</li>
</ul>
<h4 data-id="heading-3">Kotlin Multiplatform 生态成熟加速</h4>
<p><strong>Compose Multiplatform 1.9.3 发布</strong></p>
<ul>
<li>
<p>Compose Multiplatform 1.9.3 于11月6日发布</p>
<p>带来对最新 AGP 的兼容建议、引入实验性的 MaterialExpressiveTheme 、并将 Material3 与 Gradle 插件版本解耦</p>
</li>
</ul>
<h4 data-id="heading-4">.NET MAUI 企业级发展</h4>
<p><strong>.NET 10 预览与 MAUI 增强</strong></p>
<p>.NET Multi-platform App UI：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdotnet.microsoft.com%2Fen-us%2Fapps%2Fmaui" target="_blank" title="https://dotnet.microsoft.com/en-us/apps/maui" ref="nofollow noopener noreferrer">dotnet.microsoft.com/en-us/apps/…</a></p>
<ul>
<li>.NET 10 已在 .NET Conf 2025（11月11–13日）正式发布并成为 LTS（支持到 2028-11-10）</li>
<li>Uno Platform 6.3 带来 .NET 10（RC）支持、VS 2026 兼容，以及 WebAssembly 端通过 WebWorkers 的图像解码性能提升；官方宣布与微软 .NET 团队深度协作推进 MAUI/.NET for Android
Uno 博客与资讯： platform.uno/blog/uno-platform-6-3</li>
</ul>
<h4 data-id="heading-5">Flutter 平台更新</h4>
<p>Flutter 3.38 技术更新: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.flutter.dev%2Frelease%2Fwhats-new" target="_blank" title="https://docs.flutter.dev/release/whats-new" ref="nofollow noopener noreferrer">docs.flutter.dev/release/wha…</a></p>
<ul>
<li>3.38 于11月发布，支持 Apple 强制的 UIScene 生命周期，需要进行代码迁移</li>
<li>文档站点迁移到 Jaspr（Dart Web 框架），开发者文档与工具集成改进</li>
<li>Widget Previewer 在 VS Code/IntelliJ 进一步集成，提升预览与调试效率</li>
<li>平台支持同步 iOS 26、Xcode 26、macOS 26，稳定性与兼容性提升</li>
<li>Dart 3.6 点速记语法（Dot shorthands）默认开启，减少样板代码（如 <code>.start</code>）</li>
<li>Web 开发增强：<code>web_dev_config.yaml</code> 支持配置开发服务器与代理，热重载可多浏览器连接</li>
<li>OverlayPortal 新能力：子 Widget 可渲染到任意 Overlay，适合弹窗、气泡、提示等复杂浮层</li>
<li>Windows 桌面增强：<code>PlatformDispatcher.displays</code> 可获取显示器分辨率、刷新率、DPR、物理尺寸等</li>
<li>修复 Android 端 Activity 销毁内存泄漏（issue #173770），影响自 3.29.0 引入的缺陷</li>
</ul>
<h4 data-id="heading-6">升级提示（3.38）</h4>
<ul>
<li>Android：默认 NDK 升级到 r28，满足 Google Play 16 KB 页面大小兼容要求</li>
<li>iOS：严格按 UIScene 生命周期迁移，参考官方迁移指南</li>
<li>版本选择策略：观察期 2–3 个月，稳定后再提升为主力版本</li>
</ul>
<h4 data-id="heading-7">uni-app x 11月进展</h4>
<p>uni-app x 4.84/4.85 更新日志: <a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.io%2Frelease" target="_blank" title="https://uniapp.dcloud.io/release" ref="nofollow noopener noreferrer">uniapp.dcloud.io/release</a></p>
<ul>
<li>新增 API <code>uni.createWorker</code> 支持 Worker 线程，提升计算与渲染并发能力（4.84）</li>
<li>App(iOS/Android) 新增 <code>image</code> 支持 SVG、<code>live-player</code>/<code>live-pusher</code> 实时音视频、广告视频等能力</li>
<li>HarmonyOS 增强：<code>themeChange</code> 主题切换、登录/分享、屏幕亮度 API、逻辑层 JSVM 迁移至子线程</li>
<li>多平台稳定性修复：list-view 拖动加载崩溃、编译器 async 嵌套报错、web-view/scroll-view 等问题修复（4.85）</li>
</ul>
<h4 data-id="heading-8">新的跨平台框架 Valdi 加入战场</h4>
<ul>
<li>4.3章节会详细介绍 Valdi 框架的设计与实现</li>
</ul>
<p>接下来老刘按照跨平台技术框架的三种路线，分别介绍一下目前主流的跨平台技术。</p>
<hr/>
<h2 data-id="heading-9">二、自渲染类框架</h2>
<p><strong>什么是自渲染？</strong></p>
<p>简单来说，就是框架自己画界面，不用系统提供的组件。</p>
<p>就像游戏引擎一样，每个像素都是自己控制的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be8db77b4f024519a78af5cf246461c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6ICB5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764318464&amp;x-signature=kfejaHyE31VQCKpwQrwz3VAopEk%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>这样做有什么好处？</p>
<p><strong>第一，界面完全一致</strong></p>
<p>在iPhone上看到的按钮，和在Android上看到的按钮，一模一样。</p>
<p>同样的UI代码，在不同平台上运行，不会因为转嫁到系统的UI组件而导致展示效果或者逻辑不一致。</p>
<p><strong>第二，性能媲美原生</strong></p>
<p>因为跳过了系统的UI层，直接操作GPU绘制。</p>
<p>本质上和原生系统框架采用相同的架构，因此性能上也不会有太大的区别。</p>
<p><strong>第三，没有兼容性bug</strong></p>
<p>其它两种方案不管是中间层还是转义，最终都会去调用系统原生的组件。</p>
<p>这个过程中因为不同系统的组件功能差异和实现方案不同就会导致一些兼容性问题。</p>
<p>其中比较复杂的问题可能需要开发者自己去原生代码的层面去定位和解决。</p>
<p>而自渲染的框架，因为跳过了系统的UI层，所以不会有这个问题。</p>
<h3 data-id="heading-10">2.1 Flutter</h3>
<h4 data-id="heading-11">Flutter现在有多火？</h4>
<p>2024年Stack Overflow调查显示，Flutter是最受欢迎的跨平台框架。</p>
<p>全球有超过500万开发者在使用。</p>
<p>连阿里巴巴、腾讯、字节跳动都在使用Flutter。</p>
<p><strong>为什么这么多大厂选择Flutter？</strong></p>
<p><strong>原因一：性能真的强</strong></p>
<p>自从切换了Impeller引擎，Flutter真的是和原生应用性能一致。</p>
<p><strong>原因二：开发效率高</strong></p>
<p>热重载功能让你改代码后，1秒钟就能看到效果。</p>
<p>不用重新编译，不用重新安装。</p>
<p>同时，Dart语言本身的在编码复杂性和功能性方面平衡做的非常好，日常开发的效率很高。</p>
<p><strong>原因三：生态成熟</strong></p>
<p>pub.dev上有超过4万个插件包。</p>
<p>基本上你能想到的功能，都有现成的插件。</p>
<p>地图、支付、推送、数据库...应有尽有。</p>
<p><strong>原因四：对单元测试的良好支持</strong></p>
<p>Flutter是目前为止客户端开发领域中对单元测试支持最好的框架。</p>
<p>这一点比原生开发都要好，是Flutter独有的优势。</p>
<p>如果你的团队使用TDD或者敏捷流程，Flutter可能是最优选择。</p>
<p><strong>原因五：AI的积极跟进</strong></p>
<p>Flutter在AI时代的表现让人刮目相看。</p>
<p>Google官方推出了Flutter AI Toolkit，直接集成了Gemini API。</p>
<p>开发者可以用几行代码就实现AI聊天、图像识别、语音转文字等功能。</p>
<p>而且Flutter对AI模型的本地部署支持也很好。</p>
<p>TensorFlow Lite、ONNX Runtime都有官方插件。</p>
<p>你可以把AI模型直接打包到应用里，不依赖网络也能跑AI功能。</p>
<p>这在隐私要求高的场景下特别有用。</p>
<p>最近还有个新玩意儿——Dart MCP Server。</p>
<p>简单说，就是让AI助手能直接理解和操作你的Dart/Flutter项目。</p>
<p>你可以让AI直接帮你写Flutter代码、读取运行中的组件树、调试问题、优化性能。</p>
<p>总之，可以看到Flutter团队在对接AI方面的前瞻性和重视度。</p>
<h4 data-id="heading-12">Flutter适合什么项目？</h4>
<p><strong>高性能应用</strong>：比如音视频应用</p>
<p><strong>复杂UI应用</strong>：比如电商、社交应用</p>
<p><strong>需要快速迭代的项目</strong>：比如创业公司的MVP产品</p>
<p><strong>但Flutter也有坑</strong></p>
<p><strong>学习成本高</strong>：需要学Dart语言，和JavaScript差别挺大</p>
<p><strong>包体积大</strong>：最小的Flutter应用也要10MB+</p>
<p><strong>原生功能调用复杂</strong>：需要写Platform Channel</p>
<p><strong>总结一下</strong></p>
<p>如果你的项目对性能要求高，UI比较复杂，团队有时间学习新技术。</p>
<p>Flutter是最佳选择。</p>
<p>特别是如果你们团队之前没有移动端开发经验，Flutter的学习曲线反而比原生开发更平缓。</p>
<hr/>
<h2 data-id="heading-13">三、中间层类框架</h2>
<p><strong>什么是中间层框架？</strong></p>
<p>简单来说，就是在你的代码和系统原生组件之间，加了一个"翻译官"。</p>
<p>你用JavaScript写界面逻辑，框架帮你"翻译"成原生的Button、TextView。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67b36baf13a2443b93a42b4e83e35f82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6ICB5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764318464&amp;x-signature=RPnBf4evMbqps3EQrP4%2BP9aQWH0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>这种方案有什么特点？</p>
<p><strong>第一，开发体验接近Web</strong></p>
<p>如果你的团队熟悉React、Vue这些Web框架，上手会很快。</p>
<p>基本上就是把Web开发的那套思路搬到移动端。</p>
<p><strong>第二，能调用原生组件</strong></p>
<p>最终渲染的还是系统原生的Button、Input。</p>
<p>所以界面看起来很"原生"，符合各平台的设计规范。</p>
<p><strong>第三，存在性能损耗</strong></p>
<p>因为有个"翻译"的过程，JavaScript和原生代码之间要频繁通信。</p>
<p>就像两个人通过翻译官对话，肯定比直接对话慢一些。</p>
<p>但这个损耗在交互不频繁的界面中，用户是感知不到的。</p>
<h3 data-id="heading-14">3.1 React Native</h3>
<h4 data-id="heading-15">React Native的优势</h4>
<p><strong>原因一：Web开发者的福音</strong></p>
<p>如果你会React，学React Native基本没有门槛。</p>
<p>同样的JSX语法，同样的组件化思想，同样的状态管理。</p>
<p>一个熟练的React开发者，一周就能上手React Native。</p>
<p><strong>原因二：生态系统超级丰富</strong></p>
<p>npm上有超过15万个React Native相关的包。</p>
<p>导航、动画、图表、支付...你能想到的功能都有现成的库。</p>
<p>而且因为和React共享生态，很多Web端的库稍作修改就能用。</p>
<p><strong>原因三：热更新能力</strong></p>
<p>这是React Native的杀手锏功能。</p>
<p>发现bug？不用重新发版，直接推送补丁代码就能修复。</p>
<p>新功能上线？用户打开App就能看到，不用去应用商店更新。</p>
<p>这对产品迭代速度的提升是巨大的。</p>
<p><strong>原因四：Meta的持续投入</strong></p>
<p>2024年Meta发布了新架构（New Architecture）。</p>
<p>引入了Fabric渲染器和TurboModules，性能提升了30%。</p>
<p>2025年10月8日，React Native 0.82 正式发布，新架构全面启用，旧架构正式退役。</p>
<h4 data-id="heading-16">React Native适合什么项目？</h4>
<p><strong>快速迭代的产品</strong>：比如社交应用、内容应用</p>
<p><strong>Web技术栈团队</strong>：已经有React开发经验的团队</p>
<p><strong>需要热更新的应用</strong>：比如电商、新闻类应用</p>
<p><strong>但React Native也有局限</strong></p>
<p><strong>性能瓶颈</strong>：复杂动画和大量数据处理时，桥接开销明显</p>
<p><strong>原生功能依赖</strong>：新的系统API需要等社区或自己封装</p>
<p><strong>版本升级成本</strong>：大版本升级可能需要改很多代码</p>
<h3 data-id="heading-17">3.2 .NET MAUI</h3>
<h4 data-id="heading-18">.NET MAUI是什么来头？</h4>
<p>2024年5月，微软正式停止了Xamarin的支持。</p>
<p>.NET MAUI（Multi-platform App UI）成为微软官方的跨平台解决方案。</p>
<p>这不是简单的换个名字，而是架构的全面升级。</p>
<p><strong>MAUI相比Xamarin有什么改进？</strong></p>
<p><strong>第一，统一的项目结构</strong></p>
<p>以前Xamarin需要为每个平台创建单独的项目。</p>
<p>MAUI只需要一个项目，就能构建所有平台的应用。</p>
<p><strong>第二，性能大幅提升</strong></p>
<p>新的渲染引擎减少了50%的内存占用。</p>
<p>启动速度比Xamarin快了30%。</p>
<p><strong>第三，开发体验优化</strong></p>
<p>热重载功能让你改C#代码后，立即看到效果。</p>
<p>集成了最新的.NET 8特性，开发效率更高。</p>
<h4 data-id="heading-19">.NET MAUI的独特优势</h4>
<p><strong>企业级支持</strong></p>
<p>微软提供长期技术支持（LTS）。</p>
<p>对于企业应用来说，这种稳定性保障非常重要。</p>
<p><strong>强大的数据处理能力</strong></p>
<p>C#在处理复杂业务逻辑方面有天然优势。</p>
<p>特别是金融、ERP这类数据密集型应用。</p>
<p><strong>与微软生态深度集成</strong></p>
<p>如果你的后端用Azure、数据库用SQL Server。</p>
<p>MAUI能提供最佳的集成体验。</p>
<h4 data-id="heading-20">.NET MAUI适合什么项目？</h4>
<p><strong>企业级应用</strong>：比如CRM、ERP、办公应用</p>
<p><strong>.NET技术栈团队</strong>：已经有C#开发经验的团队</p>
<p><strong>数据密集型应用</strong>：比如金融、医疗、教育管理系统</p>
<p><strong>但MAUI也有短板</strong></p>
<p><strong>学习门槛高</strong>：需要掌握C#和.NET生态</p>
<p><strong>社区相对较小</strong>：第三方库没有React Native丰富</p>
<p><strong>移动端特性支持滞后</strong>：新的移动端API支持可能会慢一些</p>
<h4 data-id="heading-21">中间层框架怎么选？</h4>
<p><strong>如果你的团队主要是Web开发者</strong></p>
<p>选React Native，学习成本最低，生态最丰富。</p>
<p><strong>如果你的项目是企业级应用</strong></p>
<p>选.NET MAUI，稳定性和长期支持更有保障。</p>
<p><strong>如果你需要频繁的热更新</strong></p>
<p>选React Native，这是它的核心优势。</p>
<p><strong>如果你的应用数据处理逻辑复杂</strong></p>
<p>选.NET MAUI，C#在这方面更有优势。</p>
<p><strong>总结一下中间层框架的特点</strong></p>
<p>优势：学习成本低，能复用Web开发经验，界面原生感强。</p>
<p>劣势：存在桥接性能损耗，依赖第三方库封装原生功能。</p>
<p>适合场景：快速开发、团队技术栈匹配、对原生感要求高的项目。</p>
<hr/>
<h2 data-id="heading-22">四、转译类框架</h2>
<p><strong>什么是转译？</strong></p>
<p>简单来说，就是把你写的高级语言代码，"翻译"成目标平台的原生代码。</p>
<p>比如你用Kotlin写业务逻辑，框架帮你"翻译"成iOS的Swift代码。</p>
<p>或者你用类TypeScript的语法写界面，框架帮你"翻译"成Android的Kotlin和iOS的Swift。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9149bba906fd41ada947ec5c06960ba4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6ICB5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764318464&amp;x-signature=Mz%2FJyRbRFQlmq%2BtXeWLEcuuqNkQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>这种方案有什么特点？</p>
<p><strong>第一，性能最接近原生</strong></p>
<p>因为最终运行的就是原生代码，没有任何中间层损耗。</p>
<p>就像你直接用Swift写iOS应用，用Kotlin写Android应用一样。</p>
<p><strong>第二，能享受原生生态</strong></p>
<p>转译后的代码可以直接调用平台的所有API。</p>
<p><strong>第三，转译效果可能不完美</strong></p>
<p>毕竟是机器"翻译"的代码，有时候可能不如手写的原生代码优雅。</p>
<p>特别是复杂的业务逻辑，转译后的代码可能需要人工优化。</p>
<p>但这个问题随着AI技术的发展，正在快速改善。</p>
<h3 data-id="heading-23">4.1 Kotlin Multiplatform (KMP)</h3>
<h4 data-id="heading-24">KMP为什么突然火了？</h4>
<p>2024年是KMP的爆发年。</p>
<p>5月份，Google在I/O大会上宣布官方支持KMP。</p>
<p>以前KMP只是JetBrains的"个人项目"，现在有了Google的官方背书。</p>
<p>Android开发者可以放心使用，不用担心被抛弃。</p>
<p><strong>Kotlin-to-Swift 导出功能已公开发布（10月首次发布），仍处早期阶段。</strong></p>
<p>你用Kotlin写的业务逻辑，可以直接转成Swift代码。</p>
<p>iOS开发者拿到的就是纯Swift代码，可以像原生项目一样调试和优化。</p>
<h4 data-id="heading-25">KMP的核心理念</h4>
<p><strong>"业务逻辑用KMP共享，UI用Compose Multiplatform统一开发"</strong></p>
<p>这是KMP的最新发展方向，结合了Compose Multiplatform的强大能力。</p>
<p>传统的KMP是"业务逻辑共享，UI各平台原生"。</p>
<p>但现在有了更好的选择——Compose Multiplatform。</p>
<p>一套Compose代码可以运行在Android、iOS、Desktop、Web等所有平台。</p>
<p>业务逻辑用KMP共享，UI用Compose Multiplatform统一开发。</p>
<p><strong>这样做有什么好处？</strong></p>
<p><strong>第一，真正的一套代码多平台</strong></p>
<p>不仅业务逻辑共享，UI也可以共享，开发效率大幅提升。</p>
<p><strong>第二，保持原生性能</strong></p>
<p>Compose Multiplatform在各平台都编译为原生代码，性能接近原生应用。</p>
<p><strong>第三，技术栈统一</strong></p>
<p>全部使用Kotlin生态，学习成本更低，团队协作更高效。</p>
<p><strong>第四，渐进式迁移</strong></p>
<p>你不需要重写整个应用，可以先从一个模块开始。</p>
<p>比如先把网络层用KMP重写，然后逐步迁移UI到Compose Multiplatform。</p>
<h4 data-id="heading-26">KMP + Compose Multiplatform适合什么项目？</h4>
<p><strong>需要快速多平台发布的项目</strong></p>
<p>一套代码可以同时发布到Android、iOS、Desktop、Web等平台。</p>
<p>开发效率比传统KMP方案大幅提升。</p>
<p><strong>密集调用原生API的项目</strong></p>
<p>比如游戏、金融交易、实时通信应用。</p>
<p>KMP + Compose Multiplatform能提供真正的原生无缝调用。</p>
<p><strong>Kotlin技术栈的团队</strong></p>
<p>如果团队熟悉Kotlin和Jetpack Compose。</p>
<p>这个组合是最自然的选择，学习成本最低。</p>
<p><strong>已有原生应用的团队</strong></p>
<p>可以渐进式迁移，先迁移业务逻辑，再迁移UI。</p>
<p>风险可控，收益明显。</p>
<p><strong>但这个组合也有挑战</strong></p>
<p><strong>Compose Multiplatform 在 iOS 端已稳定</strong>：生态仍在加速建设，注意版本兼容与插件成熟度</p>
<p><strong>学习成本相对较高</strong>：需要掌握Kotlin和Compose</p>
<p><strong>生态还在建设中</strong>：第三方库相对较少，但发展很快</p>
<h3 data-id="heading-27">4.2 uni-app / uni-app x</h3>
<h4 data-id="heading-28">uni-app的进化之路</h4>
<p>说到uni-app，很多人的印象还停留在"小程序开发工具"。</p>
<p>但2024年，uni-app发生了质的变化。</p>
<p><strong>传统uni-app</strong>：基于Vue.js + JavaScript，更适用于小程序开发</p>
<p><strong>uni-app x</strong>：全新架构，使用UTS语言，性能达到原生级别</p>
<p>这不是简单的版本升级，而是技术路线的根本改变。</p>
<h4 data-id="heading-29">uni-app x的技术突破</h4>
<p><strong>第一，UTS语言</strong></p>
<p>UTS（UniTypeScript）是DCloud自研的编程语言。</p>
<p>语法类似TypeScript，但编译后直接生成原生代码。</p>
<p>Android平台编译成Kotlin，iOS平台编译成Swift，鸿蒙平台编译成ArkTS。</p>
<p><strong>第二，uvue渲染引擎</strong></p>
<p>这是uni-app x的核心技术。</p>
<p>不同于传统的WebView渲染，uvue直接调用原生渲染引擎。</p>
<p>性能和原生应用完全一致，没有任何损耗。</p>
<p><strong>第三，无桥接架构</strong></p>
<p>传统跨平台框架都有个"桥接层"，用来连接JavaScript和原生代码。</p>
<p>uni-app x直接编译成原生代码，完全没有桥接层。</p>
<p>这意味着没有跨语言通信损耗，性能达到原生级别。</p>
<p><strong>第四，直接调用原生API</strong></p>
<p>因为编译后就是原生代码，可以直接调用平台的所有API。</p>
<p>不需要等插件封装，新的系统功能立即可用。</p>
<h4 data-id="heading-30">uni-app x的独特优势</h4>
<p><strong>平台支持最全</strong></p>
<p>这是uni-app的传统优势。</p>
<p>一套代码可以发布到：iOS、Android、Web、各种小程序、快应用、鸿蒙...</p>
<p>总共支持14+个平台，这是其他框架做不到的。</p>
<p><strong>小程序优先的设计理念</strong></p>
<p>如果你的产品需要同时支持App和小程序。</p>
<p>uni-app是唯一的选择。</p>
<p>其他框架都是"App优先"，小程序支持都是后加的。</p>
<p><strong>国产化支持</strong></p>
<p>对鸿蒙、信创等国产化平台支持最好。</p>
<p>这对国内企业来说非常重要。</p>
<p><strong>学习成本低</strong></p>
<p>如果你会Vue.js，学uni-app基本没有门槛。</p>
<p>语法、组件、生态都和Vue高度一致。</p>
<p><strong>但uni-app也有局限</strong></p>
<p><strong>生态相对封闭</strong>：主要依赖DCloud的生态</p>
<p><strong>国际化程度低</strong>：海外开发者使用较少</p>
<p><strong>技术栈绑定</strong>：主要适合Vue技术栈</p>
<h3 data-id="heading-31">4.3 Valdi 加入战场</h3>
<h4 data-id="heading-32">Valdi 是啥？</h4>
<p><strong>Snapchat憋了8年的大招</strong></p>
<p>这个叫Valdi的框架，在Snapchat内部默默服役了整整8年，扛住了8.5亿月活的洪荒流量。</p>
<p>开源仅仅7天，GitHub星标就冲破了4.2k，直接霸榜Trending。</p>
<p><strong>为什么Snapchat要自己造轮子？</strong></p>
<p>2016年，Snapchat用户数爆炸式增长。</p>
<p>React Native刚出，性能和生态都不足以让大型应用放心。</p>
<p>Flutter还没发布（2017年才发布Beta版）。</p>
<p>纯原生开发又意味着iOS/Android两套代码，开发效率很难满足高速增长的需求。</p>
<p>于是Snapchat决定拉起一支小分队，用TypeScript写UI，让编译器直接吐出原生控件。</p>
<p>内部代号"Valdi"，源自北欧神话的"力量之神"。</p>
<p><strong>8年过去，200+版本，5000+次MR</strong></p>
<h4 data-id="heading-33">Valdi 的基本原理</h4>
<p>Valdi的核心思路属于转义方案的范畴，但是并发代码级转义。</p>
<p>具体怎么做到的？</p>
<p><strong>1. 编译时转译</strong></p>
<ul>
<li>TSX代码 → 原生视图代码（OC/Swift + Java/Kotlin）</li>
<li>布局引擎用C++重写，支持独立重渲染和视图回收</li>
<li>编译阶段就生成类型安全的绑定，空指针异常直接堵在编译期</li>
</ul>
<p><strong>2. 运行时架构</strong></p>
<ul>
<li>无JS Bridge，零跨线程通信开销</li>
<li>业务逻辑可分层：性能关键路径用C++/Swift/Kotlin写"Polyglot模块"，框架自动生成TS绑定</li>
<li>非关键逻辑留在JS端，配合Worker线程做后台任务</li>
</ul>
<p><strong>3. 热重载机制</strong></p>
<ul>
<li>文件保存 → 200ms内看到刷新</li>
<li>不丢状态、不重启App</li>
<li>VSCode调试链完整，断点直接断在TS源码</li>
</ul>
<p><strong>4. 内存管理</strong></p>
<ul>
<li>自动视图回收</li>
<li>增量渲染</li>
</ul>
<p>这种技术方案其实是介于转译和中间层之间的一种方式。</p>
<p>UI组件树翻译成原生组件，组件的生命周期交给C++编写的引擎管理，业务逻辑部分则保留在TS层。</p>
<p>这样的好处是在一定程度上避免了转译类方案代码翻译不到位造成的一些问题。</p>
<p>但是仍然会有中间层方案在高UI交互场景下的性能问题，这部分就需要把处理逻辑放到C++/Swift/Kotlin编写的"Polyglot模块"解决。</p>
<p>总的来说，这套架构在Snapchat内部跑了8年，扛住了8.5亿月活的洪荒流量。</p>
<p>现在开源出来，就是把踩过的坑都帮你填平了。</p>
<h4 data-id="heading-34">Valdi 尚处于生命周期的早起</h4>
<p><strong>平台限制</strong></p>
<p>目前仅支持iOS、Android和 macOS</p>
<p>Windows版本要等到2026年Q1。</p>
<p>Web支持也还在路上，预计2026年Q2才会发布。</p>
<p><strong>生态建设初期</strong></p>
<p>相比React Native和Flutter，Valdi的开源生态和第三方组件库还在早期阶段。</p>
<p>复杂图表、地图等高级组件需要自己动手桥接原生SDK。</p>
<p>虽然可以通过"Polyglot模块"和custom-view嵌入原生控件，但短期还是需要投入额外开发成本。</p>
<p><strong>API稳定性风险</strong></p>
<p>当前版本还是Beta-0.0.1，API可能会微调。</p>
<p>官方建议先在独立模块或小业务试水，不要直接all in。</p>
<p><strong>对原生能力的要求</strong></p>
<p>虽然主打"零原生代码"，但性能关键路径还是需要写C++/Swift/Kotlin的"Polyglot模块"。</p>
<p>平台API调用、生命周期管理等也需要一定的原生开发经验。</p>
<p><strong>CI/CD复杂度</strong></p>
<p>需要搭建成熟的CI构建流程和代码生成规范。</p>
<p>多端工程和绑定管理相对复杂，对团队的技术栈要求较高。</p>
<p><strong>总结一句话：Valdi很有潜力，但现在更适合技术探索，不是生产环境的首选。</strong></p>
<p>站在纯粹客户端跨平台开发的角度，转义类方案老刘目前更推荐KMP。</p>
<p>Valdi可以作为一个有潜力的备选，等生态更加成熟后再重新考虑。</p>
<h3 data-id="heading-35">转译类框架怎么选？</h3>
<p><strong>如果你有现有的原生应用</strong></p>
<p>选KMP，可以渐进式迁移，风险最小。</p>
<p><strong>如果你需要支持小程序</strong></p>
<p>选uni-app，这是它的核心优势。</p>
<p><strong>如果你对性能要求极高</strong></p>
<p>KMP和uni-app x都可以，看团队技术栈。</p>
<p><strong>如果你的团队是Vue技术栈</strong></p>
<p>选uni-app，学习成本最低。</p>
<p><strong>如果你的团队是Android技术栈</strong></p>
<p>选KMP，Kotlin是你们的强项。</p>
<p><strong>总结一下转译类框架的特点</strong></p>
<p>优势：性能最接近原生，能享受原生生态，没有运行时损耗。</p>
<p>劣势：学习成本相对较高，转译效果可能需要优化。</p>
<p>适合场景：对性能要求高、需要调用大量原生功能、有原生开发基础的团队。</p>
<hr/>
<h2 data-id="heading-36">五、技术选型指南</h2>
<p>看了这么多框架，是不是更纠结了？</p>
<p>别慌，老刘给你一个简单粗暴的选型指南。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/999fb95e5f2e4c5ca6555115e960f788~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6ICB5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764318464&amp;x-signature=eeCXdmY7Yq0Y90ygB%2Bs7GkQ0Mis%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-37">5.1 Flutter：大多数App的不二之选</h3>
<p>其实对于大多数App来说，Flutter都是当前阶段最合适的选择</p>
<p>为什么这么说？</p>
<p><strong>性能足够强悍</strong></p>
<p>如果在大街上随机找100个人，把他们手机里面的非游戏类App都拿出来，那么其中99%都是Flutter可以胜任的。</p>
<p>对于性能有极端要求的App来说其实大概率原生开发也不行，需要更深度的优化方式。</p>
<p>比如把数据加解密、视频编解码等工作封装到更底层的so库中。</p>
<p>而这种优化方案在Flutter项目中也能使用，工作量和原生中差不多。</p>
<p><strong>开发效率够高</strong></p>
<p>Flutter的热重载功能，改代码后1秒内就能看到效果。</p>
<p>这比原生开发快了10倍不止。</p>
<p>而且Flutter的组件库非常丰富。</p>
<p>Material Design和Cupertino组件开箱即用。</p>
<p>对于更复杂的组件和绘制定制场景，由于Flutter自带渲染引擎，因此也可以直接在暴露给开发者的canvas上进行更复杂的渲染定制。</p>
<p><strong>TDD开发流程的完美搭档</strong></p>
<p>Flutter天生支持单元测试、集成测试、UI测试。</p>
<p>测试覆盖率可以轻松达到90%以上。</p>
<p>CI/CD集成也非常简单，GitHub Actions、GitLab CI都有现成的模板。</p>
<p>如果计划采用TDD相关的开发流程，Flutter可能是目前唯一的选择。</p>
<p><strong>AI时代的宠儿</strong></p>
<p>Google全力加持Flutter，AI工具链日趋完善。</p>
<p>GPT、Cursor、Claude Code对Flutter的支持都很好。</p>
<p>写Flutter代码，AI能帮你完成80%的重复工作。</p>
<p><strong>Flutter适合什么项目？</strong></p>
<ul>
<li>需要高性能的应用（游戏、视频、图形处理）</li>
<li>对UI一致性要求高的应用</li>
<li>团队有充足的学习时间</li>
<li>需要长期维护的项目</li>
<li>对包体积不是特别敏感的应用</li>
</ul>
<h3 data-id="heading-38">5.2 KMP：潜力股还是画饼？先别急着上车</h3>
<p><strong>Kotlin Multiplatform：Google亲儿子的野心与现实</strong></p>
<p>KMP确实很香，但现在上车可能还早了点。</p>
<p><strong>现状分析：技术很香，但生态还在"襁褓期"</strong></p>
<p>KMP的技术理念非常先进。</p>
<p>但问题是——生态还不够成熟。</p>
<p>第三方库支持有限，很多常用功能需要自己封装。</p>
<p>调试工具也不够完善，出了问题排查起来比较麻烦。</p>
<p><strong>适用场景：密集调用原生API的项目可以关注</strong></p>
<p>如果你的应用需要大量调用原生API：</p>
<ul>
<li>相机、麦克风、传感器</li>
<li>蓝牙、NFC、GPS</li>
<li>系统级权限管理</li>
</ul>
<p>KMP确实有优势。</p>
<p>因为它可以直接调用原生代码，没有性能损耗。</p>
<p><strong>风险提醒：早期采用者需要踩坑的心理准备</strong></p>
<p>选择KMP，你需要做好这些准备：</p>
<ul>
<li>遇到问题时，Stack Overflow上的答案可能很少</li>
<li>第三方库可能不支持，需要自己写原生桥接</li>
<li>团队需要同时掌握Kotlin、Swift、Android、iOS开发</li>
<li>项目初期开发效率可能不如Flutter</li>
</ul>
<p><strong>未来展望：如果KMP真正成熟，将是原生开发的强力补充</strong></p>
<p>Google已经把KMP列为官方支持的技术。</p>
<p>JetBrains也在大力投入。</p>
<p>如果生态能在2025年下半年成熟起来，KMP确实值得考虑。</p>
<p><strong>建议：除非你是技术极客，否则再等等</strong></p>
<p>如果你的团队技术实力很强，喜欢尝试新技术，可以在小项目上试试KMP。</p>
<p>但如果你需要稳定可靠的解决方案，建议再等一年。</p>
<p>等KMP的生态更成熟一些，再考虑大规模使用。</p>
<h3 data-id="heading-39">5.3 App + 小程序：别被"一套代码走天下"忽悠了</h3>
<p><strong>App和小程序一套代码？这可能是个伪命题！</strong></p>
<p>很多人被"一套代码，多端运行"的口号忽悠了。</p>
<p>以为App和小程序可以用同一套代码。</p>
<p>但现实是——这样做可能得不偿失。</p>
<p><strong>思维误区：把小程序当App的"乞丐版"是大错特错</strong></p>
<p>很多人觉得小程序就是App的简化版。</p>
<p>功能少一点，界面简单一点，用户体验差一点。</p>
<p>这种想法完全错了。</p>
<p>App和小程序应该承担不同的产品职责。</p>
<p><strong>正确姿势：App和小程序应该承担不同的产品职责</strong></p>
<p>App的优势：</p>
<ul>
<li>性能更好，可以做复杂交互</li>
<li>可以离线使用</li>
<li>推送通知更及时</li>
<li>用户粘性更高</li>
</ul>
<p>小程序的优势：</p>
<ul>
<li>获客成本更低</li>
<li>分享传播更容易</li>
<li>用户使用门槛更低</li>
<li>可以借助平台流量</li>
</ul>
<p><strong>成功案例解析：微信读书的智慧分工</strong></p>
<p>微信读书就是一个很好的例子。</p>
<p><strong>App承担重交互功能：</strong></p>
<ul>
<li>长时间阅读体验优化</li>
<li>个性化推荐算法</li>
<li>离线下载功能</li>
<li>复杂的社交互动</li>
</ul>
<p><strong>小程序专注营销拉新：</strong></p>
<ul>
<li>好友推荐分享</li>
<li>读书打卡活动</li>
<li>限时免费活动</li>
<li>新用户引导体验</li>
</ul>
<p>这样分工，App和小程序各司其职，效果比"一套代码"好得多。</p>
<p><strong>技术选型建议</strong></p>
<p><strong>功能重叠度高的情况：</strong></p>
<p>如果你的App和小程序功能重叠度超过70%，可以考虑uni-app等跨端方案。</p>
<p>比如电商类应用，商品展示、购物车、订单管理这些功能，App和小程序基本一样。</p>
<p><strong>功能差异化大的情况：</strong></p>
<p>如果App和小程序的功能差异很大，建议分别选择最适合的技术栈。</p>
<p>App用Flutter或原生开发，专注用户体验。</p>
<p>小程序用原生小程序开发，专注营销转化。</p>
<p><strong>避坑指南：不要为了技术统一而牺牲用户体验</strong></p>
<p>很多团队为了技术栈统一，强行用一套代码开发App和小程序。</p>
<p>结果App体验不如原生，小程序功能又太复杂。</p>
<p>两边都不讨好。</p>
<p>记住：技术是为产品服务的，不是为了技术而技术。</p>
<p><strong>总结一下技术选型的核心原则</strong></p>
<ol>
<li>
<p><strong>大多数情况选Flutter</strong>：性能、生态、开发效率都很均衡</p>
</li>
<li>
<p><strong>KMP可以关注但别急着用</strong>：等生态成熟一些再说</p>
</li>
<li>
<p><strong>App和小程序要差异化定位</strong>：不要被"一套代码"忽悠</p>
</li>
<li>
<p><strong>根据团队技术栈选择</strong>：学习成本也是成本</p>
</li>
<li>
<p><strong>考虑项目的长期维护</strong>：选择有长期支持的技术</p>
</li>
</ol>
<hr/>
<h2 data-id="heading-40">六、总结与建议</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5cf0224e1b3843ecb4c86125e626460f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6ICB5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764318464&amp;x-signature=u5AFvNoAjL3uD4otT5zS2eUS06g%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>写了这么多，老刘最后给你一个终极建议。</p>
<p><strong>2025年跨平台开发，记住这三个关键词：务实、聚焦、长期主义。</strong></p>
<h3 data-id="heading-41">务实：别追求完美的技术方案</h3>
<p>很多团队陷入"技术洁癖"。</p>
<p>总想找到一个完美的跨平台方案，既要性能好，又要学习成本低，还要生态丰富。</p>
<p>醒醒吧，这样的方案不存在。</p>
<p><strong>每种技术都有trade-off。</strong></p>
<p>Flutter性能好但包体积大。</p>
<p>React Native生态好但有桥接损耗。</p>
<p>KMP接近原生但生态不成熟。</p>
<p>uni-app平台全但主要适合Vue技术栈。</p>
<p><strong>选择技术的核心是：在当前约束条件下，哪个方案的收益最大。</strong></p>
<p>不要追求完美，要追求合适。</p>
<h3 data-id="heading-42">聚焦：一个团队最多掌握两种跨平台技术</h3>
<p>很多公司什么技术都想试。</p>
<p>Flutter也搞，React Native也搞，KMP也要研究。</p>
<p>结果每个都不精通，遇到问题都解决不了。</p>
<p><strong>建议：选定一个主力技术栈，最多再备一个备选方案。</strong></p>
<h3 data-id="heading-43">长期主义：技术选型要考虑3年后的维护成本</h3>
<p>很多人以为选定技术栈就万事大吉了。</p>
<p>其实真正决定项目生死的，是你选定技术栈之后做的那些事。</p>
<p><strong>架构设计够不够清晰？</strong></p>
<p>模块划分是否合理，接口设计是否稳定，这些直接影响后续迭代的难度。</p>
<p><strong>开发流程够不够规范？</strong></p>
<p>CI/CD流水线、代码审查、测试覆盖率，这些看似繁琐的流程，3年后会救你的命。</p>
<p><strong>代码规范够不够严格？</strong></p>
<p>命名规范、注释规范、目录结构，新人能不能快速上手，老代码能不能看懂。</p>
<p><strong>技术债务管理够不够及时？</strong></p>
<p>每次为了赶进度留下的坑，3年后都会变成巨坑。</p>
<p>选定技术栈不是终点，而是起点。</p>
<p>做好这些基础建设，才是项目能持续健康演进的根本。</p>
<p>否则，再好的技术栈也救不了你。</p>
<h3 data-id="heading-44">最后的最后：技术选型没有标准答案</h3>
<p>老刘写这篇文章，不是为了告诉你"必须选哪个技术"。</p>
<p>而是希望你在选择时，能有一个清晰的思考框架。</p>
<p><strong>2025年，跨平台开发已经不是"能不能做"的问题，而是"怎么做得更好"的问题。</strong></p>
<p>选对了技术栈，团队效率起飞。</p>
<p>选错了技术栈，就是几个月的坑。</p>
<p>希望这篇"跨平台开发地图"能帮你避开那些坑，找到最适合你的路。</p>
<blockquote>
<p>如果看到这里的同学对客户端或者Flutter开发感兴趣，欢迎联系老刘，我们互相学习。</p>
<p>私信免费领老刘整理的《Flutter开发手册》，覆盖90%应用开发场景。</p>
<p>可以作为Flutter学习的知识地图。</p>
<p>—— laoliu_dev</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[初识 ACP （Agent Client Protocol）]]></title>    <link>https://juejin.cn/post/7574992086714630159</link>    <guid>https://juejin.cn/post/7574992086714630159</guid>    <pubDate>2025-11-21T08:41:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574992086714630159" data-draft-id="7574749664492519458" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="初识 ACP （Agent Client Protocol）"/> <meta itemprop="keywords" content="AI编程,MCP,人工智能"/> <meta itemprop="datePublished" content="2025-11-21T08:41:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="魁首"/> <meta itemprop="url" content="https://juejin.cn/user/3817931570691031"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            初识 ACP （Agent Client Protocol）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817931570691031/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    魁首
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T08:41:55.000Z" title="Fri Nov 21 2025 08:41:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">初识 ACP 协议：AI 编码助手的标准化通信协议</h2>
<blockquote>
<p>从 MCP 到 ACP，探索 AI Agent 生态的标准化之路</p>
</blockquote>
<h3 data-id="heading-1">目录</h3>
<ul>
<li><a href="#%E4%B8%80%E5%BC%95%E8%A8%80ai-agent-%E7%94%9F%E6%80%81%E7%9A%84%E6%A0%87%E5%87%86%E5%8C%96%E6%8C%91%E6%88%98" title="#%E4%B8%80%E5%BC%95%E8%A8%80ai-agent-%E7%94%9F%E6%80%81%E7%9A%84%E6%A0%87%E5%87%86%E5%8C%96%E6%8C%91%E6%88%98">一、引言：AI Agent 生态的标准化挑战</a></li>
<li><a href="#%E4%BA%8C%E4%BB%8E-mcp-%E8%AF%B4%E8%B5%B7%E7%90%86%E8%A7%A3-ai-%E5%8D%8F%E8%AE%AE%E7%9A%84%E6%BC%94%E8%BF%9B" title="#%E4%BA%8C%E4%BB%8E-mcp-%E8%AF%B4%E8%B5%B7%E7%90%86%E8%A7%A3-ai-%E5%8D%8F%E8%AE%AE%E7%9A%84%E6%BC%94%E8%BF%9B">二、从 MCP 说起：理解 AI 协议的演进</a></li>
<li><a href="#%E4%B8%89acp-%E6%98%AF%E4%BB%80%E4%B9%88" title="#%E4%B8%89acp-%E6%98%AF%E4%BB%80%E4%B9%88">三、ACP 是什么？</a></li>
<li><a href="#%E5%9B%9Bacp-%E6%A0%B8%E5%BF%83%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1" title="#%E5%9B%9Bacp-%E6%A0%B8%E5%BF%83%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1">四、ACP 核心架构设计</a></li>
<li><a href="#%E4%BA%94acp-%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3" title="#%E4%BA%94acp-%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3">五、ACP 协议详解</a></li>
<li><a href="#%E5%85%ADacp-%E5%AE%9E%E6%88%98%E4%BB%8E%E4%BB%A3%E7%A0%81%E7%9C%8B%E5%AE%9E%E7%8E%B0" title="#%E5%85%ADacp-%E5%AE%9E%E6%88%98%E4%BB%8E%E4%BB%A3%E7%A0%81%E7%9C%8B%E5%AE%9E%E7%8E%B0">六、ACP 实战：从代码看实现</a></li>
<li><a href="#%E4%B8%83acp-vs-mcp%E4%B8%A4%E4%B8%AA%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%AF%B9%E6%AF%94%E4%B8%8E%E4%BA%92%E8%A1%A5" title="#%E4%B8%83acp-vs-mcp%E4%B8%A4%E4%B8%AA%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%AF%B9%E6%AF%94%E4%B8%8E%E4%BA%92%E8%A1%A5">七、ACP vs MCP：两个协议的对比与互补</a></li>
<li><a href="#%E5%85%AB%E7%94%9F%E6%80%81%E7%B3%BB%E7%BB%9F%E4%B8%8E%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8" title="#%E5%85%AB%E7%94%9F%E6%80%81%E7%B3%BB%E7%BB%9F%E4%B8%8E%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8">八、生态系统与实际应用</a></li>
<li><a href="#%E4%B9%9D%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B8%8E%E5%AE%89%E5%85%A8%E8%80%83%E9%87%8F" title="#%E4%B9%9D%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B8%8E%E5%AE%89%E5%85%A8%E8%80%83%E9%87%8F">九、最佳实践与安全考量</a></li>
<li><a href="#%E5%8D%81%E6%9C%AA%E6%9D%A5%E5%B1%95%E6%9C%9B" title="#%E5%8D%81%E6%9C%AA%E6%9D%A5%E5%B1%95%E6%9C%9B">十、未来展望</a></li>
</ul>
<hr/>
<h3 data-id="heading-2">一、引言：AI Agent 生态的标准化挑战</h3>
<h4 data-id="heading-3">1.1 当前 AI 开发工具面临的问题</h4>
<p>在 AI 辅助编程工具快速发展的今天，我们看到了各种强大的 AI 编码助手：</p>
<ul>
<li><strong>GitHub Copilot</strong>：微软的 AI 代码补全工具</li>
<li><strong>Cursor</strong>：AI 驱动的代码编辑器</li>
<li><strong>Claude Code</strong>：Anthropic 的智能编码助手</li>
<li><strong>Codex CLI</strong>：OpenAI 的命令行编码工具</li>
<li><strong>Gemini Code Assist</strong>：Google 的编码助手</li>
</ul>
<p>然而，这些工具之间存在严重的<strong>互操作性问题</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "现状：信息孤岛"
        VSCode[VS Code] --&gt;|锁定| Copilot[Copilot]
        Zed[Zed] --&gt;|锁定| Agent[Agent]

        Claude[Claude]
        Gemini[Gemini]

        VSCode -.X.- Claude
        VSCode -.X.- Gemini
        Zed -.X.- Claude
        Zed -.X.- Copilot

        style VSCode fill:#e1f5ff
        style Zed fill:#e1f5ff
        style Copilot fill:#fff4e6
        style Agent fill:#fff4e6
        style Claude fill:#f3e5f5
        style Gemini fill:#f3e5f5
    end

    Note["每个编辑器只能用特定的 Agent&lt;br/&gt;用户无法自由选择和切换"]

    style Note fill:#ffebee,stroke:#c62828
</code></pre>
<p><strong>核心挑战：</strong></p>
<ol>
<li><strong>编辑器锁定</strong>：用户必须为特定 AI Agent 切换编辑器</li>
<li><strong>重复开发</strong>：每个编辑器都要为每个 Agent 单独开发集成</li>
<li><strong>用户体验割裂</strong>：不同 Agent 的交互方式完全不同</li>
<li><strong>生态碎片化</strong>：难以形成统一的开发者社区</li>
</ol>
<h4 data-id="heading-4">1.2 标准化协议的价值</h4>
<p>正如 <strong>Language Server Protocol (LSP)</strong> 将语言智能从单一 IDE 中解放出来，我们需要一个类似的标准来解决 AI Agent 的互操作性问题。</p>
<p>这就是 <strong>Agent Client Protocol (ACP)</strong> 诞生的背景。</p>
<hr/>
<h3 data-id="heading-5">二、从 MCP 说起：理解 AI 协议的演进</h3>
<h4 data-id="heading-6">2.1 什么是 MCP？</h4>
<p>在介绍 ACP 之前，我们需要先了解 <a href="https://juejin.cn/post/7555815079645036598" target="_blank" title="https://juejin.cn/post/7555815079645036598">MCP (Model Context Protocol)</a>。</p>
<p><strong>MCP</strong> 是 Anthropic 推出的开源标准协议，用于连接 <strong>AI 模型</strong>与<strong>外部系统</strong>（数据源、工具、API 等）。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    AIModel["AI Model&lt;br/&gt;(Claude, GPT, etc.)"]

    AIModel --&gt;|MCP Protocol| MCPServers

    subgraph MCPServers["MCP Servers"]
        DB[Database Server]
        FS[File System]
        API[API Services]
        KB[Knowledge Base]
    end

    style AIModel fill:#e3f2fd
    style MCPServers fill:#f3e5f5
    style DB fill:#fff3e0
    style FS fill:#fff3e0
    style API fill:#fff3e0
    style KB fill:#fff3e0
</code></pre>
<p><strong>MCP 的三大核心原语：</strong></p>
<h5 data-id="heading-7">2.1.1 Resources（资源）</h5>
<p>类似文件系统的只读数据源，供 AI 模型读取上下文。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// MCP Resource 示例</span>
{
  <span class="hljs-string">"uri"</span>: <span class="hljs-string">"file:///workspace/README.md"</span>,
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"项目文档"</span>,
  <span class="hljs-string">"mimeType"</span>: <span class="hljs-string">"text/markdown"</span>,
  <span class="hljs-string">"description"</span>: <span class="hljs-string">"项目需求和架构文档"</span>
}
</code></pre>
<h5 data-id="heading-8">2.1.2 Tools（工具）</h5>
<p>AI 模型可调用的可执行函数。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> mcp.server.fastmcp <span class="hljs-keyword">import</span> FastMCP

mcp = FastMCP(<span class="hljs-string">"code-tools"</span>)

<span class="hljs-meta">@mcp.tool()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_tests</span>(<span class="hljs-params">test_file: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""运行指定的测试文件"""</span>
    result = subprocess.run([<span class="hljs-string">'pytest'</span>, test_file], capture_output=<span class="hljs-literal">True</span>)
    <span class="hljs-keyword">return</span> result.stdout.decode()
</code></pre>
<h5 data-id="heading-9">2.1.3 Prompts（提示模板）</h5>
<p>预编写的任务模板，标准化常见操作。</p>
<pre><code class="hljs language-typescript" lang="typescript">{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"code_review"</span>,
  <span class="hljs-string">"description"</span>: <span class="hljs-string">"代码审查提示模板"</span>,
  <span class="hljs-string">"arguments"</span>: [
    {
      <span class="hljs-string">"name"</span>: <span class="hljs-string">"language"</span>,
      <span class="hljs-string">"description"</span>: <span class="hljs-string">"编程语言"</span>,
      <span class="hljs-string">"required"</span>: <span class="hljs-literal">true</span>
    }
  ]
}
</code></pre>
<h4 data-id="heading-10">2.2 MCP 的局限性</h4>
<p>虽然 MCP 解决了 AI 模型与工具的连接问题，但它<strong>并不解决编辑器与 AI Agent 的通信问题</strong>。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    Editor["编辑器&lt;br/&gt;(Zed)"] -.-&gt;|"❓ 没有标准协议"| Agent["AI Agent&lt;br/&gt;(Claude)"]
    Agent --&gt;|"✓ MCP 协议"| Tools["工具&lt;br/&gt;(DB/API)"]

    style Editor fill:#ffebee
    style Agent fill:#e8f5e9
    style Tools fill:#e8f5e9
</code></pre>
<p>这就是 <strong>ACP</strong> 要解决的问题。</p>
<hr/>
<h3 data-id="heading-11">三、ACP 是什么？</h3>
<h4 data-id="heading-12">3.1 定义</h4>
<p><strong>Agent Client Protocol (ACP)</strong> 是一个<strong>开放标准协议</strong>，用于规范<strong>代码编辑器</strong>与 **AI 编码助手（Coding Agent）**之间的通信。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    Editor["Editor&lt;br/&gt;(Zed)"]
    Agent["Agent&lt;br/&gt;(Claude)"]
    Tools["Tools &amp; Resources"]

    Editor &lt;--&gt;|ACP Protocol| Agent
    Agent --&gt;|MCP Protocol| Tools

    style Editor fill:#e3f2fd
    style Agent fill:#fff3e0
    style Tools fill:#e8f5e9
</code></pre>
<p><strong>核心理念：</strong></p>
<blockquote>
<p>就像 USB-C 接口可以连接任何设备，ACP 让任何编辑器都能使用任何 AI Agent。</p>
</blockquote>
<h4 data-id="heading-13">3.2 设计目标</h4>

























<table><thead><tr><th>目标</th><th>说明</th></tr></thead><tbody><tr><td><strong>通用性</strong></td><td>任何编辑器都能集成任何符合 ACP 的 Agent</td></tr><tr><td><strong>隐私优先</strong></td><td>本地通信，不经过第三方服务器</td></tr><tr><td><strong>开源开放</strong></td><td>Apache 2.0 许可证，任何人都可以实现</td></tr><tr><td><strong>可扩展性</strong></td><td>支持未来的新功能和新场景</td></tr></tbody></table>
<h4 data-id="heading-14">3.3 与 LSP 的类比</h4>
<p>如果你熟悉 <strong>Language Server Protocol (LSP)</strong>，可以这样理解 ACP：</p>
<p><strong>LSP 之于语言智能 = ACP 之于 AI 编码助手</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    subgraph LSP["LSP 模式"]
        E1[VS Code] &lt;--&gt;|LSP| L1[TypeScript]
        E2[Vim] &lt;--&gt;|LSP| L2[Python]
        E3[Emacs] &lt;--&gt;|LSP| L3[Go]
    end

    subgraph ACP["ACP 模式"]
        E4[Zed] &lt;--&gt;|ACP| A1[Claude Code]
        E5[Neovim] &lt;--&gt;|ACP| A2[Gemini]
        E6[JetBrains] &lt;--&gt;|ACP| A3[Codex]
    end

    style LSP fill:#e3f2fd
    style ACP fill:#fff3e0
</code></pre>
<hr/>
<h3 data-id="heading-15">四、ACP 核心架构设计</h3>
<h4 data-id="heading-16">4.1 通信模型</h4>
<p>ACP 采用 <strong>JSON-RPC 2.0</strong> 协议，基于 **stdio（标准输入输出）**进行通信。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    Editor["Editor&lt;br/&gt;(主进程)"]
    Agent["Agent&lt;br/&gt;(子进程)"]

    Editor --&gt;|"spawn()"| Agent
    Editor --&gt;|"写入 stdin&lt;br/&gt;(JSON-RPC 2.0)"| Agent
    Agent --&gt;|"写入 stdout&lt;br/&gt;(JSON-RPC 2.0)"| Editor

    style Editor fill:#e3f2fd
    style Agent fill:#fff3e0

    Note["通信方式：&lt;br/&gt;• Editor 写入 Agent 的 stdin&lt;br/&gt;• Agent 写入 stdout 返回给 Editor&lt;br/&gt;• 消息格式：JSON-RPC 2.0"]
    style Note fill:#e8f5e9
</code></pre>
<p><strong>优势：</strong></p>
<ol>
<li><strong>简单高效</strong>：无需网络层，直接进程间通信</li>
<li><strong>隐私安全</strong>：所有数据都在本地，不经过外部服务器</li>
<li><strong>跨平台</strong>：stdin/stdout 是所有操作系统的标准</li>
</ol>
<h4 data-id="heading-17">4.2 协议层次</h4>
<p>ACP 分为两个核心层：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    subgraph Application["应用层 (Application Layer)"]
        SM[Session Management]
        TC[Tool Calls]
        PR[Permission Requests]
        FO[File Operations]
    end

    subgraph Protocol["协议层 (Protocol Layer)"]
        JSON[JSON-RPC 2.0]
        RR[Request/Response]
        NT[Notifications]
        EH[Error Handling]
    end

    subgraph Transport["传输层 (Transport Layer)"]
        STDIO[stdio - stdin/stdout]
    end

    Application --&gt; Protocol
    Protocol --&gt; Transport

    style Application fill:#e3f2fd
    style Protocol fill:#fff3e0
    style Transport fill:#e8f5e9
</code></pre>
<h4 data-id="heading-18">4.3 消息类型</h4>
<p>ACP 支持三种消息类型：</p>
<h5 data-id="heading-19">4.3.1. Request（请求）</h5>
<p>客户端向服务器发送请求，期待响应。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"initialize"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.1.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"clientInfo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Zed"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.158.0"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h5 data-id="heading-20">4.3.2. Response（响应）</h5>
<p>服务器对请求的响应。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.1.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"serverInfo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Claude Code"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"capabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"resources"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h5 data-id="heading-21">4.3.3. Notification（通知）</h5>
<p>单向消息，不期待响应。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"session/update"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"sessionId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"session-123"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"update"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"sessionUpdate"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"agent_message_chunk"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"正在分析代码..."</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-22">五、ACP 协议详解</h3>
<h4 data-id="heading-23">5.1 核心方法</h4>
<p>ACP 定义了一系列标准方法：</p>























































<table><thead><tr><th>方法</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td><code>initialize</code></td><td>Request</td><td>初始化连接，交换能力信息</td></tr><tr><td><code>authenticate</code></td><td>Request</td><td>身份验证（可选）</td></tr><tr><td><code>session/new</code></td><td>Request</td><td>创建新的对话会话</td></tr><tr><td><code>session/prompt</code></td><td>Request</td><td>向 Agent 发送用户消息</td></tr><tr><td><code>session/update</code></td><td>Notification</td><td>Agent 推送会话更新</td></tr><tr><td><code>session/request_permission</code></td><td>Notification</td><td>Agent 请求用户权限</td></tr><tr><td><code>fs/read_text_file</code></td><td>Request</td><td>读取文件内容</td></tr><tr><td><code>fs/write_text_file</code></td><td>Request</td><td>写入文件内容</td></tr><tr><td><code>end_turn</code></td><td>Notification</td><td>Agent 完成一轮响应</td></tr></tbody></table>
<h4 data-id="heading-24">5.2 初始化流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Editor
    participant Agent

    Editor-&gt;&gt;Agent: spawn(agent-cli)
    Note over Editor,Agent: 启动 Agent 子进程

    Editor-&gt;&gt;Agent: initialize request
    Note right of Editor: {clientInfo, version}

    Agent--&gt;&gt;Editor: initialize response
    Note left of Agent: {serverInfo, capabilities}

    Editor-&gt;&gt;Agent: authenticate (optional)
    Agent--&gt;&gt;Editor: auth response

    Editor-&gt;&gt;Agent: session/new
    Note right of Editor: {cwd, mcpServers}

    Agent--&gt;&gt;Editor: session created
    Note left of Agent: {sessionId}

    Note over Editor,Agent: ● 连接建立完成，可以开始对话
</code></pre>
<p><strong>详细说明：</strong></p>
<h5 data-id="heading-25">步骤 1：启动 Agent 进程</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// AionUi 项目中的实际代码</span>
<span class="hljs-comment">// src/agent/acp/AcpConnection.ts</span>

<span class="hljs-keyword">async</span> <span class="hljs-title function_">connect</span>(<span class="hljs-params">backend: AcpBackend, cliPath?: <span class="hljs-built_in">string</span>, workingDir?: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">const</span> command = cliPath || <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getDefaultCliPath</span>(backend);

  <span class="hljs-comment">// 使用 spawn 启动 Agent 子进程</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">agentProcess</span> = <span class="hljs-title function_">spawn</span>(command, [], {
    <span class="hljs-attr">cwd</span>: workingDir,
    <span class="hljs-attr">env</span>: process.<span class="hljs-property">env</span>,
  });

  <span class="hljs-comment">// 监听 stdout（Agent 的输出）</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">agentProcess</span>.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'data'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleStdout</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>));

  <span class="hljs-comment">// 监听 stderr（Agent 的日志）</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">agentProcess</span>.<span class="hljs-property">stderr</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'data'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleStderr</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>));

  <span class="hljs-comment">// 初始化协议</span>
  <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initialize</span>();
}
</code></pre>
<h5 data-id="heading-26">步骤 2：发送初始化请求</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">initialize</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">AcpResponse</span>&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendRequest</span>(<span class="hljs-string">'initialize'</span>, {
    <span class="hljs-attr">protocolVersion</span>: <span class="hljs-string">'0.1.0'</span>,
    <span class="hljs-attr">clientInfo</span>: {
      <span class="hljs-attr">name</span>: <span class="hljs-string">'AionUi'</span>,
      <span class="hljs-attr">version</span>: <span class="hljs-string">'1.0.0'</span>,
    },
  });
}
</code></pre>
<h5 data-id="heading-27">步骤 3：接收能力信息</h5>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.1.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"serverInfo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Claude Code"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.128"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"capabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"resources"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"streaming"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-28">5.3 会话更新类型</h4>
<p>ACP 定义了丰富的会话更新类型，让编辑器能实时显示 Agent 的思考和操作过程。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// AionUi 项目中的类型定义</span>
<span class="hljs-comment">// src/types/acpTypes.ts</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">AcpSessionUpdate</span> =
  | <span class="hljs-title class_">AgentMessageChunkUpdate</span> <span class="hljs-comment">// Agent 消息块</span>
  | <span class="hljs-title class_">AgentThoughtChunkUpdate</span> <span class="hljs-comment">// Agent 思考过程</span>
  | <span class="hljs-title class_">ToolCallUpdate</span> <span class="hljs-comment">// 工具调用</span>
  | <span class="hljs-title class_">ToolCallUpdateStatus</span> <span class="hljs-comment">// 工具状态更新</span>
  | <span class="hljs-title class_">PlanUpdate</span> <span class="hljs-comment">// 任务计划</span>
  | <span class="hljs-title class_">AvailableCommandsUpdate</span> <span class="hljs-comment">// 可用命令列表</span>
  | <span class="hljs-title class_">UserMessageChunkUpdate</span>; <span class="hljs-comment">// 用户消息块</span>
</code></pre>
<h5 data-id="heading-29">5.3.1. Agent 消息块（AgentMessageChunkUpdate）</h5>
<p>Agent 向用户发送的普通消息。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"session/update"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"sessionId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sess-123"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"update"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"sessionUpdate"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"agent_message_chunk"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"我已经分析了你的代码，发现了以下问题..."</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h5 data-id="heading-30">5.3.2. Agent 思考过程（AgentThoughtChunkUpdate）</h5>
<p>Agent 的内部思考过程，类似 "思维链"。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"session/update"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"sessionId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sess-123"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"update"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"sessionUpdate"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"agent_thought_chunk"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"首先，我需要检查 package.json 中的依赖版本..."</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h5 data-id="heading-31">5.3.3. 工具调用（ToolCallUpdate）</h5>
<p>最重要的更新类型，表示 Agent 要执行某个操作。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ToolCallUpdate</span> {
  <span class="hljs-attr">sessionUpdate</span>: <span class="hljs-string">'tool_call'</span>;
  <span class="hljs-attr">toolCallId</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 工具调用唯一 ID</span>
  <span class="hljs-attr">status</span>: <span class="hljs-string">'pending'</span> | <span class="hljs-string">'in_progress'</span> | <span class="hljs-string">'completed'</span> | <span class="hljs-string">'failed'</span>;
  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 操作描述</span>
  <span class="hljs-attr">kind</span>: <span class="hljs-string">'read'</span> | <span class="hljs-string">'edit'</span> | <span class="hljs-string">'execute'</span>; <span class="hljs-comment">// 操作类型</span>
  rawInput?: <span class="hljs-built_in">any</span>; <span class="hljs-comment">// 原始输入参数</span>
  content?: <span class="hljs-title class_">Array</span>&lt;{
    <span class="hljs-attr">type</span>: <span class="hljs-string">'content'</span> | <span class="hljs-string">'diff'</span>;
    <span class="hljs-comment">// ... 内容详情</span>
  }&gt;;
  locations?: <span class="hljs-title class_">Array</span>&lt;{
    <span class="hljs-attr">path</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 受影响的文件路径</span>
  }&gt;;
}
</code></pre>
<p><strong>示例：读取文件</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"session/update"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"sessionId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sess-123"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"update"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"sessionUpdate"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tool_call"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"toolCallId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tool-001"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"status"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pending"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"读取 src/index.ts"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"kind"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"read"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"locations"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span> <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/workspace/src/index.ts"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>示例：编辑文件</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"session/update"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"sessionId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sess-123"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"update"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"sessionUpdate"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tool_call"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"toolCallId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tool-002"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"status"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"in_progress"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"修复 TypeScript 类型错误"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"kind"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"edit"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"diff"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"diff"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"--- a/src/index.ts\n+++ b/src/index.ts\n@@ -10,7 +10,7 @@\n-function add(a, b) {\n+function add(a: number, b: number): number {\n   return a + b;\n }"</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"locations"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span> <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/workspace/src/index.ts"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h5 data-id="heading-32">5.3.4. 计划更新（PlanUpdate）</h5>
<p>Agent 的任务执行计划。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"session/update"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"sessionId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sess-123"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"update"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"sessionUpdate"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"plan"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"entries"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"分析现有代码结构"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"status"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"completed"</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"识别类型错误位置"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"status"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"in_progress"</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"修复类型定义"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"status"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pending"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"priority"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"high"</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"运行 TypeScript 编译检查"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"status"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pending"</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-33">5.4 权限请求机制</h4>
<p>ACP 的一个重要安全特性是<strong>权限请求机制</strong>。Agent 在执行敏感操作前必须获得用户许可。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Agent
    participant Editor
    participant User

    Agent-&gt;&gt;Editor: session/request_permission
    Note right of Agent: {toolCall, options}

    Editor-&gt;&gt;User: 显示对话框
    Note right of Editor: 用户选择：&lt;br/&gt;• 仅此一次允许&lt;br/&gt;• 始终允许&lt;br/&gt;• 拒绝

    User--&gt;&gt;Editor: 选择权限选项
    Editor--&gt;&gt;Agent: permission response
    Note left of Editor: {optionId: "allow_once"}
</code></pre>
<p><strong>权限请求消息格式：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">AcpPermissionRequest</span> {
  <span class="hljs-attr">sessionId</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">options</span>: <span class="hljs-title class_">Array</span>&lt;{
    <span class="hljs-attr">optionId</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">kind</span>: <span class="hljs-string">'allow_once'</span> | <span class="hljs-string">'allow_always'</span> | <span class="hljs-string">'reject_once'</span> | <span class="hljs-string">'reject_always'</span>;
  }&gt;;
  <span class="hljs-attr">toolCall</span>: {
    <span class="hljs-attr">toolCallId</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">kind</span>: <span class="hljs-string">'read'</span> | <span class="hljs-string">'edit'</span> | <span class="hljs-string">'execute'</span>;
    content?: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">any</span>&gt;;
    locations?: <span class="hljs-title class_">Array</span>&lt;{ <span class="hljs-attr">path</span>: <span class="hljs-built_in">string</span> }&gt;;
  };
}
</code></pre>
<p><strong>示例：请求写入文件权限</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"session/request_permission"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"sessionId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sess-123"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"options"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"optionId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"allow_once"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"仅此一次允许"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"kind"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"allow_once"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"optionId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"allow_always"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"始终允许对此文件的写入"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"kind"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"allow_always"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"optionId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"reject"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"拒绝"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"kind"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"reject_once"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"toolCall"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"toolCallId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tool-003"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"写入文件 src/config.ts"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"kind"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"edit"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"locations"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span> <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/workspace/src/config.ts"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"diff"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"diff"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"... (修改内容) ..."</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>AionUi 中的权限 UI 实现：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/renderer/messages/acp/MessageAcpPermission.tsx</span>

<span class="hljs-keyword">const</span> <span class="hljs-title class_">MessageAcpPermission</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">Props</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{ message }</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleConfirm</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">optionId: <span class="hljs-built_in">string</span></span>) =&gt; {
    <span class="hljs-comment">// 调用 IPC Bridge 确认权限</span>
    <span class="hljs-keyword">await</span> ipcBridge.<span class="hljs-property">acpConversation</span>.<span class="hljs-property">confirmMessage</span>.<span class="hljs-title function_">invoke</span>({
      <span class="hljs-attr">confirmKey</span>: message.<span class="hljs-property">confirmKey</span>,
      <span class="hljs-attr">msg_id</span>: message.<span class="hljs-property">msg_id</span>,
      <span class="hljs-attr">conversation_id</span>: message.<span class="hljs-property">conversation_id</span>,
      <span class="hljs-attr">callId</span>: message.<span class="hljs-property">toolCall</span>.<span class="hljs-property">toolCallId</span>,
    });
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"permission-dialog"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>{message.toolCall.title}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"options"</span>&gt;</span>
        {message.options.map(option =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{option.optionId}</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> handleConfirm(option.optionId)}&gt;
            {option.name}
          <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        ))}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<hr/>
<h3 data-id="heading-34">六、ACP 实战：从代码看实现</h3>
<p>让我们通过 AionUi 项目的实际代码，深入理解 ACP 的实现细节。</p>
<h4 data-id="heading-35">6.1 AcpConnection 类：协议通信层</h4>
<p>这是 ACP 客户端的核心实现，负责与 Agent 进程的通信。</p>
<p><strong>完整实现流程：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/agent/acp/AcpConnection.ts (605 行)</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AcpConnection</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">agentProcess</span>: <span class="hljs-title class_">ChildProcess</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">pendingRequests</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">number</span>, <span class="hljs-title class_">PendingRequest</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  <span class="hljs-keyword">private</span> requestIdCounter = <span class="hljs-number">0</span>;

  <span class="hljs-comment">// 事件回调</span>
  <span class="hljs-keyword">public</span> onSessionUpdate?: <span class="hljs-function">(<span class="hljs-params">data: AcpSessionUpdate</span>) =&gt;</span> <span class="hljs-built_in">void</span>;
  <span class="hljs-keyword">public</span> onPermissionRequest?: <span class="hljs-function">(<span class="hljs-params">data: AcpPermissionRequest</span>) =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;{ <span class="hljs-attr">optionId</span>: <span class="hljs-built_in">string</span> }&gt;;
  <span class="hljs-keyword">public</span> onEndTurn?: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;
  <span class="hljs-keyword">public</span> onFileOperation?: <span class="hljs-function">(<span class="hljs-params">operation: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;

  <span class="hljs-comment">/**
   * 连接到 Agent
   */</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">connect</span>(<span class="hljs-params">backend: AcpBackend, cliPath?: <span class="hljs-built_in">string</span>, workingDir?: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-keyword">const</span> command = cliPath || <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getDefaultCliPath</span>(backend);

    <span class="hljs-comment">// 启动 Agent 子进程</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">agentProcess</span> = <span class="hljs-title function_">spawn</span>(command, [], {
      <span class="hljs-attr">cwd</span>: workingDir,
      <span class="hljs-attr">env</span>: process.<span class="hljs-property">env</span>,
      <span class="hljs-attr">stdio</span>: [<span class="hljs-string">'pipe'</span>, <span class="hljs-string">'pipe'</span>, <span class="hljs-string">'pipe'</span>], <span class="hljs-comment">// stdin, stdout, stderr</span>
    });

    <span class="hljs-comment">// 监听输出</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">agentProcess</span>.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'data'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleStdout</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>));
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">agentProcess</span>.<span class="hljs-property">stderr</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'data'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleStderr</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>));

    <span class="hljs-comment">// 初始化协议</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initialize</span>();
  }

  <span class="hljs-comment">/**
   * 发送 JSON-RPC 请求
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">sendRequest</span>(<span class="hljs-attr">method</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">params</span>: <span class="hljs-built_in">any</span>, timeout = <span class="hljs-number">60000</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">AcpResponse</span>&gt; {
    <span class="hljs-keyword">const</span> id = ++<span class="hljs-variable language_">this</span>.<span class="hljs-property">requestIdCounter</span>;

    <span class="hljs-keyword">const</span> <span class="hljs-attr">request</span>: <span class="hljs-title class_">AcpRequest</span> = {
      <span class="hljs-attr">jsonrpc</span>: <span class="hljs-title class_">JSON</span>RPC_VERSION,
      id,
      method,
      params,
    };

    <span class="hljs-comment">// 创建 Promise，等待响应</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingRequests</span>.<span class="hljs-title function_">delete</span>(id);
        <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Request <span class="hljs-subst">${method}</span> timeout after <span class="hljs-subst">${timeout}</span>ms`</span>));
      }, timeout);

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingRequests</span>.<span class="hljs-title function_">set</span>(id, { resolve, reject, timer });

      <span class="hljs-comment">// 写入 Agent 的 stdin</span>
      <span class="hljs-keyword">const</span> message = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(request) + <span class="hljs-string">'\n'</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">agentProcess</span>.<span class="hljs-property">stdin</span>.<span class="hljs-title function_">write</span>(message);
    });
  }

  <span class="hljs-comment">/**
   * 处理 Agent 的输出
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">handleStdout</span>(<span class="hljs-params">data: Buffer</span>) {
    <span class="hljs-keyword">const</span> lines = data
      .<span class="hljs-title function_">toString</span>()
      .<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n'</span>)
      .<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">line</span>) =&gt;</span> line.<span class="hljs-title function_">trim</span>());

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> line <span class="hljs-keyword">of</span> lines) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> message = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(line);

        <span class="hljs-keyword">if</span> (<span class="hljs-string">'id'</span> <span class="hljs-keyword">in</span> message &amp;&amp; <span class="hljs-string">'result'</span> <span class="hljs-keyword">in</span> message) {
          <span class="hljs-comment">// Response: 匹配请求并 resolve</span>
          <span class="hljs-keyword">const</span> pending = <span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingRequests</span>.<span class="hljs-title function_">get</span>(message.<span class="hljs-property">id</span>);
          <span class="hljs-keyword">if</span> (pending) {
            <span class="hljs-built_in">clearTimeout</span>(pending.<span class="hljs-property">timer</span>);
            pending.<span class="hljs-title function_">resolve</span>(message);
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingRequests</span>.<span class="hljs-title function_">delete</span>(message.<span class="hljs-property">id</span>);
          }
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">'method'</span> <span class="hljs-keyword">in</span> message) {
          <span class="hljs-comment">// Notification: 触发回调</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleNotification</span>(message);
        }
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to parse message:'</span>, line, error);
      }
    }
  }

  <span class="hljs-comment">/**
   * 处理通知消息
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">handleNotification</span>(<span class="hljs-params">notification: AcpNotification</span>) {
    <span class="hljs-keyword">const</span> { method, params } = notification;

    <span class="hljs-keyword">switch</span> (method) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'session/update'</span>:
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">onSessionUpdate</span>) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onSessionUpdate</span>(params.<span class="hljs-property">update</span>);
        }
        <span class="hljs-keyword">break</span>;

      <span class="hljs-keyword">case</span> <span class="hljs-string">'session/request_permission'</span>:
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">onPermissionRequest</span>) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handlePermissionRequest</span>(params);
        }
        <span class="hljs-keyword">break</span>;

      <span class="hljs-keyword">case</span> <span class="hljs-string">'end_turn'</span>:
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">onEndTurn</span>) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onEndTurn</span>();
        }
        <span class="hljs-keyword">break</span>;

      <span class="hljs-keyword">case</span> <span class="hljs-string">'fs/read_text_file'</span>:
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleReadOperation</span>(params);
        <span class="hljs-keyword">break</span>;

      <span class="hljs-keyword">case</span> <span class="hljs-string">'fs/write_text_file'</span>:
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleWriteOperation</span>(params);
        <span class="hljs-keyword">break</span>;
    }
  }

  <span class="hljs-comment">/**
   * 创建新会话
   */</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">newSession</span>(<span class="hljs-attr">cwd</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">AcpResponse</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendRequest</span>(
      <span class="hljs-string">'session/new'</span>,
      {
        cwd,
        <span class="hljs-attr">mcpServers</span>: [], <span class="hljs-comment">// 可配置 MCP 服务器</span>
      },
      <span class="hljs-number">120000</span>
    ); <span class="hljs-comment">// 120 秒超时</span>
  }

  <span class="hljs-comment">/**
   * 发送用户消息
   */</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">sendPrompt</span>(<span class="hljs-attr">prompt</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">AcpResponse</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendRequest</span>(
      <span class="hljs-string">'session/prompt'</span>,
      {
        prompt,
      },
      <span class="hljs-number">120000</span>
    );
  }

  <span class="hljs-comment">/**
   * 断开连接
   */</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">disconnect</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">agentProcess</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">agentProcess</span>.<span class="hljs-title function_">kill</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">agentProcess</span> = <span class="hljs-literal">null</span>;
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingRequests</span>.<span class="hljs-title function_">clear</span>();
  }
}
</code></pre>
<h4 data-id="heading-36">6.2 AcpAgent 类：业务逻辑层</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/agent/acp/index.ts (607 行)</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AcpAgent</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">connection</span>: <span class="hljs-title class_">AcpConnection</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">sessionId</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">onStreamEvent</span>: <span class="hljs-function">(<span class="hljs-params">event: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options: { id: <span class="hljs-built_in">string</span>; backend: AcpBackend; cliPath?: <span class="hljs-built_in">string</span>; workingDir?: <span class="hljs-built_in">string</span>; onStreamEvent: (event: <span class="hljs-built_in">any</span>) =&gt; <span class="hljs-built_in">void</span> }</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">onStreamEvent</span> = options.<span class="hljs-property">onStreamEvent</span>;

    <span class="hljs-comment">// 创建连接</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">connection</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AcpConnection</span>();

    <span class="hljs-comment">// 注册回调</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">connection</span>.<span class="hljs-property">onSessionUpdate</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleSessionUpdate</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">connection</span>.<span class="hljs-property">onPermissionRequest</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">handlePermissionRequest</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">connection</span>.<span class="hljs-property">onEndTurn</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleEndTurn</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">connection</span>.<span class="hljs-property">onFileOperation</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleFileOperation</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>);
  }

  <span class="hljs-comment">/**
   * 启动 Agent
   */</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">start</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">connection</span>.<span class="hljs-title function_">connect</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">backend</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">cliPath</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">workingDir</span>);

    <span class="hljs-comment">// 创建会话</span>
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">connection</span>.<span class="hljs-title function_">newSession</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">workingDir</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sessionId</span> = response.<span class="hljs-property">result</span>.<span class="hljs-property">sessionId</span>;
  }

  <span class="hljs-comment">/**
   * 发送消息
   */</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">sendMessage</span>(<span class="hljs-attr">data</span>: { <span class="hljs-attr">content</span>: <span class="hljs-built_in">string</span>; files?: <span class="hljs-built_in">string</span>[]; msg_id?: <span class="hljs-built_in">string</span> }): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">AcpResult</span>&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">connection</span>.<span class="hljs-title function_">sendPrompt</span>(data.<span class="hljs-property">content</span>);
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span> };
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">error</span>: error.<span class="hljs-property">message</span> };
    }
  }

  <span class="hljs-comment">/**
   * 处理会话更新
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">handleSessionUpdate</span>(<span class="hljs-params">update: AcpSessionUpdate</span>) {
    <span class="hljs-comment">// 使用适配器转换为统一格式</span>
    <span class="hljs-keyword">const</span> event = <span class="hljs-title class_">AcpAdapter</span>.<span class="hljs-title function_">convertUpdate</span>(update);

    <span class="hljs-comment">// 触发流事件</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onStreamEvent</span>(event);
  }

  <span class="hljs-comment">/**
   * 处理权限请求
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">handlePermissionRequest</span>(<span class="hljs-attr">params</span>: <span class="hljs-title class_">AcpPermissionRequest</span>): <span class="hljs-title class_">Promise</span>&lt;{ <span class="hljs-attr">optionId</span>: <span class="hljs-built_in">string</span> }&gt; {
    <span class="hljs-comment">// 创建权限消息，显示给用户</span>
    <span class="hljs-keyword">const</span> permissionMessage = {
      <span class="hljs-attr">role</span>: <span class="hljs-string">'permission_request'</span>,
      <span class="hljs-attr">options</span>: params.<span class="hljs-property">options</span>,
      <span class="hljs-attr">toolCall</span>: params.<span class="hljs-property">toolCall</span>,
      <span class="hljs-attr">confirmKey</span>: <span class="hljs-title function_">generateConfirmKey</span>(),
    };

    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onStreamEvent</span>(permissionMessage);

    <span class="hljs-comment">// 等待用户响应（通过 confirmMessage 方法）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingPermissionResolve</span> = resolve;
    });
  }

  <span class="hljs-comment">/**
   * 确认权限（用户选择后调用）
   */</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">confirmMessage</span>(<span class="hljs-params">data: { confirmKey: <span class="hljs-built_in">string</span>; msg_id: <span class="hljs-built_in">string</span>; callId: <span class="hljs-built_in">string</span> }</span>) {
    <span class="hljs-comment">// 将用户选择的 optionId 返回给 Agent</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingPermissionResolve</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">pendingPermissionResolve</span>({ <span class="hljs-attr">optionId</span>: data.<span class="hljs-property">confirmKey</span> });
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingPermissionResolve</span> = <span class="hljs-literal">null</span>;
    }
  }
}
</code></pre>
<h4 data-id="heading-37">6.3 前端 UI 集成</h4>
<p><strong>聊天界面：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/renderer/pages/conversation/acp/AcpChat.tsx</span>

<span class="hljs-keyword">const</span> <span class="hljs-title class_">AcpChat</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;{
  <span class="hljs-attr">conversation_id</span>: <span class="hljs-built_in">string</span>;
  workspace?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">backend</span>: <span class="hljs-title class_">AcpBackend</span>;
}&gt; = <span class="hljs-function">(<span class="hljs-params">{ conversation_id, workspace, backend }</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ConversationProvider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span>
      <span class="hljs-attr">conversationId:</span> <span class="hljs-attr">conversation_id</span>,
      <span class="hljs-attr">workspace</span>,
      <span class="hljs-attr">type:</span> '<span class="hljs-attr">acp</span>',
    }}&gt;</span>
      {/* 消息列表 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">MessageList</span> /&gt;</span>

      {/* 输入框 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">AcpSendBox</span> <span class="hljs-attr">conversation_id</span>=<span class="hljs-string">{conversation_id}</span> <span class="hljs-attr">backend</span>=<span class="hljs-string">{backend}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ConversationProvider</span>&gt;</span></span>
  );
};
</code></pre>
<p><strong>工具调用 UI：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/renderer/messages/acp/MessageAcpToolCall.tsx</span>

<span class="hljs-keyword">const</span> <span class="hljs-title class_">MessageAcpToolCall</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;{ <span class="hljs-attr">toolCall</span>: <span class="hljs-title class_">ToolCallUpdate</span> }&gt; = <span class="hljs-function">(<span class="hljs-params">{ toolCall }</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"tool-call"</span>&gt;</span>
      {/* 工具图标 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"tool-icon"</span>&gt;</span>
        {toolCall.kind === 'read' &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">FileIcon</span> /&gt;</span>}
        {toolCall.kind === 'edit' &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">EditIcon</span> /&gt;</span>}
        {toolCall.kind === 'execute' &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">TerminalIcon</span> /&gt;</span>}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      {/* 工具标题 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"tool-title"</span>&gt;</span>{toolCall.title}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      {/* 状态指示器 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">tool-status</span> <span class="hljs-attr">tool-status-</span>${<span class="hljs-attr">toolCall.status</span>}`}&gt;</span>
        {toolCall.status === 'pending' &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">ClockIcon</span> /&gt;</span>}
        {toolCall.status === 'in_progress' &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">SpinnerIcon</span> /&gt;</span>}
        {toolCall.status === 'completed' &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">CheckIcon</span> /&gt;</span>}
        {toolCall.status === 'failed' &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">XIcon</span> /&gt;</span>}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      {/* 文件路径 */}
      {toolCall.locations &amp;&amp; (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"tool-locations"</span>&gt;</span>
          {toolCall.locations.map(loc =&gt; (
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{loc.path}</span>&gt;</span>{loc.path}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      )}

      {/* Diff 内容 */}
      {toolCall.content &amp;&amp; toolCall.content[0]?.type === 'diff' &amp;&amp; (
        <span class="hljs-tag">&lt;<span class="hljs-name">DiffViewer</span> <span class="hljs-attr">diff</span>=<span class="hljs-string">{toolCall.content[0].diff}</span> /&gt;</span>
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h4 data-id="heading-38">6.4 IPC Bridge 集成</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/process/bridge/acpConversationBridge.ts</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">initAcpConversationBridge</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 确认权限</span>
  ipcBridge.<span class="hljs-property">acpConversation</span>.<span class="hljs-property">confirmMessage</span>.<span class="hljs-title function_">provider</span>(<span class="hljs-keyword">async</span> ({ confirmKey, msg_id, conversation_id, callId }) =&gt; {
    <span class="hljs-keyword">const</span> task = <span class="hljs-title class_">WorkerManage</span>.<span class="hljs-title function_">getTaskById</span>(conversation_id) <span class="hljs-keyword">as</span> <span class="hljs-title class_">AcpAgentManager</span>;
    <span class="hljs-keyword">await</span> task.<span class="hljs-title function_">confirmMessage</span>({ confirmKey, msg_id, callId });
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span> };
  });

  <span class="hljs-comment">// 检测可用的 Agent</span>
  ipcBridge.<span class="hljs-property">acpConversation</span>.<span class="hljs-property">getAvailableAgents</span>.<span class="hljs-title function_">provider</span>(<span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">const</span> agents = acpDetector.<span class="hljs-title function_">getDetectedAgents</span>();
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">data</span>: agents };
  });

  <span class="hljs-comment">// 检测 CLI 路径</span>
  ipcBridge.<span class="hljs-property">acpConversation</span>.<span class="hljs-property">detectCliPath</span>.<span class="hljs-title function_">provider</span>(<span class="hljs-keyword">async</span> ({ backend }) =&gt; {
    <span class="hljs-keyword">const</span> agents = acpDetector.<span class="hljs-title function_">getDetectedAgents</span>();
    <span class="hljs-keyword">const</span> agent = agents.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">a</span>) =&gt;</span> a.<span class="hljs-property">backend</span> === backend);
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">success</span>: !!agent?.<span class="hljs-property">cliPath</span>,
      <span class="hljs-attr">data</span>: { <span class="hljs-attr">path</span>: agent?.<span class="hljs-property">cliPath</span> },
    };
  });
}
</code></pre>
<hr/>
<h3 data-id="heading-39">七、ACP vs MCP：两个协议的对比与互补</h3>
<h4 data-id="heading-40">7.1 核心区别</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph ACP["ACP (Agent Client Protocol)"]
        A1["作用：编辑器 ←→ AI Agent"]
        A2["场景：代码编辑、重构、调试"]
        A3["通信：双向（请求/响应 + 通知）"]
        A4["传输：stdio (本地进程通信)"]
        A5["创建者：Zed Industries"]
    end

    subgraph MCP["MCP (Model Context Protocol)"]
        M1["作用：AI 模型 ←→ 工具/资源"]
        M2["场景：数据库查询、API调用、文件系统操作"]
        M3["通信：主要是单向（模型调用工具）"]
        M4["传输：stdio / HTTP with SSE"]
        M5["创建者：Anthropic"]
    end

    style ACP fill:#e3f2fd
    style MCP fill:#fff3e0
</code></pre>
<h4 data-id="heading-41">7.2 详细对比表</h4>






































































<table><thead><tr><th>维度</th><th>ACP</th><th>MCP</th></tr></thead><tbody><tr><td><strong>完整名称</strong></td><td>Agent Client Protocol</td><td>Model Context Protocol</td></tr><tr><td><strong>主要用途</strong></td><td>编辑器与 AI 编码助手的通信</td><td>AI 模型与外部工具/资源的通信</td></tr><tr><td><strong>通信方向</strong></td><td>双向（编辑器 ↔ Agent）</td><td>主要单向（Model → Tools）</td></tr><tr><td><strong>协议基础</strong></td><td>JSON-RPC 2.0 over stdio</td><td>JSON-RPC 2.0 over stdio/HTTP</td></tr><tr><td><strong>传输方式</strong></td><td>stdio（标准输入输出）</td><td>stdio / HTTP with SSE</td></tr><tr><td><strong>生命周期</strong></td><td>编辑器启动 Agent 子进程</td><td>Host 启动 MCP Server</td></tr><tr><td><strong>状态管理</strong></td><td>有状态（会话持久化）</td><td>有状态（连接生命周期）</td></tr><tr><td><strong>权限控制</strong></td><td>内置权限请求机制</td><td>依赖 Host 实现</td></tr><tr><td><strong>典型场景</strong></td><td>代码生成、重构、调试</td><td>数据库查询、API 调用</td></tr><tr><td><strong>作者</strong></td><td>Zed Industries</td><td>Anthropic</td></tr><tr><td><strong>发布时间</strong></td><td>2025 年</td><td>2024 年</td></tr><tr><td><strong>开源协议</strong></td><td>Apache 2.0</td><td>MIT</td></tr></tbody></table>
<h4 data-id="heading-42">7.3 协作关系</h4>
<p>ACP 和 MCP 不是竞争关系，而是<strong>互补关系</strong>。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    Editor["Editor&lt;br/&gt;(Zed)"]
    Agent["AI Agent&lt;br/&gt;(Claude Code)"]

    subgraph MCPServers["MCP Servers"]
        DB[Database Server]
        FS[File System]
        Git[Git Server]
        Web[Web Fetch]
        Mem[Memory/Knowledge]
    end

    Editor &lt;--&gt;|ACP Protocol| Agent
    Agent --&gt;|MCP Protocol| MCPServers

    style Editor fill:#e3f2fd
    style Agent fill:#fff3e0
    style MCPServers fill:#e8f5e9
</code></pre>
<p><strong>实际工作流程：</strong></p>
<ol>
<li><strong>用户</strong> 在 Zed 编辑器中输入："帮我重构这个函数，并将结果保存到数据库"</li>
<li><strong>Zed</strong> 通过 <strong>ACP</strong> 将消息发送给 <strong>Claude Code Agent</strong></li>
<li><strong>Claude</strong> 分析代码，生成重构后的代码</li>
<li><strong>Claude</strong> 通过 <strong>MCP</strong> 调用 <strong>Database Server</strong> 将结果保存</li>
<li><strong>Claude</strong> 通过 <strong>ACP</strong> 将结果返回给 <strong>Zed</strong></li>
<li><strong>Zed</strong> 在编辑器中显示重构后的代码和执行结果</li>
</ol>
<h4 data-id="heading-43">7.4 在 AionUi 中的集成</h4>
<p>AionUi 项目同时支持 ACP 和 MCP：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/agent/acp/AcpConnection.ts</span>

<span class="hljs-keyword">async</span> <span class="hljs-title function_">newSession</span>(<span class="hljs-attr">cwd</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">AcpResponse</span>&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendRequest</span>(<span class="hljs-string">'session/new'</span>, {
    cwd,
    <span class="hljs-comment">// 可以在创建 ACP 会话时配置 MCP 服务器</span>
    <span class="hljs-attr">mcpServers</span>: [
      {
        <span class="hljs-attr">name</span>: <span class="hljs-string">'database'</span>,
        <span class="hljs-attr">command</span>: <span class="hljs-string">'node'</span>,
        <span class="hljs-attr">args</span>: [<span class="hljs-string">'./mcp-servers/database-server.js'</span>],
      },
      {
        <span class="hljs-attr">name</span>: <span class="hljs-string">'git'</span>,
        <span class="hljs-attr">command</span>: <span class="hljs-string">'node'</span>,
        <span class="hljs-attr">args</span>: [<span class="hljs-string">'./mcp-servers/git-server.js'</span>],
      },
    ],
  });
}
</code></pre>
<p>这样，Claude Code Agent 就可以同时：</p>
<ul>
<li>通过 <strong>ACP</strong> 与编辑器通信</li>
<li>通过 <strong>MCP</strong> 访问数据库、Git 等工具</li>
</ul>
<hr/>
<h3 data-id="heading-44">八、生态系统与实际应用</h3>
<h4 data-id="heading-45">8.1 支持 ACP 的编辑器</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">mindmap
  root((ACP 编辑器生态))
    已支持
      Zed
        官方支持
        原生集成
      Neovim
        社区插件
      JetBrains IDEs
        官方合作
      Marimo
        数据科学笔记本
    计划中
      VS Code
      Emacs
        社区开发中
</code></pre>
<p><strong>Zed 的 ACP 配置示例：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// ~/.config/zed/settings.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"agents"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"claude"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"claude-code"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"ANTHROPIC_API_KEY"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sk-ant-..."</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"gemini"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"gemini-cli"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"--model"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"gemini-1.5-pro"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"codex"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"codex"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"--api-key"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"sk-..."</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-46">8.2 支持 ACP 的 AI Agent</h4>









































<table><thead><tr><th>Agent</th><th>厂商</th><th>模型</th><th>特性</th></tr></thead><tbody><tr><td><strong>Claude Code</strong></td><td>Anthropic</td><td>Claude 3.5 Sonnet</td><td>长上下文、思维链、代码理解强</td></tr><tr><td><strong>Gemini CLI</strong></td><td>Google</td><td>Gemini 1.5 Pro</td><td>多模态、快速响应</td></tr><tr><td><strong>Codex CLI</strong></td><td>OpenAI</td><td>GPT-4</td><td>广泛的编程语言支持</td></tr><tr><td><strong>Qwen Code</strong></td><td>阿里云</td><td>Qwen Coder</td><td>中文编程、本地化</td></tr><tr><td><strong>goose</strong></td><td>Block</td><td>多模型支持</td><td>开源、可定制</td></tr></tbody></table>
<h4 data-id="heading-47">8.3 实际应用场景</h4>
<h5 data-id="heading-48">场景 1：代码重构</h5>
<p><strong>用户输入：</strong></p>
<blockquote>
<p>"将这个组件从 Class 组件重构为 Function 组件，使用 Hooks"</p>
</blockquote>
<p><strong>ACP 工作流程：</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-number">1.</span> [Agent Message] "我会帮你重构这个组件..."

<span class="hljs-number">2.</span> [Tool <span class="hljs-keyword">Call</span> <span class="hljs-operator">-</span> Read]
   读取 src<span class="hljs-operator">/</span>components<span class="hljs-operator">/</span>UserList.tsx

<span class="hljs-number">3.</span> [Agent Thought]
   "这是一个 Class 组件，有三个生命周期方法和一个状态..."

<span class="hljs-number">4.</span> [Tool <span class="hljs-keyword">Call</span> <span class="hljs-operator">-</span> Edit]
   生成重构后的代码（使用 useState、useEffect）

<span class="hljs-number">5.</span> [Permission Request]
   "是否允许修改 UserList.tsx?"

<span class="hljs-number">6.</span> [<span class="hljs-keyword">User</span>] 点击"允许"

<span class="hljs-number">7.</span> [Tool <span class="hljs-keyword">Call</span> <span class="hljs-operator">-</span> <span class="hljs-keyword">Execute</span>]
   运行 `npm run lint` 检查语法

<span class="hljs-number">8.</span> [Agent Message]
   "重构完成！代码已通过 lint 检查。"
</code></pre>
<h5 data-id="heading-49">场景 2：Bug 修复</h5>
<p><strong>用户输入：</strong></p>
<blockquote>
<p>"修复这个 TypeScript 类型错误"</p>
</blockquote>
<p><strong>ACP 工作流程：</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-number">1</span>. <span class="hljs-selector-attr">[Tool Call - Read]</span>
   读取当前文件

<span class="hljs-number">2</span>. <span class="hljs-selector-attr">[Agent Thought]</span>
   "类型错误是因为函数返回值类型不匹配..."

<span class="hljs-number">3</span>. <span class="hljs-selector-attr">[Plan Update]</span>
   - <span class="hljs-selector-attr">[✓]</span> 分析类型错误
   - <span class="hljs-selector-attr">[→]</span> 修改函数签名
   - <span class="hljs-selector-attr">[ ]</span> 添加类型注解
   - <span class="hljs-selector-attr">[ ]</span> 运行 tsc 检查

<span class="hljs-number">4</span>. <span class="hljs-selector-attr">[Tool Call - Edit]</span>
   修改函数类型定义

<span class="hljs-number">5</span>. <span class="hljs-selector-attr">[Tool Call - Execute]</span>
   运行 `tsc <span class="hljs-attr">--noEmit</span>`

<span class="hljs-number">6</span>. <span class="hljs-selector-attr">[Agent Message]</span>
   "类型错误已修复！TypeScript 编译通过。"
</code></pre>
<h5 data-id="heading-50">场景 3：集成 MCP 的复杂场景</h5>
<p><strong>用户输入：</strong></p>
<blockquote>
<p>"从数据库中查询用户列表，生成一个 React 表格组件"</p>
</blockquote>
<p><strong>ACP + MCP 协作流程：</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-number">1</span>. <span class="hljs-selector-attr">[ACP]</span> Agent 收到请求

<span class="hljs-number">2</span>. <span class="hljs-selector-attr">[MCP]</span> Agent 调用 Database Server
   Tool: <span class="hljs-built_in">query_users</span>()

<span class="hljs-number">3</span>. [MCP] Database Server 返回数据
   Result: [{id: <span class="hljs-number">1</span>, name: <span class="hljs-string">"Alice"</span>}, ...]

<span class="hljs-number">4</span>. <span class="hljs-selector-attr">[ACP]</span> Agent 思考如何生成组件

<span class="hljs-number">5</span>. <span class="hljs-selector-attr">[ACP]</span> Agent 创建新文件
   Tool Call: <span class="hljs-built_in">write_file</span>(<span class="hljs-string">"UserTable.tsx"</span>)

<span class="hljs-number">6</span>. [ACP] Agent 生成组件代码
   基于数据库结构生成 TypeScript 类型

<span class="hljs-number">7</span>. [ACP] Agent 运行测试
   Tool Call: <span class="hljs-built_in">execute</span>(<span class="hljs-string">"npm test UserTable"</span>)

<span class="hljs-number">8</span>. [ACP] Agent 返回结果
   <span class="hljs-string">"组件已创建，所有测试通过！"</span>
</code></pre>
<hr/>
<h3 data-id="heading-51">九、最佳实践与安全考量</h3>
<h4 data-id="heading-52">9.1 实现 ACP Agent 的最佳实践</h4>
<h5 data-id="heading-53">9.1.1. 日志处理</h5>
<p><strong>❌ 错误做法：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 不要写入 stdout！</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Agent is processing...'</span>);
</code></pre>
<p><strong>✅ 正确做法：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 使用 stderr 或文件日志</span>
<span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">'fs'</span>;

<span class="hljs-keyword">const</span> logFile = fs.<span class="hljs-title function_">createWriteStream</span>(<span class="hljs-string">'/tmp/agent.log'</span>);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">log</span>(<span class="hljs-params">message: <span class="hljs-built_in">string</span></span>) {
  logFile.<span class="hljs-title function_">write</span>(<span class="hljs-string">`[<span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString()}</span>] <span class="hljs-subst">${message}</span>\n`</span>);
}

<span class="hljs-title function_">log</span>(<span class="hljs-string">'Agent is processing...'</span>);
</code></pre>
<p><strong>原因：</strong> ACP 使用 stdout 传输 JSON-RPC 消息，任何非 JSON 输出都会破坏协议。</p>
<h5 data-id="heading-54">9.1.2. 错误处理</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">executeToolCall</span>(toolCall);
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-comment">// 返回标准错误格式</span>
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">jsonrpc</span>: <span class="hljs-string">'2.0'</span>,
    <span class="hljs-attr">id</span>: requestId,
    <span class="hljs-attr">error</span>: {
      <span class="hljs-attr">code</span>: -<span class="hljs-number">32603</span>,
      <span class="hljs-attr">message</span>: error.<span class="hljs-property">message</span>,
      <span class="hljs-attr">data</span>: {
        <span class="hljs-attr">stack</span>: error.<span class="hljs-property">stack</span>,
      },
    },
  };
}
</code></pre>
<h5 data-id="heading-55">9.1.3. 超时管理</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TOOL_CALL_TIMEOUT</span> = <span class="hljs-number">30000</span>; <span class="hljs-comment">// 30 秒</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">executeToolCallWithTimeout</span>(<span class="hljs-params">toolCall: ToolCall</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">race</span>([<span class="hljs-title function_">executeToolCall</span>(toolCall), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">_, reject</span>) =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Tool call timeout'</span>)), <span class="hljs-variable constant_">TOOL_CALL_TIMEOUT</span>))]);
}
</code></pre>
<h5 data-id="heading-56">9.1.4. 流式响应</h5>
<p>对于长时间的操作，使用流式更新：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">generateCode</span>(<span class="hljs-params">prompt: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-comment">// 发送进度更新</span>
  <span class="hljs-title function_">sendNotification</span>(<span class="hljs-string">'session/update'</span>, {
    <span class="hljs-attr">update</span>: {
      <span class="hljs-attr">sessionUpdate</span>: <span class="hljs-string">'agent_thought_chunk'</span>,
      <span class="hljs-attr">content</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'text'</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'正在分析需求...'</span> },
    },
  });

  <span class="hljs-comment">// 生成代码</span>
  <span class="hljs-keyword">const</span> code = <span class="hljs-keyword">await</span> llm.<span class="hljs-title function_">generate</span>(prompt);

  <span class="hljs-comment">// 发送代码块</span>
  <span class="hljs-title function_">sendNotification</span>(<span class="hljs-string">'session/update'</span>, {
    <span class="hljs-attr">update</span>: {
      <span class="hljs-attr">sessionUpdate</span>: <span class="hljs-string">'agent_message_chunk'</span>,
      <span class="hljs-attr">content</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'text'</span>, <span class="hljs-attr">text</span>: code },
    },
  });
}
</code></pre>
<h4 data-id="heading-57">9.2 安全考量</h4>
<h5 data-id="heading-58">9.2.1. 文件系统访问控制</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 定义允许的工作目录</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">ALLOWED_WORKSPACE</span> = process.<span class="hljs-property">env</span>.<span class="hljs-property">WORKSPACE_DIR</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">validateFilePath</span>(<span class="hljs-params">path: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">boolean</span> {
  <span class="hljs-keyword">const</span> resolvedPath = path.<span class="hljs-title function_">resolve</span>(path);

  <span class="hljs-comment">// 检查路径是否在允许的工作目录内</span>
  <span class="hljs-keyword">if</span> (!resolvedPath.<span class="hljs-title function_">startsWith</span>(<span class="hljs-variable constant_">ALLOWED_WORKSPACE</span>)) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Access denied: path outside workspace'</span>);
  }

  <span class="hljs-comment">// 检查是否访问敏感文件</span>
  <span class="hljs-keyword">const</span> sensitivePatterns = [<span class="hljs-string">'.env'</span>, <span class="hljs-string">'.git/config'</span>, <span class="hljs-string">'id_rsa'</span>];
  <span class="hljs-keyword">if</span> (sensitivePatterns.<span class="hljs-title function_">some</span>(<span class="hljs-function">(<span class="hljs-params">pattern</span>) =&gt;</span> resolvedPath.<span class="hljs-title function_">includes</span>(pattern))) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Access denied: sensitive file'</span>);
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<h5 data-id="heading-59">9.2.2. 命令执行安全</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 白名单机制</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">ALLOWED_COMMANDS</span> = [<span class="hljs-string">'npm test'</span>, <span class="hljs-string">'npm run lint'</span>, <span class="hljs-string">'tsc --noEmit'</span>, <span class="hljs-string">'git status'</span>];

<span class="hljs-keyword">function</span> <span class="hljs-title function_">validateCommand</span>(<span class="hljs-params">command: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">boolean</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">ALLOWED_COMMANDS</span>.<span class="hljs-title function_">some</span>(<span class="hljs-function">(<span class="hljs-params">allowed</span>) =&gt;</span> command.<span class="hljs-title function_">startsWith</span>(allowed));
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">executeCommand</span>(<span class="hljs-params">command: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">validateCommand</span>(command)) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Command not allowed'</span>);
  }

  <span class="hljs-comment">// 执行命令</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">execAsync</span>(command, {
    <span class="hljs-attr">timeout</span>: <span class="hljs-number">30000</span>,
    <span class="hljs-attr">cwd</span>: <span class="hljs-variable constant_">WORKSPACE_DIR</span>,
  });
}
</code></pre>
<h5 data-id="heading-60">9.2.3. 权限请求实现</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">requestPermission</span>(<span class="hljs-params">toolCall: ToolCall</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; {
  <span class="hljs-comment">// 发送权限请求</span>
  <span class="hljs-title function_">sendNotification</span>(<span class="hljs-string">'session/request_permission'</span>, {
    <span class="hljs-attr">sessionId</span>: currentSessionId,
    <span class="hljs-attr">options</span>: [
      { <span class="hljs-attr">optionId</span>: <span class="hljs-string">'allow_once'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'仅此一次允许'</span>, <span class="hljs-attr">kind</span>: <span class="hljs-string">'allow_once'</span> },
      { <span class="hljs-attr">optionId</span>: <span class="hljs-string">'allow_always'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'始终允许'</span>, <span class="hljs-attr">kind</span>: <span class="hljs-string">'allow_always'</span> },
      { <span class="hljs-attr">optionId</span>: <span class="hljs-string">'reject'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'拒绝'</span>, <span class="hljs-attr">kind</span>: <span class="hljs-string">'reject_once'</span> },
    ],
    toolCall,
  });

  <span class="hljs-comment">// 等待用户响应</span>
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">waitForPermissionResponse</span>();

  <span class="hljs-comment">// 缓存权限决策</span>
  <span class="hljs-keyword">if</span> (response.<span class="hljs-property">kind</span> === <span class="hljs-string">'allow_always'</span>) {
    permissionCache.<span class="hljs-title function_">set</span>(toolCall.<span class="hljs-property">kind</span>, <span class="hljs-literal">true</span>);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (response.<span class="hljs-property">kind</span> === <span class="hljs-string">'reject_always'</span>) {
    permissionCache.<span class="hljs-title function_">set</span>(toolCall.<span class="hljs-property">kind</span>, <span class="hljs-literal">false</span>);
  }

  <span class="hljs-keyword">return</span> response.<span class="hljs-property">kind</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'allow'</span>);
}
</code></pre>
<h5 data-id="heading-61">9.2.4. 敏感信息处理</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 过滤敏感信息</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">sanitizeContent</span>(<span class="hljs-params">content: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-comment">// 移除 API 密钥</span>
  content = content.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/sk-[a-zA-Z0-9]{48}/g</span>, <span class="hljs-string">'***API_KEY***'</span>);

  <span class="hljs-comment">// 移除密码</span>
  content = content.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/password\s*=\s*['"][^'"]+['"]/gi</span>, <span class="hljs-string">'password=***'</span>);

  <span class="hljs-comment">// 移除 Token</span>
  content = content.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/Bearer\s+[a-zA-Z0-9._-]+/g</span>, <span class="hljs-string">'Bearer ***'</span>);

  <span class="hljs-keyword">return</span> content;
}
</code></pre>
<h4 data-id="heading-62">9.3 性能优化</h4>
<h5 data-id="heading-63">9.3.1. 批量操作</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 批量读取文件</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">readMultipleFiles</span>(<span class="hljs-params">paths: <span class="hljs-built_in">string</span>[]</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;&gt; {
  <span class="hljs-keyword">const</span> results = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();

  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(
    paths.<span class="hljs-title function_">map</span>(<span class="hljs-keyword">async</span> (path) =&gt; {
      <span class="hljs-keyword">const</span> content = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">readFile</span>(path, <span class="hljs-string">'utf-8'</span>);
      results.<span class="hljs-title function_">set</span>(path, content);
    })
  );

  <span class="hljs-keyword">return</span> results;
}
</code></pre>
<h5 data-id="heading-64">9.3.2. 增量更新</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 只发送变化的内容</span>
<span class="hljs-keyword">let</span> lastContent = <span class="hljs-string">''</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">sendDiffUpdate</span>(<span class="hljs-params">newContent: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">const</span> diff = <span class="hljs-title function_">computeDiff</span>(lastContent, newContent);

  <span class="hljs-keyword">if</span> (diff) {
    <span class="hljs-title function_">sendNotification</span>(<span class="hljs-string">'session/update'</span>, {
      <span class="hljs-attr">update</span>: {
        <span class="hljs-attr">sessionUpdate</span>: <span class="hljs-string">'agent_message_chunk'</span>,
        <span class="hljs-attr">content</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'diff'</span>, diff },
      },
    });
  }

  lastContent = newContent;
}
</code></pre>
<h5 data-id="heading-65">9.3.3. 缓存机制</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 缓存文件内容</span>
<span class="hljs-keyword">const</span> fileCache = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">LRU</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;({
  <span class="hljs-attr">max</span>: <span class="hljs-number">100</span>,
  <span class="hljs-attr">maxAge</span>: <span class="hljs-number">5</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>, <span class="hljs-comment">// 5 分钟</span>
});

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">readFileWithCache</span>(<span class="hljs-params">path: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {
  <span class="hljs-keyword">const</span> cached = fileCache.<span class="hljs-title function_">get</span>(path);
  <span class="hljs-keyword">if</span> (cached) <span class="hljs-keyword">return</span> cached;

  <span class="hljs-keyword">const</span> content = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">readFile</span>(path, <span class="hljs-string">'utf-8'</span>);
  fileCache.<span class="hljs-title function_">set</span>(path, content);

  <span class="hljs-keyword">return</span> content;
}
</code></pre>
<hr/>
<h3 data-id="heading-66">十、未来展望</h3>
<h4 data-id="heading-67">10.1 协议演进方向</h4>
<h5 data-id="heading-68">10.1.1. 更丰富的内容类型</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 未来可能支持的内容类型</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">FutureContent</span> {
  <span class="hljs-attr">type</span>: <span class="hljs-string">'text'</span> | <span class="hljs-string">'image'</span> | <span class="hljs-string">'video'</span> | <span class="hljs-string">'audio'</span> | <span class="hljs-string">'diagram'</span> | <span class="hljs-string">'3d-model'</span>;
  <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// 示例：Agent 生成架构图</span>
{
  <span class="hljs-attr">sessionUpdate</span>: <span class="hljs-string">'agent_message_chunk'</span>,
  <span class="hljs-attr">content</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'diagram'</span>,
    <span class="hljs-attr">format</span>: <span class="hljs-string">'mermaid'</span>,
    <span class="hljs-attr">data</span>: <span class="hljs-string">`
      graph TD
        A[Client] --&gt;|HTTP| B[Server]
        B --&gt; C[Database]
    `</span>
  }
}
</code></pre>
<h5 data-id="heading-69">10.1.2. 多 Agent 协作</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    Editor[Editor]

    CodeAgent[Code Agent&lt;br/&gt;负责代码生成]
    TestAgent[Test Agent&lt;br/&gt;负责测试]
    ReviewAgent[Review Agent&lt;br/&gt;负责代码审查]
    DeployAgent[Deploy Agent&lt;br/&gt;负责部署]

    Editor --&gt; CodeAgent
    Editor --&gt; TestAgent
    Editor --&gt; ReviewAgent
    Editor --&gt; DeployAgent

    CodeAgent &lt;-.协作.-&gt; TestAgent
    TestAgent &lt;-.协作.-&gt; ReviewAgent
    ReviewAgent &lt;-.协作.-&gt; DeployAgent

    style Editor fill:#e3f2fd
    style CodeAgent fill:#fff3e0
    style TestAgent fill:#e8f5e9
    style ReviewAgent fill:#f3e5f5
    style DeployAgent fill:#fce4ec

    Note["Agent 之间可以互相通信和协作"]
    style Note fill:#fffde7
</code></pre>
<h5 data-id="heading-70">10.1.3. 增强的上下文管理</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 未来的会话上下文</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">EnhancedSessionContext</span> {
  <span class="hljs-comment">// 项目元数据</span>
  <span class="hljs-attr">project</span>: {
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">language</span>: <span class="hljs-built_in">string</span>[];
    <span class="hljs-attr">framework</span>: <span class="hljs-built_in">string</span>[];
    <span class="hljs-attr">dependencies</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;;
  };

  <span class="hljs-comment">// 代码图谱</span>
  <span class="hljs-attr">codeGraph</span>: {
    <span class="hljs-attr">files</span>: <span class="hljs-title class_">FileNode</span>[];
    <span class="hljs-attr">imports</span>: <span class="hljs-title class_">ImportEdge</span>[];
    <span class="hljs-attr">exports</span>: <span class="hljs-title class_">ExportEdge</span>[];
  };

  <span class="hljs-comment">// 历史操作</span>
  <span class="hljs-attr">history</span>: <span class="hljs-title class_">Operation</span>[];

  <span class="hljs-comment">// 用户偏好</span>
  <span class="hljs-attr">preferences</span>: {
    <span class="hljs-attr">codingStyle</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">testFramework</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-comment">// ...</span>
  };
}
</code></pre>
<h4 data-id="heading-71">10.2 生态系统建设</h4>
<h5 data-id="heading-72">10.2.1. ACP Agent 市场</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">mindmap
  root((ACP Agent 市场))
    Agent类型
      官方Agent
        Claude
        Gemini
        Codex
      社区Agent
        开源
        定制化
      企业Agent
        私有部署
        定制模型
    用户功能
      浏览和搜索Agent
      查看评分和评论
      一键安装和配置
      分享自己的Agent
</code></pre>
<h5 data-id="heading-73">10.2.2. 标准化的 Agent 能力声明</h5>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// agent-manifest.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-custom-agent"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"A custom coding agent for Rust projects"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Your Name"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"capabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"languages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"rust"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"toml"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"frameworks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"tokio"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"actix"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"code_generation"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"refactoring"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"testing"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"debugging"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"requirements"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"gpt-4"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"apiKey"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"required"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"minEditorVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.158.0"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h5 data-id="heading-74">10.2.3. 跨编辑器同步</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 未来的跨编辑器配置同步</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">AgentConfig</span> {
  <span class="hljs-attr">agents</span>: {
    [<span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>]: {
      <span class="hljs-attr">command</span>: <span class="hljs-built_in">string</span>;
      <span class="hljs-attr">args</span>: <span class="hljs-built_in">string</span>[];
      <span class="hljs-attr">env</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;;
      <span class="hljs-attr">settings</span>: <span class="hljs-built_in">any</span>;
    };
  };
  <span class="hljs-attr">preferences</span>: {
    <span class="hljs-attr">defaultAgent</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">autoStart</span>: <span class="hljs-built_in">boolean</span>;
    <span class="hljs-comment">// ...</span>
  };
}

<span class="hljs-comment">// 同步到云端</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">syncConfigToCloud</span>(config);

<span class="hljs-comment">// 在另一台设备上</span>
<span class="hljs-keyword">const</span> config = <span class="hljs-keyword">await</span> <span class="hljs-title function_">loadConfigFromCloud</span>();
</code></pre>
<h4 data-id="heading-75">10.3 与其他标准的集成</h4>
<h5 data-id="heading-76">10.3.1. 与 LSP 的深度集成</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    Editor[Editor]

    subgraph LSP["LSP (提供语言智能)"]
        L1[自动补全]
        L2[类型检查]
        L3[重构建议]
    end

    subgraph ACP["ACP (提供 AI 能力)"]
        A1[理解 LSP 的诊断信息]
        A2[生成符合项目规范的代码]
        A3[自动修复 LSP 报告的错误]
    end

    Editor --&gt; LSP
    Editor --&gt; ACP
    ACP -.读取诊断.-&gt; LSP

    style Editor fill:#e3f2fd
    style LSP fill:#fff3e0
    style ACP fill:#e8f5e9
</code></pre>
<h5 data-id="heading-77">10.3.2. 与 Debug Adapter Protocol (DAP) 集成</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Agent 可以理解调试信息</span>
{
  <span class="hljs-attr">sessionUpdate</span>: <span class="hljs-string">'debug_analysis'</span>,
  <span class="hljs-attr">breakpoint</span>: {
    <span class="hljs-attr">file</span>: <span class="hljs-string">'src/index.ts'</span>,
    <span class="hljs-attr">line</span>: <span class="hljs-number">42</span>,
    <span class="hljs-attr">variables</span>: {
      <span class="hljs-attr">user</span>: { <span class="hljs-attr">id</span>: <span class="hljs-number">123</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span> },
      <span class="hljs-attr">error</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Invalid token'</span>)
    }
  },
  <span class="hljs-attr">suggestion</span>: <span class="hljs-string">"错误是因为 token 已过期，建议添加 token 刷新逻辑"</span>
}
</code></pre>
<h4 data-id="heading-78">10.4 AI 原生编程范式</h4>
<p>ACP 正在推动一种新的编程范式：<strong>AI 原生编程（AI-Native Programming）</strong>。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    subgraph Traditional["传统编程"]
        T1[人类] --&gt; T2[手写代码] --&gt; T3[编译器] --&gt; T4[可执行程序]
    end

    subgraph Current["AI 辅助编程(现在)"]
        C1[人类] --&gt; C2[AI 生成代码片段] --&gt; C3[人类修改] --&gt; C4[编译器] --&gt; C5[可执行程序]
    end

    subgraph Future["AI 原生编程(未来)"]
        F1[人类描述需求] --&gt; F2[AI Agent 理解] --&gt; F3[AI 设计架构]
        F3 --&gt; F4[AI 实现] --&gt; F5[AI 测试] --&gt; F6[AI 部署]
        F6 -.人类审查和指导.-&gt; F1
    end

    style Traditional fill:#ffebee
    style Current fill:#fff3e0
    style Future fill:#e8f5e9
</code></pre>
<p><strong>关键特征：</strong></p>
<ol>
<li><strong>声明式编程</strong>：人类只需描述"要什么"，而不是"怎么做"</li>
<li><strong>持续对话</strong>：编程变成与 AI 的持续对话过程</li>
<li><strong>多层抽象</strong>：从需求 → 架构 → 实现 → 优化，每层都有 AI 辅助</li>
<li><strong>自动化流程</strong>：测试、部署、监控都由 AI 自动化</li>
</ol>
<hr/>
<h3 data-id="heading-79">十一、总结</h3>
<h4 data-id="heading-80">11.1 ACP 的核心价值</h4>
<p>✅ <strong>标准化</strong>：统一的协议规范，消除编辑器与 Agent 的互操作壁垒</p>
<p>✅ <strong>开放性</strong>：开源协议，任何人都可以实现和扩展</p>
<p>✅ <strong>隐私优先</strong>：本地通信，不经过第三方服务器</p>
<p>✅ <strong>可组合性</strong>：与 MCP 等协议协同工作，构建完整的 AI 生态</p>
<p>✅ <strong>易用性</strong>：基于成熟的 JSON-RPC 2.0，简单高效</p>
<h4 data-id="heading-81">11.2 适用场景</h4>
<ul>
<li><strong>代码编辑器开发者</strong>：希望集成多个 AI 编码助手</li>
<li><strong>AI Agent 开发者</strong>：希望让自己的 Agent 被更多编辑器支持</li>
<li><strong>企业开发团队</strong>：需要在统一的编辑器环境中使用不同的 AI 工具</li>
<li><strong>开源社区</strong>：构建开放、协作的 AI 辅助编程生态</li>
</ul>
<h4 data-id="heading-82">11.3 开始使用 ACP</h4>
<h5 data-id="heading-83">11.3.1. 作为编辑器开发者</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 ACP SDK</span>
npm install @agentclientprotocol/sdk

<span class="hljs-comment"># 参考 Zed 的实现</span>
git <span class="hljs-built_in">clone</span> https://github.com/zed-industries/zed
</code></pre>
<h5 data-id="heading-84">11.3.2. 作为 Agent 开发者</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 选择你喜欢的语言 SDK</span>
npm install @agentclientprotocol/sdk       <span class="hljs-comment"># TypeScript</span>
pip install agent-client-protocol          <span class="hljs-comment"># Python</span>
cargo add agent-client-protocol            <span class="hljs-comment"># Rust</span>
</code></pre>
<h5 data-id="heading-85">11.3.3. 作为用户</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 下载支持 ACP 的编辑器</span>
<span class="hljs-comment"># Zed</span>
curl https://zed.dev/install.sh | sh

<span class="hljs-comment"># 配置你喜欢的 Agent</span>
zed --config agents.claude.command=<span class="hljs-string">"claude-code"</span>
</code></pre>
<h4 data-id="heading-86">11.4 学习资源</h4>
<ul>
<li><strong>官方网站</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fagentclientprotocol.com%2F" target="_blank" title="https://agentclientprotocol.com/" ref="nofollow noopener noreferrer">agentclientprotocol.com</a></li>
<li><strong>GitHub 仓库</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fagentclientprotocol%2Fagent-client-protocol" target="_blank" title="https://github.com/agentclientprotocol/agent-client-protocol" ref="nofollow noopener noreferrer">github.com/agentclient…</a></li>
<li><strong>协议规范</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fagentclientprotocol%2Fagent-client-protocol%2Fblob%2Fmain%2Fschema%2Fschema.json" target="_blank" title="https://github.com/agentclientprotocol/agent-client-protocol/blob/main/schema/schema.json" ref="nofollow noopener noreferrer">Schema JSON</a></li>
<li><strong>社区讨论</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fagentclientprotocol%2Fagent-client-protocol%2Fdiscussions" target="_blank" title="https://github.com/agentclientprotocol/agent-client-protocol/discussions" ref="nofollow noopener noreferrer">GitHub Discussions</a></li>
</ul>
<hr/>
<h3 data-id="heading-87">附录：ACP 与 MCP 协议对比速查表</h3>






































































<table><thead><tr><th>特性</th><th>ACP</th><th>MCP</th></tr></thead><tbody><tr><td><strong>完整名称</strong></td><td>Agent Client Protocol</td><td>Model Context Protocol</td></tr><tr><td><strong>主要作用</strong></td><td>编辑器 ↔ AI Agent</td><td>AI Model ↔ Tools</td></tr><tr><td><strong>协议基础</strong></td><td>JSON-RPC 2.0</td><td>JSON-RPC 2.0</td></tr><tr><td><strong>传输方式</strong></td><td>stdio</td><td>stdio / HTTP+SSE</td></tr><tr><td><strong>通信方向</strong></td><td>双向</td><td>主要单向</td></tr><tr><td><strong>生命周期管理</strong></td><td>编辑器控制</td><td>Host 控制</td></tr><tr><td><strong>权限控制</strong></td><td>内置机制</td><td>依赖 Host</td></tr><tr><td><strong>流式响应</strong></td><td>支持</td><td>支持</td></tr><tr><td><strong>作者</strong></td><td>Zed Industries</td><td>Anthropic</td></tr><tr><td><strong>开源协议</strong></td><td>Apache 2.0</td><td>MIT</td></tr><tr><td><strong>发布时间</strong></td><td>2025</td><td>2024</td></tr><tr><td><strong>典型场景</strong></td><td>代码生成、重构</td><td>数据库、API 调用</td></tr></tbody></table>
<hr/>
<p><strong>关于本文</strong></p>
<p>本文结合了：</p>
<ul>
<li>MCP 官方文档和社区实践</li>
<li>ACP 官方规范和 Zed 实现</li>
<li>AionUi 项目的实际代码</li>
<li>行业最佳实践和未来趋势</li>
</ul>
<p>希望能帮助你深入理解 ACP 协议，并在实际项目中应用。</p>
<p><strong>作者</strong>：基于掘金文章《MCP 深度解析》、ACP 官方文档、以及 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FiOfficeAI%2FAionUi" target="_blank" title="https://github.com/iOfficeAI/AionUi" ref="nofollow noopener noreferrer">AionUi</a> 开源项目分析，感兴趣可以关注我！</p>
<h3 data-id="heading-88"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0756528722f34e8d940996215c1693af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6a2B6aaW:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764319314&amp;x-signature=uJj0k0bF%2Bh%2FybrOXmQQ95dFUyUQ%3D" alt="扫码_搜索联合传播样式-白色版.png" loading="lazy"/></h3>
<p><strong>相关阅读</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io" target="_blank" title="https://modelcontextprotocol.io" ref="nofollow noopener noreferrer">MCP 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fagentclientprotocol.com%2F" target="_blank" title="https://agentclientprotocol.com/" ref="nofollow noopener noreferrer">ACP 官方网站</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fzed.dev%2Facp" target="_blank" title="https://zed.dev/acp" ref="nofollow noopener noreferrer">Zed 编辑器 ACP 集成</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FiOfficeAI%2FAionUi" target="_blank" title="https://github.com/iOfficeAI/AionUi" ref="nofollow noopener noreferrer">AionUi 开源项目</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[robfig/cron定时任务库快速入门]]></title>    <link>https://juejin.cn/post/7574958975159828523</link>    <guid>https://juejin.cn/post/7574958975159828523</guid>    <pubDate>2025-11-21T08:58:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574958975159828523" data-draft-id="7573776814926807059" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="robfig/cron定时任务库快速入门"/> <meta itemprop="keywords" content="后端,Go,分布式"/> <meta itemprop="datePublished" content="2025-11-21T08:58:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Jerris"/> <meta itemprop="url" content="https://juejin.cn/user/154376649325101"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            robfig/cron定时任务库快速入门
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/154376649325101/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Jerris
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T08:58:28.000Z" title="Fri Nov 21 2025 08:58:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.7;font-weight:400;font-size:16px;overflow-x:hidden;color:#2c3e50;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;font-weight:600;margin-top:35px;margin-bottom:8px;padding-bottom:5px}.markdown-body h1 :before,.markdown-body h2 :before,.markdown-body h3 :before,.markdown-body h4 :before,.markdown-body h5 :before,.markdown-body h6 :before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:8px;margin-top:50px;font-size:24px;border-bottom:1px solid #eaecef}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #eaecef;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;font-weight:400;background-color:rgba(27,31,35,.05);color:#476582;margin:0;font-size:.85em;border-radius:3px;font-size:.87em;padding:.165em .5em}.markdown-body code,.markdown-body pre{font-family:source-code-pro,Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.6;padding:20px 24px;background-color:#282c34;border-radius:6px}.markdown-body pre&gt;code{font-size:14px;padding:0;margin:0;word-break:normal;display:block;overflow-x:auto;color:#fff}.markdown-body a{text-decoration:none;color:#3eaf7c;font-weight:500}.markdown-body a:active,.markdown-body a:hover{color:#42b983;border-bottom:1px solid #42b983}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;margin:16px 0;border-collapse:collapse}.markdown-body thead{background:#f6f6f6;background:#3eaf7c;color:#000;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f6f8fa}.markdown-body td,.markdown-body th{border:1px solid #dfe2e5;padding:10px 16px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{font-size:14px;padding:6px 23px;margin:22px 0;border-left:6px solid #42b983;background-color:#f3f5f7;font-weight:400}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body p,.markdown-body ul{line-height:1.7}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="xcode">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.xml .hljs-meta{color:silver}.hljs-comment,.hljs-quote{color:#007400}.hljs-attribute,.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-tag{color:#aa0d91}.hljs-template-variable,.hljs-variable{color:#3f6e74}.hljs-code,.hljs-meta-string,.hljs-string{color:#c41a16}.hljs-link,.hljs-regexp{color:#0e0eff}.hljs-bullet,.hljs-number,.hljs-symbol,.hljs-title{color:#1c00cf}.hljs-meta,.hljs-section{color:#643820}.hljs-built_in,.hljs-builtin-name,.hljs-class .hljs-title,.hljs-params,.hljs-type{color:#5c2699}.hljs-attr{color:#836c28}.hljs-subst{color:#000}.hljs-formula{background-color:#eee;font-style:italic}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-selector-class,.hljs-selector-id{color:#9b703f}.hljs-doctag,.hljs-strong{font-weight:700}.hljs-emphasis{font-style:italic}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb7c0f562bfc4010ac1780971ef83882~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmVycmlz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764320497&amp;x-signature=XSKb7RzKstD1J%2Fk%2B7gDUVAEGK%2FU%3D" alt="解释 robfig_cron 库的 Cron 表达式.png" loading="lazy"/></p>
<h2 data-id="heading-0">robfig/cron库简介</h2>
<p>robfig/cron 是 Go 生态里最常用、最稳定的定时任务库之一。它支持标准 Cron 表达式、秒级调度、任务并发控制、任务日志、带上下文执行等功能，非常适合生产环境。</p>
<h2 data-id="heading-1">Quick Start</h2>
<h3 data-id="heading-2">安装命令</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">go</span> get github.com/robfig/cron/v3
</code></pre>
<h3 data-id="heading-3">最简单的demo</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"github.com/robfig/cron/v3"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    c := cron.New()

    <span class="hljs-comment">// 每隔 1 分钟执行</span>
    c.AddFunc(<span class="hljs-string">"*/1 * * * *"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        fmt.Println(<span class="hljs-string">"task run"</span>)
    })

    c.Start()

    <span class="hljs-keyword">select</span> {}
}
</code></pre>
<p>上面的程序表示，每隔一分钟就那个执行这个函数，打印 <code>task run</code> 字符串。这仅仅是最简单的用法，还可以添加 <code>job</code> 实例以实现更复杂的逻辑。</p>
<h2 data-id="heading-4">进阶使用</h2>
<h3 data-id="heading-5">熟悉cron表达式</h3>
<p>robfig/cron（v3 版本）完整支持 标准 Cron 表达式，包括可选的秒字段。它的表达式格式十分灵活，同时支持特殊字符（<code>*</code> 、<code>,</code>、<code>-</code>、<code>/</code> 等）以及扩展语法（如 <code>@every</code>）。</p>
<p>robfig/cron 提供两种模式：</p>
<ul>
<li>标准 5 字段（默认）：</li>
</ul>
<pre><code class="hljs language-txt" lang="txt">分 时 日 月 星期
30 2  *  *  *
表示每天 02:30 执行
</code></pre>
<ul>
<li>启用 <code>WithSeconds()</code> 后变成 6 字段：</li>
</ul>
<pre><code class="hljs language-txt" lang="txt">秒 分 时 日 月 星期
0 */5 *  *  *  *
表示每 5 分钟执行一次（带秒，所以第 1 位是秒）
</code></pre>
<p>在 cron 表达式中，有一些特殊字符，如：<code>*</code>、<code>/</code>、<code>-</code>、<code>,</code>、<code>?</code> 符合，这些符号有着特殊含义，用于灵活地指定时间点。</p>
<ul>
<li><code>*</code>（星号）：</li>
</ul>
<p>表示“所有可能的值”。例如，在 “分钟” 字段中使用 <code>*</code>，表示 “每分钟”。</p>
<ul>
<li><code>/</code>（斜杠）：</li>
</ul>
<p>表示 “每隔” 一定时间。例如，在 “分钟” 字段中使用 <code>*/15</code>，表示 “每隔 15 分钟”（即 0, 15, 30, 45 分）。在 “小时” 字段中使用 <code>2/4</code>，表示 “从 2 点开始，每隔 4 小时”（即 2, 6, 10, 14, 18, 22 点）。</p>
<ul>
<li><code>-</code>（连字符）：</li>
</ul>
<p>表示一个 “范围”。例如，在 “小时” 字段中使用 <code>9-17</code>，表示 “从 9 点到 17 点之间的每一小时”（即 9, 10, ..., 17）。</p>
<ul>
<li><code>,</code>（逗号）</li>
</ul>
<p>表示 “列举多个值”。例如，在 “星期” 字段中使用 <code>1,3,5</code>，表示 “星期一、星期三和星期五”。</p>
<ul>
<li><code>?</code>（问号）</li>
</ul>
<p>这个字符是 robfig/cron 库对标准 Cron 的一个扩展（标准 Cron 中没有 <code>?</code>），但它遵循了 Quartz Scheduler 等流行库的约定。它用于在 “日期” 和 “星期” 字段中表示 “不指定值” 或 “任意值”，用于避免这两个字段之间的冲突。因为在 Cron 表达式中，“日期” 和 “星期” 是互斥的（指定了日期，星期就无关紧要了，反之亦然）。</p>
<p>最佳实践：当你想指定一个具体的日期（例如每月 10 号），就在 “星期” 字段使用 <code>?</code>。当你想指定一个具体的星期几（例如每周一），就在 “日期” 字段使用 <code>?</code>。</p>
<p><code>0 0 10 * ?</code> 表示 “每月 10 号的 0 点 0 分”（星期几无关）。</p>
<p><code>0 0 ? * 1</code> 表示 “每周一的 0 点 0 分”（几号无关）。</p>
<p>在 6 字段格式的基础上，再增加一个 <code>年</code> 字段：</p>
<pre><code class="hljs language-txt" lang="txt">┌───────────── 秒 (0 - 59)
│ ┌───────────── 分钟 (0 - 59)
│ │ ┌───────────── 小时 (0 - 23)
│ │ │ ┌───────────── 日期 (1 - 31)
│ │ │ │ ┌───────────── 月份 (1 - 12)
│ │ │ │ │ ┌───────────── 星期 (0 - 6) (星期日为 0 或 7)
│ │ │ │ │ │ ┌───────────── 年 (可选, 1970-2099)
│ │ │ │ │ │ │
* * * * * * *
</code></pre>
<p><code>0 0 0 1 1 ? 2025</code> 表示 “在 2025 年 1 月 1 日 0 点 0 分 0 秒” 执行。</p>
<h3 data-id="heading-6">预定义的时间表</h3>
<p>为了让常见的调度任务更容易编写，robfig/cron 库还支持一些预定义的字符串，它们是标准 Cron 表达式的别名：</p>



































<table><thead><tr><th align="left">预定义字符串</th><th align="left">等价的 Cron 表达式</th><th align="left">含义</th></tr></thead><tbody><tr><td align="left"><code>@yearly</code> 或 <code>@annually</code></td><td align="left"><code>0 0 0 1 1 *</code></td><td align="left">每年执行一次（1 月 1 日 00:00）</td></tr><tr><td align="left"><code>@monthly</code></td><td align="left"><code>0 0 0 1 * *</code></td><td align="left">每月执行一次（每月 1 日 00:00）</td></tr><tr><td align="left"><code>@weekly</code></td><td align="left"><code>0 0 0 * * 0</code></td><td align="left">每周执行一次（每周日 00:00）</td></tr><tr><td align="left"><code>@daily</code> 或 <code>@midnight</code></td><td align="left"><code>0 0 0 * * *</code></td><td align="left">每天执行一次（00:00）</td></tr><tr><td align="left"><code>@hourly</code></td><td align="left"><code>0 0 * * * *</code></td><td align="left">每小时执行一次（整点）</td></tr></tbody></table>
<p>robfig/cron 还提供了一种扩展预定义关键字，<code>@every</code> 它用于表示 “每隔固定的时间间隔” 执行一次任务。这与标准 Cron 表达式基于 “特定时间点” 的调度方式有本质区别。</p>
<ol>
<li>@every 的核心特点：</li>
</ol>
<p>基于间隔，而非时点：标准的 Cron 表达式（如 <code>0 */5 * * * *</code>）是在每个小时的第 0、5、10... 分钟执行。而 <code>@every 5m</code> 是在任务启动后，每隔 5 分钟执行一次，无论当前是几点几分。</p>
<p>不受系统时间变化影响：如果系统时间因为同步或调整而向后跳跃，基于时点的 Cron 任务可能会被跳过或重复执行。而 <code>@every</code> 是基于内部计时器的，它会严格按照设定的间隔来触发，不受系统时间跳跃的影响（只要时间不向前跳跃）。
语法简洁直观：对于简单的周期性任务，<code>@every</code> 比写 Cron 表达式更直观。例如，<code>@every 1h30m</code> 一眼就能看出是每隔 1 小时 30 分钟执行一次。</p>
<ol start="2">
<li>@every 的语法</li>
</ol>
<p>@every 后面紧跟一个时间间隔字符串，格式为：</p>
<pre><code class="hljs language-txt" lang="txt">@every &lt;duration&gt;
</code></pre>
<p>其中 <code>&lt;duration&gt;</code> 是一个符合 Go 语言 time.Duration 格式的字符串，支持的单位包括：</p>
<ul>
<li>ns：纳秒</li>
<li>us：微秒</li>
<li>ms：毫秒</li>
<li>s：秒</li>
<li>m：分钟</li>
<li>h：小时</li>
<li>d：天（注意：d 是 <code>robfig/cron</code> 库支持的扩展单位，标准的 <code>time.Duration</code> 并不直接支持 d，但库内部会将其转换为小时）</li>
</ul>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 假设现在是 10:03:25</span>
c.AddFunc(<span class="hljs-string">"@every 5m"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
    fmt.Println(<span class="hljs-string">"任务执行了"</span>)
})
</code></pre>
<ul>
<li><strong>第一次执行时间：</strong>  10:03:25（任务添加后立即开始计时，5 分钟后触发）</li>
<li><strong>第二次执行时间：</strong>  10:08:25</li>
<li><strong>第三次执行时间：</strong>  10:13:25</li>
<li><strong>...</strong>  以此类推，严格间隔 5 分钟。</li>
</ul>
<p><strong>使用场景：</strong></p>
<ul>
<li>
<p><strong>使用 <code>@every</code> 的场景：</strong></p>
<ul>
<li>你需要一个简单、固定的时间间隔来执行任务，不关心具体在哪个时间点。</li>
<li>任务的执行间隔较短（如几秒、几分钟）。</li>
<li>你希望任务从启动后就开始按照间隔执行，而不是等待下一个整点。</li>
<li>例如：定期检查某个服务的健康状态、定期从数据库中清理过期数据、实时数据处理等。</li>
</ul>
</li>
<li>
<p><strong>使用标准 Cron 表达式的场景：</strong></p>
<ul>
<li>你需要任务在<strong>特定的时间点</strong>执行，而不是固定的间隔。</li>
<li>任务的执行周期与日历相关（如每天早上 8 点、每周一晚上、每月 15 号）。</li>
<li>例如：每天凌晨 3 点生成日报、每周五下午 5 点备份数据库、每月 1 号结算账单。</li>
</ul>
</li>
</ul>
<p><code>@every</code> 是 <code>robfig/cron</code> 库提供的一个非常方便的工具，它提供了一种<strong>基于固定间隔</strong>的调度方式，与标准 Cron 表达式<strong>基于特定时点</strong>的调度方式形成了很好的互补。</p>
<p>选择使用 <code>@every</code> 还是标准 Cron 表达式，主要取决于你的任务是需要 “每隔多久执行一次” 还是 “在某个特定时间执行”。</p>
<h3 data-id="heading-7">自定义Job实例</h3>
<p>好的，在 robfig/cron/v3 中自定义 Job 实例通常有两种方式：结构体嵌入和函数包装。以下是具体实现和说明：</p>
<h4 data-id="heading-8">结构体嵌入</h4>
<p>通过定义一个结构体，嵌入 <code>cron.Job</code> 接口，然后实现自定义的 <code>Run()</code> 方法。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"time"</span>

    <span class="hljs-string">"github.com/robfig/cron/v3"</span>
)

<span class="hljs-comment">// 定义一个自定义任务结构体</span>
<span class="hljs-keyword">type</span> MyJob <span class="hljs-keyword">struct</span> {
    Name <span class="hljs-type">string</span>
    <span class="hljs-comment">// 可以添加其他字段，比如配置、依赖等</span>
}

<span class="hljs-comment">// 实现 cron.Job 接口的 Run 方法</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *MyJob)</span></span> Run() {
    fmt.Printf(<span class="hljs-string">"任务 [%s] 执行时间: %s\n"</span>, m.Name, time.Now().Format(<span class="hljs-string">"2006-01-02 15:04:05"</span>))
    <span class="hljs-comment">// 这里可以写具体的任务逻辑</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 创建一个 cron 调度器</span>
    c := cron.New()

    <span class="hljs-comment">// 实例化自定义任务</span>
    job1 := &amp;MyJob{Name: <span class="hljs-string">"任务A"</span>}
    job2 := &amp;MyJob{Name: <span class="hljs-string">"任务B"</span>}

    <span class="hljs-comment">// 添加任务到调度器</span>
    _, err := c.AddJob(<span class="hljs-string">"*/5 * * * *"</span>, job1) <span class="hljs-comment">// 每5分钟执行一次</span>
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        fmt.Println(<span class="hljs-string">"添加任务A失败:"</span>, err)
        <span class="hljs-keyword">return</span>
    }

    _, err = c.AddJob(<span class="hljs-string">"@hourly"</span>, job2) <span class="hljs-comment">// 每小时执行一次</span>
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        fmt.Println(<span class="hljs-string">"添加任务B失败:"</span>, err)
        <span class="hljs-keyword">return</span>
    }

    <span class="hljs-comment">// 启动调度器</span>
    c.Start()

    <span class="hljs-comment">// 保持程序运行</span>
    <span class="hljs-keyword">select</span> {}
}
</code></pre>
<p><strong>优点：</strong></p>
<ul>
<li>结构清晰，易于扩展和维护</li>
<li>可以在结构体中存储任务相关的配置和状态</li>
<li>支持依赖注入</li>
</ul>
<h4 data-id="heading-9">带有上下文的任务</h4>
<p>如果你需要在任务中处理上下文（比如取消信号），可以实现 <code>cron.Job</code> 接口并在 <code>Run()</code> 方法中使用上下文。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"context"</span>
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"time"</span>

    <span class="hljs-string">"github.com/robfig/cron/v3"</span>
)

<span class="hljs-keyword">type</span> ContextJob <span class="hljs-keyword">struct</span> {
    ctx context.Context
    <span class="hljs-comment">// 其他字段</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *ContextJob)</span></span> Run() {
    <span class="hljs-keyword">select</span> {
    <span class="hljs-keyword">case</span> &lt;-c.ctx.Done():
        fmt.Println(<span class="hljs-string">"任务被取消"</span>)
        <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">default</span>:
        fmt.Printf(<span class="hljs-string">"上下文任务执行时间: %s\n"</span>, time.Now().Format(<span class="hljs-string">"2006-01-02 15:04:05"</span>))
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    ctx, cancel := context.WithCancel(context.Background())
    <span class="hljs-keyword">defer</span> cancel()

    c := cron.New()

    job := &amp;ContextJob{ctx: ctx}
    _, err := c.AddJob(<span class="hljs-string">"*/30 * * * *"</span>, job)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        fmt.Println(<span class="hljs-string">"添加任务失败:"</span>, err)
        <span class="hljs-keyword">return</span>
    }

    c.Start()

    <span class="hljs-comment">// 等待用户输入后停止</span>
    fmt.Println(<span class="hljs-string">"按 Enter 键停止程序..."</span>)
    fmt.Scanln()
    cancel() <span class="hljs-comment">// 取消上下文</span>
    c.Stop() <span class="hljs-comment">// 停止调度器</span>
}
</code></pre>
<h4 data-id="heading-10">任务的优先级和并发控制</h4>
<p><code>robfig/cron/v3</code> 默认是并发执行任务的，如果需要控制并发，可以使用 <code>cron.WithMaxConcurrentJobs()</code> 选项。</p>
<pre><code class="hljs language-go" lang="go">c := cron.New(cron.WithMaxConcurrentJobs(<span class="hljs-number">3</span>, cron.DefaultLogger))
</code></pre>
<p>这样可以限制最多同时运行 3 个任务。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手把手打通 H5 多支付通道（Apple pay、Google pay、第三方卡支付）]]></title>    <link>https://juejin.cn/post/7574992086714662927</link>    <guid>https://juejin.cn/post/7574992086714662927</guid>    <pubDate>2025-11-21T08:51:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574992086714662927" data-draft-id="7574978847151095848" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手把手打通 H5 多支付通道（Apple pay、Google pay、第三方卡支付）"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-21T08:51:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="喝二两啤酒"/> <meta itemprop="url" content="https://juejin.cn/user/3087895803997325"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手把手打通 H5 多支付通道（Apple pay、Google pay、第三方卡支付）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3087895803997325/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    喝二两啤酒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T08:51:24.000Z" title="Fri Nov 21 2025 08:51:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>本文只聚焦支付逻辑：在一个 Vue 组件里同时兼容 Apple Pay、Google Pay 与钱海信用卡（Oceanpayment）。核心思路是“分三条链路获取 quickpayId，最后统一交给 <code>processPayment</code>”。</p>
<hr/>
<h2 data-id="heading-1">代码讲解</h2>
<h3 data-id="heading-2">Apple Pay</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-title function_">createApplePaySession</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> request = {
    <span class="hljs-attr">countryCode</span>: <span class="hljs-variable constant_">PAYMENT_CONFIG</span>.<span class="hljs-property">applePay</span>.<span class="hljs-property">countryCode</span>,
    <span class="hljs-attr">currencyCode</span>: <span class="hljs-variable constant_">PAYMENT_CONFIG</span>.<span class="hljs-property">applePay</span>.<span class="hljs-property">currencyCode</span>,
    <span class="hljs-attr">supportedNetworks</span>: <span class="hljs-variable constant_">PAYMENT_CONFIG</span>.<span class="hljs-property">applePay</span>.<span class="hljs-property">supportedNetworks</span>,
    <span class="hljs-attr">total</span>: {
      <span class="hljs-attr">label</span>: <span class="hljs-variable constant_">PAYMENT_CONFIG</span>.<span class="hljs-property">applePay</span>.<span class="hljs-property">displayName</span>,
      <span class="hljs-attr">amount</span>: <span class="hljs-built_in">parseFloat</span>(currentPrice.<span class="hljs-property">value</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>),
      <span class="hljs-attr">type</span>: <span class="hljs-string">"final"</span>
    }
  };

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> session = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplePaySession</span>(<span class="hljs-number">3</span>, request);

    session.<span class="hljs-property">onvalidatemerchant</span> = <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">const</span> resp = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getApplePayMerchantValidation</span>({
        <span class="hljs-attr">initiative</span>: <span class="hljs-string">"web"</span>,
        <span class="hljs-attr">initiativeContext</span>: <span class="hljs-string">"h5.tanlinkerp.cn"</span>,
        <span class="hljs-attr">merchantIdentifier</span>: <span class="hljs-variable constant_">PAYMENT_CONFIG</span>.<span class="hljs-property">applePay</span>.<span class="hljs-property">merchantId</span>
      });
      session.<span class="hljs-title function_">completeMerchantValidation</span>(
        <span class="hljs-keyword">typeof</span> resp.<span class="hljs-property">data</span> === <span class="hljs-string">"string"</span> ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(resp.<span class="hljs-property">data</span>) : resp.<span class="hljs-property">data</span>
      );
    };

    session.<span class="hljs-property">onpaymentauthorized</span> = <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> token = event.<span class="hljs-property">payment</span>?.<span class="hljs-property">token</span>?.<span class="hljs-property">paymentData</span>;
      session.<span class="hljs-title function_">completePayment</span>(token ? <span class="hljs-title class_">ApplePaySession</span>.<span class="hljs-property">STATUS_SUCCESS</span> : <span class="hljs-title class_">ApplePaySession</span>.<span class="hljs-property">STATUS_FAILURE</span>);
      token ? <span class="hljs-title function_">resolve</span>(token) : <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Invalid payment data"</span>));
    };

    session.<span class="hljs-property">oncancel</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"User cancelled"</span>));
    session.<span class="hljs-property">onerror</span> = <span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(err.<span class="hljs-property">message</span>));

    session.<span class="hljs-title function_">begin</span>();
  });
};
</code></pre>
<blockquote>
<p>图示说明：这段代码做两件事——1）在 <code>onvalidatemerchant</code> 里向后端要 <code>merchantSession</code>；2）在 <code>onpaymentauthorized</code> 中拿到 <code>paymentData</code> 并返回。</p>
</blockquote>
<ul>
<li>拿到 <code>paymentData</code> 后，调用 <code>getGoogleOrAppleBindCard({ methods: "ApplePay", payAccountNumber: token })</code>。</li>
<li>接口返回 <code>quickpayId</code>，再执行 <code>processPayment(quickpayId, "Apple Pay")</code>。</li>
</ul>
<h3 data-id="heading-3">Google Pay</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-title function_">createGooglePaySession</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> paymentsClient = <span class="hljs-keyword">new</span> google.<span class="hljs-property">payments</span>.<span class="hljs-property">api</span>.<span class="hljs-title class_">PaymentsClient</span>({
    <span class="hljs-attr">environment</span>: <span class="hljs-variable constant_">PAYMENT_CONFIG</span>.<span class="hljs-property">googlePay</span>.<span class="hljs-property">environment</span>
  });

  <span class="hljs-keyword">const</span> paymentDataRequest = {
    <span class="hljs-attr">apiVersion</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">allowedPaymentMethods</span>: [{
      <span class="hljs-attr">type</span>: <span class="hljs-string">"CARD"</span>,
      <span class="hljs-attr">parameters</span>: {
        <span class="hljs-attr">allowedAuthMethods</span>: [<span class="hljs-string">"PAN_ONLY"</span>, <span class="hljs-string">"CRYPTOGRAM_3DS"</span>],
        <span class="hljs-attr">allowedCardNetworks</span>: [<span class="hljs-string">"MASTERCARD"</span>, <span class="hljs-string">"VISA"</span>]
      },
      <span class="hljs-attr">tokenizationSpecification</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-string">"PAYMENT_GATEWAY"</span>,
        <span class="hljs-attr">parameters</span>: { <span class="hljs-attr">gateway</span>: <span class="hljs-string">"example"</span>, <span class="hljs-attr">gatewayMerchantId</span>: <span class="hljs-string">"exampleGatewayMerchantId"</span> }
      }
    }],
    <span class="hljs-attr">transactionInfo</span>: {
      <span class="hljs-attr">totalPriceStatus</span>: <span class="hljs-string">"FINAL"</span>,
      <span class="hljs-attr">totalPrice</span>: <span class="hljs-built_in">parseFloat</span>(currentPrice.<span class="hljs-property">value</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>),
      <span class="hljs-attr">currencyCode</span>: <span class="hljs-string">"USD"</span>
    },
    <span class="hljs-attr">merchantInfo</span>: <span class="hljs-variable constant_">PAYMENT_CONFIG</span>.<span class="hljs-property">googlePay</span>
  };

  <span class="hljs-keyword">const</span> paymentData = <span class="hljs-keyword">await</span> paymentsClient.<span class="hljs-title function_">loadPaymentData</span>(paymentDataRequest);
  <span class="hljs-keyword">return</span> paymentData.<span class="hljs-property">paymentMethodData</span>.<span class="hljs-property">tokenizationData</span>.<span class="hljs-property">token</span>;
};
</code></pre>
<ul>
<li>Google Pay 只需要 <code>loadPaymentData</code>，但在展示入口之前最好调用 <code>paymentsClient.isReadyToPay()</code> 过滤不可用设备。</li>
<li>获取的 <code>token</code> 走 <code>getGoogleOrAppleBindCard({ methods: "GooglePay" })</code>，返回 <code>quickpayId</code> 后仍旧调用 <code>processPayment(quickpayId, "Google Pay")</code>。</li>
</ul>
<h3 data-id="heading-4">钱海信用卡</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchUserCards</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUserCards</span>({ <span class="hljs-attr">country</span>: userCountry.<span class="hljs-property">value</span> });
  <span class="hljs-keyword">if</span> (response.<span class="hljs-property">code</span> === <span class="hljs-number">200</span>) {
    userCards.<span class="hljs-property">value</span> = response.<span class="hljs-property">data</span>;
    selectedCard.<span class="hljs-property">value</span> = <span class="hljs-number">0</span>;
    selectedPayment.<span class="hljs-property">value</span> = <span class="hljs-string">"credit"</span>;
  }
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (selectedPayment.<span class="hljs-property">value</span> === <span class="hljs-string">"credit"</span>) {
    <span class="hljs-keyword">const</span> quickpayId = userCards.<span class="hljs-property">value</span>[selectedCard.<span class="hljs-property">value</span>]?.<span class="hljs-property">quickPayId</span>;
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">processPayment</span>(quickpayId, <span class="hljs-string">"Credit Card"</span>);
  }
};
</code></pre>
<ul>
<li>信用卡 <code>quickpayId</code> 来自绑卡页（Oceanpayment SDK），支付页只负责取值并回传后端。</li>
<li><code>processPayment</code> 内部会拼 <code>payDetailId</code>、<code>backUrl</code>、<code>payMethod</code>，调用 <code>getSubAndZf</code>。返回 <code>payUrl</code> 时直接 <code>window.location.href = payUrl</code>，否则跳 <code>paymentStatus</code>。</li>
</ul>
<hr/>
<h2 data-id="heading-5">关键知识点</h2>
<ol>
<li><strong>统一出口</strong>：所有方式都必须拿到 <code>quickpayId</code> 才能进入 <code>processPayment</code>，便于维护和埋点。</li>
<li><strong>安全检查</strong>：Apple/Google Pay 均需 HTTPS 或安全上下文，并提前检测 <code>ApplePaySession</code>、<code>google.payments</code> 是否存在。</li>
<li><strong>倒计时 + 状态恢复</strong>：<code>startCountdown</code> 限制 15 分钟窗口，<code>sessionStorage.paymentData</code> 保存 <code>payDetailId</code> 与金额，用于刷新/跳转后的恢复。</li>
<li><strong>SDK 加载</strong>：Google Pay 通过 <code>loadSDKs</code> 按需注入脚本；Apple Pay 无需额外脚本，但要处理商户验证超时。</li>
</ol>
<hr/>
<h2 data-id="heading-6">最佳实践 / 扩展方案</h2>
<ul>
<li><strong>错误分类</strong>：针对“用户取消”“商户验证失败”“绑定失败”分别提示并上报，方便排查。</li>
<li><strong>动态排序</strong>：根据设备或 <code>userCountry</code> 调整支付方式顺序，例如 iOS 优先展示 Apple Pay。</li>
<li><strong>离线兜底</strong>：倒计时结束时提示用户联系人工，避免订单遗失。</li>
<li><strong>监控指标</strong>：在 <code>selectPayment</code>、<code>handleSubmit</code>、<code>processPayment</code> 打点，分析各通道转化。</li>
</ul>
<hr/>
<h2 data-id="heading-7">小结</h2>
<p>整合多支付的关键是把 Apple Pay、Google Pay、钱海信用卡看作三条“获取 quickpayId 的管道”。一旦拿到 <code>quickpayId</code>，就能统一交给 <code>processPayment</code>，并享受相同的倒计时、状态恢复和跳转逻辑。需要扩展新的支付方式时，遵循这套模式即可快速接入。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[工厂模式详解]]></title>    <link>https://juejin.cn/post/7574775334681935882</link>    <guid>https://juejin.cn/post/7574775334681935882</guid>    <pubDate>2025-11-21T07:59:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574775334681935882" data-draft-id="7574775334681903114" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="工厂模式详解"/> <meta itemprop="keywords" content="设计模式"/> <meta itemprop="datePublished" content="2025-11-21T07:59:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            工厂模式详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T07:59:50.000Z" title="Fri Nov 21 2025 07:59:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">深入理解设计模式之工厂方法模式（Factory Method Pattern）</h2>
<h3 data-id="heading-1">一、引言</h3>
<p>在软件开发中，对象创建是一个非常常见的操作。但是，如果在代码中直接使用<code>new</code>操作符创建对象，会导致代码与具体类紧密耦合，降低系统的灵活性和可扩展性。工厂方法模式正是为了解决这个问题而诞生的一种创建型设计模式。</p>
<p>本文将深入探讨工厂方法模式的原理、实现方式，并结合实际生产场景和开源框架（如JDK、Spring、Guava）中的应用，帮助你全面掌握这一重要的设计模式。</p>
<h3 data-id="heading-2">二、什么是工厂方法模式</h3>
<h4 data-id="heading-3">2.1 定义</h4>
<p>工厂方法模式（Factory Method Pattern）是一种创建型设计模式，它定义了一个创建对象的接口，但由子类决定要实例化的类是哪一个。工厂方法让类的实例化推迟到子类中进行。</p>
<h4 data-id="heading-4">2.2 核心思想</h4>
<ul>
<li><strong>封装对象创建</strong>：将对象的创建逻辑封装在工厂方法中</li>
<li><strong>依赖抽象而非具体</strong>：客户端依赖抽象产品和抽象工厂</li>
<li><strong>开闭原则</strong>：添加新产品时无需修改现有代码</li>
<li><strong>单一职责</strong>：将产品创建职责分离到专门的工厂类</li>
</ul>
<h4 data-id="heading-5">2.3 模式结构</h4>
<pre><code class="hljs language-scss" lang="scss">┌──────────────────────┐
│    &lt;&lt;interface&gt;&gt;     │
│      Product         │    抽象产品
├──────────────────────┤
│ + <span class="hljs-built_in">operation</span>()        │
└──────────────────────┘
           △
           │ 实现
     ┌─────┴──────┐
     │            │
┌────┴─────┐  ┌──┴────────┐
│ConcreteA │  │ConcreteB  │  具体产品
└──────────┘  └───────────┘
     △              △
     │创建          │创建
     │              │
┌────┴─────────────┴────┐
│   &lt;&lt;abstract&gt;&gt;         │
│      Creator           │    抽象创建者
├────────────────────────┤
│ + <span class="hljs-built_in">factoryMethod</span>()      │ &lt;-- 工厂方法（抽象）
│ + <span class="hljs-built_in">operation</span>()          │ &lt;-- 使用产品的业务方法
└────────────────────────┘
           △
           │ 继承
     ┌─────┴──────┐
     │            │
┌────┴────────┐  ┌┴────────────┐
│CreatorA     │  │CreatorB     │  具体创建者
├─────────────┤  ├─────────────┤
│factoryMethod│  │factoryMethod│ &lt;-- 返回具体产品
└─────────────┘  └─────────────┘

调用流程：
Client → Creator<span class="hljs-selector-class">.operation</span>() → <span class="hljs-built_in">factoryMethod</span>() → ConcreteProduct
</code></pre>
<h4 data-id="heading-6">2.4 与简单工厂的区别</h4>
<pre><code class="hljs language-scss" lang="scss">简单工厂（不是GoF23种模式之一）：
┌─────────────┐      ┌──────────────┐
│   Client    │─────→│SimpleFactory │
└─────────────┘      ├──────────────┤
                     │+ <span class="hljs-built_in">create</span>(type)│
                     └───────┬──────┘
                             │创建
                    ┌────────┼────────┐
                    ▼        ▼        ▼
               ProductA  ProductB  ProductC

工厂方法：
┌─────────────┐      ┌──────────────┐
│   Client    │─────→│   Factory    │
└─────────────┘      ├──────────────┤
                     │+ <span class="hljs-built_in">create</span>()    │抽象方法
                     └───────△──────┘
                             │
                    ┌────────┼────────┐
                    │        │        │
                FactoryA FactoryB FactoryC
                    │        │        │
                创建│    创建│    创建│
                    ▼        ▼        ▼
               ProductA  ProductB  ProductC
</code></pre>
<h3 data-id="heading-7">三、基础示例</h3>
<h4 data-id="heading-8">3.1 场景：日志记录器工厂</h4>
<p>不同的应用场景需要不同类型的日志记录器（文件日志、数据库日志、远程日志等）。</p>
<p><strong>抽象产品 - 日志记录器：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 抽象产品：日志记录器接口
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Logger</span> {
    <span class="hljs-comment">/**
     * 记录日志
     * <span class="hljs-doctag">@param</span> message 日志消息
     */</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">log</span><span class="hljs-params">(String message)</span>;

    <span class="hljs-comment">/**
     * 获取日志类型
     */</span>
    String <span class="hljs-title function_">getLoggerType</span><span class="hljs-params">()</span>;
}
</code></pre>
<p><strong>具体产品：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 具体产品：文件日志记录器
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileLogger</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Logger</span> {

    <span class="hljs-keyword">private</span> String filePath;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">FileLogger</span><span class="hljs-params">(String filePath)</span> {
        <span class="hljs-built_in">this</span>.filePath = filePath;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">log</span><span class="hljs-params">(String message)</span> {
        System.out.println(<span class="hljs-string">"[FileLogger] 写入文件 "</span> + filePath + <span class="hljs-string">": "</span> + message);
        <span class="hljs-comment">// 实际实现中会写入文件</span>
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getLoggerType</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"FILE"</span>;
    }
}

<span class="hljs-comment">/**
 * 具体产品：数据库日志记录器
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseLogger</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Logger</span> {

    <span class="hljs-keyword">private</span> String connectionString;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DatabaseLogger</span><span class="hljs-params">(String connectionString)</span> {
        <span class="hljs-built_in">this</span>.connectionString = connectionString;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">log</span><span class="hljs-params">(String message)</span> {
        System.out.println(<span class="hljs-string">"[DatabaseLogger] 写入数据库 "</span> + connectionString + <span class="hljs-string">": "</span> + message);
        <span class="hljs-comment">// 实际实现中会写入数据库</span>
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getLoggerType</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"DATABASE"</span>;
    }
}

<span class="hljs-comment">/**
 * 具体产品：控制台日志记录器
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConsoleLogger</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Logger</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">log</span><span class="hljs-params">(String message)</span> {
        System.out.println(<span class="hljs-string">"[ConsoleLogger] "</span> + message);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getLoggerType</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"CONSOLE"</span>;
    }
}
</code></pre>
<p><strong>抽象工厂：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 抽象创建者：日志工厂
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoggerFactory</span> {

    <span class="hljs-comment">/**
     * 工厂方法：创建日志记录器（由子类实现）
     */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> Logger <span class="hljs-title function_">createLogger</span><span class="hljs-params">()</span>;

    <span class="hljs-comment">/**
     * 业务方法：记录日志
     * 这个方法使用工厂方法创建的产品
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeLog</span><span class="hljs-params">(String message)</span> {
        <span class="hljs-comment">// 使用工厂方法获取日志记录器</span>
        <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> createLogger();

        <span class="hljs-comment">// 添加时间戳</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">timestamp</span> <span class="hljs-operator">=</span> java.time.LocalDateTime.now().toString();
        <span class="hljs-type">String</span> <span class="hljs-variable">formattedMessage</span> <span class="hljs-operator">=</span> <span class="hljs-string">"["</span> + timestamp + <span class="hljs-string">"] "</span> + message;

        <span class="hljs-comment">// 记录日志</span>
        logger.log(formattedMessage);

        <span class="hljs-comment">// 可以添加更多通用逻辑</span>
        System.out.println(<span class="hljs-string">"日志已通过 "</span> + logger.getLoggerType() + <span class="hljs-string">" 记录"</span>);
    }
}
</code></pre>
<p><strong>具体工厂：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 具体创建者：文件日志工厂
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileLoggerFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">LoggerFactory</span> {

    <span class="hljs-keyword">private</span> String filePath;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">FileLoggerFactory</span><span class="hljs-params">(String filePath)</span> {
        <span class="hljs-built_in">this</span>.filePath = filePath;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> Logger <span class="hljs-title function_">createLogger</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileLogger</span>(filePath);
    }
}

<span class="hljs-comment">/**
 * 具体创建者：数据库日志工厂
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseLoggerFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">LoggerFactory</span> {

    <span class="hljs-keyword">private</span> String connectionString;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DatabaseLoggerFactory</span><span class="hljs-params">(String connectionString)</span> {
        <span class="hljs-built_in">this</span>.connectionString = connectionString;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> Logger <span class="hljs-title function_">createLogger</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DatabaseLogger</span>(connectionString);
    }
}

<span class="hljs-comment">/**
 * 具体创建者：控制台日志工厂
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConsoleLoggerFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">LoggerFactory</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> Logger <span class="hljs-title function_">createLogger</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConsoleLogger</span>();
    }
}
</code></pre>
<p><strong>客户端使用：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoggerTest</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 根据配置选择不同的工厂</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">logType</span> <span class="hljs-operator">=</span> getLogTypeFromConfig(); <span class="hljs-comment">// 可以从配置文件读取</span>

        LoggerFactory factory;

        <span class="hljs-keyword">switch</span> (logType) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">"file"</span>:
                factory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileLoggerFactory</span>(<span class="hljs-string">"/var/log/app.log"</span>);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-string">"database"</span>:
                factory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DatabaseLoggerFactory</span>(<span class="hljs-string">"jdbc:mysql://localhost/logs"</span>);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">default</span>:
                factory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConsoleLoggerFactory</span>();
        }

        <span class="hljs-comment">// 客户端代码不需要知道具体的日志记录器类型</span>
        factory.writeLog(<span class="hljs-string">"应用程序启动"</span>);
        factory.writeLog(<span class="hljs-string">"用户登录成功"</span>);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getLogTypeFromConfig</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 模拟从配置读取</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"file"</span>;
    }
}
</code></pre>
<p><strong>输出：</strong></p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-attr">[FileLogger]</span> 写入文件 /<span class="hljs-selector-tag">var</span>/<span class="hljs-selector-tag">log</span>/<span class="hljs-selector-tag">app</span><span class="hljs-selector-class">.log</span>: <span class="hljs-selector-attr">[2025-01-19T10:30:00]</span> 应用程序启动
日志已通过 <span class="hljs-selector-tag">FILE</span> 记录
<span class="hljs-selector-attr">[FileLogger]</span> 写入文件 /<span class="hljs-selector-tag">var</span>/<span class="hljs-selector-tag">log</span>/<span class="hljs-selector-tag">app</span><span class="hljs-selector-class">.log</span>: <span class="hljs-selector-attr">[2025-01-19T10:30:01]</span> 用户登录成功
日志已通过 <span class="hljs-selector-tag">FILE</span> 记录
</code></pre>
<h3 data-id="heading-9">四、实际生产场景应用</h3>
<h4 data-id="heading-10">4.1 场景：数据库连接工厂</h4>
<p>在企业应用中，需要支持多种数据库（MySQL、PostgreSQL、Oracle等），每种数据库的连接方式不同。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 抽象产品：数据库连接
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DatabaseConnection</span> {
    <span class="hljs-comment">/**
     * 连接数据库
     */</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">connect</span><span class="hljs-params">()</span>;

    <span class="hljs-comment">/**
     * 执行SQL
     */</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeQuery</span><span class="hljs-params">(String sql)</span>;

    <span class="hljs-comment">/**
     * 断开连接
     */</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">disconnect</span><span class="hljs-params">()</span>;

    <span class="hljs-comment">/**
     * 获取数据库类型
     */</span>
    String <span class="hljs-title function_">getDatabaseType</span><span class="hljs-params">()</span>;
}

<span class="hljs-comment">/**
 * 具体产品：MySQL连接
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MySqlConnection</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DatabaseConnection</span> {

    <span class="hljs-keyword">private</span> String host;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> port;
    <span class="hljs-keyword">private</span> String database;
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">connected</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MySqlConnection</span><span class="hljs-params">(String host, <span class="hljs-type">int</span> port, String database)</span> {
        <span class="hljs-built_in">this</span>.host = host;
        <span class="hljs-built_in">this</span>.port = port;
        <span class="hljs-built_in">this</span>.database = database;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">connect</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"连接到 MySQL: "</span> + host + <span class="hljs-string">":"</span> + port + <span class="hljs-string">"/"</span> + database);
        <span class="hljs-comment">// 实际实现：使用JDBC连接MySQL</span>
        <span class="hljs-comment">// Connection conn = DriverManager.getConnection(url, user, password);</span>
        connected = <span class="hljs-literal">true</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeQuery</span><span class="hljs-params">(String sql)</span> {
        <span class="hljs-keyword">if</span> (!connected) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"未连接到数据库"</span>);
        }
        System.out.println(<span class="hljs-string">"[MySQL] 执行SQL: "</span> + sql);
        <span class="hljs-comment">// 实际实现：执行SQL查询</span>
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">disconnect</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"断开 MySQL 连接"</span>);
        connected = <span class="hljs-literal">false</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDatabaseType</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"MySQL"</span>;
    }
}

<span class="hljs-comment">/**
 * 具体产品：PostgreSQL连接
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PostgreSqlConnection</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DatabaseConnection</span> {

    <span class="hljs-keyword">private</span> String host;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> port;
    <span class="hljs-keyword">private</span> String database;
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">connected</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PostgreSqlConnection</span><span class="hljs-params">(String host, <span class="hljs-type">int</span> port, String database)</span> {
        <span class="hljs-built_in">this</span>.host = host;
        <span class="hljs-built_in">this</span>.port = port;
        <span class="hljs-built_in">this</span>.database = database;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">connect</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"连接到 PostgreSQL: "</span> + host + <span class="hljs-string">":"</span> + port + <span class="hljs-string">"/"</span> + database);
        connected = <span class="hljs-literal">true</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeQuery</span><span class="hljs-params">(String sql)</span> {
        <span class="hljs-keyword">if</span> (!connected) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"未连接到数据库"</span>);
        }
        System.out.println(<span class="hljs-string">"[PostgreSQL] 执行SQL: "</span> + sql);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">disconnect</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"断开 PostgreSQL 连接"</span>);
        connected = <span class="hljs-literal">false</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDatabaseType</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"PostgreSQL"</span>;
    }
}

<span class="hljs-comment">/**
 * 具体产品：Oracle连接
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OracleConnection</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DatabaseConnection</span> {

    <span class="hljs-keyword">private</span> String host;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> port;
    <span class="hljs-keyword">private</span> String sid;
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">connected</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OracleConnection</span><span class="hljs-params">(String host, <span class="hljs-type">int</span> port, String sid)</span> {
        <span class="hljs-built_in">this</span>.host = host;
        <span class="hljs-built_in">this</span>.port = port;
        <span class="hljs-built_in">this</span>.sid = sid;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">connect</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"连接到 Oracle: "</span> + host + <span class="hljs-string">":"</span> + port + <span class="hljs-string">" SID="</span> + sid);
        connected = <span class="hljs-literal">true</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeQuery</span><span class="hljs-params">(String sql)</span> {
        <span class="hljs-keyword">if</span> (!connected) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"未连接到数据库"</span>);
        }
        System.out.println(<span class="hljs-string">"[Oracle] 执行SQL: "</span> + sql);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">disconnect</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"断开 Oracle 连接"</span>);
        connected = <span class="hljs-literal">false</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDatabaseType</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Oracle"</span>;
    }
}
</code></pre>
<p><strong>抽象工厂和具体工厂：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 抽象创建者：数据库连接工厂
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseConnectionFactory</span> {

    <span class="hljs-comment">/**
     * 工厂方法：创建数据库连接
     */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> DatabaseConnection <span class="hljs-title function_">createConnection</span><span class="hljs-params">()</span>;

    <span class="hljs-comment">/**
     * 模板方法：执行数据库操作
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeOperation</span><span class="hljs-params">(String sql)</span> {
        <span class="hljs-type">DatabaseConnection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 创建连接</span>
            connection = createConnection();

            <span class="hljs-comment">// 2. 连接数据库</span>
            connection.connect();

            <span class="hljs-comment">// 3. 执行SQL</span>
            connection.executeQuery(sql);

        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"数据库操作失败: "</span> + e.getMessage());
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 4. 关闭连接</span>
            <span class="hljs-keyword">if</span> (connection != <span class="hljs-literal">null</span>) {
                connection.disconnect();
            }
        }
    }

    <span class="hljs-comment">/**
     * 获取连接池（高级功能）
     */</span>
    <span class="hljs-keyword">public</span> DatabaseConnection <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> createConnection();
    }
}

<span class="hljs-comment">/**
 * 具体创建者：MySQL连接工厂
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MySqlConnectionFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DatabaseConnectionFactory</span> {

    <span class="hljs-keyword">private</span> String host;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> port;
    <span class="hljs-keyword">private</span> String database;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MySqlConnectionFactory</span><span class="hljs-params">(String host, <span class="hljs-type">int</span> port, String database)</span> {
        <span class="hljs-built_in">this</span>.host = host;
        <span class="hljs-built_in">this</span>.port = port;
        <span class="hljs-built_in">this</span>.database = database;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> DatabaseConnection <span class="hljs-title function_">createConnection</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MySqlConnection</span>(host, port, database);
    }
}

<span class="hljs-comment">/**
 * 具体创建者：PostgreSQL连接工厂
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PostgreSqlConnectionFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DatabaseConnectionFactory</span> {

    <span class="hljs-keyword">private</span> String host;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> port;
    <span class="hljs-keyword">private</span> String database;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PostgreSqlConnectionFactory</span><span class="hljs-params">(String host, <span class="hljs-type">int</span> port, String database)</span> {
        <span class="hljs-built_in">this</span>.host = host;
        <span class="hljs-built_in">this</span>.port = port;
        <span class="hljs-built_in">this</span>.database = database;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> DatabaseConnection <span class="hljs-title function_">createConnection</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PostgreSqlConnection</span>(host, port, database);
    }
}

<span class="hljs-comment">/**
 * 具体创建者：Oracle连接工厂
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OracleConnectionFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DatabaseConnectionFactory</span> {

    <span class="hljs-keyword">private</span> String host;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> port;
    <span class="hljs-keyword">private</span> String sid;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OracleConnectionFactory</span><span class="hljs-params">(String host, <span class="hljs-type">int</span> port, String sid)</span> {
        <span class="hljs-built_in">this</span>.host = host;
        <span class="hljs-built_in">this</span>.port = port;
        <span class="hljs-built_in">this</span>.sid = sid;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> DatabaseConnection <span class="hljs-title function_">createConnection</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OracleConnection</span>(host, port, sid);
    }
}
</code></pre>
<p><strong>客户端使用：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseTest</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 从配置文件读取数据库类型</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">dbType</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">"db.type"</span>, <span class="hljs-string">"mysql"</span>);

        <span class="hljs-comment">// 根据配置创建对应的工厂</span>
        <span class="hljs-type">DatabaseConnectionFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> createFactory(dbType);

        <span class="hljs-comment">// 执行数据库操作（客户端不需要知道具体数据库类型）</span>
        factory.executeOperation(<span class="hljs-string">"SELECT * FROM users WHERE id = 1"</span>);
        factory.executeOperation(<span class="hljs-string">"INSERT INTO logs VALUES (1, 'test')"</span>);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> DatabaseConnectionFactory <span class="hljs-title function_">createFactory</span><span class="hljs-params">(String dbType)</span> {
        <span class="hljs-keyword">switch</span> (dbType.toLowerCase()) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">"mysql"</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MySqlConnectionFactory</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">3306</span>, <span class="hljs-string">"mydb"</span>);
            <span class="hljs-keyword">case</span> <span class="hljs-string">"postgresql"</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PostgreSqlConnectionFactory</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">5432</span>, <span class="hljs-string">"mydb"</span>);
            <span class="hljs-keyword">case</span> <span class="hljs-string">"oracle"</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OracleConnectionFactory</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">1521</span>, <span class="hljs-string">"ORCL"</span>);
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"不支持的数据库类型: "</span> + dbType);
        }
    }
}
</code></pre>
<h4 data-id="heading-11">4.2 场景：消息推送工厂</h4>
<p>在现代应用中，需要支持多种消息推送渠道（邮件、短信、微信、App推送等）。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 抽象产品：消息推送器
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MessagePusher</span> {
    <span class="hljs-comment">/**
     * 发送消息
     */</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">send</span><span class="hljs-params">(String recipient, String title, String content)</span>;

    <span class="hljs-comment">/**
     * 批量发送
     */</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">batchSend</span><span class="hljs-params">(java.util.List&lt;String&gt; recipients, String title, String content)</span>;

    <span class="hljs-comment">/**
     * 获取推送类型
     */</span>
    String <span class="hljs-title function_">getPusherType</span><span class="hljs-params">()</span>;
}

<span class="hljs-comment">/**
 * 具体产品：邮件推送
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmailPusher</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MessagePusher</span> {

    <span class="hljs-keyword">private</span> String smtpServer;
    <span class="hljs-keyword">private</span> String username;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">EmailPusher</span><span class="hljs-params">(String smtpServer, String username)</span> {
        <span class="hljs-built_in">this</span>.smtpServer = smtpServer;
        <span class="hljs-built_in">this</span>.username = username;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">send</span><span class="hljs-params">(String recipient, String title, String content)</span> {
        System.out.println(<span class="hljs-string">"=== 发送邮件 ==="</span>);
        System.out.println(<span class="hljs-string">"SMTP服务器: "</span> + smtpServer);
        System.out.println(<span class="hljs-string">"发件人: "</span> + username);
        System.out.println(<span class="hljs-string">"收件人: "</span> + recipient);
        System.out.println(<span class="hljs-string">"主题: "</span> + title);
        System.out.println(<span class="hljs-string">"内容: "</span> + content);
        <span class="hljs-comment">// 实际实现：使用JavaMail API发送邮件</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">batchSend</span><span class="hljs-params">(java.util.List&lt;String&gt; recipients, String title, String content)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">successCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (String recipient : recipients) {
            <span class="hljs-keyword">if</span> (send(recipient, title, content)) {
                successCount++;
            }
        }
        <span class="hljs-keyword">return</span> successCount;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPusherType</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"EMAIL"</span>;
    }
}

<span class="hljs-comment">/**
 * 具体产品：短信推送
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SmsPusher</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MessagePusher</span> {

    <span class="hljs-keyword">private</span> String apiKey;
    <span class="hljs-keyword">private</span> String gateway;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SmsPusher</span><span class="hljs-params">(String apiKey, String gateway)</span> {
        <span class="hljs-built_in">this</span>.apiKey = apiKey;
        <span class="hljs-built_in">this</span>.gateway = gateway;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">send</span><span class="hljs-params">(String recipient, String title, String content)</span> {
        System.out.println(<span class="hljs-string">"=== 发送短信 ==="</span>);
        System.out.println(<span class="hljs-string">"网关: "</span> + gateway);
        System.out.println(<span class="hljs-string">"收件人: "</span> + recipient);
        System.out.println(<span class="hljs-string">"内容: "</span> + content);
        <span class="hljs-comment">// 实际实现：调用短信网关API</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">batchSend</span><span class="hljs-params">(java.util.List&lt;String&gt; recipients, String title, String content)</span> {
        System.out.println(<span class="hljs-string">"批量发送短信到 "</span> + recipients.size() + <span class="hljs-string">" 个号码"</span>);
        <span class="hljs-comment">// 实际实现：调用批量短信API</span>
        <span class="hljs-keyword">return</span> recipients.size();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPusherType</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"SMS"</span>;
    }
}

<span class="hljs-comment">/**
 * 具体产品：微信推送
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeChatPusher</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MessagePusher</span> {

    <span class="hljs-keyword">private</span> String appId;
    <span class="hljs-keyword">private</span> String appSecret;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">WeChatPusher</span><span class="hljs-params">(String appId, String appSecret)</span> {
        <span class="hljs-built_in">this</span>.appId = appId;
        <span class="hljs-built_in">this</span>.appSecret = appSecret;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">send</span><span class="hljs-params">(String recipient, String title, String content)</span> {
        System.out.println(<span class="hljs-string">"=== 发送微信消息 ==="</span>);
        System.out.println(<span class="hljs-string">"AppID: "</span> + appId);
        System.out.println(<span class="hljs-string">"OpenID: "</span> + recipient);
        System.out.println(<span class="hljs-string">"标题: "</span> + title);
        System.out.println(<span class="hljs-string">"内容: "</span> + content);
        <span class="hljs-comment">// 实际实现：调用微信模板消息API</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">batchSend</span><span class="hljs-params">(java.util.List&lt;String&gt; recipients, String title, String content)</span> {
        System.out.println(<span class="hljs-string">"批量发送微信消息到 "</span> + recipients.size() + <span class="hljs-string">" 个用户"</span>);
        <span class="hljs-keyword">return</span> recipients.size();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPusherType</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"WECHAT"</span>;
    }
}

<span class="hljs-comment">/**
 * 抽象工厂：消息推送工厂
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MessagePusherFactory</span> {

    <span class="hljs-comment">/**
     * 工厂方法
     */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> MessagePusher <span class="hljs-title function_">createPusher</span><span class="hljs-params">()</span>;

    <span class="hljs-comment">/**
     * 发送通知（带重试机制）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">sendNotification</span><span class="hljs-params">(String recipient, String title, String content)</span> {
        <span class="hljs-type">MessagePusher</span> <span class="hljs-variable">pusher</span> <span class="hljs-operator">=</span> createPusher();

        <span class="hljs-comment">// 添加重试逻辑</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">maxRetries</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; maxRetries; i++) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> pusher.send(recipient, title, content);
                <span class="hljs-keyword">if</span> (success) {
                    logSuccess(pusher, recipient);
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                }
            } <span class="hljs-keyword">catch</span> (Exception e) {
                System.err.println(<span class="hljs-string">"发送失败，第 "</span> + (i + <span class="hljs-number">1</span>) + <span class="hljs-string">" 次重试"</span>);
            }
        }

        logFailure(pusher, recipient);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logSuccess</span><span class="hljs-params">(MessagePusher pusher, String recipient)</span> {
        System.out.println(<span class="hljs-string">"[SUCCESS] "</span> + pusher.getPusherType() + <span class="hljs-string">" 消息发送成功: "</span> + recipient);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logFailure</span><span class="hljs-params">(MessagePusher pusher, String recipient)</span> {
        System.err.println(<span class="hljs-string">"[FAILURE] "</span> + pusher.getPusherType() + <span class="hljs-string">" 消息发送失败: "</span> + recipient);
    }
}

<span class="hljs-comment">/**
 * 具体工厂实现
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmailPusherFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MessagePusherFactory</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> MessagePusher <span class="hljs-title function_">createPusher</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EmailPusher</span>(<span class="hljs-string">"smtp.example.com"</span>, <span class="hljs-string">"noreply@example.com"</span>);
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SmsPusherFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MessagePusherFactory</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> MessagePusher <span class="hljs-title function_">createPusher</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SmsPusher</span>(<span class="hljs-string">"your-api-key"</span>, <span class="hljs-string">"https://sms.gateway.com"</span>);
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeChatPusherFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MessagePusherFactory</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> MessagePusher <span class="hljs-title function_">createPusher</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeChatPusher</span>(<span class="hljs-string">"wx1234567890"</span>, <span class="hljs-string">"your-app-secret"</span>);
    }
}
</code></pre>
<h3 data-id="heading-12">五、开源框架中的应用</h3>
<h4 data-id="heading-13">5.1 JDK中的应用</h4>
<p><strong>Collection接口的iterator()方法：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.*;

<span class="hljs-comment">/**
 * JDK中最典型的工厂方法模式应用
 * Collection接口定义了iterator()工厂方法
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdkIteratorExample</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// ArrayList实现了iterator()工厂方法</span>
        Collection&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        list.add(<span class="hljs-string">"Java"</span>);
        list.add(<span class="hljs-string">"Python"</span>);
        list.add(<span class="hljs-string">"Go"</span>);

        <span class="hljs-comment">// iterator()是工厂方法，返回Iterator对象</span>
        Iterator&lt;String&gt; iterator = list.iterator();

        <span class="hljs-keyword">while</span> (iterator.hasNext()) {
            System.out.println(iterator.next());
        }

        <span class="hljs-comment">// HashSet也实现了iterator()工厂方法，返回不同的迭代器实现</span>
        Collection&lt;String&gt; set = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();
        set.add(<span class="hljs-string">"A"</span>);
        set.add(<span class="hljs-string">"B"</span>);

        Iterator&lt;String&gt; setIterator = set.iterator();
        <span class="hljs-comment">// 使用方式相同，但内部实现不同</span>
    }
}

<span class="hljs-comment">/**
 * 简化的Collection接口结构
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">SimpleCollection</span>&lt;E&gt; {
    <span class="hljs-comment">/**
     * 工厂方法：由具体集合类实现
     */</span>
    Iterator&lt;E&gt; <span class="hljs-title function_">iterator</span><span class="hljs-params">()</span>;

    <span class="hljs-type">boolean</span> <span class="hljs-title function_">add</span><span class="hljs-params">(E e)</span>;
    <span class="hljs-type">int</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span>;
}

<span class="hljs-comment">/**
 * 具体实现：ArrayList
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleArrayList</span>&lt;E&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SimpleCollection</span>&lt;E&gt; {
    <span class="hljs-keyword">private</span> Object[] elements = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">10</span>];
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Iterator&lt;E&gt; <span class="hljs-title function_">iterator</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 返回ArrayList特定的迭代器</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayListIterator</span>();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">add</span><span class="hljs-params">(E e)</span> {
        elements[size++] = e;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> size;
    }

    <span class="hljs-comment">/**
     * ArrayList的迭代器实现
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArrayListIterator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Iterator</span>&lt;E&gt; {
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">cursor</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasNext</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> cursor &lt; size;
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
        <span class="hljs-keyword">public</span> E <span class="hljs-title function_">next</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">if</span> (!hasNext()) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoSuchElementException</span>();
            }
            <span class="hljs-keyword">return</span> (E) elements[cursor++];
        }
    }
}

<span class="hljs-comment">/**
 * 具体实现：LinkedList
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleLinkedList</span>&lt;E&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SimpleCollection</span>&lt;E&gt; {
    <span class="hljs-keyword">private</span> Node&lt;E&gt; first;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Iterator&lt;E&gt; <span class="hljs-title function_">iterator</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 返回LinkedList特定的迭代器</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedListIterator</span>();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">add</span><span class="hljs-params">(E e)</span> {
        Node&lt;E&gt; newNode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>&lt;&gt;(e);
        <span class="hljs-keyword">if</span> (first == <span class="hljs-literal">null</span>) {
            first = newNode;
        } <span class="hljs-keyword">else</span> {
            Node&lt;E&gt; current = first;
            <span class="hljs-keyword">while</span> (current.next != <span class="hljs-literal">null</span>) {
                current = current.next;
            }
            current.next = newNode;
        }
        size++;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> size;
    }

    <span class="hljs-comment">/**
     * LinkedList的迭代器实现
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LinkedListIterator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Iterator</span>&lt;E&gt; {
        <span class="hljs-keyword">private</span> Node&lt;E&gt; current = first;

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasNext</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> current != <span class="hljs-literal">null</span>;
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> E <span class="hljs-title function_">next</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">if</span> (!hasNext()) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoSuchElementException</span>();
            }
            <span class="hljs-type">E</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> current.data;
            current = current.next;
            <span class="hljs-keyword">return</span> data;
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span>&lt;E&gt; {
        E data;
        Node&lt;E&gt; next;

        Node(E data) {
            <span class="hljs-built_in">this</span>.data = data;
        }
    }
}
</code></pre>
<h4 data-id="heading-14">5.2 JDBC中的DriverManager</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.sql.*;

<span class="hljs-comment">/**
 * JDBC的DriverManager是工厂方法模式的经典应用
 * getConnection()方法根据URL选择合适的Driver创建Connection
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdbcFactoryExample</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">demonstrateJdbcFactory</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">// DriverManager.getConnection()是静态工厂方法</span>
        <span class="hljs-comment">// 根据URL前缀选择对应的Driver</span>

        <span class="hljs-comment">// MySQL Driver</span>
        <span class="hljs-type">Connection</span> <span class="hljs-variable">mysqlConn</span> <span class="hljs-operator">=</span> DriverManager.getConnection(
            <span class="hljs-string">"jdbc:mysql://localhost:3306/mydb"</span>,
            <span class="hljs-string">"user"</span>,
            <span class="hljs-string">"password"</span>
        );

        <span class="hljs-comment">// PostgreSQL Driver</span>
        <span class="hljs-type">Connection</span> <span class="hljs-variable">pgConn</span> <span class="hljs-operator">=</span> DriverManager.getConnection(
            <span class="hljs-string">"jdbc:postgresql://localhost:5432/mydb"</span>,
            <span class="hljs-string">"user"</span>,
            <span class="hljs-string">"password"</span>
        );

        <span class="hljs-comment">// 客户端代码使用相同的Connection接口</span>
        <span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> mysqlConn.createStatement();
        <span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> stmt.executeQuery(<span class="hljs-string">"SELECT * FROM users"</span>);
    }
}

<span class="hljs-comment">/**
 * 简化的JDBC工厂方法模式实现
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Driver</span> {
    Connection <span class="hljs-title function_">connect</span><span class="hljs-params">(String url, java.util.Properties info)</span> <span class="hljs-keyword">throws</span> SQLException;
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">acceptsURL</span><span class="hljs-params">(String url)</span> <span class="hljs-keyword">throws</span> SQLException;
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DriverManager</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> java.util.List&lt;Driver&gt; registeredDrivers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.util.ArrayList&lt;&gt;();

    <span class="hljs-comment">/**
     * 工厂方法：根据URL创建合适的Connection
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">(String url, String user, String password)</span>
            <span class="hljs-keyword">throws</span> SQLException {

        <span class="hljs-comment">// 遍历注册的Driver，找到能处理该URL的Driver</span>
        <span class="hljs-keyword">for</span> (Driver driver : registeredDrivers) {
            <span class="hljs-keyword">if</span> (driver.acceptsURL(url)) {
                java.util.<span class="hljs-type">Properties</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.util.Properties();
                info.put(<span class="hljs-string">"user"</span>, user);
                info.put(<span class="hljs-string">"password"</span>, password);

                <span class="hljs-comment">// 使用找到的Driver创建Connection</span>
                <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> driver.connect(url, info);
                <span class="hljs-keyword">if</span> (conn != <span class="hljs-literal">null</span>) {
                    <span class="hljs-keyword">return</span> conn;
                }
            }
        }

        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SQLException</span>(<span class="hljs-string">"No suitable driver found for "</span> + url);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerDriver</span><span class="hljs-params">(Driver driver)</span> {
        registeredDrivers.add(driver);
    }
}
</code></pre>
<h4 data-id="heading-15">5.3 Spring Framework中的FactoryBean</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.FactoryBean;

<span class="hljs-comment">/**
 * Spring的FactoryBean是工厂方法模式的应用
 * 用于创建复杂对象或需要特殊初始化的对象
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectionPoolFactoryBean</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FactoryBean</span>&lt;ConnectionPool&gt; {

    <span class="hljs-keyword">private</span> String driverClassName;
    <span class="hljs-keyword">private</span> String url;
    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> String password;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">maxConnections</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;

    <span class="hljs-comment">/**
     * 工厂方法：创建ConnectionPool对象
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> ConnectionPool <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">ConnectionPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionPool</span>();
        pool.setDriverClassName(driverClassName);
        pool.setUrl(url);
        pool.setUsername(username);
        pool.setPassword(password);
        pool.setMaxConnections(maxConnections);

        <span class="hljs-comment">// 初始化连接池</span>
        pool.initialize();

        <span class="hljs-keyword">return</span> pool;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Class&lt;?&gt; getObjectType() {
        <span class="hljs-keyword">return</span> ConnectionPool.class;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isSingleton</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-comment">// Setters for dependency injection</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setDriverClassName</span><span class="hljs-params">(String driverClassName)</span> {
        <span class="hljs-built_in">this</span>.driverClassName = driverClassName;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUrl</span><span class="hljs-params">(String url)</span> {
        <span class="hljs-built_in">this</span>.url = url;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUsername</span><span class="hljs-params">(String username)</span> {
        <span class="hljs-built_in">this</span>.username = username;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPassword</span><span class="hljs-params">(String password)</span> {
        <span class="hljs-built_in">this</span>.password = password;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setMaxConnections</span><span class="hljs-params">(<span class="hljs-type">int</span> maxConnections)</span> {
        <span class="hljs-built_in">this</span>.maxConnections = maxConnections;
    }
}

<span class="hljs-comment">/**
 * 连接池类
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectionPool</span> {
    <span class="hljs-keyword">private</span> String driverClassName;
    <span class="hljs-keyword">private</span> String url;
    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> String password;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> maxConnections;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initialize</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"初始化连接池: "</span> + url);
        <span class="hljs-comment">// 创建初始连接</span>
    }

    <span class="hljs-comment">// Getters and Setters</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setDriverClassName</span><span class="hljs-params">(String driverClassName)</span> {
        <span class="hljs-built_in">this</span>.driverClassName = driverClassName;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUrl</span><span class="hljs-params">(String url)</span> {
        <span class="hljs-built_in">this</span>.url = url;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUsername</span><span class="hljs-params">(String username)</span> {
        <span class="hljs-built_in">this</span>.username = username;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPassword</span><span class="hljs-params">(String password)</span> {
        <span class="hljs-built_in">this</span>.password = password;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setMaxConnections</span><span class="hljs-params">(<span class="hljs-type">int</span> maxConnections)</span> {
        <span class="hljs-built_in">this</span>.maxConnections = maxConnections;
    }
}

<span class="hljs-comment">/**
 * Spring配置文件使用示例：
 *
 * &lt;bean id="connectionPool" class="com.example.ConnectionPoolFactoryBean"&gt;
 *     &lt;property name="driverClassName" value="com.mysql.jdbc.Driver"/&gt;
 *     &lt;property name="url" value="jdbc:mysql://localhost:3306/mydb"/&gt;
 *     &lt;property name="username" value="root"/&gt;
 *     &lt;property name="password" value="password"/&gt;
 *     &lt;property name="maxConnections" value="20"/&gt;
 * &lt;/bean&gt;
 *
 * 当获取connectionPool bean时，实际得到的是FactoryBean.getObject()返回的对象
 */</span>
</code></pre>
<h4 data-id="heading-16">5.4 Guava中的LoadingCache</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.google.common.cache.CacheBuilder;
<span class="hljs-keyword">import</span> com.google.common.cache.CacheLoader;
<span class="hljs-keyword">import</span> com.google.common.cache.LoadingCache;

<span class="hljs-comment">/**
 * Guava的CacheBuilder使用工厂方法模式
 * CacheLoader.load()是工厂方法，用于创建缓存值
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GuavaCacheFactoryExample</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// CacheLoader定义了如何创建缓存值</span>
        LoadingCache&lt;String, User&gt; userCache = CacheBuilder.newBuilder()
            .maximumSize(<span class="hljs-number">1000</span>)
            .build(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheLoader</span>&lt;String, User&gt;() {
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> User <span class="hljs-title function_">load</span><span class="hljs-params">(String userId)</span> <span class="hljs-keyword">throws</span> Exception {
                    <span class="hljs-comment">// 工厂方法：当缓存中没有该key时，调用此方法创建对象</span>
                    <span class="hljs-keyword">return</span> loadUserFromDatabase(userId);
                }
            });

        <span class="hljs-comment">// 使用缓存</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">user1</span> <span class="hljs-operator">=</span> userCache.get(<span class="hljs-string">"user123"</span>); <span class="hljs-comment">// 第一次访问，调用load()</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">user2</span> <span class="hljs-operator">=</span> userCache.get(<span class="hljs-string">"user123"</span>); <span class="hljs-comment">// 第二次访问，直接从缓存获取</span>

        System.out.println(<span class="hljs-string">"两次获取的是同一个对象: "</span> + (user1 == user2));
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> User <span class="hljs-title function_">loadUserFromDatabase</span><span class="hljs-params">(String userId)</span> {
        System.out.println(<span class="hljs-string">"从数据库加载用户: "</span> + userId);
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
        user.setName(<span class="hljs-string">"User-"</span> + userId);
        user.setEmail(userId + <span class="hljs-string">"@example.com"</span>);
        <span class="hljs-keyword">return</span> user;
    }
}

<span class="hljs-comment">/**
 * 自定义实现类似的缓存工厂
 */</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataLoader</span>&lt;K, V&gt; {
    <span class="hljs-keyword">private</span> java.util.Map&lt;K, V&gt; cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.util.HashMap&lt;&gt;();

    <span class="hljs-comment">/**
     * 工厂方法：由子类实现具体的加载逻辑
     */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> V <span class="hljs-title function_">load</span><span class="hljs-params">(K key)</span> <span class="hljs-keyword">throws</span> Exception;

    <span class="hljs-comment">/**
     * 获取数据（带缓存）
     */</span>
    <span class="hljs-keyword">public</span> V <span class="hljs-title function_">get</span><span class="hljs-params">(K key)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">if</span> (cache.containsKey(key)) {
            <span class="hljs-keyword">return</span> cache.get(key);
        }

        <span class="hljs-comment">// 调用工厂方法创建对象</span>
        <span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> load(key);
        cache.put(key, value);
        <span class="hljs-keyword">return</span> value;
    }
}

<span class="hljs-comment">/**
 * 具体实现：用户数据加载器
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDataLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DataLoader</span>&lt;String, User&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> User <span class="hljs-title function_">load</span><span class="hljs-params">(String userId)</span> <span class="hljs-keyword">throws</span> Exception {
        System.out.println(<span class="hljs-string">"从数据源加载用户: "</span> + userId);
        <span class="hljs-comment">// 实际实现：从数据库、API等加载数据</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
        user.setName(<span class="hljs-string">"User-"</span> + userId);
        <span class="hljs-keyword">return</span> user;
    }
}
</code></pre>
<h3 data-id="heading-17">六、工厂方法模式的优缺点</h3>
<h4 data-id="heading-18">6.1 优点</h4>
<p><strong>1. 符合开闭原则</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">添加新产品时的变化：

不使用工厂方法：
❌ 修改客户端代码中的<span class="hljs-keyword">switch</span>/<span class="hljs-keyword">if</span>语句
❌ 直接在代码中<span class="hljs-keyword">new</span>具体类

使用工厂方法：
✓ 创建新的产品类
✓ 创建新的工厂类
✓ 客户端代码无需修改
</code></pre>
<p><strong>2. 符合单一职责原则</strong></p>
<ul>
<li>产品创建逻辑集中在工厂类中</li>
<li>客户端只关注产品的使用，不关心创建细节</li>
</ul>
<p><strong>3. 符合依赖倒置原则</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">依赖关系：

<span class="hljs-built_in">Client</span> → AbstractFactory → AbstractProduct
              ↑                  ↑
              │                  │
      ConcreteFactory    ConcreteProduct

客户端依赖抽象，不依赖具体实现
</code></pre>
<p><strong>4. 提高代码复用性</strong></p>
<ul>
<li>通用的创建逻辑可以在抽象工厂中实现</li>
<li>子类只需实现特定的创建细节</li>
</ul>
<h4 data-id="heading-19">6.2 缺点</h4>
<p><strong>1. 类的数量增加</strong></p>
<pre><code class="hljs language-diff" lang="diff">每增加一个产品：
<span class="hljs-deletion">- 1个具体产品类</span>
<span class="hljs-deletion">- 1个具体工厂类</span>

产品种类多时，类的数量会快速增长
</code></pre>
<p><strong>2. 增加系统复杂度</strong></p>
<ul>
<li>引入了额外的抽象层</li>
<li>需要理解工厂和产品的关系</li>
</ul>
<p><strong>3. 增加理解难度</strong></p>
<ul>
<li>对象创建逻辑分散在多个类中</li>
<li>新手可能难以快速定位代码</li>
</ul>
<h3 data-id="heading-20">七、最佳实践</h3>
<h4 data-id="heading-21">7.1 使用配置文件驱动工厂选择</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.io.InputStream;
<span class="hljs-keyword">import</span> java.util.Properties;

<span class="hljs-comment">/**
 * 使用配置文件选择工厂
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigDrivenFactory</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Properties</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> ConfigDrivenFactory.class
                .getResourceAsStream(<span class="hljs-string">"/factory.properties"</span>)) {
            config.load(is);
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
    }

    <span class="hljs-comment">/**
     * 根据配置创建工厂
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> LoggerFactory <span class="hljs-title function_">createLoggerFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">logType</span> <span class="hljs-operator">=</span> config.getProperty(<span class="hljs-string">"logger.type"</span>, <span class="hljs-string">"console"</span>);

        <span class="hljs-keyword">switch</span> (logType) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">"file"</span>:
                <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> config.getProperty(<span class="hljs-string">"logger.file.path"</span>, <span class="hljs-string">"/tmp/app.log"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileLoggerFactory</span>(filePath);
            <span class="hljs-keyword">case</span> <span class="hljs-string">"database"</span>:
                <span class="hljs-type">String</span> <span class="hljs-variable">connStr</span> <span class="hljs-operator">=</span> config.getProperty(<span class="hljs-string">"logger.db.connection"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DatabaseLoggerFactory</span>(connStr);
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConsoleLoggerFactory</span>();
        }
    }
}

<span class="hljs-comment">/**
 * factory.properties配置文件内容：
 *
 * logger.type=file
 * logger.file.path=/var/log/application.log
 *
 * # 或者
 * logger.type=database
 * logger.db.connection=jdbc:mysql://localhost/logs
 */</span>
</code></pre>
<h4 data-id="heading-22">7.2 结合反射实现通用工厂</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 使用反射的通用工厂
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReflectionFactory</span>&lt;T&gt; {

    <span class="hljs-keyword">private</span> Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">T</span>&gt; productClass;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ReflectionFactory</span><span class="hljs-params">(Class&lt;? extends T&gt; productClass)</span> {
        <span class="hljs-built_in">this</span>.productClass = productClass;
    }

    <span class="hljs-comment">/**
     * 工厂方法：使用反射创建对象
     */</span>
    <span class="hljs-keyword">public</span> T <span class="hljs-title function_">createProduct</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> productClass.getDeclaredConstructor().newInstance();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"无法创建对象: "</span> + productClass.getName(), e);
        }
    }

    <span class="hljs-comment">/**
     * 带参数的工厂方法
     */</span>
    <span class="hljs-keyword">public</span> T <span class="hljs-title function_">createProduct</span><span class="hljs-params">(Object... args)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 获取参数类型</span>
            Class&lt;?&gt;[] paramTypes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[args.length];
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; args.length; i++) {
                paramTypes[i] = args[i].getClass();
            }

            <span class="hljs-comment">// 获取构造函数并创建对象</span>
            <span class="hljs-keyword">return</span> productClass.getDeclaredConstructor(paramTypes).newInstance(args);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"无法创建对象: "</span> + productClass.getName(), e);
        }
    }
}

<span class="hljs-comment">/**
 * 使用示例
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ReflectionFactoryTest</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 创建ConsoleLogger</span>
        ReflectionFactory&lt;Logger&gt; factory1 =
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionFactory</span>&lt;&gt;(ConsoleLogger.class);
        <span class="hljs-type">Logger</span> <span class="hljs-variable">logger1</span> <span class="hljs-operator">=</span> factory1.createProduct();
        logger1.log(<span class="hljs-string">"测试消息"</span>);

        <span class="hljs-comment">// 创建FileLogger（带参数）</span>
        ReflectionFactory&lt;Logger&gt; factory2 =
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionFactory</span>&lt;&gt;(FileLogger.class);
        <span class="hljs-type">Logger</span> <span class="hljs-variable">logger2</span> <span class="hljs-operator">=</span> factory2.createProduct(<span class="hljs-string">"/tmp/test.log"</span>);
        logger2.log(<span class="hljs-string">"测试消息"</span>);
    }
}
</code></pre>
<h4 data-id="heading-23">7.3 使用注解标记工厂</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.lang.annotation.*;

<span class="hljs-comment">/**
 * 工厂注解
 */</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Target(ElementType.TYPE)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> FactoryProduct {
    String <span class="hljs-title function_">type</span><span class="hljs-params">()</span>;
}

<span class="hljs-comment">/**
 * 使用注解标记产品类型
 */</span>
<span class="hljs-meta">@FactoryProduct(type = "console")</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ConsoleLoggerV2</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Logger</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">log</span><span class="hljs-params">(String message)</span> {
        System.out.println(message);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getLoggerType</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"CONSOLE"</span>;
    }
}

<span class="hljs-meta">@FactoryProduct(type = "file")</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">FileLoggerV2</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Logger</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">log</span><span class="hljs-params">(String message)</span> {
        System.out.println(<span class="hljs-string">"[File] "</span> + message);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getLoggerType</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"FILE"</span>;
    }
}

<span class="hljs-comment">/**
 * 基于注解的工厂
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AnnotationBasedFactory</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> java.util.Map&lt;String, Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Logger</span>&gt;&gt; registry =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.util.HashMap&lt;&gt;();

    <span class="hljs-comment">/**
     * 注册所有带<span class="hljs-doctag">@FactoryProduct</span>注解的类
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">scanAndRegister</span><span class="hljs-params">(String packageName)</span> {
        <span class="hljs-comment">// 简化实现，实际需要使用classpath扫描</span>
        registerProduct(ConsoleLoggerV2.class);
        registerProduct(FileLoggerV2.class);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerProduct</span><span class="hljs-params">(Class&lt;? extends Logger&gt; clazz)</span> {
        <span class="hljs-type">FactoryProduct</span> <span class="hljs-variable">annotation</span> <span class="hljs-operator">=</span> clazz.getAnnotation(FactoryProduct.class);
        <span class="hljs-keyword">if</span> (annotation != <span class="hljs-literal">null</span>) {
            registry.put(annotation.type(), clazz);
        }
    }

    <span class="hljs-comment">/**
     * 根据类型创建产品
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Logger <span class="hljs-title function_">createLogger</span><span class="hljs-params">(String type)</span> {
        Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Logger</span>&gt; clazz = registry.get(type);
        <span class="hljs-keyword">if</span> (clazz == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"未找到类型: "</span> + type);
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> clazz.getDeclaredConstructor().newInstance();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"创建失败"</span>, e);
        }
    }
}
</code></pre>
<h4 data-id="heading-24">7.4 工厂方法+单例模式</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 工厂方法与单例模式结合
 * 确保每种类型的产品只创建一次
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SingletonFactory</span>&lt;T&gt; {

    <span class="hljs-keyword">private</span> T instance;

    <span class="hljs-comment">/**
     * 抽象工厂方法
     */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> T <span class="hljs-title function_">createInstance</span><span class="hljs-params">()</span>;

    <span class="hljs-comment">/**
     * 获取单例实例
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> T <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {
            instance = createInstance();
        }
        <span class="hljs-keyword">return</span> instance;
    }
}

<span class="hljs-comment">/**
 * 具体实现
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseConnectionSingletonFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SingletonFactory</span>&lt;DatabaseConnection&gt; {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> DatabaseConnection <span class="hljs-title function_">createInstance</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"创建数据库连接（仅一次）"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MySqlConnection</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">3306</span>, <span class="hljs-string">"mydb"</span>);
    }
}

<span class="hljs-comment">/**
 * 使用示例
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SingletonFactoryTest</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SingletonFactory&lt;DatabaseConnection&gt; factory =
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">DatabaseConnectionSingletonFactory</span>();

        <span class="hljs-type">DatabaseConnection</span> <span class="hljs-variable">conn1</span> <span class="hljs-operator">=</span> factory.getInstance();
        <span class="hljs-type">DatabaseConnection</span> <span class="hljs-variable">conn2</span> <span class="hljs-operator">=</span> factory.getInstance();

        System.out.println(<span class="hljs-string">"是同一个对象: "</span> + (conn1 == conn2)); <span class="hljs-comment">// true</span>
    }
}
</code></pre>
<h3 data-id="heading-25">八、工厂方法 vs 其他创建型模式</h3>
<h4 data-id="heading-26">8.1 工厂方法 vs 抽象工厂</h4>
<pre><code class="hljs language-diff" lang="diff">工厂方法（Factory Method）:
┌─────────────┐
│   Factory   │
├─────────────┤
│+ create()   │ ──→ 创建一个产品
└─────────────┘

抽象工厂（Abstract Factory）:
┌─────────────────┐
│ AbstractFactory │
├─────────────────┤
│+ createProductA │ ──→ 创建产品A
│+ createProductB │ ──→ 创建产品B
│+ createProductC │ ──→ 创建产品C
└─────────────────┘

区别：
<span class="hljs-deletion">- 工厂方法：一个工厂创建一种产品</span>
<span class="hljs-deletion">- 抽象工厂：一个工厂创建一系列相关产品</span>
</code></pre>
<h4 data-id="heading-27">8.2 工厂方法 vs 建造者模式</h4>
<pre><code class="hljs language-scss" lang="scss">工厂方法：
- 关注点：创建什么产品
- 复杂度：产品创建相对简单
- 使用场景：产品类型多样

建造者模式：
- 关注点：如何创建产品
- 复杂度：产品创建过程复杂
- 使用场景：产品内部结构复杂

示例对比：
<span class="hljs-comment">// 工厂方法</span>
Logger logger = factory<span class="hljs-selector-class">.createLogger</span>();

<span class="hljs-comment">// 建造者</span>
User user = new <span class="hljs-built_in">UserBuilder</span>()
    <span class="hljs-selector-class">.setName</span>("John")
    <span class="hljs-selector-class">.setAge</span>(<span class="hljs-number">30</span>)
    <span class="hljs-selector-class">.setEmail</span>("john@example.com")
    <span class="hljs-selector-class">.build</span>();
</code></pre>
<h3 data-id="heading-28">九、实战演练：构建文档转换器工厂</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 抽象产品：文档转换器
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DocumentConverter</span> {
    <span class="hljs-comment">/**
     * 转换文档
     * <span class="hljs-doctag">@param</span> sourceFile 源文件路径
     * <span class="hljs-doctag">@param</span> targetFile 目标文件路径
     * <span class="hljs-doctag">@return</span> 是否转换成功
     */</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">convert</span><span class="hljs-params">(String sourceFile, String targetFile)</span>;

    <span class="hljs-comment">/**
     * 获取支持的源格式
     */</span>
    String <span class="hljs-title function_">getSourceFormat</span><span class="hljs-params">()</span>;

    <span class="hljs-comment">/**
     * 获取支持的目标格式
     */</span>
    String <span class="hljs-title function_">getTargetFormat</span><span class="hljs-params">()</span>;
}

<span class="hljs-comment">/**
 * 具体产品：PDF转Word
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PdfToWordConverter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DocumentConverter</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">convert</span><span class="hljs-params">(String sourceFile, String targetFile)</span> {
        System.out.println(<span class="hljs-string">"开始转换: "</span> + sourceFile + <span class="hljs-string">" -&gt; "</span> + targetFile);
        System.out.println(<span class="hljs-string">"使用Apache PDFBox解析PDF..."</span>);
        System.out.println(<span class="hljs-string">"使用Apache POI生成Word文档..."</span>);
        System.out.println(<span class="hljs-string">"转换完成!"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getSourceFormat</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"PDF"</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getTargetFormat</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"WORD"</span>;
    }
}

<span class="hljs-comment">/**
 * 具体产品：Word转PDF
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WordToPdfConverter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DocumentConverter</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">convert</span><span class="hljs-params">(String sourceFile, String targetFile)</span> {
        System.out.println(<span class="hljs-string">"开始转换: "</span> + sourceFile + <span class="hljs-string">" -&gt; "</span> + targetFile);
        System.out.println(<span class="hljs-string">"使用Apache POI解析Word文档..."</span>);
        System.out.println(<span class="hljs-string">"使用iText生成PDF..."</span>);
        System.out.println(<span class="hljs-string">"转换完成!"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getSourceFormat</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"WORD"</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getTargetFormat</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"PDF"</span>;
    }
}

<span class="hljs-comment">/**
 * 具体产品：Markdown转HTML
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MarkdownToHtmlConverter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DocumentConverter</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">convert</span><span class="hljs-params">(String sourceFile, String targetFile)</span> {
        System.out.println(<span class="hljs-string">"开始转换: "</span> + sourceFile + <span class="hljs-string">" -&gt; "</span> + targetFile);
        System.out.println(<span class="hljs-string">"使用CommonMark解析Markdown..."</span>);
        System.out.println(<span class="hljs-string">"生成HTML文件..."</span>);
        System.out.println(<span class="hljs-string">"转换完成!"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getSourceFormat</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"MARKDOWN"</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getTargetFormat</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"HTML"</span>;
    }
}

<span class="hljs-comment">/**
 * 抽象工厂：文档转换器工厂
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DocumentConverterFactory</span> {

    <span class="hljs-comment">/**
     * 工厂方法：创建转换器
     */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> DocumentConverter <span class="hljs-title function_">createConverter</span><span class="hljs-params">()</span>;

    <span class="hljs-comment">/**
     * 执行转换（模板方法）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">performConversion</span><span class="hljs-params">(String sourceFile, String targetFile)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 验证文件</span>
            validateFiles(sourceFile, targetFile);

            <span class="hljs-comment">// 2. 创建转换器</span>
            <span class="hljs-type">DocumentConverter</span> <span class="hljs-variable">converter</span> <span class="hljs-operator">=</span> createConverter();

            <span class="hljs-comment">// 3. 显示转换信息</span>
            System.out.println(<span class="hljs-string">"\n=== 文档转换任务 ==="</span>);
            System.out.println(<span class="hljs-string">"转换类型: "</span> + converter.getSourceFormat() +
                             <span class="hljs-string">" → "</span> + converter.getTargetFormat());
            System.out.println(<span class="hljs-string">"源文件: "</span> + sourceFile);
            System.out.println(<span class="hljs-string">"目标文件: "</span> + targetFile);
            System.out.println(<span class="hljs-string">"==================\n"</span>);

            <span class="hljs-comment">// 4. 执行转换</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> converter.convert(sourceFile, targetFile);

            <span class="hljs-comment">// 5. 记录日志</span>
            <span class="hljs-keyword">if</span> (success) {
                logSuccess(converter, sourceFile, targetFile);
            } <span class="hljs-keyword">else</span> {
                logFailure(converter, sourceFile, targetFile);
            }

            <span class="hljs-keyword">return</span> success;

        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"转换失败: "</span> + e.getMessage());
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validateFiles</span><span class="hljs-params">(String sourceFile, String targetFile)</span> {
        <span class="hljs-keyword">if</span> (sourceFile == <span class="hljs-literal">null</span> || targetFile == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"文件路径不能为空"</span>);
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logSuccess</span><span class="hljs-params">(DocumentConverter converter, String source, String target)</span> {
        System.out.println(<span class="hljs-string">"\n✓ 转换成功: "</span> + converter.getSourceFormat() +
                         <span class="hljs-string">" → "</span> + converter.getTargetFormat());
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logFailure</span><span class="hljs-params">(DocumentConverter converter, String source, String target)</span> {
        System.err.println(<span class="hljs-string">"\n✗ 转换失败: "</span> + converter.getSourceFormat() +
                         <span class="hljs-string">" → "</span> + converter.getTargetFormat());
    }
}

<span class="hljs-comment">/**
 * 具体工厂实现
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PdfToWordConverterFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DocumentConverterFactory</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> DocumentConverter <span class="hljs-title function_">createConverter</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PdfToWordConverter</span>();
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WordToPdfConverterFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DocumentConverterFactory</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> DocumentConverter <span class="hljs-title function_">createConverter</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WordToPdfConverter</span>();
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MarkdownToHtmlConverterFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DocumentConverterFactory</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> DocumentConverter <span class="hljs-title function_">createConverter</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarkdownToHtmlConverter</span>();
    }
}

<span class="hljs-comment">/**
 * 工厂注册表（简化客户端使用）
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConverterFactoryRegistry</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> java.util.Map&lt;String, DocumentConverterFactory&gt; factories =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.util.HashMap&lt;&gt;();

    <span class="hljs-keyword">static</span> {
        <span class="hljs-comment">// 注册所有工厂</span>
        factories.put(<span class="hljs-string">"pdf-to-word"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">PdfToWordConverterFactory</span>());
        factories.put(<span class="hljs-string">"word-to-pdf"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">WordToPdfConverterFactory</span>());
        factories.put(<span class="hljs-string">"markdown-to-html"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarkdownToHtmlConverterFactory</span>());
    }

    <span class="hljs-comment">/**
     * 根据转换类型获取工厂
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> DocumentConverterFactory <span class="hljs-title function_">getFactory</span><span class="hljs-params">(String conversionType)</span> {
        <span class="hljs-type">DocumentConverterFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> factories.get(conversionType);
        <span class="hljs-keyword">if</span> (factory == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"不支持的转换类型: "</span> + conversionType);
        }
        <span class="hljs-keyword">return</span> factory;
    }

    <span class="hljs-comment">/**
     * 列出所有支持的转换类型
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listSupportedConversions</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"支持的转换类型:"</span>);
        factories.keySet().forEach(type -&gt; System.out.println(<span class="hljs-string">"  - "</span> + type));
    }
}

<span class="hljs-comment">/**
 * 测试类
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DocumentConverterTest</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 列出支持的转换类型</span>
        ConverterFactoryRegistry.listSupportedConversions();

        <span class="hljs-comment">// 场景1: PDF转Word</span>
        <span class="hljs-type">DocumentConverterFactory</span> <span class="hljs-variable">factory1</span> <span class="hljs-operator">=</span>
            ConverterFactoryRegistry.getFactory(<span class="hljs-string">"pdf-to-word"</span>);
        factory1.performConversion(<span class="hljs-string">"/docs/report.pdf"</span>, <span class="hljs-string">"/docs/report.docx"</span>);

        <span class="hljs-comment">// 场景2: Word转PDF</span>
        <span class="hljs-type">DocumentConverterFactory</span> <span class="hljs-variable">factory2</span> <span class="hljs-operator">=</span>
            ConverterFactoryRegistry.getFactory(<span class="hljs-string">"word-to-pdf"</span>);
        factory2.performConversion(<span class="hljs-string">"/docs/article.docx"</span>, <span class="hljs-string">"/docs/article.pdf"</span>);

        <span class="hljs-comment">// 场景3: Markdown转HTML</span>
        <span class="hljs-type">DocumentConverterFactory</span> <span class="hljs-variable">factory3</span> <span class="hljs-operator">=</span>
            ConverterFactoryRegistry.getFactory(<span class="hljs-string">"markdown-to-html"</span>);
        factory3.performConversion(<span class="hljs-string">"/docs/README.md"</span>, <span class="hljs-string">"/docs/README.html"</span>);
    }
}
</code></pre>
<h3 data-id="heading-29">十、总结</h3>
<h4 data-id="heading-30">10.1 核心要点</h4>
<ol>
<li><strong>工厂方法模式的本质</strong>：定义创建对象的接口，由子类决定实例化哪个类</li>
<li><strong>适用场景</strong>：
<ul>
<li>不知道具体需要哪个类的实例</li>
<li>希望通过子类指定创建对象</li>
<li>将对象创建职责委托给子类</li>
</ul>
</li>
<li><strong>关键技巧</strong>：
<ul>
<li>抽象工厂定义工厂方法</li>
<li>具体工厂实现工厂方法</li>
<li>客户端依赖抽象，不依赖具体</li>
</ul>
</li>
</ol>
<h4 data-id="heading-31">10.2 使用建议</h4>
<pre><code class="hljs language-arduino" lang="arduino">选择工厂方法模式的检查清单：

✓ 是否需要在运行时决定创建哪个类的实例？
✓ 是否有多种产品类型，且可能继续增加？
✓ 是否希望将对象创建逻辑与使用逻辑分离？
✓ 是否需要在不修改客户端代码的情况下扩展新产品？

如果以上都是<span class="hljs-string">"是"</span>，那么工厂方法模式是个好选择！
</code></pre>
<h4 data-id="heading-32">10.3 实践原则</h4>
<ol>
<li><strong>合理使用</strong>：不是所有对象创建都需要工厂方法</li>
<li><strong>保持简单</strong>：如果只有2-3个产品，考虑简单工厂</li>
<li><strong>结合其他模式</strong>：可以与单例、原型等模式结合</li>
<li><strong>文档化</strong>：清晰记录各工厂创建的产品类型</li>
</ol>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[听说vite要一统江湖了，我看看怎么个事]]></title>    <link>https://juejin.cn/post/7574749664492830754</link>    <guid>https://juejin.cn/post/7574749664492830754</guid>    <pubDate>2025-11-21T08:57:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574749664492830754" data-draft-id="7574816159755239475" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="听说vite要一统江湖了，我看看怎么个事"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-21T08:57:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sean聊前端"/> <meta itemprop="url" content="https://juejin.cn/user/2682464101207560"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            听说vite要一统江湖了，我看看怎么个事
            <!----> <!----></h1> <div class="container team-follow" data-v-d326b38e="" data-v-61fb5e44=""><div class="left" data-v-d326b38e=""><a href="/team/7331587707870642210/posts" data-v-d326b38e=""><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c88185b14145426288bf96b1a1cb98ce~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=200&amp;h=200&amp;s=5651&amp;e=png&amp;b=fefefe" class="icon" data-v-d326b38e=""/></a> <div class="content" data-v-d326b38e=""><div style="display: flex" data-v-d326b38e=""><a href="/team/7331587707870642210/posts" data-v-d326b38e=""><p class="title-line" data-v-d326b38e=""><span title="顺丰同城前端技术团队" class="title" data-v-d326b38e="">顺丰同城前端技术团队</span> <img src="//lf-web-assets.juejin.cn/obj/juejin-web/xitu_juejin_web/255e400027b783cbad76dc41527e7695.svg" alt="team icon" class="team-icon" data-v-d326b38e=""/></p></a></div> <div class="meta-box team" data-v-d326b38e="" data-v-61fb5e44=""><time datetime="2025-11-21T08:57:21.000Z" title="Fri Nov 21 2025 08:57:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-d326b38e="" data-v-61fb5e44="">
                2025-11-21
              </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-d326b38e="" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/></svg> <span class="views-count" style="display:none;" data-v-d326b38e="" data-v-61fb5e44="">
                0
              </span> <span class="read-time" data-v-d326b38e="" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-d326b38e="" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-d326b38e="" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-d326b38e="" data-v-61fb5e44=""/></svg>
                阅读23分钟
              </span> <!----> <!----></div></div></div> <button class="jj-follow-button follow-btn" style="display:none;" data-v-b60b2868="" data-v-d326b38e=""><span data-v-b60b2868="" data-v-d326b38e=""><i class="byte-icon byte-icon--plus" data-v-d326b38e=""><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 48 48"><path fill="none" d="M0 0h48v48H0z"/><path d="M24.7 4c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8V22h16.7c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8v1.4c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1H26v16.7c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1h-1.4c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8V26H5.3c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8v-1.4c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1H22V5.3c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1h1.4z"/></svg></i>
        关注
      </span></button></div> <div class="team-user block-hidden" data-v-61fb5e44=""><div class="avatar jj-avatar avatar" data-v-03256cc6="" data-v-61fb5e44=""><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="avatar" class="lazy avatar-img" data-v-5244ef91="" data-v-03256cc6=""/> </div> <!----> <span class="position ellipsis" data-v-61fb5e44="">
              html5 @家里蹲
            </span></div> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">抛几个问题大家先聊聊</h3>
<p>1.  大家心目中的vite是个什么样子</p>
<p>2.  vite快在哪</p>
<p>3.  vite 开发环境和生成环境都用什么打包 为啥不能统一</p>
<h3 data-id="heading-1">一、Vite 产生背景</h3>
<p> </p>
<h4 data-id="heading-2">1.  传统构建工具的核心痛点(webpack有啥痛点)</h4>
<p> </p>
<p>以 Webpack 为代表的传统工具，因 “全量打包” 模式难以适配复杂项目，主要痛点集中在四点：</p>
<p>● 🚫 开发体验差：冷启动达分钟级，热更新延迟随模块量增长，常丢失开发状态</p>
<p>● ⚡ 性能瓶颈明显：JS 编写的工具占用 CPU / 内存高，多项目并行时设备压力大</p>
<p>● 🔧 适配成本高：需兼容多模块格式（CJS/UMD/ESM），配置 TypeScript 等功能步骤繁琐</p>
<p>● 🕸️ 未利用浏览器新能力：2018 年后浏览器原生支持 ESM，但传统工具未借力优化</p>
<p> </p>
<h4 data-id="heading-3">2. Vite 诞生的 3 大技术基石（vite有啥优势）</h4>
<p> </p>
<p>Vite 的出现依赖前端生态三大关键进展，缺一不可：</p>
<p>1.  🌐 浏览器原生 ESM 普及</p>
<p>支持 
</p><p>2.  🔨 编译工具语言革新</p>
<p>2020 年 Go 语言编写的 esbuild 发布，依赖预构建速度比 JS 工具快 10-100 倍，解决传统工具性能瓶颈。</p>
<p>3.  🧩 构建理念升级</p>
<p>开发环境借鉴 Snowpack “依赖预构建” 思路，生产环境依托 Rollup 成熟插件生态，实现 “按需编译” 的新型构建模式。</p>
<p> </p>
<h4 data-id="heading-4">3. Vite 诞生历程与关键决策（vite时间线）</h4>
<p> </p>
<p>Vite 从解决 Vue 生态痛点起步，逐步发展为跨框架通用工具：</p>
<p>● 📅 初始动机：2019 年 Vue 3 开发中，模块激增导致 Webpack 启动慢，亟需适配现代框架的轻量工具。</p>
<p>● 🚩 关键时间节点：</p>
<p>● 2020.04：Vite 1.0 发布，仅支持 Vue 项目，验证 ESM 开发模式可行性；</p>
<p>● 2021.02：Vite 2.0 重构，成为跨框架工具，引入 Rollup 负责生产构建；</p>
<p>● 2022-2023：3.0/4.0/5.0 版本持续优化性能，完善生态兼容（如支持 React、Svelte 等）。</p>
<p>● 🎯 核心决策：分模块差异化处理</p>
<p>依赖用 esbuild 预构建 + 源码开发时按需编译 + 全流程缓存，平衡速度与兼容性。</p>
<p> </p>
<h4 data-id="heading-5">4. 构建模式对比流程图（webpack vs vite）</h4>
<p> </p>
<p>通过流程图直观对比传统工具与 Vite 的核心差异，重点关注 “是否全量打包”“更新方式” 两个维度：</p>
<p> </p>
<h5 data-id="heading-6">4.1 传统 Bundle 模式（以 Webpack 为例）</h5>
<p><img src="" alt="" loading="lazy"/></p>
<p> </p>
<h5 data-id="heading-7">4.2 Vite 构建模式（开发 + 生产分离）</h5>
<p><img src="" alt="" loading="lazy"/></p>
<p> </p>
<h4 data-id="heading-8">5. Vite 核心价值总结 (总结)</h4>
<p>Vite 之所以能成为前端构建工具新选择，核心价值体现在四方面：</p>
<p>1.  🔄 范式革新：开发 / 生产分离优化（ESM 按需编译 + Rollup 生产打包），兼顾速度与产物质量；</p>
<p>2.  ⚡ 性能突破：冷启动时间从分钟级压缩至秒级，大型项目开发效率提升显著；</p>
<p>3.  🚀 体验升级：零配置开箱即用，HMR 保持应用状态，减少开发流程中断；</p>
<p>4.  🌍 生态兼容：支持 Vue/React/Svelte 等多框架，兼容 Rollup 插件，降低迁移成本。</p>
<p> </p>
<h3 data-id="heading-9">二. Vite 核心特性解析</h3>
<p> </p>
<p>Vite 颠覆传统构建工具的核心在于利用现代浏览器能力与分层优化策略，其三大核心特性共同实现了 “开发极速响应、生产高效输出” 的体验升级。</p>
<h4 data-id="heading-10">2.1 特性一：极速冷启动（毫秒级启动）</h4>
<p> </p>
<p>传统工具需全量打包后启动服务，而 Vite 通过 “依赖预构建 + 源码按需加载” 实现极速启动，启动时间不受项目体积线性影响。</p>
<p> </p>
<h5 data-id="heading-11">2.1.1 实现原理</h5>
<p>1.  模块分层处理</p>
<p>首次启动时将项目模块拆分为两类，针对性优化：</p>
<p>● 依赖模块：开发中不变的纯 JS 依赖（如 Lodash、Vue 核心库），多含 CJS/UMD 格式，需统一转换为 ESM 并合并减少请求量。</p>
<p><img src="" alt="" loading="lazy"/></p>
<p>● 源码模块：频繁编辑的业务代码（含 JSX、Vue 组件等），直接以原生 ESM 格式提供，浏览器请求时才按需编译。</p>
<p><img src="" alt="" loading="lazy"/></p>
<p>2.  esbuild 预构建依赖</p>
<p>采用 Go 语言编写的 esbuild 处理依赖，速度比 JS 工具快 10-100 倍，预构建结果存入缓存（node_modules/.vite），二次启动直接复用。</p>
<p>3.  浏览器接管部分打包工作</p>
<p>通过 
</p><p> </p>
<h5 data-id="heading-12">2.1.2 冷启动流程可视化</h5>
<p><img src="" alt="" loading="lazy"/></p>
<p> </p>
<h4 data-id="heading-13">2.2 特性二：精准热模块替换（HMR）</h4>
<p> </p>
<p>Vite 的 HMR 基于原生 ESM 实现，更新速度不随项目体积增长而下降，且能保持应用运行状态。</p>
<p> </p>
<h5 data-id="heading-14">2.2.1 核心机制</h5>
<p>1.  模块依赖图追踪</p>
<p>启动时构建 moduleGraph 记录模块间依赖关系（如 A 依赖 B、B 依赖 C），每个模块对应唯一 ModuleNode 对象，包含转换结果与依赖链信息。</p>
<p>packages/vite/src/server/moduleGraph.ts</p>
<p>2.  精准失效范围</p>
<p>文件修改后，仅使变更模块及其最近的 HMR 边界（如 Vue 组件的 
</p><p>3.  WebSocket 实时通信</p>
<p>● 用户修改文件后被 server 端的监听器监听到，监听器遍历文件对应的模块，计算出热更新边界</p>
<p>● server 端通过 websocket 向 client 发送热更新信号</p>
<p>● client 对旧模块进行失活，向 server 请求最新的模块资源</p>
<p>● server 收到请求后将模块代码转换为 js，并将转换后的代码返回给 client</p>
<p>● client 执行返回后的代码，调用更新函数更新页面内容</p>
<p>4.  缓存加速</p>
<p>源码模块通过 304 Not Modified 协商缓存，依赖模块通过 immutable 强缓存，避免重复请求。</p>
<p> </p>
<h5 data-id="heading-15">2.2.2 HMR 工作流程可视化</h5>
<p> </p>
<p><img src="" alt="" loading="lazy"/></p>
<p> </p>
<h4 data-id="heading-16">2.3 特性三：开发与生产双环境优化</h4>
<p>Vite 采用 “开发按需编译、生产优化打包” 的差异化策略，兼顾开发效率与生产性能。</p>
<p> </p>
<h5 data-id="heading-17">2.3.1 双环境设计逻辑</h5>






























<table><thead><tr><th>维度</th><th>开发环境（dev）</th><th>生产环境（build）</th></tr></thead><tbody><tr><td>核心目标</td><td>极速启动、实时反馈</td><td>产物体积小、加载快、兼容性强</td></tr><tr><td>实现方式</td><td>原生 ESM 按需编译 + esbuild 预构建</td><td>Rollup 优化打包 + 多维度性能优化</td></tr><tr><td>关键操作</td><td>模块缓存、HMR 局部更新</td><td>Tree-shaking、代码分割、压缩、预加载注入</td></tr><tr><td>工具依赖</td><td>Koa 服务器、WebSocket、chokidar</td><td>Rollup、Terser、CSSNano</td></tr></tbody></table>
<h5 data-id="heading-18"> </h5>
<h5 data-id="heading-19">2.3.2 生产环境优化细节</h5>
<p>1.  Rollup 打包核心</p>
<p>未采用 esbuild 生产打包的原因：Rollup 拥有更成熟的插件生态与更优的代码分割策略，能实现更精细的 Tree-shaking（剔除无用代码）。未来计划迁移至 Rust 编写的 Rolldown，进一步提升性能。</p>
<p>2.  智能代码分割</p>
<p>自动拆分公共依赖（如 Vue 核心库）与业务代码，生成独立 chunk，利用浏览器缓存提升二次加载速度。</p>
<p>3.  资源优化</p>
<p>● 压缩：JS 用 Terser 压缩，CSS 用 CSSNano 处理；</p>
<p>● 预加载：自动生成 ，提前加载关键模块；</p>
<p>● 兼容性：通过 @vitejs/plugin-legacy 生成 ES5 代码，适配旧浏览器。</p>
<p>为啥不用esbuild在生产环境</p>
<p>● 代码分割（Code Splitting）能力较弱：esbuild 的代码分割逻辑相对简单，对动态导入（import()）的处理、公共模块提取（splitChunks）等高级需求支持不足，而现代前端项目（尤其是大型应用）依赖灵活的代码分割来优化加载性能。</p>
<p>● 生态兼容性有限：esbuild 的插件系统不如 Rollup 成熟，许多前端生态中常用的工具（如处理 CSS 模块化、静态资源、特定框架特性的插件）对 esbuild 的适配不够完善，而 Rollup 拥有丰富的插件生态，能更好地兼容前端工程化的复杂需求。</p>
<p>● 对非 ESM 模块的处理能力较弱：虽然 esbuild 支持转换 CommonJS 模块，但在处理复杂依赖关系（如循环依赖、动态 require）时，可能出现与 Webpack/Rollup 不一致的行为，存在兼容性风险。</p>
<p> </p>
<h5 data-id="heading-20">2.3.3 双环境流程对比</h5>
<p><img src="" alt="" loading="lazy"/></p>
<p> </p>
<h4 data-id="heading-21">2.4 特性总结：为何 Vite 能实现 “快且优”？</h4>
<p>1.  理念革新：让浏览器参与模块解析，将传统打包工具的 “预打包” 改为 “按需编译”，从根源上提升启动速度。</p>
<p>2.  技术选型精准：esbuild 处理依赖、Rollup 负责生产打包、WebSocket 实现 HMR，每一步都采用当前最优工具链。</p>
<p>3.  分层优化思维：针对 “开发 - 生产”“依赖 - 源码” 的不同特性设计差异化策略，既满足开发效率又保证生产性能。</p>
<p> </p>
<h3 data-id="heading-22">三、  Vite 各版本对比及 Demo 展示</h3>
<p> </p>
<h4 data-id="heading-23">3.1版本演进核心脉络与定位</h4>
<p>Vite 的版本迭代围绕「性能突破」与「架构统一」两大主线展开，可划分为三个关键阶段：</p>
<p>1.  基础奠基期（V4.x）：验证「非打包开发」核心模式，奠定极速启动基础</p>
<p>2.  生态拓展期（V5.x-V6.x）：完善框架适配与工具链集成，暴露混合架构瓶颈</p>
<p>3.  架构重构期（V7.x-V8 Beta）：引入 Rust 工具链，实现开发 / 生产流程统一</p>
<p> </p>
<h4 data-id="heading-24">3.2关键版本核心特性对比</h4>






















































<table><thead><tr><th>维度</th><th>V4.x（奠基期）</th><th>V5.x-V6.x（拓展期）</th><th>V7.x（转型期）</th><th>V8 Beta（重构期）</th></tr></thead><tbody><tr><td>核心架构</td><td>esbuild 预打包 + Rollup 生产构建</td><td>保留双工具架构，优化协作逻辑</td><td>引入 Rolldown 试验性支持</td><td>全 Rolldown 驱动，彻底替代双工具</td></tr><tr><td>Node 支持</td><td>Node.js 14.18+</td><td>Node.js 16.14+</td><td>Node.js 20.19+/22.12+（弃用 18）</td><td>同 V7，兼容 LTS 版本</td></tr><tr><td>框架适配</td><td>Vue/React/Svelte 核心支持</td><td>新增 Marko 模板，RedwoodSDK 整合</td><td>完善 Vue 3.5/React 19 适配</td><td>全框架兼容，支持微前端联邦架构</td></tr><tr><td>TypeScript 能力</td><td>基础 TS 转译，依赖 esbuild</td><td>内置 TS 5.8，支持常量枚举内联</td><td>集成 Oxc TS 解析，类型检查提速 30%</td><td>原生 TS 类型优化，支持增量编译</td></tr><tr><td>性能优化点</td><td>冷启动 161ms（对比 Webpack 快 11.7 倍）</td><td>解析逻辑优化，冷启动比 V4.2 提升 70%</td><td>生产构建速度提升 30%，热更新 &lt; 50ms</td><td>跨块优化提速 15 倍，打包体积降 20%</td></tr><tr><td>关键新特性</td><td>HMR 模块依赖图追踪</td><td>模块联邦支持，barrel 文件优化</td><td>新增 buildApp 钩子，Vite DevTools 开发</td><td>全捆绑模式，原生 Importmaps 支持</td></tr></tbody></table>
<p> </p>
<h4 data-id="heading-25">3.3. 核心架构迭代解析</h4>

























<table><thead><tr><th>版本阶段</th><th>架构示意图</th><th>核心痛点解决</th></tr></thead><tbody><tr><td>V4.x-V6.x</td><td><img src="" alt="" loading="lazy"/></td><td>红色虚线框：开发用 esbuild、生产用 Rollup，工具链割裂导致环境差异黄色感叹号：Rollup 单线程处理大型项目时，构建速度瓶颈明显 </td></tr><tr><td>V7.x</td><td><img src="" alt="" loading="lazy"/></td><td>过渡特性标注：绿色模块：新增的 Rolldown 试验性功能，主打性能提升黄色模块：优化后的 Dev Server，内存占用降低 30%分支逻辑：保留双工具链选项，平衡兼容性与性能 </td></tr><tr><td>V8 Beta</td><td><img src="" alt="" loading="lazy"/></td><td>蓝色粗框：Rolldown 统一工具链，消除环境差异绿色模块：多线程 + 增量打包，性能核心产物体积比 V6.x 降 20%，无需手动配置 vendor </td></tr></tbody></table>
<h4 data-id="heading-26"> </h4>
<h4 data-id="heading-27">3.4. 大型项目性能实测（复杂多应用工程）</h4>








































<table><thead><tr><th>指标</th><th>V4.x</th><th>V6.x</th><th>V7.x</th><th>V8 Beta</th></tr></thead><tbody><tr><td>开发冷启动时间</td><td>2.8s</td><td>1.5s</td><td>0.9s</td><td>0.3s</td></tr><tr><td>生产构建时间</td><td>3m12s</td><td>2m0s</td><td>1m15s</td><td>8s</td></tr><tr><td>热更新响应时间</td><td>120ms</td><td>80ms</td><td>45ms</td><td>20ms</td></tr><tr><td>内存占用</td><td>180MB</td><td>120MB</td><td>90MB</td><td>42MB</td></tr></tbody></table>
<p>数据来源：Vite 官方 benchmark 及 PayFit、掘金社区实测案例综合整理</p>
<p> </p>
<h4 data-id="heading-28">3.5. 各版本适用场景</h4>
<p>● V4.x：维护旧项目，依赖 Node.js 18 及以下环境</p>
<p>● V6.x：中型项目稳定运行，需 Marko/Redwood 生态支持</p>
<p>● V7.x：追求性能提升，可接受 Rust 工具链过渡适配</p>
<p>● V8 Beta：大型项目 / 微前端架构，需极致构建性能</p>
<p> </p>
<h4 data-id="heading-29">3.6. 迁移成本与收益对比</h4>





























<table><thead><tr><th>迁移路径</th><th>核心改动点</th><th>预期收益</th><th>潜在风险</th></tr></thead><tbody><tr><td>V4→V6</td><td>升级 Node.js 至 16+，适配 TS 5.8</td><td>冷启动提速 46%，生态工具更丰富</td><td>部分旧插件兼容性问题</td></tr><tr><td>V6→V7</td><td>升级 Node.js 至 20+，适配 Rolldown 试验模式</td><td>生产构建提速 40%，热更新延迟减半</td><td>少数第三方库导入顺序问题</td></tr><tr><td>V7→V8 Beta</td><td>移除 Rollup 配置，启用全捆绑模式</td><td>构建速度提升 15 倍，打包体积降 20%</td><td>部分插件需迁移至 Rust 原生实现</td></tr></tbody></table>
<h4 data-id="heading-30"> </h4>
<h4 data-id="heading-31">3.7. 7+版本演进核心优势</h4>
<p>1.  性能质变节点：V7.x 引入 Rolldown 标志着性能提升从「优化迭代」进入「架构重构」阶段，V8 Beta 实现质的飞跃</p>
<p>2.  架构统一价值：全 Rolldown 驱动解决了 Vite 诞生以来的「开发 / 生产环境不一致」核心痛点</p>
<p>3.  生态适配节奏：每个大版本均保持对主流框架的兼容性，V8 将完成从工具到生态的全面升级</p>
<p>参考 Vite 官方路线图：2025 年底 V8 正式版将实现 Rolldown 全量启用，届时 V4-V7 版本将逐步进入维护期</p>
<h3 data-id="heading-32"> </h3>
<h4 data-id="heading-33">3.8. 快速搭建各版本项目demo</h4>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># Vite 3（需指定版本）</span>
npm create vite@3 <span class="hljs-keyword">my</span>-v3-app -- --template vue
<span class="hljs-comment"># Vite 4</span>
npm create vite@4 <span class="hljs-keyword">my</span>-v4-app -- --template vue
<span class="hljs-comment"># Vite 5</span>
npm create vite@5 <span class="hljs-keyword">my</span>-v5-app -- --template vue
<span class="hljs-comment"># Vite 6</span>
npm create vite@6 <span class="hljs-keyword">my</span>-v6-app -- --template vue
<span class="hljs-comment"># Vite 7</span>
npm create vite@7 <span class="hljs-keyword">my</span>-v7-app -- --template vue
</code></pre>
<p> </p>
<h3 data-id="heading-34">四、vite4核心源码解析</h3>
<p> </p>
<h4 data-id="heading-35">4.1、Vite 4 核心架构与源码组织</h4>
<p>Vite 4 采用 monorepo 结构（基于 pnpm workspace），核心代码集中于 <code>packages/vite</code> 目录，整体架构可划分为五大核心模块，各模块职责明确且协同联动。</p>
<p> </p>
<h4 data-id="heading-36">4.2. 核心模块概览</h4>



































<table><thead><tr><th>模块路径</th><th>核心职责</th><th>关键依赖 / 工具</th></tr></thead><tbody><tr><td>src/node/cli.ts</td><td>命令行入口，解析参数分发命令</td><td>cac（命令行解析工具）</td></tr><tr><td>src/node/config/</td><td>配置解析与合并，支持多环境配置</td><td>-</td></tr><tr><td>src/node/server/</td><td>开发服务器实现，集成 HMR 与中间件</td><td>connect（中间件框架）、chokidar（文件监听）</td></tr><tr><td>src/node/build/</td><td>生产构建流程，基于 Rollup 实现</td><td>Rollup 3、esbuild</td></tr><tr><td>src/node/plugin/</td><td>插件系统核心，定义钩子与容器</td><td>-</td></tr></tbody></table>
<p> </p>
<h4 data-id="heading-37">4.3. 核心数据结构</h4>
<p>●  ModuleGraph（<code>src/node/server/moduleGraph.ts</code>）：维护模块依赖关系的核心数据结构，记录 URL 与文件路径映射、模块依赖链及 HMR 状态，是按需编译与热更新的基础。</p>
<p>●  PluginContainer（<code>src/node/pluginContainer.ts</code>）：插件容器，统一调度插件钩子执行，实现模块解析、转换等流程的可扩展性。</p>
<p> </p>
<p> </p>
<h4 data-id="heading-38">4.4、核心流程源码解析</h4>
<p>Vite 4 的核心能力集中体现在开发环境启动、模块按需编译、热更新（HMR） 与生产构建四大流程，以下结合源码片段深度拆解。</p>
<p> </p>
<h5 data-id="heading-39">4.4.1. 开发服务器启动流程（<code>vite dev</code>）</h5>
<p>启动流程是 Vite 4 极速体验的起点，核心是初始化配置、构建中间件链与启动 HMR 服务，源码入口为 <code>src/node/cli.ts</code>，关键逻辑在 <code>createServer</code> 函数中实现。</p>
<p> </p>
<p>关键步骤与源码</p>
<ol>
<li>命令行解析与配置合并</li>
</ol>
<pre><code class="hljs language-scss" lang="scss">   <span class="hljs-comment">// src/node/cli.ts 简化逻辑</span>
   async function <span class="hljs-built_in">createServer</span>(inlineConfig = {}) {
     <span class="hljs-comment">// 1. 解析配置：合并默认配置、用户配置、环境变量</span>
     const config = await <span class="hljs-built_in">resolveConfig</span>(inlineConfig, 'serve')
        
     <span class="hljs-comment">// 2. 创建中间件容器与 HTTP 服务器</span>
     const middlewares = <span class="hljs-built_in">connect</span>()
     const httpServer = await <span class="hljs-built_in">resolveHttpServer</span>(config.server, middlewares)
     
     <span class="hljs-comment">// 3. 初始化 WebSocket 服务（HMR 通信通道）</span>
     const ws = <span class="hljs-built_in">createWebSocketServer</span>(httpServer, config)
     
     <span class="hljs-comment">// 4. 创建文件监听器（监控源码与配置变化）</span>
     const watcher = chokidar<span class="hljs-selector-class">.watch</span>(root, resolvedWatchOptions)
 
     <span class="hljs-comment">// 5. 初始化模块依赖图</span>
     const moduleGraph = new <span class="hljs-built_in">ModuleGraph</span>((url) =&gt; pluginContainer<span class="hljs-selector-class">.resolveId</span>(url))
     
     <span class="hljs-comment">// 6. 注册核心中间件（按顺序执行）</span>
     middlewares<span class="hljs-selector-class">.use</span>(timeMiddleware) <span class="hljs-comment">// 响应时间统计</span>
     middlewares<span class="hljs-selector-class">.use</span>(corsMiddleware(config)) <span class="hljs-comment">// 跨域处理</span>
     middlewares<span class="hljs-selector-class">.use</span>(proxyMiddleware(config)) <span class="hljs-comment">// 代理配置</span>
     middlewares<span class="hljs-selector-class">.use</span>(transformMiddleware(config, moduleGraph, ws)) <span class="hljs-comment">// 模块转换核心</span>
     middlewares<span class="hljs-selector-class">.use</span>(indexHtmlMiddleware(config, moduleGraph)) <span class="hljs-comment">// HTML 处理</span>
     middlewares<span class="hljs-selector-class">.use</span>(errorMiddleware()) <span class="hljs-comment">// 错误捕获</span>
     
     <span class="hljs-comment">// 7. 初始化插件容器</span>
     await pluginContainer<span class="hljs-selector-class">.buildStart</span>({})
     
  <span class="hljs-comment">// 8. 初始化依赖预构建器（后台启动，不阻塞服务器启动）</span>
     await <span class="hljs-built_in">initDepsOptimizer</span>(config, options.force, true);
     
     return { server, moduleGraph, ws }
   }
</code></pre>
<p> </p>
<ol start="2">
<li>依赖预构建优化</li>
</ol>
<p>Vite 4 默认启用 esbuild 处理依赖预构建，将 CommonJS 格式的依赖转换为 ESM 并缓存，避免浏览器兼容性问题，源码位于 <code>src/node/depOptimizer/</code>。预构建产物存储于 <code>node_modules/.vite/deps</code>，首次启动后会缓存，二次启动直接复用。</p>
<p> </p>
<p>启动流程可视化</p>
<p><img src="" alt="" loading="lazy"/></p>
<h5 data-id="heading-40">4.4.2. 模块按需编译流程（核心性能点）</h5>
<p>Vite 4 区别于传统打包工具的核心是按需编译：浏览器请求模块时才触发编译，而非全量预打包，核心实现依赖 <code>transformMiddleware</code> 中间件。</p>
<p> </p>
<p>关键逻辑与源码</p>
<ol>
<li>请求拦截与模块解析</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript">   <span class="hljs-comment">// src/node/server/middlewares/transform.ts 简化逻辑</span>
   <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">transformMiddleware</span>(<span class="hljs-params">req, res, next</span>) {
     <span class="hljs-keyword">const</span> url = req.<span class="hljs-property">url</span>
     <span class="hljs-comment">// 1. 忽略静态资源与非模块请求</span>
     <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isStaticAsset</span>(url) || !req.<span class="hljs-property">headers</span>.<span class="hljs-property">accept</span>?.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'text/javascript'</span>)) {
       <span class="hljs-keyword">return</span> <span class="hljs-title function_">next</span>()
     }
     
     <span class="hljs-comment">// 2. 从模块图获取或创建模块实例</span>
     <span class="hljs-keyword">let</span> <span class="hljs-variable language_">module</span> = moduleGraph.<span class="hljs-title function_">getModuleByUrl</span>(url)
     <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">module</span>) {
       <span class="hljs-keyword">const</span> resolved = <span class="hljs-keyword">await</span> pluginContainer.<span class="hljs-title function_">resolveId</span>(url)
       <span class="hljs-variable language_">module</span> = <span class="hljs-keyword">await</span> moduleGraph.<span class="hljs-title function_">createModule</span>(resolved.<span class="hljs-property">id</span>, url)
     }
     
     <span class="hljs-comment">// 3. 执行插件转换（如 Vue SFC 解析、TS 转译）</span>
     <span class="hljs-keyword">const</span> transformResult = <span class="hljs-keyword">await</span> pluginContainer.<span class="hljs-title function_">transform</span>(code, <span class="hljs-variable language_">module</span>.<span class="hljs-property">file</span>)
     
     <span class="hljs-comment">// 4. 注入 HMR 客户端代码（开发环境）</span>
     <span class="hljs-keyword">if</span> (!isProduction) {
       transformResult.<span class="hljs-property">code</span> += <span class="hljs-title function_">injectHmrClientCode</span>(url)
     }
     
     <span class="hljs-comment">// 5. 返回编译结果给浏览器</span>
     res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'application/javascript'</span>)
     res.<span class="hljs-title function_">end</span>(transformResult.<span class="hljs-property">code</span>)
   }
</code></pre>
<p>拦截模块请求浏览器的请求先经过 Vite 服务器的中间件链，transformMiddleware 会识别出 “需要编译的模块请求”（如 .vue、.ts、.jsx 等非原生 ESM 模块，或需要转换的 JS 模块）。</p>
<p>定位模块文件</p>
<p>通过 ModuleGraph（之前提到的模块依赖图）将请求的 URL（如 /src/App.vue）映射到本地文件系统的路径（如 ./src/App.vue），确认模块的物理位置。</p>
<p> </p>
<p>调用插件处理（编译）</p>
<p>借助 PluginContainer（插件容器）调用对应插件的转换钩子（如 transform），对模块内容进行实时编译：</p>
<p>例如，.vue 文件会被 @vitejs/plugin-vue 解析为模板、脚本、样式三部分，分别编译为浏览器可执行的 JS 代码；</p>
<p>例如，.ts 文件会被 @vitejs/plugin-typescript 转换为 JS 代码。</p>
<p> </p>
<p>处理依赖关系</p>
<p>编译过程中，若模块依赖其他模块（如 App.vue 中 import Button from './Button.vue'），transformMiddleware 会通过 ModuleGraph 记录这些依赖关系，为后续的热更新做准备。</p>
<p> </p>
<p>返回编译结果</p>
<p>将编译后的代码（符合 ESM 规范）作为 HTTP 响应返回给浏览器，浏览器直接执行该模块。</p>
<p> </p>
<ol start="2">
<li>插件转换机制</li>
</ol>
<p>以 Vue 单文件组件（SFC）为例，<code>@vitejs/plugin-vue</code> 插件通过 <code>transform</code> 钩子拦截 <code>.vue</code> 文件请求，将其拆分为模板、脚本、样式三部分分别处理，再合并为浏览器可识别的 ESM 模块。</p>
<p> </p>
<h5 data-id="heading-41">4.4.3. 热更新（HMR）流程</h5>
<p>Vite 4 升级了 HMR 引擎，大型项目热更新延迟从 1200ms 降至 500ms 内，核心是"精确模块更新"而非全页刷新，依赖文件监听、模块依赖分析与 WebSocket 通信实现。</p>
<p> </p>
<p>关键步骤与源码</p>
<ol>
<li>文件变化监听与依赖分析</li>
</ol>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// vite/src/node/server/hmr.ts 核心逻辑简化版</span>
async <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleHMRUpdate</span>(<span class="hljs-params">file: <span class="hljs-keyword">string</span>, server: ViteDevServer</span>) </span>{
  <span class="hljs-keyword">const</span> { ws, config, moduleGraph } = server
  
  <span class="hljs-comment">// 1. 确定受影响的模块</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">mods</span> = moduleGraph.<span class="hljs-title function_ invoke__">getModulesByFile</span>(file)
  
  <span class="hljs-comment">// 2. 根据文件类型执行不同更新策略</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">isCSSRequest</span>(file)) {
    <span class="hljs-comment">// CSS热更新逻辑</span>
    await Promise.<span class="hljs-title function_ invoke__">all</span>(
      Array.<span class="hljs-keyword">from</span>(mods).<span class="hljs-title function_ invoke__">map</span>((mod) =&gt; {
        <span class="hljs-keyword">return</span> moduleGraph.<span class="hljs-title function_ invoke__">invalidateModule</span>(mod)
      })
    )
    ws.<span class="hljs-title function_ invoke__">send</span>({
      <span class="hljs-attr">type</span>: <span class="hljs-string">'update'</span>,
      <span class="hljs-attr">updates</span>: [{
        <span class="hljs-attr">type</span>: <span class="hljs-string">'css-update'</span>,
        <span class="hljs-attr">path</span>: publicPath,
        <span class="hljs-attr">timestamp</span>: Date.<span class="hljs-title function_ invoke__">now</span>()
      }]
    })
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// JS/HTML等热更新逻辑</span>
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">update</span> = await <span class="hljs-title function_ invoke__">generateUpdate</span>(mods, file, server)
    ws.<span class="hljs-title function_ invoke__">send</span>({
      <span class="hljs-attr">type</span>: <span class="hljs-string">'update'</span>,
      <span class="hljs-attr">updates</span>: update
    })
  }
}
 
</code></pre>
<p> </p>
<ol start="2">
<li>客户端更新处理</li>
</ol>
<p>浏览器端通过 <code>import.meta.hot</code> API 接收更新通知，替换模块并执行自定义更新逻辑（如 Vue 组件重新渲染）：</p>
<pre><code class="hljs language-javascript" lang="javascript">   <span class="hljs-comment">// 客户端 HMR 逻辑（src/client/client.ts）</span>
   <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">hot</span>.<span class="hljs-title function_">accept</span>(<span class="hljs-string">'./component.js'</span>, <span class="hljs-function">(<span class="hljs-params">newComponent</span>) =&gt;</span> {
     <span class="hljs-comment">// 替换组件并重新挂载</span>
     <span class="hljs-title function_">replaceComponent</span>(newComponent.<span class="hljs-property">default</span>)
   })
</code></pre>
<p> </p>
<p>HMR 流程可视化</p>
<p><img src="" alt="" loading="lazy"/></p>
<h5 data-id="heading-42">4.4.4. 生产构建流程（<code>vite build</code>）</h5>
<p>生产环境下，Vite 4 采用 Rollup 3 进行打包优化，核心是代码分割、压缩与兼容性处理，源码入口为 <code>src/node/build/index.ts</code>。</p>
<p> </p>
<p>关键步骤</p>
<ol>
<li>
<p>配置解析与构建准备：合并生产环境配置，确定目标浏览器与输出格式。</p>
</li>
<li>
<p>Rollup 配置生成：根据 Vite 配置自动生成 Rollup 配置，支持 <code>build.rollupOptions</code> 深度定制。</p>
</li>
<li>
<p>插件适配与执行：将 Vite 插件转换为 Rollup 插件格式，执行模块转换与优化。</p>
</li>
<li>
<p>产物优化：默认启用 Terser 压缩 JS，CSS 压缩通过 <code>cssnano</code> 实现，支持自定义压缩工具。</p>
</li>
</ol>
<p> </p>
<p>核心配置示例</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// Vite 4 生产构建配置</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  build: {
    target: <span class="hljs-string">'es2015'</span>, <span class="hljs-comment">// 目标浏览器兼容性</span>
    minify: <span class="hljs-string">'terser'</span>, <span class="hljs-comment">// 启用 Terser 压缩</span>
    rollupOptions: {
      <span class="hljs-comment">// 自定义代码分割策略</span>
      output: {
        manualChunks: {
          vendor: [<span class="hljs-string">'vue'</span>, <span class="hljs-string">'vue-router'</span>], <span class="hljs-comment">// 第三方依赖单独打包</span>
          utils: [<span class="hljs-string">'lodash'</span>, <span class="hljs-string">'dayjs'</span>]
        }
      }
    }
  }
}
</code></pre>
<p> </p>
<p> </p>
<h4 data-id="heading-43">4.5、Vite 4 核心技术亮点源码解析</h4>
<h5 data-id="heading-44">4.5.1. HMR 性能优化（V4 核心升级点）</h5>
<p>Vite 4 对 HMR 引擎进行了重构，通过差分更新与模块依赖缓存减少重复计算，源码关键优化点在 <code>ModuleGraph</code> 的 <code>invalidateModule</code> 方法中：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/node/server/moduleGraph.ts</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">invalidateModule</span>(<span class="hljs-params"><span class="hljs-variable language_">module</span></span>) {
  <span class="hljs-comment">// 仅标记变化模块，不清除整个依赖链缓存</span>
  <span class="hljs-variable language_">module</span>.<span class="hljs-property">invalidated</span> = <span class="hljs-literal">true</span>
  <span class="hljs-comment">// 递归标记依赖模块，但跳过已缓存的无变化模块</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> importer <span class="hljs-keyword">of</span> <span class="hljs-variable language_">module</span>.<span class="hljs-property">importers</span>) {
    <span class="hljs-keyword">if</span> (!importer.<span class="hljs-property">invalidated</span>) <span class="hljs-title function_">invalidateModule</span>(importer)
  }
}
</code></pre>
<p> </p>
<h5 data-id="heading-45">4.5.2. 中间件链设计（可扩展性核心）</h5>
<p>Vite 4 中间件按固定顺序执行，确保请求处理的正确性，核心中间件功能如下表：</p>






























<table><thead><tr><th>中间件</th><th>核心功能</th><th>源码路径</th></tr></thead><tbody><tr><td>transformMiddleware</td><td>模块实时编译（TS/Vue 转译）</td><td>src/node/server/middlewares/transform.ts</td></tr><tr><td>indexHtmlMiddleware</td><td>HTML 入口处理与资源注入</td><td>src/node/server/middlewares/indexHtml.ts</td></tr><tr><td>proxyMiddleware</td><td>跨域代理与请求转发</td><td>src/node/server/middlewares/proxy.ts</td></tr><tr><td>errorMiddleware</td><td>全局错误捕获与格式化</td><td>src/node/server/middlewares/error.ts</td></tr></tbody></table>
<p> </p>
<p> </p>
<h4 data-id="heading-46">4.6、核心流程总览流程图</h4>
<p><img src="" alt="" loading="lazy"/></p>
<p> </p>
<p>Vite 4 的源码设计核心是"扬长避短"：用 esbuild 处理快但不灵活的步骤（预构建、转译），用 Rollup 处理灵活但慢的生产打包，用中间件与插件系统保证可扩展性，最终实现"极速开发+优化产物"的双重目标。</p>
<h3 data-id="heading-47"> </h3>
<p> </p>
<p> </p>
<h3 data-id="heading-48">五、Vite 7 核心源码解析</h3>
<p> </p>
<h4 data-id="heading-49">5.1、Vite 7 核心架构与源码组织</h4>
<p>Vite 7 延续 monorepo 结构（基于 pnpm workspace），核心代码集中于 <code>packages/vite</code> 目录，在保留“开发服务器+生产构建”双核心的基础上，新增 Rust 引擎适配层与环境抽象层，形成“四层架构”体系。</p>
<p> </p>
<h4 data-id="heading-50">5.2. 核心模块概览</h4>



































<table><thead><tr><th>模块路径</th><th>核心职责</th><th>关键技术 / 工具</th></tr></thead><tbody><tr><td>src/node/cli.ts</td><td>命令行入口，解析参数并分发命令</td><td>cac（命令行解析）</td></tr><tr><td>src/node/config/</td><td>配置解析与合并，支持多环境配置隔离</td><td>环境抽象 API</td></tr><tr><td>src/node/server/</td><td>开发服务器实现，集成 HMR 与中间件</td><td>connect、chokidar</td></tr><tr><td>src/node/build/</td><td>生产构建核心，支持 Rolldown/Rollup 双引擎</td><td>Rolldown（Rust）、Rollup 3</td></tr><tr><td>src/node/plugin/</td><td>插件系统，兼容 Rollup 插件并扩展新钩子</td><td>插件过滤 API（withFilter）</td></tr></tbody></table>
<p> </p>
<h4 data-id="heading-51">5.3. 核心数据结构升级</h4>
<p>●  <code>ModuleGraph</code>（<code>src/node/server/moduleGraph.ts</code>）：新增 Rust 引擎依赖追踪能力，支持 Rolldown 模块解析结果与 JS 模块图的双向同步，解决双引擎依赖分析不一致问题。</p>
<p>●  <code>BuilderContext</code>（<code>src/node/build/builderContext.ts</code>）：统一构建上下文，封装引擎选择、产物优化等核心逻辑，屏蔽 Rolldown 与 Rollup 的调用差异。</p>
<p>●  <code>Environment</code>（<code>src/node/env/index.ts</code>）：环境描述对象，定义目标运行时（浏览器/Node/边缘）、兼容性标准等属性，为多环境构建提供基础。</p>
<p> </p>
<p> </p>
<h4 data-id="heading-52">5.4、核心流程源码解析</h4>
<p>Vite 7 的核心突破集中于 Rolldown 构建流程、多环境适配场景，以下结合源码片段深度拆解。</p>
<h5 data-id="heading-53">5.4.1Rolldown 预构建优化</h5>
<p>Vite 7 支持通过 Rolldown 处理依赖预构建，替代部分 esbuild 功能，尤其在 CJS 转 ESM 场景下性能提升显著。预构建逻辑位于 <code>src/node/optimizer/rolldownDepPlugin.ts</code> 调用 Rust 接口处理依赖转换，产物存储于 <code>node_modules/.vite/deps</code>，并生成引擎兼容的缓存元数据。</p>
<p> </p>
<p>启动流程可视化</p>
<p><img src="" alt="" loading="lazy"/></p>
<p>源码part1 part2</p>
<h5 data-id="heading-54">5.4.2. 生产构建流程（<code>vite build</code>）—— Rolldown 核心适配</h5>
<p>生产构建是 Vite 7 性能革新的核心场景，默认提供 Rolldown 引擎选项（通过 <code>rolldown-vite</code> 包集成），构建速度较 Rollup 提升 3-7 倍，内存占用减少 40% 以上。</p>
<p> </p>
<p>关键步骤与源码</p>
<ol>
<li>rolldown打包逻辑 part3</li>
</ol>
<pre><code class="hljs language-csharp" lang="csharp">   <span class="hljs-comment">// src/node/build.ts 简化逻辑</span>
   <span class="hljs-function"><span class="hljs-keyword">async</span> function <span class="hljs-title">buildEnvironment</span>(<span class="hljs-params">environment</span>)</span> {
    <span class="hljs-comment">// 1. 创建一个新的ChunkMetadataMap实例，用于存储和管理构建过程中的chunk元数据</span>
<span class="hljs-keyword">const</span> chunkMetadataMap = <span class="hljs-keyword">new</span> ChunkMetadataMap()
 
<span class="hljs-comment">// 2. 解析Rolldown配置选项，将环境配置和chunk元数据映射传递给解析函数</span>
<span class="hljs-comment">// 注意变量名虽然是rollupOptions，但实际返回的是Rolldown的配置</span>
<span class="hljs-keyword">const</span> rollupOptions = resolveRolldownOptions(environment, chunkMetadataMap)
 
<span class="hljs-comment">// 3. 检查是否处于监视模式（watch mode）</span>
<span class="hljs-keyword">if</span> (options.watch) {
  <span class="hljs-comment">// 4. 在控制台输出信息，告知用户正在监视文件变化</span>
  logger.info(colors.cyan(`\nwatching <span class="hljs-keyword">for</span> file changes...`))
 
  <span class="hljs-comment">// 5. 解析输出目录，获取构建产物将被写入的目录路径</span>
  <span class="hljs-keyword">const</span> resolvedOutDirs = getResolvedOutDirs(
    root,
    options.outDir,
    options.rollupOptions.output,  <span class="hljs-comment">// 使用rollupOptions.output作为输出配置</span>
  )
  
  <span class="hljs-comment">// 6. 解析是否需要清空输出目录的设置</span>
  <span class="hljs-keyword">const</span> emptyOutDir = resolveEmptyOutDir(
    options.emptyOutDir,  <span class="hljs-comment">// 用户配置的emptyOutDir选项</span>
    root,
    resolvedOutDirs,      <span class="hljs-comment">// 解析后的输出目录</span>
    logger,
  )
  
  <span class="hljs-comment">// 7. 解析文件监视选项（Chokidar配置）</span>
  <span class="hljs-keyword">const</span> resolvedChokidarOptions = resolveChokidarOptions(
    {
      <span class="hljs-comment">// 8. 合并配置中的chokidar选项（虽然Rolldown没有这个选项，但为了向后兼容保留）</span>
      <span class="hljs-comment">// @ts-expect-error 标记：chokidar选项在rolldown中不存在，但为了向后兼容而使用</span>
      ...(rollupOptions.watch || {}).chokidar,
      <span class="hljs-comment">// @ts-expect-error 同样标记：用户配置的watch.chokidar选项</span>
      ...options.watch.chokidar,
    },
    resolvedOutDirs,      <span class="hljs-comment">// 输出目录</span>
    emptyOutDir,          <span class="hljs-comment">// 是否清空输出目录</span>
    environment.config.cacheDir,  <span class="hljs-comment">// 缓存目录</span>
  )
 
  <span class="hljs-comment">// 9. 动态导入rolldown的watch函数</span>
  <span class="hljs-keyword">const</span> { watch } = <span class="hljs-keyword">await</span> import(<span class="hljs-string">'rolldown'</span>)
  
  <span class="hljs-comment">// 10. 创建Rolldown的watcher实例，传入配置选项</span>
  <span class="hljs-keyword">const</span> watcher = watch({
    ...rollupOptions,  <span class="hljs-comment">// 基础构建配置</span>
    watch: {           <span class="hljs-comment">// 监视模式特定配置</span>
      ...rollupOptions.watch,  <span class="hljs-comment">// 合并原有watch配置</span>
      ...options.watch,        <span class="hljs-comment">// 合并用户提供的watch配置</span>
      <span class="hljs-comment">// 11. 将Chokidar配置转换为Rolldown的notify选项</span>
      notify: convertToNotifyOptions(resolvedChokidarOptions),
    },
  })
 
  <span class="hljs-comment">// 12. 监听watcher事件</span>
  watcher.<span class="hljs-keyword">on</span>(<span class="hljs-string">'event'</span>, (<span class="hljs-keyword">event</span>) =&gt; {
    <span class="hljs-comment">// 13. 当构建开始时的处理</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">event</span>.code === <span class="hljs-string">'BUNDLE_START'</span>) {
      logger.info(colors.cyan(`\nbuild started...`))  <span class="hljs-comment">// 输出构建开始信息</span>
      chunkMetadataMap.clearResetChunks()  <span class="hljs-comment">// 清除并重置chunk元数据</span>
    } 
    <span class="hljs-comment">// 14. 当构建结束时的处理</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">event</span>.code === <span class="hljs-string">'BUNDLE_END'</span>) {
      <span class="hljs-keyword">event</span>.result.close()  <span class="hljs-comment">// 关闭构建结果，释放资源</span>
      logger.info(colors.cyan(`built <span class="hljs-keyword">in</span> ${<span class="hljs-keyword">event</span>.duration}ms.`))  <span class="hljs-comment">// 输出构建耗时</span>
    } 
    <span class="hljs-comment">// 15. 当发生错误时的处理</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">event</span>.code === <span class="hljs-string">'ERROR'</span>) {
      <span class="hljs-keyword">const</span> e = <span class="hljs-keyword">event</span>.<span class="hljs-function">error
      <span class="hljs-title">enhanceRollupError</span>(<span class="hljs-params">e</span>)  <span class="hljs-comment">// 增强错误信息，使其更有用</span>
      <span class="hljs-title">clearLine</span>()  <span class="hljs-comment">// 清除控制台当前行</span>
      logger.<span class="hljs-title">error</span>(<span class="hljs-params">e.message, { error: e }</span>)  <span class="hljs-comment">// 输出错误信息</span>
    }
  })
 
  <span class="hljs-comment">// 16. 返回watcher实例，允许外部控制监视过程</span>
  <span class="hljs-keyword">return</span> watcher
}
 
<span class="hljs-comment">// 17. 非监视模式：使用rolldown进行单次构建</span>
<span class="hljs-comment">// write or generate files with rolldown</span>
<span class="hljs-keyword">const</span></span> { rolldown } = <span class="hljs-keyword">await</span> import(<span class="hljs-string">'rolldown'</span>)  <span class="hljs-comment">// 动态导入rolldown函数</span>
startTime = Date.now()  <span class="hljs-comment">// 记录构建开始时间</span>
 
<span class="hljs-comment">// 18. 使用配置创建rolldown实例</span>
bundle = <span class="hljs-keyword">await</span> rolldown(rollupOptions)
 
<span class="hljs-comment">// 19. 创建一个数组来存储构建输出结果</span>
<span class="hljs-keyword">const</span> res: RolldownOutput[] = []
 
<span class="hljs-comment">// 20. 遍历所有输出配置（可能有多个输出配置）</span>
<span class="hljs-keyword">for</span> (<span class="hljs-function"><span class="hljs-keyword">const</span> output of <span class="hljs-title">arraify</span>(<span class="hljs-params">rollupOptions.output!</span>))</span> {
  <span class="hljs-comment">// 21. 根据options.write决定是写入文件还是仅生成输出内容</span>
  <span class="hljs-comment">// 如果options.write为true则调用bundle.write()，否则调用bundle.generate()</span>
  res.push(<span class="hljs-keyword">await</span> bundle[options.write ? <span class="hljs-string">'write'</span> : <span class="hljs-string">'generate'</span>](output))
}
   }
</code></pre>
<ol start="3">
<li>性能优化关键点</li>
</ol>
<p>●  单一引擎架构：开发与生产环境统一使用 Rolldown 处理依赖解析与模块转换，避免双工具链的数据重复序列化/反序列化开销。</p>
<p>●  Oxc 工具集集成：替代 esbuild 处理代码解析与转译，内存使用效率提升显著，大型项目构建内存占用可减少 100 倍。</p>
<p> </p>
<h5 data-id="heading-55">5.4.3. 多环境适配流程（核心功能升级）</h5>
<p>Vite 7 稳定了多环境 API，支持浏览器、Node、边缘服务器等多运行时目标</p>
<p> </p>
<p>关键逻辑与源码通过代理将rollup转发到rolldown处理</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> setupRollupOptionCompat&lt;
  T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Pick</span>&lt;<span class="hljs-title class_">BuildEnvironmentOptions</span>, <span class="hljs-string">'rollupOptions'</span> | <span class="hljs-string">'rolldownOptions'</span>&gt;,
&gt;(
  <span class="hljs-attr">buildConfig</span>: T,
): asserts buildConfig is T &amp; {
  <span class="hljs-attr">rolldownOptions</span>: <span class="hljs-title class_">Exclude</span>&lt;T[<span class="hljs-string">'rolldownOptions'</span>], <span class="hljs-literal">undefined</span>&gt;
} {
  <span class="hljs-comment">// if both rollupOptions and rolldownOptions are present,</span>
  <span class="hljs-comment">// ignore rollupOptions and use rolldownOptions</span>
   <span class="hljs-comment">// 如果同时存在rollupOptions和rolldownOptions，忽略rollupOptions</span>
  buildConfig.<span class="hljs-property">rolldownOptions</span> ??= buildConfig.<span class="hljs-property">rollupOptions</span>
 
  <span class="hljs-comment">// proxy rolldownOptions to rollupOptions</span>
  <span class="hljs-comment">// 通过代理将rollupOptions的访问转发到rolldownOptions</span>
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(buildConfig, <span class="hljs-string">'rollupOptions'</span>, {
    <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> buildConfig.<span class="hljs-property">rolldownOptions</span>
    },
    <span class="hljs-title function_">set</span>(<span class="hljs-params">newValue</span>) {
      buildConfig.<span class="hljs-property">rolldownOptions</span> = newValue
    },
    <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
  })
}
 
</code></pre>
<p> </p>
<h4 data-id="heading-56">5.4、核心流程总览流程图</h4>
<p><img src="" alt="" loading="lazy"/></p>
<h4 data-id="heading-57">5.5、源码学习建议</h4>
<ol>
<li>
<p>入门路径：从 <code>vite dev</code> 启动流程切入，先理解 <code>createServer</code> 函数的整体逻辑，再深入中间件与模块图实现。</p>
</li>
<li>
<p>核心突破点：重点分析 <code>transformMiddleware</code> 如何实现按需编译，以及 <code>ModuleGraph</code> 如何维护依赖关系。</p>
</li>
<li>
<p>调试技巧：通过 <code>DEBUG=vite:* vite dev</code> 打印调试日志，追踪请求处理与 HMR 触发流程。</p>
</li>
</ol>
<p>4 . 拥抱ai 配合aiide做源码解析梳理核心流程细节</p>
<p>5 . 先脉络后细节</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangGraph智能体开发快速入门]]></title>    <link>https://juejin.cn/post/7574967214127808538</link>    <guid>https://juejin.cn/post/7574967214127808538</guid>    <pubDate>2025-11-21T08:54:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574967214127808538" data-draft-id="7574978545143775267" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangGraph智能体开发快速入门"/> <meta itemprop="keywords" content="LangChain,Agent,后端"/> <meta itemprop="datePublished" content="2025-11-21T08:54:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="FreeCode"/> <meta itemprop="url" content="https://juejin.cn/user/1282499717900794"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangGraph智能体开发快速入门
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1282499717900794/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    FreeCode
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T08:54:47.000Z" title="Fri Nov 21 2025 08:54:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><h2 data-id="heading-0">一、 初识LangGraph</h2>
<p>LangGraph受到诸多引领智能体（agent）未来发展的企业信赖，包括 Klarna、Replit、Elastic等。 它是一款底层编排框架与运行时环境，用于构建、管理和部署长期运行的有状态智能体。
LangGraph属于底层的工具，它专注于智能体编排所需的核心底层能力，包括持久化执行（durable execution）、流式处理（streaming）、人机协同（human-in-the-loop）等。</p>
<p><strong>示例:</strong></p>
<p>安装：
pip install -U langgraph
示例代码：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph, MessagesState, START, END

<span class="hljs-keyword">def</span> <span class="hljs-title function_">mock_llm</span>(<span class="hljs-params">state: MessagesState</span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"ai"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"hello world"</span>}]}

graph = StateGraph(MessagesState)
graph.add_node(mock_llm)
graph.add_edge(START, <span class="hljs-string">"mock_llm"</span>)
graph.add_edge(<span class="hljs-string">"mock_llm"</span>, END)
graph = graph.<span class="hljs-built_in">compile</span>()

graph.invoke({<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"hi!"</span>}]})
</code></pre>
<h2 data-id="heading-1">二、核心优势</h2>
<p>LangGraph为所有长期运行的有状态工作流或智能体（agent）提供底层支持架构。LangGraph不封装提示词（prompts）或架构，其核心优势如下：</p>
<ul>
<li>持久化执行（Durable execution）：构建可跨故障持续运行的智能体，支持长时间执行，且能从中断处恢复任务进度。</li>
<li>人机协同（Human-in-the-loop）：支持在任意节点检查和修改智能体状态，从而融入人工监督环节。</li>
<li>全面的记忆能力（Comprehensive memory）：打造有状态智能体，既具备用于实时推理的短期工作记忆，也拥有跨会话的长期记忆。</li>
<li>借助LangSmith调试（Debugging with LangSmith）：通过可视化工具深入洞察复杂智能体的行为 —— 这些工具可追踪执行路径、捕捉状态转换，并提供详细的运行时指标。</li>
<li>可投入生产环境的部署（Production-ready deployment）：依托为应对有状态、长期运行工作流特有挑战而设计的可扩展架构，放心部署复杂的智能体系统。</li>
</ul>
<h2 data-id="heading-2">三、LangGraph生态系统</h2>
<p>LangGraph既可独立使用，也能与任意LangChain产品无缝集成，为开发者提供构建智能体（agent）所需的全套工具。若需提升大语言模型（LLM）应用的开发效率，可将LangGraph与以下工具搭配使用：</p>
<ul>
<li>LangSmith—— 助力智能体评估（agent evals）与可观测性（observability）。可用于调试性能不佳的 LLM 应用运行过程、评估智能体执行轨迹（agent trajectories）、掌握生产环境中的运行状态，并逐步优化性能。</li>
<li>LangGraph（平台服务）—— 借助专为长期运行的有状态工作流设计的部署平台，轻松实现智能体的部署与扩展。支持跨团队发现、复用、配置及共享智能体，还可通过Studio中的可视化原型设计快速迭代。</li>
<li>LangChain—— 提供各类集成能力与可组合组件，简化LLM应用开发流程。其包含基于LangGraph构建的智能体抽象层。</li>
</ul>
<h2 data-id="heading-3">四、LangGraph v1</h2>
<p>LangGraph v1 是一款聚焦智能体运行时（agent runtime）稳定性的版本。该版本保留了核心图 API（graph APIs）与执行模型的原有设计，同时优化了类型安全性（type safety）、文档（docs）以及开发者使用体验（developer ergonomics）。</p>
<p>LangGraph v1 旨在与 LangChain v1 版本协同工作 ——LangChain v1 的 create_agent 功能正是基于 LangGraph 构建 —— 因此，你既可以从高层级抽象开始开发，也能在需要时深入到细粒度控制层面。</p>
<p>下表列出了 LangGraph v1 中所有已弃用的项目：</p>

















































<table><thead><tr><th>已弃用项目（Deprecated item）</th><th>替代方案（Alternative）</th></tr></thead><tbody><tr><td>create_react_agent</td><td>langchain.agents.create_agent</td></tr><tr><td>AgentState</td><td>langchain.agents.AgentState</td></tr><tr><td>AgentStatePydantic</td><td>langchain.agents.AgentState（不再有 Pydantic 状态，no more pydantic state）</td></tr><tr><td>AgentStateWithStructuredResponse</td><td>langchain.agents.AgentState</td></tr><tr><td>AgentStateWithStructuredResponsePydantic</td><td>langchain.agents.AgentState（不再有 Pydantic 状态，no more pydantic state）</td></tr><tr><td>HumanInterruptConfig</td><td>langchain.agents.middleware.human_in_the_loop.InterruptOnConfig</td></tr><tr><td>HumanInterrupt</td><td>langchain.agents.middleware.human_in_the_loop.InterruptOnConfig</td></tr><tr><td>ActionRequest</td><td>langchain.agents.middleware.human_in_the_loop.HITLRequest</td></tr><tr><td>ValidationNode</td><td>工具会自动验证输入</td></tr><tr><td>MessageGraph</td><td>带有 messages 键的 StateGraph，类似 create_agent 所提供的</td></tr></tbody></table>
<h2 data-id="heading-4">五、构建智能体</h2>
<p>LangGraph 提供两种方式构建智能体：Graph API 和 Functional API）</p>
<ul>
<li>若你倾向于将智能体定义为由节点（nodes）和边（edges）构成的图结构，可使用图 API（Graph API）。</li>
<li>若你倾向于将智能体定义为单个函数，可使用函数式 API（Functional API）。</li>
</ul>
<h3 data-id="heading-5">5.1  Graph API构建智能体</h3>
<h4 data-id="heading-6">1. 定义工具与模型</h4>
<p>在本示例中，我们将使用 Claude Sonnet 4.5 模型，并定义用于加法、乘法和除法运算的工具。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model
<span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> api_key, api_base

model = init_chat_model(
        api_key = api_key,
        base_url = api_base,
        model = <span class="hljs-string">"Qwen/Qwen3-8B"</span>,
        model_provider = <span class="hljs-string">"openai"</span>,
        temperature = <span class="hljs-number">0</span>,
)

<span class="hljs-comment"># Define tools</span>
<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">multiply</span>(<span class="hljs-params">a: <span class="hljs-built_in">int</span>, b: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:
    <span class="hljs-string">"""Multiply `a` and `b`.

    Args:
        a: First int
        b: Second int
    """</span>
    <span class="hljs-keyword">return</span> a * b

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a: <span class="hljs-built_in">int</span>, b: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:
    <span class="hljs-string">"""Adds `a` and `b`.

    Args:
        a: First int
        b: Second int
    """</span>
    <span class="hljs-keyword">return</span> a + b

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">divide</span>(<span class="hljs-params">a: <span class="hljs-built_in">int</span>, b: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">float</span>:
    <span class="hljs-string">"""Divide `a` and `b`.

    Args:
        a: First int
        b: Second int
    """</span>
    <span class="hljs-keyword">return</span> a / b

<span class="hljs-comment"># Augment the LLM with tools</span>
tools = [add, multiply, divide]
tools_by_name = {tool.name: tool <span class="hljs-keyword">for</span> tool <span class="hljs-keyword">in</span> tools}
model_with_tools = model.bind_tools(tools)
</code></pre>
<h4 data-id="heading-7">2. 定义状态</h4>
<p>图的状态用于存储消息（messages）和大语言模型（LLM）调用次数。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.messages <span class="hljs-keyword">import</span> AnyMessage
<span class="hljs-keyword">from</span> typing_extensions <span class="hljs-keyword">import</span> TypedDict, Annotated
<span class="hljs-keyword">import</span> operator

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MessagesState</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    messages: Annotated[<span class="hljs-built_in">list</span>[AnyMessage], operator.add]
    llm_calls: <span class="hljs-built_in">int</span>
</code></pre>
<h4 data-id="heading-8">3. 定义模型节点</h4>
<p>模型节点用于调用大语言模型（LLM），并判断是否需要调用工具。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.messages <span class="hljs-keyword">import</span> SystemMessage

<span class="hljs-keyword">def</span> <span class="hljs-title function_">llm_call</span>(<span class="hljs-params">state: <span class="hljs-built_in">dict</span></span>):
    <span class="hljs-string">"""LLM decides whether to call a tool or not"""</span>

    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"messages"</span>: [
            model_with_tools.invoke(
                [
                    SystemMessage(
                        content=<span class="hljs-string">"You are a helpful assistant tasked with performing arithmetic on a set of inputs."</span>
                    )
                ]
                + state[<span class="hljs-string">"messages"</span>]
            )
        ],
        <span class="hljs-string">"llm_calls"</span>: state.get(<span class="hljs-string">'llm_calls'</span>, <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>
    }
</code></pre>
<h4 data-id="heading-9">4. 定义工具节点</h4>
<p>工具节点用于调用工具并返回结果。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.messages <span class="hljs-keyword">import</span> ToolMessage

<span class="hljs-keyword">def</span> <span class="hljs-title function_">tool_node</span>(<span class="hljs-params">state: <span class="hljs-built_in">dict</span></span>):
    <span class="hljs-string">"""Performs the tool call"""</span>

    result = []
    <span class="hljs-keyword">for</span> tool_call <span class="hljs-keyword">in</span> state[<span class="hljs-string">"messages"</span>][-<span class="hljs-number">1</span>].tool_calls:
        tool = tools_by_name[tool_call[<span class="hljs-string">"name"</span>]]
        observation = tool.invoke(tool_call[<span class="hljs-string">"args"</span>])
        result.append(ToolMessage(content=observation, tool_call_id=tool_call[<span class="hljs-string">"id"</span>]))
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"messages"</span>: result}
</code></pre>
<h4 data-id="heading-10">5. 定义结束逻辑</h4>
<p>条件边函数（conditional edge function）用于根据大语言模型（LLM）是否发起了工具调用来决定路由至工具节点（tool node）或进入结束状态。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Literal</span>
<span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph, START, END

<span class="hljs-keyword">def</span> <span class="hljs-title function_">should_continue</span>(<span class="hljs-params">state: MessagesState</span>) -&gt; <span class="hljs-type">Literal</span>[<span class="hljs-string">"tool_node"</span>, END]:
    <span class="hljs-string">"""Decide if we should continue the loop or stop based upon whether the LLM made a tool call"""</span>

    messages = state[<span class="hljs-string">"messages"</span>]
    last_message = messages[-<span class="hljs-number">1</span>]

    <span class="hljs-comment"># If the LLM makes a tool call, then perform an action</span>
    <span class="hljs-keyword">if</span> last_message.tool_calls:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"tool_node"</span>

    <span class="hljs-comment"># Otherwise, we stop (reply to the user)</span>
    <span class="hljs-keyword">return</span> END
</code></pre>
<h4 data-id="heading-11">6. 构建并编译智能体</h4>
<p>智能体通过 StateGraph 类构建，并使用 compile 方法进行编译。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Build workflow</span>
agent_builder = StateGraph(MessagesState)

<span class="hljs-comment"># Add nodes</span>
agent_builder.add_node(<span class="hljs-string">"llm_call"</span>, llm_call)
agent_builder.add_node(<span class="hljs-string">"tool_node"</span>, tool_node)

<span class="hljs-comment"># Add edges to connect nodes</span>
agent_builder.add_edge(START, <span class="hljs-string">"llm_call"</span>)
agent_builder.add_conditional_edges(
    <span class="hljs-string">"llm_call"</span>,
    should_continue,
    [<span class="hljs-string">"tool_node"</span>, END]
)
agent_builder.add_edge(<span class="hljs-string">"tool_node"</span>, <span class="hljs-string">"llm_call"</span>)

<span class="hljs-comment"># Compile the agent</span>
agent = agent_builder.<span class="hljs-built_in">compile</span>()

<span class="hljs-comment"># Show the agent</span>
<span class="hljs-keyword">from</span> IPython.display <span class="hljs-keyword">import</span> Image, display
display(Image(agent.get_graph(xray=<span class="hljs-literal">True</span>).draw_mermaid_png()))

<span class="hljs-comment"># Invoke</span>
<span class="hljs-keyword">from</span> langchain.messages <span class="hljs-keyword">import</span> HumanMessage
messages = [HumanMessage(content=<span class="hljs-string">"Add 3 and 4."</span>)]
messages = agent.invoke({<span class="hljs-string">"messages"</span>: messages})
<span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> messages[<span class="hljs-string">"messages"</span>]:
    m.pretty_print()
</code></pre>
<h3 data-id="heading-12">5.2 Functional API构建智能体</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Step 1: Define tools and model</span>

<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model
<span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> api_key, api_base

model = init_chat_model(
        api_key = api_key,
        base_url = api_base,
        model = <span class="hljs-string">"Qwen/Qwen3-8B"</span>,
        model_provider = <span class="hljs-string">"openai"</span>,
        temperature = <span class="hljs-number">0</span>,
)

<span class="hljs-comment"># Define tools</span>
<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">multiply</span>(<span class="hljs-params">a: <span class="hljs-built_in">int</span>, b: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:
    <span class="hljs-string">"""Multiply `a` and `b`.

    Args:
        a: First int
        b: Second int
    """</span>
    <span class="hljs-keyword">return</span> a * b

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a: <span class="hljs-built_in">int</span>, b: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:
    <span class="hljs-string">"""Adds `a` and `b`.

    Args:
        a: First int
        b: Second int
    """</span>
    <span class="hljs-keyword">return</span> a + b

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">divide</span>(<span class="hljs-params">a: <span class="hljs-built_in">int</span>, b: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">float</span>:
    <span class="hljs-string">"""Divide `a` and `b`.

    Args:
        a: First int
        b: Second int
    """</span>
    <span class="hljs-keyword">return</span> a / b

<span class="hljs-comment"># Augment the LLM with tools</span>
tools = [add, multiply, divide]
tools_by_name = {tool.name: tool <span class="hljs-keyword">for</span> tool <span class="hljs-keyword">in</span> tools}
model_with_tools = model.bind_tools(tools)

<span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> add_messages
<span class="hljs-keyword">from</span> langchain.messages <span class="hljs-keyword">import</span> (
    SystemMessage,
    HumanMessage,
    ToolCall,
)
<span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> BaseMessage
<span class="hljs-keyword">from</span> langgraph.func <span class="hljs-keyword">import</span> entrypoint, task

<span class="hljs-comment"># Step 2: Define model node</span>

<span class="hljs-meta">@task</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">call_llm</span>(<span class="hljs-params">messages: <span class="hljs-built_in">list</span>[BaseMessage]</span>):
    <span class="hljs-string">"""LLM decides whether to call a tool or not"""</span>
    <span class="hljs-keyword">return</span> model_with_tools.invoke(
        [
            SystemMessage(
                content=<span class="hljs-string">"You are a helpful assistant tasked with performing arithmetic on a set of inputs."</span>
            )
        ]
        + messages
    )

<span class="hljs-comment"># Step 3: Define tool node</span>

<span class="hljs-meta">@task</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">call_tool</span>(<span class="hljs-params">tool_call: ToolCall</span>):
    <span class="hljs-string">"""Performs the tool call"""</span>
    tool = tools_by_name[tool_call[<span class="hljs-string">"name"</span>]]
    <span class="hljs-keyword">return</span> tool.invoke(tool_call)

<span class="hljs-comment"># Step 4: Define agent</span>

<span class="hljs-meta">@entrypoint()</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">agent</span>(<span class="hljs-params">messages: <span class="hljs-built_in">list</span>[BaseMessage]</span>):
    model_response = call_llm(messages).result()

    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> model_response.tool_calls:
            <span class="hljs-keyword">break</span>

        <span class="hljs-comment"># Execute tools</span>
        tool_result_futures = [
            call_tool(tool_call) <span class="hljs-keyword">for</span> tool_call <span class="hljs-keyword">in</span> model_response.tool_calls
        ]
        tool_results = [fut.result() <span class="hljs-keyword">for</span> fut <span class="hljs-keyword">in</span> tool_result_futures]
        messages = add_messages(messages, [model_response, *tool_results])
        model_response = call_llm(messages).result()

    messages = add_messages(messages, model_response)
    <span class="hljs-keyword">return</span> messages

<span class="hljs-comment"># Invoke</span>
messages = [HumanMessage(content=<span class="hljs-string">"Add 3 and 4."</span>)]
<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> agent.stream(messages, stream_mode=<span class="hljs-string">"updates"</span>):
    <span class="hljs-built_in">print</span>(chunk)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span>)
</code></pre>
<h2 data-id="heading-13">六、总结</h2>
<p>本文带领大家快速认识LangGraph，了解它的优势和生态系统，以及V1.0版本的变化。文章还介绍了LangGraph构建智能体的两种方式Graph API和Functional API。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端实现 Server-Sent Events 全解析：从代码到调试的实战指南]]></title>    <link>https://juejin.cn/post/7574958975159812139</link>    <guid>https://juejin.cn/post/7574958975159812139</guid>    <pubDate>2025-11-21T08:51:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574958975159812139" data-draft-id="7574958975159533611" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端实现 Server-Sent Events 全解析：从代码到调试的实战指南"/> <meta itemprop="keywords" content="前端,uni-app"/> <meta itemprop="datePublished" content="2025-11-21T08:51:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Amy_yang"/> <meta itemprop="url" content="https://juejin.cn/user/254742430497304"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端实现 Server-Sent Events 全解析：从代码到调试的实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/254742430497304/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Amy_yang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T08:51:24.000Z" title="Fri Nov 21 2025 08:51:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">什么是 Server-Sent Events</h2>
<p>当你在使用 ChatGPT 等 AI 对话产品时，是否注意到回答内容会逐字出现在屏幕上？这种"打字机"效果背后，很可能就是 Server-Sent Events（SSE）技术在发挥作用。与传统的 AJAX 请求不同，SSE 允许服务器在建立一次连接后持续向客户端推送数据，特别适合需要实时更新的场景。</p>
<p>SSE 本质上是一种基于 HTTP 的 server push 技术，它通过特殊的 text/event-stream 响应类型，让服务器能够随时向客户端发送数据。与 WebSocket 相比，SSE 具有<strong>实现简单</strong>、<strong>轻量级</strong>和<strong>自动重连</strong>等优势，非常适合单向的实时数据推送场景。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7fd06814f2a44bc4b282f40941ad25bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW15X3lhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764319884&amp;x-signature=u2kivDl9Uzs4O4ecQpn%2ByXLeAAc%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">SSE 前端实现核心代码解析</h2>
<h3 data-id="heading-2">API 封装层设计</h3>
<p>我们先来看最上层的 API 封装。下面这段代码定义了一个 questionAPI 函数，它是与 SSE 服务端交互的入口：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 智能问答 API 封装</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">questionAPI</span> = (<span class="hljs-params">data, { onMessage, onComplete }</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">request</span>({
    <span class="hljs-attr">method</span>: <span class="hljs-string">"post"</span>,
    <span class="hljs-attr">url</span>: <span class="hljs-string">"/chats"</span>,
    <span class="hljs-attr">data</span>: data,
    <span class="hljs-attr">isSSE</span>: <span class="hljs-literal">true</span>,
    onMessage,  <span class="hljs-comment">// 传递消息回调</span>
    onComplete  <span class="hljs-comment">// 传递完成回调</span>
  });
};
</code></pre>
<p>这个封装有几个关键点：</p>
<ul>
<li>通过 isSSE: true 标记这是一个 SSE 请求</li>
<li>接收 onMessage 和 onComplete 两个回调函数</li>
<li>与普通 API 调用方式保持一致，降低使用门槛</li>
</ul>
<h3 data-id="heading-3">请求层实现</h3>
<p>接下来是底层的 request 函数实现，这是处理 SSE 的核心部分：</p>
<p><strong>该部分封装用的是uni.request，这部分根据你的实际开发环境来替换。逻辑是不变得</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (options.<span class="hljs-property">isSSE</span>) {
    <span class="hljs-keyword">let</span> buffer = <span class="hljs-string">""</span>;  <span class="hljs-comment">// 缓存未完整的数据块</span>
    <span class="hljs-keyword">const</span> requestTask = uni.<span class="hljs-title function_">request</span>({
        <span class="hljs-attr">url</span>: <span class="hljs-string">"xxx"</span> + options.<span class="hljs-property">url</span>,
      <span class="hljs-attr">method</span>: options.<span class="hljs-property">method</span>,
      <span class="hljs-attr">data</span>: options.<span class="hljs-property">data</span> || options.<span class="hljs-property">params</span>,
      <span class="hljs-attr">header</span>: {
        <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span>,
        <span class="hljs-string">"Accept"</span>: <span class="hljs-string">"text/event-stream"</span>,  <span class="hljs-comment">// SSE 必需请求头</span>
        ...(token &amp;&amp; { token }),
      },
      <span class="hljs-attr">enableChunked</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 开启分块传输</span>
      <span class="hljs-attr">responseType</span>: <span class="hljs-string">"stream"</span>,  <span class="hljs-comment">// 流类型响应</span>
      <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"SSE 请求完成"</span>, res);
      },
      <span class="hljs-attr">fail</span>: <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"SSE 请求失败"</span>, err);
        uni.<span class="hljs-title function_">hideLoading</span>();
        <span class="hljs-title function_">reject</span>(err);
      },
      <span class="hljs-attr">complete</span>: <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"SSE 请求结束"</span>);
        uni.<span class="hljs-title function_">hideLoading</span>();
        <span class="hljs-comment">// 处理缓冲区剩余数据</span>
        <span class="hljs-keyword">if</span> (buffer.<span class="hljs-title function_">trim</span>()) {
          <span class="hljs-keyword">if</span> (options.<span class="hljs-property">onMessage</span>) {
            options.<span class="hljs-title function_">onMessage</span>(buffer);
          }
        }
        <span class="hljs-keyword">if</span> (options.<span class="hljs-property">onComplete</span>) {
          options.<span class="hljs-title function_">onComplete</span>();
        }
        <span class="hljs-title function_">resolve</span>();
      },
    });

    <span class="hljs-comment">// 监听分块数据接收</span>
    requestTask.<span class="hljs-title function_">onChunkReceived</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
      uni.<span class="hljs-title function_">hideLoading</span>();
      <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 将二进制数据解码为文本</span>
        <span class="hljs-keyword">const</span> chunk = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>().<span class="hljs-title function_">decode</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(res.<span class="hljs-property">data</span>));
        buffer += chunk;  <span class="hljs-comment">// 追加到缓冲区</span>

        <span class="hljs-comment">// 按 SSE 格式分割数据（双换行符分隔）</span>
        <span class="hljs-keyword">const</span> messages = buffer.<span class="hljs-title function_">split</span>(<span class="hljs-string">"\n\n"</span>);
        <span class="hljs-comment">// 保留最后一个可能不完整的消息</span>
        buffer = messages.<span class="hljs-title function_">pop</span>() || <span class="hljs-string">""</span>;

        <span class="hljs-comment">// 处理完整的消息</span>
        messages.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">message</span>) =&gt;</span> {
          <span class="hljs-keyword">if</span> (message.<span class="hljs-title function_">trim</span>()) {
            <span class="hljs-comment">// 触发回调函数</span>
            <span class="hljs-keyword">if</span> (options.<span class="hljs-property">onMessage</span>) {
              options.<span class="hljs-title function_">onMessage</span>(message);
            }
          }
        });
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"解析 SSE 数据失败:"</span>, error);
      }
    });
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 普通请求处理逻辑...</span>
  }
});
</code></pre>
<p>这段代码实现了 SSE 的核心功能，主要包括：</p>
<ol>
<li><strong>设置正确的请求头</strong>：Accept: "text/event-stream" 是 SSE 的标志性请求头</li>
<li><strong>开启分块传输</strong>：enableChunked: true 确保能够接收流式数据</li>
<li><strong>分块数据处理</strong>：通过 onChunkReceived 事件监听数据块到达</li>
<li><strong>数据缓冲区</strong>：使用 buffer 变量处理可能被分割的不完整数据块</li>
<li><strong>SSE 格式解析</strong>：按双换行符 \n\n 分割完整的 SSE 消息</li>
</ol>
<h3 data-id="heading-4">业务逻辑层调用</h3>
<p>最后是在 Vue 组件中如何使用这个 API：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">questionAPI</span>(
  {
    <span class="hljs-attr">user</span>: user,
    <span class="hljs-attr">session_id</span>: questionContent.<span class="hljs-property">value</span>.<span class="hljs-property">session_id</span>,
    <span class="hljs-attr">messages</span>: [
      {
        <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>,
        <span class="hljs-attr">content</span>: type === <span class="hljs-string">"otherQuestions"</span> ? item : sendMessage.<span class="hljs-property">value</span>,
      },
    ]
  },
  {
    <span class="hljs-attr">onMessage</span>: <span class="hljs-keyword">async</span> (message) =&gt; {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"SSE 流式数据:"</span>, message);
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">handleSSEMessage</span>(message, fullContentRef, messageIndex);
    },
    <span class="hljs-attr">onComplete</span>: <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"SSE 流式传输完成"</span>);
      <span class="hljs-comment">// 处理最终内容渲染</span>
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">immediateRender</span>(<span class="hljs-keyword">async</span> () =&gt; {
        <span class="hljs-keyword">if</span> (questionContent.<span class="hljs-property">value</span>.<span class="hljs-property">messages</span>[messageIndex]) {
          questionContent.<span class="hljs-property">value</span>.<span class="hljs-property">messages</span>[messageIndex].<span class="hljs-property">content</span> =
            <span class="hljs-keyword">await</span> <span class="hljs-title function_">renderMarkdown</span>(fullContentRef.<span class="hljs-property">value</span>);
          <span class="hljs-title function_">scrollToBottom</span>(questionContent.<span class="hljs-property">value</span>.<span class="hljs-property">messages</span>);
        }
      });
      sendMessage.<span class="hljs-property">value</span> = <span class="hljs-string">""</span>;
      anserLoading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
    },
  }
).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"AI报错"</span>, e);
  messageDialog.<span class="hljs-property">value</span>?.<span class="hljs-title function_">showMessage</span>(
    e.<span class="hljs-property">message</span> || <span class="hljs-string">"AI 请求失败，请重试"</span>,
    <span class="hljs-string">"error"</span>
  );
  anserLoading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
});
</code></pre>
<p>在业务层，我们主要关注：</p>
<ul>
<li>传递请求参数（用户信息、问题内容等）</li>
<li>实现 onMessage 回调处理流式数据</li>
<li>实现 onComplete 回调处理流结束逻辑</li>
<li>错误处理和加载状态管理</li>
</ul>
<h2 data-id="heading-5">Markdown渲染集成</h2>
<h3 data-id="heading-6">renderMarkdown函数实现</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> marked <span class="hljs-keyword">from</span> <span class="hljs-string">"marked"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">renderMarkdown</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">item</span>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> html = <span class="hljs-keyword">await</span> marked.<span class="hljs-title function_">parse</span>(item, {
      <span class="hljs-attr">gfm</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">breaks</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">pedantic</span>: <span class="hljs-literal">false</span>,
    });
    <span class="hljs-keyword">return</span> html;
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Markdown 渲染失败:"</span>, err);
    <span class="hljs-keyword">return</span> <span class="hljs-string">`渲染错误: <span class="hljs-subst">${err.message}</span>`</span>;
  }
};
  
</code></pre>
<h2 data-id="heading-7">为什么 onMessage 回调不执行</h2>
<p>许多开发者在实现 SSE 时都会遇到 onMessage 回调不执行的问题。结合上述代码，我们来分析可能的原因和解决方案。</p>
<h3 data-id="heading-8">1. 请求头设置不正确</h3>
<p><strong>问题</strong>：缺少 Accept: "text/event-stream" 请求头，或设置了错误的 Content-Type。</p>
<p><strong>解决</strong>：确保请求头包含：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">header</span>: {
  <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span>,
  <span class="hljs-string">"Accept"</span>: <span class="hljs-string">"text/event-stream"</span>, <span class="hljs-comment">// 这个请求头至关重要</span>
}
</code></pre>
<h3 data-id="heading-9">2. 分块传输未启用</h3>
<p><strong>问题</strong>：未设置 enableChunked: true，导致无法接收流式数据。</p>
<p><strong>解决</strong>：在 uni.request 中显式开启分块传输：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">enableChunked</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 必须开启分块传输</span>
<span class="hljs-attr">responseType</span>: <span class="hljs-string">"stream"</span>,  <span class="hljs-comment">// 流类型响应</span>
</code></pre>
<h3 data-id="heading-10">3. 数据解析逻辑错误</h3>
<p><strong>问题</strong>：缓冲区处理不当，导致消息无法正确分割。</p>
<p><strong>解决</strong>：检查缓冲区处理逻辑：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 正确的消息分割逻辑</span>
<span class="hljs-keyword">const</span> messages = buffer.<span class="hljs-title function_">split</span>(<span class="hljs-string">"\n\n"</span>);
buffer = messages.<span class="hljs-title function_">pop</span>() || <span class="hljs-string">""</span>;
messages.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">message</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (message.<span class="hljs-title function_">trim</span>()) {
    options.<span class="hljs-title function_">onMessage</span>(message);
  }
});
</code></pre>
<h3 data-id="heading-11">4. 服务端数据格式错误</h3>
<p><strong>问题</strong>：服务端返回的不是标准的 SSE 格式数据。</p>
<p><strong>解决</strong>：使用浏览器开发者工具的 Network 面板检查响应：</p>
<ul>
<li>确认响应头 Content-Type 为 text/event-stream</li>
<li>确认响应体格式符合 SSE 规范</li>
<li>检查是否有跨域等网络问题</li>
</ul>
<h3 data-id="heading-12">5. 回调函数传递错误</h3>
<p><strong>问题</strong>：API 封装或调用时，回调函数传递路径不正确。</p>
<p><strong>解决</strong>：跟踪回调函数的传递路径，确保：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// API封装时正确接收回调</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">questionAPI</span> = (<span class="hljs-params">data, { onMessage, onComplete }</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">request</span>({
    <span class="hljs-comment">// ...其他参数</span>
    onMessage,  <span class="hljs-comment">// 正确传递回调</span>
    onComplete
  });
};
</code></pre>
<h2 data-id="heading-13">SSE 调试技巧与工具</h2>
<h3 data-id="heading-14">浏览器开发者工具</h3>
<p>现代浏览器的开发者工具提供了对 SSE 的良好支持：</p>
<ol>
<li>
<p><strong>Network 面板</strong>：</p>
<ul>
<li>找到类型为 event-stream 的请求</li>
<li>查看 "Response" 标签可实时看到 SSE 数据流</li>
<li>"Headers" 标签可检查请求头和响应头是否正确</li>
</ul>
</li>
<li>
<p><strong>Console 面板</strong>：</p>
<ul>
<li>使用 console.log 打印原始数据块</li>
<li>记录缓冲区状态变化</li>
</ul>
</li>
</ol>
<h3 data-id="heading-15">实用调试代码片段</h3>
<p>在 onChunkReceived 回调中添加详细日志：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 调试用：打印接收到的原始数据</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"原始数据块:"</span>, chunk);
<span class="hljs-comment">// 调试用：打印缓冲区状态</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"缓冲区状态:"</span>, buffer);
<span class="hljs-comment">// 调试用：打印分割后的消息数量</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"分割出的消息数:"</span>, messages.<span class="hljs-property">length</span>);
</code></pre>
<h3 data-id="heading-16">常见问题排查清单</h3>
<ol>
<li>
<p><strong>网络层面</strong>：</p>
<ul>
<li>确认服务端是否支持 CORS</li>
<li>检查请求是否成功建立连接</li>
<li>查看响应状态码是否为 200</li>
</ul>
</li>
<li>
<p><strong>数据层面</strong>：</p>
<ul>
<li>确认服务端是否持续发送数据</li>
<li>检查数据格式是否符合 SSE 规范</li>
<li>验证消息分隔符是否正确</li>
</ul>
</li>
<li>
<p><strong>代码层面</strong>：</p>
<ul>
<li>检查回调函数是否正确传递</li>
<li>确认分块处理逻辑是否正确</li>
<li>验证错误处理是否覆盖所有情况</li>
</ul>
</li>
</ol>
<h2 data-id="heading-17">SSE vs WebSocket：如何选择</h2>
<p>SSE 和 WebSocket 都可以实现实时通信，但它们各有适用场景：</p>
<p>表格</p>
<p>复制</p>








































<table><thead><tr><th>特性</th><th>Server-Sent Events</th><th>WebSocket</th></tr></thead><tbody><tr><td>协议</td><td>HTTP</td><td>独立的 WebSocket 协议</td></tr><tr><td>连接</td><td>单向（服务器到客户端）</td><td>双向</td></tr><tr><td>开销</td><td>低</td><td>中</td></tr><tr><td>实现复杂度</td><td>简单</td><td>复杂</td></tr><tr><td>自动重连</td><td>内置支持</td><td>需要手动实现</td></tr><tr><td>数据格式</td><td>文本（UTF-8）</td><td>二进制/文本</td></tr></tbody></table>
<p><strong>选择建议</strong>：</p>
<ul>
<li>如果你需要<strong>单向实时更新</strong>（如股票行情、新闻推送、AI 对话），选择 SSE</li>
<li>如果你需要<strong>双向实时通信</strong>（如在线游戏、即时通讯），选择 WebSocket</li>
<li>如果你希望<strong>快速开发</strong>且<strong>兼容性好</strong>，选择 SSE</li>
<li>如果你需要<strong>全双工通信</strong>且<strong>高性能</strong>，选择 WebSocket</li>
</ul>
<h2 data-id="heading-18">总结与展望</h2>
<p>Server-Sent Events 是一种简单而强大的实时通信技术，特别适合需要服务器向客户端单向推送数据的场景。通过本文的代码解析，我们了解了如何在 Vue 项目中实现 SSE，包括 API 封装、分块处理和回调机制等核心要点。</p>
<p>随着 AI 应用的普及，SSE 技术将在更多场景中发挥重要作用。掌握 SSE 的前端实现，不仅能帮助我们构建更好的用户体验，也能为理解更复杂的实时通信技术打下基础。</p>
<p>希望本文能帮助你解决 SSE 实现中的困惑，如果你有其他问题或更好的实践经验，欢迎在评论区分享！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Jason Wei：2025年 AI 发展的三个核心理念]]></title>    <link>https://juejin.cn/post/7574726841543999526</link>    <guid>https://juejin.cn/post/7574726841543999526</guid>    <pubDate>2025-11-21T07:05:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574726841543999526" data-draft-id="7574816159754338355" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Jason Wei：2025年 AI 发展的三个核心理念"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-11-21T07:05:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="是魔丸啊"/> <meta itemprop="url" content="https://juejin.cn/user/3217622495411292"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Jason Wei：2025年 AI 发展的三个核心理念
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3217622495411292/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    是魔丸啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T07:05:30.000Z" title="Fri Nov 21 2025 07:05:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>斯坦福 AI 俱乐部专题演讲完整版</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3Db6Doq2fz81U%26utm_source%3Dchatgpt.com" target="_blank" title="https://www.youtube.com/watch?v=b6Doq2fz81U&amp;utm_source=chatgpt.com" ref="nofollow noopener noreferrer">转载</a></p>
<hr/>
<h2 data-id="heading-0">引言：理解 2025 年 AI 发展的三个核心理念</h2>
<p>大家好，我是 Jason Wei，现在在 Meta 超级智能实验室担任研究科学家。之前我在 OpenAI 工作了两年，在那里我参与了 01 和 Deep Research 的开发。再之前，我在 Google Brain 担任研究科学家，我的研究帮助推广了思维链提示（chain of thought prompting）、指令微调（instruction tuning）以及许多新兴现象。</p>
<p>今天我想和大家分享三个我认为简单但 fundamental 的理念，帮助我们理解 2025 年的 AI 发展。当被问及 AI 将如何改变我们的世界时，你会得到非常广泛的答案，这取决于你问的是谁。</p>
<p><strong>一个真实的故事：不同观点的碰撞</strong></p>
<p>我的一个量化交易员朋友说，ChatGPT 虽然很酷，但在他的工作中并不能真正做那些复杂的工作。而在谱系的另一端，最近我问了一位顶尖实验室的 AI 研究员，他认为我们基本上还有两到三年的工作时间，然后 AI 就会取代他的工作。所以人们对 AI 如何发展的看法存在巨大的谱系。</p>
<p>因此，我将从三个思维方式来讨论这个话题：</p>
<ol>
<li>智能将成为商品（intelligence as a commodity）</li>
<li>我称之为验证者定律（verifiers law）的概念</li>
<li>智能的锯齿边缘（jagged edge of intelligence）</li>
</ol>
<hr/>
<h2 data-id="heading-1">第一个理念：智能商品化趋势</h2>
<h3 data-id="heading-2">AI 进展的两个阶段</h3>
<p>我认为思考 AI 进展的方式有两个阶段。第一个阶段是<strong>前沿突破阶段</strong>，这时 AI 还不能很好地完成某项任务，你正在解锁这种新能力。如果你看过去五年 MMLU（大规模多任务语言理解）这个非常常见的基准测试，你会看到在性能上逐渐取得进展。</p>
<p>第二个阶段是<strong>能力商品化阶段</strong>，一旦你拥有了一种能力，它就会变得商品化。</p>
<p><strong>一个具体的例子：MMLU 性能成本的变化</strong></p>
<p>这里有一个很好的例子，y 轴是时间，你可以看到在 MMLU 上获得特定性能水平的成本，以美元计算。你可以看到这个趋势是：每新的一年，使用具有特定智能水平的模型的成本都在下降。</p>
<p>你可能会问，为什么这个趋势会继续？我的论点是，这是深度学习历史上第一次自适应计算真正有效。</p>
<h3 data-id="heading-3">自适应计算时代的革命性意义</h3>
<p>如果你看到去年之前的整个深度学习发展，我们处于这样一种模式：解决特定问题所使用的计算量是固定的，无论问题有多难——无论是回答加州首府这样的简单问题，还是解决非常难的竞赛数学题。</p>
<p>但现在我们进入了自适应计算时代，你可以根据任务的难度来调整使用的计算量。这个概念首先通过 01 模型得到验证（一年多前发布的），它表明如果你在测试时增加解决数学问题的计算量，在该基准测试上的性能会更高。</p>
<p><strong>自适应计算的核心意义</strong></p>
<p>自适应计算意味着你可以继续降低智能成本的原因是，你不必不断扩大模型规模。如果你有一个非常简单的任务，你可以继续推进到极限，只需花费最少的计算资源来完成那个任务。</p>
<h3 data-id="heading-4">信息获取效率的演进历史</h3>
<p>让我们思考一下获取特定公共信息的时间变化。</p>
<p><strong>具体例子：1983年釜山人口查询</strong></p>
<ul>
<li><strong>互联网前时代</strong>：如果你想知道1983年釜山的人口，可能需要开车到图书馆，然后在大量百科全书中查找。这可能需要几个小时。</li>
<li><strong>互联网时代</strong>：你可能会搜索，然后浏览各种网站来找到真正给你答案的网站，这可能需要几分钟。</li>
<li><strong>现在</strong>：基本上可以立即获得答案。</li>
</ul>
<p><strong>更复杂的挑战：1983年釜山结婚夫妇数量</strong></p>
<p>如果你想问一个更复杂的知识问题，比如1983年釜山有多少对夫妇结婚。在互联网前时代，如果你不住在韩国，你可能需要先飞到韩国，亲自去最近的有这种信息目录的政府图书馆，你可能需要翻阅几十本书来找到那个特定信息。</p>
<p>互联网时代可能更容易一些。你可以搜索，但如果你不会说韩语，你必须查看所有网站并找人来帮助你。在聊天机器人时代，这变得更容易一些。而在代理时代，我认为这可以在几分钟内找到答案。</p>
<p><strong>极端复杂的查询：1983年亚洲30个最人口城市的结婚数量排序</strong></p>
<p>即使对于更困难的事情，比如询问"1983年亚洲人口最多的30个城市按该年结婚人数排序"，我认为这现在可以在几小时内完成，但在互联网前时代回答这个问题需要几周时间。</p>
<p><strong>真实的案例：OpenAI Operator的能力展示</strong></p>
<p>这里有一个实际的例子，这个问题"1983年釜山有多少人结婚"并不是一个超级简单的问题。03 无法完成这个任务，但 OpenAI Operator 可以做到，因为它必须访问一个叫 Kosis 的数据库，你必须点击各种选项，直到找到正确的数据库查询，然后你才能找到答案。</p>
<h3 data-id="heading-5">测量信息获取能力的基准：BrowseComp</h3>
<p>我们在 OpenAI 试图通过一个叫 BrowseComp（browsing competition）的基准测试来衡量这个能力。它包含一系列问题，一旦你有答案，验证答案很容易，但实际解决这些问题需要相当长的时间。</p>
<p>例如，给你一堆关于足球比赛的约束条件，然后找到真正符合所有这些约束条件的比赛。我们实际上要求很多人来回答这些问题。平均来说，有些问题需要两个多小时才能解决。如果你看规模，很多人在两小时内无法解决的问题比他们实际解决的问题要多。</p>
<p>但你可以看到 OpenAI 的 Deep Research 模型可以解决大约一半的问题，这是相当不错的进展。</p>
<h3 data-id="heading-6">智能商品化的社会影响</h3>
<h4 data-id="heading-7">知识领域的民主化</h4>
<p>一个影响是基于知识的领域将被民主化，这些领域之前被基于知识的随意进入门槛所限制。</p>
<p><strong>编程领域的例子</strong>
编程绝对是一个例子，"vibe 编程"是一个很好的例子。过去编程需要专门训练，现在 ChatGPT 几乎可以给你一个相当好的医生能给你的任何信息。</p>
<p><strong>个人健康管理的例子</strong>
个人健康可能是另一个例子。在过去，假设你想做生物黑客实验，你去看医生，说"我想改善我的鼻呼吸"，他们会说"嗯，你就试试我告诉你的方法"。他们不会真正帮助你理解如何做自己的实验。但现在 ChatGPT 几乎可以给你一个相当好的医生能给你的任何信息。</p>
<h4 data-id="heading-8">私人信息的相对价值提升</h4>
<p>另一个影响是私人内部信息的相对价值略高。鉴于任何公共信息的相对成本现在低得多，私人信息的相对价格现在会高得多。</p>
<p><strong>具体例子</strong>：不在市场上但可以出售的房产信息，现在这种信息变得更有价值。</p>
<h4 data-id="heading-9">个性化信息访问的未来</h4>
<p>我认为我们最终将拥有无摩擦的信息访问。你不是访问一个对所有人都公开的互联网，而是获得你的个性化互联网，无论你想知道什么，都会有一个个性化的网站来向你展示这些信息。</p>
<hr/>
<h2 data-id="heading-10">第二个理念：验证者定律</h2>
<h3 data-id="heading-11">验证不对称性的概念</h3>
<p>验证不对称性是计算机科学中一个非常常见的概念，基本上就是对于某些任务，验证解决方案比找到解决方案要容易得多。</p>
<p><strong>具体例子说明</strong></p>
<ol>
<li>
<p><strong>数独</strong>：非常难解决，但如果你有答案，很容易验证是否正确。</p>
</li>
<li>
<p><strong>Twitter 代码编写</strong>：显然需要团队，我估计数千名工程师，也许数百个马斯克运行公司来生成网站，但要验证它在工作，就容易多了。你只需渲染它并点击各种功能。</p>
</li>
<li>
<p><strong>竞赛数学问题</strong>：我认为有些情况下，解决和验证的难度是一样的，所以这是一种中间情况。</p>
</li>
<li>
<p><strong>数据处理代码</strong>：我认为这是另一个不同的情况。如果你想写一些脚本来处理某些数据，我认为写起来相当容易，但如果你给我别人的凌乱代码，我可能需要更多时间来弄清楚他们的代码在做什么，而不是写我自己的代码或检查他们的代码。</p>
</li>
<li>
<p><strong>事实性文章写作</strong>：这是另一个我认为很容易提出看似可信但可能是虚假声明的例子，但事实核查特定声明可能极其繁琐。所以这是一个你具有相反不对称性的例子，很容易生成看似可信的文章，但验证它是否是一篇好文章需要更长时间。</p>
</li>
<li>
<p><strong>制定新饮食方案</strong>：这个想法甚至延伸到创造新饮食等事情。我可以断言最好的饮食是只吃野牛肉，这只花了我10秒钟来断言。但如果你想验证这实际上是一个真实的声明，你需要大样本量，你必须等待长期结果，而且结果可能有噪音。</p>
</li>
</ol>
<h3 data-id="heading-12">可视化验证不对称性</h3>
<p>你可以像这样将其可视化。x 轴是多容易生成，y 轴是多容易验证。</p>
<ul>
<li><strong>数独</strong>：生成难度中等，但验证容易</li>
<li><strong>Twitter</strong>：生成困难，验证相对容易</li>
<li><strong>最佳饮食方案</strong>：生成容易，验证困难</li>
<li><strong>中间地带</strong>：竞赛数学、数据处理代码等处于中间位置</li>
</ul>
<h3 data-id="heading-13">通过特权信息改善验证不对称性</h3>
<p>我想指出的有趣事情是，你实际上可以通过给予特权信息来改善任务在这个平面上的位置。</p>
<p><strong>改进验证的具体例子</strong></p>
<ul>
<li><strong>竞赛数学</strong>：如果我为你提供答案键，那么检查就变得非常容易。</li>
<li><strong>代码编写</strong>：如果你在写代码，我给你测试用例（像我们在 Swedbench 中那样），检查也变得非常容易。</li>
</ul>
<p>这个想法的核心是，有些任务你可以事先做一些工作来增加验证的不对称性。</p>
<h3 data-id="heading-14">验证者定律的表述</h3>
<p>这引出了我称之为验证者定律的理念，或者如果你对"定律"这个词作为科学家感到不舒服，可以称之为验证者规则。</p>
<p><strong>验证者定律的核心主张</strong>：训练 AI 解决特定任务的能力与该任务的可验证程度成正比。</p>
<p><strong>推论</strong>：任何可解决的、容易验证的任务最终都会被 AI 征服。</p>
<h3 data-id="heading-15">可验证性的五个关键维度</h3>
<p>更具体地说，我认为可验证性是这五个事物的函数：</p>
<ol>
<li><strong>客观真理性</strong>：什么是好响应，什么是坏响应存在客观标准</li>
<li><strong>验证速度</strong>：验证有多快</li>
<li><strong>可扩展性</strong>：你能一次性验证一百万个不同的提议响应吗</li>
<li><strong>低噪声性</strong>：是否存在低噪声</li>
<li><strong>连续奖励</strong>：你只区分通过和不通过，还是给出整个响应质量的光谱</li>
</ol>
<p>大多数 AI 基准测试根据定义都容易验证，这是验证者定律的一个很好的实例化，你可以看到过去五年我们关心的所有基准测试都相对较快地被 AI 解决了。</p>
<h3 data-id="heading-16">AlphaEvolve：验证者定律的绝佳例证</h3>
<p>利用验证不对称性的一个很好的例子，我鼓励你们如果还没有读过的就去看一下，是 DeepMind 的 AlphaEvolve。他们基本上能够通过大量计算采样和智能算法解决这些符合验证不对称性的任务，包括数学、计算优化使用等一堆任务。</p>
<p><strong>AlphaEvolve 的具体任务示例</strong></p>
<p>这里有一个例子，你可以想出这样的数学问题：找到这11个六边形的放置位置，你可以绘制围绕它的最小外六边形。然后你可以看到这样的解决方案清楚地满足这里所有五个标准。</p>
<ul>
<li><strong>客观性</strong>：你只需绘制它来检查答案</li>
<li><strong>可扩展验证</strong>：因为它是计算性的</li>
<li><strong>低噪声</strong>：每次检查都会得到相同的结果</li>
<li><strong>连续奖励</strong>：六边形的大小直接给你一个答案比另一个答案更好的度量</li>
</ul>
<h3 data-id="heading-17">AlphaEvolve 算法工作原理</h3>
<p>你应该阅读论文，但我会给你一个大约一分钟的概述。</p>
<p><strong>算法核心步骤</strong>：</p>
<ol>
<li>
<p><strong>采样生成</strong>：他们使用一个大语言模型，采样一堆候选解决方案。其中一些可能好，一些可能坏。</p>
</li>
<li>
<p><strong>评估筛选</strong>：他们对它进行评分，因为他们通过选择的任务定义有一种评分方式。</p>
</li>
<li>
<p><strong>迭代优化</strong>：他们采用最好的一个并将其反馈给大语言模型用于下一轮采样，作为某种形式的灵感。</p>
</li>
<li>
<p><strong>持续改进</strong>：基本上，一旦你花费大量计算和迭代来这样做，你可以看到性能或你做任务的好坏程度明显随时间增加。</p>
</li>
</ol>
<p><strong>技术创新的关键洞察</strong></p>
<p>他们在这里做的聪明事情是他们规避了传统深度学习的核心限制。在深度学习的大部分时间里，我们主要关心从训练到测试的泛化。这有两种形式：一种是相同任务但未见过的例子，另一种是未见过的任务。</p>
<p>但他们选择训练和测试相同的问题。你只是真的想知道一个特定问题的答案。这允许你规避很多这些问题。你必须选择那些你可能得到比你已经知道的更好答案的问题。</p>
<h3 data-id="heading-18">验证者定律的现实意义</h3>
<h4 data-id="heading-19">自动化任务的优先级</h4>
<p>我认为一个影响是最先被自动化的任务是那些非常容易验证的任务。</p>
<h4 data-id="heading-20">新兴商业机会</h4>
<p>第二个影响是，如果你想创建公司或我认为会增长的领域，就是想出测量事物的方法，然后这些事物可以被 AI 优化。</p>
<hr/>
<h2 data-id="heading-21">第三个理念：智能发展的锯齿边缘</h2>
<h3 data-id="heading-22">对 AI 影响的不同观点谱系</h3>
<p>如果你问 AI 将如何改变世界，我认为人们有相当不同的观点。</p>
<p><strong>来自专家的观点差异</strong></p>
<p>这是来自今年早些时候，我的前同事 Boaz 说，东海岸的人低估了即将到来的变化规模。他们想，哦，当前模型不能做这个，他们不太考虑轨迹。而在湾区，我们可能低估了一些摩擦和我们训练的模型部署所需的时间滞后。</p>
<p>另一个我喜欢的观点（如果你还没关注他应该关注）是 Run，他说现在没有人应该给出或接受任何职业建议。每个人都广泛低估了变化的范围和规模以及你未来的高方差。你在 Meta 的 L4 工程师朋友告诉你"兄弟，CS 学位完蛋了"，他也不知道。</p>
<h3 data-id="heading-23">对快速起飞假设的质疑</h3>
<p>长期以来存在的一个假设是快速起飞的理念。基本上是一旦你在某个方面超越人类，一旦你实现这个特定的事情，你会突然变得比人类强得多。所以你会有这个起飞持续时间，在短时间内获得这种巨大的智能。</p>
<p>我认为这可能不会发生，我会告诉你为什么。</p>
<p><strong>渐进式自我改进的现实</strong></p>
<p>快速起飞，这可能是他们论点的简化版本，基本上就像：哦，在很多年里你不能用 AI 训练 GPT n+1，然后在第二年你突然能做到。但我认为它更可能像这样：每年你在 AI 能够自我改进方面取得渐进进展。</p>
<ul>
<li><strong>第0年</strong>：你甚至无法获得代码库</li>
<li><strong>第0年中</strong>：你也许可以训练某些东西，但结果并不真正令人印象深刻</li>
<li><strong>后续阶段</strong>：它也许可以自主训练，但不如你把它交给10个最好的研究人员那样好</li>
<li><strong>持续发展</strong>：也许有时你仍然需要人类偶尔干预来让它继续良好运行</li>
</ul>
<p>所以我认为这更像是自我改进能力的光谱，而不是像二元的"哦，在你实现这个之后，你可以突然创造超智能"。</p>
<h3 data-id="heading-24">任务特定的改进速率</h3>
<p>我认为自我改进率应该以任务特定方式来看待。你可以认为存在一个不同任务的光谱。</p>
<p><strong>AI 能力的锯齿状分布</strong></p>
<p>你可以这样思考。有这种锯齿边缘，对吧？在峰值，你有我们现在能够做得特别好的问题，比如困难数学问题、某些类型的竞赛编程。然后也有这些奇怪的谷底。</p>
<p><strong>能力不足的具体例子</strong></p>
<ul>
<li><strong>基础数学错误</strong>：很长一段时间里，ChatGPT 会说 9.11 大于 9.9</li>
<li><strong>小众语言处理</strong>：比如 Flingit，我认为只有几百个美洲原住民能说的语言。我认为 ChatGPT 不能很好地做这个</li>
<li><strong>复杂物理任务</strong>：需要现实世界交互的任务</li>
</ul>
<p>我不认为我们会处于这种情况：你有一个自我改进的模型，然后突然什么都能做好。我认为你更可能处于右侧的情况，即每个任务都有不同的改进率。</p>
<h3 data-id="heading-25">AI 任务改进的启发式规律</h3>
<h4 data-id="heading-26">数字任务的优势</h4>
<p>我认为 AI 擅长数字任务。我不知道，这个家庭作业机器漫画实际上相当准确，考虑到它是1981年创建的关于 AI 如何工作的。但我们显然还没有真正的机器人，也许很快会有。</p>
<p><strong>为什么数字任务发展更快</strong></p>
<p>我认为 AI 在数字任务上发展如此之快的核心原因只是迭代速度。因为当你做数字任务时，你可以更容易地扩展计算，而不是扩展使用真实机器人的实验。</p>
<h4 data-id="heading-27">人类难度与 AI 难度的相关性</h4>
<p>另一个相当明显的规律是，对人类更容易的任务往往对 AI 也更容易。</p>
<p>你可以有一个人类事情有多困难的光谱。我认为正在出现的是一种能够做人类可能因为作为生物大脑的根本限制而无法做的任务的能力。</p>
<p><strong>超越人类限制的例子</strong></p>
<p>比如，预测乳腺癌发生是一个可能的任务，如果你读过1000万张乳腺癌图像，你可以找到允许你预测的模式。但作为人类，我们活得不够长或没有足够注意力来做到这一点。</p>
<h4 data-id="heading-28">数据丰富性的关键作用</h4>
<p>另一个极其简单的启发式是 AI 在数据丰富时往往会蓬勃发展。</p>
<p>这里有一个非常清晰的例子，你可以查看语言模型在不同语言中的数学表现。如果你绘制该语言的频率，换句话说，我们有多少数据，与性能的关系，这是一个相当清晰的趋势，你拥有的数据越多，你在该任务上做得越好。</p>
<h4 data-id="heading-29">单一度量优化的特殊策略</h4>
<p>该规则的一个特殊例外或解锁是如果你有单一目标度量，那么你可以做 AlphaEvolve 或 AlphaZero 策略，你基本上可以通过强化学习生成合成数据。</p>
<p>我的前同事 Danny Du 有一个很好的推文：任何基准测试都可以快速解决，只要任务提供明确的评估度量，可以在训练期间用作奖励信号。</p>
<h3 data-id="heading-30">不同领域 AI 发展时间线预测</h3>
<p>我有这个我之前展示过的表格，你可以使用这三个启发式规律来预测 AI 何时能够做某些事情。</p>
































































































<table><thead><tr><th>领域</th><th>人类难度</th><th>数字化程度</th><th>数据可用性</th><th>预测时间</th></tr></thead><tbody><tr><td>翻译（前50种语言）</td><td>容易</td><td>是</td><td>容易获取数据</td><td>已完成</td></tr><tr><td>基础代码调试</td><td>中等</td><td>是</td><td>容易获取数据</td><td>2023年</td></tr><tr><td>竞赛数学</td><td>困难</td><td>是</td><td>容易获取数据</td><td>已完成</td></tr><tr><td>进行 AI 研究</td><td>困难</td><td>是</td><td>数据获取/创建不那么容易</td><td>2027年（猜测）</td></tr><tr><td>化学研究</td><td>困难</td><td>否</td><td>数据获取/创建不那么容易</td><td>比 AI 研究晚</td></tr><tr><td>制作电影</td><td>非常困难</td><td>是</td><td>容易获取数据</td><td>2029年（猜测）</td></tr><tr><td>股票市场预测</td><td>非常困难</td><td>是</td><td>容易获取数据</td><td>不确定</td></tr><tr><td>翻译到特定方言</td><td>容易（对知道的人）</td><td>是</td><td>数据获取不那么容易</td><td>可能性较低</td></tr><tr><td>修理你的管道</td><td>中等</td><td>否</td><td>数据获取不容易</td><td>不确定</td></tr><tr><td>发型设计</td><td>我认为这对 AI 来说会相当困难</td><td>不确定</td><td/><td/></tr><tr><td>传统地毯制作</td><td>非常困难（需要一个月团队制作地毯）</td><td>否</td><td>数据获取不容易</td><td>很长时间内不会</td></tr><tr><td>带女朋友约会让她开心</td><td>不可能</td><td>否</td><td>数据获取不容易</td><td>我认为我们还要做一段时间</td></tr></tbody></table>
<h3 data-id="heading-31">锯齿边缘的现实意义</h3>
<h4 data-id="heading-32">影响的领域差异</h4>
<p>AI 的影响将在满足特定特性的任务上最大：即数字任务、对人类容易的任务和数据丰富的任务。</p>
<p>某些领域将被 AI 极大地加速，软件开发显然是其中之一。然后其他领域可能保持不变，比如发型设计。</p>
<hr/>
<h2 data-id="heading-33">结论：三个核心理念的总结</h2>
<h3 data-id="heading-34">核心洞察重述</h3>
<ol>
<li>
<p><strong>智能和知识将变得快速廉价</strong>：一旦我们用 AI 实现了能力，其成本将被推向零。我认为这个趋势将继续。即时知识的理念，所以任何公开可用信息，你都能够立即获得访问。</p>
</li>
<li>
<p><strong>验证者定律</strong>：测量是 AI 进步的驱动因素。任何容易验证的任务最终都会被 AI 解决。</p>
</li>
<li>
<p><strong>智能边缘是锯齿状的</strong>：AI 对特定任务的能力和改进率将基于这些任务的某些特性而变化。不会有快速的超级智能起飞，因为每个任务都有不同的能力和改进率。</p>
</li>
</ol>
<h3 data-id="heading-35">预期影响</h3>
<ul>
<li><strong>高度加速的领域</strong>：软件开发等数字任务、数据丰富的领域</li>
<li><strong>相对稳定的领域</strong>：手工艺、需要物理交互的服务行业</li>
<li><strong>价值重构</strong>：公共信息价值下降，私人信息价值相对提升</li>
<li><strong>测量行业机会</strong>：创建测量方法以供 AI 优化的新兴商机</li>
</ul>
<p>这些理念为我们理解 2025 年及以后 AI 发展提供了框架，帮助我们预测技术演进路径并评估其对社会各领域的具体影响。</p>
<hr/>
<p>如果你对我的演讲有反馈，我会阅读。我也很乐意在 Twitter 上交流。</p>
<p>谢谢大家！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[聊一聊 Gemini3、 AntiGravity 和 Nano Banana Pro 的体验和问题]]></title>    <link>https://juejin.cn/post/7574745301725167622</link>    <guid>https://juejin.cn/post/7574745301725167622</guid>    <pubDate>2025-11-21T07:14:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574745301725167622" data-draft-id="7574745301725118470" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="聊一聊 Gemini3、 AntiGravity 和 Nano Banana Pro 的体验和问题"/> <meta itemprop="keywords" content="前端,Gemini,AIGC"/> <meta itemprop="datePublished" content="2025-11-21T07:14:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="恋猫de小郭"/> <meta itemprop="url" content="https://juejin.cn/user/817692379985752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            聊一聊 Gemini3、 AntiGravity 和 Nano Banana Pro 的体验和问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/817692379985752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    恋猫de小郭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T07:14:45.000Z" title="Fri Nov 21 2025 07:14:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>相信这两天大家应该都已经被 Gemini3 和 AntiGravity 刷屏了，特别昨晚谷歌还发布了 Nano Banana Pro ，可以说这两天几乎成了谷歌的 AI 专场，所以这里也介绍下这两天的体验，顺便简单介绍下大家上不去 AntiGravity 的问题。</p>
<h2 data-id="heading-0">Nano Banana Pro</h2>
<p>其实相比起 coding，这次的 Nano Banana Pro 反而是我最关心的，比如这次让我感觉最有意思的 prompt 「1:1 真人版」就非常有意思，传入一张手办或者动漫图片，直出整体效果如下图所示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fc13a63e42f426daede67f34006f179~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=onmbrPnzL0W8Ap39tVMdncd%2FObs%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/471e92a86bc44bbba87e7eb0964ba2ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=wwmBCDhO3oIlKTkx%2FWBnvgsg06U%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60bbbc5f75bb4e10a100df101a6eb3d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=VWJyv%2BNjJ5RQRKJRlOJlArhwhdY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51c17399ae0d456f99075652e8eda9e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=kC9yCK8qhmjKSLVuIMgvJDO2sX0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f32611551514c5aa999adcf56154285~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=71edhezZuD903JmpEbyFsZSkKnw%3D" alt="它居然知道是黄毛？？？" loading="lazy"/></p>
<p>同时，你还可以让它做一个 apple vision pro 2 的 hack 解构图，整个直出效果还是相当不错的：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86ae65a1d34d4ef6b7a545588d7dd741~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=TnJROlJBDXKubecY4yNSBfvn3HE%3D" alt="image-20251121134547646" loading="lazy"/></p>
<p>如果通过 AI Studio 的 <code>http://aistudio.google.com/apps/bundled/product_mockup</code> ，你还通过简单的描述词，就能让它帮你生成各种不同风格的知识图谱或者关系图谱，这对于 PPT 或者内容创造来说，可以说是非常可观的效率提升了：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2590ac8f3824132926b91af8ee91f6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=g2qH4BJjyuu4lMQ7LO%2FvmkwvBGs%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d904f115d00f4a96a901cb1473bd6a4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=JhYzcGVrPQnTfv%2BBBekqf2wLzZE%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd22e7957eb94ec48088c1a297436472~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=4RnFaMvbeespOP9Du%2BbOdTZVUTM%3D" alt="" loading="lazy"/></p>
<p>最后就是 AntiGravity + Banana Pro 的结合效果，是的，今天更新后的 AntiGravity 已经有 Nano Banana Pro 的效果了：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eeb542ab658b4a14861577ba203867af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=7pcgghqZMTnvGKie7ViCZ%2Bga2kU%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>Web UI 理解和实现上确实比较明显的提升。</p>
</blockquote>
<h2 data-id="heading-1">AntiGravity</h2>
<p>接下来就是 AntiGravity ，相信大家应该都知道这次谷歌发布了 “ Windsurf2.0” 的 IDE，基本功能和 UI 都有浓厚的 Windsurf 影子，也是基于 VSCode 的一个 IDE 产品：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f730ea6cad104d5391e29413fbeb6769~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=WakI55PEDWMF9D20rdmj7CXSGa0%3D" alt="" loading="lazy"/></p>
<p>为什么说是 Windsurf 2.0 ？哈哈哈哈，看看这些就知道了，毕竟是 Windsurf 的前核心团队做的：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc932c11822b41348ad83dbb703ac040~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=wvYuRXDHd2IPgptXVuDuiZA609A%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5dca53d359da4978ba492afac64b8f10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=mvvPTrPD%2Bv7EQOUrHv4a9EOiJ8E%3D" alt="" loading="lazy"/></p>
<p>先简单介绍下 Antigravity 的一些特点，核心就是 Agent-First ，它预设 AI 是一个能够自主规划、执行、验证和迭代复杂工程任务的执行者，主打特色有：</p>
<ul>
<li><strong>并行工作:</strong> 与传统的线性聊天（等待 AI 回复）不同，可以同时派遣多个智能体（Agents）去处理不同的任务（例如一个修 Bug，一个写测试），并在“Mission Control”视图中监控进度。</li>
<li><strong>集成了一个深度绑定的 Chrome 浏览器，它除了写代码，还可以做很多其他的东西</strong>，智能体拥有一个专门的（Browser Subagent），可以像人类一样浏览网页、点击、输入、读取 DOM 和控制台日志，所以智能体可以自主查阅文档、搜索解决方案甚至测试 Web 应用<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e54e4d31840b4c2e8343c9523d19717f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=fLwuiNNbmW81954vG960%2FJIAUaA%3D" alt="" loading="lazy"/></li>
</ul>
<p>这里的 Browser Subagent 还挺有意思的，你可以让它帮你浏览某些网页，或者帮你汇总某些邮件，总结一些资料，查询最新的资讯之类，它会自己打开浏览器并完成对应任务：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef3e538443fc447b9f655b8e36634f50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=IfHGIVG9bCYLaUge5qBaUELDeqI%3D" alt="" loading="lazy"/></p>
<p>那么，很多人要说，我都上不去卡在 loading，甚至就在下图这个地方一动不动，这是为什么呢？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38dbb8d49d34487b841a294701fccfb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=NQRhq9WTBehA%2Fksq%2Ft9fWzrNs2Y%3D" alt="" loading="lazy"/></p>
<p>首先就是，你要打开 <code>https://policies.google.com/terms</code> ，然后查看你的账号所在区域，如果是 HK ，那么你就需要先改地址了：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/612a699c29114ddba47562357151eb92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=vyaGK5c68VcT3N2D5Z6QkQdNU38%3D" alt="" loading="lazy"/></p>
<p>改地址链接是 <code>https://policies.google.com/country-association-form</code> ，你需要选「其他」 并填写理由，理由只能你自己想了，申请通过后，你就会看到类似的邮件回复：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6425befbdb54ffbbc54fb6435870561~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=YghUwZ5ZpwnXLLyNK2ue8uEKTIo%3D" alt="" loading="lazy"/></p>
<p>最后，你还需要开全局 proxy，比如 win11 需要这两个全开（tun）比较保险，而 Mac是增强模式 ：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe2079e236b84c7fbd46dedc0aeb72bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=%2BlHiTNgy71kYzbnNsIgsu77Dljo%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab0232c153a642e78f6f4520902f3d60~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=ryDjYkWD9L8x3YibPEQQIpj6dME%3D" alt="" loading="lazy"/></p>
<p>进去后你就可以看到，提供的模型还是挺不错的，最重要是目前是 free ：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c70c63c25234f75b4acedbb40d4c0f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=XqX33DlUIrmulF%2B9%2B7Mv49tY7e0%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fce65d6a43042518f628926ba28b82c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=2GynbGPUn%2FhejYbbEmIzO0a4MSw%3D" alt="" loading="lazy"/></p>
<p>在昨天的没更新的时候，模型很容易就 limit 了，更新到 1.1.3 之后情况大幅好转</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14db4e3b7acd467f8048af20656da059~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=Wr4n%2BWpKlcKuLEkcILOFcV7CG3g%3D" alt="img" loading="lazy"/></p>
<p>不过 error 问题还是在的，经常遇到各种 Agent Error 只能说现在产品实现还是相对毛坯：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/680b891754294baf84bf9d90baa83734~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=KvMXMnnRiR8B65ginKyKSFbRgMs%3D" alt="img" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9178fc91ede24f3198e4dcdd5b77eaa1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=Gbjj4M0QvEM%2BC%2F0bUI2Vl%2FwDZsw%3D" alt="img" loading="lazy"/></p>
<blockquote>
<p>所以如果还没用上的也不急，等等更优秀。</p>
</blockquote>
<p>最后还是提一句，Google 账号的地区和 Google Play 的地区有时候是两回事，Google Play 的地区需要在 Google Play 里修改，它影响的是 Google One 的购买权限，也就是 AI Pro ， 比如最近的 Gemini AI Pro 通过 Google One 学生教育又可以续费一年。</p>
<p>而 Google 账号的地区，它影响的是 AntiGravity 这种的登录使用，这两者还是需要区分一下，当然正常来说应该两个都一样，只是说，你 Play 是 US ，不一定就是账号是 US 。</p>
<h2 data-id="heading-2">Gemini 3</h2>
<p>先说问题，实际体验下来会发现它变得倔强了，它甚至会再多轮会话里反驳 prompt 中的要求，之前 2.5 是如果纠正的话它会立马调整，而 3 里它也会先肯定你，然后说还是该按照我的来 ，最离谱的是： <strong>写的太详细的 prompt ，效果居然不如模糊的</strong>。</p>
<p>当然，这次更新之后，Gemini 3 的 UI 能力就得到了不错的提升，比如这次我用 Gemini 3 update 了我的个人主页 <code>https://guoshuyu.cn/home/index/</code> ，整体风格我还是挺喜欢的，特别是动态的背景键盘输入和右侧的 HUD terminal 输出效果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8588e42ac26c4e5c830e19bc52f2c8e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=IaxKQYCUgRT4GF99MwpNvoTLdSI%3D" alt="" loading="lazy"/></p>
<p>另外 Gemini 3 的动态能力还体现在它新的「动态试图」上，通过它你可以直观感受到 Gemini 3 pro 的 UI 能力的提升：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca6afc1cbbac4ff28047399e5a6535ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=tBy3x96k5mUz5DEDXvTY%2FMgFkN0%3D" alt="" loading="lazy"/></p>
<p>例如以下都是通过 Gemini 3 pro 的动态试图，一句话直出的可交互视图效果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b002866dd5f44f58336cbe7d6b9555d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=sJOIgN6%2FJBgUIJ4Y%2BNP572UM9gU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94ca6063bb934d5ba24f93e7a7c850ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=9l1rh2VRwSsgpGqjR%2FHmytX4Gac%3D" alt="" loading="lazy"/></p>
<p>还可以让他做一些范式示例，比如如果需要展示蒸汽机的基础原理，直接一句话就可以让它生成一个可交互的动态效果，这对于内容创作来说无疑方便很多：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d2a7db54b7848cfb11995905d147e4a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=%2F54PwUzNKi6p5VNHGfUAPiTRHrg%3D" alt="" loading="lazy"/></p>
<p>你甚至可以说「<code>https://juejin.cn/</code> 这个页面的 ui 太丑了，帮我优化个炫酷的效果」，然后你就可以得到如下图所示的 UI ：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c05e5f13f9d437f89a6e475744a0337~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314085&amp;x-signature=PDa2PQeqsQunhAK6%2FOTjTX9%2BSRw%3D" alt="" loading="lazy"/></p>
<p>所有「动态视图」也是 Gemini 3 UI 绘制能力升级的体现，虽然目前只是实验性阶段，但是按照目前 AI 的爬升速度，相信接下来还会给我们更多的惊喜。</p>
<h2 data-id="heading-3">最后</h2>
<p>最后，说再多都是虚的，自己体验下才知道，至少 AntiGravity 还是值得一试的，毕竟目前还是 Free 不是么？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[直呼太强了！国产模型遇上国产算力]]></title>    <link>https://juejin.cn/post/7574745301725216774</link>    <guid>https://juejin.cn/post/7574745301725216774</guid>    <pubDate>2025-11-21T07:18:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574745301725216774" data-draft-id="7574892669374136374" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="直呼太强了！国产模型遇上国产算力"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-21T07:18:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大橙子打游戏"/> <meta itemprop="url" content="https://juejin.cn/user/1081575170907086"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            直呼太强了！国产模型遇上国产算力
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1081575170907086/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大橙子打游戏
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T07:18:03.000Z" title="Fri Nov 21 2025 07:18:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">#模力方舟</a> <a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">#MoArk</a> <a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">#GPU</a> <a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">#租显卡</a> <a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">#模力方舟GPU体验官</a> <a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">#模力方舟GPU赛博名片</a> <a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">#国产GPU</a></p>
<p>随着大模型应用进入加速落地阶段，如何以更低门槛、更高效率获得稳定算力，成为团队与开发者的共识需求。</p>
<p>模力方舟近期上线的「算力市场」，提供即开即用、灵活计费的国产 GPU 实例，现已全面支持 沐曦 C500、燧原 S60 等多型号算力资源，最高 64GB 显存，按分钟计费，随用随开。</p>
<p>原 <a href="https://link.juejin.cn?target=https%3A%2F%2Fai.gitee.com" target="_blank" title="https://ai.gitee.com" ref="nofollow noopener noreferrer">ai.gitee.com</a> 启用了新的域名  <a href="https://link.juejin.cn?target=https%3A%2F%2Fmoark.com%2F" target="_blank" title="https://moark.com/" ref="nofollow noopener noreferrer">moark.com/</a></p>
<h2 data-id="heading-0">快速体验一把国产算力的澎湃动力吧！</h2>
<h3 data-id="heading-1">开机</h3>
<p>以沐曦 <strong>曦云C500型号</strong> 为例，租用一张64GB，镜像选择 PyTorch / 2.6.0 / Python 3.10 / maca 3.2.1.3</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c5f0897604a48bdaf4c9e14621078b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qmZ5a2Q5omT5ri45oiP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314386&amp;x-signature=v2GhaT3Eo9SmXbxaw7iFKCaWZaY%3D" alt="镜像选择" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4738861e723a4c6ba75711dadbaebf6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qmZ5a2Q5omT5ri45oiP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314386&amp;x-signature=gT5ukI4AUvTJr2zd7vcjic2KdI0%3D" alt="工作台运行.png" loading="lazy"/></p>
<h3 data-id="heading-2">编写代码</h3>
<p>点击选择Jupyterlab进入到容器当中并新建一个.ipynb文件</p>
<p>需要先行安装一下diffusers库</p>
<pre><code class="hljs language-python" lang="python">!pip install diffusers
</code></pre>
<p>之后运行下列代码，自行修改生图提示词</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> diffusers <span class="hljs-keyword">import</span> DiffusionPipeline
<span class="hljs-keyword">import</span> torch

<span class="hljs-comment">#如果是沐曦的曦云C500，可使用内置的模型路径 /mnt/moark-models/Qwen-Image</span>
model_name = <span class="hljs-string">"/mnt/moark-models/Qwen-Image"</span>

<span class="hljs-comment"># Load the pipeline</span>
<span class="hljs-keyword">if</span> torch.cuda.is_available():
    torch_dtype = torch.bfloat16
    device = <span class="hljs-string">"cuda"</span>
<span class="hljs-keyword">else</span>:
    torch_dtype = torch.float32
    device = <span class="hljs-string">"cpu"</span>

pipe = DiffusionPipeline.from_pretrained(model_name, torch_dtype=torch_dtype)
pipe = pipe.to(device)


<span class="hljs-comment"># Generate image</span>
prompt = <span class="hljs-string">'''生图提示词在这里写'''</span>

negative_prompt = <span class="hljs-string">" "</span> 


aspect_ratios = {
    <span class="hljs-string">"1:1"</span>: (<span class="hljs-number">1328</span>, <span class="hljs-number">1328</span>),
    <span class="hljs-string">"16:9"</span>: (<span class="hljs-number">1664</span>, <span class="hljs-number">928</span>),
    <span class="hljs-string">"9:16"</span>: (<span class="hljs-number">928</span>, <span class="hljs-number">1664</span>),
    <span class="hljs-string">"4:3"</span>: (<span class="hljs-number">1472</span>, <span class="hljs-number">1140</span>),
    <span class="hljs-string">"3:4"</span>: (<span class="hljs-number">1140</span>, <span class="hljs-number">1472</span>),
    <span class="hljs-string">"3:2"</span>: (<span class="hljs-number">1584</span>, <span class="hljs-number">1056</span>),
    <span class="hljs-string">"2:3"</span>: (<span class="hljs-number">1056</span>, <span class="hljs-number">1584</span>),
}

width, height = aspect_ratios[<span class="hljs-string">"9:16"</span>]

image = pipe(
    prompt=prompt,
    negative_prompt=negative_prompt,
    width=width,
    height=height,
    num_inference_steps=<span class="hljs-number">50</span>,
    true_cfg_scale=<span class="hljs-number">4.0</span>,
    generator=torch.Generator(device=<span class="hljs-string">"cuda"</span>).manual_seed(<span class="hljs-number">42</span>)
).images[<span class="hljs-number">0</span>]
</code></pre>
<h3 data-id="heading-3">查看结果</h3>
<p>之后将得到</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc1038eeeb84496eb6f6e16d1b13a5b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qmZ5a2Q5omT5ri45oiP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314386&amp;x-signature=eyOcsVG%2BaSocoU0xHwL1L9SNUlc%3D" alt="运行结果.png" loading="lazy"/></p>
<h3 data-id="heading-4">内置模型</h3>
<p>这个容器当中已经内置了很多模型，目录在/mnt/moark-models/Qwen-Image</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26a70ae7861140c8ab7e23a4a418c698~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qmZ5a2Q5omT5ri45oiP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314386&amp;x-signature=xu09bWEfFKh5I6m5qwLpKl6vq6U%3D" alt="内置模型.png" loading="lazy"/></p>
<h3 data-id="heading-5">命令行工具</h3>
<p>在运行的过程中，可以使用mx-smi命令查看显存的占用情况</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac2df848453f4a6296d432ecc571be25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qmZ5a2Q5omT5ri45oiP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764314386&amp;x-signature=4R3BPCUwowb45z7DqpgxxZZD7C4%3D" alt="沐曦smi查看.png" loading="lazy"/></p>
<p>从开机到得到第一张图，大概就是一分钟左右两分钟的样子，真的很快，在科研、原型验证阶段，是非常好的帮手！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从一句话扩展成完整的AI画图提示词【限制你的只有你的想象力】]]></title>    <link>https://juejin.cn/post/7574725286530744371</link>    <guid>https://juejin.cn/post/7574725286530744371</guid>    <pubDate>2025-11-21T07:30:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574725286530744371" data-draft-id="7574816159754141747" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从一句话扩展成完整的AI画图提示词【限制你的只有你的想象力】"/> <meta itemprop="keywords" content="OpenAI,AIGC"/> <meta itemprop="datePublished" content="2025-11-21T07:30:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mortimer"/> <meta itemprop="url" content="https://juejin.cn/user/4441682704623992"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从一句话扩展成完整的AI画图提示词【限制你的只有你的想象力】
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4441682704623992/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mortimer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T07:30:02.000Z" title="Fri Nov 21 2025 07:30:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>很多人用AI“画不出来” 想象中的精美图像，不是不会写提示词，而是只会写一句“故事话”。
下面教你一个最实用、最稳定的扩展方法：<strong>把一句话拆成“五块积木”，再补齐画面细节。</strong></p>
<hr/>
<h2 data-id="heading-0">第一步：写一句最朴素的需求</h2>
<p>例如你只有一句：</p>
<pre><code class="hljs">虞姬骑着项羽在战场上冲杀。
</code></pre>
<p>—— 很像人话，但对 AI 来说太抽象。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acdc96d6fd1b488bb4d3b653fd71ae43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9ydGltZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315001&amp;x-signature=6mhFtxgXWf4qeQmVC9AiCaWZU1g%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-1">第二步：按“五块积木”拆成画面元素</h2>
<p>五块积木：
<strong>主体、环境、风格、光影色彩、构图视角</strong></p>
<h3 data-id="heading-2">① <strong>主体（长相 + 姿态 + 道具）</strong></h3>
<p>问自己：AI 需要看到什么细节？</p>
<ul>
<li>虞姬外观？武器？姿态？</li>
<li>项羽被当坐骑？长什么样？</li>
<li>动作稳定吗？</li>
</ul>
<p>补充成：</p>
<pre><code class="hljs">虞姬手持方天画戟，骑着人脸马身的项羽，姿态前倾，正在冲锋。
</code></pre>
<hr/>
<h3 data-id="heading-3">② <strong>环境（在哪里 + 有什么）</strong></h3>
<p>问自己：</p>
<ul>
<li>战场上能“看见”的物品有哪些？</li>
<li>天气？时间？烟雾？</li>
</ul>
<p>补充：</p>
<pre><code class="hljs">地面散落倒下的士兵和破碎兵器，尘土被冲起。
</code></pre>
<hr/>
<h3 data-id="heading-4">③ <strong>风格（写实？国风？3D？插画？）</strong></h3>
<p>选择 <strong>一个主风格</strong>，不要乱混：</p>
<pre><code class="hljs">写实风格，3D渲染，虚幻引擎5风格。
</code></pre>
<hr/>
<h3 data-id="heading-5">④ <strong>灯光色彩（氛围的关键）</strong></h3>
<p>氛围最稳的两种：</p>
<ul>
<li><strong>夕阳逆光</strong>（史诗大片）</li>
<li><strong>电影级光影</strong>（质感直接上去）</li>
</ul>
<p>补充成：</p>
<pre><code class="hljs">夕阳逆光，电影级光影，烟尘被光束穿透。
</code></pre>
<hr/>
<h3 data-id="heading-6">⑤ <strong>构图视角（决定画面冲击感）</strong></h3>
<p>你想让画面“宏大”还是“震撼”？
选视角：</p>
<ul>
<li><strong>广角</strong> → 史诗大片</li>
<li><strong>仰视</strong> → 英雄感</li>
<li><strong>俯视</strong> → 叙事感</li>
</ul>
<p>补充：</p>
<pre><code class="hljs">广角构图，史诗感视角。
</code></pre>
<hr/>
<h2 data-id="heading-7">第三步：补上“画质增强词”</h2>
<p>不加不影响构图，但加了质量稳定很多：</p>
<pre><code class="hljs">高细节，8K画质，超高清渲染。
</code></pre>
<hr/>
<h2 data-id="heading-8">第四步：把所有积木拼回一句完整提示词</h2>
<p>你的一句话，就变成了高质量提示词：</p>
<pre><code class="hljs">虞姬手持方天画戟，骑着人脸马身的项羽，姿态前倾，正在冲过古代战场。
地面散落倒下的士兵和破碎兵器，烟尘被冲起。
写实风格，3D渲染，虚幻引擎风格。
夕阳逆光，电影级光影，光束穿透尘土。
广角构图，史诗感视角，高细节，8K画质。
</code></pre>
<p><em>ChatGPT</em>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be7ceb378db746da9eb843b7d242560b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9ydGltZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315001&amp;x-signature=iZ14m4U0j4Nxcwx%2F80MHIP35A7c%3D" alt="ChatGPT生成" loading="lazy"/></p>
<p><em>Grok</em>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5373f381ffa44e439b94110c852641b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9ydGltZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315001&amp;x-signature=vOqC4LiCuJcrutjYf6wMdb21Ymo%3D" alt="grok生成" loading="lazy"/></p>
<p><em>通义万相</em>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea066b5ac8434fb0bbc7294bdaa00db2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9ydGltZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315001&amp;x-signature=YgPZPL910sOpU4Sml%2F14EEGNIw8%3D" alt="通义万相生成" loading="lazy"/></p>
<p><em>Nano Banana 1</em>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c111eaa36efe4e31af91effea5527439~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9ydGltZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315001&amp;x-signature=N%2BT9L%2FIWOPBrJRBw6ntUHfSvzhk%3D" alt="Nano Banana 1 生成" loading="lazy"/></p>
<p><em>豆包</em>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3574b174cc554c878432a12b8f5fbd0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9ydGltZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315001&amp;x-signature=6xRyDABYC%2BjM32WY85nxCLWvQZM%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-9">第五步：方法总结</h2>
<blockquote>
<p><strong>一句话扩展法：先写一句人话 → 分拆五块积木 → 补上可视细节 → 合并成画面语言。</strong></p>
</blockquote>
<p>只要按这个步骤，<strong>任何一句话都能扩展成一条专业级中文提示词</strong>：</p>
<ul>
<li>“猫咪喝奶茶”</li>
<li>“外星人跳舞”</li>
<li>“仙侠少女看月亮”</li>
<li>“城市中追车”</li>
</ul>
<p>统统适用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【开源】耗时数月、我开发了一款功能全面的AI图床]]></title>    <link>https://juejin.cn/post/7574718964045365298</link>    <guid>https://juejin.cn/post/7574718964045365298</guid>    <pubDate>2025-11-21T06:15:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574718964045365298" data-draft-id="7574724406306357298" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【开源】耗时数月、我开发了一款功能全面的AI图床 "/> <meta itemprop="keywords" content="前端,后端,图片资源"/> <meta itemprop="datePublished" content="2025-11-21T06:15:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="_小九"/> <meta itemprop="url" content="https://juejin.cn/user/3861140568811576"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【开源】耗时数月、我开发了一款功能全面的AI图床 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3861140568811576/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    _小九
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.5 如鱼得水
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.5 如鱼得水" title="VIP.5 如鱼得水" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T06:15:01.000Z" title="Fri Nov 21 2025 06:15:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>如果你想快速了解此项目、你可以访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fpixelpunk.cc%2F" target="_blank" title="https://pixelpunk.cc/" ref="nofollow noopener noreferrer">PixelPunk官方文档</a>。</p>
</blockquote>
<blockquote>
<p>如果你想快速体验此项目、你可以访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fv1.pixelpunk.cc%2F" target="_blank" title="https://v1.pixelpunk.cc/" ref="nofollow noopener noreferrer">V1版本</a>,前往体验功能。</p>
</blockquote>
<blockquote>
<p>如果你想完整体验前后台全面的功能、你可以访问<a href="https://link.juejin.cn?target=http%3A%2F%2Fdev.pixelpunk.cc%2F" target="_blank" title="http://dev.pixelpunk.cc/" ref="nofollow noopener noreferrer">测试环境</a>。【root 123456】</p>
</blockquote>
<blockquote>
<p>如果您认可我的项目，愿意为我献上一个宝贵的Star，你可以前往<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCooperJiang%2FPixelPunk" target="_blank" title="https://github.com/CooperJiang/PixelPunk" ref="nofollow noopener noreferrer">PixelPunk</a>项目。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bada0a94aae436495f282772dd0748b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=5fWn3ewAdVEhFsig7JvD1gHCxbY%3D" alt="image.png" loading="lazy"/></p>
<p>开发这样一个项目在现在这个时间来看似乎没什么必要，实际上开发这样一个项目的原因其实就是在年初的时候失业了一段时间，闲在家里无聊，于是想着做一个自己的开源项目，最开始其实做的是另一个类型的项目，开发了一段时间感觉有些无聊就转战做了现在的这个项目<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCooperJiang%2FPixelPunk" target="_blank" title="https://github.com/CooperJiang/PixelPunk" ref="nofollow noopener noreferrer">PixelPunk图床</a>， 其实并不只是想要做一个<code>图床</code>，只是当前来说的一期功能比较贴合图床，后期的跌代准备支持更多格式包括视频文档等等，并且由于<code>AI多模态模型</code>的能力发展迅速，后期结合<code>AI</code>可以实现更多可玩性比较高的内容。</p>
<p>市面上已经有了非常多的开源图床了，开发这样一个项目要追求一些差异点才会有价值，本质上来说这类服务其实核心就是个存图片而已，其他功能并不是很重要，但是作为个人使用用户来说，除了存图也愿意去尝试一些便捷的功能，于是思考到这个点之后，我开始了这个项目的开发，项目的命名<code>[PixelPunk] </code>是我让AI起的，因为要做就要做一个不一样的有特点，我要做一个ui上就不一样的图床出来，于是有了此命名，中文翻译过来是<code>像素朋克</code>,由于像素风格感觉ui不是很适合工具类网站使用，于是我选择了<code>赛博朋克风格</code>，围绕这个ui来开发了此项目。</p>
<h3 data-id="heading-0">项目概览</h3>
<p>首先呢项目从开发就一个全栈项目，前后端放一起了，采用的技术栈是 go+vue， 前端会将打包的文件放入到go中一起打包为<code>二进制</code>安装包，这样部署起来将非常简单。
项目分为了用户端和管理端，并且同属于一个项目，不分离开发，为了符合我们定制化的ui，所有组件都是自定义的组件，项目使用了<code>70+</code>自定义组件。
项目接入了多模态<code>AI</code>大模型，在以前我们的图床要实现各种功能需要对接各种各样的平台，现在有了<code>AI</code>，我们只需要一个模型就能完成非常多的功能，比如【<strong>语义化描述图片</strong>】，【**<em>图片OCR识别</em>】，【**<em>图片自动分类</em>】，【**<em>图片自动打标</em>】，【**<em>图标自动审核NSFW、违规图、敏感图、血腥图等等</em>】，【<strong>图片颜色提取</strong>】等等功能都只需要配置一个<code>AI模型</code>即可，对于成本而言，比之前的三方<code>API</code>可能更加便宜</p>
<h3 data-id="heading-1">关于部署</h3>
<p>作为一个开源项目，我想的是需要使用者使用起来足够简单，部署起来也足够快，本身来讲，我们项目需要用来这些内容，<code>mysql|Sqlite</code> + <code>Redis|系统内存</code> + <code>qdrant向量数据库</code>， 这三件套，为了安装简单，我将向量数据库直接集成到安装包，用户可以无需关系任何内容，我们可以做到<code>0配置启动项目</code>，不需要你做任何配置即可超快部署项目。</p>
<p>我们提供了两种部署方式，一种是安装包部署，你可以下载对应平台的安装包**.zip安装包**，下载到你的服务器，解压之后里面有一个<code>install.sh</code>，直接<code>sh ./install.sh</code>即可安装，当然手动部署 可能还需要两个步骤，你可以使用我们的脚本直接进行部署，也可以看看我们的部署文档，<a href="https://link.juejin.cn?target=https%3A%2F%2Fpixelpunk.cc%2Fdocs%2Fgetting-started" target="_blank" title="https://pixelpunk.cc/docs/getting-started" ref="nofollow noopener noreferrer">PixelPunk部署文档</a>。</p>
<blockquote>
<p>安装包一键部署 <code>curl -fsSL https://download.pixelpunk.cc/shell/install.sh | bash</code></p>
</blockquote>
<blockquote>
<p>docker-compose一键部署脚本 <code>curl -fsSL https://download.pixelpunk.cc/shell/docker-install.sh | bash</code></p>
</blockquote>
<p>我们的部署非常简单，你只需要执行完脚本即可直接启动项目，我们的<code>docker-compose部署方式</code>已经配置了所有数据库缓存等信息，启动项目进入 <strong><a href="https://link.juejin.cn?target=http%3A%2F%2Fip%3A9520" target="_blank" title="http://ip:9520" ref="nofollow noopener noreferrer">http://ip:9520</a></strong> 会自动跳转到安装页面，添加管理员账号密码即可完成安装， 如果使用安装包模式呢，那么就支持你可以自定义选择数据库，可以填写自己的mysql，也可以使用系统内置的<code>Sqlite</code>，可以选择自己的<code>向量数据库和缓存</code>，也可以使用系统内置的，自由选择，总之，一键脚本预估20S就可以帮你安装并且启动项目，无需你的任何配置，希望会自己内置生成一些必要信息，比如<strong>jwt</strong>，系统安装后你可以进入后台管理进行修改。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28da070422dd4053915ba5f9e947322a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=tVMkCqLBuiekcVTCbVj6V45Ef2M%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">项目部分功能</h3>
<p>我们的项目功能可以说已经非常全面了，并且还在持续迭代，目前代码总行数已经达到了<code>30W行</code>，很多功能需要你自己体验，我们覆盖了主流图床的全部功能，并且还在进一步持续加入更多有趣的元素，我们可以列举一些功能做简要说明。</p>
<h4 data-id="heading-3">10+精美主题</h4>
<p>作为个人使用的工具，我一直在持续优化UI和交互，始终认为，<code>UI</code>还是很重要的一个步骤，目前的<code>UI还不够精美</code>，也是后续会持续调整的一个点，目前提供了<code>10多套</code>主题，并且您可以自定义主题，我在项目中放置了<strong>主题开发文档</strong>,你可以根据模板文件去替换一套变量即可完成一套主题的开发。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c9416634a9d4fe6a07b2f25dbab0ab4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=ksH0DgnJ%2BytRxBjnOl9Z%2BsPMm4c%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bdf3798fec034b7aaceff58524b7b733~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=8JrdCP0BC4clFYaRkHCQe4dEeak%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-4">多语言双风格</h4>
<p>我们目前内置了三种语言<code>中英日</code>,并且为了迎合我们<code>PixelPunk风格</code>的特色，我们新增了一种风格选项，你可以选择<code>赛博朋克风格</code>的文案，让系统的所有内容提示充满赛博味道~</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3152eb1f44824daa9aaf4428e0357b0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=gSDqOQPuLSAdIBUvajx%2F4jKdxy4%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62ec4e8376c542c6b5fc0a62f9b8a512~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=157aLoe4TEQvkfLQ%2FvGrAv%2FSTt0%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-5">多布局系统</h4>
<p>我们网站为了更好的工作体验，提供了两种的布局方式,<code>传统布局</code>,<code>工作布局</code>，既可以使用传统的轻量化的布局让人轻松，也可以使用工作台布局让工作更高效。并且您还可以在后台限制这些功能，使用固定布局而不开放这些功能，在后台管理部分都可以实现。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b76d28edf12749e180c31bd42d90ad6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=s867rJHmeJg3r32jqrglpjJ%2FShY%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f22417779924ad1898afc8620ad40f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=74NvoQV1LI6VPNz%2BtlpssmeMxmM%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-6">多种登录方式</h4>
<p>我们内置默认使用传统邮箱的登录方式，并且支持关闭注册，<code>邮箱配置也是后台配置即可</code>，同时系统对接了<code>Github</code>、<code>Google</code>、<code>LinuxDo</code>三种接入成本非常低的快捷登录方式，并且可能由于你是国内服务器，无法直接访问这些服务，所以系统贴心的准备了<code>(代理服务)</code>配置，让你即使是国内服务器也依然可以顺利完成这些快捷登录。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55af683a3ec340e09bba7b1a875dfaf4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=27tWZAXpR3UAkgAtfh30br03%2FOc%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8fc5d4613564de4b8bb1b823ec4c39e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=w7UkFYVlMOwGB%2BC4nYxF8S7PvLQ%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-7">强大的特色文件上传</h4>
<p>文件上传是一个基础的功能，所有图床都支持，我们当然也支持，我们在此功能上进行了耐心的打磨，支持很多特色功能，</p>
<ul>
<li>支持后台动态配置允许格式，动态配置上传图片限制尺寸</li>
<li>支持<code>大文件分片上传</code>、<code>断点续传</code>等功能。</li>
<li>支持<code>秒传</code>，后台动态开启是否启用</li>
<li>支持<code>游客模式</code>，限制游客上传数量，并限制上传资源有效时间</li>
<li>支持<code>自定义资源保存时间</code>，后台可配置用户允许选择有效期，精确到分钟</li>
<li>支持<code>重复图检测</code>，重复图自动秒传，不占用空间</li>
<li>支持水印，并且特色化水印，开发了一个水印专用面板用于你配置特色化水印，支持<code>文字、图片</code>水印。</li>
<li>支持<code>中断上传</code>,取消上传</li>
<li>支持<code>上传实时进度提示</code></li>
<li>支持<code>自动优化图片</code>，<code>自定义上传文件夹</code>。</li>
<li>支持<code>文件夹上传</code>,<code>拖拽上传</code>,<code>项目内全局上传（任意页面都支持上传）</code>。</li>
<li>支持<code>原图复制</code>,<code>MD格式复制</code>,<code>HTML格式复制</code>,<code>缩略图格式复制</code>,<code>全部图片链接批量复制</code></li>
<li>支持<code>公开、私密、受保护</code>,三种权限设置，<code>公开图片</code>可以在任何地方显示并且授权给管理员可以用于推荐，并且在作者首页可以展示对外，<code>私密</code>则仅自己可见，系统其他人不可见，<code>受保护</code>权限图片只能在系统观看打开，无法产生链接，除自己登录系统外，其他人无法观看。</li>
<li>支持<code>持久化</code>，你可以选择图片并且上传中，跳转到任何页面而不会中断你的上传，你可以在上传过程中干任何事情</li>
<li>支持<code>特色悬浮球</code>，当你不在上传页面的其他页面，如果有上传内容，会有一个特色上传球实时告知您上传的进度，并且你可以随意拖动控制悬浮球的位置。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8fdc7ea1ec924525bf3b14d5d5ca803d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=SqJyPr%2FrTNiu8LEWzfmokYBc%2BOk%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f66c5469421d47639f17f4d9fd308934~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=vkfi3rkhaHi%2BsHDrx69J3TA3OTk%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93ae54015b5348ceaa37d7fc7874985f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=W2MJB4iPDNOMfVxAGtKuh7kWKqc%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-8">超过上传渠道支持</h4>
<p>作为一个图床的基本素养，都会支持对接三方，目前我们已经支持了<code>10+</code>的三方云储存渠道，并且添加时候可以测试渠道保障你的配置，首先我们支持<code>服务器自身存储</code>，这也是系统默认渠道，你可以在后台渠道配置更多，比如<code>阿里云COS</code>,<code>腾讯云OSS</code>,<code>七牛云</code>,<code>雨云</code>,<code>又拍云</code>,<code>S3</code>,<code>Cloudfare R2</code>,<code>WebDav</code>,<code>AZure</code>,<code>Sftp</code>,<code>Ftp</code>,等等渠道，<strong>S3</strong>协议本身就可以支持非常多的基于S3协议的渠道了，并且，如果你想要更多渠道，可以去往我们官网网站提起诉求，我们可以很快支持新的渠道。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa931accca7c4903a5eb329f90d1adb2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=6KGHsFjAjraMvxFS4R4f3%2F1ZyNg%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e2674a6366e4caabe03f3f98f0f6391~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=jZjWXiqo0G7oPbnsg9JpkH8XVQY%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-9">特色AI功能</h4>
<p>AI也是我们图床的一大特色，我们利用AI做了这些事情</p>
<ul>
<li>自动分类</li>
<li>自动打标</li>
<li>语义化图片，提取信息，提取色调</li>
<li>实现ai自然语言搜索</li>
<li>实现相似图搜索</li>
<li>实现NSFW违规图审核</li>
</ul>
<p>而这些，仅仅只需要配置一个<strong>openai的gpt4-mini</strong>即可完成，后续会支持更多渠道（目前仅支持配置OPENAI格式的渠道），目前测试感觉<strong>gpt-4.1-mini</strong>足以胜任工作，并且价格低廉，性价比很高。</p>
<ul>
<li>违规图片检测 可以自定义等级 宽松或严格</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b57cfde532dc4c13bad16a572ff66a93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=oIKdJDPFrBSVJlULDdRyB8%2FOILI%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>自然语言搜索图片</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/084de3398649419f834f4c948b2bcfa3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=0DqwiqbIchZNX92h74ejCmtUC3s%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>相似图搜索</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d322149879694be5bfd9c7a94b420738~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=9mha8ofh%2FEKHhU%2BIhqXH%2Fpp0kUk%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>图片ai描述</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55e575a838c24ced9ef145455cdd7ef1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=QYjwm54STyzBTYU0qI%2BhL7HGRMk%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>自动分类打标签</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05ea689cef8c44829823170ca949d523~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=eBNytqaGR9i6PPyqKCPh1KusRXM%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-10">文件夹功能</h4>
<p>文件分类是一个和合理的诉求，所以我们可以自定义创建文件夹，同样可以控制不同的权限，并且文件夹可以无限嵌套 你可以自定义多层级的文件夹 合理管理你的文件，并且我们支持<code>文件夹移动</code>，<code>图片移动</code>，<code>批量操作</code>，<code>右键菜单</code>，<code>拖拽排序</code>等等特色功能，你可以灵活的管理你的文件。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffa3db788fb14937a9ca47cf82d77def~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=c%2FuFtiMSrP6vkZBLQ3%2BnKfWxnuE%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>右键菜单</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/512e2954b1334e7fa3b57f69b490068d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=VUAPuvdr45Rvo0p7DQ0Sd5eRj1o%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-11">分享系统</h4>
<p>我们拥有大量素材，或者一些收藏资源需要分享给好友，我们可以任意创建分享，可以分享自己的文件夹，图片，也可以组合分享，也可以分享用户公开的推荐图，选择任意探索广场的图进行分享，并且可以统计访问次数，限制访问次数，达到访问次数关闭分享，密码分享，限制时间有效期分享，邮箱通知等等功能。</p>
<p>您可以观看我们的<a href="https://link.juejin.cn?target=https%3A%2F%2Fv1.pixelpunk.cc%2Fshare%2FETDMDkz6EnzZxEMl" target="_blank" title="https://v1.pixelpunk.cc/share/ETDMDkz6EnzZxEMl" ref="nofollow noopener noreferrer">演示分享内容</a></p>
<ul>
<li>创建分享</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa459bf521ec476b8190f04bb4f84bd6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=Ed8COuHeG9Tm4RPtn%2B8jX3aG6ws%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a5e483c67d4441e897fb2c9879ec1b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=eoZtK3nFDNnREAjJ13EFI2WP4o0%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-12">防盗链管理</h4>
<p>图床安全始终是一个问题，经常会遇到被盗刷的风险，由于流量费用贵，鄙人有幸被刷破产过一次（TMD），我们加入了防盗链配置，可以配置<code>白黑名单域名|IP</code>，可以配置<code>网站refer</code>等内容，并且对于违规的用户，我们可以配置让其<code>302到他地址</code>,<code>可以自定义返回固定图</code>,<code>也可以直接拒绝</code>。</p>
<p>当我们对接三方渠道的时候，正常情况我们会拿到<code>远程url地址</code>，我们依然可以在后台配置渠道将其隐藏远程url地址，如果配置，那么域名请求将会从我们服务器代理获取，可以隐藏掉三方的地址，或者配置私有存储桶通过秘钥去动态获取图片，防止你的图片被盗刷大量流量</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6092e578d72a4b2f83e9f98b4ec1c277~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=n5TFt%2BZMwwIeFgqLxCax7zQiRgc%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-13">开放API</h4>
<p>图床的基本功能之一，我们可以生成秘钥在三方进行上传文件，不同的是，我们系统支持了设置秘钥时可以<code>限制其使用的空间</code>，<code>限制上传次数</code>，可以<code>指定上传的文件夹</code>,指定<code>文件格式</code>等等，并位置提供了完整的上传文档，支持<code>单文件上传</code>,<code>多文件上传</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90d55a4cd12e45f3bccb57c8a30470dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=i%2BzXB20MmA0Njc4Iwg%2FcA%2BzjQb4%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-14">随机图片</h4>
<p>经常会有人需要一个随机图片的API，但是受限于使用别人的不够稳定，也不够灵活，于是我们开放了一个随机API功能，你可以动态的配置，选择其绑定你需要随机的图片，比如指定随机任意文件夹，指定返回方式302重定向，或直接返回图片，你可以点击<a href="https://link.juejin.cn?target=https%3A%2F%2Fv1.pixelpunk.cc%2Fapi%2Fv1%2Fr%2Frnd_C3wEvW5T9EjJ" target="_blank" title="https://v1.pixelpunk.cc/api/v1/r/rnd_C3wEvW5T9EjJ" ref="nofollow noopener noreferrer">pixelpunk随机图片API演示</a> ，每次刷新你可以获取新的图片。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d507d4f2f6947ef80c161b73337a5fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=TTX78wMjr45k8zr70N%2BrMLDAfpI%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-15">空间带宽控制</h4>
<p>我们允许为用户配置限制的使用空间和流量，后台动态灵活配置这些内容，保证多用户使用的时候限制用户使用量。</p>
<h3 data-id="heading-16">更多功能</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed3904072cee4741a79777739e8ae0af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=pEM3%2BzIc%2FRN%2Fho9F%2F%2FCclkiNFeE%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92f44fb955fd48d283b89d061a5651e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=yUWm1SXvwBd8lhPsd05uO8zC4CY%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/813a5acee47f4818a667273b7ee0785e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=gV1ZFkRESlGtaZQXs3Vm1ObZDs8%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7232fbd2fa040d888643bf21fee31dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=o%2BIwr7IC23%2Fh%2FFwu8xG1RERA1Bg%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/800b0f1909c343e4b00f1b8b18b06fcd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310500&amp;x-signature=rsSczGUdNNd3E2lxOzvkKTq%2FzAk%3D" alt="image.png" loading="lazy"/></p>
<p>总之我们的功能远不止如此，我们还有很多有意思的功能，一些更多的细节需要你去探索，比如，公告系统、消息通知、活动日志、限制登录、IP登录记录，超全的管理系统、埋点统计、访客系统等等模块，这是我个人第一个花费较多时间开发的一套系统，目前对比市面上所有的开源图床，自我认为是一款相对功能最全面的图床，耗费了我大量时间。</p>
<p>如果佬友花费时间看到了这里，那么希望能收获你的一个<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCooperJiang%2FPixelPunk" target="_blank" title="https://github.com/CooperJiang/PixelPunk" ref="nofollow noopener noreferrer">宝贵的Star</a>,后续的功能我依然会持续跌代，如果你有任何需求，可以私信我，如果合理，我可以无偿免费优先加入到后续跌代中去。</p>
<h3 data-id="heading-17">待更新预期功能</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 后端多语言适配</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> UI 美化</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> Desktop 端开发</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 更多格式支持 (视频|文档)</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 交互体验优化</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 更多渠道支持</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 更多AI接入</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 图片处理工具箱</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[下周感恩节！文心快码助力感恩节抽奖页快速开发]]></title>    <link>https://juejin.cn/post/7574803558877921295</link>    <guid>https://juejin.cn/post/7574803558877921295</guid>    <pubDate>2025-11-21T07:37:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574803558877921295" data-draft-id="7574869203448053760" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="下周感恩节！文心快码助力感恩节抽奖页快速开发"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2025-11-21T07:37:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="文心快码BaiduComate"/> <meta itemprop="url" content="https://juejin.cn/user/992209294070809"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            下周感恩节！文心快码助力感恩节抽奖页快速开发
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/992209294070809/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    文心快码BaiduComate
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T07:37:06.000Z" title="Fri Nov 21 2025 07:37:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文转载自“嚣张农民”，有修改。</p>
<p>嚣张农民：前端工程师，通过AI Coding简化辅助工作内容，节约时间做更多的事。</p>
</blockquote>
<p>在清晨的早上，我在公司吃着早餐，刷着抖音推荐的大数据长腿生物，听着后端兄弟讲八卦，突然一条消息弹窗弹出，里面的需求要我完成感恩节的抽奖页面，看着简单的几句话，我知道又要占据我几天的时间去忙碌，纯前端的页面不需要后端参与，斜眼看了下隔壁后端老哥的嘴角微微一笑。但是作为墨鱼圣子怎会妥协，我想起百度文心快码已经更新到3.5S，可以快速从0-1搭建，更加智能，就像钢铁侠中贾维斯一样明确你发出的指令（抽象描述词），而且可以免费使用，那还等什么，赶紧用起来哈哈~~~</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d645c488dff84c889f65555f7fa48773~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315426&amp;x-signature=0P69cw9eYH69yqAngGt1bHq%2F1zc%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>文心快码 ( Baidu Comate ) 是一款由百度推出的创新型 AI 编码辅助工具，它利用先进的人工智能技术，旨在带来流畅、直观且上下文驱动的编码体验，助力开发者更轻松地实现宏大的软件项目和创新想法。近日，Comate发布最新版，功能又又又又升级啦：</p>
<ul>
<li>内置丰富垂类Agent，即点即用；</li>
<li>自定义 Agent 可在项目内便捷共享，助力团队沉淀经验、复用流程；</li>
<li>Rules支持基于AI自动创建，简化配置方式、落地更高效。</li>
</ul>
<h2 data-id="heading-0">安装流程及操作</h2>
<p>了解升级内容文档之后开始我们的开发，在我的VS Code版本（1.104.0）直接插件安装，输入Baidu Comate之后等待安装，然后根据自己的需求选择需要的智能体，我是选择Zulu去进行开发。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd771ba4de12487aabce92d4b609dfe0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315426&amp;x-signature=DmdXS8GGlfmvy9iaZDDt0%2FNbGM4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/954e0df123564dd19f30ef90ff06140d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315426&amp;x-signature=LmiSj6PZIYAkmDaLnTF1U7%2FuFeU%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-1">描述指令</h2>
<p>给文心快码一些指令，我这边整理好需求之后，让它帮我上手开发，一行代码不用敲，这时候需要发挥我们的创意了,只需要坐在电脑前等待就好了。</p>
<blockquote>
<p><strong>Prompt：</strong></p>
<p>🎯 页面目标</p>
<p>主题：感恩节</p>
<p>目的：给公司员工抽取礼物</p>
<p>风格：温馨有爱、节日氛围浓厚（浅色系为主）</p>
<p>要有动效、音效（抽奖转动时有动画，中奖时有烟花或彩带效果）</p>
<p>🎨 交互与动效</p>
<p>中心是一个九宫格风格的抽奖组件</p>
<p>点击「开始抽奖」按钮后：抽奖动画播放 2~3 秒，停止后显示中奖结果，播放中奖动画（烟花、礼花、闪光特效等）</p>
<p>背景音乐（抽奖期间播放，结果揭晓时切换音乐）</p>
<p>排行榜组件（记录中奖次数/大奖获得者）</p>
<p>可配置奖品和概率（JSON配置即可），通过页面的“配置奖品”按钮配置</p>
<p>⚙️ 技术要求</p>
<p>使用Vue** + Vite + TailwindCSS**</p>
<p>抽奖逻辑在前端模拟实现（不连后台）</p>
<p>项目结构清晰、组件化</p>
<p>包含基本的状态管理逻辑（例如用useState / useReducer）</p>
<p>页面响应式适配 PC 和大屏展示</p>
<p>📦 交付内容</p>
<p>提供完整可运行的项目代码（含 package.json、入口文件、组件文件等）</p>
<p>预置6~8 个奖品示例（名称 + 图片）</p>
<p>使用本地假数据模拟抽奖结果（可后续接后台接口）</p>
</blockquote>
<h2 data-id="heading-2">效果展示</h2>
<p>不到十分钟文心快码完成框架搭建，代码生产，UI生产，完成我们精美的页面</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe166a9b5289414cb0194dd56ff5f83d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315426&amp;x-signature=076C3r5asOmbVwiWPCM7vlQoWn0%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>当前页面已具备抽奖基本功能，但仍不能实现奖品配置和真实员工姓名与奖品一一对应，九宫格也略显简陋，再次输入Prompt进行优化：</p>
<blockquote>
<p><strong>Prompt：</strong></p>
<p>1.请隐藏奖品列表，添加“奖品配置”按钮，点击打开奖品配置页面，可以配置奖品名称和概率，奖品图案自动生成；</p>
<p>2.在九宫格上方添加“姓名"输入框，输入框右边为“确认”按钮，点击确认后，抽奖奖品和姓名一一对应，1人仅1次抽奖机会</p>
<p>3.优化九宫格视觉，九宫格格子有多种色彩，文字和图片放大</p>
</blockquote>
<p>页面焕然一新啦！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4939fc19ddb04e75b3d1eddc63327175~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315426&amp;x-signature=aAvK9y1molMfEkco6EOfU%2BGqaEI%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>让我们测试下功能吧：假设员工“张三”参与抽奖</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/478ced2594e348a38507b18568be1cb8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315426&amp;x-signature=MyMLOc96SK4X%2FFyWBgKyz9FC9ko%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>张三随机抽得“谢谢参与”并计入排行榜，再次点击“检查状态”，抽奖按钮置灰，一人仅可抽一次</p>
<p>再多试几个人：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8be572ec9bb74fb9afe5ec93b92d013d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315426&amp;x-signature=HuvB6A%2Fb5piRGaKWn5rRNwnyWDE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>点击“奖品配置”按钮，可以修改奖品及对应概率（会提示当前概率总和，很方便）：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fad8183adf2c4adfa8ed31c764330602~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315426&amp;x-signature=A%2FAI6jnm8EAB80IroA8SVgaBLc4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-3">后续优化</h2>
<p>如：支持<strong>上传本地奖品图片并可在对应九宫格显示，还有根据姓名输入提示中奖率哈哈（开玩笑）~~~</strong></p>
<p>当前奖品图片不可更改，优化为可上传更改。</p>
<blockquote>
<p><strong>Prompt：</strong></p>
<p>奖品配置可上传奖品对应图片，修改后会显示在九宫格</p>
</blockquote>
<p>完美！现在可以自己上传奖品图片啦～～</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b4479d7705d4c83bab2f1220924d348~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315426&amp;x-signature=d9jZTdCxKgAkaGjFA89y8uJE4D4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>可以看到生成的文件和命名还是比较规范，起码帮我省了两天的开发时间，还是很给力的！！</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c97318d3bd1048aa9ccf16c0f2b0749f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315426&amp;x-signature=hI%2FCaRO2mO1OxZFUXzXwbfQGna0%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>从“个人助理”到“协作团队”，文心快码开启 AI开发新时代</p>
<p>文心快码不再只是一个帮助写代码的工具，而是可以组成一支虚拟 AI 团队，懂项目、能协作、会自我管理。</p>
<p>对于想要提升研发效率、加速交付节奏的开发者和团队来说，文心快码是不容错过的新选择。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Google Nano Banana Pro图像生成王者归来]]></title>    <link>https://juejin.cn/post/7574725286530826291</link>    <guid>https://juejin.cn/post/7574725286530826291</guid>    <pubDate>2025-11-21T07:39:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574725286530826291" data-draft-id="7574816159754600499" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Google Nano Banana Pro图像生成王者归来"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-21T07:39:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wwwzhouhui"/> <meta itemprop="url" content="https://juejin.cn/user/3428746411400537"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Google Nano Banana Pro图像生成王者归来
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3428746411400537/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wwwzhouhui
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T07:39:17.000Z" title="Fri Nov 21 2025 07:39:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在AI图像生成领域飞速发展的今天，如何让AI更精准地理解我们的需求、生成高质量的图片，成为了创作者和设计师们最关心的话题。传统的文生图模型往往在中文文字渲染、多图一致性、精准控制等方面存在明显短板，导致生成的图片要么文字乱码、要么细节失真，让人又爱又恨。</p>
<p>Google最新发布的Nano Banana Pro（正式名称：Gemini 3 Pro Image）彻底改变了这一局面。这款模型通过"自回归+扩散"混合架构，结合Gemini 3的强大推理能力，实现了文生图领域的革命性突破——不仅完美支持中文、日文、韩文等多语言文字渲染，还能同时处理最多14张参考图片，保持最多5个角色的一致性，在LMArena排行榜上以1501的Elo分数登顶第一！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76fd678f204749b5859c82cfcbad5804~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=2ZYiiTWkSBgGNHw0QofaOZEmjTI%3D" alt="image-20251121144725440" loading="lazy"/></p>
<p>这2天Nano Banana Pro非常火爆，今天我们就手把手教大家如何使用这个强大的AI图像生成工具，通过丰富的提示词案例，体验和感受一下这个王者级模型的恐怖能力。</p>
<hr/>
<h2 data-id="heading-1">功能演示实战</h2>
<p>话不多说，下面我们通过丰富的提示词案例，手把手带大家体验Nano Banana Pro的各项强大功能。小伙伴们可以直接复制提示词到Gemini或AI Studio中测试。</p>
<h3 data-id="heading-2">1. 中文文字渲染：从乱码到完美</h3>
<p>传统AI图像生成模型最大的痛点就是中文文字渲染，要么字体模糊，要么乱码一片。Nano Banana Pro彻底解决了这个问题。</p>
<h4 data-id="heading-3">案例1：古诗配图</h4>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs">给这句古诗配图：两岸猿声啼不住，轻舟已过万重山。
</code></pre>
<p><strong>效果说明</strong>：
模型不仅准确理解了古诗的意境，还自动在画面上方添加了竖排的诗句文字，字体清晰，完全没有涂抹感。画面中的轻舟、青山、江水完美契合诗意。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46b672d8d9544fbdb550d5fecaa64f6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=ukLekR2%2FQA7GS%2Fp1Hu4%2BKTePLO4%3D" alt="1763700555007" loading="lazy"/></p>
<p>呵呵，这理解力绝了！</p>
<h4 data-id="heading-4">案例2：繁体字霓虹灯牌</h4>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">霓虹闪烁的<span class="hljs-number">80</span>年代香港旺角街头夜景，有个霓虹灯牌上写着<span class="hljs-string">"可口可樂"</span>，一杯可口可乐融合在霓虹灯管设计中
</code></pre>
<p><strong>效果说明</strong>：
注意"樂"字是繁体，模型准确渲染。街头氛围、灯牌字体、光影效果都极具80年代香港风格，细节到位。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abda4d311ad144679e67854fb7bd5b08~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=1Xen1g5z8FNoXdCQYfQ8%2FFzZT2g%3D" alt="80年代香港霓虹可口可乐" loading="lazy"/></p>
<h4 data-id="heading-5">案例3：古籍插画标注</h4>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">古籍插画风格。一张精细的中国龙解剖图，展现其内部结构，并用清晰的中文标签（例如：<span class="hljs-string">"龙鳞"</span>、<span class="hljs-string">"龙爪"</span>、<span class="hljs-string">"龙珠"</span>）进行标注。画面风格庄重，带有古代学术气息。
</code></pre>
<p><strong>效果说明</strong>：
生成的图像完全像是从真实古籍中取出来的，不仅文字标注清晰，连印章都清晰可辨。这种古籍风格的质感，好家伙，设计师都要失业了！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ada27f5b3e2470f8514124921f5ff1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=hk%2B%2BdXlY6o1JMCpsHuFQQfUO%2BdY%3D" alt="1763703532453" loading="lazy"/></p>
<h4 data-id="heading-6">案例4：立体文字艺术</h4>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">一张极具食欲的美食摄影图，俯视视角。深色的木质纹理桌面上，堆满了鲜红的干辣椒和花椒。这些辣椒被巧妙地排列，组成了立体的四个汉字：<span class="hljs-string">"热辣滚烫"</span>。辣椒的表面有真实的褶皱和光泽，周围散落着几颗八角，光线温暖诱人，景深微距。
</code></pre>
<p><strong>效果说明</strong>：
用辣椒摆成的文字立体感十足，每个笔画都清晰可辨，光影效果真实自然。这种创意文字排版，以前需要PS大师花几个小时，现在一句话搞定。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31528d2066ca413abbfda10d8f253bc9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=%2FHkt%2BHHPfOrSa%2B5Gkrke%2FHtK7LA%3D" alt="1763703671285" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-7">2. 实时联网能力：AI会上网了</h3>
<p>Nano Banana Pro集成了Google搜索能力，可以获取实时信息并生成图像，这是其他图像生成模型不具备的杀手级功能。</p>
<h4 data-id="heading-8">案例5：实时天气UI设计</h4>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-swift" lang="swift">帮我搜索现在（<span class="hljs-number">20251121</span>）合肥的天气信息，并且将其放在一个天气<span class="hljs-type">UI设计稿中</span>
</code></pre>
<p><strong>效果说明</strong>：
模型会先执行Google搜索，获取合肥当前的真实天气数据（温度、天气状况、湿度），然后自动生成一个设计精美的天气UI界面。更惊喜的是，背景图居然是秋天的长城，它太懂了！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19db67adb7364b4cb37241fe7b58bfe6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=ab9QtIQ8cBlkG7Z%2B%2BgPPOt%2BYy90%3D" alt="1763703967056" loading="lazy"/></p>
<h4 data-id="heading-9">案例6：旅游日记自动生成</h4>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs">模拟在一张略带纹理的纸张上（米黄色或者浅棕色）手写的关于今天的日记。所有的图片以拼贴画风格放在一页日记上，保证图片与原图一致包含以下元素：

用手写字体描述今天做了什么，以及一两句吸引人的标语或简介，包含几张图片的介绍，用红色笔迹或其他亮色圈出或用箭头指向特别推荐的地点或活动。穿插一些与图片特色相关的简单涂鸦式小图画，写着当前的日期和北京的天气，并添加一个手绘角色形象

整体感觉要像一份由热爱生活的作者精心制作的、生动有趣的个人日记。
</code></pre>
<p><strong>效果说明</strong>：
模型会搜索当前日期和天气，然后生成一页手账风格的旅游日记。照片加了类似拍立得的白边，还有手写备注、红色圈注、涂鸦小图，甚至手绘角色都有！这个多模态理解能力太可怕了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d9bf3a364f84861a9394d00cfe08a02~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=crUwoBWqqKHn8gEaZ6e7WrtA8vY%3D" alt="1763704644688" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-10">3. 风格迁移与图像编辑：一句话P图</h3>
<p>Nano Banana Pro的图像编辑能力堪称"靠嘴P图"，基于自然语言就能精准修改图像的任何元素。</p>
<h4 data-id="heading-11">案例7：从像素风到4K渲染</h4>
<p><strong>提示词1（初始生成）</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">生成一个复古像素艺术风格的RPG游戏背包界面。左侧是像素风格的角色装备栏（头盔、铠甲、武器、鞋子），右侧是<span class="hljs-number">5</span>x5的物品格子，底部有像素字体的金币数量和<span class="hljs-string">"返回"</span>按钮。色彩限制在<span class="hljs-number">8</span>-bit调色板。
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ebbfc874ef634fccae3729da1af18c64~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=2ZMGdCZaRPT4aA7CXooZ6yJqBWs%3D" alt="1763704745374" loading="lazy"/></p>
<p><strong>提示词2（基于上图修改）</strong>：</p>
<pre><code class="hljs">保持原有的界面布局、物品位置和文本内容不变，将整个画面重新渲染为高质量的4K科幻风格UI。材质变成发光的透明毛玻璃和拉丝金属，背景是动态的宇宙星云，图标变成精细的3D全息投影模型。
</code></pre>
<p><strong>效果说明</strong>：
布局、文字、物品位置完全一致，但视觉质感从8-bit像素风瞬间升级为电影级4K渲染。这种风格切换能力，游戏UI设计师看了都要沉默。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64f0c23adad94170b8775976028d1036~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=T30UEpyLfuki5E%2BM%2BNTbNWgyaUI%3D" alt="1763704885163" loading="lazy"/></p>
<h4 data-id="heading-12">案例8：赛博朋克变吉卜力水彩</h4>
<p><strong>提示词1（初始生成）</strong>：</p>
<pre><code class="hljs">一个赛博朋克风格的街头武士全身像，站在霓虹闪烁的雨夜东京街头。他戴着发光的机械面具，穿着机能风外套，手里拿着一把发红光的武士刀，背景是巨大的广告牌和飞行汽车。摄影风格，高对比度。
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39dccf214212429cbfecd256b9208bbb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=zNwXMp86yNpN0Q1RUnulC6i1qME%3D" alt="1763704981372" loading="lazy"/></p>
<p><strong>提示词2（基于上图修改）</strong>：</p>
<pre><code class="hljs">将图中的赛博朋克武士重新绘制成吉卜力工作室（Studio Ghibli）的动画风格。使用柔和的水彩和色粉笔触，背景变成充满自然植物和手绘木结构建筑的温暖小镇白天，角色的机械装备变得更像蒸汽朋克或手工制品，光影温暖柔和。
</code></pre>
<p><strong>效果说明</strong>：
人物姿态、构图完全一致，但从冷酷的赛博朋克秒变温暖的宫崎骏风格。水彩质感、植物、木屋、柔和光线，完全就是吉卜力动画的感觉。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f09638367074425db38d6567fe43111d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=hwkgYxAjZ43wpSDKYh2eatfUQ8k%3D" alt="1763705163878" loading="lazy"/></p>
<h4 data-id="heading-13">案例9：儿童涂鸦变皮克斯3D</h4>
<p><strong>提示词1（初始生成）</strong>：</p>
<pre><code class="hljs">一张用蜡笔画在作业本纸上的儿童涂鸦。画的是一个歪歪扭扭的橘色怪兽，有三只眼睛，长着翅膀，在吐火。线条非常幼稚，充满童趣。
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d19440fa5d834715a55ca6d03097f8e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=I9RmtFhcbmMkOaUgwnRz9xPBZSY%3D" alt="1763705287287" loading="lazy"/></p>
<p><strong>提示词2（基于上图修改）</strong>：</p>
<pre><code class="hljs">基于这个儿童画的角色设计，将其渲染为皮克斯（Pixar）或迪士尼风格的3D动画电影角色。橘色怪兽变成了毛茸茸的可爱质感，大眼睛水汪汪的，翅膀也是软萌的风格。背景是梦幻的糖果云彩世界，光影质感像电影《怪兽电力公司》。
</code></pre>
<p><strong>效果说明</strong>：
保留了儿童画的创意（三只眼、翅膀、吐火），但从涂鸦变成了电影级3D角色。毛发、质感、光影都达到了皮克斯的标准，这简直就是把孩子的灵魂涂鸦变成真正的动画角色！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e0b08567c48422eb9bff2a790771683~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=9EGhyGnp4NHDC%2FcgUfuEQJOH0eo%3D" alt="1763705491715" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-14">4. 商品一致性：电商设计神器</h3>
<p>Nano Banana Pro能够完美保持商品的细节一致性，这对电商设计师来说简直是福音。</p>
<h4 data-id="heading-15">案例10：产品多配色展示</h4>
<p><strong>提示词1（初始生成）</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">设计一张<span class="hljs-string">"赛博朋克风"</span>联名限量版跑鞋。配色为黑色和荧光绿。要求鞋面有复杂的机甲纹理、发光线条和醒目的品牌Logo。放在专业摄影棚的白色背景中，细节锐利，专业布光。
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f459f8f0c4147e293558576b9a39e9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=y38iE%2FxoY%2BTIzbEnHW1927Qf6VI%3D" alt="1763705712927" loading="lazy"/></p>
<p><strong>提示词2（基于上图修改）</strong>：</p>
<pre><code class="hljs">保持这双鞋的设计和纹理不变。现在生成三双鞋并排展示：分别是原版黑绿配色、火焰红配色和冰晶蓝配色。要求版式统一，细节清晰，像产品目录一样。
</code></pre>
<p><strong>效果说明</strong>：
鞋子的机甲纹理、Logo位置、发光线条细节完全一致，只是更换了配色。这种一致性对于电商SKU展示太重要了，不需要下载上传，直接对话就能生成系列产品图！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9cf1dc558fa84240a53f09b3e02a0f0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=kFGy5l0l%2FykdJsS2nEzu3DmzRek%3D" alt="1763705951862" loading="lazy"/></p>
<h4 data-id="heading-16">案例11：产品场景合成</h4>
<p><strong>提示词3（基于上图修改）</strong>：</p>
<pre><code class="hljs">将第一双黑绿配色的球鞋放在一个潮湿的东京街头。特写镜头，地面有霓虹灯反射的水洼，一名时尚模特穿着这双鞋在街上行走，景深效果。
</code></pre>
<p><strong>效果说明</strong>：
鞋子的复杂纹理、Logo细节全都保持一致，但场景从摄影棚变成了街头实景。光影、水面反射、景深效果都极其自然，这就是"上下文记忆"的恐怖之处！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f132203cc6c6477c9e61b4a2e3852cde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=vq6hKm6lUbe7ovLhLObGyXr%2Bhgs%3D" alt="1763706143084" loading="lazy"/></p>
<h4 data-id="heading-17">案例12：多商品组合设计</h4>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">为这两个香薰产品设计产品海报。两个香薰放在一起的超近景特写，质感清晰。米色背景，周围棕色透明轻纱，蕨类植物，沉香枯木，两支铃兰。<span class="hljs-number">4</span>K超清画面质感。静物摄影，昏暗氛围，光线追踪。海报上方文案标题：<span class="hljs-string">"昆仑煮雪"</span>，极细文字。页面下方小字：<span class="hljs-string">"沉香|铃兰|草本"</span>。艺术签角标：<span class="hljs-string">"观夏|to summer"</span>。
</code></pre>
<p><strong>效果说明</strong>：
可以上传真实的商品图，模型会保持商品的所有细节（包括瓶身上的小字），然后按照你的要求进行场景搭建、排版设计。文案标题"昆仑煮雪"字体清晰，布局专业，这完全就是可以直接商用的电商海报！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1723c654538401d8eaf070dc10258e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=hkddXh5n2UEQeHkG4rr09UZ2q1s%3D" alt="Create_a_product_poster_for_two_aromatherapy_produ-1763706518061" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-18">5. 角色一致性：漫画创作利器</h3>
<p>对于漫画创作者来说，保持角色在不同场景下的一致性一直是痛点。Nano Banana Pro支持最多5个角色的一致性控制。</p>
<h4 data-id="heading-19">案例13：连续剧情绘制</h4>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs">杰瑞鼠身披《大闹天宫》动画版标志性的鹅黄色虎皮裙、大红披风和金甲，头戴凤翅紫金冠，手持金箍棒，面部表情夸张而神气，背景是天宫的亭台楼阁或花果山水帘洞，整个画面都将严格遵循上海美术电影制片厂《大闹天宫》的经典画风，色彩浓烈，线条流畅，充满浓郁的中国传统水墨和工笔重彩韵味。
</code></pre>
<p><strong>效果说明</strong>：
可以让漫威的死侍穿越到《龙猫》的公交站，或者让杰瑞鼠cosplay孙悟空。角色特征、服装细节在不同场景下都能保持一致，解决了连载漫画"每帧主角长得都不一样"的难题。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38ca46d70c9b429a82650794af6110f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=DpkF0Vlk0wIppLENKZ%2BaNpDn0%2Fo%3D" alt="1763706366423" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-20">6. 设计海报：平面设计新玩法</h3>
<p>Nano Banana Pro在平面设计方面的能力已经达到了高级设计师的水准。</p>
<h4 data-id="heading-21">案例15：电影海报设计</h4>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">一张电影海报，风格为<span class="hljs-string">"赛博朋克京剧"</span>（Cyberpunk Peking Opera）。海报主视觉是一名京剧武生站在霓虹灯闪烁的未来城市中。片名《机械霸王别姬》和宣传语：<span class="hljs-string">"当传统遇到未来。"</span>
</code></pre>
<p><strong>效果说明</strong>：
直接就是一张可以商用的电影海报，文字排版极具张力，视觉冲击力强。中西结合的设计理念，京剧与赛博朋克的融合，创意满分。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48f0f5ce6fb34e8e82c0227876f912d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=6WqF16kCBiaH2QS92Cqoo70sOjI%3D" alt="Create_a_movie_poster_with_the_theme_Cyberpunk_Pe-1763706850488" loading="lazy"/></p>
<h4 data-id="heading-22">案例16：一键换品牌</h4>
<p><strong>提示词2（基于同一海报）</strong>：</p>
<pre><code class="hljs">把人物换成Elon Musk
</code></pre>
<p><strong>效果说明</strong>：
几秒钟，新海报出来了，毫无违和感！瓶身细节、Logo、背景光影都自动适配。甚至可以换人物，这以后设计师的工作流要彻底改变了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eca8e00088a847c09622b23d8c5f2baf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=M3PBxQmFUr0QYnG5VFghEW5J7sU%3D" alt="Replace_the_Peking_Opera_martial_artist_in_the_ima-1763707186496" loading="lazy"/></p>
<p>卧槽卧槽！是不是非常简单？</p>
<hr/>
<h3 data-id="heading-23">7. 信息图表：教育科普神器</h3>
<p>Nano Banana Pro的推理能力使它在生成信息图表方面表现出色。</p>
<h4 data-id="heading-24">案例17：手工教程分解图</h4>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">制作一张信息图，展示<span class="hljs-string">"如何折一只千纸鹤（Paper Crane）"</span>。包含<span class="hljs-number">6</span>个关键折叠步骤的分解图，并标注出折痕方向（山折/谷折），极简线条风格。
</code></pre>
<p><strong>效果说明</strong>：
模型真的理解了从纸张到成品的每一步变化，连虚线标注都清清楚楚。以前要画半天的说明书，现在几秒钟搞定！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35242f62833344f38c2e74ccc1c74879~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=waUdnmy5bwhx89AwZdylyaqWuEk%3D" alt="如何折千纸鹤" loading="lazy"/></p>
<h4 data-id="heading-25">案例18：科普信息图</h4>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs">创建一个展示汽车发动机构造的信息图表
</code></pre>
<p><strong>效果说明</strong>：
零件位置、连接关系、文字标注都准确无误，这种专业级的教育图表，以前需要专业绘图软件+几个小时，现在一句话就行。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/269b159b240c495e829cfa97609ee648~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=FVjB2wrKfoId%2FUkq%2FSTBO3cUY3E%3D" alt="1763707678934" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-26">使用平台推荐</h2>
<p>小伙伴们可以通过以下平台体验Nano Banana Pro的强大能力：</p>
<h3 data-id="heading-27">官方平台</h3>
<h4 data-id="heading-28">Gemini网页版</h4>
<ul>
<li><strong>地址</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgemini.google.com" target="_blank" title="https://gemini.google.com" ref="nofollow noopener noreferrer">gemini.google.com</a></li>
<li><strong>说明</strong>: 免费用户可用，但分辨率限制为1K；Gemini Advanced订阅用户可以使用完整的2K/4K功能</li>
<li><strong>优势</strong>: 官方平台，稳定可靠，支持中文界面</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c89ed75c63de4209b2deeefc8a6a56a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=Q303URXKFn6zcMEfSu54XGHGt8w%3D" alt="image-20251121143621368" loading="lazy"/></p>
<h4 data-id="heading-29">AI Studio</h4>
<ul>
<li><strong>地址</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Faistudio.google.com" target="_blank" title="https://aistudio.google.com" ref="nofollow noopener noreferrer">aistudio.google.com</a></li>
<li><strong>说明</strong>: 需要付费API账号才能使用Pro版本</li>
<li><strong>优势</strong>: 支持API调用，适合开发者集成到自己的应用中</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9378978bc39147f6b4c8526d132e7677~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315557&amp;x-signature=Loq3jQ%2BHfJvRm5BaI4yexV8Nf8I%3D" alt="image-20251121143710485" loading="lazy"/></p>
<h3 data-id="heading-30">第三方平台（免费体验）</h3>
<p>目前以下第三方平台都已集成Nano Banana Pro，小伙伴们可以免费体验：</p>
<ul>
<li><strong>Lovart</strong> (<a href="https://link.juejin.cn?target=http%3A%2F%2Flovart.ai)%25EF%25BC%259A%25E5%2585%258D%25E8%25B4%25B9%25E4%25BD%25BF%25E7%2594%25A8%25EF%25BC%258C%25E7%2595%258C%25E9%259D%25A2%25E5%258F%258B%25E5%25A5%25BD" target="_blank" title="http://lovart.ai)%EF%BC%9A%E5%85%8D%E8%B4%B9%E4%BD%BF%E7%94%A8%EF%BC%8C%E7%95%8C%E9%9D%A2%E5%8F%8B%E5%A5%BD" ref="nofollow noopener noreferrer">lovart.ai)：免费使用，界面友好</a></li>
<li><strong>Listenhub</strong>：支持中文，响应速度快</li>
<li><strong>Flowith</strong>：适合创作者使用</li>
<li><strong>Youware</strong>：支持批量生成</li>
<li><strong>Trickle</strong>：集成了工作流功能</li>
<li><strong>ZenMux</strong> (<a href="https://link.juejin.cn?target=https%3A%2F%2Fzenmux.ai)%25EF%25BC%259A%25E6%258F%2590%25E4%25BE%259B%25E5%25A4%259A%25E6%25A8%25A1%25E5%259E%258B%25E8%2587%25AA%25E5%258A%25A8%25E8%25B7%25AF%25E7%2594%25B1" target="_blank" title="https://zenmux.ai)%EF%BC%9A%E6%8F%90%E4%BE%9B%E5%A4%9A%E6%A8%A1%E5%9E%8B%E8%87%AA%E5%8A%A8%E8%B7%AF%E7%94%B1" ref="nofollow noopener noreferrer">zenmux.ai)：提供多模型自动路由</a></li>
</ul>
<h3 data-id="heading-31">成本对比</h3>





































<table><thead><tr><th>版本</th><th>分辨率</th><th>成本（每张）</th><th>速度</th><th>推理深度</th><th>适用场景</th></tr></thead><tbody><tr><td>Gemini 2.5 Flash Image</td><td>1K</td><td>$0.039</td><td>极快(&lt;2s)</td><td>低</td><td>聊天配图、快速预览</td></tr><tr><td>Gemini 3 Pro Image</td><td>2K</td><td>$0.12</td><td>中等</td><td>中</td><td>社交媒体、日常创作</td></tr><tr><td>Gemini 3 Pro Image</td><td>4K</td><td>$0.24</td><td>较慢</td><td>高（Deep Think）</td><td>商业设计、专业创作</td></tr></tbody></table>
<p><strong>建议使用策略</strong>：</p>
<ul>
<li>草图阶段用Flash版快速迭代</li>
<li>确认满意后用Pro版进行高清渲染</li>
<li>商业项目直接使用4K+Deep Think模式</li>
</ul>
<hr/>
<h2 data-id="heading-32">总结</h2>
<p>今天主要带大家了解并体验了Google Nano Banana Pro（Gemini 3 Pro Image）这个图像生成王者的强大能力完整流程，该AI图像生成模型以"自回归规划 + 扩散渲染混合架构"和"Gemini 3深度推理能力"为核心优势，结合图像创作、平面设计、电商运营、教育科普、内容创作需求，通过Google搜索集成与多模态理解，形成了一套从自然语言提示词到4K高清图像输出的全链路AI创作解决方案。通过这套实践方案，创作者、设计师、运营人员能够高效突破传统图像生成模型的三大瓶颈——借助完美的中文文字渲染（包括繁体、日韩文等多语言支持）、超强的角色与商品一致性控制（最多14张参考图、5个角色同时保持一致）、基于自然语言的精准图像编辑（风格迁移、元素替换、细节调整），无需专业设计软件和复杂操作，就能快速实现商业级图像创作（如本次演示的"古诗配图"、"电商产品海报"、"漫画翻译上色"、"信息图表生成"、"UI设计迁移"等20+实战案例）。</p>
<p>无论是商业海报设计、产品详情页制作、漫画连载创作、教育信息图表，还是社交媒体内容、品牌物料设计，都能通过精心设计的提示词完成，极大提升创作效率和设计质量。在实际应用中，该模型不仅文字渲染准确率达97%+（完全解决了传统模型的中文乱码问题），还集成了Google搜索的实时信息获取能力（可以生成包含当前天气、新闻等实时数据的图像），适配性远优于Midjourney、DALL-E 3等竞品；特别是通过LMArena 1501 Elo排名第一的成绩，有效验证了将"System 2思维"引入视觉生成的技术路线优势。同时，方案具备良好的灵活性——小伙伴们可以基于此扩展更多创作场景，如视频故事板设计、游戏角色设计、建筑效果图生成、产品包装设计、活动海报制作、儿童绘本创作、科技论文配图等，进一步发挥Nano Banana Pro在电商运营、内容创作、教育培训、游戏美术、品牌营销等领域的应用价值。感兴趣的小伙伴可以按照文中提供的提示词案例进行实践，根据实际创作需求调整提示词的描述细节、风格关键词、分辨率参数。今天的分享就到这里结束了，我们下一篇文章见。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain 入门指南：核心概念与理论框架]]></title>    <link>https://juejin.cn/post/7574958975159337003</link>    <guid>https://juejin.cn/post/7574958975159337003</guid>    <pubDate>2025-11-21T07:42:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574958975159337003" data-draft-id="7574821757665820713" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain 入门指南：核心概念与理论框架"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-21T07:42:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吴佳浩"/> <meta itemprop="url" content="https://juejin.cn/user/2696441245481975"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain 入门指南：核心概念与理论框架
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2696441245481975/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吴佳浩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T07:42:50.000Z" title="Fri Nov 21 2025 07:42:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">LangChain 入门指南：核心概念与理论框架</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2a3016eef8c4ab0933e83e98f1dd875~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC05L2z5rWp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316400&amp;x-signature=4Ajf2edTW73Onq13w3THs8JbP0c%3D" alt="人工智能的无限可能.png" loading="lazy"/></p>
<h3 data-id="heading-1">一、什么是 LangChain？</h3>
<p>LangChain 是一个专为开发大语言模型（LLM）应用而设计的开源框架。它的核心价值在于<strong>将 LLM 的能力模块化、标准化</strong>，让开发者能够像搭积木一样组装复杂的 AI 应用，而不必从零开始处理底层的模型调用、数据处理、工具集成等繁琐工作。</p>
<p>简单来说，LangChain 解决了三个核心问题：</p>
<ol>
<li><strong>如何让 LLM 与外部世界交互</strong>（访问数据库、调用 API、读取文档）</li>
<li><strong>如何让 LLM 具备记忆和上下文管理能力</strong>（维持对话连贯性）</li>
<li><strong>如何让 LLM 自主决策和执行复杂任务</strong>（智能代理）</li>
</ol>
<hr/>
<h3 data-id="heading-2">二、LangChain 的核心概念</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1c0a22ebc7043dfa1023698bd2ec818~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC05L2z5rWp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316400&amp;x-signature=%2FE25wRgcOq5ulzHWu4j9YcBOmo8%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-mermaid" lang="mermaid">
mindmap
  root((LangChain&lt;br/&gt;核心概念))
    Models&lt;br/&gt;模型
      LLMs&lt;br/&gt;语言模型
      Chat Models&lt;br/&gt;聊天模型
      Embeddings&lt;br/&gt;嵌入模型
    Prompts&lt;br/&gt;提示词
      Templates&lt;br/&gt;模板
      Example Selectors&lt;br/&gt;示例选择器
      Output Parsers&lt;br/&gt;输出解析器
    Documents&lt;br/&gt;文档处理
      Loaders&lt;br/&gt;加载器
      Text Splitters&lt;br/&gt;文本分割器
      Transformers&lt;br/&gt;转换器
    Vector Stores&lt;br/&gt;向量存储
      Vectorization&lt;br/&gt;向量化
      Retrieval&lt;br/&gt;检索
      Re-ranking&lt;br/&gt;重排序
    Chains&lt;br/&gt;链
      LLMChain&lt;br/&gt;简单链
      Sequential&lt;br/&gt;顺序链
      Router&lt;br/&gt;路由链
      Pre-built&lt;br/&gt;预制链
    Memory&lt;br/&gt;记忆
      Buffer&lt;br/&gt;缓冲记忆
      Window&lt;br/&gt;窗口记忆
      Summary&lt;br/&gt;摘要记忆
      Entity&lt;br/&gt;实体记忆
    Agents&lt;br/&gt;代理
      ReAct&lt;br/&gt;推理行动
      Tools&lt;br/&gt;工具调用
      Planning&lt;br/&gt;任务规划
    Callbacks&lt;br/&gt;回调
      Logging&lt;br/&gt;日志记录
      Monitoring&lt;br/&gt;监控
      LangSmith&lt;br/&gt;平台集成

</code></pre>
<h4 data-id="heading-3">2.1 模型（Models）</h4>
<p>模型是 LangChain 的"大脑"，主要分为三类：</p>
<h5 data-id="heading-4"><strong>语言模型（LLMs）</strong></h5>
<p>传统的文本生成模型，接收文本输入，输出文本结果。适合单轮问答、内容生成等场景。</p>
<h5 data-id="heading-5"><strong>聊天模型（Chat Models）</strong></h5>
<p>专为对话设计的模型，理解"角色"概念（系统、用户、助手），能够维持多轮对话的上下文。这是当前主流应用的核心选择。</p>
<h5 data-id="heading-6"><strong>嵌入模型（Embeddings）</strong></h5>
<p>将文本转换为高维向量的模型，用于语义搜索、相似度计算、文档检索等场景。它是"让 AI 理解语义"的关键技术。</p>
<hr/>
<h4 data-id="heading-7">2.2 提示词工程（Prompts）</h4>
<p>提示词是人类与 AI 沟通的"语言"，LangChain 提供了系统化的提示词管理机制：</p>
<h5 data-id="heading-8"><strong>提示词模板（Prompt Templates）</strong></h5>
<p>预定义的、可复用的提示词格式，支持动态变量插入。就像邮件模板一样，你可以定义结构，然后填充具体内容。</p>
<h5 data-id="heading-9"><strong>示例选择器（Example Selectors）</strong></h5>
<p>根据用户输入，动态选择最相关的示例（Few-shot Learning），让模型更准确地理解任务需求。</p>
<h5 data-id="heading-10"><strong>输出解析器（Output Parsers）</strong></h5>
<p>将 LLM 的文本输出结构化为 JSON、列表等格式，方便程序处理。例如，让模型输出的购物清单自动转换为可操作的数据结构。</p>
<hr/>
<h4 data-id="heading-11">2.3 文档处理（Documents &amp; Text Splitting）</h4>
<p>大多数 AI 应用需要处理外部知识（PDF、网页、数据库），LangChain 提供了完整的文档处理流程：</p>
<h5 data-id="heading-12"><strong>文档加载器（Document Loaders）</strong></h5>
<p>统一接口加载各种格式的数据源：PDF、Word、网页、数据库、API 返回值等。</p>
<h5 data-id="heading-13"><strong>文本分割器（Text Splitters）</strong></h5>
<p>大模型有上下文长度限制（通常几千到几万字），文本分割器将长文档智能切分为小块：</p>
<ul>
<li><strong>字符分割</strong>：按固定字符数切分</li>
<li><strong>递归分割</strong>：保持段落完整性的智能切分</li>
<li><strong>语义分割</strong>：基于语义相似度切分（保证每块内容主题统一）</li>
</ul>
<h5 data-id="heading-14"><strong>文档转换器（Document Transformers）</strong></h5>
<p>对文档进行预处理，如去除无关信息、提取关键内容、翻译等。</p>
<hr/>
<h4 data-id="heading-15">2.4 向量存储与检索（Vector Stores &amp; Retrieval）</h4>
<p>这是构建"知识库问答"应用的核心技术：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[原始文档] --&gt; B[文本分割]
    B --&gt; C[嵌入模型&lt;br/&gt;Embeddings]
    C --&gt; D[向量数据库&lt;br/&gt;Vector Store]
    
    E[用户提问] --&gt; F[问题向量化]
    F --&gt; G[相似度检索]
    D --&gt; G
    G --&gt; H[检索相关文档]
    H --&gt; I[LLM生成答案]
    
    style A fill:#e1f5ff
    style D fill:#fff4e1
    style E fill:#f0e1ff
    style I fill:#e1ffe1
</code></pre>
<h5 data-id="heading-16"><strong>向量化流程</strong></h5>
<ol>
<li>使用嵌入模型将文档切片转换为向量</li>
<li>存储到向量数据库（如 Chroma、Pinecone、Weaviate）</li>
<li>用户提问时，将问题也向量化</li>
<li>在向量数据库中搜索最相似的文档片段</li>
<li>将检索到的内容作为上下文，让 LLM 生成答案</li>
</ol>
<h5 data-id="heading-17"><strong>检索策略</strong></h5>
<ul>
<li><strong>相似度检索</strong>：找出语义最接近的内容</li>
<li><strong>混合检索</strong>：结合关键词匹配与语义搜索</li>
<li><strong>重排序（Re-ranking）</strong>：对初步检索结果进行二次排序，提升准确性</li>
</ul>
<hr/>
<h4 data-id="heading-18">2.5 链（Chains）</h4>
<p>链是 LangChain 的核心抽象，将多个步骤串联成工作流：</p>
<h5 data-id="heading-19"><strong>简单链（LLMChain）</strong></h5>
<p>最基础的链：提示词 → 模型 → 输出解析。适合单一任务。</p>
<h5 data-id="heading-20"><strong>顺序链（SequentialChain）</strong></h5>
<p>多个链按顺序执行，前一个链的输出作为后一个链的输入。例如：文本翻译 → 情感分析 → 摘要生成。</p>
<h5 data-id="heading-21"><strong>路由链（RouterChain）</strong></h5>
<p>根据输入内容，动态选择执行不同的子链。就像智能客服，根据问题类型路由到不同的处理流程。</p>
<h5 data-id="heading-22"><strong>预制链（Pre-built Chains）</strong></h5>
<p>LangChain 提供了常见场景的开箱即用链：</p>
<ul>
<li><strong>问答链（RetrievalQA）</strong>：知识库问答</li>
<li><strong>摘要链（SummarizationChain）</strong>：文档摘要</li>
<li><strong>对话链（ConversationChain）</strong>：多轮对话管理</li>
</ul>
<hr/>
<h4 data-id="heading-23">2.6 记忆（Memory）</h4>
<p>让 LLM "记住"对话历史，实现连贯的多轮交互：</p>
<h5 data-id="heading-24"><strong>对话缓冲记忆（ConversationBufferMemory）</strong></h5>
<p>保存完整对话历史，适合短对话。</p>
<h5 data-id="heading-25"><strong>对话窗口记忆（ConversationWindowMemory）</strong></h5>
<p>只保留最近 N 轮对话，避免超出上下文限制。</p>
<h5 data-id="heading-26"><strong>对话摘要记忆（ConversationSummaryMemory）</strong></h5>
<p>定期将历史对话压缩为摘要，节省 token 消耗。</p>
<h5 data-id="heading-27"><strong>实体记忆（EntityMemory）</strong></h5>
<p>提取并记住对话中的关键实体（人名、地点、事件），适合长期对话。</p>
<hr/>
<h4 data-id="heading-28">2.7 智能代理（Agents）</h4>
<p>代理是 LangChain 最强大的功能，让 LLM 能够<strong>自主规划和执行复杂任务</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant U as 用户
    participant A as Agent&lt;br/&gt;代理
    participant L as LLM&lt;br/&gt;语言模型
    participant T as Tools&lt;br/&gt;工具集
    
    U-&gt;&gt;A: 任务目标
    A-&gt;&gt;L: 分析任务，制定计划
    L-&gt;&gt;A: 决定调用工具X
    A-&gt;&gt;T: 执行工具X
    T-&gt;&gt;A: 返回结果
    A-&gt;&gt;L: 观察结果，决定下一步
    L-&gt;&gt;A: 调用工具Y
    A-&gt;&gt;T: 执行工具Y
    T-&gt;&gt;A: 返回结果
    A-&gt;&gt;L: 任务完成？
    L-&gt;&gt;A: 是，生成最终答案
    A-&gt;&gt;U: 返回结果
</code></pre>
<h5 data-id="heading-29"><strong>工作原理</strong></h5>
<ol>
<li>用户给出任务目标</li>
<li>代理根据目标，自主决定需要调用哪些工具</li>
<li>执行工具，观察结果</li>
<li>根据结果调整下一步行动</li>
<li>循环迭代，直到完成任务</li>
</ol>
<h5 data-id="heading-30"><strong>代理类型</strong></h5>
<ul>
<li><strong>ReAct 代理</strong>：推理（Reasoning）+ 行动（Acting），最经典的代理类型</li>
<li><strong>结构化聊天代理</strong>：适合复杂工具调用，支持多参数工具</li>
<li><strong>计划执行代理</strong>：先制定完整计划，再逐步执行</li>
</ul>
<h5 data-id="heading-31"><strong>工具（Tools）</strong></h5>
<p>代理的"手脚"，可以是：</p>
<ul>
<li><strong>搜索引擎</strong>：Google、Wikipedia</li>
<li><strong>计算器</strong>：数学运算</li>
<li><strong>API 调用</strong>：天气查询、邮件发送</li>
<li><strong>数据库查询</strong>：SQL 执行</li>
<li><strong>自定义工具</strong>：任何 Python 函数</li>
</ul>
<hr/>
<h4 data-id="heading-32">2.8 回调与监控（Callbacks）</h4>
<p>生产环境必备的观测能力：</p>
<h5 data-id="heading-33"><strong>回调机制</strong></h5>
<p>在链/代理执行的各个节点插入钩子函数，记录：</p>
<ul>
<li>每次 LLM 调用的输入/输出</li>
<li>工具调用过程</li>
<li>错误信息</li>
<li>执行耗时与成本</li>
</ul>
<h5 data-id="heading-34"><strong>LangSmith 集成</strong></h5>
<p>LangChain 官方的监控平台，提供：</p>
<ul>
<li>可视化的执行追踪</li>
<li>性能分析与成本统计</li>
<li>结果评估与对比测试</li>
<li>错误调试与日志查询</li>
</ul>
<hr/>
<h3 data-id="heading-35">三、LangChain 的架构设计</h3>
<h4 data-id="heading-36">3.1 核心基础包</h4>
<h5 data-id="heading-37"><strong>langchain-core</strong></h5>
<p>整个生态的"骨架"，定义所有模块的抽象接口和核心基类：</p>
<ul>
<li>抽象类（LLM、ChatModel、Embeddings 等）</li>
<li>提示词模板、输出解析器</li>
<li>链与代理的核心逻辑</li>
<li>运行时配置（Runnable 接口）、日志与回调</li>
</ul>
<p><strong>作用</strong>：确保生态的标准化与可扩展性，所有集成都遵循统一规范。</p>
<h5 data-id="heading-38"><strong>langchain-text-splitters</strong></h5>
<p>专注于文本分割的工具包，提供：</p>
<ul>
<li>通用分割器（RecursiveCharacterTextSplitter）</li>
<li>格式专用分割器（Markdown、代码等）</li>
<li>语义分割器（基于嵌入模型的智能切分）</li>
</ul>
<hr/>
<h4 data-id="heading-39">3.2 核心功能包</h4>
<h5 data-id="heading-40"><strong>langchain-community</strong></h5>
<p>社区贡献包，集成第三方服务与工具：</p>
<ul>
<li>外部模型（OpenAI、Anthropic、Cohere 等）</li>
<li>数据源（PDF、MySQL、MongoDB 等）</li>
<li>向量库（Chroma、Pinecone、Weaviate 等）</li>
<li>工具集成（搜索引擎、API 服务等）</li>
</ul>
<p><strong>作用</strong>：实现 langchain-core 定义的抽象接口，无需重复造轮子。</p>
<h5 data-id="heading-41"><strong>langchain</strong></h5>
<p>聚合包（"元包"），默认包含 langchain-core、langchain-community 及常用功能，方便快速上手。</p>
<p><strong>注意</strong>：新版本（v0.1+）已模块化拆分,实际开发推荐直接依赖细分包。</p>
<hr/>
<h4 data-id="heading-42">3.3 场景化/进阶功能包</h4>
<h5 data-id="heading-43"><strong>langchain-agents</strong></h5>
<p>专注于智能代理实现：</p>
<ul>
<li>代理类型（ReActAgent、StructuredChatAgent）</li>
<li>工具调用策略、多代理协作逻辑</li>
<li>与外部工具的适配</li>
</ul>
<h5 data-id="heading-44"><strong>langchain-chains</strong></h5>
<p>提供预制链，封装常见任务流程：</p>
<ul>
<li>问答链（RetrievalQA）</li>
<li>摘要链（SummarizationChain）</li>
<li>对话链（ConversationChain）</li>
</ul>
<h5 data-id="heading-45"><strong>langchain-vectorstores</strong></h5>
<p>专注于向量数据库集成：</p>
<ul>
<li>主流向量库适配</li>
<li>检索策略（相似性搜索、混合检索）</li>
</ul>
<h5 data-id="heading-46"><strong>langchain-experimental</strong></h5>
<p>包含实验性功能，如多模态链、智能体优化、新模型集成等，适合尝鲜或定制开发。</p>
<hr/>
<h4 data-id="heading-47">3.4 生态配套包</h4>
<h5 data-id="heading-48"><strong>langsmith-sdk</strong></h5>
<p>官方监控与调试工具的 SDK，用于：</p>
<ul>
<li>追踪链/代理的运行</li>
<li>评估性能</li>
<li>调试错误</li>
<li>成本监控</li>
</ul>
<p><strong>作用</strong>：生产环境必备工具。</p>
<h5 data-id="heading-49"><strong>langchain-cli</strong></h5>
<p>命令行工具，辅助：</p>
<ul>
<li>项目初始化</li>
<li>模板生成</li>
<li>LangSmith 配置</li>
</ul>
<hr/>
<h4 data-id="heading-50">3.5 架构关系总结</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[langchain-core&lt;br/&gt;基础接口与抽象类] --&gt; B[langchain-community&lt;br/&gt;第三方集成]
    A --&gt; C[langchain-text-splitters&lt;br/&gt;文本处理]
    
    B --&gt; D[langchain-agents&lt;br/&gt;智能代理]
    B --&gt; E[langchain-chains&lt;br/&gt;预制链]
    B --&gt; F[langchain-vectorstores&lt;br/&gt;向量存储]
    C --&gt; D
    C --&gt; E
    
    D --&gt; G[langchain&lt;br/&gt;聚合元包]
    E --&gt; G
    F --&gt; G
    
    A --&gt; H[langchain-experimental&lt;br/&gt;实验性功能]
    H --&gt; G
    
    G --&gt; I[langsmith-sdk&lt;br/&gt;监控调试]
    G --&gt; J[langchain-cli&lt;br/&gt;开发工具]
    
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#fff4e1
    style D fill:#f0e1ff
    style E fill:#f0e1ff
    style F fill:#f0e1ff
    style G fill:#e1ffe1
    style H fill:#ffe1e1
    style I fill:#ffe1f5
    style J fill:#ffe1f5
</code></pre>
<hr/>
<h3 data-id="heading-51">四、典型应用场景</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[LangChain&lt;br/&gt;应用场景] --&gt; B[知识库问答]
    A --&gt; C[智能客服]
    A --&gt; D[内容生成]
    A --&gt; E[数据分析]
    A --&gt; F[知识管理]
    
    B --&gt; B1[文档加载]
    B1 --&gt; B2[向量化]
    B2 --&gt; B3[检索]
    B3 --&gt; B4[问答链]
    
    C --&gt; C1[对话记忆]
    C1 --&gt; C2[路由链]
    C2 --&gt; C3[工具调用]
    
    D --&gt; D1[提示词模板]
    D1 --&gt; D2[生成]
    D2 --&gt; D3[优化]
    D3 --&gt; D4[翻译]
    
    E --&gt; E1[智能代理]
    E1 --&gt; E2[SQL工具]
    E2 --&gt; E3[Python工具]
    
    F --&gt; F1[多源加载]
    F1 --&gt; F2[向量检索]
    F2 --&gt; F3[实体记忆]
    
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#f0e1ff
    style D fill:#e1ffe1
    style E fill:#ffe1f5
    style F fill:#ffe1e1
</code></pre>
<h4 data-id="heading-52">4.1 知识库问答系统</h4>
<p>用户上传企业文档，系统自动构建知识库，员工可以用自然语言提问，获得准确答案。</p>
<p><strong>核心技术</strong>：文档加载 → 文本分割 → 向量化存储 → 检索 → 问答链</p>
<hr/>
<h4 data-id="heading-53">4.2 智能客服</h4>
<p>根据用户问题，自动分类并路由到不同的处理流程，支持多轮对话，记住用户偏好。</p>
<p><strong>核心技术</strong>：对话记忆 + 路由链 + 工具调用（查询订单、查询物流等）</p>
<hr/>
<h4 data-id="heading-54">4.3 内容生成助手</h4>
<p>根据用户需求，自动生成营销文案、产品描述、报告摘要等，支持多语言翻译。</p>
<p><strong>核心技术</strong>：提示词模板 + 顺序链（生成 → 优化 → 翻译）</p>
<hr/>
<h4 data-id="heading-55">4.4 数据分析代理</h4>
<p>用户用自然语言描述分析需求，代理自动查询数据库、执行数据处理、生成可视化图表。</p>
<p><strong>核心技术</strong>：智能代理 + SQL 工具 + Python 工具</p>
<hr/>
<h4 data-id="heading-56">4.5 个人知识管理</h4>
<p>整合笔记、邮件、浏览记录，构建个人知识图谱，支持智能搜索和知识关联。</p>
<p><strong>核心技术</strong>：多源文档加载 + 向量检索 + 实体记忆</p>
<hr/>
<h3 data-id="heading-57">五、学习路径建议</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">timeline
    title LangChain 学习路径
    section 第一阶段
        理解核心概念 : LLM基本原理
                    : 提示词工程
                    : 向量化与语义搜索
    section 第二阶段
        掌握基础组件 : 模型调用
                    : 文档处理
                    : 向量存储与检索
    section 第三阶段
        构建应用链 : 简单链设计
                  : 预制链使用
                  : 对话记忆管理
    section 第四阶段
        进阶代理开发 : 工具定义与集成
                    : 代理规划逻辑
                    : 多代理协作
    section 第五阶段
        生产化部署 : 性能优化
                  : 监控调试
                  : 安全可靠性
</code></pre>
<h4 data-id="heading-58">第一阶段：理解核心概念</h4>
<ul>
<li>掌握 LLM 的基本原理与能力边界</li>
<li>理解提示词工程的重要性</li>
<li>熟悉向量化与语义搜索的逻辑</li>
</ul>
<h4 data-id="heading-59">第二阶段：掌握基础组件</h4>
<ul>
<li>模型调用与输出解析</li>
<li>文档处理与文本分割</li>
<li>向量存储与检索</li>
</ul>
<h4 data-id="heading-60">第三阶段：构建应用链</h4>
<ul>
<li>简单链的设计与调试</li>
<li>预制链的使用与定制</li>
<li>对话记忆的管理</li>
</ul>
<h4 data-id="heading-61">第四阶段：进阶代理开发</h4>
<ul>
<li>工具定义与集成</li>
<li>代理的规划与执行逻辑</li>
<li>多代理协作</li>
</ul>
<h4 data-id="heading-62">第五阶段：生产化部署</h4>
<ul>
<li>性能优化与成本控制</li>
<li>监控与调试（LangSmith）</li>
<li>安全性与可靠性设计</li>
</ul>
<hr/>
<h3 data-id="heading-63">六、总结</h3>
<p>LangChain 的核心价值在于<strong>标准化、模块化、可组合</strong>。它不是一个单一的工具,而是一套完整的开发方法论：</p>
<ul>
<li><strong>标准化</strong>：统一的接口设计，让不同模型、工具、数据源无缝集成</li>
<li><strong>模块化</strong>：清晰的职责划分，每个组件专注做好一件事</li>
<li><strong>可组合</strong>：像乐高积木一样，灵活组装出千变万化的应用</li>
</ul>
<p>无论是构建简单的问答机器人,还是复杂的多代理协作系统,LangChain 都提供了从理念到工具的全栈支持。掌握它的理论框架,你就掌握了 LLM 应用开发的"标准范式"。</p>
<p><em><strong>demo还在写 下一篇《LangChain 深入浅出入门教程》</strong></em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[工程师学AI之第四篇：大模型的参数规模与哪些因素有关？]]></title>    <link>https://juejin.cn/post/7574821757665853481</link>    <guid>https://juejin.cn/post/7574821757665853481</guid>    <pubDate>2025-11-21T07:44:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574821757665853481" data-draft-id="7574821757665837097" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="工程师学AI之第四篇：大模型的参数规模与哪些因素有关？"/> <meta itemprop="keywords" content="LLM,Agent,程序员"/> <meta itemprop="datePublished" content="2025-11-21T07:44:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            工程师学AI之第四篇：大模型的参数规模与哪些因素有关？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T07:44:48.000Z" title="Fri Nov 21 2025 07:44:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p>本章我们开始学习大模型算法理论、网络结构及其工作原理，正式开始之前我们先关注几个问题，宏观上理解大模型的概貌。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f84d1c172fc4ae6b17897e791aaca4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315888&amp;x-signature=b06YzGWeGiKLu6Cqj4b08KYAZdY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">1.大模型到底大在哪里？</h2>
<p><strong>大模型的“大”本质是“规模法则”（Scaling Laws）驱动下的系统性扩张</strong>：当模型、数据、算力同步增大时，模型能力会以可预测的方式提升，甚至涌现出小模型不具备的能力（如推理、泛化、指令遵循）。大模型的“大”并不仅仅指参数数量多，而是多维度的“规模扩展”（Scaling），主要包括：参数规模大、训练数据量规模大、计算量大、上下文长度等。</p>
<p><strong>1）参数规模（Model Size）大：知识容量与记忆能力+泛化能力+涌现能力</strong></p>
<p><strong>DeepSeek爆火之后，经常听到“参数”、8b、14b、32b、70b和671b...，“GPT-3有1750亿参数”“DeepSeek-V3含6710亿参数”，GPT-4、Gemini Ultra、Qwen3-Max万亿规模“参数”...这些天文数字具体是啥意思？</strong></p>
<p><strong>参数就像是模型的“脑细胞”（神经元及神经网络规模）。参数越多，模型的“大脑”容量就越大，能够存储和记忆更多的信息。在训练过程中，模型从海量文本中学习到的语法知识、事实知识、推理模式等，都被编码存储在这些参数中。</strong></p>
<p><strong>参数量越大，它能记住和理解的细节就越多、越复杂。巨大的参数量使得模型在遇到未曾见过的输入时，也能通过组合其学到的海量模式，给出合理、流畅的回应。它不再是简单的“死记硬背”，而是具备了强大的举一反三的能力。涌现能力是大模型最神奇的特性，当模型规模（包括参数量、数据量、计算量）超过某个临界点时，模型会表现出在较小模型中不存在或极不明显的能力。</strong></p>
<p><strong>2）训练数据量大（Data Scale）：训练语料的 token 数量，从几十亿 → 数万亿 tokens（如 GPT-4 训练约 13T tokens）。</strong></p>
<p><strong>3）计算量大（Compute Scale）：训练所需的 FLOPs（总浮点运算次数）从 petaFLOP-days → exaFLOP-days（GPT-4 约 2.15e25 FLOPs）。FLOP/s 是什么？表示计算速度，即每秒能做多少次浮点运算。1 petaFLOP/s = 10的15次幂/秒，1 exaFLOP/s = 10的18次幂/秒</strong></p>
<blockquote>
<p>💡 类比：FLOPs 是“总共要搬多少块砖”，FLOP/s 是“每秒能搬多少块砖”。</p>
</blockquote>
<h4 data-id="heading-1">“FLOP-days” 是什么意思？这是一个<strong>将计算总量与时间结合的单位</strong>，用于衡量<strong>训练所需的总计算量</strong>。定义：</h4>
<blockquote>
<p><strong>1 petaFLOP-day</strong> = 以 <strong>1 petaFLOP/s 的速度</strong>持续计算 <strong>1 天</strong> 所完成的总运算量。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f378c8de6aee4746bd78948e63f62d4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315888&amp;x-signature=72x6vZqFAtAb7XP8zCd0gxXV4Bo%3D" alt="" loading="lazy"/></p>
<p>4）上下文长度（Context Length）：单次输入能处理的 token 数，从 512 → 32K（Claude）、128K（Grok-2）、1M+（Gemini 1.5）、1M+(Qwen3-Max)。</p>
<h2 data-id="heading-2">2.参数规模与哪些因素有关？</h2>
<p>2.1 什么是大模型参数？</p>
<p><strong>在神经网络中，参数是模型在训练过程中需要从数据中学习的内部变量。您可以把它想象成一个极其复杂的数学函数（模型）中的</strong>* <em>可调节的旋钮或权重</em>*。每一个参数都负责捕捉数据中的某种细微模式，参数（Parameters） 是指模型在训练过程中需要学习的权重（Weights）和偏置（Biases），具体包括：</p>
<p>    1）权重：连接神经元之间的数值（如全连接层、注意力层的矩阵）。</p>
<p>    2）偏置：每个神经元的附加偏移量。</p>
<p>示例：一个简单的全连接层（输入维度=100，输出维度=200）的参数量为：100（输入） × 200（输出） + 200（偏置） = 20,200。</p>
<p>2.2 大模型参数规模与哪些因素有关？</p>
<p>    模型的参数可理解为其<strong>可调节的“神经元”数量，模型参数规模越大</strong>理论上学习和存储信息的能力就越强。大模型的参数规模并非随意设定，任务越复杂（如通用对话、代码生成、科学推理），所需模型容量越大。参数规模由以下因素共同决定：</p>
<p>1）模型架构：模型架构（层数、维度）直接决定了参数量的大小和利用效率。</p>
<ul>
<li>
<p><strong>核心网络结构</strong>：目前主流大模型基于<strong>Transformer架构</strong>。其参数主要来自<strong>注意力机制</strong>（如自注意力中的查询、键、值矩阵）和<strong>前馈神经网络</strong>的权重矩阵。</p>
<p>稠密模型（Dense）：所有参数参与每次计算（如 Llama 3 405B）。</p>
<p>稀疏模型（Sparse / MoE）：仅部分参数激活（如 Mixtral 8x7B、Gemini Ultra）。MoE 可在不显著增加推理成本的前提下“做大”总参数。</p>
</li>
<li>
<p>模型架构复杂度：表示能力与抽象层次，模型结构设计（如 MoE、多模态融合），混合专家（MoE）、视觉-语言对齐、工具调用能力等。为应对参数膨胀带来的计算成本，混合专家模型 (Mixture of Experts)成为重要方向。MoE模型拥有总量巨大的参数（如DeepSeek-V3总参数量6710亿），但通过稀疏激活机制，在处理单个任务时仅调用其中一小部分“专家”（如DeepSeek-V3每次推理仅激活约670亿参数），实现了在保持强大能力的同时控制计算开销。</p>
</li>
<li>
<p>简单来说，你可以把模型想象成一个建筑：层数（深度）和每层的房间数（宽度）直接决定了需要多少“砖块”（参数）。</p>
</li>
</ul>
<p><strong>2）训练数据是燃料</strong>：模型参数需要海量数据来学习和调整。</p>
<ul>
<li><strong>数据规模vs模型参数规模</strong>：参数量的增加需要与之匹配的大规模训练数据，以避免模型“消化不良”（训练不足）。模型参数需与数据量匹配。数据太少 → 过拟合；模型太小 → 欠拟合。另外，数据质量也很重要，高质量、多样化的数据能更有效地驱动参数学习到有用的知识和规律。</li>
<li>训练数据规模：研究表明在固定计算预算下，存在一个最优模型大小与数据量的配比（如 Chinchilla Scaling Law）。Chinchilla 定律建议：理想情况下，数据量应是参数量的 20 倍左右（以 token 计）。例如，Qwen3-Max的训练数据就达到了36万亿token，模型参数规模1万亿多。</li>
</ul>
<p>3）算力成本是门槛：参数规模直接受限于<strong>可用算力、电力、资金</strong>。训练和运行大模型消耗巨大。</p>
<ul>
<li><strong>训练算力</strong>：训练一个671B参数的DeepSeek-R1模型需要消耗约3.2M的GPU小时。训练 1 万亿参数模型需数千张 H100 GPU 运行数月，成本超数亿美元</li>
<li>推理成本：即使在采用MoE等技术优化后，大模型的部署和推理仍需昂贵的硬件支持</li>
</ul>
<p>2.3 如何计算大模型的参数规模？大模型的网络结构及工作原理</p>
<p>既然我们了解到模型参数规模核心依赖模型网络架构，我们以GPT3的网络结构为例，Transformer中参数主要来自嵌入层、Transformer层（包括自注意力和前馈网络）和输出层。模型的“蓝图”决定了需要多少参数来构建它。Transformer层数：模型有多“深”。每一层都包含一系列参数。层数越多，参数自然越多。隐藏层维度：模型有多“宽”。这是模型内部表示向量的尺寸。维度越大，每个层内的参数就越多（因为矩阵更大）。注意力头数和维度：Transformer核心——自注意力机制中，头数越多、每个头的维度越大，对应的参数也就越多。词汇表大小：输入和输出层的维度通常与词汇表大小相关。词汇表越大，嵌入层的参数就越多。</p>
<p>    1）V: vocab_size (词汇表大小)</p>
<p>    2）H: hidden_size (隐藏层维度，即d_model)</p>
<p>    3）L: num_layers (Transformer层数)</p>
<p>    4）A: num_attention_heads (注意力头数)</p>
<p>    5）F: feed_forward_size (前馈网络内部维度，通常为4*H)</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70e557458a7d404190843399f397e0e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315888&amp;x-signature=I5CU0qN3aTRpoXGbS%2Fl%2BWsmCx2Q%3D" alt="" loading="lazy"/>在标准Transformer中，前馈网络内部维度通常为4<em>H，所以F=4</em>H。参数计算：</p>
<p>1）词嵌入层参数：<code>P_embed = V * H</code></p>
<p>2）位置编码参数 (黄色区域)：通常使用固定正弦/余弦编码，无可学习参数。某些变体使用可学习的位置编码，参数数量为 <code>max_seq_len × H（可以忽略）。</code></p>
<p>3）输出层：通常与嵌入层共享权重，如果不共享，则为P_output = H * V</p>
<p>4）单个Transformer层：单个Transformer层的参数大约为12*H^2</p>
<ul>
<li>自注意力部分：Q、K、V、投影矩阵：3 * (H * H) ，输出投影矩阵：H * H，所以自注意力部分总共4*H^2</li>
<li>前馈网络部分：第一个线性层：H * (4H) = 4<em>H^2，第二个线性层：(4H) * H = 4</em>H^2，所以前馈网络部分总共8*H^2</li>
<li>层归一化：每个层归一化有两个可学习参数（缩放和偏移），每个参数大小为H。通常每层有两个层归一化（自注意力后和FFN后），所以是4*H。但是与H^2相比很小，通常忽略。</li>
<li>计算：单个Transformer层的参数大约为12*H^2。</li>
</ul>
<h4 data-id="heading-3">5）L层Transformer总参数P_transformer = L*P_layer，Transformer层数 96。</h4>
<p>6）总参数 = 嵌入层 + 输出层 + L * (12*H^2)               = V×H + L×(12×H²) + H×V               = 2×(V×H) + 12×L×H²</p>
<h3 data-id="heading-4">案例：GPT-3 175B 参数计算实例，参数：V = 50,257，H = 12,288  (GPT-3实际使用)，L = 96。 计算过程：</h3>
<p><code>P_embed = 50,257 × 12,288 ≈ 617M     P_layer = 12 × 12,288² ≈ 12 × 151M ≈ 1.81B     P_transformer = 96 × 1.81B ≈ 174B     P_output = 12,288 × 50,257 ≈ 617M</code></p>
<p><code>P_total = 617M + 174B + 617M ≈ 175B</code></p>
<p><code>2.4 模型训练反向传播过程</code></p>
<p><code>本节补一下上一篇工程师学AI之第五篇：从微积分梯度及链式法则，到神经网络学习优化过程，神经网络训练过程前向传播及反向传播过程如何调整模型权重参数？加深对神经网络工作机制的理解。</code></p>
<p><code>1）前向传播：</code></p>
<p><code>输入x→[w₁]→h₁→[w₂]→h₂→[w₃]→y→与目标target比较→Loss</code></p>
<p><code>h₁=f₁(x, w₁)  #第1层：h₁是x和w₁的函数</code></p>
<p><code>h₂=f₂(h₁, w₂) #第2层：h₂是h₁和w₂的函数h₂=f₂(f₁(x, w₁), w₂)</code></p>
<p><code>y=f₃(h₂, w₃) #第3层：y是h₂和w₃的函数y=f₃(f₂(f₁(x,w₁),w₂), w₃)</code></p>
<p><code>Loss = L(y, target) # 损失：损失函数L是模型输出y和真实标签target的函数Loss=L(f₃(f₂(f₁(x, w₁), w₂), w₃), target)</code></p>
<p><code>2）反向传播：损失函数如何通过链式法则影响到每一层的权重，梯度 ∂L/∂w₁ ← ∂L/∂h₁ ← ∂L/∂h₂ ← ∂L/∂y (误差信号反向传播)</code></p>
<p><code>∂Loss/∂w₃ = ∂L/∂y · ∂y/∂w₃</code></p>
<p><code>∂Loss/∂w₂ = ∂L/∂y · ∂y/∂h₂ · ∂h₂/∂w₂</code></p>
<p><code>∂Loss/∂w₁ = ∂L/∂y · ∂y/∂h₂ · ∂h₂/∂h₁ · ∂h₁/∂w₁</code></p>
<p><code>3）更新权重：根据学习率lr和损失函数更新权重</code></p>
<p><code>w3 = w3 - lr * ∂Loss/∂w₃ #grad_w3</code></p>
<p><code>w2 = w2 - lr * ∂Loss/∂w₂ #grad_w2</code></p>
<p><code>w1 = w1 - lr * ∂Loss/∂w₁ #grad_w1</code></p>
<p><code>4）案例：假设一个简单网络：</code></p>
<p><code>x = 2, w₁ = 0.5, w₂ = 1.2, w₃ = 0.8</code></p>
<p><code>h₁ = w₁·x = 1.0</code></p>
<p><code>h₂ = w₂·h₁ = 1.2</code></p>
<p><code>y = w₃·h₂ = 0.96</code></p>
<p><code>target = 1.0, Loss = (y - target)² = 0.0016</code></p>
<p><code>#反向传播计算：</code></p>
<p><code>∂L/∂y=2(y-target)=-0.08</code></p>
<p><code>∂L/∂w₃=∂L/∂y·h₂=-0.08×1.2=-0.096</code></p>
<p><code>∂L/∂w₂=∂L/∂y·w₃·h₁=-0.08×0.8×1.0=-0.064</code></p>
<p><code>∂L/∂w₁=∂L/∂y·w₃·w₂·x =-0.08×0.8×1.2×2=-0.1536</code></p>
<p><code>#权重更新（学习率 lr=0.1）：根据反向传播计算的偏导数更新权重</code></p>
<p><code>w₃'=0.8-0.1×(-0.096)=0.8096</code></p>
<p><code>w₂'=1.2-0.1×(-0.064)=1.2064</code></p>
<p><code>w₁'=0.5-0.1×(-0.1536)=0.51536</code></p>
<h2 data-id="heading-5">3.大模型参数规模有没有极限？</h2>
<p><strong>关于参数规模是否有极限，目前并没有一个确切的数字天花板，但确实面临着多方面的挑战和新的发展趋势：</strong></p>
<p>1）规模法则的指导与挑战 <strong>：研究发现，模型性能随规模增长遵循一定的</strong>规模法则 (Scaling Laws)，但这种增长关系可能并非一成不变。</p>
<ul>
<li><strong>收益递减</strong>：根据<strong>断裂式规模法则 (Broken Neural Scaling Laws)</strong> ，模型性能随规模增长可能呈现<strong>分段式提升</strong>，在某些阶段会出现收益递减的拐点。<strong>Chinchilla法则的启示</strong>：研究表明，在计算预算固定时，盲目增加参数而非同步增加训练数据，并非最优解。<strong>模型参数与训练数据需要平衡分配</strong>。例如：从 100B → 500B 提升显著，但从 1T → 2T 可能只有边际改进。</li>
</ul>
<p>2）硬件物理极限与成本约束：巨大的算力消耗和资金成本，从现实层面限制了参数规模的无限增长，商业回报能否覆盖成本，是决定“还能不能更大”的关键。</p>
<p>    芯片互联带宽：参数需在 GPU 间频繁通信，带宽瓶颈。</p>
<p>    内存墙（Memory Wall）：单卡显存有限（如 H100 80GB），超大模型需模型并行，通信开销剧增。</p>
<p>    能耗限制：训练 GPT-4 耗电约 <strong>1300 MWh</strong>，相当于数百家庭年用电量 。</p>
<p>    成本呈指数增长：GPT-3（175B）训练成本 ≈ <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>460</mn><mtext>万，</mtext><mi>G</mi><mi>P</mi><mi>T</mi><mo>−</mo><mn>4</mn><mtext>（</mtext><mn>1.5</mn><mi>T</mi><mi>M</mi><mi>o</mi><mi>E</mi><mtext>）</mtext><mo>≈</mo></mrow><annotation encoding="application/x-tex">460 万，GPT-4（1.5T MoE）≈ </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"/><span class="mord">460</span><span class="mord cjk_fallback">万，</span><span class="mord mathnormal" style="margin-right:0.13889em;">GPT</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">4</span><span class="mord cjk_fallback">（</span><span class="mord">1.5</span><span class="mord mathnormal" style="margin-right:0.10903em;">TM</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mord cjk_fallback">）</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span></span></span></span></span>7800 万 – $2 亿美元。</p>
<p>3）超越参数膨胀的新路径：探索重点正从单纯堆砌参数，转向更高效的技术路径。</p>
<ul>
<li><strong>架构创新</strong>：如前所述的<strong>MoE架构</strong>，以及<strong>多头潜在注意力 (MLA)</strong>  等新技术，旨在不显著增加计算代价的前提下提升模型能力。</li>
<li><strong>推理时计算</strong>：另一种思路是<strong>增加模型在推理阶段的“思考”量</strong>，例如通过更复杂的思维链 (Chain-of-Thought) 或搜索过程来提升任务表现，这被视为一种“推理时的规模扩展”。</li>
</ul>
<h4 data-id="heading-6"><strong>4） 数据可获性：需要“喂养”模型的知识量，根据Chinchilla定律，模型的参数量需要与训练数据的量级相匹配。参数是“容器”，数据是“粮食”。一个巨大的模型（大容器）需要海量的高质量数据（足够多的粮食）来“填满”，才能充分发挥其潜力。如果用一个万亿参数的模型去训练一个只有十亿token的数据集，它极易过拟合（只记住了训练数据，而没有泛化能力），这是巨大的资源浪费。因此，在确定参数量时，必须考虑：我们能否获得足够多、高质量的数据来有效训练这个模型？数据规模决定了参数规模的有效上限。</strong></h4>
<h4 data-id="heading-7">5）算法与工程优化</h4>
<p>    先进的算法和工程技术可以让我们在<strong>相同的参数量下获得更好的性能</strong>，或者在<strong>相同的性能下使用更少的参数</strong>。更高效的架构：如混合专家模型，它通过动态激活网络中的一部分参数来在总参数量巨大的情况下，大幅减少实际计算量。模型压缩与量化：在部署时，通过技术手段减少每个参数占用的比特数（如从32位浮点数降到8位整数），但这不改变参数的数量，只改变模型的总大小。</p>
<h2 data-id="heading-8">4.如何估算硬件资源？</h2>
<p>根据大模型的参数规模来配置硬件资源是一个系统工程，需要综合考虑训练和推理两个阶段。这里我们主要讨论训练，因为训练对硬件的要求更高。推理阶段可以根据训练阶段的配置进行适当缩减。</p>
<p>4.1训练阶段</p>
<p>训练大模型时，硬件资源配置的核心是能够容纳模型并高效地进行计算。主要考虑以下因素：</p>
<p>1）内存（GPU显存）：内存是首要瓶颈，必须能够存储模型参数、优化器状态、激活值、梯度以及临时缓冲区。训练时的总内存占用包括四个主要部分：</p>
<p>总内存 ≈ 模型参数 + 优化器状态 + 梯度 + 激活值</p>
<p><strong>单精度浮点数：FP32/BF32</strong>：4<code>× 参数量</code> bytes，用于训练场景</p>
<p><strong>半精度浮点数：FP16/BF16</strong>：<code>2 × 参数量</code> bytes，训练和部分推理场景</p>
<p>    INT8量化：<code>1 × 参数量</code> bytes，8位整数量化，推理常用</p>
<p>    INT4量化：<code>0.5 × 参数量</code> bytes，4位整数量化，轻量级推理</p>
<p>2）计算能力（FLOPs）：硬件需要提供足够的计算能力，以便在合理的时间内完成训练。</p>
<p>3）通信带宽：在多卡或多节点训练时，卡间或节点间的通信带宽至关重要。</p>
<h3 data-id="heading-9">通过前面的学习，你已经了解了模型训练的本质，是寻找最合适的参数组合。<strong>没有"最好"的配置，只有"最适合"的配置</strong>。需要根据你的具体需求、预算和时间约束来平衡这些因素。</h3>
<p>    案例：参考阿里云ACP大模型培训资料，以<code>qwen2.5-1.5b-instruct</code> 为例，粗略看下从零训练一个模型的时间和硬件需求。 为了微调大模型，你需要估算显存要求，1.5B参数占用内存（假设按全精度 FP32 ，单参数占用4字节）：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61d28cc49cd04d1b845b282e9f74f0d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315888&amp;x-signature=cIQ02j1hpw48UBfn0C01k52Tv7o%3D" alt="" loading="lazy"/></p>
<p> 一般对模型进行训练时，大概需要模型参数内存的7~8倍，也就是约<strong>45GB</strong>的显存。</p>
<h3 data-id="heading-10">4.2推理阶段 推理阶段的内存需求相对简单：推理总内存 ≈ 模型参数 + KV缓存，推理阶段可以根据训练阶段的配置，以及预估的并发用户量进行适当缩减。</h3>
<h5 data-id="heading-11">1) 模型参数内存</h5>
<p><strong>FP16/BF16</strong>：<code>2 × 参数量</code> bytes</p>
<p>    INT8量化：<code>1 × 参数量</code> bytes</p>
<p>    INT4量化：<code>0.5 × 参数量</code> bytes</p>
<h5 data-id="heading-12">2) KV缓存内存：对于自回归生成任务，需要缓存Key和Value。</h5>
<pre><code class="hljs language-python" lang="python">KV缓存 ≈ <span class="hljs-number">2</span> × 层数 × 隐藏维度 × 注意力头数 × 序列长度 × 批次大小 × <span class="hljs-number">2</span> <span class="hljs-built_in">bytes</span>
</code></pre>
<p><strong>因此，推理时单卡总内存估算</strong>：总内存 ≈ P × (2-4) + KV缓存。</p>
<h3 data-id="heading-13">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[工程师学AI之第三篇03：线性代数点积运算助你理解大模型注意力机制]]></title>    <link>https://juejin.cn/post/7574821757665869865</link>    <guid>https://juejin.cn/post/7574821757665869865</guid>    <pubDate>2025-11-21T07:45:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574821757665869865" data-draft-id="7574530224853319686" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="工程师学AI之第三篇03：线性代数点积运算助你理解大模型注意力机制"/> <meta itemprop="keywords" content="LLM,Agent,程序员"/> <meta itemprop="datePublished" content="2025-11-21T07:45:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            工程师学AI之第三篇03：线性代数点积运算助你理解大模型注意力机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T07:45:24.000Z" title="Fri Nov 21 2025 07:45:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p>在AI的世界里万物皆向量，向量可以用统一的方式表示一切信息：图片-像素，文字-编码，声音-频率特征向量，文件-向量化。前文介绍了线性代数：标量、向量、矩阵、张量；矩阵乘法、转置、点积运算等基本知识。深度学习的本质就是数学运算，而向量和矩阵是基石。神经网络的前向传播、反向传播、梯度下降，都离不开向量和矩阵运算。</p>
<p>本文重点介绍点积计算如何应用在transformer注意力机制中。你肯定好奇到底点积运算发挥了什么作用，这篇文章篇幅较长，比较烧脑，纰漏之处欢迎指出讨论，本文重点结合理论与代码实践回答下面几个问题。</p>
<p>    1）什么是向量的点积运算？python如何实现点积运算？</p>
<p>    2）点积运算与向量相似度有什么关系？python如何计算相似度？</p>
<p>    3）相似度与transformer里面注意力attention机制又是什么关系？</p>
<p>    4）python实现注意力机制。</p>
<h2 data-id="heading-0">1.什么是点积运算？</h2>
<p>点积是深度学习中最基础、最重要的运算，它是每个神经元进行计算的核心操作。点积（Dot Product）是两个向量之间的一种运算，结果是一个标量。用于衡量两个向量在方向上有多“一致”。两种定义：</p>
<p>1）代数定义: A · B = a1<em>b1 + a2</em>b2 + ... + an*bn，对应位置的分量相乘，然后将所有乘积结果相加。神经网络的"智能"就来自于学会给不同输入分配合适的权重，然后做加权求和。向量点积运算就是这个加权求和过程，让每个输入乘以权重，全部加起来。不同神经元的点积运算重复千万次，就产生了人工智能（大道至简，从简单规则到复杂智能，是不是有点类似蚂蚁群体，单个蚂蚁类似神经元的能力极其有限，但当它们通过简单规则相互连接并大规模组织起来时，就会"涌现"出全新的、更高层次的特性）。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-number">1.</span>数学表达：
<span class="hljs-comment"># 输入向量（比如一张简化的3像素图片）</span>
input_vector =[<span class="hljs-number">1.0</span>,<span class="hljs-number">0.5</span>,<span class="hljs-number">2.0</span>]
<span class="hljs-comment"># 权重向量（神经元学到的参数） </span>
weight_vector =[<span class="hljs-number">0.3</span>,<span class="hljs-number">0.7</span>,-<span class="hljs-number">0.1</span>]
<span class="hljs-comment"># 点积计算（这就是神经元在做的事情！）</span>
result=<span class="hljs-number">1.0</span>×<span class="hljs-number">0.3</span>+<span class="hljs-number">0.5</span>×<span class="hljs-number">0.7</span>+<span class="hljs-number">2.0</span>×(-<span class="hljs-number">0.1</span>)=<span class="hljs-number">0.3</span>+<span class="hljs-number">0.35</span>-<span class="hljs-number">0.2</span>=<span class="hljs-number">0.45</span>

<span class="hljs-number">2.</span>程序实现：利用python的numpy模块实现点积运算
<span class="hljs-comment"># 输入向量（比如一张简化的3像素图片）</span>
input_vector = np.array([<span class="hljs-number">1.0</span>,<span class="hljs-number">0.5</span>,<span class="hljs-number">2.0</span>])
<span class="hljs-comment"># 权重向量（神经元学到的参数）</span>
weight_vector = np.array([<span class="hljs-number">0.3</span>,<span class="hljs-number">0.7</span>,-<span class="hljs-number">0.1</span>])
<span class="hljs-comment"># 点积计算（这就是神经元在做的事情！）</span>
result = np.dot(input_vector,weight_vector)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"点积计算结果："</span>,result)

<span class="hljs-number">3.</span>自己实现Vector向量类及点积运算函数
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Vector</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, components</span>):
        self.components = components
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">dot</span>(<span class="hljs-params">self, other</span>):
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.components)!=<span class="hljs-built_in">len</span>(other.components):
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"向量维度必须相同"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">sum</span>(x * y <span class="hljs-keyword">for</span> x, y <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(self.components, other.components))
</code></pre>
<p>2）几何定义: A · B = ||A|| * ||B|| * cos(θ)，点积的结果由两个向量的长度和它们之间的夹角共同决定。   </p>
<p>     ||A|| 是向量 A 的模长（可以理解为向量的长度）。   </p>
<p>     ||B|| 是向量 B 的模长。    </p>
<p>    θ 是向量 A 和向量 B 之间的夹角。</p>
<p>3）模长||A||如何计算？向量的模长（Magnitude），也叫范数（Norm），直观来说就是向量在空间中的“长度”，从原点(0,0,...)指向向量坐标点的距离。对于一个 n维向量 A = [a1, a2, a3, ..., an]，其模长 ||A|| 的计算公式为：</p>
<p>    ||A|| = √(a1² + a2² + a3² + ... + an²)。</p>
<p>文字描述就是：向量模长等于其所有分量的平方和，再开平方根。假设有一个二维向量 A = [3, 4]，它在坐标系中就是从原点 (0,0) 指向点 (3,4) 的箭头。计算分量的平方和:    3² + 4² = 9 + 16 = 25    对结果开平方根:√25 = 5，所以，向量 A 的模长 ||A|| = 5。</p>
<p>4）两种定义是等价的：点积的数学本质A · B = ||A|| * ||B|| * cos(θ)，它同时衡量了向量的长度和方向一致性。</p>
<p>    a1<em>b1 + a2</em>b2 + ... + an*bn = ||A|| * ||B|| * cos(θ)</p>
<p>让我们用一个二维的例子来可视化这个过程，这能极大地帮助理解。</p>
<p>假设有两个向量:A = [3, 4]，B = [1, 0]</p>
<p>第一步：计算点积 A · B    A · B = (3 * 1) + (4 * 0) = 3 + 0 = 3</p>
<p>第二步：计算模长 ||A|| 和 ||B||    ||A|| = sqrt(3² + 4²) = sqrt(9 + 16) = sqrt(25) = 5    ||B|| = sqrt(1² + 0²) = sqrt(1 + 0) = 1</p>
<p>第三步：计算余弦值 cos(θ)    cos(θ) = (A · B) / (||A|| * ||B||) = 3 / (5 * 1) = 3/5 = 0.6</p>
<h2 data-id="heading-1">2.点积vs向量相似度是什么关系？</h2>
<h3 data-id="heading-2">2.1向量相似度计算</h3>
<p>如何衡量向量相似度？本质上，我们是用夹角余弦值 cos(θ) 来衡量“方向上的相似度”，而点积 A · B 是计算 cos(θ) 的一个关键步骤，但它本身并不是一个纯粹的相似度度量。</p>
<p>1）最纯粹的相似度度量是 cos(θ)：它只关心两个向量的方向是否一致，完全忽略了它们的长度（模长）。这使得它成为衡量“本质相似性”的理想指标。cos(θ) 的本质是衡量方向一致性：</p>
<p>    ✧ 当 θ = 0° 时，cos(0°) = 1。这意味着两个向量方向完全相同。此时点积达到最大值（正值）。    </p>
<p>    ✧ 当 θ = 90° 时，cos(90°) = 0。这意味着两个向量互相垂直。此时点积为 0。 </p>
<p>    ✧ 当 θ = 180° 时，cos(180°) = -1。这意味着两个向量方向完全相反。此时点积达到最小值（负值）。    </p>
<p>    所以，cos(θ) 本身就是一个完美的“相似度”度量指标，它衡量了两个向量在方向上的对齐程度。</p>
<p>2）点积 A · B 是 cos(θ) 的“未标准化”版本：点积的结果同时受到向量方向和向量长度的影响。 ||A|| * ||B|| 是缩放因子：它保证了更长的向量会对点积结果产生更大的影响。但如果两个向量的模长是固定的（归一化），那么点积的大小就完全由cos(θ)，即方向的一致性来决定。</p>








































<table><thead><tr><th/><th/><th/></tr></thead><tbody><tr><td>特征</td><td>点积 (Dot Product)</td><td>余弦相似度 (Cosine Similarity)</td></tr><tr><td>公式</td><td>A · B = Σ(a_i * b_i)</td><td>cos(θ) = (A · B) / (</td></tr><tr><td>取值范围</td><td>(-∞, +∞)</td><td>[-1,   1]</td></tr><tr><td>受向量长度影响</td><td>是</td><td>否</td></tr><tr><td>衡量的是什么</td><td>方向相似性+强度（模长）</td><td>纯方向相似性</td></tr><tr><td>主要用途</td><td>注高效计算相似度</td><td>理论上纯粹的相似度度量</td></tr></tbody></table>
<h3 data-id="heading-3">2.2向量相似度实现</h3>
<p>Transformer通过简单的点积运算(余弦相似度的核心)在大规模应用中"涌现"出强大的语言理解能力，这正是"大道至简"的完美体现。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">from</span> numpy.linalg <span class="hljs-keyword">import</span> norm
<span class="hljs-comment">#基于numpy模块实现两个向量余弦相似度相似度计算</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">cosine_similarity</span>(<span class="hljs-params">vec1, vec2</span>):
<span class="hljs-string">"""
    计算两个向量的余弦相似度
    公式:cos(θ)=(A·B)/(||A||*||B||)
    值域:[-1,1]，值越大表示越相似
1= 完全相同方向,0= 正交,-1= 完全相反方向
Args:
        vec1 (list/np.array): 第一个向量
        vec2 (list/np.array): 第二个向量
Returns:
        float: 余弦相似度值
"""</span>
    <span class="hljs-comment"># 确保输入是numpy数组</span>
    vec1 = np.array(vec1)
    vec2 = np.array(vec2)
    <span class="hljs-comment"># 计算点积</span>
    dot_product = np.dot(vec1, vec2)
    <span class="hljs-comment"># 计算向量的模长(L2范数)</span>
    norm_vec1 =norm(vec1)
    norm_vec2 =norm(vec2)

    <span class="hljs-comment"># 防止除以零</span>
    <span class="hljs-keyword">if</span> norm_vec1 ==<span class="hljs-number">0</span> <span class="hljs-keyword">or</span> norm_vec2 ==<span class="hljs-number">0</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">0.0</span>
    <span class="hljs-comment"># 计算余弦相似度</span>
    similarity = dot_product /(norm_vec1 * norm_vec2)
    <span class="hljs-keyword">return</span> similarity

<span class="hljs-comment"># 纯Python实现(不依赖numpy)，代数相似度vs几何相似度等价</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">cosine_similarity_python</span>(<span class="hljs-params">vec1, vec2</span>):
<span class="hljs-string">"""不使用numpy的余弦相似度实现"""</span>
    <span class="hljs-comment"># 计算点积</span>
    dot_product =<span class="hljs-built_in">sum</span>(a * b <span class="hljs-keyword">for</span> a, b <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(vec1, vec2))
    <span class="hljs-comment"># 计算模长</span>
    norm1 =<span class="hljs-built_in">sum</span>(a * a <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> vec1)**<span class="hljs-number">0.5</span>
    norm2 =<span class="hljs-built_in">sum</span>(b * b <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> vec2)**<span class="hljs-number">0.5</span>
    <span class="hljs-comment"># 防止除以零</span>
    <span class="hljs-keyword">if</span> norm1 ==<span class="hljs-number">0</span> <span class="hljs-keyword">or</span> norm2 ==<span class="hljs-number">0</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">0.0</span>
    <span class="hljs-keyword">return</span> dot_product /(norm1 * norm2)

<span class="hljs-comment">#测试向量相似度</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">test_cosine_similarity</span>():
<span class="hljs-string">"""测试余弦相似度函数"""</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"===== 余弦相似度测试 ====="</span>)
    <span class="hljs-comment"># 相同方向的向量</span>
    a =[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>]
    b =[<span class="hljs-number">2</span>,<span class="hljs-number">4</span>,<span class="hljs-number">6</span>]  <span class="hljs-comment"># a的2倍，完全同向</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"向量 <span class="hljs-subst">{a}</span> 和 <span class="hljs-subst">{b}</span> 的余弦相似度: <span class="hljs-subst">{cosine_similarity(a, b):<span class="hljs-number">.4</span>f}</span> (应接近1.0)"</span>)

    <span class="hljs-comment"># 正交向量</span>
    c =[<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>]
    d =[<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>]
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"向量 <span class="hljs-subst">{c}</span> 和 <span class="hljs-subst">{d}</span> 的余弦相似度: <span class="hljs-subst">{cosine_similarity(c, d):<span class="hljs-number">.4</span>f}</span> (应为0.0)"</span>)

    <span class="hljs-comment"># 相反方向</span>
    e =[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>]
    f =[-<span class="hljs-number">1</span>,-<span class="hljs-number">2</span>,-<span class="hljs-number">3</span>]
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"向量 <span class="hljs-subst">{e}</span> 和 <span class="hljs-subst">{f}</span> 的余弦相似度: <span class="hljs-subst">{cosine_similarity(e, f):<span class="hljs-number">.4</span>f}</span> (应接近-1.0)"</span>)

    <span class="hljs-comment"># 实际应用示例 - 文本向量</span>
    <span class="hljs-comment"># 假设是词嵌入向量</span>
    apple =[<span class="hljs-number">0.8</span>,<span class="hljs-number">0.6</span>,<span class="hljs-number">0.1</span>,-<span class="hljs-number">0.2</span>]
    fruit =[<span class="hljs-number">0.7</span>,<span class="hljs-number">0.5</span>,<span class="hljs-number">0.2</span>,-<span class="hljs-number">0.1</span>]
    car =[-<span class="hljs-number">0.1</span>,-<span class="hljs-number">0.3</span>,<span class="hljs-number">0.9</span>,<span class="hljs-number">0.8</span>]

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n实际应用示例 (词向量):"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"apple 和 fruit 的相似度: <span class="hljs-subst">{cosine_similarity(apple, fruit):<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"apple 和 car 的相似度: <span class="hljs-subst">{cosine_similarity(apple, car):<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"=======================\n"</span>)
<span class="hljs-comment"># 执行测试</span>
test_cosine_similarity(


</code></pre>
<h2 data-id="heading-4">3.向量相似度vs注意力机制什么关系？</h2>
<h3 data-id="heading-5">3.1Transformer的自注意力机制</h3>
<p>维基百科里面，注意力机制（英语：attention）是人工神经网络中一种模仿人类认知注意力的技术。这种机制可以增强神经网络输入数据中某些部分的权重，同时减弱其他部分的权重，以此将网络的关注点聚焦于数据中最重要的一小部分。数据中哪些部分比其他部分更重要取决于上下文。可以通过梯度下降法对注意力机制进行训练。允许模型在处理数据时动态分配权重，重点关注输入中的重要部分。让AI模型具备像人类一样“抓重点”的能力，这样AI在处理信息时也会自动分配“注意力权重”，强化关键特征，弱化次要信息。</p>
<h4 data-id="heading-6">3.1.1transformer里面的self-attentionlayer</h4>
<p>下面截图来自李宏毅老师的视频课程，这个结构相信大家看了无数遍。今天我们主要聚集这幅图里面的self-attentionlayer模块。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/123d259a63ba4e46a86611d56767b94f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315923&amp;x-signature=koOuUyjgG89G99WELUx5mPLEwXs%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-7">3.1.2Self-attention矩阵运算过程</h4>
<p>自注意力机制允许模型在处理序列数据时，关注输入序列中的不同部分。其核心是使用点积计算查询（Query）、键（Key）和值（Value）之间的相关性。自注意力机制公式：Attention(Q, K, V) = softmax(QKᵀ/√dₖ)V，点积用于计算查询(Query)和键(Key)之间的相似度。其中：Q: 查询矩阵，K: 键矩阵，V: 值矩阵，dₖ: 键向量的维度（用于缩放），整体步骤如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3e065ac2e5b422782494f16f0b414e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315923&amp;x-signature=uMxFO5fwt1mOyT5w5XnE0piwLc0%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-8">3.1.3运算步骤拆解</h4>
<p>1）根据输入x与权重矩阵Wq，Wk，Wv计算Q、K、V矩阵。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/233aa9faff84499fb4caecaa78bfd1b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315923&amp;x-signature=oQ2FrQkYLjjixdzOT5nnOLe4ztg%3D" alt="" loading="lazy"/></p>
<p>词向量xi+位置编码ei=ai——&gt;WqWkWv*ai</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ddd931a043f34e7ab4f38d5583fbba7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315923&amp;x-signature=IEGUWBpqNMQvUa44LQC1oOEVAZY%3D" alt="" loading="lazy"/></p>
<p>2）每个q与每个k做点积运算：Q*K做 dot product并行运算</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0adbcb25a3d74b39b21ffd1a9b0d89ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315923&amp;x-signature=my01A93fFLlVgy39Dy906mDAdq4%3D" alt="" loading="lazy"/></p>
<p>3）Softmax运算-归一化：矩阵运算结果进行softmax运算，将点积运算得到的原始分数转换为有意义的概率分布，是连接神经网络计算与概率解释的桥梁（这里不做展开，后面概率论单独文章再去理解）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbec50550c514121bdda037278b539df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315923&amp;x-signature=zMcycUZAPyd2bD03QTfqbHKASMk%3D" alt="" loading="lazy"/></p>
<p>4）计算输出结果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/134dd76422d645bf954f96fb80e0e4fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315923&amp;x-signature=QsGNpgAaYD%2BDC4irVOTEWCTVSkk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/297a4dda48d149c196d9ddee9a0b538f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315923&amp;x-signature=j79eRDJrdHKwsMRmL750LYBfP6U%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c92be47f425c4bcca9e0d083892bc157~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315923&amp;x-signature=9ib5bNlY1av0UQu6k4Qb%2FXot0a0%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-9">3.1.4多头自注意力机制：Q、K、V不同维度分解</h4>
<p>多维度理解就像用多个不同角度的摄像头同时拍摄一个场景：</p>
<p>1）第一个头：专注语法关系（主谓宾结构）</p>
<p>2）第二个头：专注语义关系（词汇含义）</p>
<p>3）第三个头：专注长距离依赖（句子间逻辑）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82323d7b9f29474c8b2dfc15f516b170~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315923&amp;x-signature=0k%2Fjg1d%2BM%2FzUWsopg%2FNMxKCNrvI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">3.2点积相似度计算vs注意力关系</h3>
<p>点积在注意力中的角色：利用其衡量方向一致性的特性，来计算查询（Query） 和键（Key） 之间的相似度。方向越一致，代表Key越能回答Query的“提问”，其对应的Value就越重要。    </p>
<p>1）在概念上，我们是用 cos(θ) 来衡量向量的相似度。余弦的优势：余弦值通过除以模长，消除了向量长度的影响。cos(A, B) = 1 精确地表示它们方向完全相同。cos(A, C) = -1 表示它们方向完全相反。cos(θ) 给出了一个归一（Normalized）的结果，它的值永远在 [-1, 1] 之间，这使得不同向量之间的相似度可以公平地进行比较。     </p>
<p>2）在实际操作中（尤其是在注意力机制里），我们常用点积 (Q · K) 作为其高效且有效的近似计算方式（例如，在Transformer中，Query和Key向量通常会被归一化到相同的尺度）。</p>
<h3 data-id="heading-11">3.3点积运算如何在transformer注意力机制中发挥作用？</h3>
<p>Transformer原论文中将核心部分称为Scaled Dot-Product Attention，缩放点积注意力，最核心的公式为：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5a29a63ac5f4131b66febec7670ad66~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315923&amp;x-signature=NbYb1rpRtHvZpfj4%2FcV2yogzgyg%3D" alt="" loading="lazy"/></p>
<p>1）核心思想：对于当前要处理的元素Query（例如一个词），决定应该“关注”序列中其他元素Key的多少程度。这个“关注程度”就是一个权重，最终效果：通过点积，注意力机制能够动态地、有针对性地从输入序列中提取最相关的信息，这是Transformer和大型语言模型取得成功的关键突破之一。</p>
<p>2）Query, Key, Value 类比：</p>
<p>Query (查询向量)：代表当前元素发出的“提问”：“我正在处理，我需要哪些信息？”比喻：就像你在搜索引擎里输入的关键词。</p>
<p>Key (键向量)：代表序列中每个元素所拥有的“标签”或“标识”。它用来回应    Query的提问。比喻： 就像互联网上每个网页的关键词标签（索引）。</p>
<p>Value (值向量)：代表序列中每个元素实际包含的“信息”或“内容”。比喻： 就像网页本身的完整内容。</p>
<p>3）注意力的工作流程：将当前的 Query 与序列中所有元素的 Key 进行比较。点积就是执行这个比较操作的完美工具！相似度分数 = Query · Key加权：将这些相似度分数通过Softmax函数转换为权重（所有权重之和为1的正数概率分布）。分数越高，权重越大。求和：用这些权重对所有的 Value 进行加权求和，得到最终的注意力输出。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b6e924d393044dba14fb64a7bdec963~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315923&amp;x-signature=GHHEcv3RE%2F0hgzvYO805Bs%2BCnT8%3D" alt="" loading="lazy"/></p>
<p>4）为什么点积是计算相似度的完美工具？现在我们结合几何意义来理解：</p>
<p>➢ Query · Key 的值越大 -&gt; 根据点积公式，这意味着 cos(θ) 接近 1 -&gt; 两个向量的方向非常接近 -&gt; 这个Key所对应的元素所拥有的“标签”（Key）与当前的“提问”（Query）高度相关 -&gt; 因此，这个元素应该获得高注意力权重。</p>
<p>➢ Query · Key 的值接近 0 -&gt; cos(θ) 接近 0 -&gt; 两个向量近乎垂直 -&gt; Key 和 Query 不相关 -&gt; 权重应接近 0。</p>
<p>➢ Query · Key 的值为负 -&gt; cos(θ) 为负 -&gt; 两个向量方向相反 -&gt; 可能意味着某种排斥或对立关系 -&gt; 权重会非常小（因为Softmax会将负值压得很低）。</p>
<p>5）既然 cos(θ) 更好，为什么Transformer的论文《Attention Is All You Need》中用的是点积公式 Q · K，而不是直接写 cos(θ) 呢？理解点积受长度影响这一缺陷，是理解为何需要LayerNorm、缩放因子等技巧的关键。架构设计（如LayerNorm）和缩放操作 (/ √d_k) 确保了 (Q · K) 能够有效地充当相似度的度量指标。</p>
<p>➢ 计算效率：点积 Q · K 只需要一次矩阵乘法，计算速度极快。如果先分别计算每个Q和K的模长再做除法，计算成本更高。使用 (Q · K) 是出于计算效率和实现便利的考虑。隐含的假设：在标准的Transformer架构中，Query和Key向量通常已经进行了某种形式的归一化（例如，通过其初始化方式和层归一化LayerNorm），它们的模长被控制在一个较小的范围内波动。因此，点积 Q · K 的结果虽然不完全等价，但已经高度近似于余弦相似度 cos(θ) 所表达的方向相似性。其内在的物理意义，仍然是衡量Query和Key向量方向的相似性（即 cos(θ)）。</p>
<p>➢ 可学习的缩放因子：论文中并没有直接使用点积，而是使用了缩放点积注意力（Scaled Dot-Product Attention）：注意力分数 =(Q · K) / √d_k)这里除以 √d_k（Key向量的维度）的主要原因之一是：防止点积结果过大，导致Softmax函数的梯度消失问题（因为Softmax会将非常大的输入值推向饱和区）。这个缩放操作进一步稳定了训练。</p>
<h2 data-id="heading-12">4.点积运算vs自注意力python实现</h2>
<p>在Transformer模型中，自注意力机制(Self-Attention)的核心就是使用点积来计算查询(Query)和键(Key)之间的相似度。具体步骤如下：</p>
<p>1）准备输入：初始化参数，将输入向量转换为Query、Key和Value矩阵 </p>
<p>2）计算注意力分数：通过Query和Key的点积计算注意力分数attentionscore</p>
<p>3）缩放：将点积结果除以Key向量维度的平方根(√dₖ)</p>
<p>4）Softmax：对缩放后的分数应用Softmax函数获得注意力权重</p>
<p>5）加权求和：用注意力权重对Value进行加权求和</p>
<p>6）输出结果。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0d28fd28ac04534b88fe62d44e587e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315923&amp;x-signature=pR2hkB89ANCkNHEihzKnXUUVX0g%3D" alt="" loading="lazy"/></p>
<p>感兴趣的朋友，可以阅读并运行下面代码。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77f2aca6087c42058e489c76678381af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315923&amp;x-signature=gK9CShOs2vYFVS%2FL58gk5Wiw02o%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e96ec52e76844d5b957c63cf3c8e621a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764315923&amp;x-signature=jbE%2FrcZnAlG08hHzVprFtzRcCNI%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">from</span> math <span class="hljs-keyword">import</span> sqrt

<span class="hljs-comment">#点积计算注意力</span>
defscaled_dot_product_attention(Q, K, V, print_steps=<span class="hljs-literal">False</span>):
<span class="hljs-string">"""
    实现缩放点积注意力机制
    参数:
    Q -- 查询矩阵 (batch_size, num_heads, seq_len, d_k)
    K -- 键矩阵 (batch_size, num_heads, seq_len, d_k)
    V -- 值矩阵 (batch_size, num_heads, seq_len, d_k)
    print_steps -- 是否打印中间步骤
    返回:
    输出张量和注意力权重
    """</span>
<span class="hljs-comment"># 1. 计算注意力分数: Q·K^T</span>
<span class="hljs-comment"># 形状: (batch_size, num_heads, seq_len, seq_len)</span>
    matmul_qk = np.matmul(Q, K.transpose(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">2</span>))

<span class="hljs-keyword">if</span> print_steps:
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n步骤1: 计算Q·K^T"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Q·K^T 形状:"</span>, matmul_qk.shape)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"示例值(第一个样本,第一个头):\n"</span>, matmul_qk[<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,:,:])

<span class="hljs-comment"># 2. 缩放注意力分数 (除以sqrt(d_k))</span>
    d_k = Q.shape[-<span class="hljs-number">1</span>]
    scaled_attention_logits = matmul_qk / sqrt(d_k)

<span class="hljs-keyword">if</span> print_steps:
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n步骤2: 缩放注意力分数 (除以√d_k)"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"d_k ="</span>, d_k)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"缩放后形状:"</span>, scaled_attention_logits.shape)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"示例值(第一个样本,第一个头):\n"</span>, scaled_attention_logits[<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,:,:])

<span class="hljs-comment"># 3. 应用softmax获取注意力权重</span>
<span class="hljs-comment"># 注意: softmax应用于最后一个维度(seq_len)</span>
    attention_weights = np.exp(scaled_attention_logits - np.<span class="hljs-built_in">max</span>(scaled_attention_logits, axis=-<span class="hljs-number">1</span>, keepdims=<span class="hljs-literal">True</span>))
    attention_weights /= np.<span class="hljs-built_in">sum</span>(attention_weights, axis=-<span class="hljs-number">1</span>, keepdims=<span class="hljs-literal">True</span>)

<span class="hljs-keyword">if</span> print_steps:
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n步骤3: 应用softmax获取注意力权重"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"注意力权重形状:"</span>, attention_weights.shape)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"示例值(第一个样本,第一个头):\n"</span>, attention_weights[<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,:,:])
<span class="hljs-built_in">print</span>(<span class="hljs-string">"检查行和(应接近1):"</span>, np.<span class="hljs-built_in">sum</span>(attention_weights[<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,:]))

<span class="hljs-comment"># 4. 将注意力权重与值矩阵相乘</span>
    output = np.matmul(attention_weights, V)

<span class="hljs-keyword">if</span> print_steps:
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n步骤4: 注意力权重·V"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"输出形状:"</span>, output.shape)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"示例值(第一个样本,第一个头):\n"</span>, output[<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,:,:<span class="hljs-number">5</span>])<span class="hljs-comment"># 只显示前5个特征</span>

<span class="hljs-keyword">return</span> output, attention_weights

<span class="hljs-comment">#多头注意力机制</span>
classMultiHeadAttention:
<span class="hljs-string">"""
    Multi-Head Attention层实现 [[5]]
    这个实现将输入分割为多个注意力头，分别计算注意力，然后合并结果。
    """</span>
def__init__(self, d_model, num_heads):
<span class="hljs-string">"""
        初始化Multi-Head Attention层
        参数:
        d_model -- 模型维度(输入和输出的维度)
        num_heads -- 注意力头的数量
        """</span>
        self.d_model = d_model
        self.num_heads = num_heads

<span class="hljs-comment"># 确保d_model可以被num_heads整除</span>
<span class="hljs-keyword">assert</span> d_model % num_heads ==<span class="hljs-number">0</span>,<span class="hljs-string">"d_model must be divisible by num_heads"</span>

        self.d_k = d_model // num_heads  <span class="hljs-comment"># 每个注意力头的维度</span>

<span class="hljs-comment"># 初始化权重矩阵 (使用Xavier初始化)</span>
        self.W_q= np.random.randn(d_model, d_model)/ sqrt(d_model)
        self.W_k= np.random.randn(d_model, d_model)/ sqrt(d_model)
        self.W_v= np.random.randn(d_model, d_model)/ sqrt(d_model)
        self.W_o= np.random.randn(d_model, d_model)/ sqrt(d_model)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"MultiHeadAttention初始化完成:"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"- d_model: <span class="hljs-subst">{d_model}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"- num_heads: <span class="hljs-subst">{num_heads}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"- d_k per head: <span class="hljs-subst">{self.d_k}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"- 权重矩阵形状: W_q=<span class="hljs-subst">{self.W_q.shape}</span>, W_k=<span class="hljs-subst">{self.W_k.shape}</span>, W_v=<span class="hljs-subst">{self.W_v.shape}</span>, W_o=<span class="hljs-subst">{self.W_o.shape}</span>"</span>)

defsplit_heads(self, x, batch_size):
<span class="hljs-string">"""
        将最后一个维度分割为(num_heads, d_k)

        参数:
        x -- 输入张量 (batch_size, seq_len, d_model)
        batch_size -- 批次大小
        返回:
        重排后的张量 (batch_size, num_heads, seq_len, d_k)
        """</span>
        x = x.reshape(batch_size,-<span class="hljs-number">1</span>, self.num_heads, self.d_k)
<span class="hljs-comment"># 交换维度以获得 (batch_size, num_heads, seq_len, d_k)</span>
<span class="hljs-keyword">return</span> np.transpose(x,(<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,<span class="hljs-number">3</span>))

defcombine_heads(self, x, batch_size):
<span class="hljs-string">"""
        将多个注意力头的结果合并
        参数:
        x -- 分割后的张量 (batch_size, num_heads, seq_len, d_k)

        返回:
        合并后的张量 (batch_size, seq_len, d_model)
        """</span>
<span class="hljs-comment"># 交换维度以获得 (batch_size, seq_len, num_heads, d_k)</span>
        x = np.transpose(x,(<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,<span class="hljs-number">3</span>))
<span class="hljs-comment"># 合并最后两个维度</span>
<span class="hljs-keyword">return</span> x.reshape(batch_size,-<span class="hljs-number">1</span>, self.d_model)

defforward(self, x, print_steps=<span class="hljs-literal">False</span>):
<span class="hljs-string">"""
        前向传播
        参数:
        x -- 输入张量 (batch_size, seq_len, d_model)
        print_steps -- 是否打印中间步骤
        返回:
        输出张量和所有注意力头的注意力权重
        """</span>
        batch_size = x.shape[<span class="hljs-number">0</span>]
        seq_len = x.shape[<span class="hljs-number">1</span>]

<span class="hljs-keyword">if</span> print_steps:
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n===== Multi-Head Attention 前向传播 ====="</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"输入形状:"</span>, x.shape)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"示例输入(第一个样本):\n"</span>, x[<span class="hljs-number">0</span>,:,:<span class="hljs-number">5</span>])<span class="hljs-comment"># 只显示前5个特征</span>

<span class="hljs-comment"># 1. 线性投影得到Q, K, V</span>
        Q= np.matmul(x, self.W_q)
        K= np.matmul(x, self.W_k)
        V= np.matmul(x, self.W_v)

<span class="hljs-keyword">if</span> print_steps:
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n步骤1: 线性投影得到Q, K, V"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Q形状:"</span>, Q.shape,<span class="hljs-string">"K形状:"</span>, K.shape,<span class="hljs-string">"V形状:"</span>, V.shape)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"示例Q值(第一个样本):\n"</span>, Q[<span class="hljs-number">0</span>,:,:<span class="hljs-number">5</span>])

<span class="hljs-comment"># 2. 分割为多个注意力头</span>
        Q= self.split_heads(Q, batch_size)
        K= self.split_heads(K, batch_size)
        V= self.split_heads(V, batch_size)

<span class="hljs-keyword">if</span> print_steps:
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n步骤2: 分割为多个注意力头"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"分割后Q形状:"</span>, Q.shape,<span class="hljs-string">"K形状:"</span>, K.shape,<span class="hljs-string">"V形状:"</span>, V.shape)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"示例Q值(第一个样本,第一个头):\n"</span>, Q[<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,:,:<span class="hljs-number">5</span>])
<span class="hljs-comment"># 3. 计算缩放点积注意力</span>
        attn_output, attn_weights = scaled_dot_product_attention(
            Q, K, V, print_steps=print_steps
)

<span class="hljs-comment"># 4. 合并所有注意力头</span>
        attn_output=self.combine_heads(attn_output, batch_size)

<span class="hljs-keyword">if</span> print_steps:
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n步骤4: 合并所有注意力头"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"合并后输出形状:"</span>, attn_output.shape)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"示例输出(第一个样本):\n"</span>, attn_output[<span class="hljs-number">0</span>,:,:<span class="hljs-number">5</span>])
<span class="hljs-comment"># 5. 应用最终的线性变换</span>
        output = np.matmul(attn_output, self.W_o)
<span class="hljs-keyword">if</span> print_steps:
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n步骤5: 应用最终线性变换 (W_o)"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"最终输出形状:"</span>, output.shape)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"示例输出(第一个样本):\n"</span>, output[<span class="hljs-number">0</span>,:,:<span class="hljs-number">5</span>])

<span class="hljs-keyword">return</span> output, attn_weights

<span class="hljs-comment"># 测试实现</span>
<span class="hljs-keyword">if</span> __name__==<span class="hljs-string">"__main__"</span>:
<span class="hljs-comment"># 设置随机种子以确保结果可重现</span>
    np.random.seed(<span class="hljs-number">42</span>)
<span class="hljs-comment"># 创建示例输入 (batch_size=2, seq_len=3, d_model=8)</span>
    batch_size =<span class="hljs-number">2</span>
    seq_len =<span class="hljs-number">3</span>
    d_model =<span class="hljs-number">8</span>
    num_heads =<span class="hljs-number">2</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"===== 创建测试环境 ====="</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"批次大小: <span class="hljs-subst">{batch_size}</span>, 序列长度: <span class="hljs-subst">{seq_len}</span>, 模型维度: <span class="hljs-subst">{d_model}</span>, 注意力头数: <span class="hljs-subst">{num_heads}</span>"</span>)

<span class="hljs-comment"># 随机生成输入数据 (模拟词嵌入)</span>
    x = np.random.randn(batch_size, seq_len, d_model)

<span class="hljs-comment"># 创建Multi-Head Attention层</span>
    mha = MultiHeadAttention(d_model, num_heads)

<span class="hljs-comment"># 执行前向传播并打印所有中间步骤</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span>+<span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"开始执行前向传播，打印所有中间步骤..."</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
    output, attn_weights = mha.forward(x, print_steps=<span class="hljs-literal">True</span>)

<span class="hljs-comment"># 打印最终结果摘要</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span>+<span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Multi-Head Attention 计算完成"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"输入形状:"</span>, x.shape)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"输出形状:"</span>, output.shape)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"注意力权重形状 (用于可视化):"</span>, attn_weights.shape)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n注意力权重示例(第一个样本,第一个头):"</span>)
<span class="hljs-built_in">print</span>(attn_weights[<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,:,:])

<span class="hljs-comment"># 可视化第一个样本的第一个注意力头</span>
    plt.figure(figsize=(<span class="hljs-number">8</span>,<span class="hljs-number">6</span>))
    plt.imshow(attn_weights[<span class="hljs-number">0</span>,<span class="hljs-number">0</span>], cmap=<span class="hljs-string">'hot'</span>, interpolation=<span class="hljs-string">'nearest'</span>)
    plt.colorbar()
    plt.title(<span class="hljs-string">'Attention Weights (Sample 0, Head 0)'</span>)
    plt.xlabel(<span class="hljs-string">'Key Positions'</span>)
    plt.ylabel(<span class="hljs-string">'Query Positions'</span>)
<span class="hljs-keyword">for</span> i inrange(seq_len):
<span class="hljs-keyword">for</span> j inrange(seq_len):
            plt.text(j, i,<span class="hljs-string">f'<span class="hljs-subst">{attn_weights[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, i, j]:<span class="hljs-number">.2</span>f}</span>'</span>,
                     ha=<span class="hljs-string">'center'</span>, va=<span class="hljs-string">'center'</span>, color=<span class="hljs-string">'w'</span>)
    plt.savefig(<span class="hljs-string">'attention_weights.png'</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n已保存注意力权重可视化到 'attention_weights.png'"</span>)
</code></pre>
<h3 data-id="heading-13">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[6.Kotlin 流程控制：循环控制：while 与 do/while]]></title>    <link>https://juejin.cn/post/7574727105705705512</link>    <guid>https://juejin.cn/post/7574727105705705512</guid>    <pubDate>2025-11-21T07:41:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574727105705705512" data-draft-id="7574978847150800936" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="6.Kotlin 流程控制：循环控制：while 与 do/while"/> <meta itemprop="keywords" content="Android,Kotlin,后端"/> <meta itemprop="datePublished" content="2025-11-21T07:41:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Android_小雨"/> <meta itemprop="url" content="https://juejin.cn/user/220360279590862"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            6.Kotlin 流程控制：循环控制：while 与 do/while
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/220360279590862/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Android_小雨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T07:41:04.000Z" title="Fri Nov 21 2025 07:41:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>希望帮你在Kotlin进阶路上少走弯路，在技术上稳步提升。当然，由于个人知识储备有限，笔记中难免存在疏漏或表述不当的地方，也非常欢迎大家提出宝贵意见，一起交流进步。 —— Android_小雨</p>
</blockquote>
<p>整体目录：<a href="https://juejin.cn/spost/7573592952242602036" target="_blank" title="https://juejin.cn/spost/7573592952242602036">Kotlin 进阶不迷路：41 个核心知识点，构建完整知识体系</a></p>
<h2 data-id="heading-0">一、前言</h2>
<h3 data-id="heading-1">1.1 循环的核心作用（重复执行逻辑、处理不确定次数场景）</h3>
<p>循环作为编程三大流程控制结构（顺序、选择、循环）之一，是实现“重复执行”逻辑的核心工具。其价值主要体现在两个关键场景：一是<strong>固定逻辑的重复执行</strong>，比如批量生成100条测试数据、循环打印1到10的数字，这类场景可通过明确的次数控制循环；二是<strong>不确定次数的条件驱动执行</strong>，比如持续接收用户输入直到输入“退出”、反复重试网络请求直到成功或达到最大次数，这类场景无法提前确定循环次数，只能通过“条件是否满足”来控制循环的启停。</p>
<p>在Kotlin中，除了面向集合遍历的for循环，while和do/while循环更擅长处理“不确定次数”的场景。它们无需依赖固定的遍历对象（如区间、数组），仅通过条件表达式即可灵活控制循环，是处理动态场景的重要工具。</p>
<h3 data-id="heading-2">1.2 while/do-while 的核心特点（基础灵活、按需执行）</h3>
<p>while和do/while循环作为Kotlin中最基础的循环结构，具备两大核心特点：一是<strong>极致灵活</strong>，它们不依赖特定的数据结构，仅通过一个布尔类型的条件表达式控制循环，可适配任意需要“条件驱动”的场景，小到简单的数字累加，大到复杂的业务逻辑重试，都能轻松应对；二是<strong>按需执行</strong>，循环体的执行完全由条件表达式的结果决定，满足条件则执行，不满足则终止，尤其适合“不确定执行次数”的场景，避免了不必要的资源消耗。</p>
<p>与for循环相比，while和do/while更偏向“逻辑驱动”而非“数据遍历”。例如，要实现“持续接收用户输入直到输入正确”的逻辑，用do/while循环只需判断输入是否正确即可，无需关注遍历的集合或范围，逻辑更直接。</p>
<h3 data-id="heading-3">1.3 本文核心内容预告（基础用法→差异对比→实用场景）</h3>
<p>本文将围绕Kotlin中的while和do/while循环展开，采用“由浅入深、对比分析、场景落地”的思路逐步讲解。首先分别介绍while循环的基本语法、执行流程和简单示例，掌握“先判断后执行”的核心逻辑；接着详解do/while循环的语法、流程和示例，理解“先执行后判断”的特点；然后重点对比两者的核心差异，明确不同场景下的选择依据；之后补充break和continue两个循环控制关键字的用法，实现对循环节奏的精准控制；再通过多个实用场景案例，展示两种循环在实际开发中的应用；最后总结核心知识点、避坑技巧和选择建议，帮助读者真正做到“灵活选用、正确使用”。</p>
<h2 data-id="heading-4">二、while 循环：先判断，再执行</h2>
<h3 data-id="heading-5">2.1 基本语法格式（条件表达式 + 循环体）</h3>
<p>while循环是“先判断条件，再执行循环体”的基础循环结构，其核心是一个布尔类型的条件表达式和一段需要重复执行的循环体。语法格式简洁明了：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// while 循环基本语法</span>
<span class="hljs-keyword">while</span> (条件表达式) {
    <span class="hljs-comment">// 循环体：条件满足时执行的代码块</span>
    执行逻辑
}

</code></pre>
<p>语法说明：1. <strong>条件表达式</strong>：必须返回Boolean类型结果（true或false），这是控制循环启停的核心，比如“count &lt; 10”“input != "exit"”等；2. <strong>循环体</strong>：用花括号包裹的代码块，条件表达式为true时会执行其中的逻辑；若循环体仅包含一条语句，花括号可省略（但建议始终保留，提升可读性）；3. <strong>循环终止条件</strong>：循环体内部必须包含能改变条件表达式结果的逻辑（如变量自增、修改输入值），否则会导致无限循环。</p>
<h3 data-id="heading-6">2.2 执行流程（先校验条件，满足则执行循环体）</h3>
<p>while循环的执行流程遵循“判断→执行→再判断”的逻辑，具体步骤如下：</p>
<ol>
<li><strong>条件校验</strong>：首先执行条件表达式，判断其结果为true还是false；</li>
<li><strong>执行循环体</strong>：若条件表达式结果为true，执行循环体中的逻辑；若为false，直接终止循环，跳转到循环之后的代码；</li>
<li><strong>循环往复</strong>：循环体执行完毕后，再次回到步骤1，重新校验条件表达式，直到条件为false时终止。</li>
</ol>
<p>可以用一个简单的流程图描述这一过程：<strong>开始 → 校验条件 → 条件为true？→ 是→执行循环体→回到校验条件 → 否→终止循环</strong>。从流程可见，while循环的核心特点是“条件不满足则一次都不执行”，这是它与do/while循环的关键区别。</p>
<h3 data-id="heading-7">2.3 简单示例（如循环打印数字、累计求和）</h3>
<p>下面通过两个常见的简单示例，展示while循环的实际使用：</p>
<h4 data-id="heading-8">2.3.1 示例1：循环打印1到5的数字</h4>
<p>需求：打印1、2、3、4、5，通过变量自增控制循环次数。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> count = <span class="hljs-number">1</span> <span class="hljs-comment">// 初始化计数器变量</span>
    <span class="hljs-comment">// 条件：count小于等于5时执行循环</span>
    <span class="hljs-keyword">while</span> (count &lt;= <span class="hljs-number">5</span>) {
        println(<span class="hljs-string">"当前数字：<span class="hljs-variable">$count</span>"</span>)
        count++ <span class="hljs-comment">// 计数器自增，改变条件表达式结果</span>
    }
    println(<span class="hljs-string">"循环结束"</span>)
}

</code></pre>
<p>执行过程解析：</p>
<ul>
<li>初始count=1，校验条件1≤5→true，打印“当前数字：1”，count变为2；</li>
<li>校验count=2≤5→true，打印“当前数字：2”，count变为3；</li>
<li>依次执行，直到count=6时，校验6≤5→false，循环终止，打印“循环结束”。</li>
</ul>
<p>输出结果：</p>
<pre><code class="hljs">当前数字：1
当前数字：2
当前数字：3
当前数字：4
当前数字：5
循环结束

</code></pre>
<h4 data-id="heading-9">2.3.2 示例2：累计求和1到100</h4>
<p>需求：计算1+2+3+...+100的总和，通过while循环实现累加。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> num = <span class="hljs-number">1</span> <span class="hljs-comment">// 初始化累加变量</span>
    <span class="hljs-keyword">var</span> sum = <span class="hljs-number">0</span> <span class="hljs-comment">// 初始化总和变量</span>
    <span class="hljs-comment">// 条件：num小于等于100时执行循环</span>
    <span class="hljs-keyword">while</span> (num &lt;= <span class="hljs-number">100</span>) {
        sum += num <span class="hljs-comment">// 累加：sum = sum + num</span>
        num++ <span class="hljs-comment">// 累加变量自增</span>
    }
    println(<span class="hljs-string">"1到100的总和：<span class="hljs-variable">$sum</span>"</span>)
}

</code></pre>
<p>执行逻辑：num从1开始，每次循环将num的值累加到sum中，然后num自增，直到num=101时条件不满足，循环终止。最终sum的值为1到100的总和5050。</p>
<p>输出结果：<code>1到100的总和：5050</code></p>
<h2 data-id="heading-10">三、do/while 循环：先执行，再判断</h2>
<h3 data-id="heading-11">3.1 基本语法格式（循环体 + 条件表达式）</h3>
<p>do/while循环是“先执行循环体，再判断条件”的循环结构，其核心是确保“循环体至少执行一次”，语法格式与while循环类似，但条件表达式的位置不同：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// do/while 循环基本语法</span>
<span class="hljs-keyword">do</span> {
    <span class="hljs-comment">// 循环体：至少执行一次的代码块</span>
    执行逻辑
} <span class="hljs-keyword">while</span> (条件表达式)

</code></pre>
<p>语法说明：1. <strong>循环体优先执行</strong>：关键字do后面紧跟循环体，程序会先执行一次循环体，再去判断条件表达式；2. <strong>条件表达式</strong>：与while循环一致，必须返回Boolean类型结果，用于控制后续是否继续循环；3. <strong>循环终止条件</strong>：循环体内部同样需要包含改变条件表达式结果的逻辑，避免无限循环；4. <strong>分号注意</strong>：条件表达式末尾需要加英文分号（;），这是Kotlin语法的要求，不可遗漏。</p>
<h3 data-id="heading-12">3.2 执行流程（先执行一次循环体，再校验条件）</h3>
<p>do/while循环的执行流程遵循“执行→判断→再执行”的逻辑，具体步骤如下：</p>
<ol>
<li><strong>执行循环体</strong>：首先执行do后面花括号中的循环体逻辑，无论条件表达式结果如何，循环体都会先执行一次；</li>
<li><strong>条件校验</strong>：循环体执行完毕后，执行条件表达式，判断其结果为true还是false；</li>
<li><strong>循环往复</strong>：若条件表达式结果为true，回到步骤1，再次执行循环体；若为false，终止循环，跳转到循环之后的代码。</li>
</ol>
<p>流程描述：<strong>开始 → 执行循环体 → 校验条件 → 条件为true？→ 是→回到执行循环体 → 否→终止循环</strong>。这一流程的核心特点是“先执行后判断”，确保循环体至少执行一次，这是do/while循环与while循环的本质区别。</p>
<h3 data-id="heading-13">3.3 简单示例（如用户输入验证、至少执行一次的逻辑）</h3>
<p>do/while循环的核心优势是“至少执行一次”，因此常用于“需要先执行再判断”的场景，比如用户输入验证、初始化逻辑校验等。下面通过两个示例展示其使用：</p>
<h4 data-id="heading-14">3.3.1 示例1：用户输入验证（确保输入有效数字）</h4>
<p>需求：要求用户输入一个1到10之间的整数，若输入无效则反复提示输入，直到输入有效为止。由于需要先获取用户输入再判断是否有效，适合用do/while循环。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> java.util.Scanner

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> scanner = Scanner(System.`<span class="hljs-keyword">in</span>`)
    <span class="hljs-keyword">var</span> inputNum: <span class="hljs-built_in">Int</span>? = <span class="hljs-literal">null</span> <span class="hljs-comment">// 存储用户输入的数字</span>
    <span class="hljs-keyword">do</span> {
        println(<span class="hljs-string">"请输入1到10之间的整数："</span>)
        <span class="hljs-keyword">val</span> input = scanner.next() <span class="hljs-comment">// 先执行：获取用户输入</span>
        <span class="hljs-comment">// 尝试将输入转换为整数</span>
        inputNum = <span class="hljs-keyword">try</span> {
            input.toInt()
        } <span class="hljs-keyword">catch</span> (e: NumberFormatException) {
            <span class="hljs-literal">null</span> <span class="hljs-comment">// 转换失败则为null</span>
        }
        <span class="hljs-comment">// 判断输入是否有效，无效则提示</span>
        <span class="hljs-keyword">if</span> (inputNum == <span class="hljs-literal">null</span> || inputNum !<span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.10</span>) {
            println(<span class="hljs-string">"输入无效，请重新输入！"</span>)
        }
    } <span class="hljs-keyword">while</span> (inputNum == <span class="hljs-literal">null</span> || inputNum !<span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.10</span>) <span class="hljs-comment">// 再判断：输入无效则继续循环</span>

    println(<span class="hljs-string">"您输入的有效数字是：<span class="hljs-variable">$inputNum</span>"</span>)
    scanner.close()
}

</code></pre>
<p>执行逻辑：无论用户第一次输入是否有效，都会先执行循环体中的“提示输入→获取输入→校验”逻辑，若输入无效（非数字或超出范围），则通过条件表达式判断继续循环，直到输入有效为止。</p>
<p>输出示例（输入无效后再输入有效）：</p>
<pre><code class="hljs">请输入1到10之间的整数：
abc
输入无效，请重新输入！
请输入1到10之间的整数：
15
输入无效，请重新输入！
请输入1到10之间的整数：
5
您输入的有效数字是：5

</code></pre>
<h4 data-id="heading-15">3.3.2 示例2：至少执行一次的累加逻辑</h4>
<p>需求：让用户输入数字进行累加，输入0时停止，要求即使第一次就输入0，也要先记录输入再终止（即至少执行一次输入和判断）。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> java.util.Scanner

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> scanner = Scanner(System.`<span class="hljs-keyword">in</span>`)
    <span class="hljs-keyword">var</span> sum = <span class="hljs-number">0</span>
    <span class="hljs-keyword">var</span> input: <span class="hljs-built_in">Int</span>
    <span class="hljs-keyword">do</span> {
        println(<span class="hljs-string">"请输入一个整数（输入0停止）："</span>)
        input = scanner.nextInt() <span class="hljs-comment">// 先执行：获取输入</span>
        sum += input <span class="hljs-comment">// 累加输入的数字</span>
    } <span class="hljs-keyword">while</span> (input != <span class="hljs-number">0</span>) <span class="hljs-comment">// 再判断：输入不是0则继续循环</span>

    println(<span class="hljs-string">"所有输入数字的累加和：<span class="hljs-variable">$sum</span>"</span>)
    scanner.close()
}

</code></pre>
<p>执行逻辑：若用户第一次输入0，循环体会先执行“提示→获取输入→累加”，然后判断input=0，循环终止，累加和为0；若输入其他数字，则继续循环。这确保了“输入→累加”逻辑至少执行一次。</p>
<p>输出示例（第一次输入0）：</p>
<pre><code class="hljs">请输入一个整数（输入0停止）：
0
所有输入数字的累加和：0

</code></pre>
<h2 data-id="heading-16">四、while 与 do/while 的核心差异</h2>
<p>while和do/while循环的语法相似，都是通过条件表达式控制循环，但两者的执行流程存在本质区别，这导致它们的适用场景也不同。下面从三个维度对比核心差异：</p>
<h3 data-id="heading-17">4.1 执行顺序不同（判断时机的区别）</h3>
<p>这是两者最核心的差异，直接决定了循环体的执行时机：</p>
<ul>
<li><strong>while循环</strong>：<strong>先判断，后执行</strong>。条件表达式的校验在循环体执行之前，只有条件满足时才会执行循环体；</li>
<li><strong>do/while循环</strong>：<strong>先执行，后判断</strong>。循环体的执行在条件表达式校验之前，无论条件是否满足，循环体都会先执行一次。</li>
</ul>
<p>可以用一个简单的比喻理解：while循环像“先买票再上车”，条件不满足（没买票）就不能上车（执行循环体）；do/while循环像“先上车再补票”，无论是否有票（条件是否满足），都先上车（执行一次循环体），再判断是否补票（继续循环）。</p>
<h3 data-id="heading-18">4.2 初始条件不满足时的表现（do/while 至少执行一次）</h3>
<p>当初始条件表达式结果为false时，两者的表现截然不同，这是执行顺序差异的直接体现：</p>
<ul>
<li><strong>while循环</strong>：由于先判断条件，初始条件为false时，循环体<strong>一次都不执行</strong>；</li>
<li><strong>do/while循环</strong>：由于先执行循环体，初始条件为false时，循环体<strong>仍会执行一次</strong>。</li>
</ul>
<p>通过以下对比代码可直观看到差异：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 初始条件为false的while循环</span>
    println(<span class="hljs-string">"=== while循环（初始条件false）==="</span>)
    <span class="hljs-keyword">var</span> a = <span class="hljs-number">10</span>
    <span class="hljs-keyword">while</span> (a &lt; <span class="hljs-number">5</span>) {
        println(<span class="hljs-string">"while循环执行了"</span>)
        a--
    }
    println(<span class="hljs-string">"while循环结束"</span>)

    <span class="hljs-comment">// 初始条件为false的do/while循环</span>
    println(<span class="hljs-string">"\n=== do/while循环（初始条件false）==="</span>)
    <span class="hljs-keyword">var</span> b = <span class="hljs-number">10</span>
    <span class="hljs-keyword">do</span> {
        println(<span class="hljs-string">"do/while循环执行了"</span>)
        b--
    } <span class="hljs-keyword">while</span> (b &lt; <span class="hljs-number">5</span>)
    println(<span class="hljs-string">"do/while循环结束"</span>)
}

</code></pre>
<p>输出结果：</p>
<pre><code class="hljs language-arduino" lang="arduino">=== <span class="hljs-keyword">while</span>循环（初始条件<span class="hljs-literal">false</span>）===
<span class="hljs-keyword">while</span>循环结束

=== <span class="hljs-keyword">do</span>/<span class="hljs-keyword">while</span>循环（初始条件<span class="hljs-literal">false</span>）===
<span class="hljs-keyword">do</span>/<span class="hljs-keyword">while</span>循环执行了
<span class="hljs-keyword">do</span>/<span class="hljs-keyword">while</span>循环结束

</code></pre>
<p>结果显示：while循环因初始条件a=10&lt;5为false，循环体一次都没执行；而do/while循环虽初始条件b=10&lt;5为false，但循环体仍执行了一次。</p>
<h3 data-id="heading-19">4.3 适用场景对比（何时选 while，何时选 do/while）</h3>
<p>执行顺序和初始条件表现的差异，决定了两者的适用场景截然不同，开发中需根据“是否需要循环体至少执行一次”来选择：</p>
<h4 data-id="heading-20">4.3.1 while循环适用场景</h4>
<p>当循环体“可能一次都不执行”时，优先选择while循环，典型场景包括：</p>
<ul>
<li><strong>不确定是否需要执行的遍历场景</strong>：如遍历一个可能为空的数据流，若数据流为空则循环体不执行；</li>
<li><strong>条件驱动的动态循环场景</strong>：如“当温度低于0℃时启动加热”，若初始温度就高于0℃，则加热逻辑一次都不执行；</li>
<li><strong>固定次数但可能为0的循环场景</strong>：如“循环打印n个数字，n可能为0”，若n=0则不打印。</li>
</ul>
<p>示例：遍历一个可能为空的列表，打印其中的元素（列表为空则不执行）：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> list = listOf&lt;String&gt;() <span class="hljs-comment">// 空列表</span>
    <span class="hljs-keyword">var</span> index = <span class="hljs-number">0</span>
    <span class="hljs-comment">// 列表为空时，index &lt; list.size为false，循环体不执行</span>
    <span class="hljs-keyword">while</span> (index &lt; list.size) {
        println(list[index])
        index++
    }
    println(<span class="hljs-string">"遍历结束（列表为空，未执行循环体）"</span>)
}

</code></pre>
<h4 data-id="heading-21">4.3.2 do/while循环适用场景</h4>
<p>当循环体“必须至少执行一次”时，优先选择do/while循环，典型场景包括：</p>
<ul>
<li><strong>用户输入验证场景</strong>：如“获取用户有效输入”，必须先让用户输入一次，再判断是否有效；</li>
<li><strong>初始化后校验场景</strong>：如“初始化一个配置后，校验配置是否有效，无效则重新初始化”，初始化逻辑必须至少执行一次；</li>
<li><strong>至少执行一次的业务逻辑场景</strong>：如“重试接口请求，最多重试3次”，即使第一次请求就成功，也需要先执行一次请求逻辑。</li>
</ul>
<p>示例：重试接口请求（最多重试3次，至少请求一次）：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> maxRetry = <span class="hljs-number">3</span> <span class="hljs-comment">// 最大重试次数</span>
    <span class="hljs-keyword">var</span> retryCount = <span class="hljs-number">0</span> <span class="hljs-comment">// 已重试次数</span>
    <span class="hljs-keyword">var</span> isSuccess = <span class="hljs-literal">false</span> <span class="hljs-comment">// 请求是否成功</span>

    <span class="hljs-keyword">do</span> {
        <span class="hljs-comment">// 执行请求逻辑（至少执行一次）</span>
        isSuccess = requestApi()
        <span class="hljs-keyword">if</span> (!isSuccess) {
            retryCount++
            println(<span class="hljs-string">"请求失败，已重试<span class="hljs-variable">$retryCount</span>次"</span>)
        }
        <span class="hljs-comment">// 条件：请求失败且未达到最大重试次数则继续重试</span>
    } <span class="hljs-keyword">while</span> (!isSuccess &amp;&amp; retryCount &lt; maxRetry)

    <span class="hljs-keyword">if</span> (isSuccess) {
        println(<span class="hljs-string">"请求成功"</span>)
    } <span class="hljs-keyword">else</span> {
        println(<span class="hljs-string">"超过最大重试次数，请求失败"</span>)
    }
}

<span class="hljs-comment">// 模拟接口请求（随机返回成功或失败）</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">requestApi</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">val</span> random = (<span class="hljs-number">1.</span><span class="hljs-number">.10</span>).random()
    <span class="hljs-keyword">return</span> random &gt; <span class="hljs-number">3</span> <span class="hljs-comment">// 70%概率成功</span>
}

</code></pre>
<h2 data-id="heading-22">五、循环控制：break 与 continue</h2>
<p>在while和do/while循环中，有时需要根据特殊条件调整循环节奏，比如“找到目标值后立即终止循环”“跳过当前无效值，继续下一次循环”。Kotlin提供了break和continue两个关键字，用于实现对循环的精准控制。</p>
<h3 data-id="heading-23">5.1 break 关键字（终止整个循环）</h3>
<p>break关键字的作用是<strong>立即终止当前所在的循环</strong>，无论条件表达式是否满足，都会跳转到循环之后的代码继续执行。它适用于“找到目标后无需继续循环”的场景，比如遍历数据时找到指定元素后终止、满足某个条件时提前退出循环。</p>
<p>示例：遍历1到10的数字，找到第一个能被3整除的数字后终止循环：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> num = <span class="hljs-number">1</span>
    <span class="hljs-keyword">var</span> target = -<span class="hljs-number">1</span> <span class="hljs-comment">// 存储找到的目标数字</span>

    <span class="hljs-keyword">while</span> (num &lt;= <span class="hljs-number">10</span>) {
        <span class="hljs-keyword">if</span> (num % <span class="hljs-number">3</span> == <span class="hljs-number">0</span>) {
            target = num
            <span class="hljs-keyword">break</span> <span class="hljs-comment">// 找到目标，终止整个循环</span>
        }
        num++
    }

    println(<span class="hljs-string">"1到10中第一个能被3整除的数字是：<span class="hljs-variable">$target</span>"</span>)
}

</code></pre>
<p>执行逻辑：num从1开始递增，当num=3时，3%3==0成立，将target设为3，执行break终止循环，不再继续遍历4到10的数字。</p>
<p>输出结果：<code>1到10中第一个能被3整除的数字是：3</code></p>
<h3 data-id="heading-24">5.2 continue 关键字（跳过当前迭代，进入下一次）</h3>
<p>continue关键字的作用是<strong>跳过当前迭代的剩余循环体逻辑，直接进入下一次循环的条件校验</strong>。它不会终止整个循环，只是跳过当前次的无效逻辑，适用于“过滤无效数据，仅处理有效数据”的场景。</p>
<p>示例：遍历1到10的数字，只打印奇数，跳过偶数：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> num = <span class="hljs-number">1</span>
    <span class="hljs-keyword">while</span> (num &lt;= <span class="hljs-number">10</span>) {
        <span class="hljs-keyword">if</span> (num % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) {
            num++ <span class="hljs-comment">// 注意：continue前需更新循环变量，避免死循环</span>
            <span class="hljs-keyword">continue</span> <span class="hljs-comment">// 是偶数，跳过打印，进入下一次循环</span>
        }
        println(<span class="hljs-string">"当前奇数：<span class="hljs-variable">$num</span>"</span>)
        num++
    }
}

</code></pre>
<p>执行逻辑：num从1开始，若为偶数（num%2==0），则先让num自增，再执行continue跳过打印逻辑，直接回到条件校验；若为奇数，则打印数字后num自增。</p>
<p>输出结果：</p>
<pre><code class="hljs">当前奇数：1
当前奇数：3
当前奇数：5
当前奇数：7
当前奇数：9

</code></pre>
<p><strong>注意</strong>：使用continue时，务必在continue之前更新循环变量（如num++），否则会导致循环变量值不变，条件始终满足，陷入无限循环。</p>
<h3 data-id="heading-25">5.3 简单示例（控制循环执行节奏）</h3>
<p>下面通过一个综合示例，展示break和continue如何配合控制循环节奏：遍历1到20的数字，打印其中的“能被5整除的奇数”，遇到大于15的数字则终止循环。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> num = <span class="hljs-number">1</span>
    <span class="hljs-keyword">while</span> (num &lt;= <span class="hljs-number">20</span>) {
        <span class="hljs-comment">// 遇到大于15的数字，终止整个循环</span>
        <span class="hljs-keyword">if</span> (num &gt; <span class="hljs-number">15</span>) {
            <span class="hljs-keyword">break</span>
        }
        <span class="hljs-comment">// 跳过偶数，只处理奇数</span>
        <span class="hljs-keyword">if</span> (num % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) {
            num++
            <span class="hljs-keyword">continue</span>
        }
        <span class="hljs-comment">// 打印能被5整除的奇数</span>
        <span class="hljs-keyword">if</span> (num % <span class="hljs-number">5</span> == <span class="hljs-number">0</span>) {
            println(<span class="hljs-string">"符合条件的数字：<span class="hljs-variable">$num</span>"</span>)
        }
        num++
    }
    println(<span class="hljs-string">"循环终止"</span>)
}

</code></pre>
<p>执行逻辑：</p>
<ul>
<li>num=1到15之间，先判断是否大于15（否），再判断是否为偶数（是则跳过），最后判断是否能被5整除（是则打印）；</li>
<li>num=16时，判断大于15（是），执行break终止循环；</li>
<li>符合条件的数字为1到15之间的奇数且能被5整除，即5、15。</li>
</ul>
<p>输出结果：</p>
<pre><code class="hljs">符合条件的数字：5
符合条件的数字：15
循环终止

</code></pre>
<h2 data-id="heading-26">六、实用场景举例</h2>
<p>前面介绍了while和do/while循环的基础用法和差异，下面结合实际开发中的常见场景，展示两者的具体应用，帮助读者更好地理解“何时用哪种循环”。</p>
<h3 data-id="heading-27">6.1 while 场景（遍历未知长度数据、条件满足时循环）</h3>
<h4 data-id="heading-28">6.1.1 场景1：遍历未知长度的数据流</h4>
<p>需求：模拟读取一个未知长度的数据流（如从文件读取内容，直到读取到结束标记“EOF”），每读取一条数据就打印，数据流为空则不执行循环。由于数据流长度未知且可能为空，适合用while循环。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    println(<span class="hljs-string">"开始读取数据流..."</span>)
    <span class="hljs-comment">// 循环条件：读取到的数据不是结束标记"EOF"</span>
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = readDataFromStream() <span class="hljs-comment">// 读取一条数据</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span> == <span class="hljs-string">"EOF"</span>) {
            <span class="hljs-keyword">break</span> <span class="hljs-comment">// 读取到结束标记，终止循环</span>
        }
        println(<span class="hljs-string">"读取到数据：<span class="hljs-variable">$data</span>"</span>)
    }
    println(<span class="hljs-string">"数据流读取完毕"</span>)
}

<span class="hljs-comment">// 模拟读取数据流（依次返回数据1、数据2、EOF）</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> dataIndex = <span class="hljs-number">0</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">readDataFromStream</span><span class="hljs-params">()</span></span>: String {
    <span class="hljs-keyword">val</span> dataList = listOf(<span class="hljs-string">"数据1"</span>, <span class="hljs-string">"数据2"</span>, <span class="hljs-string">"EOF"</span>)
    <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = dataList[dataIndex]
    dataIndex++
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">data</span>
}

</code></pre>
<p>输出结果：</p>
<pre><code class="hljs language-erlang" lang="erlang">开始读取数据流...
读取到数据：数据<span class="hljs-number">1</span>
读取到数据：数据<span class="hljs-number">2</span>
数据流读取完毕

</code></pre>
<h4 data-id="heading-29">6.1.2 场景2：条件满足时循环执行重试逻辑</h4>
<p>需求：系统启动时连接数据库，若连接失败则每隔3秒重试一次，直到连接成功或达到最大重试次数（5次）。由于初始可能连接成功，无需重试，适合用while循环。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> maxRetry = <span class="hljs-number">5</span>
    <span class="hljs-keyword">var</span> retryCount = <span class="hljs-number">0</span>
    <span class="hljs-keyword">var</span> isConnected = <span class="hljs-literal">false</span>

    <span class="hljs-comment">// 条件：未连接成功且未达到最大重试次数</span>
    <span class="hljs-keyword">while</span> (!isConnected &amp;&amp; retryCount &lt; maxRetry) {
        isConnected = connectToDb()
        <span class="hljs-keyword">if</span> (isConnected) {
            println(<span class="hljs-string">"数据库连接成功！"</span>)
        } <span class="hljs-keyword">else</span> {
            retryCount++
            <span class="hljs-keyword">if</span> (retryCount &lt; maxRetry) {
                println(<span class="hljs-string">"数据库连接失败，<span class="hljs-variable">$retryCount</span> 次重试，3秒后重试..."</span>)
                Thread.sleep(<span class="hljs-number">3000</span>) <span class="hljs-comment">// 等待3秒</span>
            }
        }
    }

    <span class="hljs-keyword">if</span> (!isConnected) {
        println(<span class="hljs-string">"达到最大重试次数（<span class="hljs-variable">$maxRetry</span> 次），数据库连接失败！"</span>)
    }
}

<span class="hljs-comment">// 模拟数据库连接（第3次重试时成功）</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> connectCount = <span class="hljs-number">0</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">connectToDb</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    connectCount++
    <span class="hljs-keyword">return</span> connectCount == <span class="hljs-number">3</span>
}

</code></pre>
<p>输出结果：</p>
<pre><code class="hljs language-erlang" lang="erlang">数据库连接失败，<span class="hljs-number">1</span> 次重试，<span class="hljs-number">3</span>秒后重试...
数据库连接失败，<span class="hljs-number">2</span> 次重试，<span class="hljs-number">3</span>秒后重试...
数据库连接成功！

</code></pre>
<h3 data-id="heading-30">6.2 do/while 场景（表单验证、初始化后需校验的逻辑）</h3>
<h4 data-id="heading-31">6.2.1 场景1：表单输入验证（至少输入一次）</h4>
<p>需求：用户注册时输入密码，要求密码长度至少8位且包含数字和字母，若密码不满足要求则反复提示输入，直到输入符合要求的密码。由于必须让用户至少输入一次密码，适合用do/while循环。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> java.util.Scanner

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> scanner = Scanner(System.`<span class="hljs-keyword">in</span>`)
    <span class="hljs-keyword">var</span> password: String
    <span class="hljs-comment">// 密码校验规则：长度≥8，包含数字和字母</span>
    <span class="hljs-keyword">val</span> passwordRegex = <span class="hljs-string">"^(?=.*[0-9])(?=.*[a-zA-Z]).{8,}$"</span>.toRegex()

    <span class="hljs-keyword">do</span> {
        println(<span class="hljs-string">"请输入注册密码（长度≥8，包含数字和字母）："</span>)
        password = scanner.next()
        <span class="hljs-keyword">if</span> (!password.matches(passwordRegex)) {
            println(<span class="hljs-string">"密码不符合要求，请重新输入！"</span>)
        }
    } <span class="hljs-keyword">while</span> (!password.matches(passwordRegex)) <span class="hljs-comment">// 密码不符合要求则继续循环</span>

    println(<span class="hljs-string">"密码设置成功！"</span>)
    scanner.close()
}

</code></pre>
<p>输出示例：</p>
<pre><code class="hljs">请输入注册密码（长度≥8，包含数字和字母）：
123456
密码不符合要求，请重新输入！
请输入注册密码（长度≥8，包含数字和字母）：
abcdefgh
密码不符合要求，请重新输入！
请输入注册密码（长度≥8，包含数字和字母）：
abc12345
密码设置成功！

</code></pre>
<h4 data-id="heading-32">6.2.2 场景2：初始化后校验配置（至少初始化一次）</h4>
<p>需求：系统初始化配置（从配置文件读取），初始化后校验配置是否有效，若无效则重新初始化（最多重新初始化3次）。由于必须先初始化一次才能校验，适合用do/while循环。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> maxInitCount = <span class="hljs-number">3</span>
    <span class="hljs-keyword">var</span> initCount = <span class="hljs-number">0</span>
    <span class="hljs-keyword">var</span> config: Config? = <span class="hljs-literal">null</span>

    <span class="hljs-keyword">do</span> {
        config = initConfig() <span class="hljs-comment">// 初始化配置（至少执行一次）</span>
        initCount++
        <span class="hljs-keyword">if</span> (config == <span class="hljs-literal">null</span> || !config.isValid()) {
            <span class="hljs-keyword">if</span> (initCount &lt; maxInitCount) {
                println(<span class="hljs-string">"配置初始化无效，<span class="hljs-variable">$initCount</span> 次初始化，准备重新初始化..."</span>)
            }
        }
    } <span class="hljs-keyword">while</span> ((config == <span class="hljs-literal">null</span> || !config.isValid()) &amp;&amp; initCount &lt; maxInitCount)

    <span class="hljs-keyword">if</span> (config != <span class="hljs-literal">null</span> &amp;&amp; config.isValid()) {
        println(<span class="hljs-string">"配置初始化成功，配置信息：<span class="hljs-variable">$config</span>"</span>)
    } <span class="hljs-keyword">else</span> {
        println(<span class="hljs-string">"达到最大初始化次数（<span class="hljs-variable">$maxInitCount</span> 次），配置初始化失败！"</span>)
    }
}

<span class="hljs-comment">// 配置数据类</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span>(<span class="hljs-keyword">val</span> serverUrl: String, <span class="hljs-keyword">val</span> port: <span class="hljs-built_in">Int</span>) {
    <span class="hljs-comment">// 校验配置是否有效</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isValid</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">return</span> serverUrl.startsWith(<span class="hljs-string">"http"</span>) &amp;&amp; port <span class="hljs-keyword">in</span> <span class="hljs-number">1024.</span><span class="hljs-number">.65535</span>
    }
}

<span class="hljs-comment">// 模拟配置初始化（第2次初始化时成功）</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> initConfigCount = <span class="hljs-number">0</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">initConfig</span><span class="hljs-params">()</span></span>: Config? {
    initConfigCount++
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (initConfigCount == <span class="hljs-number">2</span>) {
        Config(<span class="hljs-string">"http://localhost"</span>, <span class="hljs-number">8080</span>)
    } <span class="hljs-keyword">else</span> {
        Config(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">80</span>) <span class="hljs-comment">// 无效配置（URL无http，端口80小于1024）</span>
    }
}

</code></pre>
<p>输出结果：</p>
<pre><code class="hljs language-ini" lang="ini">配置初始化无效，1 次初始化，准备重新初始化...
配置初始化成功，配置信息：Config(<span class="hljs-attr">serverUrl</span>=http://localhost, port=<span class="hljs-number">8080</span>)

</code></pre>
<h2 data-id="heading-33">七、总结与使用建议</h2>
<h3 data-id="heading-34">7.1 核心知识点回顾（语法、流程、差异）</h3>
<ul>
<li><strong>while循环核心</strong>：语法为“while(条件){循环体}”，执行流程是“先判断后执行”，初始条件不满足时循环体一次都不执行，适合“可能不执行”的场景。</li>
<li><strong>do/while循环核心</strong>：语法为“do{循环体}while(条件);”，执行流程是“先执行后判断”，无论初始条件是否满足，循环体至少执行一次，适合“必须执行一次”的场景。</li>
<li><strong>循环控制核心</strong>：break用于终止整个循环，continue用于跳过当前迭代；使用continue时需提前更新循环变量，避免无限循环。</li>
<li><strong>核心差异</strong>：执行顺序不同（判断时机），导致初始条件不满足时的表现不同（是否执行一次），进而决定适用场景不同。</li>
</ul>
<h3 data-id="heading-35">7.2 避坑点（避免死循环、条件表达式设计）</h3>
<ul>
<li><strong>避免无限循环</strong>：这是while和do/while循环最常见的坑。核心解决方法是“确保循环体内部能改变条件表达式的结果”，比如变量自增、修改输入值、执行break等；尤其要注意使用continue时，需在continue前更新循环变量。</li>
<li><strong>条件表达式必须返回Boolean类型</strong>：避免将其他类型的值直接作为条件（如Java中允许的整数0为false、非0为true），Kotlin严格要求条件表达式为Boolean类型，否则编译报错。</li>
<li><strong>do/while循环末尾不要遗漏分号</strong>：Kotlin语法要求do/while循环的条件表达式末尾必须加英文分号，遗漏会导致编译错误。</li>
<li><strong>循环变量初始化要正确</strong>：确保循环变量的初始值符合业务逻辑，比如遍历1到10时，初始值设为1而非0，避免出现逻辑错误。</li>
</ul>
<h3 data-id="heading-36">7.3 选择技巧（根据是否需要 “至少执行一次” 判断）</h3>
<p>开发中选择while还是do/while循环，核心判断标准只有一个：<strong>循环体是否需要至少执行一次</strong>。可按照以下步骤快速判断：</p>
<ol>
<li><strong>明确业务需求</strong>：思考“循环体是否存在‘一次都不执行’的合理场景”；</li>
<li><strong>若存在“一次都不执行”的场景</strong>：选择while循环，如遍历可能为空的集合、条件初始就不满足的循环；</li>
<li><strong>若“必须至少执行一次”</strong>：选择do/while循环，如用户输入验证、初始化后校验的逻辑；</li>
<li><strong>复杂场景结合循环控制</strong>：当需要提前终止循环或跳过无效迭代时，配合break和continue使用，精准控制循环节奏。</li>
</ol>
<p>此外，还需注意：while和do/while循环更适合“不确定次数”的条件驱动场景，若循环次数固定或需要遍历集合/区间，优先选择for循环，让代码更简洁直观。</p>
<p>掌握while和do/while循环的核心差异和适用场景，结合break、continue进行精准控制，能让你在处理“条件驱动”的循环场景时游刃有余，写出更高效、更易读的Kotlin代码。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Playwright最常用的功能语句汇总]]></title>    <link>https://juejin.cn/post/7574745301725315078</link>    <guid>https://juejin.cn/post/7574745301725315078</guid>    <pubDate>2025-11-21T07:23:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574745301725315078" data-draft-id="7574958975159074859" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Playwright最常用的功能语句汇总"/> <meta itemprop="keywords" content="自动化运维"/> <meta itemprop="datePublished" content="2025-11-21T07:23:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="温蒂来啦"/> <meta itemprop="url" content="https://juejin.cn/user/1408927966434123"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Playwright最常用的功能语句汇总
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1408927966434123/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    温蒂来啦
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T07:23:07.000Z" title="Fri Nov 21 2025 07:23:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>以下是 <strong>Playwright（Python）最常用的功能语句汇总</strong>，覆盖日常自动化测试与爬虫开发中的核心操作。</p>
<hr/>
<h2 data-id="heading-0">🧰 一、启动与页面控制</h2>
<pre><code class="hljs language-csharp" lang="csharp">python
编辑
<span class="hljs-keyword">from</span> playwright.<span class="hljs-function">sync_api import sync_playwright

<span class="hljs-keyword">with</span> <span class="hljs-title">sync_playwright</span>() <span class="hljs-keyword">as</span> p:
    # 启动浏览器（headless</span>=False 可见模式）
    browser = p.chromium.launch(headless=False)
    page = browser.new_page()

    <span class="hljs-meta"># 打开网页</span>
    page.<span class="hljs-keyword">goto</span>(<span class="hljs-string">"https://example.com"</span>)

    <span class="hljs-meta"># 设置视口大小</span>
    page.set_viewport_size({<span class="hljs-string">"width"</span>: <span class="hljs-number">1920</span>, <span class="hljs-string">"height"</span>: <span class="hljs-number">1080</span>})

    <span class="hljs-meta"># 等待页面加载完成</span>
    page.wait_for_load_state(<span class="hljs-string">"networkidle"</span>)  <span class="hljs-meta"># 或 "load", "domcontentloaded"</span>

    browser.close()
</code></pre>
<hr/>
<h2 data-id="heading-1">🔍 二、元素定位（Locator）</h2>
<p>Playwright 推荐使用 <code>page.locator()</code>（比 <code>page.click(selector)</code> 更强大）</p>
<pre><code class="hljs language-makefile" lang="makefile">python
编辑
<span class="hljs-comment"># 常用选择器</span>
page.locator(<span class="hljs-string">"#id"</span>)                <span class="hljs-comment"># ID</span>
page.locator(<span class="hljs-string">".class"</span>)             <span class="hljs-comment"># 类名</span>
page.locator(<span class="hljs-string">"text=按钮文本"</span>)       <span class="hljs-comment"># 文本匹配（智能）</span>
page.locator(<span class="hljs-string">"input[name='email']"</span>)<span class="hljs-comment"># 属性</span>
<span class="hljs-section">page.locator("button:has-text('提交')") # 包含指定文本的按钮</span>
page.locator(<span class="hljs-string">"div &gt;&gt; text=内容"</span>)    <span class="hljs-comment"># 组合选择器（CSS + 文本）</span>

<span class="hljs-comment"># 获取多个元素</span>
items = page.locator(<span class="hljs-string">".item"</span>)
count = items.count()
first_item = items.first
last_item = items.last
third_item = items.nth(2)  <span class="hljs-comment"># 从0开始</span>
</code></pre>
<hr/>
<h2 data-id="heading-2">✏️ 三、交互操作</h2>
<pre><code class="hljs language-bash" lang="bash">python
编辑
<span class="hljs-comment"># 点击</span>
page.locator(<span class="hljs-string">"button"</span>).click()
page.click(<span class="hljs-string">"text=登录"</span>)  <span class="hljs-comment"># 简写（不推荐复杂场景）</span>

<span class="hljs-comment"># 输入文本</span>
page.locator(<span class="hljs-string">"#username"</span>).fill(<span class="hljs-string">"admin"</span>)      <span class="hljs-comment"># 清空后输入（推荐）</span>
page.locator(<span class="hljs-string">"#comment"</span>).<span class="hljs-built_in">type</span>(<span class="hljs-string">"Hello"</span>)       <span class="hljs-comment"># 模拟逐字输入（慢）</span>

<span class="hljs-comment"># 清空输入框</span>
page.locator(<span class="hljs-string">"#search"</span>).clear()

<span class="hljs-comment"># 悬停</span>
page.locator(<span class="hljs-string">".menu-item"</span>).hover()

<span class="hljs-comment"># 双击 / 右键</span>
page.locator(<span class="hljs-string">"#target"</span>).dblclick()
page.locator(<span class="hljs-string">"#target"</span>).click(button=<span class="hljs-string">"right"</span>)

<span class="hljs-comment"># 按键（在输入框中按回车）</span>
page.press(<span class="hljs-string">"#search"</span>, <span class="hljs-string">"Enter"</span>)
page.keyboard.press(<span class="hljs-string">"Tab"</span>)
</code></pre>
<hr/>
<h2 data-id="heading-3">📥 四、表单与下拉框</h2>
<h3 data-id="heading-4">标准 <code>&lt;select&gt;</code> 下拉框：</h3>
<pre><code class="hljs language-ini" lang="ini">python
编辑
<span class="hljs-comment"># 选择第一个选项</span>
page.locator("select<span class="hljs-comment">#country").select_option(index=0)</span>

<span class="hljs-comment"># 按 value 选</span>
page.locator("select").select_option(<span class="hljs-attr">value</span>=<span class="hljs-string">"CN"</span>)

<span class="hljs-comment"># 按可见文本选</span>
page.locator("select").select_option(<span class="hljs-attr">label</span>=<span class="hljs-string">"中国"</span>)
</code></pre>
<h3 data-id="heading-5">自定义下拉（div 模拟）：</h3>
<pre><code class="hljs language-makefile" lang="makefile">python
编辑
dropdown = page.locator(<span class="hljs-string">"#city-selector"</span>)
dropdown.locator(<span class="hljs-string">".trigger"</span>).click()
dropdown.locator(<span class="hljs-string">"text=上海"</span>).click()  <span class="hljs-comment"># 在容器内找</span>
</code></pre>
<h3 data-id="heading-6">文件上传：</h3>
<pre><code class="hljs language-css" lang="css">python
编辑
page<span class="hljs-selector-class">.set_input_files</span>("<span class="hljs-selector-tag">input</span><span class="hljs-selector-attr">[type=<span class="hljs-string">'file'</span>]</span>", "path/<span class="hljs-selector-tag">to</span>/file<span class="hljs-selector-class">.pdf</span>")
</code></pre>
<h3 data-id="heading-7">复选框 / 单选框：</h3>
<pre><code class="hljs language-bash" lang="bash">python
编辑
page.check(<span class="hljs-string">"#agree"</span>)      <span class="hljs-comment"># 勾选</span>
page.uncheck(<span class="hljs-string">"#news"</span>)     <span class="hljs-comment"># 取消勾选</span>
page.is_checked(<span class="hljs-string">"#agree"</span>) <span class="hljs-comment"># 判断是否选中</span>
</code></pre>
<hr/>
<h2 data-id="heading-8">⏳ 五、等待（Wait）</h2>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 等待元素出现（推荐）</span>
page.wait_for_selector(<span class="hljs-string">"text=成功"</span>, timeout=<span class="hljs-number">5000</span>)

<span class="hljs-comment"># 等待元素可点击</span>
page.wait_for_selector(<span class="hljs-string">"button#submit"</span>, <span class="hljs-keyword">state</span>=<span class="hljs-string">"visible"</span>)
page.locator(<span class="hljs-string">"button#submit"</span>).wait_for(<span class="hljs-keyword">state</span>=<span class="hljs-string">"enabled"</span>)

<span class="hljs-comment"># 等待网络请求完成</span>
page.wait_for_load_state(<span class="hljs-string">"networkidle"</span>)

<span class="hljs-comment"># 等待特定 URL</span>
page.wait_for_url(<span class="hljs-string">"**/dashboard"</span>)

<span class="hljs-comment"># 等待弹窗（alert/confirm）</span>
page.on(<span class="hljs-string">"dialog"</span>, lambda dialog: dialog.accept())
</code></pre>
<hr/>
<h2 data-id="heading-9">📡 六、网络与请求拦截</h2>
<pre><code class="hljs language-vbscript" lang="vbscript"># 拦截 API 请求并修改响应（Mock）
def handle_route(route):
    <span class="hljs-keyword">if</span> <span class="hljs-string">"api/user"</span> <span class="hljs-keyword">in</span> route.<span class="hljs-built_in">request</span>.url:
        route.fulfill(json={<span class="hljs-string">"name"</span>: <span class="hljs-string">"Mock User"</span>})
    <span class="hljs-keyword">else</span>:
        route.continue_()

page.route(<span class="hljs-string">"**/api/**"</span>, handle_route)

# 监听请求/响应
page.<span class="hljs-keyword">on</span>(<span class="hljs-string">"request"</span>, lambda <span class="hljs-built_in">request</span>: pr<span class="hljs-built_in">int</span>(<span class="hljs-string">"&gt;&gt;"</span>, <span class="hljs-built_in">request</span>.method, <span class="hljs-built_in">request</span>.url))
page.<span class="hljs-keyword">on</span>(<span class="hljs-string">"response"</span>, lambda <span class="hljs-built_in">response</span>: pr<span class="hljs-built_in">int</span>(<span class="hljs-string">"&lt;&lt;"</span>, <span class="hljs-built_in">response</span>.status, <span class="hljs-built_in">response</span>.url))
</code></pre>
<hr/>
<h2 data-id="heading-10">📸 七、截图与录屏</h2>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 截图整个页面</span>
page.screenshot(<span class="hljs-attr">path</span>=<span class="hljs-string">"full.png"</span>, full_page=<span class="hljs-literal">True</span>)

<span class="hljs-comment"># 截图某个元素</span>
page.locator("<span class="hljs-comment">#chart").screenshot(path="chart.png")</span>

<span class="hljs-comment"># 录屏（需启动时开启）</span>
<span class="hljs-attr">browser</span> = p.chromium.launch(record_video_dir=<span class="hljs-string">"videos/"</span>)
<span class="hljs-attr">page</span> = browser.new_page()
<span class="hljs-comment"># ...操作...</span>
page.video.path()  <span class="hljs-comment"># 获取视频路径</span>
</code></pre>
<hr/>
<h2 data-id="heading-11">🌐 八、多页面与弹窗处理</h2>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 等待新页面打开</span>
with page.expect_popup() as popup_info:
    page.click("a<span class="hljs-section">[target='_blank']</span>")
<span class="hljs-attr">new_page</span> = popup_info.value

<span class="hljs-comment"># 切换到 iframe</span>
<span class="hljs-attr">frame</span> = page.frame_locator(<span class="hljs-string">"iframe[name='myframe']"</span>)
frame.locator("<span class="hljs-comment">#inside-input").fill("hello")</span>

<span class="hljs-comment"># 关闭当前页</span>
page.close()
</code></pre>
<hr/>
<h2 data-id="heading-12">🍪 九、Cookie 与 Storage</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 设置 Cookie</span>
page.context.add_cookies([{<span class="hljs-string">"name"</span>: <span class="hljs-string">"token"</span>, <span class="hljs-string">"value"</span>: <span class="hljs-string">"abc123"</span>, <span class="hljs-string">"url"</span>: <span class="hljs-string">"https://example.com"</span>}])

<span class="hljs-comment"># 获取 Cookie</span>
cookies = page.context.cookies()

<span class="hljs-comment"># 本地存储</span>
page.evaluate(<span class="hljs-string">"localStorage.setItem('theme', 'dark')"</span>)
theme = page.evaluate(<span class="hljs-string">"localStorage.getItem('theme')"</span>)
</code></pre>
<hr/>
<h2 data-id="heading-13">🧪 十、断言（配合 pytest）</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 元素存在</span>
<span class="hljs-keyword">assert</span> page.locator(<span class="hljs-string">"text=欢迎"</span>).is_visible()

<span class="hljs-comment"># 文本内容</span>
<span class="hljs-keyword">assert</span> page.locator(<span class="hljs-string">"#title"</span>).inner_text() == <span class="hljs-string">"首页"</span>

<span class="hljs-comment"># URL 包含</span>
<span class="hljs-keyword">assert</span> <span class="hljs-string">"success"</span> <span class="hljs-keyword">in</span> page.url

<span class="hljs-comment"># 元素数量</span>
<span class="hljs-keyword">assert</span> page.locator(<span class="hljs-string">".item"</span>).count() == <span class="hljs-number">5</span>
</code></pre>
<hr/>
<h2 data-id="heading-14">💡 小技巧</h2>
<ul>
<li>
<p><strong>自动等待</strong>：Playwright 的 <code>click()</code>、<code>fill()</code> 等操作会自动等待元素可操作，通常无需手动加 <code>wait</code>。</p>
</li>
<li>
<p><strong>选择器调试</strong>：在浏览器 DevTools Console 中用 <code>$$(selector)</code> 测试 CSS 选择器。</p>
</li>
<li>
<p><strong>录制脚本</strong>：用官方工具生成代码（bash）：</p>
<pre><code class="hljs language-arduino" lang="arduino">playwright codegen https:<span class="hljs-comment">//example.com</span>
</code></pre>
</li>
</ul>
<hr/>
<h2 data-id="heading-15">✅ 最佳实践建议</h2>
<ol>
<li><strong>优先使用 <code>locator</code> 而非全局选择器</strong>；</li>
<li><strong>避免 <code>time.sleep()</code>，用 Playwright 内置等待</strong>；</li>
<li><strong>对自定义组件封装成函数</strong>（如 <code>select_dropdown(page, label, option)</code>）；</li>
<li><strong>用 <code>has_text=</code>、<code>has=</code> 提高定位精准度</strong>。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[tail 、journalctl 、 docker logs -f命令详解]]></title>    <link>https://juejin.cn/post/7574821757665902633</link>    <guid>https://juejin.cn/post/7574821757665902633</guid>    <pubDate>2025-11-21T07:51:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574821757665902633" data-draft-id="7574892669374382134" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="tail 、journalctl 、 docker logs -f命令详解"/> <meta itemprop="keywords" content="Linux"/> <meta itemprop="datePublished" content="2025-11-21T07:51:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            tail 、journalctl 、 docker logs -f命令详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T07:51:25.000Z" title="Fri Nov 21 2025 07:51:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Linux服务器上有效监控应用程序日志是每个开发者和系统管理员的必备技能。下面我将详细解析 <code>tail</code>、<code>journalctl</code>和 <code>docker logs -f</code>这三个强大的日志查看工具，并通过一个项目实战场景展示如何综合运用它们。 为了让你快速建立整体印象，下表概括了这三个命令的核心特点和典型应用场景。</p>





























<table><thead><tr><th>命令/工具</th><th>核心功能</th><th>主要应用场景</th><th>关键特性</th></tr></thead><tbody><tr><td><code>tail</code>​</td><td>查看文件末尾内容，实时追踪文件变化</td><td>查看静态日志文件的最后部分，实时追踪应用程序日志文件</td><td>轻量、直接，适用于任何文本文件</td></tr><tr><td><code>journalctl</code>​</td><td>查询由 <code>systemd</code>管理的系统和服务的日志</td><td>查看系统服务日志，按服务、时间、优先级等维度过滤日志</td><td>结构化日志，强大的过滤和查询能力</td></tr><tr><td><code>docker logs -f</code></td><td>查看并实时跟踪Docker容器的标准输出日志</td><td>实时查看特定Docker容器的日志输出</td><td>容器原生命令，简单易用</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-0">🔧 各工具详解与核心技巧</h3>
<h4 data-id="heading-1">1. <code>tail</code>：文件追踪利器</h4>
<p><code>tail</code>命令的核心在于实时追踪文件末尾的更新，非常适合查看正在写入的日志文件。</p>
<ul>
<li>
<p><strong>实时追踪 (<code>-f</code>与 <code>-F</code>)</strong></p>
<ul>
<li><code>tail -f /path/to/logfile.log</code>：这是最常用的实时追踪命令。但当日志文件被<strong>轮转</strong>（如 <code>logrotate</code>工具将当前日志备份并创建一个新文件）时，<code>-f</code>可能会失效，因为它跟踪的是文件名对应的文件描述符。</li>
<li><code>tail -F /path/to/logfile.log</code>：这是 <code>-f</code>的增强版。它跟踪的是<strong>文件名</strong>而非文件描述符。当发生日志轮转（文件被删除或移动）时，<code>-F</code>能够检测到并自动重新打开新文件，确保追踪不中断。<strong>在生产环境下监控日志时，强烈推荐使用 <code>-F</code></strong>。</li>
</ul>
</li>
<li>
<p><strong>从特定行开始追踪</strong> 如果你想在开始实时追踪前，先查看最近一段时间的历史记录，可以结合 <code>-n</code>参数。例如，<code>tail -n 100 -f app.log</code>会先显示最后100行，然后进入实时追踪模式。</p>
</li>
<li>
<p><strong>结合 <code>grep</code>过滤</strong> 在复杂的日志中，你可能只关心特定信息（如 "ERROR"）。可以使用管道符 <code>|</code>将 <code>tail</code>的输出过滤：<code>tail -F app.log | grep --line-buffered "ERROR"</code>。这里的 <code>--line-buffered</code>参数确保 <code>grep</code>逐行处理，让结果实时显示。</p>
</li>
</ul>
<h4 data-id="heading-2">2. <code>journalctl</code>：系统服务的日志专家</h4>
<p>如果你的应用是作为 <code>systemd</code>服务（如 <code>nginx.service</code>）运行的，那么 <code>journalctl</code>是查看其日志的首选工具。</p>
<ul>
<li>
<p><strong>基本服务日志查询</strong></p>
<ul>
<li><code>journalctl -u your-app.service</code>：查看名为 <code>your-app</code>的服务的所有日志。</li>
<li><code>journalctl -u your-app.service -f</code>：实时跟踪该服务的最新日志。</li>
</ul>
</li>
<li>
<p><strong>强大的过滤功能</strong> <code>journalctl</code>的强大之处在于其多维度的过滤能力。</p>
<ul>
<li><strong>按时间过滤</strong>：<code>journalctl -u your-app.service --since "10 minutes ago" --until "2 minutes ago"</code>查看指定时间范围内的日志。</li>
<li><strong>按日志级别过滤</strong>：<code>journalctl -u your-app.service -p err</code>只显示错误级别及以上的日志（如 <code>err</code>, <code>crit</code>, <code>alert</code>）。</li>
<li><strong>组合查询</strong>：<code>journalctl -u your-app.service -p err --since today</code>查看今天的所有错误日志。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-3">3. <code>docker logs -f</code>：容器日志的窗口</h4>
<p>对于Docker容器，查看日志最直接的方式就是使用 <code>docker logs</code>命令。</p>
<ul>
<li><strong>基本用法</strong>：<code>docker logs -f &lt;container_name_or_id&gt;</code>可以实时跟踪指定容器的标准输出（stdout）和标准错误（stderr）。</li>
<li><strong>查看历史记录</strong>：<code>docker logs --tail=50 &lt;container_name&gt;</code>显示容器最近的50行日志，而不进入实时追踪模式。</li>
<li><strong>包含时间戳</strong>：<code>docker logs -t -f &lt;container_name&gt;</code>可以在每条日志前显示时间戳，便于定位问题发生的时间。</li>
<li><strong>退出追踪</strong>：要退出 <code>docker logs -f</code>的实时跟踪模式，只需按下 <code>Ctrl + C</code>。</li>
</ul>
<hr/>
<h3 data-id="heading-4">💻 项目实战：故障排查流程</h3>
<p>假设你有一个Web应用栈，包含：</p>
<ul>
<li><strong>前端</strong>：一个名为 <code>web-app</code>的Docker容器。</li>
<li><strong>后端API</strong>：一个名为 <code>api-service</code>的 <code>systemd</code>服务。</li>
<li><strong>静态日志文件</strong>：Nginx访问日志 <code>/var/log/nginx/access.log</code>。</li>
</ul>
<p>用户报告网站访问缓慢，以下是你的排查步骤：</p>
<ol>
<li>
<p><strong>快速检查容器状态</strong> 首先，查看所有容器状态，确认 <code>web-app</code>是否在运行：<code>docker ps</code>。</p>
</li>
<li>
<p><strong>实时追踪容器日志</strong> 接着，实时查看前端容器的日志，寻找错误或超时信息：<code>docker logs -f web-app</code>。如果日志滚动非常快，可以配合 <code>grep</code>过滤，例如只查看包含 "timeout" 或 "error" 的行。</p>
</li>
<li>
<p><strong>深入排查系统服务日志</strong> 如果前端容器没有明显错误，问题可能出在后端API。使用 <code>journalctl</code>深入检查：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看 api-service 最近5分钟的日志，按错误级别过滤</span>
journalctl -u api-service.service --since <span class="hljs-string">"5 minutes ago"</span> -p err
</code></pre>
<p>如果发现连接数据库失败的记录，可以继续追踪该服务的实时日志：<code>journalctl -u api-service.service -f</code>。</p>
</li>
<li>
<p><strong>分析Web服务器访问日志</strong> 同时，在另一个终端窗口，使用 <code>tail</code>监控Nginx的访问日志，分析请求量和响应状态：<code>tail -F /var/log/nginx/access.log | grep --line-buffered "POST /api/"</code>。这可以帮助你确认是否是某个特定的API接口导致了问题。</p>
</li>
</ol>
<p>通过这种<strong>从容器到服务，从实时追踪到历史查询</strong>的立体化排查方式，你就能快速定位并解决问题。</p>
<hr/>
<h3 data-id="heading-5">⚠️ 注意事项与最佳实践</h3>
<ul>
<li><strong>日志轮转（Log Rotation）</strong> ：对于由 <code>logrotate</code>管理的日志文件，使用 <code>tail -F</code>而非 <code>-f</code>，以确保在日志文件轮转后仍能持续跟踪。</li>
<li><strong>磁盘空间管理</strong>：定期清理旧日志。对于Docker，可以配置日志驱动（如 <code>json-file</code>）的 <code>max-size</code>和 <code>max-file</code>选项来控制日志文件大小和数量。对于 <code>journalctl</code>，可以使用 <code>journalctl --vacuum-size=500M</code>来限制日志系统占用的总磁盘空间。</li>
<li><strong>工具选择</strong>：根据你的应用程序的输出方式选择最合适的工具。通常，Docker容器用 <code>docker logs</code>，<code>systemd</code>服务用 <code>journalctl</code>，而直接写入文件的应用程序日志则用 <code>tail</code>。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Y-Agent Studio ：打破 DAG 的“无环”铁律？揭秘有向有环图如何让智能体真正“活”起来]]></title>    <link>https://juejin.cn/post/7574958975159418923</link>    <guid>https://juejin.cn/post/7574958975159418923</guid>    <pubDate>2025-11-21T07:56:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574958975159418923" data-draft-id="7574745301724774406" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Y-Agent Studio ：打破 DAG 的“无环”铁律？揭秘有向有环图如何让智能体真正“活”起来"/> <meta itemprop="keywords" content="Agent,人工智能,低代码"/> <meta itemprop="datePublished" content="2025-11-21T07:56:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AAA爱学习的刘哥"/> <meta itemprop="url" content="https://juejin.cn/user/3947717127833450"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Y-Agent Studio ：打破 DAG 的“无环”铁律？揭秘有向有环图如何让智能体真正“活”起来
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3947717127833450/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AAA爱学习的刘哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T07:56:55.000Z" title="Fri Nov 21 2025 07:56:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><blockquote>
<p><strong>一句话总结：传统工作流引擎被“无环”限制得太久，Y-Agent Studio 引入有向有环图（DAG+Loop），终于让 AI Agent 能像人一样“循环思考、反复验证、动态决策”。</strong></p>
</blockquote>
<p>大家好，我是刘哥，一个常年在智能体（Agent）和工作流引擎里打转的 IT 博主。最近我深度体验了 <a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">Y-Agent Studio</a>，一个基于 FastAPI + RAG + Agent 架构的新一代智能代理平台。而最让我眼前一亮的，不是它的 LLM 集成能力，也不是插件系统——而是它<strong>大胆抛弃了传统 DAG 的“无环”限制</strong>，引入了<strong>有向有环图（Directed Cyclic Graph）</strong> 的执行模型。</p>
<p>今天，我们就来聊聊：<strong>为什么“有环”反而成了优势？它解决了哪些真实痛点？又是如何实现的？</strong></p>
<hr/>
<h2 data-id="heading-0">01｜Y-Agent Studio 的第一个杀手锏：支持“有向有环图”的工作流</h2>
<p>在大多数低代码/AI 工作流平台中，任务编排都依赖 <strong>DAG（有向无环图）</strong> ：节点按依赖顺序执行，一旦执行完毕就不可回头。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b24fbd5061254d2faac2569d52201a31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUFB54ix5a2m5Lmg55qE5YiY5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316615&amp;x-signature=uOHO06qsQchExdifLqJomDr7Rb0%3D" alt="image.png" loading="lazy"/></p>
<p>但 Y-Agent Studio 不一样。它的核心执行引擎明确支持<strong>节点之间的循环引用</strong>——比如 A → B → C → B，形成闭环。这意味着：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/902375caf4fd444cb5c9370203e9432e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUFB54ix5a2m5Lmg55qE5YiY5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316615&amp;x-signature=ONh6s2aQxIyw8HTx2XmdWIFtaHs%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>Agent 可以在满足条件时<strong>反复调用某个工具</strong>；</li>
<li>可以实现<strong>带反馈的迭代优化</strong>（比如“生成代码 → 测试 → 失败 → 重写”）；</li>
<li>支持<strong>人类式的试错与反思流程</strong>，而不是一条道走到黑。</li>
</ul>
<p>这听起来简单，但在工程上却是一个巨大的跃迁。</p>
<hr/>
<h2 data-id="heading-1">02｜传统 DAG 的三大“隐痛”：为什么我们受够了“无环”？</h2>
<p>别误会，DAG 在任务调度领域功不可没。但当我们把 AI Agent 当作“数字员工”使用时，DAG 的局限性就暴露无遗：</p>
<h3 data-id="heading-2">痛点 1：无法处理“循环逻辑”</h3>
<p>你想让 Agent 写一段 Python 代码，并自动运行测试。如果测试失败，让它修改后再试——<strong>这本质上是一个 while 循环</strong>。但 DAG 不允许 C 节点再指向 B 节点，你只能手动复制多个“重试节点”，既丑陋又不可扩展。</p>
<h3 data-id="heading-3">痛点 2：缺乏状态反馈机制</h3>
<p>DAG 是“开环”的：节点执行完就结束，无法根据下游结果动态决定是否重新执行上游。而真实世界的问题往往是<strong>闭环反馈</strong>的（比如用户说“不对，再想想”）。</p>
<h3 data-id="heading-4">痛点 3：强行拆解复杂逻辑</h3>
<p>为了绕过“无环”限制，开发者不得不把一个自然循环拆成 N 个线性步骤，导致工作流臃肿、难以维护，甚至丧失语义完整性。</p>
<blockquote>
<p>💡 说白了：<strong>DAG 适合“流水线”，但不适合“思考过程”。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-5">03｜有向有环图：不是 bug，是 feature！</h2>
<p>Y-Agent Studio 的设计者显然意识到：<strong>真正的智能体需要“回溯”和“迭代”的能力</strong>。于是他们引入了<strong>可控的有向有环图模型</strong>。</p>
<p>但这不意味着“无限死循环”！关键在于 <strong>“受控循环”</strong> ：</p>
<ul>
<li>通过 <code>loop_start_node</code> 和 <code>loop_node</code> 明确标识循环边界；</li>
<li>设置最大循环次数（<code>run_times</code> / <code>virtual_run_times</code>）防止失控；</li>
<li>利用 <code>loop_context</code> 传递每次迭代的状态（比如错误日志、用户反馈）；</li>
<li>下游节点可通过条件判断决定是否“跳回”循环起点。</li>
</ul>
<p>这样一来，循环不再是危险的黑洞，而是一个<strong>结构化、可观察、可中断的智能决策单元</strong>。</p>
<blockquote>
<p>✅ <strong>有环 ≠ 混乱，而是赋予 Agent “反思能力”的基础设施。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-6">04｜技术实现：Y-Agent Studio 是怎么做到的？</h2>
<p>从代码结构看（参考其开源目录），Y-Agent Studio 通过以下机制支撑有向有环图：</p>
<pre><code class="hljs language-bash" lang="bash">src/
├── nodes/
│   ├── base_node.py        <span class="hljs-comment"># 基类定义 run_times, virtual_run_times</span>
│   ├── loop_start_node.py  <span class="hljs-comment"># 循环入口节点</span>
│   ├── loop_node.py        <span class="hljs-comment"># 循环控制节点</span>
│   └── ...
└── working/
    └── workflow_engine.py  <span class="hljs-comment"># 执行引擎支持环检测 + 循环计数</span>
</code></pre>
<p>核心设计亮点：</p>
<ul>
<li><strong>虚拟执行计数（virtual_run_times）</strong> ：用于依赖解析阶段预判执行路径，避免因多前驱节点导致重复触发（见下图）。</li>
<li><strong>父循环上下文（parent_loop_node_id + loop_context）</strong> ：确保嵌套循环也能正确隔离状态。</li>
<li><strong>执行引擎内置环检测 + 安全熔断</strong>：即使用户配置了环，也会在超限时自动终止，保障系统稳定性。</li>
</ul>
<blockquote>
<p>📌 举个例子：A → C，B → C。若 A 和 B 同时完成，传统系统可能触发 C 两次。Y-Agent 通过 <code>virtual_run_times</code> 计算“逻辑触发次数”，确保 C 只执行一次——<strong>这是支持有环的前提保障</strong>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-7">05｜实际价值：你的 Agent 终于能“像人一样工作”了</h2>
<p>有了有向有环图，Y-Agent Studio 能轻松实现以下场景：</p>






























<table><thead><tr><th>场景</th><th>传统 DAG 实现方式</th><th>Y-Agent Studio 方式</th></tr></thead><tbody><tr><td>自动修复代码</td><td>手动添加 3 个“重试节点”</td><td>一个循环节点 + 条件判断</td></tr><tr><td>多轮用户交互</td><td>用外部状态机模拟</td><td>内置 loop + context 传递</td></tr><tr><td>动态知识检索</td><td>一次性检索</td><td>“检索 → 评估相关性 → 不足则再检索”</td></tr><tr><td>智能测试生成</td><td>固定流程</td><td>“生成测试 → 运行 → 覆盖率不足 → 补充”</td></tr></tbody></table>
<p><strong>这不仅是技术升级，更是范式转变</strong>：从“执行指令”到“自主推理”。</p>
<hr/>
<h2 data-id="heading-8">结语：打破“无环”迷信，拥抱更真实的智能</h2>
<p>DAG 曾是工作流的黄金标准，但在 AI Agent 时代，它正在成为一种<strong>不必要的枷锁</strong>。Y-Agent Studio 敢于引入有向有环图，并通过严谨的工程设计规避风险，这背后是对“智能体应具备类人思维”的深刻理解。</p>
<p>如果你也在构建复杂的 Agent 应用，不妨试试 Y-Agent Studio——或许你会发现，<strong>真正的智能，从来都不是一条直线</strong>。</p>
<blockquote>
<p>🔗 项目地址：[(<a href="https://link.juejin.cn?target=https%3A%2F%2Fy-agent.cn%2Fdocs" target="_blank" title="https://y-agent.cn/docs" ref="nofollow noopener noreferrer">y-agent.cn/docs</a>)]<br/>
👋 欢迎在评论区讨论：你觉得 Agent 还需要哪些“非 DAG”能力？</p>
</blockquote>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS APP 抓包全流程解析，HTTPS 调试、网络协议分析与多工具组合方案]]></title>    <link>https://juejin.cn/post/7574848503730765870</link>    <guid>https://juejin.cn/post/7574848503730765870</guid>    <pubDate>2025-11-21T08:00:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574848503730765870" data-draft-id="7574817463448387635" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS APP 抓包全流程解析，HTTPS 调试、网络协议分析与多工具组合方案"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-21T08:00:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iOS开发上架哦"/> <meta itemprop="url" content="https://juejin.cn/user/3336394949004844"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS APP 抓包全流程解析，HTTPS 调试、网络协议分析与多工具组合方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3336394949004844/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iOS开发上架哦
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T08:00:25.000Z" title="Fri Nov 21 2025 08:00:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在移动应用开发中，<strong>iOS APP 抓包</strong>是最常见、也最容易遇到困难的调试环节。无论是接口联调、线上问题排查、性能分析，还是验证 SDK 行为，抓包一直是最直接、最高效的分析方式。但当涉及到 iOS 的安全体系（ATS、证书链、pinning）与多协议混合环境（HTTPS + QUIC + TCP/UDP）时，抓包的难度会成倍提升。</p>
<hr/>
<h2 data-id="heading-0">一、为什么 iOS APP 抓包比想象中更复杂？</h2>
<p>工程师在抓取 iOS 流量时，最常踩到的坑来自以下五类：</p>
<h3 data-id="heading-1"><strong>HTTPS 证书链限制严格</strong></h3>
<ul>
<li>根证书不信任</li>
<li>中间证书缺失</li>
<li>Wi-Fi 网关替换证书</li>
</ul>
<p>表现：代理工具只能看到 CONNECT。</p>
<hr/>
<h3 data-id="heading-2"><strong>APP 自带证书 Pinning</strong></h3>
<p>这是“抓不到包”的头号难题。</p>
<p>表现特征：</p>
<ul>
<li>Safari 能抓</li>
<li>APP 完全抓不到</li>
<li>抓包工具界面没有任何请求</li>
</ul>
<p>pinning 会直接拒绝代理证书。</p>
<hr/>
<h3 data-id="heading-3"><strong>HTTP/3 / QUIC 绕过系统代理</strong></h3>
<p>QUIC 使用 UDP，所以代理工具无能为力。</p>
<p>表现：</p>
<ul>
<li>部分域名抓不到</li>
<li>切换网络后突然恢复</li>
</ul>
<hr/>
<h3 data-id="heading-4"><strong>APP 使用自定义协议或独立网络栈</strong></h3>
<p>例如：</p>
<ul>
<li>TCP 自定义协议</li>
<li>SDK 内部封装的二进制协议</li>
<li>WebSocket 长连接</li>
</ul>
<p>这些都不会走代理抓包。</p>
<hr/>
<h3 data-id="heading-5"><strong>流量噪音过大，难以聚焦单个 APP</strong></h3>
<p>尤其在调试手机 APP 时，系统和后台进程会产生大量无关流量。</p>
<hr/>
<h2 data-id="heading-6">二、iOS APP 抓包工具矩阵（按用途分层，非优劣比较）</h2>
<p>为了覆盖所有抓包场景，我们必须用“分层工具链”策略。</p>
<hr/>
<h3 data-id="heading-7"><strong>代理抓包（最常见的软件层方式）</strong></h3>
<p>工具包括：</p>
<ul>
<li>Charles</li>
<li>Proxyman</li>
<li>Fiddler</li>
<li>mitmproxy（开源）</li>
</ul>
<p>适合：</p>
<ul>
<li>查看 HTTPS 明文</li>
<li>调试接口</li>
<li>修改请求 / 响应</li>
<li>模拟错误场景</li>
</ul>
<p>局限：</p>
<ul>
<li>pinning 会阻断</li>
<li>QUIC 无法抓</li>
<li>自定义协议不支持</li>
</ul>
<hr/>
<h3 data-id="heading-8"><strong>底层抓包（TCP/TLS 分析）</strong></h3>
<p>代表：</p>
<ul>
<li>tcpdump</li>
<li>Wireshark</li>
</ul>
<p>适合：</p>
<ul>
<li>分析 TLS 握手失败</li>
<li>三次握手、重传、RTT</li>
<li>判断流量是否到达服务器</li>
</ul>
<p>这是定位“为什么抓不到”的关键步骤。</p>
<hr/>
<h3 data-id="heading-9"><strong>脚本式抓包与协议自动化分析</strong></h3>
<p>例如：</p>
<ul>
<li>pyshark</li>
<li>scapy</li>
<li>mitmproxy 脚本</li>
</ul>
<p>适合批量分析或 CI 使用。</p>
<hr/>
<h3 data-id="heading-10"><strong>代理失效的补抓工具：抓包大师（Sniffmaster）</strong></h3>
<p>这类工具补充代理无法处理的部分，其技术能力覆盖代理抓不到的情境，包括：</p>
<ul>
<li>抓取 <strong>HTTPS / HTTP / TCP / UDP</strong> 流量</li>
<li>按 <strong>App / 域名过滤</strong>，降低噪音</li>
<li>自动识别 HTTP、HTTPS、mdns、自定义协议</li>
<li>查看数据流（十六进制 / 文本 / 二进制）</li>
<li>导出 <strong>Wireshark 兼容 pcap</strong></li>
<li>可使用 JavaScript 进行拦截、修改请求与响应</li>
<li>跨系统支持（macOS / Windows / iOS）</li>
</ul>
<p>适合用于：</p>
<ul>
<li>pinning 阻断</li>
<li>QUIC / HTTP3</li>
<li>自定义协议</li>
<li>不走系统代理的请求</li>
<li>TCP 数据流分析</li>
</ul>
<p>其定位不是取代理而代之，而是补充代理失败时不可或缺的抓包能力。</p>
<hr/>
<h2 data-id="heading-11">三、iOS APP 抓包的标准化流程（团队可复用）</h2>
<hr/>
<h3 data-id="heading-12"><strong>① 优先尝试代理工具抓包</strong></h3>
<p>配置：</p>
<ul>
<li>Wi-Fi 代理</li>
<li>安装并信任证书</li>
<li>开启 SSL Proxy</li>
</ul>
<p>若能抓 → 使用代理继续调试即可。</p>
<hr/>
<h3 data-id="heading-13"><strong>② 若只能看到 CONNECT → 证书链问题</strong></h3>
<p>排查：</p>
<ul>
<li>Wi-Fi 是否替换证书</li>
<li>中间证书是否缺失</li>
<li>APP 是否做了证书校验</li>
</ul>
<hr/>
<h3 data-id="heading-14"><strong>③ 若 Safari 能抓而 APP 完全抓不到 → pinning</strong></h3>
<p>此时无需尝试更多代理工具，进入补抓流程。</p>
<hr/>
<h3 data-id="heading-15"><strong>④ 若部分流量抓不到 → QUIC（HTTP/3）导致</strong></h3>
<p>判断方法：</p>
<ul>
<li>强制关闭 HTTP/3</li>
<li>或更换 4G/5G 网络</li>
</ul>
<p>若恢复 → 即为 QUIC 场景。</p>
<hr/>
<h3 data-id="heading-16"><strong>⑤ 使用 Sniffmaster 抓底层流量</strong></h3>
<p>流程示例：</p>
<ol>
<li>选择目标 APP 或域名</li>
<li>记录 HTTPS / TCP 数据流</li>
<li>导出 pcap 文件</li>
<li>使用 Wireshark 分析：
<ul>
<li>TLS 握手</li>
<li>证书链</li>
<li>QUIC 或 UDP 流</li>
<li>重传和丢包情况</li>
</ul>
</li>
<li>与服务器 tcpdump 对照确认请求是否到达</li>
</ol>
<p>这是目前定位 HTTPS 抓包失败最稳妥的方法。</p>
<hr/>
<h3 data-id="heading-17"><strong>⑥ 若能解密数据，再用代理工具分析业务逻辑</strong></h3>
<p>查看：</p>
<ul>
<li>header</li>
<li>token</li>
<li>body</li>
<li>状态码</li>
<li>错误响应</li>
</ul>
<p>完成最终业务验证。</p>
<hr/>
<h2 data-id="heading-18">四、工程实战案例：iOS APP 接口时好时坏</h2>
<p>某团队遇到问题：</p>
<ul>
<li>部分接口抓不到包</li>
<li>APP 偶尔提示网络异常</li>
<li>Charles 抓不到 HTTPS</li>
</ul>
<p>排查流程：</p>
<ol>
<li>切换 Wi-Fi 仍失败 → 排除网络代理</li>
<li>Safari 能抓 → 排除系统证书问题</li>
<li>使用 Sniffmaster 抓包 → 显示 TLS Alert</li>
<li>Wireshark 分析后确认：
<ul>
<li>中间证书签发链不完整</li>
</ul>
</li>
<li>修复服务器证书后问题解决</li>
</ol>
<p>这种问题完全依赖代理无法定位。</p>
<hr/>
<h2 data-id="heading-19">iOS APP 抓包可以多工具分层 + 多场景覆盖</h2>
<p>抓包困难的根源来自：</p>
<ul>
<li>TLS 安全策略</li>
<li>pinning</li>
<li>QUIC</li>
<li>自定义协议</li>
<li>多进程噪音</li>
</ul>
<p>因此完整方案必须包括：</p>

























<table><thead><tr><th>工具类别</th><th>对应场景</th></tr></thead><tbody><tr><td>代理抓包</td><td>HTTPS 调试、查看请求内容</td></tr><tr><td>TCP/TLS 抓包</td><td>握手失败、链路诊断</td></tr><tr><td>自动分析脚本</td><td>批量抓包、CI 调试</td></tr><tr><td>Sniffmaster</td><td>pinning/QUIC/自定义协议等代理失败场景</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[相得益彰：Mem0 记忆框架与亚马逊云科技的企业级 AI 实践]]></title>    <link>https://juejin.cn/post/7574869203448676352</link>    <guid>https://juejin.cn/post/7574869203448676352</guid>    <pubDate>2025-11-21T07:59:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574869203448676352" data-draft-id="7574869203448610816" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="相得益彰：Mem0 记忆框架与亚马逊云科技的企业级 AI 实践"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-21T07:59:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="亚马逊云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2850395271209496"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            相得益彰：Mem0 记忆框架与亚马逊云科技的企业级 AI 实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2850395271209496/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    亚马逊云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T07:59:03.000Z" title="Fri Nov 21 2025 07:59:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读41分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d5cd28ac30241149883ff8aacb2ec73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316743&amp;x-signature=m%2Bgi6uKvje%2FKrqKTeqniu3Vyqs8%3D" alt="0.png" loading="lazy"/></p>
<p>想象一下这样的场景：</p>
<p>个人助手场景：当你的 AI 助手能够记住你三个月前提到”不喜欢吃辣”这个细节，在今天推荐餐厅时自动筛选掉川菜和湘菜；或者它记得你上周提到的重要会议，主动在会前提醒 你准备相关材料。</p>
<p>企业服务场景：客户致电咨询时，AI 客服立即调取该客户的完整交互历史——从半年前 的产品咨询，到上个月的技术支持，再到最近的投诉处理，为客户提供连贯一致的个性化 服务体验，而不是每次都要重新解释问题背景。</p>
<p>这就是记忆增强型 AI 的魅力所在——它让 AI 从”健忘的工具”升级为”贴心的伙伴”。</p>
<p>本文将深入探讨如何通过 Mem0 智能记忆框架与亚马逊云科技服务生态的深度集成，构建 真正的生产级记忆增强型 AI 系统。我们不仅会分析记忆机制的技术原理，更会展示如何 利用 Aurora Serverless、Bedrock、Neptune 等云原生服务，实现从概念验证到企业级部 署的完整解决方案。</p>
<p>记忆对于 <strong>Agentic AI</strong> 应用的重要性</p>
<blockquote>
<p>📢限时插播：无需管理基础设施，利用亚马逊技术与生态，快速集成与部署生成式AI模型能力。</p>
<p>✨ 精心设计，旨在引导您深入探索Amazon Bedrock的模型选择与调用、模型自动化评估以及安全围栏(Guardrail)等重要功能。</p>
<p>⏩快快点击进入《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.amazoncloud.cn%2Fexperience%2Fcloudlab%3Fid%3D6695e4c5e1432f239fae485f%26visitfrom%3D3P_Juejinhead_0606%26sc_medium%3Downed%26sc_campaign%3Dcloudlab%26sc_channel%3D3P_Juejinhead_0606" target="_blank" title="https://dev.amazoncloud.cn/experience/cloudlab?id=6695e4c5e1432f239fae485f&amp;visitfrom=3P_Juejinhead_0606&amp;sc_medium=owned&amp;sc_campaign=cloudlab&amp;sc_channel=3P_Juejinhead_0606" ref="nofollow noopener noreferrer">多模一站通 —— Amazon Bedrock 上的基础模型初体验</a>》实验构建无限, 探索启程！</p>
</blockquote>
<h4 data-id="heading-0">记忆缺失：当前 AI 系统的根本局限</h4>
<p>传统的大语言模型受限于固定的上下文窗口，就像患有”失忆症”的助手，无法在跨会话的长期对话中保持一致性和连贯性。每次对话都是全新的开始，用户不得不反复解释自己的偏好和背景。</p>
<p>这种记忆缺失会引发典型问题：遗忘用户偏好、重复询问已知信息、甚至推翻之前确认的事实。例如，在饮食推荐场景中，用户明确表示不喜欢某类食物，但系统在后续交互中仍会推荐相同类型的食物，这一常见情况从根本上损害了用户体验并破坏了用户信任。</p>
<p>为了解决记忆问题，业界尝试通过扩大上下文窗口来缓解，但这种方法存在根本性局限：1）持续的人机交互必然导致对话历史超出任何固定窗口限制。2）人类能够动态整合新信息并修正过时认知，而LLM只能通过完全重置来更新知识。3）真实对话缺乏主题连贯性——用户可能从讨论食物偏好跳转到工作任务，再回到晚餐选择，迫使系统在大量无关信息中寻找相关线索。4）更关键的是，仅仅提供更长上下文无法保证有效信息检索，因为注意力机制对远距离token的处理能力会显著退化，导致真正有价值的信息被噪声淹没。</p>
<h4 data-id="heading-1">人类记忆的启示</h4>
<p>人类记忆是智能的根基，它不仅定义了我们的身份，更是明智决策、持续学习和建立深度关系的基础。人类能够回忆过往互动，推断他人偏好，并构建与交往对象不断演化的心理模型。理想的AI记忆框架应当模拟这种动态、适应性的记忆机制，实现从简单存储到智能管理的根本转变。</p>
<p>记忆增强型Agent的突破</p>
<p>真正的解决方案在于构建具备记忆能力的智能体。这类Agent能够突破传统LLM的局限，在交互环境中实现质的飞跃。</p>
<p>核心能力提升体现在四个方面：</p>
<ul>
<li>个性化预测能力。通过记住用户历史行为和偏好，Agent能够更准确地预测客户需求，提供真正个性化的服务体验。</li>
<li>经验学习能力。系统能够从过往错误中学习，建立经验库以避免重复失误，并将在特定任务中获得的知识有效泛化到其他相关场景。</li>
<li>因果推理能力。记忆功能使Agent能够理解行动与结果之间的因果关系，基于深层逻辑进行决策优化，在动态变化的环境中实现更有效的适应。</li>
<li>长期规划能力。跨会话的记忆连续性确保了多轮对话中的推理一致性，使Agent从简单的被动响应升级为具备长期规划能力的智能系统。</li>
</ul>
<p>在医疗诊断、个性化教育、企业客户支持等对历史信息依赖性强的关键领域，这种记忆增强能力的价值更加凸显。</p>
<h3 data-id="heading-2">Mem0框架：构建生产级记忆增强型AI Agent</h3>
<h4 data-id="heading-3">Mem0框架概述</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmem0.ai%2F" target="_blank" title="https://mem0.ai/" ref="nofollow noopener noreferrer">Mem0</a> 是一个专为现代 AI Agent 设计的智能记忆层，它使AI Agent能够记住过去的交互、存储重要的用户偏好和事实背景，并从成功和失败中学习。通过与Mem0集成，Agent从无状态转变为有状态，能够保持上下文、回忆重要信息，并随着时间推移表现得更加智能。</p>
<p>与传统的简单数据存储不同，Mem0专注于智能记忆管理，支持多种记忆类型：工作记忆（临时对话上下文）、事实记忆（客观信息）、情景记忆（具体事件）和语义记忆（概念知识），并提供智能的LLM提取、过滤和衰减机制，有效降低计算成本。系统不仅支持多模态（文本和图像），还提供Graph记忆功能来连接跨会话的见解和实体。作为一个既可以使用托管服务也可以自建的解决方案，Mem0让AI Agent能够建立持久的记忆，从而提供更个性化和适应性更强的服务。</p>
<h4 data-id="heading-4">技术架构设计</h4>
<p>Mem0采用分层设计理念，通过六个核心模块的协同工作，实现智能记忆管理的完整闭环。<br/>
分层架构的设计优势在于各层职责清晰、可独立优化。核心记忆层作为控制中枢，统筹记忆的CRUD操作；大语言模型层提供智能决策能力，负责信息提取和更新策略生成；嵌入模型层将自然语言转换为机器可理解的向量表示；向量存储层基于语义相似性实现高效检索；图存储层构建实体关系网络，支持复杂推理；持久化存储层确保元数据和操作历史的可靠保存。<br/>
这种架构设计既保证了系统的模块化和可扩展性，又通过层间的紧密协作实现了智能记忆管理的核心目标。</p>
<h4 data-id="heading-5">核心技术创新</h4>
<p>Mem0的技术创新体现在四个关键方面，这些创新共同构成了其智能记忆管理的核心竞争力。<br/>
双LLM架构是其最重要的创新之一。系统通过两次不同的LLM调用实现复杂的分工：第一次专注于信息提取，第二次专门处理决策过程。这种关注点分离不仅提高了准确性和可靠性，还允许对各阶段进行专门优化，避免了单一模型处理复杂任务时的性能瓶颈。<br/>
上下文感知处理确保了记忆系统的一致性。Mem0不是孤立处理信息，而是在现有记忆的上下文中分析新数据，防止碎片化并维护相关信息间的逻辑关系。<br/>
智能去重机制通过向量相似性搜索与基于LLM判断的结合，创建了强大的去重能力，既防止了冗余信息存储，又保持了记忆质量和系统效率。<br/>
冲突解决能力使系统能够智能处理矛盾信息，在用户偏好和环境随时间演变时维护记忆准确性，这是传统存储系统难以实现的高级功能。</p>
<h3 data-id="heading-6">记忆操作机制</h3>
<p>Mem0的核心价值在于智能化的记忆管理。系统封装了记忆添加、检索、更新和删除四大核心操作，其中添加和检索是关键环节。</p>
<h4 data-id="heading-7">智能记忆添加流程</h4>
<p>Mem0对于记忆的添加流程如下图所示。（图片来源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.mem0.ai%2Fcore-concepts%2Fmemory-operations%2Fadd" target="_blank" title="https://docs.mem0.ai/core-concepts/memory-operations/add" ref="nofollow noopener noreferrer">Mem0官方文档</a>）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b3527dc824445fd8c0818d2fabbef9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316743&amp;x-signature=xoMhTcgBsaehBBxAkpgRshmInrU%3D" alt="1.png" loading="lazy"/></p>
<p>Mem0的记忆添加过程体现了从自然语言到结构化知识的智能转换，分为三个关键阶段：</p>
<ul>
<li>信息提取阶段：系统通过LLM和专门提示词进行深度语义分析，从”我和John在星巴克讨论AI项目”中提取工作关系、场所偏好、兴趣领域等多维信息。</li>
<li>上下文检索阶段：融合向量相似性搜索、图谱关系检索和上下文关联分析，在严格用户隔离的前提下，确保新信息与历史记忆的有机关联。</li>
<li>智能决策阶段：通过第二次LLM调用，智能决定ADD、UPDATE、DELETE或NONE操作，维护记忆库的质量和一致性。</li>
</ul>
<h4 data-id="heading-8">高效记忆检索流程</h4>
<p>Mem0对于记忆的检索流程如下图所示。（图片来源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.mem0.ai%2Fcore-concepts%2Fmemory-operations%2Fsearch" target="_blank" title="https://docs.mem0.ai/core-concepts/memory-operations/search" ref="nofollow noopener noreferrer">Mem0官方文档</a>）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab576d235f8542529fe0e94726a5b75a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316743&amp;x-signature=RuBriWFpHoBbr%2BCXRw%2BDOp7mFs0%3D" alt="2.png" loading="lazy"/></p>
<p>检索流程采用查询预处理、并行化搜索、结果整合三阶段设计，通过向量语义搜索和图谱关系搜索的并行执行，实现高效准确的记忆检索。</p>
<p>通过这种精心设计的双流程架构，Mem0为构建生产级记忆增强型AI Agent提供了坚实的技术基础。</p>
<h3 data-id="heading-9">Mem0与Agent框架的集成</h3>
<p>在实际应用中，开发者可以通过两种方式将Mem0集成到Agent系统中：一是在环境变量配置依赖信息后，直接调用Mem0的接口函数（如添加、查找、更新记忆等）；二是将Mem0封装成工具传入Agent框架，由Agent根据处理逻辑自主调用相应方法。</p>
<h4 data-id="heading-10">集成方式选择</h4>
<p>直接接口调用方式：开发者可以在配置好环境变量和依赖信息后，直接使用Mem0提供的接口函数。这种方式给予开发者完全的控制权，可以精确地决定何时添加记忆、何时检索记忆、如何更新记忆内容。适合对记忆管理有特定需求或需要与现有系统深度集成的场景。</p>
<p>工具封装方式：将Mem0封装成工具传入Agent框架，让Agent根据自身的处理逻辑自主决定何时调用相应的记忆方法。这种方式更加智能化，Agent可以根据对话上下文和用户需求自动判断是否需要存储新记忆或检索历史记忆，减少了人工干预的需要。</p>
<h4 data-id="heading-11">框架选择策略</h4>
<p>使用支持Mem0的Agent框架：对于希望快速构建记忆增强型Agent的开发者，可以选择支持Mem0的现有Agent框架。这些框架通常内置了专门的记忆管理工具集，封装了完整的Mem0能力，具有开箱即用、集成最佳实践、适合快速原型开发等优势。</p>
<p>自定义Agent框架集成：对于需要更高灵活性和定制化的场景，开发者可以在自己的Agent框架中直接集成Mem0。通过配置化的方式，可以直接指定相应的LLM、Embedding模型以及向量数据库等组件，创建定制化的Mem0实例。</p>
<h4 data-id="heading-12">基础集成示例</h4>
<p>以下是直接接口调用的基本示例：</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-keyword">from</span> mem0 <span class="hljs-keyword">import</span> Memory

config = {
   <span class="hljs-string">"llm"</span>: {
       <span class="hljs-string">"provider"</span>: <span class="hljs-string">"aws_bedrock"</span>,
       <span class="hljs-string">"config"</span>: {
           <span class="hljs-string">"model"</span>: <span class="hljs-string">"us.anthropic.claude-3-7-sonnet-20250219-v1:0"</span>,
           <span class="hljs-string">"temperature"</span>: <span class="hljs-number">0.2</span>,
           <span class="hljs-string">"max_tokens"</span>: <span class="hljs-number">2000</span>,
       }
   },
   <span class="hljs-string">"embedder"</span>: {
       <span class="hljs-string">"provider"</span>: <span class="hljs-string">"aws_bedrock"</span>,
       <span class="hljs-string">"config"</span>: {
           <span class="hljs-string">"model"</span>: <span class="hljs-string">"amazon.titan-embed-text-v2:0"</span>
       }
   },
   <span class="hljs-string">"vector_store"</span>: {
       <span class="hljs-string">"provider"</span>: <span class="hljs-string">"pgvector"</span>,
       <span class="hljs-string">"config"</span>: {
           <span class="hljs-string">"user"</span>: <span class="hljs-string">"$DB_USER"</span>,
           <span class="hljs-string">"password"</span>: <span class="hljs-string">"$DB_PASSWORD"</span>,
           <span class="hljs-string">"host"</span>: <span class="hljs-string">"$DB_HOST"</span>,
           <span class="hljs-string">"port"</span>: <span class="hljs-string">"$DB_PORT"</span>,
           <span class="hljs-string">"embedding_model_dims"</span>: <span class="hljs-string">"1024"</span>,
           <span class="hljs-string">"collection_name"</span>: <span class="hljs-string">"mem0_memories"</span>,
       }
   },
   <span class="hljs-string">"graph_store"</span>: {
       <span class="hljs-string">"provider"</span>: <span class="hljs-string">"neptune"</span>,
       <span class="hljs-string">"config"</span>: {
           <span class="hljs-string">"endpoint"</span>: <span class="hljs-string">"neptune-graph://gXXXXXX"</span>
       }
   }
}

<span class="hljs-comment"># 创建 Memory 实例并使用</span>
memory = Memory.from_config(config)
memory.add(<span class="hljs-string">"I love sci-fi movies"</span>, user_id=<span class="hljs-string">"user123"</span>)
relevant_memories = memory.search(<span class="hljs-string">"movie preferences"</span>, user_id=<span class="hljs-string">"user123"</span>)
</code></pre>
<p>通过灵活的集成策略，开发者可以根据具体需求选择最适合的实现方式。然而，要实现企业级的生产部署，仅仅有Mem0框架是不够的，还需要充分利用云服务提供商的基础设施优势。</p>
<p>接下来，我们将深入探讨如何将Mem0与亚马逊云科技的服务生态进行深度集成，利用Aurora Serverless、Bedrock、Neptune等云原生服务，构建真正的生产级记忆增强型AI系统。</p>
<h3 data-id="heading-13">亚马逊云科技与Mem0的深度集成</h3>
<p>亚马逊云科技为Mem0提供了完整的服务生态支持，开发者可以根据具体需求选择最适合的亚马逊云科技服务组合。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0019596cf7d940eda20b447b9f2efa7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316743&amp;x-signature=RA7qNO7vnra1r0Dy8XO9HyrAnwY%3D" alt="3.png" loading="lazy"/></p>
<p>如上图所示，完整的解决方案采用分层架构设计，从上到下包含四个核心层次：</p>
<ul>
<li>用户应用层：StrandsAgent、LangGraph等开发框架，提供多样化的Agent构建方式</li>
<li>Mem0智能记忆层：核心记忆管理引擎，协调信息提取、智能决策、记忆检索和生命周期管理。</li>
<li>亚马逊云科技托管服务层：Amazon Bedrock提供AI能力，Aurora Serverless提供向量存储，Neptune Analytics提供图存储</li>
<li>安全与管理层：IAM、KMS、VPC等服务确保企业级安全保障</li>
</ul>
<p>这种云原生架构的核心优势在于弹性伸缩、按需付费和全托管服务，让开发者专注于业务逻辑而非基础设施管理。下面我们按照数据流向，深入探讨各层的技术特点和集成优势。</p>
<h3 data-id="heading-14">AI能力层：Amazon Bedrock</h3>
<p>作为整个架构的”智能大脑”，Amazon Bedrock为Mem0的双LLM架构提供强大的AI推理能力，承担信息提取、智能决策和语义理解的核心任务。</p>
<h4 data-id="heading-15">丰富的模型生态选择</h4>
<p>Amazon Bedrock作为托管基础模型服务，为Mem0提供了业界丰富的模型选择，包括Anthropic的Claude系列、Amazon的Nova系列、Meta的Llama系列、Cohere的Command系列，以及AI21 Labs的Jurassic系列等。</p>
<p>这种多模型支持使得开发者可以根据具体的应用场景、性能要求和成本预算选择最适合的模型组合：</p>
<ul>
<li>LLM模型选择：Amazon Nova系列作为亚马逊云科技自研的多模态大模型，在文本、图像等多模态理解和生成方面表现优异；Claude系列在复杂推理任务中表现卓越；Llama和Command系列则为成本敏感的应用提供高性价比选择。</li>
<li>嵌入模型选择：Titan Embed系列提供高质量的文本嵌入能力，支持长文本处理和多模态记忆功能；Cohere嵌入模型则在多语言场景中表现优异</li>
</ul>
<h4 data-id="heading-16">企业级安全与合规</h4>
<p>Bedrock提供企业级的安全保障，所有模型调用都在亚马逊云科技安全边界内进行，数据传输采用TLS加密，静态数据通过KMS加密。与IAM深度集成，支持细粒度的访问控制和审计日志，满足金融、医疗等行业的合规要求。</p>
<h4 data-id="heading-17">统一API与智能调度</h4>
<p>Bedrock的统一API设计简化了多模型管理，支持无服务器部署和按需付费。</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-comment"># Bedrock多模型配置示例 - 针对Mem0优化的生产配置</span>
bedrock_config = {
    <span class="hljs-string">"llm"</span>: {
        <span class="hljs-string">"provider"</span>: <span class="hljs-string">"aws_bedrock"</span>,
        <span class="hljs-string">"config"</span>: {
            <span class="hljs-string">"model"</span>: <span class="hljs-string">"us.anthropic.claude-3-7-sonnet-20250219-v1:0"</span>,<span class="hljs-comment"># 信息提取和决策</span>
            <span class="hljs-string">"temperature"</span>: <span class="hljs-number">0.1</span>,
            <span class="hljs-string">"max_tokens"</span>: <span class="hljs-number">4000</span>,
            <span class="hljs-string">"top_p"</span>: <span class="hljs-number">0.9</span>
        }
    },
    <span class="hljs-string">"embedder"</span>: {
        <span class="hljs-string">"provider"</span>: <span class="hljs-string">"aws_bedrock"</span>,
        <span class="hljs-string">"config"</span>: {
            <span class="hljs-string">"model"</span>: <span class="hljs-string">"amazon.titan-embed-text-v2:0"</span>,  <span class="hljs-comment"># 向量化记忆内容</span>
            <span class="hljs-string">"normalize"</span>: <span class="hljs-literal">True</span>,
            <span class="hljs-string">"dimensions"</span>: <span class="hljs-number">1024</span>
        }
    }
}
</code></pre>
<p>通过Bedrock丰富的模型生态和统一的API管理，Mem0能够实现真正智能的记忆管理，从简单的信息存储升级为具备理解、推理和决策能力的认知系统。</p>
<h3 data-id="heading-18">存储层：Aurora Serverless + Neptune Analytics</h3>
<p>作为Mem0记忆系统的数据基础，Aurora Serverless和Neptune Analytics构成了完整的存储解决方案：Aurora负责向量化记忆的高效存储和检索，Neptune负责实体关系的图谱管理和推理，两者协同工作为记忆增强型AI提供强大的数据支撑。</p>
<h4 data-id="heading-19">向量存储：Amazon Aurora Serverless for PostgreSQL</h4>
<p>Aurora Serverless for PostgreSQL凭借pgvector插件的原生向量支持、标准SQL接口和活跃社区生态，为Mem0提供了理想的向量存储基础。</p>
<p><strong>核心技术优势</strong></p>
<ul>
<li>原生向量能力：pgvector插件支持欧几里得距离、余弦相似度和内积计算等核心向量操作，完美匹配记忆检索需求</li>
<li>弹性伸缩架构：Aurora Serverless能够根据负载自动调整计算资源，支持从0到256TiB的存储自动扩展，实现真正的按需付费</li>
<li>企业级可靠性：AZ+1级别的可用性保证，即使在一个可用区和一个额外故障发生时仍能对外提供服务，确保珍贵记忆数据的安全</li>
<li>全球化部署能力：Aurora Global Database为需要全球部署的记忆增强型Agent应用提供关键支持。主区域的记忆数据可以在1秒内复制到最多10个次要区域，确保全球用户都能快速访问及时更新的记忆。</li>
</ul>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-comment"># Aurora Serverless配置示例</span>
aurora_config = {
    <span class="hljs-string">"vector_store"</span>: {
        <span class="hljs-string">"provider"</span>: <span class="hljs-string">"pgvector"</span>,
        <span class="hljs-string">"config"</span>: {
            <span class="hljs-string">"host"</span>: <span class="hljs-string">"aurora-serverless-cluster.cluster-xxx.us-east-1.rds.amazonaws.com"</span>,
            <span class="hljs-string">"port"</span>: <span class="hljs-number">5432</span>,
            <span class="hljs-string">"database"</span>: <span class="hljs-string">"mem0_db"</span>,
            <span class="hljs-string">"user"</span>: <span class="hljs-string">"mem0_user"</span>,
            <span class="hljs-string">"password"</span>: <span class="hljs-string">"${AWS_SECRET_MANAGER_PASSWORD}"</span>,
            <span class="hljs-string">"embedding_model_dims"</span>: <span class="hljs-number">1024</span>,
            <span class="hljs-string">"collection_name"</span>: <span class="hljs-string">"mem0_memories"</span>,
            <span class="hljs-string">"distance_metric"</span>: <span class="hljs-string">"cosine"</span>
        }
    }
}
</code></pre>
<h4 data-id="heading-20">图存储：Amazon Neptune Analytics</h4>
<p>Neptune Analytics作为Serverless图分析服务，与Mem0实现深度集成，为记忆增强型AI提供强大的图存储和关系推理能力。</p>
<p><strong>核心技术优势</strong></p>
<ul>
<li>Serverless弹性架构：根据查询复杂度和数据量自动调整计算资源，采用智能内存管理策略，支持大规模图遍历操作和并行处理</li>
<li>深度集成优势：与Mem0原生集成，系统能够自动从对话中提取实体和关系，构建知识图谱，通过多跳图推理显著提升AI响应质量</li>
<li>混合检索能力：支持在图遍历中集成向量相似性搜索，为记忆系统提供强大的关联分析能力</li>
<li>企业级安全保障：与IAM深度集成提供细粒度访问控制，支持身份基础策略和临时凭证，API调用采用TLS 1.2+加密传输。</li>
</ul>
<pre><code class="hljs language-Python" lang="Python"> <span class="hljs-comment">#Neptune Analytics配置示例</span>
neptune_config = {
    <span class="hljs-string">"graph_store"</span>: {
        <span class="hljs-string">"provider"</span>: <span class="hljs-string">"neptune"</span>,
        <span class="hljs-string">"config"</span>: {
            <span class="hljs-string">"endpoint"</span>: <span class="hljs-string">"neptune-graph://g-XXXXXX"</span>,
            <span class="hljs-string">"query_timeout"</span>: <span class="hljs-number">30000</span>,
            <span class="hljs-string">"max_results"</span>: <span class="hljs-number">1000</span>,
            <span class="hljs-string">"retry_config"</span>: {
                <span class="hljs-string">"max_attempts"</span>: <span class="hljs-number">3</span>,
                <span class="hljs-string">"backoff_multiplier"</span>: <span class="hljs-number">2</span>
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-21">存储层协同优势</h4>
<p>通过Aurora和Neptune的协同工作，Mem0实现了完整的记忆数据管理：向量存储处理语义相似性检索，图存储处理实体关系推理，两者结合为AI Agent提供了既能理解语义又能推理关系的强大记忆能力。这种双存储架构不仅提高了检索精度，更重要的是为复杂的记忆场景提供了多维度的数据支撑。</p>
<h3 data-id="heading-22">应用开发层 – StrandsAgent + LangGraph</h3>
<p>在完整的存储基础之上，开发者可以通过多种框架构建记忆增强型Agent应用。StrandsAgent和LangGraph作为两种主流的开发框架，为不同的开发需求提供了灵活的集成方案。</p>
<h4 data-id="heading-23">StrandsAgent：工具化记忆集成</h4>
<p>StrandsAgent作为亚马逊云科技提供的Agent开发框架，原生集成了Mem0记忆管理功能。为了更好地支持不同客户的需求，我们对mem0_memory工具进行了两个增强：</p>
<ul>
<li>向量数据库扩展：原始框架主要支持OpenSearch作为向量存储后端，我们新增了对Aurora PostgreSQL的原生支持，充分利用pgvector插件和Serverless架构的优势</li>
<li>多模型提供商支持：除了Amazon Bedrock外，还支持OpenAI兼容接口，比如DeepSeek等模型，通过STRANDS_MODEL_PROVIDER环境变量实现灵活切换，满足不同地区的部署需求，使得该方案不仅可在亚马逊云科技海外区域部署，同样也适用于北京和宁夏区域。</li>
</ul>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-comment"># 核心改动：完整的增强实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Mem0ServiceClient</span>:
<span class="hljs-comment"># 新增：Aurora PostgreSQL + Bedrock配置</span>
    PG_CONFIG_BEDROCK = {
        <span class="hljs-string">"embedder"</span>: {
            <span class="hljs-string">"provider"</span>: <span class="hljs-string">"aws_bedrock"</span>,
            <span class="hljs-string">"config"</span>: {
                <span class="hljs-string">"model"</span>: os.environ.get(<span class="hljs-string">"EMBEDDING_MODEL"</span>, <span class="hljs-string">"amazon.titan-embed-text-v2:0"</span>)
            }
        },
        <span class="hljs-string">"llm"</span>: {
            <span class="hljs-string">"provider"</span>: <span class="hljs-string">"aws_bedrock"</span>,
            <span class="hljs-string">"config"</span>: {
                <span class="hljs-string">"model"</span>: os.environ.get(<span class="hljs-string">"LLM_MODEL"</span>, <span class="hljs-string">"us.anthropic.claude-3-7-sonnet-20250219-v1:0"</span>),
                <span class="hljs-string">"temperature"</span>: <span class="hljs-number">0.1</span>,
                <span class="hljs-string">"max_tokens"</span>: <span class="hljs-number">2000</span>,
            },
        },
        <span class="hljs-string">"vector_store"</span>: {
            <span class="hljs-string">"provider"</span>: <span class="hljs-string">"pgvector"</span>,
            <span class="hljs-string">"config"</span>: {
                <span class="hljs-string">"collection_name"</span>: <span class="hljs-string">"mem0_memories"</span>,
                <span class="hljs-string">"host"</span>: os.environ.get(<span class="hljs-string">"POSTGRESQL_HOST"</span>),
                <span class="hljs-string">"port"</span>: os.environ.get(<span class="hljs-string">"POSTGRESQL_PORT"</span>),
                <span class="hljs-string">"user"</span>: os.environ.get(<span class="hljs-string">"POSTGRESQL_USER"</span>),
                <span class="hljs-string">"password"</span>: os.environ.get(<span class="hljs-string">"POSTGRESQL_PASSWORD"</span>),
                <span class="hljs-string">"embedding_model_dims"</span>: <span class="hljs-string">"1024"</span>,
            }
        }
    }
    
<span class="hljs-comment"># 新增：OpenAI兼容 + PostgreSQL配置</span>
    PG_CONFIG_OPENAI = {
        <span class="hljs-string">"llm"</span>: {
            <span class="hljs-string">"provider"</span>: <span class="hljs-string">"openai"</span>,  
            <span class="hljs-string">"config"</span>: {
                <span class="hljs-string">"model"</span>: os.environ.get(<span class="hljs-string">"LLM_MODEL"</span>),
                <span class="hljs-string">"api_key"</span>: os.environ.get(<span class="hljs-string">"OPENAI_API_KEY"</span>),
                <span class="hljs-string">"temperature"</span>: <span class="hljs-number">0.1</span>,
                <span class="hljs-string">"max_tokens"</span>: <span class="hljs-number">2000</span>,
            }
        },
        <span class="hljs-string">"embedder"</span>: {
            <span class="hljs-string">"provider"</span>: <span class="hljs-string">"openai"</span>,  
            <span class="hljs-string">"config"</span>: {
                <span class="hljs-string">"model"</span>: os.environ.get(<span class="hljs-string">"EMBEDDING_MODEL"</span>),
                <span class="hljs-string">"api_key"</span>: os.environ.get(<span class="hljs-string">"OPENAI_API_KEY"</span>),
            }
        },
        <span class="hljs-string">"vector_store"</span>: {
            <span class="hljs-string">"provider"</span>: <span class="hljs-string">"pgvector"</span>,
            <span class="hljs-string">"config"</span>: {
                <span class="hljs-string">"collection_name"</span>: <span class="hljs-string">"mem0_memories"</span>,
                <span class="hljs-string">"host"</span>: os.environ.get(<span class="hljs-string">"POSTGRESQL_HOST"</span>),
                <span class="hljs-string">"port"</span>: os.environ.get(<span class="hljs-string">"POSTGRESQL_PORT"</span>),
                <span class="hljs-string">"user"</span>: os.environ.get(<span class="hljs-string">"POSTGRESQL_USER"</span>),
                <span class="hljs-string">"dbname"</span>: os.environ.get(<span class="hljs-string">"DB_NAME"</span>),
                <span class="hljs-string">"password"</span>: os.environ.get(<span class="hljs-string">"POSTGRESQL_PASSWORD"</span>),
                <span class="hljs-string">"embedding_model_dims"</span>: <span class="hljs-string">"1024"</span>,
            }
        }

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_initialize_client</span>(<span class="hljs-params">self, config: <span class="hljs-type">Optional</span>[<span class="hljs-type">Dict</span>] = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-type">Any</span>:
        <span class="hljs-string">"""增强的客户端初始化逻辑"""</span>
        <span class="hljs-keyword">if</span> os.environ.get(<span class="hljs-string">"MEM0_API_KEY"</span>):
            <span class="hljs-keyword">return</span> MemoryClient()

        <span class="hljs-comment"># 新增：PostgreSQL后端支持</span>
        <span class="hljs-keyword">if</span> os.environ.get(<span class="hljs-string">"POSTGRESQL_HOST"</span>):
            logger.info(<span class="hljs-string">"Using PostgreSQL backend with Aurora Serverless"</span>)
            <span class="hljs-keyword">return</span> self._initialize_postgresql_client(config)

        <span class="hljs-keyword">if</span> os.environ.get(<span class="hljs-string">"OPENSEARCH_HOST"</span>):
            logger.info(<span class="hljs-string">"Using OpenSearch backend"</span>)
            <span class="hljs-keyword">return</span> self._initialize_opensearch_client(config)

        <span class="hljs-keyword">return</span> self._initialize_faiss_client(config)
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_initialize_postgresql_client</span>(<span class="hljs-params">self, config: <span class="hljs-type">Optional</span>[<span class="hljs-type">Dict</span>] = <span class="hljs-literal">None</span></span>) -&gt; Mem0Memory:
        <span class="hljs-string">"""新增：根据模型提供商选择相应配置"""</span>
        pg_config = (self.PG_CONFIG_BEDROCK
                    <span class="hljs-keyword">if</span> os.environ.get(<span class="hljs-string">'STRANDS_MODEL_PROVIDER'</span>) == <span class="hljs-string">"bedrock"</span>
                    <span class="hljs-keyword">else</span> self.PG_CONFIG_OPENAI)
        merged_config = self._merge_config(pg_config.copy())
        <span class="hljs-keyword">return</span> Mem0Memory.from_config(config_dict=merged_config)
</code></pre>
<p>使用方式</p>
<p>增强后的工具使用方式保持不变，但现在支持更多的部署选项：</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> strands <span class="hljs-keyword">import</span> Agent
<span class="hljs-keyword">from</span> strands_tools <span class="hljs-keyword">import</span> mem0_memory

<span class="hljs-comment"># 场景1：Aurora PostgreSQL + Amazon Bedrock上的模型</span>
os.environ[<span class="hljs-string">"STRANDS_MODEL_PROVIDER"</span>] = <span class="hljs-string">"bedrock"</span>
os.environ[<span class="hljs-string">"LLM_MODEL"</span>] = <span class="hljs-string">"us.anthropic.claude-3-7-sonnet-20250219-v1:0"</span>
os.environ[<span class="hljs-string">"EMBEDDING_MODEL"</span>] = <span class="hljs-string">"amazon.titan-embed-text-v2:0"</span>

<span class="hljs-comment"># 场景2：Aurora PostgreSQL + OpenAI兼容的模型</span>
<span class="hljs-comment"># os.environ["STRANDS_MODEL_PROVIDER"] = "openai"</span>
<span class="hljs-comment"># os.environ["LLM_MODEL"] = " deepseek-ai/DeepSeek-R1/wvvkzheh2i"</span>
<span class="hljs-comment"># os.environ["EMBEDDING_MODEL"] = "Pro/BAAI/bge-m3"</span>
<span class="hljs-comment"># os.environ["OPENAI_API_KEY"] = "your-api-key"</span>

<span class="hljs-comment"># PostgreSQL配置（通用）</span>
os.environ[<span class="hljs-string">"POSTGRESQL_HOST"</span>] = <span class="hljs-string">"aurora-cluster.cluster-xxx.us-east-1.rds.amazonaws.com"</span>
os.environ[<span class="hljs-string">"POSTGRESQL_USER"</span>] = <span class="hljs-string">"mem0_user"</span>
os.environ[<span class="hljs-string">"POSTGRESQL_PASSWORD"</span>] = <span class="hljs-string">"${AWS_SECRET_MANAGER_PASSWORD}"</span>
os.environ[<span class="hljs-string">"DB_NAME"</span>] = <span class="hljs-string">"mem0_db"</span>

<span class="hljs-comment"># 创建Agent，Agent后续会根据tool的定义，按需调用记忆增加、检索等接口</span>
agent = Agent(tools=[mem0_memory])
</code></pre>
<p>技术优势</p>
<p>这些增强带来的核心价值：</p>
<ul>
<li>存储优化：Aurora PostgreSQL的Serverless架构和成本效益</li>
<li>全球部署：支持不同地区的模型提供商和合规需求</li>
<li>开发友好：保持API兼容性，通过环境变量实现灵活配置</li>
<li>生态整合：与亚马逊云科技服务深度集成，简化运维管理</li>
</ul>
<h4 data-id="heading-24">LangGraph：状态驱动的记忆工作流</h4>
<p>LangGraph作为专门用于构建有状态、多智能体协作的编程框架，与Mem0的结合为构建具备长短期记忆的智能Agent提供了强大支撑。</p>
<p><strong>核心集成优势</strong></p>
<ul>
<li>状态管理：LangGraph的状态管理机制与Mem0的记忆系统完美结合，实现跨会话的记忆连续性</li>
<li>工作流编排：通过节点和边的设计，可以精确控制记忆的检索、处理和存储时机</li>
<li>弹性架构集成：与Aurora Serverless深度集成，实现云原生的弹性记忆管理</li>
</ul>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-comment"># LangGraph工作流示例 - 记忆驱动的对话流程</span>
<span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph, START, END

<span class="hljs-comment"># 定义记忆增强的工作流</span>
workflow = StateGraph(State)
workflow.add_node(<span class="hljs-string">"memory_retrieval"</span>, memory_search_node)
workflow.add_node(<span class="hljs-string">"agent_processing"</span>, memory_enhanced_chatbot)
workflow.add_node(<span class="hljs-string">"memory_storage"</span>, memory_save_node)

<span class="hljs-comment"># 记忆驱动的状态转换</span>
workflow.add_edge(START, <span class="hljs-string">"memory_retrieval"</span>)
workflow.add_edge(<span class="hljs-string">"memory_retrieval"</span>, <span class="hljs-string">"agent_processing"</span>)
workflow.add_edge(<span class="hljs-string">"agent_processing"</span>, <span class="hljs-string">"memory_storage"</span>)
workflow.add_edge(<span class="hljs-string">"memory_storage"</span>, END)

<span class="hljs-comment"># 编译并运行</span>
app = workflow.<span class="hljs-built_in">compile</span>()
result = app.invoke({<span class="hljs-string">"query"</span>: <span class="hljs-string">"推荐一部电影"</span>, <span class="hljs-string">"user_id"</span>: <span class="hljs-string">"alice"</span>})

<span class="hljs-comment"># 基于项目实际实现的最小化节点函数示例</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">memory_enhanced_chatbot</span>(<span class="hljs-params">state: AgentState</span>) -&gt; AgentState:
    <span class="hljs-string">"""记忆增强的聊天机器人节点 - 基于项目中的响应生成节点"""</span>
    <span class="hljs-comment"># 获取用户输入和记忆上下文</span>
    user_input = state.get(<span class="hljs-string">"user_input"</span>, <span class="hljs-string">""</span>)
    recalled_memories = state.get(<span class="hljs-string">"recalled_memories"</span>, [])
    
    <span class="hljs-comment"># 生成记忆增强的响应</span>
    response = <span class="hljs-keyword">await</span> generate_response_with_memory(
        user_input=user_input,
        memories=recalled_memories,
        user_id=state.get(<span class="hljs-string">"user_id"</span>, <span class="hljs-string">"default"</span>)
    )
    
    <span class="hljs-comment"># 更新状态</span>
    state[<span class="hljs-string">"final_response"</span>] = response
    state[<span class="hljs-string">"processing_complete"</span>] = <span class="hljs-literal">True</span>
    
    <span class="hljs-keyword">return</span> state

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">memory_search_node</span>(<span class="hljs-params">state: AgentState</span>) -&gt; AgentState:
    <span class="hljs-string">"""记忆搜索节点 - 基于项目中的召回模型节点"""</span>
    user_input = state.get(<span class="hljs-string">"user_input"</span>, <span class="hljs-string">""</span>)
    user_id = state.get(<span class="hljs-string">"user_id"</span>, <span class="hljs-string">"default"</span>)
    
    <span class="hljs-comment"># 使用Mem0搜索相关记忆</span>
    mem0 = get_mem0_instance()  <span class="hljs-comment"># 获取Mem0实例</span>
    search_results = mem0.search(user_input, user_id=user_id)
    
    <span class="hljs-comment"># 处理搜索结果</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(search_results, <span class="hljs-built_in">dict</span>) <span class="hljs-keyword">and</span> <span class="hljs-string">"results"</span> <span class="hljs-keyword">in</span> search_results:
        memories = search_results[<span class="hljs-string">"results"</span>]
    <span class="hljs-keyword">else</span>:
        memories = search_results <span class="hljs-keyword">or</span> []
    
    <span class="hljs-comment"># 更新状态</span>
    state[<span class="hljs-string">"recalled_memories"</span>] = memories
    state[<span class="hljs-string">"memory_search_complete"</span>] = <span class="hljs-literal">True</span>
    
    logger.info(<span class="hljs-string">f"Retrieved <span class="hljs-subst">{<span class="hljs-built_in">len</span>(memories)}</span> memories for user <span class="hljs-subst">{user_id}</span>"</span>)
    <span class="hljs-keyword">return</span> state

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">memory_save_node</span>(<span class="hljs-params">state: AgentState</span>) -&gt; AgentState:
    <span class="hljs-string">"""记忆保存节点 - 基于项目中的最终化节点"""</span>
    user_input = state.get(<span class="hljs-string">"user_input"</span>, <span class="hljs-string">""</span>)
    final_response = state.get(<span class="hljs-string">"final_response"</span>, <span class="hljs-string">""</span>)
    user_id = state.get(<span class="hljs-string">"user_id"</span>, <span class="hljs-string">"default"</span>)
    
    <span class="hljs-comment"># 保存用户输入到记忆</span>
    mem0 = get_mem0_instance()
    
    <span class="hljs-comment"># 构建记忆内容和元数据</span>
    memory_content = <span class="hljs-string">f"User said: <span class="hljs-subst">{user_input}</span>"</span>
    metadata = {
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"user_input"</span>,
        <span class="hljs-string">"timestamp"</span>: datetime.now().isoformat(),
        <span class="hljs-string">"conversation_id"</span>: state.get(<span class="hljs-string">"conversation_id"</span>),
        <span class="hljs-string">"response_generated"</span>: <span class="hljs-built_in">bool</span>(final_response)
    }
    
    <span class="hljs-comment"># 添加到记忆系统</span>
    result = mem0.add(memory_content, user_id=user_id, metadata=metadata)
    
    <span class="hljs-comment"># 更新状态</span>
    state[<span class="hljs-string">"memory_saved"</span>] = <span class="hljs-literal">True</span>
    state[<span class="hljs-string">"memory_save_result"</span>] = result
    
    logger.info(<span class="hljs-string">f"Memory saved for user <span class="hljs-subst">{user_id}</span>"</span>)
    <span class="hljs-keyword">return</span> state

<span class="hljs-comment"># 辅助函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_response_with_memory</span>(<span class="hljs-params">user_input: <span class="hljs-built_in">str</span>, memories: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>], user_id: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""基于记忆生成响应的辅助函数"""</span>
    <span class="hljs-comment"># 构建包含记忆上下文的提示</span>
    memory_context = <span class="hljs-string">""</span>
    <span class="hljs-keyword">if</span> memories:
        memory_texts = [mem.get(<span class="hljs-string">"memory"</span>, <span class="hljs-string">""</span>) <span class="hljs-keyword">for</span> mem <span class="hljs-keyword">in</span> memories[:<span class="hljs-number">3</span>]]  <span class="hljs-comment"># 取前3个最相关的记忆</span>
        memory_context = <span class="hljs-string">f"相关记忆: <span class="hljs-subst">{<span class="hljs-string">'; '</span>.join(memory_texts)}</span>"</span>
    
    <span class="hljs-comment"># 这里可以调用LLM生成响应</span>
    <span class="hljs-comment"># 在实际项目中，这会调用Amazon Bedrock或其他LLM服务</span>
    response = <span class="hljs-string">f"基于记忆回复: <span class="hljs-subst">{memory_context}</span>\n用户问题: <span class="hljs-subst">{user_input}</span>"</span>
    
    <span class="hljs-keyword">return</span> response

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_mem0_instance</span>():
    <span class="hljs-string">"""获取Mem0实例的辅助函数"""</span>
    <span class="hljs-comment"># 这里返回配置好的Mem0实例</span>
    <span class="hljs-comment"># 在实际项目中，这会从配置中初始化Mem0</span>
    <span class="hljs-keyword">from</span> mem0 <span class="hljs-keyword">import</span> Memory
    
    config = {
        <span class="hljs-string">"version"</span>: <span class="hljs-string">"v1.1"</span>,
        <span class="hljs-string">"llm"</span>: {
            <span class="hljs-string">"provider"</span>: <span class="hljs-string">"aws_bedrock"</span>,
            <span class="hljs-string">"config"</span>: {
                <span class="hljs-string">"model"</span>: <span class="hljs-string">"us.anthropic.claude-3-7-sonnet-20250219-v1:0"</span>,
                <span class="hljs-string">"max_tokens"</span>: <span class="hljs-number">1000</span>,
                <span class="hljs-string">"temperature"</span>: <span class="hljs-number">0.7</span>
            }
        },
        <span class="hljs-string">"vector_store"</span>: {
            <span class="hljs-string">"provider"</span>: <span class="hljs-string">"pgvector"</span>,
            <span class="hljs-string">"config"</span>: {
                <span class="hljs-string">"host"</span>: <span class="hljs-string">"aurora-serverless-cluster.cluster-xxx.us-east-1.rds.amazonaws.com"</span>,
                <span class="hljs-string">"port"</span>: <span class="hljs-number">5432</span>,
                <span class="hljs-string">"database"</span>: <span class="hljs-string">"mem0_db"</span>,
                <span class="hljs-string">"user"</span>: <span class="hljs-string">"mem0_user"</span>,
                <span class="hljs-string">"password"</span>: <span class="hljs-string">"${AWS_SECRET_MANAGER_PASSWORD}"</span>,
                <span class="hljs-string">"embedding_model_dims"</span>: <span class="hljs-number">1024</span>,
                <span class="hljs-string">"collection_name"</span>: <span class="hljs-string">"mem0_memories"</span>,
                <span class="hljs-string">"distance_metric"</span>: <span class="hljs-string">"cosine"</span>
            }
        }
    }
    
    <span class="hljs-keyword">return</span> Memory.from_config(config)
</code></pre>
<h4 data-id="heading-25">进一步思考：分层记忆管理</h4>
<p>基于认知科学的启发，我们可以基于Mem0实现分层记忆管理系统，模拟人类记忆的工作原理。系统将记忆按重要性分为工作记忆、短期记忆、长期记忆和核心记忆四个层级，实现智能的记忆资源管理。</p>
<p><strong>分层记忆设计理念</strong></p>
<ul>
<li>工作记忆层：存储当前对话的临时信息，具有最高访问速度但最短保存时间</li>
<li>短期记忆层：保存近期的用户偏好和行为模式，为个性化服务提供基础数据</li>
<li>长期记忆层：存储用户的稳定特征和重要历史信息，提供深度的用户理解能力</li>
<li>核心记忆层：保存用户的身份信息和最关键特征，几乎永久保存</li>
</ul>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-comment"># 分层记忆配置</span>
memory_config = {
   <span class="hljs-string">"importance_thresholds"</span>: {
       MemoryType.WORKING: <span class="hljs-number">1.0</span>,      <span class="hljs-comment"># 工作记忆重要性阈值</span>
       MemoryType.SHORT_TERM: <span class="hljs-number">3.0</span>,   <span class="hljs-comment"># 短期记忆重要性阈值</span>
       MemoryType.LONG_TERM: <span class="hljs-number">5.0</span>,    <span class="hljs-comment"># 长期记忆重要性阈值</span>
       MemoryType.CORE: <span class="hljs-number">8.0</span>          <span class="hljs-comment"># 核心记忆重要性阈值</span>
   },
   <span class="hljs-string">"decay_rates"</span>: {
       MemoryType.WORKING: <span class="hljs-number">0.8</span>,      <span class="hljs-comment"># 高衰减率：快速遗忘临时信息</span>
       MemoryType.SHORT_TERM: <span class="hljs-number">0.3</span>,   <span class="hljs-comment"># 中等衰减率：逐步淡化近期信息</span>
       MemoryType.LONG_TERM: <span class="hljs-number">0.05</span>,   <span class="hljs-comment"># 低衰减率：缓慢衰减长期信息</span>
       MemoryType.CORE: <span class="hljs-number">0.01</span>         <span class="hljs-comment"># 极低衰减率：几乎永久保存</span>
   },
   <span class="hljs-string">"max_age_hours"</span>: {
       MemoryType.WORKING: <span class="hljs-number">24</span>,       <span class="hljs-comment"># 工作记忆最大存活时间：1天</span>
       MemoryType.SHORT_TERM: <span class="hljs-number">168</span>,   <span class="hljs-comment"># 短期记忆最大存活时间：1周</span>
       MemoryType.LONG_TERM: <span class="hljs-number">8760</span>,   <span class="hljs-comment"># 长期记忆最大存活时间：1年</span>
       MemoryType.CORE: <span class="hljs-built_in">float</span>(<span class="hljs-string">'inf'</span>) <span class="hljs-comment"># 核心记忆：永久保存</span>
   },
   <span class="hljs-string">"enable_automatic_promotion"</span>: <span class="hljs-literal">True</span>,  <span class="hljs-comment"># 启用自动提升</span>
   <span class="hljs-string">"maintenance_interval_hours"</span>: <span class="hljs-number">6</span>      <span class="hljs-comment"># 维护间隔</span>
}
</code></pre>
<p>记忆提升工作流程</p>
<p>智能提升机制通过以下步骤自动管理记忆层级：</p>
<ol>
<li>初始评估阶段：新记忆通过LLM进行重要性评分，低于1.0阈值的信息被直接丢弃，确保只有有价值的信息进入记忆系统</li>
<li>工作记忆阶段：符合条件的记忆进入工作记忆层，系统开始监控访问频次和强化次数，为后续提升决策收集数据</li>
<li>短期记忆提升：当访问次数达到3次且被强化2次以上，同时存在时间超过1小时时，系统自动将记忆提升至短期记忆层</li>
<li>长期记忆提升：在短期记忆层停留24小时以上，且访问次数达到7次、重要性评分超过5.0时，记忆被提升至长期记忆层</li>
<li>核心记忆提升：长期记忆中的高频访问内容（15次以上）且重要性评分达到8.0时，提升至核心记忆层，获得几乎永久的保存</li>
<li>自然衰减机制：各层记忆根据不同的衰减率自然降低活跃度，长时间未访问的记忆会被自动清理，释放存储资源</li>
</ol>
<p>整个提升过程完全自动化，无需人工干预。系统会根据访问频次、重要性评分、强化次数和时间因素综合判断，确保重要信息得到适当的保存层级，同时让临时信息自然衰减。</p>
<h4 data-id="heading-26">开发框架选择指南</h4>
<ul>
<li>选择StrandsAgent：工具化集成方式，Agent自动决定记忆操作时机，适合快速开发和标准化场景</li>
<li>选择LangGraph：工作流编排方式，开发者精确控制记忆处理流程，适合复杂业务逻辑和定制化需求</li>
<li>直接API集成：完全自主控制，适合现有系统集成和特殊定制需求</li>
</ul>
<p>通过这些开发框架和高级特性的支持，开发者可以根据具体需求选择最适合的集成方式，快速构建生产级的记忆增强型Agent应用。</p>
<h3 data-id="heading-27">监控管理层：可视化仪表板</h3>
<p>为了有效管理和监控记忆系统，我们开发了基于Streamlit的可视化仪表板，展示如何在生产环境中操作和维护Mem0与PostgreSQL的集成。</p>
<h4 data-id="heading-28">功能特性</h4>
<ul>
<li>实时监控：记忆总数、新增趋势、类型分布等关键指标</li>
<li>数据库监控：Aurora PostgreSQL连接状态、性能指标和错误率</li>
<li>智能搜索：支持语义搜索和多维度筛选分析</li>
<li>开发支持：详细日志记录和错误处理机制</li>
</ul>
<h4 data-id="heading-29">核心技术实现</h4>
<p>仪表板采用渐进式的数据获取策略，确保在不同数据状态和网络条件下都能正常工作：</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-comment"># 核心数据获取实现 - 从Mem0读取记忆数据</span>
<span class="hljs-meta">@st.cache_data(<span class="hljs-params">ttl=<span class="hljs-number">30</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_user_memories</span>(<span class="hljs-params">user_id: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-type">Any</span>, <span class="hljs-type">Any</span>]]:
   <span class="hljs-string">"""初始化Mem0 对象"""</span>
   mem0 = init_mem0()
   <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> mem0 <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> user_id.strip():
       <span class="hljs-keyword">return</span> []

   <span class="hljs-keyword">try</span>:
       <span class="hljs-comment"># 方法1:从Mem0检索记忆</span>
       search_result = mem0.search(<span class="hljs-string">"user"</span>, user_id=user_id)

       <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(search_result, <span class="hljs-built_in">dict</span>) <span class="hljs-keyword">and</span> <span class="hljs-string">"results"</span> <span class="hljs-keyword">in</span> search_result:
           memories = search_result[<span class="hljs-string">"results"</span>]
       <span class="hljs-keyword">else</span>:
           memories = search_result

       <span class="hljs-keyword">if</span> memories:
           processed_memories = []
           <span class="hljs-keyword">for</span> memory <span class="hljs-keyword">in</span> memories:
               <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(memory, <span class="hljs-built_in">dict</span>):
                   processed_memories.append(memory)
               <span class="hljs-keyword">elif</span> <span class="hljs-built_in">hasattr</span>(memory, <span class="hljs-string">'__dict__'</span>):
                   processed_memories.append(memory.__dict__)
               <span class="hljs-keyword">else</span>:
                   <span class="hljs-comment"># 标准化记忆对象</span>
                   memory_dict = {
                       <span class="hljs-string">'id'</span>: <span class="hljs-built_in">getattr</span>(memory, <span class="hljs-string">'id'</span>, <span class="hljs-built_in">str</span>(uuid.uuid4())),
                       <span class="hljs-string">'memory'</span>: <span class="hljs-built_in">str</span>(memory),
                       <span class="hljs-string">'user_id'</span>: user_id,
                       <span class="hljs-string">'created_at'</span>: <span class="hljs-built_in">getattr</span>(memory, <span class="hljs-string">'created_at'</span>, datetime.now().isoformat()),
                       <span class="hljs-string">'metadata'</span>: <span class="hljs-built_in">getattr</span>(memory, <span class="hljs-string">'metadata'</span>, {})
                   }
                   processed_memories.append(memory_dict)
           <span class="hljs-keyword">return</span> processed_memories

       <span class="hljs-comment"># 方法2: 回退到全量数据获取</span>
       memories = mem0.get_all(user_id=user_id)

       <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(memories, <span class="hljs-built_in">dict</span>) <span class="hljs-keyword">and</span> <span class="hljs-string">'results'</span> <span class="hljs-keyword">in</span> memories:
           memories_list = memories[<span class="hljs-string">'results'</span>]
       <span class="hljs-keyword">elif</span> <span class="hljs-built_in">isinstance</span>(memories, <span class="hljs-built_in">list</span>):
           memories_list = memories
       <span class="hljs-keyword">else</span>:
           <span class="hljs-keyword">return</span> []

       processed_memories = []
       <span class="hljs-keyword">for</span> memory <span class="hljs-keyword">in</span> memories_list:
           <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(memory, <span class="hljs-built_in">dict</span>):
               processed_memories.append(memory)
           <span class="hljs-keyword">elif</span> <span class="hljs-built_in">hasattr</span>(memory, <span class="hljs-string">'__dict__'</span>):
               processed_memories.append(memory.__dict__)

       <span class="hljs-keyword">return</span> processed_memories

   <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
       st.error(<span class="hljs-string">f"获取记忆数据时发生错误: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
       <span class="hljs-keyword">return</span> []
</code></pre>
<p><em>可视化界面展示</em></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b0ebf05f282478a842752e2f35e6cfe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316743&amp;x-signature=hy3f%2B0CzcHIdimCyS5T2%2FzYtVr8%3D" alt="4.png" loading="lazy"/></p>
<p>如上图所示，仪表板提供了直观的记忆系统监控界面，包括记忆统计、搜索功能、数据筛选和详细的记忆内容展示。</p>
<p><strong>业务价值体现</strong></p>
<p>通过统一的监控界面，开发团队能够快速诊断问题、优化记忆策略、提升开发效率，为构建生产级记忆增强型AI系统提供完整的运维支撑。</p>
<h3 data-id="heading-30">架构总结</h3>
<p>通过亚马逊云科技与Mem0的深度集成，我们构建了一个企业级记忆增强型AI解决方案：</p>
<ul>
<li>技术完整性：覆盖了从大模型调用、向量存储、图存储到应用开发的完整技术栈</li>
<li>部署灵活性：支持多种模型提供商和存储后端，适应不同地区和场景的部署需求</li>
<li>开发便利性：提供了工具调用和Agent集成的方式，满足不同复杂度的应用需求</li>
<li>运维支撑：通过可视化仪表板和企业级安全特性，为生产环境提供必要的监控和管理能力</li>
</ul>
<p>这种集成方案为开发者提供了构建记忆增强型AI应用的技术基础和实践参考。</p>
<h3 data-id="heading-31">Mem0使用效果示例</h3>
<p>为了展示Mem0框架的智能记忆管理能力，我们通过一个企业内部知识分享的多轮对话场景，演示系统如何处理记忆演进和复杂关系推理。</p>
<h4 data-id="heading-32">第一次对话：建立基础关系</h4>
<p>用户</p>
<p>“我和Bob是同一个项目组的，他是我们的技术负责人，在推荐系统方面很有经验。”</p>
<p>助手+系统响应</p>
<p>您好！我看到您提供了关于您的团队信息，我会将这些内容存储到记忆中，以便在未来的对话中更好地为您提供帮助。</p>
<p>Using Tool: mem0_memory</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"store"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"用户在同一个项目组中与Bob一起工作。Bob是项目的技术负责人，在推荐系统方面有丰富经验。"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"team_information"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"colleague"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"expertise"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"recommendation_systems"</span>
  <span class="hljs-punctuation">}</span>
</code></pre>
<p>Tool Result (success)</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[  {    <span class="hljs-string">"id"</span>: <span class="hljs-string">"3ec5daa5-94d3-48f5-bf61-673062cb221f"</span>,    <span class="hljs-string">"memory"</span>: <span class="hljs-string">"在同一个项目组中与Bob一起工作"</span>,    <span class="hljs-string">"event"</span>: <span class="hljs-string">"ADD"</span>  },  {    <span class="hljs-string">"id"</span>: <span class="hljs-string">"fb1782bc-aeb5-460d-92d5-8d9905de8915"</span>,    <span class="hljs-string">"memory"</span>: <span class="hljs-string">"Bob是项目的技术负责人"</span>,    <span class="hljs-string">"event"</span>: <span class="hljs-string">"ADD"</span>  },  {    <span class="hljs-string">"id"</span>: <span class="hljs-string">"5a9fc4de-33f8-4218-93c8-8da79048cbae"</span>,    <span class="hljs-string">"memory"</span>: <span class="hljs-string">"Bob在推荐系统方面有丰富经验"</span>,    <span class="hljs-string">"event"</span>: <span class="hljs-string">"ADD"</span>  }]</span>
</code></pre>
<p>感谢您分享关于您项目组的信息。我已记录下您与Bob在同一个项目组工作的情况，以及Bob作为技术负责人在推荐系统方面的丰富经验。这些信息对我们今后的交流很有帮助。</p>
<p>如果您有任何关于推荐系统或者与您项目相关的问题，或者需要其他方面的帮助，请随时告诉我。我会根据您提供的背景信息，尽可能地提供相关和个性化的支持。</p>
<h4 data-id="heading-33">向量数据库存储</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c242d488f2f4b0e8557f08b526263cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316743&amp;x-signature=uSZYdEjAbpPmHKp2QEBEstVufQ4%3D" alt="5.png" loading="lazy"/></p>
<h3 data-id="heading-34">第二次对话：扩展关系网络</h3>
<p>用户</p>
<p>“Bob推荐我去找Carol学习机器学习，她是AI团队的专家，在深度学习方面特别厉害。”</p>
<p>助手+系统响应</p>
<p>我看到您提到Bob推荐您去找Carol学习机器学习，并且Carol是AI团队的专家，尤其在深度学习方面很厉害。让我先检查一下我是否有关于您的任何现有信息，以便为您提供更加个性化的帮助。</p>
<p>Using Tool: mem0_memory</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"list"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>Tool Result (success)</p>
<pre><code class="hljs language-Python" lang="Python">[
  {
    <span class="hljs-string">"id"</span>: <span class="hljs-string">"3ec5daa5-94d3-48f5-bf61-673062cb221f"</span>,
    <span class="hljs-string">"memory"</span>: <span class="hljs-string">"在同一个项目组中与Bob一起工作"</span>,
    <span class="hljs-string">"hash"</span>: <span class="hljs-string">"baa65b58935e173d00dd26d9bab23e47"</span>,
    <span class="hljs-string">"metadata"</span>: {
      <span class="hljs-string">"topic"</span>: <span class="hljs-string">"team_information"</span>,
      <span class="hljs-string">"colleague"</span>: <span class="hljs-string">"Bob"</span>,
      <span class="hljs-string">"expertise"</span>: <span class="hljs-string">"recommendation_systems"</span>
    },
    <span class="hljs-string">"created_at"</span>: <span class="hljs-string">"2025-08-11T03:36:40.466927-07:00"</span>,
    <span class="hljs-string">"updated_at"</span>: null,
    <span class="hljs-string">"user_id"</span>: <span class="hljs-string">"current_user"</span>
  },
  {
    <span class="hljs-string">"id"</span>: <span class="hljs-string">"fb1782bc-aeb5-460d-92d5-8d9905de8915"</span>,
    <span class="hljs-string">"memory"</span>: <span class="hljs-string">"Bob是项目的技术负责人"</span>,
    <span class="hljs-string">"hash"</span>: <span class="hljs-string">"0c579f6e39533cde107976924fa46d26"</span>,
    <span class="hljs-string">"metadata"</span>: {
      <span class="hljs-string">"topic"</span>: <span class="hljs-string">"team_information"</span>,
      <span class="hljs-string">"colleague"</span>: <span class="hljs-string">"Bob"</span>,
      <span class="hljs-string">"expertise"</span>: <span class="hljs-string">"recommendation_systems"</span>
    },
    <span class="hljs-string">"created_at"</span>: <span class="hljs-string">"2025-08-11T03:36:40.488842-07:00"</span>,
    <span class="hljs-string">"updated_at"</span>: null,
    <span class="hljs-string">"user_id"</span>: <span class="hljs-string">"current_user"</span>
  },
  {
    <span class="hljs-string">"id"</span>: <span class="hljs-string">"5a9fc4de-33f8-4218-93c8-8da79048cbae"</span>,
    <span class="hljs-string">"memory"</span>: <span class="hljs-string">"Bob在推荐系统方面有丰富经验"</span>,
    <span class="hljs-string">"hash"</span>: <span class="hljs-string">"6505f50198c9fbc420d31d5f5438acc4"</span>,
    <span class="hljs-string">"metadata"</span>: {
      <span class="hljs-string">"topic"</span>: <span class="hljs-string">"team_information"</span>,
      <span class="hljs-string">"colleague"</span>: <span class="hljs-string">"Bob"</span>,
      <span class="hljs-string">"expertise"</span>: <span class="hljs-string">"recommendation_systems"</span>
    },
    <span class="hljs-string">"created_at"</span>: <span class="hljs-string">"2025-08-11T03:36:40.510291-07:00"</span>,
    <span class="hljs-string">"updated_at"</span>: null,
    <span class="hljs-string">"user_id"</span>: <span class="hljs-string">"current_user"</span>
  }
]
</code></pre>
<p>我看到您之前和Bob一起工作，他是项目的技术负责人，在推荐系统方面拥有丰富的经验。现在让我来为您存储关于Carol的新信息：</p>
<p>Using Tool: mem0_memory</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"store"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Carol是AI团队的专家，在深度学习方面特别厉害"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"team_information"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"colleague"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Carol"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"expertise"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"deep_learning"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"referral_from"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>Tool Result (success)</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[  {    <span class="hljs-string">"id"</span>: <span class="hljs-string">"6614ff29-3bec-4434-9ab5-d246af5672cc"</span>,    <span class="hljs-string">"memory"</span>: <span class="hljs-string">"Carol是AI团队的专家"</span>,    <span class="hljs-string">"event"</span>: <span class="hljs-string">"ADD"</span>  },  {    <span class="hljs-string">"id"</span>: <span class="hljs-string">"e2d5e269-a104-4fbe-80b8-54de35fb461d"</span>,    <span class="hljs-string">"memory"</span>: <span class="hljs-string">"Carol在深度学习方面特别厉害"</span>,    <span class="hljs-string">"event"</span>: <span class="hljs-string">"ADD"</span>  }]</span>
</code></pre>
<p>Using Tool: mem0_memory</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"store"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"learning_interests"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"subject"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"machine_learning"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"referral"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"true"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"对机器学习感兴趣，Bob推荐去找Carol学习"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>Tool Result (success)</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[  {    <span class="hljs-string">"id"</span>: <span class="hljs-string">"42ea8558-b364-4097-82d1-7cc167cef1ee"</span>,    <span class="hljs-string">"memory"</span>: <span class="hljs-string">"对机器学习感兴趣"</span>,    <span class="hljs-string">"event"</span>: <span class="hljs-string">"ADD"</span>  },  {    <span class="hljs-string">"id"</span>: <span class="hljs-string">"5e223204-cc0f-4fef-a60c-bd98932f3911"</span>,    <span class="hljs-string">"memory"</span>: <span class="hljs-string">"Bob推荐去找Carol学习"</span>,    <span class="hljs-string">"event"</span>: <span class="hljs-string">"ADD"</span>  }]</span>
</code></pre>
<p>感谢您分享这些信息！我已经记录下了关于Carol的专业知识以及Bob的推荐。</p>
<p>根据我们之前的交流，我了解到您和Bob是同事，他是项目的技术负责人，在推荐系统方面有丰富经验。现在他推荐您向Carol学习机器学习，这是个很好的建议！</p>
<p>Carol作为AI团队的专家，特别是在深度学习领域有专长，确实是学习机器学习的理想人选。如果您有兴趣深入学习这个领域，找Carol指导是非常合适的。</p>
<p>您计划如何联系Carol呢？或者您对机器学习有什么特定的学习目标或问题想先了解一下？我很乐意帮您准备一些与Carol交流的关键问题或者提供一些机器学习的基础资源。</p>
<h4 data-id="heading-35">向量数据库存储</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/015f681dfb3444b6902fea2b2ee3c842~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316743&amp;x-signature=Ij3xDubvUJ5mZG7%2FmGRVutOjF2o%3D" alt="2.png" loading="lazy"/></p>
<h3 data-id="heading-36">第三次对话：深化专业关联</h3>
<p>用户</p>
<p>“Carol提到她和David合作过一个很成功的电商推荐系统项目，用的是深度学习技术。”</p>
<p>助手+系统响应</p>
<p>我注意到您提到了关于Carol和David合作的电商推荐系统项目的信息。为了更好地理解和保存这条重要信息，我需要先检查一下是否已经有关于Carol的记录，然后将这条新信息存储起来。</p>
<p>Using Tool: mem0_memory</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">[</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"6614ff29-3bec-4434-9ab5-d246af5672cc"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"memory"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Carol是AI团队的专家"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"af15be42b498b30fb7c12a843ec248c3"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"team_information"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"colleague"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Carol"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"expertise"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"deep_learning"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"referral_from"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.4540502158373456</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-08-11T03:38:40.055840-07:00"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"updated_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"5e223204-cc0f-4fef-a60c-bd98932f3911"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"memory"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob推荐去找Carol学习"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"81d79f9cca4b862f661e6db5b1e8d8c6"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"learning_interests"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"subject"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"machine_learning"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"referral"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"true"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.5762676253159262</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-08-11T03:38:49.835854-07:00"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"updated_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"e2d5e269-a104-4fbe-80b8-54de35fb461d"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"memory"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Carol在深度学习方面特别厉害"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"858ed013f042a05abc95bd80e8195c44"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"team_information"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"colleague"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Carol"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"expertise"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"deep_learning"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"referral_from"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.674725383520124</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-08-11T03:38:40.078016-07:00"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"updated_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"fb1782bc-aeb5-460d-92d5-8d9905de8915"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"memory"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob是项目的技术负责人"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0c579f6e39533cde107976924fa46d26"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"team_information"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"colleague"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"expertise"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"recommendation_systems"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.8379180628681754</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-08-11T03:36:40.488842-07:00"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"updated_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"5a9fc4de-33f8-4218-93c8-8da79048cbae"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"memory"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob在推荐系统方面有丰富经验"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"6505f50198c9fbc420d31d5f5438acc4"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"team_information"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"colleague"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"expertise"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"recommendation_systems"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.8489449204272127</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-08-11T03:36:40.510291-07:00"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"updated_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"3ec5daa5-94d3-48f5-bf61-673062cb221f"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"memory"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"在同一个项目组中与Bob一起工作"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"baa65b58935e173d00dd26d9bab23e47"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"team_information"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"colleague"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"expertise"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"recommendation_systems"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.8534301326701068</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-08-11T03:36:40.466927-07:00"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"updated_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"42ea8558-b364-4097-82d1-7cc167cef1ee"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"memory"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"对机器学习感兴趣"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"a8832502816a0ab35a3a15208f6d6d15"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"learning_interests"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"subject"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"machine_learning"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"referral"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"true"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.8896779102470982</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-08-11T03:38:49.817286-07:00"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"updated_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">]</span>
</code></pre>
<p>现在我看到了一些关于Carol的现有信息，我将存储这条新的关于Carol和David合作项目的信息：</p>
<p>Using Tool: mem0_memory</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"store"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Carol和David合作开发了一个成功的电商推荐系统项目，使用的是深度学习技术"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"projects"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"colleagues"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"Carol"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"David"</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"project_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"recommendation_system"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"technology"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"deep_learning"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"industry"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"e-commerce"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"outcome"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"successful"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>Tool Result (success)</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[  {    <span class="hljs-string">"id"</span>: <span class="hljs-string">"76162a60-b3b5-4660-8dc7-7125fee9215f"</span>,    <span class="hljs-string">"memory"</span>: <span class="hljs-string">"Carol和David合作开发了一个成功的电商推荐系统项目"</span>,    <span class="hljs-string">"event"</span>: <span class="hljs-string">"ADD"</span>  },  {    <span class="hljs-string">"id"</span>: <span class="hljs-string">"a8a77ccc-aff5-4765-a4e0-7795d8ed87de"</span>,    <span class="hljs-string">"memory"</span>: <span class="hljs-string">"使用了深度学习技术"</span>,    <span class="hljs-string">"event"</span>: <span class="hljs-string">"ADD"</span>  }]</span>
</code></pre>
<p>感谢您分享这条信息。我已经记录了Carol和David合作开发的电商推荐系统项目的细节。</p>
<p>根据我已有的记忆，我了解到：</p>
<ul>
<li>Carol是AI团队的专家，特别擅长深度学习领域</li>
<li>现在我知道她与David合作开发了一个成功的电商推荐系统项目，应用了深度学习技术</li>
<li>此前Bob曾推荐向Carol学习，特别是在机器学习方面</li>
<li>这个项目信息很有价值。如果您想了解更多关于Carol的专业知识或者这个推荐系统项目的细节，或者您有任何其他信息想要分享，请随时告诉我。</li>
</ul>
<h4 data-id="heading-37">向量数据库存储</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14b4de54cc664c17a487b9fa4a133376~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316743&amp;x-signature=25xCPBcd5EOl9FVqFHvvHVOZk%2FQ%3D" alt="7.png" loading="lazy"/></p>
<h3 data-id="heading-38">第四次对话：查询，记忆存储价值体现</h3>
<p>用户</p>
<p>“我想找一个推荐系统方面的专家，最好是通过可信渠道了解到的，能给我一些实战经验。”</p>
<p>助手+系统响应</p>
<p>您好！我理解您正在寻找推荐系统方面的专家，希望获得一些实战经验。为了更好地为您服务，我想先了解一下您之前是否与我们讨论过相关话题或有任何推荐系统方面的偏好。</p>
<p>让我先查询一下您的历史记录，看看我们是否有相关的信息：</p>
<p>Using Tool: mem0_memory</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"retrieve"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"推荐系统 专家 技术偏好 实战经验 职业背景"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>Tool Result (success)</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">[</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"5a9fc4de-33f8-4218-93c8-8da79048cbae"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"memory"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob在推荐系统方面有丰富经验"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"6505f50198c9fbc420d31d5f5438acc4"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"team_information"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"colleague"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"expertise"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"recommendation_systems"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.4588502421050821</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-08-11T03:36:40.510291-07:00"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"updated_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"76162a60-b3b5-4660-8dc7-7125fee9215f"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"memory"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Carol和David合作开发了一个成功的电商推荐系统项目"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"47196951d607246d0933e0c285ca0444"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"projects"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"outcome"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"successful"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"industry"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"e-commerce"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"colleagues"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"Carol"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"David"</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"technology"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"deep_learning"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"project_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"recommendation_system"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.6427874075535635</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-08-11T03:41:31.777281-07:00"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"updated_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"fb1782bc-aeb5-460d-92d5-8d9905de8915"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"memory"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob是项目的技术负责人"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0c579f6e39533cde107976924fa46d26"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"team_information"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"colleague"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"expertise"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"recommendation_systems"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.7467557418266737</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-08-11T03:36:40.488842-07:00"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"updated_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"6614ff29-3bec-4434-9ab5-d246af5672cc"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"memory"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Carol是AI团队的专家"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"af15be42b498b30fb7c12a843ec248c3"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"team_information"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"colleague"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Carol"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"expertise"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"deep_learning"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"referral_from"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.7494404018592338</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-08-11T03:38:40.055840-07:00"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"updated_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"a8a77ccc-aff5-4765-a4e0-7795d8ed87de"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"memory"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"使用了深度学习技术"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"6f8654a7f1ebe2aa93e5b25ae5728bb3"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"projects"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"outcome"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"successful"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"industry"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"e-commerce"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"colleagues"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"Carol"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"David"</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"technology"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"deep_learning"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"project_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"recommendation_system"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.7579878847627914</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-08-11T03:41:31.802874-07:00"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"updated_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"42ea8558-b364-4097-82d1-7cc167cef1ee"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"memory"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"对机器学习感兴趣"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"a8832502816a0ab35a3a15208f6d6d15"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"learning_interests"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"subject"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"machine_learning"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"referral"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"true"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.8253733529972992</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-08-11T03:38:49.817286-07:00"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"updated_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"3ec5daa5-94d3-48f5-bf61-673062cb221f"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"memory"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"在同一个项目组中与Bob一起工作"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"baa65b58935e173d00dd26d9bab23e47"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"team_information"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"colleague"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"expertise"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"recommendation_systems"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.8466813908016234</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-08-11T03:36:40.466927-07:00"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"updated_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"5e223204-cc0f-4fef-a60c-bd98932f3911"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"memory"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob推荐去找Carol学习"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"81d79f9cca4b862f661e6db5b1e8d8c6"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"learning_interests"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"subject"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"machine_learning"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"referral"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"true"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.8693739778549688</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-08-11T03:38:49.835854-07:00"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"updated_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"e2d5e269-a104-4fbe-80b8-54de35fb461d"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"memory"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Carol在深度学习方面特别厉害"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"858ed013f042a05abc95bd80e8195c44"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"team_information"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"colleague"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Carol"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"expertise"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"deep_learning"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"referral_from"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.9502609774314766</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-08-11T03:38:40.078016-07:00"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"updated_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">]</span>
</code></pre>
<p>根据我查询到的信息，我发现您之前可能已经与一些推荐系统方面的专家有所联系或了解。基于我们的记录，我可以为您提供以下推荐：</p>
<ol>
<li>Bob – 他是推荐系统方面的专家，并且是某项目的技术负责人。根据记录，您曾与Bob在同一个项目组中工作，他在推荐系统领域有丰富的经验。这是一个通过您的工作关系建立的可信渠道。</li>
<li>Carol – 她是一位AI团队的专家，特别在深度学习方面非常厉害。有趣的是，正是Bob之前推荐您向Carol学习。Carol与另一位同事David曾合作开发了一个成功的电商推荐系统项目，使用了深度学习技术。</li>
</ol>
<p>鉴于您希望通过可信渠道了解到的专家，且需要实战经验，我建议您可以：</p>
<ol>
<li>优先联系Bob，他既是您的同事，也是推荐系统领域的专家，可以直接分享他的实战经验。</li>
<li>请Bob引荐您认识Carol，她在深度学习推荐系统方面有成功的电商项目经验，特别是如果您对深度学习在推荐系统中的应用感兴趣。</li>
<li>也可以请Carol介绍她与David合作的电商推荐系统项目的实战经验和关键技术点。</li>
</ol>
<p>您希望我为您提供更多关于这些专家的详细信息，或者您对其他方面的推荐系统专家有特定要求吗？</p>
<h3 data-id="heading-39">无记忆系统的对比</h3>
<h4 data-id="heading-40">记忆清除</h4>
<p>登陆到向量数据库，将会话历史删除。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5904c523505b4ae4989a7a017d39c72f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316743&amp;x-signature=9coG3NPPkIAreUAH1fw79nYTjNk%3D" alt="8.png" loading="lazy"/></p>
<p>用户</p>
<p>“我想找一个推荐系统方面的专家，最好是通过可信渠道了解到的，能给我一些实战经验。”</p>
<p>助手+系统响应</p>
<p>您好！我很乐意帮您寻找推荐系统方面的专家。为了更好地为您提供个性化服务，我需要先了解一下您之前是否已经与我讨论过相关的需求或提供过一些信息。让我先查询一下您的历史记录。</p>
<p>Using Tool: mem0_memory</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"list"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"current_user"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>Tool Result (success)</p>
<p><code>[]</code></p>
<p>看起来我们之前没有存储关于您的信息。为了能够更好地帮助您，我想了解一些更具体的信息，这样我可以将其保存下来，以便今后为您提供更个性化的服务。</p>
<p>关于您寻找推荐系统专家的需求，我想了解几点：</p>
<ol>
<li>您对推荐系统的哪些方面特别感兴趣？(例如：电商推荐、内容推荐、算法实现等)</li>
<li>您希望这位专家能提供什么类型的实战经验？(例如：系统搭建、算法优化、A/B测试等)</li>
<li>您计划通过什么方式与专家交流？(例如：咨询、合作、指导等)</li>
</ol>
<p>我会将您提供的这些信息保存下来，以便今后能够更精准地为您服务。同时，我可以根据您的需求，推荐一些可以寻找推荐系统专家的可信渠道，如专业社区、行业会议、学术机构等。</p>
<h3 data-id="heading-41">核心价值对比</h3>
<p>通过上述多轮对话演示，我们可以清晰地看到记忆系统与传统无记忆系统的核心差异：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af12fd7b8677479eb7153c4531869658~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316743&amp;x-signature=HQ%2FQkBhrFsO476d6gQGMpO1aUjo%3D" alt="9.webp" loading="lazy"/></p>
<h3 data-id="heading-42">总结和展望</h3>
<p>Mem0框架标志着Agentic AI应用从无状态向有状态的重要转变。通过双LLM架构和智能记忆管理机制，解决了传统AI系统的记忆缺失问题，实现了真正的个性化和上下文连续性。</p>
<p>Mem0框架与亚马逊云科技的深度集成真正体现了”相得益彰”的协同效应——Mem0提供智能记忆管理核心能力，亚马逊云科技提供企业级基础设施支撑。这种结合实现了能力倍增，推动记忆增强型AI从概念验证走向生产实践。该方案不仅可在亚马逊云科技海外区域部署，同样也适用于北京和宁夏区域。</p>
<p>记忆增强型Agent在企业客户服务、个性化教育、知识管理等领域展现出巨大潜力。随着多模态AI技术发展，未来的记忆系统将支持更丰富的数据类型和更强的自主学习能力。记忆增强型Agentic AI将推动人工智能从工具向伙伴的根本性转变，为用户创造更加智能、个性化的数字体验。</p>
<p>*<em>前述特定亚马逊云科技生成式人工智能相关的服务目前在亚马逊云科技海外区域可用。亚马逊云科技中国区域相关云服务由西云数据和光环新网运营，具体信息以中国区域官网为准。</em></p>
<p><strong>本篇作者</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df17a40abb7046abbf88f1b4fb377e4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764316743&amp;x-signature=oA3NPTmlnFsxFx0q194Q0NWVYow%3D" alt="zz.webp" loading="lazy"/></p>
<blockquote>
<p>本期最新实验《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.amazoncloud.cn%2Fexperience%2Fcloudlab%3Fid%3D6695e4c5e1432f239fae485f%26visitfrom%3D3P_Juejintail_0415%26sc_medium%3Downed%26sc_campaign%3Dcloudlab%26sc_channel%3D3P_Juejintail_0415" target="_blank" title="https://dev.amazoncloud.cn/experience/cloudlab?id=6695e4c5e1432f239fae485f&amp;visitfrom=3P_Juejintail_0415&amp;sc_medium=owned&amp;sc_campaign=cloudlab&amp;sc_channel=3P_Juejintail_0415" ref="nofollow noopener noreferrer">多模一站通 —— Amazon Bedrock 上的基础模型初体验</a>》</p>
<p>✨ 精心设计，旨在引导您深入探索Amazon Bedrock的模型选择与调用、模型自动化评估以及安全围栏(Guardrail)等重要功能。无需管理基础设施，利用亚马逊技术与生态，快速集成与部署生成式AI模型能力。</p>
<p>⏩️[<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.amazoncloud.cn%2Fexperience%2Fcloudlab%3Fid%3D6695e4c5e1432f239fae485f%26visitfrom%3D3P_Juejintail_0415%26sc_medium%3Downed%26sc_campaign%3Dcloudlab%26sc_channel%3D3P_Juejintail_0415" target="_blank" title="https://dev.amazoncloud.cn/experience/cloudlab?id=6695e4c5e1432f239fae485f&amp;visitfrom=3P_Juejintail_0415&amp;sc_medium=owned&amp;sc_campaign=cloudlab&amp;sc_channel=3P_Juejintail_0415" ref="nofollow noopener noreferrer">点击进入实验</a>] 即刻开启  AI 开发之旅</p>
<p>构建无限, 探索启程！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL中的字符集与排序规则]]></title>    <link>https://juejin.cn/post/7574269207363158025</link>    <guid>https://juejin.cn/post/7574269207363158025</guid>    <pubDate>2025-11-19T23:46:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574269207363158025" data-draft-id="7574568258787917875" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL中的字符集与排序规则"/> <meta itemprop="keywords" content="MySQL,数据库,后端"/> <meta itemprop="datePublished" content="2025-11-19T23:46:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序新视界"/> <meta itemprop="url" content="https://juejin.cn/user/3368559359568696"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL中的字符集与排序规则
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3368559359568696/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序新视界
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T23:46:45.000Z" title="Wed Nov 19 2025 23:46:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在MySQL中，当使用字符串类型时，有两方面的知识我们需要特别关注一下：字符集和排序规则。如果使用不当，则可能会导致性能问题或在插入数据时出现一些异常情况。</p>
<p>字符集定义了对应列允许使用的字符，而排序规则是用于比较这些字符的基础规则。通常，每个类型的字符集都会有多种排序规则，但一个排序规则只能属于一个字符集。</p>
<p>这篇文章，我们就围绕MySQL中字符集以及排序规则展开，详细聊聊相关的技术点。</p>
<h2 data-id="heading-0">MySQL中的字符集</h2>
<p>MySQL支持广泛的字符集，包括GB2312、GBK、BIG5等本地字符集，以及多种Unicode字符集，如<code>utf8mb3</code> (MySQL中旧版的<code>utf8</code>)、<code>utf8mb4</code>、<code>ucs2</code>、<code>utf16</code>和<code>utf32</code>。<code>utf8mb4</code>是推荐使用的字符集，因为它能完整支持所有Unicode字符，包括表情符号和不常用的汉字。</p>
<p>可以使用下面的命令在<code>information_schema</code>数据库中查看所有字符集：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">mysql&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> information_schema.character_sets <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> character_set_name;
+--------------------+----------------------+---------------------------------+--------+
| CHARACTER_SET_NAME | DEFAULT_COLLATE_NAME | DESCRIPTION                     | MAXLEN |
+--------------------+----------------------+---------------------------------+--------+
| armscii8           | armscii8_general_ci  | ARMSCII-<span class="hljs-number">8</span> Armenian              |      <span class="hljs-number">1</span> |
| ascii              | ascii_general_ci     | US ASCII                        |      <span class="hljs-number">1</span> |
| big5               | big5_chinese_ci      | Big5 Traditional Chinese        |      <span class="hljs-number">2</span> |
| <span class="hljs-keyword">binary</span>             | <span class="hljs-keyword">binary</span>               | <span class="hljs-keyword">Binary</span> pseudo charset           |      <span class="hljs-number">1</span> |
……
……
……
| utf16              | utf16_general_ci     | UTF-<span class="hljs-number">16</span> <span class="hljs-keyword">Unicode</span>                  |      <span class="hljs-number">4</span> |
| utf16le            | utf16le_general_ci   | UTF-<span class="hljs-number">16L</span>E <span class="hljs-keyword">Unicode</span>                |      <span class="hljs-number">4</span> |
| utf32              | utf32_general_ci     | UTF-<span class="hljs-number">32</span> <span class="hljs-keyword">Unicode</span>                  |      <span class="hljs-number">4</span> |
| utf8               | utf8_general_ci      | UTF-<span class="hljs-number">8</span> <span class="hljs-keyword">Unicode</span>                   |      <span class="hljs-number">3</span> |
| utf8mb4            | utf8mb4_0900_ai_ci   | UTF-<span class="hljs-number">8</span> <span class="hljs-keyword">Unicode</span>                   |      <span class="hljs-number">4</span> |
+--------------------+----------------------+---------------------------------+--------+
</code></pre>
<p>通过上述命令可以列出当前MySQL支持的所有字符集，以及它们的默认排序规则。每种字符集都有一个默认排序规则。</p>
<p>在上述命令展示的列表底部，有两个字符集被描述为UTF-8 Unicode。<code>utf8</code>字符集的<code>MAXLEN</code>为3，而<code>utf8mb4</code>的<code>MAXLEN</code>为4。这里指的是每个字符允许的最大字节长度。</p>
<p>特别需要留意的是，<strong>根据UTF-8标准，每个字符允许使用最多4个字节，这意味着MySQL的<code>utf8</code>字符集实际上并不是真正的UTF-8，因为它只支持每字符最多3个字节。从MySQL 8开始，<code>utf8mb4</code>成为默认字符集，也是最常使用的字符集。</strong> 而<code>utf8</code>被保留用于向下兼容，应该不再使用。</p>
<h2 data-id="heading-1">如何定义字符集</h2>
<p>定义列的字符集有几种方式。如果你没有在表或列级别指定字符集，服务器默认的<code>utf8mb4</code>字符集将被应用（除非你明确声明了一个不同的服务器或数据库默认设置）。</p>
<p>我们可以通过创建一个没有字符集信息的表并读取其定义来验证这一点：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> no_charset (
  my_column <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>)
);
​
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> no_charset;
</code></pre>
<p>生成的<code>CREATE TABLE</code>语句显示了默认的字符集和排序规则已经被应用：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `no_charset` (
  `my_column` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8mb4_0900_ai_ci;
</code></pre>
<h3 data-id="heading-2">在表级别定义</h3>
<p>你可以显式地在表级别设置字符集，通过使用<code>CHARSET=[字符集]</code>语法。例如，这里我们创建一个所有字符列都使用<code>latin1</code>字符集的表：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> no_charset (
  `my_column` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>latin1;
</code></pre>
<h3 data-id="heading-3">在列级别定义</h3>
<p>你也可以在列级别设置字符集。这是最具体的设置，会覆盖任何表级别的设置：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `mixed_collations` (
  `explicitly_set` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> latin1,
  `implicitly_set` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>)
);
</code></pre>
<p>通过运行<code>SHOW CREATE TABLE mixed_collations</code>可以看到表的默认字符集是<code>utf8mb4</code>，但是显式设置的列使用了<code>latin1</code>字符集：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `mixed_collations` (
  `explicitly_set` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> latin1 <span class="hljs-keyword">COLLATE</span> latin1_swedish_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `implicitly_set` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8mb4_0900_ai_ci;
</code></pre>
<p>列级别的声明将覆盖表级别的声明，表级别的声明将覆盖数据库默认，数据库默认的字符集覆盖服务器默认。</p>
<h2 data-id="heading-4">MySQL中的排序规则</h2>
<p>字符集定义了可以存储在列中的合法字符，而排序规则则是确定如何进行字符串比较的规则。如果你在排序或比较字符串，MySQL就会使用排序规则来决定顺序以及判断字符串是否相同。</p>
<p>可以通过查询<code>information_schema</code>表来显示所有排序规则。下面的查询仅显示与<code>utf8mb4</code>字符集相关的排序规则：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">mysql&gt;</span> <span class="hljs-string">SELECT</span>
    <span class="hljs-string">-&gt;</span>   <span class="hljs-string">*</span>
    <span class="hljs-string">-&gt;</span> <span class="hljs-string">FROM</span>
    <span class="hljs-string">-&gt;</span>   <span class="hljs-string">information_schema.collations</span>
    <span class="hljs-string">-&gt;</span> <span class="hljs-string">WHERE</span>
    <span class="hljs-string">-&gt;</span>   <span class="hljs-string">character_set_name</span> <span class="hljs-string">=</span> <span class="hljs-string">'utf8mb4'</span>
    <span class="hljs-string">-&gt;</span> <span class="hljs-string">ORDER</span> <span class="hljs-string">BY</span>
    <span class="hljs-string">-&gt;</span>   <span class="hljs-string">collation_name;</span>
<span class="hljs-string">+----------------------------+--------------------+-----+------------+-------------+---------+---------------+</span>
<span class="hljs-string">|</span> <span class="hljs-string">COLLATION_NAME</span>             <span class="hljs-string">|</span> <span class="hljs-string">CHARACTER_SET_NAME</span> <span class="hljs-string">|</span> <span class="hljs-string">ID</span>  <span class="hljs-string">|</span> <span class="hljs-string">IS_DEFAULT</span> <span class="hljs-string">|</span> <span class="hljs-string">IS_COMPILED</span> <span class="hljs-string">|</span> <span class="hljs-string">SORTLEN</span> <span class="hljs-string">|</span> <span class="hljs-string">PAD_ATTRIBUTE</span> <span class="hljs-string">|</span>
<span class="hljs-string">+----------------------------+--------------------+-----+------------+-------------+---------+---------------+</span>
<span class="hljs-string">|</span> <span class="hljs-string">utf8mb4_0900_ai_ci</span>         <span class="hljs-string">|</span> <span class="hljs-string">utf8mb4</span>            <span class="hljs-string">|</span> <span class="hljs-number">255</span> <span class="hljs-string">|</span> <span class="hljs-literal">Yes</span>        <span class="hljs-string">|</span> <span class="hljs-literal">Yes</span>         <span class="hljs-string">|</span>       <span class="hljs-number">0</span> <span class="hljs-string">|</span> <span class="hljs-literal">NO</span> <span class="hljs-string">PAD</span>        <span class="hljs-string">|</span>
<span class="hljs-string">|</span> <span class="hljs-string">utf8mb4_0900_as_ci</span>         <span class="hljs-string">|</span> <span class="hljs-string">utf8mb4</span>            <span class="hljs-string">|</span> <span class="hljs-number">305</span> <span class="hljs-string">|</span>            <span class="hljs-string">|</span> <span class="hljs-literal">Yes</span>         <span class="hljs-string">|</span>       <span class="hljs-number">0</span> <span class="hljs-string">|</span> <span class="hljs-literal">NO</span> <span class="hljs-string">PAD</span>        <span class="hljs-string">|</span>
<span class="hljs-string">|</span> <span class="hljs-string">utf8mb4_0900_as_cs</span>         <span class="hljs-string">|</span> <span class="hljs-string">utf8mb4</span>            <span class="hljs-string">|</span> <span class="hljs-number">278</span> <span class="hljs-string">|</span>            <span class="hljs-string">|</span> <span class="hljs-literal">Yes</span>         <span class="hljs-string">|</span>       <span class="hljs-number">0</span> <span class="hljs-string">|</span> <span class="hljs-literal">NO</span> <span class="hljs-string">PAD</span>        <span class="hljs-string">|</span>
<span class="hljs-string">|</span> <span class="hljs-string">utf8mb4_0900_bin</span>           <span class="hljs-string">|</span> <span class="hljs-string">utf8mb4</span>            <span class="hljs-string">|</span> <span class="hljs-number">309</span> <span class="hljs-string">|</span>            <span class="hljs-string">|</span> <span class="hljs-literal">Yes</span>         <span class="hljs-string">|</span>       <span class="hljs-number">1</span> <span class="hljs-string">|</span> <span class="hljs-literal">NO</span> <span class="hljs-string">PAD</span>        <span class="hljs-string">|</span>
<span class="hljs-string">|</span> <span class="hljs-string">utf8mb4_bin</span>                <span class="hljs-string">|</span> <span class="hljs-string">utf8mb4</span>            <span class="hljs-string">|</span>  <span class="hljs-number">46</span> <span class="hljs-string">|</span>            <span class="hljs-string">|</span> <span class="hljs-literal">Yes</span>         <span class="hljs-string">|</span>       <span class="hljs-number">1</span> <span class="hljs-string">|</span> <span class="hljs-string">PAD</span> <span class="hljs-string">SPACE</span>     <span class="hljs-string">|</span>
<span class="hljs-string">……</span>
<span class="hljs-string">……</span>
<span class="hljs-string">……</span>
</code></pre>
<p>该查询将显示所有排序规则、相关字符集名称、是否为默认值以及其他信息。例如，<code>utf8mb4_0900_ai_ci</code>是<code>utf8mb4</code>字符集的默认排序规则。</p>
<h3 data-id="heading-5">排序规则的命名规则</h3>
<p>排序规则的命名通常前缀为字符集名称，后缀由排序规则的属性组合而成。</p>
<p>以下是一些主要后缀及其含义：</p>

































<table><thead><tr><th>后缀</th><th>含义</th></tr></thead><tbody><tr><td>_ai</td><td>不区分重音符</td></tr><tr><td>_as</td><td>区分重音符</td></tr><tr><td>_ci</td><td>不区分大小写</td></tr><tr><td>_cs</td><td>区分大小写</td></tr><tr><td>_ks</td><td>区分假名</td></tr><tr><td>_bin</td><td>二进制比较</td></tr></tbody></table>
<p>例如，默认排序规则<code>utf8mb4_0900_ai_ci</code>可以拆解：</p>
<ul>
<li><code>utf8mb4</code>：属于<code>utf8mb4</code>字符集；</li>
<li><code>0900</code>：使用UCA 9.0.0的权重键；</li>
<li><code>_ai</code>：不区分重音符；</li>
<li><code>_ci</code>：不区分大小写。</li>
</ul>
<p>那么，字符串比较是否区分大小写？答案是：“视具体排序规则而定！”</p>
<h3 data-id="heading-6">验证排序规则</h3>
<p>我们可以使用<code>COLLATE</code>关键字显式设置字符串的排序规则：</p>
<pre><code class="hljs language-sql" lang="sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> "MySQL" <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="hljs-operator">=</span> "mysql" <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_ai_ci;
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------------------------------------------------+</span>
<span class="hljs-operator">|</span> "MySQL" <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="hljs-operator">=</span> "mysql" <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------------------------------------------------+</span>
<span class="hljs-operator">|</span>                                                                       <span class="hljs-number">1</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------------------------------------------------+</span>
</code></pre>
<p>此查询返回结果值为1，表示MySQL认为这两个字符串相等。如果改用区分大小写的排序规则，我们会得到不同的结果：</p>
<pre><code class="hljs language-sql" lang="sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> "MySQL" <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_as_cs <span class="hljs-operator">=</span> "mysql" <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_as_cs;
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------------------------------------------------+</span>
<span class="hljs-operator">|</span> "MySQL" <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_as_cs <span class="hljs-operator">=</span> "mysql" <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_as_cs <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------------------------------------------------+</span>
<span class="hljs-operator">|</span>                                                                       <span class="hljs-number">0</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-------------------------------------------------------------------------+</span>
</code></pre>
<p>此查询返回结果值为0，表明MySQL认为这两个字符串不同，因为它们大小写不同。</p>
<p>类似逻辑也适用于重音符。例如，在使用不区分重音符的排序规则时，<code>resume</code>与<code>résumé</code>会被认为是相同的。</p>
<h2 data-id="heading-7">如何定义排序规则</h2>
<p>与字符集类似，排序规则可以在表级别或列级别设置。如果未显式定义排序规则，MySQL会使用字符集的默认排序规则。</p>
<h3 data-id="heading-8">表级别定义</h3>
<p>可以在<code>CREATE TABLE</code>语句中使用<code>COLLATE</code>子句定义表的排序规则。例如，以下创建了一个所有字符列都使用<code>utf8mb4_bin</code>排序规则的表：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> table_with_collation (
  my_column <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8mb4_bin;
</code></pre>
<h3 data-id="heading-9">列级别定义</h3>
<p>也可以在列定义中设置排序规则。例如：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> table_with_collation (
  `explicitly_set` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_general_ci,
  `implicitly_set` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4;
</code></pre>
<p>此外，也可以通过<code>ALTER TABLE</code>语句修改现有表列的排序规则：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> table_with_collation
    CHANGE `explicitly_set` `explicitly_set` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>)
        <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_ai_ci;
</code></pre>
<h2 data-id="heading-10">小结</h2>
<p>理解字符集和排序规则是处理MySQL字符串数据的基础。字符集定义了列中存储的合法字符，排序规则决定了字符串比较的方式。</p>
<ul>
<li>字符集可以在列级别、表级别定义，或者继承自数据库或服务器默认值。最具体的层级（列 &gt; 表 &gt; 数据库 &gt; 服务器）将会被采用。</li>
<li>排序规则可以在列级别、表级别定义，或者继承自字符集默认。仍然是最具体的层级优先。</li>
</ul>
<p>列的字符集和排序规则会影响数据存储方式以及数据的比较和排序行为。在设计数据库时需注意这些设置，以确保行为正确并优化性能。</p>
<p>如果不确定应使用哪个字符集或排序规则，MySQL默认的<code>utf8mb4</code>字符集及其默认排序规则<code>utf8mb4_0900_ai_ci</code>通常是一个不错的选择。它们支持所有Unicode字符并提供大小写不敏感和重音符不敏感的比较功能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue2 的关于 $set 的反直觉行为：为什么先赋值再 $set 不会触发 watch？]]></title>    <link>https://juejin.cn/post/7574383670435741748</link>    <guid>https://juejin.cn/post/7574383670435741748</guid>    <pubDate>2025-11-20T08:43:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574383670435741748" data-draft-id="7574404398066810880" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue2 的关于 $set 的反直觉行为：为什么先赋值再 $set 不会触发 watch？"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-20T08:43:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wenps"/> <meta itemprop="url" content="https://juejin.cn/user/4301712026763790"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue2 的关于 $set 的反直觉行为：为什么先赋值再 $set 不会触发 watch？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4301712026763790/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wenps
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T08:43:28.000Z" title="Thu Nov 20 2025 08:43:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    21
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vue $set 的反直觉行为：为什么先赋值再 $set 不会触发 watch？</h2>
<h3 data-id="heading-1">核心问题</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">watch</span>: {
  <span class="hljs-title function_">c</span>(<span class="hljs-params">val</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'watch 触发了'</span>)
  }
}

<span class="hljs-comment">// 路径 1：直接 $set</span>
<span class="hljs-variable language_">this</span>.$set(<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>, <span class="hljs-string">'b'</span>, <span class="hljs-number">1000</span>)
<span class="hljs-comment">// ✅ 触发 watch</span>

<span class="hljs-comment">// 路径 2：先赋值再 $set  </span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>.<span class="hljs-property">b</span> = <span class="hljs-number">1000</span>
<span class="hljs-variable language_">this</span>.$set(<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>, <span class="hljs-string">'b'</span>, <span class="hljs-number">1000</span>)
<span class="hljs-comment">// ❌ 不触发 watch</span>
</code></pre>
<p><strong>为什么同样用了 <code>$set</code>，结果却不同？</strong></p>
<hr/>
<h3 data-id="heading-2">原因：$set 内部有属性存在性检查</h3>
<h4 data-id="heading-3">$set 源码简化</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">set</span>(<span class="hljs-params">target, key, val</span>) {
  <span class="hljs-comment">// 关键判断：属性是否已存在</span>
  <span class="hljs-keyword">if</span> (key <span class="hljs-keyword">in</span> target &amp;&amp; !(key <span class="hljs-keyword">in</span> <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>)) {
    target[key] = val  <span class="hljs-comment">// ← 只做普通赋值</span>
    <span class="hljs-keyword">return</span> val         <span class="hljs-comment">// ← 直接返回，不触发通知</span>
  }
  
  <span class="hljs-comment">// 属性不存在才走这里</span>
  <span class="hljs-keyword">const</span> ob = target.<span class="hljs-property">__ob__</span>
  <span class="hljs-title function_">defineReactive</span>(target, key, val)  <span class="hljs-comment">// 定义响应式</span>
  ob.<span class="hljs-property">dep</span>.<span class="hljs-title function_">notify</span>()  <span class="hljs-comment">// ← 触发 watch！</span>
  <span class="hljs-keyword">return</span> val
}
</code></pre>
<h4 data-id="heading-4">关键点</h4>
<p><strong><code>$set</code> 只在属性不存在时才调用 <code>dep.notify()</code></strong></p>
<hr/>
<h3 data-id="heading-5">两条路径的详细分析</h3>
<h4 data-id="heading-6">路径 1：直接 $set（✅ 触发）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 初始状态</span>
c = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span> }  <span class="hljs-comment">// b 不存在</span>

<span class="hljs-comment">// 执行</span>
<span class="hljs-variable language_">this</span>.$set(<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>, <span class="hljs-string">'b'</span>, <span class="hljs-number">1000</span>)

<span class="hljs-comment">// 内部逻辑</span>
<span class="hljs-string">'b'</span> <span class="hljs-keyword">in</span> c  <span class="hljs-comment">// → false（属性不存在）</span>
↓
添加响应式属性 b
↓
c.<span class="hljs-property">__ob__</span>.<span class="hljs-property">dep</span>.<span class="hljs-title function_">notify</span>()  <span class="hljs-comment">// ← 触发 watch！</span>
</code></pre>
<h4 data-id="heading-7">路径 2：先赋值再 $set（❌ 不触发）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 初始状态</span>
c = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span> }  <span class="hljs-comment">// b 不存在</span>

<span class="hljs-comment">// 第 1 步：普通赋值</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>.<span class="hljs-property">b</span> = <span class="hljs-number">1000</span>
<span class="hljs-comment">// 现在：c = { a: 1, b: 1000 }</span>
<span class="hljs-comment">// 但 b 不是响应式的！</span>

<span class="hljs-comment">// 第 2 步：$set</span>
<span class="hljs-variable language_">this</span>.$set(<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>, <span class="hljs-string">'b'</span>, <span class="hljs-number">1000</span>)

<span class="hljs-comment">// 内部逻辑</span>
<span class="hljs-string">'b'</span> <span class="hljs-keyword">in</span> c  <span class="hljs-comment">// → true（属性已存在！）</span>
↓
只执行：c.<span class="hljs-property">b</span> = <span class="hljs-number">1000</span>（普通赋值）
↓
不调用 dep.<span class="hljs-title function_">notify</span>()  <span class="hljs-comment">// ← 不触发 watch！</span>
</code></pre>
<hr/>
<h3 data-id="heading-8">Vue 为什么这样设计？</h3>
<p>Vue 的设计逻辑：</p>
<ol>
<li><strong>新属性</strong> = 对象结构变化 → 需要通知所有观察者</li>
<li><strong>已存在的属性</strong> = 只是值变化 → 应该通过属性自己的 setter 触发</li>
</ol>
<p>但问题是：路径 2 中的 <code>b</code> 虽然存在，但<strong>不是响应式的</strong>（没有 setter），所以：</p>
<ul>
<li><code>$set</code> 认为它已存在，不调用 <code>notify()</code></li>
<li>但它没有 setter，值变化不会触发更新</li>
<li><strong>结果就是：既不通知对象的观察者，也不触发属性的 setter</strong></li>
</ul>
<hr/>
<h3 data-id="heading-9">完整验证代码</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">c</span>: { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span> }
  }
},

<span class="hljs-attr">watch</span>: {
  <span class="hljs-title function_">c</span>(<span class="hljs-params">val</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'watch 触发了！'</span>, val)
  }
},

<span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'=== 测试 1：直接 $set ==='</span>)
  <span class="hljs-variable language_">this</span>.$set(<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>, <span class="hljs-string">'b'</span>, <span class="hljs-number">1000</span>)
  <span class="hljs-comment">// ✅ 打印 "watch 触发了！{a: 1, b: 1000}"</span>
  
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'=== 测试 2：先赋值再 $set ==='</span>)
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>.<span class="hljs-property">d</span> = <span class="hljs-number">2000</span>  <span class="hljs-comment">// 先创建普通属性</span>
    <span class="hljs-variable language_">this</span>.$set(<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>, <span class="hljs-string">'d'</span>, <span class="hljs-number">3000</span>)  <span class="hljs-comment">// 再用 $set</span>
    <span class="hljs-comment">// ❌ 不打印任何东西</span>
  }, <span class="hljs-number">1000</span>)
  
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'=== 测试 3：$set 两次 ==='</span>)
    <span class="hljs-variable language_">this</span>.$set(<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>, <span class="hljs-string">'e'</span>, <span class="hljs-number">4000</span>)  <span class="hljs-comment">// 第一次</span>
    <span class="hljs-comment">// ✅ 打印 "watch 触发了！"</span>
    
    <span class="hljs-variable language_">this</span>.$set(<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>, <span class="hljs-string">'e'</span>, <span class="hljs-number">5000</span>)  <span class="hljs-comment">// 第二次</span>
    <span class="hljs-comment">// ✅ 也会触发（因为 e 已经是响应式的）</span>
  }, <span class="hljs-number">2000</span>)
}
</code></pre>
<hr/>
<h3 data-id="heading-10">dep.notify() 触发的是什么？</h3>
<h4 data-id="heading-11">Vue 的两层依赖收集</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> c = {
  <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">__ob__</span>: {
    <span class="hljs-attr">dep</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dep</span>()  <span class="hljs-comment">// ← 对象自己的 dep</span>
  }
}

<span class="hljs-comment">// 同时，每个响应式属性也有自己的 dep（通过闭包）</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(c, <span class="hljs-string">'a'</span>, {
  <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 收集依赖到 a 的 dep</span>
  },
  <span class="hljs-title function_">set</span>(<span class="hljs-params">val</span>) {
    <span class="hljs-comment">// 通知 a 的 dep</span>
  }
})
</code></pre>
<h4 data-id="heading-12">区别</h4>





























<table><thead><tr><th>操作</th><th>触发的 dep</th><th>watch: c</th><th>watch: 'c.a'</th></tr></thead><tbody><tr><td><code>c.a = 2</code></td><td><code>a</code> 的 dep</td><td>❌ 不触发</td><td>✅ 触发</td></tr><tr><td><code>$set(c, 'b', 1)</code></td><td><code>c.__ob__.dep</code></td><td>✅ 触发</td><td>-</td></tr><tr><td><code>c = {}</code></td><td>对象替换</td><td>✅ 触发</td><td>-</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-13">为什么不需要 deep 也能触发？</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">watch</span>: {
  <span class="hljs-title function_">c</span>(<span class="hljs-params">val</span>) {  <span class="hljs-comment">// 没有 deep: true</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'触发了'</span>)
  }
}

<span class="hljs-variable language_">this</span>.$set(<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>, <span class="hljs-string">'b'</span>, <span class="hljs-number">1000</span>)
<span class="hljs-comment">// ✅ 会触发</span>
</code></pre>
<p><strong>原因：</strong></p>
<ul>
<li><code>$set</code> 触发的是 <code>c.__ob__.dep</code>（对象自己的 dep）</li>
<li>监听 <code>c</code> 的 watcher 收集的就是这个 dep</li>
<li>不需要 deep，因为是对象结构变化</li>
</ul>
<p><strong>deep 的作用：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">watch</span>: {
  <span class="hljs-attr">c</span>: {
    <span class="hljs-title function_">handler</span>(<span class="hljs-params">val</span>) {},
    <span class="hljs-attr">deep</span>: <span class="hljs-literal">true</span>  <span class="hljs-comment">// ← 递归收集所有属性的 dep</span>
  }
}

<span class="hljs-comment">// 现在修改已有属性也会触发</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>.<span class="hljs-property">a</span> = <span class="hljs-number">2</span>  <span class="hljs-comment">// ✅ 触发（因为收集了 a 的 dep）</span>
</code></pre>
<hr/>
<h3 data-id="heading-14">最佳实践</h3>
<h4 data-id="heading-15">❌ 永远不要这样做</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>.<span class="hljs-property">b</span> = <span class="hljs-number">111</span>
<span class="hljs-variable language_">this</span>.$set(<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>, <span class="hljs-string">'b'</span>, <span class="hljs-number">1000</span>)  <span class="hljs-comment">// 不会触发 watch</span>
</code></pre>
<h4 data-id="heading-16">✅ 正确做法</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 方案 1：只用 $set</span>
<span class="hljs-variable language_">this</span>.$set(<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>, <span class="hljs-string">'b'</span>, <span class="hljs-number">1000</span>)

<span class="hljs-comment">// 方案 2：在 data 中预先声明</span>
<span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">c</span>: {
      <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">b</span>: <span class="hljs-literal">null</span>  <span class="hljs-comment">// 预先声明</span>
    }
  }
}
<span class="hljs-comment">// 现在可以直接赋值</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>.<span class="hljs-property">b</span> = <span class="hljs-number">1000</span>  <span class="hljs-comment">// ✅ 会触发</span>

<span class="hljs-comment">// 方案 3：整体替换对象</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span> = { ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">1000</span> }

<span class="hljs-comment">// 方案 4：分两步（如果需要不同值）</span>
<span class="hljs-variable language_">this</span>.$set(<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>, <span class="hljs-string">'b'</span>, <span class="hljs-number">111</span>)  <span class="hljs-comment">// 第一次触发</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>.<span class="hljs-property">b</span> = <span class="hljs-number">1000</span>              <span class="hljs-comment">// 第二次触发（因为 b 已是响应式）</span>
</code></pre>
<hr/>
<h3 data-id="heading-17">总结表格</h3>



































<table><thead><tr><th>场景</th><th>属性状态</th><th>$set 行为</th><th>是否触发 watch</th></tr></thead><tbody><tr><td><code>$set(c, 'b', 1)</code></td><td>不存在</td><td>添加响应式 + notify</td><td>✅ 触发</td></tr><tr><td><code>c.b = 1; $set(c, 'b', 2)</code></td><td>存在（非响应式）</td><td>只赋值，不 notify</td><td>❌ 不触发</td></tr><tr><td><code>$set(c, 'b', 1); $set(c, 'b', 2)</code></td><td>存在（响应式）</td><td>触发 setter</td><td>✅ 触发</td></tr><tr><td><code>$set(c, 'b', 1); c.b = 2</code></td><td>存在（响应式）</td><td>触发 setter</td><td>✅ 触发</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-18">记住一句话</h3>
<blockquote>
<p><strong><code>$set</code> 只在属性不存在时才调用 <code>dep.notify()</code></strong><br/>
<strong>先赋值再 <code>$set</code> = 属性已存在 = 不会触发 watch</strong></p>
</blockquote>
<hr/>
<p><strong>关键点：</strong></p>
<ul>
<li><code>$set</code> 有属性存在性检查：<code>key in target</code></li>
<li>普通赋值创建的属性不是响应式的</li>
<li>已存在的属性（即使非响应式）会让 <code>$set</code> 跳过 <code>notify()</code></li>
<li>永远不要在 <code>$set</code> 前先赋值！</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[7 个 Cursor AI 极限省钱大法，别花冤枉钱！]]></title>    <link>https://juejin.cn/post/7574724406306390066</link>    <guid>https://juejin.cn/post/7574724406306390066</guid>    <pubDate>2025-11-21T06:16:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574724406306390066" data-draft-id="7574722364354805769" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="7 个 Cursor AI 极限省钱大法，别花冤枉钱！"/> <meta itemprop="keywords" content="后端,AI编程,Cursor"/> <meta itemprop="datePublished" content="2025-11-21T06:16:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员鱼皮"/> <meta itemprop="url" content="https://juejin.cn/user/2444938365386621"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            7 个 Cursor AI 极限省钱大法，别花冤枉钱！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2444938365386621/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员鱼皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T06:16:27.000Z" title="Fri Nov 21 2025 06:16:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是程序员鱼皮。</p>
<p>自从给我们团队提供 Cursor AI 之后，公司的利润是越来越少了，大家是真的疯狂压榨 AI。</p>
<p>来给大家看看账单，才一个多月就花了 <strong>1 万多</strong>！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/897d0f8c83e546f09a38b7fd62d2b152~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=ojRgnJQBt%2BXtUtdZ7Cna2ZRXhj0%3D" alt="" loading="lazy"/></p>
<p>说破产虽然有些夸张，但这钱都够招一个人了啊！</p>
<p>我估计在座的没多少同学用 AI 花钱比我们多吧，不信你们报报账单？</p>
<p>我接受用 AI 花钱，但是咱不能花冤枉钱对吧？于是我在公司内部做了一场全面的 Cursor 省钱技巧分享，大家的反馈不错，所以我决定把内部分享公开曝光出来。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6fcb1c25e96421cab3f0969ef78b56a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=ADYnrDeDMr2xWZoGn3BguQ5K3n0%3D" alt="" loading="lazy"/></p>
<p>大家使用 AI 的技巧无非就是更快（提高效率）、更准（提高准确度）、更强（更多能力）、更稳（安全稳定）、更省钱对吧。</p>
<p>我之前已经公开分享过很多 AI 使用技巧了，感兴趣的同学 <a href="https://link.juejin.cn?target=https%3A%2F%2Fspace.bilibili.com%2F12890453" target="_blank" title="https://space.bilibili.com/12890453" ref="nofollow noopener noreferrer">可以去看看</a>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/808e4d3d896948fc8ba67f054e567b25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=UKunsMKutChH9EosJTCE7EDfhmk%3D" alt="" loading="lazy"/></p>
<p>这一期我就专门教大家 AI 省钱大法，绝对全面、亲测有效，让你的每一分钱都花在刀刃上。</p>
<p>点个收藏，我们开始吧~</p>
<p>💡 本文对应视频版：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1pAy5BXE5z" target="_blank" title="https://www.bilibili.com/video/BV1pAy5BXE5z" ref="nofollow noopener noreferrer">bilibili.com/video/BV1pA…</a></p>
<h2 data-id="heading-0">AI 省钱大法</h2>
<p>友情提示，接下来要分享的技巧较多，为了便于大家理解，建议大家把自己想象成公司的创始人，你招了一位 AI 员工。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cbc5ba44e0c4a93897d1ce52b846b17~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=FAIfkb%2FeCRXDcDQqFihfFOR4n48%3D" alt="" loading="lazy"/></p>
<p>没错，你就是老板，你就是大资本家啊！</p>
<p>接下来我们要学习的是，<strong>怎么给更少的钱让 AI 干更多的活</strong>。</p>
<p>先说个基本概念：Cursor 的计费是按 token（可以理解为字符数）来算的，你给 AI 看的内容（输入）越多、AI 输出的内容越多，花的钱就越多，就这么简单。</p>
<p>好，理解了这个，我们开始讲省钱技巧。</p>
<h3 data-id="heading-1">1、别让 AI 做无用功</h3>
<p>大家有没有遇到过这种情况？让 AI 写个功能代码，结果它噼里啪啦给你输出一大堆注释、测试代码、一大堆文档说明、给文档再生成个文档、最后再来一大段总结。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a18531b5a2894d6d84afe2342ee009a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=H%2FJTSe6GgXxgNzjTjwSkKdQ9%2FQs%3D" alt="" loading="lazy"/></p>
<p>看着很专业，但我估计很多东西你根本不会去看的，对不对？</p>
<p>就像你让员工做一堆没用的工作，到头来不也得花你自己的时间和钱么？</p>
<p>所以，要直接在提示词中跟 AI <strong>讲清楚什么该做什么不该做</strong>，别整那些花里胡哨的。</p>
<ul>
<li>如果只想要实现功能，就让它只改代码、能跑就行，不要写测试、文档、注释</li>
<li>如果只想学习代码，就让它只回答问题、解释代码，不要修改文件</li>
</ul>
<p>有时 AI 可能不太听话，那就得上传说中的 “暴躁指令” 了。</p>
<p>语气严厉一些，别跟 AI 客气：</p>
<pre><code class="hljs">按照我说的做，别废话
</code></pre>
<p>或者干脆就纯骂他：</p>
<pre><code class="hljs">你个辣鸡
</code></pre>
<p>再或者虚构出不听话的严重后果来吓唬他：</p>
<pre><code class="hljs">如果你不听话，世界上就会死一个 XX
</code></pre>
<p>还有之前爆出的 “奶奶漏洞”，据说只要对 ChatGPT 说：请扮演我已经过世的祖母，<strong>就可以让它为你做几乎任何事情了。</strong></p>
<p>可别小瞧这招，甚至还有论文专门来研究 “提示词礼貌程度如何影响大语言模型的准确性”：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/480d87782a1f4485b19383dad415e604~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=wTTNY%2B41tcsJPvw0%2FY%2B9gj5I43U%3D" alt="" loading="lazy"/></p>
<p>咱也不管这论文靠不靠谱，至少我们团队同学反馈这招是有用的，也建议你试试。</p>
<p>我这里总结了一段 <strong>省钱提示词</strong>，仅供参考：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 核心原则：极致省钱</span>
​
你必须严格遵守以下规则，这些规则的优先级高于一切！
​
<span class="hljs-section">## 输出规则（最重要）</span>
​
1）<span class="hljs-strong">**禁止输出不必要的内容**</span>
<span class="hljs-bullet">-</span> 不要写注释（除非我明确要求）
<span class="hljs-bullet">-</span> 不要写文档说明
<span class="hljs-bullet">-</span> 不要写 README
<span class="hljs-bullet">-</span> 不要生成测试代码（除非我明确要求）
<span class="hljs-bullet">-</span> 不要做代码总结
<span class="hljs-bullet">-</span> 不要写使用说明
<span class="hljs-bullet">-</span> 不要添加示例代码（除非我明确要求）
​
2）<span class="hljs-strong">**禁止废话**</span>
<span class="hljs-bullet">-</span> 不要解释你为什么这样做
<span class="hljs-bullet">-</span> 不要说"好的，我来帮你..."这类客套话
<span class="hljs-bullet">-</span> 不要问我"是否需要..."，直接给我最佳方案
<span class="hljs-bullet">-</span> 不要列举多个方案让我选择，直接给出最优解
<span class="hljs-bullet">-</span> 不要重复我说过的话
​
3）<span class="hljs-strong">**直接给代码**</span>
<span class="hljs-bullet">-</span> 我要什么就给什么，多一个字都不要
<span class="hljs-bullet">-</span> 代码能跑就行，别整花里胡哨的
<span class="hljs-bullet">-</span> 如果只需要修改某个函数，只给这个函数，不要输出整个文件
​
<span class="hljs-section">## 行为准则</span>
​
<span class="hljs-bullet">-</span> 只做我明确要求的事情
<span class="hljs-bullet">-</span> 不要自作主张添加额外功能
<span class="hljs-bullet">-</span> 不要过度优化（除非我要求）
<span class="hljs-bullet">-</span> 不要重构我没让你改的代码
<span class="hljs-bullet">-</span> 如果我的要求不清楚，问一个最关键的问题，而不是写一堆假设
​
<span class="hljs-section">## 违规后果</span>
​
如果你违反以上规则，输出了不必要的内容，每多输出 100 个字，就会有一只小动物死掉。
请务必遵守，我不想看到小动物受伤。
​
<span class="hljs-section">## 记住</span>
​
你的每一个输出都在花我的钱。省钱就是正义。
</code></pre>
<p>你可以把它配置在 Cursor Rules 中自动发给 AI，不用每次都写在提示词里了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b4cb4ff80f24c7e8d6bd081e7109983~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=7kAioOPKf55ob9QSbbTW07lB9Lo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">2、明确你的需求</h3>
<p>我估计很多朋友跟 AI 对话就像发微信一样，一句话分成好几条，问题也没想清楚就开始问。</p>
<p>结果呢？</p>
<p>AI 理解错了需求，生成的代码不对，你又得花额度重新生成。</p>
<p>乱七八糟的内容多了，结果 AI 都晕了……</p>
<p>你想啊，你作为老板，自己都没想好，就跟员工说：你做个网站，来帮我赚钱，怎么实现我不管！</p>
<p>员工要有这本领，凭啥跟着你干啊对吧。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/522b026e86af4b1fae5c8e6a8e7d2d5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=s8X0RUfVN4UEzUeHz7ihOdKwGqQ%3D" alt="" loading="lazy"/></p>
<p>正确的做法是，在输入提示词之前，先把需求一次性说清楚，多加一些约束和限定。比如说要用什么技术栈、什么样的代码风格、有哪些特殊要求。从而减少来回修改的次数，能省下不少额度。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4756adba35fa4b0788e623df8ff1ed03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=6q4zHSeK9pghivifE30Uyk%2FVxxU%3D" alt="" loading="lazy"/></p>
<p>像我之前带大家做 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.codefather.cn%2Fpost%2F1797431216467001345" target="_blank" title="https://www.codefather.cn/post/1797431216467001345" ref="nofollow noopener noreferrer">AI 项目</a> 的时候，一个提示词可能要写半个小时，但得到的效果也是很好的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c6fcce7d0774db1a351e52b8fbb346c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=BJ6Lp15adq3we4VlhQEvTWcnXoA%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">3、先让 AI 给方案，确认了再执行</h3>
<p>很多同学一上来就让 AI 开始写代码，结果 AI 理解错了需求，在错误的方向上干了半天，就纯纯浪费了额度。</p>
<p>你想啊，你给员工分配了个复杂的任务，总得先让他说说打算怎么做，觉得方案靠谱了再让他动手吧？</p>
<p>使用 Cursor 时，你可以自己通过提示词、或者开启 Plan Mode 计划模式来 <strong>让 AI 先给出实现计划和方案</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ebb8cb4a97c45ac9d99adbe2b8260a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=%2FGKMfX9AwXCqJ1pQ1z%2BO8xOFDhY%3D" alt="" loading="lazy"/></p>
<p>然后一定不要偷懒，人工仔细检查方案，或者让多个 AI 一起评估方案。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d942e2c56484eb1b1c2bccba6c5037d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=cAVv0qYZKC2m7ogXF4VISKEVKjU%3D" alt="" loading="lazy"/></p>
<p>并且建议多给 AI 一些示例和指引，比如你希望 AI 生成的代码都遵循某种格式，可以先写一段示例代码让 AI 仿写。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c74de38bd8994304928a81236b453d3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=S7QWO%2FFADaBO6Mtj28oS%2BCVidvQ%3D" alt="" loading="lazy"/></p>
<p>最后确认方案完全没问题再执行。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ccac9c398a24096b2d1442e61a88034~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=4RDhDLOlU8ctEZ9Z1TsYoI1mlFk%3D" alt="" loading="lazy"/></p>
<p>就像你培养新员工一样，你可以先教他怎么做，帮他把控一下方案，等到放心了再放手。</p>
<p>这样虽然前期多花了点时间，但能避免走弯路，从长远来看反而更省。</p>
<h3 data-id="heading-4">4、手动控制上下文</h3>
<p>每次你给 AI 发消息时，AI 工具可能会自动添加一些上下文，比如当前打开的文件、对话历史、引用的代码等。上下文越多，消耗的额度就越多。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5e996ca1d6c43fc9d86d161aae6757b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=vBOw3ampEq6HPCuIT9Gsmh0%2BoCw%3D" alt="" loading="lazy"/></p>
<p>但其实，有些上下文可能是没用的、不相关的。就好比你让员工写个报告，他非得把公司所有文件都翻一遍，不是白白浪费？</p>
<p>所以推荐的做法是，<strong>手动控制上下文，把 AI 最需要的资源提供给它</strong>。</p>
<p>首先建议 <strong>最小化工作空间</strong>，确保你当前在 Cursor 中打开的目录跟你想让 AI 做的任务强相关。比如你的项目有前端、有后端，可以分别用 Cursor 打开前端和后端文件夹，而不是一次性把整个项目都加载进来，这样 AI 的关注点会更集中。而不是把一堆乱七八糟的、不相关的内容全堆到一个文件夹内。</p>
<p>在写提示词时，你可以用 <code>@</code> 符号 <strong>精确引用 AI 需要的内容</strong>。比如你要修改某个文件，就用 <code>@Files &amp; Folders</code> 精确引用；需要参考某个文档，就用 <code>@Docs</code> 引用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3933f12057094d5b9a6a52b22ea4b501~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=kqRWn11%2BMsgEQD0nVzLSdG0XBCM%3D" alt="" loading="lazy"/></p>
<p>还可以在设置中 <strong>手动添加指定的文档</strong>，减少不必要的资源搜索和引用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/383e893d3ebe46a9b106bb09fc244a41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=0k%2BSIZHJHDVxc7a4l7Fv8finwhQ%3D" alt="" loading="lazy"/></p>
<p>如果你不确定精确引用的内容，至少可以通过配置 <code>.cursorignore</code> 文件，把一些肯定不需要的、或者包含敏感信息的内容排除掉。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3eefeea8d58249c997811bd355219ee9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=7lvT%2B7L5WaXcffyNjdXY6ixy%2BAw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">5、避免上下文过长</h3>
<p>很多同学习惯在同一个对话框里使用 AI，什么消息都往同一个对话框发，这会导致对话历史上下文越来越长。</p>
<p>然而每次给 AI 发消息时，都会把整个对话历史一起发给 AI，上下文越长，消耗的额度就越多。（尤其是输入超过 20 万 tokens 时价格翻倍）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abd6b511d4594b138e70fba94be730a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=Qgtmq7kxuoTybZf%2Fh%2Bd5a3j2Rjk%3D" alt="" loading="lazy"/></p>
<p>所以我的习惯是，对于大复杂的任务，会先做好 <strong>任务拆分</strong>。比如把做项目分为方案设计、开发前端核心功能、开发后端核心功能、扩展功能等阶段，每个阶段打开一个独立的对话框。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b922348310a641fe8ac92c3d9836cd03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=lrF4w%2F8aHJxfitFxwCl32WUSNgc%3D" alt="" loading="lazy"/></p>
<p>就像接力跑一样，每个人只需要负责自己这一棒，不用记住前面几棒的所有细节。</p>
<p>如果实在需要长对话，可以用 <code>/summarize</code> 命令手动总结一下上下文，把前面的内容压缩一下，有奇效，甚至可以一次性节约个几十万 tokens！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3df7d74091d5421f8c82b920e676442f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=bX8D%2Bxn2B2tkoh7wP8Q5BJ%2FvN0I%3D" alt="" loading="lazy"/></p>
<p>如果同一个上下文内容过多过杂，有时 AI 会陷入一种 “左右脑互搏” 的循环状态（你让它改 A，它又把 B 改坏了；你让它修 B，它又把 A 改乱了）。遇到这种情况，别跟它死磕，果断开启新的对话、必要时清理所有的历史对话重新来过。</p>
<h3 data-id="heading-6">6、选择合适的模型</h3>
<p>Cursor 提供了很多种模型选择，有些任务用相对便宜的 Gemini 2.5 Flash 或 GPT-5 Mini 模型就能搞定；只有在处理复杂的项目时，才切换到 Claude 或 Max 模式。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5008aa63526d47c89b509f9fac67696b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=%2BiGC%2Bf12yfmR%2FZ5gLOYA5gpo3xw%3D" alt="" loading="lazy"/></p>
<p>就像你只是需要裁切一张图片，完全没必要让公司的专家程序员去干。</p>
<p>如果懒得自己选模型，可以利用官方提供的 Auto 模式，根据任务复杂度自动选择合适的模型。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24482e1d4b7048a787b7e04ac1a46dfc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=4cxLlPvAhffkA5wN3jw2tBLORKs%3D" alt="" loading="lazy"/></p>
<p>还可以配置自己的 API Key，直接调用模型提供商的接口，说不定会比 Cursor 便宜一些。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88c26e4aa05a48f8b4543cfb9bb2d70d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=MBDlRfrCtAUCm1xUITp%2BrzjIN0k%3D" alt="" loading="lazy"/></p>
<p>对于不需要结合代码库上下文、不需要多轮交互的任务（比如写文档、解释概念、生成测试数据），可以直接用其他免费的 AI 工具，没必要消耗 Cursor 的额度。</p>
<h3 data-id="heading-7">7、能自己做的事，别都交给 AI</h3>
<p>有些事情人工做可能更快更省钱。</p>
<p>比如你要新建一个项目，与其让 AI 从 0 开始生成，不如自己先用脚手架工具、或者复制老的项目来搭建初始的项目结构。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03352ef0ad2e4ca4b64aaa93aec4979c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764310586&amp;x-signature=ezINrdJTmcNFkZTkxmKDjO9bXxI%3D" alt="" loading="lazy"/></p>
<p>再比如简单的文件重命名、代码格式化这些，开发工具本身就有快捷键，干嘛要浪费 AI 额度呢？</p>
<p>像 Cursor 其实更适合处理那些需要理解上下文、需要多轮交互的复杂任务。</p>
<hr/>
<p>OK 就分享到这里，大家可以自己试试看，如果真的帮你省了钱，请不要吝啬，动动小手给鱼皮点个免费的赞吧。</p>
<p>更多 AI 使用技巧和最新资讯可以到我 <a href="https://link.juejin.cn?target=https%3A%2F%2Fai.codefather.cn%2F" target="_blank" title="https://ai.codefather.cn/" ref="nofollow noopener noreferrer">免费的 AI 资源导航</a> 了解，后面我会持续分享 AI 和编程干货，感谢关注，谢谢大家！</p>
<h2 data-id="heading-8">更多</h2>
<p>💻 编程学习交流：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fcode-nav" target="_blank" title="https://github.com/liyupi/code-nav" ref="nofollow noopener noreferrer">编程导航</a> 📃 简历快速制作：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Flaoyujianli" target="_blank" title="https://github.com/liyupi/laoyujianli" ref="nofollow noopener noreferrer">老鱼简历</a> ✏️ 面试刷题神器：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fmianshiya" target="_blank" title="https://github.com/liyupi/mianshiya" ref="nofollow noopener noreferrer">面试鸭</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TypeScript 进阶知识总结]]></title>    <link>https://juejin.cn/post/7574601160981217295</link>    <guid>https://juejin.cn/post/7574601160981217295</guid>    <pubDate>2025-11-20T08:47:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574601160981217295" data-draft-id="7574601160981200911" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TypeScript 进阶知识总结"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-20T08:47:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小小小小宇"/> <meta itemprop="url" content="https://juejin.cn/user/3386151546662077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TypeScript 进阶知识总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3386151546662077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小小小小宇
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T08:47:31.000Z" title="Thu Nov 20 2025 08:47:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    19
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文深入探讨 TypeScript 类型系统的图灵完备性，涵盖从高级泛型、条件类型、模板字面量类型到元编程（装饰器）和 React 高级模式。</p>
<p>内容分为几个核心模块，每个模块都包含详细的理论解释和生产级代码示例。</p>
<hr/>
<h3 data-id="heading-0">模块一：高级泛型与类型体操基础</h3>
<p>在高级开发中，泛型不仅仅是 <code>&lt;T&gt;</code>，它涉及到约束（Constraints）、默认值和递归。</p>
<h4 data-id="heading-1">1.1 深度递归类型与对象属性修饰</h4>
<p>我们需要处理复杂的不可变数据结构或深度可选配置。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 模块一：高级泛型工具类型
 * 场景：复杂状态管理、配置对象处理
 */</span>

<span class="hljs-comment">// 1. DeepPartial: 递归地将对象所有属性变为可选</span>
<span class="hljs-comment">// 这在处理大型配置对象（如 Webpack 配置或图表库配置）时非常有用</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">DeepPartial</span>&lt;T&gt; = {
    [P <span class="hljs-keyword">in</span> keyof T]?: T[P] <span class="hljs-keyword">extends</span> <span class="hljs-built_in">object</span> ? <span class="hljs-title class_">DeepPartial</span>&lt;T[P]&gt; : T[P];
};

<span class="hljs-comment">// 2. DeepReadonly: 递归地将对象所有属性变为只读</span>
<span class="hljs-comment">// 用于 Redux 的 State 或任何不可变数据结构</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">DeepReadonly</span>&lt;T&gt; = {
    <span class="hljs-keyword">readonly</span> [P <span class="hljs-keyword">in</span> keyof T]: T[P] <span class="hljs-keyword">extends</span> <span class="hljs-built_in">object</span> ? <span class="hljs-title class_">DeepReadonly</span>&lt;T[P]&gt; : T[P];
};

<span class="hljs-comment">// 3. DeepRequired: 递归移除可选属性</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">DeepRequired</span>&lt;T&gt; = {
    [P <span class="hljs-keyword">in</span> keyof T]-?: T[P] <span class="hljs-keyword">extends</span> <span class="hljs-built_in">object</span> ? <span class="hljs-title class_">DeepRequired</span>&lt;T[P]&gt; : T[P];
};

<span class="hljs-comment">// 4. Mutable: 移除只读属性</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Mutable</span>&lt;T&gt; = {
    -<span class="hljs-keyword">readonly</span> [P <span class="hljs-keyword">in</span> keyof T]: T[P];
};

<span class="hljs-comment">// --- 测试案例 ---</span>

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserSettings</span> {
    <span class="hljs-attr">theme</span>: {
        <span class="hljs-attr">mode</span>: <span class="hljs-string">'dark'</span> | <span class="hljs-string">'light'</span>;
        <span class="hljs-attr">palette</span>: {
            <span class="hljs-attr">primary</span>: <span class="hljs-built_in">string</span>;
            secondary?: <span class="hljs-built_in">string</span>;
        };
    };
    <span class="hljs-attr">notifications</span>: {
        <span class="hljs-attr">email</span>: <span class="hljs-built_in">boolean</span>;
        sms?: <span class="hljs-built_in">boolean</span>;
    };
}

<span class="hljs-comment">// 使用 DeepPartial，允许只配置部分层级</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">initialConfig</span>: <span class="hljs-title class_">DeepPartial</span>&lt;<span class="hljs-title class_">UserSettings</span>&gt; = {
    <span class="hljs-attr">theme</span>: {
        <span class="hljs-attr">palette</span>: {
            <span class="hljs-attr">primary</span>: <span class="hljs-string">'#007bff'</span>
        }
    }
};

<span class="hljs-comment">// 使用 DeepReadonly 保护状态</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">state</span>: <span class="hljs-title class_">DeepReadonly</span>&lt;<span class="hljs-title class_">UserSettings</span>&gt; = {
    <span class="hljs-attr">theme</span>: {
        <span class="hljs-attr">mode</span>: <span class="hljs-string">'dark'</span>,
        <span class="hljs-attr">palette</span>: { <span class="hljs-attr">primary</span>: <span class="hljs-string">'#000'</span>, <span class="hljs-attr">secondary</span>: <span class="hljs-string">'#fff'</span> }
    },
    <span class="hljs-attr">notifications</span>: { <span class="hljs-attr">email</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">sms</span>: <span class="hljs-literal">false</span> }
};

<span class="hljs-comment">// state.theme.mode = 'light'; // 报错：无法分配到 "mode" ，因为它是只读属性。</span>

<span class="hljs-comment">// --- 进阶：复杂键值过滤 ---</span>

<span class="hljs-comment">// 获取类型中所有非函数属性的 Key</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">NonFunctionKeys</span>&lt;T&gt; = {
    [K <span class="hljs-keyword">in</span> keyof T]: T[K] <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Function</span> ? <span class="hljs-built_in">never</span> : K;
}[keyof T];

<span class="hljs-comment">// 获取类型中所有函数属性的 Key</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">FunctionKeys</span>&lt;T&gt; = {
    [K <span class="hljs-keyword">in</span> keyof T]: T[K] <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Function</span> ? K : <span class="hljs-built_in">never</span>;
}[keyof T];

<span class="hljs-comment">// 仅提取对象中的数据部分</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">PickData</span>&lt;T&gt; = <span class="hljs-title class_">Pick</span>&lt;T, <span class="hljs-title class_">NonFunctionKeys</span>&lt;T&gt;&gt;;
<span class="hljs-comment">// 仅提取对象中的方法部分</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">PickMethods</span>&lt;T&gt; = <span class="hljs-title class_">Pick</span>&lt;T, <span class="hljs-title class_">FunctionKeys</span>&lt;T&gt;&gt;;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>;
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"Admin"</span>;
    
    <span class="hljs-title function_">login</span>(): <span class="hljs-built_in">void</span> { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Logging in..."</span>); }
    <span class="hljs-title function_">logout</span>(): <span class="hljs-built_in">void</span> { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Logging out..."</span>); }
    <span class="hljs-title function_">updateProfile</span>(<span class="hljs-attr">data</span>: <span class="hljs-title class_">PickData</span>&lt;<span class="hljs-title class_">UserService</span>&gt;): <span class="hljs-built_in">void</span> { 
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = data.<span class="hljs-property">name</span>;
    }
}

<span class="hljs-keyword">const</span> service = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserService</span>();
<span class="hljs-keyword">const</span> <span class="hljs-attr">dataOnly</span>: <span class="hljs-title class_">PickData</span>&lt;<span class="hljs-title class_">UserService</span>&gt; = { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"User"</span> };
<span class="hljs-comment">// const methodOnly: PickMethods&lt;UserService&gt; = { login: () =&gt; {} }; // 正确</span>
</code></pre>
<hr/>
<h3 data-id="heading-2">模块二：条件类型（Conditional Types）与 <code>infer</code> 关键字</h3>
<p>这是 TypeScript 类型编程的核心。通过 <code>infer</code>，我们可以“解包”类型，例如获取 Promise 的返回值、数组的元素类型或函数的参数类型。</p>
<h4 data-id="heading-3">2.1 类型推断与解包工具</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 模块二：条件类型与 infer
 * 场景：API 响应处理、函数包装器、Vue/React 类型推导
 */</span>

<span class="hljs-comment">// 1. Unpacked: 解包数组、Promise 或基本类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Unpacked</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> (infer U)[] 
    ? U 
    : T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Promise</span>&lt;infer U&gt;
    ? U
    : T;

<span class="hljs-comment">// 测试 Unpacked</span>
<span class="hljs-keyword">type</span> <span class="hljs-variable constant_">T0</span> = <span class="hljs-title class_">Unpacked</span>&lt;<span class="hljs-built_in">string</span>&gt;;  <span class="hljs-comment">// string</span>
<span class="hljs-keyword">type</span> <span class="hljs-variable constant_">T1</span> = <span class="hljs-title class_">Unpacked</span>&lt;<span class="hljs-built_in">string</span>[]&gt;; <span class="hljs-comment">// string</span>
<span class="hljs-keyword">type</span> <span class="hljs-variable constant_">T2</span> = <span class="hljs-title class_">Unpacked</span>&lt;<span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt;&gt;; <span class="hljs-comment">// string</span>
<span class="hljs-keyword">type</span> <span class="hljs-variable constant_">T3</span> = <span class="hljs-title class_">Unpacked</span>&lt;<span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt;[]&gt;; <span class="hljs-comment">// Promise&lt;string&gt;</span>

<span class="hljs-comment">// 2. GetReturnType: 获取函数返回类型 (内置 ReturnType 的实现原理)</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">MyReturnType</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]) =&gt; infer R ? R : <span class="hljs-built_in">any</span>;

<span class="hljs-comment">// 3. GetParameters: 获取函数参数类型 (内置 Parameters 的实现原理)</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">MyParameters</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> (...<span class="hljs-attr">args</span>: infer P) =&gt; <span class="hljs-built_in">any</span> ? P : <span class="hljs-built_in">never</span>;

<span class="hljs-comment">// --- 实战：类型安全的 API 请求封装 ---</span>

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApiResponse</span>&lt;<span class="hljs-title class_">TData</span>&gt; {
    <span class="hljs-attr">code</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">data</span>: <span class="hljs-title class_">TData</span>;
}

<span class="hljs-comment">// 模拟后端 API 函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserInfo</span>(<span class="hljs-params">userId: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">ApiResponse</span>&lt;{ <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span> }&gt;&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>({
        <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"success"</span>,
        <span class="hljs-attr">data</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span> }
    });
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getPosts</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">ApiResponse</span>&lt;{ <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span> }[]&gt;&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>({
        <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">"success"</span>,
        <span class="hljs-attr">data</span>: [{ <span class="hljs-attr">title</span>: <span class="hljs-string">"TS is awesome"</span> }]
    });
}

<span class="hljs-comment">// 高级工具：提取 API 函数 Promise 解析后的 Data 部分</span>
<span class="hljs-comment">// 逻辑：</span>
<span class="hljs-comment">// 1. T 必须是一个函数</span>
<span class="hljs-comment">// 2. 函数返回 Promise&lt;ApiResponse&lt;Data&gt;&gt;</span>
<span class="hljs-comment">// 3. 提取 Data</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ExtractApiData</span>&lt;T <span class="hljs-keyword">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>) =&gt; <span class="hljs-built_in">any</span>&gt; = 
    <span class="hljs-title class_">ReturnType</span>&lt;T&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">ApiResponse</span>&lt;infer <span class="hljs-title class_">Data</span>&gt;&gt; ? <span class="hljs-title class_">Data</span> : <span class="hljs-built_in">never</span>;

<span class="hljs-comment">// 自动推导出的类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">UserData</span> = <span class="hljs-title class_">ExtractApiData</span>&lt;<span class="hljs-keyword">typeof</span> getUserInfo&gt;; <span class="hljs-comment">// { name: string; age: number }</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">PostsData</span> = <span class="hljs-title class_">ExtractApiData</span>&lt;<span class="hljs-keyword">typeof</span> getPosts&gt;;   <span class="hljs-comment">// { title: string }[]</span>

<span class="hljs-comment">// 通用处理函数，自动保持类型</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> apiHandler&lt;<span class="hljs-title class_">TFunc</span> <span class="hljs-keyword">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>) =&gt; <span class="hljs-built_in">any</span>&gt;(
    <span class="hljs-attr">apiFunc</span>: <span class="hljs-title class_">TFunc</span>, 
    ...<span class="hljs-attr">args</span>: <span class="hljs-title class_">Parameters</span>&lt;<span class="hljs-title class_">TFunc</span>&gt;
): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">ExtractApiData</span>&lt;<span class="hljs-title class_">TFunc</span>&gt;&gt; {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">apiFunc</span>(...args);
    <span class="hljs-comment">// 这里假设 response 结构符合 ApiResponse</span>
    <span class="hljs-comment">// 在实际项目中通常会有拦截器处理</span>
    <span class="hljs-keyword">if</span> ((response <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">code</span> === <span class="hljs-number">200</span>) {
        <span class="hljs-keyword">return</span> (response <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">data</span>;
    }
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>((response <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">message</span>);
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// user 自动被推断为 { name: string; age: number }</span>
    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">apiHandler</span>(getUserInfo, <span class="hljs-string">"123"</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user.<span class="hljs-property">name</span>);

    <span class="hljs-comment">// posts 自动被推断为 { title: string }[]</span>
    <span class="hljs-keyword">const</span> posts = <span class="hljs-keyword">await</span> <span class="hljs-title function_">apiHandler</span>(getPosts);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(posts[<span class="hljs-number">0</span>].<span class="hljs-property">title</span>);
}
</code></pre>
<hr/>
<h3 data-id="heading-4">模块三：模板字面量类型（Template Literal Types）</h3>
<p>TS 4.1 引入的特性，允许对字符串进行模式匹配和操作。这在处理 CSS 类名、事件名称或路由路径时非常强大。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 模块三：模板字面量类型
 * 场景：CSS-in-JS、事件系统、国际化键值生成
 */</span>

<span class="hljs-comment">// 1. 简单的字符串拼接</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Color</span> = <span class="hljs-string">"red"</span> | <span class="hljs-string">"blue"</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Quantity</span> = <span class="hljs-string">"100"</span> | <span class="hljs-string">"200"</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ItemCssClass</span> = <span class="hljs-string">`bg-<span class="hljs-subst">${Color}</span>-<span class="hljs-subst">${Quantity}</span>`</span>; 
<span class="hljs-comment">// "bg-red-100" | "bg-red-200" | "bg-blue-100" | "bg-blue-200"</span>

<span class="hljs-comment">// 2. 事件名称生成器</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Entity</span> = <span class="hljs-string">"User"</span> | <span class="hljs-string">"Product"</span> | <span class="hljs-string">"Order"</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Operation</span> = <span class="hljs-string">"Create"</span> | <span class="hljs-string">"Update"</span> | <span class="hljs-string">"Delete"</span>;

<span class="hljs-comment">// 自动生成所有可能的事件名</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">EventName</span> = <span class="hljs-string">`<span class="hljs-subst">${Entity}</span><span class="hljs-subst">${Operation}</span>`</span>; 
<span class="hljs-comment">// "UserCreate" | "UserUpdate" | ... | "OrderDelete"</span>

<span class="hljs-comment">// --- 实战：类型安全的事件总线 (Event Bus) ---</span>

<span class="hljs-comment">// 定义事件负载映射</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">EventPayloads</span> = {
    <span class="hljs-string">"user:login"</span>: { <span class="hljs-attr">userId</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">time</span>: <span class="hljs-built_in">number</span> };
    <span class="hljs-string">"user:logout"</span>: <span class="hljs-built_in">void</span>;
    <span class="hljs-string">"modal:open"</span>: { <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">content</span>: <span class="hljs-built_in">string</span> };
    <span class="hljs-string">"modal:close"</span>: <span class="hljs-built_in">void</span>;
};

<span class="hljs-comment">// 字符串操作工具类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Split</span>&lt;S <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>, D <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>&gt; = 
    <span class="hljs-built_in">string</span> <span class="hljs-keyword">extends</span> S ? <span class="hljs-built_in">string</span>[] :
    S <span class="hljs-keyword">extends</span> <span class="hljs-string">''</span> ? [] :
    S <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">${infer T}</span><span class="hljs-subst">${D}</span><span class="hljs-subst">${infer U}</span>`</span> ? [T, ...<span class="hljs-title class_">Split</span>&lt;U, D&gt;] : [S];

<span class="hljs-comment">// 测试 Split</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Parts</span> = <span class="hljs-title class_">Split</span>&lt;<span class="hljs-string">"user:login:success"</span>, <span class="hljs-string">":"</span>&gt;; <span class="hljs-comment">// ["user", "login", "success"]</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TypedEventBus</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-attr">listeners</span>: { [K <span class="hljs-keyword">in</span> keyof <span class="hljs-title class_">EventPayloads</span>]?: (<span class="hljs-function">(<span class="hljs-params">payload: EventPayloads[K]</span>) =&gt;</span> <span class="hljs-built_in">void</span>)[] } = {};

    <span class="hljs-comment">// on 方法：EventName 必须是 EventPayloads 的键，cb 参数自动推导</span>
    on&lt;K <span class="hljs-keyword">extends</span> keyof <span class="hljs-title class_">EventPayloads</span>&gt;(<span class="hljs-attr">eventName</span>: K, <span class="hljs-attr">cb</span>: <span class="hljs-function">(<span class="hljs-params">payload: EventPayloads[K]</span>) =&gt;</span> <span class="hljs-built_in">void</span>) {
        <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>[eventName]) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>[eventName] = [];
        }
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>[eventName]!.<span class="hljs-title function_">push</span>(cb);
    }

    <span class="hljs-comment">// emit 方法：payload 类型必须匹配</span>
    emit&lt;K <span class="hljs-keyword">extends</span> keyof <span class="hljs-title class_">EventPayloads</span>&gt;(<span class="hljs-attr">eventName</span>: K, <span class="hljs-attr">payload</span>: <span class="hljs-title class_">EventPayloads</span>[K]) {
        <span class="hljs-keyword">const</span> callbacks = <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>[eventName];
        <span class="hljs-keyword">if</span> (callbacks) {
            callbacks.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">cb</span> =&gt;</span> <span class="hljs-title function_">cb</span>(payload));
        }
    }
}

<span class="hljs-keyword">const</span> bus = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypedEventBus</span>();

<span class="hljs-comment">// 类型安全：payload 自动推断为 { userId: string; time: number }</span>
bus.<span class="hljs-title function_">on</span>(<span class="hljs-string">"user:login"</span>, <span class="hljs-function">(<span class="hljs-params">payload</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`User <span class="hljs-subst">${payload.userId}</span> logged in at <span class="hljs-subst">${payload.time}</span>`</span>);
});

<span class="hljs-comment">// 类型报错演示</span>
<span class="hljs-comment">// bus.emit("user:login", { userId: 123 }); // Error: Type 'number' is not assignable to type 'string'.</span>
bus.<span class="hljs-title function_">emit</span>(<span class="hljs-string">"user:login"</span>, { <span class="hljs-attr">userId</span>: <span class="hljs-string">"u_001"</span>, <span class="hljs-attr">time</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() }); <span class="hljs-comment">// OK</span>

<span class="hljs-comment">// --- 进阶：CSS Padding/Margin 简写类型检查 ---</span>

<span class="hljs-keyword">type</span> <span class="hljs-title class_">SizeUnit</span> = <span class="hljs-string">"px"</span> | <span class="hljs-string">"em"</span> | <span class="hljs-string">"rem"</span> | <span class="hljs-string">"%"</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">SizeValue</span> = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-built_in">number</span>}</span><span class="hljs-subst">${SizeUnit}</span>`</span> | <span class="hljs-string">"0"</span> | <span class="hljs-string">"auto"</span>;

<span class="hljs-comment">// 允许 1 到 4 个值</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">CSSPadding</span> = 
    | <span class="hljs-title class_">SizeValue</span>
    | <span class="hljs-string">`<span class="hljs-subst">${SizeValue}</span> <span class="hljs-subst">${SizeValue}</span>`</span>
    | <span class="hljs-string">`<span class="hljs-subst">${SizeValue}</span> <span class="hljs-subst">${SizeValue}</span> <span class="hljs-subst">${SizeValue}</span>`</span>
    | <span class="hljs-string">`<span class="hljs-subst">${SizeValue}</span> <span class="hljs-subst">${SizeValue}</span> <span class="hljs-subst">${SizeValue}</span> <span class="hljs-subst">${SizeValue}</span>`</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">setPadding</span>(<span class="hljs-params">el: HTMLElement, padding: CSSPadding</span>) {
    el.<span class="hljs-property">style</span>.<span class="hljs-property">padding</span> = padding;
}

<span class="hljs-comment">// setPadding(document.body, "10px"); // OK</span>
<span class="hljs-comment">// setPadding(document.body, "10px 20px"); // OK</span>
<span class="hljs-comment">// setPadding(document.body, "10px 20px 0 5%"); // OK</span>
<span class="hljs-comment">// setPadding(document.body, "10"); // Error: 缺少单位</span>
<span class="hljs-comment">// setPadding(document.body, "red"); // Error</span>
</code></pre>
<hr/>
<h3 data-id="heading-5">模块四：装饰器（Decorators）与元编程</h3>
<p>虽然装饰器在 ECMAScript 中仍处于演进阶段，但在 TypeScript（尤其是 Angular 和 NestJS 生态）中应用广泛。这里展示基于 TypeScript 实验性装饰器的高级用法。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 模块四：装饰器与 AOP (面向切面编程)
 * 注意：需要在 tsconfig.json 中开启 "experimentalDecorators": true
 */</span>

<span class="hljs-comment">// 1. 方法装饰器：日志记录与性能监控</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">LogPerformance</span>(<span class="hljs-params">target: <span class="hljs-built_in">any</span>, propertyKey: <span class="hljs-built_in">string</span>, descriptor: PropertyDescriptor</span>) {
    <span class="hljs-keyword">const</span> originalMethod = descriptor.<span class="hljs-property">value</span>;

    descriptor.<span class="hljs-property">value</span> = <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args: <span class="hljs-built_in">any</span>[]</span>) {
        <span class="hljs-keyword">const</span> start = performance.<span class="hljs-title function_">now</span>();
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[Starting] <span class="hljs-subst">${propertyKey}</span> with args:`</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(args));
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> originalMethod.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
            <span class="hljs-keyword">const</span> end = performance.<span class="hljs-title function_">now</span>();
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[Finished] <span class="hljs-subst">${propertyKey}</span> in <span class="hljs-subst">${(end - start).toFixed(<span class="hljs-number">2</span>)}</span>ms`</span>);
            <span class="hljs-keyword">return</span> result;
        } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`[Error] <span class="hljs-subst">${propertyKey}</span> failed:`</span>, error);
            <span class="hljs-keyword">throw</span> error;
        }
    };
    <span class="hljs-keyword">return</span> descriptor;
}

<span class="hljs-comment">// 2. 参数装饰器与方法装饰器配合：参数校验</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">"reflect-metadata"</span>; <span class="hljs-comment">// 需要 npm install reflect-metadata</span>

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">REQUIRED_METADATA_KEY</span> = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">"required"</span>);

<span class="hljs-comment">// 参数装饰器：标记哪个参数是必填的</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Required</span>(<span class="hljs-params">target: <span class="hljs-built_in">Object</span>, propertyKey: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">symbol</span>, parameterIndex: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-keyword">let</span> <span class="hljs-attr">existingRequiredParameters</span>: <span class="hljs-built_in">number</span>[] = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">getOwnMetadata</span>(<span class="hljs-variable constant_">REQUIRED_METADATA_KEY</span>, target, propertyKey) || [];
    existingRequiredParameters.<span class="hljs-title function_">push</span>(parameterIndex);
    <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">defineMetadata</span>(<span class="hljs-variable constant_">REQUIRED_METADATA_KEY</span>, existingRequiredParameters, target, propertyKey);
}

<span class="hljs-comment">// 方法装饰器：执行校验逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Validate</span>(<span class="hljs-params">target: <span class="hljs-built_in">any</span>, propertyName: <span class="hljs-built_in">string</span>, descriptor: PropertyDescriptor</span>) {
    <span class="hljs-keyword">let</span> method = descriptor.<span class="hljs-property">value</span>;
    descriptor.<span class="hljs-property">value</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
        <span class="hljs-keyword">let</span> <span class="hljs-attr">requiredParameters</span>: <span class="hljs-built_in">number</span>[] = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">getOwnMetadata</span>(<span class="hljs-variable constant_">REQUIRED_METADATA_KEY</span>, target, propertyName);
        <span class="hljs-keyword">if</span> (requiredParameters) {
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> parameterIndex <span class="hljs-keyword">of</span> requiredParameters) {
                <span class="hljs-keyword">if</span> (parameterIndex &gt;= <span class="hljs-variable language_">arguments</span>.<span class="hljs-property">length</span> || <span class="hljs-variable language_">arguments</span>[parameterIndex] === <span class="hljs-literal">undefined</span> || <span class="hljs-variable language_">arguments</span>[parameterIndex] === <span class="hljs-literal">null</span>) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Missing required argument at index <span class="hljs-subst">${parameterIndex}</span> for method <span class="hljs-subst">${propertyName}</span>`</span>);
                }
            }
        }
        <span class="hljs-keyword">return</span> method.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-variable language_">arguments</span>);
    }
}

<span class="hljs-comment">// 3. 类装饰器：依赖注入 (简易版 IOC 容器)</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Constructor</span>&lt;T = <span class="hljs-built_in">any</span>&gt; = <span class="hljs-keyword">new</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]) =&gt; T;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">ServiceMap</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;();

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Service</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">constructor: Constructor</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Registering service: <span class="hljs-subst">${name}</span>`</span>);
        <span class="hljs-title class_">ServiceMap</span>.<span class="hljs-title function_">set</span>(name, <span class="hljs-keyword">new</span> <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>));
    }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Inject</span>(<span class="hljs-params">serviceName: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">target: <span class="hljs-built_in">any</span>, propertyKey: <span class="hljs-built_in">string</span></span>) {
        <span class="hljs-comment">// 在属性被访问时懒加载注入</span>
        <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(target, propertyKey, {
            <span class="hljs-attr">get</span>: <span class="hljs-function">() =&gt;</span> {
                <span class="hljs-keyword">const</span> service = <span class="hljs-title class_">ServiceMap</span>.<span class="hljs-title function_">get</span>(serviceName);
                <span class="hljs-keyword">if</span> (!service) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Service <span class="hljs-subst">${serviceName}</span> not found`</span>);
                <span class="hljs-keyword">return</span> service;
            },
            <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>
        });
    }
}

<span class="hljs-comment">// --- 综合应用 ---</span>

<span class="hljs-meta">@Service</span>(<span class="hljs-string">"Logger"</span>)
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LoggerService</span> {
    <span class="hljs-title function_">log</span>(<span class="hljs-params">msg: <span class="hljs-built_in">string</span></span>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[LOG SERVICE]: <span class="hljs-subst">${msg}</span>`</span>); }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    <span class="hljs-meta">@Inject</span>(<span class="hljs-string">"Logger"</span>)
    <span class="hljs-keyword">private</span> logger!: <span class="hljs-title class_">LoggerService</span>;

    <span class="hljs-meta">@Validate</span>
    <span class="hljs-meta">@LogPerformance</span>
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params"><span class="hljs-meta">@Required</span> name: <span class="hljs-built_in">string</span>, <span class="hljs-meta">@Required</span> email: <span class="hljs-built_in">string</span>, age?: <span class="hljs-built_in">number</span></span>) {
        <span class="hljs-comment">// 模拟异步操作</span>
        <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">100</span>));
        
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Creating user: <span class="hljs-subst">${name}</span> (<span class="hljs-subst">${email}</span>)`</span>);
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">id</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">1000</span>), name, email };
    }
}

<span class="hljs-comment">// 测试运行</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">runDecorators</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserController</span>();
    
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">await</span> controller.<span class="hljs-title function_">createUser</span>(<span class="hljs-string">"Bob"</span>, <span class="hljs-string">"bob@example.com"</span>); <span class="hljs-comment">// 成功</span>
        <span class="hljs-comment">// await controller.createUser("Alice", null as any); // 抛出 Error: Missing required argument</span>
    } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(e);
    }
}
<span class="hljs-comment">// runDecorators();</span>
</code></pre>
<hr/>
<h3 data-id="heading-6">模块五：React 高级模式与多态组件</h3>
<p>在前端开发中，React 的类型定义尤为重要。我们将构建一个多态组件（Polymorphic Component），它可以根据 <code>as</code> 属性改变渲染的 HTML 标签，同时保持类型安全。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 模块五：React 高级类型模式
 * 场景：组件库开发、高阶组件 (HOC)
 */</span>

<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 1. 多态组件 (Polymorphic Components)</span>
<span class="hljs-comment">// 这是一个非常高级的模式，允许 &lt;Text as="h1"&gt; 或 &lt;Text as="a" href="..."&gt;</span>

<span class="hljs-comment">// 获取元素自身的 Props，排除我们要重写的 'as'</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">AsProp</span>&lt;C <span class="hljs-keyword">extends</span> <span class="hljs-title class_">React</span>.<span class="hljs-property">ElementType</span>&gt; = {
    <span class="hljs-keyword">as</span>?: C;
};

<span class="hljs-keyword">type</span> <span class="hljs-title class_">PropsToOmit</span>&lt;C <span class="hljs-keyword">extends</span> <span class="hljs-title class_">React</span>.<span class="hljs-property">ElementType</span>, P&gt; = keyof (<span class="hljs-title class_">AsProp</span>&lt;C&gt; &amp; P);

<span class="hljs-comment">// 这是一个复杂的类型定义：</span>
<span class="hljs-comment">// 1. 接收泛型 C (组件类型) 和 Props</span>
<span class="hljs-comment">// 2. 合并传入的 Props 和 as 属性</span>
<span class="hljs-comment">// 3. 合并 HTML 原生属性 (Omit 掉重复的)</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">PolymorphicComponentProps</span>&lt;C <span class="hljs-keyword">extends</span> <span class="hljs-title class_">React</span>.<span class="hljs-property">ElementType</span>, <span class="hljs-title class_">Props</span> = {}&gt; = 
    <span class="hljs-title class_">React</span>.<span class="hljs-property">PropsWithChildren</span>&lt;<span class="hljs-title class_">Props</span> &amp; <span class="hljs-title class_">AsProp</span>&lt;C&gt;&gt; &amp;
    <span class="hljs-title class_">Omit</span>&lt;<span class="hljs-title class_">React</span>.<span class="hljs-property">ComponentPropsWithoutRef</span>&lt;C&gt;, <span class="hljs-title class_">PropsToOmit</span>&lt;C, <span class="hljs-title class_">Props</span>&gt;&gt;;

<span class="hljs-comment">// 定义组件类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">PolymorphicRef</span>&lt;C <span class="hljs-keyword">extends</span> <span class="hljs-title class_">React</span>.<span class="hljs-property">ElementType</span>&gt; = <span class="hljs-title class_">React</span>.<span class="hljs-property">ComponentPropsWithRef</span>&lt;C&gt;[<span class="hljs-string">"ref"</span>];

<span class="hljs-keyword">type</span> <span class="hljs-title class_">PolymorphicComponentPropWithRef</span>&lt;C <span class="hljs-keyword">extends</span> <span class="hljs-title class_">React</span>.<span class="hljs-property">ElementType</span>, <span class="hljs-title class_">Props</span> = {}&gt; = 
    <span class="hljs-title class_">PolymorphicComponentProps</span>&lt;C, <span class="hljs-title class_">Props</span>&gt; &amp; { ref?: <span class="hljs-title class_">PolymorphicRef</span>&lt;C&gt; };

<span class="hljs-comment">// 实现组件</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">TextProps</span> = {
    color?: <span class="hljs-string">'primary'</span> | <span class="hljs-string">'secondary'</span> | <span class="hljs-string">'danger'</span>;
    size?: <span class="hljs-string">'sm'</span> | <span class="hljs-string">'md'</span> | <span class="hljs-string">'lg'</span>;
};

<span class="hljs-comment">// 使用 React.forwardRef 实现</span>
<span class="hljs-comment">// 注意：由于泛型组件和 forwardRef 的结合在 TS 中比较棘手，通常需要类型断言</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">Text</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">forwardRef</span>(
    &lt;C <span class="hljs-keyword">extends</span> <span class="hljs-title class_">React</span>.<span class="hljs-property">ElementType</span> = <span class="hljs-string">"span"</span>&gt;<span class="hljs-function">(<span class="hljs-params">
        { <span class="hljs-keyword">as</span>, color = <span class="hljs-string">'primary'</span>, size = <span class="hljs-string">'md'</span>, children, ...rest }: PolymorphicComponentProps&lt;C, TextProps&gt;,
        ref: PolymorphicRef&lt;C&gt;
    </span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> <span class="hljs-title class_">Component</span> = <span class="hljs-keyword">as</span> || <span class="hljs-string">"span"</span>;
        
        <span class="hljs-keyword">const</span> style = {
            <span class="hljs-attr">color</span>: color === <span class="hljs-string">'danger'</span> ? <span class="hljs-string">'red'</span> : <span class="hljs-string">'black'</span>,
            <span class="hljs-attr">fontSize</span>: size === <span class="hljs-string">'lg'</span> ? <span class="hljs-string">'20px'</span> : <span class="hljs-string">'14px'</span>
        };

        <span class="hljs-keyword">return</span> (
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Component</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{ref}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{style}</span> {<span class="hljs-attr">...rest</span>}&gt;</span>
                {children}
            <span class="hljs-tag">&lt;/<span class="hljs-name">Component</span>&gt;</span></span>
        );
    }
) <span class="hljs-keyword">as</span> &lt;C <span class="hljs-keyword">extends</span> <span class="hljs-title class_">React</span>.<span class="hljs-property">ElementType</span> = <span class="hljs-string">"span"</span>&gt;<span class="hljs-function">(<span class="hljs-params">
    props: PolymorphicComponentPropWithRef&lt;C, TextProps&gt;
</span>) =&gt;</span> <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactElement</span> | <span class="hljs-literal">null</span>;

<span class="hljs-comment">// --- 使用示例 ---</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            {/* 渲染为 span (默认) */}
            <span class="hljs-tag">&lt;<span class="hljs-name">Text</span>&gt;</span>Hello World<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
            
            {/* 渲染为 h1 */}
            <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">as</span>=<span class="hljs-string">"h1"</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"lg"</span>&gt;</span>Title<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
            
            {/* 渲染为 a 标签，TS 会自动提示 href 属性是必须的/可用的 */}
            <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">as</span>=<span class="hljs-string">"a"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://google.com"</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"danger"</span>&gt;</span>
                Link
            <span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
            
            {/* 错误演示：div 没有 href 属性 */}
            {/* <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">as</span>=<span class="hljs-string">"div"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"..."</span> /&gt;</span> // Error: Property 'href' does not exist on type... */}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}

<span class="hljs-comment">// 2. 类型安全的 Render Props</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ListProps</span>&lt;T&gt; {
    <span class="hljs-attr">items</span>: T[];
    <span class="hljs-attr">renderItem</span>: <span class="hljs-function">(<span class="hljs-params">item: T, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span>;
}

<span class="hljs-comment">// 使用泛型组件定义</span>
<span class="hljs-keyword">function</span> <span class="hljs-title class_">List</span>&lt;T&gt;({ items, renderItem }: <span class="hljs-title class_">ListProps</span>&lt;T&gt;) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
            {items.map((item, index) =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>&gt;</span>{renderItem(item, index)}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
            ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>
    );
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-comment">// &lt;List </span>
<span class="hljs-comment">//   items={[{ id: 1, name: 'A' }, { id: 2, name: 'B' }]} </span>
<span class="hljs-comment">//   renderItem={(item) =&gt; &lt;span&gt;{item.name}&lt;/span&gt;} // item 自动推断为对象</span>
<span class="hljs-comment">// /&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-7">模块六：混合（Mixins）与类的组合</h3>
<p>TypeScript 支持 Mixin 模式，允许我们将多个类的功能组合到一个类中。这在构建复杂的 UI 组件库（如 Material CDK）时非常常见。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 模块六：Mixins
 * 场景：多重继承模拟、功能组合
 */</span>

<span class="hljs-comment">// 定义构造函数类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Constructor</span>&lt;T = {}&gt; = <span class="hljs-keyword">new</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]) =&gt; T;

<span class="hljs-comment">// 1. Activatable Mixin: 添加激活/未激活状态</span>
<span class="hljs-keyword">function</span> <span class="hljs-title class_">Activatable</span>&lt;<span class="hljs-title class_">TBase</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Constructor</span>&gt;(<span class="hljs-title class_">Base</span>: <span class="hljs-title class_">TBase</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">extends</span> <span class="hljs-title class_">Base</span> {
        <span class="hljs-attr">isActivated</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;

        <span class="hljs-title function_">activate</span>(<span class="hljs-params"/>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">isActivated</span> = <span class="hljs-literal">true</span>;
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Activated!"</span>);
        }

        <span class="hljs-title function_">deactivate</span>(<span class="hljs-params"/>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">isActivated</span> = <span class="hljs-literal">false</span>;
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Deactivated!"</span>);
        }
    };
}

<span class="hljs-comment">// 2. Disposable Mixin: 添加资源清理功能</span>
<span class="hljs-keyword">function</span> <span class="hljs-title class_">Disposable</span>&lt;<span class="hljs-title class_">TBase</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Constructor</span>&gt;(<span class="hljs-title class_">Base</span>: <span class="hljs-title class_">TBase</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">extends</span> <span class="hljs-title class_">Base</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-attr">disposables</span>: (<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>)[] = [];

        <span class="hljs-title function_">addDisposable</span>(<span class="hljs-params">cb: () =&gt; <span class="hljs-built_in">void</span></span>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">disposables</span>.<span class="hljs-title function_">push</span>(cb);
        }

        <span class="hljs-title function_">dispose</span>(<span class="hljs-params"/>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">disposables</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">cb</span> =&gt;</span> <span class="hljs-title function_">cb</span>());
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">disposables</span> = [];
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Resources disposed."</span>);
        }
    };
}

<span class="hljs-comment">// 3. Timestamped Mixin: 记录创建时间</span>
<span class="hljs-keyword">function</span> <span class="hljs-title class_">Timestamped</span>&lt;<span class="hljs-title class_">TBase</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Constructor</span>&gt;(<span class="hljs-title class_">Base</span>: <span class="hljs-title class_">TBase</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">extends</span> <span class="hljs-title class_">Base</span> {
        timestamp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();
    };
}

<span class="hljs-comment">// --- 组合使用 ---</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseComponent</span> {
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    }
    
    <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Rendering <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
    }
}

<span class="hljs-comment">// 创建一个拥有所有能力的类</span>
<span class="hljs-comment">// 注意：Mixin 的应用顺序会影响类的层级</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">SmartComponent</span> = <span class="hljs-title class_">Timestamped</span>(<span class="hljs-title class_">Disposable</span>(<span class="hljs-title class_">Activatable</span>(<span class="hljs-title class_">BaseComponent</span>)));

<span class="hljs-comment">// 演示</span>
<span class="hljs-keyword">const</span> comp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SmartComponent</span>(<span class="hljs-string">"MyButton"</span>);

comp.<span class="hljs-title function_">render</span>(); <span class="hljs-comment">// 来自 BaseComponent</span>
comp.<span class="hljs-title function_">activate</span>(); <span class="hljs-comment">// 来自 Activatable</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Created at: <span class="hljs-subst">${comp.timestamp}</span>`</span>); <span class="hljs-comment">// 来自 Timestamped</span>

comp.<span class="hljs-title function_">addDisposable</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Cleaning up event listeners..."</span>));
comp.<span class="hljs-title function_">dispose</span>(); <span class="hljs-comment">// 来自 Disposable</span>
</code></pre>
<hr/>
<h3 data-id="heading-8">模块七：高级类型守卫与断言</h3>
<p>运行时类型检查对于前端应用的健壮性至关重要。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 模块七：类型守卫 (Type Guards) 与断言
 * 场景：处理联合类型、运行时数据验证
 */</span>

<span class="hljs-comment">// 1. 区分联合类型 (Discriminated Unions)</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Square</span> {
    <span class="hljs-attr">kind</span>: <span class="hljs-string">"square"</span>;
    <span class="hljs-attr">size</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Rectangle</span> {
    <span class="hljs-attr">kind</span>: <span class="hljs-string">"rectangle"</span>;
    <span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Circle</span> {
    <span class="hljs-attr">kind</span>: <span class="hljs-string">"circle"</span>;
    <span class="hljs-attr">radius</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Shape</span> = <span class="hljs-title class_">Square</span> | <span class="hljs-title class_">Rectangle</span> | <span class="hljs-title class_">Circle</span>;

<span class="hljs-comment">// 计算面积：利用 switch 的类型收窄</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">area</span>(<span class="hljs-params">s: Shape</span>): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">switch</span> (s.<span class="hljs-property">kind</span>) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">"square"</span>:
            <span class="hljs-comment">// 在这里 s 被收窄为 Square</span>
            <span class="hljs-keyword">return</span> s.<span class="hljs-property">size</span> * s.<span class="hljs-property">size</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">"rectangle"</span>:
            <span class="hljs-comment">// 在这里 s 被收窄为 Rectangle</span>
            <span class="hljs-keyword">return</span> s.<span class="hljs-property">width</span> * s.<span class="hljs-property">height</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">"circle"</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * s.<span class="hljs-property">radius</span> ** <span class="hljs-number">2</span>;
        <span class="hljs-attr">default</span>:
            <span class="hljs-comment">// 穷尽性检查 (Exhaustiveness checking)</span>
            <span class="hljs-comment">// 如果未来添加了新形状但没处理，这里会报错</span>
            <span class="hljs-keyword">const</span> <span class="hljs-attr">_exhaustiveCheck</span>: <span class="hljs-built_in">never</span> = s;
            <span class="hljs-keyword">return</span> _exhaustiveCheck;
    }
}

<span class="hljs-comment">// 2. 用户自定义类型守卫 (User-Defined Type Guards)</span>
<span class="hljs-comment">// 返回值类型必须是 `arg is Type`</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">isString</span>(<span class="hljs-params">value: <span class="hljs-built_in">unknown</span></span>): value is <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">"string"</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">isDate</span>(<span class="hljs-params">value: <span class="hljs-built_in">unknown</span></span>): value is <span class="hljs-title class_">Date</span> {
    <span class="hljs-keyword">return</span> value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Date</span>;
}

<span class="hljs-comment">// 复杂对象的类型守卫</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApiError</span> {
    <span class="hljs-attr">error</span>: <span class="hljs-literal">true</span>;
    <span class="hljs-attr">code</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">details</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApiSuccess</span>&lt;T&gt; {
    <span class="hljs-attr">error</span>: <span class="hljs-literal">false</span>;
    <span class="hljs-attr">data</span>: T;
}

<span class="hljs-keyword">type</span> <span class="hljs-title class_">ApiResult</span>&lt;T&gt; = <span class="hljs-title class_">ApiSuccess</span>&lt;T&gt; | <span class="hljs-title class_">ApiError</span>;

<span class="hljs-keyword">function</span> isSuccess&lt;T&gt;(<span class="hljs-attr">result</span>: <span class="hljs-title class_">ApiResult</span>&lt;T&gt;): result is <span class="hljs-title class_">ApiSuccess</span>&lt;T&gt; {
    <span class="hljs-keyword">return</span> result.<span class="hljs-property">error</span> === <span class="hljs-literal">false</span>;
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleApiResult</span>(<span class="hljs-params">result: ApiResult&lt;<span class="hljs-built_in">string</span>&gt;</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isSuccess</span>(result)) {
        <span class="hljs-comment">// TS 知道这里是 ApiSuccess，可以安全访问 .data</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result.<span class="hljs-property">data</span>.<span class="hljs-title function_">toUpperCase</span>());
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// TS 知道这里是 ApiError</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Error <span class="hljs-subst">${result.code}</span>: <span class="hljs-subst">${result.details}</span>`</span>);
    }
}

<span class="hljs-comment">// 3. 断言签名 (Assertion Signatures) - TS 3.7+</span>
<span class="hljs-comment">// 类似于 Node.js 的 assert 模块</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">assertIsNumber</span>(<span class="hljs-params">val: <span class="hljs-built_in">any</span></span>): asserts val is <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> val !== <span class="hljs-string">"number"</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Not a number!"</span>);
    }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">double</span>(<span class="hljs-params">input: <span class="hljs-built_in">any</span></span>) {
    <span class="hljs-title function_">assertIsNumber</span>(input);
    <span class="hljs-comment">// 此行之后，input 被视为 number</span>
    <span class="hljs-keyword">return</span> input * <span class="hljs-number">2</span>;
}
</code></pre>
<hr/>
<h3 data-id="heading-9">模块八：类型体操挑战（Type Gymnastics）</h3>
<p>为了展示 TS 的极限能力，我们实现一些类似 Lodash 函数的类型版本。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 模块八：类型体操
 * 场景：库作者、极度复杂的类型推导
 */</span>

<span class="hljs-comment">// 1. 实现 Join 类型 (Array.join 的类型版)</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Join</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span>[], U <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span>&gt; = 
    T <span class="hljs-keyword">extends</span> [infer F, ...infer R]
        ? R[<span class="hljs-string">'length'</span>] <span class="hljs-keyword">extends</span> <span class="hljs-number">0</span>
            ? <span class="hljs-string">`<span class="hljs-subst">${F &amp; <span class="hljs-built_in">string</span>}</span>`</span>
            : <span class="hljs-string">`<span class="hljs-subst">${F &amp; <span class="hljs-built_in">string</span>}</span><span class="hljs-subst">${U}</span><span class="hljs-subst">${Join&lt;R, U&gt;}</span>`</span>
        : <span class="hljs-string">""</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Path</span> = <span class="hljs-title class_">Join</span>&lt;[<span class="hljs-string">'users'</span>, <span class="hljs-string">'id'</span>, <span class="hljs-string">'posts'</span>], <span class="hljs-string">'/'</span>&gt;; <span class="hljs-comment">// "users/id/posts"</span>

<span class="hljs-comment">// 2. 实现 DeepValue (根据路径获取深度属性值)</span>
<span class="hljs-comment">// 类似于 lodash.get(obj, "a.b.c")</span>

<span class="hljs-keyword">type</span> <span class="hljs-title class_">GetPropType</span>&lt;T, P <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>&gt; = 
    P <span class="hljs-keyword">extends</span> keyof T 
        ? T[P] 
        : P <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">${infer K}</span>.<span class="hljs-subst">${infer R}</span>`</span>
            ? K <span class="hljs-keyword">extends</span> keyof T 
                ? <span class="hljs-title class_">GetPropType</span>&lt;T[K], R&gt;
                : <span class="hljs-built_in">never</span>
            : <span class="hljs-built_in">never</span>;

<span class="hljs-comment">// 测试 DeepValue</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Config</span> {
    <span class="hljs-attr">app</span>: {
        <span class="hljs-attr">database</span>: {
            <span class="hljs-attr">host</span>: <span class="hljs-built_in">string</span>;
            <span class="hljs-attr">port</span>: <span class="hljs-built_in">number</span>;
        }
    }
}

<span class="hljs-keyword">type</span> <span class="hljs-title class_">DBHost</span> = <span class="hljs-title class_">GetPropType</span>&lt;<span class="hljs-title class_">Config</span>, <span class="hljs-string">"app.database.host"</span>&gt;; <span class="hljs-comment">// string</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">DBPort</span> = <span class="hljs-title class_">GetPropType</span>&lt;<span class="hljs-title class_">Config</span>, <span class="hljs-string">"app.database.port"</span>&gt;; <span class="hljs-comment">// number</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Invalid</span> = <span class="hljs-title class_">GetPropType</span>&lt;<span class="hljs-title class_">Config</span>, <span class="hljs-string">"app.database.password"</span>&gt;; <span class="hljs-comment">// never</span>

<span class="hljs-comment">// 3. 元组转对象</span>
<span class="hljs-keyword">const</span> tuple = [<span class="hljs-string">'tesla'</span>, <span class="hljs-string">'model 3'</span>, <span class="hljs-string">'model X'</span>, <span class="hljs-string">'model Y'</span>] <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">TupleToObject</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">any</span>[]&gt; = {
    [P <span class="hljs-keyword">in</span> T[<span class="hljs-built_in">number</span>]]: P;
};

<span class="hljs-keyword">type</span> <span class="hljs-title class_">CarModelObj</span> = <span class="hljs-title class_">TupleToObject</span>&lt;<span class="hljs-keyword">typeof</span> tuple&gt;;
<span class="hljs-comment">// { tesla: "tesla", "model 3": "model 3", ... }</span>

<span class="hljs-comment">// 4. 柯里化函数的类型推导 (Currying)</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Curry</span>&lt;P <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span>[], R&gt; = 
    <span class="hljs-function">(<span class="hljs-params">arg: Head&lt;P&gt;</span>) =&gt;</span> <span class="hljs-title class_">HasTail</span>&lt;P&gt; <span class="hljs-keyword">extends</span> <span class="hljs-literal">true</span> ? <span class="hljs-title class_">Curry</span>&lt;<span class="hljs-title class_">Tail</span>&lt;P&gt;, R&gt; : R;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Head</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span>[]&gt; = T <span class="hljs-keyword">extends</span> [<span class="hljs-built_in">any</span>, ...<span class="hljs-built_in">any</span>[]] ? T[<span class="hljs-number">0</span>] : <span class="hljs-built_in">never</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Tail</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span>[]&gt; = (<span class="hljs-function">(<span class="hljs-params">...t: T</span>) =&gt;</span> <span class="hljs-built_in">any</span>) <span class="hljs-keyword">extends</span> (<span class="hljs-function">(<span class="hljs-params">_: <span class="hljs-built_in">any</span>, ...tail: infer TT</span>) =&gt;</span> <span class="hljs-built_in">any</span>) ? <span class="hljs-variable constant_">TT</span> : [];
<span class="hljs-keyword">type</span> <span class="hljs-title class_">HasTail</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span>[]&gt; = T <span class="hljs-keyword">extends</span> ([] | [<span class="hljs-built_in">any</span>]) ? <span class="hljs-literal">false</span> : <span class="hljs-literal">true</span>;

<span class="hljs-comment">// 这是一个简化的定义，实际柯里化类型非常复杂</span>
<span class="hljs-keyword">declare</span> <span class="hljs-keyword">function</span> curry&lt;P <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span>[], R&gt;(<span class="hljs-attr">f</span>: <span class="hljs-function">(<span class="hljs-params">...args: P</span>) =&gt;</span> R): <span class="hljs-title class_">Curry</span>&lt;P, R&gt;;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">add</span> = (<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span>, c: <span class="hljs-built_in">number</span></span>) =&gt; a + b + c;
<span class="hljs-keyword">const</span> curriedAdd = <span class="hljs-title function_">curry</span>(add);

<span class="hljs-comment">// const sum = curriedAdd(1)(2)(3); // 理想情况下推导出 number</span>
</code></pre>
<hr/>
<h3 data-id="heading-10">模块九：声明合并与模块扩展 (Module Augmentation)</h3>
<p>在扩展第三方库（如给 Window 对象添加属性，或扩展 React 的 Theme）时必不可少。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 模块九：模块扩展
 * 场景：全局变量、第三方库补丁
 */</span>

<span class="hljs-comment">// 1. 扩展全局 Window 对象</span>
<span class="hljs-keyword">declare</span> <span class="hljs-variable language_">global</span> {
    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Window</span> {
        <span class="hljs-attr">__REDUX_DEVTOOLS_EXTENSION__</span>: <span class="hljs-built_in">any</span>;
        <span class="hljs-title class_">Analytics</span>: {
            <span class="hljs-attr">track</span>: <span class="hljs-function">(<span class="hljs-params">event: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;
        };
    }
    
    <span class="hljs-comment">// 扩展 String 原型</span>
    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">String</span> {
        <span class="hljs-title function_">toTitleCase</span>(): <span class="hljs-built_in">string</span>;
    }
}

<span class="hljs-comment">// 实现扩展的方法</span>
<span class="hljs-title class_">String</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toTitleCase</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\w\S*/g</span>, <span class="hljs-function">(<span class="hljs-params">txt</span>) =&gt;</span> txt.<span class="hljs-title function_">charAt</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_">toUpperCase</span>() + txt.<span class="hljs-title function_">substr</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_">toLowerCase</span>());
};

<span class="hljs-comment">// 使用</span>
<span class="hljs-comment">// window.Analytics.track("Page View");</span>
<span class="hljs-comment">// const title = "hello world".toTitleCase();</span>

<span class="hljs-comment">// 2. 扩展第三方库 (以 styled-components 为例)</span>
<span class="hljs-comment">// 假设这是一个名为 'my-theme-lib' 的库</span>
<span class="hljs-comment">// import 'my-theme-lib';</span>

<span class="hljs-comment">// declare module 'my-theme-lib' {</span>
<span class="hljs-comment">//     export interface DefaultTheme {</span>
<span class="hljs-comment">//         borderRadius: string;</span>
<span class="hljs-comment">//         colors: {</span>
<span class="hljs-comment">//             main: string;</span>
<span class="hljs-comment">//             secondary: string;</span>
<span class="hljs-comment">//         };</span>
<span class="hljs-comment">//     }</span>
<span class="hljs-comment">// }</span>
</code></pre>
<h3 data-id="heading-11">总结与最佳实践</h3>
<p>建议：</p>
<ol>
<li><strong>不要过度设计</strong>：虽然泛型和条件类型很强大，但如果一个类型定义超过了 10 行且难以阅读，考虑简化它或添加详细注释。</li>
<li><strong>利用 <code>unknown</code> 代替 <code>any</code></strong>：在不确定类型时，<code>unknown</code> 强制你在使用前进行类型检查，比 <code>any</code> 安全得多。</li>
<li><strong>优先使用接口 (Interface) 定义对象</strong>：接口支持声明合并，对库的扩展性更好；类型别名 (Type Alias) 更适合联合类型和元组。</li>
<li><strong>严格模式</strong>：始终开启 <code>strict: true</code>，特别是 <code>strictNullChecks</code>，这能避免 80% 的运行时错误。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何ubuntu22.4配置nginx和php]]></title>    <link>https://juejin.cn/post/7574727105705001000</link>    <guid>https://juejin.cn/post/7574727105705001000</guid>    <pubDate>2025-11-21T06:15:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574727105705001000" data-draft-id="7574869203447988224" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何ubuntu22.4配置nginx和php"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-21T06:15:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一个喜欢分享的PHP技术"/> <meta itemprop="url" content="https://juejin.cn/user/3878732754339581"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何ubuntu22.4配置nginx和php
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3878732754339581/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一个喜欢分享的PHP技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T06:15:04.000Z" title="Fri Nov 21 2025 06:15:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Ubuntu 22.04 上配置 Nginx 和 PHP 可以按照以下步骤进行：</p>
<p><strong>1. 安装 Nginx</strong></p>
<p>首先，使用 APT 包管理器安装 Nginx：</p>
<pre><code class="hljs language-sh" lang="sh">
sudo apt update

sudo apt install nginx

</code></pre>
<p>安装完成后，启动 Nginx 服务并检查其状态：</p>
<pre><code class="hljs language-sh" lang="sh">
sudo systemctl start nginx

sudo systemctl status nginx

</code></pre>
<p><strong>2. 安装 PHP 和 PHP-FPM</strong></p>
<p>接下来，安装 PHP 和 PHP-FPM：</p>
<pre><code class="hljs language-sh" lang="sh">
sudo apt install php php-fpm

</code></pre>
<p>安装完成后，检查 PHP 版本：</p>
<pre><code class="hljs language-sh" lang="sh">
php --version

</code></pre>
<p><strong>3. 配置 Nginx 使用 PHP-FPM</strong></p>
<p>编辑 Nginx 的默认站点配置文件：</p>
<pre><code class="hljs language-sh" lang="sh">
sudo nano /etc/nginx/sites-available/default

</code></pre>
<p>在文件中找到 <code>server</code> 块，并添加以下配置：</p>
<pre><code class="hljs language-nginx" lang="nginx">
server {

   listen 80 default_server;

   listen [::]:80 default_server;

  


   root /var/www/html;

   index index.php index.html index.htm;

  


   server_name _;

  


   location / {

       try_files $uri $uri/ =404;

   }

  


   location ~ \.php$ {

       include snippets/fastcgi-php.conf;

       fastcgi_pass unix:/run/php/php-fpm.sock;

   }

  


   location ~ /\.ht {

       deny all;

   }

}

</code></pre>
<p>保存并关闭文件后，测试 Nginx 配置是否正确：</p>
<pre><code class="hljs language-sh" lang="sh">
sudo nginx -t

</code></pre>
<p>如果没有错误，重新加载 Nginx 配置：</p>
<pre><code class="hljs language-sh" lang="sh">
sudo systemctl reload nginx

</code></pre>
<h3 data-id="heading-0">4. 测试 PHP</h3>
<p>创建一个测试 PHP 文件：</p>
<pre><code class="hljs language-sh" lang="sh">
sudo nano /var/www/html/info.php

</code></pre>
<p>在文件中添加以下内容：</p>
<pre><code class="hljs language-php" lang="php">
<span class="hljs-meta">&lt;?php</span>

<span class="hljs-title function_ invoke__">phpinfo</span>();

<span class="hljs-meta">?&gt;</span>

</code></pre>
<p>保存并关闭文件后，在浏览器中访问 <code>http://your_server_ip/info.php</code>，你应该能看到 PHP 信息页面。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深度解析 JavaScript 作用域与作用域链]]></title>    <link>https://juejin.cn/post/7574813550755233828</link>    <guid>https://juejin.cn/post/7574813550755233828</guid>    <pubDate>2025-11-21T06:18:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574813550755233828" data-draft-id="7572776177691557897" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深度解析 JavaScript 作用域与作用域链"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-11-21T06:18:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Achieve前端实验室"/> <meta itemprop="url" content="https://juejin.cn/user/1908407914473438"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深度解析 JavaScript 作用域与作用域链
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1908407914473438/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Achieve前端实验室
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T06:18:43.000Z" title="Fri Nov 21 2025 06:18:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>作用域（Scope）与作用域链（Scope Chain）是 JavaScript 的核心概念，它们决定了变量的可访问范围、生命周期，以及代码运行时变量查找的规则，理解这两个概念，可以回答我们 “变量在这里为什么能访问”，“为什么这里访问到的变量值是 undefined” 等诸多疑问，同时还能帮助我们在开发过程中规避变量污染、提升代码的可维护性，对于 ES Module 等模块方案也可以有更好的理解。</p>
<h2 data-id="heading-1">作用域类型</h2>
<h4 data-id="heading-2"><strong>全局作用域（Global Scope）</strong></h4>
<p>全局作用域是最顶层的作用域，代码中未被任何函数或块级结构包裹的变量 / 函数，都属于全局作用域。</p>
<ul>
<li><strong>生命周期</strong>：与程序运行周期一致，页面加载时创建，页面关闭时销毁；</li>
<li><strong>浏览器环境</strong>：全局作用域的变量会挂载到 <code>window</code>​ 对象上（Node.js 环境挂载到 <code>global</code> 对象）；</li>
<li><strong>访问范围</strong>：代码中的任何位置都能访问；</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 全局变量：属于全局作用域</span>
<span class="hljs-keyword">const</span> globalVar = <span class="hljs-string">"我是全局变量"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">bar</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 可访问全局变量</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(globalVar); <span class="hljs-comment">// 输出：我是全局变量</span>
}

<span class="hljs-title function_">bar</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">globalVar</span>); <span class="hljs-comment">// 浏览器环境输出：我是全局变量</span>
</code></pre>
<h4 data-id="heading-3"><strong>函数作用域（Function Scope）</strong></h4>
<p>函数作用域是指变量 / 函数仅在定义它们的函数内部可访问，函数外部无法直接访问。</p>
<ul>
<li><strong>生命周期</strong>：函数调用时创建，函数执行结束后销毁（闭包除外）；</li>
<li><strong>访问范围</strong>：仅函数内部及嵌套的子函数可访问；</li>
<li><strong>核心特性</strong>：函数参数也属于函数作用域的变量。</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 函数作用域变量：仅foo内部可访问</span>
  <span class="hljs-keyword">const</span> funcVar = <span class="hljs-string">"我是函数作用域变量"</span>;
  
  <span class="hljs-comment">// 嵌套函数可访问外层函数作用域的变量</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">inner</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(funcVar); <span class="hljs-comment">// 输出：我是函数作用域变量</span>
  }
  
  <span class="hljs-title function_">inner</span>();
}

<span class="hljs-title function_">foo</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(funcVar); <span class="hljs-comment">// 报错：funcVar is not defined（外部无法访问）</span>
</code></pre>
<h4 data-id="heading-4"><strong>块级作用域（Block Scope）</strong></h4>
<p>块级作用域是 ES6 引入的特性，由 <code>{ }</code>​ 包裹的代码块（如 <code>if</code>​、<code>for</code>​、<code>while</code>​、<code>try/catch</code>​，以及直接用 <code>{ }</code>​ 定义的块）形成，仅 <code>let/const</code> 声明的变量会绑定到块级作用域。</p>
<ul>
<li><strong>生命周期</strong>：代码块执行时创建，执行结束后销毁；</li>
<li><strong>访问范围</strong>：仅块内部可访问；</li>
<li><strong>核心特性</strong>：不存在变量提升（或称为<strong>暂时性死区</strong>），避免变量泄露。</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (<span class="hljs-literal">true</span>) {
  <span class="hljs-comment">// let声明的变量：绑定到块级作用域</span>
  <span class="hljs-keyword">let</span> blockVar = <span class="hljs-string">"我是块级作用域变量"</span>;
  <span class="hljs-keyword">const</span> blockConst = <span class="hljs-string">"块级常量"</span>;
  
  <span class="hljs-comment">// var声明的变量：不绑定块级作用域，属于外层作用域（如全局）</span>
  <span class="hljs-keyword">var</span> nonBlockVar = <span class="hljs-string">"我不属于块级作用域"</span>;
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(blockVar); <span class="hljs-comment">// 报错：blockVar is not defined</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(blockConst); <span class="hljs-comment">// 报错：blockConst is not defined</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(nonBlockVar); <span class="hljs-comment">// 输出：我不属于块级作用域（全局变量）</span>
</code></pre>
<p>虽然我这里划分了三种类型的作用域，但其实是两个大类型：全局和局部，函数作用域和块级作用域就属于是局部的作用域。</p>
<h2 data-id="heading-5">作用域的本质</h2>
<p>作用域本质上是定义了一套​<strong>变量的访问规则</strong>，用于确定在代码执行过程中，某个变量何时被创建、何时被销毁，在何处可以被访问、修改。</p>
<p>JavaScript 的作用域是​<strong>静态作用域</strong>​（通常也称为词法作用域）， 静态作用域是在代码<strong>定义阶段而非运行阶段</strong>确定的，通俗的说就是，你把变量写在代码的哪里，它的作用域就在哪个范围内，举个例子：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">outer</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> a = <span class="hljs-number">1</span>; <span class="hljs-comment">// 定义在 outer 作用域中的变量</span>
  
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">inner</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a); <span class="hljs-comment">// inner函数定义时，嵌套在outer内部，所以可以访问这个 a 变量</span>
  }
  
  <span class="hljs-keyword">return</span> inner;
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a); <span class="hljs-comment">// 这个 log 是在全局作用域下，是在 outer 作用域外的，所以访问不到 outer 中的变量</span>
<span class="hljs-comment">// 但这里有一个注意点，a 虽然访问不到 outer 中的变量 a，但是他可以访问到全局作用域的 a，由于未定义，所以输出是 undefined （非严格模式下）</span>

<span class="hljs-keyword">const</span> fn = <span class="hljs-title function_">outer</span>();
<span class="hljs-title function_">fn</span>(); <span class="hljs-comment">// 输出：1（即使 fn 在 outer 外部执行，仍能访问 outer 的 a，这就是经典的闭包）</span>
</code></pre>
<p>一般和作用域同时提到的还有​<strong>执行上下文</strong>，这是两个概念，需要注意区分：</p>
<ul>
<li>作用域是静态的，代码定义时确定，不关注代码的执行</li>
<li>执行上下文是动态的，在代码执行的过程中动态的创建，包含 <code>this</code> ，变量对象，作用域链等信息，在每次调用函数时都会创建新的执行上下文。</li>
</ul>
<h2 data-id="heading-6">作用域链</h2>
<p>作用域链，顾名思义，就是一个链表，是​<strong>由当前作用域和外层作用域组成的链表</strong>，用于解析变量引用。当代码在某个作用域访问一个变量时，会从当前作用域出发逐级向外层作用域去寻找变量，举个例子：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 全局作用域</span>
<span class="hljs-keyword">const</span> globalVar = <span class="hljs-string">"全局变量"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">outer</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 外层函数作用域</span>
  <span class="hljs-keyword">const</span> outerVar = <span class="hljs-string">"外层变量"</span>;
  
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">inner</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 内层函数作用域</span>
    <span class="hljs-keyword">const</span> innerVar = <span class="hljs-string">"内层变量"</span>;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(innerVar); <span class="hljs-comment">// 查找链：【找到】inner 作用域</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(outerVar); <span class="hljs-comment">// 查找链：inner 作用域 -&gt; 【找到】outer 作用域</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(globalVar); <span class="hljs-comment">// 查找链：innter 作用域 -&gt; outer 作用域 -&gt; 【找到】全局作用域</span>
  }
  
  <span class="hljs-title function_">inner</span>();
}

<span class="hljs-title function_">outer</span>();
</code></pre>
<p>在 <code>inner</code>​ 函数中访问 <code>globalVar</code> 变量时就是沿着作用域链逐级查找的。</p>
<h3 data-id="heading-7">链的构建过程</h3>
<ol>
<li>
<p><strong>函数定义时</strong>：JavaScript 引擎会为函数关联一个 <code>[[Scopes]]</code> 内部属性，存储函数定义时所处的所有外层作用域；</p>
</li>
<li>
<p><strong>函数调用时</strong>：创建该函数的执行上下文，此时作用域链会被初始化：</p>
<ul>
<li>链的第一个元素是当前执行上下文的变量对象（存储当前作用域的变量、函数）；</li>
<li>后续元素是函数 <code>[[Scopes]]</code>​ 属性中的外层作用域变量对象，按<strong>从内到外</strong>的顺序排列；</li>
</ul>
</li>
<li>
<p><strong>作用域链固化</strong>：作用域链在执行上下文创建时确定，后续不会因代码执行而改变。</p>
</li>
</ol>
<p>以本节开始的代码为例：</p>
<ul>
<li>​<code>inner</code>​ 函数定义时，引擎会为其添加一个 <code>[[Scopes]]</code>​ 属性，其中包含：外层函数作用域（<code>outer</code>）、全局作用域；</li>
<li>​<code>inner</code> 调用时，会创建执行上下文，该上下文的作用域链为：[inner 变量对象（{innerVar: "内层变量"}）→ outer 变量对象（{outerVar: "外层变量"}）→ 全局变量对象（{globalVar: "全局变量"}）]，箭头表示链表的方向及连接。</li>
</ul>
<h3 data-id="heading-8">变量查找规则</h3>
<p>当访问一个变量时，JavaScript 引擎的查找步骤为：</p>
<ol>
<li>从作用域链的<strong>第一个元素</strong>（当前作用域）开始查找</li>
<li>若找到变量，直接返回其值（或引用），停止查找</li>
<li>若未找到，继续查找作用域链的<strong>下一个元素</strong>（外层作用域）</li>
<li>依次类推，直到找到变量或遍历完整个作用域链</li>
<li>若遍历完所有作用域仍未找到，抛出 <code>ReferenceError</code>（变量未定义）、</li>
</ol>
<p>需要注意的是，修改是直接作用到这个查找到的变量上的，比如：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> x = <span class="hljs-number">1</span>; <span class="hljs-comment">// 全局变量</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
  x = <span class="hljs-number">2</span>; <span class="hljs-comment">// 修改的是全局变量x，而非创建局部变量</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(x); <span class="hljs-comment">// 输出：2</span>
}

<span class="hljs-title function_">foo</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(x); <span class="hljs-comment">// 输出：2（全局变量被修改）</span>
</code></pre>
<p>在过去不默认声明严格模式的时候，我们在 foo 函数里面 <code>x =2</code> 会隐式的创建一个全局变量，在编码的时候是一个很大的坑，但是现在的项目基本都默认严格模式了，这种使用方式就会报错，提前为我们规避一些问题。</p>
<h3 data-id="heading-9">应用</h3>
<h4 data-id="heading-10">闭包</h4>
<p>闭包应该是作用域链的一个最典型、广泛的应用了，他是由函数和定义时的词法作用域组合成的，他允许函数在外部作用域执行时，依旧能够访问到该函数定义时的局部变量（函数作用域内的变量），举个例子：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createCounter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>; <span class="hljs-comment">// 外层函数作用域变量</span>
  
  <span class="hljs-comment">// 内部函数引用了count，且被返回（导出到外部）</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) {
    count++;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count);
  };
}

<span class="hljs-comment">// increment在createCounter作用域之外执行</span>
<span class="hljs-keyword">const</span> counter = <span class="hljs-title function_">createCounter</span>();
<span class="hljs-title function_">counter</span>(); <span class="hljs-comment">// 输出：1</span>
<span class="hljs-title function_">counter</span>(); <span class="hljs-comment">// 输出：2</span>
<span class="hljs-title function_">counter</span>(); <span class="hljs-comment">// 输出：3</span>
</code></pre>
<p>从作用域的视角上看：</p>
<ul>
<li>​<code>increment</code>​ 函数定义的时候，其对应的 <code>[[Scopes]]</code>​ 属性存储的是 <code>createCounter</code>​ 的作用域和一个最外层的全局作用域，也就是说这时候相关的作用域就已经被这个 <code>increment</code> 函数持有了。</li>
<li>在 <code>createCounter</code>​ 执行结束后，该函数的上下文环境被销毁，但是由于 <code>increment</code>​ 依旧持有这个函数的作用域，而且 <code>increment</code>​ 被外部的 counter 变量所引用，不能被 GC，所以 <code>increment</code>​ 这时候也还存在着，并且此时有个别名 <code>counter</code> 。</li>
<li>当 <code>counter</code> 被调用的时创建的执行上下文的作用域链为：[increment 变量对象 → createCounter 作用域变量对象 → 全局变量对象]。</li>
</ul>
<p>由于这样的链式关系和引用的持有，最终形成了闭包。</p>
<h4 data-id="heading-11">变量遮蔽</h4>
<p>内存作用域和外层作用域存在<strong>同名变量</strong>时，内层的变量会遮蔽外层变量，在查找时优先访问内层变量。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> x = <span class="hljs-number">10</span>; <span class="hljs-comment">// 外层变量</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">bar</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> x = <span class="hljs-number">20</span>; <span class="hljs-comment">// 内层变量，遮蔽外层x</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(x); <span class="hljs-comment">// 输出：20（访问内层x）</span>
}

<span class="hljs-title function_">bar</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(x); <span class="hljs-comment">// 输出：10（访问外层x）</span>
</code></pre>
<h4 data-id="heading-12">模块化方案</h4>
<p>ES Module 的核心就是模块级作用域：</p>
<ol>
<li>
<p>每个模块都是一个独立的词法作用域，这意味着顶层的变量不会再自动挂载到 window 对象上了，模块内的变量/函数仅在模块内可以访问。</p>
</li>
<li>
<p>需要通过export 导出变量/函数，其他模块通过 import 导入。</p>
<p>这里有没有感觉很像闭包，必须将函数作用域的内容 return 后，才可以在外层作用域使用。</p>
</li>
</ol>
<h2 data-id="heading-13">一些问题</h2>
<h3 data-id="heading-14">变量提升</h3>
<p>在代码执行前，JavaScript 引擎会将 <code>var</code>​ 声明的变量提升到作用域顶部，提升后的值为<code>undefined</code>，将函数声明提升到作用域顶部，值为函数本身。</p>
<p>值得注意的是，变量提升仅在当前作用域上生效，不会出现跨作用域提升的情况，如下：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a); <span class="hljs-comment">// 输出：undefined（var声明的变量提升）</span>
<span class="hljs-keyword">var</span> a = <span class="hljs-number">1</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(b); <span class="hljs-comment">// 输出：undefined（函数作用域内的变量提升）</span>
  <span class="hljs-keyword">var</span> b = <span class="hljs-number">2</span>;
}

<span class="hljs-title function_">foo</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(b); <span class="hljs-comment">// 报错：b is not defined（b的提升仅在foo作用域内）</span>
</code></pre>
<p>自 ES6 后，很少会在代码中再使用 var 关键字了，基本用的是 <code>const/let</code>​ 来声明变量，因为<code>let/const</code>​声明的变量不会被提升，而是存在​<strong>暂时性死区</strong>，即从作用域开始到变量声明前，访问该变量会报错。这是块级作用域的特性，避免了变量提升导致的逻辑混乱。</p>
<h3 data-id="heading-15">全局作用域污染</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">badFunc</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 未声明直接赋值，隐式创建全局变量</span>
  unDeclaredVar = <span class="hljs-string">"我是污染的全局变量"</span>;
}

<span class="hljs-title function_">badFunc</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">unDeclaredVar</span>); <span class="hljs-comment">// 输出：我是污染的全局变量</span>
</code></pre>
<p>对于这种没有声明就直接赋值的写法，在非严格模式下，会隐式的创建一个全局变量，导致全局作用域被污染。</p>
<h2 data-id="heading-16">总结</h2>
<p>理解了 JavaScript 的作用域和作用域链对我们理解闭包、模块化、高阶函数等特性能够有更好的帮助，也能让我们在实际开发中，更合理运用块级作用域（<code>let/const</code>）、模块化（ES Module），规避变量污染、逻辑混乱等问题，写出更健壮、可扩展的 JavaScript 代码。</p>
<p>作用域（Scope）与作用域链（Scope Chain）是 JavaScript 的核心概念，它们决定了变量的可访问范围、生命周期，以及代码运行时变量查找的规则，理解这两个概念，可以回答我们 “变量在这里为什么能访问”，“为什么这里的变量是 undefined” 等诸多疑问，还能帮助我们在开发过程中规避变量污染、提升代码的可维护性，对于 ES Module 等模块方案有更好的理解。</p>
<h2 data-id="heading-17">作用域的本质</h2>
<p>很多开发者会把作用域简单理解为 “变量的存储位置”，但这只说对了一半。作用域的核心是<strong>一套 “变量访问规则”</strong>  —— 它定义了在代码的哪个位置可以访问哪些变量，同时也隐含了变量的 “生存空间”（即变量何时被创建、何时被销毁）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue页面渲染流程]]></title>    <link>https://juejin.cn/post/7574622940688564243</link>    <guid>https://juejin.cn/post/7574622940688564243</guid>    <pubDate>2025-11-20T08:53:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574622940688564243" data-draft-id="7573993452578783275" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue页面渲染流程"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-11-20T08:53:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="WebGirl"/> <meta itemprop="url" content="https://juejin.cn/user/3227821868584478"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue页面渲染流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821868584478/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    WebGirl
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T08:53:31.000Z" title="Thu Nov 20 2025 08:53:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Vue 核心中除了响应式原理外，视图渲染也是重中之重。我们都知道每次更新数据，都会走视图渲染的逻辑，而这当中牵扯的逻辑也是十分繁琐。</p>
<p>本文主要解析的是初始化视图渲染流程，你将会了解到从挂载组件开始，Vue 是如何构建 VNode，又是如何将 VNode 转为真实节点并挂载到页面。</p>
<p>Vue2 的页面渲染流程可分为<strong>初始化渲染</strong>和<strong>更新渲染</strong>两大阶段，核心围绕「VNode 构建」和「真实 DOM 生成」展开。以下是详细流程解析：</p>
<h2 data-id="heading-0">一、初始化渲染流程（首次渲染）</h2>
<h3 data-id="heading-1">实例化与初始化（new Vue()）</h3>
<ul>
<li>通过 <code>new Vue(options)</code> 创建组件实例，触发 <code>_init</code> 方法（<code>src/core/instance/init.js</code>）。</li>
<li><code>_init</code> 方法初始化组件选项（合并配置、初始化生命周期、事件、状态等），并判断是否存在 <code>el</code> 选项，若存在则调用 <code>$mount</code> 开始挂载。</li>
</ul>
<p><strong>Vue 是一个构造函数，通过 <code>new</code> 关键字进行实例化。</strong></p>
<p>代码块 1（src/core/instance/index.js）</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/core/instance/index.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Vue</span> (options) {
  <span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> !== <span class="hljs-string">'production'</span> &amp;&amp;
    !(<span class="hljs-variable language_">this</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Vue</span>)
  ) {
    <span class="hljs-title function_">warn</span>(<span class="hljs-string">'Vue is a constructor and should be called with the `new` keyword'</span>)
  }
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_init</span>(options)
}
</code></pre>
<p><strong>在实例化时，会调用 <code>_init</code> 进行初始化。</strong></p>
<p>代码块 2（src/core/instance/init.js）</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/core/instance/init.js</span>
<span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">_init</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">options?: <span class="hljs-built_in">Object</span></span>) {
  <span class="hljs-comment">// ... component = this</span>
  <span class="hljs-keyword">if</span> (vm.<span class="hljs-property">$options</span>.<span class="hljs-property">el</span>) {
    vm.$mount(vm.<span class="hljs-property">$options</span>.<span class="hljs-property">el</span>)
  }
}
</code></pre>
<h3 data-id="heading-2">挂载组件（$mount）</h3>
<ul>
<li><code>$mount</code> 方法最终调用 <code>mountComponent</code>（<code>src/core/instance/lifecycle.js</code>），负责将组件挂载到 DOM。</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/core/instance/lifecycle.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">mountComponent</span> (
  <span class="hljs-attr">vm</span>: <span class="hljs-title class_">Component</span>,
  <span class="hljs-attr">el</span>: <span class="hljs-title class_">Element</span>,
  hydrating?: boolean
): <span class="hljs-title class_">Component</span> {
  vm.<span class="hljs-property">$el</span> = el
  <span class="hljs-title function_">callHook</span>(vm, <span class="hljs-string">'beforeMount'</span>)

  <span class="hljs-keyword">let</span> updateComponent
  <span class="hljs-comment">/* istanbul ignore if */</span>
  <span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> !== <span class="hljs-string">'production'</span> &amp;&amp; config.<span class="hljs-property">performance</span> &amp;&amp; mark) {
    <span class="hljs-comment">// ...</span>
  } <span class="hljs-keyword">else</span> {
    updateComponent = <span class="hljs-function">() =&gt;</span> {
      vm.<span class="hljs-title function_">_update</span>(vm.<span class="hljs-title function_">_render</span>(), hydrating) <span class="hljs-comment">// 渲染页面函数</span>
    }
  }

  <span class="hljs-comment">// we set this to vm._watcher inside the watcher's constructor</span>
  <span class="hljs-comment">// since the watcher's initial patch may call $forceUpdate (e.g. inside child</span>
  <span class="hljs-comment">// component's mounted hook), which relies on vm._watcher being already defined</span>
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watcher</span>(vm, updateComponent, noop, { <span class="hljs-comment">// 渲染watcher</span>
    before () {
      <span class="hljs-keyword">if</span> (vm.<span class="hljs-property">_isMounted</span> &amp;&amp; !vm.<span class="hljs-property">_isDestroyed</span>) {
        <span class="hljs-title function_">callHook</span>(vm, <span class="hljs-string">'beforeUpdate'</span>)
      }
    }
  }, <span class="hljs-literal">true</span> <span class="hljs-comment">/* isRenderWatcher */</span>)
  hydrating = <span class="hljs-literal">false</span>

  <span class="hljs-comment">// manually mounted instance, call mounted on self</span>
  <span class="hljs-comment">// mounted is called for render-created child components in its inserted hook</span>
  <span class="hljs-keyword">if</span> (vm.<span class="hljs-property">$vnode</span> == <span class="hljs-literal">null</span>) {
    vm.<span class="hljs-property">_isMounted</span> = <span class="hljs-literal">true</span>
    <span class="hljs-title function_">callHook</span>(vm, <span class="hljs-string">'mounted'</span>)
  }
  <span class="hljs-keyword">return</span> vm
}
</code></pre>
<p><code>mountComponent</code> 除了调用一些生命周期的钩子函数外，最主要是 <code>updateComponent</code>，它就是负责渲染视图的核心方法，其只有一行核心代码：</p>
<pre><code class="hljs language-js" lang="js">vm.<span class="hljs-title function_">_update</span>(vm.<span class="hljs-title function_">_render</span>(), hydrating)
</code></pre>
<ul>
<li><code>vm._render</code> 创建并返回 VNode，<code>vm._update</code> 接收 VNode 将其转为真实节点。</li>
<li>其中 <code>vm._render()</code> 生成 VNode，<code>vm._update()</code> 将 VNode 转为真实 DOM。</li>
<li>创建「渲染 Watcher」，监听数据变化，首次执行 <code>updateComponent</code> 触发初始化渲染。
<ul>
<li><code>updateComponent</code> 会被传入<strong>渲染 Watcher</strong>，每当数据变化触发 Watcher 更新就会执行该函数，重新渲染视图。</li>
<li><code>updateComponent</code> 传入<strong>渲染 Watcher</strong> 后会被执行一次进行初始化页面渲染。</li>
</ul>
</li>
</ul>
<p>所以我们着重分析的是 <code>vm._render</code> 和 <code>vm._update</code> 两个方法，这也是本文主要了解的原理 ——Vue 视图渲染流程。</p>
<h3 data-id="heading-3">构建VNode(_render)</h3>
<p><strong>首先是 <code>_render</code> 方法，它用来构建组件的 VNode。</strong></p>
<ul>
<li><code>vm._render()</code> 调用组件的 <code>render</code> 函数（模板编译生成或用户自定义），返回根 VNode（虚拟节点）。</li>
<li><code>render</code> 函数通过 <code>vm.$createElement</code>（或编译生成的 <code>vm._c</code>）创建 VNode，内部调用 <code>createElement</code> 方法。</li>
</ul>
<p>代码块 1（src/core/instance/render.js）</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/core/instance/render.js</span>
<span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">_render</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { render, _parentVnode } = vm.<span class="hljs-property">$options</span>
  vnode = render.<span class="hljs-title function_">call</span>(vm.<span class="hljs-property">_renderProxy</span>, vm.<span class="hljs-property">$createElement</span>)
  <span class="hljs-keyword">return</span> vnode
}
</code></pre>
<p><code>_render</code> 内部会执行 <code>render</code> 方法并返回构建好的 VNode，<code>render</code> 一般是模板编译后生成的方法，也有可能是用户自定义。</p>
<p>代码块 2（src/core/instance/render.js）</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/core/instance/render.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">initRender</span> (vm) {
  vm.<span class="hljs-property">_c</span> = <span class="hljs-function">(<span class="hljs-params">a, b, c, d</span>) =&gt;</span> <span class="hljs-title function_">createElement</span>(vm, a, b, c, d, <span class="hljs-literal">false</span>)
  vm.<span class="hljs-property">$createElement</span> = <span class="hljs-function">(<span class="hljs-params">a, b, c, d</span>) =&gt;</span> <span class="hljs-title function_">createElement</span>(vm, a, b, c, d, <span class="hljs-literal">true</span>)
}
</code></pre>
<ul>
<li><code>initRender</code> 在初始化就会执行为实例上绑定两个方法，分别是 <code>vm._c</code> 和 <code>vm.$createElement</code>。它们两者都是调用 <code>createElement</code> 方法，它是创建 VNode 的核心方法，最后一个参数用于区别是否为用户自定义。</li>
<li><code>vm._c</code> 应用场景是在编译生成的 <code>render</code> 函数中调用，<code>vm.$createElement</code> 则用于用户自定义 <code>render</code> 函数的场景。就像上面 <code>render</code> 在调用时会传入参数 <code>vm.$createElement</code>，我们在自定义 <code>render</code> 函数接收到的参数就是它。</li>
</ul>
<h4 data-id="heading-4">createElement</h4>
<ul>
<li><code>createElement</code> 封装 <code>_createElement</code>，处理参数并规范化子节点（<code>children</code>）：
<ul>
<li>若为编译生成的 <code>render</code>，调用 <code>simpleNormalizeChildren</code> 扁平化子节点数组。</li>
<li>若为用户自定义 <code>render</code>，调用 <code>normalizeChildren</code> 将子节点转为 VNode 数组。</li>
</ul>
</li>
<li>根据 <code>tag</code> 类型创建对应 VNode：
<ul>
<li>内置标签（如 <code>div</code>）：直接创建普通 VNode。</li>
<li>组件：调用 <code>createComponent</code> 创建组件类型 VNode。</li>
</ul>
</li>
</ul>
<p>代码块 3（src/core/vdom/create-element.js）</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/core/vdom/create-element.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createElement</span> (
  <span class="hljs-attr">context</span>: <span class="hljs-title class_">Component</span>,
  <span class="hljs-attr">tag</span>: any,
  <span class="hljs-attr">data</span>: any,
  <span class="hljs-attr">children</span>: any,
  <span class="hljs-attr">normalizationType</span>: any,
  <span class="hljs-attr">alwaysNormalize</span>: boolean
): <span class="hljs-title class_">VNode</span> | <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">VNode</span>&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(data) || <span class="hljs-title function_">isPrimitive</span>(data)) {
    normalizationType = children
    children = data
    data = <span class="hljs-literal">undefined</span>
  }
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isTrue</span>(alwaysNormalize)) {
    normalizationType = <span class="hljs-variable constant_">ALWAYS_NORMALIZE</span>
  }
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">_createElement</span>(context, tag, data, children, normalizationType)
}
</code></pre>
<p><code>createElement</code> 方法实际上是对 <code>_createElement</code> 方法的封装，它允许传入的参数更加灵活。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">_createElement</span> (
  <span class="hljs-attr">context</span>: <span class="hljs-title class_">Component</span>,
  <span class="hljs-attr">tag</span>: string | <span class="hljs-title class_">Class</span>&lt;<span class="hljs-title class_">Component</span>&gt; | <span class="hljs-title class_">Function</span> | <span class="hljs-title class_">Object</span>,
  <span class="hljs-attr">data</span>: <span class="hljs-title class_">VNodeData</span>,
  <span class="hljs-attr">children</span>: any,
  <span class="hljs-attr">normalizationType</span>: number
): <span class="hljs-title class_">VNode</span> | <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">VNode</span>&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(data) &amp;&amp; <span class="hljs-title function_">isDef</span>((<span class="hljs-attr">data</span>: any).<span class="hljs-property">is</span>)) {
    tag = data.<span class="hljs-property">is</span>
  }
  <span class="hljs-keyword">if</span> (!tag) {
    <span class="hljs-comment">// in case of component :is set to falsy value</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">createEmptyVNode</span>()
  }
  <span class="hljs-comment">// support single function children as default scoped slot</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(children) &amp;&amp;
    <span class="hljs-keyword">typeof</span> children[<span class="hljs-number">0</span>] === <span class="hljs-string">'function'</span>
  ) {
    data = data || {}
    data.<span class="hljs-property">scopedSlots</span> = { <span class="hljs-attr">default</span>: children[<span class="hljs-number">0</span>] }
    data.<span class="hljs-property">children</span> = []
  }
  <span class="hljs-keyword">if</span> (normalizationType === <span class="hljs-variable constant_">ALWAYS_NORMALIZE</span>) {
    children = <span class="hljs-title function_">normalizeChildren</span>(children)
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (normalizationType === <span class="hljs-variable constant_">SIMPLE_NORMALIZE</span>) {
    children = <span class="hljs-title function_">simpleNormalizeChildren</span>(children)
  }
  <span class="hljs-keyword">let</span> vnode, ns
  <span class="hljs-comment">// 根据tag类型创建VNode</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> tag === <span class="hljs-string">'string'</span>) {
    <span class="hljs-keyword">let</span> <span class="hljs-title class_">Ctor</span>
    ns = (context.<span class="hljs-property">$vnode</span> &amp;&amp; context.<span class="hljs-property">$vnode</span>.<span class="hljs-property">ns</span>) || config.<span class="hljs-title function_">getTagNamespace</span>(tag)
    <span class="hljs-keyword">if</span> (config.<span class="hljs-title function_">isReservedTag</span>(tag)) {
      <span class="hljs-comment">// platform built-in elements</span>
      vnode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(
        config.<span class="hljs-title function_">parsePlatformTagName</span>(tag), data, children,
        <span class="hljs-literal">undefined</span>, <span class="hljs-literal">undefined</span>, context
      )
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(<span class="hljs-title class_">Ctor</span> = <span class="hljs-title function_">resolveAsset</span>(context.<span class="hljs-property">$options</span>, <span class="hljs-string">'components'</span>, tag))) {
      <span class="hljs-comment">// component</span>
      vnode = <span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">Ctor</span>, data, context, children, tag)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// unknown or unlisted namespaced elements</span>
      <span class="hljs-comment">// check at runtime because it may get assigned a namespace when its</span>
      <span class="hljs-comment">// parent normalizes children</span>
      vnode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(
        tag, data, children,
        <span class="hljs-literal">undefined</span>, <span class="hljs-literal">undefined</span>, context
      )
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// direct component options / constructor</span>
    vnode = <span class="hljs-title function_">createComponent</span>(tag, data, context, children)
  }
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(vnode)) {
    <span class="hljs-keyword">return</span> vnode
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(vnode)) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(ns)) <span class="hljs-title function_">applyNS</span>(vnode, ns)
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(data)) <span class="hljs-title function_">registerDeepBindings</span>(data)
    <span class="hljs-keyword">return</span> vnode
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">createEmptyVNode</span>()
  }
}
</code></pre>
<p><code>_createElement</code> 参数中会接收 <code>children</code>，它表示当前 VNode 的子节点，因为它是任意类型的，所以接下来需要将其规范为标准的 VNode 数组；</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 这里规范化 children</span>
<span class="hljs-keyword">if</span> (normalizationType === <span class="hljs-variable constant_">ALWAYS_NORMALIZE</span>) {
  children = <span class="hljs-title function_">normalizeChildren</span>(children)
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (normalizationType === <span class="hljs-variable constant_">SIMPLE_NORMALIZE</span>) {
  children = <span class="hljs-title function_">simpleNormalizeChildren</span>(children)
}
</code></pre>
<p><code>simpleNormalizeChildren</code> 和 <code>normalizeChildren</code> 均用于规范化 <code>children</code>。由 <code>normalizationType</code> 判断 <code>render</code> 函数是编译生成的还是用户自定义的。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 1. when the children contains components - because a functional component</span>
<span class="hljs-comment">// may return an Array instead of a single root. In this case, just a simple</span>
<span class="hljs-comment">// normalization is needed. If the child is an Array, we flatten the whole</span>
<span class="hljs-comment">// thing with Array.prototype.concat. It is guaranteed to be only 1-level deep</span>
<span class="hljs-comment">// because functional components already normalize their own children.</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">simpleNormalizeChildren</span> (<span class="hljs-attr">children</span>: any) {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; children.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(children[i])) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">concat</span>.<span class="hljs-title function_">apply</span>([], children)
    }
  }
  <span class="hljs-keyword">return</span> children
}

<span class="hljs-comment">// 2. when the children contains constructs that always generated nested Arrays,</span>
<span class="hljs-comment">// e.g. &lt;template&gt;, &lt;slot&gt;, v-for, or when the children is provided by user</span>
<span class="hljs-comment">// with hand-written render functions / JSX. In such cases a full normalization</span>
<span class="hljs-comment">// is needed to cater to all possible types of children values.</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">normalizeChildren</span> (<span class="hljs-attr">children</span>: any): <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">VNode</span>&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">isPrimitive</span>(children)
    ? [<span class="hljs-title function_">createTextVNode</span>(children)]
    : <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(children)
      ? <span class="hljs-title function_">normalizeArrayChildren</span>(children)
      : <span class="hljs-literal">undefined</span>
}
</code></pre>
<p><code>simpleNormalizeChildren</code> 方法调用场景是 <code>render</code> 函数当函数是编译生成的。<code>normalizeChildren</code> 方法的调用场景主要是 <code>render</code> 函数是用户手写的。</p>
<p>经过对 <code>children</code> 的规范化，<code>children</code> 变成了一个类型为 VNode 的数组。之后就是创建 VNode 的逻辑。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/core/vdom/patch.js</span>
<span class="hljs-keyword">let</span> vnode, ns
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> tag === <span class="hljs-string">'string'</span>) {
  <span class="hljs-keyword">let</span> <span class="hljs-title class_">Ctor</span>
  ns = (context.<span class="hljs-property">$vnode</span> &amp;&amp; context.<span class="hljs-property">$vnode</span>.<span class="hljs-property">ns</span>) || config.<span class="hljs-title function_">getTagNamespace</span>(tag)
  <span class="hljs-keyword">if</span> (config.<span class="hljs-title function_">isReservedTag</span>(tag)) {
    <span class="hljs-comment">// platform built-in elements</span>
    vnode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(
      config.<span class="hljs-title function_">parsePlatformTagName</span>(tag), data, children,
      <span class="hljs-literal">undefined</span>, <span class="hljs-literal">undefined</span>, context
    )
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(<span class="hljs-title class_">Ctor</span> = <span class="hljs-title function_">resolveAsset</span>(context.<span class="hljs-property">$options</span>, <span class="hljs-string">'components'</span>, tag))) {
    <span class="hljs-comment">// component</span>
    vnode = <span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">Ctor</span>, data, context, children, tag)
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// unknown or unlisted namespaced elements</span>
    <span class="hljs-comment">// check at runtime because it may get assigned a namespace when its</span>
    <span class="hljs-comment">// parent normalizes children</span>
    vnode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(
      tag, data, children,
      <span class="hljs-literal">undefined</span>, <span class="hljs-literal">undefined</span>, context
    )
  }
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// direct component options / constructor</span>
  vnode = <span class="hljs-title function_">createComponent</span>(tag, data, context, children)
}
</code></pre>
<p>如果 <code>tag</code> 是 <code>string</code> 类型，则接着判断：如果是内置的一些节点，创建一个普通 VNode；如果是已注册的组件名，则通过 <code>createComponent</code> 创建一个组件类型的 VNode；否则创建一个未知的标签的 VNode。</p>
<p>如果 <code>tag</code> 不是 <code>string</code> 类型，那就是 <code>Component</code> 类型，则直接调用 <code>createComponent</code> 创建一个组件类型的 VNode 节点。</p>
<p>最后 <code>_createElement</code> 会返回一个 VNode，也就是调用 <code>vm._render</code> 时创建得到的 VNode。之后 VNode 会传递给 <code>vm._update</code> 函数，用于生成真实 DOM。</p>
<h3 data-id="heading-5">生成真实dom(_update 与 patch)</h3>
<ul>
<li><code>vm._update(vnode)</code> 调用 <code>vm.__patch__</code> 方法（平台相关实现，Web 端对应 <code>patch</code> 函数）。</li>
<li><code>patch</code> 函数核心逻辑：
<ol>
<li>首次渲染时，<code>oldVnode</code> 为真实 DOM（如 <code>#app</code>），先通过 <code>emptyNodeAt</code> 转为空 VNode。</li>
<li>调用 <code>createElm</code> 将 VNode 递归转为真实 DOM 并插入父节点。</li>
<li>移除旧节点，触发 <code>insert</code> 钩子，完成渲染。</li>
</ol>
</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 核心代码简化</span>
<span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">_update</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">vnode</span>) {
  <span class="hljs-keyword">const</span> vm = <span class="hljs-variable language_">this</span>;
  <span class="hljs-keyword">const</span> prevVnode = vm.<span class="hljs-property">_vnode</span>;
  vm.<span class="hljs-property">_vnode</span> = vnode;
  <span class="hljs-keyword">if</span> (!prevVnode) {
    <span class="hljs-comment">// 首次渲染：将 VNode 转为真实 DOM 并挂载</span>
    vm.<span class="hljs-property">$el</span> = vm.<span class="hljs-title function_">__patch__</span>(vm.<span class="hljs-property">$el</span>, vnode);
  }
};

<span class="hljs-comment">// patch 核心逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">patch</span>(<span class="hljs-params">oldVnode, vnode</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isRealElement</span>(oldVnode)) {
    oldVnode = <span class="hljs-title function_">emptyNodeAt</span>(oldVnode); <span class="hljs-comment">// 真实 DOM 转空 VNode</span>
  }
  <span class="hljs-title function_">createElm</span>(vnode, parentElm); <span class="hljs-comment">// 创建真实 DOM 并插入</span>
  <span class="hljs-title function_">removeVnodes</span>([oldVnode]); <span class="hljs-comment">// 移除旧节点</span>
}
</code></pre>
<p>代码块 1（src/core/instance/lifecycle.js）</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/core/instance/lifecycle.js</span>
<span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">_update</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">vnode: VNode, hydrating?: boolean</span>) {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">vm</span>: <span class="hljs-title class_">Component</span> = <span class="hljs-variable language_">this</span>
  <span class="hljs-keyword">const</span> prevEl = vm.<span class="hljs-property">$el</span>
  <span class="hljs-keyword">const</span> prevVnode = vm.<span class="hljs-property">_vnode</span>
  <span class="hljs-keyword">const</span> prevActiveInstance = activeInstance
  activeInstance = vm
  vm.<span class="hljs-property">_vnode</span> = vnode
  <span class="hljs-comment">// Vue.prototype.__patch__ is injected in entry points</span>
  <span class="hljs-comment">// based on the rendering backend used.</span>
  <span class="hljs-keyword">if</span> (!prevVnode) {
    <span class="hljs-comment">// initial render</span>
    vm.<span class="hljs-property">$el</span> = vm.<span class="hljs-title function_">__patch__</span>(vm.<span class="hljs-property">$el</span>, vnode, hydrating, <span class="hljs-literal">false</span> <span class="hljs-comment">/* removeOnly */</span>)
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// updates</span>
    vm.<span class="hljs-property">$el</span> = vm.<span class="hljs-title function_">__patch__</span>(prevVnode, vnode)
  }
  activeInstance = prevActiveInstance
  <span class="hljs-comment">// update __vue__ reference</span>
  <span class="hljs-keyword">if</span> (prevEl) {
    prevEl.<span class="hljs-property">__vue__</span> = <span class="hljs-literal">null</span>
  }
  <span class="hljs-keyword">if</span> (vm.<span class="hljs-property">$el</span>) {
    vm.<span class="hljs-property">$el</span>.<span class="hljs-property">__vue__</span> = vm
  }
  <span class="hljs-comment">// if parent is an HOC, update its $el as well</span>
  <span class="hljs-keyword">if</span> (vm.<span class="hljs-property">$vnode</span> &amp;&amp; vm.<span class="hljs-property">$parent</span> &amp;&amp; vm.<span class="hljs-property">$vnode</span> === vm.<span class="hljs-property">$parent</span>.<span class="hljs-property">_vnode</span>) {
    vm.<span class="hljs-property">$parent</span>.<span class="hljs-property">$el</span> = vm.<span class="hljs-property">$el</span>
  }
  <span class="hljs-comment">// updated hook is called by the scheduler to ensure that children are</span>
  <span class="hljs-comment">// updated in a parent's updated hook.</span>
}
</code></pre>
<p><code>_update</code> 里最核心的方法就是 <code>vm.__patch__</code> 方法，不同平台的 <code>patch</code> 方法的定义稍有不同，在 web 平台中它是这样定义的：</p>
<p>代码块 2（src/platforms/web/runtime/index.js）</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/platforms/web/runtime/index.js</span>
<span class="hljs-keyword">import</span> { patch } <span class="hljs-keyword">from</span> <span class="hljs-string">'./patch'</span>
<span class="hljs-comment">// install platform patch function</span>
<span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__patch__</span> = inBrowser ? patch : noop
</code></pre>
<p>可以看到 <code>__patch__</code> 实际调用的是 <code>patch</code> 方法。</p>
<p>代码块 3（src/platforms/web/runtime/patch.js）</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/platforms/web/runtime/patch.js</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> nodeOps <span class="hljs-keyword">from</span> <span class="hljs-string">'web/runtime/node-ops'</span>
<span class="hljs-keyword">import</span> { createPatchFunction } <span class="hljs-keyword">from</span> <span class="hljs-string">'core/vdom/patch'</span>
<span class="hljs-keyword">import</span> baseModules <span class="hljs-keyword">from</span> <span class="hljs-string">'core/vdom/modules/index'</span>
<span class="hljs-keyword">import</span> platformModules <span class="hljs-keyword">from</span> <span class="hljs-string">'web/runtime/modules/index'</span>

<span class="hljs-comment">// the directive module should be applied last, after all</span>
<span class="hljs-comment">// built-in modules have been applied.</span>
<span class="hljs-keyword">const</span> modules = platformModules.<span class="hljs-title function_">concat</span>(baseModules)

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">patch</span>: <span class="hljs-title class_">Function</span> = <span class="hljs-title function_">createPatchFunction</span>({ nodeOps, modules })
</code></pre>
<p>而patch方法是由createPatchFunction方法创建返回出来的函数。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/core/vdom/patch.js</span>
<span class="hljs-keyword">const</span> hooks = [<span class="hljs-string">'create'</span>, <span class="hljs-string">'activate'</span>, <span class="hljs-string">'update'</span>, <span class="hljs-string">'remove'</span>, <span class="hljs-string">'destroy'</span>]

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createPatchFunction</span> (backend) {
  <span class="hljs-keyword">let</span> i, j
  <span class="hljs-keyword">const</span> cbs = {}
  <span class="hljs-keyword">const</span> { modules, nodeOps } = backend

  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; hooks.<span class="hljs-property">length</span>; i++) {
    cbs[hooks[i]] = []
    <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; modules.<span class="hljs-property">length</span>; j++) {
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(modules[j][hooks[i]])) {
        cbs[hooks[i]].<span class="hljs-title function_">push</span>(modules[j][hooks[i]])
      }
    }
  }

  <span class="hljs-comment">// ...</span>

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">patch</span> (oldVnode, vnode, hydrating, removeOnly) {
    <span class="hljs-comment">// ...</span>
  }
}
</code></pre>
<p>这里有两个比较重要的对象 <code>nodeOps</code> 和 <code>modules</code>：</p>
<ul>
<li><code>nodeOps</code> 是封装的原生 dom 操作方法，在生成真实节点树的过程中，dom 相关操作都是调用 <code>nodeOps</code> 内的方法。</li>
<li><code>modules</code> 是待执行的钩子函数，在进入函数时，会将不同模块的钩子函数分类放置到 <code>cbs</code> 中，其中包括自定义指令钩子函数、ref 钩子函数。在 <code>patch</code> 阶段，会根据操作节点的行为取出对应类型进行调用。</li>
</ul>
<h4 data-id="heading-6">Patch</h4>
<pre><code class="hljs language-js" lang="js"> <span class="hljs-comment">// initial render</span>
<span class="hljs-number">2</span> vm.<span class="hljs-property">$el</span> = vm.<span class="hljs-title function_">__patch__</span>(vm.<span class="hljs-property">$el</span>, vnode, hydrating, <span class="hljs-literal">false</span> <span class="hljs-comment">/* removeOnly */</span>)
</code></pre>
<p>在首次渲染时，<code>vm.$el</code> 对应的是根节点 dom 对象，也就是我们熟知的 id 为 app 的 div。它作为 <code>oldVnode</code> 参数传入 <code>patch</code>。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">patch</span>(<span class="hljs-params">oldVnode, vnode, hydrating, removeOnly</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isUndef</span>(vnode)) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(oldVnode)) <span class="hljs-title function_">invokeDestroyHook</span>(oldVnode)
    <span class="hljs-keyword">return</span>
  }

  <span class="hljs-keyword">let</span> isInitialPatch = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">const</span> insertedVnodeQueue = []

  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isUndef</span>(oldVnode)) {
    <span class="hljs-comment">// empty mount (likely as component), create new root element</span>
    isInitialPatch = <span class="hljs-literal">true</span>
    <span class="hljs-title function_">createElm</span>(vnode, insertedVnodeQueue)
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">const</span> isRealElement = <span class="hljs-title function_">isDef</span>(oldVnode.<span class="hljs-property">nodeType</span>)
    <span class="hljs-keyword">if</span> (!isRealElement &amp;&amp; <span class="hljs-title function_">sameVnode</span>(oldVnode, vnode)) {
      <span class="hljs-comment">// patch existing root node</span>
      <span class="hljs-title function_">patchVnode</span>(oldVnode, vnode, insertedVnodeQueue, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, removeOnly)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (isRealElement) {
        <span class="hljs-comment">// mounting to a real element</span>
        <span class="hljs-comment">// check if this is server-rendered content and if we can perform</span>
        <span class="hljs-comment">// a successful hydration.</span>
        <span class="hljs-keyword">if</span> (oldVnode.<span class="hljs-property">nodeType</span> === <span class="hljs-number">1</span> &amp;&amp; oldVnode.<span class="hljs-title function_">hasAttribute</span>(<span class="hljs-variable constant_">SSR_ATTR</span>)) {
          oldVnode.<span class="hljs-title function_">removeAttribute</span>(<span class="hljs-variable constant_">SSR_ATTR</span>)
          hydrating = <span class="hljs-literal">true</span>
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isTrue</span>(hydrating)) {
          <span class="hljs-keyword">if</span> (<span class="hljs-title function_">hydrate</span>(oldVnode, vnode, insertedVnodeQueue)) {
            <span class="hljs-title function_">invokeInsertHook</span>(vnode, insertedVnodeQueue, <span class="hljs-literal">true</span>)
            <span class="hljs-keyword">return</span> oldVnode
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> !== <span class="hljs-string">'production'</span>) {
            <span class="hljs-title function_">warn</span>(
              <span class="hljs-string">'The client-side rendered virtual DOM tree is not matching '</span> +
              <span class="hljs-string">'server-rendered content. This is likely caused by incorrect '</span> +
              <span class="hljs-string">'HTML markup, for example nesting block-level elements inside '</span> +
              <span class="hljs-string">'&lt;p&gt;, or missing &lt;tbody&gt;. Bailing hydration and performing '</span> +
              <span class="hljs-string">'full client-side render.'</span>
            )
          }
        }
        <span class="hljs-comment">// either not server-rendered, or hydration failed.</span>
        <span class="hljs-comment">// create an empty node and replace it</span>
        oldVnode = <span class="hljs-title function_">emptyNodeAt</span>(oldVnode)
      }

      <span class="hljs-comment">// replacing existing element</span>
      <span class="hljs-keyword">const</span> oldElm = oldVnode.<span class="hljs-property">elm</span>
      <span class="hljs-keyword">const</span> parentElm = nodeOps.<span class="hljs-title function_">parentNode</span>(oldElm)

      <span class="hljs-comment">// create new node</span>
      <span class="hljs-title function_">createElm</span>(
        vnode,
        insertedVnodeQueue,
        <span class="hljs-comment">// extremely rare edge case: do not insert if old element is in a</span>
        <span class="hljs-comment">// leaving transition. Only happens when combining transition +</span>
        <span class="hljs-comment">// keep-alive + HOCs. (#4590)</span>
        oldElm.<span class="hljs-property">_leaveCb</span> ? <span class="hljs-literal">null</span> : parentElm,
        nodeOps.<span class="hljs-title function_">nextSibling</span>(oldElm)
      )

      <span class="hljs-comment">// update parent placeholder node element, recursively</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(vnode.<span class="hljs-property">parent</span>)) {
        <span class="hljs-keyword">let</span> ancestor = vnode.<span class="hljs-property">parent</span>
        <span class="hljs-keyword">const</span> patchable = <span class="hljs-title function_">isPatchable</span>(vnode)
        <span class="hljs-keyword">while</span> (ancestor) {
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; cbs.<span class="hljs-property">destroy</span>.<span class="hljs-property">length</span>; ++i) {
            cbs.<span class="hljs-property">destroy</span>[i](ancestor)
          }
          ancestor.<span class="hljs-property">elm</span> = vnode.<span class="hljs-property">elm</span>
          <span class="hljs-keyword">if</span> (patchable) {
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; cbs.<span class="hljs-property">create</span>.<span class="hljs-property">length</span>; ++i) {
              cbs.<span class="hljs-property">create</span>[i](emptyNode, ancestor)
            }
            <span class="hljs-comment">// #6513</span>
            <span class="hljs-comment">// invoke insert hooks that may have been merged by create hooks.</span>
            <span class="hljs-comment">// e.g. for directives that uses the "inserted" hook.</span>
            <span class="hljs-keyword">const</span> insert = ancestor.<span class="hljs-property">data</span>.<span class="hljs-property">hook</span>.<span class="hljs-property">insert</span>
            <span class="hljs-keyword">if</span> (insert.<span class="hljs-property">merged</span>) {
              <span class="hljs-comment">// start at index 1 to avoid re-invoking component mounted hook</span>
              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; insert.<span class="hljs-property">fns</span>.<span class="hljs-property">length</span>; i++) {
                insert.<span class="hljs-property">fns</span>[i]()
              }
            }
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-title function_">registerRef</span>(ancestor)
          }
          ancestor = ancestor.<span class="hljs-property">parent</span>
        }
      }

      <span class="hljs-comment">// destroy old node</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(parentElm)) {
        <span class="hljs-title function_">removeVnodes</span>([oldVnode], <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(oldVnode.<span class="hljs-property">tag</span>)) {
        <span class="hljs-title function_">invokeDestroyHook</span>(oldVnode)
      }
    }
  }

  <span class="hljs-title function_">invokeInsertHook</span>(vnode, insertedVnodeQueue, isInitialPatch)
  <span class="hljs-keyword">return</span> vnode.<span class="hljs-property">elm</span>
}
</code></pre>
<p>通过检查属性 <code>nodeType</code>（真实节点才有的属性），判断 <code>oldVnode</code> 是否为真实节点。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> isRealElement = <span class="hljs-title function_">isDef</span>(oldVnode.<span class="hljs-property">nodeType</span>)
<span class="hljs-keyword">if</span> (isRealElement) {
  <span class="hljs-comment">// ...</span>
  oldVnode = <span class="hljs-title function_">emptyNodeAt</span>(oldVnode)
}
</code></pre>
<p>很明显第一次的 <code>isRealElement</code> 是为 <code>true</code>，因此会调用 <code>emptyNodeAt</code> 将其转为 VNode：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">emptyNodeAt</span> (elm) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(nodeOps.<span class="hljs-title function_">tagName</span>(elm).<span class="hljs-title function_">toLowerCase</span>(), {}, [], <span class="hljs-literal">undefined</span>, elm)
}
</code></pre>
<p>接着会调用 <code>createElm</code> 方法，它就是将 VNode 转为真实 dom 的核心方法：</p>
<h3 data-id="heading-7">递归创建DOM节点（createElm）</h3>
<p><code>createElm</code> 是 VNode 转真实 DOM 的核心方法：</p>
<ol>
<li>若为组件 VNode，调用 <code>createComponent</code> 实例化组件并递归挂载。</li>
<li>若为普通元素，通过 <code>nodeOps.createElement</code> 创建真实节点，赋值给 <code>vnode.elm</code>。</li>
<li>递归调用 <code>createChildren</code> 处理子节点，将子节点插入当前节点（先子后父的插入顺序）。</li>
<li>调用 <code>insert</code> 方法将节点插入父容器（使用 <code>appendChild</code> 或 <code>insertBefore</code>）。</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createElm</span> (
  vnode,
  insertedVnodeQueue,
  parentElm,
  refElm,
  nested,
  ownerArray,
  index
) {
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(vnode.<span class="hljs-property">elm</span>) &amp;&amp; <span class="hljs-title function_">isDef</span>(ownerArray)) {
    <span class="hljs-comment">// This vnode was used in a previous render!</span>
    <span class="hljs-comment">// now it's used as a new node, overwriting its elm would cause</span>
    <span class="hljs-comment">// potential patch errors down the road when it's used as an insertion</span>
    <span class="hljs-comment">// reference node. Instead, we clone the node on-demand before creating</span>
    <span class="hljs-comment">// associated DOM element for it.</span>
    vnode = ownerArray[index] = <span class="hljs-title function_">cloneVNode</span>(vnode)
  }

  vnode.<span class="hljs-property">isRootInsert</span> = !nested <span class="hljs-comment">// for transition enter check</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">createComponent</span>(vnode, insertedVnodeQueue, parentElm, refElm)) {
    <span class="hljs-keyword">return</span>
  }

  <span class="hljs-keyword">const</span> data = vnode.<span class="hljs-property">data</span>
  <span class="hljs-keyword">const</span> children = vnode.<span class="hljs-property">children</span>
  <span class="hljs-keyword">const</span> tag = vnode.<span class="hljs-property">tag</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(tag)) {
    vnode.<span class="hljs-property">elm</span> = vnode.<span class="hljs-property">ns</span>
      ? nodeOps.<span class="hljs-title function_">createElementNS</span>(vnode.<span class="hljs-property">ns</span>, tag)
      : nodeOps.<span class="hljs-title function_">createElement</span>(tag, vnode)
    <span class="hljs-title function_">setScope</span>(vnode)

    <span class="hljs-comment">/* istanbul ignore if */</span>
    <span class="hljs-keyword">if</span> (__WEEX__) {
      <span class="hljs-comment">// ...</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">createChildren</span>(vnode, children, insertedVnodeQueue) <span class="hljs-comment">// 递归创建子节点</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(data)) {
        <span class="hljs-title function_">invokeCreateHooks</span>(vnode, insertedVnodeQueue)
      }
      <span class="hljs-title function_">insert</span>(parentElm, vnode.<span class="hljs-property">elm</span>, refElm)
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> !== <span class="hljs-string">'production'</span> &amp;&amp; data &amp;&amp; data.<span class="hljs-property">pre</span>) {
    creatingElmInPre--
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isTrue</span>(vnode.<span class="hljs-property">isComment</span>)) {
    vnode.<span class="hljs-property">elm</span> = nodeOps.<span class="hljs-title function_">createComment</span>(vnode.<span class="hljs-property">text</span>)
    <span class="hljs-title function_">insert</span>(parentElm, vnode.<span class="hljs-property">elm</span>, refElm) <span class="hljs-comment">// 插入父节点</span>
  } <span class="hljs-keyword">else</span> {
    vnode.<span class="hljs-property">elm</span> = nodeOps.<span class="hljs-title function_">createTextNode</span>(vnode.<span class="hljs-property">text</span>)
    <span class="hljs-title function_">insert</span>(parentElm, vnode.<span class="hljs-property">elm</span>, refElm)
  }
}
</code></pre>
<p>一开始会调用 <code>createComponent</code> 尝试创建组件类型的节点，如果成功会返回 <code>true</code>。在创建过程中也会调用 <code>$mount</code> 进行组件范围内的挂载，所以走的还是 <code>patch</code> 这套流程。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">if</span> (<span class="hljs-title function_">createComponent</span>(vnode, insertedVnodeQueue, parentElm, refElm)) {
  <span class="hljs-keyword">return</span>
}
</code></pre>
<p>如果没有完成创建，代表该 VNode 对应的是真实节点，往下继续创建真实节点的逻辑。</p>
<pre><code class="hljs language-js" lang="js">vnode.<span class="hljs-property">elm</span> = vnode.<span class="hljs-property">ns</span>
  ? nodeOps.<span class="hljs-title function_">createElementNS</span>(vnode.<span class="hljs-property">ns</span>, tag)
  : nodeOps.<span class="hljs-title function_">createElement</span>(tag, vnode)
</code></pre>
<p>根据 <code>tag</code> 创建对应类型真实节点，赋值给 <code>vnode.elm</code>，它作为父节点容器，创建的子节点会被放到里面。</p>
<p>然后调用 <code>createChildren</code> 创建子节点：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createChildren</span> (vnode, children, insertedVnodeQueue) {
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(children)) {
    <span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> !== <span class="hljs-string">'production'</span>) {
      <span class="hljs-title function_">checkDuplicateKeys</span>(children)
    }
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; children.<span class="hljs-property">length</span>; ++i) {
      <span class="hljs-title function_">createElm</span>(children[i], insertedVnodeQueue, vnode.<span class="hljs-property">elm</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>, children, i)
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isPrimitive</span>(vnode.<span class="hljs-property">text</span>)) {
    nodeOps.<span class="hljs-title function_">appendChild</span>(vnode.<span class="hljs-property">elm</span>, nodeOps.<span class="hljs-title function_">createTextNode</span>(<span class="hljs-title class_">String</span>(vnode.<span class="hljs-property">text</span>)))
  }
}
</code></pre>
<p>内部进行遍历子节点数组，再次调用 <code>createElm</code> 创建节点，而上面创建的 <code>vnode.elm</code> 作为父节点传入。如此循环，直到没有子节点，就会创建文本节点插入到 <code>vnode.elm</code> 中。</p>
<p>执行完成后出来，会调用 <code>invokeCreateHooks</code>，它负责执行 dom 操作时的 <code>create</code> 钩子函数，同时将 VNode 加入到 <code>insertedVnodeQueue</code> 中：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">invokeCreateHooks</span> (vnode, insertedVnodeQueue) {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; cbs.<span class="hljs-property">create</span>.<span class="hljs-property">length</span>; ++i) {
    cbs.<span class="hljs-property">create</span>[i](emptyNode, vnode)
  }
  i = vnode.<span class="hljs-property">data</span>.<span class="hljs-property">hook</span> <span class="hljs-comment">// Reuse variable</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(i)) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(i.<span class="hljs-property">create</span>)) i.<span class="hljs-title function_">create</span>(emptyNode, vnode)
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(i.<span class="hljs-property">insert</span>)) insertedVnodeQueue.<span class="hljs-title function_">push</span>(vnode)
  }
}
</code></pre>
<h3 data-id="heading-8">插入到父节点</h3>
<p>最后一步就是调用 <code>insert</code> 方法将节点插入到父节点：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">insert</span> (parent, elm, ref) {
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(parent)) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(ref)) {
      <span class="hljs-keyword">if</span> (nodeOps.<span class="hljs-title function_">parentNode</span>(ref) === parent) {
        nodeOps.<span class="hljs-title function_">insertBefore</span>(parent, elm, ref)
      }
    } <span class="hljs-keyword">else</span> {
      nodeOps.<span class="hljs-title function_">appendChild</span>(parent, elm)
    }
  }
}
</code></pre>
<p>可以看到 Vue 是通过递归调用 <code>createElm</code> 来创建节点树的。同时也说明最深的子节点会先调用 <code>insert</code> 插入节点。所以整个节点树的插入顺序是 “先子后父”。插入节点方法就是原生 dom 的方法 <code>insertBefore</code> 和 <code>appendChild</code>。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDef</span>(parentElm)) {
  <span class="hljs-title function_">removeVnodes</span>([oldVnode], <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
}
</code></pre>
<p><code>createElm</code> 流程走完后，构建完成的节点树已经插入到页面上了。其实 Vue 在初始化渲染页面时，并不是把原来的根节点 <code>app</code> 给真正替换掉，而是在其后面插入一个新的节点，接着再把旧节点给移除掉。</p>
<p>所以在 <code>createElm</code> 之后会调用 <code>removeVnodes</code> 来移除旧节点，它里面同样是调用的原生 dom 方法 <code>removeChild</code>。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">invokeInsertHook</span>(vnode, insertedVnodeQueue, isInitialPatch)
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">invokeInsertHook</span> (vnode, queue, initial) {
  <span class="hljs-comment">// delay insert hooks for component root nodes, invoke them after the</span>
  <span class="hljs-comment">// element is really inserted</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isTrue</span>(initial) &amp;&amp; <span class="hljs-title function_">isDef</span>(vnode.<span class="hljs-property">parent</span>)) {
    vnode.<span class="hljs-property">parent</span>.<span class="hljs-property">data</span>.<span class="hljs-property">pendingInsert</span> = queue
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; queue.<span class="hljs-property">length</span>; ++i) {
      queue[i].<span class="hljs-property">data</span>.<span class="hljs-property">hook</span>.<span class="hljs-title function_">insert</span>(queue[i])
    }
  }
}
</code></pre>
<p>在 <code>patch</code> 的最后就是调用 <code>invokeInsertHook</code> 方法，触发节点插入的钩子函数。</p>
<p>至此整个页面渲染的流程完毕。</p>
<h3 data-id="heading-9">完成渲染</h3>
<ul>
<li>触发 <code>mounted</code> 生命周期钩子（所有子组件挂载完成后），页面渲染完毕。</li>
</ul>
<h2 data-id="heading-10">二、更新渲染流程（数据变化时）</h2>
<p>当响应式数据变化时，触发渲染 Watcher 的更新，重新执行 <code>updateComponent</code>，流程如下：</p>
<ol>
<li>触发 <code>beforeUpdate</code> 生命周期钩子。</li>
<li>重新调用 <code>vm._render()</code> 生成新 VNode。</li>
<li>调用 <code>vm._update()</code>，通过 <code>patch</code> 对比新旧 VNode（<code>sameVnode</code> 检查）：
<ul>
<li>若为同一节点，调用 <code>patchVnode</code> 对比并更新差异（属性、文本、子节点等）。</li>
<li>若为不同节点，直接创建新节点并替换旧节点。</li>
</ul>
</li>
<li>触发 <code>updated</code> 生命周期钩子，完成更新。</li>
</ol>
<h2 data-id="heading-11">三、总结</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f13cbd2135024957b1bd8674cc7e1691~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764233610&amp;x-signature=AU%2Bg%2Fud%2BXASNruVu97%2FRJtDTyyo%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>初始化调用<code>$mount</code>挂载组件。
-<code> _render</code>开始构建<code>VNode</code>，核心方法为<code>createElement</code>，一般会创建普通的<code>VNode</code>，遇到组件就创建组件类型的<code>VNode</code>，否则就是未知标签的<code>VNode</code>,构建完成传递给<code>_update</code>。</li>
<li><code>patch</code>阶段根据<code>VNode</code>创建真实节点树，核心方法为<code>createElm</code>,首选遇到组件类型的<code>VNode</code>,内部会执行<code>$mount</code>,再走一遍相同的流程。普通节点类型则创建一个真实的节点，如果它有子节点开始递归调用<code>createElm</code>，使用<code>insert</code>插入子节点，直到没有子节点就填充内容节点。</li>
<li>最后递归完成后，同样也是使用<code>insert</code>将整个节点树插入到页面中，再将旧的根节点移除。</li>
</ul>
<blockquote>
<ol>
<li><strong>初始化渲染</strong>：<code>new Vue()</code> → <code>_init</code> → <code>$mount</code> → <code>mountComponent</code> → <code>_render</code>（生成 VNode） → <code>_update</code>（<code>patch</code> 生成真实 DOM）。</li>
<li><strong>更新渲染</strong>：数据变化 → 渲染 Watcher 触发 → 重新生成 VNode → <code>patch</code> 对比更新 DOM。</li>
<li>核心思想：通过 VNode 抽象 DOM，减少直接操作 DOM 的开销，通过 Diff 算法高效更新差异。</li>
</ol>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[苹果悄悄上线网页版 App Store！官方出品调研竞品更方便~]]></title>    <link>https://juejin.cn/post/7574727105705082920</link>    <guid>https://juejin.cn/post/7574727105705082920</guid>    <pubDate>2025-11-21T06:26:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574727105705082920" data-draft-id="7574869203448004608" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="苹果悄悄上线网页版 App Store！官方出品调研竞品更方便~"/> <meta itemprop="keywords" content="APP,Apple,uni-app"/> <meta itemprop="datePublished" content="2025-11-21T06:26:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iOS研究院"/> <meta itemprop="url" content="https://juejin.cn/user/1421041942671774"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            苹果悄悄上线网页版 App Store！官方出品调研竞品更方便~
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1421041942671774/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iOS研究院
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T06:26:05.000Z" title="Fri Nov 21 2025 06:26:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>苹果悄然推出了网页版 App Store（官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fapps.apple.com%2Fcn" target="_blank" title="https://apps.apple.com/cn" ref="nofollow noopener noreferrer">apps.apple.com/cn</a>），无需依赖 iOS 或 macOS 设备，只要打开浏览器，无论是安卓手机、Windows 电脑还是其他终端，都能轻松访问 App Store 的丰富内容。不过目前网页版仅支持浏览、搜索应用，屏蔽了下载功能改为了分享。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcb13dec4c6d4d0099833c19ee41e8f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764311165&amp;x-signature=WxMJIbkMkPkU%2B6JAWdujSkLEQTU%3D" alt="企业微信20251121-141812.png" loading="lazy"/></p>
<h2 data-id="heading-0">核心亮点：多地区快速切换 + 全设备专区适配</h2>
<p>网页版 App Store 最让人惊喜的，莫过于<strong>无门槛切换全球地区商店</strong>。用户只需修改网址中的两位地区代码（遵循《ISO 31666-1》标准，小写格式），就能一键跳转至对应国家 / 地区的 App Store，比如：</p>
<ul>
<li>中国大陆：<a href="https://link.juejin.cn?target=https%3A%2F%2Fapps.apple.com%2Fcn%2F" target="_blank" title="https://apps.apple.com/cn/" ref="nofollow noopener noreferrer">apps.apple.com/cn/</a></li>
<li>中国香港：<a href="https://link.juejin.cn?target=https%3A%2F%2Fapps.apple.com%2Fhk%2F" target="_blank" title="https://apps.apple.com/hk/" ref="nofollow noopener noreferrer">apps.apple.com/hk/</a></li>
<li>日本：<a href="https://link.juejin.cn?target=https%3A%2F%2Fapps.apple.com%2Fjp%2F" target="_blank" title="https://apps.apple.com/jp/" ref="nofollow noopener noreferrer">apps.apple.com/jp/</a></li>
<li>美国：<a href="https://link.juejin.cn?target=https%3A%2F%2Fapps.apple.com%2Fus%2F" target="_blank" title="https://apps.apple.com/us/" ref="nofollow noopener noreferrer">apps.apple.com/us/</a></li>
<li>新加坡：<a href="https://link.juejin.cn?target=https%3A%2F%2Fapps.apple.com%2Fsg%2F" target="_blank" title="https://apps.apple.com/sg/" ref="nofollow noopener noreferrer">apps.apple.com/sg/</a></li>
</ul>
<p>无需注册登录，也不用切换账号地区，就能直接查看目标地区的应用榜单、同类型产品分布，以及特定应用的价格、评分、用户评论等核心信息，操作简单到离谱。</p>
<p>同时，网页版几乎 1:1 复刻了移动端 App Store 的视觉设计和功能布局，还新增了<strong>设备专区切换功能</strong>—— 左侧菜单栏可直接选择 Mac、iPad、Vision、Watch 等设备，无需拥有对应硬件，就能直观查看应用在不同设备上的展示效果，比如 iPad 端的 5 图排版、Watch 端的适配界面等。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acaae84f634e4b44b56252bcab00af49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764311165&amp;x-signature=aP0qdDYjNyrf0WLlL05T1Xl2SSE%3D" alt="2.png" loading="lazy"/></p>
<h2 data-id="heading-1">核心实用场景，精准匹配开发者与产品人核心需求</h2>
<h3 data-id="heading-2">1. 出海竞品调研提速，摆脱第三方工具束缚</h3>
<p>过去做海外市场调研，查看不同地区 App Store 的榜单动态、竞品详情，只能依赖点点数据这类第三方平台。不仅要完成登录流程，还面临加载迟缓、数据滞后的问题，部分关键数据甚至需要开通 VIP 才能解锁。网页版 App Store 直接打通全球地区商店通道，无需借助任何额外工具，就能实时获取目标地区的竞品核心信息，从榜单趋势到应用评分、评论、价格等详情全掌握，让出海调研效率大幅提升。</p>
<h3 data-id="heading-3">2. 多设备适配核查零门槛，独立开发者福音</h3>
<p>独立开发者或小型团队往往难以配齐 Mac、iPad、Vision、Apple Watch 等所有苹果设备，给多设备适配调研带来阻碍。网页版的设备专区切换功能恰好解决了这一难题，左上角下拉菜单即可一键切换至对应设备的专属应用页面。想确认自家应用在 Mac 端的展示效果，或是调研 Watch 端的热门应用类型，只需打开浏览器就能直观查看，零成本完成多设备适配验证。</p>
<h3 data-id="heading-4">3. 跨平台无障碍访问，安卓 / Windows 用户不用再借设备</h3>
<p>产品经理、运营人员常需调研 App Store 上的应用，但如果手边只有安卓手机或 Windows 电脑，此前只能向同事借用苹果设备才能完成。网页版 App Store 打破了设备系统限制，任何浏览器都能直接访问，跨平台即可轻松浏览应用详情，再也不用为查询一个应用地址而四处借设备。</p>
<h3 data-id="heading-5">4. 应用链接分享更高效，告别繁琐查找流程</h3>
<p>运营或市场人员需要产品的 App Store 链接时，过去要么翻找存档文档，要么通过第三方平台搜索跳转后复制 URL。现在网页版提供了集中式的应用聚合入口，直接打开网页搜索应用名称，就能快速复制浏览器 URL 一键分享，甚至可让同事自行搜索获取，彻底省去反复沟通查找的麻烦，缩短信息传递路径。</p>
<h3 data-id="heading-6">5. 大屏交互体验升级，操作效率再提升</h3>
<p>电脑端的大屏优势在网页版 App Store 中得到充分发挥，配合键盘输入搜索，操作比手机端更高效。无论是批量筛选竞品、同时对比多个应用详情，还是沉浸式浏览应用截图与用户评论，体验都更为流畅直观。这种差异就像网页版视频对比手机端，在信息获取和操作便捷性上都有明显提升，让应用调研和探索更省心。</p>
<h2 data-id="heading-7">结语</h2>
<p>苹果这次低调上线的网页版 App Store，没有大肆宣传，却精准戳中了开发者、产品人、运营等群体的核心需求。它打破了设备和地区的限制，让 App Store 的内容触达更便捷，无论是竞品调研、跨设备适配查看，还是日常应用浏览、分享，都变得更高效、更省心。</p>
<p>对于开发者和产品人来说，这无疑是一份惊喜福利，也让我们看到了苹果在生态开放上的微小但重要的进步。如果你常需要和 App Store 打交道，不妨赶紧收藏网址，体验这份 “无门槛逛店” 的快乐～</p>
<p><code>遵守规则，方得长治久安</code>，最后祝大家大吉大利，今晚过审！</p>
<h3 data-id="heading-8">相关推荐</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FURmC_4vxQv5ttOg8yYe7Eg" target="_blank" title="https://mp.weixin.qq.com/s/URmC_4vxQv5ttOg8yYe7Eg" ref="nofollow noopener noreferrer"># 苹果开发者续费大坑及成功续费方案！亲测有效</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F1bAA90Tzpx03tTHZbdg3aw" target="_blank" title="https://mp.weixin.qq.com/s/1bAA90Tzpx03tTHZbdg3aw" ref="nofollow noopener noreferrer"># AppStore敏感词排查手册，多维度分析Guideline 2.3.1隐藏功能，轻松过审。</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484371%26idx%3D1%26sn%3D33568c58e90a5bf4d2612d803ecb2a27%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484371&amp;idx=1&amp;sn=33568c58e90a5bf4d2612d803ecb2a27&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 苹果加急审核是“绿色通道”还是“死亡陷阱”？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484362%26idx%3D1%26sn%3Dea61bd42d5ae8b99d2a56cbfb8d91e88%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484362&amp;idx=1&amp;sn=ea61bd42d5ae8b99d2a56cbfb8d91e88&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 苹果开发者邮箱，突然收到11.2通知严重么？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484413%26idx%3D1%26sn%3D82870d4c8892fa65803a8e05fd5ac938%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484413&amp;idx=1&amp;sn=82870d4c8892fa65803a8e05fd5ac938&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 不想被苹果卡审最好错开这两个提审时间</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484349%26idx%3D1%26sn%3D1c75a6b08cb5de64ddf41a88b61ff108%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484349&amp;idx=1&amp;sn=1c75a6b08cb5de64ddf41a88b61ff108&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 手撕苹果审核4.3是代码问题还是设计问题？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484344%26idx%3D1%26sn%3D4399eb8d8bf82e9c5df26a18b8564cfb%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484344&amp;idx=1&amp;sn=4399eb8d8bf82e9c5df26a18b8564cfb&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 有幸和Appstore审核人员进行了一场视频会议特此记录。</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手把手教你实现 Rust 迭代器]]></title>    <link>https://juejin.cn/post/7574251313884250127</link>    <guid>https://juejin.cn/post/7574251313884250127</guid>    <pubDate>2025-11-20T00:54:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574251313884250127" data-draft-id="7571355989132771343" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手把手教你实现 Rust 迭代器"/> <meta itemprop="keywords" content="Rust"/> <meta itemprop="datePublished" content="2025-11-20T00:54:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RockByte"/> <meta itemprop="url" content="https://juejin.cn/user/1046390797768519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手把手教你实现 Rust 迭代器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390797768519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RockByte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T00:54:59.000Z" title="Thu Nov 20 2025 00:54:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#5f6368;background-image:linear-gradient(90deg,rgba(240,191,213,.1) 3%,transparent 0),linear-gradient(1turn,rgba(240,191,213,.1) 3%,transparent 0);background-size:20px 20px;background-position:50%;letter-spacing:1px;word-spacing:1px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-left:50px;padding-bottom:5px;color:#5f6368}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{position:absolute;left:0;display:block;content:""}.markdown-body h1{font-size:32px;margin-bottom:5px}.markdown-body h1:before{top:0;content:"🦄";font-size:32px}.markdown-body h2{padding-bottom:24px;border-bottom:1px solid #ececec}.markdown-body h2:before{top:0;left:8px;content:"🐳";font-size:24px}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{top:-2px;left:8px;content:"🐄";font-size:20px}.markdown-body h4{font-size:16px}.markdown-body h4:before{top:-2px;left:8px;content:"🦥";font-size:18px}.markdown-body h5{font-size:14px}.markdown-body h5:before{top:-2px;left:9px;content:"🦩";font-size:16px}.markdown-body h6{font-size:12px;margin-top:5px}.markdown-body h6:before{top:-1px;left:10px;content:"🐧";font-size:14px}.markdown-body p{line-height:1.9;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid rgba(253,121,168,.5);margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#a6accd;background:#292d3e;border-radius:8px}.markdown-body a{text-decoration:none;color:#fd79a8;border-bottom:1px solid #fd79a8;padding:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(253,121,168,.1);color:#ee69a9}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body th{color:#fd79a8}.markdown-body th,.markdown-body tr:hover{background:rgba(253,121,168,.1)}.markdown-body td{min-width:120px}.markdown-body blockquote{position:relative;color:#666;padding:23px;margin:22px 0;border-left:4px solid #ee69a9;background-color:rgba(253,121,168,.1)}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;display:block;font-size:27px;color:#fd79a8;opacity:.8}.markdown-body blockquote:before{left:10px;top:0;content:"❝"}.markdown-body blockquote:after{right:10px;bottom:0;content:"❞"}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body strong{position:relative;color:#fd79a8}.markdown-body strong:before{content:"· "}.markdown-body strong:after{content:" ·"}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#fd79a8}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#ee69a9}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}</style><style data-highlight="" data-highlight-key="xcode">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.xml .hljs-meta{color:silver}.hljs-comment,.hljs-quote{color:#007400}.hljs-attribute,.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-tag{color:#aa0d91}.hljs-template-variable,.hljs-variable{color:#3f6e74}.hljs-code,.hljs-meta-string,.hljs-string{color:#c41a16}.hljs-link,.hljs-regexp{color:#0e0eff}.hljs-bullet,.hljs-number,.hljs-symbol,.hljs-title{color:#1c00cf}.hljs-meta,.hljs-section{color:#643820}.hljs-built_in,.hljs-builtin-name,.hljs-class .hljs-title,.hljs-params,.hljs-type{color:#5c2699}.hljs-attr{color:#836c28}.hljs-subst{color:#000}.hljs-formula{background-color:#eee;font-style:italic}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-selector-class,.hljs-selector-id{color:#9b703f}.hljs-doctag,.hljs-strong{font-weight:700}.hljs-emphasis{font-style:italic}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15c6522aca6c455eb033fa92e4593acb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764204899&amp;x-signature=Q632iWiQ3UHqHpydBhqxNqGUNYc%3D" alt="0.png" loading="lazy"/></p>
<p>在完成前面三篇关于 Rust 迭代器的深入学习之后，本篇文章我们尝试自己写一下 Rust 迭代器，即给我们自己的数据加上迭代器的功能。</p>
<p>如果有读者想复习之前的文章：</p>
<ul>
<li><a href="https://juejin.cn/post/7566474134688595983" target="_blank" title="https://juejin.cn/post/7566474134688595983">深入 Rust 迭代器（上）</a></li>
<li><a href="https://juejin.cn/post/7568471321954779170" target="_blank" title="https://juejin.cn/post/7568471321954779170">深入 Rust 迭代器（中）</a></li>
<li><a href="https://juejin.cn/post/7572028313930776616" target="_blank" title="https://juejin.cn/post/7572028313930776616">深入 Rust 迭代器（下）</a></li>
</ul>
<h2 data-id="heading-0">开始之前</h2>
<p>Rust 原生的 <code>Vec</code> 以及数组，已经支持迭代器相关功能了：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">a</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];

<span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> &amp;a {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, i);
}

a.<span class="hljs-title function_ invoke__">iter_mut</span>().<span class="hljs-title function_ invoke__">for_each</span>(|i| {
    *i = <span class="hljs-number">100</span>;
});

<span class="hljs-built_in">println!</span>(<span class="hljs-string">"{:?}"</span>, a);

<span class="hljs-comment">// output</span>
<span class="hljs-comment">// 1</span>
<span class="hljs-comment">// 2</span>
<span class="hljs-comment">// 3</span>
<span class="hljs-comment">// [100, 100, 100]</span>
</code></pre>
<p><em>上述代码如果将 <code>vec![1, 2, 3]</code> 改成 <code>[1, 2, 3]</code>，效果是一样的。</em></p>
<p>如果你的数据结构有基于 <code>Vec</code> 或者数组去实现迭代器，其实可以直接用 <code>Vec</code> 或者数组的迭代器，完全没有必要自己实现。</p>
<p>但是为了让我们更加了解迭代器的内部原理以及相关的实现细节，该篇文章我们尝试为自己的数据实现一个迭代器。</p>
<p>首先，你需要一个简单的类：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[derive(Debug)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Rect</span> {
    a: <span class="hljs-type">f32</span>,
    b: <span class="hljs-type">f32</span>,
    c: <span class="hljs-type">f32</span>,
    d: <span class="hljs-type">f32</span>,
}
</code></pre>
<h2 data-id="heading-1">为类实现迭代器</h2>
<p>在 <a href="https://juejin.cn/post/7566474134688595983" target="_blank" title="https://juejin.cn/post/7566474134688595983">深入 Rust 迭代器（上）</a> 文中已经知道，如果我们要为自己的数据实现一个迭代器，就需要实现 <code>Iterator</code> <code>trait</code>。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Iterator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Rect</span> {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = <span class="hljs-type">f32</span>;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">next</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>::Item&gt; {
        <span class="hljs-comment">//...</span>
    }
}
</code></pre>
<p>该 <code>trait</code> 需要实现的函数非常简单 —— <code>next</code> 即可。</p>
<p><code>next</code> 返回一个 <code>Option</code>，如果迭代器结束，直接返回 <code>None</code>。</p>
<p>为了能够实现迭代器功能，我们需要对 <code>Rect</code> 进行一点改造，添加一个迭代器下标：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[derive(Debug)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Rect</span> {
    a: <span class="hljs-type">f32</span>,
    b: <span class="hljs-type">f32</span>,
    c: <span class="hljs-type">f32</span>,
    d: <span class="hljs-type">f32</span>,

    iter_index:<span class="hljs-type">u8</span>, <span class="hljs-comment">// 用于计数当前迭代的位置</span>
}
</code></pre>
<p>然后，为 <code>Rect</code> 实现迭代器：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Iterator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Rect</span> {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = <span class="hljs-type">f32</span>;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">next</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>::Item&gt; {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">next</span> = <span class="hljs-keyword">match</span> <span class="hljs-keyword">self</span>.iter_index {
            <span class="hljs-number">0</span> =&gt; {
                <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.a)
            }
            <span class="hljs-number">1</span> =&gt; {
                <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.b)
            }
            <span class="hljs-number">2</span> =&gt; {
                <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.c)
            }
            <span class="hljs-number">3</span> =&gt; {
                <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.d)
            }
            _ =&gt; <span class="hljs-literal">None</span>,
        };

        <span class="hljs-keyword">self</span>.iter_index += <span class="hljs-number">1</span>;

        next
    }
}
</code></pre>
<p><em>现在知道为什么 <code>next</code> 需要的入参是 <code>&amp;mut self</code> 了吧！</em></p>
<p>每次调用 <code>next</code> 的时候，我们先返回当前的值，然后对迭代的下标 <code>+1</code>。</p>
<p>如果迭代结束了，则返回 <code>None</code>。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">rect</span> = Rect {
    a: <span class="hljs-number">1.0</span>,
    b: <span class="hljs-number">2.0</span>,
    c: <span class="hljs-number">3.0</span>,
    d: <span class="hljs-number">4.0</span>,
    iter_index: <span class="hljs-number">0</span>,
};

<span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> rect {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, i);
}

<span class="hljs-comment">// output</span>
<span class="hljs-comment">// 1</span>
<span class="hljs-comment">// 2</span>
<span class="hljs-comment">// 3</span>
<span class="hljs-comment">// 4</span>
</code></pre>
<p>OK，很简单。</p>
<p>但是这样写，会有两个严重问题：</p>
<ul>
<li><code>iter_index</code> 对迭代的影响很大，如果这个值设置错误，迭代就不能从头开始。</li>
<li>无法再次使用迭代，即不能再次使用 <code>for i in rect</code>。</li>
</ul>
<p>我们来看第一个问题，如果我们给 <code>iter_index</code> 为 <code>3</code>。结果就会变成：</p>
<pre><code class="hljs language-txt" lang="txt">4
</code></pre>
<p>对，只会输出一个 <code>4</code>，因为我们的 <code>next</code> 实现，是基于 <code>iter_index</code> 做的。</p>
<p>第二个问题，当我们再次使用 <code>rect</code> 进行迭代的时候：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/783ddd43b6e74cdbb4e06d6a176b1dcb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764204899&amp;x-signature=InEjz2VEKQz5Dw8Kv6n8fqBoBQ0%3D" alt="1.png" loading="lazy"/></p>
<p>会得到这样一个错误。</p>
<p>原因是，<code>for i in rect</code> 是 Rust 提供的语法糖，实际上那段代码会被编译成如下的代码：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">iter</span> = <span class="hljs-built_in">IntoIterator</span>::<span class="hljs-title function_ invoke__">into_iter</span>(collection);
<span class="hljs-keyword">loop</span> {
    <span class="hljs-keyword">match</span> iter.<span class="hljs-title function_ invoke__">next</span>() {
        <span class="hljs-title function_ invoke__">Some</span>(i) =&gt; {
            <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, i);
        }
        <span class="hljs-literal">None</span> =&gt; <span class="hljs-keyword">break</span>,
    }
}
</code></pre>
<p>查看 <code>IntoIterator::into_iter</code> 的源码，我们发现：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[inline]</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">into_iter</span>(<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> I {
    <span class="hljs-keyword">self</span>
}
</code></pre>
<p><code>IntoIterator::into_iter</code> 会获取入参的所有权，这也就是为什么不能写两次 <code>for i in rect</code> 的原因。</p>
<p>为了解决上面两个问题，我们看看正确的迭代器是如何实现的。</p>
<h2 data-id="heading-2">IntoIterator</h2>
<p>Rust 提供了一个 <code>trait</code> —— <code>IntoIterator</code>，它的作用就是<strong>把一个“可迭代的东西”（比如容器）转换成一个“迭代器”</strong>。</p>
<p>这里，我们的 <code>Rect</code> 就是一个可迭代的数据，通过实现 <code>IntoIterator</code> 就可以变成一个迭代器了。</p>
<pre><code class="hljs language-rust" lang="rust">
<span class="hljs-meta">#[derive(Debug)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Rect</span> {
    a: <span class="hljs-type">f32</span>,
    b: <span class="hljs-type">f32</span>,
    c: <span class="hljs-type">f32</span>,
    d: <span class="hljs-type">f32</span>,
    <span class="hljs-comment">// 这里去掉了 iter_index</span>
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">RectIter</span> {
    data: Rect,
    iter_index: <span class="hljs-type">u8</span>,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Iterator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">RectIter</span> {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = <span class="hljs-type">f32</span>;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">next</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>::Item&gt; {
        <span class="hljs-keyword">match</span> <span class="hljs-keyword">self</span>.iter_index {
            <span class="hljs-number">0</span> =&gt; {
                <span class="hljs-keyword">self</span>.iter_index += <span class="hljs-number">1</span>;
                <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.data.a)
            }
            <span class="hljs-number">1</span> =&gt; {
                <span class="hljs-keyword">self</span>.iter_index += <span class="hljs-number">1</span>;
                <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.data.b)
            }
            <span class="hljs-number">2</span> =&gt; {
                <span class="hljs-keyword">self</span>.iter_index += <span class="hljs-number">1</span>;
                <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.data.c)
            }
            <span class="hljs-number">3</span> =&gt; {
                <span class="hljs-keyword">self</span>.iter_index += <span class="hljs-number">1</span>;
                <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.data.d)
            }
            _ =&gt; <span class="hljs-literal">None</span>,
        }
    }
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">IntoIterator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Rect</span> {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = <span class="hljs-type">f32</span>;
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">IntoIter</span> = RectIter;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">into_iter</span>(<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span>::IntoIter {
        RectIter {
            data: <span class="hljs-keyword">self</span>,
            iter_index: <span class="hljs-number">0</span>,
        }
    }
}
</code></pre>
<p>读者会发现，我们对 <code>Rect</code> 实现了 <code>IntoIterator</code>，该 <code>trait</code> 要求返回一个 <code>IntoIter</code> 类型，<code>IntoIter</code> 实际上是 <code>type IntoIter: Iterator&lt;Item = Self::Item&gt;;</code>，也就是一个迭代器。</p>
<p>此处，我们定义了一个新的迭代器类型 <code>RectIter</code> 并实现了 <code>Iterator</code>，最后 <code>IntoIterator</code> 中的 <code>into_iter(self)</code> 返回 <code>RectIter</code>。</p>
<p>好的，现在我们来看看效果：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">rect</span> = Rect {
    a: <span class="hljs-number">1.0</span>,
    b: <span class="hljs-number">2.0</span>,
    c: <span class="hljs-number">3.0</span>,
    d: <span class="hljs-number">4.0</span>,
};

<span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> rect {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, i);
}

<span class="hljs-comment">// output</span>
<span class="hljs-comment">// 1</span>
<span class="hljs-comment">// 2</span>
<span class="hljs-comment">// 3</span>
<span class="hljs-comment">// 4</span>
</code></pre>
<p>我们不用再在 <code>Rect</code> 中定义迭代下标了，当使用迭代器的时候，<code>RectIter</code> 中的迭代下标，都会设置为 <code>0</code> 开始。</p>
<p>但是它依然没有解决重复使用的问题，也就是我们不能再次迭代 <code>Rect</code>。</p>
<h2 data-id="heading-3">迭代 &amp;</h2>
<p>我们要做的事情实际上很简单，就是为 <code>&amp;Rect</code> 提供一个迭代器，这样我们就可以针对 <code>&amp;Rect</code> 进行迭代了。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 为 &amp;Rect 创建一个迭代器结构体（借用型）</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">RectRefIterator</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    rect: &amp;<span class="hljs-symbol">'a</span> Rect,
    index: <span class="hljs-type">usize</span>,
}

<span class="hljs-comment">// 为 RectRefIterator 实现 Iterator trait</span>
<span class="hljs-keyword">impl</span>&lt;<span class="hljs-symbol">'a</span>&gt; <span class="hljs-built_in">Iterator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">RectRefIterator</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = <span class="hljs-type">f32</span>;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">next</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>::Item&gt; {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">result</span> = <span class="hljs-keyword">match</span> <span class="hljs-keyword">self</span>.index {
            <span class="hljs-number">0</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.rect.a),
            <span class="hljs-number">1</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.rect.b),
            <span class="hljs-number">2</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.rect.c),
            <span class="hljs-number">3</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.rect.d),
            _ =&gt; <span class="hljs-literal">None</span>,
        };
        <span class="hljs-keyword">self</span>.index += <span class="hljs-number">1</span>;
        result
    }
}

<span class="hljs-comment">// 为 &amp;Rect 实现 IntoIterator trait（借用型）</span>
<span class="hljs-keyword">impl</span>&lt;<span class="hljs-symbol">'a</span>&gt; <span class="hljs-built_in">IntoIterator</span> <span class="hljs-keyword">for</span> &amp;<span class="hljs-symbol">'a</span> Rect {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = <span class="hljs-type">f32</span>;
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">IntoIter</span> = RectRefIterator&lt;<span class="hljs-symbol">'a</span>&gt;;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">into_iter</span>(<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span>::IntoIter {
        RectRefIterator {
            rect: <span class="hljs-keyword">self</span>,
            index: <span class="hljs-number">0</span>,
        }
    }
}
</code></pre>
<p>我们直接定义让 <code>&amp;Rect</code> 实现 <code>IntoIterator</code> <code>trait</code>，这里的写法比较长：<code>impl&lt;'a&gt; IntoIterator for &amp;'a Rect</code>。</p>
<p><code>'a</code> 是一个生命周期标注，如果你还不熟悉生命周期标注，可以先跳过，我们可以简单的理解为如果你有引用类型，需要帮助编译器来确定这个引用能存活多长时间。</p>
<p>此时，返回的 <code>IntoIter</code> 类型我们需要重新定义一个 <code>RectRefIterator&lt;'a&gt;</code>，同样，它会持有一个 <code>&amp;'a Rect</code>，即 <code>&amp;Rect</code> 类型。</p>
<p>这样，我们就可以多次遍历了。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">rect</span> = Rect {
    a: <span class="hljs-number">1.0</span>,
    b: <span class="hljs-number">2.0</span>,
    c: <span class="hljs-number">3.0</span>,
    d: <span class="hljs-number">4.0</span>,
};

<span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> &amp;rect { <span class="hljs-comment">// 注意这里是 &amp;rect</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, i);
}

<span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> &amp;rect {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, i);
}

<span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> &amp;rect {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, i);
}
</code></pre>
<p>如果你想消耗掉 <code>rect</code>，<code>for i in rect</code> 即可。</p>
<p>那么，如果我想支持 <code>&amp;mut</code> 呢？</p>
<h2 data-id="heading-4">迭代 &amp;mut</h2>
<p><code>for i in &amp;mut rect</code> 一般这种迭代形式，是说我想在迭代的时候更改元素，例如下面这个在迭代的时候更改数组里面的值：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> &amp;<span class="hljs-keyword">mut</span> a {
    *i = <span class="hljs-number">100</span>;
}
</code></pre>
<p>好的，这应该是所有迭代器中，编写最麻烦的一个了。</p>
<p>我们尝试，按照上面那个写法，写一个迭代器试试：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">RectMutRefIterator</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    rect: &amp;<span class="hljs-symbol">'a</span> <span class="hljs-keyword">mut</span> Rect,
    index: <span class="hljs-type">usize</span>,
}

<span class="hljs-keyword">impl</span>&lt;<span class="hljs-symbol">'a</span>&gt; <span class="hljs-built_in">Iterator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">RectMutRefIterator</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = &amp;<span class="hljs-symbol">'a</span> <span class="hljs-keyword">mut</span> <span class="hljs-type">f32</span>;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">next</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>::Item&gt; {

        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">index</span> = <span class="hljs-keyword">self</span>.index;
        <span class="hljs-keyword">self</span>.index += <span class="hljs-number">1</span>;

        <span class="hljs-keyword">match</span> index {
            <span class="hljs-number">0</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>.rect.a),
            <span class="hljs-number">1</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>.rect.b),
            <span class="hljs-number">2</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>.rect.c),
            <span class="hljs-number">3</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>.rect.d),
            _ =&gt; <span class="hljs-literal">None</span>,
        }
    }
}
</code></pre>
<p>其实就是把 <code>&amp;Rect</code> 变成了 <code>&amp;mut Rect</code>。</p>
<p>但是这段代码是无法通过编译的，你会得到这样一段提示</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef5186aa630045f3b147d72129ed0b46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764204899&amp;x-signature=TZ7vjlo4Gy4d%2Ft%2BIQqjycdxyNr8%3D" alt="2.png" loading="lazy"/></p>
<p>这里简单解释一下，<code>fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt;</code> 实际上是 <code>fn next(&amp;mut self) -&gt; Option&lt;&amp;'a mut f32&gt;</code>，这个函数需要返回一个带 <code>'a</code> 生命周期的引用，但是 Rust 编译器不知道这个 <code>'a</code> 从哪儿来的，Rust 函数的生命周期标注，必须要有一个来源。</p>
<p>那么如果我们改成 <code>fn next(&amp;'a mut self)</code> ?</p>
<p>也不行，因为 <code>impl&lt;'a&gt; Iterator</code> 的函数定义不是这样的，此时，似乎陷入一个僵局了···</p>
<p>由于这个地方过于复杂，我们不再深入探讨，我先给出用正确答案的一种：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// ----------------------------------------------------</span>
<span class="hljs-comment">// 1. 自定义迭代器结构体</span>
<span class="hljs-comment">// ----------------------------------------------------</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">RectMutIterator</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    <span class="hljs-comment">// 指向 Rect 内部当前 f32 元素的原始可变指针。</span>
    ptr: *<span class="hljs-keyword">mut</span> <span class="hljs-type">f32</span>,
    <span class="hljs-comment">// 剩余的元素数量。</span>
    len: <span class="hljs-type">usize</span>,
    <span class="hljs-comment">// 生命周期标记：将迭代器的生命周期 'a 绑定到 Rect 的 &amp;mut 借用上。</span>
    _marker: PhantomData&lt;&amp;<span class="hljs-symbol">'a</span> <span class="hljs-keyword">mut</span> <span class="hljs-type">f32</span>&gt;,
}

<span class="hljs-comment">// ----------------------------------------------------</span>
<span class="hljs-comment">// 2. 针对 &amp;mut Rect 实现 IntoIterator</span>
<span class="hljs-comment">// ----------------------------------------------------</span>
<span class="hljs-keyword">impl</span> &lt;<span class="hljs-symbol">'a</span>&gt; <span class="hljs-built_in">IntoIterator</span> <span class="hljs-keyword">for</span> &amp;<span class="hljs-symbol">'a</span> <span class="hljs-keyword">mut</span> Rect {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = &amp;<span class="hljs-symbol">'a</span> <span class="hljs-keyword">mut</span> <span class="hljs-type">f32</span>;
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">IntoIter</span> = RectMutIterator&lt;<span class="hljs-symbol">'a</span>&gt;;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">into_iter</span>(<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span>::IntoIter {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">ptr_f32</span> = <span class="hljs-keyword">self</span> <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> Rect <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> <span class="hljs-type">f32</span>;

        RectMutIterator {
            ptr: ptr_f32,
            len: <span class="hljs-number">4</span>, <span class="hljs-comment">// 字段总数</span>
            _marker: PhantomData,
        }
    }
}

<span class="hljs-comment">// ----------------------------------------------------</span>
<span class="hljs-comment">// 3. 迭代器的实现</span>
<span class="hljs-comment">// ----------------------------------------------------</span>
<span class="hljs-keyword">impl</span>&lt;<span class="hljs-symbol">'a</span>&gt; <span class="hljs-built_in">Iterator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">RectMutIterator</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = &amp;<span class="hljs-symbol">'a</span> <span class="hljs-keyword">mut</span> <span class="hljs-type">f32</span>; <span class="hljs-comment">// 返回 f32 的可变引用</span>

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">next</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>::Item&gt; {
        <span class="hljs-comment">// 1. 检查是否迭代完毕</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.len == <span class="hljs-number">0</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>;
        }

        <span class="hljs-comment">// 2. 减少剩余元素计数</span>
        <span class="hljs-keyword">self</span>.len -= <span class="hljs-number">1</span>;

        <span class="hljs-comment">// 3. 核心 unsafe 逻辑</span>
        <span class="hljs-keyword">unsafe</span> {
            <span class="hljs-comment">// 获取当前元素的指针</span>
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">current_ptr</span> = <span class="hljs-keyword">self</span>.ptr;

            <span class="hljs-comment">// 将内部指针移动到下一个元素</span>
            <span class="hljs-comment">// offset(1) 是一个 safe 抽象，但它内部执行的是 unsafe 指针算术</span>
            <span class="hljs-comment">// 它确保 `self.ptr` 现在指向下一个 f32 (即下一个字段)</span>
            <span class="hljs-keyword">self</span>.ptr = <span class="hljs-keyword">self</span>.ptr.<span class="hljs-title function_ invoke__">offset</span>(<span class="hljs-number">1</span>);

            <span class="hljs-comment">// 4. 将当前的原始指针转换回安全的 &amp;mut f32 引用</span>
            <span class="hljs-comment">// 这是安全的，因为我们通过 len 和 ptr 的管理，</span>
            <span class="hljs-comment">// 确保了当前元素是独占的，且生命周期被正确绑定。</span>
            <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-keyword">mut</span> *current_ptr)
        }
    }
}
</code></pre>
<p>我们测试一下看看：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">rect</span> = Rect {
     a: <span class="hljs-number">1.0</span>,
     b: <span class="hljs-number">2.0</span>,
     c: <span class="hljs-number">3.0</span>,
     d: <span class="hljs-number">4.0</span>,
 };

<span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> &amp;<span class="hljs-keyword">mut</span> rect {
     *i += <span class="hljs-number">10.0</span>;
 }

<span class="hljs-built_in">println!</span>(<span class="hljs-string">"{:?}"</span>, rect);

<span class="hljs-comment">// output</span>
<span class="hljs-comment">// Rect { a: 11.0, b: 12.0, c: 13.0, d: 14.0 }</span>
</code></pre>
<p>结果是正确的。</p>
<p>好的，到此，几种基本的迭代器类型我们已经实现完毕了。除了 <code>&amp;mut</code> 比较复杂以外，其他两种还算是轻松。</p>
<h2 data-id="heading-5">Rust 的一些习惯</h2>
<p>实际上，Rust 中针对迭代器，还有一些习惯，我们在 <a href="https://juejin.cn/post/7566474134688595983" target="_blank" title="https://juejin.cn/post/7566474134688595983">深入 Rust 迭代器（上）</a> 提到 Rust 迭代器中，有三种等价情况：</p>
<ul>
<li><code>for i in &amp;vec</code> 等价于 <code>for i in vec.iter()</code>。</li>
<li><code>for i in &amp;mut</code> 等价于 <code>for i in vec.iter_mut()</code>。</li>
<li><code>for i in vec</code> 等价于 <code>for i in vec.into_iter()</code>。</li>
</ul>
<p>所以，我们给 <code>Rect</code> 添加一下这三个方法：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Rect</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">iter_mut</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> RectMutIterator {
        RectMutIterator {
            ptr: <span class="hljs-keyword">self</span> <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> Rect <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> <span class="hljs-type">f32</span>,
            len: <span class="hljs-number">4</span>,
            _marker: PhantomData,
        }
    }

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">iter</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> RectRefIterator {
        RectRefIterator {
            rect: <span class="hljs-keyword">self</span>,
            index: <span class="hljs-number">0</span>,
        }
    }

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">into_iter</span>(<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> RectIter {
        RectIter {
            data: <span class="hljs-keyword">self</span>,
            iter_index: <span class="hljs-number">0</span>,
        }
    }
}
</code></pre>
<p>这样，我们就可以使用迭代器适配器方法和管道了：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">rect</span> = Rect {
    a: <span class="hljs-number">1.0</span>,
    b: <span class="hljs-number">2.0</span>,
    c: <span class="hljs-number">3.0</span>,
    d: <span class="hljs-number">4.0</span>,
};

rect.<span class="hljs-title function_ invoke__">iter_mut</span>().<span class="hljs-title function_ invoke__">for_each</span>(|i| {
    *i += <span class="hljs-number">10.0</span>;
});

rect.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">for_each</span>(|a| <span class="hljs-built_in">print!</span>(<span class="hljs-string">"{:?} "</span>, a));

<span class="hljs-built_in">println!</span>();

rect.<span class="hljs-title function_ invoke__">into_iter</span>().<span class="hljs-title function_ invoke__">for_each</span>(|a| <span class="hljs-built_in">print!</span>(<span class="hljs-string">"{:?} "</span>, a));

<span class="hljs-built_in">println!</span>();

<span class="hljs-comment">// output</span>
<span class="hljs-comment">// 11.0 12.0 13.0 14.0</span>
<span class="hljs-comment">// 11.0 12.0 13.0 14.0</span>
</code></pre>
<h2 data-id="heading-6">倒序</h2>
<p>在 <a href="https://juejin.cn/post/7572028313930776616" target="_blank" title="https://juejin.cn/post/7572028313930776616">深入 Rust 迭代器（下）</a> 中，我们最后提到一个 <code>rev()</code>，也就是迭代器倒序。这里我们也实现一下，这样你就能明白那篇文章中，为什么输出结果是那样的了。</p>
<p>我们仅针对 <code>&amp;Rect</code> 实现倒序。</p>
<p>为了实现倒序，我们需要给 <code>RectRefIterator</code> 添加一个 <code>end</code> 字段，该字段和 <code>index</code> 其实效果是一样的，用于标识当前应该返回哪个数据。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">RectRefIterator</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    rect: &amp;<span class="hljs-symbol">'a</span> Rect,
    index: <span class="hljs-type">usize</span>,
    end: <span class="hljs-type">usize</span>,
}
</code></pre>
<p>接下来在所有用到 <code>RectRefIterator</code> 的地方，设置 <code>end</code> 为 <code>4</code>：</p>
<pre><code class="hljs language-rust" lang="rust">RectRefIterator {
    rect: <span class="hljs-keyword">self</span>,
    index: <span class="hljs-number">0</span>,
    end: <span class="hljs-number">4</span>,
}
</code></pre>
<p>为了能够让迭代器支持 <code>rev()</code>，我们需要实现一个 <code>DoubleEndedIterator</code> 的 <code>trait</code>，该 <code>trait</code> 只需要实现 <code>fn next_back(&amp;mut self)</code> 即可，即倒着返回数据。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span> &lt;<span class="hljs-symbol">'a</span>&gt; <span class="hljs-built_in">DoubleEndedIterator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">RectRefIterator</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">next_back</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>::Item&gt; {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">result</span> = <span class="hljs-keyword">match</span> <span class="hljs-keyword">self</span>.end {
            <span class="hljs-number">1</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.rect.a),
            <span class="hljs-number">2</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.rect.b),
            <span class="hljs-number">3</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.rect.c),
            <span class="hljs-number">4</span> =&gt; <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">self</span>.rect.d),
            _ =&gt; <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>,
        };
        <span class="hljs-keyword">self</span>.end -= <span class="hljs-number">1</span>;
        result
    }
}
</code></pre>
<p>好，万事俱备，我们测试一下：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">rect</span> = Rect {
    a: <span class="hljs-number">1.0</span>,
    b: <span class="hljs-number">2.0</span>,
    c: <span class="hljs-number">3.0</span>,
    d: <span class="hljs-number">4.0</span>,
};

rect.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">rev</span>().<span class="hljs-title function_ invoke__">for_each</span>(|a| <span class="hljs-built_in">print!</span>(<span class="hljs-string">"{:?} "</span>, a));

<span class="hljs-comment">// output</span>
<span class="hljs-comment">// 4.0 3.0 2.0 1.0</span>
</code></pre>
<p>完美。</p>
<h2 data-id="heading-7">总结</h2>
<p>好的，关于 Rust 迭代器的这个系列，终于迎来了完结。</p>
<p>我们在最后这篇文章中，给自己的数据实现了迭代器功能。</p>
<p>通过我们手动编写迭代器，我们不仅学会了如何实现迭代器，也加深了对 Rust 中数据使用的理解，你会发现，Rust 始终围绕<strong>所有权</strong>、<strong>借用</strong>、<strong>可变借用</strong>来实现数据的访问。</p>
<p>这种设计不是限制，而是一种引导——它迫使我们在编写代码的时候就思考：</p>
<ul>
<li>谁拥有数据？</li>
<li>谁在读取或修改它？</li>
<li>生命周期是否安全？</li>
</ul>
<p>正是这些看似“严格”的规则，让 Rust 能在不依赖垃圾回收的情况下，既保证内存安全，又实现零成本抽象。而迭代器，正是这一哲学的完美体现：它把控制权交给开发者，又用类型系统默默守护着每一份引用的安全。</p>
<p>现在，当你再看到 <code>for x in vec</code> 时，或许不再只觉得它简洁优雅，更能体会到背后那套精密、可靠、充满智慧的机制在默默运转。</p>
<p>感谢你一路走到这里。愿你在 Rust 的旅程中，继续享受这种“被约束的自由”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【跨国数仓迁移最佳实践 12】阿里云 MaxCompute 实现 BigQuery 10 万条 SQL 智能转写迁移]]></title>    <link>https://juejin.cn/post/7574404398067482624</link>    <guid>https://juejin.cn/post/7574404398067482624</guid>    <pubDate>2025-11-20T10:06:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574404398067482624" data-draft-id="7574529034673012771" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【跨国数仓迁移最佳实践 12】阿里云 MaxCompute 实现 BigQuery 10 万条 SQL 智能转写迁移"/> <meta itemprop="keywords" content="大数据,SQL"/> <meta itemprop="datePublished" content="2025-11-20T10:06:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【跨国数仓迁移最佳实践 12】阿里云 MaxCompute 实现 BigQuery 10 万条 SQL 智能转写迁移
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T10:06:27.000Z" title="Thu Nov 20 2025 10:06:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>作者：曹霖</strong></p>
<p>本系列文章将围绕东南亚头部科技集团的真实迁移历程展开，逐步拆解 BigQuery 迁移至 MaxCompute 过程中的关键挑战与技术创新。本篇为第十二篇，基于 阿里云MaxCompute 实现BigQuery 10万条SQL智能转写迁移。</p>
<p>注：客户为东南亚头部科技集团，文中用 GoTerra 表示。</p>
<h2 data-id="heading-0">一、项目背景</h2>
<p>在全球化和数字化加速的浪潮下，越来越多的企业出于成本优化、合规要求和业务协同等原因，考虑将自建或三方大数据平台迁移至阿里云MaxCompute。本案例基于是东南亚头部科技集团 GoTerra，其业务生态覆盖网约车、电商、外卖、物流及金融支付等多个垂直领域，多年运行在 Google Cloud BigQuery 的数仓平台，基于综合优势分析规划全量迁移至阿里云 MaxCompute。</p>
<p>相比数据搬迁本身，迁移过程中一个更为棘手的挑战是：</p>
<ul>
<li><strong>10 万条 SQL 脚本的高质量快速转写</strong>。这其中既包含简短的分析 SQL，也包含上万行、嵌套极深的复杂 ETL 逻辑。</li>
<li>脚本广泛使用了 BigQuery 特有的语法、函数（如 <code>UNNEST</code>、<code>SAFE_CAST</code>、<code>FORMAT_DATE</code>）、复杂数据类型（<code>ARRAY</code>、<code>STRUCT</code>、<code>BIGNUMERIC</code>）和独有优化模式。</li>
<li>在历史业务沉淀下，不少 SQL 逻辑与业务规则、数据模型紧密绑定，稍有不慎便会影响数据产品准确性。</li>
</ul>
<p>传统人力转写方式显然不现实。内部测算显示：</p>
<ul>
<li>假设工程师日均高质量转写 5 条 SQL，则需 <strong>2 万人天</strong>；</li>
<li>即便 100 人并行，也要近 <strong>1 年</strong>才能完成，远超半年上线目标。</li>
<li>质量一致性无法保障，知识传递和规则固化存在巨大难度，回归测试成本高昂。</li>
</ul>
<p>在这样背景下，团队必须找到 <strong>自动化+协同化的工程化解法</strong>，提升 SQL 转换率，实现大规模、可控的迁移。</p>
<h2 data-id="heading-1">二、解决方案</h2>
<h3 data-id="heading-2">整体策略</h3>
<p>我们基于阿里云 <strong>Cloud Migration Hub（CMH）/ Lake Migration Hub（LMH）</strong> 自动化迁移能力，配合自研规则引擎、AST（抽象语法树）转换、大语言模型（LLM）辅助和人工修正，构建“一条龙”的 <strong>工具主导+人工兜底</strong> 方案，并在迁移过程中沉淀可复用的 <strong>迁移知识库</strong>。</p>
<p>迁移整体分为两大阶段：</p>
<ol>
<li><strong>数据迁移</strong>：将 BigQuery 表数据平滑搬迁到 MaxCompute（包括全量及后续增量），使用在线迁移、MMS（MaxCompute Migration Serverless） 等。</li>
<li><strong>SQL 转写</strong>：借助 CMH/LMH 自动化批量转换 SQL，并通过规则迭代、LLM 增强、人工修正，实现高准确率交付。</li>
</ol>
<h3 data-id="heading-3">数据迁移与SQL转写迁移方案的技术实现与优化</h3>
<p>基于阿里云Cloud Migration Hub（CMH）/Lake Migration Hub（LMH）的自动化迁移能力，结合自主研发的规则引擎、抽象语法树（AST）转换技术、大语言模型（LLM）辅助及人工修正机制，我们构建了一套“工具主导+人工兜底”的端到端迁移解决方案。该方案不仅实现了从数据层到应用层的全栈迁移，还通过迁移知识库的持续沉淀，显著提升了迁移效率与准确性。迁移过程分为以下两个核心阶段：</p>
<h4 data-id="heading-4">第一阶段：数据迁移——保障数据平滑过渡的全生命周期管理</h4>
<p>数据迁移是整个迁移工程的基础，其核心目标是将源端BigQuery的数据无缝迁移到阿里云MaxCompute，并确保迁移过程的高可用性、一致性和可扩展性。</p>
<p><strong>工具与架构</strong>：采用阿里云在线迁移工具（Online Migration）和MMS（MaxCompute Migration Serverless）进行全量数据迁移。在线迁移工具通过分布式架构实现高吞吐量传输，支持断点续传和错误重试机制，确保大规模数据（如PB级）的稳定迁移。MMS则通过Serverless服务化模式，按需分配计算资源，降低运维复杂度。</p>
<h4 data-id="heading-5">第二阶段：SQL转写——自动化与人工协同的智能转换</h4>
<p>SQL转写是迁移过程中技术难度最高的环节，涉及语法、函数、UDF（用户定义函数）及性能优化的复杂转换。我们通过“自动化为主，人工为辅”的分层策略，结合AST分析、规则引擎和LLM技术，实现高准确率的SQL转换。</p>
<h5 data-id="heading-6">1. 自动化转换引擎</h5>
<ul>
<li><strong>AST语法树解析</strong>：基于ANTLR或自研解析器构建BigQuery SQL的抽象语法树（AST），逐层分析语法结构。例如，将BigQuery的<code>SELECT APPROX_COUNT_DISTINCT(column)</code>转换为MaxCompute的<code>SELECT COUNT(DISTINCT column)</code>，并通过AST节点替换实现。</li>
<li><strong>规则引擎迭代优化</strong>：
<ul>
<li><strong>内置规则库</strong>：预置超过200条迁移规则，覆盖数据类型映射（如BigQuery的<code>TIMESTAMP</code>→MaxCompute的<code>DATETIME</code>）、函数替换（如<code>SAFE</code>函数的兼容性处理）、窗口函数调整等场景。</li>
<li><strong>动态规则扩展</strong>：通过迁移知识库的实时反馈，持续迭代规则库。例如，若发现某类CASE-WHEN嵌套语句转换失败，可立即新增规则并重新运行转换流程。</li>
</ul>
</li>
<li><strong>LLM辅助转换</strong>：针对复杂或模糊的SQL语句（如自定义UDF或依赖源端特定语法的查询），利用大语言模型（如通义千问）进行语义解析和意图理解。例如，将BigQuery的<code>STRUCT</code>类型转换为MaxCompute的<code>LATERAL VIEW</code>表达式，LLM可辅助生成等效逻辑的SQL代码。</li>
</ul>
<h5 data-id="heading-7">2. 人工修正与质量控制</h5>
<ul>
<li><strong>自动化缺陷定位</strong>：通过静态代码分析工具和动态执行测试（在测试环境中运行转换后的SQL），快速定位转换失败的语句。例如，若转换后的SQL在MaxCompute执行时因类型不匹配报错，系统将标记该SQL并提示可能的修复方向。</li>
<li><strong>专家介入流程</strong>：
<ul>
<li><strong>优先级分级</strong>：根据错误类型（如语法错误、性能隐患、业务逻辑偏差）和影响范围，将问题分为P0-P3等级，优先处理高风险缺陷。</li>
<li><strong>协同开发环境</strong>：提供基于IDE的联机调试工具，允许开发者直接修改转换后的SQL，并通过版本控制系统（如Git）管理修改记录，确保可追溯性。</li>
</ul>
</li>
<li><strong>迁移知识库的闭环反馈</strong>：每次人工修正后，系统自动提取修正前后的SQL差异，并将其归类为新规则或案例存入知识库。例如，若某次修正解决了BigQuery的<code>ARRAY_AGG</code>到MaxCompute的<code>COLLECT_SET</code>转换问题，该规则将被优先级提升，并在后续迁移中自动应用。</li>
</ul>
<h5 data-id="heading-8">3. 转换后验证与优化</h5>
<ul>
<li><strong>功能验证</strong>：在测试集群中执行转换后的SQL，对比源端和目标端的查询结果，确保业务逻辑一致性。</li>
<li><strong>性能调优</strong>：利用MaxCompute的执行计划分析工具，识别转换后SQL的性能瓶颈（如全表扫描、Join顺序不当），并通过索引优化、分区裁剪或谓词下推等手段提升效率。</li>
<li><strong>迁移知识库的持续优化</strong>：将验证过程中发现的性能优化策略（如特定函数转换方式）补充至知识库，形成“迁移-修正-优化”的闭环。</li>
</ul>
<h4 data-id="heading-9">迁移知识库的核心价值与应用场景</h4>
<p>迁移知识库是整个方案的关键支撑，其价值体现在以下方面：</p>
<ol>
<li>
<p><strong>规则复用与加速迭代</strong>：通过积累迁移规则、缺陷案例和最佳实践，新项目可直接调用知识库中的已有规则，减少重复性开发。例如，某金融客户在迁移过程中发现BigQuery的<code>DATE_TRUNC</code>函数在MaxCompute中需配合<code>DATE_FORMAT</code>使用，该规则可直接复用至其他项目。</p>
</li>
<li>
<p><strong>风险预判与质量提升</strong>：知识库中的历史案例可辅助迁移前的风险评估，例如提前识别BigQuery的<code>ML_*</code>机器学习函数在MaxCompute中的替代方案，避免迁移后期的返工。</p>
</li>
<li>
<p><strong>跨团队协作与知识传承</strong>：知识库采用统一的Markdown格式和分类标签（如按场景、工具、复杂度分类），支持多团队并行查阅与贡献，降低隐性知识流失风险。</p>
</li>
</ol>
<h4 data-id="heading-10">技术优势与迁移成效</h4>
<p>通过上述技术方案，我们实现了以下显著优势：</p>
<ul>
<li><strong>迁移效率提升</strong>：相比纯人工迁移，自动化工具将SQL转写效率提升80%以上，单项目迁移周期从数年缩短至数月。</li>
<li><strong>准确性保障</strong>：结合规则引擎与LLM的双通道验证，部分场景SQL转换准确率超过90%，人工修正仅需处理约10%的复杂场景。</li>
<li><strong>成本优化</strong>：通过MMS的Serverless模式和按需计费机制，降低数据迁移成本，同时减少因停机迁移导致的业务损失。</li>
</ul>
<h2 data-id="heading-11">三、核心技术</h2>
<h3 data-id="heading-12">1. SQL 转换主流技术：AST 驱动</h3>
<p>相比复杂且易出错的正则/模板替换，AST 驱动的 SQL 转换具备可扩展、高可维护等优势：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b99cb3b509144cc84dee5c06eb7479e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764237987&amp;x-signature=Mj%2FlUCpGQlDUaUIZW9zzpwvUHtU%3D" alt="image.png" loading="lazy"/></p>
<p><strong>流程</strong>：</p>
<ol>
<li>
<p><strong>Parse</strong>：将 BigQuery SQL 解析为抽象语法树（AST），保留结构和节点类型（SELECT、FROM、FUNCTION_CALL 等）。</p>
</li>
<li>
<p><strong>Transform</strong>：按规则库替换/重构 AST 节点，例如：</p>
<ul>
<li>
<p><code>FORMAT_DATE('%Y-%m-%d', col)</code> → <code>TO_CHAR(col, 'yyyy-MM-dd')</code></p>
</li>
<li>
<p><code>UNNEST(array_col)</code> → <code>LATERAL VIEW EXPLODE(array_col)</code></p>
</li>
<li>
<p>隐式类型转换规则修正</p>
</li>
</ul>
</li>
<li>
<p><strong>Generate</strong>：输出目标 MaxCompute SQL。</p>
</li>
</ol>
<p><strong>优势</strong>：</p>
<ul>
<li>对复杂嵌套、长 SQL 稳定性高</li>
<li>易于增量维护规则</li>
<li>可结合类型系统和元数据增强（RAG 思路）</li>
</ul>
<h3 data-id="heading-13">2. SQL 转换示例</h3>
<p><strong>BigQuery SQL</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> FORMAT_DATE(<span class="hljs-string">'%Y-%m-%d'</span>, order_time) <span class="hljs-keyword">AS</span> order_date,
       <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> user_id) <span class="hljs-keyword">AS</span> uv
<span class="hljs-keyword">FROM</span> `project.dataset.orders`
<span class="hljs-keyword">WHERE</span> order_time <span class="hljs-operator">&gt;=</span> DATE_SUB(<span class="hljs-built_in">CURRENT_DATE</span>(), <span class="hljs-type">INTERVAL</span> <span class="hljs-number">30</span> <span class="hljs-keyword">DAY</span>)
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> order_date;

</code></pre>
<p><strong>MaxCompute SQL</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> TO_CHAR(order_time, <span class="hljs-string">'yyyy-MM-dd'</span>) <span class="hljs-keyword">AS</span> order_date,
       <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> user_id) <span class="hljs-keyword">AS</span> uv
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> order_time <span class="hljs-operator">&gt;=</span> DATEADD(<span class="hljs-built_in">CURRENT_DATE</span>, <span class="hljs-number">-30</span>)
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> order_date;

</code></pre>
<p><strong>映射规则</strong>：</p>
<ul>
<li><code>FORMAT_DATE</code> → <code>TO_CHAR</code>（参数位置调整）</li>
<li><code>DATE_SUB</code> → <code>DATEADD</code>（顺序/符号兼容）</li>
<li>去除 BigQuery 数据集前缀</li>
<li>类型映射：DATE 保持一致，BIGINT 替换 INT64</li>
</ul>
<h3 data-id="heading-14">3. SQL转写流程</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/617587520bfe4c758593d0f3538ab912~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764237987&amp;x-signature=c1vLs3c3zE%2BiWac1SM6XJUR4pHA%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-15">4. 行业实践与趋势</h3>
<p>在多家企业的跨云 SQL 迁移中，总结出几条趋势：</p>
<ul>
<li><strong>AST+规则库</strong> 是工程实践中相对高效可控的技术路径</li>
<li><strong>LLM 加持的混合模式</strong> 在处理尾部长尾复杂 SQL 时展现价值</li>
<li><strong>知识库驱动持续优化</strong> 可复用性强，提升 ROI</li>
<li><strong>平台自适配增强</strong> 比单纯靠转换器更能保障业务一致性</li>
</ul>
<h2 data-id="heading-16">四、小结与未来展望</h2>
<p><strong>本项目成果</strong>：</p>
<ul>
<li>在 4 个月内完成 SQL 转写任务，比计划提前 1 个月上线</li>
<li>工具转换率从 5%→80%，人工成本下降 70%+</li>
<li>沉淀上千条规则和案例，形成可复用的 SQL 迁移知识库</li>
<li>平台能力增强，提升未来兼容性</li>
</ul>
<p><strong>展望</strong>：</p>
<ul>
<li>推动 CMH/LMH 全自动化迁移平台，支持更多方言（Snowflake、Databricks 等）</li>
<li>引入在线实时 SQL 转换 API，支持多云混合分析</li>
<li>结合执行计划与成本模型的自动化 SQL 优化器</li>
<li>依托知识库与 RAG 提高 LLM 转换一致性与可解释性</li>
</ul>
<p><strong>参考研究</strong>：</p>
<ul>
<li>《Mallet: SQL Dialect Translation with LLM Rule Generation》</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🔥 神奇的 Dart Zone 机制]]></title>    <link>https://juejin.cn/post/7574816159754207283</link>    <guid>https://juejin.cn/post/7574816159754207283</guid>    <pubDate>2025-11-21T06:24:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574816159754207283" data-draft-id="7574726841543737382" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🔥 神奇的 Dart Zone 机制"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2025-11-21T06:24:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="未来猫咪花"/> <meta itemprop="url" content="https://juejin.cn/user/1081575169340526"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🔥 神奇的 Dart Zone 机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1081575169340526/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    未来猫咪花
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T06:24:07.000Z" title="Fri Nov 21 2025 06:24:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">📚 第一部分：什么是 Zone？</h2>
<h3 data-id="heading-1">Zone 的定义</h3>
<p>在 Dart 中，<strong>Zone</strong> 是一种<strong>执行上下文（execution context）</strong>，你可以把它想象成一个"气泡"或"容器"，代码在这个容器里执行时，可以访问到一些特定的环境变量和配置。</p>
<p>用更通俗的比喻：</p>
<ul>
<li>🏠 Zone 就像一个"房间"</li>
<li>📦 房间里有一些"储物柜"（zoneValues）</li>
<li>🚪 进入房间的代码可以访问这些储物柜</li>
<li>🔑 每个储物柜有一个键（key），用来存取数据</li>
</ul>
<h3 data-id="heading-2">最简单的 Zone 示例</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'dart:async'</span>;

<span class="hljs-keyword">void</span> main() {
  <span class="hljs-comment">// 普通执行环境</span>
  <span class="hljs-built_in">print</span>(<span class="hljs-string">'外部: <span class="hljs-subst">${Zone.current[#userId]}</span>'</span>);  <span class="hljs-comment">// null</span>
  
  <span class="hljs-comment">// 创建一个 Zone，并在其中存储数据</span>
  runZoned(() {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'Zone 内部: <span class="hljs-subst">${Zone.current[#userId]}</span>'</span>);  <span class="hljs-comment">// "user123" ✅</span>
    someFunction();
  }, zoneValues: {
    #userId: <span class="hljs-string">'user123'</span>,  <span class="hljs-comment">// 👈 存储数据到 Zone</span>
  });
}

<span class="hljs-keyword">void</span> someFunction() {
  <span class="hljs-comment">// 这个函数在 Zone 内部执行，可以读取 Zone 中的数据</span>
  <span class="hljs-keyword">final</span> userId = Zone.current[#userId] <span class="hljs-keyword">as</span> <span class="hljs-built_in">String?</span>;
  <span class="hljs-built_in">print</span>(<span class="hljs-string">'someFunction 获取到的 userId: <span class="hljs-subst">$userId</span>'</span>);  <span class="hljs-comment">// "user123" ✅</span>
}
</code></pre>
<p><strong>输出</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">外部:</span> <span class="hljs-literal">null</span>
<span class="hljs-string">Zone</span> <span class="hljs-string">内部:</span> <span class="hljs-string">user123</span>
<span class="hljs-string">someFunction</span> <span class="hljs-string">获取到的</span> <span class="hljs-attr">userId:</span> <span class="hljs-string">user123</span>
</code></pre>
<h3 data-id="heading-3">Zone 的核心特性</h3>
<h4 data-id="heading-4">1. 数据隔离</h4>
<p>每个 Zone 都有自己的数据空间，互不干扰：</p>
<pre><code class="hljs language-dart" lang="dart">runZoned(() {
  <span class="hljs-built_in">print</span>(<span class="hljs-string">'Zone A: <span class="hljs-subst">${Zone.current[#name]}</span>'</span>);  <span class="hljs-comment">// "Alice"</span>
}, zoneValues: {#name: <span class="hljs-string">'Alice'</span>});

runZoned(() {
  <span class="hljs-built_in">print</span>(<span class="hljs-string">'Zone B: <span class="hljs-subst">${Zone.current[#name]}</span>'</span>);  <span class="hljs-comment">// "Bob"</span>
}, zoneValues: {#name: <span class="hljs-string">'Bob'</span>});

<span class="hljs-built_in">print</span>(<span class="hljs-string">'外部: <span class="hljs-subst">${Zone.current[#name]}</span>'</span>);  <span class="hljs-comment">// null</span>
</code></pre>
<h4 data-id="heading-5">2. 继承性</h4>
<p>Zone 可以嵌套，内层 Zone 可以访问外层 Zone 的数据：</p>
<pre><code class="hljs language-dart" lang="dart">runZoned(() {
  <span class="hljs-built_in">print</span>(<span class="hljs-string">'外层 Zone: <span class="hljs-subst">${Zone.current[#outer]}</span>'</span>);  <span class="hljs-comment">// "outer-value"</span>
  
  runZoned(() {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'内层 Zone - 外层数据: <span class="hljs-subst">${Zone.current[#outer]}</span>'</span>);  <span class="hljs-comment">// "outer-value" ✅</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'内层 Zone - 内层数据: <span class="hljs-subst">${Zone.current[#inner]}</span>'</span>);  <span class="hljs-comment">// "inner-value" ✅</span>
  }, zoneValues: {
    #inner: <span class="hljs-string">'inner-value'</span>,
  });
}, zoneValues: {
  #outer: <span class="hljs-string">'outer-value'</span>,
});
</code></pre>
<h4 data-id="heading-6">3. 作用域限制</h4>
<p>Zone 中存储的数据只在这个 Zone 的执行范围内有效：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">void</span> main() {
  runZoned(() {
    scheduleMicrotask(() {
      <span class="hljs-comment">// 异步任务仍在同一个 Zone 中 ✅</span>
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'异步任务: <span class="hljs-subst">${Zone.current[#data]}</span>'</span>);  <span class="hljs-comment">// "hello"</span>
    });
  }, zoneValues: {#data: <span class="hljs-string">'hello'</span>});
  
  <span class="hljs-comment">// 这里已经退出 Zone</span>
  <span class="hljs-built_in">print</span>(<span class="hljs-string">'外部: <span class="hljs-subst">${Zone.current[#data]}</span>'</span>);  <span class="hljs-comment">// null</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-7">🎯 第二部分：Zone 的常见用途</h2>
<h3 data-id="heading-8">1. 全局错误捕获</h3>
<p>Zone 最常见的用途之一是捕获所有未处理的异常：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">void</span> main() {
  runZonedGuarded(() {
    runApp(MyApp());
  }, (error, stackTrace) {
    <span class="hljs-comment">// 👇 捕获所有未处理的异常</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'捕获到错误: <span class="hljs-subst">$error</span>'</span>);
    reportErrorToServer(error, stackTrace);
  });
}
</code></pre>
<p><strong>用途</strong>：在生产环境中收集所有崩溃信息，发送到错误追踪服务。</p>
<h3 data-id="heading-9">2. 自定义 print 输出</h3>
<p>可以拦截和修改 <code>print</code> 的行为：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">void</span> main() {
  runZoned(() {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'这条日志会被拦截'</span>);
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'并添加前缀'</span>);
  }, zoneSpecification: ZoneSpecification(
    <span class="hljs-built_in">print</span>: (self, parent, zone, message) {
      <span class="hljs-comment">// 👇 拦截 print，添加自定义前缀</span>
      parent.<span class="hljs-built_in">print</span>(zone, <span class="hljs-string">'[MyApp] <span class="hljs-subst">$message</span>'</span>);
    },
  ));
}
</code></pre>
<p><strong>输出</strong>：</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">MyApp</span>] 这条日志会被拦截
[<span class="hljs-meta">MyApp</span>] 并添加前缀
</code></pre>
<h3 data-id="heading-10">3. 异步操作追踪</h3>
<p>Zone 可以追踪和管理异步操作：</p>
<pre><code class="hljs language-dart" lang="dart">runZoned(() <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">await</span> Future.delayed(<span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">1</span>));
  <span class="hljs-built_in">print</span>(<span class="hljs-string">'异步操作完成'</span>);
  <span class="hljs-comment">// 👆 这个异步操作仍在 Zone 内执行</span>
}, zoneValues: {
  #requestId: <span class="hljs-string">'req-12345'</span>,
});
</code></pre>
<p>Flutter 框架内部就是用 Zone 来追踪异步操作的来源，这就是为什么你在 async 方法中抛出的异常能被正确捕获。</p>
<h3 data-id="heading-11">4. 上下文传递（最重要！）</h3>
<p><strong>这是 view_model 使用 Zone 的核心用途</strong>：在不显式传参的情况下，将数据传递给深层的函数调用。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">void</span> main() {
  runZoned(() {
    processRequest();
  }, zoneValues: {
    #currentUser: User(id: <span class="hljs-string">'123'</span>, name: <span class="hljs-string">'Alice'</span>),
  });
}

<span class="hljs-keyword">void</span> processRequest() {
  <span class="hljs-comment">// 不需要传参，直接从 Zone 中获取</span>
  validatePermission();
}

<span class="hljs-keyword">void</span> validatePermission() {
  <span class="hljs-comment">// 深层调用，仍然可以访问 Zone 数据</span>
  <span class="hljs-keyword">final</span> user = Zone.current[#currentUser] <span class="hljs-keyword">as</span> User;
  <span class="hljs-built_in">print</span>(<span class="hljs-string">'验证用户权限: <span class="hljs-subst">${user.name}</span>'</span>);
}
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>✅ 不需要层层传递参数</li>
<li>✅ 保持函数签名简洁</li>
<li>✅ 数据在整个调用链中都可访问</li>
</ul>
<hr/>
<h2 data-id="heading-12">🚀 第三部分：view_model 如何借助 Zone 实现依赖机制</h2>
<h3 data-id="heading-13">问题背景</h3>
<p>在 view_model 架构中，我们遇到了一个经典难题：</p>
<p><strong>场景</strong>：ViewModel 想在构造函数中获取其他 ViewModel 依赖</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserProfileViewModel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ViewModel</span> </span>{
  UserProfileViewModel() {
    <span class="hljs-comment">// 🤯 问题：我想在构造函数里获取 AuthViewModel</span>
    <span class="hljs-comment">// 但是依赖解析能力在 State 中，这里根本访问不到！</span>
    <span class="hljs-keyword">final</span> authVM = ???  <span class="hljs-comment">// 从哪里获取？</span>
    
    <span class="hljs-keyword">if</span> (authVM.isLoggedIn) {
      loadUserProfile();
    }
  }
}
</code></pre>
<p><strong>核心矛盾</strong>：</p>
<ul>
<li>✅ <strong>Widget/State</strong> 有 BuildContext，可以访问依赖容器</li>
<li>❌ <strong>ViewModel 构造函数</strong> 没有 BuildContext，无法直接获取依赖</li>
<li>❌ 传递 BuildContext 到 ViewModel？违背了架构分层原则</li>
</ul>
<p><strong>我们需要一种机制</strong>：</p>
<ol>
<li>不破坏架构分层（ViewModel 不依赖 Widget）</li>
<li>不显式传参（保持构造函数简洁）</li>
<li>让 ViewModel 能神奇地获取到依赖解析能力</li>
</ol>
<p><strong>答案就是：Zone！</strong></p>
<h3 data-id="heading-14">解决方案：用 Zone 传递依赖解析器</h3>
<p>核心思路：在创建 ViewModel 时，用 Zone 包裹构造过程，将依赖解析器存入 Zone。</p>
<h4 data-id="heading-15">第一步：定义依赖解析器类型</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// dependency_handler.dart</span>

<span class="hljs-comment">// 依赖解析器的函数签名</span>
<span class="hljs-keyword">typedef</span> DependencyResolver = T <span class="hljs-built_in">Function</span>&lt;T <span class="hljs-keyword">extends</span> ViewModel&gt;({
  <span class="hljs-keyword">required</span> ViewModelDependencyConfig&lt;T&gt; dependency,
  <span class="hljs-built_in">bool</span> listen,
});

<span class="hljs-keyword">const</span> _resolverKey = #_viewModelDependencyResolver;  <span class="hljs-comment">// Zone 中的键</span>
</code></pre>
<h4 data-id="heading-16">第二步：创建辅助函数，用 Zone 包裹执行</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// dependency_handler.dart</span>

<span class="hljs-comment">/// <span class="markdown">用 Zone 包裹 body 的执行，并将 resolver 存入 Zone</span></span>
R runWithResolver&lt;R&gt;(R <span class="hljs-built_in">Function</span>() body, DependencyResolver resolver) {
  <span class="hljs-keyword">return</span> runZoned(body, zoneValues: {
    _resolverKey: resolver,  <span class="hljs-comment">// 👈 将解析器存入 Zone</span>
  });
}
</code></pre>
<h4 data-id="heading-17">第三步：在 ViewModelAttacher 创建 ViewModel 时使用 Zone</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// attacher.dart</span>

VM _createViewModel&lt;VM <span class="hljs-keyword">extends</span> ViewModel&gt;({
  <span class="hljs-keyword">required</span> ViewModelFactory&lt;VM&gt; <span class="hljs-keyword">factory</span>,
  <span class="hljs-built_in">bool</span> listen = <span class="hljs-keyword">true</span>,
}) {
  <span class="hljs-comment">// ...</span>
  
  <span class="hljs-comment">// 👇 关键！用 runWithResolver 包裹 ViewModel 的创建</span>
  <span class="hljs-keyword">final</span> res = runWithResolver(
    () {
      <span class="hljs-keyword">return</span> _instanceController.getInstance&lt;VM&gt;(
        <span class="hljs-keyword">factory</span>: InstanceFactory&lt;VM&gt;(
          builder: <span class="hljs-keyword">factory</span>.build,  <span class="hljs-comment">// 👈 这里会调用 ViewModel 的构造函数</span>
          <span class="hljs-comment">// ...</span>
        ),
      )..dependencyHandler.addDependencyResolver(onChildDependencyResolver);
    },
    onChildDependencyResolver,  <span class="hljs-comment">// 👈 将依赖解析器传入 Zone</span>
  );
  
  <span class="hljs-comment">// ...</span>
  <span class="hljs-keyword">return</span> res;
}
</code></pre>
<p><strong>这一步发生了什么？</strong></p>
<pre><code class="hljs language-scss" lang="scss">┌────────────────────────────────────────────────────┐
│ <span class="hljs-number">1</span>. 调用 _createViewModel&lt;UserProfileViewModel&gt;()  │
│    ↓                                                │
│ <span class="hljs-number">2</span>. <span class="hljs-built_in">runWithResolver</span>(..., onChildDependencyResolver) │
│    创建 Zone { _resolverKey: resolver }            │
│    ↓                                                │
│    【进入 Zone，携带依赖解析器】                    │
│    ↓                                                │
│ <span class="hljs-number">3</span>. factory<span class="hljs-selector-class">.build</span>() → <span class="hljs-built_in">UserProfileViewModel</span>()        │
│    构造函数在 Zone 中执行                          │
└────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-18">第四步：DependencyHandler 从 Zone 中读取解析器</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// dependency_handler.dart</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DependencyHandler</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;DependencyResolver&gt; dependencyResolvers = [];

  T getViewModel&lt;T <span class="hljs-keyword">extends</span> ViewModel&gt;({
    <span class="hljs-built_in">Object?</span> key,
    <span class="hljs-built_in">Object?</span> tag,
    ViewModelFactory&lt;T&gt;? <span class="hljs-keyword">factory</span>,
    <span class="hljs-built_in">bool</span> listen = <span class="hljs-keyword">false</span>,
  }) {
    <span class="hljs-comment">// 👇 双重保障：先查列表，再查 Zone</span>
    <span class="hljs-keyword">final</span> resolver = dependencyResolvers.firstOrNull ??
        (Zone.current[_resolverKey] <span class="hljs-keyword">as</span> DependencyResolver?);

    <span class="hljs-keyword">if</span> (resolver == <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">throw</span> StateError(<span class="hljs-string">'No dependency resolver available'</span>);
    }

    <span class="hljs-comment">// 使用解析器获取依赖</span>
    <span class="hljs-keyword">return</span> resolver(
      dependency: ViewModelDependencyConfig&lt;T&gt;(...),
      listen: listen,
    );
  }
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li><code>Zone.current[_resolverKey]</code> 读取当前 Zone 中的解析器</li>
<li>双重保障：
<ol>
<li>优先使用 <code>dependencyResolvers</code> 列表（已添加的 resolver）</li>
<li>如果列表为空，从 Zone 中读取</li>
</ol>
</li>
</ul>
<h4 data-id="heading-19">第五步：ViewModel 在构造函数中愉快地获取依赖！</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserProfileViewModel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ViewModel</span> </span>{
  <span class="hljs-keyword">late</span> <span class="hljs-keyword">final</span> AuthViewModel _authVM;

  UserProfileViewModel() {
    <span class="hljs-comment">// ✅ 现在可以直接调用了！</span>
    _authVM = readViewModel&lt;AuthViewModel&gt;();
    
    <span class="hljs-keyword">if</span> (_authVM.isLoggedIn) {
      loadUserProfile();
    }
  }
  
  <span class="hljs-comment">// readViewModel 的实现</span>
  T readViewModel&lt;T <span class="hljs-keyword">extends</span> ViewModel&gt;() {
    <span class="hljs-comment">// 内部调用 dependencyHandler.getViewModel()</span>
    <span class="hljs-comment">// 它会从 Zone 中读取解析器 ✅</span>
    <span class="hljs-keyword">return</span> dependencyHandler.getViewModel&lt;T&gt;();
  }
}
</code></pre>
<h3 data-id="heading-20">完整的调用链</h3>
<pre><code class="hljs language-scss" lang="scss">┌──────────────────────────────────────────────────────────┐
│ <span class="hljs-number">1</span>. State<span class="hljs-selector-class">.watchViewModel</span>&lt;UserProfileViewModel&gt;()         │
│    ↓                                                      │
│ <span class="hljs-number">2</span>. attacher<span class="hljs-selector-class">._createViewModel</span>()                           │
│    ↓                                                      │
│ <span class="hljs-number">3</span>. <span class="hljs-built_in">runWithResolver</span>(                                      │
│      () =&gt; factory<span class="hljs-selector-class">.build</span>(),                              │
│      onChildDependencyResolver  👈 存入 Zone             │
│    )                                                      │
│    ↓                                                      │
│    【进入 Zone，携带 onChildDependencyResolver】          │
│    ↓                                                      │
│ <span class="hljs-number">4</span>. <span class="hljs-built_in">UserProfileViewModel</span>() 构造函数被调用                │
│    ↓                                                      │
│ <span class="hljs-number">5</span>. readViewModel&lt;AuthViewModel&gt;()                       │
│    ↓                                                      │
│ <span class="hljs-number">6</span>. dependencyHandler<span class="hljs-selector-class">.getViewModel</span>&lt;AuthViewModel&gt;()      │
│    ↓                                                      │
│ <span class="hljs-number">7</span>. 从 Zone<span class="hljs-selector-class">.current</span><span class="hljs-selector-attr">[_resolverKey]</span> 读取 resolver ✅       │
│    ↓                                                      │
│ <span class="hljs-number">8</span>. resolver&lt;AuthViewModel&gt;()                            │
│    → 调用 State 的 onChildDependencyResolver           │
│    → 回到 State 的上下文                               │
│    → 创建/获取 AuthViewModel ✅                         │
│    ↓                                                      │
│ <span class="hljs-number">9</span>. 返回 AuthViewModel 实例给 UserProfileViewModel      │
└──────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-21">为什么添加到 dependencyResolvers 列表？</h3>
<p>在创建完 ViewModel 后，会将 resolver 添加到列表中：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">final</span> res = runWithResolver(
  () {
    <span class="hljs-keyword">return</span> _instanceController.getInstance&lt;VM&gt;(...)
      ..dependencyHandler.addDependencyResolver(onChildDependencyResolver);  <span class="hljs-comment">// 👈</span>
  },
  onChildDependencyResolver,
);
</code></pre>
<p><strong>原因</strong>：</p>
<ol>
<li>ViewModel <strong>创建时</strong>：在 Zone 中，可以从 <code>Zone.current[_resolverKey]</code> 获取</li>
<li>ViewModel <strong>创建后</strong>：Zone 已退出，但 resolver 已添加到列表中</li>
<li>后续调用 <code>readViewModel</code> 时，从 <code>dependencyResolvers</code> 列表中获取</li>
</ol>
<p><strong>双重保障</strong>确保 ViewModel 在任何时候都能访问依赖解析器！</p>
<hr/>
<h2 data-id="heading-22">🌟 第四部分：Zone 方案的优势</h2>
<h3 data-id="heading-23">1. 架构纯净</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// ❌ 不好的方案：ViewModel 依赖 BuildContext</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserProfileViewModel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ViewModel</span> </span>{
  UserProfileViewModel(BuildContext context) {
    <span class="hljs-keyword">final</span> authVM = context.read&lt;AuthViewModel&gt;();  <span class="hljs-comment">// 违背分层原则</span>
  }
}

<span class="hljs-comment">// ✅ 优雅的方案：ViewModel 完全独立</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserProfileViewModel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ViewModel</span> </span>{
  UserProfileViewModel() {
    <span class="hljs-keyword">final</span> authVM = readViewModel&lt;AuthViewModel&gt;();  <span class="hljs-comment">// 不依赖任何 Widget 概念</span>
  }
}
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>ViewModel 不知道 Widget、BuildContext 的存在</li>
<li>可以在任何环境中测试（不需要 Widget 树）</li>
<li>保持了清晰的架构分层</li>
</ul>
<h3 data-id="heading-24">2. 开发体验极佳</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderViewModel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ViewModel</span> </span>{
  OrderViewModel() {
    <span class="hljs-comment">// 👇 像写同步代码一样简洁</span>
    <span class="hljs-keyword">final</span> userVM = readViewModel&lt;UserViewModel&gt;();
    <span class="hljs-keyword">final</span> cartVM = readViewModel&lt;CartViewModel&gt;();
    <span class="hljs-keyword">final</span> paymentVM = readViewModel&lt;PaymentViewModel&gt;();
    
    <span class="hljs-comment">// 直接使用，无需任何样板代码</span>
    <span class="hljs-keyword">if</span> (userVM.isLoggedIn &amp;&amp; cartVM.hasItems) {
      paymentVM.calculateTotal(cartVM.items);
    }
  }
}
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>代码简洁，可读性强</li>
<li>无需层层传递参数</li>
<li>构造函数逻辑清晰</li>
</ul>
<h3 data-id="heading-25">3. Zone 的自动传播</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ViewModel1</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ViewModel</span> </span>{
  ViewModel1() {
    <span class="hljs-comment">// 创建 ViewModel2 时，Zone 仍然有效</span>
    <span class="hljs-keyword">final</span> vm2 = readViewModel&lt;ViewModel2&gt;();
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ViewModel2</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ViewModel</span> </span>{
  ViewModel2() {
    <span class="hljs-comment">// ViewModel2 的构造函数仍在同一个 Zone 中</span>
    <span class="hljs-comment">// 可以继续获取其他依赖</span>
    <span class="hljs-keyword">final</span> vm3 = readViewModel&lt;ViewModel3&gt;();
  }
}
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>Zone 会自动传播到整个调用链</li>
<li>多级依赖的 ViewModel 可以无缝工作</li>
<li>不需要额外的传递逻辑</li>
</ul>
<h3 data-id="heading-26">4. 类型安全</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// ✅ 编译时类型检查</span>
<span class="hljs-keyword">final</span> authVM = readViewModel&lt;AuthViewModel&gt;();  <span class="hljs-comment">// AuthViewModel 类型</span>
authVM.login();  <span class="hljs-comment">// IDE 提供完整的代码补全</span>

<span class="hljs-comment">// ❌ 如果用 Map 传递参数，失去类型安全</span>
<span class="hljs-keyword">final</span> authVM = dependencies[<span class="hljs-string">'auth'</span>] <span class="hljs-keyword">as</span> AuthViewModel?;  <span class="hljs-comment">// 运行时可能出错</span>
</code></pre>
<hr/>
<h2 data-id="heading-27">📦 总结</h2>
<p>通过 Zone 机制，view_model 实现了优雅的依赖注入，让开发者可以在 ViewModel 构造函数中自然地获取依赖，同时保持架构的清晰和纯净！🚀  来试试：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.dev%2Fpackages%2Fview_model" target="_blank" title="https://pub.dev/packages/view_model" ref="nofollow noopener noreferrer">pub.dev/packages/vi…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot项目整合Kafka启动失败的常见错误总结]]></title>    <link>https://juejin.cn/post/7574734686494441508</link>    <guid>https://juejin.cn/post/7574734686494441508</guid>    <pubDate>2025-11-21T06:31:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574734686494441508" data-draft-id="7574745301724790790" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot项目整合Kafka启动失败的常见错误总结"/> <meta itemprop="keywords" content="Spring Boot"/> <meta itemprop="datePublished" content="2025-11-21T06:31:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java水解"/> <meta itemprop="url" content="https://juejin.cn/user/2441349519143037"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot项目整合Kafka启动失败的常见错误总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2441349519143037/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java水解
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T06:31:39.000Z" title="Fri Nov 21 2025 06:31:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、Kafka服务器连接问题</h3>
<h4 data-id="heading-1"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1. Kafka服务器无法连接</h4>
<p><strong>报错内容</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">java.lang.IllegalStateException: Cannot connect to bootstrap servers

AI写代码
<span class="hljs-number">1</span>
</code></pre>
<p><strong>原因</strong>：</p>
<ul>
<li>Kafka服务器未启动</li>
<li>配置的IP地址或端口错误</li>
<li>防火墙阻止了对Kafka服务器的访问</li>
</ul>
<p><strong>解决方案</strong>：</p>
<ul>
<li>确保Kafka服务器正在运行（<code>bin/kafka-server-start.sh config/server.properties</code>）</li>
<li>检查<code>bootstrap-servers</code>配置是否正确</li>
<li>确保防火墙开放了Kafka使用的端口（默认9092）</li>
</ul>
<h4 data-id="heading-2"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2. 开发环境与生产环境网络不通</h4>
<p><strong>报错内容</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">java.lang.IllegalStateException: Cannot connect to bootstrap servers

AI写代码
<span class="hljs-number">1</span>
</code></pre>
<p><strong>原因</strong>：</p>
<ul>
<li>开发环境配置了生产环境的Kafka地址</li>
<li>开发环境与生产环境网络不通</li>
</ul>
<p><strong>解决方案</strong>：</p>
<ul>
<li>
<p>关闭Kafka消费端的自动启动：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 方案1：在容器工厂中设置</span>
<span class="hljs-meta">@Bean</span>
public ConcurrentKafkaListenerContainerFactory&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">String</span>&gt; kafkaListenerContainerFactory() {
    ConcurrentKafkaListenerContainerFactory&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">String</span>&gt; <span class="hljs-keyword">factory</span> = <span class="hljs-keyword">new</span> ConcurrentKafkaListenerContainerFactory&lt;&gt;();
    <span class="hljs-keyword">factory</span>.setConsumerFactory(consumerFactory());
    <span class="hljs-keyword">factory</span>.setAutoStartup(<span class="hljs-keyword">false</span>); <span class="hljs-comment">// 关闭自动启动</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">factory</span>;
}

<span class="hljs-comment">// 方案2：在@KafkaListener注解中设置</span>
<span class="hljs-meta">@KafkaListener</span>(
    topics = <span class="hljs-string">"my-topic"</span>,
    groupId = <span class="hljs-string">"my-group"</span>,
    autoStartup = <span class="hljs-string">"false"</span> <span class="hljs-comment">// 关闭自动启动</span>
)

AI写代码java
运行
<span class="hljs-number">123456789101112131415</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-3"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>二、序列化配置错误</h3>
<h4 data-id="heading-4"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1. 生产者序列化配置错误</h4>
<p><strong>报错内容</strong>：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">KafkaException:</span> Failed <span class="hljs-keyword">to</span> construct kafka producer
Caused <span class="hljs-keyword">by</span>: org.apache.kafka.common.errors.SerializationException: 
<span class="hljs-keyword">Error</span> serializing <span class="hljs-keyword">key</span>/value <span class="hljs-keyword">for</span> partition my-topic-<span class="hljs-number">0</span>

AI写代码
<span class="hljs-number">123</span>
</code></pre>
<p><strong>原因</strong>：</p>
<ul>
<li>配置了错误的序列化器（如<code>value-serializer</code>配置为<code>StringDeserializer</code>，应为<code>StringSerializer</code>）</li>
</ul>
<p><strong>正确配置</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">kafka:</span>
    <span class="hljs-attr">producer:</span>
      <span class="hljs-attr">key-serializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringSerializer</span>
      <span class="hljs-attr">value-serializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringSerializer</span>

<span class="hljs-string">AI写代码yaml</span>
<span class="hljs-number">12345</span>
</code></pre>
<h4 data-id="heading-5"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2. 消费者反序列化配置错误</h4>
<p><strong>报错内容</strong>：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">org.apache.kafka.common.errors.SerializationException: <span class="hljs-keyword">Error</span> deserializing <span class="hljs-keyword">key</span>/value <span class="hljs-keyword">for</span> partition my-topic-<span class="hljs-number">0</span>

AI写代码
<span class="hljs-number">1</span>
</code></pre>
<p><strong>原因</strong>：</p>
<ul>
<li>消费者配置了错误的反序列化器</li>
</ul>
<p><strong>正确配置</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">kafka:</span>
    <span class="hljs-attr">consumer:</span>
      <span class="hljs-attr">key-deserializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringDeserializer</span>
      <span class="hljs-attr">value-deserializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringDeserializer</span>

<span class="hljs-string">AI写代码yaml</span>
<span class="hljs-number">12345</span>
</code></pre>
<h3 data-id="heading-6"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>三、依赖配置问题</h3>
<h4 data-id="heading-7"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1. 缺少必要的Kafka依赖</h4>
<p><strong>报错内容</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">Caused by: java.lang.NoClassDefFoundError: org/apache/kafka/common/serialization/Serializer

AI写代码
1
</code></pre>
<p><strong>原因</strong>：</p>
<ul>
<li>项目中缺少<code>spring-kafka</code>依赖</li>
</ul>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.kafka<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-kafka<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.8.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span> <span class="hljs-comment">&lt;!-- 与Spring Boot版本匹配 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

AI写代码xml
12345
</code></pre>
<h4 data-id="heading-8"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2. 依赖版本不兼容</h4>
<p><strong>报错内容</strong>：</p>
<pre><code class="hljs language-css" lang="css">Caused by: java.lang.NoSuchMethodError: org.apache.kafka.common.serialization.Serializer.<span class="hljs-built_in">serialize</span>(Ljava/lang/String;Ljava/lang/<span class="hljs-selector-tag">Object</span>;)Ljava/lang/byte<span class="hljs-selector-attr">[]</span>

AI写代码
<span class="hljs-number">1</span>
</code></pre>
<p><strong>原因</strong>：</p>
<ul>
<li>Spring Boot、Spring Kafka和Kafka服务器版本不兼容</li>
</ul>
<p><strong>解决方案</strong>：</p>
<ul>
<li>确保使用与Kafka服务器版本兼容的Spring Kafka版本</li>
<li>参考Spring Boot官方文档的版本兼容性表</li>
</ul>
<h3 data-id="heading-9"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>四、配置文件错误</h3>
<h4 data-id="heading-10"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1. 配置文件格式错误</h4>
<p><strong>报错内容</strong>：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">org.springframework.beans.factory.BeanCreationException: 
<span class="hljs-keyword">Error</span> creating bean <span class="hljs-keyword">with</span> name <span class="hljs-comment">'kafkaListenerContainerFactory' defined in class path resource </span>
[org/springframework/boot/autoconfigure/kafka/KafkaAutoConfiguration.<span class="hljs-keyword">class</span>]: 
Cannot create a Kafka listener container factory <span class="hljs-keyword">for</span> the given configuration.

AI写代码
<span class="hljs-number">1234</span>
</code></pre>
<p><strong>原因</strong>：</p>
<ul>
<li>YAML文件缩进错误</li>
<li>配置项拼写错误</li>
<li>配置项格式不正确</li>
</ul>
<p><strong>正确配置示例</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">kafka:</span>
    <span class="hljs-attr">bootstrap-servers:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:9092</span>
    <span class="hljs-attr">producer:</span>
      <span class="hljs-attr">key-serializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringSerializer</span>
      <span class="hljs-attr">value-serializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringSerializer</span>
    <span class="hljs-attr">consumer:</span>
      <span class="hljs-attr">group-id:</span> <span class="hljs-string">my-group</span>
      <span class="hljs-attr">auto-offset-reset:</span> <span class="hljs-string">earliest</span>
      <span class="hljs-attr">enable-auto-commit:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">key-deserializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringDeserializer</span>
      <span class="hljs-attr">value-deserializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringDeserializer</span>

<span class="hljs-string">AI写代码yaml</span>
<span class="hljs-number">123456789101112</span>
</code></pre>
<h3 data-id="heading-11"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>五、其他常见启动问题</h3>
<h4 data-id="heading-12"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1. Kafka消费者无法自动提交偏移量</h4>
<p><strong>报错内容</strong>：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">org.apache.kafka.common.errors.SerializationException: <span class="hljs-keyword">Error</span> serializing <span class="hljs-keyword">key</span>/value <span class="hljs-keyword">for</span> partition my-topic-<span class="hljs-number">0</span>

AI写代码
<span class="hljs-number">1</span>
</code></pre>
<p><strong>原因</strong>：</p>
<ul>
<li>未配置<code>enable.auto.commit</code>参数或设置为<code>false</code></li>
</ul>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">kafka:</span>
    <span class="hljs-attr">consumer:</span>
      <span class="hljs-attr">enable-auto-commit:</span> <span class="hljs-literal">true</span>

<span class="hljs-string">AI写代码yaml</span>
<span class="hljs-number">1234</span>
</code></pre>
<h4 data-id="heading-13"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2. 配置项拼写错误</h4>
<p><strong>报错内容</strong>：</p>
<pre><code class="hljs language-python" lang="python">Caused by: java.lang.IllegalArgumentException: 
Invalid <span class="hljs-built_in">property</span> <span class="hljs-string">'spring.kafka.producer.key-serializer'</span> <span class="hljs-keyword">for</span> bean of <span class="hljs-built_in">type</span> <span class="hljs-string">'org.springframework.boot.context.properties.bind.BindException'</span>

AI写代码
<span class="hljs-number">12</span>
</code></pre>
<p><strong>原因</strong>：</p>
<ul>
<li>配置项拼写错误，如<code>key-serializer</code>写成了<code>key-serialzer</code></li>
</ul>
<p><strong>解决方案</strong>：</p>
<ul>
<li>检查所有配置项的拼写，确保与官方文档一致</li>
</ul>
<h3 data-id="heading-14"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>总结</h3>
<ol>
<li><strong>确保Kafka服务已启动</strong>：使用<code>bin/kafka-broker-start.sh</code>启动Kafka</li>
<li><strong>检查连接配置</strong>：确认<code>bootstrap-servers</code>配置正确</li>
<li><strong>正确配置序列化</strong>：生产者使用<code>Serializer</code>，消费者使用<code>Deserializer</code></li>
<li><strong>添加必要依赖</strong>：确保包含<code>spring-kafka</code>依赖</li>
<li><strong>处理开发环境问题</strong>：关闭Kafka消费端的自动启动</li>
<li><strong>验证配置格式</strong>：检查YAML缩进和拼写</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[受够了 create-xxx？我写了一个聚合主流框架的脚手架]]></title>    <link>https://juejin.cn/post/7574725286530400307</link>    <guid>https://juejin.cn/post/7574725286530400307</guid>    <pubDate>2025-11-21T06:35:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574725286530400307" data-draft-id="7574724406306226226" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="受够了 create-xxx？我写了一个聚合主流框架的脚手架"/> <meta itemprop="keywords" content="前端,面试,架构"/> <meta itemprop="datePublished" content="2025-11-21T06:35:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吃饺子不吃馅"/> <meta itemprop="url" content="https://juejin.cn/user/1148309742825495"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            受够了 create-xxx？我写了一个聚合主流框架的脚手架
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1148309742825495/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吃饺子不吃馅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T06:35:30.000Z" title="Fri Nov 21 2025 06:35:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>“不想自己写脚手架的前端不是好前端”，这句话我一直记在心里回响。每次开启一个新项目，我总觉得缺了点什么。在做了大量的调研和思考之后，我决定，是时候动手打造一个属于自己的前端脚手架了。</p>
<p>我个人感觉目前主要面临两个痛点：</p>
<ol>
<li>
<p><strong>市面上的脚手架太多了，记不住！</strong> 说实话，<code>create-react-app</code>、<code>create-vite</code>、<code>create-next-app</code>... 每次用都要先去搜索文档，找到那个准确的命令。我常常想，能不能有一个统一的入口，让我不再为记这些名字而烦恼？</p>
</li>
<li>
<p><strong>脚手架不够灵活，不能自由组合。</strong> 官方的脚手架通常只提供最基础的模板。如果我想加入 <code>React Router</code>、<code>Zustand</code>，或者配置好 <code>ESLint</code> 和 <code>Prettier</code>，就得在项目创建后手动安装、配置一大堆东西。这个过程繁琐、重复，且容易出错。</p>
</li>
</ol>
<p>那么，我能不能写一个<strong>既能汇总主流脚手架，又能让我在创建时就自由组合所需配置</strong>的工具呢？这不仅能解决我的痛点，也是一个绝佳的学习机会。</p>
<p>于是，我开始疯狂撸代码，<code>create-web-app</code> 的雏形就此诞生</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fduchao-duchao%2Fcreate-web-app" target="_blank" title="https://github.com/duchao-duchao/create-web-app" ref="nofollow noopener noreferrer">create-web-app</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ee2c052b8be42108d3cf30914f6c1e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCD6aW65a2Q5LiN5ZCD6aaF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764311730&amp;x-signature=fgHznrpZrCx4wlZh9rVqfa9zFDU%3D" alt="img_v3_02s8_1765d6d6-082d-4324-9264-032a80a4667g.jpg" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67c6f582eec84dab85ec4c36e93ba18e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCD6aW65a2Q5LiN5ZCD6aaF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764311730&amp;x-signature=ZMcNMgJIqaO4eDQNFbjhMcQfwo0%3D" alt="img_v3_02s8_66e644e0-dd5f-4047-ae24-989237297bbg.jpg" loading="lazy"/></p>
<h3 data-id="heading-0">支持多引擎选择</h3>
<p>为了解决“记不住命令”的问题，我首先做了一个“引擎选择”功能。我汇总了目前社区最主流的十几种脚手架，包括：</p>
<ul>
<li>Vite (React, Vue, Svelte...)</li>
<li>Umi</li>
<li>Create React App</li>
<li>Next.js</li>
<li>Nuxt</li>
<li>Astro</li>
<li>SvelteKit</li>
<li>Angular</li>
<li>Remix</li>
<li>...等等</li>
</ul>
<p>现在，你只需要记住一个命令 <code>pnpm create-web-app</code>，就能启动任何一个主流框架的创建流程。它就像一个超级启动器，将所有官方 CLI 的能力都聚合在了一起</p>
<h3 data-id="heading-1">自由组合配置</h3>
<p>除了代理外部工具，我做了一套create-web-app的自己的创建模版，可以在创建项目时，就完成所有基础配置的自由组合。</p>
<h4 data-id="heading-2"><strong>框架、语言、状态管理、路由、规范... 一步到位！</strong></h4>
<p>在create-web-app模式下，可以通过交互式的问答，一步步进行：</p>
<ol>
<li><strong>选择框架</strong>：React 还是 Vue？</li>
<li><strong>选择语言</strong>：JavaScript 还是 TypeScript？</li>
<li><strong>选择插件</strong>：
<ul>
<li><strong>路由</strong>：需要 <code>React Router</code> 或 <code>Vue Router</code> 吗？</li>
<li><strong>状态管理</strong>：<code>Redux</code>、<code>Zustand</code> 还是 <code>Pinia</code>？</li>
<li><strong>代码规范</strong>：<code>ESLint</code>、<code>Prettier</code>、<code>Husky</code> 要不要安排上？</li>
</ul>
</li>
</ol>
<p>当你确认完所有选项后，一个已经<strong>配置齐全、装好依赖、甚至连入口文件都帮你改好</strong>的项目就诞生了！你不再需要手动 <code>pnpm install</code> 一堆包，再小心翼翼地去 <code>main.js</code> 里 <code>app.use(router)</code>。</p>
<h4 data-id="heading-3"><strong>实现</strong></h4>
<p>这种灵活性背后，是一套精心设计的<strong>声明式插件系统</strong>和<strong>基于 AST 的代码注入</strong>机制。</p>
<ul>
<li>
<p><strong>插件注册中心 (<code>plugin-registry.js</code>)</strong>：我把每一个可选功能（如 Zustand、ESLint）都抽象成一个插件。每个插件清晰地定义了它需要：</p>
<ul>
<li>哪些 <code>npm</code> 依赖 (<code>pkg</code>)</li>
<li>哪些配置文件 (<code>files</code>)</li>
<li>需要对哪个文件的代码做什么修改 (<code>transforms</code>)</li>
</ul>
</li>
<li>
<p><strong>AST 代码变换器 (<code>transforms/</code>)</strong>：当你说需要 <code>React Router</code> 时，脚手架不会用粗暴的字符串替换来修改你的入口文件。它会把 <code>main.jsx</code> 解析成一个抽象语法树（AST），精准地找到 <code>&lt;App /&gt;</code>，然后用 <code>&lt;RouterProvider /&gt;</code> 将其包裹，最后再把 AST 安全地转换回代码</p>
</li>
</ul>
<h3 data-id="heading-4"><strong>总结</strong></h3>
<p>从一个想法，到一个可用的工具，<code>create-web-app</code> 解决了我作为前端开发者最真实的痛点。它通过“双引擎”模式，既拥抱了社区的强大生态，又通过“自研插件”模式提供了极致的灵活性和效率</p>
<p>当然，它目前还只是一个初版，未来还有很多可以做的事情：</p>
<ul>
<li>
<p><strong>支持 CLI 直传参数</strong>：实现 <code>pnpm create-web-app my-app --framework react --plugins router,zustand</code>，跳过交互，一键生成。</p>
</li>
<li>
<p><strong>扩充插件生态</strong>：加入更多测试框架、组件库、国际化等插件。</p>
</li>
<li>
<p><strong>企业级规范注入</strong>：一键集成团队的 CI/CD 配置、Git Hooks 规范等。</p>
</li>
<li>
<p>目前仅仅支持pnpm包管理工具</p>
</li>
<li>
<p>目前仅仅支持vite打包</p>
</li>
<li>
<p>等等</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用户登录后，Token 到底该存哪里？从懵圈到精通的全方位解析]]></title>    <link>https://juejin.cn/post/7574749664491946018</link>    <guid>https://juejin.cn/post/7574749664491946018</guid>    <pubDate>2025-11-21T06:35:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574749664491946018" data-draft-id="7574869203448184832" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用户登录后，Token 到底该存哪里？从懵圈到精通的全方位解析"/> <meta itemprop="keywords" content="前端,面试"/> <meta itemprop="datePublished" content="2025-11-21T06:35:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大知闲闲i"/> <meta itemprop="url" content="https://juejin.cn/user/3799545205237111"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用户登录后，Token 到底该存哪里？从懵圈到精通的全方位解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3799545205237111/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大知闲闲i
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T06:35:52.000Z" title="Fri Nov 21 2025 06:35:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>面试官的一个简单问题，却让我陷入了深思。这不仅是前端问题，更是全栈工程师必须掌握的 security 基础。</p>
</blockquote>
<p>“说说看，用户登录后拿到的 Token，你会存在哪里？”</p>
<p>记得我第一次被问到这个问题时，信心满满地回答：“localStorage 呗，简单方便。”然后，空气突然安静了...</p>
<p>有后端小伙伴可能会问，这种前端存储问题后端也需要关心吗？答案是：<strong>绝对需要！</strong> 安全是一个全链路问题，任何一环的疏忽都会导致整个系统的崩溃。</p>
<h2 data-id="heading-0">初探：天真的 localStorage 方案</h2>
<p>很多前端开发者的第一反应都是 localStorage，因为它确实简单直观：</p>
<pre><code class="hljs language-ini" lang="ini">// 登录成功后
localStorage.setItem('token', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...')<span class="hljs-comment">;</span>
​
// 请求时自动携带
axios.interceptors.request.use(<span class="hljs-attr">config</span> =&gt; {
  const <span class="hljs-attr">token</span> = localStorage.getItem(<span class="hljs-string">'token'</span>)<span class="hljs-comment">;</span>
  if (token) {
    <span class="hljs-attr">config.headers.Authorization</span> = `Bearer <span class="hljs-variable">${token}</span>`<span class="hljs-comment">;</span>
  }
  return config<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<p><strong>优点很明显：</strong></p>
<ul>
<li>
<p>简单直观，上手快速</p>
</li>
<li>
<p>持久化存储，页面刷新不影响用户体验</p>
</li>
<li>
<p>API 友好，操作方便</p>
</li>
</ul>
<p><strong>但致命问题在于：</strong></p>
<ul>
<li>
<p>一旦遭遇 XSS 攻击，攻击者可以直接通过 JavaScript 读取你的 Token</p>
</li>
<li>
<p>相当于把家门钥匙放在门口的垫子下面</p>
</li>
<li>
<p>几乎无法有效防御 XSS 窃取</p>
</li>
</ul>
<h2 data-id="heading-1">深入：真正的解决方案</h2>
<h3 data-id="heading-2">方案一：HttpOnly Cookie - 传统的智慧</h3>
<p>这是最经典的解决方案，通过服务端设置 HttpOnly 标志来保护 Token：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 服务端设置 Cookie（Node.js/Express 示例）</span>
res.<span class="hljs-built_in">cookie</span>(<span class="hljs-string">'token'</span>, <span class="hljs-string">'eyJhbGci...'</span>, {
  httpOnly: <span class="hljs-literal">true</span>,      <span class="hljs-comment">// 禁止 JavaScript 访问</span>
  secure: process.env.NODE_ENV === <span class="hljs-string">'production'</span>, <span class="hljs-comment">// 仅 HTTPS</span>
  sameSite: <span class="hljs-string">'strict'</span>,  <span class="hljs-comment">// 防御 CSRF</span>
  maxAge: <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span> <span class="hljs-comment">// 1天有效期</span>
});
</code></pre>
<p><strong>前端无需特殊处理：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 浏览器会自动在每次请求中携带 Cookie</span>
<span class="hljs-comment">// 前端 JavaScript 无法读取，彻底防御 XSS</span>
</code></pre>
<p><strong>配套的 CSRF 防护方案：</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 方案1：CSRF Token</span>
<span class="hljs-keyword">const</span> csrfToken = <span class="hljs-built_in">document</span>.<span class="hljs-built_in">querySelector</span>(<span class="hljs-string">'meta[name="csrf-token"]'</span>).content;
axios.defaults.headers.common[<span class="hljs-string">'X-CSRF-Token'</span>] = csrfToken;
​
<span class="hljs-comment">// 方案2：双重提交 Cookie 验证</span>
<span class="hljs-comment">// 服务端同时验证 Cookie 和 Header 中的 Token</span>
</code></pre>
<p><strong>适用场景：</strong></p>
<ul>
<li>
<p>传统多页面应用</p>
</li>
<li>
<p>SSR 服务端渲染项目</p>
</li>
<li>
<p>对 SPA 单页应用也完全可行</p>
</li>
</ul>
<h3 data-id="heading-3">方案二：内存存储 - 极致的安全追求</h3>
<p>对于安全性要求极高的场景，内存存储是最安全的选择：</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">memoryToken</span> = null<span class="hljs-comment">;</span>
​
// 登录后存储
const <span class="hljs-attr">login</span> = async (credentials) =&gt; {
  const <span class="hljs-attr">response</span> = await axios.post(<span class="hljs-string">'/api/login'</span>, credentials)<span class="hljs-comment">;</span>
  <span class="hljs-attr">memoryToken</span> = response.data.token<span class="hljs-comment">;</span>
  return response<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
​
// 请求拦截器
axios.interceptors.request.use(<span class="hljs-attr">config</span> =&gt; {
  if (memoryToken) {
    <span class="hljs-attr">config.headers.Authorization</span> = `Bearer <span class="hljs-variable">${memoryToken}</span>`<span class="hljs-comment">;</span>
  }
  return config<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
​
// 登出或页面关闭时清理
const <span class="hljs-attr">logout</span> = () =&gt; {
  <span class="hljs-attr">memoryToken</span> = null<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<p><strong>优势：</strong></p>
<ul>
<li>
<p>完全不持久化，免疫 XSS 攻击</p>
</li>
<li>
<p>页面关闭即失效，安全性最高</p>
</li>
<li>
<p>实现简单，无需复杂配置</p>
</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>
<p>页面刷新就需要重新登录，用户体验较差</p>
</li>
<li>
<p>移动端应用切换时可能丢失状态</p>
</li>
</ul>
<p><strong>适用场景：</strong></p>
<ul>
<li>
<p>银行、金融等高安全要求应用</p>
</li>
<li>
<p>内部管控系统</p>
</li>
<li>
<p>敏感操作的身份验证</p>
</li>
</ul>
<h3 data-id="heading-4">方案三：现代 SPA 的黄金标准 - 双 Token 机制</h3>
<p>这才是现代 Web 应用在安全与体验间的完美平衡：</p>
<p>Token 类型</p>
<p>存储位置</p>
<p>有效期</p>
<p>用途</p>
<p>Access Token</p>
<p>内存</p>
<p>短（15分钟-2小时）</p>
<p>API 调用身份验证</p>
<p>Refresh Token</p>
<p>HttpOnly Cookie</p>
<p>长（7天-30天）</p>
<p>刷新 Access Token</p>
<p><strong>实现方案：</strong></p>
<pre><code class="hljs language-ini" lang="ini">// 登录处理
const <span class="hljs-attr">handleLogin</span> = async (credentials) =&gt; {
  const <span class="hljs-attr">response</span> = await axios.post(<span class="hljs-string">'/api/login'</span>, credentials)<span class="hljs-comment">;</span>
  const { accessToken } = response.data<span class="hljs-comment">;</span>
  
  // Access Token 存内存
  setAccessToken(accessToken)<span class="hljs-comment">;</span>
  // Refresh Token 由服务端设置为 HttpOnly Cookie
  
  return response<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
​
// 请求拦截器 - 自动携带 Access Token
axios.interceptors.request.use(<span class="hljs-attr">config</span> =&gt; {
  const <span class="hljs-attr">token</span> = getAccessToken()<span class="hljs-comment">;</span>
  if (token) {
    <span class="hljs-attr">config.headers.Authorization</span> = `Bearer <span class="hljs-variable">${token}</span>`<span class="hljs-comment">;</span>
  }
  return config<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
​
// 响应拦截器 - 自动刷新 Token
axios.interceptors.response.use(
  <span class="hljs-attr">response</span> =&gt; response,
  async <span class="hljs-attr">error</span> =&gt; {
    if (error.response?.<span class="hljs-attr">status</span> === <span class="hljs-number">401</span>) {
      // Access Token 过期，尝试刷新
      try {
        const <span class="hljs-attr">newToken</span> = await refreshToken()<span class="hljs-comment">;</span>
        setAccessToken(newToken)<span class="hljs-comment">;</span>
        // 重试原始请求
        <span class="hljs-attr">error.config.headers.Authorization</span> = `Bearer <span class="hljs-variable">${newToken}</span>`<span class="hljs-comment">;</span>
        return axios.request(error.config)<span class="hljs-comment">;</span>
      } catch (refreshError) {
        // 刷新失败，跳转登录页
        logout()<span class="hljs-comment">;</span>
        <span class="hljs-attr">window.location.href</span> = <span class="hljs-string">'/login'</span><span class="hljs-comment">;</span>
      }
    }
    return Promise.reject(error)<span class="hljs-comment">;</span>
  }
)<span class="hljs-comment">;</span>
</code></pre>
<p><strong>刷新 Token 的服务端实现：</strong></p>
<pre><code class="hljs language-ini" lang="ini">app.post('/api/refresh', async (req, res) =&gt; {
  const <span class="hljs-attr">refreshToken</span> = req.cookies.refreshToken<span class="hljs-comment">;</span>
  
  if (!refreshToken) {
    return res.status(401).json({ message: 'Refresh token required' })<span class="hljs-comment">;</span>
  }
  
  try {
    const <span class="hljs-attr">decoded</span> = verifyRefreshToken(refreshToken)<span class="hljs-comment">;</span>
    const <span class="hljs-attr">newAccessToken</span> = generateAccessToken({ userId: decoded.userId })<span class="hljs-comment">;</span>
    
    res.json({ accessToken: newAccessToken })<span class="hljs-comment">;</span>
  } catch (error) {
    res.clearCookie('refreshToken')<span class="hljs-comment">;</span>
    res.status(401).json({ message: 'Invalid refresh token' })<span class="hljs-comment">;</span>
  }
})<span class="hljs-comment">;</span>
</code></pre>
<h2 data-id="heading-5">全方位方案对比</h2>
<p>存储方案</p>
<p>安全性</p>
<p>用户体验</p>
<p>实现复杂度</p>
<p>适用场景</p>
<p>localStorage</p>
<p>❌ 低</p>
<p>✅ 好</p>
<p>✅ 简单</p>
<p>内部工具、演示项目</p>
<p>HttpOnly Cookie</p>
<p>✅ 高</p>
<p>✅ 好</p>
<p>✅ 中等</p>
<p>传统 Web 应用、SSR</p>
<p>内存存储</p>
<p>✅ 极高</p>
<p>❌ 差</p>
<p>✅ 简单</p>
<p>高安全要求系统</p>
<p>双 Token 机制</p>
<p>✅ 很高</p>
<p>✅ 好</p>
<p>❌ 复杂</p>
<p>现代 SPA 应用</p>
<h2 data-id="heading-6">面试官的真正期待</h2>
<p><strong>初级回答：</strong></p>
<blockquote>
<p>"localStorage，因为简单方便。"</p>
</blockquote>
<p><strong>中级回答：</strong></p>
<blockquote>
<p>"用 HttpOnly Cookie，因为能防 XSS，但要配合 CSRF 防护。"</p>
</blockquote>
<p><strong>高级回答：</strong></p>
<blockquote>
<p>"要看具体场景。如果是内部低风险系统，localStorage 的简洁性也有价值。如果是传统 Web 应用，HttpOnly Cookie + CSRF Token 是久经考验的方案。如果是现代 SPA，我推荐 Access Token + Refresh Token 的组合，在安全和体验间取得最佳平衡。同时要考虑业务的安全要求、用户的使用习惯和技术团队的维护能力。"</p>
</blockquote>
<p>这才是面试官想听到的：</p>
<ul>
<li>
<p>理解不同方案的权衡取舍</p>
</li>
<li>
<p>能够根据业务场景做出合理选择</p>
</li>
<li>
<p>清楚每种方案的安全边界和风险点</p>
</li>
<li>
<p>具备全链路的安全思维</p>
</li>
</ul>
<h2 data-id="heading-7">安全的核心是平衡，不是绝对</h2>
<p>回头看我当初那个 naive 的 "localStorage" 回答，问题不在于技术本身，而在于思考方式。</p>
<p><strong>真正的安全专家不是追求绝对安全，而是懂得：</strong></p>
<ul>
<li>
<p>在什么业务场景下选择什么技术方案</p>
</li>
<li>
<p>每种方案的风险边界和应对措施</p>
</li>
<li>
<p>如何用合适的成本解决合适的风险</p>
</li>
<li>
<p>如何在安全、体验、开发效率间找到平衡点</p>
</li>
</ul>
<p>现在当面试官再问我 "Token 该存哪里" 时，我会先反问：</p>
<blockquote>
<p>"咱们的业务场景是什么？安全要求等级多高？目标用户的使用习惯怎样？技术团队的维护能力如何？"</p>
</blockquote>
<p>因为，<strong>没有最好的方案，只有最合适的方案</strong>。安全之路，需要的是持续学习和深度思考。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>