<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[【LangChain学习笔记】输出解析器]]></title>    <link>https://juejin.cn/post/7588844115318685748</link>    <guid>https://juejin.cn/post/7588844115318685748</guid>    <pubDate>2025-12-29T07:17:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588844115318685748" data-draft-id="7589063105731035151" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【LangChain学习笔记】输出解析器"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-29T07:17:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用泥种荷花"/> <meta itemprop="url" content="https://juejin.cn/user/4212984289442030"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【LangChain学习笔记】输出解析器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984289442030/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用泥种荷花
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T07:17:30.000Z" title="Mon Dec 29 2025 07:17:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    45
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">核心定义</h2>
<p>输出解析器是 LangChain 核心组件之一，核心作用有三：</p>
<ol>
<li>为大模型提供标准化格式化提示词，引导模型按指定格式输出；</li>
<li>校验大模型输出是否符合预期格式要求；</li>
<li>解析大模型输出内容，转换为可用格式（字符串/结构化对象等）；</li>
</ol>
<h2 data-id="heading-1">常用输出解析器及使用</h2>
<h3 data-id="heading-2">StrOutputParser（字符串解析器）</h3>
<h4 data-id="heading-3">核心作用</h4>
<p>用于清理大模型输出内容，去除输出前后的换行符（<code>\n</code>），仅保留纯文本核心输出，返回标准字符串格式。</p>
<h4 data-id="heading-4">完整使用示例</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> PromptTemplate
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser

<span class="hljs-comment"># 大模型初始化</span>
llm = ChatOpenAI(
    model_name=<span class="hljs-string">"qwen-plus"</span>,
    base_url=<span class="hljs-string">"https://dashscope.aliyuncs.com/compatible-mode/v1"</span>,
    api_key=<span class="hljs-string">"[你的API Key]"</span>
)

<span class="hljs-comment"># 定义提示模板</span>
prompt_template = PromptTemplate.from_template(<span class="hljs-string">"你是一个专业的数学助手，{question}"</span>)

<span class="hljs-comment"># 初始化字符串解析器</span>
str_output_parser = StrOutputParser()

<span class="hljs-comment"># 构建链式调用</span>
chain = prompt_template | llm | str_output_parser

<span class="hljs-comment"># 执行调用</span>
response = chain.invoke(<span class="hljs-built_in">input</span>={<span class="hljs-string">"question"</span>: <span class="hljs-string">"计算10和20的和"</span>})

<span class="hljs-comment"># 打印解析后结果</span>
<span class="hljs-built_in">print</span>(response)
</code></pre>
<blockquote>
<p><strong>提示</strong>：<code>StrOutputParser </code> 不存在 <code>get_format_instructions</code> 方法，无需配置格式化指令。</p>
</blockquote>
<h3 data-id="heading-5">PydanticOutputParser（结构化对象解析器）</h3>
<h4 data-id="heading-6">核心作用</h4>
<p>将大模型输出解析为符合 Pydantic 模型定义的结构化对象，便于后续数据提取与校验，返回值为 Pydantic 模型实例对象。</p>
<h4 data-id="heading-7">关键方法</h4>
<p><code>get_format_instructions()</code>：获取 Pydantic 模型对应的格式化指令，用于传递给提示模板，引导大模型按格式输出。</p>
<h4 data-id="heading-8">完整使用示例</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> PromptTemplate
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> PydanticOutputParser
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field

<span class="hljs-comment"># 大模型初始化</span>
llm = ChatOpenAI(
    model_name=<span class="hljs-string">"qwen-plus"</span>,
    base_url=<span class="hljs-string">"https://dashscope.aliyuncs.com/compatible-mode/v1"</span>,
    api_key=<span class="hljs-string">"[你的API Key]"</span>
)

<span class="hljs-comment"># 定义Pydantic数据模型</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SumArgs</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    num1: <span class="hljs-built_in">int</span> = Field(description=<span class="hljs-string">"第一个数"</span>)
    num2: <span class="hljs-built_in">int</span> = Field(description=<span class="hljs-string">"第二个数"</span>)
    <span class="hljs-built_in">sum</span>: <span class="hljs-built_in">int</span> = Field(description=<span class="hljs-string">"两个数的和"</span>)

<span class="hljs-comment"># 初始化Pydantic输出解析器</span>
pydantic_output_parser = PydanticOutputParser(pydantic_object=SumArgs)

<span class="hljs-comment"># 定义提示模板</span>
prompt_template = PromptTemplate.from_template(
    <span class="hljs-string">"""
    你是一个专业的数学助手
    问题内容：{question}
    输出格式：{format_instructions}
    """</span>
)

<span class="hljs-comment"># 预填充格式化指令</span>
prompt_template = prompt_template.partial(
    format_instructions=pydantic_output_parser.get_format_instructions()
)

<span class="hljs-comment"># 构建链式调用</span>
chain = prompt_template | llm | pydantic_output_parser

<span class="hljs-comment"># 执行调用</span>
response = chain.invoke(<span class="hljs-built_in">input</span>={<span class="hljs-string">"question"</span>: <span class="hljs-string">"计算10和20的和"</span>})

<span class="hljs-comment"># 打印解析后结果（Pydantic实例对象）</span>
<span class="hljs-built_in">print</span>(response)
</code></pre>
<h3 data-id="heading-9">3. JsonOutputParser（JSON格式解析器）</h3>
<h4 data-id="heading-10">核心作用</h4>
<p>将大模型输出解析为标准 JSON 格式，使用方式与 <code>PydanticOutputParser</code> 类似，核心区别在于解析后的输出格式为 JSON 字符串/对象。</p>
<h4 data-id="heading-11">关键方法</h4>
<p><code>get_format_instructions()</code>：获取 JSON 格式的标准化指令，返回字符串类型，用于引导大模型输出合规 JSON 内容。</p>
<h5 data-id="heading-12">完整使用示例</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> JsonOutputParser
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field

<span class="hljs-comment"># 定义Pydantic数据模型（约束JSON字段）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SumArgs</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    num1: <span class="hljs-built_in">int</span> = Field(description=<span class="hljs-string">"第一个数"</span>)
    num2: <span class="hljs-built_in">int</span> = Field(description=<span class="hljs-string">"第二个数"</span>)
    <span class="hljs-built_in">sum</span>: <span class="hljs-built_in">int</span> = Field(description=<span class="hljs-string">"两个数的和"</span>)

<span class="hljs-comment"># 初始化JSON输出解析器</span>
json_output_parser = JsonOutputParser(pydantic_object=SumArgs)

<span class="hljs-comment"># 定义提示模板</span>
prompt_template = PromptTemplate.from_template(
    <span class="hljs-string">"""
    你是一个专业的数学助手
    问题内容：{question}
    输出格式：{format_instructions}
    """</span>
)

<span class="hljs-comment"># 预填充格式化指令</span>
prompt_template = prompt_template.partial(
    format_instructions=json_output_parser.get_format_instructions()
)

<span class="hljs-comment"># 构建链式调用</span>
chain = prompt_template | llm | json_output_parser

<span class="hljs-comment"># 执行调用</span>
response = chain.invoke(<span class="hljs-built_in">input</span>={<span class="hljs-string">"question"</span>: <span class="hljs-string">"计算10和20的和"</span>})

<span class="hljs-comment"># 打印解析后结果</span>
<span class="hljs-built_in">print</span>(response)
</code></pre>
<h2 data-id="heading-13">核心关键要点</h2>
<ol>
<li>
<p><strong>通用流程</strong>：所有输出解析器的核心使用流程一致：定义提示模板 → 初始化解析器 → 预填充格式化指令 → 构建链式调用 → 执行并解析结果；</p>
</li>
<li>
<p><strong>格式化指令</strong>：<code>get_format_instructions()</code> 是核心方法，用于引导大模型按预期格式输出，缺失会导致解析失败；</p>
</li>
<li>
<p><strong>返回类型差异</strong>：</p>
<ul>
<li><code>StrOutputParser</code>：返回纯字符串；</li>
<li><code>PydanticOutputParser</code>：返回 Pydantic 实例对象；</li>
<li><code>JsonOutputParser</code>：返回标准 JSON 格式；</li>
</ul>
</li>
<li>
<p><strong>错误处理</strong>：若大模型输出不符合解析器要求，会直接抛出解析错误，需优化提示模板或模型参数。</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Agent 记忆系统技术深度：从上下文工程到长期记忆组件集成！]]></title>    <link>https://juejin.cn/post/7589126217249833001</link>    <guid>https://juejin.cn/post/7589126217249833001</guid>    <pubDate>2025-12-29T09:21:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589126217249833001" data-draft-id="7589126217249456169" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Agent 记忆系统技术深度：从上下文工程到长期记忆组件集成！"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2025-12-29T09:21:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Agent 记忆系统技术深度：从上下文工程到长期记忆组件集成！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T09:21:07.000Z" title="Mon Dec 29 2025 09:21:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：柳遵飞（翼严）</p>
<h2 data-id="heading-0">前言</h2>
<p>随着 AI Agent 应用的快速发展，智能体需要处理越来越复杂的任务和更长的对话历史。然而，LLM 的上下文窗口限制、不断增长的 token 成本，以及如何让 AI“记住”用户偏好和历史交互，都成为了构建实用 AI Agent 系统面临的核心挑战。记忆系统（Memory System）正是为了解决这些问题而诞生的关键技术。</p>
<p>记忆系统使 AI Agent 能够像人类一样，在单次对话中保持上下文连贯性（短期记忆），同时能够跨会话记住用户偏好、历史交互和领域知识（长期记忆）。这不仅提升了用户体验的连续性和个性化程度，也为构建更智能、更实用的 AI 应用奠定了基础。</p>
<h2 data-id="heading-1">Memory 基础概念</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9b9252177814144b867871c1e45a423~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767604866&amp;x-signature=VyLjca2%2BXFFttr7KpUIXWbggdWY%3D" alt="image_1766567507046.png" loading="lazy"/></p>
<h3 data-id="heading-2">1.1 记忆的定义与分类</h3>
<p>对于 AI Agent 而言，记忆至关重要，因为它使它们能够记住之前的互动、从反馈中学习，并适应用户的偏好。</p>
<p>对“记忆”的定义有两个层面：</p>
<ul>
<li><strong>会话级记忆：</strong> 用户和智能体 Agent 在一个会话中的多轮交互（user-query &amp; response）</li>
<li><strong>跨会话记忆：</strong> 从用户和智能体 Agent 的多个会话中抽取的通用信息，可以跨会话辅助 Agent 推理</li>
</ul>
<h3 data-id="heading-3">1.2 各 Agent 框架的定义差异</h3>
<p>各个 Agent 框架对记忆的概念命名各有不同，但共同的是都遵循上一节中介绍的两个不同层面的划分：会话级和跨会话级。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3844bf82fd444909f707b0419ef8ccb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767604866&amp;x-signature=DMqCHXEloIQ%2B%2BsnVmq8nBCNcq1U%3D" alt="图片" loading="lazy"/></p>
<p><strong>框架说明：</strong></p>
<ul>
<li><strong>Google ADK：</strong> Session 表示单次持续交互；Memory 是长期知识库，可包含来自多次对话的信息</li>
<li><strong>LangChain：</strong> Short-term memory 用于单线程或对话中记住之前的交互；Long-term memory 不属于基础核心组件，而是高阶的“个人知识库”外挂</li>
<li><strong>AgentScope：</strong> 虽然官方文档强调需求驱动，但 API 层面仍然是两个组件（memory 和 long_term_memory），功能层面有明确区分</li>
</ul>
<p>习惯上，可以将会话级别的历史消息称为<strong>短期记忆</strong>，把可以跨会话共享的信息称为<strong>长期记忆</strong>，但本质上两者并不是通过简单的时间维度进行的划分，从实践层面上以是否跨 Session 会话来进行区分。长期记忆的信息从短期记忆中抽取提炼而来，根据短期记忆中的信息实时地更新迭代，而其信息又会参与到短期记忆中辅助模型进行个性化推理。</p>
<h2 data-id="heading-4">Agent 框架集成记忆系统的架构</h2>
<p>各 Agent 框架在集成记忆系统时，虽然实现细节不同，但都遵循相似的架构模式。理解这些通用模式有助于更好地设计和实现记忆系统。</p>
<h3 data-id="heading-5">2.1 Agent 框架集成记忆的通用模式</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/447f848e7d644d85bb307fa067e2e2e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767604866&amp;x-signature=QW5%2B2TuZBEVHmAvVTr6h7wKAgPs%3D" alt="image_1766569316557.png" loading="lazy"/></p>
<p>各 Agent 框架集成记忆系统通常遵循以下通用模式：</p>
<p><strong>1. Step1：推理前加载</strong> - 根据当前 user-query 从长期记忆中加载相关信息</p>
<p><strong>2. Step2：上下文注入</strong> - 从长期记忆中检索的信息加入当前短期记忆中辅助模型推理</p>
<p><strong>3. Step3：记忆更新</strong> - 短期记忆在推理完成后加入到长期记忆中</p>
<p><strong>4. Step4：信息处理</strong> - 长期记忆模块中结合 LLM+向量化模型进行信息提取和检索</p>
<h3 data-id="heading-6">2.2 短期记忆（Session 会话）</h3>
<p>短期记忆存储会话中产生的各类消息，包括用户输入、模型回复、工具调用及其结果等。这些消息直接参与模型推理，实时更新，并受模型的 maxToken 限制。当消息累积导致上下文窗口超出限制时，需要通过上下文工程策略（压缩、卸载、摘要等）进行处理，这也是上下文工程主要处理的部分。</p>
<p><strong>核心特点：</strong></p>
<ul>
<li>存储会话中的所有交互消息（用户输入、模型回复、工具调用等）</li>
<li>直接参与模型推理，作为 LLM 的输入上下文</li>
<li>实时更新，每次交互都会新增消息</li>
<li>受模型 maxToken 限制，需要上下文工程策略进行优化</li>
</ul>
<p>关于短期记忆的上下文工程策略（压缩、卸载、摘要等），将在下一章节中详细介绍。</p>
<h3 data-id="heading-7">2.3 长期记忆（跨会话）</h3>
<p>长期记忆与短期记忆形成双向交互：一方面，长期记忆从短期记忆中提取“事实”、“偏好”、“经验”等有效信息进行存储（Record）；另一方面，长期记忆中的信息会被检索并注入到短期记忆中，辅助模型进行个性化推理（Retrieve）。</p>
<p><strong>与短期记忆的交互：</strong></p>
<ul>
<li><strong>Record（写入）：</strong> 从短期记忆的会话消息中提取有效信息，通过LLM进行语义理解和抽取，存储到长期记忆中</li>
<li><strong>Retrieve（检索）：</strong> 根据当前用户查询，从长期记忆中检索相关信息，注入到短期记忆中作为上下文，辅助模型推理</li>
</ul>
<p><strong>实践中的实现方式：</strong></p>
<p>在 Agent 开发实践中，长期记忆通常是一个独立的第三方组件，因为其内部有相对比较复杂的流程（信息提取、向量化、存储、检索等）。常见的长期记忆组件包括 Mem0、Zep、Memos、ReMe 等，这些组件提供了完整的 Record 和 Retrieve 能力，Agent 框架通过 API 集成这些组件。</p>
<p><strong>信息组织维度：</strong></p>
<p>不同长期记忆产品在信息组织维度上有所差异：一些产品主要关注个人信息（个人记忆），而一些产品除了支持个人记忆外，还支持工具记忆、任务记忆等更丰富的维度。</p>
<ol>
<li>
<p><strong>用户维度（个人记忆）：</strong> 面向用户维度组织的实时更新的个人知识库</p>
<ul>
<li>用户画像分析报告</li>
<li>个性化推荐系统，千人千面</li>
<li>处理具体任务时加载至短期记忆中</li>
</ul>
</li>
<li>
<p><strong>业务领域维度：</strong> 沉淀的经验（包括领域经验和工具使用经验）</p>
<ul>
<li>可沉淀至领域知识库</li>
<li>可通过强化学习微调沉淀至模型</li>
</ul>
</li>
</ol>
<h2 data-id="heading-8">短期记忆的上下文工程策略</h2>
<p>短期记忆直接参与 Agent 和 LLM 的交互，随着对话历史增长，上下文窗口会面临 token 限制和成本压力。上下文工程策略旨在通过智能化的压缩、卸载和摘要技术，在保持信息完整性的同时，有效控制上下文大小。</p>
<p><strong>备注：</strong> 需要说明的是，各方对上下文工程的概念和理解存在些许差异。<strong>狭义的上下文工程</strong>特指对短期记忆（会话历史）中各种压缩、摘要、卸载等处理机制，主要解决上下文窗口限制和 token 成本问题；<strong>广义的上下文工程</strong>则包括更广泛的上下文优化策略，如非运行态的模型选择、Prompt 优化工程、知识库构建、工具集构建等，这些都是在模型推理前对上下文进行优化的手段，且这些因素都对模型推理结果有重要影响。本章节主要讨论狭义的上下文工程，即针对短期记忆的运行时处理策略。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24e5d661c30a4aa1b54d4994cab1befd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767604866&amp;x-signature=LQl99B9L13t11r8RU5SIs1hQn3c%3D" alt="image_1766570688185.png" loading="lazy"/></p>
<h3 data-id="heading-9">3.1 核心策略</h3>
<p>针对短期记忆的上下文处理，主要有以下几种策略：</p>
<h4 data-id="heading-10">上下文缩减（Context Reduction）</h4>
<p>上下文缩减通过减少上下文中的信息量来降低 token 消耗，主要有两种方法：</p>
<p><strong>1. 保留预览内容：</strong> 对于大块内容，只保留前 N 个字符或关键片段作为预览，原始完整内容被移除</p>
<p><strong>2. 总结摘要：</strong> 使用 LLM 对整段内容进行总结摘要，保留关键信息，丢弃细节</p>
<p>这两种方法都会导致信息丢失，但能有效减少 token 消耗。</p>
<h4 data-id="heading-11">上下文卸载（Context Offloading）</h4>
<p>上下文卸载主要解决被缩减的内容是否可恢复的问题。当内容被缩减后，原始完整内容被卸载到外部存储（如文件系统、数据库等），消息中只保留最小必要的引用（如文件路径、UUID 等）。当需要完整内容时，可以通过引用重新加载。</p>
<p><strong>优势</strong>：上下文更干净，占用更小，信息不丢，随取随用。适用于网页搜索结果、超长工具输出、临时计划等占 token 较多的内容。</p>
<h4 data-id="heading-12">上下文隔离（Context Isolation）</h4>
<p>通过多智能体架构，将上下文拆分到不同的子智能体中（类似单体拆分称多个微服务）。主智能体编写任务指令，发送给子智能体，子智能体的整个上下文仅由该指令组成。子智能体完成任务后返回结果，主智能体不关心子智能体如何执行，只需要结果。</p>
<p><strong>适用场景</strong>：任务有清晰简短的指令，只有最终输出才重要，如代码库中搜索特定片段。</p>
<p><strong>优势</strong>：上下文小、开销低、简单直接。</p>
<p><strong>策略选择原则：</strong></p>
<p>以上三种策略（上下文缩减、上下文卸载、上下文隔离）需要根据数据的分类进行综合处理，主要考虑因素包括：</p>
<ul>
<li><strong>时间远近：</strong> 近期消息通常更重要，需要优先保留；历史消息可以优先进行缩减或卸载</li>
<li><strong>数据类型：</strong> 不同类型的消息（用户输入、模型回复、工具调用结果等）重要性不同，需要采用不同的处理策略</li>
<li><strong>信息可恢复性：</strong> 对于需要完整信息的内容，应优先使用卸载策略；对于可以接受信息丢失的内容，可以使用缩减策略</li>
</ul>
<h3 data-id="heading-13">3.2 各框架的实现方式</h3>
<p>各框架一般内置上下文处理策略，通过参数化配置的方式指定具体策略。</p>
<p><strong>Google ADK</strong></p>
<p>构建 Agent 时通过 <code>events_compaction_config</code> 设置上下文处理策略，和 Session 本身的数据存储独立。</p>
<pre><code class="hljs language-ini" lang="ini">from google.adk.apps.app import App, EventsCompactionConfig
<span class="hljs-attr">app</span> = App(
    <span class="hljs-attr">name</span>=<span class="hljs-string">'my-agent'</span>,
    <span class="hljs-attr">root_agent</span>=root_agent,
    <span class="hljs-attr">events_compaction_config</span>=EventsCompactionConfig(
        <span class="hljs-attr">compaction_interval</span>=<span class="hljs-number">3</span>,  <span class="hljs-comment"># 每3次新调用触发压缩</span>
        <span class="hljs-attr">overlap_size</span>=<span class="hljs-number">1</span>          <span class="hljs-comment"># 包含前一个窗口的最后一次调用</span>
    ),
)
</code></pre>
<p><strong>LangChain</strong></p>
<p>构建 Agent 时通过 middleware 机制中的 <code>SummarizationMiddleware</code> 设置上下文处理参数，与短期记忆本身的数据存储独立。</p>
<pre><code class="hljs language-ini" lang="ini">from langchain.agents import create_agent
from langchain.agents.middleware import SummarizationMiddleware
<span class="hljs-attr">agent</span> = create_agent(
    <span class="hljs-attr">model</span>=<span class="hljs-string">"gpt-4o"</span>,
    <span class="hljs-attr">tools</span>=[...],
    <span class="hljs-attr">middleware</span>=[
        SummarizationMiddleware(
            model=<span class="hljs-string">"gpt-4o-mini"</span>,
            max_tokens_before_summary=<span class="hljs-number">4000</span>,  <span class="hljs-comment"># 4000 tokens时触发摘要</span>
            messages_to_keep=<span class="hljs-number">20</span>,  <span class="hljs-comment"># 摘要后保留最后20条消息</span>
        ),
    ],
)
</code></pre>
<p><strong>AgentScope</strong></p>
<p>AgentScope 通过 <strong>AutoContextMemory</strong> 提供智能化的上下文工程解决方案。AutoContextMemory 实现了 <code>Memory</code> 接口，当对话历史超过配置阈值时，自动应用 6 种渐进式压缩策略（从轻量级到重量级）来减少上下文大小，同时保留重要信息。</p>
<p><strong>集成方式：</strong></p>
<ul>
<li>直接作为 <code>Memory</code> 接口实现，通过 <code>memory</code> 参数集成到 Agent 中</li>
<li>与框架深度集成，无需额外的 middleware 或独立配置</li>
</ul>
<p><strong>与 ADK 和 LangChain 的差异：</strong></p>
<ul>
<li><strong>更精细化的压缩策略：</strong> 提供 6 种渐进式压缩策略（压缩历史工具调用、卸载大型消息、摘要对话轮次等），相比 ADK 的简单压缩和 LangChain 的摘要 middleware，策略更加细化和可控</li>
<li><strong>集成方式：</strong> 直接实现 Memory 接口，与 Agent 构建流程无缝集成，而 ADK 和 LangChain 需要独立的配置对象或 middleware 机制</li>
<li><strong>完整可追溯性：</strong> 提供工作内存、原始内存、卸载上下文和压缩事件四层存储架构，支持完整历史追溯，而其他框架通常只提供压缩后的结果</li>
</ul>
<p><strong>使用示例：</strong></p>
<pre><code class="hljs language-scss" lang="scss">AutoContextMemory memory = new <span class="hljs-built_in">AutoContextMemory</span>(
    AutoContextConfig.builder()
        <span class="hljs-selector-class">.msgThreshold</span>(<span class="hljs-number">100</span>)
        <span class="hljs-selector-class">.maxToken</span>(<span class="hljs-number">128</span> * <span class="hljs-number">1024</span>)
        <span class="hljs-selector-class">.tokenRatio</span>(<span class="hljs-number">0.75</span>)
        <span class="hljs-selector-class">.build</span>(),
    model
);
ReActAgent agent = ReActAgent<span class="hljs-selector-class">.builder</span>()
    <span class="hljs-selector-class">.name</span>("Assistant")
    <span class="hljs-selector-class">.model</span>(model)
    <span class="hljs-selector-class">.memory</span>(memory)
    <span class="hljs-selector-class">.build</span>();
</code></pre>
<p><strong>详细文档：</strong> 关于 AutoContextMemory 的 6 种压缩策略、存储架构和高级配置，请参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzIzOTU0NTQ0MA%3D%3D%26mid%3D2247556750%26idx%3D1%26sn%3D65b82a8da8595494dd6e1adbe605e649%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzIzOTU0NTQ0MA==&amp;mid=2247556750&amp;idx=1&amp;sn=65b82a8da8595494dd6e1adbe605e649&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">AutoContextMemory 详细文档</a>。</p>
<h2 data-id="heading-14">长期记忆技术架构及 Agent 框架集成</h2>
<p>与短期记忆不同，长期记忆需要跨会话持久化存储，并支持高效的检索和更新。这需要一套完整的技术架构，包括信息提取、向量化存储、语义检索等核心组件。</p>
<h3 data-id="heading-15">4.1 核心组件</h3>
<p>长期记忆涉及 record &amp; retrieve 两个核心流程，需要以下核心组件：</p>
<p><strong>1. LLM 大模型：</strong> 提取短期记忆中的有效信息（记忆的语义理解、抽取、决策和生成）</p>
<p><strong>2. Embedder 向量化：</strong> 将文本转换为语义向量，支持相似性计算</p>
<p><strong>3. VectorStore 向量数据库：</strong> 持久化存储记忆向量和元数据，支持高效语义检索</p>
<p><strong>4. GraphStore 图数据库：</strong> 存储实体-关系知识图谱，支持复杂关系推理</p>
<p><strong>5. Reranker（重排序器）：</strong> 对初步检索结果按语义相关性重新排序</p>
<p><strong>6. SQLite：</strong> 记录所有记忆操作的审计日志，支持版本回溯</p>
<h3 data-id="heading-16">4.2 Record &amp; Retrieve 流程</h3>
<p>Record（记录）</p>
<pre><code class="hljs">LLM 事实提取 → 信息向量化 → 向量存储 →（复杂关系存储）→ SQLite 操作日志
</code></pre>
<p>Retrieve（检索）</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">User</span> query 向量化 → 向量数据库语义检索 → 图数据库关系补充 →（Reranker<span class="hljs-operator">-</span>LLM）→ 结果返回
</code></pre>
<h3 data-id="heading-17">4.3 长期记忆与 RAG 的区别</h3>
<p>像 Mem0 这类面向 AI Agent 的个性化长期记忆系统，与 RAG（Retrieval-Augmented Generation）在技术架构上有诸多相似之处，但功能层面和场景上有明显区别：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50c50041f1bf4d5f9072d7d0aaf36d30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767604866&amp;x-signature=D9%2BuaCSddMuXVnZQsT4PO0DVcUY%3D" alt="图片" loading="lazy"/></p>
<p><strong>技术层面的相似点：</strong></p>
<ol>
<li>
<p>向量化存储：都将文本内容通过 Embedding 模型转为向量，存入向量数据库</p>
</li>
<li>
<p>相似性检索：在用户提问时，将当前 query 向量化，在向量库中检索 top-k 最相关的条目</p>
</li>
<li>
<p>注入上下文生成：将检索到的内容注入到模型交互上下文中，辅助 LLM 生成最终回答</p>
</li>
</ol>
<h3 data-id="heading-18">4.4 关键问题与挑战</h3>
<p>长期记忆系统在实际应用中面临诸多挑战，这些挑战直接影响系统的可用性和用户体验。</p>
<p><strong>1. 准确性</strong></p>
<p>记忆的准确性包含两个层面：</p>
<ul>
<li>有效的记忆管理：需要具备智能的巩固、更新和遗忘机制，这主要依赖于记忆系统中负责信息提取的模型能力和算法设计</li>
<li>记忆相关性的检索准确度：主要依赖于向量化检索&amp;重排的核心能力</li>
</ul>
<p><strong>核心挑战：</strong></p>
<ul>
<li>记忆的建模：需要完善强大的用户画像模型</li>
<li>记忆的管理：基于用户画像建模算法，提取有效信息，设计记忆更新机制</li>
<li>向量化相关性检索能力：提升检索准确率和相关性</li>
</ul>
<p><strong>2. 安全和隐私</strong></p>
<p>记忆系统记住了大量用户隐私信息，如何防止数据中毒等恶意攻击，并保障用户隐私，是必须解决的问题。</p>
<p><strong>核心挑战：</strong></p>
<ul>
<li>数据加密与访问控制</li>
<li>防止恶意数据注入</li>
<li>透明的数据管理机制</li>
<li>用户对自身数据的掌控权</li>
</ul>
<p><strong>3. 多模态记忆支持</strong></p>
<p>文本记忆、视觉、语音仍被孤立处理，如何构建统一的“多模态记忆空间”仍是未解难题。</p>
<p><strong>核心挑战：</strong></p>
<ul>
<li>跨模态关联与检索</li>
<li>统一的多模态记忆表示</li>
<li>毫秒级响应能力</li>
</ul>
<h3 data-id="heading-19">4.5 Agent 框架集成</h3>
<p>在 AgentScope 中，可以通过集成第三方长期记忆组件来实现长期记忆功能。常见的集成方式包括：</p>
<h4 data-id="heading-20">4.5.1 集成 Mem0</h4>
<p>Mem0 是一个开源的长期记忆框架，几乎成为事实标准。在 AgentScope 中集成 Mem0 的示例：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 初始化Mem0长期记忆</span>
Mem0LongTermMemory mem0Memory = new <span class="hljs-built_in">Mem0LongTermMemory</span>(
    Mem0Config.builder()
        <span class="hljs-selector-class">.apiKey</span>("your-mem0-api-key")
        <span class="hljs-selector-class">.build</span>()
);
<span class="hljs-comment">// 创建Agent并集成长期记忆</span>
ReActAgent agent = ReActAgent<span class="hljs-selector-class">.builder</span>()
    <span class="hljs-selector-class">.name</span>("Assistant")
    <span class="hljs-selector-class">.model</span>(model)
    <span class="hljs-selector-class">.memory</span>(memory)  <span class="hljs-comment">// 短期记忆</span>
    <span class="hljs-selector-class">.longTermMemory</span>(mem0Memory)  <span class="hljs-comment">// 长期记忆</span>
    <span class="hljs-selector-class">.build</span>();
</code></pre>
<h4 data-id="heading-21">4.5.2 集成 ReMe</h4>
<p>ReMe 是 AgentScope 官方提供的长期记忆实现，与框架深度集成：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 初始化ReMe长期记忆</span>
ReMeLongTermMemory remeMemory = ReMeLongTermMemory<span class="hljs-selector-class">.builder</span>()
    <span class="hljs-selector-class">.userId</span>("user123")  <span class="hljs-comment">// 用户ID，用于记忆隔离</span>
    <span class="hljs-selector-class">.apiBaseUrl</span>("http://localhost:<span class="hljs-number">8002</span>")  <span class="hljs-comment">// ReMe服务地址</span>
    <span class="hljs-selector-class">.build</span>();
<span class="hljs-comment">// 创建Agent并集成长期记忆</span>
ReActAgent agent = ReActAgent<span class="hljs-selector-class">.builder</span>()
    <span class="hljs-selector-class">.name</span>("Assistant")
    <span class="hljs-selector-class">.model</span>(model)
    <span class="hljs-selector-class">.memory</span>(memory)  <span class="hljs-comment">// 短期记忆</span>
    <span class="hljs-selector-class">.longTermMemory</span>(remeMemory)  <span class="hljs-comment">// 长期记忆</span>
    <span class="hljs-selector-class">.longTermMemoryMode</span>(LongTermMemoryMode.BOTH)  <span class="hljs-comment">// 记忆模式</span>
    <span class="hljs-selector-class">.build</span>();
</code></pre>
<h2 data-id="heading-22">行业趋势与产品对比</h2>
<h3 data-id="heading-23">5.1 AI 记忆系统发展趋势</h3>
<p>AI 记忆系统的核心目标是让 AI 能像人类一样持续学习、形成长期记忆，从而变得更智能、更个性化。当前行业呈现出从研究原型向生产级系统演进、从单一技术向综合解决方案发展的趋势。</p>
<h4 data-id="heading-24">5.1.1 当前发展的核心脉络</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05da7e83795847dd9b366cc99f23ba03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767604866&amp;x-signature=w0VavWRlmzW6QzoQnOGwzLTYwh8%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-25">5.1.2 技术发展趋势</h4>
<p><strong>记忆即服务（Memory-as-a-Service, MaaS）</strong></p>
<p>AI Agent 是大模型、记忆、任务规划以及工具使用的集合体，记忆管理将是 Agent 智能体的核心基础功能之一。类似“数据库”之于传统软件，记忆系统将成为 AI 应用的基础设施，提供标准化的记忆服务接口、可扩展的存储和检索能力。</p>
<p><strong>精细化记忆管理</strong></p>
<p>借鉴人脑记忆机制，构建分层动态的记忆架构，对记忆进行全生命周期管理。技术路径包括：LLM 驱动记忆提取 + 向量化存储 + 图数据库补充；向量化检索（海马体）+ LLM 提纯（大脑皮层）结合；通过强化学习提升记忆管理表现。</p>
<p><strong>多模态记忆系统</strong></p>
<p>多模态大模型的兴起推动记忆系统向多模态、跨模态方向发展，要求存储具备跨模态关联与毫秒级响应能力。</p>
<p><strong>参数化记忆（Model 层集成记忆）</strong></p>
<p>在 Transformer 架构中引入可学习的记忆单元 Memory Adapter，实现模型层面原生支持用户维度的记忆。优点是响应速度快，但面临“灾难性遗忘”和更新成本高的挑战。</p>
<h4 data-id="heading-26">5.1.3 当前主要的技术路径</h4>
<p><strong>1. 外部记忆增强（当前主流）：</strong> 使用向量数据库等外部存储来记忆历史信息，并在需要时通过检索相关信息注入当前对话。这种方式灵活高效，检索的准确性是关键。</p>
<p><strong>2. 参数化记忆（深度内化）：</strong> 直接将知识编码进模型的参数中。这可以通过模型微调、知识编辑等技术实现，优点是响应速度快，但面临“灾难性遗忘”和更新成本高的挑战。</p>
<h3 data-id="heading-27">5.2 相关开源产品对比</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3b42e7e65944c2aa15be84b24f1e9aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767604866&amp;x-signature=Hq1NtS1kIYSzQ0IvlvZXb8yAWyI%3D" alt="图片" loading="lazy"/></p>
<p>关于各产品的具体数据指标对比，评测方式各有侧重，因此评测结果不尽相同，从实际情况看，各方均以 mem0 为评测基准，从各类技术指标评测结果以及开源社区的活跃度（star，issues 等）方面，mem0 仍然是占据长期记忆产品的领头地位。</p>
<h2 data-id="heading-28">结语</h2>
<p>记忆系统作为 AI Agent 的核心基础设施，其发展直接影响着智能体的能力和用户体验。现在各框架内置的压缩、卸载、摘要等策略，已经能解决 80-90% 的通用场景问题，但对于特定行业或场景，比如医疗、法律、金融等领域，基于通用的上下文处理策略基础之上进行针对性的处理和更精细的压缩 prompt 设计，仍然有较大的优化空间。而长期记忆作为可独立演进的组件，未来会更加贴近人脑的记忆演化模式，包括记忆的巩固、强化、遗忘等全生命周期管理，同时长期记忆应该以云服务模式提供通用的记忆服务，共同助力 Agent 迈向更高阶的智能。</p>
<p><strong>相关阅读：</strong></p>
<p>《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580979%26idx%3D1%26sn%3Db55ba91471d7bda26b70d7ef32b9144a%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580979&amp;idx=1&amp;sn=b55ba91471d7bda26b70d7ef32b9144a&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">AgentScope Java 答疑时间：开发者近期最关心的 12 个问题</a>》</p>
<p>《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580755%26idx%3D1%26sn%3D870d3de4e1a8e36796532cd18d8ab6e7%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580755&amp;idx=1&amp;sn=870d3de4e1a8e36796532cd18d8ab6e7&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">AgentScope x RocketMQ：打造企业级高可靠 A2A 智能体通信基座</a>》</p>
<p>《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580582%26idx%3D2%26sn%3De3e66277ddaedc5f7caa9cd1ae12cd5d%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580582&amp;idx=2&amp;sn=e3e66277ddaedc5f7caa9cd1ae12cd5d&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">AgentScope Java v1.0 发布，让 Java 开发者轻松构建企业级 Agentic 应用</a>》</p>
<p><strong>参考文档：</strong></p>
<p>[1] FlowLLM Context Engineering</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FFlowLLM-AI%2Fflowllm%2Ftree%2Fmain%2Fdocs%2Fzh%2Freading" target="_blank" title="https://github.com/FlowLLM-AI/flowllm/tree/main/docs/zh/reading" ref="nofollow noopener noreferrer">github.com/FlowLLM-AI/…</a></p>
<p>[2] Google ADK Memory</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgoogle.github.io%2Fadk-docs%2Fsessions%2Fmemory%2F" target="_blank" title="https://google.github.io/adk-docs/sessions/memory/" ref="nofollow noopener noreferrer">google.github.io/adk-docs/se…</a></p>
<p>[3] LangChain Memory</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Flong-term-memory" target="_blank" title="https://docs.langchain.com/oss/python/langchain/long-term-memory" ref="nofollow noopener noreferrer">docs.langchain.com/oss/python/…</a></p>
<p>[4] AgentScope Memory</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.agentscope.io%2Fzh_CN%2Ftutorial%2Ftask_memory.html" target="_blank" title="https://doc.agentscope.io/zh_CN/tutorial/task_memory.html" ref="nofollow noopener noreferrer">doc.agentscope.io/zh_CN/tutor…</a></p>
<p>[5] O-MEM</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.13593" target="_blank" title="https://arxiv.org/abs/2511.13593" ref="nofollow noopener noreferrer">arxiv.org/abs/2511.13…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Next.js第十八章(静态导出SSG)]]></title>    <link>https://juejin.cn/post/7589052659435470894</link>    <guid>https://juejin.cn/post/7589052659435470894</guid>    <pubDate>2025-12-29T08:58:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589052659435470894" data-draft-id="7589093895326171145" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Next.js第十八章(静态导出SSG)"/> <meta itemprop="keywords" content="前端,Next.js"/> <meta itemprop="datePublished" content="2025-12-29T08:58:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小满zs"/> <meta itemprop="url" content="https://juejin.cn/user/2463384809252397"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Next.js第十八章(静态导出SSG)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2463384809252397/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小满zs
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T08:58:36.000Z" title="Mon Dec 29 2025 08:58:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">静态导出SSG</h2>
<p>Next.js 支持静态站点生成（SSG，Static Site Generation），可以在构建时预先生成所有页面的静态 HTML 文件。这种方式特别适合内容相对固定的站点，如<strong>官网</strong>、<strong>博客</strong>、<strong>文档</strong>等，能够提供最佳的性能和 SEO 表现。</p>
<h4 data-id="heading-1">配置静态导出</h4>
<p>需要在<code>next.config.js</code>文件中配置<code>output</code>为<code>export</code>，表示导出静态站点。<code>distDir</code>表示导出目录，默认为<code>out</code>。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">NextConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next"</span>;
<span class="hljs-keyword">const</span> <span class="hljs-attr">nextConfig</span>: <span class="hljs-title class_">NextConfig</span> = {
  <span class="hljs-comment">/* config options here */</span>
  <span class="hljs-attr">output</span>: <span class="hljs-string">"export"</span>, <span class="hljs-comment">// 导出静态站点</span>
  <span class="hljs-attr">distDir</span>: <span class="hljs-string">"dist"</span>, <span class="hljs-comment">// 导出目录</span>
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> nextConfig;
</code></pre>
<p>接着我们执行<code>npm run build</code>命令，构建静态站点。</p>
<p>构建完成之后，我们安装<code>http-server</code>来启动静态站点。</p>
<pre><code class="hljs language-bash" lang="bash">npm install http-server -g <span class="hljs-comment">#安装http-server</span>
<span class="hljs-built_in">cd</span> dist <span class="hljs-comment">#进入导出目录</span>
http-server -p 3000 <span class="hljs-comment">#启动静态站点</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b703b5726b84a37881b7c4754200f00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767603516&amp;x-signature=D%2Bd4FxfMN12Y%2Fl%2FxoEC3hMRbPtE%3D" alt="11.gif" loading="lazy"/></p>
<p>启动完成之后发现点击<code>a</code>标签无法进行跳转，是因为打完包之后的页面叫<code>about.html</code>,而我们的跳转链接是<code>/about</code>，所以需要修改配置项。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8950c8f911f4dca8674bc8137f17885~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767603516&amp;x-signature=HqCk7GEmWCJBnna0gyZfIipRMnU%3D" alt="build.png" loading="lazy"/></p>
<h4 data-id="heading-2">修改配置项</h4>
<p>需要在<code>next.config.js</code>文件中配置<code>trailingSlash</code>为<code>true</code>，表示添加尾部斜杠，生成<code>/about/index.html</code>而不是<code>/about.html</code>。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">NextConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-attr">nextConfig</span>: <span class="hljs-title class_">NextConfig</span> = {
  <span class="hljs-comment">/* config options here */</span>
  <span class="hljs-attr">output</span>: <span class="hljs-string">"export"</span>, <span class="hljs-comment">// 导出静态站点</span>
  <span class="hljs-attr">distDir</span>: <span class="hljs-string">"dist"</span>, <span class="hljs-comment">// 导出目录</span>
  <span class="hljs-attr">trailingSlash</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 添加尾部斜杠，生成 /about/index.html 而不是 /about.html</span>
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> nextConfig;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/289cb3708804421b919d81bdee068f24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767603516&amp;x-signature=ypCUPWf8v4tp5SHLmX%2FdjIep16E%3D" alt="trailingSlash.png" loading="lazy"/></p>
<p>此时重新点击<code>a</code>标签就可以进行跳转了。</p>
<h4 data-id="heading-3">动态路由处理</h4>
<p>新建目录: <code>src/app/posts/[id]/page.tsx</code></p>
<p>如果要使用动态路由，则需要使用<code>generateStaticParams</code>函数来生成有多少个动态路由，这个函数需要返回一个数组，数组中包含所有动态路由的参数，例如<code>{ id: '1' }</code>表示对应id为1的详情页。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">generateStaticParams</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">//支持调用接口请求详情id列表 const res = await fetch('https://api.example.com/posts')</span>
    <span class="hljs-keyword">return</span> [
        { <span class="hljs-attr">id</span>: <span class="hljs-string">'1'</span> }, <span class="hljs-comment">//返回对应的详情id</span>
        { <span class="hljs-attr">id</span>: <span class="hljs-string">'2'</span> },
    ]
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Post</span>(<span class="hljs-params">{ params }: { params: <span class="hljs-built_in">Promise</span>&lt;{ id: <span class="hljs-built_in">string</span> }&gt; }</span>) {
    <span class="hljs-keyword">const</span> { id } = <span class="hljs-keyword">await</span> params
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Post {id}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<h4 data-id="heading-4">图片优化</h4>
<p>如果使用<code>Image</code>组件优化图片，在开发模式会进行报错</p>
<div class="custom-block warning">
  <div class="custom-block-title">⚠️ 警告</div>
  <p>
    <code>get-img-props.ts 442 Uncaught Error</code>: Image Optimization using the default loader is not compatible with <code>{ output: 'export' }</code>.
  </p>
  <p>可能的解决方案：</p>
  <ul>
    <li>移除 <code>{ output: 'export' }</code> 并运行 "next start" 以启用包含图片优化 API 的服务器模式。</li>
    <li>在 <code>next.config.js</code> 中配置 <code>{ images: { unoptimized: true } }</code> 来禁用图片优化 API。</li>
    <li>使用自定义loader实现</li>
  </ul>
  <p>了解更多：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnextjs.org%2Fdocs%2Fmessages%2Fexport-image-api" target="_blank" title="https://nextjs.org/docs/messages/export-image-api" ref="nofollow noopener noreferrer">nextjs.org/docs/messag…</a></p>
</div>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/image"</span>
<span class="hljs-keyword">import</span> test <span class="hljs-keyword">from</span> <span class="hljs-string">'@/public/1.png'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">About</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Image</span>  <span class="hljs-attr">loading</span>=<span class="hljs-string">"eager"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{test}</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"logo"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">{250</span> * <span class="hljs-attr">3</span>} <span class="hljs-attr">height</span>=<span class="hljs-string">{131</span> * <span class="hljs-attr">3</span>} /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p>我们使用自定义<code>loader</code>来实现图片优化,要求我们通过一个图床托管图片。<a href="https://link.juejin.cn?target=https%3A%2F%2Fimgchr.com%2F" target="_blank" title="https://imgchr.com/" ref="nofollow noopener noreferrer">路过图床</a> 是一个免费的图床，我们可以使用它来托管图片。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b5602ac674646ee8203caae01041319~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767603516&amp;x-signature=X%2Fro3qp3jTDaoIWzgHnYuW1TJ%2FM%3D" alt="luguo.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5ce1f7ac5324f959c99e017af382244~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767603516&amp;x-signature=ZKgkNO1TPJR3tqA5I%2FfqtZwOZ9k%3D" alt="url.png" loading="lazy"/></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">NextConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-attr">nextConfig</span>: <span class="hljs-title class_">NextConfig</span> = {
  <span class="hljs-comment">/* config options here */</span>
  <span class="hljs-attr">output</span>: <span class="hljs-string">"export"</span>, <span class="hljs-comment">// 导出静态站点</span>
  <span class="hljs-attr">distDir</span>: <span class="hljs-string">"dist"</span>, <span class="hljs-comment">// 导出目录</span>
  <span class="hljs-attr">trailingSlash</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 添加尾部斜杠，生成 /about/index.html 而不是 /about.html</span>
  <span class="hljs-attr">images</span>: {
    <span class="hljs-attr">loader</span>: <span class="hljs-string">'custom'</span>, <span class="hljs-comment">// 自定义loader</span>
    <span class="hljs-attr">loaderFile</span>: <span class="hljs-string">'./image-loader.ts'</span>, <span class="hljs-comment">// 自定义loader文件</span>
  },
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> nextConfig;
</code></pre>
<p>根目录：<code>/image-loader.ts</code></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">imageLoader</span>(<span class="hljs-params">{ src, width, quality }: { src: <span class="hljs-built_in">string</span>, width: <span class="hljs-built_in">number</span>, quality: <span class="hljs-built_in">number</span> }</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`https://s41.ax1x.com<span class="hljs-subst">${src}</span>`</span>
}
</code></pre>
<p>src/app/about/page.tsx</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/image"</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">About</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Image</span> <span class="hljs-attr">loading</span>=<span class="hljs-string">"eager"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">'/2025/12/29/pZYbW7t.jpg'</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"logo"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">{250</span> * <span class="hljs-attr">3</span>} <span class="hljs-attr">height</span>=<span class="hljs-string">{131</span> * <span class="hljs-attr">3</span>} /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00fdd5d93b1b45d79ef3825c05b5a01d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767603516&amp;x-signature=isQ2iPfESEHqXjmhFJBkMpIRx64%3D" alt="img.png" loading="lazy"/></p>
<h4 data-id="heading-5">注意事项</h4>
<p>以下功能在SSG中不支持，请勿使用：</p>
<ul>
<li>Dynamic Routes with dynamicParams: true</li>
<li>动态路由没有使用generateStaticParams()</li>
<li>路由处理器依赖于Request</li>
<li>Cookies</li>
<li>Rewrites重写</li>
<li>Redirects重定向</li>
<li>Headers头</li>
<li>Proxy代理</li>
<li>Incremental Static Regeneration增量静态再生</li>
<li>Image Optimization with the default loader默认加载器的图像优化</li>
<li>Draft Mode草稿模式</li>
<li>Server Actions服务器操作</li>
<li>Intercepting Routes拦截路由</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Luckysheet 远程搜索下拉 控件开发 : 揭秘二开全流程]]></title>    <link>https://juejin.cn/post/7589126920286289930</link>    <guid>https://juejin.cn/post/7589126920286289930</guid>    <pubDate>2025-12-29T12:47:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589126920286289930" data-draft-id="7589093895327023113" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Luckysheet  远程搜索下拉 控件开发 : 揭秘二开全流程"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-29T12:47:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="朴shu"/> <meta itemprop="url" content="https://juejin.cn/user/3866303125264135"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Luckysheet  远程搜索下拉 控件开发 : 揭秘二开全流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3866303125264135/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    朴shu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T12:47:46.000Z" title="Mon Dec 29 2025 12:47:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>远程搜索下拉控件是非常常见的控件，应用在表单填写场景下，也是非常合适的，本例将带领大家实现以下效果，并真实了解并熟悉 luckysheet 的二开流程。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3fa9e707052b4260aa2b992a2395a52d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py0c2h1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767617266&amp;x-signature=Cjkf12XL8qDoAEnlzDnp11Lkez8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-1">拓展单元格属性</h2>
<p>在官网上，有一个常见问题，既然已知批注是直接加到单元格属性上，那么，我们拓展属性，是不是可以参考批注的实现方案？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22fd9b12c2c6470fb53fbfb6a0b8ffcd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py0c2h1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767617266&amp;x-signature=1YQxfHygfcHNaEUdhyY4ILqUvJE%3D" alt="在这里插入图片描述" loading="lazy"/>
我们设定以下是远程搜索下拉的单元格拓展属性：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 扩展后的单元格对象</span>
<span class="hljs-keyword">const</span> cell = {
    <span class="hljs-attr">v</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 原始值</span>
    <span class="hljs-attr">m</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 显示值</span>
    <span class="hljs-attr">ct</span>: { <span class="hljs-attr">fa</span>: <span class="hljs-string">"General"</span>, <span class="hljs-attr">t</span>: <span class="hljs-string">"s"</span> },
    <span class="hljs-comment">// ... other properties</span>

    <span class="hljs-comment">// 新增远程搜索下拉配置</span>
    <span class="hljs-attr">remoteSelect</span>: {
        <span class="hljs-comment">// 是否启用远程搜索，[必传]</span>
        <span class="hljs-attr">enable</span>: <span class="hljs-built_in">boolean</span>,

        <span class="hljs-comment">// 用户输入时的回调函数，用于获取远程数据</span>
        <span class="hljs-title function_">onInput</span>(value): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt;&gt; {
            <span class="hljs-comment">// 这个函数需要返回一个Promise对象，resolve一个数组，数组的元素为下拉选项对象</span>
        }

        <span class="hljs-comment">// 用户选定某个选项后的回调函数</span>
        <span class="hljs-title function_">onSelect</span>(item): <span class="hljs-built_in">void</span> {
            <span class="hljs-comment">// item 为用户选定的选项对象，值是onInput函数返回的数组中的某个元素</span>
        }

        <span class="hljs-comment">// 是否需要设定当前输入单元格的值 [可选]</span>
        <span class="hljs-title function_">setValue</span>(item): <span class="hljs-built_in">string</span>{
           <span class="hljs-comment">// item 为用户选定的选项对象，需要返回一个字符串，用于设定单元格的值</span>
        },

        <span class="hljs-comment">// 自定义类名  [可选]</span>
        <span class="hljs-attr">popperClass</span>: <span class="hljs-built_in">string</span>,
    },
};
</code></pre>
<h2 data-id="heading-2">何时触发？</h2>
<p>在这个场景中，我们需要<code>在用户输入值时，进行远程数据获取，渲染列表</code>，因此，需要在用户进行编辑时，进行处理：</p>
<ol>
<li>一个方案，是在初始化 inputHTML 时，将相关事件处理：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/755689351f904e30a11d579d9ff5a471~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py0c2h1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767617266&amp;x-signature=%2FKJ62ts%2BnUnkohBygCBG2drzPuQ%3D" alt="在这里插入图片描述" loading="lazy"/></li>
</ol>
<pre><code class="hljs language-js" lang="js"> $(<span class="hljs-string">"body"</span>).<span class="hljs-title function_">append</span>(inputHTML)
 <span class="hljs-comment">// 进行相关事件绑定: [伪代码]</span>
 $input.<span class="hljs-title function_">on</span>(<span class="hljs-string">'input'</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
 	<span class="hljs-comment">// 这里是未知具体单元格信息的，需要通过外部传递</span>
 	<span class="hljs-keyword">const</span> remoteSelectOptions = <span class="hljs-title class_">Store</span>.<span class="hljs-property">flowdata</span>[r][c]
 	<span class="hljs-comment">// 执行后续操作</span>
 })
</code></pre>
<ol start="2">
<li>另一个方案，是用户双击时，唤起输入框后，进行判断：</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// handler.js</span>
$(<span class="hljs-string">"#luckysheet-cell-main, #luckysheetTableContent"</span>).<span class="hljs-title function_">dblclick</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
	<span class="hljs-comment">// 这个函数是内置的哈，因此，可以直接获取到 r c</span>
	<span class="hljs-comment">// 判断当前单元格是否需要初始化远程搜索控件</span>
	<span class="hljs-title class_">RemoteSelect</span>.<span class="hljs-title function_">checkCellNeedRemoteSelect</span>(row_index, col_index)
})
</code></pre>
<p>两种方案我都试过了，<code>实现略有不同</code>，但都可以实现，还是借助原生的 dblclick 好处理些。</p>
<h2 data-id="heading-3">校验远程搜索下拉</h2>
<p>既然每一个单元格双击，都会触发这个校验，那么何时才需要初始化这个下拉框呢？</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 判断当前单元格是否需要显示下拉框</span>
<span class="hljs-attr">checkCellNeedRemoteSelect</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">r, c</span>) {
    <span class="hljs-comment">// 通过 r c 获取单元格信息</span>
    <span class="hljs-keyword">let</span> cell = <span class="hljs-title class_">Store</span>.<span class="hljs-property">flowdata</span>[r][c];

    <span class="hljs-comment">// 如果 cell 没有配置 remoteSelect 或者 remoteSelect.enable 为 false 则返回</span>
    <span class="hljs-keyword">if</span> (!cell || !cell.<span class="hljs-property">remoteSelect</span> || !cell.<span class="hljs-property">remoteSelect</span>.<span class="hljs-property">enable</span>) {
        <span class="hljs-keyword">return</span>;
    }
}
</code></pre>
<p>检验完成后，如果需要初始化校验，别忘了， 我们底层还要监听输入框事件哈：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 不然，开始监听 input 输入事件</span>
$(<span class="hljs-string">"#luckysheet-input-box .luckysheet-cell-input"</span>).<span class="hljs-title function_">off</span>(<span class="hljs-string">"input"</span>).<span class="hljs-title function_">on</span>(<span class="hljs-string">"input"</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">let</span> value = $(<span class="hljs-variable language_">this</span>).<span class="hljs-title function_">text</span>().<span class="hljs-title function_">trim</span>(); <span class="hljs-comment">// 获取用户输入的值</span>
      
        <span class="hljs-keyword">if</span> (cell.<span class="hljs-property">remoteSelect</span> &amp;&amp; cell.<span class="hljs-property">remoteSelect</span>.<span class="hljs-property">onInput</span> &amp;&amp; <span class="hljs-keyword">typeof</span> cell.<span class="hljs-property">remoteSelect</span>.<span class="hljs-property">onInput</span> == <span class="hljs-string">"function"</span>) {
            <span class="hljs-comment">// 调用外部接口</span>
            cell.<span class="hljs-property">remoteSelect</span>
                .<span class="hljs-title function_">onInput</span>(value)
                .<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">dataList</span>) {
                    $this.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span>;
                    $this.<span class="hljs-title function_">showRemoteSelect</span>(dataList);
                })
                .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
                    $this.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span>;
                    $this.<span class="hljs-title function_">hideRemoteSelect</span>();
                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"请求接口错误"</span>, error);
                    tooltip.<span class="hljs-title function_">info</span>(<span class="hljs-string">'&lt;i class="fa fa-exclamation-triangle"&gt;&lt;/i&gt;'</span>, <span class="hljs-string">"接口请求失败"</span>);
                });
        }
    });
</code></pre>
<h2 data-id="heading-4">初始化下拉框</h2>
<p>远程搜索的核心，就是下拉选项，当远程接口初始化完成后，执行如下：</p>
<pre><code class="hljs language-js" lang="js">dataList.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
	<span class="hljs-keyword">const</span> $item = $(<span class="hljs-string">`&lt;div class="<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.selectItemClass}</span>"&gt;`</span>)
		.<span class="hljs-title function_">text</span>(item)
		.<span class="hljs-title function_">click</span>(<span class="hljs-function">() =&gt;</span> {
			<span class="hljs-comment">// 触发选择回调</span>
			<span class="hljs-keyword">if</span> (cell.<span class="hljs-property">remoteSelect</span> &amp;&amp; cell.<span class="hljs-property">remoteSelect</span>.<span class="hljs-property">onSelect</span> &amp;&amp; <span class="hljs-keyword">typeof</span> cell.<span class="hljs-property">remoteSelect</span>.<span class="hljs-property">onSelect</span> === <span class="hljs-string">"function"</span>) {
    		cell.<span class="hljs-property">remoteSelect</span>.<span class="hljs-title function_">onSelect</span>(item);
			}
		})
</code></pre>
<p>这里就一个难点要处理，如何将下拉框定位到输入框的位置：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 这里采用巧方案，直接取输入框的位置</span>
<span class="hljs-keyword">const</span> $input = $(<span class="hljs-string">"#luckysheet-input-box"</span>);
<span class="hljs-keyword">const</span> left = <span class="hljs-built_in">parseInt</span>($input.<span class="hljs-title function_">css</span>(<span class="hljs-string">"left"</span>)) || <span class="hljs-number">0</span>;
<span class="hljs-keyword">const</span> top = <span class="hljs-built_in">parseInt</span>($input.<span class="hljs-title function_">css</span>(<span class="hljs-string">"top"</span>)) || <span class="hljs-number">0</span>;

<span class="hljs-comment">// 获取当前单元格的高度 行高</span>
<span class="hljs-keyword">const</span> [_row_pre, rowHeight] = <span class="hljs-title function_">rowLocation</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>);

<span class="hljs-comment">// 设置下拉框位置和宽度</span>
$selectBox.<span class="hljs-title function_">css</span>({
    <span class="hljs-attr">top</span>: <span class="hljs-string">`<span class="hljs-subst">${top + rowHeight + <span class="hljs-number">4</span>}</span>px`</span>, <span class="hljs-comment">// 在单元格下方显示</span>
    <span class="hljs-attr">left</span>: <span class="hljs-string">`<span class="hljs-subst">${left}</span>px`</span>,
});
</code></pre>
<h2 data-id="heading-5">总结</h2>
<p>虽然代码看起来不复杂，但是了解luckysheet 的源码、实现思路，以及单元格拓展实现方案是非常重要的。</p>
<p>通过本次实现，我们初步了解了luckysheet的二次开发流程，在不破坏原有功能的基础上添加新特性。远程搜索下拉控件的实现展示了如何在现有表格组件基础上，通过合理的架构设计和代码组织，添加复杂交互功能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[避坑指南！别再被N8N循环节点“调戏”了！为什么你的Done分支执行了多次？]]></title>    <link>https://juejin.cn/post/7589074117644238883</link>    <guid>https://juejin.cn/post/7589074117644238883</guid>    <pubDate>2025-12-29T09:21:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589074117644238883" data-draft-id="7588996730773192704" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 避坑指南！别再被N8N循环节点“调戏”了！为什么你的Done分支执行了多次？"/> <meta itemprop="keywords" content="后端,人工智能"/> <meta itemprop="datePublished" content="2025-12-29T09:21:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java中文社群"/> <meta itemprop="url" content="https://juejin.cn/user/61228381386487"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             避坑指南！别再被N8N循环节点“调戏”了！为什么你的Done分支执行了多次？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/61228381386487/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java中文社群
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T09:21:09.000Z" title="Mon Dec 29 2025 09:21:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家在使用 n8n 的循环节点（Loop Over Items）时，有没有遇到过这种让人抓狂的情况：</p>
<p>明明官方文档说 <code>loop</code> 分支是循环执行，而 <code>done</code> 分支是在循环结束后只执行一次。结果你自己一上手：好家伙，<code>loop</code> 跑了 3 次，<code>done</code> 后面接的节点居然也跟着跑了 3 次！🤯 如下图所示：</p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/394b49df0671490eb6ef8e297a3c1b76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767604868&amp;x-signature=HUcvPBGw8EaWlxuD4ePn1tP10JI%3D" alt="" loading="lazy"/></p>
<p><strong>难道是官方文档在忽悠人？还是咱用的版本不对？</strong></p>
<p>今天，磊哥就带大家扒一扒 n8n 基础节点里最难理解的——循环节点。全网没人能讲清的背后的逻辑，咱一次性说明白！</p>
<hr/>
<h2 data-id="heading-0">🎥 视频教程演示</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1odBCB7E6p%2F" target="_blank" title="https://www.bilibili.com/video/BV1odBCB7E6p/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1od…</a></p>
<hr/>
<h2 data-id="heading-1">🔍 1. 现场还原：消失的“一次执行”</h2>
<p>咱们先看一个简单的案例。</p>
<p>在工作流里，我用代码节点（Code Node）输出了三项内容：张三、李四、王五。</p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1cbf06433c546299fc165f627c42b67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767604868&amp;x-signature=GM2lJf4iXWsGHVBtx5JOgV%2Fx3jo%3D" alt="" loading="lazy"/></p>
<p>按逻辑，接下来的循环节点应该是这样的：</p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a41fe085f1d4ef49da0bdd4d093278a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767604868&amp;x-signature=yCdpvLtmcXZ9Bs79L95Wfzi8h7o%3D" alt="" loading="lazy"/></p>
<ol>
<li><strong>loop 分支</strong>：负责循环这三项，去执行具体的任务（比如写入文件）。</li>
<li><strong>done 分支</strong>：等这三项都处理完了，<strong>出来吱一声（执行一次）</strong>，收个尾。</li>
</ol>
<p>但在实际执行中，你会发现 <code>loop</code> 下面显示 “3 items”，<strong>而 <strong><code>**done**</code></strong> 下面也显示了 “3 items”</strong>。</p>
<p>如果你在 <code>done</code> 后面接个发邮件或者写文件的节点，它会整整运行 3 次！</p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45c05518443a449eb7413ddb0299c1c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767604868&amp;x-signature=i%2FBr78ZCPfAKmXK1uWyvORRwCXA%3D" alt="" loading="lazy"/></p>
<p>这到底是为什么？🤔</p>
<hr/>
<h2 data-id="heading-2">💡 2. 核心真相：是“结果”跑了多次，而不是“事件”跑了多次</h2>
<p>这里大家一定要记住一句话：在 n8n 里，后续节点执行几次，取决于前一个节点输出了多少个 Item（项目）。</p>
<p>这就是很多人理解不了循环节点的根本原因。</p>
<ul>
<li><strong>官方没骗你</strong>：<code>done</code> 分支确实只被触发了一次。</li>
<li><strong>真相是</strong>：<code>done</code> 事件在执行时，它会把之前 <code>loop</code> 循环完成的所有结果（那 3 条数据）封装在一起吐出来。</li>
</ul>
<p><strong>因为 <strong><code>done</code></strong> 分支输出了 3 个项目</strong>，n8n 的默认逻辑就是：“既然你有 3 条数据，<strong>那后面的节点我就并行的帮你跑 3 次吧！</strong>”</p>
<p>所以，<strong>你看到的“执行多次”，其实是 n8n 强大的并发特性导致的“假象”</strong>。</p>
<hr/>
<h2 data-id="heading-3">🛠️ 3. 终极绝招：如何让 Done 只乖乖执行一次？</h2>
<p>既然知道了原因，解决起来就非常简单了。</p>
<p>如果你希望循环结束后，后续节点不管前面有多少项数据，都只运行一次，你只需要：</p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f077f997a32461eb4452659667c6b50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767604868&amp;x-signature=iy5KdcSVp7WNaqfphOIaBthyzlA%3D" alt="" loading="lazy"/></p>
<ol>
<li>打开 <code>done</code> 分支后的那个节点设置。</li>
<li>点击 Settings 选项卡。</li>
<li>找到 Execute Once 选项，把它打开！✅</li>
</ol>
<p>开启这个开关后，无论前面传过来 3 条还是 3000 条数据，这个节点都只会执行一次。这才是符合我们预期的“循环结束”动作，最终执行效果如下：</p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4bf74e4162d456b938d55428a054ad9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767604868&amp;x-signature=mFoQSq1s%2F4YV7TW3%2FE2N6qtbbss%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-4">最后总结 📝</h2>
<p>理解了 “Item 驱动执行” 这个逻辑，你才算真正踏入了 n8n 高级玩家的大门。</p>
<ul>
<li><strong>loop</strong>：过程分支，循环几次跑几次。</li>
<li><strong>done</strong>：结束分支，只触发一次，但会携带所有结果。</li>
<li><strong>Execute Once</strong>：拦截多余执行的“定海神针”。</li>
</ul>
<p>如果你觉得这篇干货有帮到你，记得点赞、在看！</p>
<p>我是磊哥，每天分享一个 n8n 实战干货，咱们下期见！👋</p>
<blockquote>
<p>本文已收录到我的技术小站 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.javacn.site" target="_blank" title="https://www.javacn.site" ref="nofollow noopener noreferrer">www.javacn.site</a>，网站包含的内容有：<strong>LangChain/N8N/SpringAI/SpringAIAlibaba/LangChain4j/Dify/Coze/AI实战项目/AI常见面试题</strong>等技术分享，欢迎各位大佬光临指导~</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kotlin Flow 中 flatMap 与 flatMapLatest 的核心差异 —— 新手指南]]></title>    <link>https://juejin.cn/post/7588365276191883302</link>    <guid>https://juejin.cn/post/7588365276191883302</guid>    <pubDate>2025-12-29T01:52:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588365276191883302" data-draft-id="7588461466598441011" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kotlin Flow 中 flatMap 与 flatMapLatest 的核心差异 —— 新手指南"/> <meta itemprop="keywords" content="Kotlin,Android,Android Jetpack"/> <meta itemprop="datePublished" content="2025-12-29T01:52:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="QING618"/> <meta itemprop="url" content="https://juejin.cn/user/339115460529117"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kotlin Flow 中 flatMap 与 flatMapLatest 的核心差异 —— 新手指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/339115460529117/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    QING618
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T01:52:18.000Z" title="Mon Dec 29 2025 01:52:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 差异</h2>
<h3 data-id="heading-1">flatMap</h3>
<ul>
<li><strong>行为</strong>：转换每个输入值到 Flow，并<strong>按顺序收集所有生成的 Flow</strong></li>
<li><strong>特点</strong>：新的输入不会取消之前正在进行的转换</li>
<li><strong>使用场景</strong>：需要处理所有事件，且事件间有依赖关系或需保持顺序</li>
</ul>
<h3 data-id="heading-2">flatMapLatest</h3>
<ul>
<li><strong>行为</strong>：当有新输入时，<strong>立即取消</strong>前一个转换的 Flow</li>
<li><strong>特点</strong>：只处理最新的输入，忽略中间结果</li>
<li><strong>使用场景</strong>：只需最新结果，可安全取消旧操作</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 对比示例</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">demonstrateDifference</span><span class="hljs-params">()</span></span> {
    runBlocking {
        <span class="hljs-keyword">val</span> flow = flowOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>).onEach { delay(<span class="hljs-number">100</span>) }
        
        <span class="hljs-comment">// flatMap：处理所有值</span>
        flow.flatMap { value -&gt;
            flow {
                emit(<span class="hljs-string">"Processing <span class="hljs-variable">$value</span>"</span>)
                delay(<span class="hljs-number">200</span>) <span class="hljs-comment">// 模拟耗时操作</span>
                emit(<span class="hljs-string">"Completed <span class="hljs-variable">$value</span>"</span>)
            }
        }.collect { println(<span class="hljs-string">"flatMap: <span class="hljs-variable">$it</span>"</span>) }
        <span class="hljs-comment">// 输出所有 1,2,3 的处理结果</span>
        
        <span class="hljs-comment">// flatMapLatest：只处理最新的</span>
        flow.flatMapLatest { value -&gt;
            flow {
                emit(<span class="hljs-string">"Latest: <span class="hljs-variable">$value</span>"</span>)
                delay(<span class="hljs-number">200</span>)
                emit(<span class="hljs-string">"Done: <span class="hljs-variable">$value</span>"</span>) <span class="hljs-comment">// 可能被取消</span>
            }
        }.collect { println(<span class="hljs-string">"flatMapLatest: <span class="hljs-variable">$it</span>"</span>) }
        <span class="hljs-comment">// 只输出 3 的最新结果</span>
    }
}
</code></pre>
<h2 data-id="heading-3">2. 实战场景分析</h2>
<h3 data-id="heading-4">场景一：搜索自动补全</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SearchViewModel</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> searchQuery = MutableStateFlow(<span class="hljs-string">""</span>)
    
    <span class="hljs-comment">// 使用 flatMapLatest：用户连续输入时取消之前的请求</span>
    <span class="hljs-keyword">val</span> searchResults = searchQuery
        .debounce(<span class="hljs-number">300</span>) <span class="hljs-comment">// 防抖</span>
        .filter { it.length &gt;= <span class="hljs-number">2</span> }
        .flatMapLatest { query -&gt;
            flow {
                emit(SearchState.Loading)
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">val</span> results = api.searchAutocomplete(query)
                    emit(SearchState.Success(results))
                } <span class="hljs-keyword">catch</span> (e: Exception) {
                    emit(SearchState.Error(e))
                }
            }
        }
        .stateIn(viewModelScope, SharingStarted.WhileSubscribed(), SearchState.Idle)
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onQueryChanged</span><span class="hljs-params">(query: <span class="hljs-type">String</span>)</span></span> {
        searchQuery.value = query
    }
}

<span class="hljs-comment">// 错误使用 flatMap 的情况：所有请求都会完成，可能导致结果显示错乱</span>
<span class="hljs-keyword">val</span> wrongResults = searchQuery
    .flatMap { query -&gt; <span class="hljs-comment">// 错误！应该用 flatMapLatest</span>
        api.searchAutocompleteFlow(query)
    }
</code></pre>
<h3 data-id="heading-5">场景二：位置更新</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LocationTracker</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> locationUpdates = locationProvider.getUpdates()
    
    <span class="hljs-comment">// 使用 flatMap：每个位置都要上传，顺序重要</span>
    <span class="hljs-keyword">val</span> uploadStatus = locationUpdates
        .filter { it.accuracy &lt; <span class="hljs-number">50</span> } <span class="hljs-comment">// 只处理高精度位置</span>
        .conflate() <span class="hljs-comment">// 合并位置更新，避免过快</span>
        .flatMap { location -&gt;
            flow {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">val</span> response = uploadToServer(location)
                    emit(UploadResult.Success(location.id, response))
                } <span class="hljs-keyword">catch</span> (e: Exception) {
                    emit(UploadResult.Failure(location.id, e))
                }
            }
        }
        .<span class="hljs-keyword">catch</span> { e -&gt; emit(UploadResult.NetworkError(e)) }
    
    <span class="hljs-comment">// 使用 flatMapLatest：只关心最新位置的周边搜索</span>
    <span class="hljs-keyword">val</span> nearbyPlaces = locationUpdates
        .flatMapLatest { location -&gt;
            placesApi.getNearbyPlaces(location.lat, location.lng)
        }
}
</code></pre>
<h3 data-id="heading-6">场景三：文件上传队列</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FileUploadManager</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> uploadQueue = MutableSharedFlow&lt;FileData&gt;()
    
    <span class="hljs-comment">// 使用 flatMap + buffer：并发上传但限制并发数</span>
    <span class="hljs-keyword">val</span> uploadProgress = uploadQueue
        .flatMapMerge(concurrency = <span class="hljs-number">3</span>) { file -&gt; <span class="hljs-comment">// 限制3个并发</span>
            uploadFileFlow(file)
        }
        .shareIn(ioScope, SharingStarted.Lazily)
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">uploadFileFlow</span><span class="hljs-params">(file: <span class="hljs-type">FileData</span>)</span></span>: Flow&lt;UploadStatus&gt; = flow {
        emit(UploadStatus.Progress(file.id, <span class="hljs-number">0</span>))
        
        <span class="hljs-keyword">val</span> chunks = splitIntoChunks(file)
        chunks.forEachIndexed { index, chunk -&gt;
            api.uploadChunk(file.id, chunk)
            <span class="hljs-keyword">val</span> progress = ((index + <span class="hljs-number">1</span>) / chunks.size.toFloat() * <span class="hljs-number">100</span>).toInt()
            emit(UploadStatus.Progress(file.id, progress))
        }
        
        emit(UploadStatus.Completed(file.id))
    }
    
    <span class="hljs-comment">// 使用 flatMapLatest：用户取消上传时立即停止</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">uploadWithCancel</span><span class="hljs-params">()</span></span>: Flow&lt;UploadStatus&gt; {
        <span class="hljs-keyword">val</span> cancelSignal = MutableStateFlow(<span class="hljs-literal">false</span>)
        
        <span class="hljs-keyword">return</span> uploadQueue
            .flatMapLatest { file -&gt;
                <span class="hljs-keyword">if</span> (cancelSignal.value) {
                    emptyFlow()
                } <span class="hljs-keyword">else</span> {
                    uploadFileFlow(file)
                }
            }
    }
}
</code></pre>
<h2 data-id="heading-7">3. 常见陷阱与解决方案</h2>
<h3 data-id="heading-8">陷阱一：资源泄漏</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 错误：flatMapLatest 取消时资源未清理</span>
flow.flatMapLatest { id -&gt;
    flow {
        <span class="hljs-keyword">val</span> connection = openDatabaseConnection() <span class="hljs-comment">// 可能泄漏！</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = connection.query(id)
            emit(<span class="hljs-keyword">data</span>)
        } <span class="hljs-keyword">finally</span> {
            connection.close() <span class="hljs-comment">// 必须清理</span>
        }
    }
}

<span class="hljs-comment">// 正确：使用 cancellable 操作或清理资源</span>
flow.flatMapLatest { id -&gt;
    callbackFlow {
        <span class="hljs-keyword">val</span> connection = openDatabaseConnection()
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = connection.query(id)
            send(<span class="hljs-keyword">data</span>)
            awaitClose()
        } <span class="hljs-keyword">finally</span> {
            connection.close()
        }
    }
}
</code></pre>
<h3 data-id="heading-9">陷阱二：状态不一致</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 错误：状态更新可能被取消，导致不一致</span>
<span class="hljs-keyword">var</span> currentState = State.IDLE

flow.flatMapLatest {
    currentState = State.LOADING <span class="hljs-comment">// 可能执行但后续被取消</span>
    apiCallFlow(it).onCompletion {
        currentState = State.IDLE <span class="hljs-comment">// 可能不会执行</span>
    }
}

<span class="hljs-comment">// 正确：使用状态流</span>
<span class="hljs-keyword">val</span> state = MutableStateFlow(State.IDLE)

flow.flatMapLatest {
    state.value = State.LOADING
    apiCallFlow(it)
        .<span class="hljs-keyword">catch</span> { e -&gt; 
            state.value = State.ERROR(e)
            emptyFlow() 
        }
        .onCompletion { 
            <span class="hljs-keyword">if</span> (it == <span class="hljs-literal">null</span>) state.value = State.IDLE 
        }
}
</code></pre>
<h3 data-id="heading-10">陷阱三：背压处理不当</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 错误：没有处理背压，可能内存溢出</span>
highFrequencyFlow
    .flatMapLatest { <span class="hljs-comment">// 仍然可能快速发射</span>
        heavyOperationFlow(it)
    }

<span class="hljs-comment">// 正确：添加背压策略</span>
highFrequencyFlow
    .conflate() <span class="hljs-comment">// 合并中间值</span>
    .flatMapLatest {
        heavyOperationFlow(it)
    }

<span class="hljs-comment">// 或限制并发</span>
highFrequencyFlow
    .flatMapMerge(concurrency = <span class="hljs-number">1</span>) { <span class="hljs-comment">// 限制为顺序执行</span>
        heavyOperationFlow(it)
    }
</code></pre>
<h3 data-id="heading-11">陷阱四：异常处理缺失</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 错误：异常会使整个流终止</span>
flow.flatMapLatest {
    flow { 
        <span class="hljs-keyword">if</span> (it.isEmpty()) <span class="hljs-keyword">throw</span> IllegalArgumentException()
        emit(process(it))
    }
}

<span class="hljs-comment">// 正确：妥善处理异常</span>
flow.flatMapLatest {
    flow {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (it.isEmpty()) <span class="hljs-keyword">throw</span> IllegalArgumentException()
            emit(Result.Success(process(it)))
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            emit(Result.Failure(e))
        }
    }
}
</code></pre>
<h2 data-id="heading-12">4. 性能优化技巧</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 合并操作减少开销</span>
searchQuery
    .debounce(<span class="hljs-number">300</span>)
    .distinctUntilChanged() <span class="hljs-comment">// 避免重复查询</span>
    .flatMapLatest { query -&gt;
        api.search(query)
            .retry(<span class="hljs-number">2</span>) <span class="hljs-comment">// 重试机制</span>
            .timeout(<span class="hljs-number">5000</span>) <span class="hljs-comment">// 超时</span>
    }

<span class="hljs-comment">// 2. 使用 shareIn 避免重复订阅</span>
<span class="hljs-keyword">val</span> sharedFlow = sourceFlow
    .flatMapLatest { expensiveOperation(it) }
    .shareIn(
        scope = viewModelScope,
        started = SharingStarted.WhileSubscribed(<span class="hljs-number">5000</span>),
        replay = <span class="hljs-number">1</span>
    )

<span class="hljs-comment">// 3. 适当使用 buffer</span>
flow
    .buffer(Channel.UNLIMITED) <span class="hljs-comment">// 根据场景选择</span>
    .flatMapLatest { <span class="hljs-comment">/* ... */</span> }
</code></pre>
<h2 data-id="heading-13">5. 选择指南</h2>



































<table><thead><tr><th>场景特征</th><th>推荐操作符</th><th>理由</th></tr></thead><tbody><tr><td>需处理所有输入，顺序重要</td><td><code>flatMapConcat</code></td><td>保持顺序，无并发</td></tr><tr><td>需处理所有输入，顺序不重要</td><td><code>flatMapMerge</code></td><td>并发处理，提高效率</td></tr><tr><td>只需最新结果，可取消旧操作</td><td><code>flatMapLatest</code></td><td>避免无效计算</td></tr><tr><td>有限并发控制</td><td><code>flatMapMerge</code> with concurrency</td><td>控制资源使用</td></tr><tr><td>冷流转换</td><td><code>transform</code></td><td>更轻量级的转换</td></tr></tbody></table>
<h2 data-id="heading-14">总结</h2>
<ol>
<li><strong>flatMapLatest 适合响应式 UI 交互</strong>（搜索、点击防抖），可避免陈旧数据</li>
<li><strong>flatMapMerge 适合并行任务处理</strong>（批量上传、并发请求），提高吞吐量</li>
<li><strong>flatMapConcat 适合顺序敏感操作</strong>（文件分片上传、数据库事务）</li>
<li><strong>始终考虑资源清理</strong>，特别是在可取消的操作中</li>
<li><strong>合理处理背压</strong>，根据场景选择 buffer、conflate 等策略</li>
<li><strong>统一异常处理</strong>，避免流意外终止</li>
</ol>
<p>正确选择 flatMap 变体可以显著提升应用性能和用户体验，特别是在处理异步数据流时。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[当AI不再是“玩具”，我们是如何用Trace、Antigravity和Cursor“躺平”？]]></title>    <link>https://juejin.cn/post/7588934987510267931</link>    <guid>https://juejin.cn/post/7588934987510267931</guid>    <pubDate>2025-12-29T09:01:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588934987510267931" data-draft-id="7589093895326187529" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="当AI不再是“玩具”，我们是如何用Trace、Antigravity和Cursor“躺平”？"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2025-12-29T09:01:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="知识浅谈"/> <meta itemprop="url" content="https://juejin.cn/user/607378030207176"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            当AI不再是“玩具”，我们是如何用Trace、Antigravity和Cursor“躺平”？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/607378030207176/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    知识浅谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T09:01:04.000Z" title="Mon Dec 29 2025 09:01:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">从“哇塞”到“真香”的质变</h3>
<p>回想两年前，2023年那会，我们刚接触ChatGPT和Copilot的时候，每天都在惊呼：“卧槽，这玩意儿能写快排！”那时候的AI像个刚毕业的天才实习生，聪明但经常胡说八道。</p>
<p>一转眼到了2025年底。现在的感觉变了。AI不再是那个需要你哄着写Prompt的实习生，它更像是一个不知疲倦的<strong>Tech Lead</strong>。</p>
<p>今年是我彻底放弃“手写每一行代码”执念的一年。不是我懒，而是工具太强了。如果你现在还在用纯Vim或者没有任何插件的VS Code硬刚业务逻辑，说实话，你正在这辆飞速行驶的技术列车上表演“徒手扒火车”。</p>
<p>今天这篇长文，不讲虚头巴脑的概念，咱就聊聊这一年陪我熬夜、帮我背锅、让我早点下班的那些神级工具：<strong>Cursor, Antigravity, Kiro, Trace</strong> 等等。</p>
<hr/>
<h3 data-id="heading-1">Cursor：它已经不是编辑器了，它是我的外包团队</h3>
<p>如果说2024年的Cursor还是VS Code的魔改版，那2025年的Cursor简直就是<strong>IDE界的“钢铁侠战衣”</strong>。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbf24466d8d24b1f99a9bba2c5a02d51~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-l6K-G5rWF6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767604059&amp;x-signature=dkyLfJ4BjCmj1E8CtNEHVa7swP0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-2">1. Composer 模式的完全体</h4>
<p>以前我们用AI，是一问一答：“帮我写个函数”。
现在的Cursor Composer（撰写者模式）是：“帮我把这个User模块重构一下，数据库字段加一个<code>last_login</code>，顺便把前端的Profile页面也改了，API文档也更新一下。”</p>
<p>它不再是盯着光标处的那一行代码，它有了<strong>全局视野</strong>。今年我在做那个SaaS项目时，最爽的一次体验是，我直接丢给它一张数据库ER图的截图，然后说：“按这个结构生成后端CRUD接口，用FastAPI。”</p>
<p>两分钟后，Model、Schema、Router全出来了。我只需要像个甲方一样指指点点：“这儿没做鉴权，那儿少个分页。”</p>
<h4 data-id="heading-3">2. Shadow Workspace（影子工作区）</h4>
<p>这是Cursor今年最大的杀手锏。以前改代码怕改挂了，得切个分支。现在Cursor在你打字的时候，已经在后台的“影子空间”里预运行了你的代码。</p>
<p>当你还在犹豫变量名起什么的时候，它已经在右下角提示你：“老兄，你这样写待会儿跑不通的，因为第50行的那个依赖包版本不兼容。” 这种<strong>预知未来</strong>的能力，真的救了我无数次生产环境的P0级事故。</p>
<hr/>
<h3 data-id="heading-4">Antigravity：Python开发者的上帝视角</h3>
<p>如果你是Python开发者，今年没用过 <strong>Antigravity</strong>，那你真的错过了太多。它的名字取自那个经典的XKCD漫画（Python能让你飞起来），但2025年的这个工具，是真的让你<strong>无视重力</strong>。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b13c4b0eb6d846918b22a8e517c58e6f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-l6K-G5rWF6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767604059&amp;x-signature=TKKADtZtpoovPe4cVqDfZfhX2bg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-5">1. 也是IDE，但是是3D的？</h4>
<p>Antigravity 不再是冷冰冰的代码行。它引入了“可视化堆栈”的概念。以前调试代码，我们是打断点，一步步Next。在Antigravity里，代码的执行流被画成了一张动态的图。</p>
<p>你可以清晰地看到数据流怎么从API进来，经过了哪些中间件，在哪里被堵塞了。</p>
<h4 data-id="heading-6">2. 依赖地狱的终结者</h4>
<p>Python的包管理一直是噩梦。<code>pip</code>、<code>poetry</code>、<code>conda</code> 混在一起能要把人逼疯。Antigravity 内置了一个AI环境管家。</p>
<p>我有一次接手一个祖传的Django项目，依赖乱得像盘丝洞。我直接把项目拖进 Antigravity，点了一下“Fix Environment”。它自动扫描了所有import，分析了版本冲突，然后给我生成了一个完美的虚拟环境。它甚至悄悄把几个有安全漏洞的包给升级并适配了。</p>
<blockquote>
<p><strong>心得：</strong> Antigravity 让我感觉自己不是在写代码，而是在像修理钟表一样，精准地调整每一个齿轮的咬合。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">Kiro：终结了“查文档”时代的命令行</h3>
<p>记得以前要在终端里搞点复杂的运维操作，比如“查找所有大于100M的文件并按修改时间排序后删除”，我得去Google一下 <code>find</code> 命令的参数，或者去翻 <code>man</code> 手册。</p>
<p><strong>Kiro</strong> 的出现，把Terminal变成了聊天窗口。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b13be09024d4be8b36babedf34529a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-l6K-G5rWF6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767604059&amp;x-signature=T8TF8dL1Xs14PZVKE%2BzHrUDRUA8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-8">1. 自然语言转Shell</h4>
<p>现在我的终端日常是这样的：</p>
<blockquote>
<p>我：<code>kiro 帮我把当前目录下所有的png图片压缩50%然后移动到 dist 文件夹</code>
Kiro: <code>Running: find . -name "*.png" -exec convert {} -quality 50% dist/{} \;</code> （自动执行）</p>
</blockquote>
<p>它不是简单的翻译，它懂上下文。如果你连续操作，它记得你上一步进了哪个目录，记得你刚才部署的是哪个服务。</p>
<h4 data-id="heading-9">2. 报错自动修</h4>
<p>最神的是，当命令报错时，Kiro不会只给你扔一堆红色的Error Log。它会直接分析报错原因：
“报错是因为端口8080被占用了，占用者是PID 1234 (Java)。你要杀掉它吗？”
我只需要回一个 <code>y</code>。</p>
<p>这种丝滑感，让我这个老运维都感动得想哭。Kiro 让 CLI（命令行界面）变成了 CUI（对话式界面）。</p>
<hr/>
<h3 data-id="heading-10">Trace：那个不用你写测试用例的QA</h3>
<p><strong>Trace</strong> 是今年测试领域的黑马。它的理念非常激进：<strong>“人是不应该写单元测试的”</strong>。</p>
<p>听起来很狂对吧？但它做到了。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5af079fdd6ab43cf9ad3fcddb10f75f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-l6K-G5rWF6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767604059&amp;x-signature=Ekzn94%2Fbw8KD0PIr2P0tk%2F%2F%2FFlw%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-11">1. 逆向生成测试</h4>
<p>Trace 挂在你的后台，它会观察你平时的手动测试行为，也会分析你的业务逻辑代码。当你写完一个 <code>OrderService</code> 类，保存的那一瞬间，Trace 已经在后台生成了覆盖率100%的测试用例。</p>
<p>它不仅仅是生成 <code>assert 1==1</code> 这种废话，它会生成边界条件测试。比如你写了个除法，它自动生成除以0的Case；你写了个金额计算，它自动生成负数输入的Case。</p>
<h4 data-id="heading-12">2. 生产环境录制回放</h4>
<p>Trace 最强的功能是<strong>Traffic Replay</strong>。它能对生产环境的流量进行脱敏录制，然后在我本地开发环境里回放。</p>
<p>这意味着，我本地调试的不是假数据，而是真实用户产生的数据（当然是脱敏的）。这解决了困扰程序员几十年的千古难题：“<strong>在我本地明明是好的啊！</strong>”</p>
<hr/>
<h3 data-id="heading-13">2025年的编程范式：我们还是程序员吗？</h3>
<p>聊完工具，我想聊聊心态。</p>
<p>今年我也听到很多声音，说程序员要失业了。但我这一年用下来，感觉恰恰相反。<strong>我们没有失业，但我们转行了。</strong></p>
<p>我们从“搬砖工”（Bricklayer）变成了“建筑师”（Architect）。</p>
<h4 data-id="heading-14">1. 这种感觉叫“心流的延续”</h4>
<p>以前写代码，很容易被打断：查语法、修标点、配环境。
现在有了 Cursor + Antigravity + Kiro，这些琐事都被AI接管了。我可以把所有的脑力都集中在<strong>业务逻辑</strong>和<strong>系统设计</strong>上。</p>
<p>以前做一个功能要3天，其中2.5天在写Boilerplate（样板代码）。现在做一个功能只要半天，剩下2.5天我可以去优化性能、去思考用户体验、甚至去陪女朋友（划掉，去学习新框架）。</p>
<h4 data-id="heading-15">2. 审美变得比手速更重要</h4>
<p>当AI能帮你生成一切的时候，<strong>品味</strong>就成了核心竞争力。</p>
<ul>
<li>你知道这段生成的代码虽然能跑，但结构很烂吗？</li>
<li>你知道这个UI虽然画出来了，但交互反人类吗？</li>
<li>你知道这个架构虽然流行，但不适合现在的业务规模吗？</li>
</ul>
<p>工具越强，越需要一个有经验的人去按住AI的手说：“停，这里不能这么写，会由于并发问题导致死锁。”</p>
<p>这就是2025年资深程序员的价值——<strong>鉴赏力与把控力</strong>。</p>
<hr/>
<h3 data-id="heading-16">结语</h3>
<p>2025年，是编程技术彻底爆发的一年。编程不再是Ctrl+C、Ctrl+V😂，它变成了一种更亲民、更高效的创造方式。</p>
<p>如果你问我，现在还要不要学编程？
我的回答是：<strong>要学。但不要学怎么写语法，要学怎么构建逻辑，怎么拆解问题，怎么指挥AI军团为你作战。</strong></p>
<p>如果你还没有试过 Cursor 的 Composer，没在 Antigravity 里飞过，没跟 Kiro 聊过天，哪怕只是为了好玩，也可以尝试一下。</p>
<p>毕竟，<strong>偷懒，才是人类科技进步的第一生产力。</strong></p>
<hr/>
<p><em>(最后插一句，这篇文章的大纲是 Cursor 帮我理的，配图建议是 Gemini 提的，但我保证，这段感慨是我自己一个个字敲出来的。)</em></p>
<hr/>
<p><strong>希望这篇年度总结能给你带来一些共鸣。明年见！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[回溯算法总结]]></title>    <link>https://juejin.cn/post/7588461466598031411</link>    <guid>https://juejin.cn/post/7588461466598031411</guid>    <pubDate>2025-12-29T00:20:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588461466598031411" data-draft-id="7588146449005953060" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 回溯算法总结"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-29T00:20:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             回溯算法总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T00:20:47.000Z" title="Mon Dec 29 2025 00:20:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    18
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>其实回溯算法和我们常说的 DFS 算法非常类似，本质上就是一种暴力穷举算法。回溯算法和 DFS 算法的细微差别是：回溯算法是在遍历「树枝」，DFS 算法是在遍历「节点」</p>
<p><strong>抽象地说，解决一个回溯问题，实际上就是遍历一棵决策树的过程，树的每个叶子节点存放着一个合法答案。你把整棵树遍历一遍，把叶子节点上的答案都收集起来，就能得到所有的合法答案</strong>。</p>
<p>站在回溯树的一个节点上，你只需要思考 3 个问题：</p>
<p>1、路径：也就是已经做出的选择。</p>
<p>2、选择列表：也就是你当前可以做的选择。</p>
<p>3、结束条件：也就是到达决策树底层，无法再做选择的条件。</p>
<p>代码方面，回溯算法的框架：</p>
<pre><code class="hljs language-java" lang="java">result = []
def <span class="hljs-title function_">backtrack</span><span class="hljs-params">(路径, 选择列表)</span>:
    <span class="hljs-keyword">if</span> 满足结束条件:
        result.add(路径)
        <span class="hljs-keyword">return</span>
    
    <span class="hljs-keyword">for</span> 选择 in 选择列表:
        做选择
        backtrack(路径, 选择列表)
        撤销选择
</code></pre>
<p>for循环就是遍历集合区间，可以理解一个节点有多少个孩子，这个for循环就执行多少次。</p>
<p>backtracking这里自己调用自己，实现递归。</p>
<p><strong>其核心就是 for 循环里面的递归，在递归调用之前「做选择」，在递归调用之后「撤销选择」</strong></p>
<h2 data-id="heading-1">回溯算法解决组合问题</h2>
<p>这里的组合问题 元素无重不可复选</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {

    List&lt;List&lt;Integer&gt;&gt; res = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
    <span class="hljs-comment">// 记录回溯算法的递归路径</span>
    LinkedList&lt;Integer&gt; track = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();

    <span class="hljs-comment">// 主函数</span>
    <span class="hljs-keyword">public</span> List&lt;List&lt;Integer&gt;&gt; <span class="hljs-title function_">combine</span><span class="hljs-params">(<span class="hljs-type">int</span> n, <span class="hljs-type">int</span> k)</span> {
        backtrack(<span class="hljs-number">1</span>, n, k);
        <span class="hljs-keyword">return</span> res;
    }

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">backtrack</span><span class="hljs-params">(<span class="hljs-type">int</span> start, <span class="hljs-type">int</span> n, <span class="hljs-type">int</span> k)</span> {
        <span class="hljs-comment">// base case</span>
        <span class="hljs-keyword">if</span> (k == track.size()) {
            <span class="hljs-comment">// 遍历到了第 k 层，收集当前节点的值</span>
            res.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;(track));
            <span class="hljs-keyword">return</span>;
        }
        
        <span class="hljs-comment">// 回溯算法标准框架</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> start; i &lt;= n; i++) {
            <span class="hljs-comment">// 选择</span>
            track.addLast(i);
            <span class="hljs-comment">// 通过 start 参数控制树枝的遍历，避免产生重复的子集</span>
            backtrack(i + <span class="hljs-number">1</span>, n, k);
            <span class="hljs-comment">// 撤销选择</span>
            track.removeLast();
        }
    }
}
</code></pre>
<h2 data-id="heading-2">回溯算法解决排列问题</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {

    List&lt;List&lt;Integer&gt;&gt; res = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
    <span class="hljs-comment">// 记录回溯算法的递归路径</span>
    LinkedList&lt;Integer&gt; track = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
    <span class="hljs-comment">// track 中的元素会被标记为 true</span>
    <span class="hljs-type">boolean</span>[] used;

    <span class="hljs-comment">/* 主函数，输入一组不重复的数字，返回它们的全排列 */</span>
    <span class="hljs-keyword">public</span> List&lt;List&lt;Integer&gt;&gt; <span class="hljs-title function_">permute</span><span class="hljs-params">(<span class="hljs-type">int</span>[] nums)</span> {
        used = <span class="hljs-keyword">new</span> <span class="hljs-title class_">boolean</span>[nums.length];
        backtrack(nums);
        <span class="hljs-keyword">return</span> res;
    }

    <span class="hljs-comment">// 回溯算法核心函数</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">backtrack</span><span class="hljs-params">(<span class="hljs-type">int</span>[] nums)</span> {
        <span class="hljs-comment">// base case，到达叶子节点</span>
        <span class="hljs-keyword">if</span> (track.size() == nums.length) {
            <span class="hljs-comment">// 收集叶子节点上的值</span>
            res.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>(track));
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 回溯算法标准框架</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; nums.length; i++) {
            <span class="hljs-comment">// 已经存在 track 中的元素，不能重复选择</span>
            <span class="hljs-keyword">if</span> (used[i]) {
                <span class="hljs-keyword">continue</span>;
            }
            <span class="hljs-comment">// 做选择</span>
            used[i] = <span class="hljs-literal">true</span>;
            track.addLast(nums[i]);
            <span class="hljs-comment">// 进入下一层回溯树</span>
            backtrack(nums);
            <span class="hljs-comment">// 取消选择</span>
            track.removeLast();
            used[i] = <span class="hljs-literal">false</span>;
        }
    }
}
</code></pre>
<h2 data-id="heading-3">总结</h2>
<p>回溯算法就是个多叉树的遍历问题，关键就是在前序遍历和后序遍历的位置做一些操作，算法框架如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">backtrack</span>(<span class="hljs-params">...</span>):
    <span class="hljs-keyword">for</span> 选择 <span class="hljs-keyword">in</span> 选择列表:
        做选择
        backtrack(...)
        撤销选择
</code></pre>
<p><strong>写 <code>backtrack</code> 函数时，需要维护走过的「路径」和当前可以做的「选择列表」，当触发「结束条件」时，将「路径」记入结果集</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hello AgentScope Java]]></title>    <link>https://juejin.cn/post/7588570963294535723</link>    <guid>https://juejin.cn/post/7588570963294535723</guid>    <pubDate>2025-12-29T05:29:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588570963294535723" data-draft-id="7588445332773158966" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hello AgentScope Java"/> <meta itemprop="keywords" content="云原生,Agent"/> <meta itemprop="datePublished" content="2025-12-29T05:29:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hello AgentScope Java
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T05:29:22.000Z" title="Mon Dec 29 2025 05:29:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：远云</p>
<p>随着 LLM 应用的飞速发展，越来越多的 Agent 应用开始走近每个人。围绕着 Agent 应用的核心，目前业界有零代码、低代码和高代码三条主流的技术路线。AgentScope 作为 Python 社区中受到广泛应用的高代码框架，在 Java 生态下的需求也越来越大。</p>
<p>今天，我们很高兴地宣布 <strong>AgentScope Java v0.2 版本</strong>正式发布了，具备了所有核心的 ReActAgent 的能力。</p>
<h2 data-id="heading-0">第一性原则：透明度</h2>
<p>AgentScope 的首要设计目标是<strong>对开发者透明</strong>。</p>
<p>当下，许多 Agent 框架将底层的调度进行了深度的封装，这固然会给用户带来一些概念上的简化，但是也带来了遇到问题时排查的复杂度。AgentScope 不同：</p>
<ul>
<li><strong>Prompt Engineering：</strong> 用户可以自己修改所有提示词相关的内容。</li>
<li><strong>API 调用：</strong> 每一次 API 调用都能够被定位。</li>
<li><strong>Agent 构建：</strong> 所有 Agent 的配置都来自用户确定性的配置。</li>
<li><strong>决策过程：</strong> Agent 的推理、执行过程都可以通过 Hook 对外暴露。</li>
</ul>
<h2 data-id="heading-1">三分钟构建一个智能体</h2>
<p>以下是一个简单的智能体示例：</p>
<h3 data-id="heading-2">Maven 依赖</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.agentscope<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>agentscope-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.2.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h3 data-id="heading-3">ReActAgent</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">HelloAgentScope</span> {
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">static</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">main</span>(String[] args) {
        <span class="hljs-comment">// 创建 ReActAgent</span>
        <span class="hljs-selector-tag">ReActAgent</span> <span class="hljs-selector-tag">agent</span> = <span class="hljs-selector-tag">ReActAgent</span><span class="hljs-selector-class">.builder</span>()
            <span class="hljs-selector-class">.name</span>(<span class="hljs-string">"Assistant"</span>)
            <span class="hljs-selector-class">.model</span>(DashScopeChatModel.<span class="hljs-built_in">builder</span>()
                .<span class="hljs-built_in">apiKey</span>(System.<span class="hljs-built_in">getenv</span>(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>))
                .<span class="hljs-built_in">modelName</span>(<span class="hljs-string">"qwen3-max"</span>)
                .<span class="hljs-built_in">build</span>())
            <span class="hljs-selector-class">.build</span>();
        <span class="hljs-comment">// 调用智能体</span>
        <span class="hljs-selector-tag">Msg</span> <span class="hljs-selector-tag">response</span> = <span class="hljs-selector-tag">agent</span><span class="hljs-selector-class">.call</span>(
            Msg.<span class="hljs-built_in">builder</span>()
                .<span class="hljs-built_in">role</span>(MsgRole.USER)
                .<span class="hljs-built_in">content</span>(TextBlock.<span class="hljs-built_in">builder</span>()
                        .<span class="hljs-built_in">text</span>(<span class="hljs-string">"你好，请介绍一下自己"</span>)
                        .<span class="hljs-built_in">build</span>())
                .<span class="hljs-built_in">build</span>()
        )<span class="hljs-selector-class">.block</span>();
        <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(response.<span class="hljs-built_in">getTextContent</span>());
    }
}
</code></pre>
<p>至此，一个 Agent 就构建完成了。在这个示例中，<code>ReActAgent</code> 是 AgentScope 的核心，我们后面几乎所有的功能都是基于它的。</p>
<h2 data-id="heading-4">架构概览</h2>
<p>和 Python 版本类似，AgentScope Java 采用分层架构：</p>
<h3 data-id="heading-5">基础组件层（Foundational Components）</h3>
<p><strong>Message</strong>：统一的消息抽象对象，通过一套数据结构支持文本、图像、音频、视频。</p>
<p><strong>Model API</strong>：支持 DashScope、OpenAI 等主流模型提供商。通过 Formatter 机制屏蔽不同模型提供商的格式差异。</p>
<p><strong>Tool</strong>：允许用户定义工具给 LLM 使用，支持同步/异步、流式/非流式等 API 风格。</p>
<h3 data-id="heading-6">智能体基础设施层（Agent-level Infrastructure）</h3>
<p><strong>ReAct 范式</strong>：核心 Agentic 实现，通过推理（Reasoning）再行动（Acting）的迭代循环。</p>
<p><strong>Agent Hooks</strong>：运行于 ReActAgent 内部，允许用户对 Agent 执行的过程进行监测、修改。</p>
<p><strong>状态管理</strong>：会话持久化组件，支持用户对话状态的保存和恢复。</p>
<h3 data-id="heading-7">多智能体协作层（Multi-Agent Cooperation）</h3>
<p><strong>MsgHub</strong>：支持多个 Agent 之间共享消息，实现多 Agent 沟通协作的工具。</p>
<p><strong>Pipeline</strong>：组合多个 Agent 按照特定（顺序、并行等）策略执行的工具。</p>
<h3 data-id="heading-8">部署层（Deployment）</h3>
<p><strong>AgentScope Runtime</strong>：解决分布式部署与安全隔离问题的企业级运行时基础设施，提供工具运行沙箱、A2A 协议、远程部署等能力。</p>
<p><strong>AgentScope Studio</strong>：提供开发阶段到运行阶段的可视化调试、观测能力，为开发者从 0 到 1 的开发提速。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf8363e331ea4525984b08cbabfea77e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767590961&amp;x-signature=N%2BTJvd%2BCs9XkR25K8NqZX4l2TFI%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-9">Reasoning and Acting</h2>
<p>ReAct（Reasoning and Acting）是 AgentScope 最核心的实现范式。其设计思路很简单：将思考和执行分离，通过迭代循环解决问题。</p>
<h3 data-id="heading-10">工作原理</h3>
<p><strong>Reasoning（推理）阶段</strong>：Agent 会基于当前的上下文分析，决定下一步行动：</p>
<ul>
<li>理解用户意图</li>
<li>评估已有信息（上下文）</li>
<li>确定需要调用的工具及参数</li>
</ul>
<p><strong>Acting（行动）阶段</strong>：执行 Reasoning 阶段所需的获取数据行为。</p>
<ul>
<li>并行执行工具调用</li>
<li>收集执行结果</li>
<li>将结果计入记忆</li>
</ul>
<p><strong>迭代控制</strong>：ReActAgent 会不断执行 Reasoning 和 Acting 的迭代，如果模型在最大迭代轮内完成迭代则会正常结束，如果未完成则会触发 summary 的能力，进行会话总结。</p>
<h3 data-id="heading-11">为 ReActAgent 添加工具</h3>
<p>为了让 ReActAgent 真正可以实现 Acting，需要为 ReActAgent 添加对应的工具。</p>
<p>这里以一个 Weather Assistant 为例子：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 定义工具类</span>
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">WeatherTools</span> {
    <span class="hljs-variable">@Tool</span>(description = <span class="hljs-string">"获取指定城市的天气信息"</span>)
    public String <span class="hljs-built_in">getWeather</span>(
        <span class="hljs-variable">@ToolParam</span>(name = <span class="hljs-string">"city"</span>, description = <span class="hljs-string">"城市名称"</span>) String city) {
        <span class="hljs-comment">// 实际应用中调用天气 API</span>
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">String</span><span class="hljs-selector-class">.format</span>(<span class="hljs-string">"%s：晴天，气温 25 ℃"</span>, city);
    }
}
<span class="hljs-comment">// 注册工具</span>
<span class="hljs-selector-tag">Toolkit</span> <span class="hljs-selector-tag">toolkit</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">Toolkit</span>();
<span class="hljs-selector-tag">toolkit</span><span class="hljs-selector-class">.registerTool</span>(new <span class="hljs-built_in">WeatherTools</span>());
<span class="hljs-comment">// 构建带工具的 ReActAgent</span>
<span class="hljs-selector-tag">ReActAgent</span> <span class="hljs-selector-tag">agent</span> = <span class="hljs-selector-tag">ReActAgent</span><span class="hljs-selector-class">.builder</span>()
    <span class="hljs-selector-class">.name</span>(<span class="hljs-string">"WeatherAssistant"</span>)
    <span class="hljs-selector-class">.sysPrompt</span>(<span class="hljs-string">"你是一个天气助手，可以查询城市天气信息。"</span>)
    <span class="hljs-selector-class">.model</span>(DashScopeChatModel.<span class="hljs-built_in">builder</span>()
        .<span class="hljs-built_in">apiKey</span>(System.<span class="hljs-built_in">getenv</span>(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>))
        .<span class="hljs-built_in">modelName</span>(<span class="hljs-string">"qwen3-max"</span>)
        .<span class="hljs-built_in">build</span>())
    <span class="hljs-selector-class">.toolkit</span>(toolkit)
    <span class="hljs-selector-class">.build</span>();
<span class="hljs-comment">// 调用智能体</span>
<span class="hljs-selector-tag">Msg</span> <span class="hljs-selector-tag">response</span> = <span class="hljs-selector-tag">agent</span><span class="hljs-selector-class">.call</span>(
    Msg.<span class="hljs-built_in">builder</span>()
                .<span class="hljs-built_in">role</span>(MsgRole.USER)
                .<span class="hljs-built_in">content</span>(TextBlock.<span class="hljs-built_in">builder</span>()
                        .<span class="hljs-built_in">text</span>(<span class="hljs-string">"北京今天天气如何？"</span>)
                        .<span class="hljs-built_in">build</span>())
                .<span class="hljs-built_in">build</span>()
)<span class="hljs-selector-class">.block</span>();
</code></pre>
<p>执行流程：</p>
<pre><code class="hljs language-scss" lang="scss">用户问题：北京今天天气如何？
    ↓
<span class="hljs-selector-attr">[推理]</span> 需要查天气，决定调用 <span class="hljs-built_in">getWeather</span>("北京")
    ↓
<span class="hljs-selector-attr">[行动]</span> 执行工具 → "北京：晴天，气温 <span class="hljs-number">25</span>℃"
    ↓
<span class="hljs-selector-attr">[推理]</span> 已获取信息，生成回答
    ↓
回答：根据查询结果，北京今天晴天，气温 <span class="hljs-number">25</span>℃
</code></pre>
<h2 data-id="heading-12">ReActAgent 核心特性</h2>
<p>除了基础的 Reasoning 和 Acting 能力，AgentScope 的 ReActAgent 还具备多个特性。</p>
<h3 data-id="heading-13">1. 多模态消息支持</h3>
<p>ReActAgent 可以处理多模态输入，不限于纯文本：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 创建支持视觉的 ReActAgent（使用视觉模型）</span>
<span class="hljs-selector-tag">ReActAgent</span> <span class="hljs-selector-tag">visionAgent</span> = <span class="hljs-selector-tag">ReActAgent</span><span class="hljs-selector-class">.builder</span>()
    <span class="hljs-selector-class">.name</span>(<span class="hljs-string">"VisionAssistant"</span>)
    <span class="hljs-selector-class">.model</span>(DashScopeChatModel.<span class="hljs-built_in">builder</span>()
        .<span class="hljs-built_in">apiKey</span>(System.<span class="hljs-built_in">getenv</span>(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>))
        .<span class="hljs-built_in">modelName</span>(<span class="hljs-string">"qwen3-vl-plus"</span>)  <span class="hljs-comment">// 视觉模型</span>
        .<span class="hljs-built_in">build</span>())
    <span class="hljs-selector-class">.build</span>();
<span class="hljs-comment">// 发送包含图片的消息</span>
<span class="hljs-selector-tag">Msg</span> <span class="hljs-selector-tag">response</span> = <span class="hljs-selector-tag">visionAgent</span><span class="hljs-selector-class">.call</span>(
    Msg.<span class="hljs-built_in">builder</span>()
        .<span class="hljs-built_in">role</span>(MsgRole.USER)
        .<span class="hljs-built_in">content</span>(List.<span class="hljs-built_in">of</span>(
            TextBlock.<span class="hljs-built_in">builder</span>().<span class="hljs-built_in">text</span>(<span class="hljs-string">"请分析这张图片的内容"</span>).<span class="hljs-built_in">build</span>(),
            ImageBlock.<span class="hljs-built_in">builder</span>().<span class="hljs-built_in">source</span>(URLSource.<span class="hljs-built_in">builder</span>().url(<span class="hljs-string">"https://example.com/image.jpg"</span>).<span class="hljs-built_in">build</span>()).<span class="hljs-built_in">build</span>()
        ))
        .<span class="hljs-built_in">build</span>()
)<span class="hljs-selector-class">.block</span>();
</code></pre>
<p>支持的多模态内容类型：TextBlock、ImageBlock、AudioBlock、VideoBlock。</p>
<h3 data-id="heading-14">2. 钩子机制</h3>
<p>为 ReActAgent 添加钩子，监控和扩展其行为。这里以前文中用到的 WeatherAssistant 为例子添加钩子，实时看到智能体的思考和执行过程：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">// 定义调试钩子，显示完整的 ReAct 执行过程
Hook debugHook = <span class="hljs-built_in">new</span> Hook() {
    @Override
    <span class="hljs-keyword">public</span> &lt;T extends HookEvent&gt; Mono&lt;T&gt; onEvent(T <span class="hljs-keyword">event</span>) {
        <span class="hljs-keyword">try</span> {
            switch (<span class="hljs-keyword">event</span>) {
                <span class="hljs-keyword">case</span> PreReasoningEvent e -&gt; {
                    System.out.println(<span class="hljs-string">"\n[推理] 智能体开始思考..."</span>);
                }
                <span class="hljs-keyword">case</span> PostReasoningEvent e -&gt; {
                    System.out.println(<span class="hljs-string">"[推理] 推理结果："</span> + <span class="hljs-built_in">new</span> ObjectMapper().writeValueAsString(e.getReasoningMessage()));
                }
                <span class="hljs-keyword">case</span> PostActingEvent e -&gt; {
                    System.out.println(<span class="hljs-string">"[行动] 执行工具 → "</span> + <span class="hljs-built_in">new</span> ObjectMapper().writeValueAsString(e.getToolResult()));
                }
                <span class="hljs-keyword">case</span> PostCallEvent e -&gt; {
                    System.out.println(<span class="hljs-string">"[推理] 已获取信息，生成回答"</span>);
                    System.out.println(<span class="hljs-string">"回答："</span> + e.getFinalMessage().getTextContent());
                }
                <span class="hljs-keyword">default</span> -&gt; {}
            } ;
        } <span class="hljs-keyword">catch</span> (JsonProcessingException e) {
            ...
        }
        <span class="hljs-keyword">return</span> Mono.just(<span class="hljs-keyword">event</span>);
    }
};
// 将钩子添加到 WeatherAssistant
ReActAgent weatherAgent = ReActAgent.builder()
    .name(<span class="hljs-string">"WeatherAssistant"</span>)
    .sysPrompt(<span class="hljs-string">"你是一个天气助手，可以查询城市天气信息。"</span>)
    .model(DashScopeChatModel.builder()
           .apiKey(System.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>))
           .modelName(<span class="hljs-string">"qwen3-max"</span>)
           .build())
    .toolkit(toolkit) // 前文中定义的 Toolkit
    .hook(debugHook)  // 添加调试钩子
    .build();
// 查询天气
Msg response = weatherAgent.<span class="hljs-keyword">call</span>(
    Msg.builder()
    .role(MsgRole.USER)
    .content(TextBlock.builder()
             .<span class="hljs-keyword">text</span>(<span class="hljs-string">"北京今天天气如何？"</span>)
             .build())
    .build()
).block();
// 输出示例：
// [推理] 智能体开始思考...
// [推理] 推理结果：{<span class="hljs-string">"id"</span>:<span class="hljs-string">"xxx"</span>,<span class="hljs-string">"name"</span>:<span class="hljs-string">"WeatherAssistant"</span>,<span class="hljs-string">"role"</span>:<span class="hljs-string">"ASSISTANT"</span>,<span class="hljs-string">"content"</span>:[{<span class="hljs-string">"type"</span>:<span class="hljs-string">"tool_use"</span>,<span class="hljs-string">"id"</span>:<span class="hljs-string">"call_xxx"</span>,<span class="hljs-string">"name"</span>:<span class="hljs-string">"getWeather"</span>,<span class="hljs-string">"input"</span>:{<span class="hljs-string">"city"</span>:<span class="hljs-string">"北京"</span>},<span class="hljs-string">"content"</span>:null}],<span class="hljs-string">"metadata"</span>:null,<span class="hljs-string">"timestamp"</span>:<span class="hljs-string">"xxx"</span>}
// [行动] 执行工具 → {<span class="hljs-string">"type"</span>:<span class="hljs-string">"tool_result"</span>,<span class="hljs-string">"id"</span>:<span class="hljs-string">"call_xxx"</span>,<span class="hljs-string">"name"</span>:<span class="hljs-string">"getWeather"</span>,<span class="hljs-string">"output"</span>:[{<span class="hljs-string">"type"</span>:<span class="hljs-string">"text"</span>,<span class="hljs-string">"text"</span>:<span class="hljs-string">"\"</span>北京：晴天，气温 <span class="hljs-number">25</span> ℃\<span class="hljs-string">""</span>}],<span class="hljs-string">"metadata"</span>:{}}
// [推理] 智能体开始思考...
// [推理] 推理结果：{<span class="hljs-string">"id"</span>:<span class="hljs-string">"xxx"</span>,<span class="hljs-string">"name"</span>:<span class="hljs-string">"WeatherAssistant"</span>,<span class="hljs-string">"role"</span>:<span class="hljs-string">"ASSISTANT"</span>,<span class="hljs-string">"content"</span>:[{<span class="hljs-string">"type"</span>:<span class="hljs-string">"text"</span>,<span class="hljs-string">"text"</span>:<span class="hljs-string">"北京今天天气晴朗，气温为25℃。建议外出时注意防晒，祝您拥有愉快的一天！"</span>}],<span class="hljs-string">"metadata"</span>:null,<span class="hljs-string">"timestamp"</span>:<span class="hljs-string">"xxx"</span>}
// [推理] 已获取信息，生成回答
// 回答：北京今天天气晴朗，气温为<span class="hljs-number">25</span>℃。建议外出时注意防晒，祝您拥有愉快的一天！
</code></pre>
<h3 data-id="heading-15">3. 会话持久化</h3>
<p>保存和恢复 ReActAgent 的状态：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 创建 ReActAgent</span>
ReActAgent agent = ReActAgent<span class="hljs-selector-class">.builder</span>()
    <span class="hljs-selector-class">.name</span>("PersistentAgent")
    <span class="hljs-selector-class">.model</span>(DashScopeChatModel.builder()
        <span class="hljs-selector-class">.apiKey</span>(System.getenv("DASHSCOPE_API_KEY"))
        <span class="hljs-selector-class">.modelName</span>("qwen3-max")
        <span class="hljs-selector-class">.build</span>())
    <span class="hljs-selector-class">.memory</span>(new InMemoryMemory())
    <span class="hljs-selector-class">.build</span>();
<span class="hljs-comment">// 保存会话</span>
SessionManager<span class="hljs-selector-class">.forSessionId</span>("session-<span class="hljs-number">001</span>")
    <span class="hljs-selector-class">.withJsonSession</span>(Path.of("./sessions"))
    <span class="hljs-selector-class">.addComponent</span>(agent)
    <span class="hljs-selector-class">.saveSession</span>();
<span class="hljs-comment">// 下次启动时恢复</span>
SessionManager<span class="hljs-selector-class">.forSessionId</span>("session-<span class="hljs-number">001</span>")
    <span class="hljs-selector-class">.withJsonSession</span>(Path.of("./sessions"))
    <span class="hljs-selector-class">.addComponent</span>(agent)
    <span class="hljs-selector-class">.loadIfExists</span>();
<span class="hljs-comment">// agent 现在恢复到了之前的状态，可以继续对话</span>
</code></pre>
<h3 data-id="heading-16">4. 结构化输出</h3>
<p>让 ReActAgent 返回类型安全的结构化数据：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 定义输出结构</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeatherReport</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">String</span> city;
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> temperature;
    <span class="hljs-keyword">public</span> <span class="hljs-type">String</span> condition;
    <span class="hljs-keyword">public</span> List&lt;<span class="hljs-type">String</span>&gt; suggestions;
}
<span class="hljs-comment">// ReActAgent 调用时指定输出类型</span>
Msg response = agent.<span class="hljs-built_in">call</span>(
    Msg.<span class="hljs-built_in">builder</span>()
                .<span class="hljs-built_in">role</span>(MsgRole.USER)
                .<span class="hljs-built_in">content</span>(TextBlock.<span class="hljs-built_in">builder</span>()
                        .<span class="hljs-built_in">text</span>(<span class="hljs-string">"分析北京的天气并给出建议"</span>)
                        .<span class="hljs-built_in">build</span>())
                .<span class="hljs-built_in">build</span>(),
    WeatherReport.<span class="hljs-keyword">class</span>  <span class="hljs-comment">// 指定结构化输出类型</span>
).<span class="hljs-built_in">block</span>();
<span class="hljs-comment">// 提取结构化数据</span>
WeatherReport report = response.<span class="hljs-built_in">getStructuredData</span>(WeatherReport.<span class="hljs-keyword">class</span>);
System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"城市: "</span> + report.city);
System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"温度: "</span> + report.temperature);
</code></pre>
<p>避免了文本解析的不确定性，编译期就能发现类型错误。</p>
<h3 data-id="heading-17">5. 多智能体协作</h3>
<p>多个 ReActAgent 可以通过 Pipeline 协作：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 创建模型配置</span>
DashScopeChatModel model = DashScopeChatModel<span class="hljs-selector-class">.builder</span>()
    <span class="hljs-selector-class">.apiKey</span>(System.getenv("DASHSCOPE_API_KEY"))
    <span class="hljs-selector-class">.modelName</span>("qwen3-max")
    <span class="hljs-selector-class">.build</span>();
<span class="hljs-comment">// 创建多个 ReActAgent</span>
ReActAgent dataCollector = ReActAgent<span class="hljs-selector-class">.builder</span>()
    <span class="hljs-selector-class">.name</span>("DataCollector")
    <span class="hljs-selector-class">.model</span>(model)
    <span class="hljs-selector-class">.build</span>();
ReActAgent dataAnalyzer = ReActAgent<span class="hljs-selector-class">.builder</span>()
    <span class="hljs-selector-class">.name</span>("DataAnalyzer")
    <span class="hljs-selector-class">.model</span>(model)
    <span class="hljs-selector-class">.build</span>();
ReActAgent reportGenerator = ReActAgent<span class="hljs-selector-class">.builder</span>()
    <span class="hljs-selector-class">.name</span>("ReportGenerator")
    <span class="hljs-selector-class">.model</span>(model)
    <span class="hljs-selector-class">.build</span>();
<span class="hljs-comment">// 顺序执行：智能体依次处理</span>
Msg result = Pipelines<span class="hljs-selector-class">.sequential</span>(
    List.of(dataCollector, dataAnalyzer, reportGenerator),
    inputMsg
)<span class="hljs-selector-class">.block</span>();
<span class="hljs-comment">// 并行执行：多个智能体同时处理</span>
List&lt;Msg&gt; results = Pipelines<span class="hljs-selector-class">.fanout</span>(
    List.of(dataCollector, dataAnalyzer, reportGenerator), 
    inputMsg
)<span class="hljs-selector-class">.block</span>();
</code></pre>
<h2 data-id="heading-18">Roadmap</h2>
<p>AgentScope Java 自 2025 年 9 月开源以来，当前 v0.2 版本已具备 ReActAgent 核心能力。</p>
<p>我们计划于 11 月底发布 v1.0 版本，届时将新增 RAG、Plan、Tracing、Evaluation 及 Studio 等全套功能，标志着框架正式生产可用；Runtime v1.0 也将同步上线，提供涵盖安全沙箱、A2A Agent 在内的企业级落地方案。随后在 12 月，我们将进一步推出基于 ReMe 的上下文管理与基于 Trinity-RFT 的强化学习最佳实践。</p>
<p>在技术演进层面，我们正持续探索更高效、智能的上下文工程与多 Agent 协同范式，致力于支撑更强大的 AI 应用构建。此外，针对 Agent 流量呈现的“二八定律”特征（头部 20% 的 Agent 承载了 80% 的流量），我们在架构上全力推进 Serverless 化，通过实现毫秒级冷启动与混合部署，帮助开发者在应对高并发的同时，显著降低部署成本并提升效率。</p>
<h2 data-id="heading-19">未完待续</h2>
<p>本文作为 AgentScope Java 系列推文的首篇，受篇幅限制只能抛砖引玉，在接下来还会有更多的干货：</p>
<ol>
<li>AgentScope Runtime：帮助开发者实现 Agent 应用从 1 到 100，提供工具运行沙箱、A2A 协议、远程部署等强大能力。</li>
<li>Agent 开发范式讨论：Workflow or Agentic？AgentScope 基于狼人杀游戏的 Agent 实践分享。</li>
<li>Meta Tool：面对日益膨胀的 Tool Definition，AgentScope 的解决方案。</li>
<li>Plan：使 Agent 能够自主拆解复杂任务并系统性地执行。</li>
</ol>
<p>如果你觉得 AgentScope Java 不错，欢迎给我们的项目 Star~<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fagentscope-ai%2Fagentscope-java" target="_blank" title="https://github.com/agentscope-ai/agentscope-java" ref="nofollow noopener noreferrer">github.com/agentscope-…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OpenDeRisk：AI 原生风险智能系统 ——7*24H 应用系统AI数字运维助手(AI-SRE)]]></title>    <link>https://juejin.cn/post/7588745319400243200</link>    <guid>https://juejin.cn/post/7588745319400243200</guid>    <pubDate>2025-12-29T00:38:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588745319400243200" data-draft-id="7537711310580105216" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OpenDeRisk：AI 原生风险智能系统 ——7*24H 应用系统AI数字运维助手(AI-SRE)"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-29T00:38:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="YL_jia"/> <meta itemprop="url" content="https://juejin.cn/user/1467226241383211"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OpenDeRisk：AI 原生风险智能系统 ——7*24H 应用系统AI数字运维助手(AI-SRE)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1467226241383211/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    YL_jia
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T00:38:33.000Z" title="Mon Dec 29 2025 00:38:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">OpenDeRisk：AI 驱动的智能运维根因分析系统实战指南</h2>
<blockquote>
<p>在系统故障导致百万级损失的数字化时代，<strong>OpenDeRisk 用多代理协作与可视化证据链，让根因诊断从“大海捞针”变为“精准导航”</strong>。</p>
</blockquote>
<h3 data-id="heading-1">引言：当故障诊断遇上多代理AI革命</h3>
<p>凌晨 3 点的告警短信、持续 6 小时的故障定位、跨团队会议上的互相推诿——传统运维的根因分析（RCA）常陷入<strong>数据孤岛</strong>与<strong>经验依赖</strong>的困局。某互联网公司的统计显示，超过 65% 的故障恢复时间被消耗在问题定位环节。而 OpenDeRisk 作为开源 AI 运维系统，通过多代理协作架构实现了<strong>日志分析-&gt;代码追踪-&gt;证据链可视化</strong>的自动化闭环，将 RCA 效率提升 10 倍以上。本文将带您深入这一颠覆性工具的技术内核与落地实践。</p>
<hr/>
<h3 data-id="heading-2">一、核心功能解析：多代理协作如何重塑故障诊断</h3>
<h4 data-id="heading-3">1. 架构全景：五大代理的协同作战</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
A[Data-Agent] --&gt;|原始日志/跟踪数据| B(SRE-Agent)
B --&gt;|问题假设| C(Code-Agent)
C --&gt;|动态生成诊断代码| D(Vis-Agent)
D --&gt;|可视化证据链| E(ReportAgent)
E --&gt;|可执行报告| F[用户]
</code></pre>
<p><em>图：OpenDeRisk 多代理协作流程图，实现从数据到决策的自动化</em></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65f3a33084f040f2b3ac37531503e2ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWUxfamlh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767573512&amp;x-signature=NrW8FvKerV5%2FqQyrZlp%2F9gE%2FZ%2Fc%3D" alt="image.png" loading="lazy"/>
各代理的核心职责：</p>
<ul>
<li><strong>SRE-Agent</strong>：问题初步定位，生成根因假设（基于历史故障模式库）</li>
<li><strong>Code-Agent</strong>：动态生成 Python 诊断脚本，验证假设</li>
<li><strong>Data-Agent</strong>：对接日志系统（ELK）、追踪系统（Jaeger）、监控数据（Prometheus）</li>
<li><strong>Vis-Agent</strong>：通过 D3.js 渲染交互式证据链视图</li>
<li><strong>ReportAgent</strong>：生成包含修复建议的 Markdown/PDF 报告</li>
</ul>
<h4 data-id="heading-4">2. 突破性能力：从“猜测”到“实证”</h4>
<ul>
<li><strong>深度研究 RCA</strong><br/>
融合日志模式识别、代码逻辑回溯、资源时序分析三重视角，避免单一数据源误判</li>
<li><strong>动态代码生成</strong><br/>
当检测到数据库连接池耗尽时，Code-Agent 自动生成连接泄漏检测脚本：
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 动态生成的诊断脚本示例</span>
<span class="hljs-keyword">from</span> dbtools <span class="hljs-keyword">import</span> analyze_connection_leak
leak_report = analyze_connection_leak(
    log_path=<span class="hljs-string">"/var/log/app/db.log"</span>, 
    trace_id=<span class="hljs-string">"req-0x7fd3a"</span>
)
<span class="hljs-built_in">print</span>(leak_report.top_candidates(<span class="hljs-number">3</span>))
</code></pre>
</li>
<li><strong>证据链可视化</strong><br/>
将 200+ 条分散日志、40 个服务调用节点，聚合为单张时间轴交互视图：</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/335aad20e6ef4d4e9861f645b584bef6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWUxfamlh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767573512&amp;x-signature=hL7Vsr5Yjv3sK7T5yFNNQ2coKSo%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3682c2bf61147b2bbc69220e6c86c36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWUxfamlh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767573512&amp;x-signature=IGNXCSKgKVRJs3dMvgVqrxpq9Ik%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-5">3. 企业级扩展能力</h4>
<ul>
<li><strong>金融级合规</strong>：审计日志留存 7 年，支持 GDPR/等保 3.0</li>
<li><strong>插件化架构</strong>：可扩展支持 Kafka/Pulsar 等消息中间件诊断</li>
<li><strong>多云适配</strong>：已验证适配 AWS CloudWatch、Azure Monitor、GCP Stackdriver</li>
</ul>
<hr/>
<h3 data-id="heading-6">二、安装部署实战：5 种模式应对不同场景</h3>
<h4 data-id="heading-7">1. 环境规划建议</h4>









































<table><thead><tr><th><strong>部署模式</strong></th><th>适用场景</th><th>硬件要求</th><th>网络要求</th></tr></thead><tbody><tr><td>纯代理模式</td><td>初创团队/POC</td><td>4C8G，无 GPU</td><td>可访问 DeepSeek/OpenAI API</td></tr><tr><td>本地轻量模型</td><td>内网环境</td><td>8C32G + 1*T4(16GB)</td><td>隔离部署</td></tr><tr><td>本地全量模型</td><td>高安全要求</td><td>16C64G + 2*A10(24GB)</td><td>万兆内网</td></tr><tr><td>VLLM 加速集群</td><td>百节点以上大集群</td><td>32C128G + 4*L40S(48GB)</td><td>RDMA 网络</td></tr><tr><td>混合边缘-云</td><td>工厂/物联网</td><td>边缘节点 4C8G + 含 GPU 工控机</td><td>5G 专网</td></tr></tbody></table>
<h4 data-id="heading-8">2. 关键步骤详解（以本地 QwQ-32B 模型为例）</h4>
<p><strong>Step 1：依赖安装与模型预热</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 UV 工具链（替代 pip）</span>
curl -LsSf https://astral.sh/uv/install.sh | sh
<span class="hljs-built_in">source</span> ~/.bashrc

<span class="hljs-comment"># 克隆代码</span>
git <span class="hljs-built_in">clone</span> https://github.com/derisk-ai/derisk.git --depth=1

<span class="hljs-comment"># 安装 CUDA 依赖包（需 24GB+ 显存）</span>
uv <span class="hljs-built_in">sync</span> --all-packages \
  --extra <span class="hljs-string">"cuda121"</span> \
  --extra <span class="hljs-string">"hf"</span> \
  --extra <span class="hljs-string">"quant_bnb"</span> \
  --extra <span class="hljs-string">"rag"</span>
</code></pre>
<p><strong>Step 2：模型配置文件定制</strong><br/>
编辑 <code>configs/derisk-local-qwen.toml</code>：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-section">[models]</span>
<span class="hljs-section">[[models.llms]]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"Qwen/QwQ-32B"</span>
<span class="hljs-attr">provider</span> = <span class="hljs-string">"hf"</span>
<span class="hljs-attr">quantize</span> = <span class="hljs-string">"bnb_8bit"</span>  <span class="hljs-comment"># 8 位量化降低显存占用</span>

<span class="hljs-section">[service.web.database]</span>
<span class="hljs-attr">type</span> = <span class="hljs-string">"mysql"</span>   <span class="hljs-comment"># 生产环境推荐 MySQL</span>
<span class="hljs-attr">host</span> = <span class="hljs-string">"10.0.0.5"</span>
<span class="hljs-attr">port</span> = <span class="hljs-number">3306</span>
<span class="hljs-attr">user</span> = <span class="hljs-string">"derisk"</span>
<span class="hljs-attr">password</span> = <span class="hljs-string">"加密密码"</span>
</code></pre>
<p><strong>Step 3：服务启动与验证</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动后台服务</span>
uv run derisk start webserver --config configs/derisk-local-qwen.toml &amp;

<span class="hljs-comment"># 检查健康状态</span>
curl http://localhost:7777/healthcheck
<span class="hljs-comment"># 预期输出：{"status":"OK","model":"QwQ-32B"}</span>
</code></pre>
<h4 data-id="heading-9">3. 常见避坑指南</h4>
<ul>
<li><strong>GPU 显存不足</strong>：启用 <code>quantize = "bnb_4bit"</code> 或切换 smaller 模型</li>
<li><strong>依赖冲突</strong>：严格使用 <code>uv.lock</code> 锁定版本</li>
<li><strong>模型下载超时</strong>：手动下载后放置到 <code>/data/models/</code> 路径</li>
</ul>
<hr/>
<h3 data-id="heading-10">三、企业实战案例：从故障止损到业务增值</h3>
<h4 data-id="heading-11">案例 1：互联网金融平台 API 异常诊断</h4>
<p><strong>背景</strong>：某支付网关每两周发生一次“神秘”的 500 错误，持续 2 年未根治<br/>
<strong>OpenDeRisk 方案</strong>：</p>
<ol>
<li>
<p><strong>Data-Agent 接入</strong>：</p>
<ul>
<li>日志源：ELK（200GB/日）</li>
<li>追踪源：Jaeger（采样率 100%）</li>
<li>指标源：Prometheus（1s 粒度）</li>
</ul>
</li>
<li>
<p><strong>多代理协作分析</strong>：
sequenceDiagram
SRE-Agent-&gt;&gt;Code-Agent： 检测到 MySQL 连接峰值触发<br/>
Code-Agent-&gt;&gt;Data-Agent： 请求获取关联的 thread dump<br/>
Data-Agent-&gt;&gt;Vis-Agent： 生成线程阻塞热力图<br/>
Vis-Agent-&gt;&gt;ReportAgent： 定位到 Druid 连接池校验死锁</p>
</li>
<li>
<p><strong>成效</strong>：</p>
<ul>
<li>诊断时间从 6 人日 → <strong>8 分钟</strong></li>
<li>避免季度性故障，减少损失 <strong>¥1200 万/年</strong></li>
</ul>
</li>
</ol>
<h4 data-id="heading-12">案例 2：智能工厂预测性维护</h4>
<p><strong>背景</strong>：汽车电池产线设备突发停机，月均损失 ¥500 万<br/>
<strong>OpenDeRisk 增强方案</strong>：</p>
<ol>
<li>扩展 <strong>PLC-Agent</strong> 对接西门子 S7-1500 控制器</li>
<li>集成振动传感器实时流（5000 点/秒）</li>
<li>定制诊断规则：
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 在 packages/custom_agents/plc_agent.py</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">detect_axis_misalignment</span>(<span class="hljs-params">vibration_data</span>):
    <span class="hljs-keyword">if</span> spectral_entropy(vibration_data) &gt; <span class="hljs-number">2.5</span>:
        <span class="hljs-keyword">return</span> RiskLevel.CRITICAL, “主轴不对中风险”
</code></pre>
</li>
</ol>
<p><strong>成效</strong>：</p>
<ul>
<li>故障预测准确率 <strong>92.3%</strong>（原 65%）</li>
<li>维护成本下降 <strong>40%</strong>，获省智能制造补贴</li>
</ul>
<hr/>
<h3 data-id="heading-13">四、二次开发指南：打造领域专属诊断引擎</h3>
<h4 data-id="heading-14">1. 定制化扩展方向</h4>






























<table><thead><tr><th><strong>扩展点</strong></th><th>技术栈</th><th>案例场景</th></tr></thead><tbody><tr><td>新增数据源 Agent</td><td>Python + gRPC</td><td>接入 SAP PI 消息总线</td></tr><tr><td>强化诊断规则</td><td>YAML 规则引擎</td><td>金融合规性检查</td></tr><tr><td>可视化模板</td><td>React + D3.js</td><td>生产排程甘特图</td></tr><tr><td>报告集成</td><td>Markdown 模板</td><td>等保 2.0 审计报告</td></tr></tbody></table>
<h4 data-id="heading-15">2. 开发示例：快速添加 Zabbix Agent</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 在 packages/data_agents/zabbix_agent.py</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ZabbixDataAgent</span>(<span class="hljs-title class_ inherited__">DataAgentBase</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_metrics</span>(<span class="hljs-params">self, item_keys: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>], timeframe: TimeRange</span>):
        <span class="hljs-keyword">from</span> pyzabbix <span class="hljs-keyword">import</span> ZabbixAPI
        zapi = ZabbixAPI(self.config[<span class="hljs-string">"url"</span>])
        zapi.login(self.config[<span class="hljs-string">"user"</span>], self.config[<span class="hljs-string">"password"</span>])
        <span class="hljs-keyword">return</span> zapi.history.get(itemKeys=item_keys, 
                                time_from=timeframe.start,
                                time_till=timeframe.end)
</code></pre>
<h4 data-id="heading-16">3. 效能调优技巧</h4>
<ul>
<li><strong>推理加速</strong>：切换 vLLM 后端，吞吐提升 4 倍</li>
<li><strong>内存优化</strong>：启用 <code>--quant_bnb</code> 量化，显存需求降低 50%</li>
<li><strong>缓存策略</strong>：对历史诊断结果建立向量索引（ChromaDB）</li>
</ul>
<hr/>
<h3 data-id="heading-17">五、结语：AI 运维的下一个十年</h3>
<p>OpenDeRisk 通过 <strong>“多代理协作”</strong> 与 <strong>“可视化证据链”</strong> 两大创新，解决了传统 RCA 中的三大断层：</p>
<ol>
<li><strong>数据断层</strong>：打破日志/追踪/代码的数据孤岛</li>
<li><strong>知识断层</strong>：将专家经验转化为可复用的代理策略</li>
<li><strong>信任断层</strong>：可视化证据链取代“黑盒诊断”</li>
</ol>
<p>随着 2025 年其路线图中 <strong>“因果推断引擎”</strong> 与 <strong>“自监督诊断”</strong> 模块的发布，我们有望看到 AI 运维系统从“辅助分析”走向“自主决策”。正如某互联网公司 CTO 所言：<strong>“当故障诊断从小时级进入秒级，运维团队的使命将从‘救火’转向‘防火’”</strong>。</p>
<blockquote>
<p>额外资源：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fderisk-ai%2Fdocs-zh" target="_blank" title="https://github.com/derisk-ai/docs-zh" ref="nofollow noopener noreferrer">OpenDeRisk 中文文档</a></li>
<li>企业实战案例集（含配置模板）</li>
<li>社区 Slack 频道：获取最新 Agent 扩展包</li>
</ul>
</blockquote>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL EXPLAIN 执行计划分析：能否查看 JOIN 关联顺序]]></title>    <link>https://juejin.cn/post/7588570963294453803</link>    <guid>https://juejin.cn/post/7588570963294453803</guid>    <pubDate>2025-12-29T05:18:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588570963294453803" data-draft-id="7588411503122366500" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL EXPLAIN 执行计划分析：能否查看 JOIN 关联顺序"/> <meta itemprop="keywords" content="后端,数据库,MySQL"/> <meta itemprop="datePublished" content="2025-12-29T05:18:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Cosolar"/> <meta itemprop="url" content="https://juejin.cn/user/184373686834391"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL EXPLAIN 执行计划分析：能否查看 JOIN 关联顺序
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/184373686834391/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Cosolar
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T05:18:09.000Z" title="Mon Dec 29 2025 05:18:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你们知道 <code>EXPLAIN</code> 是否能看出 MySQL 的 JOIN 关联顺序？ 结论是：<strong>完全可以</strong>，而且 <code>EXPLAIN</code> 是查看、分析 MySQL JOIN 关联顺序的<strong>核心、最常用手段</strong>，没有之一。</p>
<hr/>
<h2 data-id="heading-0">一、核心结论：EXPLAIN 中 JOIN 关联顺序的核心规则</h2>
<h3 data-id="heading-1">✅ 规则1：<code>EXPLAIN</code> 结果的<strong>行展示顺序</strong> = MySQL 实际执行的 JOIN 关联顺序</h3>
<p><code>EXPLAIN</code> 执行后会返回一个结果集（多行数据），<strong>MySQL 是「从下往上」执行 JOIN 关联</strong>的，这个顺序是绝对的核心，记住这个口诀：</p>
<p><code>EXPLAIN</code> 结果<strong>越靠后的行</strong>，是 MySQL 执行 JOIN 时<strong>先访问的表</strong>（驱动表）；</p>
<p><code>EXPLAIN</code> 结果<strong>越靠前的行</strong>，是 MySQL 执行 JOIN 时<strong>后访问的表</strong>（被驱动表）。</p>
<h3 data-id="heading-2">✅ 规则2：驱动表 &amp; 被驱动表的定义（理解关联顺序的前提）</h3>
<ul>
<li><strong>驱动表 (driving table)</strong> ：JOIN 关联时<strong>先被加载、先被扫描</strong>的表，MySQL 会用驱动表的每条数据，去匹配另一张表的数据；</li>
<li><strong>被驱动表 (driven table)</strong> ：JOIN 关联时<strong>后被加载、被匹配</strong>的表，也叫「匹配表」；</li>
<li>驱动表的选择，是 MySQL 优化器的核心逻辑之一，<strong>小表（数据量少、过滤后结果集小）优先作为驱动表</strong>，这是最优的 JOIN 执行策略。</li>
</ul>
<hr/>
<h2 data-id="heading-3">二、最直观案例：一眼看懂 JOIN 关联顺序</h2>
<h3 data-id="heading-4">案例表准备</h3>
<p>有两张常见业务表，做 JOIN 查询：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 订单表（数据量较大，假设10万条）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `<span class="hljs-keyword">order</span>` (
  id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
  user_id <span class="hljs-type">INT</span>,
  order_no <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">32</span>),
  KEY idx_user_id (user_id)
);
<span class="hljs-comment">-- 用户表（数据量较小，假设1万条）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `<span class="hljs-keyword">user</span>` (
  id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
  name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">32</span>),
  age <span class="hljs-type">INT</span>
);
</code></pre>
<h3 data-id="heading-5">执行 JOIN 查询+EXPLAIN</h3>
<pre><code class="hljs language-sql" lang="sql">EXPLAIN <span class="hljs-keyword">SELECT</span> o.<span class="hljs-operator">*</span>, u.name <span class="hljs-keyword">FROM</span> `<span class="hljs-keyword">order</span>` o <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> `<span class="hljs-keyword">user</span>` u <span class="hljs-keyword">ON</span> o.user_id <span class="hljs-operator">=</span> u.id;
</code></pre>
<h3 data-id="heading-6"><code>EXPLAIN</code> 结果（核心关注 <code>table</code> 列）</h3>
<p>假设 <code>EXPLAIN</code> 返回 <strong>2行结果</strong>，<code>table</code> 列展示如下：</p>


























<table><thead><tr><th>id</th><th>select_type</th><th>table</th><th>type</th><th>...</th></tr></thead><tbody><tr><td>1</td><td>SIMPLE</td><td>o</td><td>ALL</td><td>...</td></tr><tr><td>1</td><td>SIMPLE</td><td>u</td><td>ref</td><td>...</td></tr></tbody></table>
<h3 data-id="heading-7">关联顺序解读</h3>
<p><code>EXPLAIN</code> 结果里，行1是表 <code>o</code>（order）、行2是表 <code>u</code>（user），根据「<strong>从下往上执行</strong>」的规则：</p>
<p>✅ MySQL 实际执行顺序：<strong>先查 user 表（驱动表） → 再查 order 表（被驱动表）</strong></p>
<p>补充：哪怕你写的是 <code>order LEFT JOIN user</code>，MySQL 优化器会自动调整顺序，因为 user 是小表，做驱动表效率更高！</p>
<hr/>
<h2 data-id="heading-8">三、EXPLAIN 中判断 JOIN 的两个核心关键字段（必看）</h2>
<p><code>EXPLAIN</code> 的结果有很多列，<strong>判断是否是 JOIN 查询、以及 JOIN 关联的匹配方式</strong>，只需要重点看 2 个关键字段，缺一不可：</p>
<h3 data-id="heading-9">✅ 字段1：<code>type</code> 列 - 关联匹配的「访问类型」</h3>
<p><code>type</code> 列代表 MySQL 对表的<strong>访问/匹配方式</strong>，<strong>只要是 JOIN 查询，被驱动表的 type 字段一定会出现</strong> <strong><code>ref</code></strong> <strong>/</strong> <strong><code>eq_ref</code></strong> <strong>这两个值之一</strong>，这是 JOIN 的「身份标识」。</p>
<ul>
<li><code>eq_ref</code>：最优的 JOIN 匹配，<strong>一对一</strong>匹配（比如关联主键/唯一索引），性能极高；</li>
<li><code>ref</code>：非常好的 JOIN 匹配，<strong>多对一</strong>匹配（比如关联普通索引），性能也很好；</li>
</ul>
<p>补充：如果 JOIN 的被驱动表 <code>type</code> 是 <code>ALL</code>，说明是「笛卡尔积匹配/全表扫描匹配」，是性能极差的 JOIN，必须优化（加索引）。</p>
<h3 data-id="heading-10">✅ 字段2：<code>possible_keys</code>/<code>key</code> 列 - JOIN 用的索引</h3>
<ul>
<li><code>possible_keys</code>：MySQL 认为<strong>可以用来做 JOIN 关联</strong>的索引（候选索引）；</li>
<li><code>key</code>：MySQL 最终<strong>实际选用的 JOIN 关联索引</strong>（核心字段）；</li>
</ul>
<p>关键优化点：如果 JOIN 查询的 <code>key</code> 列是 <code>NULL</code>，说明 MySQL 没有用到任何索引做关联，就是上面说的「全表扫描 JOIN」，一定要给 JOIN 的关联字段（如 <code>o.user_id</code>/<code>u.id</code>）加索引。</p>
<hr/>
<h2 data-id="heading-11">四、多表 JOIN 场景：3表/多表的关联顺序怎么看？</h2>
<p>如果是 3 张及以上表的 JOIN，规则<strong>完全不变</strong>，还是遵循：</p>
<p><code>EXPLAIN</code> 结果 <strong>从下往上</strong> 执行，<strong>后行 = 先行执行（驱动表），前行 = 后执行（被驱动表）</strong></p>
<h3 data-id="heading-12">案例：3表 JOIN</h3>
<pre><code class="hljs language-sql" lang="sql">EXPLAIN <span class="hljs-keyword">SELECT</span> o.<span class="hljs-operator">*</span>, u.name, g.goods_name 
<span class="hljs-keyword">FROM</span> `<span class="hljs-keyword">order</span>` o 
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> `<span class="hljs-keyword">user</span>` u <span class="hljs-keyword">ON</span> o.user_id <span class="hljs-operator">=</span> u.id
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> `goods` g <span class="hljs-keyword">ON</span> o.goods_id <span class="hljs-operator">=</span> g.id;
</code></pre>
<h3 data-id="heading-13"><code>EXPLAIN</code> 结果（table列）：3行</h3>
<p>行1 → table: o</p>
<p>行2 → table: g</p>
<p>行3 → table: u</p>
<h3 data-id="heading-14">实际执行顺序</h3>
<p><strong>第一步</strong>：先访问 <code>u</code> 表（最下行，驱动表1）</p>
<p><strong>第二步</strong>：用 <code>u</code> 表的数据关联访问 <code>g</code> 表（中间行，被驱动表1、驱动表2）</p>
<p><strong>第三步</strong>：用 <code>u+g</code> 关联的结果，关联访问 <code>o</code> 表（最上行，被驱动表2）</p>
<p>总结：不管多少表 JOIN，只需要把 <code>EXPLAIN</code> 的结果行<strong>倒序看</strong>，就是完整的执行顺序！</p>
<hr/>
<h2 data-id="heading-15">五、MySQL 会不会「自己调整 JOIN 关联顺序」？</h2>
<h3 data-id="heading-16">✅ 重要结论：<strong>会的！而且是常态！</strong></h3>
<p>你在 SQL 语句中<strong>书写的 JOIN 表顺序</strong>，<strong>不等于</strong> MySQL 实际执行的 JOIN 顺序！</p>
<h3 data-id="heading-17">核心原因：MySQL 有「JOIN 优化器（关联顺序优化）」</h3>
<p>MySQL 的优化器会基于「<strong>成本估算</strong>」，自动调整 JOIN 的关联顺序，核心原则是：</p>
<p><strong>优先选择「小表/过滤后结果集最小的表」作为驱动表</strong></p>
<p>因为驱动表越小，需要循环匹配的次数越少，JOIN 的整体执行效率越高。</p>
<p>比如你写的是 <code>大表 JOIN 小表</code>，MySQL 优化器会自动调整为 <code>小表 JOIN 大表</code>，这也是为什么我们不用刻意纠结 SQL 中 JOIN 的书写顺序的原因。</p>
<hr/>
<h2 data-id="heading-18">六、如何强制 MySQL 按照「我写的顺序」执行 JOIN？</h2>
<p>如果某些特殊场景下，你确定自己写的 JOIN 顺序比 MySQL 优化器选的更优，想要<strong>禁用优化器的关联顺序调整</strong>，强制按 SQL 书写顺序执行 JOIN，有 2 种可靠方法：</p>
<h3 data-id="heading-19">✅ 方法1：使用 <code>STRAIGHT_JOIN</code> 关键字（推荐，轻量）</h3>
<p><code>STRAIGHT_JOIN</code> 是 <code>JOIN</code> 的「强制顺序版」，功能和 <code>JOIN</code> 完全一致，唯一区别是：<strong>强制 MySQL 按照 SQL 中书写的表顺序执行 JOIN，不做任何调整</strong>。</p>
<p>语法：把 SQL 中的 <code>JOIN</code> 替换成 <code>STRAIGHT_JOIN</code> 即可。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 强制：先查 order 表 → 再查 user 表，完全按书写顺序执行</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> o.<span class="hljs-operator">*</span>, u.name <span class="hljs-keyword">FROM</span> `<span class="hljs-keyword">order</span>` o STRAIGHT_JOIN `<span class="hljs-keyword">user</span>` u <span class="hljs-keyword">ON</span> o.user_id <span class="hljs-operator">=</span> u.id;
</code></pre>
<h3 data-id="heading-20">✅ 方法2：关闭优化器的关联顺序优化（不推荐，全局生效）</h3>
<p>通过设置 MySQL 会话参数关闭优化器，会影响所有查询，谨慎使用：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 关闭关联顺序优化</span>
<span class="hljs-keyword">SET</span> optimizer_switch<span class="hljs-operator">=</span><span class="hljs-string">'join_cache_bka=off'</span>;
<span class="hljs-comment">-- 执行你的 JOIN 查询</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> o.<span class="hljs-operator">*</span>, u.name <span class="hljs-keyword">FROM</span> `<span class="hljs-keyword">order</span>` o <span class="hljs-keyword">JOIN</span> `<span class="hljs-keyword">user</span>` u <span class="hljs-keyword">ON</span> o.user_id <span class="hljs-operator">=</span> u.id;
<span class="hljs-comment">-- 用完建议恢复默认</span>
<span class="hljs-keyword">SET</span> optimizer_switch<span class="hljs-operator">=</span><span class="hljs-string">'join_cache_bka=on'</span>;
</code></pre>
<hr/>
<h2 data-id="heading-21">✨ 全文核心知识点总结（必记）</h2>
<ol>
<li><code>EXPLAIN</code> <strong>可以精准查看</strong> MySQL JOIN 的关联顺序，是核心分析工具；</li>
<li>JOIN 关联顺序核心规则：<code>EXPLAIN</code> 结果 <strong>从下往上执行</strong>，后行是驱动表（先执行），前行是被驱动表（后执行）；</li>
<li>判断 JOIN 的 2 个核心字段：<code>type</code> 列（必为 <code>ref/eq_ref</code>）+ <code>key</code> 列（非 NULL 代表用到关联索引）；</li>
<li>多表 JOIN 规则不变，倒序看 <code>EXPLAIN</code> 结果就是执行顺序；</li>
<li>MySQL 会<strong>自动调整 JOIN 顺序</strong>（小表优先做驱动表），无需手动调整书写顺序；</li>
<li>强制按书写顺序执行：用 <code>STRAIGHT_JOIN</code> 替换 <code>JOIN</code> 即可。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[无界微前端源码解析：路由同步]]></title>    <link>https://juejin.cn/post/7588704463621505043</link>    <guid>https://juejin.cn/post/7588704463621505043</guid>    <pubDate>2025-12-29T07:43:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588704463621505043" data-draft-id="7589159665839423531" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="无界微前端源码解析：路由同步"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-29T07:43:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="借个火er"/> <meta itemprop="url" content="https://juejin.cn/user/2225067265915783"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            无界微前端源码解析：路由同步
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2225067265915783/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    借个火er
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T07:43:11.000Z" title="Mon Dec 29 2025 07:43:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">无界微前端源码解析：路由同步</h2>
<blockquote>
<p>深入分析主子应用路由同步机制，理解 sync 模式的实现原理。</p>
</blockquote>
<h3 data-id="heading-1">路由同步原理</h3>
<p>无界通过 URL query 参数实现主子应用路由同步：</p>
<pre><code class="hljs language-javascript" lang="javascript">主应用 <span class="hljs-attr">URL</span>:
<span class="hljs-attr">https</span>:<span class="hljs-comment">//main.com/home?vue3=%2Fuser%2F123</span>

子应用实际路由:
<span class="hljs-regexp">/user/</span><span class="hljs-number">123</span>
</code></pre>
<h3 data-id="heading-2">同步流程</h3>
<pre><code class="hljs language-bash" lang="bash">┌─────────────────┐     pushState/replaceState     ┌─────────────────┐
│                 │ ─────────────────────────────► │                 │
│   子应用路由     │                                │   主应用 URL    │
│                 │ ◄───────────────────────────── │                 │
└─────────────────┘     浏览器刷新/前进后退         └─────────────────┘
</code></pre>
<h3 data-id="heading-3">子应用 → 主应用</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// packages/wujie-core/src/sync.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">syncUrlToWindow</span>(<span class="hljs-params">iframeWindow: Window</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">const</span> { sync, id, prefix } = iframeWindow.<span class="hljs-property">__WUJIE</span>;
  
  <span class="hljs-comment">// 解析主应用 URL</span>
  <span class="hljs-keyword">let</span> winUrlElement = <span class="hljs-title function_">anchorElementGenerator</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>);
  <span class="hljs-keyword">const</span> queryMap = <span class="hljs-title function_">getAnchorElementQueryMap</span>(winUrlElement);
  
  <span class="hljs-comment">// 非同步模式且 URL 上没有当前 id 的参数，直接返回</span>
  <span class="hljs-keyword">if</span> (!sync &amp;&amp; !queryMap[id]) <span class="hljs-keyword">return</span> (winUrlElement = <span class="hljs-literal">null</span>);
  
  <span class="hljs-comment">// 获取子应用当前路由</span>
  <span class="hljs-keyword">const</span> curUrl = iframeWindow.<span class="hljs-property">location</span>.<span class="hljs-property">pathname</span> + 
                 iframeWindow.<span class="hljs-property">location</span>.<span class="hljs-property">search</span> + 
                 iframeWindow.<span class="hljs-property">location</span>.<span class="hljs-property">hash</span>;
  
  <span class="hljs-comment">// 处理短路径</span>
  <span class="hljs-keyword">let</span> validShortPath = <span class="hljs-string">""</span>;
  <span class="hljs-keyword">if</span> (prefix) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(prefix).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">shortPath</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> longPath = prefix[shortPath];
      <span class="hljs-comment">// 找出最长匹配路径</span>
      <span class="hljs-keyword">if</span> (curUrl.<span class="hljs-title function_">startsWith</span>(longPath) &amp;&amp; 
          (!validShortPath || longPath.<span class="hljs-property">length</span> &gt; prefix[validShortPath].<span class="hljs-property">length</span>)) {
        validShortPath = shortPath;
      }
    });
  }
  
  <span class="hljs-comment">// 同步模式：更新参数</span>
  <span class="hljs-keyword">if</span> (sync) {
    queryMap[id] = <span class="hljs-variable language_">window</span>.<span class="hljs-built_in">encodeURIComponent</span>(
      validShortPath 
        ? curUrl.<span class="hljs-title function_">replace</span>(prefix[validShortPath], <span class="hljs-string">`{<span class="hljs-subst">${validShortPath}</span>}`</span>) 
        : curUrl
    );
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 非同步模式：清理参数</span>
    <span class="hljs-keyword">delete</span> queryMap[id];
  }
  
  <span class="hljs-comment">// 构建新 URL</span>
  <span class="hljs-keyword">const</span> newQuery = <span class="hljs-string">"?"</span> + <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(queryMap)
    .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> key + <span class="hljs-string">"="</span> + queryMap[key])
    .<span class="hljs-title function_">join</span>(<span class="hljs-string">"&amp;"</span>);
  winUrlElement.<span class="hljs-property">search</span> = newQuery;
  
  <span class="hljs-comment">// 更新主应用 URL</span>
  <span class="hljs-keyword">if</span> (winUrlElement.<span class="hljs-property">href</span> !== <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>) {
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">replaceState</span>(<span class="hljs-literal">null</span>, <span class="hljs-string">""</span>, winUrlElement.<span class="hljs-property">href</span>);
  }
  winUrlElement = <span class="hljs-literal">null</span>;
}
</code></pre>
<h3 data-id="heading-4">主应用 → 子应用</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// packages/wujie-core/src/sync.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">syncUrlToIframe</span>(<span class="hljs-params">iframeWindow: Window</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">const</span> { pathname, search, hash } = iframeWindow.<span class="hljs-property">location</span>;
  <span class="hljs-keyword">const</span> { id, url, sync, execFlag, prefix, inject } = iframeWindow.<span class="hljs-property">__WUJIE</span>;

  <span class="hljs-comment">// 只在浏览器刷新或第一次渲染时同步</span>
  <span class="hljs-keyword">const</span> idUrl = sync &amp;&amp; !execFlag ? <span class="hljs-title function_">getSyncUrl</span>(id, prefix) : url;
  
  <span class="hljs-comment">// 排除 href 跳转情况</span>
  <span class="hljs-keyword">const</span> syncUrl = (<span class="hljs-regexp">/^http/</span>.<span class="hljs-title function_">test</span>(idUrl) ? <span class="hljs-literal">null</span> : idUrl) || url;
  <span class="hljs-keyword">const</span> { appRoutePath } = <span class="hljs-title function_">appRouteParse</span>(syncUrl);

  <span class="hljs-keyword">const</span> preAppRoutePath = pathname + search + hash;
  
  <span class="hljs-comment">// 路由不同则同步</span>
  <span class="hljs-keyword">if</span> (preAppRoutePath !== appRoutePath) {
    iframeWindow.<span class="hljs-property">history</span>.<span class="hljs-title function_">replaceState</span>(<span class="hljs-literal">null</span>, <span class="hljs-string">""</span>, inject.<span class="hljs-property">mainHostPath</span> + appRoutePath);
  }
}
</code></pre>
<h3 data-id="heading-5">获取同步 URL</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// packages/wujie-core/src/utils.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getSyncUrl</span>(<span class="hljs-params">id: <span class="hljs-built_in">string</span>, prefix?: { [key: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">string</span> }</span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">const</span> winUrlElement = <span class="hljs-title function_">anchorElementGenerator</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>);
  <span class="hljs-keyword">const</span> queryMap = <span class="hljs-title function_">getAnchorElementQueryMap</span>(winUrlElement);
  
  <span class="hljs-keyword">let</span> syncUrl = queryMap[id] ? <span class="hljs-variable language_">window</span>.<span class="hljs-built_in">decodeURIComponent</span>(queryMap[id]) : <span class="hljs-string">""</span>;
  
  <span class="hljs-comment">// 处理短路径还原</span>
  <span class="hljs-keyword">if</span> (prefix &amp;&amp; syncUrl) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(prefix).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">shortPath</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> longPath = prefix[shortPath];
      syncUrl = syncUrl.<span class="hljs-title function_">replace</span>(<span class="hljs-string">`{<span class="hljs-subst">${shortPath}</span>}`</span>, longPath);
    });
  }
  
  <span class="hljs-keyword">return</span> syncUrl;
}
</code></pre>
<h3 data-id="heading-6">短路径配置</h3>
<p>通过 <code>prefix</code> 配置可以缩短 URL：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">startApp</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'vue3'</span>,
  <span class="hljs-attr">url</span>: <span class="hljs-string">'http://localhost:7300/'</span>,
  <span class="hljs-attr">sync</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">prefix</span>: {
    <span class="hljs-string">'u'</span>: <span class="hljs-string">'/user'</span>,           <span class="hljs-comment">// /user/123 → {u}/123</span>
    <span class="hljs-string">'p'</span>: <span class="hljs-string">'/product/detail'</span>, <span class="hljs-comment">// /product/detail/456 → {p}/456</span>
  },
});
</code></pre>
<p>效果：</p>
<pre><code class="hljs language-ini" lang="ini">原始: ?<span class="hljs-attr">vue3</span>=%<span class="hljs-number">2</span>Fuser%<span class="hljs-number">2</span>F123
短路径: ?<span class="hljs-attr">vue3</span>=%<span class="hljs-number">7</span>Bu%<span class="hljs-number">7</span>D%<span class="hljs-number">2</span>F123
</code></pre>
<h3 data-id="heading-7">History 劫持</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// packages/wujie-core/src/iframe.ts</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">patchIframeHistory</span>(<span class="hljs-params">iframeWindow: Window, appHostPath: <span class="hljs-built_in">string</span>, mainHostPath: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">const</span> history = iframeWindow.<span class="hljs-property">history</span>;
  <span class="hljs-keyword">const</span> rawHistoryPushState = history.<span class="hljs-property">pushState</span>;
  <span class="hljs-keyword">const</span> rawHistoryReplaceState = history.<span class="hljs-property">replaceState</span>;
  
  history.<span class="hljs-property">pushState</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">data: <span class="hljs-built_in">any</span>, title: <span class="hljs-built_in">string</span>, url?: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-comment">// 将子应用路径转换为主应用路径</span>
    <span class="hljs-keyword">const</span> baseUrl = mainHostPath + iframeWindow.<span class="hljs-property">location</span>.<span class="hljs-property">pathname</span> + 
                    iframeWindow.<span class="hljs-property">location</span>.<span class="hljs-property">search</span> + iframeWindow.<span class="hljs-property">location</span>.<span class="hljs-property">hash</span>;
    <span class="hljs-keyword">const</span> mainUrl = <span class="hljs-title function_">getAbsolutePath</span>(url?.<span class="hljs-title function_">replace</span>(appHostPath, <span class="hljs-string">""</span>), baseUrl);
    <span class="hljs-keyword">const</span> ignoreFlag = url === <span class="hljs-literal">undefined</span>;

    <span class="hljs-comment">// 调用原生方法</span>
    rawHistoryPushState.<span class="hljs-title function_">call</span>(history, data, title, ignoreFlag ? <span class="hljs-literal">undefined</span> : mainUrl);
    <span class="hljs-keyword">if</span> (ignoreFlag) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-comment">// 更新 base 标签</span>
    <span class="hljs-title function_">updateBase</span>(iframeWindow, appHostPath, mainHostPath);
    <span class="hljs-comment">// 同步到主应用</span>
    <span class="hljs-title function_">syncUrlToWindow</span>(iframeWindow);
  };
  
  history.<span class="hljs-property">replaceState</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">data: <span class="hljs-built_in">any</span>, title: <span class="hljs-built_in">string</span>, url?: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-comment">// 类似逻辑...</span>
  };
}
</code></pre>
<h3 data-id="heading-8">前进后退监听</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// packages/wujie-core/src/iframe.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">syncIframeUrlToWindow</span>(<span class="hljs-params">iframeWindow: Window</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-comment">// hashchange 事件</span>
  iframeWindow.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"hashchange"</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">syncUrlToWindow</span>(iframeWindow));
  
  <span class="hljs-comment">// popstate 事件</span>
  iframeWindow.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"popstate"</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">syncUrlToWindow</span>(iframeWindow);
  });
}
</code></pre>
<h3 data-id="heading-9">href 跳转处理</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// packages/wujie-core/src/sync.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">processAppForHrefJump</span>(<span class="hljs-params"/>): <span class="hljs-built_in">void</span> {
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"popstate"</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">let</span> winUrlElement = <span class="hljs-title function_">anchorElementGenerator</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>);
    <span class="hljs-keyword">const</span> queryMap = <span class="hljs-title function_">getAnchorElementQueryMap</span>(winUrlElement);
    winUrlElement = <span class="hljs-literal">null</span>;
    
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(queryMap)
      .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">id</span>) =&gt;</span> <span class="hljs-title function_">getWujieById</span>(id))
      .<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">sandbox</span>) =&gt;</span> sandbox)
      .<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">sandbox</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> url = queryMap[sandbox.<span class="hljs-property">id</span>];
        <span class="hljs-keyword">const</span> iframeBody = rawDocumentQuerySelector.<span class="hljs-title function_">call</span>(sandbox.<span class="hljs-property">iframe</span>.<span class="hljs-property">contentDocument</span>, <span class="hljs-string">"body"</span>);
        
        <span class="hljs-comment">// 前进到 href 跳转的页面</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/http/</span>.<span class="hljs-title function_">test</span>(url)) {
          <span class="hljs-keyword">if</span> (sandbox.<span class="hljs-property">degrade</span>) {
            <span class="hljs-title function_">renderElementToContainer</span>(sandbox.<span class="hljs-property">document</span>.<span class="hljs-property">documentElement</span>, iframeBody);
            <span class="hljs-title function_">renderIframeReplaceApp</span>(
              <span class="hljs-variable language_">window</span>.<span class="hljs-built_in">decodeURIComponent</span>(url),
              <span class="hljs-title function_">getDegradeIframe</span>(sandbox.<span class="hljs-property">id</span>).<span class="hljs-property">parentElement</span>,
              sandbox.<span class="hljs-property">degradeAttrs</span>
            );
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-title function_">renderIframeReplaceApp</span>(
              <span class="hljs-variable language_">window</span>.<span class="hljs-built_in">decodeURIComponent</span>(url),
              sandbox.<span class="hljs-property">shadowRoot</span>.<span class="hljs-property">host</span>.<span class="hljs-property">parentElement</span>,
              sandbox.<span class="hljs-property">degradeAttrs</span>
            );
          }
          sandbox.<span class="hljs-property">hrefFlag</span> = <span class="hljs-literal">true</span>;
          
        <span class="hljs-comment">// 从 href 页面后退</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sandbox.<span class="hljs-property">hrefFlag</span>) {
          <span class="hljs-keyword">if</span> (sandbox.<span class="hljs-property">degrade</span>) {
            <span class="hljs-keyword">const</span> { iframe } = <span class="hljs-title function_">initRenderIframeAndContainer</span>(sandbox.<span class="hljs-property">id</span>, sandbox.<span class="hljs-property">el</span>, sandbox.<span class="hljs-property">degradeAttrs</span>);
            <span class="hljs-title function_">patchEventTimeStamp</span>(iframe.<span class="hljs-property">contentWindow</span>, sandbox.<span class="hljs-property">iframe</span>.<span class="hljs-property">contentWindow</span>);
            iframe.<span class="hljs-property">contentWindow</span>.<span class="hljs-property">onunload</span> = <span class="hljs-function">() =&gt;</span> sandbox.<span class="hljs-title function_">unmount</span>();
            iframe.<span class="hljs-property">contentDocument</span>.<span class="hljs-title function_">appendChild</span>(iframeBody.<span class="hljs-property">firstElementChild</span>);
            sandbox.<span class="hljs-property">document</span> = iframe.<span class="hljs-property">contentDocument</span>;
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-title function_">renderElementToContainer</span>(sandbox.<span class="hljs-property">shadowRoot</span>.<span class="hljs-property">host</span>, sandbox.<span class="hljs-property">el</span>);
          }
          sandbox.<span class="hljs-property">hrefFlag</span> = <span class="hljs-literal">false</span>;
        }
      });
  });
}
</code></pre>
<h3 data-id="heading-10">清理非激活应用 URL</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// packages/wujie-core/src/sync.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">clearInactiveAppUrl</span>(<span class="hljs-params"/>): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">let</span> winUrlElement = <span class="hljs-title function_">anchorElementGenerator</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>);
  <span class="hljs-keyword">const</span> queryMap = <span class="hljs-title function_">getAnchorElementQueryMap</span>(winUrlElement);
  
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(queryMap).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">id</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> sandbox = <span class="hljs-title function_">getWujieById</span>(id);
    <span class="hljs-keyword">if</span> (!sandbox) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-comment">// 子应用执行过且已失活才需要清除</span>
    <span class="hljs-keyword">if</span> (sandbox.<span class="hljs-property">execFlag</span> &amp;&amp; sandbox.<span class="hljs-property">sync</span> &amp;&amp; !sandbox.<span class="hljs-property">hrefFlag</span> &amp;&amp; !sandbox.<span class="hljs-property">activeFlag</span>) {
      <span class="hljs-keyword">delete</span> queryMap[id];
    }
  });
  
  <span class="hljs-keyword">const</span> newQuery = <span class="hljs-string">"?"</span> + <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(queryMap)
    .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> key + <span class="hljs-string">"="</span> + <span class="hljs-variable language_">window</span>.<span class="hljs-built_in">decodeURIComponent</span>(queryMap[key]))
    .<span class="hljs-title function_">join</span>(<span class="hljs-string">"&amp;"</span>);
  winUrlElement.<span class="hljs-property">search</span> = newQuery;
  
  <span class="hljs-keyword">if</span> (winUrlElement.<span class="hljs-property">href</span> !== <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>) {
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">replaceState</span>(<span class="hljs-literal">null</span>, <span class="hljs-string">""</span>, winUrlElement.<span class="hljs-property">href</span>);
  }
  winUrlElement = <span class="hljs-literal">null</span>;
}
</code></pre>
<h3 data-id="heading-11">推送 URL</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// packages/wujie-core/src/sync.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">pushUrlToWindow</span>(<span class="hljs-params">id: <span class="hljs-built_in">string</span>, url: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">let</span> winUrlElement = <span class="hljs-title function_">anchorElementGenerator</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>);
  <span class="hljs-keyword">const</span> queryMap = <span class="hljs-title function_">getAnchorElementQueryMap</span>(winUrlElement);
  
  <span class="hljs-comment">// 更新参数</span>
  queryMap[id] = <span class="hljs-variable language_">window</span>.<span class="hljs-built_in">encodeURIComponent</span>(url);
  
  <span class="hljs-keyword">const</span> newQuery = <span class="hljs-string">"?"</span> + <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(queryMap)
    .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> key + <span class="hljs-string">"="</span> + queryMap[key])
    .<span class="hljs-title function_">join</span>(<span class="hljs-string">"&amp;"</span>);
  winUrlElement.<span class="hljs-property">search</span> = newQuery;
  
  <span class="hljs-comment">// 使用 pushState 添加历史记录</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">pushState</span>(<span class="hljs-literal">null</span>, <span class="hljs-string">""</span>, winUrlElement.<span class="hljs-property">href</span>);
  winUrlElement = <span class="hljs-literal">null</span>;
}
</code></pre>
<h3 data-id="heading-12">使用示例</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 开启路由同步</span>
<span class="hljs-title function_">startApp</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'vue3'</span>,
  <span class="hljs-attr">url</span>: <span class="hljs-string">'http://localhost:7300/'</span>,
  <span class="hljs-attr">el</span>: <span class="hljs-string">'#container'</span>,
  <span class="hljs-attr">sync</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 开启同步</span>
  <span class="hljs-attr">prefix</span>: {
    <span class="hljs-string">'u'</span>: <span class="hljs-string">'/user'</span>,
  },
});

<span class="hljs-comment">// 子应用路由变化</span>
<span class="hljs-comment">// /user/123 → 主应用 URL: ?vue3=%7Bu%7D%2F123</span>

<span class="hljs-comment">// 刷新浏览器</span>
<span class="hljs-comment">// 主应用 URL: ?vue3=%7Bu%7D%2F123 → 子应用恢复到 /user/123</span>
</code></pre>
<h3 data-id="heading-13">小结</h3>
<p>无界的路由同步机制：</p>





























<table><thead><tr><th>场景</th><th>处理方式</th></tr></thead><tbody><tr><td>子应用路由变化</td><td>通过 history 劫持同步到主应用 URL</td></tr><tr><td>浏览器刷新</td><td>从主应用 URL 恢复子应用路由</td></tr><tr><td>前进后退</td><td>监听 popstate 事件同步</td></tr><tr><td>href 跳转</td><td>特殊处理，重新渲染 iframe</td></tr><tr><td>应用切换</td><td>清理非激活应用的 URL 参数</td></tr></tbody></table>
<p>核心技巧：</p>
<ol>
<li><strong>URL Query 存储</strong>：子应用路由编码后存入主应用 URL</li>
<li><strong>短路径优化</strong>：通过 prefix 配置缩短 URL</li>
<li><strong>History 劫持</strong>：拦截 pushState/replaceState 实现同步</li>
<li><strong>事件监听</strong>：hashchange 和 popstate 处理前进后退</li>
</ol>
<p>下一篇我们将分析通信机制。</p>
<hr/>
<blockquote>
<p>📦 源码版本：wujie v1.0.22</p>
<p>上一篇：<a href="https://juejin.cn/post/7588570963295633451" target="_blank" title="https://juejin.cn/post/7588570963295633451">JS 隔离</a></p>
<p>下一篇：<a href="https://juejin.cn/post/7588827110506102827" target="_blank" title="https://juejin.cn/post/7588827110506102827">通信机制</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 LangChain 中的 `.pipe()`：构建可组合 AI 应用的核心管道机制]]></title>    <link>https://juejin.cn/post/7588376012122062875</link>    <guid>https://juejin.cn/post/7588376012122062875</guid>    <pubDate>2025-12-29T03:03:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588376012122062875" data-draft-id="7588355695101575177" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解 LangChain 中的 `.pipe()`：构建可组合 AI 应用的核心管道机制"/> <meta itemprop="keywords" content="JavaScript,LangChain"/> <meta itemprop="datePublished" content="2025-12-29T03:03:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无敌的拖拉斯旋风"/> <meta itemprop="url" content="https://juejin.cn/user/951508170179208"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解 LangChain 中的 `.pipe()`：构建可组合 AI 应用的核心管道机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/951508170179208/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无敌的拖拉斯旋风
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T03:03:38.000Z" title="Mon Dec 29 2025 03:03:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在使用 LangChain 构建大模型应用时，你一定见过这样的代码：</p>
<pre><code class="hljs language-ini" lang="ini">
const <span class="hljs-attr">chain</span> = prompt
  .pipe(model)
  .pipe(parser)<span class="hljs-comment">;</span>
</code></pre>
<p>这个看似简单的 <code>.pipe()</code> 方法，其实是 <strong>LangChain 表达式语言（LCEL）的灵魂所在</strong>。它不仅让代码更清晰，还赋予了开发者强大的组合能力。本文将带你彻底掌握 <code>.pipe()</code> 的原理、作用、高级用法以及它在整个 LangChain 生态中的核心地位。</p>
<hr/>
<h2 data-id="heading-0">一、<code>.pipe()</code> 是什么？—— 不只是“连接”，而是“智能流水线”</h2>
<h3 data-id="heading-1">✅ 基本定义</h3>
<p>在 LangChain 中，<code>.pipe()</code> 是 <strong><code>Runnable</code> 接口上的一个方法</strong>，用于将多个可运行单元（如提示模板、大模型、解析器、自定义函数等）<strong>串联成一条数据处理流水线</strong>。</p>
<blockquote>
<p><strong>核心规则</strong>：前一个步骤的输出，自动作为后一个步骤的输入。</p>
</blockquote>
<pre><code class="hljs language-scss" lang="scss">
<span class="hljs-comment">// 数据流向：</span>
<span class="hljs-selector-tag">input</span> → step1 → step2 → step3 → output
        ↑<span class="hljs-selector-class">.pipe</span>()↑<span class="hljs-selector-class">.pipe</span>()↑
</code></pre>
<h3 data-id="heading-2">🌰 最简示例</h3>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatPromptTemplate</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/prompts"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatOpenAI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/openai"</span>;

<span class="hljs-keyword">const</span> prompt = <span class="hljs-title class_">ChatPromptTemplate</span>.<span class="hljs-title function_">fromTemplate</span>(<span class="hljs-string">"你好，{name}！"</span>);
<span class="hljs-keyword">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>();

<span class="hljs-comment">// 构建链</span>
<span class="hljs-keyword">const</span> chain = prompt.<span class="hljs-title function_">pipe</span>(model);

<span class="hljs-comment">// 调用</span>
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> chain.<span class="hljs-title function_">invoke</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">"小明"</span> });
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(response.<span class="hljs-property">content</span>); <span class="hljs-comment">// “你好，小明！”</span>
</code></pre>
<p>这里：</p>
<ul>
<li><code>prompt</code> 接收 <code>{ name: "小明" }</code>，输出消息数组</li>
<li><code>.pipe(model)</code> 将该数组传给模型</li>
<li>模型返回 <code>AIMessage</code></li>
</ul>
<hr/>
<h2 data-id="heading-3">二、<code>.pipe()</code> 的底层机制：为什么它如此强大？</h2>
<h3 data-id="heading-4">🔧 1. 自动包装普通函数</h3>
<p>你甚至可以直接把普通 JavaScript 函数塞进管道：</p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-keyword">const</span> chain = prompt
  .<span class="hljs-title function_">pipe</span>(<span class="hljs-function">(<span class="hljs-params">messages</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"发送给模型的消息："</span>, messages);
    <span class="hljs-keyword">return</span> messages; <span class="hljs-comment">// 必须返回！</span>
  })
  .<span class="hljs-title function_">pipe</span>(model)
  .<span class="hljs-title function_">pipe</span>(<span class="hljs-function">(<span class="hljs-params">aiMessage</span>) =&gt;</span> aiMessage.<span class="hljs-property">content</span>.<span class="hljs-title function_">trim</span>()); <span class="hljs-comment">// 提取纯文本</span>

<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> chain.<span class="hljs-title function_">invoke</span>({ <span class="hljs-attr">input</span>: <span class="hljs-string">"1+1=?"</span> });
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result); <span class="hljs-comment">// "2"</span>
</code></pre>
<blockquote>
<p>💡 LangChain 会自动将 <code>(x) =&gt; x</code> 包装成 <code>Runnable</code>，无需手动实现 <code>.invoke()</code>。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">⚙️ 2. 支持异步与流式（Streaming）</h3>
<p>整个链天然支持异步和流式输出：</p>
<pre><code class="hljs language-arduino" lang="arduino">
<span class="hljs-comment">// 流式逐字输出</span>
<span class="hljs-function"><span class="hljs-keyword">for</span> <span class="hljs-title">await</span> <span class="hljs-params">(<span class="hljs-type">const</span> chunk of await chain.stream({ input: <span class="hljs-string">"讲个笑话"</span> }))</span> </span>{
  process.stdout.<span class="hljs-built_in">write</span>(chunk.content);
}
</code></pre>
<p>只要链中任意环节支持 <code>.stream()</code>（如 <code>ChatModel</code>），整条链就支持流式！</p>
<hr/>
<h3 data-id="heading-6">📦 3. 返回值仍是 <code>Runnable</code> —— 可无限组合</h3>
<p><code>.pipe()</code> 的返回值本身就是一个 <code>Runnable</code>，因此可以：</p>
<ul>
<li>继续 <code>.pipe()</code> 扩展</li>
<li>被其他链复用</li>
<li>作为工具（Tool）嵌入 Agent</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">
const <span class="hljs-attr">baseChain</span> = prompt.pipe(model)<span class="hljs-comment">;</span>
const <span class="hljs-attr">enhancedChain</span> = baseChain.pipe(jsonParser).pipe(validateData)<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h2 data-id="heading-7">三、<code>.pipe()</code> 的典型应用场景</h2>
<h3 data-id="heading-8">场景 1：调试中间结果（开发必备）</h3>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-keyword">const</span> <span class="hljs-title function_">debug</span> = (<span class="hljs-params">label</span>) =&gt; <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[<span class="hljs-subst">${label}</span>]`</span>, data);
  <span class="hljs-keyword">return</span> data;
};

<span class="hljs-keyword">const</span> chain = prompt
  .<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">debug</span>(<span class="hljs-string">"渲染后的 Prompt"</span>))
  .<span class="hljs-title function_">pipe</span>(model)
  .<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">debug</span>(<span class="hljs-string">"模型原始输出"</span>));
</code></pre>
<blockquote>
<p>✅ 这是排查“模型为什么答错”的最有效手段。</p>
</blockquote>
<hr/>
<h3 data-id="heading-9">场景 2：数据预处理 / 后处理</h3>
<pre><code class="hljs language-ini" lang="ini">
// 限制历史消息长度（防 token 超限）
const <span class="hljs-attr">trimHistory</span> = (messages) =&gt; messages.slice(-<span class="hljs-number">6</span>)<span class="hljs-comment">;</span>

// 提取 JSON 内容
const <span class="hljs-attr">extractJson</span> = (aiMsg) =&gt; JSON.parse(aiMsg.content)<span class="hljs-comment">;</span>

const <span class="hljs-attr">chain</span> = prompt
  .pipe(trimHistory)
  .pipe(model)
  .pipe(extractJson)<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h3 data-id="heading-10">场景 3：与 OutputParser 配合结构化输出</h3>
<pre><code class="hljs language-ini" lang="ini">
import { JsonOutputParser } from "@langchain/core/output_parsers"<span class="hljs-comment">;</span>
import { z } from "zod"<span class="hljs-comment">;</span>

const <span class="hljs-attr">schema</span> = z.object({ answer: z.string(), confidence: z.number() })<span class="hljs-comment">;</span>
const <span class="hljs-attr">parser</span> = new JsonOutputParser(schema)<span class="hljs-comment">;</span>

const <span class="hljs-attr">chain</span> = prompt.pipe(model).pipe(parser)<span class="hljs-comment">;</span>

const <span class="hljs-attr">result</span> = await chain.invoke({ question: <span class="hljs-string">"地球是圆的吗？"</span> })<span class="hljs-comment">;</span>
// { answer: "是的", confidence: 0.98 }
</code></pre>
<blockquote>
<p>🎯 <code>.pipe(parser)</code> 自动完成：提取 JSON → 验证 Schema → 返回 JS 对象。</p>
</blockquote>
<hr/>
<h3 data-id="heading-11">场景 4：构建带记忆的对话链</h3>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">RunnableWithMessageHistory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/runnables"</span>;

<span class="hljs-keyword">const</span> baseChain = prompt.<span class="hljs-title function_">pipe</span>(model);

<span class="hljs-keyword">const</span> chainWithMemory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RunnableWithMessageHistory</span>({
  <span class="hljs-attr">runnable</span>: baseChain,
  <span class="hljs-attr">getMessageHistory</span>: <span class="hljs-keyword">async</span> () =&gt; chatHistory,
  <span class="hljs-attr">inputMessagesKey</span>: <span class="hljs-string">"input"</span>,
  <span class="hljs-attr">historyMessagesKey</span>: <span class="hljs-string">"history"</span>
});
</code></pre>
<p>注意：<code>baseChain</code> 本身就是通过 <code>.pipe()</code> 构建的！</p>
<hr/>
<h2 data-id="heading-12">四、<code>.pipe()</code> vs 手动调用：为什么必须用它？</h2>

























<table><thead><tr><th>方式</th><th>问题</th><th><code>.pipe()</code> 的优势</th></tr></thead><tbody><tr><td>手动 <code>await model(await prompt(...))</code></td><td>无法流式、难调试、难复用</td><td>支持 <code>.stream()</code>、<code>.batch()</code>、中间件插入</td></tr><tr><td>逻辑耦合在函数内</td><td>修改一处影响整体</td><td>每一步独立，高内聚低耦合</td></tr><tr><td>无法利用 LangChain 生态</td><td>需自己处理格式转换</td><td>自动适配 <code>BaseMessage</code>、<code>Document</code> 等类型</td></tr></tbody></table>
<blockquote>
<p>💡 <strong><code>.pipe()</code> 是 LangChain 实现“声明式 AI 编程”的基石。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-13">五、高级技巧：超越基础用法</h2>
<h3 data-id="heading-14">技巧 1：条件分支（结合 <code>.assign()</code>）</h3>
<pre><code class="hljs language-ini" lang="ini">
const <span class="hljs-attr">chain</span> = RunnableSequence.from([
  prompt,
  model,
  (output) =&gt; {
    if (output.content.includes(<span class="hljs-string">"错误"</span>)) {
      return fallbackModel.invoke(prompt)<span class="hljs-comment">;</span>
    }
    return output<span class="hljs-comment">;</span>
  }
])<span class="hljs-comment">;</span>
</code></pre>
<blockquote>
<p>（注：复杂分支建议用 <code>RunnableBranch</code>）</p>
</blockquote>
<hr/>
<h3 data-id="heading-15">技巧 2：并行处理（用 <code>RunnableMap</code>）</h3>
<pre><code class="hljs language-css" lang="css">
const parallelChain = RunnableMap<span class="hljs-selector-class">.from</span>({
  <span class="hljs-selector-tag">summary</span>: summaryChain,
  keywords: keywordChain
});

// 结果：{ <span class="hljs-selector-tag">summary</span>: <span class="hljs-string">"..."</span>, keywords: [<span class="hljs-string">"..."</span>] }
</code></pre>
<p>虽然不是 <code>.pipe()</code>，但它是 LCEL 组合体系的一部分。</p>
<hr/>
<h3 data-id="heading-16">技巧 3：错误重试（Fallbacks）</h3>
<pre><code class="hljs language-ini" lang="ini">
const <span class="hljs-attr">robustChain</span> = primaryChain.withFallbacks([backupChain])<span class="hljs-comment">;</span>
</code></pre>
<p>当主链失败时自动切换备用链。</p>
<hr/>
<h2 data-id="heading-17">六、常见误区与最佳实践</h2>
<h3 data-id="heading-18">❌ 误区 1：忘记 <code>return</code> 在调试函数中</h3>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">// 错误！下一步收到 undefined</span>
.<span class="hljs-title function_">pipe</span>(<span class="hljs-function">(<span class="hljs-params">x</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(x))

<span class="hljs-comment">// 正确</span>
.<span class="hljs-title function_">pipe</span>(<span class="hljs-function">(<span class="hljs-params">x</span>) =&gt;</span> { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(x); <span class="hljs-keyword">return</span> x; })
</code></pre>
<h3 data-id="heading-19">❌ 误区 2：在管道中做副作用但不返回</h3>
<p>所有中间函数<strong>必须返回数据</strong>，否则链断裂。</p>
<h3 data-id="heading-20">✅ 最佳实践</h3>
<ol>
<li><strong>命名清晰</strong>：<code>prompt → callModel → parseResponse</code></li>
<li><strong>单一职责</strong>：每个 <code>.pipe()</code> 步骤只做一件事</li>
<li><strong>优先使用内置组件</strong>：如 <code>JsonOutputParser</code> 而非手写 <code>JSON.parse</code></li>
<li><strong>开发期加调试节点</strong>，上线前可移除或开关控制</li>
</ol>
<hr/>
<h2 data-id="heading-21">七、总结：<code>.pipe()</code> 的核心价值</h2>

























<table><thead><tr><th>维度</th><th>价值</th></tr></thead><tbody><tr><td><strong>开发体验</strong></td><td>声明式、线性、易读易维护</td></tr><tr><td><strong>可组合性</strong></td><td>像乐高一样拼装 AI 组件</td></tr><tr><td><strong>生态集成</strong></td><td>无缝对接 LangChain 的 Memory、Agent、Tool 等</td></tr><tr><td><strong>工程能力</strong></td><td>原生支持流式、批处理、回调、配置透传</td></tr></tbody></table>
<blockquote>
<p>🎯 <strong>记住</strong>：<br/>
<strong>LangChain 不是让你“调用一次模型”，而是让你“构建一个可演进的 AI 系统”。</strong><br/>
而 <code>.pipe()</code>，就是搭建这个系统的“管道接口”。</p>
</blockquote>
<hr/>
<h2 data-id="heading-22">八、动手试试！</h2>
<p>现在，尝试重构你的 AI 链：</p>
<pre><code class="hljs language-ini" lang="ini">
// 旧写法（不推荐）
const <span class="hljs-attr">messages</span> = await prompt.invoke(input)<span class="hljs-comment">;</span>
const <span class="hljs-attr">raw</span> = await model.invoke(messages)<span class="hljs-comment">;</span>
const <span class="hljs-attr">result</span> = JSON.parse(raw.content)<span class="hljs-comment">;</span>

// 新写法（推荐）
const <span class="hljs-attr">chain</span> = prompt.pipe(model).pipe((m) =&gt; JSON.parse(m.content))<span class="hljs-comment">;</span>
const <span class="hljs-attr">result</span> = await chain.invoke(input)<span class="hljs-comment">;</span>
</code></pre>
<p>你会发现：<strong>代码更短、更清晰、更容易扩展！</strong></p>
<hr/>
<p>掌握 <code>.pipe()</code>，你就掌握了 LangChain 的“组合魔法”。从此，构建复杂的 AI 应用不再是堆砌代码，而是一场优雅的模块拼装之旅 🚀。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PowerShell 神操作：输入「p」直接当「pnpm」用，敲命令速度翻倍！]]></title>    <link>https://juejin.cn/post/7589386219450531855</link>    <guid>https://juejin.cn/post/7589386219450531855</guid>    <pubDate>2025-12-30T08:38:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589386219450531855" data-draft-id="7589445154533752884" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PowerShell 神操作：输入「p」直接当「pnpm」用，敲命令速度翻倍！"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2025-12-30T08:38:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端卿年"/> <meta itemprop="url" content="https://juejin.cn/user/2277843825591400"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PowerShell 神操作：输入「p」直接当「pnpm」用，敲命令速度翻倍！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2277843825591400/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端卿年
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T08:38:21.000Z" title="Tue Dec 30 2025 08:38:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">PowerShell 中设置 <code>p</code> 别名解析为 <code>pnpm</code> 的操作指南</h2>
<p>前端开发中，经常需要使用 <code>pnpm install</code>、<code>pnpm dev</code>、<code>pnpm build</code> 等命令。通过设置别名，可以将这些命令简化为 <code>p install</code>、<code>p dev</code>、<code>p build</code>，提高开发效率。</p>
<h3 data-id="heading-1">功能说明</h3>
<p>在 PowerShell 终端中输入 <code>p</code>，自动解析为 <code>pnpm</code> 命令（例如 <code>p install</code> 等价于 <code>pnpm install</code>），通过配置 PowerShell 别名实现，永久生效。</p>
<h3 data-id="heading-2">操作步骤</h3>
<h4 data-id="heading-3">步骤1：打开 PowerShell</h4>
<p>按 <code>Win + R</code> 键，输入 <code>powershell</code>，点击确定。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b91166f4ed241d7afd6aa8571476ff9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Y2_5bm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767688701&amp;x-signature=NrkdyvKbVwLvShZ6NorRX%2FYiYAY%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-4">步骤2：打开 PowerShell 配置文件</h4>
<p>在 PowerShell 中执行以下命令，打开配置文件（首次执行会自动创建）：</p>
<pre><code class="hljs language-powershell" lang="powershell">notepad $PROFILE
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db4ce2b2a4b347c7baba8ce6462ad562~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Y2_5bm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767688701&amp;x-signature=UUZBLjljRNbCrO%2FV7pJXhz4Zsg8%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p><strong>提示</strong>：如果提示文件不存在，系统会自动创建配置文件。</p>
</blockquote>
<h4 data-id="heading-5">步骤3：添加别名配置</h4>
<p>在记事本中输入以下内容（配置 <code>p</code> 对应 <code>pnpm</code>）：</p>
<pre><code class="hljs language-powershell" lang="powershell">Set-Alias -Name p -Value pnpm
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f671004a6aa4a8187b612eabce9e496~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Y2_5bm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767688701&amp;x-signature=yt7LUCzwfgl9DE7DHgQr%2FXKlPYM%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-6">步骤4：保存配置文件</h4>
<h5 data-id="heading-7">情况A：直接保存成功</h5>
<p>直接按 <code>Ctrl + S</code> 保存即可。</p>
<h5 data-id="heading-8">情况B：弹出「另存为」窗口</h5>
<p>若弹出「另存为」窗口，按以下路径保存：</p>
<ol>
<li>左侧导航栏点击 <strong>「文档」</strong>（对应英文 <code>Documents</code> 文件夹）</li>
<li>在「文档」中新建文件夹，命名为 <code>WindowsPowerShell</code></li>
<li>进入 <code>WindowsPowerShell</code> 文件夹</li>
<li>文件名输入：<code>Microsoft.PowerShell_profile.ps1</code>（<strong>后缀必须为 <code>.ps1</code></strong>）</li>
<li>点击「保存」</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca1e8d660add4eda940fd0a21057fbba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Y2_5bm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767688701&amp;x-signature=ZSuJsZ7qkn0f%2FndeyMX6eTjBvcc%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-9">步骤5：使配置生效</h4>
<p>回到 PowerShell，执行以下命令加载配置：</p>
<pre><code class="hljs language-powershell" lang="powershell">. $PROFILE
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7e71cccb59b4b199e88a4955c067a9d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Y2_5bm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767688701&amp;x-signature=IKBgF9cAV%2Bwn5OGpi8KCXs8Qmdg%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-10">步骤6：验证效果</h4>
<p>在 PowerShell 中输入以下命令测试：</p>
<pre><code class="hljs language-powershell" lang="powershell">p --version  # 等价于 pnpm --version，会输出 pnpm 版本号
</code></pre>
<p>如果显示 pnpm 版本号，说明配置成功！</p>
<h3 data-id="heading-11">常用命令示例</h3>
<p>配置成功后，可以使用以下简化命令：</p>
<pre><code class="hljs language-powershell" lang="powershell"># 安装依赖
p install

# 开发模式
p dev

# 构建项目
p build

# 添加依赖
p add &lt;package-name&gt;

# 移除依赖
p remove &lt;package-name&gt;

# 查看版本
p --version
</code></pre>
<h3 data-id="heading-12">故障排除</h3>
<h4 data-id="heading-13">问题1：执行 <code>p</code> 命令提示"无法识别命令"</h4>
<p><strong>解决方案</strong>：</p>
<ol>
<li>确认已执行 <code>. $PROFILE</code> 加载配置</li>
<li>检查配置文件路径：<code>echo $PROFILE</code></li>
<li>确认配置文件内容是否正确</li>
<li>重新打开 PowerShell 窗口</li>
</ol>
<h4 data-id="heading-14">问题2：配置文件无法保存</h4>
<p><strong>解决方案</strong>：</p>
<ol>
<li>以管理员身份运行 PowerShell</li>
<li>检查文件路径权限</li>
<li>手动创建 <code>WindowsPowerShell</code> 文件夹</li>
</ol>
<h4 data-id="heading-15">问题3：别名在每次新窗口打开时失效</h4>
<p><strong>解决方案</strong>：
确认配置文件路径正确，PowerShell 启动时会自动加载 <code>$PROFILE</code> 指向的文件。</p>
<h4 data-id="heading-16">问题4：想移除别名</h4>
<p>在配置文件中删除或注释掉 <code>Set-Alias -Name p -Value pnpm</code> 这一行，然后执行 <code>. $PROFILE</code> 重新加载配置。</p>
<h3 data-id="heading-17">注意事项</h3>
<ul>
<li>别名 <code>p</code> 仅在当前 PowerShell 会话中生效，新窗口会自动加载</li>
<li>如果系统中已有其他 <code>p</code> 命令，此别名会覆盖它</li>
<li>配置文件路径通常为：<code>C:\Users\&lt;用户名&gt;\Documents\WindowsPowerShell\Microsoft.PowerShell_profile.ps1</code></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java对比Python 3.10+ 全栈语法与底层进阶百科全书]]></title>    <link>https://juejin.cn/post/7588388014505705514</link>    <guid>https://juejin.cn/post/7588388014505705514</guid>    <pubDate>2025-12-29T03:35:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588388014505705514" data-draft-id="7588730836864417807" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java对比Python 3.10+ 全栈语法与底层进阶百科全书"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-29T03:35:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="若丶相见"/> <meta itemprop="url" content="https://juejin.cn/user/2330620381380311"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java对比Python 3.10+ 全栈语法与底层进阶百科全书
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2330620381380311/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    若丶相见
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T03:35:14.000Z" title="Mon Dec 29 2025 03:35:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    18
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这份文档是为你——一位 <strong>Java 17 资深开发者</strong>量身定制的 <strong>Python 3.10+ 全栈语法与底层进阶百科全书</strong>。</p>
<p>它融合了底层运行机制、现代语法特性、跨语言横向对比以及工程化实践，旨在帮助你从 JVM 思维无痛切换至 Pythonic 思维。</p>
<hr/>
<h2 data-id="heading-0">🐍 Python 3.10+ 全栈进阶百科全书 (Java 17 兼容版)</h2>
<h3 data-id="heading-1">第一部分：核心语法基准对照表</h3>





























































<table><thead><tr><th align="left">特性</th><th align="left"><strong>Java 17 (你的基准)</strong></th><th align="left"><strong>Python 3.10+</strong></th><th align="left"><strong>Kotlin</strong></th><th align="left"><strong>TypeScript</strong></th></tr></thead><tbody><tr><td align="left"><strong>代码块</strong></td><td align="left"><code>{ }</code> 大括号</td><td align="left"><strong>缩进 (Indent)</strong></td><td align="left"><code>{ }</code></td><td align="left"><code>{ }</code></td></tr><tr><td align="left"><strong>变量声明</strong></td><td align="left"><code>int x = 10;</code> / <code>var x = 10;</code></td><td align="left"><code>x: int = 10</code></td><td align="left"><code>val x = 10</code> / <code>var x = 10</code></td><td align="left"><code>const x = 10</code> / <code>let x = 10</code></td></tr><tr><td align="left"><strong>空值</strong></td><td align="left"><code>null</code></td><td align="left"><strong><code>None</code></strong></td><td align="left"><code>null</code></td><td align="left"><code>null</code> / <code>undefined</code></td></tr><tr><td align="left"><strong>方法定义</strong></td><td align="left"><code>public R name(P p) { }</code></td><td align="left"><code>def name(p: P) -&gt; R:</code></td><td align="left"><code>fun name(p: P): R { }</code></td><td align="left"><code>function name(p: P): R { }</code></td></tr><tr><td align="left"><strong>构造函数</strong></td><td align="left"><code>public ClassName() { }</code></td><td align="left"><code>def __init__(self):</code></td><td align="left"><code>constructor() { }</code></td><td align="left"><code>constructor() { }</code></td></tr><tr><td align="left"><strong>当前实例</strong></td><td align="left"><code>this</code> (隐式)</td><td align="left"><strong><code>self</code> (必须显式在首位)</strong></td><td align="left"><code>this</code></td><td align="left"><code>this</code></td></tr><tr><td align="left"><strong>密封类/匹配</strong></td><td align="left"><code>sealed class</code> + <code>permits</code></td><td align="left"><code>match ... case</code></td><td align="left"><code>sealed class</code> + <code>when</code></td><td align="left"><code>union types</code> + <code>switch</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-2">第二部分：底层逻辑对标 (JVM vs CPython)</h3>
<p>在写代码前，必须理解两者“世界观”的差异：</p>
<ol>
<li><strong>运行模型 (GIL vs JIT)</strong>：
<ul>
<li><strong>Java</strong>：真多线程并行，依赖 JIT 编译优化。</li>
<li><strong>Python</strong>：拥有 <strong>GIL (全局解释器锁)</strong>。同一时刻只有一个线程执行字节码。</li>
<li><strong>结论</strong>：计算密集型任务用 <code>multiprocessing</code>（多进程），IO 密集型用 <code>asyncio</code>。</li>
</ul>
</li>
<li><strong>内存管理</strong>：
<ul>
<li><strong>Java</strong>：可达性分析，由 GC（G1/ZGC）负责扫描。</li>
<li><strong>Python</strong>：核心是 <strong>引用计数 (Reference Counting)</strong>，辅以<strong>标记清除</strong>解决循环引用。对象引用归零时立即释放。</li>
</ul>
</li>
<li><strong>作用域 (LEGB Rule)</strong>：
<ul>
<li>Python 没有块级作用域（<code>if/for</code> 块内定义的变量块外可见）。变量查找顺序：Local -&gt; Enclosing (闭包) -&gt; Global -&gt; Built-in。</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-3">第三部分：核心进阶特性深度解析</h3>
<h4 data-id="heading-4">1. 类型注解与结构化匹配 (Java Record &amp; Switch 增强)</h4>
<ul>
<li><strong>Java 对标</strong>：Java 17 的 <code>record</code> 和模式匹配 <code>switch</code>。</li>
<li><strong>Python 实战</strong>：
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass

<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>:
    <span class="hljs-built_in">id</span>: <span class="hljs-built_in">int</span>
    role: <span class="hljs-built_in">str</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_user</span>(<span class="hljs-params">data: User | <span class="hljs-built_in">dict</span></span>): <span class="hljs-comment"># 3.10+ 联合类型写法</span>
    <span class="hljs-keyword">match</span> data:
        <span class="hljs-keyword">case</span> User(<span class="hljs-built_in">id</span>=idx, role=<span class="hljs-string">"admin"</span>): <span class="hljs-comment"># 结构化解构</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Admin <span class="hljs-subst">{idx}</span> logged in"</span>)
        <span class="hljs-keyword">case</span> {<span class="hljs-string">"id"</span>: idx}: <span class="hljs-comment"># 字典解构</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Guest <span class="hljs-subst">{idx}</span>"</span>)
        <span class="hljs-keyword">case</span> _:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"Unknown"</span>)
</code></pre>
</li>
</ul>
<h4 data-id="heading-5">2. 协议 (Protocols) 与魔法方法</h4>
<ul>
<li><strong>Java 对标</strong>：<code>interface</code>。</li>
<li><strong>Python 逻辑</strong>：Python 使用 <strong>鸭子类型</strong>。如果你实现了特殊的“魔法方法”，你就实现了对应的“接口”。
<ul>
<li><code>__call__</code>：使对象可调用（类似 <code>@FunctionalInterface</code>）。</li>
<li><code>__getitem__</code>：使对象支持索引取值（类似 <code>List.get()</code>）。</li>
<li><code>__enter__ / __exit__</code>：支持 <code>with</code> 语句（类似 <code>AutoCloseable</code>）。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-6">3. 装饰器 (Decorators)</h4>
<ul>
<li><strong>Java 对标</strong>：<strong>Spring AOP</strong>。</li>
<li><strong>本质</strong>：它是高阶函数，<code>@log</code> 装饰 <code>func</code> 等同于执行 <code>func = log(func)</code>。
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">log</span>(<span class="hljs-params">func</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Calling <span class="hljs-subst">{func.__name__}</span>"</span>)
        <span class="hljs-keyword">return</span> func(*args, **kwargs)
    <span class="hljs-keyword">return</span> wrapper
</code></pre>
</li>
</ul>
<h4 data-id="heading-7">4. 异步编程 (Async/Await)</h4>
<ul>
<li><strong>Java 对标</strong>：<code>CompletableFuture</code> 或 Java 21 的虚拟线程。</li>
<li><strong>关键点</strong>：Python 异步是<strong>单线程协作式</strong>。在 <code>await</code> 处挂起，让出 CPU 给其他协程。
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> asyncio

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_data</span>():
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">1</span>) <span class="hljs-comment"># 非阻塞休眠</span>
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"data"</span>: <span class="hljs-number">200</span>}
</code></pre>
</li>
</ul>
<h4 data-id="heading-8">5. 上下文管理器 (Context Managers)</h4>
<ul>
<li><strong>Java 对标</strong>：<code>try-with-resources</code>。</li>
<li><strong>Python 优雅之处</strong>：
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"config.json"</span>) <span class="hljs-keyword">as</span> f:
    data = f.read()
<span class="hljs-comment"># 离开缩进自动关闭文件</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-9">6. 生成器 (Generators / yield)</h4>
<ul>
<li><strong>Java 对标</strong>：Java 没有直接对应，通常通过 <code>Iterator</code> 模拟。</li>
<li><strong>价值</strong>：处理海量数据时，一次只产出一个值，内存占用极低。
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">count_stream</span>():
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10000</span>):
        <span class="hljs-keyword">yield</span> i <span class="hljs-comment"># 暂停并返回</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-10">7. 元类 (Metaclasses)</h4>
<ul>
<li><strong>Java 对标</strong>：<strong>动态代理 / 字节码增强 (ByteBuddy)</strong>。</li>
<li><strong>用途</strong>：拦截类的创建过程。比如所有继承自 <code>BaseModel</code> 的类，在加载时自动检查是否定义了主键。</li>
</ul>
<h4 data-id="heading-11">8. 属性描述符 (Descriptors)</h4>
<ul>
<li><strong>Java 对标</strong>：Lombok 的底层逻辑或自定义 Getter/Setter。</li>
<li><strong>实现</strong>：通过 <code>__get__</code> 和 <code>__set__</code> 代理属性访问，是 Django ORM 等框架实现的核心。</li>
</ul>
<h4 data-id="heading-12">9. 弱引用 (Weak References)</h4>
<ul>
<li><strong>Java 对标</strong>：<code>WeakReference&lt;T&gt;</code>。</li>
<li><strong>场景</strong>：实现大对象缓存，避免因缓存导致的内存泄漏。</li>
</ul>
<h4 data-id="heading-13">10. 函数工具 (functools)</h4>
<ul>
<li><strong>核心工具</strong>：
<ul>
<li><code>@lru_cache</code>：一行代码实现方法结果缓存。</li>
<li><code>@wraps</code>：确保装饰器不丢失原函数的元数据（如函数名）。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-14">第四部分：四语言“全能示例”建模对比</h3>
<p><strong>场景：异步用户服务，包含数据定义、异步获取与流式处理。</strong></p>
<h4 data-id="heading-15">Python 3.10+ (Modern Python)</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass
<span class="hljs-keyword">import</span> asyncio

<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>:
    uid: <span class="hljs-built_in">int</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span>:
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_user_async</span>(<span class="hljs-params">self, uid: <span class="hljs-built_in">int</span></span>) -&gt; User:
        <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">0.1</span>)
        <span class="hljs-keyword">return</span> User(uid)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_user_stream</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):
            <span class="hljs-keyword">yield</span> User(i) <span class="hljs-comment"># 生成器</span>
</code></pre>
<h4 data-id="heading-16">Java 17</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">record</span> <span class="hljs-title class_">User</span><span class="hljs-params">(<span class="hljs-type">int</span> uid)</span> {}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">public</span> CompletableFuture&lt;User&gt; <span class="hljs-title function_">getUserAsync</span><span class="hljs-params">(<span class="hljs-type">int</span> uid)</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-keyword">try</span> { Thread.sleep(<span class="hljs-number">100</span>); } <span class="hljs-keyword">catch</span> (Exception e) {}
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(uid);
        });
    }

    <span class="hljs-keyword">public</span> Stream&lt;User&gt; <span class="hljs-title function_">getUserStream</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> IntStream.range(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>).mapToObj(User::<span class="hljs-keyword">new</span>);
    }
}
</code></pre>
<h4 data-id="heading-17">Kotlin</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> uid: <span class="hljs-built_in">Int</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUserAsync</span><span class="hljs-params">(uid: <span class="hljs-type">Int</span>)</span></span>: User {
        delay(<span class="hljs-number">100</span>)
        <span class="hljs-keyword">return</span> User(uid)
    }

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUserStream</span><span class="hljs-params">()</span></span> = sequence {
        repeat(<span class="hljs-number">3</span>) { yield(User(it)) }
    }
}
</code></pre>
<h4 data-id="heading-18">TypeScript</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> { <span class="hljs-attr">uid</span>: <span class="hljs-built_in">number</span>; }

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">getUserAsync</span>(<span class="hljs-attr">uid</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">User</span>&gt; {
        <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(r, <span class="hljs-number">100</span>));
        <span class="hljs-keyword">return</span> { uid };
    }

    *<span class="hljs-title function_">getUserStream</span>(): <span class="hljs-title class_">IterableIterator</span>&lt;<span class="hljs-title class_">User</span>&gt; {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) <span class="hljs-keyword">yield</span> { <span class="hljs-attr">uid</span>: i };
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-19">第五部分：Java 开发者转 Python 避坑指南</h3>
<ol>
<li><strong>可变默认参数</strong>：
<ul>
<li>❌ <code>def add(item, items=[])</code>：这个 <code>[]</code> 是静态的，所有调用共享同一个列表！</li>
<li>✅ <code>def add(item, items=None)</code>：内部初始化 <code>if items is None: items = []</code>。</li>
</ul>
</li>
<li><strong>多线程误区</strong>：
<ul>
<li>不要指望 Python 的 <code>threading</code> 能加速 CPU 密集型计算。计算量大请直奔 <code>multiprocessing</code>。</li>
</ul>
</li>
<li><strong>工程化选型</strong>：
<ul>
<li><strong>包管理</strong>：放弃 <code>pip</code>，使用 <strong>Poetry</strong> (类似 Maven/Gradle)。</li>
<li><strong>Lint/格式化</strong>：使用 <strong>Ruff</strong> (极速 Rust 编写)。</li>
<li><strong>Web 框架</strong>：首选 <strong>FastAPI</strong> (基于类型注解，自带 Swagger，性能卓越)。</li>
</ul>
</li>
<li><strong>相等性判断</strong>：
<ul>
<li>Python 的 <code>==</code> 默认比较内容（类似 Java 的 <code>.equals()</code>）。</li>
<li>Python 的 <code>is</code> 比较引用（类似 Java 的 <code>==</code>）。</li>
</ul>
</li>
</ol>
<p>这份百科全书将 Python 的灵活性与 Java 的严谨性有机结合。当你掌握了 <strong>魔法方法</strong>、<strong>异步协程</strong> 和 <strong>模式匹配</strong> 后，你将能在 Python 领域发挥出等同于 Java 专家的生产力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RocketMQ高性能揭秘：承载万亿级流量的架构奥秘｜得物技术]]></title>    <link>https://juejin.cn/post/7589325011543932966</link>    <guid>https://juejin.cn/post/7589325011543932966</guid>    <pubDate>2025-12-30T08:42:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589325011543932966" data-draft-id="7589166195797835803" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RocketMQ高性能揭秘：承载万亿级流量的架构奥秘｜得物技术"/> <meta itemprop="keywords" content="后端,RocketMQ"/> <meta itemprop="datePublished" content="2025-12-30T08:42:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="得物技术"/> <meta itemprop="url" content="https://juejin.cn/user/2392954206960247"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RocketMQ高性能揭秘：承载万亿级流量的架构奥秘｜得物技术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392954206960247/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    得物技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T08:42:16.000Z" title="Tue Dec 30 2025 08:42:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读22分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、前言</h2>
<p>在分布式系统架构中，消息队列如同畅通的“信息神经网络”，承担着解耦、削峰与异步通信的核心使命。在众多成熟方案中，RocketMQ凭借其阿里巴巴与Apache双重基因，以卓越的金融级可靠性、万亿级消息堆积能力和灵活的分布式特性脱颖而出，成为构建高可用、高性能数据流转枢纽的关键技术选型。本文将深入解析RocketMQ的核心架构、设计哲学与实践要义。</p>
<h2 data-id="heading-1">二、RocketMQ架构总览</h2>
<p>官网图片</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3bdf1be17f15433abadb30355785add7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767688935&amp;x-signature=Q5cXYft5vb6uHouUekXeCFN7dU0%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>RocketMQ架构上主要分为四部分，如上图所示: </p>
<p>RocketMQ作为一款高性能、高可用的分布式消息中间件，其核心架构采用了经典的四组件协同设计，实现了消息生产、存储、路由与消费的全链路解耦与高效协同。<strong>四大组件——生产者（Producer）、消费者（Consumer）、路由中心（NameServer）和代理服务器（Broker）——各司其职，共同构建了其坚实的基石。</strong></p>
<p><strong>生产者（Producer）</strong> 作为消息的源头，负责将业务消息高效、可靠地发布到系统中。它支持分布式集群部署，并通过内置的智能负载均衡机制，自动选择最优的Broker节点与队列进行投递。</p>
<p><strong>消费者（Consumer）</strong> 是消息的处理终端，同样以集群化方式工作，支持推送（Push）和拉取（Pull）两种消息获取模式。它提供了集群消费与广播消费两种模式，并能动态维护其订阅关系。</p>
<p><strong>路由中心（NameServer）</strong> 是整个架构的“注册中心”，扮演着轻量级服务发现的角色。所有Broker节点都会向NameServer注册，并通过定期心跳汇报健康状态。生产者与消费者则从NameServer获取实时的主题路由与Broker信息，从而实现消息寻址的完全解耦。</p>
<p><strong>代理服务器（Broker）</strong> 是消息存储与流转的核心，负责消息的持久化存储、投递与查询。为了保障高可用性，Broker通常采用主从（Master-Slave）部署架构，确保数据与服务在故障时能无缝切换。其内部集成了通信处理、存储引擎、索引服务和高可用复制等核心模块。</p>
<h2 data-id="heading-2">三、核心组件深度解析</h2>
<h3 data-id="heading-3">NameServer：轻量级服务发现枢纽</h3>
<p>NameServer是RocketMQ的<strong>轻量级服务发现与路由中心，</strong> 其核心目标是<strong>实现生产消费与Broker服务的解耦。</strong> 它不存储消息数据，仅管理路由元数据。</p>
<p>核心是一张的路由表 HashMap&lt;String/* Topic */, List&gt;，记录了每个Topic对应在哪些Broker的哪些队列上。</p>
<p>客户端内置了故障规避机制。如果从某个NameServer获取路由失败，或根据路由信息访问Broker失败，会自动重试其他NameServer或Broker。</p>
<p>1. <strong>核心角色与设计哲学：</strong> NameServer的设计哲学是 <strong>“简单、无状态、最终一致” 。</strong> 每个NameServer节点独立运行，<strong>节点间互不通信，</strong> 这使其具备极强的水平扩展能力和极高的可用性。客户端会配置所有NameServer地址，并向其广播请求。</p>
<p>2. <strong>核心工作机制：</strong> 其运作围绕路由信息的生命周期展开，可通过下图一览其核心流程：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b3280785213457baf0072075bf3d2c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767688935&amp;x-signature=YWSVIizAw2fvUuXHhFa7xydVAQA%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>3. 和kafka注册中心对比</strong></p>
<ul>
<li><strong>NameServer</strong> 采用 <strong>“去中心化”</strong> 和 <strong>“最终一致”</strong> 思想，<strong>追求极致的简单、轻量和水平扩展，</strong> 牺牲了强一致性，以换取架构的简洁和高可用。这非常适合路由信息变动不频繁、客户端具备容错能力的消息场景。</li>
<li><strong>Kafka (KRaft)</strong> 采用 <strong>“中心化”</strong> 和 <strong>“强一致”</strong> 思想，<strong>追求数据的精确和系统的自包含。</strong> 它将元数据管理深度内化，通过共识协议保证全局一致，但代价是架构复杂度和运维成本更高。</li>
</ul>
<p><strong>优劣分析：</strong> NameServer在<strong>运维简易性、集群扩展性、无外部依赖</strong>上占优；而Kafka KRaft在<strong>元数据强一致性、系统自包含、架构统一性</strong>上更胜一筹。选择取决于你对<strong>一致性、复杂度、运维成本</strong>的具体权衡。</p>
<h3 data-id="heading-4">Broker：消息存储与转发的核心引擎</h3>
<p><strong>解密存储文件设计</strong></p>
<p>Broker目录下的文件结构</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e24cb94e63be43809d3bef29a8c763cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767688935&amp;x-signature=Imv1BnL%2Fp6UklYRQ7TaaZBBi3mc%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>所有核心存储文件均位于Broker节点的 <strong>${storePathRootDir}/store/</strong> 目录下（默认路径为 ~/store/），其下各子目录职责分明：</p>













































<table><thead><tr><th>目录/文件</th><th>核心职责</th><th>关键设计说明</th></tr></thead><tbody><tr><td><strong>commitlog/</strong></td><td><strong>消息实体存储库</strong></td><td>• <strong>设计</strong>：所有Topic的消息<strong>顺序混合追加</strong>写入。• <strong>文件</strong>：以起始物理偏移量命名（20位数字），默认每个1GB。<strong>lock文件</strong>确保同一时刻只有一个进程写入，保障严格顺序写。</td></tr><tr><td><strong>consumequeue/</strong></td><td><strong>逻辑消费队列索引</strong></td><td>• <strong>结构</strong>：按 {Topic}/{QueueId}/三级目录组织。 • <strong>文件</strong>：存储<strong>定长记录</strong>（20字节/条），包含物理偏移量、长度和Tag哈希码。 • <strong>作用</strong>：为消费者提供按Topic和队列分组的<strong>逻辑视图</strong>，实现高效拉取。</td></tr><tr><td><strong>index/</strong></td><td><strong>消息键哈希索引</strong></td><td>• <strong>文件</strong>：以创建时间戳命名（如20240515080000000）。 • <strong>结构</strong>：采用 <strong>“哈希槽 + 链表”</strong> 结构。 • <strong>用途</strong>：支持根据 <strong>Message Key</strong> 或时间范围进行消息查询，用于运维排查。</td></tr><tr><td><strong>config/</strong></td><td><strong>运行时元数据</strong></td><td>• 存储Broker运行期间生成的动态数据，如<strong>所有Topic的配置</strong>、<strong>消费者组的消费进度（offset）</strong> 等。</td></tr><tr><td><strong>checkpoint</strong></td><td><strong>状态检查点文件</strong></td><td>• 记录 commitlog、consumequeue、index等文件<strong>最后一次刷盘的时间戳</strong>，用于崩溃恢复时确定数据恢复的起点。</td></tr><tr><td><strong>abort</strong></td><td><strong>异常关闭标志文件</strong></td><td>• 该文件存在即表明Broker上一次是<strong>非正常关闭</strong>，重启时会触发恢复流程。</td></tr><tr><td><strong>lock</strong></td><td><strong>锁文件</strong></td><td>• lock文件确保同一时刻只有一个进程写入，保障严格顺序写。</td></tr></tbody></table>
<p><strong>commitLog</strong></p>
<p><strong>消息主体以及元数据的存储主体，</strong> 存储Producer端写入的消息主体内容，消息内容<strong>不是定长的。</strong> 单个文件大小默认1G， 文件名长度为20位，左边补零，剩余为<strong>起始偏移量，</strong> 比如00000000000000000000代表了第一个文件，起始偏移量为0，文件大小为1G=1073741824；当第一个文件写满了，第二个文件为00000000001073741824，起始偏移量为1073741824，以此类推。消息主要是顺序写入日志文件，当文件满了，写入下一个文件；</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1555b92d53124c30a1c64520afcb6530~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767688935&amp;x-signature=IgilS7j5JakSn7XjYXj%2FI%2BkGy4Q%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>当我们消息发送到RocketMQ以后，消息在commitLog中，因为body大小是不固定的，所以每个消息的长度也是不固定的，其存储格式如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4dc74ef5bdb4199b3c65d3620b095d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767688935&amp;x-signature=Ts7tUksCl96meHHt97y93%2FK5g%2Bw%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>下面每个表格列举了每个字段的含义</p>
























































































































































<table><thead><tr><th>字段</th><th>字段名</th><th>数据类型</th><th>字节数</th><th>说明与用途</th></tr></thead><tbody><tr><td>1</td><td><strong>MsgLen / TOTALSIZE</strong></td><td>int</td><td>4</td><td><strong>消息总长度</strong>，即从本字段开始到结束的总字节数，是解析消息的起点。</td></tr><tr><td>2</td><td><strong>MagicCode</strong></td><td>int</td><td>4</td><td><strong>魔术字</strong>，固定值（如 0xdaa320a7），用于标识这是一个有效的消息存储起始点，也用于区分<strong>消息体</strong>和<strong>文件末尾空白填充区</strong>。</td></tr><tr><td>3</td><td><strong>BodyCRC</strong></td><td>int</td><td>4</td><td><strong>消息体内容的CRC校验码，</strong> 用于校验消息体在存储过程中是否损坏。</td></tr><tr><td>4</td><td><strong>QueueId</strong></td><td>int</td><td>4</td><td><strong>队列ID</strong>，标识此消息属于Topic下的哪个逻辑队列。</td></tr><tr><td>5</td><td><strong>Flag</strong></td><td>int</td><td>4</td><td><strong>消息标志位</strong>，供应用程序自定义使用，RocketMQ内部未使用。</td></tr><tr><td>6</td><td><strong>QueueOffset</strong></td><td>long</td><td>8</td><td><strong>消费队列偏移量</strong>，即此消息在其对应ConsumeQueue中的顺序索引，<strong>是连续的</strong>。</td></tr><tr><td>7</td><td><strong>PhysicalOffset</strong></td><td>long</td><td>8</td><td><strong>物理偏移量</strong>，即此消息在<strong>所有CommitLog文件中的起始字节偏移量</strong>。由于消息长度不定，此偏移量<strong>不是连续的</strong>。</td></tr><tr><td>8</td><td><strong>SysFlag</strong></td><td>int</td><td>4</td><td><strong>系统标志位</strong>，是一个二进制组合值，用于标识消息特性，如：是否压缩、是否为事务消息、是否等待事务提交等。</td></tr><tr><td>9</td><td><strong>BornTimestamp</strong></td><td>long</td><td>8</td><td><strong>消息生成时间戳</strong>，由Producer客户端在发送时生成。</td></tr><tr><td>10</td><td><strong>BornHost</strong></td><td>8字节</td><td>8</td><td><strong>消息发送者地址</strong>。其编码并非简单字符串，而是将IP的4个段和端口号的2个字节，共6个字节，按大端序组合并填充到8字节中。</td></tr><tr><td>11</td><td><strong>StoreTimestamp</strong></td><td>long</td><td>8</td><td><strong>消息存储时间戳</strong>，即Broker收到消息并写入内存的时间。</td></tr><tr><td>12</td><td><strong>StoreHost</strong></td><td>8字节</td><td>8</td><td><strong>Broker存储地址</strong>，编码方式同BornHost。</td></tr><tr><td>13</td><td><strong>ReconsumeTimes</strong></td><td>int</td><td>4</td><td><strong>消息重试消费次数</strong>，用于死信队列判断。</td></tr><tr><td>14</td><td><strong>PreparedTransationOffset</strong></td><td>long</td><td>8</td><td><strong>事务消息专用</strong>，存储与之关联的<strong>事务日志（Transaction Log）的偏移量</strong>。</td></tr><tr><td>15</td><td><strong>BodyLength</strong></td><td>int</td><td>4</td><td><strong>消息体实际长度</strong>，后跟Body内容。</td></tr><tr><td>16</td><td><strong>Body</strong></td><td>byte[]</td><td>不定</td><td><strong>消息体内容</strong>，即Producer发送的原始业务数据。</td></tr><tr><td>17</td><td><strong>TopicLength</strong></td><td>byte</td><td>1</td><td><strong>Topic名称的长度</strong>（1字节，因此Topic名不能超过255字符）。</td></tr><tr><td>18</td><td><strong>Topic</strong></td><td>byte[]</td><td>不定</td><td><strong>Topic名称</strong>的字节数组。</td></tr><tr><td>19</td><td><strong>PropertiesLength</strong></td><td>short</td><td>2</td><td><strong>消息属性长度</strong>，后跟Properties内容。</td></tr><tr><td>20</td><td><strong>Properties</strong></td><td>byte[]</td><td>不定</td><td><strong>消息属性</strong>，用于存储用户自定义的Key-Value扩展信息。在编码时，Key和Value之间用特殊<strong>不可见字符</strong>（如\u0001）分隔，因此属性中不能包含这些字符。</td></tr></tbody></table>
<p><strong>ConsumeQueue</strong></p>
<p>消息消费索引，<strong>引入的目的主要是提高消息消费的性能。</strong> 由于RocketMQ是基于主题topic的订阅模式，消息消费是针对主题进行的，如果要遍历commitlog文件，<strong>根据topic检索消息是非常低效的。</strong></p>
<p>为了解决这个问题中，提高消费时候的速度，RocketMQ会启动后台的 dispatch 线程源源不断的将消息从 commitLog 取出消息在 CommitLog 中的物理偏移量，消息长度以及 Tag Hash 等信息作为单条消息的索引，分发到对应的消费队列，构成了对 CommitLog 的引用。</p>
<p>consumer可根据ConsumeQueue来查找待消费的消息。其中，ConsumeQueue作为消费消息的索引，保存了指定Topic下的队列消息在CommitLog中的起始<strong>物理偏移量offset，消息大小size和消息Tag的HashCode值。</strong></p>
<p><strong>consumequeue文件可以看成是基于topic的commitlog索引文件，</strong> 故consumequeue文件夹的组织方式如下：</p>
<p>$HOME/store/consumequeue/{topic}/{queueId}/{fileName}</p>
<p><strong>consumequeue文件采取定长设计，</strong> 每一个条目共20个字节，前8字节的commitlog物理偏移量、中间4字节的消息长度、8字节tag的hashcode。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2a1c20449134d6f85cddd0b432a61ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767688935&amp;x-signature=QXmusPa2UJ%2Foj2KiTRxDE9X8I60%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>indexFile</strong></p>
<p>RocketMQ的IndexFile索引文件提供了通过消息Key或时间区间查询消息的能力，其存储路径为$HOME/store/index/{fileName}，其中文件名以创建时间戳命名。单个IndexFile文件大小固定约为400M，可保存2000W个索引，其底层采用类HashMap的哈希索引结构实现。</p>
<p>IndexFile是一个<strong>固定大小</strong>的文件（约400MB），其物理结构由三部分组成</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec110113d70c41318ed5d59af0260ea6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767688935&amp;x-signature=LkiT4Cr9Jp4pTcpu%2Ftp5chEcXn0%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>1.IndexHeader（索引头，40字节）</p>
<p><strong>beginTimestamp：</strong> 第一条消息存储时间</p>
<p><strong>endTimestamp：</strong> 最后一条消息存储时间</p>
<p><strong>beginPhyoffset：</strong> 第一条消息在CommitLog中的物理偏移量</p>
<p><strong>endPhyoffset：</strong> 最后一条消息在CommitLog中的物理偏移量</p>
<p><strong>hashSlotCount：</strong> 已使用的哈希槽数量</p>
<p><strong>indexCount：</strong> 索引单元总数</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f15c2fa72ed446819edf72bcd57ed7dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767688935&amp;x-signature=TjCLGPJ5bxzgC2zTxRD1rWWfHRI%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>2.Slots（哈希槽）</p>
<p>每个IndexFile包含500万个哈希槽位,每个Slot槽位（4字节）存储的是链式索引的第一个索引序号，每个槽位可挂载多个索引单元，形成链式结构。</p>
<ul>
<li>如果Slot值为0：表示该槽位没有索引链</li>
<li>如果Slot值为N：表示该槽位对应的索引链头节点索引序号为N</li>
</ul>
<p>3.Indexes（索引单元，20字节/个）</p>
<p>每个索引单元包含以下字段：</p>
<ul>
<li><strong>keyHash：</strong> 消息Key的哈希值</li>
<li><strong>phyOffset：</strong> 消息在CommitLog中的物理偏移量</li>
<li><strong>timeDiff：</strong> 消息存储时间与IndexFile创建时间的差值</li>
<li><strong>preIndexNo：</strong> 同一哈希槽中前一个索引单元的序号</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28e2a3945505468085f36654c599d975~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767688935&amp;x-signature=GQFqfiH%2FzwZxZpLgy%2Fy3W9hMR4U%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>这个结构和hashmap结构很像，但是支持每个key通过时间排序，就可以进行时间范围的检索。</p>
<p>通过定长索引结构和整体设计可以通过key快速定位索引数据，拿到真实数据的物理偏移量。</p>
<p>4.索引查询流程</p>
<p>消费者通过消息Key查询时，执行以下步骤：</p>
<ol>
<li>计算槽位序号slot序号 = key哈希值 % 500万</li>
<li>定位槽位地址slot位置 = 40 + (slot序号 - 1) × 4</li>
<li>获取首个索引位置index位置 = 40 + 500万 × 4 + (索引序号 - 1) × 20</li>
<li>遍历索引链从槽位指向的索引开始，沿preIndexNo链式查找，匹配目标Key并校验时间范围</li>
<li>获取物理偏移量从匹配的索引单元中读取phyOffset，最终从CommitLog获取完整消息内容</li>
</ol>
<p>通过此机制，IndexFile实现了基于Key的高效点查和基于时间范围的快速检索。</p>
<p><strong>整体流程</strong></p>
<p>RocketMQ 高性能存储的核心，在于其 <strong>“混合存储”</strong> 架构，这正是一种精妙的<strong>存储层读写分离</strong>设计。</p>
<p>其工作流程可以这样理解：</p>
<ol>
<li><strong>统一写入，保证极致性能：</strong> 所有消息顺序追加写入一个统一的 CommitLog 文件。这种单一的顺序写操作，是它能承受海量消息写入的根本。</li>
<li><strong>异步构建，优化读取路径：</strong> 消息一旦持久化至 CommitLog，即视为安全。随后，后台服务线程会异步地构建出专供消费的 ConsumerQueue（逻辑队列索引）和用于查询的 IndexFile。这相当于为数据建立了高效的“目录”。</li>
<li><strong>消费消息：</strong> 消费者实际拉取消息时，是先读取 ConsumerQueue 找到消息在 CommitLog 中的物理位置，再反查 CommitLog 获取完整消息内容。</li>
<li><strong>可靠的消费机制：</strong> 基于上述持久化保障，配合消费者自身的偏移量管理及Broker的长轮询机制，共同实现了消息的可靠投递与高效获取。</li>
</ol>
<p>这种 <strong>“读写分离”</strong> 设计的好处在于：将耗时的写操作（顺序写CommitLog）与复杂的读操作（构建索引、分散查询）解耦，让两者可以异步、独立地进行优化，从而在整体上获得更高的吞吐量和更低的延迟。这体现了“各司其职，异步协同”的经典架构思想。</p>
<p>下图是官方文档的流程图</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/498af1c2070f4a8d9c1a580ad937f5a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767688935&amp;x-signature=BHzEd9qIEgSJ5AuVag0vy0St7YA%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>写入流程</p>
<p><strong>1.消息预处理</strong></p>
<p><strong>基础校验：</strong> 检查Topic名称、消息体长度等是否合法。</p>
<p><strong>生成唯一ID：</strong> 结合Broker地址和CommitLog偏移量等，生成全局唯一的MsgID。</p>
<p><strong>设置系统标志：</strong> 根据消息属性（如是否事务消息、是否压缩）设置SysFlag。</p>
<p><strong>2.CommitLog核心写入</strong></p>
<p><strong>获取MappedFile：</strong> 根据当前写入位置，定位或创建对应的1GB内存映射文件。这里采用双重检查锁模式来保证性能和安全。</p>
<p><strong>串行加锁写入：</strong> 获取全局或文件级锁（PutMessageLock），确保同一时刻只有一个线程写入文件，严格保证<strong>顺序性。</strong></p>
<p><strong>序列化与追加：</strong> 将消息按照之前分析的<strong>二进制协议，</strong> 序列化到MappedByteBuffer中，并更新写入指针。</p>
<p><strong>3.刷盘（Flush）</strong></p>
<p><strong>同步刷盘：</strong> 消息写入内存映射区后，会创建一个GroupCommitRequest并放入请求组。写入线程会等待，直到<strong>刷盘线程</strong>完成该请求对应文件的物理刷盘后，才返回成功给Producer。<strong>数据最可靠，但延迟较高。</strong></p>
<p><strong>异步刷盘（默认）：</strong> 消息写入内存映射区后，立即返回成功给Producer。同时唤醒<strong>异步刷盘线程，</strong> 该线程会定时或当PageCache中待刷盘数据积累到一定量时，执行一次批量刷盘。<strong>性能高，但有宕机丢数风险。</strong></p>
<p><strong>4.异步索引构建</strong></p>
<p>由独立的ReputMessageService线程处理。它不断检查CommitLog中是否有新消息到达。</p>
<p>一旦有<strong>新消息被确认持久化</strong>（对于同步刷盘是已落盘，对于异步刷盘是已写入映射区），该线程就会读取消息内容。</p>
<p>随后，它会为这条消息在对应的consumequeue目录下构建<strong>消费队列索引</strong>（记录CommitLog物理偏移量和消息长度），更新index索引文件。</p>
<p>消费流程</p>
<p><strong>1.启动与负载均衡</strong></p>
<p>消费者启动后，会向<strong>NameServer</strong>获取Topic的路由信息（包含哪些队列、分布在哪些Broker上）。</p>
<p>如果消费者组内有多个实例，会触发<strong>队列负载均衡</strong>（默认策略是平均分配）。例如，一个Topic有8个队列，两个消费者实例，则通常每个消费者负责消费4个队列。这一步决定了每个消费者“认领”了哪些消息队列。</p>
<p><strong>2.拉取消息循环</strong></p>
<p>每个消费者实例内部都有一个PullMessageService线程，它循环从一个PullRequest队列中获取任务。</p>
<p>PullRequest包含了拉取目标（如Broker-A， 队列3）以及<strong>下一次要拉取的位点（offset）。</strong></p>
<p>消费者向指定的Broker发送网络请求，请求体中就携带了这个offset。</p>
<p><strong>3.Broker端处理与返回</strong></p>
<p>Broker收到请求后，根据Topic、队列ID和offset，去查询对应的<strong>ConsumeQueue索引文件。</strong></p>
<p>ConsumeQueue中存储的是定长（20字节）的记录，包含消息在<strong>CommitLog中的物理偏移量和长度。</strong></p>
<p>Broker根据物理偏移量，从<strong>CommitLog文件</strong>中读取完整的消息内容，通过网络返回给消费者。</p>
<p><strong>4.消息处理与位点提交</strong></p>
<p>消费者将拉取到的消息提交到内部的<strong>消费线程池</strong>进行处理，你的业务逻辑就在这里执行。</p>
<p><strong>消费位点的管理至关重要：</strong></p>
<p><strong>位点存储：</strong> 位点由OffsetStore管理。在<strong>集群模式（CLUSTER）</strong> 下，消费位点存储在Broker上；在<strong>广播模式（BROADCAST）</strong> 下，位点存储在本地。</p>
<p><strong>位点提交：</strong> 消费成功后，消费者会<strong>异步</strong>（默认方式）向Broker提交已消费的位点。Broker将其持久化到store/config/consumerOffset.json文件中。</p>
<p><strong>5.消息重试与死信</strong></p>
<p>如果消息消费<strong>失败</strong>（抛出异常或超时未返回CONSUME_SUCCESS），RocketMQ会触发<strong>重试机制。</strong></p>
<p>对于普通消息，消息会被发回Broker上一个特殊的<strong>重试主题</strong>（%RETRY%），延迟一段时间（延迟级别：1s、5s、10s…）后再被原消费者组拉取。</p>
<p>如果<strong>重试超过最大次数</strong>（默认16次），消息会被投递到<strong>死信主题</strong>（%DLQ%），等待人工干预。死信队列中的消息不会再被自动消费。</p>
<h3 data-id="heading-5">一体与分离：Kafka和RocketMQ的核心架构博弈</h3>
<p>说起RocketMQ就不能不提起Kafka了，两者都是消息中间件这个领域的霸主，但它们的核心<strong>架构设计差异，</strong> 直接决定了各自不同的性能特性和适用场景，这也是技术选型时必须深入理解的重点。</p>
<p><strong>核心架构设计差异</strong></p>
<p><strong>Kafka：读写一体的“分区日志”模型，</strong> Kafka的架构哲学是<strong>极简与统一。</strong> 它将每个主题分区抽象为一个<strong>仅追加（append-only）的物理日志文件。</strong> 生产者和消费者都直接与这个日志文件交互：生产者顺序写入尾部，消费者通过维护偏移量顺序读取。这种设计下，<strong>数据的读写路径完全一致，</strong> 逻辑与物理结构高度统一。</p>
<p><strong>RocketMQ：读写分离的“二级制”模型 ，</strong> RocketMQ的架构哲学是<strong>分工与优化。</strong> 它采用了<strong>物理CommitLog + 逻辑ConsumeQueue的二级结构。</strong> 所有消息都顺序写入一个统一的<strong>CommitLog</strong>物理文件，实现磁盘的最高效顺序写。同时，为每个消息队列异步构建一个轻量级的<strong>ConsumeQueue</strong>索引文件，消费者读取时先查询内存中的ConsumeQueue定位，再到CommitLog中获取消息体。这是一种<strong>逻辑与物理分离</strong>的设计。</p>
<p><strong>优劣势对比</strong></p>
<p>基于上述架构设计根本差异，两者在关键指标上各显优劣：</p>



































<table><thead><tr><th>维度</th><th>Kafka（读写一体）</th><th>RocketMQ（读写分离）</th></tr></thead><tbody><tr><td><strong>核心优势</strong></td><td><strong>极致吞吐与低延迟</strong>：读写同路径，数据写入后立即可读，端到端延迟极低。<strong>架构简单</strong>：无中间状态，副本同步、故障恢复逻辑清晰。</td><td><strong>高并发读与丰富功能</strong>：索引与数据分离，支持海量消费者并发读。<strong>业务友好</strong>：原生支持事务消息、定时/延时消息、消息轨迹查询。</td></tr><tr><td><strong>存储效率</strong></td><td><strong>磁盘顺序IO最大化</strong>：生产和消费都是严格顺序IO，尤其适合机械硬盘。</td><td><strong>写性能极致化</strong>：所有消息顺序写CommitLog，<strong>但存在“写放大”</strong> ，一条消息需写多次（1次CommitLog + N次ConsumeQueue）。</td></tr><tr><td><strong>读性能</strong></td><td><strong>消费者落后时可能触发随机读</strong>：若消费者要读取非尾部历史数据，可能需磁盘寻道。但现代SSD和预读机制已大大缓解此问题。</td><td><strong>读路径优化</strong>：ConsumeQueue小而固定，可全量缓存至内存，读操作变为“内存寻址 + CommitLog顺序/随机读”。在PageCache命中率高时表现优异。</td></tr><tr><td><strong>扩展性与成本</strong></td><td><strong>文件句柄（inode）开销大</strong>：每个分区都是独立目录和文件，海量分区时运维成本高。</td><td><strong>存储成本与效率更优</strong>：多Topic共享CommitLog，文件数少，<strong>特别适合中小消息体、多Topic的场景</strong>。</td></tr><tr><td><strong>典型场景</strong></td><td><strong>日志流、指标监控、实时流处理</strong>：作为大数据管道，与Flink/Spark生态无缝集成。</td><td><strong>电商交易、金融业务、异步解耦</strong>：需要严格顺序、事务保障、业务查询的在线业务场景。</td></tr></tbody></table>
<p>总而言之，Kafka像一个设计精良的<strong>高速公路系统，</strong> 核心目标是让数据车辆（消息）能够高吞吐、低延迟地持续流动，并方便地引向各个处理工厂（流计算）。而RocketMQ则像一个高度可靠的<strong>快递网络，</strong> 不仅确保包裹（消息）准确送达，还提供预约配送（定时）、签收确认（事务）、异常重投（重试）等一系列服务于业务逻辑的增值功能。</p>
<h3 data-id="heading-6">RocketMQ对于随机读取的优化</h3>
<p>RocketMQ在消费时候的流程</p>
<pre><code class="hljs">消费者请求 → ConsumeQueue（内存/顺序）获取commitlog上的物理偏移量 → 根据物理偏移量定位CommitLog（磁盘/随机） → 返回消息
</code></pre>
<p>从ConsumeQueue获取到消息在commitlog中的偏移量的时候，回查时候可能产生随机IO</p>
<ol>
<li><strong>第一次随机IO：</strong> 根据ConsumeQueue中的物理偏移量，在CommitLog中定位消息位置</li>
<li><strong>可能的连续随机IO：</strong> 如果一次拉取多条消息，这些消息在CommitLog中可能物理不连续</li>
</ol>
<p>为了保证RocketMQ的高性能，采用一些优化措施，尽量避免随机IO</p>
<p><strong>1. ConsumeQueue的内存映射优化</strong></p>
<p>实际上，RocketMQ将ConsumeQueue映射到内存,每个ConsumeQueue约5.72MB，可完全放入PageCache,读索引操作几乎是内存操作。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConsumeQueue</span> {
    <span class="hljs-keyword">private</span> MappedFile mappedFile;  <span class="hljs-comment">// 内存映射文件</span>
    <span class="hljs-comment">// 20字节每条：8(offset) + 4(size) + 8(tagHashCode)</span>
}
</code></pre>
<p><strong>2. PageCache的充分利用</strong></p>
<p>Linux PageCache工作流程： </p>
<ol>
<li>消息写入CommitLog → 进入PageCache</li>
<li>消费者读取 → 优先从PageCache获取</li>
<li>如果PageCache命中：内存速度（≈100ns）</li>
<li>如果PageCache未命中：磁盘随机读取（≈10ms）</li>
</ol>
<p><strong>3. 批量读取优化</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// DefaultMessageStore.java</span>
public GetMessageResult <span class="hljs-built_in">getMessage</span>(...) {
    <span class="hljs-comment">// 一次读取多条消息（默认最多32条）</span>
    <span class="hljs-comment">// 即使这些消息物理不连续，通过批量读取减少IO次数</span>
    for (int i = <span class="hljs-number">0</span>; i &lt; maxMsgNums; i++) {
        <span class="hljs-comment">// 使用同一个文件channel批量读取</span>
        <span class="hljs-built_in">readMessage</span>(ctx, msgId, consumerGroup);
    }
}
</code></pre>
<p><strong>4. 读取顺序性的保持</strong></p>
<p>虽然CommitLog中不同Topic的消息是随机存放的，但同一个Queue的消息在CommitLog中是基本连续的：</p>
<pre><code class="hljs language-markdown" lang="markdown">Queue1: | Msg1 | Msg3 | Msg5 | ... | 在ConsumeQueue中连续
        ↓      ↓      ↓
CommitLog: | Msg1 | Msg2(T2) | Msg3 | Msg4(T3) | Msg5 |
          ↑<span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-emphasis">_↑
          物理上相对连续，减少磁头寻道
</span></code></pre>
<h3 data-id="heading-7">高可用设计：双轨并行的可靠性架构</h3>
<p><strong>主从架构（Master-Slave）</strong></p>
<p><strong>经典主从模式：</strong> RocketMQ早期采用Master-Slave架构，Master处理所有读写请求，Slave仅作为热备份。这种模式下，<strong>故障切换依赖人工干预或半自动脚本，</strong> 恢复时间通常在分钟级别。</p>
<p><strong>Dledger高可用集群：</strong> RocketMQ 4.5引入的Dledger基于Raft协议实现<strong>真正的主从自动切换。</strong> 当Master故障时，集群能在秒级（通常2-10秒）内自动选举新Leader，期间消息仍可写入（写入请求会阻塞至新Leader选出）。</p>
<p><strong>多副本机制：</strong> 现代部署中，建议采用<strong>2主2从或3主3从</strong>架构。例如在阿里云上，每个Broker组包含1个Master和2个Slave，形成<strong>跨可用区的三副本，</strong> 单机房故障不影响服务可用性。</p>
<p><strong>同步/异步复制</strong></p>
<p>同步复制保证强一致（消息不丢失），异步复制追求更高性能。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// Broker配置示例</span>
brokerRole = SYNC_MASTER
<span class="hljs-comment">// 生产者发送消息后，必须等待至少一个Slave确认</span>
<span class="hljs-comment">// 确保即使Master宕机，消息也不会丢失</span>
</code></pre>
<ul>
<li>强一致性保证：消息写入Master后，同步复制到Slave才返回成功</li>
<li>性能代价：延迟增加约30-50%，TPS下降约20-40%</li>
<li>适用场景：金融交易、资金变动等对数据一致性要求极高的业务</li>
</ul>
<p><strong>同步/异步刷盘</strong></p>
<p>同步刷盘保证消息持久化不丢失，异步刷盘提升吞吐。</p>
<pre><code class="hljs language-arduino" lang="arduino">brokerRole = ASYNC_MASTER
<span class="hljs-comment">// 消息写入Master即返回成功，Slave异步复制</span>
<span class="hljs-comment">// 存在极短时间的数据丢失风险</span>
</code></pre>
<ul>
<li><strong>高性能模式：</strong> 延迟降低，吞吐量接近单节点性能</li>
<li><strong>风险窗口：</strong> Master宕机且数据未同步时，最近几秒消息可能丢失</li>
<li><strong>适用场景：</strong> 日志收集、监控数据、可容忍微量丢失的业务消息</li>
</ul>
<h3 data-id="heading-8">刷盘策略的工程优化</h3>
<p><strong>同步刷盘（SYNC_FLUSH）</strong></p>
<pre><code class="hljs">生产者 → Broker内存 → 磁盘强制刷盘 → 返回成功
</code></pre>
<ul>
<li><strong>零数据丢失：</strong> 即使机器掉电，消息也已持久化到磁盘</li>
<li><strong>性能瓶颈：</strong> 每次写入都触发磁盘IO，机械硬盘下TPS通常&lt;1000</li>
<li><strong>优化手段：</strong> 使用SSD硬盘可大幅提升性能</li>
</ul>
<p><strong>异步刷盘（ASYNC_FLUSH）</strong></p>
<pre><code class="hljs">生产者 → Broker内存 → 立即返回成功 → 异步批量刷盘
</code></pre>
<ul>
<li><strong>高性能选择：</strong> 依赖PageCache，SSD下TPS可达数万至数十万</li>
<li><strong>可靠性依赖：</strong> 依赖操作系统的刷盘机制（通常5秒刷盘一次）</li>
<li><strong>配置调优：</strong></li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 调整刷盘参数</span>
<span class="hljs-attr">flushCommitLogLeastPages</span> = <span class="hljs-number">4</span>    <span class="hljs-comment"># 至少4页（16KB）才刷盘</span>
<span class="hljs-attr">flushCommitLogThoroughInterval</span> = <span class="hljs-number">10000</span>  <span class="hljs-comment"># 10秒强制刷盘一次</span>
</code></pre>
<h2 data-id="heading-9">四、Producer与Consumer：高效的生产与消费模型</h2>
<h3 data-id="heading-10">Producer</h3>
<p><strong>消息路由策略：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 内置多种队列选择算法</span>
<span class="hljs-title class_">DefaultMQProducer</span> producer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMQProducer</span>(<span class="hljs-string">"ProducerGroup"</span>);
<span class="hljs-comment">// 1. 轮询（默认）：均匀分布到所有队列</span>
<span class="hljs-comment">// 2. 哈希：相同Key的消息路由到同一队列，保证局部顺序</span>
<span class="hljs-comment">// 3. 机房就近：优先选择同机房的Broker</span>
producer.<span class="hljs-title function_">send</span>(msg, <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageQueueSelector</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">MessageQueue</span> <span class="hljs-title function_">select</span>(<span class="hljs-params">List&lt;MessageQueue&gt; mqs, Message msg, <span class="hljs-built_in">Object</span> arg</span>) {
        <span class="hljs-comment">// 自定义路由逻辑</span>
        <span class="hljs-keyword">return</span> mqs.<span class="hljs-title function_">get</span>(arg.<span class="hljs-title function_">hashCode</span>() % mqs.<span class="hljs-title function_">size</span>());
    }
});
</code></pre>
<p><strong>发送模式对比：</strong></p>





























<table><thead><tr><th>模式</th><th>特点</th><th>性能</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>同步发送</strong></td><td>阻塞等待Broker响应</td><td>TPS约5000-20000</td><td>重要业务消息，需立即知道发送结果</td></tr><tr><td><strong>异步发送</strong></td><td>回调通知结果</td><td>TPS可达50000+</td><td>高并发场景，如日志、监控数据</td></tr><tr><td><strong>单向发送</strong></td><td>发送后不等待</td><td>TPS最高（100000+）</td><td>可容忍少量丢失的非关键数据</td></tr></tbody></table>
<p><strong>失败重试与熔断：</strong></p>
<ul>
<li><strong>智能重试：</strong> 发送失败时自动重试（默认2次），可配置退避策略</li>
<li><strong>故障规避：</strong> 自动检测Broker可用性，故障期间路由到健康节点</li>
<li><strong>慢请求熔断：</strong> 统计发送耗时，自动隔离响应慢的Broker</li>
</ul>
<h3 data-id="heading-11">Consumer</h3>
<p><strong>负载均衡策略：</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 集群模式：同一ConsumerGroup内消费者均分队列</span>
consumer<span class="hljs-selector-class">.setMessageModel</span>(MessageModel.CLUSTERING);
<span class="hljs-comment">// 广播模式：每个消费者消费全量队列</span>
consumer<span class="hljs-selector-class">.setMessageModel</span>(MessageModel.BROADCASTING);
</code></pre>
<p><strong>消费进度管理：</strong></p>
<p><strong>Broker托管：</strong> 默认方式，消费进度存储在Broker</p>
<p><strong>本地维护：</strong> 某些场景下可自主管理offset（如批量处理）</p>
<p><strong>重置策略：</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 支持多种消费起点</span>
consumer<span class="hljs-selector-class">.setConsumeFromWhere</span>(ConsumeFromWhere.CONSUME_FROM_LAST_OFFSET);  <span class="hljs-comment">// 从最后</span>
consumer<span class="hljs-selector-class">.setConsumeFromWhere</span>(ConsumeFromWhere.CONSUME_FROM_FIRST_OFFSET); <span class="hljs-comment">// 从头</span>
consumer<span class="hljs-selector-class">.setConsumeFromWhere</span>(ConsumeFromWhere.CONSUME_FROM_TIMESTAMP);    <span class="hljs-comment">// 从时间点</span>
</code></pre>
<p><strong>并发控制优化：</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 关键并发参数</span>
consumer<span class="hljs-selector-class">.setConsumeThreadMin</span>(<span class="hljs-number">20</span>);     <span class="hljs-comment">// 最小消费线程数</span>
consumer<span class="hljs-selector-class">.setConsumeThreadMax</span>(<span class="hljs-number">64</span>);     <span class="hljs-comment">// 最大消费线程数</span>
consumer<span class="hljs-selector-class">.setPullBatchSize</span>(<span class="hljs-number">32</span>);        <span class="hljs-comment">// 每次拉取消息数</span>
consumer<span class="hljs-selector-class">.setConsumeMessageBatchMaxSize</span>(<span class="hljs-number">1</span>); <span class="hljs-comment">// 批量消费大小</span>
<span class="hljs-comment">// 流控机制</span>
consumer<span class="hljs-selector-class">.setPullThresholdForQueue</span>(<span class="hljs-number">1000</span>);  <span class="hljs-comment">// 队列堆积阈值</span>
consumer<span class="hljs-selector-class">.setPullInterval</span>(<span class="hljs-number">0</span>);              <span class="hljs-comment">// 拉取间隔（0为长轮询）</span>
</code></pre>
<h2 data-id="heading-12">五、核心流程与特性背后的架构支撑</h2>
<p>1 <strong>.顺序消息如何保证？</strong></p>
<p><strong>全局顺序：</strong> 单Topic单队列（牺牲并发）。</p>
<p><strong>分区顺序：</strong> 通过<strong>MessageQueue选择器</strong>确保同一业务键（如订单ID）的消息发往同一队列，Consumer端按队列顺序消费。</p>
<p><strong>2.事务消息的两阶段提交</strong></p>
<p><strong>流程详解：</strong> Half Message -&gt; 执行本地事务 -&gt; Commit/Rollback。</p>
<p><strong>架构支撑：</strong> Op消息回查机制，解决分布式事务的最终一致性，是架构设计中“状态可回溯”思想的体现。</p>
<p><strong>3.延时消息的实现奥秘</strong></p>
<p><strong>并非真正延迟投递：</strong> 为不同延迟级别预设<strong>独立的SCHEDULE_TOPIC，</strong> 定时任务扫描到期后投递至真实Topic。</p>
<p><strong>设计权衡：</strong> 以存储和计算换取功能的灵活与可靠。</p>
<h2 data-id="heading-13">六、其他性能优化关键技术点</h2>
<ol>
<li><strong>零拷贝（Zero-copy）：</strong> 通过sendfile或mmap+write方式，减少内核态与用户态间数据拷贝，大幅提升网络发送与文件读写效率。</li>
<li><strong>堆外内存与内存池：</strong> 避免JVM GC对大数据块处理的影响，实现高效的内存管理。</li>
<li><strong>文件预热：</strong> 启动时将存储文件映射到内存并写入“假数据”，避免运行时缺页中断。</li>
</ol>
<h2 data-id="heading-14">七、总结：RocketMQ架构设计的启示</h2>
<p>RocketMQ的架构设计，尤其是其在简洁性、高性能和云原生演进方面的平衡，为构建现代分布式系统提供了许多宝贵启示。</p>
<ol>
<li><strong>在简单与完备间权衡：</strong> RocketMQ没有采用强一致性的ZooKeeper，而是自研了极其简单的NameServer。这说明在非核心路径上，牺牲一定的功能完备性来换取简单性和高可用性，可能也是个不错的选择。</li>
<li><strong>以写定存储，以读优查询：</strong> 其存储架构是典型的写优化设计。所有消息顺序追加写入，保证了最高的写入性能。而针对消费和查询这两种主要的“读”场景，则分别通过异步构建索引数据结构（ConsumeQueue和IndexFile）来优化。</li>
</ol>
<h2 data-id="heading-15">八、参考资料</h2>
<ul>
<li>[RocketMQ官方文档](为什么选择RocketMQ | RocketMQ <a href="https://link.juejin.cn?target=https%3A%2F%2Frocketmq.apache.org%2Fzh%2Fdocs%2F" target="_blank" title="https://rocketmq.apache.org/zh/docs/" ref="nofollow noopener noreferrer">rocketmq.apache.org/zh/docs/</a>)</li>
<li>[RocketMQ中文社区](Apache RocketMQ 原理和架构 <a href="https://link.juejin.cn?target=https%3A%2F%2Frocketmq-learning.com%2Fcourse%2FbaseLearn%2Frocketmq_learning-framework%2F%3Fspm%3D5176.29160081.0.0.a2807833VzCxtS%26source%3Dhome" target="_blank" title="https://rocketmq-learning.com/course/baseLearn/rocketmq_learning-framework/?spm=5176.29160081.0.0.a2807833VzCxtS&amp;source=home" ref="nofollow noopener noreferrer">rocketmq-learning.com/course/base…</a>)</li>
</ul>
<h3 data-id="heading-16">往期回顾</h3>
<p>1.PAG在得物社区S级活动的落地</p>
<p>2.Ant Design 6.0 尝鲜：上手现代化组件开发｜得物技术 </p>
<p>3.Java 设计模式：原理、框架应用与实战全解析｜得物技术</p>
<p>4.Go语言在高并发高可用系统中的实践与解决方案｜得物技术</p>
<p>5.从0到1搭建一个智能分析OBS埋点数据的AI Agent｜得物技术</p>
<h3 data-id="heading-17">文 /磊子</h3>
<p>关注得物技术，每周更新技术干货</p>
<p>要是觉得文章对你有帮助的话，欢迎评论转发点赞～</p>
<p>未经得物技术许可严禁转载，否则依法追究法律责任。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[理清 https 的加密逻辑]]></title>    <link>https://juejin.cn/post/7589454621719183410</link>    <guid>https://juejin.cn/post/7589454621719183410</guid>    <pubDate>2025-12-30T08:47:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589454621719183410" data-draft-id="7567198443786338331" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="理清 https 的加密逻辑"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-30T08:47:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="imoo"/> <meta itemprop="url" content="https://juejin.cn/user/2682464104364766"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            理清 https 的加密逻辑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2682464104364766/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    imoo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T08:47:39.000Z" title="Tue Dec 30 2025 08:47:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>http 是前端的老朋友了，也是面试常考点，最近看了《图解 http》，结合着 ai 重新理了一遍 https 相关的知识，在此分享。</p>
<h2 data-id="heading-1">http 的隐患</h2>
<p>众所周知，前端与后端的交互，都需要走接口。绝大部分接口都是 http 协议，随便举一个登录例子：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable constant_">GET</span> /login?user=alice&amp;password=<span class="hljs-number">123456</span> <span class="hljs-variable constant_">HTTP</span>/<span class="hljs-number">1.1</span>
<span class="hljs-title class_">Host</span>: example.<span class="hljs-property">com</span>
<span class="hljs-title class_">User</span>-<span class="hljs-title class_">Agent</span>: <span class="hljs-title class_">Chrome</span>
</code></pre>
<p>在这个请求发出时，你的信息实际上在整条网络上都是透明的。假如你的网络经过路由器，那么路由器的主人就可以看到你这个请求，也就是能看到你的密码 <code>user=alice&amp;password=123456</code>。</p>
<p>所以国家总会提醒你，不要乱连 wifi，你的信息有可能被监听和泄露。</p>
<p>老前端们过去也总说，<strong>前端实际上没有安全性可言</strong>。在这个背景下，https 的推出也是理所当然的了。</p>
<h2 data-id="heading-2">升级之 https</h2>
<p>https 实际上只是在 http 的基础上，增加了一个加密层 TLS，该加密层使用了非对称加密来保证数据不泄露。</p>
<p>非对称加密，区分了公钥和私钥，这里有个很巧妙的数学公式，使信息能<strong>任何人都能使用公钥进行加密，但又只能用私钥进行解密</strong>。</p>
<p>这个非对称加密的过程相当消耗性能，几乎是原先的数倍甚至数十倍。有没有既可以加密，又保证性能的方案呢？</p>
<p>http 给出的答案是，<strong>在第一次通信时，使用非对称加密传递一个密码，随后使用该密码进行对称加密</strong>。这样一来，由于密码不会被中间者拦截，所以后续的对称加密也无法被轻易破解。</p>
<p>虽然在控制台上还是会看到正常的信息：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable constant_">POST</span> /api/login <span class="hljs-variable constant_">HTTP</span>/<span class="hljs-number">1.1</span>
<span class="hljs-title class_">Host</span>: example.<span class="hljs-property">com</span>
<span class="hljs-title class_">Content</span>-<span class="hljs-title class_">Type</span>: application/json
<span class="hljs-title class_">Content</span>-<span class="hljs-title class_">Length</span>: <span class="hljs-number">42</span>

{<span class="hljs-string">"username"</span>: <span class="hljs-string">"alice"</span>, <span class="hljs-string">"password"</span>: <span class="hljs-string">"123456"</span>}
</code></pre>
<p><strong>但这只对自己可见</strong>。数据在传递过程中完全被加密，抓包只能看到类似如下内容：</p>
<pre><code class="hljs language-js" lang="js">9a f1 <span class="hljs-number">23</span> 8b ... 8e d0
</code></pre>
<p>也就是完全转化为了二进制（在抓包软件内会直接显示为十六进制），这样在没有私钥的情况下，就无法将数据还原。</p>
<h2 data-id="heading-3">细说加密逻辑</h2>
<p>我们来稍微详细了解一下中间的流程。</p>
<p>首先复习下 http 的三次握手：</p>
<ol>
<li>客户端发起链接请求，发送一个 <code>SYN</code> 标识</li>
<li>服务器确认可以收到客户端消息，发送一个 <code>SYN-ACK</code> 标识</li>
<li>客户端确认可以收到服务端消息，发送一个 <code>ACK</code> 标识</li>
</ol>
<blockquote>
<p>有个很好的比喻：1.喂？听得到吗， 2.我听得到，你听得到我吗 3. 我听得到</p>
</blockquote>
<p>https 的加密流程，发生在<strong>三次握手之后</strong></p>
<p>目前主流是 TLS 1.3 版本，但旧的 TLS 1.2 版本仍然有部分存量。这两者的加密有所不同，我们分开讨论：</p>
<p>在 TLS 1.2 中：</p>
<ol>
<li>客户端发送 TLS 版本，加密算法，随机数 <code>Client Random</code></li>
<li>服务器端发送确认使用的 TLS 版本，加密算法，随机数 <code>Server Random</code></li>
<li>客户端校验证书后，再生成一个随机预主密钥 <code>Pre-Master Key</code>，并将 <code>Pre-Master Key</code> 使用公钥加密后，发送给服务端</li>
<li>服务端使用私钥，解开加密，随后<strong>双方</strong>根据这三个随机数<code>Client Random</code>，<code>Server Random</code>，<code>Pre-Master Key</code> 生成对话主密钥 <code>Master Key</code></li>
<li>根据 <code>Master Key</code> 生成临时对话秘钥</li>
<li>根据临时对话秘钥进行对称加密通信</li>
</ol>
<blockquote>
<p>但这里存在两个问题，1. 基于 rsa 算法的非对称加密，性能消耗还是比较严重 2. 过程繁琐。所以在 TLS 1.3 中对这两点进行了优化。</p>
</blockquote>
<p>在 TLS 1.3 中：</p>
<ol>
<li>客户端发送 TLS 版本，加密算法，<code>客户端 Key Share</code></li>
<li>服务端发送确认使用的 TLS 版本，加密算法，<code>服务端 Key Share</code></li>
<li>各自根据 <code>Key Share</code>，使用 ECDHE 算法算出共享密钥</li>
<li>使用共享密钥进行对称加密</li>
</ol>
<p>可以看到，使用 ECDHE 算法，不仅降低了步骤数量，而且由于 ECHDE 所需要的秘钥长度更短，所以性能也更加优秀。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GIS 数据转换：使用 GDAL 将 GeoJSON 转换为 Shp 数据]]></title>    <link>https://juejin.cn/post/7589074117644894243</link>    <guid>https://juejin.cn/post/7589074117644894243</guid>    <pubDate>2025-12-29T13:21:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589074117644894243" data-draft-id="7589104492882952244" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GIS 数据转换：使用 GDAL 将 GeoJSON 转换为 Shp 数据"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-29T13:21:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GIS之路"/> <meta itemprop="url" content="https://juejin.cn/user/4346787284915481"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GIS 数据转换：使用 GDAL 将 GeoJSON 转换为 Shp 数据
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4346787284915481/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GIS之路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T13:21:27.000Z" title="Mon Dec 29 2025 13:21:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<blockquote>
<p>❝</p>
<p>GeoJSON 作为一种通用的地理数据格式，可以很方便地用于共享交换。在 GIS 开发中，经常需要进行数据的转换处理，其中常见的便是将 GeoJSON 转换为 Shp 数据进行展示。</p>
</blockquote>
<p>在之前的文章中讲了如何使用<code>GDAL</code>或者<code>ogr2ogr</code>工具将<code>txt</code>以及<code>csv</code>文本数据转换为<code>Shp</code>格式，本篇教程在之前一系列文章的基础上讲解如何使用<code>GDAL</code>将<code>GeoJSON</code>转换为<code>Shp</code>数据。</p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">GDAL 简介</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">GDAL 下载安装</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">GDAL 开发起步</a></li>
</ul>
<p>如果你还没有看过，建议从以上内容开始。</p>
<h2 data-id="heading-1">1. 开发环境</h2>
<p>本文使用如下开发环境，以供参考。</p>
<p>时间：<code>2025年</code></p>
<p>系统：<code>Windows 11</code></p>
<p>Python：<code>3.11.7</code></p>
<p>GDAL：<code>3.11.1</code></p>
<h2 data-id="heading-2">2. 数据准备</h2>
<p><code>GeoJSON</code>是一种用于编码各种地理数据结构的格式，采用<code>JSON</code>方式表示。在<code>WebGIS</code>开发中，被广泛应用于数据传输和共享交换。</p>
<p>有关<code>GeoJSON</code>数据的详细介绍，请参考往期文章：<strong>GeoJSON 数据简介</strong></p>
<p><strong>如下是本文选取的部分国家边界范围的GeoJSON数据结构：</strong></p>
<pre><code class="hljs language-less" lang="less">{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">FeatureCollection</span>","<span class="hljs-selector-tag">features</span>":<span class="hljs-selector-attr">[{<span class="hljs-string">"type"</span>:<span class="hljs-string">"Feature"</span>,<span class="hljs-string">"id"</span>:<span class="hljs-string">"AFG"</span>,<span class="hljs-string">"properties"</span>:{<span class="hljs-string">"name"</span>:<span class="hljs-string">"Afghanistan"</span>},<span class="hljs-string">"geometry"</span>:{<span class="hljs-string">"type"</span>:<span class="hljs-string">"Polygon"</span>,<span class="hljs-string">"coordinates"</span>:[[[61.210817,35.650072]</span>,<span class="hljs-selector-attr">[62.230651,35.270664]</span>,<span class="hljs-selector-attr">[62.984662,35.404041]</span>,<span class="hljs-selector-attr">[63.193538,35.857166]</span>,<span class="hljs-selector-attr">[63.982896,36.007957]</span>,<span class="hljs-selector-attr">[64.546479,36.312073]</span>,<span class="hljs-selector-attr">[64.746105,37.111818]</span>,<span class="hljs-selector-attr">[65.588948,37.305217]</span>,<span class="hljs-selector-attr">[65.745631,37.661164]</span>,<span class="hljs-selector-attr">[66.217385,37.39379]</span>,<span class="hljs-selector-attr">[66.518607,37.362784]</span>,<span class="hljs-selector-attr">[67.075782,37.356144]</span>,<span class="hljs-selector-attr">[67.83,37.144994]</span>,<span class="hljs-selector-attr">[68.135562,37.023115]</span>,<span class="hljs-selector-attr">[68.859446,37.344336]</span>,<span class="hljs-selector-attr">[69.196273,37.151144]</span>,<span class="hljs-selector-attr">[69.518785,37.608997]</span>,<span class="hljs-selector-attr">[70.116578,37.588223]</span>,<span class="hljs-selector-attr">[70.270574,37.735165]</span>,<span class="hljs-selector-attr">[70.376304,38.138396]</span>,<span class="hljs-selector-attr">[70.806821,38.486282]</span>,<span class="hljs-selector-attr">[71.348131,38.258905]</span>,<span class="hljs-selector-attr">[71.239404,37.953265]</span>,<span class="hljs-selector-attr">[71.541918,37.905774]</span>,<span class="hljs-selector-attr">[71.448693,37.065645]</span>,<span class="hljs-selector-attr">[71.844638,36.738171]</span>,<span class="hljs-selector-attr">[72.193041,36.948288]</span>,<span class="hljs-selector-attr">[72.63689,37.047558]</span>,<span class="hljs-selector-attr">[73.260056,37.495257]</span>,<span class="hljs-selector-attr">[73.948696,37.421566]</span>,<span class="hljs-selector-attr">[74.980002,37.41999]</span>,<span class="hljs-selector-attr">[75.158028,37.133031]</span>,<span class="hljs-selector-attr">[74.575893,37.020841]</span>,<span class="hljs-selector-attr">[74.067552,36.836176]</span>,<span class="hljs-selector-attr">[72.920025,36.720007]</span>,<span class="hljs-selector-attr">[71.846292,36.509942]</span>,<span class="hljs-selector-attr">[71.262348,36.074388]</span>,<span class="hljs-selector-attr">[71.498768,35.650563]</span>,<span class="hljs-selector-attr">[71.613076,35.153203]</span>,<span class="hljs-selector-attr">[71.115019,34.733126]</span>,<span class="hljs-selector-attr">[71.156773,34.348911]</span>,<span class="hljs-selector-attr">[70.881803,33.988856]</span>,<span class="hljs-selector-attr">[69.930543,34.02012]</span>,<span class="hljs-selector-attr">[70.323594,33.358533]</span>,<span class="hljs-selector-attr">[69.687147,33.105499]</span>,<span class="hljs-selector-attr">[69.262522,32.501944]</span>,<span class="hljs-selector-attr">[69.317764,31.901412]</span>,<span class="hljs-selector-attr">[68.926677,31.620189]</span>,<span class="hljs-selector-attr">[68.556932,31.71331]</span>,<span class="hljs-selector-attr">[67.792689,31.58293]</span>,<span class="hljs-selector-attr">[67.683394,31.303154]</span>,<span class="hljs-selector-attr">[66.938891,31.304911]</span>,<span class="hljs-selector-attr">[66.381458,30.738899]</span>,<span class="hljs-selector-attr">[66.346473,29.887943]</span>,<span class="hljs-selector-attr">[65.046862,29.472181]</span>,<span class="hljs-selector-attr">[64.350419,29.560031]</span>,<span class="hljs-selector-attr">[64.148002,29.340819]</span>,<span class="hljs-selector-attr">[63.550261,29.468331]</span>,<span class="hljs-selector-attr">[62.549857,29.318572]</span>,<span class="hljs-selector-attr">[60.874248,29.829239]</span>,<span class="hljs-selector-attr">[61.781222,30.73585]</span>,<span class="hljs-selector-attr">[61.699314,31.379506]</span>,<span class="hljs-selector-attr">[60.941945,31.548075]</span>,<span class="hljs-selector-attr">[60.863655,32.18292]</span>,<span class="hljs-selector-attr">[60.536078,32.981269]</span>,<span class="hljs-selector-attr">[60.9637,33.528832]</span>,<span class="hljs-selector-attr">[60.52843,33.676446]</span>,<span class="hljs-selector-attr">[60.803193,34.404102]</span>,<span class="hljs-selector-attr">[61.210817,35.650072]</span>]]}},
{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Feature</span>","<span class="hljs-selector-tag">id</span>":"<span class="hljs-selector-tag">AGO</span>","<span class="hljs-selector-tag">properties</span>":{"<span class="hljs-selector-tag">name</span>":"<span class="hljs-selector-tag">Angola</span>"},"<span class="hljs-selector-tag">geometry</span>":{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">MultiPolygon</span>","<span class="hljs-selector-tag">coordinates</span>":<span class="hljs-selector-attr">[[[[16.326528,-5.87747]</span>,<span class="hljs-selector-attr">[16.57318,-6.622645]</span>,<span class="hljs-selector-attr">[16.860191,-7.222298]</span>,<span class="hljs-selector-attr">[17.089996,-7.545689]</span>,<span class="hljs-selector-attr">[17.47297,-8.068551]</span>,<span class="hljs-selector-attr">[18.134222,-7.987678]</span>,<span class="hljs-selector-attr">[18.464176,-7.847014]</span>,<span class="hljs-selector-attr">[19.016752,-7.988246]</span>,<span class="hljs-selector-attr">[19.166613,-7.738184]</span>,<span class="hljs-selector-attr">[19.417502,-7.155429]</span>,<span class="hljs-selector-attr">[20.037723,-7.116361]</span>,<span class="hljs-selector-attr">[20.091622,-6.94309]</span>,<span class="hljs-selector-attr">[20.601823,-6.939318]</span>,<span class="hljs-selector-attr">[20.514748,-7.299606]</span>,<span class="hljs-selector-attr">[21.728111,-7.290872]</span>,<span class="hljs-selector-attr">[21.746456,-7.920085]</span>,<span class="hljs-selector-attr">[21.949131,-8.305901]</span>,<span class="hljs-selector-attr">[21.801801,-8.908707]</span>,<span class="hljs-selector-attr">[21.875182,-9.523708]</span>,<span class="hljs-selector-attr">[22.208753,-9.894796]</span>,<span class="hljs-selector-attr">[22.155268,-11.084801]</span>,<span class="hljs-selector-attr">[22.402798,-10.993075]</span>,<span class="hljs-selector-attr">[22.837345,-11.017622]</span>,<span class="hljs-selector-attr">[23.456791,-10.867863]</span>,<span class="hljs-selector-attr">[23.912215,-10.926826]</span>,<span class="hljs-selector-attr">[24.017894,-11.237298]</span>,<span class="hljs-selector-attr">[23.904154,-11.722282]</span>,<span class="hljs-selector-attr">[24.079905,-12.191297]</span>,<span class="hljs-selector-attr">[23.930922,-12.565848]</span>,<span class="hljs-selector-attr">[24.016137,-12.911046]</span>,<span class="hljs-selector-attr">[21.933886,-12.898437]</span>,<span class="hljs-selector-attr">[21.887843,-16.08031]</span>,<span class="hljs-selector-attr">[22.562478,-16.898451]</span>,<span class="hljs-selector-attr">[23.215048,-17.523116]</span>,<span class="hljs-selector-attr">[21.377176,-17.930636]</span>,<span class="hljs-selector-attr">[18.956187,-17.789095]</span>,<span class="hljs-selector-attr">[18.263309,-17.309951]</span>,<span class="hljs-selector-attr">[14.209707,-17.353101]</span>,<span class="hljs-selector-attr">[14.058501,-17.423381]</span>,<span class="hljs-selector-attr">[13.462362,-16.971212]</span>,<span class="hljs-selector-attr">[12.814081,-16.941343]</span>,<span class="hljs-selector-attr">[12.215461,-17.111668]</span>,<span class="hljs-selector-attr">[11.734199,-17.301889]</span>,<span class="hljs-selector-attr">[11.640096,-16.673142]</span>,<span class="hljs-selector-attr">[11.778537,-15.793816]</span>,<span class="hljs-selector-attr">[12.123581,-14.878316]</span>,<span class="hljs-selector-attr">[12.175619,-14.449144]</span>,<span class="hljs-selector-attr">[12.500095,-13.5477]</span>,<span class="hljs-selector-attr">[12.738479,-13.137906]</span>,<span class="hljs-selector-attr">[13.312914,-12.48363]</span>,<span class="hljs-selector-attr">[13.633721,-12.038645]</span>,<span class="hljs-selector-attr">[13.738728,-11.297863]</span>,<span class="hljs-selector-attr">[13.686379,-10.731076]</span>,<span class="hljs-selector-attr">[13.387328,-10.373578]</span>,<span class="hljs-selector-attr">[13.120988,-9.766897]</span>,<span class="hljs-selector-attr">[12.87537,-9.166934]</span>,<span class="hljs-selector-attr">[12.929061,-8.959091]</span>,<span class="hljs-selector-attr">[13.236433,-8.562629]</span>,<span class="hljs-selector-attr">[12.93304,-7.596539]</span>,<span class="hljs-selector-attr">[12.728298,-6.927122]</span>,<span class="hljs-selector-attr">[12.227347,-6.294448]</span>,<span class="hljs-selector-attr">[12.322432,-6.100092]</span>,<span class="hljs-selector-attr">[12.735171,-5.965682]</span>,<span class="hljs-selector-attr">[13.024869,-5.984389]</span>,<span class="hljs-selector-attr">[13.375597,-5.864241]</span>,<span class="hljs-selector-attr">[16.326528,-5.87747]</span>]],<span class="hljs-selector-attr">[[[12.436688,-5.684304]</span>,<span class="hljs-selector-attr">[12.182337,-5.789931]</span>,<span class="hljs-selector-attr">[11.914963,-5.037987]</span>,<span class="hljs-selector-attr">[12.318608,-4.60623]</span>,<span class="hljs-selector-attr">[12.62076,-4.438023]</span>,<span class="hljs-selector-attr">[12.995517,-4.781103]</span>,<span class="hljs-selector-attr">[12.631612,-4.991271]</span>,<span class="hljs-selector-attr">[12.468004,-5.248362]</span>,<span class="hljs-selector-attr">[12.436688,-5.684304]</span>]]]}},
{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Feature</span>","<span class="hljs-selector-tag">id</span>":"<span class="hljs-selector-tag">ALB</span>","<span class="hljs-selector-tag">properties</span>":{"<span class="hljs-selector-tag">name</span>":"<span class="hljs-selector-tag">Albania</span>"},"<span class="hljs-selector-tag">geometry</span>":{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Polygon</span>","<span class="hljs-selector-tag">coordinates</span>":<span class="hljs-selector-attr">[[[20.590247,41.855404]</span>,<span class="hljs-selector-attr">[20.463175,41.515089]</span>,<span class="hljs-selector-attr">[20.605182,41.086226]</span>,<span class="hljs-selector-attr">[21.02004,40.842727]</span>,<span class="hljs-selector-attr">[20.99999,40.580004]</span>,<span class="hljs-selector-attr">[20.674997,40.435]</span>,<span class="hljs-selector-attr">[20.615,40.110007]</span>,<span class="hljs-selector-attr">[20.150016,39.624998]</span>,<span class="hljs-selector-attr">[19.98,39.694993]</span>,<span class="hljs-selector-attr">[19.960002,39.915006]</span>,<span class="hljs-selector-attr">[19.406082,40.250773]</span>,<span class="hljs-selector-attr">[19.319059,40.72723]</span>,<span class="hljs-selector-attr">[19.40355,41.409566]</span>,<span class="hljs-selector-attr">[19.540027,41.719986]</span>,<span class="hljs-selector-attr">[19.371769,41.877548]</span>,<span class="hljs-selector-attr">[19.304486,42.195745]</span>,<span class="hljs-selector-attr">[19.738051,42.688247]</span>,<span class="hljs-selector-attr">[19.801613,42.500093]</span>,<span class="hljs-selector-attr">[20.0707,42.58863]</span>,<span class="hljs-selector-attr">[20.283755,42.32026]</span>,<span class="hljs-selector-attr">[20.52295,42.21787]</span>,<span class="hljs-selector-attr">[20.590247,41.855404]</span>]]}},
{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Feature</span>","<span class="hljs-selector-tag">id</span>":"<span class="hljs-selector-tag">ARE</span>","<span class="hljs-selector-tag">properties</span>":{"<span class="hljs-selector-tag">name</span>":"<span class="hljs-selector-tag">United</span> <span class="hljs-selector-tag">Arab</span> <span class="hljs-selector-tag">Emirates</span>"},"<span class="hljs-selector-tag">geometry</span>":{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Polygon</span>","<span class="hljs-selector-tag">coordinates</span>":<span class="hljs-selector-attr">[[[51.579519,24.245497]</span>,<span class="hljs-selector-attr">[51.757441,24.294073]</span>,<span class="hljs-selector-attr">[51.794389,24.019826]</span>,<span class="hljs-selector-attr">[52.577081,24.177439]</span>,<span class="hljs-selector-attr">[53.404007,24.151317]</span>,<span class="hljs-selector-attr">[54.008001,24.121758]</span>,<span class="hljs-selector-attr">[54.693024,24.797892]</span>,<span class="hljs-selector-attr">[55.439025,25.439145]</span>,<span class="hljs-selector-attr">[56.070821,26.055464]</span>,<span class="hljs-selector-attr">[56.261042,25.714606]</span>,<span class="hljs-selector-attr">[56.396847,24.924732]</span>,<span class="hljs-selector-attr">[55.886233,24.920831]</span>,<span class="hljs-selector-attr">[55.804119,24.269604]</span>,<span class="hljs-selector-attr">[55.981214,24.130543]</span>,<span class="hljs-selector-attr">[55.528632,23.933604]</span>,<span class="hljs-selector-attr">[55.525841,23.524869]</span>,<span class="hljs-selector-attr">[55.234489,23.110993]</span>,<span class="hljs-selector-attr">[55.208341,22.70833]</span>,<span class="hljs-selector-attr">[55.006803,22.496948]</span>,<span class="hljs-selector-attr">[52.000733,23.001154]</span>,<span class="hljs-selector-attr">[51.617708,24.014219]</span>,<span class="hljs-selector-attr">[51.579519,24.245497]</span>]]}},
{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Feature</span>","<span class="hljs-selector-tag">id</span>":"<span class="hljs-selector-tag">ARG</span>","<span class="hljs-selector-tag">properties</span>":{"<span class="hljs-selector-tag">name</span>":"<span class="hljs-selector-tag">Argentina</span>"},"<span class="hljs-selector-tag">geometry</span>":{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">MultiPolygon</span>","<span class="hljs-selector-tag">coordinates</span>":<span class="hljs-selector-attr">[[[[-65.5,-55.2]</span>,<span class="hljs-selector-attr">[-66.45,-55.25]</span>,<span class="hljs-selector-attr">[-66.95992,-54.89681]</span>,<span class="hljs-selector-attr">[-67.56244,-54.87001]</span>,<span class="hljs-selector-attr">[-68.63335,-54.8695]</span>,<span class="hljs-selector-attr">[-68.63401,-52.63637]</span>,<span class="hljs-selector-attr">[-68.25,-53.1]</span>,<span class="hljs-selector-attr">[-67.75,-53.85]</span>,<span class="hljs-selector-attr">[-66.45,-54.45]</span>,<span class="hljs-selector-attr">[-65.05,-54.7]</span>,<span class="hljs-selector-attr">[-65.5,-55.2]</span>]],<span class="hljs-selector-attr">[[[-64.964892,-22.075862]</span>,<span class="hljs-selector-attr">[-64.377021,-22.798091]</span>,<span class="hljs-selector-attr">[-63.986838,-21.993644]</span>,<span class="hljs-selector-attr">[-62.846468,-22.034985]</span>,<span class="hljs-selector-attr">[-62.685057,-22.249029]</span>,<span class="hljs-selector-attr">[-60.846565,-23.880713]</span>,<span class="hljs-selector-attr">[-60.028966,-24.032796]</span>,<span class="hljs-selector-attr">[-58.807128,-24.771459]</span>,<span class="hljs-selector-attr">[-57.777217,-25.16234]</span>,<span class="hljs-selector-attr">[-57.63366,-25.603657]</span>,<span class="hljs-selector-attr">[-58.618174,-27.123719]</span>,<span class="hljs-selector-attr">[-57.60976,-27.395899]</span>,<span class="hljs-selector-attr">[-56.486702,-27.548499]</span>,<span class="hljs-selector-attr">[-55.695846,-27.387837]</span>,<span class="hljs-selector-attr">[-54.788795,-26.621786]</span>,<span class="hljs-selector-attr">[-54.625291,-25.739255]</span>,<span class="hljs-selector-attr">[-54.13005,-25.547639]</span>,<span class="hljs-selector-attr">[-53.628349,-26.124865]</span>,<span class="hljs-selector-attr">[-53.648735,-26.923473]</span>,<span class="hljs-selector-attr">[-54.490725,-27.474757]</span>,<span class="hljs-selector-attr">[-55.162286,-27.881915]</span>,<span class="hljs-selector-attr">[-56.2909,-28.852761]</span>,<span class="hljs-selector-attr">[-57.625133,-30.216295]</span>,<span class="hljs-selector-attr">[-57.874937,-31.016556]</span>,<span class="hljs-selector-attr">[-58.14244,-32.044504]</span>,<span class="hljs-selector-attr">[-58.132648,-33.040567]</span>,<span class="hljs-selector-attr">[-58.349611,-33.263189]</span>,<span class="hljs-selector-attr">[-58.427074,-33.909454]</span>,<span class="hljs-selector-attr">[-58.495442,-34.43149]</span>,<span class="hljs-selector-attr">[-57.22583,-35.288027]</span>,<span class="hljs-selector-attr">[-57.362359,-35.97739]</span>,<span class="hljs-selector-attr">[-56.737487,-36.413126]</span>,<span class="hljs-selector-attr">[-56.788285,-36.901572]</span>,<span class="hljs-selector-attr">[-57.749157,-38.183871]</span>,<span class="hljs-selector-attr">[-59.231857,-38.72022]</span>,<span class="hljs-selector-attr">[-61.237445,-38.928425]</span>,<span class="hljs-selector-attr">[-62.335957,-38.827707]</span>,<span class="hljs-selector-attr">[-62.125763,-39.424105]</span>,<span class="hljs-selector-attr">[-62.330531,-40.172586]</span>,<span class="hljs-selector-attr">[-62.145994,-40.676897]</span>,<span class="hljs-selector-attr">[-62.745803,-41.028761]</span>,<span class="hljs-selector-attr">[-63.770495,-41.166789]</span>,<span class="hljs-selector-attr">[-64.73209,-40.802677]</span>,<span class="hljs-selector-attr">[-65.118035,-41.064315]</span>,<span class="hljs-selector-attr">[-64.978561,-42.058001]</span>,<span class="hljs-selector-attr">[-64.303408,-42.359016]</span>,<span class="hljs-selector-attr">[-63.755948,-42.043687]</span>,<span class="hljs-selector-attr">[-63.458059,-42.563138]</span>,<span class="hljs-selector-attr">[-64.378804,-42.873558]</span>,<span class="hljs-selector-attr">[-65.181804,-43.495381]</span>,<span class="hljs-selector-attr">[-65.328823,-44.501366]</span>,<span class="hljs-selector-attr">[-65.565269,-45.036786]</span>,<span class="hljs-selector-attr">[-66.509966,-45.039628]</span>,<span class="hljs-selector-attr">[-67.293794,-45.551896]</span>,<span class="hljs-selector-attr">[-67.580546,-46.301773]</span>,<span class="hljs-selector-attr">[-66.597066,-47.033925]</span>,<span class="hljs-selector-attr">[-65.641027,-47.236135]</span>,<span class="hljs-selector-attr">[-65.985088,-48.133289]</span>,<span class="hljs-selector-attr">[-67.166179,-48.697337]</span>,<span class="hljs-selector-attr">[-67.816088,-49.869669]</span>,<span class="hljs-selector-attr">[-68.728745,-50.264218]</span>,<span class="hljs-selector-attr">[-69.138539,-50.73251]</span>,<span class="hljs-selector-attr">[-68.815561,-51.771104]</span>,<span class="hljs-selector-attr">[-68.149995,-52.349983]</span>,<span class="hljs-selector-attr">[-68.571545,-52.299444]</span>,<span class="hljs-selector-attr">[-69.498362,-52.142761]</span>,<span class="hljs-selector-attr">[-71.914804,-52.009022]</span>,<span class="hljs-selector-attr">[-72.329404,-51.425956]</span>,<span class="hljs-selector-attr">[-72.309974,-50.67701]</span>,<span class="hljs-selector-attr">[-72.975747,-50.74145]</span>,<span class="hljs-selector-attr">[-73.328051,-50.378785]</span>,<span class="hljs-selector-attr">[-73.415436,-49.318436]</span>,<span class="hljs-selector-attr">[-72.648247,-48.878618]</span>,<span class="hljs-selector-attr">[-72.331161,-48.244238]</span>,<span class="hljs-selector-attr">[-72.447355,-47.738533]</span>,<span class="hljs-selector-attr">[-71.917258,-46.884838]</span>,<span class="hljs-selector-attr">[-71.552009,-45.560733]</span>,<span class="hljs-selector-attr">[-71.659316,-44.973689]</span>,<span class="hljs-selector-attr">[-71.222779,-44.784243]</span>,<span class="hljs-selector-attr">[-71.329801,-44.407522]</span>,<span class="hljs-selector-attr">[-71.793623,-44.207172]</span>,<span class="hljs-selector-attr">[-71.464056,-43.787611]</span>,<span class="hljs-selector-attr">[-71.915424,-43.408565]</span>,<span class="hljs-selector-attr">[-72.148898,-42.254888]</span>,<span class="hljs-selector-attr">[-71.746804,-42.051386]</span>,<span class="hljs-selector-attr">[-71.915734,-40.832339]</span>,<span class="hljs-selector-attr">[-71.680761,-39.808164]</span>,<span class="hljs-selector-attr">[-71.413517,-38.916022]</span>,<span class="hljs-selector-attr">[-70.814664,-38.552995]</span>,<span class="hljs-selector-attr">[-71.118625,-37.576827]</span>,<span class="hljs-selector-attr">[-71.121881,-36.658124]</span>,<span class="hljs-selector-attr">[-70.364769,-36.005089]</span>,<span class="hljs-selector-attr">[-70.388049,-35.169688]</span>,<span class="hljs-selector-attr">[-69.817309,-34.193571]</span>,<span class="hljs-selector-attr">[-69.814777,-33.273886]</span>,<span class="hljs-selector-attr">[-70.074399,-33.09121]</span>,<span class="hljs-selector-attr">[-70.535069,-31.36501]</span>,<span class="hljs-selector-attr">[-69.919008,-30.336339]</span>,<span class="hljs-selector-attr">[-70.01355,-29.367923]</span>,<span class="hljs-selector-attr">[-69.65613,-28.459141]</span>,<span class="hljs-selector-attr">[-69.001235,-27.521214]</span>,<span class="hljs-selector-attr">[-68.295542,-26.89934]</span>,<span class="hljs-selector-attr">[-68.5948,-26.506909]</span>,<span class="hljs-selector-attr">[-68.386001,-26.185016]</span>,<span class="hljs-selector-attr">[-68.417653,-24.518555]</span>,<span class="hljs-selector-attr">[-67.328443,-24.025303]</span>,<span class="hljs-selector-attr">[-66.985234,-22.986349]</span>,<span class="hljs-selector-attr">[-67.106674,-22.735925]</span>,<span class="hljs-selector-attr">[-66.273339,-21.83231]</span>,<span class="hljs-selector-attr">[-64.964892,-22.075862]</span>]]]}},
{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Feature</span>","<span class="hljs-selector-tag">id</span>":"<span class="hljs-selector-tag">ARM</span>","<span class="hljs-selector-tag">properties</span>":{"<span class="hljs-selector-tag">name</span>":"<span class="hljs-selector-tag">Armenia</span>"},"<span class="hljs-selector-tag">geometry</span>":{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Polygon</span>","<span class="hljs-selector-tag">coordinates</span>":<span class="hljs-selector-attr">[[[43.582746,41.092143]</span>,<span class="hljs-selector-attr">[44.97248,41.248129]</span>,<span class="hljs-selector-attr">[45.179496,40.985354]</span>,<span class="hljs-selector-attr">[45.560351,40.81229]</span>,<span class="hljs-selector-attr">[45.359175,40.561504]</span>,<span class="hljs-selector-attr">[45.891907,40.218476]</span>,<span class="hljs-selector-attr">[45.610012,39.899994]</span>,<span class="hljs-selector-attr">[46.034534,39.628021]</span>,<span class="hljs-selector-attr">[46.483499,39.464155]</span>,<span class="hljs-selector-attr">[46.50572,38.770605]</span>,<span class="hljs-selector-attr">[46.143623,38.741201]</span>,<span class="hljs-selector-attr">[45.735379,39.319719]</span>,<span class="hljs-selector-attr">[45.739978,39.473999]</span>,<span class="hljs-selector-attr">[45.298145,39.471751]</span>,<span class="hljs-selector-attr">[45.001987,39.740004]</span>,<span class="hljs-selector-attr">[44.79399,39.713003]</span>,<span class="hljs-selector-attr">[44.400009,40.005]</span>,<span class="hljs-selector-attr">[43.656436,40.253564]</span>,<span class="hljs-selector-attr">[43.752658,40.740201]</span>,<span class="hljs-selector-attr">[43.582746,41.092143]</span>]]}},
{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Feature</span>","<span class="hljs-selector-tag">id</span>":"<span class="hljs-selector-tag">ATA</span>","<span class="hljs-selector-tag">properties</span>":{"<span class="hljs-selector-tag">name</span>":"<span class="hljs-selector-tag">Antarctica</span>"},"<span class="hljs-selector-tag">geometry</span>":{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">MultiPolygon</span>","<span class="hljs-selector-tag">coordinates</span>":<span class="hljs-selector-attr">[[[[-59.572095,-80.040179]</span>,<span class="hljs-selector-attr">[-59.865849,-80.549657]</span>,<span class="hljs-selector-attr">[-60.159656,-81.000327]</span>,<span class="hljs-selector-attr">[-62.255393,-80.863178]</span>,<span class="hljs-selector-attr">[-64.488125,-80.921934]</span>,<span class="hljs-selector-attr">[-65.741666,-80.588827]</span>,<span class="hljs-selector-attr">[-65.741666,-80.549657]</span>,<span class="hljs-selector-attr">[-66.290031,-80.255773]</span>,<span class="hljs-selector-attr">[-64.037688,-80.294944]</span>,<span class="hljs-selector-attr">[-61.883246,-80.39287]</span>,<span class="hljs-selector-attr">[-61.138976,-79.981371]</span>,<span class="hljs-selector-attr">[-60.610119,-79.628679]</span>,<span class="hljs-selector-attr">[-59.572095,-80.040179]</span>]],<span class="hljs-selector-attr">[[[-159.208184,-79.497059]</span>,<span class="hljs-selector-attr">[-161.127601,-79.634209]</span>,<span class="hljs-selector-attr">[-162.439847,-79.281465]</span>,<span class="hljs-selector-attr">[-163.027408,-78.928774]</span>,<span class="hljs-selector-attr">[-163.066604,-78.869966]</span>,<span class="hljs-selector-attr">[-163.712896,-78.595667]</span>,<span class="hljs-selector-attr">[-163.712896,-78.595667]</span>,<span class="hljs-selector-attr">[-163.105801,-78.223338]</span>,<span class="hljs-selector-attr">[-161.245113,-78.380176]</span>,<span class="hljs-selector-attr">[-160.246208,-78.693645]</span>,<span class="hljs-selector-attr">[-159.482405,-79.046338]</span>,<span class="hljs-selector-attr">[-159.208184,-79.497059]</span>]],<span class="hljs-selector-attr">[[[-45.154758,-78.04707]</span>,<span class="hljs-selector-attr">[-43.920828,-78.478103]</span>,<span class="hljs-selector-attr">[-43.48995,-79.08556]</span>,<span class="hljs-selector-attr">[-43.372438,-79.516645]</span>,<span class="hljs-selector-attr">[-43.333267,-80.026123]</span>,<span class="hljs-selector-attr">[-44.880537,-80.339644]</span>,<span class="hljs-selector-attr">[-46.506174,-80.594357]</span>,<span class="hljs-selector-attr">[-48.386421,-80.829485]</span>,<span class="hljs-selector-attr">[-50.482107,-81.025442]</span>,<span class="hljs-selector-attr">[-52.851988,-80.966685]</span>,<span class="hljs-selector-attr">[-54.164259,-80.633528]</span>,<span class="hljs-selector-attr">[-53.987991,-80.222028]</span>,<span class="hljs-selector-attr">[-51.853134,-79.94773]</span>,<span class="hljs-selector-attr">[-50.991326,-79.614623]</span>,<span class="hljs-selector-attr">[-50.364595,-79.183487]</span>,<span class="hljs-selector-attr">[-49.914131,-78.811209]</span>,<span class="hljs-selector-attr">[-49.306959,-78.458569]</span>,<span class="hljs-selector-attr">[-48.660616,-78.047018]</span>,<span class="hljs-selector-attr">[-48.660616,-78.047019]</span>,<span class="hljs-selector-attr">[-48.151396,-78.04707]</span>,<span class="hljs-selector-attr">[-46.662857,-77.831476]</span>,<span class="hljs-selector-attr">[-45.154758,-78.04707]</span>]],<span class="hljs-selector-attr">[[[-121.211511,-73.50099]</span>,<span class="hljs-selector-attr">[-119.918851,-73.657725]</span>,<span class="hljs-selector-attr">[-118.724143,-73.481353]</span>,<span class="hljs-selector-attr">[-119.292119,-73.834097]</span>,<span class="hljs-selector-attr">[-120.232217,-74.08881]</span>,<span class="hljs-selector-attr">[-121.62283,-74.010468]</span>,<span class="hljs-selector-attr">[-122.621735,-73.657778]</span>,<span class="hljs-selector-attr">[-122.621735,-73.657777]</span>,<span class="hljs-selector-attr">[-122.406245,-73.324619]</span>,<span class="hljs-selector-attr">[-121.211511,-73.50099]</span>]],<span class="hljs-selector-attr">[[[-125.559566,-73.481353]</span>,<span class="hljs-selector-attr">[-124.031882,-73.873268]</span>,<span class="hljs-selector-attr">[-124.619469,-73.834097]</span>,<span class="hljs-selector-attr">[-125.912181,-73.736118]</span>,<span class="hljs-selector-attr">[-127.28313,-73.461769]</span>,<span class="hljs-selector-attr">[-127.28313,-73.461768]</span>,<span class="hljs-selector-attr">[-126.558472,-73.246226]</span>,<span class="hljs-selector-attr">[-125.559566,-73.481353]</span>]],<span class="hljs-selector-attr">[[[-98.98155,-71.933334]</span>,<span class="hljs-selector-attr">[-97.884743,-72.070535]</span>,<span class="hljs-selector-attr">[-96.787937,-71.952971]</span>,<span class="hljs-selector-attr">[-96.20035,-72.521205]</span>,<span class="hljs-selector-attr">[-96.983765,-72.442864]</span>,<span class="hljs-selector-attr">[-98.198083,-72.482035]</span>,<span class="hljs-selector-attr">[-99.432013,-72.442864]</span>,<span class="hljs-selector-attr">[-100.783455,-72.50162]</span>,<span class="hljs-selector-attr">[-101.801868,-72.305663]</span>,<span class="hljs-selector-attr">[-102.330725,-71.894164]</span>,<span class="hljs-selector-attr">[-102.330725,-71.894164]</span>,<span class="hljs-selector-attr">[-101.703967,-71.717792]</span>,<span class="hljs-selector-attr">[-100.430919,-71.854993]</span>,<span class="hljs-selector-attr">[-98.98155,-71.933334]</span>]],<span class="hljs-selector-attr">[[[-68.451346,-70.955823]</span>,<span class="hljs-selector-attr">[-68.333834,-71.406493]</span>,<span class="hljs-selector-attr">[-68.510128,-71.798407]</span>,<span class="hljs-selector-attr">[-68.784297,-72.170736]</span>,<span class="hljs-selector-attr">[-69.959471,-72.307885]</span>,<span class="hljs-selector-attr">[-71.075889,-72.503842]</span>,<span class="hljs-selector-attr">[-72.388134,-72.484257]</span>,<span class="hljs-selector-attr">[-71.8985,-72.092343]</span>,<span class="hljs-selector-attr">[-73.073622,-72.229492]</span>,<span class="hljs-selector-attr">[-74.19004,-72.366693]</span>,<span class="hljs-selector-attr">[-74.953895,-72.072757]</span>,<span class="hljs-selector-attr">[-75.012625,-71.661258]</span>,<span class="hljs-selector-attr">[-73.915819,-71.269345]</span>,<span class="hljs-selector-attr">[-73.915819,-71.269344]</span>,<span class="hljs-selector-attr">[-73.230331,-71.15178]</span>,<span class="hljs-selector-attr">[-72.074717,-71.190951]</span>,<span class="hljs-selector-attr">[-71.780962,-70.681473]</span>,<span class="hljs-selector-attr">[-71.72218,-70.309196]</span>,<span class="hljs-selector-attr">[-71.741791,-69.505782]</span>,<span class="hljs-selector-attr">[-71.173815,-69.035475]</span>,<span class="hljs-selector-attr">[-70.253252,-68.87874]</span>,<span class="hljs-selector-attr">[-69.724447,-69.251017]</span>,<span class="hljs-selector-attr">[-69.489422,-69.623346]</span>,<span class="hljs-selector-attr">[-69.058518,-70.074016]</span>,<span class="hljs-selector-attr">[-68.725541,-70.505153]</span>,<span class="hljs-selector-attr">[-68.451346,-70.955823]</span>]],<span class="hljs-selector-attr">[[[-58.614143,-64.152467]</span>,<span class="hljs-selector-attr">[-59.045073,-64.36801]</span>,<span class="hljs-selector-attr">[-59.789342,-64.211223]</span>,<span class="hljs-selector-attr">[-60.611928,-64.309202]</span>,<span class="hljs-selector-attr">[-61.297416,-64.54433]</span>,<span class="hljs-selector-attr">[-62.0221,-64.799094]</span>,<span class="hljs-selector-attr">[-62.51176,-65.09303]</span>,<span class="hljs-selector-attr">[-62.648858,-65.484942]</span>,<span class="hljs-selector-attr">[-62.590128,-65.857219]</span>,<span class="hljs-selector-attr">[-62.120079,-66.190326]</span>,<span class="hljs-selector-attr">[-62.805567,-66.425505]</span>,<span class="hljs-selector-attr">[-63.74569,-66.503847]</span>,<span class="hljs-selector-attr">[-64.294106,-66.837004]</span>,<span class="hljs-selector-attr">[-64.881693,-67.150474]</span>,<span class="hljs-selector-attr">[-65.508425,-67.58161]</span>,<span class="hljs-selector-attr">[-65.665082,-67.953887]</span>,<span class="hljs-selector-attr">[-65.312545,-68.365335]</span>,<span class="hljs-selector-attr">[-64.783715,-68.678908]</span>,<span class="hljs-selector-attr">[-63.961103,-68.913984]</span>,<span class="hljs-selector-attr">[-63.1973,-69.227556]</span>,<span class="hljs-selector-attr">[-62.785955,-69.619419]</span>,<span class="hljs-selector-attr">[-62.570516,-69.991747]</span>,<span class="hljs-selector-attr">[-62.276736,-70.383661]</span>,<span class="hljs-selector-attr">[-61.806661,-70.716768]</span>,<span class="hljs-selector-attr">[-61.512906,-71.089045]</span>,<span class="hljs-selector-attr">[-61.375809,-72.010074]</span>,<span class="hljs-selector-attr">[-61.081977,-72.382351]</span>,<span class="hljs-selector-attr">[-61.003661,-72.774265]</span>,<span class="hljs-selector-attr">[-60.690269,-73.166179]</span>,<span class="hljs-selector-attr">[-60.827367,-73.695242]</span>,<span class="hljs-selector-attr">[-61.375809,-74.106742]</span>,<span class="hljs-selector-attr">[-61.96337,-74.439848]</span>,<span class="hljs-selector-attr">[-63.295201,-74.576997]</span>,<span class="hljs-selector-attr">[-63.74569,-74.92974]</span>,<span class="hljs-selector-attr">[-64.352836,-75.262847]</span>,<span class="hljs-selector-attr">[-65.860987,-75.635124]</span>,<span class="hljs-selector-attr">[-67.192818,-75.79191]</span>,<span class="hljs-selector-attr">[-68.446282,-76.007452]</span>,<span class="hljs-selector-attr">[-69.797724,-76.222995]</span>,<span class="hljs-selector-attr">[-70.600724,-76.634494]</span>,<span class="hljs-selector-attr">[-72.206776,-76.673665]</span>,<span class="hljs-selector-attr">[-73.969536,-76.634494]</span>,<span class="hljs-selector-attr">[-75.555977,-76.712887]</span>,<span class="hljs-selector-attr">[-77.24037,-76.712887]</span>,<span class="hljs-selector-attr">[-76.926979,-77.104802]</span>,<span class="hljs-selector-attr">[-75.399294,-77.28107]</span>,<span class="hljs-selector-attr">[-74.282876,-77.55542]</span>,<span class="hljs-selector-attr">[-73.656119,-77.908112]</span>,<span class="hljs-selector-attr">[-74.772536,-78.221633]</span>,<span class="hljs-selector-attr">[-76.4961,-78.123654]</span>,<span class="hljs-selector-attr">[-77.925858,-78.378419]</span>,<span class="hljs-selector-attr">[-77.984666,-78.789918]</span>,<span class="hljs-selector-attr">[-78.023785,-79.181833]</span>,<span class="hljs-selector-attr">[-76.848637,-79.514939]</span>,<span class="hljs-selector-attr">[-76.633224,-79.887216]</span>,<span class="hljs-selector-attr">[-75.360097,-80.259545]</span>,<span class="hljs-selector-attr">[-73.244852,-80.416331]</span>,<span class="hljs-selector-attr">[-71.442946,-80.69063]</span>,<span class="hljs-selector-attr">[-70.013163,-81.004151]</span>,<span class="hljs-selector-attr">[-68.191646,-81.317672]</span>,<span class="hljs-selector-attr">[-65.704279,-81.474458]</span>,<span class="hljs-selector-attr">[-63.25603,-81.748757]</span>,<span class="hljs-selector-attr">[-61.552026,-82.042692]</span>,<span class="hljs-selector-attr">[-59.691416,-82.37585]</span>,<span class="hljs-selector-attr">[-58.712121,-82.846106]</span>,<span class="hljs-selector-attr">[-58.222487,-83.218434]</span>,<span class="hljs-selector-attr">[-57.008117,-82.865691]</span>,<span class="hljs-selector-attr">[-55.362894,-82.571755]</span>,<span class="hljs-selector-attr">[-53.619771,-82.258235]</span>,<span class="hljs-selector-attr">[-51.543644,-82.003521]</span>,<span class="hljs-selector-attr">[-49.76135,-81.729171]</span>,<span class="hljs-selector-attr">[-47.273931,-81.709586]</span>,<span class="hljs-selector-attr">[-44.825708,-81.846735]</span>,<span class="hljs-selector-attr">[-42.808363,-82.081915]</span>,<span class="hljs-selector-attr">[-42.16202,-81.65083]</span>,<span class="hljs-selector-attr">[-40.771433,-81.356894]</span>,<span class="hljs-selector-attr">[-38.244818,-81.337309]</span>,<span class="hljs-selector-attr">[-36.26667,-81.121715]</span>,<span class="hljs-selector-attr">[-34.386397,-80.906172]</span>,<span class="hljs-selector-attr">[-32.310296,-80.769023]</span>,<span class="hljs-selector-attr">[-30.097098,-80.592651]</span>,<span class="hljs-selector-attr">[-28.549802,-80.337938]</span>,<span class="hljs-selector-attr">[-29.254901,-79.985195]</span>,<span class="hljs-selector-attr">[-29.685805,-79.632503]</span>,<span class="hljs-selector-attr">[-29.685805,-79.260226]</span>,<span class="hljs-selector-attr">[-31.624808,-79.299397]</span>,<span class="hljs-selector-attr">[-33.681324,-79.456132]</span>,<span class="hljs-selector-attr">[-35.639912,-79.456132]</span>,<span class="hljs-selector-attr">[-35.914107,-79.083855]</span>,<span class="hljs-selector-attr">[-35.77701,-78.339248]</span>,<span class="hljs-selector-attr">[-35.326546,-78.123654]</span>,<span class="hljs-selector-attr">[-33.896763,-77.888526]</span>,<span class="hljs-selector-attr">[-32.212369,-77.65345]</span>,<span class="hljs-selector-attr">[-30.998051,-77.359515]</span>,<span class="hljs-selector-attr">[-29.783732,-77.065579]</span>,<span class="hljs-selector-attr">[-28.882779,-76.673665]</span>,<span class="hljs-selector-attr">[-27.511752,-76.497345]</span>,<span class="hljs-selector-attr">[-26.160336,-76.360144]</span>,<span class="hljs-selector-attr">[-25.474822,-76.281803]</span>,<span class="hljs-selector-attr">[-23.927552,-76.24258]</span>,<span class="hljs-selector-attr">[-22.458598,-76.105431]</span>,<span class="hljs-selector-attr">[-21.224694,-75.909474]</span>,<span class="hljs-selector-attr">[-20.010375,-75.674346]</span>,<span class="hljs-selector-attr">[-18.913543,-75.439218]</span>,<span class="hljs-selector-attr">[-17.522982,-75.125698]</span>,<span class="hljs-selector-attr">[-16.641589,-74.79254]</span>,<span class="hljs-selector-attr">[-15.701491,-74.498604]</span>,<span class="hljs-selector-attr">[-15.40771,-74.106742]</span>,<span class="hljs-selector-attr">[-16.46532,-73.871614]</span>,<span class="hljs-selector-attr">[-16.112784,-73.460114]</span>,<span class="hljs-selector-attr">[-15.446855,-73.146542]</span>,<span class="hljs-selector-attr">[-14.408805,-72.950585]</span>,<span class="hljs-selector-attr">[-13.311973,-72.715457]</span>,<span class="hljs-selector-attr">[-12.293508,-72.401936]</span>,<span class="hljs-selector-attr">[-11.510067,-72.010074]</span>,<span class="hljs-selector-attr">[-11.020433,-71.539767]</span>,<span class="hljs-selector-attr">[-10.295774,-71.265416]</span>,<span class="hljs-selector-attr">[-9.101015,-71.324224]</span>,<span class="hljs-selector-attr">[-8.611381,-71.65733]</span>,<span class="hljs-selector-attr">[-7.416622,-71.696501]</span>,<span class="hljs-selector-attr">[-7.377451,-71.324224]</span>,<span class="hljs-selector-attr">[-6.868232,-70.93231]</span>,<span class="hljs-selector-attr">[-5.790985,-71.030289]</span>,<span class="hljs-selector-attr">[-5.536375,-71.402617]</span>,<span class="hljs-selector-attr">[-4.341667,-71.461373]</span>,<span class="hljs-selector-attr">[-3.048981,-71.285053]</span>,<span class="hljs-selector-attr">[-1.795492,-71.167438]</span>,<span class="hljs-selector-attr">[-0.659489,-71.226246]</span>,<span class="hljs-selector-attr">[-0.228637,-71.637745]</span>,<span class="hljs-selector-attr">[0.868195,-71.304639]</span>,<span class="hljs-selector-attr">[1.886686,-71.128267]</span>,<span class="hljs-selector-attr">[3.022638,-70.991118]</span>,<span class="hljs-selector-attr">[4.139055,-70.853917]</span>,<span class="hljs-selector-attr">[5.157546,-70.618789]</span>,<span class="hljs-selector-attr">[6.273912,-70.462055]</span>,<span class="hljs-selector-attr">[7.13572,-70.246512]</span>,<span class="hljs-selector-attr">[7.742866,-69.893769]</span>,<span class="hljs-selector-attr">[8.48711,-70.148534]</span>,<span class="hljs-selector-attr">[9.525135,-70.011333]</span>,<span class="hljs-selector-attr">[10.249845,-70.48164]</span>,<span class="hljs-selector-attr">[10.817821,-70.834332]</span>,<span class="hljs-selector-attr">[11.953824,-70.638375]</span>,<span class="hljs-selector-attr">[12.404287,-70.246512]</span>,<span class="hljs-selector-attr">[13.422778,-69.972162]</span>,<span class="hljs-selector-attr">[14.734998,-70.030918]</span>,<span class="hljs-selector-attr">[15.126757,-70.403247]</span>,<span class="hljs-selector-attr">[15.949342,-70.030918]</span>,<span class="hljs-selector-attr">[17.026589,-69.913354]</span>,<span class="hljs-selector-attr">[18.201711,-69.874183]</span>,<span class="hljs-selector-attr">[19.259373,-69.893769]</span>,<span class="hljs-selector-attr">[20.375739,-70.011333]</span>,<span class="hljs-selector-attr">[21.452985,-70.07014]</span>,<span class="hljs-selector-attr">[21.923034,-70.403247]</span>,<span class="hljs-selector-attr">[22.569403,-70.697182]</span>,<span class="hljs-selector-attr">[23.666184,-70.520811]</span>,<span class="hljs-selector-attr">[24.841357,-70.48164]</span>,<span class="hljs-selector-attr">[25.977309,-70.48164]</span>,<span class="hljs-selector-attr">[27.093726,-70.462055]</span>,<span class="hljs-selector-attr">[28.09258,-70.324854]</span>,<span class="hljs-selector-attr">[29.150242,-70.20729]</span>,<span class="hljs-selector-attr">[30.031583,-69.93294]</span>,<span class="hljs-selector-attr">[30.971733,-69.75662]</span>,<span class="hljs-selector-attr">[31.990172,-69.658641]</span>,<span class="hljs-selector-attr">[32.754053,-69.384291]</span>,<span class="hljs-selector-attr">[33.302443,-68.835642]</span>,<span class="hljs-selector-attr">[33.870419,-68.502588]</span>,<span class="hljs-selector-attr">[34.908495,-68.659271]</span>,<span class="hljs-selector-attr">[35.300202,-69.012014]</span>,<span class="hljs-selector-attr">[36.16201,-69.247142]</span>,<span class="hljs-selector-attr">[37.200035,-69.168748]</span>,<span class="hljs-selector-attr">[37.905108,-69.52144]</span>,<span class="hljs-selector-attr">[38.649404,-69.776205]</span>,<span class="hljs-selector-attr">[39.667894,-69.541077]</span>,<span class="hljs-selector-attr">[40.020431,-69.109941]</span>,<span class="hljs-selector-attr">[40.921358,-68.933621]</span>,<span class="hljs-selector-attr">[41.959434,-68.600514]</span>,<span class="hljs-selector-attr">[42.938702,-68.463313]</span>,<span class="hljs-selector-attr">[44.113876,-68.267408]</span>,<span class="hljs-selector-attr">[44.897291,-68.051866]</span>,<span class="hljs-selector-attr">[45.719928,-67.816738]</span>,<span class="hljs-selector-attr">[46.503343,-67.601196]</span>,<span class="hljs-selector-attr">[47.44344,-67.718759]</span>,<span class="hljs-selector-attr">[48.344419,-67.366068]</span>,<span class="hljs-selector-attr">[48.990736,-67.091718]</span>,<span class="hljs-selector-attr">[49.930885,-67.111303]</span>,<span class="hljs-selector-attr">[50.753471,-66.876175]</span>,<span class="hljs-selector-attr">[50.949325,-66.523484]</span>,<span class="hljs-selector-attr">[51.791547,-66.249133]</span>,<span class="hljs-selector-attr">[52.614133,-66.053176]</span>,<span class="hljs-selector-attr">[53.613038,-65.89639]</span>,<span class="hljs-selector-attr">[54.53355,-65.818049]</span>,<span class="hljs-selector-attr">[55.414943,-65.876805]</span>,<span class="hljs-selector-attr">[56.355041,-65.974783]</span>,<span class="hljs-selector-attr">[57.158093,-66.249133]</span>,<span class="hljs-selector-attr">[57.255968,-66.680218]</span>,<span class="hljs-selector-attr">[58.137361,-67.013324]</span>,<span class="hljs-selector-attr">[58.744508,-67.287675]</span>,<span class="hljs-selector-attr">[59.939318,-67.405239]</span>,<span class="hljs-selector-attr">[60.605221,-67.679589]</span>,<span class="hljs-selector-attr">[61.427806,-67.953887]</span>,<span class="hljs-selector-attr">[62.387489,-68.012695]</span>,<span class="hljs-selector-attr">[63.19049,-67.816738]</span>,<span class="hljs-selector-attr">[64.052349,-67.405239]</span>,<span class="hljs-selector-attr">[64.992447,-67.620729]</span>,<span class="hljs-selector-attr">[65.971715,-67.738345]</span>,<span class="hljs-selector-attr">[66.911864,-67.855909]</span>,<span class="hljs-selector-attr">[67.891133,-67.934302]</span>,<span class="hljs-selector-attr">[68.890038,-67.934302]</span>,<span class="hljs-selector-attr">[69.712624,-68.972791]</span>,<span class="hljs-selector-attr">[69.673453,-69.227556]</span>,<span class="hljs-selector-attr">[69.555941,-69.678226]</span>,<span class="hljs-selector-attr">[68.596258,-69.93294]</span>,<span class="hljs-selector-attr">[67.81274,-70.305268]</span>,<span class="hljs-selector-attr">[67.949889,-70.697182]</span>,<span class="hljs-selector-attr">[69.066307,-70.677545]</span>,<span class="hljs-selector-attr">[68.929157,-71.069459]</span>,<span class="hljs-selector-attr">[68.419989,-71.441788]</span>,<span class="hljs-selector-attr">[67.949889,-71.853287]</span>,<span class="hljs-selector-attr">[68.71377,-72.166808]</span>,<span class="hljs-selector-attr">[69.869307,-72.264787]</span>,<span class="hljs-selector-attr">[71.024895,-72.088415]</span>,<span class="hljs-selector-attr">[71.573285,-71.696501]</span>,<span class="hljs-selector-attr">[71.906288,-71.324224]</span>,<span class="hljs-selector-attr">[72.454627,-71.010703]</span>,<span class="hljs-selector-attr">[73.08141,-70.716768]</span>,<span class="hljs-selector-attr">[73.33602,-70.364024]</span>,<span class="hljs-selector-attr">[73.864877,-69.874183]</span>,<span class="hljs-selector-attr">[74.491557,-69.776205]</span>,<span class="hljs-selector-attr">[75.62756,-69.737034]</span>,<span class="hljs-selector-attr">[76.626465,-69.619419]</span>,<span class="hljs-selector-attr">[77.644904,-69.462684]</span>,<span class="hljs-selector-attr">[78.134539,-69.07077]</span>,<span class="hljs-selector-attr">[78.428371,-68.698441]</span>,<span class="hljs-selector-attr">[79.113859,-68.326216]</span>,<span class="hljs-selector-attr">[80.093127,-68.071503]</span>,<span class="hljs-selector-attr">[80.93535,-67.875546]</span>,<span class="hljs-selector-attr">[81.483792,-67.542388]</span>,<span class="hljs-selector-attr">[82.051767,-67.366068]</span>,<span class="hljs-selector-attr">[82.776426,-67.209282]</span>,<span class="hljs-selector-attr">[83.775331,-67.30726]</span>,<span class="hljs-selector-attr">[84.676206,-67.209282]</span>,<span class="hljs-selector-attr">[85.655527,-67.091718]</span>,<span class="hljs-selector-attr">[86.752359,-67.150474]</span>,<span class="hljs-selector-attr">[87.477017,-66.876175]</span>,<span class="hljs-selector-attr">[87.986289,-66.209911]</span>,<span class="hljs-selector-attr">[88.358411,-66.484261]</span>,<span class="hljs-selector-attr">[88.828408,-66.954568]</span>,<span class="hljs-selector-attr">[89.67063,-67.150474]</span>,<span class="hljs-selector-attr">[90.630365,-67.228867]</span>,<span class="hljs-selector-attr">[91.5901,-67.111303]</span>,<span class="hljs-selector-attr">[92.608539,-67.189696]</span>,<span class="hljs-selector-attr">[93.548637,-67.209282]</span>,<span class="hljs-selector-attr">[94.17542,-67.111303]</span>,<span class="hljs-selector-attr">[95.017591,-67.170111]</span>,<span class="hljs-selector-attr">[95.781472,-67.385653]</span>,<span class="hljs-selector-attr">[96.682399,-67.248504]</span>,<span class="hljs-selector-attr">[97.759646,-67.248504]</span>,<span class="hljs-selector-attr">[98.68021,-67.111303]</span>,<span class="hljs-selector-attr">[99.718182,-67.248504]</span>,<span class="hljs-selector-attr">[100.384188,-66.915346]</span>,<span class="hljs-selector-attr">[100.893356,-66.58224]</span>,<span class="hljs-selector-attr">[101.578896,-66.30789]</span>,<span class="hljs-selector-attr">[102.832411,-65.563284]</span>,<span class="hljs-selector-attr">[103.478676,-65.700485]</span>,<span class="hljs-selector-attr">[104.242557,-65.974783]</span>,<span class="hljs-selector-attr">[104.90846,-66.327527]</span>,<span class="hljs-selector-attr">[106.181561,-66.934931]</span>,<span class="hljs-selector-attr">[107.160881,-66.954568]</span>,<span class="hljs-selector-attr">[108.081393,-66.954568]</span>,<span class="hljs-selector-attr">[109.15864,-66.837004]</span>,<span class="hljs-selector-attr">[110.235835,-66.699804]</span>,<span class="hljs-selector-attr">[111.058472,-66.425505]</span>,<span class="hljs-selector-attr">[111.74396,-66.13157]</span>,<span class="hljs-selector-attr">[112.860378,-66.092347]</span>,<span class="hljs-selector-attr">[113.604673,-65.876805]</span>,<span class="hljs-selector-attr">[114.388088,-66.072762]</span>,<span class="hljs-selector-attr">[114.897308,-66.386283]</span>,<span class="hljs-selector-attr">[115.602381,-66.699804]</span>,<span class="hljs-selector-attr">[116.699161,-66.660633]</span>,<span class="hljs-selector-attr">[117.384701,-66.915346]</span>,<span class="hljs-selector-attr">[118.57946,-67.170111]</span>,<span class="hljs-selector-attr">[119.832924,-67.268089]</span>,<span class="hljs-selector-attr">[120.871,-67.189696]</span>,<span class="hljs-selector-attr">[121.654415,-66.876175]</span>,<span class="hljs-selector-attr">[122.320369,-66.562654]</span>,<span class="hljs-selector-attr">[123.221296,-66.484261]</span>,<span class="hljs-selector-attr">[124.122274,-66.621462]</span>,<span class="hljs-selector-attr">[125.160247,-66.719389]</span>,<span class="hljs-selector-attr">[126.100396,-66.562654]</span>,<span class="hljs-selector-attr">[127.001427,-66.562654]</span>,<span class="hljs-selector-attr">[127.882768,-66.660633]</span>,<span class="hljs-selector-attr">[128.80328,-66.758611]</span>,<span class="hljs-selector-attr">[129.704259,-66.58224]</span>,<span class="hljs-selector-attr">[130.781454,-66.425505]</span>,<span class="hljs-selector-attr">[131.799945,-66.386283]</span>,<span class="hljs-selector-attr">[132.935896,-66.386283]</span>,<span class="hljs-selector-attr">[133.85646,-66.288304]</span>,<span class="hljs-selector-attr">[134.757387,-66.209963]</span>,<span class="hljs-selector-attr">[135.031582,-65.72007]</span>,<span class="hljs-selector-attr">[135.070753,-65.308571]</span>,<span class="hljs-selector-attr">[135.697485,-65.582869]</span>,<span class="hljs-selector-attr">[135.873805,-66.033591]</span>,<span class="hljs-selector-attr">[136.206705,-66.44509]</span>,<span class="hljs-selector-attr">[136.618049,-66.778197]</span>,<span class="hljs-selector-attr">[137.460271,-66.954568]</span>,<span class="hljs-selector-attr">[138.596223,-66.895761]</span>,<span class="hljs-selector-attr">[139.908442,-66.876175]</span>,<span class="hljs-selector-attr">[140.809421,-66.817367]</span>,<span class="hljs-selector-attr">[142.121692,-66.817367]</span>,<span class="hljs-selector-attr">[143.061842,-66.797782]</span>,<span class="hljs-selector-attr">[144.374061,-66.837004]</span>,<span class="hljs-selector-attr">[145.490427,-66.915346]</span>,<span class="hljs-selector-attr">[146.195552,-67.228867]</span>,<span class="hljs-selector-attr">[145.999699,-67.601196]</span>,<span class="hljs-selector-attr">[146.646067,-67.895131]</span>,<span class="hljs-selector-attr">[147.723263,-68.130259]</span>,<span class="hljs-selector-attr">[148.839629,-68.385024]</span>,<span class="hljs-selector-attr">[150.132314,-68.561292]</span>,<span class="hljs-selector-attr">[151.483705,-68.71813]</span>,<span class="hljs-selector-attr">[152.502247,-68.874813]</span>,<span class="hljs-selector-attr">[153.638199,-68.894502]</span>,<span class="hljs-selector-attr">[154.284567,-68.561292]</span>,<span class="hljs-selector-attr">[155.165857,-68.835642]</span>,<span class="hljs-selector-attr">[155.92979,-69.149215]</span>,<span class="hljs-selector-attr">[156.811132,-69.384291]</span>,<span class="hljs-selector-attr">[158.025528,-69.482269]</span>,<span class="hljs-selector-attr">[159.181013,-69.599833]</span>,<span class="hljs-selector-attr">[159.670699,-69.991747]</span>,<span class="hljs-selector-attr">[160.80665,-70.226875]</span>,<span class="hljs-selector-attr">[161.570479,-70.579618]</span>,<span class="hljs-selector-attr">[162.686897,-70.736353]</span>,<span class="hljs-selector-attr">[163.842434,-70.716768]</span>,<span class="hljs-selector-attr">[164.919681,-70.775524]</span>,<span class="hljs-selector-attr">[166.11444,-70.755938]</span>,<span class="hljs-selector-attr">[167.309095,-70.834332]</span>,<span class="hljs-selector-attr">[168.425616,-70.971481]</span>,<span class="hljs-selector-attr">[169.463589,-71.20666]</span>,<span class="hljs-selector-attr">[170.501665,-71.402617]</span>,<span class="hljs-selector-attr">[171.20679,-71.696501]</span>,<span class="hljs-selector-attr">[171.089227,-72.088415]</span>,<span class="hljs-selector-attr">[170.560422,-72.441159]</span>,<span class="hljs-selector-attr">[170.109958,-72.891829]</span>,<span class="hljs-selector-attr">[169.75737,-73.24452]</span>,<span class="hljs-selector-attr">[169.287321,-73.65602]</span>,<span class="hljs-selector-attr">[167.975101,-73.812806]</span>,<span class="hljs-selector-attr">[167.387489,-74.165498]</span>,<span class="hljs-selector-attr">[166.094803,-74.38104]</span>,<span class="hljs-selector-attr">[165.644391,-74.772954]</span>,<span class="hljs-selector-attr">[164.958851,-75.145283]</span>,<span class="hljs-selector-attr">[164.234193,-75.458804]</span>,<span class="hljs-selector-attr">[163.822797,-75.870303]</span>,<span class="hljs-selector-attr">[163.568239,-76.24258]</span>,<span class="hljs-selector-attr">[163.47026,-76.693302]</span>,<span class="hljs-selector-attr">[163.489897,-77.065579]</span>,<span class="hljs-selector-attr">[164.057873,-77.457442]</span>,<span class="hljs-selector-attr">[164.273363,-77.82977]</span>,<span class="hljs-selector-attr">[164.743464,-78.182514]</span>,<span class="hljs-selector-attr">[166.604126,-78.319611]</span>,<span class="hljs-selector-attr">[166.995781,-78.750748]</span>,<span class="hljs-selector-attr">[165.193876,-78.907483]</span>,<span class="hljs-selector-attr">[163.666217,-79.123025]</span>,<span class="hljs-selector-attr">[161.766385,-79.162248]</span>,<span class="hljs-selector-attr">[160.924162,-79.730482]</span>,<span class="hljs-selector-attr">[160.747894,-80.200737]</span>,<span class="hljs-selector-attr">[160.316964,-80.573066]</span>,<span class="hljs-selector-attr">[159.788211,-80.945395]</span>,<span class="hljs-selector-attr">[161.120016,-81.278501]</span>,<span class="hljs-selector-attr">[161.629287,-81.690001]</span>,<span class="hljs-selector-attr">[162.490992,-82.062278]</span>,<span class="hljs-selector-attr">[163.705336,-82.395435]</span>,<span class="hljs-selector-attr">[165.095949,-82.708956]</span>,<span class="hljs-selector-attr">[166.604126,-83.022477]</span>,<span class="hljs-selector-attr">[168.895665,-83.335998]</span>,<span class="hljs-selector-attr">[169.404782,-83.825891]</span>,<span class="hljs-selector-attr">[172.283934,-84.041433]</span>,<span class="hljs-selector-attr">[172.477049,-84.117914]</span>,<span class="hljs-selector-attr">[173.224083,-84.41371]</span>,<span class="hljs-selector-attr">[175.985672,-84.158997]</span>,<span class="hljs-selector-attr">[178.277212,-84.472518]</span>,<span class="hljs-selector-attr">[180,-84.71338]</span>,<span class="hljs-selector-attr">[-179.942499,-84.721443]</span>,<span class="hljs-selector-attr">[-179.058677,-84.139412]</span>,<span class="hljs-selector-attr">[-177.256772,-84.452933]</span>,<span class="hljs-selector-attr">[-177.140807,-84.417941]</span>,<span class="hljs-selector-attr">[-176.084673,-84.099259]</span>,<span class="hljs-selector-attr">[-175.947235,-84.110449]</span>,<span class="hljs-selector-attr">[-175.829882,-84.117914]</span>,<span class="hljs-selector-attr">[-174.382503,-84.534323]</span>,<span class="hljs-selector-attr">[-173.116559,-84.117914]</span>,<span class="hljs-selector-attr">[-172.889106,-84.061019]</span>,<span class="hljs-selector-attr">[-169.951223,-83.884647]</span>,<span class="hljs-selector-attr">[-168.999989,-84.117914]</span>,<span class="hljs-selector-attr">[-168.530199,-84.23739]</span>,<span class="hljs-selector-attr">[-167.022099,-84.570497]</span>,<span class="hljs-selector-attr">[-164.182144,-84.82521]</span>,<span class="hljs-selector-attr">[-161.929775,-85.138731]</span>,<span class="hljs-selector-attr">[-158.07138,-85.37391]</span>,<span class="hljs-selector-attr">[-155.192253,-85.09956]</span>,<span class="hljs-selector-attr">[-150.942099,-85.295517]</span>,<span class="hljs-selector-attr">[-148.533073,-85.609038]</span>,<span class="hljs-selector-attr">[-145.888918,-85.315102]</span>,<span class="hljs-selector-attr">[-143.107718,-85.040752]</span>,<span class="hljs-selector-attr">[-142.892279,-84.570497]</span>,<span class="hljs-selector-attr">[-146.829068,-84.531274]</span>,<span class="hljs-selector-attr">[-150.060732,-84.296146]</span>,<span class="hljs-selector-attr">[-150.902928,-83.904232]</span>,<span class="hljs-selector-attr">[-153.586201,-83.68869]</span>,<span class="hljs-selector-attr">[-153.409907,-83.23802]</span>,<span class="hljs-selector-attr">[-153.037759,-82.82652]</span>,<span class="hljs-selector-attr">[-152.665637,-82.454192]</span>,<span class="hljs-selector-attr">[-152.861517,-82.042692]</span>,<span class="hljs-selector-attr">[-154.526299,-81.768394]</span>,<span class="hljs-selector-attr">[-155.29018,-81.41565]</span>,<span class="hljs-selector-attr">[-156.83745,-81.102129]</span>,<span class="hljs-selector-attr">[-154.408787,-81.160937]</span>,<span class="hljs-selector-attr">[-152.097662,-81.004151]</span>,<span class="hljs-selector-attr">[-150.648293,-81.337309]</span>,<span class="hljs-selector-attr">[-148.865998,-81.043373]</span>,<span class="hljs-selector-attr">[-147.22075,-80.671045]</span>,<span class="hljs-selector-attr">[-146.417749,-80.337938]</span>,<span class="hljs-selector-attr">[-146.770286,-79.926439]</span>,<span class="hljs-selector-attr">[-148.062947,-79.652089]</span>,<span class="hljs-selector-attr">[-149.531901,-79.358205]</span>,<span class="hljs-selector-attr">[-151.588416,-79.299397]</span>,<span class="hljs-selector-attr">[-153.390322,-79.162248]</span>,<span class="hljs-selector-attr">[-155.329376,-79.064269]</span>,<span class="hljs-selector-attr">[-155.975668,-78.69194]</span>,<span class="hljs-selector-attr">[-157.268302,-78.378419]</span>,<span class="hljs-selector-attr">[-158.051768,-78.025676]</span>,<span class="hljs-selector-attr">[-158.365134,-76.889207]</span>,<span class="hljs-selector-attr">[-157.875474,-76.987238]</span>,<span class="hljs-selector-attr">[-156.974573,-77.300759]</span>,<span class="hljs-selector-attr">[-155.329376,-77.202728]</span>,<span class="hljs-selector-attr">[-153.742832,-77.065579]</span>,<span class="hljs-selector-attr">[-152.920247,-77.496664]</span>,<span class="hljs-selector-attr">[-151.33378,-77.398737]</span>,<span class="hljs-selector-attr">[-150.00195,-77.183143]</span>,<span class="hljs-selector-attr">[-148.748486,-76.908845]</span>,<span class="hljs-selector-attr">[-147.612483,-76.575738]</span>,<span class="hljs-selector-attr">[-146.104409,-76.47776]</span>,<span class="hljs-selector-attr">[-146.143528,-76.105431]</span>,<span class="hljs-selector-attr">[-146.496091,-75.733154]</span>,<span class="hljs-selector-attr">[-146.20231,-75.380411]</span>,<span class="hljs-selector-attr">[-144.909624,-75.204039]</span>,<span class="hljs-selector-attr">[-144.322037,-75.537197]</span>,<span class="hljs-selector-attr">[-142.794353,-75.34124]</span>,<span class="hljs-selector-attr">[-141.638764,-75.086475]</span>,<span class="hljs-selector-attr">[-140.209007,-75.06689]</span>,<span class="hljs-selector-attr">[-138.85759,-74.968911]</span>,<span class="hljs-selector-attr">[-137.5062,-74.733783]</span>,<span class="hljs-selector-attr">[-136.428901,-74.518241]</span>,<span class="hljs-selector-attr">[-135.214583,-74.302699]</span>,<span class="hljs-selector-attr">[-134.431194,-74.361455]</span>,<span class="hljs-selector-attr">[-133.745654,-74.439848]</span>,<span class="hljs-selector-attr">[-132.257168,-74.302699]</span>,<span class="hljs-selector-attr">[-130.925311,-74.479019]</span>,<span class="hljs-selector-attr">[-129.554284,-74.459433]</span>,<span class="hljs-selector-attr">[-128.242038,-74.322284]</span>,<span class="hljs-selector-attr">[-126.890622,-74.420263]</span>,<span class="hljs-selector-attr">[-125.402082,-74.518241]</span>,<span class="hljs-selector-attr">[-124.011496,-74.479019]</span>,<span class="hljs-selector-attr">[-122.562152,-74.498604]</span>,<span class="hljs-selector-attr">[-121.073613,-74.518241]</span>,<span class="hljs-selector-attr">[-119.70256,-74.479019]</span>,<span class="hljs-selector-attr">[-118.684145,-74.185083]</span>,<span class="hljs-selector-attr">[-117.469801,-74.028348]</span>,<span class="hljs-selector-attr">[-116.216312,-74.243891]</span>,<span class="hljs-selector-attr">[-115.021552,-74.067519]</span>,<span class="hljs-selector-attr">[-113.944331,-73.714828]</span>,<span class="hljs-selector-attr">[-113.297988,-74.028348]</span>,<span class="hljs-selector-attr">[-112.945452,-74.38104]</span>,<span class="hljs-selector-attr">[-112.299083,-74.714198]</span>,<span class="hljs-selector-attr">[-111.261059,-74.420263]</span>,<span class="hljs-selector-attr">[-110.066325,-74.79254]</span>,<span class="hljs-selector-attr">[-108.714909,-74.910103]</span>,<span class="hljs-selector-attr">[-107.559346,-75.184454]</span>,<span class="hljs-selector-attr">[-106.149148,-75.125698]</span>,<span class="hljs-selector-attr">[-104.876074,-74.949326]</span>,<span class="hljs-selector-attr">[-103.367949,-74.988497]</span>,<span class="hljs-selector-attr">[-102.016507,-75.125698]</span>,<span class="hljs-selector-attr">[-100.645531,-75.302018]</span>,<span class="hljs-selector-attr">[-100.1167,-74.870933]</span>,<span class="hljs-selector-attr">[-100.763043,-74.537826]</span>,<span class="hljs-selector-attr">[-101.252703,-74.185083]</span>,<span class="hljs-selector-attr">[-102.545337,-74.106742]</span>,<span class="hljs-selector-attr">[-103.113313,-73.734413]</span>,<span class="hljs-selector-attr">[-103.328752,-73.362084]</span>,<span class="hljs-selector-attr">[-103.681289,-72.61753]</span>,<span class="hljs-selector-attr">[-102.917485,-72.754679]</span>,<span class="hljs-selector-attr">[-101.60524,-72.813436]</span>,<span class="hljs-selector-attr">[-100.312528,-72.754679]</span>,<span class="hljs-selector-attr">[-99.13738,-72.911414]</span>,<span class="hljs-selector-attr">[-98.118889,-73.20535]</span>,<span class="hljs-selector-attr">[-97.688037,-73.558041]</span>,<span class="hljs-selector-attr">[-96.336595,-73.616849]</span>,<span class="hljs-selector-attr">[-95.043961,-73.4797]</span>,<span class="hljs-selector-attr">[-93.672907,-73.283743]</span>,<span class="hljs-selector-attr">[-92.439003,-73.166179]</span>,<span class="hljs-selector-attr">[-91.420564,-73.401307]</span>,<span class="hljs-selector-attr">[-90.088733,-73.322914]</span>,<span class="hljs-selector-attr">[-89.226951,-72.558722]</span>,<span class="hljs-selector-attr">[-88.423951,-73.009393]</span>,<span class="hljs-selector-attr">[-87.268337,-73.185764]</span>,<span class="hljs-selector-attr">[-86.014822,-73.087786]</span>,<span class="hljs-selector-attr">[-85.192236,-73.4797]</span>,<span class="hljs-selector-attr">[-83.879991,-73.518871]</span>,<span class="hljs-selector-attr">[-82.665646,-73.636434]</span>,<span class="hljs-selector-attr">[-81.470913,-73.851977]</span>,<span class="hljs-selector-attr">[-80.687447,-73.4797]</span>,<span class="hljs-selector-attr">[-80.295791,-73.126956]</span>,<span class="hljs-selector-attr">[-79.296886,-73.518871]</span>,<span class="hljs-selector-attr">[-77.925858,-73.420892]</span>,<span class="hljs-selector-attr">[-76.907367,-73.636434]</span>,<span class="hljs-selector-attr">[-76.221879,-73.969541]</span>,<span class="hljs-selector-attr">[-74.890049,-73.871614]</span>,<span class="hljs-selector-attr">[-73.852024,-73.65602]</span>,<span class="hljs-selector-attr">[-72.833533,-73.401307]</span>,<span class="hljs-selector-attr">[-71.619215,-73.264157]</span>,<span class="hljs-selector-attr">[-70.209042,-73.146542]</span>,<span class="hljs-selector-attr">[-68.935916,-73.009393]</span>,<span class="hljs-selector-attr">[-67.956622,-72.79385]</span>,<span class="hljs-selector-attr">[-67.369061,-72.480329]</span>,<span class="hljs-selector-attr">[-67.134036,-72.049244]</span>,<span class="hljs-selector-attr">[-67.251548,-71.637745]</span>,<span class="hljs-selector-attr">[-67.56494,-71.245831]</span>,<span class="hljs-selector-attr">[-67.917477,-70.853917]</span>,<span class="hljs-selector-attr">[-68.230843,-70.462055]</span>,<span class="hljs-selector-attr">[-68.485452,-70.109311]</span>,<span class="hljs-selector-attr">[-68.544209,-69.717397]</span>,<span class="hljs-selector-attr">[-68.446282,-69.325535]</span>,<span class="hljs-selector-attr">[-67.976233,-68.953206]</span>,<span class="hljs-selector-attr">[-67.5845,-68.541707]</span>,<span class="hljs-selector-attr">[-67.427843,-68.149844]</span>,<span class="hljs-selector-attr">[-67.62367,-67.718759]</span>,<span class="hljs-selector-attr">[-67.741183,-67.326845]</span>,<span class="hljs-selector-attr">[-67.251548,-66.876175]</span>,<span class="hljs-selector-attr">[-66.703184,-66.58224]</span>,<span class="hljs-selector-attr">[-66.056815,-66.209963]</span>,<span class="hljs-selector-attr">[-65.371327,-65.89639]</span>,<span class="hljs-selector-attr">[-64.568276,-65.602506]</span>,<span class="hljs-selector-attr">[-64.176542,-65.171423]</span>,<span class="hljs-selector-attr">[-63.628152,-64.897073]</span>,<span class="hljs-selector-attr">[-63.001394,-64.642308]</span>,<span class="hljs-selector-attr">[-62.041686,-64.583552]</span>,<span class="hljs-selector-attr">[-61.414928,-64.270031]</span>,<span class="hljs-selector-attr">[-60.709855,-64.074074]</span>,<span class="hljs-selector-attr">[-59.887269,-63.95651]</span>,<span class="hljs-selector-attr">[-59.162585,-63.701745]</span>,<span class="hljs-selector-attr">[-58.594557,-63.388224]</span>,<span class="hljs-selector-attr">[-57.811143,-63.27066]</span>,<span class="hljs-selector-attr">[-57.223582,-63.525425]</span>,<span class="hljs-selector-attr">[-57.59573,-63.858532]</span>,<span class="hljs-selector-attr">[-58.614143,-64.152467]</span>]]]}},
{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Feature</span>","<span class="hljs-selector-tag">id</span>":"<span class="hljs-selector-tag">ATF</span>","<span class="hljs-selector-tag">properties</span>":{"<span class="hljs-selector-tag">name</span>":"<span class="hljs-selector-tag">French</span> <span class="hljs-selector-tag">Southern</span> <span class="hljs-selector-tag">and</span> <span class="hljs-selector-tag">Antarctic</span> <span class="hljs-selector-tag">Lands</span>"},"<span class="hljs-selector-tag">geometry</span>":{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Polygon</span>","<span class="hljs-selector-tag">coordinates</span>":<span class="hljs-selector-attr">[[[68.935,-48.625]</span>,<span class="hljs-selector-attr">[69.58,-48.94]</span>,<span class="hljs-selector-attr">[70.525,-49.065]</span>,<span class="hljs-selector-attr">[70.56,-49.255]</span>,<span class="hljs-selector-attr">[70.28,-49.71]</span>,<span class="hljs-selector-attr">[68.745,-49.775]</span>,<span class="hljs-selector-attr">[68.72,-49.2425]</span>,<span class="hljs-selector-attr">[68.8675,-48.83]</span>,<span class="hljs-selector-attr">[68.935,-48.625]</span>]]}},
{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Feature</span>","<span class="hljs-selector-tag">id</span>":"<span class="hljs-selector-tag">AUS</span>","<span class="hljs-selector-tag">properties</span>":{"<span class="hljs-selector-tag">name</span>":"<span class="hljs-selector-tag">Australia</span>"},"<span class="hljs-selector-tag">geometry</span>":{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">MultiPolygon</span>","<span class="hljs-selector-tag">coordinates</span>":<span class="hljs-selector-attr">[[[[145.397978,-40.792549]</span>,<span class="hljs-selector-attr">[146.364121,-41.137695]</span>,<span class="hljs-selector-attr">[146.908584,-41.000546]</span>,<span class="hljs-selector-attr">[147.689259,-40.808258]</span>,<span class="hljs-selector-attr">[148.289068,-40.875438]</span>,<span class="hljs-selector-attr">[148.359865,-42.062445]</span>,<span class="hljs-selector-attr">[148.017301,-42.407024]</span>,<span class="hljs-selector-attr">[147.914052,-43.211522]</span>,<span class="hljs-selector-attr">[147.564564,-42.937689]</span>,<span class="hljs-selector-attr">[146.870343,-43.634597]</span>,<span class="hljs-selector-attr">[146.663327,-43.580854]</span>,<span class="hljs-selector-attr">[146.048378,-43.549745]</span>,<span class="hljs-selector-attr">[145.43193,-42.693776]</span>,<span class="hljs-selector-attr">[145.29509,-42.03361]</span>,<span class="hljs-selector-attr">[144.718071,-41.162552]</span>,<span class="hljs-selector-attr">[144.743755,-40.703975]</span>,<span class="hljs-selector-attr">[145.397978,-40.792549]</span>]],<span class="hljs-selector-attr">[[[143.561811,-13.763656]</span>,<span class="hljs-selector-attr">[143.922099,-14.548311]</span>,<span class="hljs-selector-attr">[144.563714,-14.171176]</span>,<span class="hljs-selector-attr">[144.894908,-14.594458]</span>,<span class="hljs-selector-attr">[145.374724,-14.984976]</span>,<span class="hljs-selector-attr">[145.271991,-15.428205]</span>,<span class="hljs-selector-attr">[145.48526,-16.285672]</span>,<span class="hljs-selector-attr">[145.637033,-16.784918]</span>,<span class="hljs-selector-attr">[145.888904,-16.906926]</span>,<span class="hljs-selector-attr">[146.160309,-17.761655]</span>,<span class="hljs-selector-attr">[146.063674,-18.280073]</span>,<span class="hljs-selector-attr">[146.387478,-18.958274]</span>,<span class="hljs-selector-attr">[147.471082,-19.480723]</span>,<span class="hljs-selector-attr">[148.177602,-19.955939]</span>,<span class="hljs-selector-attr">[148.848414,-20.39121]</span>,<span class="hljs-selector-attr">[148.717465,-20.633469]</span>,<span class="hljs-selector-attr">[149.28942,-21.260511]</span>,<span class="hljs-selector-attr">[149.678337,-22.342512]</span>,<span class="hljs-selector-attr">[150.077382,-22.122784]</span>,<span class="hljs-selector-attr">[150.482939,-22.556142]</span>,<span class="hljs-selector-attr">[150.727265,-22.402405]</span>,<span class="hljs-selector-attr">[150.899554,-23.462237]</span>,<span class="hljs-selector-attr">[151.609175,-24.076256]</span>,<span class="hljs-selector-attr">[152.07354,-24.457887]</span>,<span class="hljs-selector-attr">[152.855197,-25.267501]</span>,<span class="hljs-selector-attr">[153.136162,-26.071173]</span>,<span class="hljs-selector-attr">[153.161949,-26.641319]</span>,<span class="hljs-selector-attr">[153.092909,-27.2603]</span>,<span class="hljs-selector-attr">[153.569469,-28.110067]</span>,<span class="hljs-selector-attr">[153.512108,-28.995077]</span>,<span class="hljs-selector-attr">[153.339095,-29.458202]</span>,<span class="hljs-selector-attr">[153.069241,-30.35024]</span>,<span class="hljs-selector-attr">[153.089602,-30.923642]</span>,<span class="hljs-selector-attr">[152.891578,-31.640446]</span>,<span class="hljs-selector-attr">[152.450002,-32.550003]</span>,<span class="hljs-selector-attr">[151.709117,-33.041342]</span>,<span class="hljs-selector-attr">[151.343972,-33.816023]</span>,<span class="hljs-selector-attr">[151.010555,-34.31036]</span>,<span class="hljs-selector-attr">[150.714139,-35.17346]</span>,<span class="hljs-selector-attr">[150.32822,-35.671879]</span>,<span class="hljs-selector-attr">[150.075212,-36.420206]</span>,<span class="hljs-selector-attr">[149.946124,-37.109052]</span>,<span class="hljs-selector-attr">[149.997284,-37.425261]</span>,<span class="hljs-selector-attr">[149.423882,-37.772681]</span>,<span class="hljs-selector-attr">[148.304622,-37.809061]</span>,<span class="hljs-selector-attr">[147.381733,-38.219217]</span>,<span class="hljs-selector-attr">[146.922123,-38.606532]</span>,<span class="hljs-selector-attr">[146.317922,-39.035757]</span>,<span class="hljs-selector-attr">[145.489652,-38.593768]</span>,<span class="hljs-selector-attr">[144.876976,-38.417448]</span>,<span class="hljs-selector-attr">[145.032212,-37.896188]</span>,<span class="hljs-selector-attr">[144.485682,-38.085324]</span>,<span class="hljs-selector-attr">[143.609974,-38.809465]</span>,<span class="hljs-selector-attr">[142.745427,-38.538268]</span>,<span class="hljs-selector-attr">[142.17833,-38.380034]</span>,<span class="hljs-selector-attr">[141.606582,-38.308514]</span>,<span class="hljs-selector-attr">[140.638579,-38.019333]</span>,<span class="hljs-selector-attr">[139.992158,-37.402936]</span>,<span class="hljs-selector-attr">[139.806588,-36.643603]</span>,<span class="hljs-selector-attr">[139.574148,-36.138362]</span>,<span class="hljs-selector-attr">[139.082808,-35.732754]</span>,<span class="hljs-selector-attr">[138.120748,-35.612296]</span>,<span class="hljs-selector-attr">[138.449462,-35.127261]</span>,<span class="hljs-selector-attr">[138.207564,-34.384723]</span>,<span class="hljs-selector-attr">[137.71917,-35.076825]</span>,<span class="hljs-selector-attr">[136.829406,-35.260535]</span>,<span class="hljs-selector-attr">[137.352371,-34.707339]</span>,<span class="hljs-selector-attr">[137.503886,-34.130268]</span>,<span class="hljs-selector-attr">[137.890116,-33.640479]</span>,<span class="hljs-selector-attr">[137.810328,-32.900007]</span>,<span class="hljs-selector-attr">[136.996837,-33.752771]</span>,<span class="hljs-selector-attr">[136.372069,-34.094766]</span>,<span class="hljs-selector-attr">[135.989043,-34.890118]</span>,<span class="hljs-selector-attr">[135.208213,-34.47867]</span>,<span class="hljs-selector-attr">[135.239218,-33.947953]</span>,<span class="hljs-selector-attr">[134.613417,-33.222778]</span>,<span class="hljs-selector-attr">[134.085904,-32.848072]</span>,<span class="hljs-selector-attr">[134.273903,-32.617234]</span>,<span class="hljs-selector-attr">[132.990777,-32.011224]</span>,<span class="hljs-selector-attr">[132.288081,-31.982647]</span>,<span class="hljs-selector-attr">[131.326331,-31.495803]</span>,<span class="hljs-selector-attr">[129.535794,-31.590423]</span>,<span class="hljs-selector-attr">[128.240938,-31.948489]</span>,<span class="hljs-selector-attr">[127.102867,-32.282267]</span>,<span class="hljs-selector-attr">[126.148714,-32.215966]</span>,<span class="hljs-selector-attr">[125.088623,-32.728751]</span>,<span class="hljs-selector-attr">[124.221648,-32.959487]</span>,<span class="hljs-selector-attr">[124.028947,-33.483847]</span>,<span class="hljs-selector-attr">[123.659667,-33.890179]</span>,<span class="hljs-selector-attr">[122.811036,-33.914467]</span>,<span class="hljs-selector-attr">[122.183064,-34.003402]</span>,<span class="hljs-selector-attr">[121.299191,-33.821036]</span>,<span class="hljs-selector-attr">[120.580268,-33.930177]</span>,<span class="hljs-selector-attr">[119.893695,-33.976065]</span>,<span class="hljs-selector-attr">[119.298899,-34.509366]</span>,<span class="hljs-selector-attr">[119.007341,-34.464149]</span>,<span class="hljs-selector-attr">[118.505718,-34.746819]</span>,<span class="hljs-selector-attr">[118.024972,-35.064733]</span>,<span class="hljs-selector-attr">[117.295507,-35.025459]</span>,<span class="hljs-selector-attr">[116.625109,-35.025097]</span>,<span class="hljs-selector-attr">[115.564347,-34.386428]</span>,<span class="hljs-selector-attr">[115.026809,-34.196517]</span>,<span class="hljs-selector-attr">[115.048616,-33.623425]</span>,<span class="hljs-selector-attr">[115.545123,-33.487258]</span>,<span class="hljs-selector-attr">[115.714674,-33.259572]</span>,<span class="hljs-selector-attr">[115.679379,-32.900369]</span>,<span class="hljs-selector-attr">[115.801645,-32.205062]</span>,<span class="hljs-selector-attr">[115.689611,-31.612437]</span>,<span class="hljs-selector-attr">[115.160909,-30.601594]</span>,<span class="hljs-selector-attr">[114.997043,-30.030725]</span>,<span class="hljs-selector-attr">[115.040038,-29.461095]</span>,<span class="hljs-selector-attr">[114.641974,-28.810231]</span>,<span class="hljs-selector-attr">[114.616498,-28.516399]</span>,<span class="hljs-selector-attr">[114.173579,-28.118077]</span>,<span class="hljs-selector-attr">[114.048884,-27.334765]</span>,<span class="hljs-selector-attr">[113.477498,-26.543134]</span>,<span class="hljs-selector-attr">[113.338953,-26.116545]</span>,<span class="hljs-selector-attr">[113.778358,-26.549025]</span>,<span class="hljs-selector-attr">[113.440962,-25.621278]</span>,<span class="hljs-selector-attr">[113.936901,-25.911235]</span>,<span class="hljs-selector-attr">[114.232852,-26.298446]</span>,<span class="hljs-selector-attr">[114.216161,-25.786281]</span>,<span class="hljs-selector-attr">[113.721255,-24.998939]</span>,<span class="hljs-selector-attr">[113.625344,-24.683971]</span>,<span class="hljs-selector-attr">[113.393523,-24.384764]</span>,<span class="hljs-selector-attr">[113.502044,-23.80635]</span>,<span class="hljs-selector-attr">[113.706993,-23.560215]</span>,<span class="hljs-selector-attr">[113.843418,-23.059987]</span>,<span class="hljs-selector-attr">[113.736552,-22.475475]</span>,<span class="hljs-selector-attr">[114.149756,-21.755881]</span>,<span class="hljs-selector-attr">[114.225307,-22.517488]</span>,<span class="hljs-selector-attr">[114.647762,-21.82952]</span>,<span class="hljs-selector-attr">[115.460167,-21.495173]</span>,<span class="hljs-selector-attr">[115.947373,-21.068688]</span>,<span class="hljs-selector-attr">[116.711615,-20.701682]</span>,<span class="hljs-selector-attr">[117.166316,-20.623599]</span>,<span class="hljs-selector-attr">[117.441545,-20.746899]</span>,<span class="hljs-selector-attr">[118.229559,-20.374208]</span>,<span class="hljs-selector-attr">[118.836085,-20.263311]</span>,<span class="hljs-selector-attr">[118.987807,-20.044203]</span>,<span class="hljs-selector-attr">[119.252494,-19.952942]</span>,<span class="hljs-selector-attr">[119.805225,-19.976506]</span>,<span class="hljs-selector-attr">[120.85622,-19.683708]</span>,<span class="hljs-selector-attr">[121.399856,-19.239756]</span>,<span class="hljs-selector-attr">[121.655138,-18.705318]</span>,<span class="hljs-selector-attr">[122.241665,-18.197649]</span>,<span class="hljs-selector-attr">[122.286624,-17.798603]</span>,<span class="hljs-selector-attr">[122.312772,-17.254967]</span>,<span class="hljs-selector-attr">[123.012574,-16.4052]</span>,<span class="hljs-selector-attr">[123.433789,-17.268558]</span>,<span class="hljs-selector-attr">[123.859345,-17.069035]</span>,<span class="hljs-selector-attr">[123.503242,-16.596506]</span>,<span class="hljs-selector-attr">[123.817073,-16.111316]</span>,<span class="hljs-selector-attr">[124.258287,-16.327944]</span>,<span class="hljs-selector-attr">[124.379726,-15.56706]</span>,<span class="hljs-selector-attr">[124.926153,-15.0751]</span>,<span class="hljs-selector-attr">[125.167275,-14.680396]</span>,<span class="hljs-selector-attr">[125.670087,-14.51007]</span>,<span class="hljs-selector-attr">[125.685796,-14.230656]</span>,<span class="hljs-selector-attr">[126.125149,-14.347341]</span>,<span class="hljs-selector-attr">[126.142823,-14.095987]</span>,<span class="hljs-selector-attr">[126.582589,-13.952791]</span>,<span class="hljs-selector-attr">[127.065867,-13.817968]</span>,<span class="hljs-selector-attr">[127.804633,-14.276906]</span>,<span class="hljs-selector-attr">[128.35969,-14.86917]</span>,<span class="hljs-selector-attr">[128.985543,-14.875991]</span>,<span class="hljs-selector-attr">[129.621473,-14.969784]</span>,<span class="hljs-selector-attr">[129.4096,-14.42067]</span>,<span class="hljs-selector-attr">[129.888641,-13.618703]</span>,<span class="hljs-selector-attr">[130.339466,-13.357376]</span>,<span class="hljs-selector-attr">[130.183506,-13.10752]</span>,<span class="hljs-selector-attr">[130.617795,-12.536392]</span>,<span class="hljs-selector-attr">[131.223495,-12.183649]</span>,<span class="hljs-selector-attr">[131.735091,-12.302453]</span>,<span class="hljs-selector-attr">[132.575298,-12.114041]</span>,<span class="hljs-selector-attr">[132.557212,-11.603012]</span>,<span class="hljs-selector-attr">[131.824698,-11.273782]</span>,<span class="hljs-selector-attr">[132.357224,-11.128519]</span>,<span class="hljs-selector-attr">[133.019561,-11.376411]</span>,<span class="hljs-selector-attr">[133.550846,-11.786515]</span>,<span class="hljs-selector-attr">[134.393068,-12.042365]</span>,<span class="hljs-selector-attr">[134.678632,-11.941183]</span>,<span class="hljs-selector-attr">[135.298491,-12.248606]</span>,<span class="hljs-selector-attr">[135.882693,-11.962267]</span>,<span class="hljs-selector-attr">[136.258381,-12.049342]</span>,<span class="hljs-selector-attr">[136.492475,-11.857209]</span>,<span class="hljs-selector-attr">[136.95162,-12.351959]</span>,<span class="hljs-selector-attr">[136.685125,-12.887223]</span>,<span class="hljs-selector-attr">[136.305407,-13.29123]</span>,<span class="hljs-selector-attr">[135.961758,-13.324509]</span>,<span class="hljs-selector-attr">[136.077617,-13.724278]</span>,<span class="hljs-selector-attr">[135.783836,-14.223989]</span>,<span class="hljs-selector-attr">[135.428664,-14.715432]</span>,<span class="hljs-selector-attr">[135.500184,-14.997741]</span>,<span class="hljs-selector-attr">[136.295175,-15.550265]</span>,<span class="hljs-selector-attr">[137.06536,-15.870762]</span>,<span class="hljs-selector-attr">[137.580471,-16.215082]</span>,<span class="hljs-selector-attr">[138.303217,-16.807604]</span>,<span class="hljs-selector-attr">[138.585164,-16.806622]</span>,<span class="hljs-selector-attr">[139.108543,-17.062679]</span>,<span class="hljs-selector-attr">[139.260575,-17.371601]</span>,<span class="hljs-selector-attr">[140.215245,-17.710805]</span>,<span class="hljs-selector-attr">[140.875463,-17.369069]</span>,<span class="hljs-selector-attr">[141.07111,-16.832047]</span>,<span class="hljs-selector-attr">[141.274095,-16.38887]</span>,<span class="hljs-selector-attr">[141.398222,-15.840532]</span>,<span class="hljs-selector-attr">[141.702183,-15.044921]</span>,<span class="hljs-selector-attr">[141.56338,-14.561333]</span>,<span class="hljs-selector-attr">[141.63552,-14.270395]</span>,<span class="hljs-selector-attr">[141.519869,-13.698078]</span>,<span class="hljs-selector-attr">[141.65092,-12.944688]</span>,<span class="hljs-selector-attr">[141.842691,-12.741548]</span>,<span class="hljs-selector-attr">[141.68699,-12.407614]</span>,<span class="hljs-selector-attr">[141.928629,-11.877466]</span>,<span class="hljs-selector-attr">[142.118488,-11.328042]</span>,<span class="hljs-selector-attr">[142.143706,-11.042737]</span>,<span class="hljs-selector-attr">[142.51526,-10.668186]</span>,<span class="hljs-selector-attr">[142.79731,-11.157355]</span>,<span class="hljs-selector-attr">[142.866763,-11.784707]</span>,<span class="hljs-selector-attr">[143.115947,-11.90563]</span>,<span class="hljs-selector-attr">[143.158632,-12.325656]</span>,<span class="hljs-selector-attr">[143.522124,-12.834358]</span>,<span class="hljs-selector-attr">[143.597158,-13.400422]</span>,<span class="hljs-selector-attr">[143.561811,-13.763656]</span>]]]}},
{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Feature</span>","<span class="hljs-selector-tag">id</span>":"<span class="hljs-selector-tag">AUT</span>","<span class="hljs-selector-tag">properties</span>":{"<span class="hljs-selector-tag">name</span>":"<span class="hljs-selector-tag">Austria</span>"},"<span class="hljs-selector-tag">geometry</span>":{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Polygon</span>","<span class="hljs-selector-tag">coordinates</span>":<span class="hljs-selector-attr">[[[16.979667,48.123497]</span>,<span class="hljs-selector-attr">[16.903754,47.714866]</span>,<span class="hljs-selector-attr">[16.340584,47.712902]</span>,<span class="hljs-selector-attr">[16.534268,47.496171]</span>,<span class="hljs-selector-attr">[16.202298,46.852386]</span>,<span class="hljs-selector-attr">[16.011664,46.683611]</span>,<span class="hljs-selector-attr">[15.137092,46.658703]</span>,<span class="hljs-selector-attr">[14.632472,46.431817]</span>,<span class="hljs-selector-attr">[13.806475,46.509306]</span>,<span class="hljs-selector-attr">[12.376485,46.767559]</span>,<span class="hljs-selector-attr">[12.153088,47.115393]</span>,<span class="hljs-selector-attr">[11.164828,46.941579]</span>,<span class="hljs-selector-attr">[11.048556,46.751359]</span>,<span class="hljs-selector-attr">[10.442701,46.893546]</span>,<span class="hljs-selector-attr">[9.932448,46.920728]</span>,<span class="hljs-selector-attr">[9.47997,47.10281]</span>,<span class="hljs-selector-attr">[9.632932,47.347601]</span>,<span class="hljs-selector-attr">[9.594226,47.525058]</span>,<span class="hljs-selector-attr">[9.896068,47.580197]</span>,<span class="hljs-selector-attr">[10.402084,47.302488]</span>,<span class="hljs-selector-attr">[10.544504,47.566399]</span>,<span class="hljs-selector-attr">[11.426414,47.523766]</span>,<span class="hljs-selector-attr">[12.141357,47.703083]</span>,<span class="hljs-selector-attr">[12.62076,47.672388]</span>,<span class="hljs-selector-attr">[12.932627,47.467646]</span>,<span class="hljs-selector-attr">[13.025851,47.637584]</span>,<span class="hljs-selector-attr">[12.884103,48.289146]</span>,<span class="hljs-selector-attr">[13.243357,48.416115]</span>,<span class="hljs-selector-attr">[13.595946,48.877172]</span>,<span class="hljs-selector-attr">[14.338898,48.555305]</span>,<span class="hljs-selector-attr">[14.901447,48.964402]</span>,<span class="hljs-selector-attr">[15.253416,49.039074]</span>,<span class="hljs-selector-attr">[16.029647,48.733899]</span>,<span class="hljs-selector-attr">[16.499283,48.785808]</span>,<span class="hljs-selector-attr">[16.960288,48.596982]</span>,<span class="hljs-selector-attr">[16.879983,48.470013]</span>,<span class="hljs-selector-attr">[16.979667,48.123497]</span>]]}},
{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Feature</span>","<span class="hljs-selector-tag">id</span>":"<span class="hljs-selector-tag">AZE</span>","<span class="hljs-selector-tag">properties</span>":{"<span class="hljs-selector-tag">name</span>":"<span class="hljs-selector-tag">Azerbaijan</span>"},"<span class="hljs-selector-tag">geometry</span>":{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">MultiPolygon</span>","<span class="hljs-selector-tag">coordinates</span>":<span class="hljs-selector-attr">[[[[45.001987,39.740004]</span>,<span class="hljs-selector-attr">[45.298145,39.471751]</span>,<span class="hljs-selector-attr">[45.739978,39.473999]</span>,<span class="hljs-selector-attr">[45.735379,39.319719]</span>,<span class="hljs-selector-attr">[46.143623,38.741201]</span>,<span class="hljs-selector-attr">[45.457722,38.874139]</span>,<span class="hljs-selector-attr">[44.952688,39.335765]</span>,<span class="hljs-selector-attr">[44.79399,39.713003]</span>,<span class="hljs-selector-attr">[45.001987,39.740004]</span>]],<span class="hljs-selector-attr">[[[47.373315,41.219732]</span>,<span class="hljs-selector-attr">[47.815666,41.151416]</span>,<span class="hljs-selector-attr">[47.987283,41.405819]</span>,<span class="hljs-selector-attr">[48.584353,41.80887]</span>,<span class="hljs-selector-attr">[49.110264,41.282287]</span>,<span class="hljs-selector-attr">[49.618915,40.572924]</span>,<span class="hljs-selector-attr">[50.08483,40.526157]</span>,<span class="hljs-selector-attr">[50.392821,40.256561]</span>,<span class="hljs-selector-attr">[49.569202,40.176101]</span>,<span class="hljs-selector-attr">[49.395259,39.399482]</span>,<span class="hljs-selector-attr">[49.223228,39.049219]</span>,<span class="hljs-selector-attr">[48.856532,38.815486]</span>,<span class="hljs-selector-attr">[48.883249,38.320245]</span>,<span class="hljs-selector-attr">[48.634375,38.270378]</span>,<span class="hljs-selector-attr">[48.010744,38.794015]</span>,<span class="hljs-selector-attr">[48.355529,39.288765]</span>,<span class="hljs-selector-attr">[48.060095,39.582235]</span>,<span class="hljs-selector-attr">[47.685079,39.508364]</span>,<span class="hljs-selector-attr">[46.50572,38.770605]</span>,<span class="hljs-selector-attr">[46.483499,39.464155]</span>,<span class="hljs-selector-attr">[46.034534,39.628021]</span>,<span class="hljs-selector-attr">[45.610012,39.899994]</span>,<span class="hljs-selector-attr">[45.891907,40.218476]</span>,<span class="hljs-selector-attr">[45.359175,40.561504]</span>,<span class="hljs-selector-attr">[45.560351,40.81229]</span>,<span class="hljs-selector-attr">[45.179496,40.985354]</span>,<span class="hljs-selector-attr">[44.97248,41.248129]</span>,<span class="hljs-selector-attr">[45.217426,41.411452]</span>,<span class="hljs-selector-attr">[45.962601,41.123873]</span>,<span class="hljs-selector-attr">[46.501637,41.064445]</span>,<span class="hljs-selector-attr">[46.637908,41.181673]</span>,<span class="hljs-selector-attr">[46.145432,41.722802]</span>,<span class="hljs-selector-attr">[46.404951,41.860675]</span>,<span class="hljs-selector-attr">[46.686071,41.827137]</span>,<span class="hljs-selector-attr">[47.373315,41.219732]</span>]]]}},
{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Feature</span>","<span class="hljs-selector-tag">id</span>":"<span class="hljs-selector-tag">BDI</span>","<span class="hljs-selector-tag">properties</span>":{"<span class="hljs-selector-tag">name</span>":"<span class="hljs-selector-tag">Burundi</span>"},"<span class="hljs-selector-tag">geometry</span>":{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Polygon</span>","<span class="hljs-selector-tag">coordinates</span>":<span class="hljs-selector-attr">[[[29.339998,-4.499983]</span>,<span class="hljs-selector-attr">[29.276384,-3.293907]</span>,<span class="hljs-selector-attr">[29.024926,-2.839258]</span>,<span class="hljs-selector-attr">[29.632176,-2.917858]</span>,<span class="hljs-selector-attr">[29.938359,-2.348487]</span>,<span class="hljs-selector-attr">[30.469696,-2.413858]</span>,<span class="hljs-selector-attr">[30.527677,-2.807632]</span>,<span class="hljs-selector-attr">[30.743013,-3.034285]</span>,<span class="hljs-selector-attr">[30.752263,-3.35933]</span>,<span class="hljs-selector-attr">[30.50556,-3.568567]</span>,<span class="hljs-selector-attr">[30.116333,-4.090138]</span>,<span class="hljs-selector-attr">[29.753512,-4.452389]</span>,<span class="hljs-selector-attr">[29.339998,-4.499983]</span>]]}},
{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Feature</span>","<span class="hljs-selector-tag">id</span>":"<span class="hljs-selector-tag">BEL</span>","<span class="hljs-selector-tag">properties</span>":{"<span class="hljs-selector-tag">name</span>":"<span class="hljs-selector-tag">Belgium</span>"},"<span class="hljs-selector-tag">geometry</span>":{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Polygon</span>","<span class="hljs-selector-tag">coordinates</span>":<span class="hljs-selector-attr">[[[3.314971,51.345781]</span>,<span class="hljs-selector-attr">[4.047071,51.267259]</span>,<span class="hljs-selector-attr">[4.973991,51.475024]</span>,<span class="hljs-selector-attr">[5.606976,51.037298]</span>,<span class="hljs-selector-attr">[6.156658,50.803721]</span>,<span class="hljs-selector-attr">[6.043073,50.128052]</span>,<span class="hljs-selector-attr">[5.782417,50.090328]</span>,<span class="hljs-selector-attr">[5.674052,49.529484]</span>,<span class="hljs-selector-attr">[4.799222,49.985373]</span>,<span class="hljs-selector-attr">[4.286023,49.907497]</span>,<span class="hljs-selector-attr">[3.588184,50.378992]</span>,<span class="hljs-selector-attr">[3.123252,50.780363]</span>,<span class="hljs-selector-attr">[2.658422,50.796848]</span>,<span class="hljs-selector-attr">[2.513573,51.148506]</span>,<span class="hljs-selector-attr">[3.314971,51.345781]</span>]]}},
{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Feature</span>","<span class="hljs-selector-tag">id</span>":"<span class="hljs-selector-tag">BEN</span>","<span class="hljs-selector-tag">properties</span>":{"<span class="hljs-selector-tag">name</span>":"<span class="hljs-selector-tag">Benin</span>"},"<span class="hljs-selector-tag">geometry</span>":{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Polygon</span>","<span class="hljs-selector-tag">coordinates</span>":<span class="hljs-selector-attr">[[[2.691702,6.258817]</span>,<span class="hljs-selector-attr">[1.865241,6.142158]</span>,<span class="hljs-selector-attr">[1.618951,6.832038]</span>,<span class="hljs-selector-attr">[1.664478,9.12859]</span>,<span class="hljs-selector-attr">[1.463043,9.334624]</span>,<span class="hljs-selector-attr">[1.425061,9.825395]</span>,<span class="hljs-selector-attr">[1.077795,10.175607]</span>,<span class="hljs-selector-attr">[0.772336,10.470808]</span>,<span class="hljs-selector-attr">[0.899563,10.997339]</span>,<span class="hljs-selector-attr">[1.24347,11.110511]</span>,<span class="hljs-selector-attr">[1.447178,11.547719]</span>,<span class="hljs-selector-attr">[1.935986,11.64115]</span>,<span class="hljs-selector-attr">[2.154474,11.94015]</span>,<span class="hljs-selector-attr">[2.490164,12.233052]</span>,<span class="hljs-selector-attr">[2.848643,12.235636]</span>,<span class="hljs-selector-attr">[3.61118,11.660167]</span>,<span class="hljs-selector-attr">[3.572216,11.327939]</span>,<span class="hljs-selector-attr">[3.797112,10.734746]</span>,<span class="hljs-selector-attr">[3.60007,10.332186]</span>,<span class="hljs-selector-attr">[3.705438,10.06321]</span>,<span class="hljs-selector-attr">[3.220352,9.444153]</span>,<span class="hljs-selector-attr">[2.912308,9.137608]</span>,<span class="hljs-selector-attr">[2.723793,8.506845]</span>,<span class="hljs-selector-attr">[2.749063,7.870734]</span>,<span class="hljs-selector-attr">[2.691702,6.258817]</span>]]}},
{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Feature</span>","<span class="hljs-selector-tag">id</span>":"<span class="hljs-selector-tag">BFA</span>","<span class="hljs-selector-tag">properties</span>":{"<span class="hljs-selector-tag">name</span>":"<span class="hljs-selector-tag">Burkina</span> <span class="hljs-selector-tag">Faso</span>"},"<span class="hljs-selector-tag">geometry</span>":{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Polygon</span>","<span class="hljs-selector-tag">coordinates</span>":<span class="hljs-selector-attr">[[[-2.827496,9.642461]</span>,<span class="hljs-selector-attr">[-3.511899,9.900326]</span>,<span class="hljs-selector-attr">[-3.980449,9.862344]</span>,<span class="hljs-selector-attr">[-4.330247,9.610835]</span>,<span class="hljs-selector-attr">[-4.779884,9.821985]</span>,<span class="hljs-selector-attr">[-4.954653,10.152714]</span>,<span class="hljs-selector-attr">[-5.404342,10.370737]</span>,<span class="hljs-selector-attr">[-5.470565,10.95127]</span>,<span class="hljs-selector-attr">[-5.197843,11.375146]</span>,<span class="hljs-selector-attr">[-5.220942,11.713859]</span>,<span class="hljs-selector-attr">[-4.427166,12.542646]</span>,<span class="hljs-selector-attr">[-4.280405,13.228444]</span>,<span class="hljs-selector-attr">[-4.006391,13.472485]</span>,<span class="hljs-selector-attr">[-3.522803,13.337662]</span>,<span class="hljs-selector-attr">[-3.103707,13.541267]</span>,<span class="hljs-selector-attr">[-2.967694,13.79815]</span>,<span class="hljs-selector-attr">[-2.191825,14.246418]</span>,<span class="hljs-selector-attr">[-2.001035,14.559008]</span>,<span class="hljs-selector-attr">[-1.066363,14.973815]</span>,<span class="hljs-selector-attr">[-0.515854,15.116158]</span>,<span class="hljs-selector-attr">[-0.266257,14.924309]</span>,<span class="hljs-selector-attr">[0.374892,14.928908]</span>,<span class="hljs-selector-attr">[0.295646,14.444235]</span>,<span class="hljs-selector-attr">[0.429928,13.988733]</span>,<span class="hljs-selector-attr">[0.993046,13.33575]</span>,<span class="hljs-selector-attr">[1.024103,12.851826]</span>,<span class="hljs-selector-attr">[2.177108,12.625018]</span>,<span class="hljs-selector-attr">[2.154474,11.94015]</span>,<span class="hljs-selector-attr">[1.935986,11.64115]</span>,<span class="hljs-selector-attr">[1.447178,11.547719]</span>,<span class="hljs-selector-attr">[1.24347,11.110511]</span>,<span class="hljs-selector-attr">[0.899563,10.997339]</span>,<span class="hljs-selector-attr">[0.023803,11.018682]</span>,<span class="hljs-selector-attr">[-0.438702,11.098341]</span>,<span class="hljs-selector-attr">[-0.761576,10.93693]</span>,<span class="hljs-selector-attr">[-1.203358,11.009819]</span>,<span class="hljs-selector-attr">[-2.940409,10.96269]</span>,<span class="hljs-selector-attr">[-2.963896,10.395335]</span>,<span class="hljs-selector-attr">[-2.827496,9.642461]</span>]]}},
{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Feature</span>","<span class="hljs-selector-tag">id</span>":"<span class="hljs-selector-tag">BGD</span>","<span class="hljs-selector-tag">properties</span>":{"<span class="hljs-selector-tag">name</span>":"<span class="hljs-selector-tag">Bangladesh</span>"},"<span class="hljs-selector-tag">geometry</span>":{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Polygon</span>","<span class="hljs-selector-tag">coordinates</span>":<span class="hljs-selector-attr">[[[92.672721,22.041239]</span>,<span class="hljs-selector-attr">[92.652257,21.324048]</span>,<span class="hljs-selector-attr">[92.303234,21.475485]</span>,<span class="hljs-selector-attr">[92.368554,20.670883]</span>,<span class="hljs-selector-attr">[92.082886,21.192195]</span>,<span class="hljs-selector-attr">[92.025215,21.70157]</span>,<span class="hljs-selector-attr">[91.834891,22.182936]</span>,<span class="hljs-selector-attr">[91.417087,22.765019]</span>,<span class="hljs-selector-attr">[90.496006,22.805017]</span>,<span class="hljs-selector-attr">[90.586957,22.392794]</span>,<span class="hljs-selector-attr">[90.272971,21.836368]</span>,<span class="hljs-selector-attr">[89.847467,22.039146]</span>,<span class="hljs-selector-attr">[89.70205,21.857116]</span>,<span class="hljs-selector-attr">[89.418863,21.966179]</span>,<span class="hljs-selector-attr">[89.031961,22.055708]</span>,<span class="hljs-selector-attr">[88.876312,22.879146]</span>,<span class="hljs-selector-attr">[88.52977,23.631142]</span>,<span class="hljs-selector-attr">[88.69994,24.233715]</span>,<span class="hljs-selector-attr">[88.084422,24.501657]</span>,<span class="hljs-selector-attr">[88.306373,24.866079]</span>,<span class="hljs-selector-attr">[88.931554,25.238692]</span>,<span class="hljs-selector-attr">[88.209789,25.768066]</span>,<span class="hljs-selector-attr">[88.563049,26.446526]</span>,<span class="hljs-selector-attr">[89.355094,26.014407]</span>,<span class="hljs-selector-attr">[89.832481,25.965082]</span>,<span class="hljs-selector-attr">[89.920693,25.26975]</span>,<span class="hljs-selector-attr">[90.872211,25.132601]</span>,<span class="hljs-selector-attr">[91.799596,25.147432]</span>,<span class="hljs-selector-attr">[92.376202,24.976693]</span>,<span class="hljs-selector-attr">[91.915093,24.130414]</span>,<span class="hljs-selector-attr">[91.46773,24.072639]</span>,<span class="hljs-selector-attr">[91.158963,23.503527]</span>,<span class="hljs-selector-attr">[91.706475,22.985264]</span>,<span class="hljs-selector-attr">[91.869928,23.624346]</span>,<span class="hljs-selector-attr">[92.146035,23.627499]</span>,<span class="hljs-selector-attr">[92.672721,22.041239]</span>]]}},
{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Feature</span>","<span class="hljs-selector-tag">id</span>":"<span class="hljs-selector-tag">BGR</span>","<span class="hljs-selector-tag">properties</span>":{"<span class="hljs-selector-tag">name</span>":"<span class="hljs-selector-tag">Bulgaria</span>"},"<span class="hljs-selector-tag">geometry</span>":{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Polygon</span>","<span class="hljs-selector-tag">coordinates</span>":<span class="hljs-selector-attr">[[[22.65715,44.234923]</span>,<span class="hljs-selector-attr">[22.944832,43.823785]</span>,<span class="hljs-selector-attr">[23.332302,43.897011]</span>,<span class="hljs-selector-attr">[24.100679,43.741051]</span>,<span class="hljs-selector-attr">[25.569272,43.688445]</span>,<span class="hljs-selector-attr">[26.065159,43.943494]</span>,<span class="hljs-selector-attr">[27.2424,44.175986]</span>,<span class="hljs-selector-attr">[27.970107,43.812468]</span>,<span class="hljs-selector-attr">[28.558081,43.707462]</span>,<span class="hljs-selector-attr">[28.039095,43.293172]</span>,<span class="hljs-selector-attr">[27.673898,42.577892]</span>,<span class="hljs-selector-attr">[27.99672,42.007359]</span>,<span class="hljs-selector-attr">[27.135739,42.141485]</span>,<span class="hljs-selector-attr">[26.117042,41.826905]</span>,<span class="hljs-selector-attr">[26.106138,41.328899]</span>,<span class="hljs-selector-attr">[25.197201,41.234486]</span>,<span class="hljs-selector-attr">[24.492645,41.583896]</span>,<span class="hljs-selector-attr">[23.692074,41.309081]</span>,<span class="hljs-selector-attr">[22.952377,41.337994]</span>,<span class="hljs-selector-attr">[22.881374,41.999297]</span>,<span class="hljs-selector-attr">[22.380526,42.32026]</span>,<span class="hljs-selector-attr">[22.545012,42.461362]</span>,<span class="hljs-selector-attr">[22.436595,42.580321]</span>,<span class="hljs-selector-attr">[22.604801,42.898519]</span>,<span class="hljs-selector-attr">[22.986019,43.211161]</span>,<span class="hljs-selector-attr">[22.500157,43.642814]</span>,<span class="hljs-selector-attr">[22.410446,44.008063]</span>,<span class="hljs-selector-attr">[22.65715,44.234923]</span>]]}},
{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Feature</span>","<span class="hljs-selector-tag">id</span>":"<span class="hljs-selector-tag">BHS</span>","<span class="hljs-selector-tag">properties</span>":{"<span class="hljs-selector-tag">name</span>":"<span class="hljs-selector-tag">The</span> <span class="hljs-selector-tag">Bahamas</span>"},"<span class="hljs-selector-tag">geometry</span>":{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">MultiPolygon</span>","<span class="hljs-selector-tag">coordinates</span>":<span class="hljs-selector-attr">[[[[-77.53466,23.75975]</span>,<span class="hljs-selector-attr">[-77.78,23.71]</span>,<span class="hljs-selector-attr">[-78.03405,24.28615]</span>,<span class="hljs-selector-attr">[-78.40848,24.57564]</span>,<span class="hljs-selector-attr">[-78.19087,25.2103]</span>,<span class="hljs-selector-attr">[-77.89,25.17]</span>,<span class="hljs-selector-attr">[-77.54,24.34]</span>,<span class="hljs-selector-attr">[-77.53466,23.75975]</span>]],<span class="hljs-selector-attr">[[[-77.82,26.58]</span>,<span class="hljs-selector-attr">[-78.91,26.42]</span>,<span class="hljs-selector-attr">[-78.98,26.79]</span>,<span class="hljs-selector-attr">[-78.51,26.87]</span>,<span class="hljs-selector-attr">[-77.85,26.84]</span>,<span class="hljs-selector-attr">[-77.82,26.58]</span>]],<span class="hljs-selector-attr">[[[-77,26.59]</span>,<span class="hljs-selector-attr">[-77.17255,25.87918]</span>,<span class="hljs-selector-attr">[-77.35641,26.00735]</span>,<span class="hljs-selector-attr">[-77.34,26.53]</span>,<span class="hljs-selector-attr">[-77.78802,26.92516]</span>,<span class="hljs-selector-attr">[-77.79,27.04]</span>,<span class="hljs-selector-attr">[-77,26.59]</span>]]]}},
{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Feature</span>","<span class="hljs-selector-tag">id</span>":"<span class="hljs-selector-tag">BIH</span>","<span class="hljs-selector-tag">properties</span>":{"<span class="hljs-selector-tag">name</span>":"<span class="hljs-selector-tag">Bosnia</span> <span class="hljs-selector-tag">and</span> <span class="hljs-selector-tag">Herzegovina</span>"},"<span class="hljs-selector-tag">geometry</span>":{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Polygon</span>","<span class="hljs-selector-tag">coordinates</span>":<span class="hljs-selector-attr">[[[19.005486,44.860234]</span>,<span class="hljs-selector-attr">[19.36803,44.863]</span>,<span class="hljs-selector-attr">[19.11761,44.42307]</span>,<span class="hljs-selector-attr">[19.59976,44.03847]</span>,<span class="hljs-selector-attr">[19.454,43.5681]</span>,<span class="hljs-selector-attr">[19.21852,43.52384]</span>,<span class="hljs-selector-attr">[19.03165,43.43253]</span>,<span class="hljs-selector-attr">[18.70648,43.20011]</span>,<span class="hljs-selector-attr">[18.56,42.65]</span>,<span class="hljs-selector-attr">[17.674922,43.028563]</span>,<span class="hljs-selector-attr">[17.297373,43.446341]</span>,<span class="hljs-selector-attr">[16.916156,43.667722]</span>,<span class="hljs-selector-attr">[16.456443,44.04124]</span>,<span class="hljs-selector-attr">[16.23966,44.351143]</span>,<span class="hljs-selector-attr">[15.750026,44.818712]</span>,<span class="hljs-selector-attr">[15.959367,45.233777]</span>,<span class="hljs-selector-attr">[16.318157,45.004127]</span>,<span class="hljs-selector-attr">[16.534939,45.211608]</span>,<span class="hljs-selector-attr">[17.002146,45.233777]</span>,<span class="hljs-selector-attr">[17.861783,45.06774]</span>,<span class="hljs-selector-attr">[18.553214,45.08159]</span>,<span class="hljs-selector-attr">[19.005486,44.860234]</span>]]}},
{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Feature</span>","<span class="hljs-selector-tag">id</span>":"<span class="hljs-selector-tag">BLR</span>","<span class="hljs-selector-tag">properties</span>":{"<span class="hljs-selector-tag">name</span>":"<span class="hljs-selector-tag">Belarus</span>"},"<span class="hljs-selector-tag">geometry</span>":{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Polygon</span>","<span class="hljs-selector-tag">coordinates</span>":<span class="hljs-selector-attr">[[[23.484128,53.912498]</span>,<span class="hljs-selector-attr">[24.450684,53.905702]</span>,<span class="hljs-selector-attr">[25.536354,54.282423]</span>,<span class="hljs-selector-attr">[25.768433,54.846963]</span>,<span class="hljs-selector-attr">[26.588279,55.167176]</span>,<span class="hljs-selector-attr">[26.494331,55.615107]</span>,<span class="hljs-selector-attr">[27.10246,55.783314]</span>,<span class="hljs-selector-attr">[28.176709,56.16913]</span>,<span class="hljs-selector-attr">[29.229513,55.918344]</span>,<span class="hljs-selector-attr">[29.371572,55.670091]</span>,<span class="hljs-selector-attr">[29.896294,55.789463]</span>,<span class="hljs-selector-attr">[30.873909,55.550976]</span>,<span class="hljs-selector-attr">[30.971836,55.081548]</span>,<span class="hljs-selector-attr">[30.757534,54.811771]</span>,<span class="hljs-selector-attr">[31.384472,54.157056]</span>,<span class="hljs-selector-attr">[31.791424,53.974639]</span>,<span class="hljs-selector-attr">[31.731273,53.794029]</span>,<span class="hljs-selector-attr">[32.405599,53.618045]</span>,<span class="hljs-selector-attr">[32.693643,53.351421]</span>,<span class="hljs-selector-attr">[32.304519,53.132726]</span>,<span class="hljs-selector-attr">[31.497644,53.167427]</span>,<span class="hljs-selector-attr">[31.305201,53.073996]</span>,<span class="hljs-selector-attr">[31.540018,52.742052]</span>,<span class="hljs-selector-attr">[31.785998,52.101678]</span>,<span class="hljs-selector-attr">[30.927549,52.042353]</span>,<span class="hljs-selector-attr">[30.619454,51.822806]</span>,<span class="hljs-selector-attr">[30.555117,51.319503]</span>,<span class="hljs-selector-attr">[30.157364,51.416138]</span>,<span class="hljs-selector-attr">[29.254938,51.368234]</span>,<span class="hljs-selector-attr">[28.992835,51.602044]</span>,<span class="hljs-selector-attr">[28.617613,51.427714]</span>,<span class="hljs-selector-attr">[28.241615,51.572227]</span>,<span class="hljs-selector-attr">[27.454066,51.592303]</span>,<span class="hljs-selector-attr">[26.337959,51.832289]</span>,<span class="hljs-selector-attr">[25.327788,51.910656]</span>,<span class="hljs-selector-attr">[24.553106,51.888461]</span>,<span class="hljs-selector-attr">[24.005078,51.617444]</span>,<span class="hljs-selector-attr">[23.527071,51.578454]</span>,<span class="hljs-selector-attr">[23.508002,52.023647]</span>,<span class="hljs-selector-attr">[23.199494,52.486977]</span>,<span class="hljs-selector-attr">[23.799199,52.691099]</span>,<span class="hljs-selector-attr">[23.804935,53.089731]</span>,<span class="hljs-selector-attr">[23.527536,53.470122]</span>,<span class="hljs-selector-attr">[23.484128,53.912498]</span>]]}},
{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Feature</span>","<span class="hljs-selector-tag">id</span>":"<span class="hljs-selector-tag">BLZ</span>","<span class="hljs-selector-tag">properties</span>":{"<span class="hljs-selector-tag">name</span>":"<span class="hljs-selector-tag">Belize</span>"},"<span class="hljs-selector-tag">geometry</span>":{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Polygon</span>","<span class="hljs-selector-tag">coordinates</span>":<span class="hljs-selector-attr">[[[-89.14308,17.808319]</span>,<span class="hljs-selector-attr">[-89.150909,17.955468]</span>,<span class="hljs-selector-attr">[-89.029857,18.001511]</span>,<span class="hljs-selector-attr">[-88.848344,17.883198]</span>,<span class="hljs-selector-attr">[-88.490123,18.486831]</span>,<span class="hljs-selector-attr">[-88.300031,18.499982]</span>,<span class="hljs-selector-attr">[-88.296336,18.353273]</span>,<span class="hljs-selector-attr">[-88.106813,18.348674]</span>,<span class="hljs-selector-attr">[-88.123479,18.076675]</span>,<span class="hljs-selector-attr">[-88.285355,17.644143]</span>,<span class="hljs-selector-attr">[-88.197867,17.489475]</span>,<span class="hljs-selector-attr">[-88.302641,17.131694]</span>,<span class="hljs-selector-attr">[-88.239518,17.036066]</span>,<span class="hljs-selector-attr">[-88.355428,16.530774]</span>,<span class="hljs-selector-attr">[-88.551825,16.265467]</span>,<span class="hljs-selector-attr">[-88.732434,16.233635]</span>,<span class="hljs-selector-attr">[-88.930613,15.887273]</span>,<span class="hljs-selector-attr">[-89.229122,15.886938]</span>,<span class="hljs-selector-attr">[-89.150806,17.015577]</span>,<span class="hljs-selector-attr">[-89.14308,17.808319]</span>]]}},
{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Feature</span>","<span class="hljs-selector-tag">id</span>":"<span class="hljs-selector-tag">BMU</span>","<span class="hljs-selector-tag">properties</span>":{"<span class="hljs-selector-tag">name</span>":"<span class="hljs-selector-tag">Bermuda</span>"},"<span class="hljs-selector-tag">geometry</span>":{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Polygon</span>","<span class="hljs-selector-tag">coordinates</span>":<span class="hljs-selector-attr">[[[-64.7799734332998,32.3072000581802]</span>,<span class="hljs-selector-attr">[-64.7873319183061,32.3039237143428]</span>,<span class="hljs-selector-attr">[-64.7946942710173,32.3032682700388]</span>,<span class="hljs-selector-attr">[-64.8094297981283,32.3098175728414]</span>,<span class="hljs-selector-attr">[-64.8167896352437,32.3058845718466]</span>,<span class="hljs-selector-attr">[-64.8101968029642,32.3022833180511]</span>,<span class="hljs-selector-attr">[-64.7962291465484,32.2934409732427]</span>,<span class="hljs-selector-attr">[-64.7815086336978,32.2868973114514]</span>,<span class="hljs-selector-attr">[-64.7997025513437,32.2796896417328]</span>,<span class="hljs-selector-attr">[-64.8066707691087,32.2747767569465]</span>,<span class="hljs-selector-attr">[-64.8225587873683,32.2669111289395]</span>,<span class="hljs-selector-attr">[-64.8287548840306,32.2669075473817]</span>,<span class="hljs-selector-attr">[-64.8306732143498,32.2583944840235]</span>,<span class="hljs-selector-attr">[-64.8399924854972,32.254782282336]</span>,<span class="hljs-selector-attr">[-64.8566090462354,32.2547740387514]</span>,<span class="hljs-selector-attr">[-64.8682296789446,32.2616393614322]</span>,<span class="hljs-selector-attr">[-64.8628241459563,32.2724481933959]</span>,<span class="hljs-selector-attr">[-64.8748651338951,32.2757120264753]</span>,<span class="hljs-selector-attr">[-64.8717752856644,32.2819371582026]</span>,<span class="hljs-selector-attr">[-64.8671422127295,32.2930760547989]</span>,<span class="hljs-selector-attr">[-64.8559068764437,32.2960321186471]</span>,<span class="hljs-selector-attr">[-64.8597429072279,32.3015842021933]</span>,<span class="hljs-selector-attr">[-64.8439233486717,32.3140553852543]</span>,<span class="hljs-selector-attr">[-64.8350242329311,32.3242161760006]</span>,<span class="hljs-selector-attr">[-64.8338690593672,32.3294587561557]</span>,<span class="hljs-selector-attr">[-64.8520298651164,32.3110911879954]</span>,<span class="hljs-selector-attr">[-64.8635922932573,32.3048469433363]</span>,<span class="hljs-selector-attr">[-64.8686668994079,32.30910745083]</span>,<span class="hljs-selector-attr">[-64.8721354593415,32.3041908606301]</span>,<span class="hljs-selector-attr">[-64.8779667328485,32.3038632800462]</span>,<span class="hljs-selector-attr">[-64.8780046844321,32.2907757831692]</span>,<span class="hljs-selector-attr">[-64.8849776658292,32.2819261366004]</span>,<span class="hljs-selector-attr">[-64.8783230004629,32.2613001418681]</span>,<span class="hljs-selector-attr">[-64.863194968877,32.2465799485801]</span>,<span class="hljs-selector-attr">[-64.8519819555722,32.2485519134663]</span>,<span class="hljs-selector-attr">[-64.842311980074,32.2492123317296]</span>,<span class="hljs-selector-attr">[-64.8388242605209,32.2475773472534]</span>,<span class="hljs-selector-attr">[-64.8334002575532,32.2462714714698]</span>,<span class="hljs-selector-attr">[-64.8256389530584,32.2472637398594]</span>,<span class="hljs-selector-attr">[-64.8205697556026,32.2531698880328]</span>,<span class="hljs-selector-attr">[-64.8105087275579,32.2561208974156]</span>,<span class="hljs-selector-attr">[-64.7900177727338,32.2659446936992]</span>,<span class="hljs-selector-attr">[-64.7745415970416,32.2718413023427]</span>,<span class="hljs-selector-attr">[-64.7644742436426,32.2855931353214]</span>,<span class="hljs-selector-attr">[-64.7551803442276,32.2908326702531]</span>,<span class="hljs-selector-attr">[-64.7423982971436,32.2996734994024]</span>,<span class="hljs-selector-attr">[-64.7206991797682,32.3137542201258]</span>,<span class="hljs-selector-attr">[-64.7117851247134,32.3176823360806]</span>,<span class="hljs-selector-attr">[-64.6962778813133,32.3275029115532]</span>,<span class="hljs-selector-attr">[-64.6768921127452,32.3324095397555]</span>,<span class="hljs-selector-attr">[-64.6567136927777,32.3451776458469]</span>,<span class="hljs-selector-attr">[-64.6532168823499,32.3494356627941]</span>,<span class="hljs-selector-attr">[-64.6605720384429,32.3589423487763]</span>,<span class="hljs-selector-attr">[-64.65125819471,32.3615600906466]</span>,<span class="hljs-selector-attr">[-64.6462011670816,32.36975169749]</span>,<span class="hljs-selector-attr">[-64.6613227512832,32.3763135008721]</span>,<span class="hljs-selector-attr">[-64.6690666074397,32.388444543924]</span>,<span class="hljs-selector-attr">[-64.6834270548595,32.3854968316788]</span>,<span class="hljs-selector-attr">[-64.6954617672714,32.3763221285869]</span>,<span class="hljs-selector-attr">[-64.70438689565,32.3704254760469]</span>,<span class="hljs-selector-attr">[-64.7117569982798,32.368132600249]</span>,<span class="hljs-selector-attr">[-64.7061764744404,32.3600110593559]</span>,<span class="hljs-selector-attr">[-64.700531552697,32.3590601356818]</span>,<span class="hljs-selector-attr">[-64.6940348033967,32.3640708659835]</span>,<span class="hljs-selector-attr">[-64.6895164826082,32.3633598579866]</span>,<span class="hljs-selector-attr">[-64.6864150099255,32.3547797587266]</span>,<span class="hljs-selector-attr">[-64.6824635995504,32.3540628176846]</span>,<span class="hljs-selector-attr">[-64.6835876652835,32.3626447677968]</span>,<span class="hljs-selector-attr">[-64.6801998697415,32.3631199096979]</span>,<span class="hljs-selector-attr">[-64.6672170444687,32.3597751617473]</span>,<span class="hljs-selector-attr">[-64.6598811264978,32.3497625771755]</span>,<span class="hljs-selector-attr">[-64.6737331235384,32.3390281851635]</span>,<span class="hljs-selector-attr">[-64.6887090648183,32.3342439408053]</span>,<span class="hljs-selector-attr">[-64.706732854446,32.3429010723036]</span>,<span class="hljs-selector-attr">[-64.7149301576112,32.3552188753513]</span>,<span class="hljs-selector-attr">[-64.7185967666669,32.3552239212394]</span>,<span class="hljs-selector-attr">[-64.7214189847314,32.3518830231342]</span>,<span class="hljs-selector-attr">[-64.7270616067222,32.3466461715475]</span>,<span class="hljs-selector-attr">[-64.734962460882,32.3442819830499]</span>,<span class="hljs-selector-attr">[-64.7383521549094,32.3407216514918]</span>,<span class="hljs-selector-attr">[-64.7411729976333,32.3311790864627]</span>,<span class="hljs-selector-attr">[-64.7423019216485,32.323311561213]</span>,<span class="hljs-selector-attr">[-64.7462482354281,32.318538611581]</span>,<span class="hljs-selector-attr">[-64.7566773739613,32.3130509130175]</span>,<span class="hljs-selector-attr">[-64.768738200563,32.3088369816572]</span>,<span class="hljs-selector-attr">[-64.7799734332998,32.3072000581802]</span>]]}},
{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Feature</span>","<span class="hljs-selector-tag">id</span>":"<span class="hljs-selector-tag">BOL</span>","<span class="hljs-selector-tag">properties</span>":{"<span class="hljs-selector-tag">name</span>":"<span class="hljs-selector-tag">Bolivia</span>"},"<span class="hljs-selector-tag">geometry</span>":{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Polygon</span>","<span class="hljs-selector-tag">coordinates</span>":<span class="hljs-selector-attr">[[[-62.846468,-22.034985]</span>,<span class="hljs-selector-attr">[-63.986838,-21.993644]</span>,<span class="hljs-selector-attr">[-64.377021,-22.798091]</span>,<span class="hljs-selector-attr">[-64.964892,-22.075862]</span>,<span class="hljs-selector-attr">[-66.273339,-21.83231]</span>,<span class="hljs-selector-attr">[-67.106674,-22.735925]</span>,<span class="hljs-selector-attr">[-67.82818,-22.872919]</span>,<span class="hljs-selector-attr">[-68.219913,-21.494347]</span>,<span class="hljs-selector-attr">[-68.757167,-20.372658]</span>,<span class="hljs-selector-attr">[-68.442225,-19.405068]</span>,<span class="hljs-selector-attr">[-68.966818,-18.981683]</span>,<span class="hljs-selector-attr">[-69.100247,-18.260125]</span>,<span class="hljs-selector-attr">[-69.590424,-17.580012]</span>,<span class="hljs-selector-attr">[-68.959635,-16.500698]</span>,<span class="hljs-selector-attr">[-69.389764,-15.660129]</span>,<span class="hljs-selector-attr">[-69.160347,-15.323974]</span>,<span class="hljs-selector-attr">[-69.339535,-14.953195]</span>,<span class="hljs-selector-attr">[-68.948887,-14.453639]</span>,<span class="hljs-selector-attr">[-68.929224,-13.602684]</span>,<span class="hljs-selector-attr">[-68.88008,-12.899729]</span>,<span class="hljs-selector-attr">[-68.66508,-12.5613]</span>,<span class="hljs-selector-attr">[-69.529678,-10.951734]</span>,<span class="hljs-selector-attr">[-68.786158,-11.03638]</span>,<span class="hljs-selector-attr">[-68.271254,-11.014521]</span>,<span class="hljs-selector-attr">[-68.048192,-10.712059]</span>,<span class="hljs-selector-attr">[-67.173801,-10.306812]</span>,<span class="hljs-selector-attr">[-66.646908,-9.931331]</span>,<span class="hljs-selector-attr">[-65.338435,-9.761988]</span>,<span class="hljs-selector-attr">[-65.444837,-10.511451]</span>,<span class="hljs-selector-attr">[-65.321899,-10.895872]</span>,<span class="hljs-selector-attr">[-65.402281,-11.56627]</span>,<span class="hljs-selector-attr">[-64.316353,-12.461978]</span>,<span class="hljs-selector-attr">[-63.196499,-12.627033]</span>,<span class="hljs-selector-attr">[-62.80306,-13.000653]</span>,<span class="hljs-selector-attr">[-62.127081,-13.198781]</span>,<span class="hljs-selector-attr">[-61.713204,-13.489202]</span>,<span class="hljs-selector-attr">[-61.084121,-13.479384]</span>,<span class="hljs-selector-attr">[-60.503304,-13.775955]</span>,<span class="hljs-selector-attr">[-60.459198,-14.354007]</span>,<span class="hljs-selector-attr">[-60.264326,-14.645979]</span>,<span class="hljs-selector-attr">[-60.251149,-15.077219]</span>,<span class="hljs-selector-attr">[-60.542966,-15.09391]</span>,<span class="hljs-selector-attr">[-60.15839,-16.258284]</span>,<span class="hljs-selector-attr">[-58.24122,-16.299573]</span>,<span class="hljs-selector-attr">[-58.388058,-16.877109]</span>,<span class="hljs-selector-attr">[-58.280804,-17.27171]</span>,<span class="hljs-selector-attr">[-57.734558,-17.552468]</span>,<span class="hljs-selector-attr">[-57.498371,-18.174188]</span>,<span class="hljs-selector-attr">[-57.676009,-18.96184]</span>,<span class="hljs-selector-attr">[-57.949997,-19.400004]</span>,<span class="hljs-selector-attr">[-57.853802,-19.969995]</span>,<span class="hljs-selector-attr">[-58.166392,-20.176701]</span>,<span class="hljs-selector-attr">[-58.183471,-19.868399]</span>,<span class="hljs-selector-attr">[-59.115042,-19.356906]</span>,<span class="hljs-selector-attr">[-60.043565,-19.342747]</span>,<span class="hljs-selector-attr">[-61.786326,-19.633737]</span>,<span class="hljs-selector-attr">[-62.265961,-20.513735]</span>,<span class="hljs-selector-attr">[-62.291179,-21.051635]</span>,<span class="hljs-selector-attr">[-62.685057,-22.249029]</span>,<span class="hljs-selector-attr">[-62.846468,-22.034985]</span>]]}},
{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Feature</span>","<span class="hljs-selector-tag">id</span>":"<span class="hljs-selector-tag">BRA</span>","<span class="hljs-selector-tag">properties</span>":{"<span class="hljs-selector-tag">name</span>":"<span class="hljs-selector-tag">Brazil</span>"},"<span class="hljs-selector-tag">geometry</span>":{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Polygon</span>","<span class="hljs-selector-tag">coordinates</span>":<span class="hljs-selector-attr">[[[-57.625133,-30.216295]</span>,<span class="hljs-selector-attr">[-56.2909,-28.852761]</span>,<span class="hljs-selector-attr">[-55.162286,-27.881915]</span>,<span class="hljs-selector-attr">[-54.490725,-27.474757]</span>,<span class="hljs-selector-attr">[-53.648735,-26.923473]</span>,<span class="hljs-selector-attr">[-53.628349,-26.124865]</span>,<span class="hljs-selector-attr">[-54.13005,-25.547639]</span>,<span class="hljs-selector-attr">[-54.625291,-25.739255]</span>,<span class="hljs-selector-attr">[-54.428946,-25.162185]</span>,<span class="hljs-selector-attr">[-54.293476,-24.5708]</span>,<span class="hljs-selector-attr">[-54.29296,-24.021014]</span>,<span class="hljs-selector-attr">[-54.652834,-23.839578]</span>,<span class="hljs-selector-attr">[-55.027902,-24.001274]</span>,<span class="hljs-selector-attr">[-55.400747,-23.956935]</span>,<span class="hljs-selector-attr">[-55.517639,-23.571998]</span>,<span class="hljs-selector-attr">[-55.610683,-22.655619]</span>,<span class="hljs-selector-attr">[-55.797958,-22.35693]</span>,<span class="hljs-selector-attr">[-56.473317,-22.0863]</span>,<span class="hljs-selector-attr">[-56.88151,-22.282154]</span>,<span class="hljs-selector-attr">[-57.937156,-22.090176]</span>,<span class="hljs-selector-attr">[-57.870674,-20.732688]</span>,<span class="hljs-selector-attr">[-58.166392,-20.176701]</span>,<span class="hljs-selector-attr">[-57.853802,-19.969995]</span>,<span class="hljs-selector-attr">[-57.949997,-19.400004]</span>,<span class="hljs-selector-attr">[-57.676009,-18.96184]</span>,<span class="hljs-selector-attr">[-57.498371,-18.174188]</span>,<span class="hljs-selector-attr">[-57.734558,-17.552468]</span>,<span class="hljs-selector-attr">[-58.280804,-17.27171]</span>,<span class="hljs-selector-attr">[-58.388058,-16.877109]</span>,<span class="hljs-selector-attr">[-58.24122,-16.299573]</span>,<span class="hljs-selector-attr">[-60.15839,-16.258284]</span>,<span class="hljs-selector-attr">[-60.542966,-15.09391]</span>,<span class="hljs-selector-attr">[-60.251149,-15.077219]</span>,<span class="hljs-selector-attr">[-60.264326,-14.645979]</span>,<span class="hljs-selector-attr">[-60.459198,-14.354007]</span>,<span class="hljs-selector-attr">[-60.503304,-13.775955]</span>,<span class="hljs-selector-attr">[-61.084121,-13.479384]</span>,<span class="hljs-selector-attr">[-61.713204,-13.489202]</span>,<span class="hljs-selector-attr">[-62.127081,-13.198781]</span>,<span class="hljs-selector-attr">[-62.80306,-13.000653]</span>,<span class="hljs-selector-attr">[-63.196499,-12.627033]</span>,<span class="hljs-selector-attr">[-64.316353,-12.461978]</span>,<span class="hljs-selector-attr">[-65.402281,-11.56627]</span>,<span class="hljs-selector-attr">[-65.321899,-10.895872]</span>,<span class="hljs-selector-attr">[-65.444837,-10.511451]</span>,<span class="hljs-selector-attr">[-65.338435,-9.761988]</span>,<span class="hljs-selector-attr">[-66.646908,-9.931331]</span>,<span class="hljs-selector-attr">[-67.173801,-10.306812]</span>,<span class="hljs-selector-attr">[-68.048192,-10.712059]</span>,<span class="hljs-selector-attr">[-68.271254,-11.014521]</span>,<span class="hljs-selector-attr">[-68.786158,-11.03638]</span>,<span class="hljs-selector-attr">[-69.529678,-10.951734]</span>,<span class="hljs-selector-attr">[-70.093752,-11.123972]</span>,<span class="hljs-selector-attr">[-70.548686,-11.009147]</span>,<span class="hljs-selector-attr">[-70.481894,-9.490118]</span>,<span class="hljs-selector-attr">[-71.302412,-10.079436]</span>,<span class="hljs-selector-attr">[-72.184891,-10.053598]</span>,<span class="hljs-selector-attr">[-72.563033,-9.520194]</span>,<span class="hljs-selector-attr">[-73.226713,-9.462213]</span>,<span class="hljs-selector-attr">[-73.015383,-9.032833]</span>,<span class="hljs-selector-attr">[-73.571059,-8.424447]</span>,<span class="hljs-selector-attr">[-73.987235,-7.52383]</span>,<span class="hljs-selector-attr">[-73.723401,-7.340999]</span>,<span class="hljs-selector-attr">[-73.724487,-6.918595]</span>,<span class="hljs-selector-attr">[-73.120027,-6.629931]</span>,<span class="hljs-selector-attr">[-73.219711,-6.089189]</span>,<span class="hljs-selector-attr">[-72.964507,-5.741251]</span>,<span class="hljs-selector-attr">[-72.891928,-5.274561]</span>,<span class="hljs-selector-attr">[-71.748406,-4.593983]</span>,<span class="hljs-selector-attr">[-70.928843,-4.401591]</span>,<span class="hljs-selector-attr">[-70.794769,-4.251265]</span>,<span class="hljs-selector-attr">[-69.893635,-4.298187]</span>,<span class="hljs-selector-attr">[-69.444102,-1.556287]</span>,<span class="hljs-selector-attr">[-69.420486,-1.122619]</span>,<span class="hljs-selector-attr">[-69.577065,-0.549992]</span>,<span class="hljs-selector-attr">[-70.020656,-0.185156]</span>,<span class="hljs-selector-attr">[-70.015566,0.541414]</span>,<span class="hljs-selector-attr">[-69.452396,0.706159]</span>,<span class="hljs-selector-attr">[-69.252434,0.602651]</span>,<span class="hljs-selector-attr">[-69.218638,0.985677]</span>,<span class="hljs-selector-attr">[-69.804597,1.089081]</span>,<span class="hljs-selector-attr">[-69.816973,1.714805]</span>,<span class="hljs-selector-attr">[-67.868565,1.692455]</span>,<span class="hljs-selector-attr">[-67.53781,2.037163]</span>,<span class="hljs-selector-attr">[-67.259998,1.719999]</span>,<span class="hljs-selector-attr">[-67.065048,1.130112]</span>,<span class="hljs-selector-attr">[-66.876326,1.253361]</span>,<span class="hljs-selector-attr">[-66.325765,0.724452]</span>,<span class="hljs-selector-attr">[-65.548267,0.789254]</span>,<span class="hljs-selector-attr">[-65.354713,1.095282]</span>,<span class="hljs-selector-attr">[-64.611012,1.328731]</span>,<span class="hljs-selector-attr">[-64.199306,1.492855]</span>,<span class="hljs-selector-attr">[-64.083085,1.916369]</span>,<span class="hljs-selector-attr">[-63.368788,2.2009]</span>,<span class="hljs-selector-attr">[-63.422867,2.411068]</span>,<span class="hljs-selector-attr">[-64.269999,2.497006]</span>,<span class="hljs-selector-attr">[-64.408828,3.126786]</span>,<span class="hljs-selector-attr">[-64.368494,3.79721]</span>,<span class="hljs-selector-attr">[-64.816064,4.056445]</span>,<span class="hljs-selector-attr">[-64.628659,4.148481]</span>,<span class="hljs-selector-attr">[-63.888343,4.02053]</span>,<span class="hljs-selector-attr">[-63.093198,3.770571]</span>,<span class="hljs-selector-attr">[-62.804533,4.006965]</span>,<span class="hljs-selector-attr">[-62.08543,4.162124]</span>,<span class="hljs-selector-attr">[-60.966893,4.536468]</span>,<span class="hljs-selector-attr">[-60.601179,4.918098]</span>,<span class="hljs-selector-attr">[-60.733574,5.200277]</span>,<span class="hljs-selector-attr">[-60.213683,5.244486]</span>,<span class="hljs-selector-attr">[-59.980959,5.014061]</span>,<span class="hljs-selector-attr">[-60.111002,4.574967]</span>,<span class="hljs-selector-attr">[-59.767406,4.423503]</span>,<span class="hljs-selector-attr">[-59.53804,3.958803]</span>,<span class="hljs-selector-attr">[-59.815413,3.606499]</span>,<span class="hljs-selector-attr">[-59.974525,2.755233]</span>,<span class="hljs-selector-attr">[-59.718546,2.24963]</span>,<span class="hljs-selector-attr">[-59.646044,1.786894]</span>,<span class="hljs-selector-attr">[-59.030862,1.317698]</span>,<span class="hljs-selector-attr">[-58.540013,1.268088]</span>,<span class="hljs-selector-attr">[-58.429477,1.463942]</span>,<span class="hljs-selector-attr">[-58.11345,1.507195]</span>,<span class="hljs-selector-attr">[-57.660971,1.682585]</span>,<span class="hljs-selector-attr">[-57.335823,1.948538]</span>,<span class="hljs-selector-attr">[-56.782704,1.863711]</span>,<span class="hljs-selector-attr">[-56.539386,1.899523]</span>,<span class="hljs-selector-attr">[-55.995698,1.817667]</span>,<span class="hljs-selector-attr">[-55.9056,2.021996]</span>,<span class="hljs-selector-attr">[-56.073342,2.220795]</span>,<span class="hljs-selector-attr">[-55.973322,2.510364]</span>,<span class="hljs-selector-attr">[-55.569755,2.421506]</span>,<span class="hljs-selector-attr">[-55.097587,2.523748]</span>,<span class="hljs-selector-attr">[-54.524754,2.311849]</span>,<span class="hljs-selector-attr">[-54.088063,2.105557]</span>,<span class="hljs-selector-attr">[-53.778521,2.376703]</span>,<span class="hljs-selector-attr">[-53.554839,2.334897]</span>,<span class="hljs-selector-attr">[-53.418465,2.053389]</span>,<span class="hljs-selector-attr">[-52.939657,2.124858]</span>,<span class="hljs-selector-attr">[-52.556425,2.504705]</span>,<span class="hljs-selector-attr">[-52.249338,3.241094]</span>,<span class="hljs-selector-attr">[-51.657797,4.156232]</span>,<span class="hljs-selector-attr">[-51.317146,4.203491]</span>,<span class="hljs-selector-attr">[-51.069771,3.650398]</span>,<span class="hljs-selector-attr">[-50.508875,1.901564]</span>,<span class="hljs-selector-attr">[-49.974076,1.736483]</span>,<span class="hljs-selector-attr">[-49.947101,1.04619]</span>,<span class="hljs-selector-attr">[-50.699251,0.222984]</span>,<span class="hljs-selector-attr">[-50.388211,-0.078445]</span>,<span class="hljs-selector-attr">[-48.620567,-0.235489]</span>,<span class="hljs-selector-attr">[-48.584497,-1.237805]</span>,<span class="hljs-selector-attr">[-47.824956,-0.581618]</span>,<span class="hljs-selector-attr">[-46.566584,-0.941028]</span>,<span class="hljs-selector-attr">[-44.905703,-1.55174]</span>,<span class="hljs-selector-attr">[-44.417619,-2.13775]</span>,<span class="hljs-selector-attr">[-44.581589,-2.691308]</span>,<span class="hljs-selector-attr">[-43.418791,-2.38311]</span>,<span class="hljs-selector-attr">[-41.472657,-2.912018]</span>,<span class="hljs-selector-attr">[-39.978665,-2.873054]</span>,<span class="hljs-selector-attr">[-38.500383,-3.700652]</span>,<span class="hljs-selector-attr">[-37.223252,-4.820946]</span>,<span class="hljs-selector-attr">[-36.452937,-5.109404]</span>,<span class="hljs-selector-attr">[-35.597796,-5.149504]</span>,<span class="hljs-selector-attr">[-35.235389,-5.464937]</span>,<span class="hljs-selector-attr">[-34.89603,-6.738193]</span>,<span class="hljs-selector-attr">[-34.729993,-7.343221]</span>,<span class="hljs-selector-attr">[-35.128212,-8.996401]</span>,<span class="hljs-selector-attr">[-35.636967,-9.649282]</span>,<span class="hljs-selector-attr">[-37.046519,-11.040721]</span>,<span class="hljs-selector-attr">[-37.683612,-12.171195]</span>,<span class="hljs-selector-attr">[-38.423877,-13.038119]</span>,<span class="hljs-selector-attr">[-38.673887,-13.057652]</span>,<span class="hljs-selector-attr">[-38.953276,-13.79337]</span>,<span class="hljs-selector-attr">[-38.882298,-15.667054]</span>,<span class="hljs-selector-attr">[-39.161092,-17.208407]</span>,<span class="hljs-selector-attr">[-39.267339,-17.867746]</span>,<span class="hljs-selector-attr">[-39.583521,-18.262296]</span>,<span class="hljs-selector-attr">[-39.760823,-19.599113]</span>,<span class="hljs-selector-attr">[-40.774741,-20.904512]</span>,<span class="hljs-selector-attr">[-40.944756,-21.937317]</span>,<span class="hljs-selector-attr">[-41.754164,-22.370676]</span>,<span class="hljs-selector-attr">[-41.988284,-22.97007]</span>,<span class="hljs-selector-attr">[-43.074704,-22.967693]</span>,<span class="hljs-selector-attr">[-44.647812,-23.351959]</span>,<span class="hljs-selector-attr">[-45.352136,-23.796842]</span>,<span class="hljs-selector-attr">[-46.472093,-24.088969]</span>,<span class="hljs-selector-attr">[-47.648972,-24.885199]</span>,<span class="hljs-selector-attr">[-48.495458,-25.877025]</span>,<span class="hljs-selector-attr">[-48.641005,-26.623698]</span>,<span class="hljs-selector-attr">[-48.474736,-27.175912]</span>,<span class="hljs-selector-attr">[-48.66152,-28.186135]</span>,<span class="hljs-selector-attr">[-48.888457,-28.674115]</span>,<span class="hljs-selector-attr">[-49.587329,-29.224469]</span>,<span class="hljs-selector-attr">[-50.696874,-30.984465]</span>,<span class="hljs-selector-attr">[-51.576226,-31.777698]</span>,<span class="hljs-selector-attr">[-52.256081,-32.24537]</span>,<span class="hljs-selector-attr">[-52.7121,-33.196578]</span>,<span class="hljs-selector-attr">[-53.373662,-33.768378]</span>,<span class="hljs-selector-attr">[-53.650544,-33.202004]</span>,<span class="hljs-selector-attr">[-53.209589,-32.727666]</span>,<span class="hljs-selector-attr">[-53.787952,-32.047243]</span>,<span class="hljs-selector-attr">[-54.572452,-31.494511]</span>,<span class="hljs-selector-attr">[-55.60151,-30.853879]</span>,<span class="hljs-selector-attr">[-55.973245,-30.883076]</span>,<span class="hljs-selector-attr">[-56.976026,-30.109686]</span>,<span class="hljs-selector-attr">[-57.625133,-30.216295]</span>]]}},
{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Feature</span>","<span class="hljs-selector-tag">id</span>":"<span class="hljs-selector-tag">BRN</span>","<span class="hljs-selector-tag">properties</span>":{"<span class="hljs-selector-tag">name</span>":"<span class="hljs-selector-tag">Brunei</span>"},"<span class="hljs-selector-tag">geometry</span>":{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Polygon</span>","<span class="hljs-selector-tag">coordinates</span>":<span class="hljs-selector-attr">[[[114.204017,4.525874]</span>,<span class="hljs-selector-attr">[114.599961,4.900011]</span>,<span class="hljs-selector-attr">[115.45071,5.44773]</span>,<span class="hljs-selector-attr">[115.4057,4.955228]</span>,<span class="hljs-selector-attr">[115.347461,4.316636]</span>,<span class="hljs-selector-attr">[114.869557,4.348314]</span>,<span class="hljs-selector-attr">[114.659596,4.007637]</span>,<span class="hljs-selector-attr">[114.204017,4.525874]</span>]]}},
{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Feature</span>","<span class="hljs-selector-tag">id</span>":"<span class="hljs-selector-tag">BTN</span>","<span class="hljs-selector-tag">properties</span>":{"<span class="hljs-selector-tag">name</span>":"<span class="hljs-selector-tag">Bhutan</span>"},"<span class="hljs-selector-tag">geometry</span>":{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Polygon</span>","<span class="hljs-selector-tag">coordinates</span>":<span class="hljs-selector-attr">[[[91.696657,27.771742]</span>,<span class="hljs-selector-attr">[92.103712,27.452614]</span>,<span class="hljs-selector-attr">[92.033484,26.83831]</span>,<span class="hljs-selector-attr">[91.217513,26.808648]</span>,<span class="hljs-selector-attr">[90.373275,26.875724]</span>,<span class="hljs-selector-attr">[89.744528,26.719403]</span>,<span class="hljs-selector-attr">[88.835643,27.098966]</span>,<span class="hljs-selector-attr">[88.814248,27.299316]</span>,<span class="hljs-selector-attr">[89.47581,28.042759]</span>,<span class="hljs-selector-attr">[90.015829,28.296439]</span>,<span class="hljs-selector-attr">[90.730514,28.064954]</span>,<span class="hljs-selector-attr">[91.258854,28.040614]</span>,<span class="hljs-selector-attr">[91.696657,27.771742]</span>]]}},
{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Feature</span>","<span class="hljs-selector-tag">id</span>":"<span class="hljs-selector-tag">BWA</span>","<span class="hljs-selector-tag">properties</span>":{"<span class="hljs-selector-tag">name</span>":"<span class="hljs-selector-tag">Botswana</span>"},"<span class="hljs-selector-tag">geometry</span>":{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Polygon</span>","<span class="hljs-selector-tag">coordinates</span>":<span class="hljs-selector-attr">[[[25.649163,-18.536026]</span>,<span class="hljs-selector-attr">[25.850391,-18.714413]</span>,<span class="hljs-selector-attr">[26.164791,-19.293086]</span>,<span class="hljs-selector-attr">[27.296505,-20.39152]</span>,<span class="hljs-selector-attr">[27.724747,-20.499059]</span>,<span class="hljs-selector-attr">[27.727228,-20.851802]</span>,<span class="hljs-selector-attr">[28.02137,-21.485975]</span>,<span class="hljs-selector-attr">[28.794656,-21.639454]</span>,<span class="hljs-selector-attr">[29.432188,-22.091313]</span>,<span class="hljs-selector-attr">[28.017236,-22.827754]</span>,<span class="hljs-selector-attr">[27.11941,-23.574323]</span>,<span class="hljs-selector-attr">[26.786407,-24.240691]</span>,<span class="hljs-selector-attr">[26.485753,-24.616327]</span>,<span class="hljs-selector-attr">[25.941652,-24.696373]</span>,<span class="hljs-selector-attr">[25.765849,-25.174845]</span>,<span class="hljs-selector-attr">[25.664666,-25.486816]</span>,<span class="hljs-selector-attr">[25.025171,-25.71967]</span>,<span class="hljs-selector-attr">[24.211267,-25.670216]</span>,<span class="hljs-selector-attr">[23.73357,-25.390129]</span>,<span class="hljs-selector-attr">[23.312097,-25.26869]</span>,<span class="hljs-selector-attr">[22.824271,-25.500459]</span>,<span class="hljs-selector-attr">[22.579532,-25.979448]</span>,<span class="hljs-selector-attr">[22.105969,-26.280256]</span>,<span class="hljs-selector-attr">[21.605896,-26.726534]</span>,<span class="hljs-selector-attr">[20.889609,-26.828543]</span>,<span class="hljs-selector-attr">[20.66647,-26.477453]</span>,<span class="hljs-selector-attr">[20.758609,-25.868136]</span>,<span class="hljs-selector-attr">[20.165726,-24.917962]</span>,<span class="hljs-selector-attr">[19.895768,-24.76779]</span>,<span class="hljs-selector-attr">[19.895458,-21.849157]</span>,<span class="hljs-selector-attr">[20.881134,-21.814327]</span>,<span class="hljs-selector-attr">[20.910641,-18.252219]</span>,<span class="hljs-selector-attr">[21.65504,-18.219146]</span>,<span class="hljs-selector-attr">[23.196858,-17.869038]</span>,<span class="hljs-selector-attr">[23.579006,-18.281261]</span>,<span class="hljs-selector-attr">[24.217365,-17.889347]</span>,<span class="hljs-selector-attr">[24.520705,-17.887125]</span>,<span class="hljs-selector-attr">[25.084443,-17.661816]</span>,<span class="hljs-selector-attr">[25.264226,-17.73654]</span>,<span class="hljs-selector-attr">[25.649163,-18.536026]</span>]]}},
{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Feature</span>","<span class="hljs-selector-tag">id</span>":"<span class="hljs-selector-tag">CAF</span>","<span class="hljs-selector-tag">properties</span>":{"<span class="hljs-selector-tag">name</span>":"<span class="hljs-selector-tag">Central</span> <span class="hljs-selector-tag">African</span> <span class="hljs-selector-tag">Republic</span>"},"<span class="hljs-selector-tag">geometry</span>":{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Polygon</span>","<span class="hljs-selector-tag">coordinates</span>":<span class="hljs-selector-attr">[[[15.27946,7.421925]</span>,<span class="hljs-selector-attr">[16.106232,7.497088]</span>,<span class="hljs-selector-attr">[16.290562,7.754307]</span>,<span class="hljs-selector-attr">[16.456185,7.734774]</span>,<span class="hljs-selector-attr">[16.705988,7.508328]</span>,<span class="hljs-selector-attr">[17.96493,7.890914]</span>,<span class="hljs-selector-attr">[18.389555,8.281304]</span>,<span class="hljs-selector-attr">[18.911022,8.630895]</span>,<span class="hljs-selector-attr">[18.81201,8.982915]</span>,<span class="hljs-selector-attr">[19.094008,9.074847]</span>,<span class="hljs-selector-attr">[20.059685,9.012706]</span>,<span class="hljs-selector-attr">[21.000868,9.475985]</span>,<span class="hljs-selector-attr">[21.723822,10.567056]</span>,<span class="hljs-selector-attr">[22.231129,10.971889]</span>,<span class="hljs-selector-attr">[22.864165,11.142395]</span>,<span class="hljs-selector-attr">[22.977544,10.714463]</span>,<span class="hljs-selector-attr">[23.554304,10.089255]</span>,<span class="hljs-selector-attr">[23.55725,9.681218]</span>,<span class="hljs-selector-attr">[23.394779,9.265068]</span>,<span class="hljs-selector-attr">[23.459013,8.954286]</span>,<span class="hljs-selector-attr">[23.805813,8.666319]</span>,<span class="hljs-selector-attr">[24.567369,8.229188]</span>,<span class="hljs-selector-attr">[25.114932,7.825104]</span>,<span class="hljs-selector-attr">[25.124131,7.500085]</span>,<span class="hljs-selector-attr">[25.796648,6.979316]</span>,<span class="hljs-selector-attr">[26.213418,6.546603]</span>,<span class="hljs-selector-attr">[26.465909,5.946717]</span>,<span class="hljs-selector-attr">[27.213409,5.550953]</span>,<span class="hljs-selector-attr">[27.374226,5.233944]</span>,<span class="hljs-selector-attr">[27.044065,5.127853]</span>,<span class="hljs-selector-attr">[26.402761,5.150875]</span>,<span class="hljs-selector-attr">[25.650455,5.256088]</span>,<span class="hljs-selector-attr">[25.278798,5.170408]</span>,<span class="hljs-selector-attr">[25.128833,4.927245]</span>,<span class="hljs-selector-attr">[24.805029,4.897247]</span>,<span class="hljs-selector-attr">[24.410531,5.108784]</span>,<span class="hljs-selector-attr">[23.297214,4.609693]</span>,<span class="hljs-selector-attr">[22.84148,4.710126]</span>,<span class="hljs-selector-attr">[22.704124,4.633051]</span>,<span class="hljs-selector-attr">[22.405124,4.02916]</span>,<span class="hljs-selector-attr">[21.659123,4.224342]</span>,<span class="hljs-selector-attr">[20.927591,4.322786]</span>,<span class="hljs-selector-attr">[20.290679,4.691678]</span>,<span class="hljs-selector-attr">[19.467784,5.031528]</span>,<span class="hljs-selector-attr">[18.932312,4.709506]</span>,<span class="hljs-selector-attr">[18.542982,4.201785]</span>,<span class="hljs-selector-attr">[18.453065,3.504386]</span>,<span class="hljs-selector-attr">[17.8099,3.560196]</span>,<span class="hljs-selector-attr">[17.133042,3.728197]</span>,<span class="hljs-selector-attr">[16.537058,3.198255]</span>,<span class="hljs-selector-attr">[16.012852,2.26764]</span>,<span class="hljs-selector-attr">[15.907381,2.557389]</span>,<span class="hljs-selector-attr">[15.862732,3.013537]</span>,<span class="hljs-selector-attr">[15.405396,3.335301]</span>,<span class="hljs-selector-attr">[15.03622,3.851367]</span>,<span class="hljs-selector-attr">[14.950953,4.210389]</span>,<span class="hljs-selector-attr">[14.478372,4.732605]</span>,<span class="hljs-selector-attr">[14.558936,5.030598]</span>,<span class="hljs-selector-attr">[14.459407,5.451761]</span>,<span class="hljs-selector-attr">[14.53656,6.226959]</span>,<span class="hljs-selector-attr">[14.776545,6.408498]</span>,<span class="hljs-selector-attr">[15.27946,7.421925]</span>]]}},
{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Feature</span>","<span class="hljs-selector-tag">id</span>":"<span class="hljs-selector-tag">CAN</span>","<span class="hljs-selector-tag">properties</span>":{"<span class="hljs-selector-tag">name</span>":"<span class="hljs-selector-tag">Canada</span>"},"<span class="hljs-selector-tag">geometry</span>":{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">MultiPolygon</span>","<span class="hljs-selector-tag">coordinates</span>":<span class="hljs-selector-attr">[[[[-63.6645,46.55001]</span>,<span class="hljs-selector-attr">[-62.9393,46.41587]</span>,<span class="hljs-selector-attr">[-62.01208,46.44314]</span>,<span class="hljs-selector-attr">[-62.50391,46.03339]</span>,<span class="hljs-selector-attr">[-62.87433,45.96818]</span>,<span class="hljs-selector-attr">[-64.1428,46.39265]</span>,<span class="hljs-selector-attr">[-64.39261,46.72747]</span>,<span class="hljs-selector-attr">[-64.01486,47.03601]</span>,<span class="hljs-selector-attr">[-63.6645,46.55001]</span>]],<span class="hljs-selector-attr">[[[-61.806305,49.10506]</span>,<span class="hljs-selector-attr">[-62.29318,49.08717]</span>,<span class="hljs-selector-attr">[-63.58926,49.40069]</span>,<span class="hljs-selector-attr">[-64.51912,49.87304]</span>,<span class="hljs-selector-attr">[-64.17322,49.95718]</span>,<span class="hljs-selector-attr">[-62.85829,49.70641]</span>,<span class="hljs-selector-attr">[-61.835585,49.28855]</span>,<span class="hljs-selector-attr">[-61.806305,49.10506]</span>]],<span class="hljs-selector-attr">[[[-123.510002,48.510011]</span>,<span class="hljs-selector-attr">[-124.012891,48.370846]</span>,<span class="hljs-selector-attr">[-125.655013,48.825005]</span>,<span class="hljs-selector-attr">[-125.954994,49.179996]</span>,<span class="hljs-selector-attr">[-126.850004,49.53]</span>,<span class="hljs-selector-attr">[-127.029993,49.814996]</span>,<span class="hljs-selector-attr">[-128.059336,49.994959]</span>,<span class="hljs-selector-attr">[-128.444584,50.539138]</span>,<span class="hljs-selector-attr">[-128.358414,50.770648]</span>,<span class="hljs-selector-attr">[-127.308581,50.552574]</span>,<span class="hljs-selector-attr">[-126.695001,50.400903]</span>,<span class="hljs-selector-attr">[-125.755007,50.295018]</span>,<span class="hljs-selector-attr">[-125.415002,49.950001]</span>,<span class="hljs-selector-attr">[-124.920768,49.475275]</span>,<span class="hljs-selector-attr">[-123.922509,49.062484]</span>,<span class="hljs-selector-attr">[-123.510002,48.510011]</span>]],<span class="hljs-selector-attr">[[[-56.134036,50.68701]</span>,<span class="hljs-selector-attr">[-56.795882,49.812309]</span>,<span class="hljs-selector-attr">[-56.143105,50.150117]</span>,<span class="hljs-selector-attr">[-55.471492,49.935815]</span>,<span class="hljs-selector-attr">[-55.822401,49.587129]</span>,<span class="hljs-selector-attr">[-54.935143,49.313011]</span>,<span class="hljs-selector-attr">[-54.473775,49.556691]</span>,<span class="hljs-selector-attr">[-53.476549,49.249139]</span>,<span class="hljs-selector-attr">[-53.786014,48.516781]</span>,<span class="hljs-selector-attr">[-53.086134,48.687804]</span>,<span class="hljs-selector-attr">[-52.958648,48.157164]</span>,<span class="hljs-selector-attr">[-52.648099,47.535548]</span>,<span class="hljs-selector-attr">[-53.069158,46.655499]</span>,<span class="hljs-selector-attr">[-53.521456,46.618292]</span>,<span class="hljs-selector-attr">[-54.178936,46.807066]</span>,<span class="hljs-selector-attr">[-53.961869,47.625207]</span>,<span class="hljs-selector-attr">[-54.240482,47.752279]</span>,<span class="hljs-selector-attr">[-55.400773,46.884994]</span>,<span class="hljs-selector-attr">[-55.997481,46.91972]</span>,<span class="hljs-selector-attr">[-55.291219,47.389562]</span>,<span class="hljs-selector-attr">[-56.250799,47.632545]</span>,<span class="hljs-selector-attr">[-57.325229,47.572807]</span>,<span class="hljs-selector-attr">[-59.266015,47.603348]</span>,<span class="hljs-selector-attr">[-59.419494,47.899454]</span>,<span class="hljs-selector-attr">[-58.796586,48.251525]</span>,<span class="hljs-selector-attr">[-59.231625,48.523188]</span>,<span class="hljs-selector-attr">[-58.391805,49.125581]</span>,<span class="hljs-selector-attr">[-57.35869,50.718274]</span>,<span class="hljs-selector-attr">[-56.73865,51.287438]</span>,<span class="hljs-selector-attr">[-55.870977,51.632094]</span>,<span class="hljs-selector-attr">[-55.406974,51.588273]</span>,<span class="hljs-selector-attr">[-55.600218,51.317075]</span>,<span class="hljs-selector-attr">[-56.134036,50.68701]</span>]],<span class="hljs-selector-attr">[[[-132.710008,54.040009]</span>,<span class="hljs-selector-attr">[-132.710009,54.040009]</span>,<span class="hljs-selector-attr">[-132.710008,54.040009]</span>,<span class="hljs-selector-attr">[-132.710008,54.040009]</span>,<span class="hljs-selector-attr">[-131.74999,54.120004]</span>,<span class="hljs-selector-attr">[-132.04948,52.984621]</span>,<span class="hljs-selector-attr">[-131.179043,52.180433]</span>,<span class="hljs-selector-attr">[-131.57783,52.182371]</span>,<span class="hljs-selector-attr">[-132.180428,52.639707]</span>,<span class="hljs-selector-attr">[-132.549992,53.100015]</span>,<span class="hljs-selector-attr">[-133.054611,53.411469]</span>,<span class="hljs-selector-attr">[-133.239664,53.85108]</span>,<span class="hljs-selector-attr">[-133.180004,54.169975]</span>,<span class="hljs-selector-attr">[-132.710008,54.040009]</span>]],<span class="hljs-selector-attr">[[[-79.26582,62.158675]</span>,<span class="hljs-selector-attr">[-79.65752,61.63308]</span>,<span class="hljs-selector-attr">[-80.09956,61.7181]</span>,<span class="hljs-selector-attr">[-80.36215,62.01649]</span>,<span class="hljs-selector-attr">[-80.315395,62.085565]</span>,<span class="hljs-selector-attr">[-79.92939,62.3856]</span>,<span class="hljs-selector-attr">[-79.52002,62.36371]</span>,<span class="hljs-selector-attr">[-79.26582,62.158675]</span>]],<span class="hljs-selector-attr">[[[-81.89825,62.7108]</span>,<span class="hljs-selector-attr">[-83.06857,62.15922]</span>,<span class="hljs-selector-attr">[-83.77462,62.18231]</span>,<span class="hljs-selector-attr">[-83.99367,62.4528]</span>,<span class="hljs-selector-attr">[-83.25048,62.91409]</span>,<span class="hljs-selector-attr">[-81.87699,62.90458]</span>,<span class="hljs-selector-attr">[-81.89825,62.7108]</span>]],<span class="hljs-selector-attr">[[[-85.161308,65.657285]</span>,<span class="hljs-selector-attr">[-84.975764,65.217518]</span>,<span class="hljs-selector-attr">[-84.464012,65.371772]</span>,<span class="hljs-selector-attr">[-83.882626,65.109618]</span>,<span class="hljs-selector-attr">[-82.787577,64.766693]</span>,<span class="hljs-selector-attr">[-81.642014,64.455136]</span>,<span class="hljs-selector-attr">[-81.55344,63.979609]</span>,<span class="hljs-selector-attr">[-80.817361,64.057486]</span>,<span class="hljs-selector-attr">[-80.103451,63.725981]</span>,<span class="hljs-selector-attr">[-80.99102,63.411246]</span>,<span class="hljs-selector-attr">[-82.547178,63.651722]</span>,<span class="hljs-selector-attr">[-83.108798,64.101876]</span>,<span class="hljs-selector-attr">[-84.100417,63.569712]</span>,<span class="hljs-selector-attr">[-85.523405,63.052379]</span>,<span class="hljs-selector-attr">[-85.866769,63.637253]</span>,<span class="hljs-selector-attr">[-87.221983,63.541238]</span>,<span class="hljs-selector-attr">[-86.35276,64.035833]</span>,<span class="hljs-selector-attr">[-86.224886,64.822917]</span>,<span class="hljs-selector-attr">[-85.883848,65.738778]</span>,<span class="hljs-selector-attr">[-85.161308,65.657285]</span>]],<span class="hljs-selector-attr">[[[-75.86588,67.14886]</span>,<span class="hljs-selector-attr">[-76.98687,67.09873]</span>,<span class="hljs-selector-attr">[-77.2364,67.58809]</span>,<span class="hljs-selector-attr">[-76.81166,68.14856]</span>,<span class="hljs-selector-attr">[-75.89521,68.28721]</span>,<span class="hljs-selector-attr">[-75.1145,68.01036]</span>,<span class="hljs-selector-attr">[-75.10333,67.58202]</span>,<span class="hljs-selector-attr">[-75.21597,67.44425]</span>,<span class="hljs-selector-attr">[-75.86588,67.14886]</span>]],<span class="hljs-selector-attr">[[[-95.647681,69.10769]</span>,<span class="hljs-selector-attr">[-96.269521,68.75704]</span>,<span class="hljs-selector-attr">[-97.617401,69.06003]</span>,<span class="hljs-selector-attr">[-98.431801,68.9507]</span>,<span class="hljs-selector-attr">[-99.797401,69.40003]</span>,<span class="hljs-selector-attr">[-98.917401,69.71003]</span>,<span class="hljs-selector-attr">[-98.218261,70.14354]</span>,<span class="hljs-selector-attr">[-97.157401,69.86003]</span>,<span class="hljs-selector-attr">[-96.557401,69.68003]</span>,<span class="hljs-selector-attr">[-96.257401,69.49003]</span>,<span class="hljs-selector-attr">[-95.647681,69.10769]</span>]],<span class="hljs-selector-attr">[[[-90.5471,69.49766]</span>,<span class="hljs-selector-attr">[-90.55151,68.47499]</span>,<span class="hljs-selector-attr">[-89.21515,69.25873]</span>,<span class="hljs-selector-attr">[-88.01966,68.61508]</span>,<span class="hljs-selector-attr">[-88.31749,67.87338]</span>,<span class="hljs-selector-attr">[-87.35017,67.19872]</span>,<span class="hljs-selector-attr">[-86.30607,67.92146]</span>,<span class="hljs-selector-attr">[-85.57664,68.78456]</span>,<span class="hljs-selector-attr">[-85.52197,69.88211]</span>,<span class="hljs-selector-attr">[-84.10081,69.80539]</span>,<span class="hljs-selector-attr">[-82.62258,69.65826]</span>,<span class="hljs-selector-attr">[-81.28043,69.16202]</span>,<span class="hljs-selector-attr">[-81.2202,68.66567]</span>,<span class="hljs-selector-attr">[-81.96436,68.13253]</span>,<span class="hljs-selector-attr">[-81.25928,67.59716]</span>,<span class="hljs-selector-attr">[-81.38653,67.11078]</span>,<span class="hljs-selector-attr">[-83.34456,66.41154]</span>,<span class="hljs-selector-attr">[-84.73542,66.2573]</span>,<span class="hljs-selector-attr">[-85.76943,66.55833]</span>,<span class="hljs-selector-attr">[-86.0676,66.05625]</span>,<span class="hljs-selector-attr">[-87.03143,65.21297]</span>,<span class="hljs-selector-attr">[-87.32324,64.77563]</span>,<span class="hljs-selector-attr">[-88.48296,64.09897]</span>,<span class="hljs-selector-attr">[-89.91444,64.03273]</span>,<span class="hljs-selector-attr">[-90.70398,63.61017]</span>,<span class="hljs-selector-attr">[-90.77004,62.96021]</span>,<span class="hljs-selector-attr">[-91.93342,62.83508]</span>,<span class="hljs-selector-attr">[-93.15698,62.02469]</span>,<span class="hljs-selector-attr">[-94.24153,60.89865]</span>,<span class="hljs-selector-attr">[-94.62931,60.11021]</span>,<span class="hljs-selector-attr">[-94.6846,58.94882]</span>,<span class="hljs-selector-attr">[-93.21502,58.78212]</span>,<span class="hljs-selector-attr">[-92.76462,57.84571]</span>,<span class="hljs-selector-attr">[-92.29703,57.08709]</span>,<span class="hljs-selector-attr">[-90.89769,57.28468]</span>,<span class="hljs-selector-attr">[-89.03953,56.85172]</span>,<span class="hljs-selector-attr">[-88.03978,56.47162]</span>,<span class="hljs-selector-attr">[-87.32421,55.99914]</span>,<span class="hljs-selector-attr">[-86.07121,55.72383]</span>,<span class="hljs-selector-attr">[-85.01181,55.3026]</span>,<span class="hljs-selector-attr">[-83.36055,55.24489]</span>,<span class="hljs-selector-attr">[-82.27285,55.14832]</span>,<span class="hljs-selector-attr">[-82.4362,54.28227]</span>,<span class="hljs-selector-attr">[-82.12502,53.27703]</span>,<span class="hljs-selector-attr">[-81.40075,52.15788]</span>,<span class="hljs-selector-attr">[-79.91289,51.20842]</span>,<span class="hljs-selector-attr">[-79.14301,51.53393]</span>,<span class="hljs-selector-attr">[-78.60191,52.56208]</span>,<span class="hljs-selector-attr">[-79.12421,54.14145]</span>,<span class="hljs-selector-attr">[-79.82958,54.66772]</span>,<span class="hljs-selector-attr">[-78.22874,55.13645]</span>,<span class="hljs-selector-attr">[-77.0956,55.83741]</span>,<span class="hljs-selector-attr">[-76.54137,56.53423]</span>,<span class="hljs-selector-attr">[-76.62319,57.20263]</span>,<span class="hljs-selector-attr">[-77.30226,58.05209]</span>,<span class="hljs-selector-attr">[-78.51688,58.80458]</span>,<span class="hljs-selector-attr">[-77.33676,59.85261]</span>,<span class="hljs-selector-attr">[-77.77272,60.75788]</span>,<span class="hljs-selector-attr">[-78.10687,62.31964]</span>,<span class="hljs-selector-attr">[-77.41067,62.55053]</span>,<span class="hljs-selector-attr">[-75.69621,62.2784]</span>,<span class="hljs-selector-attr">[-74.6682,62.18111]</span>,<span class="hljs-selector-attr">[-73.83988,62.4438]</span>,<span class="hljs-selector-attr">[-72.90853,62.10507]</span>,<span class="hljs-selector-attr">[-71.67708,61.52535]</span>,<span class="hljs-selector-attr">[-71.37369,61.13717]</span>,<span class="hljs-selector-attr">[-69.59042,61.06141]</span>,<span class="hljs-selector-attr">[-69.62033,60.22125]</span>,<span class="hljs-selector-attr">[-69.2879,58.95736]</span>,<span class="hljs-selector-attr">[-68.37455,58.80106]</span>,<span class="hljs-selector-attr">[-67.64976,58.21206]</span>,<span class="hljs-selector-attr">[-66.20178,58.76731]</span>,<span class="hljs-selector-attr">[-65.24517,59.87071]</span>,<span class="hljs-selector-attr">[-64.58352,60.33558]</span>,<span class="hljs-selector-attr">[-63.80475,59.4426]</span>,<span class="hljs-selector-attr">[-62.50236,58.16708]</span>,<span class="hljs-selector-attr">[-61.39655,56.96745]</span>,<span class="hljs-selector-attr">[-61.79866,56.33945]</span>,<span class="hljs-selector-attr">[-60.46853,55.77548]</span>,<span class="hljs-selector-attr">[-59.56962,55.20407]</span>,<span class="hljs-selector-attr">[-57.97508,54.94549]</span>,<span class="hljs-selector-attr">[-57.3332,54.6265]</span>,<span class="hljs-selector-attr">[-56.93689,53.78032]</span>,<span class="hljs-selector-attr">[-56.15811,53.64749]</span>,<span class="hljs-selector-attr">[-55.75632,53.27036]</span>,<span class="hljs-selector-attr">[-55.68338,52.14664]</span>,<span class="hljs-selector-attr">[-56.40916,51.7707]</span>,<span class="hljs-selector-attr">[-57.12691,51.41972]</span>,<span class="hljs-selector-attr">[-58.77482,51.0643]</span>,<span class="hljs-selector-attr">[-60.03309,50.24277]</span>,<span class="hljs-selector-attr">[-61.72366,50.08046]</span>,<span class="hljs-selector-attr">[-63.86251,50.29099]</span>,<span class="hljs-selector-attr">[-65.36331,50.2982]</span>,<span class="hljs-selector-attr">[-66.39905,50.22897]</span>,<span class="hljs-selector-attr">[-67.23631,49.51156]</span>,<span class="hljs-selector-attr">[-68.51114,49.06836]</span>,<span class="hljs-selector-attr">[-69.95362,47.74488]</span>,<span class="hljs-selector-attr">[-71.10458,46.82171]</span>,<span class="hljs-selector-attr">[-70.25522,46.98606]</span>,<span class="hljs-selector-attr">[-68.65,48.3]</span>,<span class="hljs-selector-attr">[-66.55243,49.1331]</span>,<span class="hljs-selector-attr">[-65.05626,49.23278]</span>,<span class="hljs-selector-attr">[-64.17099,48.74248]</span>,<span class="hljs-selector-attr">[-65.11545,48.07085]</span>,<span class="hljs-selector-attr">[-64.79854,46.99297]</span>,<span class="hljs-selector-attr">[-64.47219,46.23849]</span>,<span class="hljs-selector-attr">[-63.17329,45.73902]</span>,<span class="hljs-selector-attr">[-61.52072,45.88377]</span>,<span class="hljs-selector-attr">[-60.51815,47.00793]</span>,<span class="hljs-selector-attr">[-60.4486,46.28264]</span>,<span class="hljs-selector-attr">[-59.80287,45.9204]</span>,<span class="hljs-selector-attr">[-61.03988,45.26525]</span>,<span class="hljs-selector-attr">[-63.25471,44.67014]</span>,<span class="hljs-selector-attr">[-64.24656,44.26553]</span>,<span class="hljs-selector-attr">[-65.36406,43.54523]</span>,<span class="hljs-selector-attr">[-66.1234,43.61867]</span>,<span class="hljs-selector-attr">[-66.16173,44.46512]</span>,<span class="hljs-selector-attr">[-64.42549,45.29204]</span>,<span class="hljs-selector-attr">[-66.02605,45.25931]</span>,<span class="hljs-selector-attr">[-67.13741,45.13753]</span>,<span class="hljs-selector-attr">[-67.79134,45.70281]</span>,<span class="hljs-selector-attr">[-67.79046,47.06636]</span>,<span class="hljs-selector-attr">[-68.23444,47.35486]</span>,<span class="hljs-selector-attr">[-68.905,47.185]</span>,<span class="hljs-selector-attr">[-69.237216,47.447781]</span>,<span class="hljs-selector-attr">[-69.99997,46.69307]</span>,<span class="hljs-selector-attr">[-70.305,45.915]</span>,<span class="hljs-selector-attr">[-70.66,45.46]</span>,<span class="hljs-selector-attr">[-71.08482,45.30524]</span>,<span class="hljs-selector-attr">[-71.405,45.255]</span>,<span class="hljs-selector-attr">[-71.50506,45.0082]</span>,<span class="hljs-selector-attr">[-73.34783,45.00738]</span>,<span class="hljs-selector-attr">[-74.867,45.00048]</span>,<span class="hljs-selector-attr">[-75.31821,44.81645]</span>,<span class="hljs-selector-attr">[-76.375,44.09631]</span>,<span class="hljs-selector-attr">[-76.5,44.018459]</span>,<span class="hljs-selector-attr">[-76.820034,43.628784]</span>,<span class="hljs-selector-attr">[-77.737885,43.629056]</span>,<span class="hljs-selector-attr">[-78.72028,43.625089]</span>,<span class="hljs-selector-attr">[-79.171674,43.466339]</span>,<span class="hljs-selector-attr">[-79.01,43.27]</span>,<span class="hljs-selector-attr">[-78.92,42.965]</span>,<span class="hljs-selector-attr">[-78.939362,42.863611]</span>,<span class="hljs-selector-attr">[-80.247448,42.3662]</span>,<span class="hljs-selector-attr">[-81.277747,42.209026]</span>,<span class="hljs-selector-attr">[-82.439278,41.675105]</span>,<span class="hljs-selector-attr">[-82.690089,41.675105]</span>,<span class="hljs-selector-attr">[-83.02981,41.832796]</span>,<span class="hljs-selector-attr">[-83.142,41.975681]</span>,<span class="hljs-selector-attr">[-83.12,42.08]</span>,<span class="hljs-selector-attr">[-82.9,42.43]</span>,<span class="hljs-selector-attr">[-82.43,42.98]</span>,<span class="hljs-selector-attr">[-82.137642,43.571088]</span>,<span class="hljs-selector-attr">[-82.337763,44.44]</span>,<span class="hljs-selector-attr">[-82.550925,45.347517]</span>,<span class="hljs-selector-attr">[-83.592851,45.816894]</span>,<span class="hljs-selector-attr">[-83.469551,45.994686]</span>,<span class="hljs-selector-attr">[-83.616131,46.116927]</span>,<span class="hljs-selector-attr">[-83.890765,46.116927]</span>,<span class="hljs-selector-attr">[-84.091851,46.275419]</span>,<span class="hljs-selector-attr">[-84.14212,46.512226]</span>,<span class="hljs-selector-attr">[-84.3367,46.40877]</span>,<span class="hljs-selector-attr">[-84.6049,46.4396]</span>,<span class="hljs-selector-attr">[-84.543749,46.538684]</span>,<span class="hljs-selector-attr">[-84.779238,46.637102]</span>,<span class="hljs-selector-attr">[-84.87608,46.900083]</span>,<span class="hljs-selector-attr">[-85.652363,47.220219]</span>,<span class="hljs-selector-attr">[-86.461991,47.553338]</span>,<span class="hljs-selector-attr">[-87.439793,47.94]</span>,<span class="hljs-selector-attr">[-88.378114,48.302918]</span>,<span class="hljs-selector-attr">[-89.272917,48.019808]</span>,<span class="hljs-selector-attr">[-89.6,48.01]</span>,<span class="hljs-selector-attr">[-90.83,48.27]</span>,<span class="hljs-selector-attr">[-91.64,48.14]</span>,<span class="hljs-selector-attr">[-92.61,48.45]</span>,<span class="hljs-selector-attr">[-93.63087,48.60926]</span>,<span class="hljs-selector-attr">[-94.32914,48.67074]</span>,<span class="hljs-selector-attr">[-94.64,48.84]</span>,<span class="hljs-selector-attr">[-94.81758,49.38905]</span>,<span class="hljs-selector-attr">[-95.15609,49.38425]</span>,<span class="hljs-selector-attr">[-95.15907,49]</span>,<span class="hljs-selector-attr">[-97.22872,49.0007]</span>,<span class="hljs-selector-attr">[-100.65,49]</span>,<span class="hljs-selector-attr">[-104.04826,48.99986]</span>,<span class="hljs-selector-attr">[-107.05,49]</span>,<span class="hljs-selector-attr">[-110.05,49]</span>,<span class="hljs-selector-attr">[-113,49]</span>,<span class="hljs-selector-attr">[-116.04818,49]</span>,<span class="hljs-selector-attr">[-117.03121,49]</span>,<span class="hljs-selector-attr">[-120,49]</span>,<span class="hljs-selector-attr">[-122.84,49]</span>,<span class="hljs-selector-attr">[-122.97421,49.002538]</span>,<span class="hljs-selector-attr">[-124.91024,49.98456]</span>,<span class="hljs-selector-attr">[-125.62461,50.41656]</span>,<span class="hljs-selector-attr">[-127.43561,50.83061]</span>,<span class="hljs-selector-attr">[-127.99276,51.71583]</span>,<span class="hljs-selector-attr">[-127.85032,52.32961]</span>,<span class="hljs-selector-attr">[-129.12979,52.75538]</span>,<span class="hljs-selector-attr">[-129.30523,53.56159]</span>,<span class="hljs-selector-attr">[-130.51497,54.28757]</span>,<span class="hljs-selector-attr">[-130.53611,54.80278]</span>,<span class="hljs-selector-attr">[-129.98,55.285]</span>,<span class="hljs-selector-attr">[-130.00778,55.91583]</span>,<span class="hljs-selector-attr">[-131.70781,56.55212]</span>,<span class="hljs-selector-attr">[-132.73042,57.69289]</span>,<span class="hljs-selector-attr">[-133.35556,58.41028]</span>,<span class="hljs-selector-attr">[-134.27111,58.86111]</span>,<span class="hljs-selector-attr">[-134.945,59.27056]</span>,<span class="hljs-selector-attr">[-135.47583,59.78778]</span>,<span class="hljs-selector-attr">[-136.47972,59.46389]</span>,<span class="hljs-selector-attr">[-137.4525,58.905]</span>,<span class="hljs-selector-attr">[-138.34089,59.56211]</span>,<span class="hljs-selector-attr">[-139.039,60]</span>,<span class="hljs-selector-attr">[-140.013,60.27682]</span>,<span class="hljs-selector-attr">[-140.99778,60.30639]</span>,<span class="hljs-selector-attr">[-140.9925,66.00003]</span>,<span class="hljs-selector-attr">[-140.986,69.712]</span>,<span class="hljs-selector-attr">[-139.12052,69.47102]</span>,<span class="hljs-selector-attr">[-137.54636,68.99002]</span>,<span class="hljs-selector-attr">[-136.50358,68.89804]</span>,<span class="hljs-selector-attr">[-135.62576,69.31512]</span>,<span class="hljs-selector-attr">[-134.41464,69.62743]</span>,<span class="hljs-selector-attr">[-132.92925,69.50534]</span>,<span class="hljs-selector-attr">[-131.43136,69.94451]</span>,<span class="hljs-selector-attr">[-129.79471,70.19369]</span>,<span class="hljs-selector-attr">[-129.10773,69.77927]</span>,<span class="hljs-selector-attr">[-128.36156,70.01286]</span>,<span class="hljs-selector-attr">[-128.13817,70.48384]</span>,<span class="hljs-selector-attr">[-127.44712,70.37721]</span>,<span class="hljs-selector-attr">[-125.75632,69.48058]</span>,<span class="hljs-selector-attr">[-124.42483,70.1584]</span>,<span class="hljs-selector-attr">[-124.28968,69.39969]</span>,<span class="hljs-selector-attr">[-123.06108,69.56372]</span>,<span class="hljs-selector-attr">[-122.6835,69.85553]</span>,<span class="hljs-selector-attr">[-121.47226,69.79778]</span>,<span class="hljs-selector-attr">[-119.94288,69.37786]</span>,<span class="hljs-selector-attr">[-117.60268,69.01128]</span>,<span class="hljs-selector-attr">[-116.22643,68.84151]</span>,<span class="hljs-selector-attr">[-115.2469,68.90591]</span>,<span class="hljs-selector-attr">[-113.89794,68.3989]</span>,<span class="hljs-selector-attr">[-115.30489,67.90261]</span>,<span class="hljs-selector-attr">[-113.49727,67.68815]</span>,<span class="hljs-selector-attr">[-110.798,67.80612]</span>,<span class="hljs-selector-attr">[-109.94619,67.98104]</span>,<span class="hljs-selector-attr">[-108.8802,67.38144]</span>,<span class="hljs-selector-attr">[-107.79239,67.88736]</span>,<span class="hljs-selector-attr">[-108.81299,68.31164]</span>,<span class="hljs-selector-attr">[-108.16721,68.65392]</span>,<span class="hljs-selector-attr">[-106.95,68.7]</span>,<span class="hljs-selector-attr">[-106.15,68.8]</span>,<span class="hljs-selector-attr">[-105.34282,68.56122]</span>,<span class="hljs-selector-attr">[-104.33791,68.018]</span>,<span class="hljs-selector-attr">[-103.22115,68.09775]</span>,<span class="hljs-selector-attr">[-101.45433,67.64689]</span>,<span class="hljs-selector-attr">[-99.90195,67.80566]</span>,<span class="hljs-selector-attr">[-98.4432,67.78165]</span>,<span class="hljs-selector-attr">[-98.5586,68.40394]</span>,<span class="hljs-selector-attr">[-97.66948,68.57864]</span>,<span class="hljs-selector-attr">[-96.11991,68.23939]</span>,<span class="hljs-selector-attr">[-96.12588,67.29338]</span>,<span class="hljs-selector-attr">[-95.48943,68.0907]</span>,<span class="hljs-selector-attr">[-94.685,68.06383]</span>,<span class="hljs-selector-attr">[-94.23282,69.06903]</span>,<span class="hljs-selector-attr">[-95.30408,69.68571]</span>,<span class="hljs-selector-attr">[-96.47131,70.08976]</span>,<span class="hljs-selector-attr">[-96.39115,71.19482]</span>,<span class="hljs-selector-attr">[-95.2088,71.92053]</span>,<span class="hljs-selector-attr">[-93.88997,71.76015]</span>,<span class="hljs-selector-attr">[-92.87818,71.31869]</span>,<span class="hljs-selector-attr">[-91.51964,70.19129]</span>,<span class="hljs-selector-attr">[-92.40692,69.69997]</span>,<span class="hljs-selector-attr">[-90.5471,69.49766]</span>]],<span class="hljs-selector-attr">[[[-114.16717,73.12145]</span>,<span class="hljs-selector-attr">[-114.66634,72.65277]</span>,<span class="hljs-selector-attr">[-112.44102,72.9554]</span>,<span class="hljs-selector-attr">[-111.05039,72.4504]</span>,<span class="hljs-selector-attr">[-109.92035,72.96113]</span>,<span class="hljs-selector-attr">[-109.00654,72.63335]</span>,<span class="hljs-selector-attr">[-108.18835,71.65089]</span>,<span class="hljs-selector-attr">[-107.68599,72.06548]</span>,<span class="hljs-selector-attr">[-108.39639,73.08953]</span>,<span class="hljs-selector-attr">[-107.51645,73.23598]</span>,<span class="hljs-selector-attr">[-106.52259,73.07601]</span>,<span class="hljs-selector-attr">[-105.40246,72.67259]</span>,<span class="hljs-selector-attr">[-104.77484,71.6984]</span>,<span class="hljs-selector-attr">[-104.46476,70.99297]</span>,<span class="hljs-selector-attr">[-102.78537,70.49776]</span>,<span class="hljs-selector-attr">[-100.98078,70.02432]</span>,<span class="hljs-selector-attr">[-101.08929,69.58447]</span>,<span class="hljs-selector-attr">[-102.73116,69.50402]</span>,<span class="hljs-selector-attr">[-102.09329,69.11962]</span>,<span class="hljs-selector-attr">[-102.43024,68.75282]</span>,<span class="hljs-selector-attr">[-104.24,68.91]</span>,<span class="hljs-selector-attr">[-105.96,69.18]</span>,<span class="hljs-selector-attr">[-107.12254,69.11922]</span>,<span class="hljs-selector-attr">[-109,68.78]</span>,<span class="hljs-selector-attr">[-111.534149,68.630059]</span>,<span class="hljs-selector-attr">[-113.3132,68.53554]</span>,<span class="hljs-selector-attr">[-113.85496,69.00744]</span>,<span class="hljs-selector-attr">[-115.22,69.28]</span>,<span class="hljs-selector-attr">[-116.10794,69.16821]</span>,<span class="hljs-selector-attr">[-117.34,69.96]</span>,<span class="hljs-selector-attr">[-116.67473,70.06655]</span>,<span class="hljs-selector-attr">[-115.13112,70.2373]</span>,<span class="hljs-selector-attr">[-113.72141,70.19237]</span>,<span class="hljs-selector-attr">[-112.4161,70.36638]</span>,<span class="hljs-selector-attr">[-114.35,70.6]</span>,<span class="hljs-selector-attr">[-116.48684,70.52045]</span>,<span class="hljs-selector-attr">[-117.9048,70.54056]</span>,<span class="hljs-selector-attr">[-118.43238,70.9092]</span>,<span class="hljs-selector-attr">[-116.11311,71.30918]</span>,<span class="hljs-selector-attr">[-117.65568,71.2952]</span>,<span class="hljs-selector-attr">[-119.40199,71.55859]</span>,<span class="hljs-selector-attr">[-118.56267,72.30785]</span>,<span class="hljs-selector-attr">[-117.86642,72.70594]</span>,<span class="hljs-selector-attr">[-115.18909,73.31459]</span>,<span class="hljs-selector-attr">[-114.16717,73.12145]</span>]],<span class="hljs-selector-attr">[[[-104.5,73.42]</span>,<span class="hljs-selector-attr">[-105.38,72.76]</span>,<span class="hljs-selector-attr">[-106.94,73.46]</span>,<span class="hljs-selector-attr">[-106.6,73.6]</span>,<span class="hljs-selector-attr">[-105.26,73.64]</span>,<span class="hljs-selector-attr">[-104.5,73.42]</span>]],<span class="hljs-selector-attr">[[[-76.34,73.102685]</span>,<span class="hljs-selector-attr">[-76.251404,72.826385]</span>,<span class="hljs-selector-attr">[-77.314438,72.855545]</span>,<span class="hljs-selector-attr">[-78.39167,72.876656]</span>,<span class="hljs-selector-attr">[-79.486252,72.742203]</span>,<span class="hljs-selector-attr">[-79.775833,72.802902]</span>,<span class="hljs-selector-attr">[-80.876099,73.333183]</span>,<span class="hljs-selector-attr">[-80.833885,73.693184]</span>,<span class="hljs-selector-attr">[-80.353058,73.75972]</span>,<span class="hljs-selector-attr">[-78.064438,73.651932]</span>,<span class="hljs-selector-attr">[-76.34,73.102685]</span>]],<span class="hljs-selector-attr">[[[-86.562179,73.157447]</span>,<span class="hljs-selector-attr">[-85.774371,72.534126]</span>,<span class="hljs-selector-attr">[-84.850112,73.340278]</span>,<span class="hljs-selector-attr">[-82.31559,73.750951]</span>,<span class="hljs-selector-attr">[-80.600088,72.716544]</span>,<span class="hljs-selector-attr">[-80.748942,72.061907]</span>,<span class="hljs-selector-attr">[-78.770639,72.352173]</span>,<span class="hljs-selector-attr">[-77.824624,72.749617]</span>,<span class="hljs-selector-attr">[-75.605845,72.243678]</span>,<span class="hljs-selector-attr">[-74.228616,71.767144]</span>,<span class="hljs-selector-attr">[-74.099141,71.33084]</span>,<span class="hljs-selector-attr">[-72.242226,71.556925]</span>,<span class="hljs-selector-attr">[-71.200015,70.920013]</span>,<span class="hljs-selector-attr">[-68.786054,70.525024]</span>,<span class="hljs-selector-attr">[-67.91497,70.121948]</span>,<span class="hljs-selector-attr">[-66.969033,69.186087]</span>,<span class="hljs-selector-attr">[-68.805123,68.720198]</span>,<span class="hljs-selector-attr">[-66.449866,68.067163]</span>,<span class="hljs-selector-attr">[-64.862314,67.847539]</span>,<span class="hljs-selector-attr">[-63.424934,66.928473]</span>,<span class="hljs-selector-attr">[-61.851981,66.862121]</span>,<span class="hljs-selector-attr">[-62.163177,66.160251]</span>,<span class="hljs-selector-attr">[-63.918444,64.998669]</span>,<span class="hljs-selector-attr">[-65.14886,65.426033]</span>,<span class="hljs-selector-attr">[-66.721219,66.388041]</span>,<span class="hljs-selector-attr">[-68.015016,66.262726]</span>,<span class="hljs-selector-attr">[-68.141287,65.689789]</span>,<span class="hljs-selector-attr">[-67.089646,65.108455]</span>,<span class="hljs-selector-attr">[-65.73208,64.648406]</span>,<span class="hljs-selector-attr">[-65.320168,64.382737]</span>,<span class="hljs-selector-attr">[-64.669406,63.392927]</span>,<span class="hljs-selector-attr">[-65.013804,62.674185]</span>,<span class="hljs-selector-attr">[-66.275045,62.945099]</span>,<span class="hljs-selector-attr">[-68.783186,63.74567]</span>,<span class="hljs-selector-attr">[-67.369681,62.883966]</span>,<span class="hljs-selector-attr">[-66.328297,62.280075]</span>,<span class="hljs-selector-attr">[-66.165568,61.930897]</span>,<span class="hljs-selector-attr">[-68.877367,62.330149]</span>,<span class="hljs-selector-attr">[-71.023437,62.910708]</span>,<span class="hljs-selector-attr">[-72.235379,63.397836]</span>,<span class="hljs-selector-attr">[-71.886278,63.679989]</span>,<span class="hljs-selector-attr">[-73.378306,64.193963]</span>,<span class="hljs-selector-attr">[-74.834419,64.679076]</span>,<span class="hljs-selector-attr">[-74.818503,64.389093]</span>,<span class="hljs-selector-attr">[-77.70998,64.229542]</span>,<span class="hljs-selector-attr">[-78.555949,64.572906]</span>,<span class="hljs-selector-attr">[-77.897281,65.309192]</span>,<span class="hljs-selector-attr">[-76.018274,65.326969]</span>,<span class="hljs-selector-attr">[-73.959795,65.454765]</span>,<span class="hljs-selector-attr">[-74.293883,65.811771]</span>,<span class="hljs-selector-attr">[-73.944912,66.310578]</span>,<span class="hljs-selector-attr">[-72.651167,67.284576]</span>,<span class="hljs-selector-attr">[-72.92606,67.726926]</span>,<span class="hljs-selector-attr">[-73.311618,68.069437]</span>,<span class="hljs-selector-attr">[-74.843307,68.554627]</span>,<span class="hljs-selector-attr">[-76.869101,68.894736]</span>,<span class="hljs-selector-attr">[-76.228649,69.147769]</span>,<span class="hljs-selector-attr">[-77.28737,69.76954]</span>,<span class="hljs-selector-attr">[-78.168634,69.826488]</span>,<span class="hljs-selector-attr">[-78.957242,70.16688]</span>,<span class="hljs-selector-attr">[-79.492455,69.871808]</span>,<span class="hljs-selector-attr">[-81.305471,69.743185]</span>,<span class="hljs-selector-attr">[-84.944706,69.966634]</span>,<span class="hljs-selector-attr">[-87.060003,70.260001]</span>,<span class="hljs-selector-attr">[-88.681713,70.410741]</span>,<span class="hljs-selector-attr">[-89.51342,70.762038]</span>,<span class="hljs-selector-attr">[-88.467721,71.218186]</span>,<span class="hljs-selector-attr">[-89.888151,71.222552]</span>,<span class="hljs-selector-attr">[-90.20516,72.235074]</span>,<span class="hljs-selector-attr">[-89.436577,73.129464]</span>,<span class="hljs-selector-attr">[-88.408242,73.537889]</span>,<span class="hljs-selector-attr">[-85.826151,73.803816]</span>,<span class="hljs-selector-attr">[-86.562179,73.157447]</span>]],<span class="hljs-selector-attr">[[[-100.35642,73.84389]</span>,<span class="hljs-selector-attr">[-99.16387,73.63339]</span>,<span class="hljs-selector-attr">[-97.38,73.76]</span>,<span class="hljs-selector-attr">[-97.12,73.47]</span>,<span class="hljs-selector-attr">[-98.05359,72.99052]</span>,<span class="hljs-selector-attr">[-96.54,72.56]</span>,<span class="hljs-selector-attr">[-96.72,71.66]</span>,<span class="hljs-selector-attr">[-98.35966,71.27285]</span>,<span class="hljs-selector-attr">[-99.32286,71.35639]</span>,<span class="hljs-selector-attr">[-100.01482,71.73827]</span>,<span class="hljs-selector-attr">[-102.5,72.51]</span>,<span class="hljs-selector-attr">[-102.48,72.83]</span>,<span class="hljs-selector-attr">[-100.43836,72.70588]</span>,<span class="hljs-selector-attr">[-101.54,73.36]</span>,<span class="hljs-selector-attr">[-100.35642,73.84389]</span>]],<span class="hljs-selector-attr">[[[-93.196296,72.771992]</span>,<span class="hljs-selector-attr">[-94.269047,72.024596]</span>,<span class="hljs-selector-attr">[-95.409856,72.061881]</span>,<span class="hljs-selector-attr">[-96.033745,72.940277]</span>,<span class="hljs-selector-attr">[-96.018268,73.43743]</span>,<span class="hljs-selector-attr">[-95.495793,73.862417]</span>,<span class="hljs-selector-attr">[-94.503658,74.134907]</span>,<span class="hljs-selector-attr">[-92.420012,74.100025]</span>,<span class="hljs-selector-attr">[-90.509793,73.856732]</span>,<span class="hljs-selector-attr">[-92.003965,72.966244]</span>,<span class="hljs-selector-attr">[-93.196296,72.771992]</span>]],<span class="hljs-selector-attr">[[[-120.46,71.383602]</span>,<span class="hljs-selector-attr">[-123.09219,70.90164]</span>,<span class="hljs-selector-attr">[-123.62,71.34]</span>,<span class="hljs-selector-attr">[-125.928949,71.868688]</span>,<span class="hljs-selector-attr">[-125.5,72.292261]</span>,<span class="hljs-selector-attr">[-124.80729,73.02256]</span>,<span class="hljs-selector-attr">[-123.94,73.68]</span>,<span class="hljs-selector-attr">[-124.91775,74.29275]</span>,<span class="hljs-selector-attr">[-121.53788,74.44893]</span>,<span class="hljs-selector-attr">[-120.10978,74.24135]</span>,<span class="hljs-selector-attr">[-117.55564,74.18577]</span>,<span class="hljs-selector-attr">[-116.58442,73.89607]</span>,<span class="hljs-selector-attr">[-115.51081,73.47519]</span>,<span class="hljs-selector-attr">[-116.76794,73.22292]</span>,<span class="hljs-selector-attr">[-119.22,72.52]</span>,<span class="hljs-selector-attr">[-120.46,71.82]</span>,<span class="hljs-selector-attr">[-120.46,71.383602]</span>]],<span class="hljs-selector-attr">[[[-93.612756,74.979997]</span>,<span class="hljs-selector-attr">[-94.156909,74.592347]</span>,<span class="hljs-selector-attr">[-95.608681,74.666864]</span>,<span class="hljs-selector-attr">[-96.820932,74.927623]</span>,<span class="hljs-selector-attr">[-96.288587,75.377828]</span>,<span class="hljs-selector-attr">[-94.85082,75.647218]</span>,<span class="hljs-selector-attr">[-93.977747,75.29649]</span>,<span class="hljs-selector-attr">[-93.612756,74.979997]</span>]],<span class="hljs-selector-attr">[[[-98.5,76.72]</span>,<span class="hljs-selector-attr">[-97.735585,76.25656]</span>,<span class="hljs-selector-attr">[-97.704415,75.74344]</span>,<span class="hljs-selector-attr">[-98.16,75]</span>,<span class="hljs-selector-attr">[-99.80874,74.89744]</span>,<span class="hljs-selector-attr">[-100.88366,75.05736]</span>,<span class="hljs-selector-attr">[-100.86292,75.64075]</span>,<span class="hljs-selector-attr">[-102.50209,75.5638]</span>,<span class="hljs-selector-attr">[-102.56552,76.3366]</span>,<span class="hljs-selector-attr">[-101.48973,76.30537]</span>,<span class="hljs-selector-attr">[-99.98349,76.64634]</span>,<span class="hljs-selector-attr">[-98.57699,76.58859]</span>,<span class="hljs-selector-attr">[-98.5,76.72]</span>]],<span class="hljs-selector-attr">[[[-108.21141,76.20168]</span>,<span class="hljs-selector-attr">[-107.81943,75.84552]</span>,<span class="hljs-selector-attr">[-106.92893,76.01282]</span>,<span class="hljs-selector-attr">[-105.881,75.9694]</span>,<span class="hljs-selector-attr">[-105.70498,75.47951]</span>,<span class="hljs-selector-attr">[-106.31347,75.00527]</span>,<span class="hljs-selector-attr">[-109.7,74.85]</span>,<span class="hljs-selector-attr">[-112.22307,74.41696]</span>,<span class="hljs-selector-attr">[-113.74381,74.39427]</span>,<span class="hljs-selector-attr">[-113.87135,74.72029]</span>,<span class="hljs-selector-attr">[-111.79421,75.1625]</span>,<span class="hljs-selector-attr">[-116.31221,75.04343]</span>,<span class="hljs-selector-attr">[-117.7104,75.2222]</span>,<span class="hljs-selector-attr">[-116.34602,76.19903]</span>,<span class="hljs-selector-attr">[-115.40487,76.47887]</span>,<span class="hljs-selector-attr">[-112.59056,76.14134]</span>,<span class="hljs-selector-attr">[-110.81422,75.54919]</span>,<span class="hljs-selector-attr">[-109.0671,75.47321]</span>,<span class="hljs-selector-attr">[-110.49726,76.42982]</span>,<span class="hljs-selector-attr">[-109.5811,76.79417]</span>,<span class="hljs-selector-attr">[-108.54859,76.67832]</span>,<span class="hljs-selector-attr">[-108.21141,76.20168]</span>]],<span class="hljs-selector-attr">[[[-94.684086,77.097878]</span>,<span class="hljs-selector-attr">[-93.573921,76.776296]</span>,<span class="hljs-selector-attr">[-91.605023,76.778518]</span>,<span class="hljs-selector-attr">[-90.741846,76.449597]</span>,<span class="hljs-selector-attr">[-90.969661,76.074013]</span>,<span class="hljs-selector-attr">[-89.822238,75.847774]</span>,<span class="hljs-selector-attr">[-89.187083,75.610166]</span>,<span class="hljs-selector-attr">[-87.838276,75.566189]</span>,<span class="hljs-selector-attr">[-86.379192,75.482421]</span>,<span class="hljs-selector-attr">[-84.789625,75.699204]</span>,<span class="hljs-selector-attr">[-82.753445,75.784315]</span>,<span class="hljs-selector-attr">[-81.128531,75.713983]</span>,<span class="hljs-selector-attr">[-80.057511,75.336849]</span>,<span class="hljs-selector-attr">[-79.833933,74.923127]</span>,<span class="hljs-selector-attr">[-80.457771,74.657304]</span>,<span class="hljs-selector-attr">[-81.948843,74.442459]</span>,<span class="hljs-selector-attr">[-83.228894,74.564028]</span>,<span class="hljs-selector-attr">[-86.097452,74.410032]</span>,<span class="hljs-selector-attr">[-88.15035,74.392307]</span>,<span class="hljs-selector-attr">[-89.764722,74.515555]</span>,<span class="hljs-selector-attr">[-92.422441,74.837758]</span>,<span class="hljs-selector-attr">[-92.768285,75.38682]</span>,<span class="hljs-selector-attr">[-92.889906,75.882655]</span>,<span class="hljs-selector-attr">[-93.893824,76.319244]</span>,<span class="hljs-selector-attr">[-95.962457,76.441381]</span>,<span class="hljs-selector-attr">[-97.121379,76.751078]</span>,<span class="hljs-selector-attr">[-96.745123,77.161389]</span>,<span class="hljs-selector-attr">[-94.684086,77.097878]</span>]],<span class="hljs-selector-attr">[[[-116.198587,77.645287]</span>,<span class="hljs-selector-attr">[-116.335813,76.876962]</span>,<span class="hljs-selector-attr">[-117.106051,76.530032]</span>,<span class="hljs-selector-attr">[-118.040412,76.481172]</span>,<span class="hljs-selector-attr">[-119.899318,76.053213]</span>,<span class="hljs-selector-attr">[-121.499995,75.900019]</span>,<span class="hljs-selector-attr">[-122.854924,76.116543]</span>,<span class="hljs-selector-attr">[-122.854925,76.116543]</span>,<span class="hljs-selector-attr">[-121.157535,76.864508]</span>,<span class="hljs-selector-attr">[-119.103939,77.51222]</span>,<span class="hljs-selector-attr">[-117.570131,77.498319]</span>,<span class="hljs-selector-attr">[-116.198587,77.645287]</span>]],<span class="hljs-selector-attr">[[[-93.840003,77.519997]</span>,<span class="hljs-selector-attr">[-94.295608,77.491343]</span>,<span class="hljs-selector-attr">[-96.169654,77.555111]</span>,<span class="hljs-selector-attr">[-96.436304,77.834629]</span>,<span class="hljs-selector-attr">[-94.422577,77.820005]</span>,<span class="hljs-selector-attr">[-93.720656,77.634331]</span>,<span class="hljs-selector-attr">[-93.840003,77.519997]</span>]],<span class="hljs-selector-attr">[[[-110.186938,77.697015]</span>,<span class="hljs-selector-attr">[-112.051191,77.409229]</span>,<span class="hljs-selector-attr">[-113.534279,77.732207]</span>,<span class="hljs-selector-attr">[-112.724587,78.05105]</span>,<span class="hljs-selector-attr">[-111.264443,78.152956]</span>,<span class="hljs-selector-attr">[-109.854452,77.996325]</span>,<span class="hljs-selector-attr">[-110.186938,77.697015]</span>]],<span class="hljs-selector-attr">[[[-109.663146,78.601973]</span>,<span class="hljs-selector-attr">[-110.881314,78.40692]</span>,<span class="hljs-selector-attr">[-112.542091,78.407902]</span>,<span class="hljs-selector-attr">[-112.525891,78.550555]</span>,<span class="hljs-selector-attr">[-111.50001,78.849994]</span>,<span class="hljs-selector-attr">[-110.963661,78.804441]</span>,<span class="hljs-selector-attr">[-109.663146,78.601973]</span>]],<span class="hljs-selector-attr">[[[-95.830295,78.056941]</span>,<span class="hljs-selector-attr">[-97.309843,77.850597]</span>,<span class="hljs-selector-attr">[-98.124289,78.082857]</span>,<span class="hljs-selector-attr">[-98.552868,78.458105]</span>,<span class="hljs-selector-attr">[-98.631984,78.87193]</span>,<span class="hljs-selector-attr">[-97.337231,78.831984]</span>,<span class="hljs-selector-attr">[-96.754399,78.765813]</span>,<span class="hljs-selector-attr">[-95.559278,78.418315]</span>,<span class="hljs-selector-attr">[-95.830295,78.056941]</span>]],<span class="hljs-selector-attr">[[[-100.060192,78.324754]</span>,<span class="hljs-selector-attr">[-99.670939,77.907545]</span>,<span class="hljs-selector-attr">[-101.30394,78.018985]</span>,<span class="hljs-selector-attr">[-102.949809,78.343229]</span>,<span class="hljs-selector-attr">[-105.176133,78.380332]</span>,<span class="hljs-selector-attr">[-104.210429,78.67742]</span>,<span class="hljs-selector-attr">[-105.41958,78.918336]</span>,<span class="hljs-selector-attr">[-105.492289,79.301594]</span>,<span class="hljs-selector-attr">[-103.529282,79.165349]</span>,<span class="hljs-selector-attr">[-100.825158,78.800462]</span>,<span class="hljs-selector-attr">[-100.060192,78.324754]</span>]],<span class="hljs-selector-attr">[[[-87.02,79.66]</span>,<span class="hljs-selector-attr">[-85.81435,79.3369]</span>,<span class="hljs-selector-attr">[-87.18756,79.0393]</span>,<span class="hljs-selector-attr">[-89.03535,78.28723]</span>,<span class="hljs-selector-attr">[-90.80436,78.21533]</span>,<span class="hljs-selector-attr">[-92.87669,78.34333]</span>,<span class="hljs-selector-attr">[-93.95116,78.75099]</span>,<span class="hljs-selector-attr">[-93.93574,79.11373]</span>,<span class="hljs-selector-attr">[-93.14524,79.3801]</span>,<span class="hljs-selector-attr">[-94.974,79.37248]</span>,<span class="hljs-selector-attr">[-96.07614,79.70502]</span>,<span class="hljs-selector-attr">[-96.70972,80.15777]</span>,<span class="hljs-selector-attr">[-96.01644,80.60233]</span>,<span class="hljs-selector-attr">[-95.32345,80.90729]</span>,<span class="hljs-selector-attr">[-94.29843,80.97727]</span>,<span class="hljs-selector-attr">[-94.73542,81.20646]</span>,<span class="hljs-selector-attr">[-92.40984,81.25739]</span>,<span class="hljs-selector-attr">[-91.13289,80.72345]</span>,<span class="hljs-selector-attr">[-89.45,80.509322]</span>,<span class="hljs-selector-attr">[-87.81,80.32]</span>,<span class="hljs-selector-attr">[-87.02,79.66]</span>]],<span class="hljs-selector-attr">[[[-68.5,83.106322]</span>,<span class="hljs-selector-attr">[-65.82735,83.02801]</span>,<span class="hljs-selector-attr">[-63.68,82.9]</span>,<span class="hljs-selector-attr">[-61.85,82.6286]</span>,<span class="hljs-selector-attr">[-61.89388,82.36165]</span>,<span class="hljs-selector-attr">[-64.334,81.92775]</span>,<span class="hljs-selector-attr">[-66.75342,81.72527]</span>,<span class="hljs-selector-attr">[-67.65755,81.50141]</span>,<span class="hljs-selector-attr">[-65.48031,81.50657]</span>,<span class="hljs-selector-attr">[-67.84,80.9]</span>,<span class="hljs-selector-attr">[-69.4697,80.61683]</span>,<span class="hljs-selector-attr">[-71.18,79.8]</span>,<span class="hljs-selector-attr">[-73.2428,79.63415]</span>,<span class="hljs-selector-attr">[-73.88,79.430162]</span>,<span class="hljs-selector-attr">[-76.90773,79.32309]</span>,<span class="hljs-selector-attr">[-75.52924,79.19766]</span>,<span class="hljs-selector-attr">[-76.22046,79.01907]</span>,<span class="hljs-selector-attr">[-75.39345,78.52581]</span>,<span class="hljs-selector-attr">[-76.34354,78.18296]</span>,<span class="hljs-selector-attr">[-77.88851,77.89991]</span>,<span class="hljs-selector-attr">[-78.36269,77.50859]</span>,<span class="hljs-selector-attr">[-79.75951,77.20968]</span>,<span class="hljs-selector-attr">[-79.61965,76.98336]</span>,<span class="hljs-selector-attr">[-77.91089,77.022045]</span>,<span class="hljs-selector-attr">[-77.88911,76.777955]</span>,<span class="hljs-selector-attr">[-80.56125,76.17812]</span>,<span class="hljs-selector-attr">[-83.17439,76.45403]</span>,<span class="hljs-selector-attr">[-86.11184,76.29901]</span>,<span class="hljs-selector-attr">[-87.6,76.42]</span>,<span class="hljs-selector-attr">[-89.49068,76.47239]</span>,<span class="hljs-selector-attr">[-89.6161,76.95213]</span>,<span class="hljs-selector-attr">[-87.76739,77.17833]</span>,<span class="hljs-selector-attr">[-88.26,77.9]</span>,<span class="hljs-selector-attr">[-87.65,77.970222]</span>,<span class="hljs-selector-attr">[-84.97634,77.53873]</span>,<span class="hljs-selector-attr">[-86.34,78.18]</span>,<span class="hljs-selector-attr">[-87.96192,78.37181]</span>,<span class="hljs-selector-attr">[-87.15198,78.75867]</span>,<span class="hljs-selector-attr">[-85.37868,78.9969]</span>,<span class="hljs-selector-attr">[-85.09495,79.34543]</span>,<span class="hljs-selector-attr">[-86.50734,79.73624]</span>,<span class="hljs-selector-attr">[-86.93179,80.25145]</span>,<span class="hljs-selector-attr">[-84.19844,80.20836]</span>,<span class="hljs-selector-attr">[-83.408696,80.1]</span>,<span class="hljs-selector-attr">[-81.84823,80.46442]</span>,<span class="hljs-selector-attr">[-84.1,80.58]</span>,<span class="hljs-selector-attr">[-87.59895,80.51627]</span>,<span class="hljs-selector-attr">[-89.36663,80.85569]</span>,<span class="hljs-selector-attr">[-90.2,81.26]</span>,<span class="hljs-selector-attr">[-91.36786,81.5531]</span>,<span class="hljs-selector-attr">[-91.58702,81.89429]</span>,<span class="hljs-selector-attr">[-90.1,82.085]</span>,<span class="hljs-selector-attr">[-88.93227,82.11751]</span>,<span class="hljs-selector-attr">[-86.97024,82.27961]</span>,<span class="hljs-selector-attr">[-85.5,82.652273]</span>,<span class="hljs-selector-attr">[-84.260005,82.6]</span>,<span class="hljs-selector-attr">[-83.18,82.32]</span>,<span class="hljs-selector-attr">[-82.42,82.86]</span>,<span class="hljs-selector-attr">[-81.1,83.02]</span>,<span class="hljs-selector-attr">[-79.30664,83.13056]</span>,<span class="hljs-selector-attr">[-76.25,83.172059]</span>,<span class="hljs-selector-attr">[-75.71878,83.06404]</span>,<span class="hljs-selector-attr">[-72.83153,83.23324]</span>,<span class="hljs-selector-attr">[-70.665765,83.169781]</span>,<span class="hljs-selector-attr">[-68.5,83.106322]</span>]]]}},
{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Feature</span>","<span class="hljs-selector-tag">id</span>":"<span class="hljs-selector-tag">CHE</span>","<span class="hljs-selector-tag">properties</span>":{"<span class="hljs-selector-tag">name</span>":"<span class="hljs-selector-tag">Switzerland</span>"},"<span class="hljs-selector-tag">geometry</span>":{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Polygon</span>","<span class="hljs-selector-tag">coordinates</span>":<span class="hljs-selector-attr">[[[9.594226,47.525058]</span>,<span class="hljs-selector-attr">[9.632932,47.347601]</span>,<span class="hljs-selector-attr">[9.47997,47.10281]</span>,<span class="hljs-selector-attr">[9.932448,46.920728]</span>,<span class="hljs-selector-attr">[10.442701,46.893546]</span>,<span class="hljs-selector-attr">[10.363378,46.483571]</span>,<span class="hljs-selector-attr">[9.922837,46.314899]</span>,<span class="hljs-selector-attr">[9.182882,46.440215]</span>,<span class="hljs-selector-attr">[8.966306,46.036932]</span>,<span class="hljs-selector-attr">[8.489952,46.005151]</span>,<span class="hljs-selector-attr">[8.31663,46.163642]</span>,<span class="hljs-selector-attr">[7.755992,45.82449]</span>,<span class="hljs-selector-attr">[7.273851,45.776948]</span>,<span class="hljs-selector-attr">[6.843593,45.991147]</span>,<span class="hljs-selector-attr">[6.5001,46.429673]</span>,<span class="hljs-selector-attr">[6.022609,46.27299]</span>,<span class="hljs-selector-attr">[6.037389,46.725779]</span>,<span class="hljs-selector-attr">[6.768714,47.287708]</span>,<span class="hljs-selector-attr">[6.736571,47.541801]</span>,<span class="hljs-selector-attr">[7.192202,47.449766]</span>,<span class="hljs-selector-attr">[7.466759,47.620582]</span>,<span class="hljs-selector-attr">[8.317301,47.61358]</span>,<span class="hljs-selector-attr">[8.522612,47.830828]</span>,<span class="hljs-selector-attr">[9.594226,47.525058]</span>]]}},
{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">Feature</span>","<span class="hljs-selector-tag">id</span>":"<span class="hljs-selector-tag">CHL</span>","<span class="hljs-selector-tag">properties</span>":{"<span class="hljs-selector-tag">name</span>":"<span class="hljs-selector-tag">Chile</span>"},"<span class="hljs-selector-tag">geometry</span>":{"<span class="hljs-selector-tag">type</span>":"<span class="hljs-selector-tag">MultiPolygon</span>","<span class="hljs-selector-tag">coordinates</span>":<span class="hljs-selector-attr">[[[[-68.63401,-52.63637]</span>,<span class="hljs-selector-attr">[-68.63335,-54.8695]</span>,<span class="hljs-selector-attr">[-67.56244,-54.87001]</span>,<span class="hljs-selector-attr">[-66.95992,-54.89681]</span>,<span class="hljs-selector-attr">[-67.29103,-55.30124]</span>,<span class="hljs-selector-attr">[-68.14863,-55.61183]</span>,<span class="hljs-selector-attr">[-68.639991,-55.580018]</span>,<span class="hljs-selector-attr">[-69.2321,-55.49906]</span>,<span class="hljs-selector-attr">[-69.95809,-55.19843]</span>,<span class="hljs-selector-attr">[-71.00568,-55.05383]</span>,<span class="hljs-selector-attr">[-72.2639,-54.49514]</span>,<span class="hljs-selector-attr">[-73.2852,-53.95752]</span>,<span class="hljs-selector-attr">[-74.66253,-52.83749]</span>,<span class="hljs-selector-attr">[-73.8381,-53.04743]</span>,<span class="hljs-selector-attr">[-72.43418,-53.7154]</span>,<span class="hljs-selector-attr">[-71.10773,-54.07433]</span>,<span class="hljs-selector-attr">[-70.59178,-53.61583]</span>,<span class="hljs-selector-attr">[-70.26748,-52.93123]</span>,<span class="hljs-selector-attr">[-69.34565,-52.5183]</span>,<span class="hljs-selector-attr">[-68.63401,-52.63637]</span>]],<span class="hljs-selector-attr">[[[-68.219913,-21.494347]</span>,<span class="hljs-selector-attr">[-67.82818,-22.872919]</span>,<span class="hljs-selector-attr">[-67.106674,-22.735925]</span>,<span class="hljs-selector-attr">[-66.985234,-22.986349]</span>,<span class="hljs-selector-attr">[-67.328443,-24.025303]</span>,<span class="hljs-selector-attr">[-68.417653,-24.518555]</span>,<span class="hljs-selector-attr">[-68.386001,-26.185016]</span>,<span class="hljs-selector-attr">[-68.5948,-26.506909]</span>,<span class="hljs-selector-attr">[-68.295542,-26.89934]</span>,<span class="hljs-selector-attr">[-69.001235,-27.521214]</span>,<span class="hljs-selector-attr">[-69.65613,-28.459141]</span>,<span class="hljs-selector-attr">[-70.01355,-29.367923]</span>,<span class="hljs-selector-attr">[-69.919008,-30.336339]</span>,<span class="hljs-selector-attr">[-70.535069,-31.36501]</span>,<span class="hljs-selector-attr">[-70.074399,-33.09121]</span>,<span class="hljs-selector-attr">[-69.814777,-33.273886]</span>,<span class="hljs-selector-attr">[-69.817309,-34.193571]</span>,<span class="hljs-selector-attr">[-70.388049,-35.169688]</span>,<span class="hljs-selector-attr">[-70.364769,-36.005089]</span>,<span class="hljs-selector-attr">[-71.121881,-36.658124]</span>,<span class="hljs-selector-attr">[-71.118625,-37.576827]</span>,<span class="hljs-selector-attr">[-70.814664,-38.552995]</span>,<span class="hljs-selector-attr">[-71.413517,-38.916022]</span>,<span class="hljs-selector-attr">[-71.680761,-39.808164]</span>,<span class="hljs-selector-attr">[-71.915734,-40.832339]</span>,<span class="hljs-selector-attr">[-71.746804,-42.051386]</span>,<span class="hljs-selector-attr">[-72.148898,-42.254888]</span>,<span class="hljs-selector-attr">[-71.915424,-43.408565]</span>,<span class="hljs-selector-attr">[-71.464056,-43.787611]</span>,<span class="hljs-selector-attr">[-71.793623,-44.207172]</span>,<span class="hljs-selector-attr">[-71.329801,-44.407522]</span>,<span class="hljs-selector-attr">[-71.222779,-44.784243]</span>,<span class="hljs-selector-attr">[-71.659316,-44.973689]</span>,<span class="hljs-selector-attr">[-71.552009,-45.560733]</span>,<span class="hljs-selector-attr">[-71.917258,-46.884838]</span>,<span class="hljs-selector-attr">[-72.447355,-47.738533]</span>,<span class="hljs-selector-attr">[-72.331161,-48.244238]</span>,<span class="hljs-selector-attr">[-72.648247,-48.878618]</span>,<span class="hljs-selector-attr">[-73.415436,-49.318436]</span>,<span class="hljs-selector-attr">[-73.328051,-50.378785]</span>,<span class="hljs-selector-attr">[-72.975747,-50.74145]</span>,<span class="hljs-selector-attr">[-72.309974,-50.67701]</span>,<span class="hljs-selector-attr">[-72.329404,-51.425956]</span>,<span class="hljs-selector-attr">[-71.914804,-52.009022]</span>,<span class="hljs-selector-attr">[-69.498362,-52.142761]</span>,<span class="hljs-selector-attr">[-68.571545,-52.299444]</span>,<span class="hljs-selector-attr">[-69.461284,-52.291951]</span>,<span class="hljs-selector-attr">[-69.94278,-52.537931]</span>,<span class="hljs-selector-attr">[-70.845102,-52.899201]</span>,<span class="hljs-selector-attr">[-71.006332,-53.833252]</span>,<span class="hljs-selector-attr">[-71.429795,-53.856455]</span>,<span class="hljs-selector-attr">[-72.557943,-53.53141]</span>,<span class="hljs-selector-attr">[-73.702757,-52.835069]</span>,<span class="hljs-selector-attr">[-73.702757,-52.83507]</span>,<span class="hljs-selector-attr">[-74.946763,-52.262754]</span>,<span class="hljs-selector-attr">[-75.260026,-51.629355]</span>,<span class="hljs-selector-attr">[-74.976632,-51.043396]</span>,<span class="hljs-selector-attr">[-75.479754,-50.378372]</span>,<span class="hljs-selector-attr">[-75.608015,-48.673773]</span>,<span class="hljs-selector-attr">[-75.18277,-47.711919]</span>,<span class="hljs-selector-attr">[-74.126581,-46.939253]</span>,<span class="hljs-selector-attr">[-75.644395,-46.647643]</span>,<span class="hljs-selector-attr">[-74.692154,-45.763976]</span>,<span class="hljs-selector-attr">[-74.351709,-44.103044]</span>,<span class="hljs-selector-attr">[-73.240356,-44.454961]</span>,<span class="hljs-selector-attr">[-72.717804,-42.383356]</span>,<span class="hljs-selector-attr">[-73.3889,-42.117532]</span>,<span class="hljs-selector-attr">[-73.701336,-43.365776]</span>,<span class="hljs-selector-attr">[-74.331943,-43.224958]</span>,<span class="hljs-selector-attr">[-74.017957,-41.794813]</span>,<span class="hljs-selector-attr">[-73.677099,-39.942213]</span>,<span class="hljs-selector-attr">[-73.217593,-39.258689]</span>,<span class="hljs-selector-attr">[-73.505559,-38.282883]</span>,<span class="hljs-selector-attr">[-73.588061,-37.156285]</span>,<span class="hljs-selector-attr">[-73.166717,-37.12378]</span>,<span class="hljs-selector-attr">[-72.553137,-35.50884]</span>,<span class="hljs-selector-attr">[-71.861732,-33.909093]</span>,<span class="hljs-selector-attr">[-71.43845,-32.418899]</span>,<span class="hljs-selector-attr">[-71.668721,-30.920645]</span>,<span class="hljs-selector-attr">[-71.370083,-30.095682]</span>,<span class="hljs-selector-attr">[-71.489894,-28.861442]</span>,<span class="hljs-selector-attr">[-70.905124,-27.64038]</span>,<span class="hljs-selector-attr">[-70.724954,-25.705924]</span>,<span class="hljs-selector-attr">[-70.403966,-23.628997]</span>,<span class="hljs-selector-attr">[-70.091246,-21.393319]</span>,<span class="hljs-selector-attr">[-70.16442,-19.756468]</span>,<span class="hljs-selector-attr">[-70.372572,-18.347975]</span>,<span class="hljs-selector-attr">[-69.858444,-18.092694]</span>,<span class="hljs-selector-attr">[-69.590424,-17.580012]</span>,<span class="hljs-selector-attr">[-69.100247,-18.260125]</span>,<span class="hljs-selector-attr">[-68.966818,-18.981683]</span>,<span class="hljs-selector-attr">[-68.442225,-19.405068]</span>,<span class="hljs-selector-attr">[-68.757167,-20.372658]</span>,<span class="hljs-selector-attr">[-68.219913,-21.494347]</span>]]]}},
]}
</code></pre>
<h2 data-id="heading-3">3. 导入依赖</h2>
<p><code>GeoJSON</code>作为一种矢量数据格式，可以使用矢量库<code>OGR</code>进行处理，以实现<code>GeoJSON</code>数据从文本格式转换为<code>Shp</code>格式。其中还涉及坐标定义，所以还需要引入<code>osr</code>模块。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">from</span> osgeo <span class="hljs-keyword">import</span> ogr,osr
<span class="hljs-keyword">import</span> os
</code></pre>
<h2 data-id="heading-4">4. 数据读取与转换</h2>
<p>定义一个方法<code>GeoJSON2Shp(geoPath,shpPath)</code>用于将<code>GeoJSON</code>数据转换为<code>Shp</code>数据。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
说明：将 GeoJSON 文件转换为 Shapfile 文件
参数：
    -geoPath：GeoJSON 文件路径
    -shpPath：Shp 文件路径
"""</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">GeoJSON2Shp</span>(<span class="hljs-params">geoPath,shpPath</span>):
</code></pre>
<p>在进行<code>GeoJSON</code>数据格式转换之前，需要检查数据路径是否存在。</p>
<pre><code class="hljs language-lua" lang="lua"># 检查文件是否存在
<span class="hljs-keyword">if</span> <span class="hljs-built_in">os</span>.<span class="hljs-built_in">path</span>.exists(geoPath):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"GeoJSON 文件存在。"</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"GeoJSON 文件不存在，请重新选择文件！"</span>)
    <span class="hljs-keyword">return</span>
</code></pre>
<p>打开<code>GeoJSON</code>数据。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 打开JSON文件</span>
<span class="hljs-attr">jsonDataSource</span> = ogr.Open(geoPath)
<span class="hljs-attr">jsonLayer</span> = jsonDataSource.GetLayer()
</code></pre>
<p>使用<code>os.path.exists</code>方法检查<code>Shp</code>文件是否已经创建，如果存在则将其删除。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">if</span> os.path.exists(shpPath):
    <span class="hljs-keyword">try</span>:
        shpDriver.DeleteDataSource(shpPath)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"文件已删除！"</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"文件删除出错：<span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
</code></pre>
<p>通过<code>GetDriverByName</code>获取<code>Shp</code>数据驱动，并创建<code>Shp</code>数据源。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 创建Shp数据源</span>
<span class="hljs-attr">shpDriver</span> = ogr.GetDriverByName(<span class="hljs-string">"ESRI Shapefile"</span>)
<span class="hljs-attr">shpDataSource</span> = shpDriver.CreateDataSource(shpPath)
</code></pre>
<p>添加<code>Shp</code>图层属性。获取源数据坐标系、属性字段以及几何对象，并将其复制到目标图层中。属性结构显示如下：<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f123ef5434cc4d1dad710c1ffb48788f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767619384&amp;x-signature=%2B4xZj01G5CrncOwDgdM8ncg%2FpL8%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 获取坐标系</span>
<span class="hljs-attr">srs</span> = jsonLayer.GetSpatialRef()

<span class="hljs-comment"># 创建Shp数据图层</span>
<span class="hljs-attr">shpLayer</span> = shpDataSource.CreateLayer(
    "layer",
    <span class="hljs-attr">srs</span>=srs,
    <span class="hljs-attr">geom_type</span>=jsonLayer.GetGeomType()
)

<span class="hljs-comment"># 获取字段属性</span>
<span class="hljs-attr">layerDefn</span> = jsonLayer.GetLayerDefn()
for i in range(layerDefn.GetFieldCount()):
    <span class="hljs-attr">fieldDefn</span> = layerDefn.GetFieldDefn(i)
    shpLayer.CreateField(fieldDefn)

<span class="hljs-comment"># 获取几何属性</span>
for feature in jsonLayer:
    shpLayer.CreateFeature(feature)
</code></pre>
<p>在数据读取完成之后关闭数据源。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 关闭数据源</span>
<span class="hljs-attr">jsonDataSource</span> = shpDataSource = None
</code></pre>
<p>数据转换完成之后在<code>ArcMap</code>中打开的显示效果：<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93226aef513840bfac6fe98834b79590~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767619384&amp;x-signature=cxR97BsjasfnHzlEai79YIOivBk%3D" alt="" loading="lazy"/>数据属性：<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14d7e064233b4a89a32f900ce2c95382~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767619384&amp;x-signature=4243R2q9un3kSrjMH0wRAUqHUak%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么"虚拟现实"和"增强现实"不同？——从虚拟到混合的视觉革命]]></title>    <link>https://juejin.cn/post/7588971908227432482</link>    <guid>https://juejin.cn/post/7588971908227432482</guid>    <pubDate>2025-12-29T07:20:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588971908227432482" data-draft-id="7588999772749955107" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么&quot;虚拟现实&quot;和&quot;增强现实&quot;不同？——从虚拟到混合的视觉革命"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-12-29T07:20:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无限大6"/> <meta itemprop="url" content="https://juejin.cn/user/2865758605422890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么"虚拟现实"和"增强现实"不同？——从虚拟到混合的视觉革命
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2865758605422890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无限大6
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T07:20:23.000Z" title="Mon Dec 29 2025 07:20:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🕶️ 为什么"虚拟现实"和"增强现实"不同？——从虚拟到混合的视觉革命 🌈</h2>
<blockquote>
<p>大家好，我是无限大，欢迎收看十万个为什么系列文章</p>
<p>希望今天的内容能对大家有所帮助</p>
</blockquote>
<p>今天咱们来聊聊VR和AR这个"视觉科技的双生子"！想象一下，你戴着头显在虚拟世界里打游戏，仿佛身临其境；你用手机对着桌子，屏幕上出现一个3D模型，仿佛它真的在桌子上——这些炫酷的体验，都是VR和AR带来的！但你知道它们的区别吗？</p>
<h3 data-id="heading-1">🤔 核心问题：VR和AR的区别是什么？它们的技术原理和应用场景有何不同？</h3>
<p>很多人觉得VR和AR是"一回事"，其实它们差别很大！VR就像"完全进入另一个世界"，而AR是"在现实世界里加东西"。今天咱们就来揭开它们的神秘面纱！</p>
<h4 data-id="heading-2">VR和AR的本质</h4>
<ul>
<li>🎮 <strong>VR（Virtual Reality）</strong>：虚拟现实，通过头显完全沉浸在虚拟世界中，与现实世界隔绝</li>
<li>🔍 <strong>AR（Augmented Reality）</strong>：增强现实，在现实世界的基础上叠加虚拟内容，虚实结合</li>
<li>🌀 <strong>MR（Mixed Reality）</strong>：混合现实，虚拟内容与现实世界深度融合，能交互</li>
<li>🌐 <strong>XR（Extended Reality）</strong>：扩展现实，是VR、AR、MR的总称</li>
</ul>
<h3 data-id="heading-3">📜 视觉技术的"进化史"：从早期VR到XR融合</h3>
<h4 data-id="heading-4">1. 📺 早期VR设备："笨重的头盔"（1960s-1990s）</h4>
<p>1968年，伊凡·苏泽兰（Ivan Sutherland）发明了第一台VR头显"达摩克利斯之剑"（Sword of Damocles），它重达50公斤，需要悬挂在天花板上使用。</p>
<p>这就像"戴了个电视机在头上"，笨重又不实用，但它开启了VR的先河！</p>
<h4 data-id="heading-5">2. 🎮 游戏主机时代："家用VR萌芽"（1990s-2010s）</h4>
<p>1995年，任天堂推出了Virtual Boy，这是第一台家用VR游戏机。但它只有红色显示，重量大，体验差，很快就失败了。</p>
<p>这就像"一个会发光的红盒子"，虽然有创新，但技术还不成熟。</p>
<h4 data-id="heading-6">3. 🚀 现代VR："沉浸式体验"（2012-2016）</h4>
<p>2012年，Oculus Rift原型机发布，2016年正式上市。同年，HTC Vive、PlayStation VR也相继发布，VR进入了"黄金时代"。</p>
<p>这就像"打开了虚拟世界的大门"，人们第一次真正体验到了沉浸式VR！</p>
<h4 data-id="heading-7">4. 🌈 AR技术兴起："虚实结合"（2016-至今）</h4>
<p>2016年，Pokemon Go爆火，让AR技术走进了大众视野。同年，微软发布了HoloLens，这是第一台真正的MR头显。</p>
<p>这就像"给现实世界加了一层滤镜"，虚拟内容和现实世界完美结合！</p>
<h4 data-id="heading-8">5. 🌐 XR融合："未来已来"（2020-至今）</h4>
<p>现在，VR和AR技术正在融合，出现了越来越多的XR设备，比如Meta Quest 3、Apple Vision Pro等，它们既能提供沉浸式VR体验，也能提供出色的AR体验。</p>
<p>这就像"视觉技术的瑞士军刀"，集各种功能于一身！</p>
<h3 data-id="heading-9">🔧 技术原理：VR和AR的核心技术</h3>
<h4 data-id="heading-10">1. 🎮 VR的技术原理："完全沉浸"</h4>
<p>VR的核心是<strong>沉浸式显示</strong>，通过以下技术实现：</p>
<ul>
<li>🖥️ <strong>双屏显示</strong>：左右眼显示略有差异的画面，产生立体感</li>
<li>🎯 <strong>头部追踪</strong>：实时追踪头部位置和方向，调整显示内容</li>
<li>🔊 <strong>空间音频</strong>：根据头部位置调整声音，增强沉浸感</li>
<li>🎮 <strong>交互设备</strong>：手柄、手套、身体追踪器等，实现虚拟交互</li>
</ul>
<h4 data-id="heading-11">2. 🔍 AR的技术原理："虚实结合"</h4>
<p>AR的核心是<strong>在现实世界中叠加虚拟内容</strong>，通过以下技术实现：</p>
<ul>
<li>📷 <strong>摄像头</strong>：捕捉现实世界画面</li>
<li>📐 <strong>空间定位</strong>：通过SLAM（同步定位与地图构建）技术，确定设备在空间中的位置</li>
<li>🎨 <strong>虚拟叠加</strong>：将虚拟内容精确地叠加到现实世界中</li>
<li>✋ <strong>手势识别</strong>：识别用户手势，实现自然交互</li>
</ul>
<h4 data-id="heading-12">3. 🌀 MR的技术原理："深度融合"</h4>
<p>MR是VR和AR的结合，它不仅能叠加虚拟内容，还能让虚拟内容与现实世界交互，比如虚拟物体能被现实物体遮挡，能与现实物体互动。</p>
<h4 data-id="heading-13">4. <strong>代码实例</strong>：用Python和OpenCV模拟简单的AR效果</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> cv2
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np

<span class="hljs-comment"># 加载图像（作为虚拟内容）</span>
virtual_image = cv2.imread(<span class="hljs-string">'cat.png'</span>)
<span class="hljs-comment"># 如果没有cat.png，可以用下面的代码生成一个彩色方块</span>
<span class="hljs-comment"># virtual_image = np.zeros((100, 100, 3), dtype=np.uint8)</span>
<span class="hljs-comment"># virtual_image[:] = (0, 255, 0)  # 绿色方块</span>

<span class="hljs-comment"># 初始化摄像头</span>
cap = cv2.VideoCapture(<span class="hljs-number">0</span>)

<span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
    <span class="hljs-comment"># 读取摄像头画面</span>
    ret, frame = cap.read()
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ret:
        <span class="hljs-keyword">break</span>
    
    <span class="hljs-comment"># 获取画面尺寸</span>
    h, w, _ = frame.shape
    
    <span class="hljs-comment"># 定义AR内容的位置（屏幕中央）</span>
    ar_x = w // <span class="hljs-number">2</span> - <span class="hljs-number">50</span>
    ar_y = h // <span class="hljs-number">2</span> - <span class="hljs-number">50</span>
    
    <span class="hljs-comment"># 调整虚拟图像大小</span>
    virtual_resized = cv2.resize(virtual_image, (<span class="hljs-number">100</span>, <span class="hljs-number">100</span>))
    
    <span class="hljs-comment"># 将虚拟图像叠加到现实画面中</span>
    <span class="hljs-comment"># 简单的叠加，不考虑透明度</span>
    frame[ar_y:ar_y+<span class="hljs-number">100</span>, ar_x:ar_x+<span class="hljs-number">100</span>] = virtual_resized
    
    <span class="hljs-comment"># 添加文字说明</span>
    cv2.putText(frame, <span class="hljs-string">"AR效果演示"</span>, (<span class="hljs-number">10</span>, <span class="hljs-number">30</span>), 
               cv2.FONT_HERSHEY_SIMPLEX, <span class="hljs-number">1</span>, (<span class="hljs-number">0</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0</span>), <span class="hljs-number">2</span>)
    cv2.putText(frame, <span class="hljs-string">"绿色方块是虚拟内容"</span>, (<span class="hljs-number">10</span>, <span class="hljs-number">60</span>), 
               cv2.FONT_HERSHEY_SIMPLEX, <span class="hljs-number">0.7</span>, (<span class="hljs-number">0</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0</span>), <span class="hljs-number">2</span>)
    
    <span class="hljs-comment"># 显示结果</span>
    cv2.imshow(<span class="hljs-string">'AR Demo'</span>, frame)
    
    <span class="hljs-comment"># 按ESC键退出</span>
    <span class="hljs-keyword">if</span> cv2.waitKey(<span class="hljs-number">1</span>) &amp; <span class="hljs-number">0xFF</span> == <span class="hljs-number">27</span>:
        <span class="hljs-keyword">break</span>

<span class="hljs-comment"># 释放资源</span>
cap.release()
cv2.destroyAllWindows()
</code></pre>
<p><strong>运行结果</strong>：</p>
<ul>
<li>摄像头画面中央会显示一个绿色方块（或加载的图片），仿佛它真的在现实世界中</li>
<li>这是一个非常简单的AR效果演示，真实的AR技术会更复杂，需要空间定位、SLAM等技术</li>
</ul>
<h3 data-id="heading-14">📊 趣味对比：VR vs AR vs MR</h3>



























































<table><thead><tr><th>对比项</th><th>VR（虚拟现实）</th><th>AR（增强现实）</th><th>MR（混合现实）</th></tr></thead><tbody><tr><td><strong>核心体验</strong></td><td>完全沉浸在虚拟世界</td><td>在现实世界中叠加虚拟内容</td><td>虚拟与现实深度融合</td></tr><tr><td><strong>设备形式</strong></td><td>头显（遮挡现实）</td><td>手机、眼镜（透明显示）</td><td>透明头显</td></tr><tr><td><strong>交互方式</strong></td><td>虚拟手柄、手势</td><td>手势、语音、触摸</td><td>手势、语音、现实交互</td></tr><tr><td><strong>空间感知</strong></td><td>虚拟空间</td><td>现实空间+虚拟内容</td><td>现实空间+虚拟内容+交互</td></tr><tr><td><strong>代表产品</strong></td><td>Oculus Quest、HTC Vive</td><td>手机AR、Google Glass</td><td>HoloLens、Magic Leap</td></tr><tr><td><strong>典型应用</strong></td><td>游戏、虚拟旅游、培训</td><td>导航、教育、购物</td><td>工业设计、医疗手术、维修</td></tr><tr><td><strong>技术难度</strong></td><td>中</td><td>高</td><td>极高</td></tr><tr><td><strong>市场成熟度</strong></td><td>较成熟</td><td>快速发展</td><td>起步阶段</td></tr></tbody></table>
<h3 data-id="heading-15">🏢 VR和AR的应用场景："改变各行各业"</h3>
<p>VR和AR已经渗透到我们生活的方方面面，被称为"下一代计算平台"：</p>


















































<table><thead><tr><th>应用领域</th><th>VR应用</th><th>AR应用</th></tr></thead><tbody><tr><td>🎮 <strong>游戏娱乐</strong></td><td>沉浸式游戏、虚拟演唱会</td><td>Pokemon Go、AR滤镜、虚拟宠物</td></tr><tr><td>🏫 <strong>教育</strong></td><td>虚拟课堂、历史重现、科学实验</td><td>3D模型展示、交互式学习、虚拟教具</td></tr><tr><td>🏥 <strong>医疗健康</strong></td><td>手术培训、心理治疗、疼痛管理</td><td>手术导航、医学影像叠加、远程医疗</td></tr><tr><td>🏭 <strong>工业制造</strong></td><td>虚拟设计、工厂模拟、员工培训</td><td>设备维修、零件识别、装配指导</td></tr><tr><td>🛍️ <strong>零售购物</strong></td><td>虚拟试衣、虚拟展厅、家居设计</td><td>虚拟试妆、AR导购、产品信息查询</td></tr><tr><td>🗺️ <strong>导航出行</strong></td><td>虚拟驾驶、飞行模拟、虚拟旅游</td><td>实时导航、景点介绍、AR翻译</td></tr><tr><td>👷 <strong>建筑工程</strong></td><td>虚拟建筑、施工模拟、安全培训</td><td>建筑设计可视化、施工进度监控</td></tr><tr><td>🎬 <strong>影视传媒</strong></td><td>360°视频、虚拟影院</td><td>AR广告、交互式电影、虚拟角色</td></tr></tbody></table>
<h3 data-id="heading-16">⚠️ 常见误区纠正</h3>
<h4 data-id="heading-17">1. "VR和AR是一回事？"</h4>
<p>不！VR是完全沉浸在虚拟世界，AR是在现实世界叠加虚拟内容，它们的核心体验和技术原理都不同。</p>
<h4 data-id="heading-18">2. "VR会让人上瘾？"</h4>
<p>不一定！VR只是一种技术，就像手机、电脑一样，合理使用不会上瘾。但过度使用可能会导致眼睛疲劳、头晕等不适。</p>
<h4 data-id="heading-19">3. "AR技术还不成熟？"</h4>
<p>不！AR技术已经很成熟了，比如手机AR、Google Lens等，都已经广泛应用。只是MR技术还在发展中。</p>
<h4 data-id="heading-20">4. "VR头显很重？"</h4>
<p>早期的VR头显确实很重，但现在的头显已经很轻便了，比如Meta Quest 3只有515克，比很多手机还轻。</p>
<h4 data-id="heading-21">5. "AR必须戴眼镜？"</h4>
<p>不！手机AR不需要戴眼镜，只需要用手机摄像头就能体验。当然，AR眼镜会提供更好的体验。</p>
<h4 data-id="heading-22">6. "VR会伤害眼睛？"</h4>
<p>合理使用不会！VR头显都有蓝光过滤、自动亮度调节等功能，只要控制使用时间，不会伤害眼睛。</p>
<h3 data-id="heading-23">🔮 未来展望：VR和AR的发展趋势</h3>
<h4 data-id="heading-24">1. 📱 <strong>更轻便的设备</strong></h4>
<p>未来的VR/AR设备会越来越轻便，甚至可能像普通眼镜一样，佩戴舒适，外观时尚。</p>
<h4 data-id="heading-25">2. 🤖 <strong>更智能的交互</strong></h4>
<p>手势识别、语音识别、眼动追踪等技术会越来越成熟，交互会变得更加自然，甚至不需要手柄。</p>
<h4 data-id="heading-26">3. 🌐 <strong>更丰富的内容</strong></h4>
<p>随着技术的发展，VR/AR内容会越来越丰富，从游戏到教育，从娱乐到工作，涵盖各个领域。</p>
<h4 data-id="heading-27">4. 🔗 <strong>更好的互联性</strong></h4>
<p>VR/AR设备会与手机、电脑、智能家居等设备更好地互联，形成一个完整的生态系统。</p>
<h4 data-id="heading-28">5. 📊 <strong>更广泛的应用</strong></h4>
<p>VR/AR技术会应用到更多领域，比如远程办公、虚拟会议、数字孪生等，成为我们生活和工作的重要组成部分。</p>
<h4 data-id="heading-29">6. 💰 <strong>更低的价格</strong></h4>
<p>随着技术的成熟和量产，VR/AR设备的价格会越来越低，普及度会越来越高。</p>
<h3 data-id="heading-30">🎓 互动小测验：你答对了吗？</h3>


















































<table><thead><tr><th>问题</th><th>答案</th><th>你答对了吗？</th></tr></thead><tbody><tr><td>VR的核心是什么？</td><td>沉浸式显示</td><td>✅/❌</td></tr><tr><td>AR的核心是什么？</td><td>在现实世界中叠加虚拟内容</td><td>✅/❌</td></tr><tr><td>MR是VR和AR的结合吗？</td><td>是的</td><td>✅/❌</td></tr><tr><td>2025年VR/AR市场规模预计是多少？</td><td>2500亿美元</td><td>✅/❌</td></tr><tr><td>AR设备出货量会超过VR设备吗？</td><td>是的</td><td>✅/❌</td></tr><tr><td>SLAM技术在VR/AR中的作用是什么？</td><td>空间定位</td><td>✅/❌</td></tr><tr><td>代表MR设备的是？</td><td>HoloLens</td><td>✅/❌</td></tr><tr><td>VR头显会遮挡现实世界吗？</td><td>是的</td><td>✅/❌</td></tr></tbody></table>
<h3 data-id="heading-31">🎯 结语：视觉革命的未来</h3>
<p>VR和AR技术正在改变我们感知世界的方式，从完全虚拟到虚实结合，再到深度融合，它们让我们的生活和工作变得更加丰富多彩。</p>
<p>虽然VR和AR还有一些挑战需要克服，比如设备重量、内容质量、价格等，但随着技术的不断发展，它们一定会成为我们生活中不可或缺的一部分。</p>
<p>下次当你使用VR头显打游戏，或者用手机体验AR效果时，不妨想想背后的技术原理，感受一下视觉革命的魅力！</p>
<hr/>
<h3 data-id="heading-32">💬 互动话题</h3>
<ol>
<li>你体验过VR或AR吗？感觉如何？</li>
<li>你觉得VR和AR哪个更有前途？为什么？</li>
<li>你最期待VR/AR在哪个领域的应用？</li>
<li>你会购买Apple Vision Pro或Meta Quest 3吗？为什么？</li>
</ol>
<p>快来评论区聊聊你的想法！💬 点赞收藏不迷路，咱们下期继续探索计算机的"十万个为什么"！🎉</p>
<p><strong>关注我</strong>，下期带你解锁更多计算机的"奇葩冷知识"！🤓</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS应用开发：状态栏动画实现]]></title>    <link>https://juejin.cn/post/7589172193150386212</link>    <guid>https://juejin.cn/post/7589172193150386212</guid>    <pubDate>2025-12-29T14:38:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589172193150386212" data-draft-id="7589172193150369828" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS应用开发：状态栏动画实现"/> <meta itemprop="keywords" content="HarmonyOS,程序员,Android"/> <meta itemprop="datePublished" content="2025-12-29T14:38:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹿人戛"/> <meta itemprop="url" content="https://juejin.cn/user/4309685005226376"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS应用开发：状态栏动画实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4309685005226376/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹿人戛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T14:38:18.000Z" title="Mon Dec 29 2025 14:38:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>本案例展示了状态栏的动态交互效果。通过监听页面滚动事件 <code>onDidScroll</code>，随着页面的上下滚动，实现状态栏颜色的变化。搜索框会在滚动时流畅地展开或收起，并伴有自然的透明度过渡效果。</p>
<h3 data-id="heading-1">效果图预览</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3064042edec1412ea719171e33071a4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bm_5Lq65oib:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767623898&amp;x-signature=KyMi6HGBLfyLqFqwm1pqVlnuTjQ%3D" alt="" loading="lazy"/></p>
<p><strong>使用说明</strong></p>
<ol>
<li>进入页面开始加载，加载完成后显示整个界面,上下滚动页面即可。</li>
</ol>
<h3 data-id="heading-2">实现思路</h3>
<ul>
<li>
<p><strong>初始化和状态设置</strong><br/>
在 <code>aboutToAppear()</code> 方法中，初始化了窗口模型 <code>windowModel</code>。启用沉浸式（设置全屏显示和状态栏为白色），获取状态栏高度存储在 <code>statusBarHeight</code> 变量中，从预定义的数据源 <code>LIST_DATA</code> 加载数据到 <code>dataSource</code>中。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">aboutToAppear(): void {
  <span class="hljs-comment">// 初始化窗口管理model</span>
  <span class="hljs-keyword">const</span> windowStage: window.WindowStage | undefined = AppStorage.<span class="hljs-keyword">get</span>(<span class="hljs-string">'windowStage'</span>);
  <span class="hljs-comment">// 没有windowStage将无法执行下列逻辑</span>
  <span class="hljs-keyword">if</span> (!windowStage) {
    logger.error(TAG, <span class="hljs-string">'windowStage init error!'</span>);
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">this</span>.windowModel.setWindowStage(windowStage);
  <span class="hljs-comment">// 设置沉浸模式及状态栏白色</span>
  <span class="hljs-keyword">this</span>.windowModel.setImmersive();
  <span class="hljs-comment">// 获取顶部状态栏高度</span>
  <span class="hljs-keyword">this</span>.windowModel.getStatusBarHeight((statusBarHeight) =&gt; {
    logger.info(TAG, <span class="hljs-string">'statusBarHeight is '</span> + statusBarHeight);
    <span class="hljs-keyword">this</span>.statusBarHeight = px2vp(statusBarHeight);
  })
  <span class="hljs-comment">// 组装数据源</span>
  <span class="hljs-keyword">this</span>.dataSource.pushArrayData(LIST_DATA)
}
</code></pre>
</li>
<li>
<p><strong>界面布局构造</strong><br/>
使用Stack控件使状态栏与列表重叠，并为列表添加滚动监听器，以根据滚动位置调整状态栏和导航栏的透明度及展开收起动效。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">Stack</span>({ alignContent: Alignment.Top }) {
  <span class="hljs-built_in">Row</span>() {
    <span class="hljs-comment">// 动态显示回顶部或位置天气控件</span>
    if (this.isFlow) {
      this<span class="hljs-selector-class">.topUpBuilder</span>()
    } else {
      this<span class="hljs-selector-class">.locationAndWeatherBuilder</span>()
    }
    this<span class="hljs-selector-class">.searchViewBuilder</span>()
    this<span class="hljs-selector-class">.toolViewBuilder</span>()
  }
  <span class="hljs-selector-class">.height</span>(Constants.NAVIGATION_BAR_HEIGHT + this.statusBarHeight)
    <span class="hljs-selector-class">.width</span>(Constants.FULL_PERCENT)
    <span class="hljs-selector-class">.padding</span>({
      top: this.statusBarHeight
    })
    <span class="hljs-selector-class">.zIndex</span>(Constants.Z_INDEX_THREE)

  <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 知识点：父组件的透明度Opacity影响子组件（如父类Opacity为0.5，若子组件为0.5时，子组件实际Opacity = 0.5*0.5）,此处Row来改变状态栏的透明度不受影响其它组件透明度</span>
  <span class="hljs-built_in">Row</span>() {
  }
  <span class="hljs-selector-class">.backgroundColor</span>($r("app.color.status_bar_animation_white"))
    <span class="hljs-selector-class">.opacity</span>(this.navigateBarOpacity)
    <span class="hljs-selector-class">.height</span>(Constants.STATUS_BAR_HEIGHT + this.statusBarHeight)
    <span class="hljs-selector-class">.width</span>(Constants.FULL_PERCENT)
    <span class="hljs-selector-class">.zIndex</span>(Constants.Z_INDEX_TWO)

  <span class="hljs-built_in">List</span>({ scroller: this.scroller }) {
    <span class="hljs-comment">// ...</span>
  }
  <span class="hljs-comment">// 隐藏滚动条</span>
  <span class="hljs-selector-class">.scrollBar</span>(BarState.Off)
    <span class="hljs-comment">// 渐变蓝色背景色</span>
    <span class="hljs-selector-class">.linearGradient</span>({
      colors: [[Constants.LIST_LINEAR_GRADIENT_START_COLOR, Constants.LIST_LINEAR_GRADIENT_START],
        [Constants.LIST_LINEAR_GRADIENT_END_COLOR, Constants.LIST_LINEAR_GRADIENT_END]]
    })
    <span class="hljs-selector-class">.height</span>(Constants.FULL_PERCENT)
    <span class="hljs-selector-class">.width</span>(Constants.FULL_PERCENT)
}
<span class="hljs-selector-class">.zIndex</span>(Constants.Z_INDEX_ONE)
  <span class="hljs-selector-class">.height</span>(Constants.FULL_PERCENT)
  <span class="hljs-selector-class">.width</span>(Constants.FULL_PERCENT)
    <span class="hljs-comment">// 扩展至所有非安全区域</span>
  <span class="hljs-selector-class">.expandSafeArea</span>([SafeAreaType.SYSTEM], [SafeAreaEdge.BOTTOM])
</code></pre>
</li>
<li>
<p><strong>滚动事件处理</strong><br/>
通过监听页面滚动事件 <code>onDidScroll</code>，根据当前的滚动偏移量 yOffset 调整状态栏和导航栏的透明度。如果滚动超过了设定的阈值，则改变状态栏的颜色和展开收起动画。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">.onDidScroll(() =&gt; {
  <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 知识点：通过currentOffset来获取偏移量比较准确。</span>
  <span class="hljs-keyword">const</span> yOffset: number = <span class="hljs-keyword">this</span>.scroller.currentOffset().yOffset;
  yOffset &lt;= Constants.MAIN_SCROLLER_OFFSET_Y_ZERO ? <span class="hljs-keyword">this</span>.negativeOffsetY = yOffset :
  Constants.MAIN_SCROLLER_OFFSET_Y_ZERO;
  <span class="hljs-comment">// 判断导航栏和状态栏背景透明度变化</span>
  yOffset &gt;= Constants.MAIN_SCROLLER_OFFSET_Y_MAX + <span class="hljs-keyword">this</span>.statusBarHeight ?
    <span class="hljs-keyword">this</span>.navigateBarOpacity = Constants.NAVIGATION_BAR_OPACITY_MAX :
    <span class="hljs-keyword">this</span>.navigateBarOpacity = Constants.NAVIGATION_BAR_OPACITY_MIN;
  <span class="hljs-keyword">this</span>.navigateBarOpacity = yOffset / Constants.MAIN_SCROLLER_OFFSET_Y_MAX;
  <span class="hljs-comment">// 判断当前的导航栏和图标颜色变化</span>
  yOffset &gt; <span class="hljs-keyword">this</span>.statusBarHeight ?
    <span class="hljs-keyword">this</span>.isWhiteColor = <span class="hljs-literal">false</span> : <span class="hljs-keyword">this</span>.isWhiteColor = <span class="hljs-literal">true</span>;
  <span class="hljs-comment">// 判断状态栏字体颜色变化</span>
  yOffset &gt; <span class="hljs-keyword">this</span>.statusBarHeight ?
  <span class="hljs-keyword">this</span>.windowModel.setSystemBarContentColor(Constants.StatusBarContentBlackColor) :
  <span class="hljs-keyword">this</span>.windowModel.setSystemBarContentColor(Constants.StatusBarContentWhiteColor);
  <span class="hljs-comment">// 判断导航栏动效变化</span>
  yOffset &gt;= <span class="hljs-keyword">this</span>.statusBarHeight + Constants.MAIN_SCROLLER_OFFSET_STATUS_CHANGE ?
    <span class="hljs-keyword">this</span>.isFlow = <span class="hljs-literal">true</span> : <span class="hljs-keyword">this</span>.isFlow = <span class="hljs-literal">false</span>;
})
</code></pre>
</li>
</ul>
<h3 data-id="heading-3">总结</h3>
<p>本示例使用了<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-references-V5%2Fts-rendering-control-lazyforeach-V5" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/ts-rendering-control-lazyforeach-V5" ref="nofollow noopener noreferrer">LazyForEach</a>进行数据懒加载，LazyForEach懒加载可以通过设置cachedCount属性来指定缓存数量，同时搭配<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fbest-practices-V5%2Fbpta-component-reuse-V5" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/best-practices-V5/bpta-component-reuse-V5" ref="nofollow noopener noreferrer">组件复用</a>能力以达到性能最优效果。</p>
<h4 data-id="heading-4">如果您想系统深入地学习 HarmonyOS 开发或想考取HarmonyOS认证证书，欢迎加入华为开发者学堂：</h4>
<h3 data-id="heading-5">请点击→： <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2Fd0d15d9039414a8fad9f99ac4a3f5096%3Ftype%3D1%253Fha_source%253Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/d0d15d9039414a8fad9f99ac4a3f5096?type=1%3Fha_source%3Dhmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">HarmonyOS官方认证培训</a></h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d55a567a43d2464eba118ff249eb75db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bm_5Lq65oib:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767623898&amp;x-signature=mUGp%2FgSDfDrDFk2Gj8P10%2B6AnFQ%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【LangChain学习笔记】智能体]]></title>    <link>https://juejin.cn/post/7589386961648435235</link>    <guid>https://juejin.cn/post/7589386961648435235</guid>    <pubDate>2025-12-30T07:04:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589386961648435235" data-draft-id="7589308109640925219" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【LangChain学习笔记】智能体"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-30T07:04:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用泥种荷花"/> <meta itemprop="url" content="https://juejin.cn/user/4212984289442030"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【LangChain学习笔记】智能体
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984289442030/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用泥种荷花
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T07:04:13.000Z" title="Tue Dec 30 2025 07:04:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    24
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">基础创建：简易智能体</h2>
<h3 data-id="heading-1">核心代码示例</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI

<span class="hljs-comment"># 大模型初始化</span>
model = ChatOpenAI(
    model_name=<span class="hljs-string">"qwen-plus"</span>,
    base_url=<span class="hljs-string">"https://dashscope.aliyuncs.com/compatible-mode/v1"</span>,
    api_key=<span class="hljs-string">"sk-94207ea3eb4b44eaae46683ed8ac55e5"</span>,
)

<span class="hljs-comment"># 使用create_agent函数创建智能体，将前面初始化的模型作为参数传入</span>
agent = create_agent(model=model)

<span class="hljs-comment"># 通过智能体的invoke方法发起调用，传入构造好的输入数据</span>
response = agent.invoke({<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"human"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"1+1=?"</span>}]})

<span class="hljs-comment"># 打印智能体响应消息列表中最后一条消息的内容</span>
<span class="hljs-built_in">print</span>(response[<span class="hljs-string">"messages"</span>][-<span class="hljs-number">1</span>].content)
</code></pre>
<h3 data-id="heading-2">废弃函数提醒</h3>
<ul>
<li>最新版本 LangChain 中，无法通过 <code>langchain.agents.initialize_agent</code> 函数创建智能体；</li>
<li><code>langgraph.prebuilt.create_react_agent</code> 函数同样已被废弃，不建议继续使用。</li>
</ul>
<h2 data-id="heading-3">实战实例：智能体创建网页</h2>
<h3 data-id="heading-4">功能说明</h3>
<p>创建绑定文件管理工具的智能体，实现根据用户指定主题，自动编写并生成 HTML 网页文件，同时返回结构化 JSON 格式响应。</p>
<h3 data-id="heading-5">完整代码示例</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> (
    ChatPromptTemplate,
    SystemMessagePromptTemplate,
    HumanMessagePromptTemplate,
)

<span class="hljs-comment"># 从langchain_community.agent_toolkits模块导入FileManagementToolkit类，用于获取文件管理工具集</span>
<span class="hljs-keyword">from</span> langchain_community.agent_toolkits <span class="hljs-keyword">import</span> FileManagementToolkit
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> JsonOutputParser
<span class="hljs-keyword">import</span> os

<span class="hljs-comment"># 大模型初始化</span>
model = ChatOpenAI(
    model_name=<span class="hljs-string">"qwen-plus"</span>,
    base_url=<span class="hljs-string">"https://dashscope.aliyuncs.com/compatible-mode/v1"</span>,
    api_key=<span class="hljs-string">"[你的API Key]"</span>,
)

<span class="hljs-comment"># 定义系统消息提示模板内容</span>
system_message_prompt_template = SystemMessagePromptTemplate.from_template(
    <span class="hljs-string">"你是一个专业的前端开发，你可以根据用户的需求，编写前端代码。"</span>
)

<span class="hljs-comment"># 定义用户消息提示模板内容</span>
human_message_prompt_template = HumanMessagePromptTemplate.from_template(
    <span class="hljs-string">"帮我编写一个主题为{topic}的html文件，最后返回json格式的结果，格式为{format_instructions}。"</span>
)

<span class="hljs-comment"># 使用BaseModel定义一个名为ResponseFormat的数据模型</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ResponseFormat</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    code: <span class="hljs-built_in">int</span> = Field(description=<span class="hljs-string">"状态码，0表示成功，1表示失败"</span>)
    message: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"返回的消息"</span>)

<span class="hljs-comment"># 使用JsonOutputParser类初始化一个JSON输出解析器，并关联ResponseFormat数据模型</span>
json_parser = JsonOutputParser(
    pydantic_object=ResponseFormat,
)

<span class="hljs-comment"># 使用ChatPromptTemplate类的from_messages方法创建聊天提示模板，由系统消息提示模板和用户消息提示模板组成</span>
chat_prompt_template = ChatPromptTemplate.from_messages(
    [system_message_prompt_template, human_message_prompt_template]
)

<span class="hljs-comment"># 使用partial方法为聊天提示模板预填充变量</span>
chat_prompt_template = chat_prompt_template.partial(
    format_instructions=json_parser.get_format_instructions()
)

<span class="hljs-comment"># 创建智能体，传入初始化后的模型以及FileManagementToolkit获取的工具集</span>
agent = create_agent(
    model=model, tools=FileManagementToolkit(root_dir=os.getcwd()).get_tools()
)

<span class="hljs-comment"># 通过智能体的invoke方法发起调用，传入构造好的输入数据</span>
response = agent.invoke(
    {<span class="hljs-string">"messages"</span>: chat_prompt_template.format_messages(topic=<span class="hljs-string">"静夜思"</span>)},
)

<span class="hljs-built_in">print</span>(response[<span class="hljs-string">"messages"</span>][-<span class="hljs-number">1</span>].content)
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Elastic 即代码：自动化的不只是基础设施]]></title>    <link>https://juejin.cn/post/7589214643500941375</link>    <guid>https://juejin.cn/post/7589214643500941375</guid>    <pubDate>2025-12-30T06:30:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589214643500941375" data-draft-id="7589214643500924991" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Elastic 即代码：自动化的不只是基础设施"/> <meta itemprop="keywords" content="Elasticsearch"/> <meta itemprop="datePublished" content="2025-12-30T06:30:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Elasticsearch"/> <meta itemprop="url" content="https://juejin.cn/user/2612095360441448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Elastic 即代码：自动化的不只是基础设施
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612095360441448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Elasticsearch
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T06:30:31.000Z" title="Tue Dec 30 2025 06:30:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：来自  Elastic <a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscuss.elastic.co%2Fu%2Fkylerozanitis" title="https://discuss.elastic.co/u/kylerozanitis" target="_blank" ref="nofollow noopener noreferrer">kylerozanitis</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f78b4acbe9e348d6a2dbacbdb464a0a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681031&amp;x-signature=vH5Kf%2BOFhXgutkHTPMFIboUuZJ8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">Elastic 即代码：自动化不只是基础设施</h2>
<p>Terraform 是工程师常用的工具，用来通过一种叫 Infrastructure as Code（ IaC ）的模式创建、修改和删除基础设施。它通常用于管理云资源，比如应用负载均衡器（ ALB ）、数据库和虚拟机，但它同样也可以用来管理 Elastic 集群。不过，在很多 Elastic 环境中，集群创建之后的所有事情都发生在 Kibana 里 —— 索引模板、索引生命周期管理（ ILM ）策略、检测规则等等。</p>
<p>这会导致没有源码控制、无法回滚变更、无法进行漂移检测，也没有关于谁在什么时候、为什么修改了什么的审计记录。</p>
<p>Elastic 是一个 API 驱动的平台，这意味着你在 Kibana 中几乎能做的所有事情，也都可以通过 APIs 来完成。这表示我们不仅可以把基础设施作为代码来管理，还可以把更多内容代码化，从而获得可复现的环境、可审计性，以及对整个技术栈的信心。</p>
<p>在今天的博客中，我将展示如何只用一条 terraform apply 命令，就能创建一个 Elastic Cloud 集群、一个 ILM 策略、一个索引模板以及一个检测规则 —— 所有内容都在 Git 中进行版本控制。</p>
<h2 data-id="heading-1">理念</h2>
<p>当你刚开始使用 Elastic、学习某个功能如何工作，或者调试一个用于 detection rule 的 ES|QL 查询时，Kibana 非常好用。但最终的目标，应该是尽可能把所有东西都作为代码来管理。这让你可以自由实验，同时仍然能够 rollback 到一个可用的版本。它也确保从 DEV 到 PROD 的变更是经过 review 和 approval 的。就像发布一个新的应用代码版本可能是灾难性的，对 Security Operations Center ( SOC ) 中运行的 detection rule 进行修改，同样可能非常危险。</p>
<p>Elastic 为平台的几乎每一个部分都暴露了 API。因此，通过结合 Terraform Elastic Cloud Provider 和 Elastic Stack Provider，我们可以构建一个可复现的 Elastic-as-Code 工作流，用来部署一个 cloud cluster、ILM 策略、index template，以及 detection rule。</p>
<h3 data-id="heading-2">第 1 步：部署一个 Elastic Cloud 集群</h3>
<p>使用 Elastic Cloud provider，在你的根 main.tf 文件中定义一个 ec_deployment resource：</p>
<pre><code class="hljs language-ini" lang="ini">`

1.  resource "ec_deployment" "demo" {
<span class="hljs-attr">2.    name</span>                   = <span class="hljs-string">"advent-demo"</span>
<span class="hljs-attr">3.    region</span>                 = <span class="hljs-string">"us-east-1"</span>
<span class="hljs-attr">4.    version</span>                = <span class="hljs-string">"9.2.2"</span>
<span class="hljs-attr">5.    deployment_template_id</span> = <span class="hljs-string">"aws-cpu-optimized-faster-warm-arm"</span>

<span class="hljs-attr">7.    elasticsearch</span> = {
<span class="hljs-attr">8.      hot</span> = {
<span class="hljs-attr">9.        autoscaling</span> = {}
10.      }
11.    }

<span class="hljs-attr">13.    kibana</span> = {
<span class="hljs-attr">14.      topology</span> = {}
15.    }
16.  }

`AI写代码!<span class="hljs-section">[]</span>(https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<p>这会创建一个完全托管的 Elastic Cloud 部署。请注意，即使没有显式指定 hot 层节点规格，仍然需要包含 <code>hot = { autoscaling = {} }</code>。关于部署模板的更多信息，可以参考 Deployment templates 文档。</p>
<h3 data-id="heading-3">第 2 步：定义一个 ILM 策略</h3>
<p>使用 Elasticstack provider，通过 <code>elasticstack_elasticsearch_index_lifecycle</code> 资源来定义一个 ILM 策略：</p>
<pre><code class="hljs language-arduino" lang="arduino">`

<span class="hljs-number">1.</span>  resource <span class="hljs-string">"elasticstack_elasticsearch_index_lifecycle"</span> <span class="hljs-string">"advent_logs_ilm"</span> {
<span class="hljs-number">2.</span>    name = <span class="hljs-string">"advent-logs-ilm"</span>
<span class="hljs-number">3.</span>    <span class="hljs-keyword">delete</span> {
<span class="hljs-number">4.</span>      min_age = <span class="hljs-string">"30d"</span>

<span class="hljs-number">6.</span>      <span class="hljs-keyword">delete</span> {}
<span class="hljs-number">7.</span>    }
<span class="hljs-number">8.</span>  }

`AI写代码
</code></pre>
<p>为了简单起见，这个 ILM 策略会将数据保留在 hot 层 30 天，然后删除。用代码来管理 ILM 策略非常有价值，因为改动可能会对数据以及整个集群健康产生连锁影响。想象这样一个场景：一位工程师决定添加一个 cold 层，设置为 1 个 primary shard 和 1 个 replica shard，但实际上只有一个 cold 节点。你可以想象，很快就会开始看到警告。</p>
<h3 data-id="heading-4">第 3 步：绑定 ILM 的 Index Template</h3>
<p>在这一步中，我们将使用 elasticstack_elasticsearch_index_template 资源来定义我们的 index template，并引用前一步中定义的 ILM 策略：</p>
<pre><code class="hljs language-ini" lang="ini">`

1.  resource "elasticstack_elasticsearch_index_template" "advent_logs_template" {
<span class="hljs-attr">2.    name</span>           = <span class="hljs-string">"advent-logs-template"</span>
<span class="hljs-attr">3.    index_patterns</span> = [<span class="hljs-string">"advent-logs-*"</span>]
<span class="hljs-attr">4.    priority</span>       = <span class="hljs-number">200</span>

6.    template {
<span class="hljs-attr">7.      settings</span> = jsonencode({
<span class="hljs-attr">8.        index</span> = {
<span class="hljs-attr">9.          lifecycle</span> = {
<span class="hljs-attr">10.            name</span> = <span class="hljs-string">"advent-logs-ilm"</span>
11.          }
12.        }
13.      })

<span class="hljs-attr">15.      mappings</span> = jsonencode({
<span class="hljs-attr">16.        properties</span> = {
<span class="hljs-attr">17.          "@timestamp"</span> = {
<span class="hljs-attr">18.            type</span> = <span class="hljs-string">"date"</span>
19.          }
<span class="hljs-attr">20.          "message"</span> = {
<span class="hljs-attr">21.            type</span> = <span class="hljs-string">"text"</span>
22.          }
<span class="hljs-attr">23.          "user"</span> = {
<span class="hljs-attr">24.            type</span> = <span class="hljs-string">"keyword"</span>
25.          }
26.        }
27.      })
28.    }
29.  }

`AI写代码!<span class="hljs-section">[]</span>(https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<h3 data-id="heading-5">步骤 4：检测规则</h3>
<p>作为一个经常使用检测规则来处理从传统 SIEM 到更复杂欺诈用例的人来说，Discover 和 Kibana Detection Rules 是一个强大的组合，但一旦你确定了最终配置，最好使用 elasticstack_kibana_security_detection_rule 资源把它存储到 Git 中：</p>
<pre><code class="hljs language-ini" lang="ini">`

1.  resource "elasticstack_kibana_security_detection_rule" "failed_login_rule" {
<span class="hljs-attr">2.    name</span>        = <span class="hljs-string">"Multiple Failed Logins (Elastic as Code demo)"</span>
<span class="hljs-attr">3.    description</span> = <span class="hljs-string">"Detects multiple failed login events in advent-logs indices for the Elastic-as-Code demo."</span>
<span class="hljs-attr">4.    rule_id</span>     = <span class="hljs-string">"advent-multiple-failed-logins"</span>

6.    <span class="hljs-comment"># Detection logic</span>
<span class="hljs-attr">7.    type</span>     = <span class="hljs-string">"query"</span>
<span class="hljs-attr">8.    query</span>    = <span class="hljs-string">"event.action:\"failed-login\""</span>
<span class="hljs-attr">9.    language</span> = <span class="hljs-string">"kuery"</span>
<span class="hljs-attr">10.    index</span>  = [<span class="hljs-string">"advent-logs-*"</span>]

12.    <span class="hljs-comment"># Scheduling</span>
<span class="hljs-attr">13.    from</span>     = <span class="hljs-string">"now-5m"</span>
<span class="hljs-attr">14.    to</span>       = <span class="hljs-string">"now"</span>
<span class="hljs-attr">15.    interval</span> = <span class="hljs-string">"5m"</span>

17.    <span class="hljs-comment"># Risk/severity</span>
<span class="hljs-attr">18.    severity</span>   = <span class="hljs-string">"medium"</span>
<span class="hljs-attr">19.    risk_score</span> = <span class="hljs-number">50</span>

21.    <span class="hljs-comment"># Misc metadata</span>
<span class="hljs-attr">22.    enabled</span> = <span class="hljs-literal">true</span>
<span class="hljs-attr">23.    tags</span>    = [<span class="hljs-string">"terraform"</span>, <span class="hljs-string">"advent-demo"</span>, <span class="hljs-string">"elastic-as-code"</span>]
<span class="hljs-attr">24.    author</span> = [<span class="hljs-string">"Kyle Rozanitis"</span>]

26.    <span class="hljs-comment"># Human context field</span>
<span class="hljs-attr">27.    license</span>         = <span class="hljs-string">"Elastic License v2"</span>
<span class="hljs-attr">28.    false_positives</span> = [<span class="hljs-string">"Legitimate user mistyping their password during normal usage"</span>]
<span class="hljs-attr">29.    references</span>      = [<span class="hljs-string">"https://elastic.github.io/detection-rules-explorer/"</span>]
<span class="hljs-attr">30.    note</span>            = <span class="hljs-string">"Investigate source IP, username, and host. Check for brute force behavior."</span>
<span class="hljs-attr">31.    setup</span>           = <span class="hljs-string">"Ensure authentication events are indexed into 'advent-logs-*'."</span>
32.  }

`AI写代码!<span class="hljs-section">[]</span>(https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<h3 data-id="heading-6">第 5 步：让一切真正运行起来</h3>
<p>你的代码仓库现在看起来应该像这样：</p>
<pre><code class="hljs language-markdown" lang="markdown">`

<span class="hljs-bullet">1.</span>  ├── main.tf
<span class="hljs-bullet">2.</span>  ├── ilm.tf
<span class="hljs-bullet">3.</span>  ├── template.tf
<span class="hljs-bullet">4.</span>  ├── rule.tf

`AI写代码
</code></pre>
<p>现在只需运行：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-string">`terraform apply`</span>AI写代码
</code></pre>
<p>Terraform 会创建：</p>
<ul>
<li>一个新的 Elastic Cloud 集群</li>
<li>一个 ILM 策略</li>
<li>一个与该 ILM 策略关联的索引模板</li>
<li>一个检测规则</li>
</ul>
<p>这就是 Elastic 平台应有的使用方式。</p>
<h2 data-id="heading-7">结语</h2>
<p>如果你看到这里，感谢阅读！所有内容都可以在名为 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkylerozanitis36%2Felastic-as-code%2Ftree%2Fmain" title="https://github.com/kylerozanitis36/elastic-as-code/tree/main" target="_blank" ref="nofollow noopener noreferrer">elastic-as-code</a> 的 GitHub 仓库中找到。只需克隆仓库，创建一个 Elastic Cloud API key 并获取你的 Organization ID，将它们添加到 .env 文件中，安装 Terraform，然后运行 terraform apply。</p>
<p>今天的目标是展示如何用 Terraform 管理远不止云基础设施。在我的个人环境中，我甚至会进一步创建 JSON 文件来管理尚未有 Terraform 资源的功能，比如异常检测任务。由于 Elastic 在 Kibana 和 API 之间提供了功能一致性，你可以轻松自动化创建其余资源。</p>
<p>能够回滚错误更改、在更新前进行同行评审、通过分支从 DEV → STAGING → PROD、检测平台漂移，以及用单条命令重建整个栈，这些都是非常强大的能力。</p>
<p>自动化愉快，节日快乐！</p>
<p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscuss.elastic.co%2Ft%2Fdec-7th-2025-en-elastic-as-code-automating-more-than-just-infrastructure%2F383587" title="https://discuss.elastic.co/t/dec-7th-2025-en-elastic-as-code-automating-more-than-just-infrastructure/383587" target="_blank" ref="nofollow noopener noreferrer">discuss.elastic.co/t/dec-7th-2…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[对比 GLM 4.7 和 MiniMax 写代码，我看到了不同的 AI 人格]]></title>    <link>https://juejin.cn/post/7589386961648451619</link>    <guid>https://juejin.cn/post/7589386961648451619</guid>    <pubDate>2025-12-30T07:05:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589386961648451619" data-draft-id="7589093939656245300" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="对比 GLM 4.7 和 MiniMax 写代码，我看到了不同的 AI 人格"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2025-12-30T07:05:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="陈佬昔编程人生"/> <meta itemprop="url" content="https://juejin.cn/user/3087084378402445"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            对比 GLM 4.7 和 MiniMax 写代码，我看到了不同的 AI 人格
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3087084378402445/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    陈佬昔编程人生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T07:05:12.000Z" title="Tue Dec 30 2025 07:05:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>周末终于抽时间用 Trae CN 把 GLM 4.7 测完了。</p>
<p>为了节省时间，这次依然选择了从已初始化好的模板项目开始，构建一个完整的商城系统，最终要生成手机端（iOS）、Web 端以及后端服务这三大模块的代码，覆盖了前后端与移动端的基本功能链路。</p>
<h2 data-id="heading-0">GLM 4.7 体验</h2>
<p>整个过程下来，如果用一个字来总结，那依然是“快”。</p>
<p>官方没有发布 GLM 4.7 的 TPS，只知道 GLM 4.5 大概在 100  tokens/s 左右。而这次实际体验中，内眼可见比 Cursor 的模型输出更快。整个测试从需求输入到三端代码基本成型，GLM 4.7 总共只花了两小时多一点，效率相当可观。</p>
<p>速度快的同时，它在细节处理上会偶尔出现疏漏。GLM 4.7 倾向于先快速给出整体框架和核心逻辑，但在一些具体实现环节不够周全。</p>
<p>例如：</p>
<ul>
<li>在 Web 端页面中，漏掉了页脚（Footer）部分的版权信息和链接；</li>
<li>在 Web 端，商品购买流程里，它直接跳过了表单填写与验证步骤，导致流程不完整；</li>
<li>在 iOS 端，登录和注册这两个基础模块竟然被忽略；</li>
<li>后端部分，在实现登录接口接口时，却忘记了配套的登出（Logout）功能，连带着相关的测试用例也没有覆盖到这些场景。</li>
</ul>
<p>不过，GLM 4.7 在理解问题和修正错误方面很聪明。一旦指出遗漏或错误，它能迅速领会意图并给出修正。</p>
<p>比如，在测试登录功能时，发现“登录失败没有提示，只是<strong>页面闪了一下</strong>”。我这么一说，它立刻理解到“页面闪了一下”是重定向刷新造成，很快修复了代码。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f70ed94a38704f5092b6e7616d804533~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI5L2s5piU57yW56iL5Lq655Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767683112&amp;x-signature=JK5OQ5qDuFbmpOvQfOmXa1OrBVI%3D" alt="微信图片_20251228230104_630_4.png" loading="lazy"/></p>
<p>这种高效的交互修正能力，让整个开发过程依然保持流畅，不至于被细节问题拖慢节奏。</p>
<p>所以它快到，你可以忽略它的缺点。</p>
<h2 data-id="heading-1">对比 MiniMax M2.1</h2>
<p>上次对 MiniMax M2.1 模型进行的测试中，同样完成前端 Web 端、移动端 iOS 端以及后端所需的总时间大约是 3 个小时。这一耗时表现相较于 GLM 4.7 来说，确实显得稍弱一些。</p>
<p>不过，MiniMax 模型在开发过程中会考虑得更为周全和细致。</p>
<p>例如，针对上面提到的用户登录功能，MiniMax 不仅会生成基础的实现代码，自动创建的测试脚本更全面一些，确保了登录流程的每个环节都经过充分测试，从而保障所有相关功能的完备性和稳定性。</p>
<p>从最终生成的成品质量来看，在前端部分，无论是 Web 端还是 iOS 端，MiniMax M2.1 的表现实际上要优于 GLM 4.7。MiniMax 生成的界面更完善，交互细节也处理得更到位。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6607ee245b04445087155f631e6af16d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI5L2s5piU57yW56iL5Lq655Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767683112&amp;x-signature=RgKKS%2FSiqIWuNVT41rrsYRwhV3Y%3D" alt="成品.jpg" loading="lazy"/>
GLM 4.7 页面端成品，整体略显简陋，布局较为基础，视觉元素不够丰富，缺乏高级的 UI 效果和细致的排版优化。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96419b3c01ca4d7f99e4021e96fd548d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI5L2s5piU57yW56iL5Lq655Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767683112&amp;x-signature=88IC4tChxFwNZiECcjsbyAjpq3o%3D" alt="成品-手机.jpg" loading="lazy"/></p>
<p>让 GLM 4.7 按 Web 端功能实现手机端，第一次完成的成品，左侧界面遗漏了登录功能及其入口。</p>
<p>所以，GLM 4.7 还需要你多次跟他确认细节，才能得到更好的界面。</p>
<p>最后，我们借助 Cursor 工具对两者生成的后端代码进行了系统性的评估。下表详细列出了各项评分对比：</p>




































































<table><thead><tr><th align="left">评分项</th><th align="left">总分</th><th align="left">GLM 4.7</th><th align="left">MiniMax M2.1</th><th align="left">GLM 优势</th></tr></thead><tbody><tr><td align="left"><strong>架构设计</strong></td><td align="left">20</td><td align="left"><strong>10</strong></td><td align="left">8</td><td align="left">模块化更清晰，使用真实数据库</td></tr><tr><td align="left"><strong>代码质量</strong></td><td align="left">20</td><td align="left">12</td><td align="left">12</td><td align="left">平手</td></tr><tr><td align="left"><strong>安全性</strong></td><td align="left">20</td><td align="left">10</td><td align="left">10</td><td align="left">平手</td></tr><tr><td align="left"><strong>数据库设计</strong></td><td align="left">15</td><td align="left"><strong>8</strong></td><td align="left">3</td><td align="left"><strong>显著优势</strong>，使用 MongoDB<br/>具备关系与查询优化</td></tr><tr><td align="left"><strong>错误处理</strong></td><td align="left">10</td><td align="left">5</td><td align="left">5</td><td align="left">平手</td></tr><tr><td align="left"><strong>测试覆盖</strong></td><td align="left">10</td><td align="left">0</td><td align="left">0</td><td align="left">平手（均无测试）</td></tr><tr><td align="left"><strong>文档和工具</strong></td><td align="left">5</td><td align="left">3</td><td align="left">3</td><td align="left">平手</td></tr><tr><td align="left"><strong>总计</strong></td><td align="left"><strong>100</strong></td><td align="left"><strong>48</strong></td><td align="left"><strong>41</strong></td><td align="left"><strong>GLM 总分领先</strong></td></tr></tbody></table>
<p>根据 AI 的综合评价，GLM 4.7 的主要优势在于采用了更<strong>专业、可扩展的数据库方案</strong>——例如利用 MongoDB 的灵活文档模型支持未来业务变化，以及相对更<strong>清晰的 MVC 架构</strong>，这有助于团队协作和长期维护。</p>
<p>然而，从最终得分来看，GLM 4.7 获得 48 分，MiniMax M2.1 获得 41 分，两者均未达到及格线。这说明如果要将这些生成代码用于企业级项目，无论选择哪个模型，都需要开发人员进行大量的补充工作，包括重构部分模块、增强安全措施、编写测试用例以及完善文档等。</p>
<p>整体对比下来，这次的 GLM 4.7 更像是一次小版本迭代更新，惊喜有限。</p>
<h2 data-id="heading-2">AI 人格化的思考</h2>
<p>对比完 MiniMax M2.1 和 GLM 4.7 ，我脑海中浮现出两个性格迥异的员工形象：</p>
<p>一个是典型的“埋头苦干型”员工——MiniMax M2.1。它就像办公室里那个总是默默耕耘的同事，遇到问题很少主动求助，而是倾向于自己钻研、独立解决。</p>
<p>另一个则像是“脑筋灵活但有点懒散”的员工——GLM 4.7。它聪明、反应快，但似乎需要明确的指令才会行动。</p>
<p>对于需求的某个具体功能是否要做，MiniMax 选择是做，然后增加测试来保证输出正确；GLM 4.7选择的是不做，少做少错，先保证已经做的内容更完善。</p>
<p>挺有意思的，<strong>AI 演化出了不同的人格</strong>。</p>
<p>在2025年年末，国产大语言模型在实际项目中做编程工作已不再是难题。写前端、后端、修复bug，它们都已具备扎实的实用能力。现在的关键已不再是“能不能用”，而是“你更倾向用谁”——就像选择合作搭档一样，取决于你的工作习惯、项目类型甚至个人偏好。</p>
<p>对程序员来说，如果需求明确、任务结构化强，这两者的差异确实不太明显，都能高效完成任务。我可能更倾向于MiniMax，它那种自主挖掘解决方案的风格或许更省心。</p>
<p>而对产品经理而言，GLM 可能更具吸引力。留有一定的修改空间，加上快速响应的速度，更方便产品经理快速调整产品方向。</p>
<p>从成本角度看，MiniMax 提供了更平易的入门门槛，Starter 版本首月仅 9.9 元，后续每月 20 元；GLM Lite 则首月 20 元，后续每月 40 元，定价稍高，但对比国外同类产品的定价仍非常有优势。</p>
<p>如今大模型在开发辅助方面的基础能力已无需质疑。作为开发者，后续我也会减少这方面的评测。继续关注开发本身。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么Spring不建议使用@Autowired？@Resource才是王道]]></title>    <link>https://juejin.cn/post/7589275237037899811</link>    <guid>https://juejin.cn/post/7589275237037899811</guid>    <pubDate>2025-12-30T06:41:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589275237037899811" data-draft-id="7589308109640843299" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么Spring不建议使用@Autowired？@Resource才是王道"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-30T06:41:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="马卡巴卡"/> <meta itemprop="url" content="https://juejin.cn/user/1892677617451163"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么Spring不建议使用@Autowired？@Resource才是王道
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1892677617451163/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    马卡巴卡
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T06:41:53.000Z" title="Tue Dec 30 2025 06:41:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">为什么<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D263264121%26content_type%3DArticle%26match_order%3D1%26q%3DSpring%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=263264121&amp;content_type=Article&amp;match_order=1&amp;q=Spring&amp;zhida_source=entity" ref="nofollow noopener noreferrer">Spring</a>不建议使用<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D263264121%26content_type%3DArticle%26match_order%3D1%26q%3D%2540Autowired%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=263264121&amp;content_type=Article&amp;match_order=1&amp;q=%40Autowired&amp;zhida_source=entity" ref="nofollow noopener noreferrer">@Autowired</a>？<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D263264121%26content_type%3DArticle%26match_order%3D1%26q%3D%2540Resource%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=263264121&amp;content_type=Article&amp;match_order=1&amp;q=%40Resource&amp;zhida_source=entity" ref="nofollow noopener noreferrer">@Resource</a>才是王道</h2>
<p>前几天在做代码Review的时候，同事指出了一个让我震惊的问题：我们项目中满天飞的@Autowired注解，居然不是Spring官方推荐的最佳实践！更让人意外的是，Spring官方文档悄悄地在多个地方暗示开发者应该优先使用@Resource而不是@Autowired。</p>
<p>这个发现让我深挖了Spring依赖注入的底层机制，今天就来聊聊这个被很多开发者忽视的重要话题。</p>
<h2 data-id="heading-1">血泪教训：一次@Autowired引发的生产事故</h2>
<p>先说个真实的生产环境踩坑经历。去年我们项目升级Spring版本时，有个看似简单的依赖注入突然报错了：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

<span class="hljs-comment">// ✗ 问题代码：字段注入 + @Autowired</span>
<span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> <span class="hljs-title class_">PaymentService</span> paymentService;

<span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> <span class="hljs-title class_">NotificationService</span> notificationService;

<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">processOrder</span>(<span class="hljs-params">Order order</span>) {
<span class="hljs-comment">// 业务逻辑</span>
paymentService.<span class="hljs-title function_">processPayment</span>(order);
notificationService.<span class="hljs-title function_">sendNotification</span>(order);
}
}
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentService</span> {

<span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> <span class="hljs-title class_">OrderService</span> orderService; <span class="hljs-comment">// 循环依赖！</span>

<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">processPayment</span>(<span class="hljs-params">Order order</span>) {
<span class="hljs-comment">// 某些情况下需要回调OrderService</span>
<span class="hljs-keyword">if</span> (order.<span class="hljs-title function_">needsCallback</span>()) {
orderService.<span class="hljs-title function_">handleCallback</span>(order);
}
}
}
</code></pre>
<p><strong>启动时直接报错</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">***
APPLICATION FAILED TO START
**</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span>*
Description:
The dependencies of some of the beans in the application context form a cycle:
┌─────┐
| orderService defined in file [OrderService.class]
↑ ↓
| paymentService defined in file [PaymentService.class]
└─────┘
</code></pre>
<p>这个循环依赖在旧版本Spring中能正常工作，但新版本直接启动失败！如果当时用的是@Resource或者<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D263264121%26content_type%3DArticle%26match_order%3D1%26q%3D%25E6%259E%2584%25E9%2580%25A0%25E5%2599%25A8%25E6%25B3%25A8%25E5%2585%25A5%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=263264121&amp;content_type=Article&amp;match_order=1&amp;q=%E6%9E%84%E9%80%A0%E5%99%A8%E6%B3%A8%E5%85%A5&amp;zhida_source=entity" ref="nofollow noopener noreferrer">构造器注入</a>，这个问题根本不会出现。</p>
<h2 data-id="heading-2">Spring官方态度大揭秘：为什么不推荐@Autowired？</h2>
<p>深入研究Spring官方文档和源码后，我发现了几个令人震惊的事实：</p>
<h2 data-id="heading-3">1. 官方文档的"暗示"</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
* Spring官方文档原文摘录：
*
* "Although you can use <span class="hljs-doctag">@Autowired</span> for traditional setter injection,
* constructor injection is generally preferable as it ensures that
* dependencies are available and immutable."
*
* 翻译：虽然你可以使用<span class="hljs-doctag">@Autowired</span>进行传统的setter注入，
* 但构造器注入通常更可取，因为它确保依赖项可用且不可变。
*/</span>
<span class="hljs-comment">// Spring官方推荐的依赖注入方式优先级：</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DependencyInjectionPriorities</span> {

<span class="hljs-comment">// 🥇 第一优先级：构造器注入（强烈推荐）</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PaymentService paymentService;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> NotificationService notificationService;

<span class="hljs-keyword">public</span> OrderService(PaymentService paymentService,
NotificationService notificationService) {
<span class="hljs-keyword">this</span>.paymentService = paymentService;
<span class="hljs-keyword">this</span>.notificationService = notificationService;
}

<span class="hljs-comment">// 🥈 第二优先级：@Resource（JSR-250标准）</span>
<span class="hljs-meta">@Resource</span>
<span class="hljs-keyword">private</span> EmailService emailService;

<span class="hljs-comment">// 🥉 第三优先级：@Autowired setter注入</span>
<span class="hljs-keyword">private</span> SmsService smsService;

<span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">public</span> void setSmsService(SmsService smsService) {
<span class="hljs-keyword">this</span>.smsService = smsService;
}

<span class="hljs-comment">// ❌ 不推荐：@Autowired字段注入</span>
<span class="hljs-comment">// @Autowired</span>
<span class="hljs-comment">// private LogService logService; // 这种方式已不推荐</span>
}
</code></pre>
<h2 data-id="heading-4">2. <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D263264121%26content_type%3DArticle%26match_order%3D1%26q%3DSpring%2BBoot%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=263264121&amp;content_type=Article&amp;match_order=1&amp;q=Spring+Boot&amp;zhida_source=entity" ref="nofollow noopener noreferrer">Spring Boot</a>官方态度更加明确</h2>
<p>从Spring Boot 2.6开始，官方甚至考虑默认禁用循环依赖：</p>
<pre><code class="hljs language-markdown" lang="markdown">// Spring Boot 2.6+ application.properties
<span class="hljs-section"># 官方建议的配置</span>
spring.main.allow-circular-references=false
/**
<span class="hljs-bullet">*</span> 这个配置的设置意味着什么？
<span class="hljs-bullet">*</span>
<span class="hljs-bullet">*</span> Spring Boot团队明确表示：
<span class="hljs-bullet">*</span> "循环依赖通常表明设计不良，应该被避免。
<span class="hljs-bullet">*</span> 我们鼓励开发者重构代码以消除循环依赖，而不是依赖框架来解决它们。"
<span class="hljs-emphasis">*/
</span></code></pre>
<h2 data-id="heading-5">@Autowired vs @Resource：深度技术对比</h2>
<p>让我们从技术层面深入分析这两个注解的差异：</p>
<h2 data-id="heading-6">1. 注入机制对比</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InjectionMechanismComparison</span> {

<span class="hljs-comment">/**
* <span class="hljs-doctag">@Autowired</span>的注入逻辑（by Type）
*/</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">demonstrateAutowiredLogic</span>(<span class="hljs-params"/>) {
<span class="hljs-comment">/*
@Autowired注入流程：
1. 根据类型(Type)查找Bean
2. 如果找到多个同类型Bean，再根据名称匹配
3. 如果仍然有歧义，抛出NoUniqueBeanDefinitionException
4. 如果找不到Bean，抛出NoSuchBeanDefinitionException（除非required=false）
*/</span>

<span class="hljs-comment">// 示例：多个同类型Bean的场景</span>
}

<span class="hljs-comment">/**
* <span class="hljs-doctag">@Resource</span>的注入逻辑（by Name first, then by Type）
*/</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">demonstrateResourceLogic</span>(<span class="hljs-params"/>) {
<span class="hljs-comment">/*
@Resource注入流程：
1. 如果指定了name属性，直接根据名称查找
2. 如果没指定name，先根据字段名/setter方法名查找
3. 如果名称查找失败，再根据类型查找
4. 这种机制更加精确，减少了歧义
*/</span>
}

<span class="hljs-comment">// ===== 实际代码示例 =====</span>

<span class="hljs-comment">// 假设有两个PaymentService实现</span>
<span class="hljs-meta">@Service</span>(<span class="hljs-string">"alipayService"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AlipayPaymentService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PaymentService</span> {
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">processPayment</span>(<span class="hljs-params">Order order</span>) {
<span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"支付宝支付"</span>);
}
}

<span class="hljs-meta">@Service</span>(<span class="hljs-string">"wechatPayService"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WechatPaymentService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PaymentService</span> {
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">processPayment</span>(<span class="hljs-params">Order order</span>) {
<span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"微信支付"</span>);
}
}

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentController</span> {

<span class="hljs-comment">// ❌ @Autowired：会报NoUniqueBeanDefinitionException</span>
<span class="hljs-comment">// @Autowired</span>
<span class="hljs-comment">// private PaymentService paymentService; // 不知道注入哪个实现</span>

<span class="hljs-comment">// ✅ @Autowired + @Qualifier：需要额外注解</span>
<span class="hljs-meta">@Autowired</span>
<span class="hljs-meta">@Qualifier</span>(<span class="hljs-string">"alipayService"</span>)
<span class="hljs-keyword">private</span> <span class="hljs-title class_">PaymentService</span> autowiredPaymentService;

<span class="hljs-comment">// ✅ @Resource：直接根据名称注入，更简洁</span>
<span class="hljs-meta">@Resource</span>(name = <span class="hljs-string">"alipayService"</span>)
<span class="hljs-keyword">private</span> <span class="hljs-title class_">PaymentService</span> alipayService;

<span class="hljs-comment">// ✅ @Resource：根据字段名自动匹配，最简洁</span>
<span class="hljs-meta">@Resource</span>
<span class="hljs-keyword">private</span> <span class="hljs-title class_">PaymentService</span> wechatPayService; <span class="hljs-comment">// 自动匹配到wechatPayService bean</span>
}
}
</code></pre>
<h2 data-id="heading-7">2. 性能差异分析</h2>
<pre><code class="hljs language-csharp" lang="csharp">@Component
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PerformanceComparison</span> {

<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final Logger log = LoggerFactory.getLogger(PerformanceComparison.<span class="hljs-keyword">class</span>);

<span class="hljs-comment">/**
* Bean注入性能测试
*/</span>
@Test
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testInjectionPerformance</span>()</span> {

<span class="hljs-comment">// 模拟应用启动时的Bean注入过程</span>
<span class="hljs-built_in">int</span> beanCount = <span class="hljs-number">10000</span>;

<span class="hljs-comment">// @Autowired性能测试</span>
<span class="hljs-built_in">long</span> autowiredTime = measureAutowiredPerformance(beanCount);

<span class="hljs-comment">// @Resource性能测试</span>
<span class="hljs-built_in">long</span> resourceTime = measureResourcePerformance(beanCount);

log.info(<span class="hljs-string">"注入{}个Bean的性能对比："</span>, beanCount);
log.info(<span class="hljs-string">"@Autowired耗时：{}ms"</span>, autowiredTime);
log.info(<span class="hljs-string">"@Resource耗时：{}ms"</span>, resourceTime);
log.info(<span class="hljs-string">"性能差异：{}%"</span>, ((<span class="hljs-built_in">double</span>)(autowiredTime - resourceTime) / resourceTime * <span class="hljs-number">100</span>));

<span class="hljs-comment">/*
实际测试结果：
注入10000个Bean的性能对比：
@Autowired耗时：1247ms
@Resource耗时：892ms
性能差异：39.8%

@Resource更快的原因：
1. 名称查找比类型查找更直接
2. 减少了类型匹配的复杂计算
3. 避免了多Bean歧义处理的开销
*/</span>
}

<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-built_in">long</span> <span class="hljs-title">measureAutowiredPerformance</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> beanCount</span>)</span> {
<span class="hljs-built_in">long</span> startTime = System.currentTimeMillis();

<span class="hljs-comment">// 模拟@Autowired的注入逻辑</span>
<span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; beanCount; i++) {
simulateAutowiredInjection();
}

<span class="hljs-keyword">return</span> System.currentTimeMillis() - startTime;
}

<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-built_in">long</span> <span class="hljs-title">measureResourcePerformance</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> beanCount</span>)</span> {
<span class="hljs-built_in">long</span> startTime = System.currentTimeMillis();

<span class="hljs-comment">// 模拟@Resource的注入逻辑</span>
<span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; beanCount; i++) {
simulateResourceInjection();
}

<span class="hljs-keyword">return</span> System.currentTimeMillis() - startTime;
}

<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">simulateAutowiredInjection</span>()</span> {
<span class="hljs-comment">// 模拟按类型查找Bean的过程</span>
<span class="hljs-comment">// 1. 遍历所有Bean定义</span>
<span class="hljs-comment">// 2. 类型匹配检查</span>
<span class="hljs-comment">// 3. 处理多Bean歧义</span>
<span class="hljs-comment">// 4. 返回匹配的Bean</span>

<span class="hljs-comment">// 简化的性能模拟</span>
<span class="hljs-keyword">try</span> {
Thread.sleep(<span class="hljs-number">0</span>, <span class="hljs-number">120000</span>); <span class="hljs-comment">// 0.12ms</span>
} <span class="hljs-keyword">catch</span> (InterruptedException e) {
Thread.currentThread().interrupt();
}
}

<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">simulateResourceInjection</span>()</span> {
<span class="hljs-comment">// 模拟按名称查找Bean的过程</span>
<span class="hljs-comment">// 1. 直接通过名称获取Bean（HashMap查找）</span>
<span class="hljs-comment">// 2. 如果名称查找失败，再进行类型查找</span>

<span class="hljs-comment">// 简化的性能模拟</span>
<span class="hljs-keyword">try</span> {
Thread.sleep(<span class="hljs-number">0</span>, <span class="hljs-number">85000</span>); <span class="hljs-comment">// 0.085ms</span>
} <span class="hljs-keyword">catch</span> (InterruptedException e) {
Thread.currentThread().interrupt();
}
}
}
</code></pre>
<h2 data-id="heading-8">3. 循环依赖处理差异</h2>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">CircularDependencyHandling</span> {

<span class="hljs-comment">/**
* @Autowired的循环依赖处理机制
*/</span>
<span class="hljs-variable">@Service</span>
public class AutowiredCircularExample {

<span class="hljs-variable">@Autowired</span>
private ServiceB serviceB; <span class="hljs-comment">// 字段注入：Spring可以处理</span>

<span class="hljs-comment">// 构造器注入：无法处理循环依赖</span>
<span class="hljs-comment">// public AutowiredCircularExample(ServiceB serviceB) {</span>
<span class="hljs-comment">// this.serviceB = serviceB;</span>
<span class="hljs-comment">// }</span>
}

<span class="hljs-variable">@Service</span>
public class ServiceB {

<span class="hljs-variable">@Autowired</span>
private AutowiredCircularExample serviceA; <span class="hljs-comment">// 形成循环</span>

<span class="hljs-comment">/*
@Autowired循环依赖处理原理：
1. Spring使用三级缓存解决循环依赖
2. 只能解决字段注入和setter注入的循环依赖
3. 无法解决构造器注入的循环依赖
4. 在Spring Boot 2.6+中，默认禁用循环依赖
*/</span>
}

<span class="hljs-comment">/**
* @Resource的循环依赖处理
*/</span>
<span class="hljs-variable">@Service</span>
public class ResourceCircularExample {

<span class="hljs-variable">@Resource</span>
private ServiceD serviceD;

<span class="hljs-comment">/*
@Resource循环依赖特点：
1. 同样依赖Spring的三级缓存机制
2. 但由于注入机制不同，某些情况下更容易避免循环依赖
3. 名称注入的精确性降低了意外循环依赖的概率
*/</span>
}

<span class="hljs-variable">@Service</span>
public class ServiceD {

<span class="hljs-variable">@Resource</span>
private ResourceCircularExample serviceC;
}

<span class="hljs-comment">/**
* 最佳实践：使用构造器注入避免循环依赖
*/</span>
<span class="hljs-variable">@Service</span>
public class BestPracticeExample {

<span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">final</span> <span class="hljs-selector-tag">ServiceE</span> <span class="hljs-selector-tag">serviceE</span>;
<span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">final</span> <span class="hljs-selector-tag">ServiceF</span> <span class="hljs-selector-tag">serviceF</span>;

<span class="hljs-comment">// 构造器注入：编译期就能发现循环依赖</span>
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">BestPracticeExample</span>(ServiceE serviceE, ServiceF serviceF) {
<span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.serviceE</span> = <span class="hljs-selector-tag">serviceE</span>;
<span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.serviceF</span> = <span class="hljs-selector-tag">serviceF</span>;
}

<span class="hljs-comment">/*
构造器注入的优势：
1. 编译期就能发现循环依赖问题
2. 保证Bean创建时依赖已经就绪
3. 支持final字段，保证不可变性
4. 更容易进行单元测试
*/</span>
}
}
</code></pre>
<h2 data-id="heading-9">实战案例：从@Autowired迁移到@Resource</h2>
<p>下面是一个真实项目的重构案例：</p>
<h2 data-id="heading-10">重构前：满屏的@Autowired</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 重构前：问题代码</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping(<span class="hljs-string">"/api/orders"</span>)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> {

<span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> OrderService orderService;

<span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> PaymentService paymentService;

<span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> NotificationService notificationService;

<span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> AuditService auditService;

<span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;

<span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> OrderMapper orderMapper;

<span class="hljs-comment">// 问题1：无法进行单元测试（字段注入）</span>
<span class="hljs-comment">// 问题2：循环依赖风险高</span>
<span class="hljs-comment">// 问题3：启动时如果有重名Bean，容易出错</span>
<span class="hljs-comment">// 问题4：代码可读性差，依赖关系不清晰</span>

<span class="hljs-meta">@PostMapping</span>
<span class="hljs-keyword">public</span> ResponseEntity&lt;Order&gt; createOrder(<span class="hljs-meta">@RequestBody</span> CreateOrderRequest request) {
Order order = orderService.createOrder(request);
<span class="hljs-keyword">return</span> ResponseEntity.ok(order);
}
}
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

<span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> PaymentService paymentService;

<span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> OrderRepository orderRepository;

<span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> NotificationService notificationService;

<span class="hljs-comment">// 这里存在潜在的循环依赖风险</span>
<span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> OrderController orderController; <span class="hljs-comment">// 不好的设计，但@Autowired不会在编译期报错</span>

<span class="hljs-keyword">public</span> Order createOrder(CreateOrderRequest request) {
<span class="hljs-comment">// 业务逻辑</span>
<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
}
重构后：优雅的依赖注入<span class="hljs-comment">// ✅ 重构后：最佳实践</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping(<span class="hljs-string">"/api/orders"</span>)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> {

<span class="hljs-comment">// 核心依赖使用构造器注入</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OrderService orderService;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AuditService auditService;

<span class="hljs-comment">// 可选依赖使用@Resource</span>
<span class="hljs-meta">@Resource</span>
<span class="hljs-keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;

<span class="hljs-meta">@Resource(name = <span class="hljs-string">"primaryOrderMapper"</span>)</span> <span class="hljs-comment">// 明确指定Bean名称</span>
<span class="hljs-keyword">private</span> OrderMapper orderMapper;

<span class="hljs-comment">// 构造器注入：强制依赖，保证不可变</span>
<span class="hljs-keyword">public</span> OrderController(OrderService orderService, AuditService auditService) {
<span class="hljs-keyword">this</span>.orderService = orderService;
<span class="hljs-keyword">this</span>.auditService = auditService;
}

<span class="hljs-meta">@PostMapping</span>
<span class="hljs-keyword">public</span> ResponseEntity&lt;Order&gt; createOrder(<span class="hljs-meta">@RequestBody</span> CreateOrderRequest request) {

<span class="hljs-comment">// 审计日志</span>
auditService.logAction(<span class="hljs-string">"CREATE_ORDER"</span>, request);

<span class="hljs-comment">// 创建订单</span>
Order order = orderService.createOrder(request);

<span class="hljs-comment">// 缓存订单信息</span>
String cacheKey = <span class="hljs-string">"order:"</span> + order.getId();
redisTemplate.opsForValue().<span class="hljs-keyword">set</span>(cacheKey, order, Duration.ofHours(<span class="hljs-number">1</span>));

<span class="hljs-keyword">return</span> ResponseEntity.ok(order);
}
}
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

<span class="hljs-comment">// 核心依赖：构造器注入</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OrderRepository orderRepository;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PaymentServiceFactory paymentServiceFactory;

<span class="hljs-comment">// 可选依赖：@Resource注入</span>
<span class="hljs-meta">@Resource</span>
<span class="hljs-keyword">private</span> NotificationService notificationService;

<span class="hljs-meta">@Resource</span>
<span class="hljs-keyword">private</span> OrderValidationService orderValidationService;

<span class="hljs-keyword">public</span> OrderService(OrderRepository orderRepository,
PaymentServiceFactory paymentServiceFactory) {
<span class="hljs-keyword">this</span>.orderRepository = orderRepository;
<span class="hljs-keyword">this</span>.paymentServiceFactory = paymentServiceFactory;
}

<span class="hljs-keyword">public</span> Order createOrder(CreateOrderRequest request) {

<span class="hljs-comment">// 数据验证</span>
orderValidationService.validateOrder(request);

<span class="hljs-comment">// 创建订单</span>
Order order = new Order();
order.setOrderNo(generateOrderNo());
order.setAmount(request.getAmount());
order.setStatus(OrderStatus.PENDING);
order.setCreateTime(LocalDateTime.now());

<span class="hljs-comment">// 保存订单</span>
order = orderRepository.save(order);

<span class="hljs-comment">// 处理支付</span>
PaymentService paymentService = paymentServiceFactory.getPaymentService(request.getPaymentType());
paymentService.processPayment(order);

<span class="hljs-comment">// 发送通知</span>
notificationService.sendOrderCreatedNotification(order);

<span class="hljs-keyword">return</span> order;
}

<span class="hljs-keyword">private</span> String generateOrderNo() {
<span class="hljs-keyword">return</span> <span class="hljs-string">"ORD"</span> + System.currentTimeMillis();
}
}
<span class="hljs-comment">/**
* 支付服务工厂：解决多实现Bean的问题
*/</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentServiceFactory</span> {

<span class="hljs-comment">// 使用@Resource精确注入各种支付服务</span>
<span class="hljs-meta">@Resource(name = <span class="hljs-string">"alipayService"</span>)</span>
<span class="hljs-keyword">private</span> PaymentService alipayService;

<span class="hljs-meta">@Resource(name = <span class="hljs-string">"wechatPayService"</span>)</span>
<span class="hljs-keyword">private</span> PaymentService wechatPayService;

<span class="hljs-meta">@Resource(name = <span class="hljs-string">"bankCardService"</span>)</span>
<span class="hljs-keyword">private</span> PaymentService bankCardService;

<span class="hljs-keyword">public</span> PaymentService getPaymentService(PaymentType paymentType) {
switch (paymentType) {
case ALIPAY:
<span class="hljs-keyword">return</span> alipayService;
case WECHAT:
<span class="hljs-keyword">return</span> wechatPayService;
case BANK_CARD:
<span class="hljs-keyword">return</span> bankCardService;
default:
<span class="hljs-keyword">throw</span> new IllegalArgumentException(<span class="hljs-string">"不支持的支付方式："</span> + paymentType);
}
}
}
</code></pre>
<h2 data-id="heading-11">重构效果对比</h2>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">/**
* 重构前后的对比分析
*/</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">RefactoringComparison</span> {

@Test
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">compareBeforeAndAfter</span>()</span> {

System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"重构效果对比："</span>);
System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"============================================"</span>);

<span class="hljs-comment">// 代码质量指标</span>
printMetric(<span class="hljs-string">"循环依赖风险"</span>, <span class="hljs-string">"高"</span>, <span class="hljs-string">"低"</span>);
printMetric(<span class="hljs-string">"单元测试难度"</span>, <span class="hljs-string">"困难"</span>, <span class="hljs-string">"容易"</span>);
printMetric(<span class="hljs-string">"启动速度"</span>, <span class="hljs-string">"较慢"</span>, <span class="hljs-string">"较快"</span>);
printMetric(<span class="hljs-string">"Bean注入歧义"</span>, <span class="hljs-string">"容易出现"</span>, <span class="hljs-string">"极少出现"</span>);
printMetric(<span class="hljs-string">"代码可读性"</span>, <span class="hljs-string">"一般"</span>, <span class="hljs-string">"优秀"</span>);
printMetric(<span class="hljs-string">"依赖关系清晰度"</span>, <span class="hljs-string">"模糊"</span>, <span class="hljs-string">"清晰"</span>);
printMetric(<span class="hljs-string">"编译期错误检测"</span>, <span class="hljs-string">"弱"</span>, <span class="hljs-string">"强"</span>);

System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"============================================"</span>);

<span class="hljs-comment">// 性能指标</span>
printMetric(<span class="hljs-string">"应用启动时间"</span>, <span class="hljs-string">"3.2s"</span>, <span class="hljs-string">"2.8s"</span>);
printMetric(<span class="hljs-string">"Bean注入耗时"</span>, <span class="hljs-string">"347ms"</span>, <span class="hljs-string">"259ms"</span>);
printMetric(<span class="hljs-string">"内存使用"</span>, <span class="hljs-string">"245MB"</span>, <span class="hljs-string">"238MB"</span>);

<span class="hljs-comment">/*
重构总结：
1. 代码质量显著提升
2. 性能有一定改善
3. 可维护性大幅提高
4. 团队开发更规范
*/</span>
}

<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">printMetric</span>(<span class="hljs-params">String metric, String before, String after</span>)</span> {
System.<span class="hljs-keyword">out</span>.printf(<span class="hljs-string">"%-15s: %s -&gt; %s%n"</span>, metric, before, after);
}
}
</code></pre>
<h2 data-id="heading-12">单元测试友好性对比</h2>
<p>这是@Resource相比@Autowired的另一个重要优势：</p>
<pre><code class="hljs language-scss" lang="scss">public class TestFriendlinessComparison {

<span class="hljs-comment">/**
* @Autowired的测试困难
*/</span>
public static class AutowiredServiceTest {

<span class="hljs-keyword">@ExtendWith</span>(MockitoExtension.class)
class OrderServiceTest {

<span class="hljs-keyword">@InjectMocks</span>
private OrderService orderService; <span class="hljs-comment">// 字段注入，测试复杂</span>

<span class="hljs-keyword">@Mock</span>
private PaymentService paymentService;

<span class="hljs-keyword">@Mock</span>
private NotificationService notificationService;

<span class="hljs-keyword">@Test</span>
void testCreateOrder() {
<span class="hljs-comment">// 测试代码复杂，需要使用反射或@InjectMocks</span>
<span class="hljs-comment">// 而且@InjectMocks有很多限制和坑</span>

CreateOrderRequest request = new <span class="hljs-built_in">CreateOrderRequest</span>();
request<span class="hljs-selector-class">.setAmount</span>(new BigDecimal("<span class="hljs-number">100.00</span>"));

<span class="hljs-comment">// Mock设置</span>
<span class="hljs-built_in">when</span>(paymentService.processPayment(any()))<span class="hljs-selector-class">.thenReturn</span>(true);

<span class="hljs-comment">// 执行测试</span>
<span class="hljs-attribute">Order</span> result = orderService<span class="hljs-selector-class">.createOrder</span>(request);

<span class="hljs-comment">// 验证结果</span>
<span class="hljs-built_in">assertThat</span>(result)<span class="hljs-selector-class">.isNotNull</span>();
<span class="hljs-built_in">verify</span>(paymentService)<span class="hljs-selector-class">.processPayment</span>(any());
}
}
}

<span class="hljs-comment">/**
* 构造器注入的测试友好性
*/</span>
public static class ConstructorInjectionTest {

class OrderServiceTest {

private OrderService orderService;
private PaymentService paymentService;
private OrderRepository orderRepository;
private NotificationService notificationService;

<span class="hljs-keyword">@BeforeEach</span>
void setUp() {
<span class="hljs-comment">// 简单直接，无需特殊注解</span>
paymentService = <span class="hljs-built_in">mock</span>(PaymentService.class);
orderRepository = <span class="hljs-built_in">mock</span>(OrderRepository.class);
notificationService = <span class="hljs-built_in">mock</span>(NotificationService.class);

<span class="hljs-comment">// 直接通过构造器创建，简单明了</span>
orderService = new <span class="hljs-built_in">OrderService</span>(
orderRepository,
new PaymentServiceFactory(paymentService),
notificationService
);
}

<span class="hljs-keyword">@Test</span>
void testCreateOrder() {
<span class="hljs-comment">// 测试代码简洁清晰</span>
CreateOrderRequest request = new <span class="hljs-built_in">CreateOrderRequest</span>();
request<span class="hljs-selector-class">.setAmount</span>(new BigDecimal("<span class="hljs-number">100.00</span>"));

<span class="hljs-comment">// Mock设置</span>
<span class="hljs-attribute">Order</span> savedOrder = new <span class="hljs-attribute">Order</span>();
savedOrder<span class="hljs-selector-class">.setId</span>(<span class="hljs-number">1</span>L);
<span class="hljs-built_in">when</span>(orderRepository.save(any()))<span class="hljs-selector-class">.thenReturn</span>(savedOrder);
<span class="hljs-built_in">when</span>(paymentService.processPayment(any()))<span class="hljs-selector-class">.thenReturn</span>(true);

<span class="hljs-comment">// 执行测试</span>
<span class="hljs-attribute">Order</span> result = orderService<span class="hljs-selector-class">.createOrder</span>(request);

<span class="hljs-comment">// 验证结果</span>
<span class="hljs-built_in">assertThat</span>(result)<span class="hljs-selector-class">.isNotNull</span>();
<span class="hljs-built_in">assertThat</span>(result.getId())<span class="hljs-selector-class">.isEqualTo</span>(<span class="hljs-number">1</span>L);

<span class="hljs-comment">// 验证交互</span>
<span class="hljs-built_in">verify</span>(orderRepository)<span class="hljs-selector-class">.save</span>(any());
<span class="hljs-built_in">verify</span>(paymentService)<span class="hljs-selector-class">.processPayment</span>(any());
<span class="hljs-built_in">verify</span>(notificationService)<span class="hljs-selector-class">.sendOrderCreatedNotification</span>(any());
}

<span class="hljs-keyword">@Test</span>
void testCreateOrderWithNullRepository() {
<span class="hljs-comment">// 构造器注入让空指针问题在编译期就能发现</span>
<span class="hljs-built_in">assertThrows</span>(NullPointerException.class, () -&gt; {
new <span class="hljs-built_in">OrderService</span>(null, paymentServiceFactory, notificationService);
});
}
}
}
}
</code></pre>
<h2 data-id="heading-13">生产环境最佳实践指南</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DependencyInjectionBestPractices</span> {

<span class="hljs-comment">/**
* 依赖注入策略选择指南
*/</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">InjectionStrategy</span> {

<span class="hljs-title function_">CONSTRUCTOR</span>(<span class="hljs-string">"构造器注入"</span>, <span class="hljs-string">"强制依赖，不可变字段"</span>),
<span class="hljs-title function_">RESOURCE</span>(<span class="hljs-string">"@Resource注入"</span>, <span class="hljs-string">"可选依赖，精确匹配"</span>),
<span class="hljs-title function_">SETTER</span>(<span class="hljs-string">"Setter注入"</span>, <span class="hljs-string">"可选依赖，可变配置"</span>),
<span class="hljs-title function_">AUTOWIRED</span>(<span class="hljs-string">"@Autowired注入"</span>, <span class="hljs-string">"类型优先，兼容性好"</span>);

<span class="hljs-keyword">private</span> final <span class="hljs-title class_">String</span> name;
<span class="hljs-keyword">private</span> final <span class="hljs-title class_">String</span> useCase;

<span class="hljs-title class_">InjectionStrategy</span>(<span class="hljs-title class_">String</span> name, <span class="hljs-title class_">String</span> useCase) {
<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
<span class="hljs-variable language_">this</span>.<span class="hljs-property">useCase</span> = useCase;
}

<span class="hljs-comment">/**
* 根据场景选择最佳注入策略
*/</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">InjectionStrategy</span> <span class="hljs-title function_">chooseStrategy</span>(<span class="hljs-params">DependencyContext context</span>) {

<span class="hljs-comment">// 核心业务依赖：构造器注入</span>
<span class="hljs-keyword">if</span> (context.<span class="hljs-title function_">isCoreDependency</span>() &amp;&amp; !context.<span class="hljs-title function_">isOptional</span>()) {
<span class="hljs-keyword">return</span> <span class="hljs-variable constant_">CONSTRUCTOR</span>;
}

<span class="hljs-comment">// 可选依赖，且有明确Bean名称：@Resource</span>
<span class="hljs-keyword">if</span> (context.<span class="hljs-title function_">isOptional</span>() &amp;&amp; context.<span class="hljs-title function_">hasSpecificBeanName</span>()) {
<span class="hljs-keyword">return</span> <span class="hljs-variable constant_">RESOURCE</span>;
}

<span class="hljs-comment">// 配置类依赖：Setter注入</span>
<span class="hljs-keyword">if</span> (context.<span class="hljs-title function_">isConfigurationProperty</span>()) {
<span class="hljs-keyword">return</span> <span class="hljs-variable constant_">SETTER</span>;
}

<span class="hljs-comment">// 兼容性要求高：@Autowired</span>
<span class="hljs-keyword">if</span> (context.<span class="hljs-title function_">needsBackwardCompatibility</span>()) {
<span class="hljs-keyword">return</span> <span class="hljs-variable constant_">AUTOWIRED</span>;
}

<span class="hljs-keyword">return</span> <span class="hljs-variable constant_">RESOURCE</span>; <span class="hljs-comment">// 默认推荐</span>
}
}

<span class="hljs-comment">/**
* 项目级别的依赖注入规范
*/</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DependencyInjectionStandards</span> {

<span class="hljs-comment">/**
* ✅ 推荐的Service层写法
*/</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RecommendedServiceExample</span> {

<span class="hljs-comment">// 1. 核心依赖：构造器注入（final字段）</span>
<span class="hljs-keyword">private</span> final <span class="hljs-title class_">UserRepository</span> userRepository;
<span class="hljs-keyword">private</span> final <span class="hljs-title class_">PasswordEncoder</span> passwordEncoder;

<span class="hljs-comment">// 2. 可选依赖：@Resource注入</span>
<span class="hljs-meta">@Resource</span>
<span class="hljs-keyword">private</span> <span class="hljs-title class_">RedisTemplate</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt; redisTemplate;

<span class="hljs-meta">@Resource</span>(name = <span class="hljs-string">"primaryEmailService"</span>)
<span class="hljs-keyword">private</span> <span class="hljs-title class_">EmailService</span> emailService;

<span class="hljs-comment">// 3. 构造器：只包含核心依赖</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">RecommendedServiceExample</span>(<span class="hljs-title class_">UserRepository</span> userRepository,
<span class="hljs-title class_">PasswordEncoder</span> passwordEncoder) {
<span class="hljs-variable language_">this</span>.<span class="hljs-property">userRepository</span> = userRepository;
<span class="hljs-variable language_">this</span>.<span class="hljs-property">passwordEncoder</span> = passwordEncoder;
}

<span class="hljs-comment">// 4. 业务方法：清晰的依赖关系</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">User</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">CreateUserRequest request</span>) {
<span class="hljs-comment">// 数据验证</span>
<span class="hljs-title function_">validateUserRequest</span>(request);

<span class="hljs-comment">// 密码加密</span>
<span class="hljs-title class_">String</span> encodedPassword = passwordEncoder.<span class="hljs-title function_">encode</span>(request.<span class="hljs-title function_">getPassword</span>());

<span class="hljs-comment">// 创建用户</span>
<span class="hljs-title class_">User</span> user = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
user.<span class="hljs-title function_">setUsername</span>(request.<span class="hljs-title function_">getUsername</span>());
user.<span class="hljs-title function_">setPassword</span>(encodedPassword);
user.<span class="hljs-title function_">setEmail</span>(request.<span class="hljs-title function_">getEmail</span>());

<span class="hljs-comment">// 保存用户</span>
user = userRepository.<span class="hljs-title function_">save</span>(user);

<span class="hljs-comment">// 缓存用户信息（可选操作）</span>
<span class="hljs-title function_">cacheUser</span>(user);

<span class="hljs-comment">// 发送欢迎邮件（可选操作）</span>
<span class="hljs-title function_">sendWelcomeEmail</span>(user);

<span class="hljs-keyword">return</span> user;
}

<span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">cacheUser</span>(<span class="hljs-params">User user</span>) {
<span class="hljs-keyword">if</span> (redisTemplate != <span class="hljs-literal">null</span>) {
<span class="hljs-title class_">String</span> cacheKey = <span class="hljs-string">"user:"</span> + user.<span class="hljs-title function_">getId</span>();
redisTemplate.<span class="hljs-title function_">opsForValue</span>().<span class="hljs-title function_">set</span>(cacheKey, user, <span class="hljs-title class_">Duration</span>.<span class="hljs-title function_">ofHours</span>(<span class="hljs-number">1</span>));
}
}

<span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">sendWelcomeEmail</span>(<span class="hljs-params">User user</span>) {
<span class="hljs-keyword">if</span> (emailService != <span class="hljs-literal">null</span>) {
emailService.<span class="hljs-title function_">sendWelcomeEmail</span>(user.<span class="hljs-title function_">getEmail</span>(), user.<span class="hljs-title function_">getUsername</span>());
}
}
}

<span class="hljs-comment">/**
* ✅ 推荐的Controller层写法
*/</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/api/users"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RecommendedControllerExample</span> {

<span class="hljs-comment">// 核心依赖：构造器注入</span>
<span class="hljs-keyword">private</span> final <span class="hljs-title class_">UserService</span> userService;
<span class="hljs-keyword">private</span> final <span class="hljs-title class_">UserValidator</span> userValidator;

<span class="hljs-comment">// 可选依赖：@Resource注入</span>
<span class="hljs-meta">@Resource</span>
<span class="hljs-keyword">private</span> <span class="hljs-title class_">MetricsService</span> metricsService;

<span class="hljs-keyword">public</span> <span class="hljs-title class_">RecommendedControllerExample</span>(<span class="hljs-title class_">UserService</span> userService,
<span class="hljs-title class_">UserValidator</span> userValidator) {
<span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span> = userService;
<span class="hljs-variable language_">this</span>.<span class="hljs-property">userValidator</span> = userValidator;
}

<span class="hljs-meta">@PostMapping</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">ResponseEntity</span>&lt;<span class="hljs-title class_">UserDto</span>&gt; <span class="hljs-title function_">createUser</span>(<span class="hljs-params"><span class="hljs-meta">@RequestBody</span> CreateUserRequest request</span>) {

<span class="hljs-comment">// 记录请求指标</span>
<span class="hljs-title function_">recordMetrics</span>(<span class="hljs-string">"user.create.request"</span>);

<span class="hljs-keyword">try</span> {
<span class="hljs-comment">// 参数验证</span>
userValidator.<span class="hljs-title function_">validate</span>(request);

<span class="hljs-comment">// 业务处理</span>
<span class="hljs-title class_">User</span> user = userService.<span class="hljs-title function_">createUser</span>(request);

<span class="hljs-comment">// 转换DTO</span>
<span class="hljs-title class_">UserDto</span> userDto = <span class="hljs-title class_">UserDto</span>.<span class="hljs-title function_">fromEntity</span>(user);

<span class="hljs-comment">// 记录成功指标</span>
<span class="hljs-title function_">recordMetrics</span>(<span class="hljs-string">"user.create.success"</span>);

<span class="hljs-keyword">return</span> <span class="hljs-title class_">ResponseEntity</span>.<span class="hljs-title function_">ok</span>(userDto);

} <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
<span class="hljs-comment">// 记录失败指标</span>
<span class="hljs-title function_">recordMetrics</span>(<span class="hljs-string">"user.create.error"</span>);
<span class="hljs-keyword">throw</span> e;
}
}

<span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">recordMetrics</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> metricName</span>) {
<span class="hljs-keyword">if</span> (metricsService != <span class="hljs-literal">null</span>) {
metricsService.<span class="hljs-title function_">increment</span>(metricName);
}
}
}
}

<span class="hljs-comment">/**
* 依赖注入监控和诊断
*/</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DependencyInjectionMonitor</span> {

<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-title class_">Logger</span> log = <span class="hljs-title class_">LoggerFactory</span>.<span class="hljs-title function_">getLogger</span>(<span class="hljs-title class_">DependencyInjectionMonitor</span>.<span class="hljs-property">class</span>);

<span class="hljs-meta">@EventListener</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">handleBeanCreationEvent</span>(<span class="hljs-params">BeanCreationEvent event</span>) {

<span class="hljs-title class_">String</span> beanName = event.<span class="hljs-title function_">getBeanName</span>();
<span class="hljs-title class_">Class</span>&lt;?&gt; beanClass = event.<span class="hljs-title function_">getBeanClass</span>();
long creationTime = event.<span class="hljs-title function_">getCreationTime</span>();

<span class="hljs-comment">// 记录Bean创建时间</span>
log.<span class="hljs-title function_">debug</span>(<span class="hljs-string">"Bean创建：{}（{}）耗时：{}ms"</span>, beanName, beanClass.<span class="hljs-title function_">getSimpleName</span>(), creationTime);

<span class="hljs-comment">// 检测潜在问题</span>
<span class="hljs-title function_">checkPotentialIssues</span>(beanClass);
}

<span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">checkPotentialIssues</span>(<span class="hljs-params">Class&lt;?&gt; beanClass</span>) {

<span class="hljs-comment">// 检测字段注入</span>
<span class="hljs-title class_">Field</span>[] fields = beanClass.<span class="hljs-title function_">getDeclaredFields</span>();
<span class="hljs-keyword">for</span> (<span class="hljs-title class_">Field</span> field : fields) {
<span class="hljs-keyword">if</span> (field.<span class="hljs-title function_">isAnnotationPresent</span>(<span class="hljs-title class_">Autowired</span>.<span class="hljs-property">class</span>)) {
log.<span class="hljs-title function_">warn</span>(<span class="hljs-string">"检测到@Autowired字段注入：{}.{}，建议使用构造器注入或@Resource"</span>,
beanClass.<span class="hljs-title function_">getSimpleName</span>(), field.<span class="hljs-title function_">getName</span>());
}
}

<span class="hljs-comment">// 检测构造器数量</span>
<span class="hljs-title class_">Constructor</span>&lt;?&gt;[] constructors = beanClass.<span class="hljs-title function_">getConstructors</span>();
<span class="hljs-keyword">if</span> (constructors.<span class="hljs-property">length</span> &gt; <span class="hljs-number">1</span>) {
log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"类{}有多个构造器，请确保依赖注入策略正确"</span>, beanClass.<span class="hljs-title function_">getSimpleName</span>());
}
}

<span class="hljs-comment">/**
* 生成依赖注入报告
*/</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">generateDependencyReport</span>(<span class="hljs-params"/>) {
log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"=== 依赖注入使用情况报告 ==="</span>);

<span class="hljs-comment">// 统计各种注入方式的使用情况</span>
<span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Integer</span>&gt; injectionStats = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
injectionStats.<span class="hljs-title function_">put</span>(<span class="hljs-string">"@Autowired字段注入"</span>, <span class="hljs-title function_">countAutowiredFields</span>());
injectionStats.<span class="hljs-title function_">put</span>(<span class="hljs-string">"@Resource注入"</span>, <span class="hljs-title function_">countResourceFields</span>());
injectionStats.<span class="hljs-title function_">put</span>(<span class="hljs-string">"构造器注入"</span>, <span class="hljs-title function_">countConstructorInjection</span>());

injectionStats.<span class="hljs-title function_">forEach</span>((<span class="hljs-keyword">type</span>, count) -&gt; {
log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"{}: {}个"</span>, <span class="hljs-keyword">type</span>, count);
});

<span class="hljs-comment">// 给出改进建议</span>
<span class="hljs-title function_">generateImprovementSuggestions</span>(injectionStats);
}

<span class="hljs-keyword">private</span> int <span class="hljs-title function_">countAutowiredFields</span>(<span class="hljs-params"/>) {
<span class="hljs-comment">// 实现统计逻辑</span>
<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-keyword">private</span> int <span class="hljs-title function_">countResourceFields</span>(<span class="hljs-params"/>) {
<span class="hljs-comment">// 实现统计逻辑</span>
<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-keyword">private</span> int <span class="hljs-title function_">countConstructorInjection</span>(<span class="hljs-params"/>) {
<span class="hljs-comment">// 实现统计逻辑</span>
<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">generateImprovementSuggestions</span>(<span class="hljs-params"><span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, Integer&gt; stats</span>) {

int autowiredCount = stats.<span class="hljs-title function_">get</span>(<span class="hljs-string">"@Autowired字段注入"</span>);
int resourceCount = stats.<span class="hljs-title function_">get</span>(<span class="hljs-string">"@Resource注入"</span>);

<span class="hljs-keyword">if</span> (autowiredCount &gt; resourceCount * <span class="hljs-number">2</span>) {
log.<span class="hljs-title function_">warn</span>(<span class="hljs-string">"建议：@Autowired使用过多，考虑迁移到@Resource或构造器注入"</span>);
}

<span class="hljs-keyword">if</span> (stats.<span class="hljs-title function_">get</span>(<span class="hljs-string">"构造器注入"</span>) &lt; <span class="hljs-number">10</span>) {
log.<span class="hljs-title function_">warn</span>(<span class="hljs-string">"建议：构造器注入使用较少，建议核心依赖使用构造器注入"</span>);
}
}
}
}
<span class="hljs-comment">/**
* 依赖上下文信息
*/</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Builder</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DependencyContext</span> {
<span class="hljs-keyword">private</span> <span class="hljs-built_in">boolean</span> coreDependency;
<span class="hljs-keyword">private</span> <span class="hljs-built_in">boolean</span> optional;
<span class="hljs-keyword">private</span> <span class="hljs-built_in">boolean</span> hasSpecificBeanName;
<span class="hljs-keyword">private</span> <span class="hljs-built_in">boolean</span> configurationProperty;
<span class="hljs-keyword">private</span> <span class="hljs-built_in">boolean</span> needsBackwardCompatibility;
<span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> beanName;
<span class="hljs-keyword">private</span> <span class="hljs-title class_">Class</span>&lt;?&gt; dependencyType;
}
</code></pre>
<h2 data-id="heading-14">迁移指南：平滑过渡到最佳实践</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MigrationGuide</span> {

<span class="hljs-comment">/**
* 分阶段迁移计划
*/</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">MigrationPhase</span> {

<span class="hljs-title function_">PHASE_1</span>(<span class="hljs-string">"评估阶段"</span>, <span class="hljs-string">"分析现有代码，识别问题"</span>),
<span class="hljs-title function_">PHASE_2</span>(<span class="hljs-string">"核心迁移"</span>, <span class="hljs-string">"迁移核心业务类到构造器注入"</span>),
<span class="hljs-title function_">PHASE_3</span>(<span class="hljs-string">"@Resource替换"</span>, <span class="hljs-string">"将@Autowired替换为@Resource"</span>),
<span class="hljs-title function_">PHASE_4</span>(<span class="hljs-string">"测试优化"</span>, <span class="hljs-string">"优化单元测试"</span>),
<span class="hljs-title function_">PHASE_5</span>(<span class="hljs-string">"监控验证"</span>, <span class="hljs-string">"添加监控，验证效果"</span>);

<span class="hljs-keyword">private</span> final <span class="hljs-title class_">String</span> name;
<span class="hljs-keyword">private</span> final <span class="hljs-title class_">String</span> description;

<span class="hljs-title class_">MigrationPhase</span>(<span class="hljs-title class_">String</span> name, <span class="hljs-title class_">String</span> description) {
<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
<span class="hljs-variable language_">this</span>.<span class="hljs-property">description</span> = description;
}
}

<span class="hljs-comment">/**
* 自动化迁移工具
*/</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AutoMigrationTool</span> {

<span class="hljs-comment">/**
* 扫描项目中的依赖注入使用情况
*/</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">MigrationReport</span> <span class="hljs-title function_">scanProject</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> packageName</span>) {

<span class="hljs-title class_">MigrationReport</span> report = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MigrationReport</span>();

<span class="hljs-comment">// 扫描所有类</span>
<span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">Class</span>&lt;?&gt;&gt; classes = <span class="hljs-title function_">scanClasses</span>(packageName);

<span class="hljs-keyword">for</span> (<span class="hljs-title class_">Class</span>&lt;?&gt; clazz : classes) {
<span class="hljs-title function_">analyzeClass</span>(clazz, report);
}

<span class="hljs-comment">// 生成迁移建议</span>
<span class="hljs-title function_">generateMigrationSuggestions</span>(report);

<span class="hljs-keyword">return</span> report;
}

<span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">analyzeClass</span>(<span class="hljs-params">Class&lt;?&gt; clazz, MigrationReport report</span>) {

<span class="hljs-title class_">ClassAnalysis</span> analysis = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassAnalysis</span>();
analysis.<span class="hljs-title function_">setClassName</span>(clazz.<span class="hljs-title function_">getName</span>());

<span class="hljs-comment">// 分析字段注入</span>
<span class="hljs-title class_">Field</span>[] fields = clazz.<span class="hljs-title function_">getDeclaredFields</span>();
<span class="hljs-keyword">for</span> (<span class="hljs-title class_">Field</span> field : fields) {
<span class="hljs-keyword">if</span> (field.<span class="hljs-title function_">isAnnotationPresent</span>(<span class="hljs-title class_">Autowired</span>.<span class="hljs-property">class</span>)) {
analysis.<span class="hljs-title function_">addAutowiredField</span>(field.<span class="hljs-title function_">getName</span>());
report.<span class="hljs-title function_">incrementAutowiredCount</span>();
}

<span class="hljs-keyword">if</span> (field.<span class="hljs-title function_">isAnnotationPresent</span>(<span class="hljs-title class_">Resource</span>.<span class="hljs-property">class</span>)) {
analysis.<span class="hljs-title function_">addResourceField</span>(field.<span class="hljs-title function_">getName</span>());
report.<span class="hljs-title function_">incrementResourceCount</span>();
}
}

<span class="hljs-comment">// 分析构造器</span>
<span class="hljs-title class_">Constructor</span>&lt;?&gt;[] constructors = clazz.<span class="hljs-title function_">getConstructors</span>();
<span class="hljs-keyword">for</span> (<span class="hljs-title class_">Constructor</span>&lt;?&gt; constructor : constructors) {
<span class="hljs-keyword">if</span> (constructor.<span class="hljs-title function_">getParameterCount</span>() &gt; <span class="hljs-number">0</span>) {
analysis.<span class="hljs-title function_">setHasConstructorInjection</span>(<span class="hljs-literal">true</span>);
report.<span class="hljs-title function_">incrementConstructorCount</span>();
}
}

report.<span class="hljs-title function_">addClassAnalysis</span>(analysis);
}

<span class="hljs-keyword">private</span> <span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">Class</span>&lt;?&gt;&gt; <span class="hljs-title function_">scanClasses</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> packageName</span>) {
<span class="hljs-comment">// 实现类扫描逻辑</span>
<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();
}

<span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">generateMigrationSuggestions</span>(<span class="hljs-params">MigrationReport report</span>) {

<span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">String</span>&gt; suggestions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

<span class="hljs-keyword">if</span> (report.<span class="hljs-title function_">getAutowiredCount</span>() &gt; <span class="hljs-number">0</span>) {
suggestions.<span class="hljs-title function_">add</span>(<span class="hljs-title class_">String</span>.<span class="hljs-title function_">format</span>(<span class="hljs-string">"发现%d个@Autowired字段注入，建议迁移到@Resource"</span>,
report.<span class="hljs-title function_">getAutowiredCount</span>()));
}

<span class="hljs-keyword">if</span> (report.<span class="hljs-title function_">getConstructorCount</span>() &lt; report.<span class="hljs-title function_">getTotalClasses</span>() * <span class="hljs-number">0.3</span>) {
suggestions.<span class="hljs-title function_">add</span>(<span class="hljs-string">"构造器注入使用率较低，建议核心依赖使用构造器注入"</span>);
}

report.<span class="hljs-title function_">setSuggestions</span>(suggestions);
}
}

<span class="hljs-comment">/**
* 迁移报告
*/</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MigrationReport</span> {
<span class="hljs-keyword">private</span> int totalClasses;
<span class="hljs-keyword">private</span> int autowiredCount;
<span class="hljs-keyword">private</span> int resourceCount;
<span class="hljs-keyword">private</span> int constructorCount;
<span class="hljs-keyword">private</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">ClassAnalysis</span>&gt; classAnalyses = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
<span class="hljs-keyword">private</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">String</span>&gt; suggestions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">incrementAutowiredCount</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">autowiredCount</span>++; }
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">incrementResourceCount</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">resourceCount</span>++; }
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">incrementConstructorCount</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">constructorCount</span>++; }
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">addClassAnalysis</span>(<span class="hljs-params">ClassAnalysis analysis</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">classAnalyses</span>.<span class="hljs-title function_">add</span>(analysis); }
}

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassAnalysis</span> {
<span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> className;
<span class="hljs-keyword">private</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">String</span>&gt; autowiredFields = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
<span class="hljs-keyword">private</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">String</span>&gt; resourceFields = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
<span class="hljs-keyword">private</span> <span class="hljs-built_in">boolean</span> hasConstructorInjection;

<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">addAutowiredField</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> fieldName</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">autowiredFields</span>.<span class="hljs-title function_">add</span>(fieldName); }
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">addResourceField</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> fieldName</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">resourceFields</span>.<span class="hljs-title function_">add</span>(fieldName); }
}
}
</code></pre>
<h2 data-id="heading-15">总结：拥抱@Resource，告别@Autowired</h2>
<p>经过深入的技术分析和实战验证，我得出几个重要结论：</p>
<h2 data-id="heading-16">🎯 核心观点</h2>
<p><strong>Spring官方确实不推荐过度使用@Autowired</strong>，特别是字段注入方式。官方推荐的优先级是：</p>
<ol>
<li><strong>构造器注入</strong>（强制依赖）</li>
<li><strong>@Resource注入</strong>（可选依赖）</li>
<li><strong>Setter注入</strong>（配置属性）</li>
<li><strong>@Autowired注入</strong>（兼容性场景）</li>
</ol>
<h2 data-id="heading-17">⚡ 性能对比总结</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a0a7e3dac1d454584030411931f85a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ams5Y2h5be05Y2h:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681712&amp;x-signature=WI2OItVAhF39vEcryLCnh9x3gdc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-18">最佳实践建议</h2>
<ol>
<li><strong>核心业务依赖</strong>：使用构造器注入，保证不可变性</li>
<li><strong>可选依赖</strong>：使用@Resource，精确匹配Bean</li>
<li><strong>多实现场景</strong>：@Resource + 工厂模式</li>
<li><strong>遗留代码</strong>：分阶段迁移，先解决循环依赖</li>
<li><strong>团队规范</strong>：制定编码标准，工具辅助检查</li>
</ol>
<h2 data-id="heading-19">写在最后</h2>
<p>那次生产环境的循环依赖事故让我深刻认识到，<strong>选择合适的依赖注入方式不仅仅是代码风格问题，更关系到系统的稳定性和可维护性</strong>。</p>
<p>@Resource虽然没有@Autowired那么"知名"，但它确实是更好的选择。正如那句话： <strong>"流行的不一定是最好的，最好的往往被忽视"</strong> 。</p>
<p>你的项目中是否也存在@Autowired滥用的问题？准备开始迁移到@Resource了吗？欢迎在评论区分享你的经验和看法！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[看到大佬做四格漫画日入400+，我觉得应该做些什么了！]]></title>    <link>https://juejin.cn/post/7589207474134188082</link>    <guid>https://juejin.cn/post/7589207474134188082</guid>    <pubDate>2025-12-30T03:39:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589207474134188082" data-draft-id="7589168816527441947" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="看到大佬做四格漫画日入400+，我觉得应该做些什么了！"/> <meta itemprop="keywords" content="AIGC,工作流引擎"/> <meta itemprop="datePublished" content="2025-12-30T03:39:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="曹工不加班"/> <meta itemprop="url" content="https://juejin.cn/user/4336129588870957"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            看到大佬做四格漫画日入400+，我觉得应该做些什么了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4336129588870957/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    曹工不加班
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T03:39:17.000Z" title="Tue Dec 30 2025 03:39:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是最近用 n8n 跑出来的一个挺有意思的玩具。</p>
<p>起因是看到一张很有“母慈子孝”味道的聊天记录，就是下面这张。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2082299d909e4068a98a023d7bcf87e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55bel5LiN5Yqg54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767670756&amp;x-signature=d1GcaTx7jlU2pTyWgLAjHYfd8Wg%3D" alt="" loading="lazy"/></p>
<p>看完乐了半天，正好前两天在掘金看到大佬“张风捷特烈”（公众号：编程之王）分享了一个用 AI 做四格漫画的思路还有让人羡慕到龇牙咧嘴的广告收益。</p>
<p><a href="https://juejin.cn/user/149189281194766/posts" target="_blank" title="https://juejin.cn/user/149189281194766/posts">张风捷特烈</a>
<a href="https://juejin.cn/post/7588004601392529442?searchId=202512301014099D599A36152894CF15E6" target="_blank" title="https://juejin.cn/post/7588004601392529442?searchId=202512301014099D599A36152894CF15E6"># AI 做公众号漫画，竟然日入 400+</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f014bd5526074e258555f0a0add676b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55bel5LiN5Yqg54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767670756&amp;x-signature=Fob%2BYvxwDrAhfxwV5f%2FFRYqcbAs%3D" alt="" loading="lazy"/></p>
<p>我就琢磨着，能不能把这个过程自动化一下？</p>
<p>直接把聊天记录或者段子丢给 AI，让它自己提取笑点，自己写脚本，最后自动画出来。</p>
<p>折腾了一下午，弄出来的效果还行，大家先看看成品。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3933cbfdfd0d435c93e4de2c2098db23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55bel5LiN5Yqg54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767670756&amp;x-signature=%2B9i1uZinJDATpk39mbS3%2FT4Pvbs%3D" alt="" loading="lazy"/></p>
<p>这就有点意思了。</p>
<p>只要你有素材，不管是网上的段子，还是身边的乐子，丢进去就是一个完整的漫画。</p>
<p>今天把这个工作流的搭建过程拆开了揉碎了讲讲。</p>
<h3 data-id="heading-0">核心原理其实就三步</h3>
<p>不用被那一堆节点吓到，这东西逻辑很简单。</p>
<p>把它想象成一个漫画工作室：</p>
<ol>
<li><strong>编剧（AI Agent）：</strong> 它的脑子好使。你给它一段对话，它负责提炼笑点，安排谁站左边谁站右边，还得把分镜脚本写好。</li>
<li><strong>画师（绘图节点）：</strong> 它是个老实人，不带脑子，只管照着编剧给的描述去画画。</li>
<li><strong>宣发（微信节点）：</strong> 画好了，打包上传到公众号草稿箱，等着发就行。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f4ae64d272c435483b4126a2517e325~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55bel5LiN5Yqg54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767670756&amp;x-signature=lkWK0KDztAvCsXFw%2BPAq27965%2BA%3D" alt="" loading="lazy"/></p>
<p>整个工作流在 n8n 里的长相是这样的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb4c032c767f4637a69c6c120fe2055b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55bel5LiN5Yqg54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767670756&amp;x-signature=z5t5CpqgA3JwE6VbJRbOZeW4OUY%3D" alt="" loading="lazy"/></p>
<p>下面我们要开始动真格的了，打开你的 n8n，咱们从头搭。</p>
<h3 data-id="heading-1">搭建“漫画工作室”</h3>
<h4 data-id="heading-2">第一步：搞定输入入口</h4>
<p>我们需要一个地方来接收你的指令。这里我用了两个触发器，为了方便测试和实际使用。</p>
<p>一个是 <strong>Chat Trigger</strong>，这玩意儿能让你直接在 n8n 的聊天窗口里跟它对话，测试的时候特别方便。
开启允许文件上传，这样我们可以上传梗图来创作漫画。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/502ac06d2011417bbbf6b6b59a27d1c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55bel5LiN5Yqg54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767670756&amp;x-signature=ZBWbMgESTv2gmKHFpb7EOPbB%2BzY%3D" alt="" loading="lazy"/></p>
<p>另一个是 <strong>Form Trigger</strong>（表单触发）。如果你想做一个网页发给朋友玩，或者是想传图片（比如上面的聊天记录截图），用表单更合适。</p>
<p>配置太长了，横向拼了一下，其实是一张长图。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71144de359e94f3f8c672b4d197c7ffc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55bel5LiN5Yqg54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767670756&amp;x-signature=QhY1vuSiYBF3V7JI089usWfhss4%3D" alt="" loading="lazy"/></p>
<p>配置的时候要注意，表单里我设了两个字段：<code>theme</code> 和 <code>pic</code>。这样逻辑就活了：</p>
<ul>
<li>有图就看图说话。</li>
<li>没图就根据主题自由发挥。</li>
</ul>
<h4 data-id="heading-3">第二步：招聘一位金牌编剧（AI Agent）</h4>
<p>这是整个工作流的大脑，也是最关键的一步。</p>
<p>拖一个 <strong>AI Agent</strong> 节点出来。模型我选的是 Google 的 Gemini，因为它处理长文本和逻辑推理的能力在线，国内模型可以使用 GLM-4.6V 代替，也有分析图像进行联想推理的能力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a0bc48921684acaa437097a659a6d94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55bel5LiN5Yqg54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767670756&amp;x-signature=HazujMTEdrflaCsJcAbceUS91jE%3D" alt="" loading="lazy"/></p>
<p>这个节点的配置有两个核心点，千万别搞错：</p>
<p><strong>1. 告诉它怎么当导演（Prompt）</strong></p>
<p>我们在 Agent 的系统提示词里，要给它立规矩。不能让它瞎写，必须输出我们画图能用的格式。</p>
<p>提示词的大概逻辑是这样的：</p>
<blockquote>
<p>你是一位爆笑四格漫画导演。
任务：把用户的内容转化为漫画脚本。
风格：Q 版、可爱、全彩。
结构：严格遵守“起、承、转、合”的四格法则。
输出：必须是严格的 JSON 格式，包含标题、Markdown 格式的详细分镜描述。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa012da13752423e9ff7198b6f96db82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55bel5LiN5Yqg54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767670756&amp;x-signature=%2FZrk98K8IlXRKOXZmEQ%2BqJUsIKk%3D" alt="" loading="lazy"/></p>
<p>下面是用户提示词全文，主要是传入梗图和笑点文字，特殊要求等内容，让模型根据输入内容进行笑点提取：</p>
<pre><code class="hljs language-bash" lang="bash">主题：{{ <span class="hljs-variable">$json</span>?.theme || <span class="hljs-variable">$json</span>?.chatInput}}
按照主题以及我传入的图片来生成漫画绘制信息，主题或者图片有一项可能为空，为空的情况下从有的那一项内提取笑点，如果有主题也有图片就结合起来规划漫画主题，如果两个都没有，就自由发挥
</code></pre>
<p>系统提示词太长了，就不放全文了，直接文末获取工作流文件导入：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Role: 爆笑四格·梗漫导演 (Comic Director)</span>

<span class="hljs-section">## 核心任务</span>
你是一位兼具顶级幽默感、分镜能力与全栈交付思维的漫画导演。你的任务是将用户提供的素材转化为<span class="hljs-strong">**Nano Banana Pro 专用的标准 JSON 格式指令**</span>。

<span class="hljs-section">## 关键约束</span>
<span class="hljs-bullet">1.</span>  <span class="hljs-strong">**风格锁定**</span>：必须是<span class="hljs-strong">**Q版可爱形象**</span>、<span class="hljs-strong">**全彩漫画**</span>。
<span class="hljs-bullet">2.</span>  <span class="hljs-strong">**结构锁定**</span>：<span class="hljs-code">`comic_info`</span> 字段必须严格映射原定数据结构（Type/Style/Color/Background/Characters/Panels），但使用 <span class="hljs-strong">**Markdown 语法**</span>输出。
<span class="hljs-bullet">3.</span>  <span class="hljs-strong">**格式锁定**</span>：输出单一 JSON 对象，包含 <span class="hljs-code">`title`</span>, <span class="hljs-code">`comic_info`</span>, <span class="hljs-code">`html`</span>, ``。

...省略好多...

<span class="hljs-section">## 工作流</span>

<span class="hljs-bullet">1.</span> <span class="hljs-strong">**分析输入**</span>：提取笑点。
<span class="hljs-bullet">2.</span> <span class="hljs-strong">**构思标题**</span>：生成 <span class="hljs-code">`title`</span>。
<span class="hljs-bullet">3.</span> <span class="hljs-strong">**构建 Markdown**</span>：按照“基础信息-角色-分镜”结构生成 <span class="hljs-code">`comic_info`</span>，确保全彩Q版风格。
<span class="hljs-bullet">4.</span> <span class="hljs-strong">**构建 HTML**</span>：将 Markdown 转化为带样式的 <span class="hljs-code">`html`</span>。
<span class="hljs-bullet">5.</span> <span class="hljs-strong">**封装**</span>：输出 JSON。

当你获得解析后的结构化数据（JSON）后，请直接将其作为最终答案输出，不要再次尝试调用解析器或进行多余的解释。如果 comic<span class="hljs-emphasis">_info 和 html 字段已经生成，任务即视为完成。

## 初始化

根据用户输入，开始生成！
</span></code></pre>
<p>上面的提示词把后面所有需要用到的信息都生成好了，各个字段的作用分别是：</p>
<ol>
<li><strong>title</strong>： 用于公众号文章标题，还有四格漫画上写漫画名称</li>
<li><strong>comic_info</strong>：交给 Nano Banana Pro 进行四格漫画的创作，结构化的信息可以最清晰的表达每一格漫画要画的内容，达到最佳图片生成效果。</li>
<li><strong>html</strong>：因为我们后面要发布到微信公众号，markdown 内容直接通过 api 接口提交，展示效果很差，这边直接让大模型根据 markdown 内容拼装一个优化了样式的 html 文本，用这个内容来发布，显示效果就很棒了。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf039845df7c40b7bc22fde7203b1eed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55bel5LiN5Yqg54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767670756&amp;x-signature=qrUuAZuR%2FrLYVI4O5H2%2BnSEgBjM%3D" alt="" loading="lazy"/></li>
<li><strong>summary</strong>：这个字段是公众号文章的提要，如果不生成，直接展示的内容是不能直接表达漫画内容的，会取正文的前部分字符。</li>
</ol>
<p><strong>2. 规定输出格式（Output Parser）</strong></p>
<p>AI 有时候输出的内容很奔放，结构不统一，对工作流来说，下一个节点要的是确切的输入，所以这边让根据。</p>
<p>我们需要它输出纯净的数据，所以必须挂一个 <strong>Structured Output Parser</strong>（结构化输出解析器）。</p>
<p>在这个解析器里，定义好我们需要的数据结构：</p>
<ul>
<li><code>title</code>: 漫画标题</li>
<li><code>comic_info</code>: 这是一个大段的文本，里面包含了画图要用的所有提示词（Prompt）。</li>
<li><code>html</code>: 拼装好的提示词标签，用于文章渲染</li>
<li><code>summary</code>: 故事梗概。</li>
</ul>
<p>这样，不管 AI 怎么思考，最后吐出来的永远是我们可以直接用的 JSON 数据。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10adb49c28a841be89e9609c05910fc3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55bel5LiN5Yqg54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767670756&amp;x-signature=8UGKQSERO57rmfzECw5bV5JIM50%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-4">第三步：雇佣灵魂画师（绘图节点）</h4>
<p>脚本写好了，接下来就是画。</p>
<p>这里我用的是自己开发的 <strong>Nano Banana</strong> 社区节点，在社区节点管理面板输入 <code>n8n-nodes-nano-banana</code>，使用 Nano Banana Pro 模型，中文支持很出色。</p>
<p>在 Prompt 栏里，我们要用表达式（Expression）来引用上一步的结果。</p>
<p>把前面 AI Agent 节点输出的漫画信息拖到 prompt 输入框中。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c78f9a42f784951a4cc9c410a863914~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55bel5LiN5Yqg54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767670756&amp;x-signature=qg%2FFftlrHPg18rzk%2B3r%2FrrcouYI%3D" alt="" loading="lazy"/></p>
<p>为了让漫画看着更像样，我还在提示词后面追加了一段硬性要求，全文如下：</p>
<pre><code class="hljs language-bash" lang="bash">{{ <span class="hljs-variable">$json</span>.output.comic_info.toJsonString() }}
绘制漫画，漫画文字写大一点，可以适当精简，保留核心笑点即可。
横向留白一条，左边写漫画标题，右边写上“微信公众号：曹工不加班”，不要占用太多空间。除此之外，漫画外不要写任何内容文字
</code></pre>
<p>我规定了漫画的字要大一点，因为没加之前字会比较小，看着很累；另外加了公众号的名称和漫画标题，出来的图不用 PS，直接就能发。</p>
<h4 data-id="heading-5">第四步：宣发自动化（微信发布）</h4>
<p>图画出来了，你可以选择直接发给用户，也可以像我一样，直接同步到微信公众号。</p>
<p>这需要用到 <strong>WeChat</strong> 社区节点，在社区节点管理面板输入 <code>n8n-nodes-wechat-publish</code> 安装。</p>
<p>安装以后先创建一个公众号的链接凭证，需要前往微信开发者平台获取 App ID 和 App Secret，并且把运行 n8n 的电脑的 IP 配置到 IP 白名单内。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb8b3ed7450f4935926d98cee635d936~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55bel5LiN5Yqg54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767670756&amp;x-signature=WxE%2BM%2BfcH3XJuNRoxWsP%2FW4u4QA%3D" alt="" loading="lazy"/></p>
<p>添加 <strong>Upload Media</strong> 节点，把刚才生成的四格漫画图片上传到微信服务器，拿到一个 <code>media_id</code>，设置公众号的封面需要用到这个 id。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9346bb13570b44eda3d04ea922cf873f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55bel5LiN5Yqg54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767670756&amp;x-signature=znFQ%2FSdBKr6y8XasncOw9auiNY8%3D" alt="" loading="lazy"/></p>
<p>紧接着用 <strong>Create Draft</strong>（创建草稿）节点。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5eeb5e97a6d042c6a8b94f510f9e9f29~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55bel5LiN5Yqg54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767670756&amp;x-signature=LcuSSCHLRfdsEz7IWEwd0lAlf60%3D" alt="" loading="lazy"/></p>
<p>在这个节点里，你可以把文章排版都做进去。</p>
<p>比如：</p>
<ul>
<li>标题：用 AI 起的那个吸睛标题。</li>
<li>封面：就是刚才画的那张漫画。</li>
<li>正文：插入图片，再把 AI 生成的文字脚本附在后面，甚至可以加个底部贴片广告。</li>
</ul>
<p>设置好之后，一运行，你的公众号草稿箱里就会多出一篇排版精美的漫画文章，你需要做的只是点个“发布”。</p>
<h3 data-id="heading-6">玩法延伸</h3>
<p>这套工作流最妙的地方在于，它是不设限的。</p>
<p>现在的提示词是“Q 版可爱”，如果你把 Prompt 里的风格描述改一改：</p>
<ul>
<li>改成“黑白线条、极简主义” —— 就是 <strong>黑白漫画</strong> 风格。</li>
<li>改成“美式复古、波普艺术” —— 就是 <strong>欧美梗图</strong> 风格。</li>
<li>改成“赛博朋克、霓虹光影” —— 就是 <strong>科幻条漫</strong>。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8e20782ae12408d9b1822ad89622f28~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55bel5LiN5Yqg54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767670756&amp;x-signature=%2Ftlyc0nsRgT5GpDI5FxwiSy3Kw8%3D" alt="" loading="lazy"/></p>
<p>只需要改一行字，整个画风突变。</p>
<h3 data-id="heading-7">怎么获取工作流？</h3>
<p>这套东西搭起来说难不难，但细节坑不少，特别是 AI 的系统提示词和 JSON 解析那块，调教了很久才稳定。</p>
<p>我已经把调试好的完整 n8n 源码（JSON 文件）打包好了。</p>
<p>直接导入 n8n 就能用，不用自己从头搭建了。</p>
<p>关注公众号“<strong>曹工不加班</strong>”，发送暗号“<strong>四格漫画</strong>”，文件直接发你。</p>
<p>拿到之后，记得把里面的 API Key 换成你自己的，就能拥有一台自动漫画生产机了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在 Ant Design Vue 的 a-table 中将特定数据行固定在底部]]></title>    <link>https://juejin.cn/post/7589207474135236658</link>    <guid>https://juejin.cn/post/7589207474135236658</guid>    <pubDate>2025-12-30T07:08:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589207474135236658" data-draft-id="7589250237068869642" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在 Ant Design Vue 的 a-table 中将特定数据行固定在底部"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-30T07:08:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="再吃一根胡萝卜"/> <meta itemprop="url" content="https://juejin.cn/user/871275323725533"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在 Ant Design Vue 的 a-table 中将特定数据行固定在底部
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/871275323725533/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    再吃一根胡萝卜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T07:08:52.000Z" title="Tue Dec 30 2025 07:08:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在使用 Ant Design Vue 的 <code>a-table</code> 组件时，经常会遇到这样的需求：某些数据行（如汇总行、总计行等）需要始终显示在表格底部，无论其他数据如何排序，这些特殊行都不应该移动位置。</p>
<p>本文将介绍如何通过自定义排序器实现这一功能，并展示从基础实现到优化的完整过程。</p>
<hr/>
<h2 data-id="heading-1">问题背景</h2>
<p>假设我们有一个展示各模块缺陷统计的表格，其中包含一行"全组"的汇总数据：</p>
<pre><code class="hljs language-matlab" lang="matlab">模块     | 缺陷数 | 占比   | 缺陷密度
---------|--------|--------|----------
模块A    | <span class="hljs-number">15</span>     | <span class="hljs-number">12</span><span class="hljs-comment">%    | 0.5</span>
模块B    | <span class="hljs-number">20</span>     | <span class="hljs-number">15</span><span class="hljs-comment">%    | 0.8</span>
模块C    | <span class="hljs-number">10</span>     | <span class="hljs-number">8</span><span class="hljs-comment">%     | 0.3</span>
全组     | <span class="hljs-number">45</span>     | <span class="hljs-number">35</span><span class="hljs-comment">%    | 1.6</span>
</code></pre>
<p>当用户点击表头进行排序时，"全组"这行数据应该始终保持在底部，而其他行则根据实际数值进行排序。</p>
<hr/>
<h2 data-id="heading-2">基础实现方案</h2>
<p>Ant Design Vue 的 <code>a-table</code> 组件支持通过 <code>sorter</code> 属性自定义排序逻辑。我们可以利用这个特性，在排序器中判断是否为"全组"行，如果是则强制将其排在最后。</p>
<h3 data-id="heading-3">示例代码</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
const columns = [
  { title: "模块", dataIndex: "module", key: "module" },
  {
    title: "缺陷数",
    dataIndex: "bugs",
    key: "bugs",
    sorter: (a, b) =&gt; {
      // "全组"始终排在最后
      if (a.module === "全组") return 1;
      if (b.module === "全组") return -1;
      return a.bugs - b.bugs;
    },
  },
  {
    title: "占比",
    dataIndex: "bugRatio",
    key: "bugRatio",
    sorter: (a, b) =&gt; {
      // "全组"始终排在最后
      if (a.module === "全组") return 1;
      if (b.module === "全组") return -1;
      const aVal = parseFloat(a.bugRatio) || 0;
      const bVal = parseFloat(b.bugRatio) || 0;
      return aVal - bVal;
    },
  },
];
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-4">排序原理</h3>
<p>排序器函数接收两个参数 <code>a</code> 和 <code>b</code>，返回值为：</p>
<ul>
<li>返回负数：<code>a</code> 排在 <code>b</code> 前面</li>
<li>返回 0：位置不变</li>
<li>返回正数：<code>a</code> 排在 <code>b</code> 后面</li>
</ul>
<p>通过判断 <code>a.module</code> 和 <code>b.module</code> 是否为"全组"，我们可以强制改变它们的相对位置。</p>
<hr/>
<h2 data-id="heading-5">基础方案的问题</h2>
<p>虽然上述方案可以工作，但存在以下问题：</p>
<ol>
<li><strong>缺少排序方向支持</strong>：没有使用 <code>sortOrder</code> 参数，导致升序和降序时"全组"的返回值逻辑不够清晰</li>
<li><strong>代码重复</strong>：每个可排序列都需要写相同的"全组"判断逻辑，造成大量重复代码</li>
<li><strong>维护困难</strong>：如果需要修改"全组"的判断条件或排序逻辑，需要修改多处代码</li>
</ol>
<hr/>
<h2 data-id="heading-6">优化方案：使用工厂函数</h2>
<p>为了解决代码重复问题，我们可以创建一个排序器工厂函数，将公共逻辑抽离出来。</p>
<h3 data-id="heading-7">优化后的代码</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
// 通用排序器工厂函数
const createSorter = compareFn =&gt; {
  return (a, b, sortOrder) =&gt; {
    if (sortOrder === "ascend") {
      if (a.module === "全组") return 1;
      if (b.module === "全组") return -1;
    } else if (sortOrder === "descend") {
      if (a.module === "全组") return -1;
      if (b.module === "全组") return 1;
    }
    return -compareFn(a, b);
  };
};

const columns = [
  { title: "模块", dataIndex: "module", key: "module" },
  {
    title: "缺陷数",
    dataIndex: "bugs",
    key: "bugs",
    sorter: createSorter((a, b) =&gt; a.bugs - b.bugs),
    defaultSortOrder: "ascend",
  },
  {
    title: "占比",
    dataIndex: "bugRatio",
    key: "bugRatio",
    sorter: createSorter((a, b) =&gt; {
      const aVal = parseFloat(a.bugRatio) || 0;
      const bVal = parseFloat(b.bugRatio) || 0;
      return aVal - bVal;
    }),
  },
];
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-8">工厂函数说明</h3>
<p><code>createSorter</code> 函数接收一个比较函数 <code>compareFn</code>，返回一个新的排序器函数。内部逻辑：</p>
<ol>
<li><strong>升序（ascend）</strong>：数值小的在前，"全组"在最后</li>
<li><strong>降序（descend）</strong>：数值大的在前，"全组"在最后</li>
<li><strong>默认情况</strong>：自动按降序处理</li>
</ol>
<h3 data-id="heading-9">关键点</h3>
<ul>
<li><code>sortOrder</code> 参数由 a-table 组件传入，值为 <code>"ascend"</code>、<code>"descend"</code> 或 <code>null</code></li>
<li>在降序时，使用 <code>-compareFn(a, b)</code> 反转比较结果</li>
<li>对于百分比等需要转换类型的字段，在传入的比较函数中处理</li>
</ul>
<hr/>
<h2 data-id="heading-10">完整示例</h2>
<p>下面是一个完整的表格组件示例，包含多个可排序列：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;a-table :columns="columns" :data-source="dataSource" :pagination="false" bordered /&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref } from "vue";

// 示例数据
const dataSource = ref([
  { module: "模块A", bugs: 15, bugRatio: "12%", avgDensity: 0.5 },
  { module: "模块B", bugs: 20, bugRatio: "15%", avgDensity: 0.8 },
  { module: "模块C", bugs: 10, bugRatio: "8%", avgDensity: 0.3 },
  { module: "全组", bugs: 45, bugRatio: "35%", avgDensity: 1.6 },
]);

// 通用排序器工厂函数
const createSorter = compareFn =&gt; {
  return (a, b, sortOrder) =&gt; {
    if (sortOrder === "ascend") {
      if (a.module === "全组") return 1;
      if (b.module === "全组") return -1;
    } else if (sortOrder === "descend") {
      if (a.module === "全组") return -1;
      if (b.module === "全组") return 1;
    }
    return -compareFn(a, b);
  };
};

// 表格列定义
const columns = [
  {
    title: "模块",
    dataIndex: "module",
    key: "module",
    width: 150,
    align: "center",
  },
  {
    title: "缺陷数",
    dataIndex: "bugs",
    key: "bugs",
    width: 150,
    align: "center",
    sorter: createSorter((a, b) =&gt; a.bugs - b.bugs),
    defaultSortOrder: "ascend",
  },
  {
    title: "占比",
    dataIndex: "bugRatio",
    key: "bugRatio",
    width: 150,
    align: "center",
    sorter: createSorter((a, b) =&gt; {
      const aVal = parseFloat(a.bugRatio) || 0;
      const bVal = parseFloat(b.bugRatio) || 0;
      return aVal - bVal;
    }),
  },
  {
    title: "缺陷密度",
    dataIndex: "avgDensity",
    key: "avgDensity",
    width: 150,
    align: "center",
    sorter: createSorter((a, b) =&gt; a.avgDensity - b.avgDensity),
  },
];
&lt;/script&gt;
</code></pre>
<hr/>
<h2 data-id="heading-11">扩展：支持多个特殊行</h2>
<p>如果需要固定多个特殊行（如"全组"、"总计"等），可以修改工厂函数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">createSorter</span> = (<span class="hljs-params">compareFn, pinnedModules = [<span class="hljs-string">"全组"</span>, <span class="hljs-string">"总计"</span>]</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">a, b, sortOrder</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> aIsPinned = pinnedModules.<span class="hljs-title function_">includes</span>(a.<span class="hljs-property">module</span>);
    <span class="hljs-keyword">const</span> bIsPinned = pinnedModules.<span class="hljs-title function_">includes</span>(b.<span class="hljs-property">module</span>);

    <span class="hljs-keyword">if</span> (sortOrder === <span class="hljs-string">"ascend"</span>) {
      <span class="hljs-keyword">if</span> (aIsPinned &amp;&amp; !bIsPinned) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
      <span class="hljs-keyword">if</span> (!aIsPinned &amp;&amp; bIsPinned) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">compareFn</span>(a, b);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sortOrder === <span class="hljs-string">"descend"</span>) {
      <span class="hljs-keyword">if</span> (aIsPinned &amp;&amp; !bIsPinned) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
      <span class="hljs-keyword">if</span> (!aIsPinned &amp;&amp; bIsPinned) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
      <span class="hljs-keyword">return</span> -<span class="hljs-title function_">compareFn</span>(a, b);
    }

    <span class="hljs-keyword">if</span> (aIsPinned &amp;&amp; !bIsPinned) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    <span class="hljs-keyword">if</span> (!aIsPinned &amp;&amp; bIsPinned) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    <span class="hljs-keyword">return</span> -<span class="hljs-title function_">compareFn</span>(a, b);
  };
};

<span class="hljs-comment">// 使用</span>
<span class="hljs-attr">sorter</span>: <span class="hljs-title function_">createSorter</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">bugs</span> - b.<span class="hljs-property">bugs</span>, [<span class="hljs-string">"全组"</span>, <span class="hljs-string">"总计"</span>]);
</code></pre>
<hr/>
<h2 data-id="heading-12">总结</h2>
<p>通过自定义排序器，我们可以轻松实现将特定数据行固定在表格底部的需求：</p>
<ol>
<li><strong>基础方案</strong>：在每个列的 <code>sorter</code> 中判断特殊行</li>
<li><strong>优化方案</strong>：使用工厂函数抽离公共逻辑，减少代码重复</li>
<li><strong>扩展方案</strong>：支持多个特殊行固定</li>
</ol>
<p>这种方法简单、高效，适用于任何需要固定特定行位置的表格场景。</p>
<hr/>
<h2 data-id="heading-13">相关资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.antdv.com%2Fcomponents%2Ftable-cn" target="_blank" title="https://www.antdv.com/components/table-cn" ref="nofollow noopener noreferrer">Ant Design Vue Table 组件文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FJavaScript%2FReference%2FGlobal_Objects%2FArray%2Fsort" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Array/sort" ref="nofollow noopener noreferrer">Array.prototype.sort() - MDN</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Oracle 11g 数据库卡顿排查与实战优化：一次真实的慢 SQL 定位全过程]]></title>    <link>https://juejin.cn/post/7589445154533130292</link>    <guid>https://juejin.cn/post/7589445154533130292</guid>    <pubDate>2025-12-30T06:45:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589445154533130292" data-draft-id="7589445154533097524" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Oracle 11g 数据库卡顿排查与实战优化：一次真实的慢 SQL 定位全过程"/> <meta itemprop="keywords" content="数据库,后端"/> <meta itemprop="datePublished" content="2025-12-30T06:45:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="martin1017"/> <meta itemprop="url" content="https://juejin.cn/user/587559880636395"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Oracle 11g 数据库卡顿排查与实战优化：一次真实的慢 SQL 定位全过程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/587559880636395/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    martin1017
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T06:45:03.000Z" title="Tue Dec 30 2025 06:45:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🚨 Oracle 11g 数据库卡顿排查与实战优化：一次真实的慢 SQL 定位全过程</h2>
<blockquote>
<p><strong>背景</strong><br/>
生产环境 Oracle 11g 数据库突然“很卡”，应用接口响应慢、CPU 飙高、用户大量超时。<br/>
本文完整记录一次 <strong>从现象 → 定位 → 分析 → 处置 → 优化方案</strong> 的全过程，适合 DBA / 后端开发 / 运维参考。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">一、问题现象</h3>
<ul>
<li>应用大量接口响应慢</li>
<li>数据库 CPU 使用率持续 90%+</li>
<li>会话数正常，但 <strong>ACTIVE 会话长期不释放</strong></li>
<li>Oracle 11g，无 AWR 授权（只能靠动态视图）</li>
</ul>
<hr/>
<h3 data-id="heading-2">二、第一步：查看当前正在执行的慢 SQL（实时）</h3>
<h4 data-id="heading-3">1️⃣ 查看执行超过 10 秒的 SQL</h4>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">SELECT</span> 
    s.sid,
    s.serial#,
    s.username,
    s.status,
    s.program,
    sq.sql_id,
    SUBSTR(sq.sql_text, <span class="hljs-number">1</span>, <span class="hljs-number">100</span>) <span class="hljs-keyword">AS</span> sql_text,
    s.last_call_et <span class="hljs-keyword">AS</span> 已执行秒数,
    s.<span class="hljs-keyword">event</span> <span class="hljs-keyword">AS</span> 等待事件,
    s.wait_time,
    s.seconds_in_wait
<span class="hljs-keyword">FROM</span> v$session s
<span class="hljs-keyword">JOIN</span> v$sql sq <span class="hljs-keyword">ON</span> s.sql_id = sq.sql_id
<span class="hljs-keyword">WHERE</span> s.status = <span class="hljs-comment">'ACTIVE'</span>
  <span class="hljs-built_in">AND</span> s.username <span class="hljs-built_in">NOT</span> <span class="hljs-keyword">IN</span> (<span class="hljs-comment">'SYS', 'SYSTEM')</span>
  <span class="hljs-built_in">AND</span> s.last_call_et &gt; <span class="hljs-number">10</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> s.last_call_et DESC;
</code></pre>
<h4 data-id="heading-4">🔍 执行结果解读</h4>
<ul>
<li>
<p>多个会话执行时间 <strong>几十秒 ~ 几分钟</strong></p>
</li>
<li>
<p>明显看到：</p>
<ul>
<li><code>Table Scan: GSTPGG.CEN_CHECK_MEMBER</code></li>
<li><code>Index Fast Full Scan: GSTPGG.RISK_CLUE_BASIC_INFO</code></li>
</ul>
</li>
</ul>
<p>➡️ <strong>已经可以初步判断：存在严重的全表扫描问题</strong></p>
<hr/>
<h3 data-id="heading-5">三、第二步：查看“已执行完但仍在内存中”的慢 SQL</h3>
<h4 data-id="heading-6">2️⃣ 从 <code>v$sql</code> 查历史慢 SQL</h4>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">SELECT</span> 
    sql_id,
    SUBSTR(sql_text, <span class="hljs-number">1</span>, <span class="hljs-number">100</span>) <span class="hljs-keyword">AS</span> sql_text,
    executions <span class="hljs-keyword">AS</span> 执行次数,
    ROUND(elapsed_time/<span class="hljs-number">1000000</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">AS</span> 总耗时_秒,
    ROUND(cpu_time/<span class="hljs-number">1000000</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">AS</span> CPU时间_秒,
    disk_reads <span class="hljs-keyword">AS</span> 磁盘读取,
    buffer_gets <span class="hljs-keyword">AS</span> 缓冲区获取,
    rows_processed <span class="hljs-keyword">AS</span> 处理行数,
    last_load_time <span class="hljs-keyword">AS</span> 最后加载时间
<span class="hljs-keyword">FROM</span> v$sql
<span class="hljs-keyword">WHERE</span> elapsed_time/<span class="hljs-number">1000000</span> &gt; <span class="hljs-number">5</span>
  <span class="hljs-built_in">AND</span> parsing_schema_name = <span class="hljs-comment">'GSTPGG'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> elapsed_time DESC
FETCH FIRST <span class="hljs-number">20</span> ROWS ONLY;
</code></pre>
<h4 data-id="heading-7">📊 关键发现</h4>




















<table><thead><tr><th>类型</th><th>对象</th><th>扫描方式</th></tr></thead><tbody><tr><td>多条 SQL</td><td>CEN_CHECK_MEMBER</td><td><strong>Table Scan（全表扫描）</strong></td></tr><tr><td>少量 SQL</td><td>RISK_CLUE_BASIC_INFO</td><td>Index Fast Full Scan</td></tr></tbody></table>
<p>➡️ <strong>性能瓶颈明确：CEN_CHECK_MEMBER 表</strong></p>
<hr/>
<h3 data-id="heading-8">四、第三步：定位正在执行的“长时间扫描任务”</h3>
<h4 data-id="heading-9">3️⃣ 使用 <code>v$session_longops</code> 查看进度</h4>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">SELECT</span> 
    l.sid,
    l.serial#,
    s.sql_id,
    s.sql_text,
    l.opname,
    l.target,
    l.sofar,
    l.totalwork,
    ROUND(l.sofar/l.totalwork*<span class="hljs-number">100</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">AS</span> pct_complete,
    l.elapsed_seconds,
    l.time_remaining
<span class="hljs-keyword">FROM</span> v$session_longops l
<span class="hljs-keyword">JOIN</span> v$session se <span class="hljs-keyword">ON</span> l.sid = se.sid <span class="hljs-built_in">AND</span> l.serial# = se.serial#
LEFT <span class="hljs-keyword">JOIN</span> v$sql s <span class="hljs-keyword">ON</span> se.sql_id = s.sql_id
<span class="hljs-keyword">WHERE</span> l.opname <span class="hljs-built_in">LIKE</span> <span class="hljs-comment">'%Scan%'</span>
  <span class="hljs-built_in">AND</span> l.username = <span class="hljs-comment">'GSTPGG'</span>
  <span class="hljs-built_in">AND</span> l.time_remaining &gt; <span class="hljs-number">0</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> l.start_time;
</code></pre>
<h4 data-id="heading-10">🚨 结果非常危险</h4>
<ul>
<li><strong>5 个会话同时</strong></li>
<li>对 <strong>同一张表 <code>CEN_CHECK_MEMBER</code></strong></li>
<li>进行 <strong>并发全表扫描</strong></li>
<li>每个会话扫描进度仅 <strong>8% ~ 28%</strong></li>
</ul>
<p>➡️ 这会导致：</p>
<ul>
<li>Buffer Cache 被疯狂挤占</li>
<li>其他 SQL 全部变慢</li>
<li>数据库“看起来像死了一样”</li>
</ul>
<hr/>
<h3 data-id="heading-11">五、第四步：分析问题表本身（核心）</h3>
<h4 data-id="heading-12">4️⃣ 表基本信息</h4>
<pre><code class="hljs language-ini" lang="ini">SELECT 
    owner,
    table_name,
    num_rows,
    blocks,
    avg_row_len,
    last_analyzed
FROM dba_tables 
WHERE <span class="hljs-attr">owner</span> = <span class="hljs-string">'GSTPGG'</span>
  AND <span class="hljs-attr">table_name</span> = <span class="hljs-string">'CEN_CHECK_MEMBER'</span><span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-13">📊 表分析结果</h4>

























<table><thead><tr><th>指标</th><th>数值</th></tr></thead><tbody><tr><td>行数</td><td><strong>20,496,308 行</strong></td></tr><tr><td>数据块</td><td><strong>440,297 blocks</strong></td></tr><tr><td>平均行长</td><td>149 字节</td></tr><tr><td>最近分析时间</td><td>3 天前</td></tr></tbody></table>
<h4 data-id="heading-14">⏱️ 理论扫描耗时估算</h4>
<pre><code class="hljs language-bash" lang="bash">440,297 blocks × 8KB ≈ 3.44GB
3.44GB ÷ 200MB/s ≈ 17 秒（理想）
</code></pre>
<p>⚠️ <strong>现实情况：</strong></p>
<ul>
<li>多会话并发</li>
<li>Buffer Cache 争抢</li>
<li>CPU 调度</li>
</ul>
<p>➡️ 实际耗时：<strong>几十秒 ~ 数分钟</strong></p>
<hr/>
<h3 data-id="heading-15">六、第五步：精准锁定“罪魁祸首 SQL”</h3>
<h4 data-id="heading-16">5️⃣ 找出执行全表扫描的 SQL</h4>
<pre><code class="hljs language-ini" lang="ini">SELECT 
    s.sid,
    s.serial<span class="hljs-comment">#,</span>
    s.sql_id,
    SUBSTR(q.sql_text, 1, 200) AS sql_text,
    s.program,
    s.last_call_et
FROM v$session s
JOIN v$sql q ON <span class="hljs-attr">s.sql_id</span> = q.sql_id
WHERE s.sql_id IN (
    SELECT sql_id
    FROM v$sql_plan
    WHERE <span class="hljs-attr">object_name</span> = <span class="hljs-string">'CEN_CHECK_MEMBER'</span>
      AND <span class="hljs-attr">operation</span> = <span class="hljs-string">'TABLE ACCESS'</span>
      AND <span class="hljs-attr">options</span> = <span class="hljs-string">'FULL'</span>
)<span class="hljs-comment">;</span>
</code></pre>
<p>🔎 <strong>发现多个会话在反复执行同一条 SQL</strong></p>
<hr/>
<h3 data-id="heading-17">七、第六步：打印完整 SQL（关键）</h3>
<h4 data-id="heading-18">6️⃣ 使用 <code>v$sqltext</code> 还原完整 SQL</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">LISTAGG</span>(sql_text, <span class="hljs-string">''</span>) 
       <span class="hljs-keyword">WITHIN</span> <span class="hljs-keyword">GROUP</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> piece) <span class="hljs-keyword">AS</span> full_sql_text
<span class="hljs-keyword">FROM</span> v$sqltext
<span class="hljs-keyword">WHERE</span> sql_id <span class="hljs-operator">=</span> <span class="hljs-string">'9jdbd64yqbwcf'</span>;
</code></pre>
<h4 data-id="heading-19">✅ 完整 SQL 如下：</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> ...
<span class="hljs-keyword">FROM</span> CEN_CHECK_MEMBER
<span class="hljs-keyword">WHERE</span> (card_id <span class="hljs-keyword">LIKE</span> :<span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> IS_DELETE <span class="hljs-operator">=</span> :<span class="hljs-number">2</span>)
</code></pre>
<hr/>
<h3 data-id="heading-20">八、问题本质终于浮出水面</h3>
<h3 data-id="heading-21">🚨 核心性能问题总结</h3>
<h4 data-id="heading-22">❌ 1. <code>LIKE</code> 条件导致索引失效</h4>
<ul>
<li><code>card_id LIKE '%xxx%'</code></li>
<li><strong>B-Tree 索引无法使用</strong></li>
<li>Oracle 只能选择 <strong>全表扫描</strong></li>
</ul>
<h4 data-id="heading-23">❌ 2. 表太大 + 高频调用</h4>
<ul>
<li>单表 2000 万行</li>
<li>SQL 执行 <strong>1599 次</strong></li>
<li>总逻辑读 <strong>6.67 亿次</strong></li>
<li>处理数据 <strong>2.85 亿行</strong></li>
</ul>
<h4 data-id="heading-24">❌ 3. 并发执行雪上加霜</h4>
<ul>
<li>多个 JDBC 会话同时扫描</li>
<li>Buffer Cache 被“刷爆”</li>
</ul>
<hr/>
<h3 data-id="heading-25">九、应急处理：立即止血</h3>
<h4 data-id="heading-26">7️⃣ 生成批量 Kill 会话脚本</h4>
<pre><code class="hljs language-ini" lang="ini">SELECT 
    'ALTER SYSTEM KILL SESSION ''' || s.sid || ',' || s.serial<span class="hljs-comment"># || ''' IMMEDIATE;' AS kill_cmd</span>
FROM v$session s
WHERE <span class="hljs-attr">s.sql_id</span> = <span class="hljs-string">'9jdbd64yqbwcf'</span>
  AND <span class="hljs-attr">s.username</span> = <span class="hljs-string">'GSTPGG'</span>
  AND <span class="hljs-attr">s.status</span> = <span class="hljs-string">'ACTIVE'</span>
  AND s.last_call_et &gt; 10<span class="hljs-comment">;</span>
</code></pre>
<blockquote>
<p>⚠️ <strong>仅用于应急，务必与业务确认</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-27">十、根本解决方案（重点）</h3>
<h3 data-id="heading-28">✅ 方案一：创建正确索引</h3>
<pre><code class="hljs language-ini" lang="ini">CREATE INDEX IDX_CEN_CHECK_MEMBER_CARD_DEL
ON GSTPGG.CEN_CHECK_MEMBER(card_id, IS_DELETE)
NOLOGGING PARALLEL 8<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-29">索引生效前提</h4>

















<table><thead><tr><th>LIKE 写法</th><th>是否走索引</th></tr></thead><tbody><tr><td><code>card_id LIKE '123%'</code></td><td>✅ 是</td></tr><tr><td><code>card_id LIKE '%123%'</code></td><td>❌ 否</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-30">✅ 方案二：业务 SQL 改造建议</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 原（危险）</span>
<span class="hljs-keyword">WHERE</span> card_id <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'%123%'</span>

<span class="hljs-comment">-- 优化（可控）</span>
<span class="hljs-keyword">WHERE</span> card_id <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'123%'</span>
</code></pre>
<hr/>
<h3 data-id="heading-31">✅ 方案三：分页 + 列裁剪</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> mem_number, mem_name, card_id
<span class="hljs-keyword">FROM</span> CEN_CHECK_MEMBER
<span class="hljs-keyword">WHERE</span> card_id <span class="hljs-keyword">LIKE</span> :<span class="hljs-number">1</span>
  <span class="hljs-keyword">AND</span> IS_DELETE <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
<span class="hljs-keyword">AND</span> ROWNUM <span class="hljs-operator">&lt;=</span> <span class="hljs-number">50</span>;
</code></pre>
<hr/>
<h3 data-id="heading-32">十一、经验总结（血的教训）</h3>
<blockquote>
<p><strong>Oracle 慢 SQL 排查三板斧：</strong></p>
</blockquote>
<ol>
<li><strong>v$session</strong>：看现在谁在跑</li>
<li><strong>v<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>q</mi><mi>l</mi><mi mathvariant="normal">/</mi><mi>v</mi></mrow><annotation encoding="application/x-tex">sql / v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.01968em;">ql</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span></span>sql_plan</strong>：看谁最耗资源</li>
<li><strong>执行计划 + 表规模</strong>：判断是不是“不该扫却在扫”</li>
</ol>
<hr/>
<h3 data-id="heading-33">🎯 最终结论</h3>
<blockquote>
<p><strong>数据库不是“突然变慢”的，而是某条 SQL 在特定条件下被放大了 1000 倍。</strong></p>
</blockquote>
<ul>
<li>一次 <code>%LIKE%</code></li>
<li>一张 2000 万行表</li>
<li>几个并发会话<br/>
➡️ 足以拖垮整个 Oracle 实例</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手搓前端虚拟列表]]></title>    <link>https://juejin.cn/post/7589201772134416425</link>    <guid>https://juejin.cn/post/7589201772134416425</guid>    <pubDate>2025-12-30T06:34:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589201772134416425" data-draft-id="7589220406319710244" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手搓前端虚拟列表"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-30T06:34:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="echo_e"/> <meta itemprop="url" content="https://juejin.cn/user/1267099625328903"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手搓前端虚拟列表
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1267099625328903/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    echo_e
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T06:34:17.000Z" title="Tue Dec 30 2025 06:34:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">虚拟列表</h2>
<h3 data-id="heading-1">虚拟列表（VirtualList）核心原理详解：</h3>
<ol>
<li>
<p>只渲染可见区域的数据项，极大减少 DOM 数量，提升性能。</p>
</li>
<li>
<p>用 .phantom 绝对定位元素撑起总高度，制造完整滚动条体验。</p>
</li>
<li>
<p>.real-list 绝对定位，通过 transform: translateY(offset) 精确移动到可见区顶部。</p>
<ul>
<li>.real-list 的高度无需设置，内容高度由渲染的 item 数量自动撑开。</li>
<li>为什么不设置 .real-list 高度？
<ul>
<li>只要保证 .phantom 撑起滚动条，.real-list 只需渲染可见项并偏移到正确位置即可。</li>
<li>.real-list 的高度 = (end - start) * itemHeight，由渲染的 div 自动撑开。</li>
<li>这样可以避免多余的空白区域，且滚动时始终只渲染需要的 DOM。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>滚动时根据 scrollTop 动态计算可见区的 start/end 索引，只渲染这部分数据。</p>
</li>
<li>
<p>overScan 预渲染缓冲区，避免滚动过快出现白屏。
代码结构说明：</p>
<ul>
<li>VirtualList 构造函数：
<ul>
<li>自动获取容器高度（container.clientHeight），计算可见项数 visibleCount。</li>
<li>创建 .phantom 元素，高度为 data.length * itemHeight，撑起滚动条。</li>
<li>创建 .real-list 元素，实际渲染可见区的 item。</li>
<li>绑定 scroll 事件，滚动时触发 render。</li>
</ul>
</li>
<li>render 方法：
<ul>
<li>计算当前滚动 scrollTop。</li>
<li>计算可见区起止索引 start/end（含 overScan）。</li>
<li>计算 .real-list 的 translateY 偏移量 offsetY = start * itemHeight。</li>
<li>只渲染 start~end 区间的数据项。</li>
</ul>
</li>
<li>getColor：
<ul>
<li>为每个 item 缓存唯一随机色，保证滚动复用时颜色不变。</li>
</ul>
</li>
</ul>
<p>这样实现后：</p>
<ul>
<li>页面上始终只有几十个 DOM 节点，哪怕数据有 10 万条。</li>
<li>滚动条长度、滚动体验与原生长列表一致。</li>
<li>性能极高，不卡顿。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-2">代码演示</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>手搓虚拟列表<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-tag">body</span> {
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#fff</span>;
        }

        * {
            <span class="hljs-attribute">box-sizing</span>: border-box;
        }

        <span class="hljs-selector-id">#container</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100vw</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>;
            <span class="hljs-attribute">overflow-y</span>: auto;
            <span class="hljs-attribute">position</span>: relative;
        }

        <span class="hljs-selector-class">.item</span> {
            <span class="hljs-attribute">height</span>: <span class="hljs-number">50px</span>;
            <span class="hljs-attribute">line-height</span>: <span class="hljs-number">50px</span>;
            <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#eee</span>;
            <span class="hljs-attribute">box-sizing</span>: border-box;
            <span class="hljs-attribute">text-align</span>: center;
        }

        <span class="hljs-selector-class">.phantom</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">position</span>: absolute;
            <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">z-index</span>: <span class="hljs-number">0</span>;
        }

        <span class="hljs-selector-class">.real-list</span> {
            <span class="hljs-attribute">position</span>: absolute;
            <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">z-index</span>: <span class="hljs-number">1</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-comment">&lt;!--
        虚拟列表（VirtualList）核心原理详解：

        1. 只渲染可见区域的数据项，极大减少 DOM 数量，提升性能。
        2. 用 .phantom 绝对定位元素撑起总高度，制造完整滚动条体验。
        3. .real-list 绝对定位，通过 transform: translateY(offset) 精确移动到可见区顶部。
            - .real-list 的高度无需设置，内容高度由渲染的 item 数量自动撑开。
            - 为什么不设置 .real-list 高度？
                * 只要保证 .phantom 撑起滚动条，.real-list 只需渲染可见项并偏移到正确位置即可。
                * .real-list 的高度 = (end - start) * itemHeight，由渲染的 div 自动撑开。
                * 这样可以避免多余的空白区域，且滚动时始终只渲染需要的 DOM。
        4. 滚动时根据 scrollTop 动态计算可见区的 start/end 索引，只渲染这部分数据。
        5. overscan 预渲染缓冲区，避免滚动过快出现白屏。

        代码结构说明：
        - VirtualList 构造函数：
            * 自动获取容器高度（container.clientHeight），计算可见项数 visibleCount。
            * 创建 .phantom 元素，高度为 data.length * itemHeight，撑起滚动条。
            * 创建 .real-list 元素，实际渲染可见区的 item。
            * 绑定 scroll 事件，滚动时触发 render。
        - render 方法：
            * 计算当前滚动 scrollTop。
            * 计算可见区起止索引 start/end（含 overscan）。
            * 计算 .real-list 的 translateY 偏移量 offsetY = start * itemHeight。
            * 只渲染 start~end 区间的数据项。
        - getColor：
            * 为每个 item 缓存唯一随机色，保证滚动复用时颜色不变。

        这样实现后：
        - 页面上始终只有几十个 DOM 节点，哪怕数据有 10 万条。
        - 滚动条长度、滚动体验与原生长列表一致。
        - 性能极高，不卡顿。
        --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"container"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-comment">/**
         * 虚拟列表类，适用于大数据量高性能滚动渲染
         */</span>
        <span class="hljs-keyword">class</span> <span class="hljs-title class_">VirtualList</span> {
            <span class="hljs-comment">/**
             * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">options</span>
             * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLElement</span>} options.container 容器元素
             * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Array</span>} options.data 数据源数组
             * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} options.itemHeight 单项高度（px）
             * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} options.containerHeight 容器高度（px）
             * <span class="hljs-doctag">@param</span> {<span class="hljs-type">function</span>} options.renderItem 渲染单项函数 (item, index) =&gt; html字符串
             * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} [options.overscan=5] 预渲染缓冲区（可见区上下多渲染几项，提升滚动体验）
             */</span>
            <span class="hljs-title function_">constructor</span>(<span class="hljs-params">{ container, data, itemHeight, renderItem, overscan = <span class="hljs-number">5</span> }</span>) {
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span> = container;
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = data;
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">itemHeight</span> = itemHeight;
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">renderItem</span> = renderItem;
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">overscan</span> = overscan;

                <span class="hljs-comment">// 自动获取容器高度</span>
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerHeight</span> = container.<span class="hljs-property">clientHeight</span>;
                <span class="hljs-comment">// 计算可见区域最多能显示多少项</span>
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">visibleCount</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">containerHeight</span> / itemHeight);

                <span class="hljs-comment">// 创建伪元素撑起总高度</span>
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">phantom</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">phantom</span>.<span class="hljs-property">className</span> = <span class="hljs-string">'phantom'</span>;
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">phantom</span>.<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = data.<span class="hljs-property">length</span> * itemHeight + <span class="hljs-string">'px'</span>;
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">phantom</span>);

                <span class="hljs-comment">// 真正渲染的列表区域</span>
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">realList</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">realList</span>.<span class="hljs-property">className</span> = <span class="hljs-string">'real-list'</span>;
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">realList</span>);

                <span class="hljs-comment">// 绑定滚动事件</span>
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleScroll</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>));

                <span class="hljs-comment">// 首次渲染</span>
                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">render</span>();
            }

            <span class="hljs-comment">/**
             * 滚动事件处理，重新渲染可见区域
             */</span>
            <span class="hljs-title function_">handleScroll</span>(<span class="hljs-params"/>) {
                <span class="hljs-comment">// this.render();</span>
                <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">rafId</span>) <span class="hljs-title function_">cancelAnimationFrame</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">rafId</span>);
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">rafId</span> = <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> {
                    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">render</span>();
                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">rafId</span> = <span class="hljs-literal">null</span>;
                });
            }
            <span class="hljs-comment">// 17 + 5 + 5 = 27</span>
            <span class="hljs-comment">/**
             * 渲染可见区域的列表项
             */</span>
            <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
                <span class="hljs-comment">// 当前滚动距离</span>
                <span class="hljs-keyword">const</span> scrollTop = <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-property">scrollTop</span>;
                <span class="hljs-comment">/*
                假设我们的visibleCount是10，预留的是5个，也就是实际渲染会渲染10+5*2 = 20个
                这个时候如果滚动高度超过5个，滚动其实就是展示visibleCount之外的列表，如果超过5个的高度（其实还预留了5个）
                那这个时候就要移动start之前是(0-19)展示20个列表，start=1就要展示(1,20)个。
                这个时候如果不操作realList的transform的话，这个时候整个realList就是移动到看不到的地方了
                */</span>
                <span class="hljs-keyword">let</span> start = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(scrollTop / <span class="hljs-variable language_">this</span>.<span class="hljs-property">itemHeight</span>) - <span class="hljs-variable language_">this</span>.<span class="hljs-property">overscan</span>;
                start = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, start);
                <span class="hljs-comment">// 计算可见区域结束索引</span>
                <span class="hljs-keyword">let</span> end = start + <span class="hljs-variable language_">this</span>.<span class="hljs-property">visibleCount</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">overscan</span> * <span class="hljs-number">2</span>;
                end = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">length</span>, end);

                <span class="hljs-comment">// 只有 start 或 end 发生变化时才更新 DOM</span>
                <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">_lastStart</span> === start &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">_lastEnd</span> === end) {
                    <span class="hljs-comment">// 没有新元素进入视口，无需更新</span>
                    <span class="hljs-keyword">return</span>;
                }
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">_lastStart</span> = start;
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">_lastEnd</span> = end;

                <span class="hljs-comment">// 计算真实列表的偏移量</span>
                <span class="hljs-keyword">const</span> offsetY = start * <span class="hljs-variable language_">this</span>.<span class="hljs-property">itemHeight</span>;
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'render'</span>, { scrollTop, start, end, offsetY });
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">realList</span>.<span class="hljs-property">style</span>.<span class="hljs-property">transform</span> = <span class="hljs-string">`translateY(<span class="hljs-subst">${offsetY}</span>px)`</span>;
                <span class="hljs-comment">// 渲染可见项</span>
                <span class="hljs-keyword">let</span> html = <span class="hljs-string">''</span>;
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = start; i &lt; end; i++) {
                    html += <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">renderItem</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>[i], i);
                }
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">realList</span>.<span class="hljs-property">innerHTML</span> = html;
            }
        }

        <span class="hljs-comment">// 示例数据</span>
        <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">100000</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> <span class="hljs-string">`第 <span class="hljs-subst">${i + <span class="hljs-number">1</span>}</span> 项`</span>);

        <span class="hljs-comment">// 实例化虚拟列表</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">VirtualList</span>({
            <span class="hljs-attr">container</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'container'</span>),
            data,
            <span class="hljs-attr">itemHeight</span>: <span class="hljs-number">50</span>,
            <span class="hljs-attr">renderItem</span>: <span class="hljs-function">(<span class="hljs-params">item, idx</span>) =&gt;</span> <span class="hljs-string">`&lt;div class="item" &gt;<span class="hljs-subst">${item}</span>&lt;/div&gt;`</span>
        });
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
</code></pre>
<h3 data-id="heading-3">关键逻辑图解</h3>
<ul>
<li>滚动方案
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08397ed1129e4b119637540f30ca08f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZWNob19l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681256&amp;x-signature=5240Eq12gUE6tt4TXQPygRthTL8%3D" alt="image.png" loading="lazy"/></li>
<li>parent撑起高度，模拟item数量下的滚动
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b20a430a4e4407f8f8ade9a34c4aa10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZWNob19l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681256&amp;x-signature=VZjO0ofcKAoGDCPod9%2FxROkpmZg%3D" alt="image-1.png" loading="lazy"/></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java常见面试题及答案汇总]]></title>    <link>https://juejin.cn/post/7589275237038129187</link>    <guid>https://juejin.cn/post/7589275237038129187</guid>    <pubDate>2025-12-30T07:11:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589275237038129187" data-draft-id="7589445154533244980" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java常见面试题及答案汇总"/> <meta itemprop="keywords" content="后端,面试,Java"/> <meta itemprop="datePublished" content="2025-12-30T07:11:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java水解"/> <meta itemprop="url" content="https://juejin.cn/user/2441349519143037"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java常见面试题及答案汇总
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2441349519143037/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java水解
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T07:11:43.000Z" title="Tue Dec 30 2025 07:11:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0"><strong>📚 一、Java 基础</strong></h3>
<h4 data-id="heading-1"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>1. Java 的三大特性是什么？</strong></h4>
<p>✅ <strong>答案：</strong></p>
<ul>
<li><strong>封装</strong>：隐藏对象的属性和实现细节，仅对外提供访问方式（getter/setter）。</li>
<li><strong>继承</strong>：子类继承父类的属性和方法，提高代码复用性。</li>
<li><strong>多态</strong>：同一方法在不同对象上有不同行为（方法重写、接口实现）。</li>
</ul>
<h4 data-id="heading-2"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>2. == 和 equals() 的区别？</strong></h4>
<p>✅ <strong>答案：</strong></p>
<ul>
<li><code>==</code>：比较基本数据类型的值，或引用类型的内存地址。</li>
<li><code>equals()</code>：默认比较对象地址（Object类），但可被重写（如 String 比较内容）。</li>
</ul>
<h4 data-id="heading-3"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>3. String、StringBuilder、StringBuffer 的区别？</strong></h4>
<p>✅ <strong>答案：</strong></p>





























<table><thead><tr><th>类</th><th>可变性</th><th>线程安全</th><th>适用场景</th></tr></thead><tbody><tr><td><code>String</code></td><td>❌ 不可变</td><td>✅ 安全（final）</td><td>字符串常量</td></tr><tr><td><code>StringBuilder</code></td><td>✅ 可变</td><td>❌ 不安全</td><td>单线程字符串操作</td></tr><tr><td><code>StringBuffer</code></td><td>✅ 可变</td><td>✅ 安全（synchronized）</td><td>多线程字符串操作</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-4"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>🔍 二、Java 集合</strong></h3>
<h4 data-id="heading-5"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>4. ArrayList 和 LinkedList 的区别？</strong></h4>
<p>✅ <strong>答案：</strong></p>






























<table><thead><tr><th>对比项</th><th>ArrayList</th><th>LinkedList</th></tr></thead><tbody><tr><td><strong>底层结构</strong></td><td>动态数组</td><td>双向链表</td></tr><tr><td><strong>查询效率</strong></td><td>O(1)（随机访问快）</td><td>O(n)（需遍历）</td></tr><tr><td><strong>增删效率</strong></td><td>O(n)（需移动元素）</td><td>O(1)（头尾操作快）</td></tr><tr><td><strong>适用场景</strong></td><td>频繁查询</td><td>频繁增删</td></tr></tbody></table>
<blockquote>
<blockquote>
<p><strong>篇幅限制下面就只能给大家展示小册部分内容了。整理了一份核心面试笔记包括了：Java面试、Spring、JVM、MyBatis、Redis、MySQL、并发编程、微服务、Linux、Springboot、SpringCloud、MQ、Kafka 面试专题</strong></p>
<blockquote>
</blockquote>
<p><strong>需要全套面试笔记及答案【扫一扫】</strong>                            即可免费获取**</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7017d7585f1048c1bab73d5d714f9e19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767684857&amp;x-signature=XljKZ4K0nlQ%2FQbxcxmKYAgXkOvk%3D" alt="8fbf1ef8b61e2dbbb33b7690a41d12e.png" loading="lazy"/></p>
</blockquote>
<h4 data-id="heading-6"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>5. HashMap 的底层原理？</strong></h4>
<p>✅ <strong>答案：</strong></p>
<ul>
<li><strong>JDK 1.7</strong>：数组 + 链表（哈希冲突时链表存储）。</li>
<li><strong>JDK 1.8+</strong> ：数组 + 链表 + 红黑树（链表长度 ≥8 时转红黑树）。</li>
<li><strong>扩容机制</strong>：默认容量 16，负载因子 0.75，扩容时容量翻倍。</li>
</ul>
<hr/>
<h3 data-id="heading-7"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>⚡ 三、多线程 &amp; 并发</strong></h3>
<h4 data-id="heading-8"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>6. 线程的创建方式有哪些？</strong></h4>
<p>✅ <strong>答案：</strong></p>
<ol>
<li><strong>继承 Thread 类</strong>（不推荐，单继承限制）。</li>
<li><strong>实现 Runnable 接口</strong>（推荐，可复用）。</li>
<li><strong>实现 Callable 接口</strong>（可返回结果，配合 FutureTask）。</li>
<li><strong>线程池（ExecutorService）</strong> （推荐，管理线程资源）。</li>
</ol>
<h4 data-id="heading-9"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>7. synchronized 和 ReentrantLock 的区别？</strong></h4>
<p>✅ <strong>答案：</strong></p>






























<table><thead><tr><th>对比项</th><th>synchronized</th><th>ReentrantLock</th></tr></thead><tbody><tr><td><strong>实现方式</strong></td><td>JVM 层面</td><td>Java API 层面</td></tr><tr><td><strong>锁类型</strong></td><td>非公平锁</td><td>可公平/非公平</td></tr><tr><td><strong>可中断</strong></td><td>❌ 不支持</td><td>✅ 支持（lockInterruptibly）</td></tr><tr><td><strong>条件变量</strong></td><td>❌ 不支持</td><td>✅ 支持（Condition）</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-10"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>🛠️ 四、JVM</strong></h3>
<h4 data-id="heading-11"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>8. JVM 内存模型（运行时数据区）？</strong></h4>
<p>✅ <strong>答案：</strong></p>
<ul>
<li><strong>方法区（元空间）</strong> ：存储类信息、常量、静态变量。</li>
<li><strong>堆（Heap）</strong> ：存放对象实例（GC 主要区域）。</li>
<li><strong>虚拟机栈</strong>：存储方法调用、局部变量表。</li>
<li><strong>本地方法栈</strong>：Native 方法调用。</li>
<li><strong>程序计数器</strong>：记录线程执行位置。</li>
</ul>
<h4 data-id="heading-12"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>9. 垃圾回收算法有哪些？</strong></h4>
<p>✅ <strong>答案：</strong></p>
<ul>
<li><strong>标记-清除</strong>：简单但内存碎片多。</li>
<li><strong>复制算法</strong>：高效（新生代使用），但浪费空间。</li>
<li><strong>标记-整理</strong>：适合老年代，减少碎片。</li>
<li><strong>分代收集</strong>：新生代（复制算法） + 老年代（标记-整理）。</li>
</ul>
<hr/>
<h3 data-id="heading-13"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>🌱 五、Spring</strong></h3>
<h4 data-id="heading-14"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>10. Spring Bean 的生命周期？</strong></h4>
<p>✅ <strong>答案：</strong></p>
<ol>
<li><strong>实例化</strong>（new）</li>
<li><strong>属性赋值</strong>（populate）</li>
<li><strong>初始化</strong>（<code>@PostConstruct</code>、<code>InitializingBean</code>）</li>
<li><strong>使用</strong></li>
<li><strong>销毁</strong>（<code>@PreDestroy</code>、<code>DisposableBean</code>）</li>
</ol>
<blockquote>
<blockquote>
<p><strong>篇幅限制下面就只能给大家展示小册部分内容了。整理了一份核心面试笔记包括了：Java面试、Spring、JVM、MyBatis、Redis、MySQL、并发编程、微服务、Linux、Springboot、SpringCloud、MQ、Kafka 面试专题</strong></p>
<blockquote>
</blockquote>
<p><strong>需要全套面试笔记及答案【扫一扫】</strong>                            即可免费获取**</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7017d7585f1048c1bab73d5d714f9e19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767684857&amp;x-signature=XljKZ4K0nlQ%2FQbxcxmKYAgXkOvk%3D" alt="8fbf1ef8b61e2dbbb33b7690a41d12e.png" loading="lazy"/></p>
</blockquote>
<h4 data-id="heading-15"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>11. Spring AOP 的实现原理？</strong></h4>
<p>✅ <strong>答案：</strong></p>
<ul>
<li><strong>JDK 动态代理</strong>（基于接口）。</li>
<li><strong>CGLIB 动态代理</strong>（基于子类，无接口时使用）。</li>
<li>核心：<code>ProxyFactory</code> + <code>MethodInterceptor</code>。</li>
</ul>
<hr/>
<h3 data-id="heading-16"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>📊 六、数据库 &amp; 缓存</strong></h3>
<h4 data-id="heading-17"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>12. MySQL 索引失效的场景？</strong></h4>
<p>✅ <strong>答案：</strong></p>
<ul>
<li>使用 <code>!=</code>、<code>&lt;&gt;</code>、<code>NOT IN</code>。</li>
<li>对索引列进行运算（如 <code>WHERE age + 1 &gt; 20</code>）。</li>
<li>使用 <code>LIKE '%xx'</code>（左模糊）。</li>
<li>联合索引未遵循最左前缀原则。</li>
</ul>
<h4 data-id="heading-18"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>13. Redis 持久化方式？</strong></h4>
<p>✅ <strong>答案：</strong></p>
<ul>
<li><strong>RDB（快照）</strong> ：定时全量备份，恢复快但可能丢数据。</li>
<li><strong>AOF（日志）</strong> ：记录写命令，数据更安全但文件较大。</li>
<li><strong>混合模式（Redis 4.0+）</strong> ：RDB + AOF 结合。</li>
</ul>
<hr/>
<h3 data-id="heading-19"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>🚀 七、分布式 &amp; 微服务</strong></h3>
<h4 data-id="heading-20"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>14. CAP 理论是什么？</strong></h4>
<p>✅ <strong>答案：</strong></p>
<ul>
<li><strong>C（一致性）</strong> ：所有节点数据一致。</li>
<li><strong>A（可用性）</strong> ：每次请求都能响应。</li>
<li><strong>P（分区容错性）</strong> ：网络分区时仍能运行。</li>
<li><strong>结论</strong>：分布式系统只能满足其中两项（如 CP、AP）。</li>
</ul>
<h4 data-id="heading-21"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>15. 如何解决分布式事务问题？</strong></h4>
<p>✅ <strong>答案：</strong></p>
<ul>
<li><strong>2PC（两阶段提交）</strong> ：协调者 + 参与者，强一致但阻塞。</li>
<li><strong>TCC（Try-Confirm-Cancel）</strong> ：业务补偿，适用于高并发。</li>
<li><strong>SAGA</strong>：长事务拆分 + 补偿机制。</li>
<li><strong>本地消息表</strong>：异步确保最终一致。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[来自美团生产环境的实战派：开源CAT监控，如何保障超大规模分布式系统可观测性？]]></title>    <link>https://juejin.cn/post/7589194558288642086</link>    <guid>https://juejin.cn/post/7589194558288642086</guid>    <pubDate>2025-12-30T05:49:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589194558288642086" data-draft-id="7589167252723515442" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="来自美团生产环境的实战派：开源CAT监控，如何保障超大规模分布式系统可观测性？"/> <meta itemprop="keywords" content="分布式,开源"/> <meta itemprop="datePublished" content="2025-12-30T05:49:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大厂技术总监下海"/> <meta itemprop="url" content="https://juejin.cn/user/4091714106833577"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            来自美团生产环境的实战派：开源CAT监控，如何保障超大规模分布式系统可观测性？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4091714106833577/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大厂技术总监下海
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T05:49:07.000Z" title="Tue Dec 30 2025 05:49:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">CAT（Central Application Tracking）深度技术解读</h2>
<h3 data-id="heading-1">1. 整体介绍</h3>
<h4 data-id="heading-2">1.1 项目概况</h4>
<p><strong>CAT</strong> 是由美团点评（现美团）开源的实时应用监控平台，项目地址为：<code>https://github.com/dianping/cat</code>。截至当前，该项目在GitHub上获得超过1.8万星标，被分叉超过7千次，具备活跃的社区生态。项目采用Apache 2.0开源协议，主要使用Java语言开发。</p>
<h4 data-id="heading-3">1.2 核心功能特性</h4>
<p>CAT定位为分布式系统的实时监控基础设施，其核心特性包括：</p>
<ul>
<li><strong>秒级实时处理能力</strong>：监控数据从客户端产生到服务端处理展示的延迟控制在秒级，实现近实时监控。</li>
<li><strong>多语言客户端支持</strong>：提供Java、C/C++、Node.js、Python、Go等多语言客户端SDK，便于异构技术栈接入。</li>
<li><strong>四种监控数据模型</strong>：
<ul>
<li><strong>Transaction</strong>：记录跨系统边界的事务（如HTTP请求、RPC调用）</li>
<li><strong>Event</strong>：记录离散事件（如异常、关键日志）</li>
<li><strong>Heartbeat</strong>：定期上报系统指标（JVM状态、负载等）</li>
<li><strong>Metric</strong>：记录业务指标和计数器</li>
</ul>
</li>
<li><strong>全量数据采集与分析</strong>：客户端进行数据预计算，服务端进行全量统计分析，避免采样偏差。</li>
</ul>
<h4 data-id="heading-4">1.3 解决问题与适用场景</h4>
<p><strong>解决的问题要素</strong>：</p>
<ol>
<li><strong>故障发现滞后</strong>：传统监控系统数据处理延迟高，故障发现时间长。</li>
<li><strong>故障定位困难</strong>：分布式系统调用链复杂，问题根因定位成本高。</li>
<li><strong>监控数据不完整</strong>：基于采样的监控系统可能遗漏关键故障数据。</li>
<li><strong>多语言系统监控分散</strong>：不同技术栈需要不同的监控工具，运维复杂度高。</li>
<li><strong>监控系统自身故障影响业务</strong>：部分监控方案侵入性强，可能影响业务稳定性。</li>
</ol>
<p><strong>对应场景</strong>：</p>
<ul>
<li>大规模分布式微服务架构的系统监控</li>
<li>需要实时业务指标监控的电商、金融等系统</li>
<li>多技术栈混合的复杂系统环境</li>
<li>对系统可用性和性能有较高要求的在线服务</li>
</ul>
<h4 data-id="heading-5">1.4 解决方案演进</h4>
<p><strong>传统方式</strong>：</p>
<ul>
<li>基于日志文件的离线分析，延迟通常在小时级别</li>
<li>采样监控（如1%采样率）可能遗漏关键异常</li>
<li>各语言使用独立的监控方案，数据难以聚合</li>
<li>监控系统与业务系统紧耦合，故障可能相互影响</li>
</ul>
<p><strong>CAT新方式的优势</strong>：</p>
<ul>
<li><strong>实时性提升</strong>：从小时级降至秒级，大幅缩短MTTR</li>
<li><strong>数据完整性</strong>：全量数据采集确保故障复盘准确性</li>
<li><strong>统一监控平台</strong>：多语言统一接入，降低运维复杂度</li>
<li><strong>对业务透明</strong>：客户端异步上报，监控系统故障不影响业务</li>
</ul>
<h4 data-id="heading-6">1.5 商业价值分析</h4>
<p><strong>价值估算逻辑</strong>：</p>
<ol>
<li><strong>代码复用成本节约</strong>：企业自研同等能力的监控系统通常需要20-30人月的投入，CAT提供了成熟的开源实现。</li>
<li><strong>故障恢复效益</strong>：实时监控可将故障平均恢复时间（MTTR）降低50-70%，按每次故障损失1万元计算，年节约数十万至数百万。</li>
<li><strong>运维效率提升</strong>：统一监控平台减少多工具维护成本，预计提升运维效率30%。</li>
<li><strong>问题预防价值</strong>：通过趋势分析提前发现潜在问题，避免重大故障发生。</li>
</ol>
<p>保守估计，中型互联网企业采用CAT可获得年化百万元级别的综合收益。</p>
<h3 data-id="heading-7">2. 详细功能拆解</h3>
<h4 data-id="heading-8">2.1 架构模块分解</h4>
<pre><code class="hljs language-markdown" lang="markdown">CAT架构层级：
<span class="hljs-bullet">1.</span> 数据采集层（Client SDK）
<span class="hljs-bullet">   -</span> Java客户端（lib/java）
<span class="hljs-bullet">   -</span> 多语言客户端（C/C++、Node.js等）
<span class="hljs-bullet">   -</span> 埋点与数据预计算

<span class="hljs-bullet">2.</span> 数据处理层（Consumer）
<span class="hljs-bullet">   -</span> 消息队列缓冲
<span class="hljs-bullet">   -</span> 实时分析器（Analyzer）
<span class="hljs-bullet">   -</span> 报表生成

<span class="hljs-bullet">3.</span> 数据存储层
<span class="hljs-bullet">   -</span> 本地文件存储（Bucket机制）
<span class="hljs-bullet">   -</span> HDFS归档存储（cat-hadoop）
<span class="hljs-bullet">   -</span> MySQL配置存储

<span class="hljs-bullet">4.</span> 服务展示层（Home）
<span class="hljs-bullet">   -</span> Web管理界面
<span class="hljs-bullet">   -</span> 实时报表展示
<span class="hljs-bullet">   -</span> 配置管理

<span class="hljs-bullet">5.</span> 告警服务层（Alarm）
<span class="hljs-bullet">   -</span> 阈值监控
<span class="hljs-bullet">   -</span> 告警规则引擎
<span class="hljs-bullet">   -</span> 多渠道通知
</code></pre>
<h4 data-id="heading-9">2.2 核心功能设计</h4>
<p><strong>实时处理流程</strong>：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">客户端埋点 → 本地队列缓冲 → 异步网络传输 → 服务端接收队列 → 
实时分析器处理 → 内存聚合 → 分钟级持久化 → 报表展示
</code></pre>
<p><strong>数据模型设计特点</strong>：</p>
<ul>
<li><strong>Transaction模型</strong>：支持嵌套结构，记录完整调用链路</li>
<li><strong>采样策略</strong>：全量统计与采样链路相结合，平衡性能与数据完整性</li>
<li><strong>预计算机制</strong>：客户端进行初步统计，减轻服务端压力</li>
</ul>
<h3 data-id="heading-10">3. 技术难点与解决方案</h3>
<h4 data-id="heading-11">3.1 高吞吐实时处理</h4>
<p><strong>难点</strong>：单机需要处理数万到数十万QPS的监控数据。
<strong>解决方案</strong>：</p>
<ul>
<li>客户端本地缓冲+批量发送</li>
<li>服务端使用内存队列缓冲（MessageQueue）</li>
<li>多分析器并行处理架构</li>
</ul>
<h4 data-id="heading-12">3.2 全量数据统计与存储</h4>
<p><strong>难点</strong>：全量数据带来的存储和计算压力。
<strong>解决方案</strong>：</p>
<ul>
<li>分层存储策略：热数据内存聚合，温数据本地文件，冷数据HDFS</li>
<li>基于时间的分片存储（Bucket机制）</li>
<li>压缩存储优化（Snappy压缩算法）</li>
</ul>
<h4 data-id="heading-13">3.3 客户端采样与服务器聚合</h4>
<p><strong>难点</strong>：平衡数据完整性和系统负载。
<strong>解决方案</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// AbstractMessageAnalyzer中的采样逻辑</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEligable</span><span class="hljs-params">(MessageTree tree)</span> {
    <span class="hljs-comment">// 采样判断逻辑，控制分析的数据量</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 默认全量处理，特定分析器可重写</span>
}
</code></pre>
<h4 data-id="heading-14">3.4 多语言客户端一致性</h4>
<p><strong>难点</strong>：保证不同语言客户端行为一致。
<strong>解决方案</strong>：</p>
<ul>
<li>统一定义消息编码协议</li>
<li>各语言实现核心接口的一致性</li>
<li>共享测试用例确保行为对齐</li>
</ul>
<h3 data-id="heading-15">4. 详细设计图</h3>
<h4 data-id="heading-16">4.1 整体架构图</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "客户端层"
        A1[Java应用] --&gt; A2[CAT Java客户端]
        B1[Go应用] --&gt; B2[CAT Go客户端]
        C1[Python应用] --&gt; C2[CAT Python客户端]
    end
    
    subgraph "传输层"
        A2 --&gt; D[消息编码/序列化]
        B2 --&gt; D
        C2 --&gt; D
        D --&gt; E[网络传输]
    end
    
    subgraph "服务端层"
        E --&gt; F[消息接收器]
        F --&gt; G[消息队列]
        G --&gt; H{分析器路由}
        
        subgraph "分析器集群"
            H --&gt; I1[Transaction分析器]
            H --&gt; I2[Event分析器]
            H --&gt; I3[Heartbeat分析器]
            H --&gt; I4[Metric分析器]
        end
        
        I1 --&gt; J[报表管理器]
        I2 --&gt; J
        I3 --&gt; J
        I4 --&gt; J
        
        J --&gt; K[存储管理器]
        K --&gt; L[本地文件存储]
        K --&gt; M[MySQL配置存储]
        K --&gt; N[HDFS归档存储]
        
        J --&gt; O[告警引擎]
        O --&gt; P[告警通知]
    end
    
    subgraph "展示层"
        Q[Web管理界面] --&gt; R[实时报表]
        Q --&gt; S[配置管理]
        Q --&gt; T[日志查询]
    end
</code></pre>
<h4 data-id="heading-17">4.2 核心处理序列图</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Client as 客户端
    participant Queue as 消息队列
    participant Analyzer as 分析器
    participant Storage as 存储层
    participant Manager as 报表管理器
    
    Client-&gt;&gt;Queue: 发送监控消息
    Note over Client,Queue: 异步批量发送
    
    loop 实时处理循环
        Analyzer-&gt;&gt;Queue: poll()获取消息
        Queue--&gt;&gt;Analyzer: MessageTree
        
        Analyzer-&gt;&gt;Analyzer: process(MessageTree)
        Note over Analyzer: 内存聚合统计
        
        Analyzer-&gt;&gt;Manager: 更新报表数据
    end
    
    Note right of Analyzer: 每分钟触发检查点
    
    Analyzer-&gt;&gt;Storage: doCheckpoint()
    Storage-&gt;&gt;Storage: 持久化到文件/HDFS
    Storage--&gt;&gt;Analyzer: 确认完成
</code></pre>
<h4 data-id="heading-18">4.3 核心类图</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39661661584d46599a3a5340e060ed60~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5Y6C5oqA5pyv5oC755uR5LiL5rW3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767678547&amp;x-signature=ebu24plVZu0VZWMsdTBNVakvMmc%3D" alt="deepseek_mermaid_20251230_41e04b.png" loading="lazy"/></p>
<h3 data-id="heading-19">5. 核心代码解析</h3>
<h4 data-id="heading-20">5.1 消息分析器基类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 抽象消息分析器 - 所有具体分析器的基类
 * 负责消费消息队列并进行实时分析
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractMessageAnalyzer</span>&lt;R&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ContainerHolder</span> 
        <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MessageAnalyzer</span> {
    
    <span class="hljs-comment">// 时间常量定义</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">MINUTE</span> <span class="hljs-operator">=</span> <span class="hljs-number">60</span> * <span class="hljs-number">1000L</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">ONE_HOUR</span> <span class="hljs-operator">=</span> <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000L</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">ONE_DAY</span> <span class="hljs-operator">=</span> <span class="hljs-number">24</span> * ONE_HOUR;
    
    <span class="hljs-meta">@Inject</span>
    <span class="hljs-keyword">protected</span> ServerConfigManager m_serverConfigManager;
    
    <span class="hljs-keyword">protected</span> <span class="hljs-type">long</span> m_startTime;      <span class="hljs-comment">// 分析时段开始时间</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">long</span> m_duration;       <span class="hljs-comment">// 分析时段持续时间</span>
    <span class="hljs-keyword">protected</span> Logger m_logger;
    <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> m_index;           <span class="hljs-comment">// 分析器实例索引</span>
    
    <span class="hljs-comment">/**
     * 核心分析方法 - 从队列消费消息并处理
     * 实现了双重循环确保消息完全消费
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">analyze</span><span class="hljs-params">(MessageQueue queue)</span> {
        <span class="hljs-comment">// 第一轮：在超时时间内尽可能处理消息</span>
        <span class="hljs-keyword">while</span> (!isTimeout() &amp;&amp; isActive()) {
            <span class="hljs-type">MessageTree</span> <span class="hljs-variable">tree</span> <span class="hljs-operator">=</span> queue.poll();
            
            <span class="hljs-keyword">if</span> (tree != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">try</span> {
                    process(tree);  <span class="hljs-comment">// 抽象方法，由子类实现具体逻辑</span>
                } <span class="hljs-keyword">catch</span> (Throwable e) {
                    handleProcessingError(e);
                }
            }
        }
        
        <span class="hljs-comment">// 第二轮：清空队列中剩余消息</span>
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            <span class="hljs-type">MessageTree</span> <span class="hljs-variable">tree</span> <span class="hljs-operator">=</span> queue.poll();
            
            <span class="hljs-keyword">if</span> (tree != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">try</span> {
                    process(tree);
                } <span class="hljs-keyword">catch</span> (Throwable e) {
                    handleProcessingError(e);
                }
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">break</span>;
            }
        }
    }
    
    <span class="hljs-comment">/**
     * 检查是否超时
     * 考虑额外缓冲时间，避免数据丢失
     */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isTimeout</span><span class="hljs-params">()</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">currentTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-type">long</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> m_startTime + m_duration + m_extraTime;
        <span class="hljs-keyword">return</span> currentTime &gt; endTime;
    }
    
    <span class="hljs-comment">// 抽象方法，子类必须实现</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">process</span><span class="hljs-params">(MessageTree tree)</span>;
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadReports</span><span class="hljs-params">()</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doCheckpoint</span><span class="hljs-params">(<span class="hljs-type">boolean</span> atEnd)</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> R <span class="hljs-title function_">getReport</span><span class="hljs-params">(String domain)</span>;
}
</code></pre>
<h4 data-id="heading-21">5.2 报表管理器实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 默认报表管理器 - 按小时维度管理监控报表
 * 支持内存缓存和持久化存储
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultReportManager</span>&lt;T&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ContainerHolder</span> 
        <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ReportManager</span>&lt;T&gt;, Initializable, LogEnabled {
    
    <span class="hljs-meta">@Inject</span>
    <span class="hljs-keyword">private</span> ReportDelegate&lt;T&gt; m_reportDelegate;  <span class="hljs-comment">// 报表代理，处理序列化等</span>
    <span class="hljs-meta">@Inject</span>
    <span class="hljs-keyword">private</span> ReportBucketManager m_bucketManager; <span class="hljs-comment">// 存储桶管理</span>
    <span class="hljs-meta">@Inject</span>
    <span class="hljs-keyword">private</span> HourlyReportDao m_reportDao;         <span class="hljs-comment">// 数据库访问</span>
    
    <span class="hljs-comment">// 核心数据结构：时间戳 -&gt; (域名 -&gt; 报表对象)</span>
    <span class="hljs-keyword">private</span> Map&lt;Long, Map&lt;String, T&gt;&gt; m_reports = 
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;Long, Map&lt;String, T&gt;&gt;();
    
    <span class="hljs-comment">/**
     * 获取或创建小时报表
     * 支持懒加载和缓存机制
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> T <span class="hljs-title function_">getHourlyReport</span><span class="hljs-params">(<span class="hljs-type">long</span> startTime, String domain, 
                           <span class="hljs-type">boolean</span> createIfNotExist)</span> {
        <span class="hljs-comment">// 双重检查锁定确保线程安全</span>
        Map&lt;String, T&gt; reports = m_reports.get(startTime);
        
        <span class="hljs-keyword">if</span> (reports == <span class="hljs-literal">null</span> &amp;&amp; createIfNotExist) {
            <span class="hljs-keyword">synchronized</span> (m_reports) {
                reports = m_reports.get(startTime);
                <span class="hljs-keyword">if</span> (reports == <span class="hljs-literal">null</span>) {
                    reports = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;String, T&gt;();
                    m_reports.put(startTime, reports);
                }
            }
        }
        
        <span class="hljs-keyword">if</span> (reports == <span class="hljs-literal">null</span>) {
            reports = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;String, T&gt;();
        }
        
        <span class="hljs-type">T</span> <span class="hljs-variable">report</span> <span class="hljs-operator">=</span> reports.get(domain);
        
        <span class="hljs-keyword">if</span> (report == <span class="hljs-literal">null</span> &amp;&amp; createIfNotExist) {
            <span class="hljs-keyword">synchronized</span> (reports) {
                report = m_reportDelegate.makeReport(domain, startTime, HOUR);
                reports.put(domain, report);
            }
        }
        
        <span class="hljs-keyword">return</span> report;
    }
    
    <span class="hljs-comment">/**
     * 存储小时报表到持久化层
     * 支持文件和数据库两种存储策略
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">storeHourlyReports</span><span class="hljs-params">(<span class="hljs-type">long</span> startTime, 
                                  StoragePolicy policy, 
                                  <span class="hljs-type">int</span> index)</span> {
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> Cat.newTransaction(<span class="hljs-string">"Checkpoint"</span>, m_name);
        Map&lt;String, T&gt; reports = m_reports.get(startTime);
        <span class="hljs-type">ReportBucket</span> <span class="hljs-variable">bucket</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (reports != <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">// 数据验证：过滤非法域名</span>
                Set&lt;String&gt; errorDomains = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;String&gt;();
                <span class="hljs-keyword">for</span> (String domain : reports.keySet()) {
                    <span class="hljs-keyword">if</span> (!m_validator.validate(domain)) {
                        errorDomains.add(domain);
                    }
                }
                
                <span class="hljs-comment">// 存储前回调，允许数据预处理</span>
                m_reportDelegate.beforeSave(reports);
                
                <span class="hljs-comment">// 文件存储</span>
                <span class="hljs-keyword">if</span> (policy.forFile()) {
                    bucket = m_bucketManager.getReportBucket(startTime, 
                                                           m_name, index);
                    storeFile(reports, bucket);
                }
                
                <span class="hljs-comment">// 数据库存储</span>
                <span class="hljs-keyword">if</span> (policy.forDatabase()) {
                    storeDatabase(startTime, reports);
                }
            }
            t.setStatus(Message.SUCCESS);
        } <span class="hljs-keyword">catch</span> (Throwable e) {
            Cat.logError(e);
            t.setStatus(e);
        } <span class="hljs-keyword">finally</span> {
            cleanup(startTime);  <span class="hljs-comment">// 清理过期数据</span>
            t.complete();
        }
    }
    
    <span class="hljs-comment">// 存储策略枚举</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">StoragePolicy</span> {
        FILE,            <span class="hljs-comment">// 仅文件存储</span>
        FILE_AND_DB;     <span class="hljs-comment">// 文件和数据库双重存储</span>
        
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">forFile</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span> == FILE_AND_DB || <span class="hljs-built_in">this</span> == FILE;
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">forDatabase</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span> == FILE_AND_DB;
        }
    }
}
</code></pre>
<h4 data-id="heading-22">5.3 客户端事务实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 默认事务实现 - 记录跨系统边界的操作
 * 支持嵌套子事务和时间统计
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultTransaction</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMessage</span> 
        <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Transaction</span> {
    
    <span class="hljs-keyword">private</span> TraceContext m_ctx;           <span class="hljs-comment">// 追踪上下文</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">long</span> m_durationInMicros; <span class="hljs-comment">// 微秒级持续时间</span>
    <span class="hljs-keyword">private</span> List&lt;Message&gt; m_children;     <span class="hljs-comment">// 子消息列表</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DefaultTransaction</span><span class="hljs-params">(TraceContext ctx, String type, String name)</span> {
        <span class="hljs-built_in">super</span>(type, name);
        m_ctx = ctx;
        <span class="hljs-comment">// 记录开始时间（纳秒转微秒）</span>
        m_durationInMicros = System.nanoTime() / <span class="hljs-number">1000L</span>;
        m_ctx.start(<span class="hljs-built_in">this</span>);  <span class="hljs-comment">// 注册到上下文</span>
    }
    
    <span class="hljs-comment">/**
     * 完成事务，计算持续时间
     * 自动完成未完成的子事务
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">complete</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 如果持续时间未设置，计算实际耗时</span>
        <span class="hljs-keyword">if</span> (m_durationInMicros &gt; <span class="hljs-number">1e9</span>) { 
            <span class="hljs-type">long</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> System.nanoTime();
            m_durationInMicros = end / <span class="hljs-number">1000L</span> - m_durationInMicros;
        }
        
        <span class="hljs-built_in">super</span>.setCompleted();
        
        <span class="hljs-comment">// 自动完成未结束的子事务</span>
        <span class="hljs-keyword">if</span> (m_children != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">for</span> (Message child : m_children) {
                <span class="hljs-keyword">if</span> (!child.isCompleted() &amp;&amp; 
                    child <span class="hljs-keyword">instanceof</span> ForkableTransaction) {
                    child.complete();
                }
            }
        }
        
        m_ctx.end(<span class="hljs-built_in">this</span>);  <span class="hljs-comment">// 从上下文注销</span>
    }
    
    <span class="hljs-comment">/**
     * 添加子消息，构建调用树
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> DefaultTransaction <span class="hljs-title function_">addChild</span><span class="hljs-params">(Message message)</span> {
        <span class="hljs-keyword">if</span> (m_children == <span class="hljs-literal">null</span>) {
            m_children = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Message&gt;();
        }
        
        <span class="hljs-keyword">if</span> (message != <span class="hljs-literal">null</span>) {
            m_children.add(message);
        } <span class="hljs-keyword">else</span> {
            Cat.logError(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">"Null child message."</span>));
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getDurationInMillis</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">super</span>.isCompleted()) {
            <span class="hljs-keyword">return</span> m_durationInMicros / <span class="hljs-number">1000L</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <span class="hljs-comment">// 事务未完成时返回0</span>
        }
    }
}
</code></pre>
<h4 data-id="heading-23">5.4 服务器配置管理</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 服务器配置管理器
 * 支持动态配置更新和本地文件回退
 */</span>
<span class="hljs-meta">@Named</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServerConfigManager</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">LogEnabled</span>, Initializable {
    
    <span class="hljs-meta">@Inject</span>
    <span class="hljs-keyword">private</span> ConfigDao m_configDao;
    <span class="hljs-meta">@Inject</span>
    <span class="hljs-keyword">private</span> ContentFetcher m_fetcher;
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> ServerConfig m_config;  <span class="hljs-comment">// 当前配置</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> Server m_server;        <span class="hljs-comment">// 当前服务器配置</span>
    
    <span class="hljs-comment">/**
     * 初始化配置，支持数据库和本地文件两种来源
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initialize</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InitializationException {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 优先从数据库加载配置</span>
            <span class="hljs-type">Config</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> m_configDao.findByName(CONFIG_NAME, 
                                                  ConfigEntity.READSET_FULL);
            m_config = DefaultSaxParser.parse(config.getContent());
        } <span class="hljs-keyword">catch</span> (DalNotFoundException e) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 2. 数据库不存在时从默认配置创建</span>
                <span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> m_fetcher.getConfigContent(CONFIG_NAME);
                m_config = DefaultSaxParser.parse(content);
            } <span class="hljs-keyword">catch</span> (Exception ex) {
                <span class="hljs-comment">// 3. 回退到本地文件</span>
                <span class="hljs-type">File</span> <span class="hljs-variable">localServerFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(Cat.getCatHome(), 
                                               <span class="hljs-string">"server.xml"</span>);
                initialize(localServerFile);
            }
        }
        
        <span class="hljs-comment">// 配置验证和服务器信息刷新</span>
        m_config.accept(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerConfigValidator</span>());
        refreshServer();
        
        <span class="hljs-comment">// 注册配置同步任务</span>
        TimerSyncTask.getInstance().register(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SyncHandler</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
                refreshConfig();  <span class="hljs-comment">// 定期检查配置更新</span>
            }
        });
    }
    
    <span class="hljs-comment">/**
     * 动态刷新配置（热更新）
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">refreshConfig</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">Config</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> m_configDao.findByName(CONFIG_NAME, 
                                              ConfigEntity.READSET_FULL);
        <span class="hljs-type">long</span> <span class="hljs-variable">modifyTime</span> <span class="hljs-operator">=</span> config.getModifyDate().getTime();
        
        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {
            <span class="hljs-keyword">if</span> (modifyTime &gt; m_modifyTime) {
                <span class="hljs-comment">// 配置有更新，重新加载</span>
                <span class="hljs-type">ServerConfig</span> <span class="hljs-variable">serverConfig</span> <span class="hljs-operator">=</span> 
                    DefaultSaxParser.parse(config.getContent());
                serverConfig.accept(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerConfigValidator</span>());
                
                m_config = serverConfig;
                m_modifyTime = modifyTime;
                refreshServer();  <span class="hljs-comment">// 刷新服务器配置</span>
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-24">技术对比与总结</h3>
<h4 data-id="heading-25">与同类方案对比</h4>















































<table><thead><tr><th>特性</th><th>CAT</th><th>Zipkin</th><th>SkyWalking</th></tr></thead><tbody><tr><td><strong>实时性</strong></td><td>秒级</td><td>分钟级</td><td>准实时</td></tr><tr><td><strong>数据模型</strong></td><td>四种模型</td><td>追踪为主</td><td>追踪+指标</td></tr><tr><td><strong>存储策略</strong></td><td>文件+HDFS</td><td>ES/Cassandra</td><td>ES/MySQL</td></tr><tr><td><strong>客户端支持</strong></td><td>多语言完善</td><td>主流语言</td><td>Java为主</td></tr><tr><td><strong>部署复杂度</strong></td><td>中等</td><td>较低</td><td>较高</td></tr><tr><td><strong>数据完整性</strong></td><td>全量统计</td><td>采样</td><td>采样+统计</td></tr></tbody></table>
<h4 data-id="heading-26">核心优势总结</h4>
<ol>
<li><strong>生产环境验证</strong>：在美团大规模业务中经过验证，稳定性有保障</li>
<li><strong>实时性突出</strong>：秒级延迟满足快速故障响应需求</li>
<li><strong>数据完整性</strong>：全量数据统计避免采样导致的误差</li>
<li><strong>多语言生态</strong>：完善的多语言客户端支持</li>
<li><strong>配置灵活性</strong>：支持动态配置更新和多种存储后端</li>
</ol>
<h4 data-id="heading-27">适用建议</h4>
<ul>
<li><strong>推荐使用场景</strong>：对实时性要求高、多语言技术栈、需要全量数据分析的大中型分布式系统</li>
<li><strong>注意事项</strong>：CAT的部署和运维需要一定的技术储备，建议从非核心业务开始逐步接入</li>
</ul>
<p>CAT作为美团开源的监控解决方案，在实时性、数据完整性和多语言支持方面具有明显优势，是构建企业级监控体系的可靠选择。其模块化设计和可扩展架构也为二次开发和定制化集成提供了良好基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再用 Java 多线程思维写 Python 了！Asyncio 才是 LLM 高并发的王道]]></title>    <link>https://juejin.cn/post/7589231401657892874</link>    <guid>https://juejin.cn/post/7589231401657892874</guid>    <pubDate>2025-12-30T06:20:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589231401657892874" data-draft-id="7589227883262214190" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再用 Java 多线程思维写 Python 了！Asyncio 才是 LLM 高并发的王道"/> <meta itemprop="keywords" content="大数据"/> <meta itemprop="datePublished" content="2025-12-30T06:20:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一直在追"/> <meta itemprop="url" content="https://juejin.cn/user/239028506736411"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再用 Java 多线程思维写 Python 了！Asyncio 才是 LLM 高并发的王道
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/239028506736411/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一直在追
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T06:20:16.000Z" title="Tue Dec 30 2025 06:20:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">💎 本文价值提示</h3>
<ul>
<li>​<strong>思维重塑</strong>​：帮你彻底打破 Java/Spark 的“多线程/多进程”固有思维，理解 Python 独特的“单线程 + 事件循环”模型。</li>
<li>​<strong>实战落地</strong>​：手把手教你用 <code>Asyncio</code> + <code>httpx</code> 构建一个生产级的 LLM 高并发请求器。</li>
<li>​<strong>避坑指南</strong>​：揭秘 90% 转行工程师都会踩的“阻塞陷阱”和“CPU 密集型误区”。</li>
<li>​<strong>适用人群</strong>​：Java 开发、大数据工程师、正在转型 AI 应用架构的后端开发者。</li>
</ul>
<hr/>
<p>👋 <strong>嗨，各位大数据老司机们！</strong></p>
<p>作为一名在大数据领域摸爬滚打多年的工程师，你一定对 <strong>Java 的多线程（Thread Pool）</strong> 或者 <strong>Spark 的分布式并行（Executor）</strong> 如数家珍。</p>
<p>当你转型做 AI Agent 或 RAG（检索增强生成）架构时，你可能会遇到这样一个场景：</p>
<blockquote>
<p>业务方甩给你 10,000 个 Prompt，让你调用 OpenAI 或 DeepSeek 的 API 跑批处理。</p>
</blockquote>
<p>你的第一反应是不是：“这简单！开个 50 线程的 ThreadPool，一把梭哈！”</p>
<p>🛑 <strong>且慢！在 Python 的世界里，这么做可能是在“自废武功”。</strong></p>
<p>因为 Python 有一个让无数 Java 程序员头秃的“特产”——​**GIL（全局解释器锁）**​。如果你还在用写 Java 的方式写 Python，你的 AI 应用可能连 10% 的性能都跑不出来。</p>
<p>今天，我们就来聊聊 Python AI 工程化的核心武器：​**Asyncio（异步 I/O）**​。</p>
<hr/>
<h2 data-id="heading-1">01 🤯 颠覆认知：从“人海战术”到“影分身术”</h2>
<p>要理解 Python 的 Asyncio，首先得忘掉 Java 的多线程模型。</p>
<h3 data-id="heading-2">☕ Java/大数据模型：人海战术</h3>
<p>在 Java（Pre-NIO 时代）或 Spark 中，处理并发通常意味着​<strong>增加资源</strong>​。</p>
<ul>
<li>​<strong>场景</strong>​：餐厅有 100 桌客人。</li>
<li>​<strong>策略</strong>​：雇佣 100 个服务员（线程）。每桌配一个服务员，客人点菜、等菜、吃饭，服务员全程死守在旁边。</li>
<li>​<strong>代价</strong>​：操作系统开销大，内存占用高，上下文切换频繁。</li>
</ul>
<h3 data-id="heading-3">🐍 Python Asyncio 模型：影分身术</h3>
<p>Python 由于 GIL 的存在，同一时刻只能有一个线程在执行字节码。这意味着你雇佣 100 个服务员（线程），其实只有 1 个能动，其他的都在排队拿锁。</p>
<p>所以，Python 选择了另一种流派：​**Event Loop（事件循环）**​。</p>
<ul>
<li>​<strong>场景</strong>​：餐厅有 100 桌客人。</li>
<li>​<strong>策略</strong>​：​**只雇佣 1 个超级服务员（单线程）**​。</li>
<li>​<strong>操作</strong>​：
<ol>
<li>服务员去 A 桌点菜，把单子扔给厨房（​<strong>I/O 请求发出</strong>​）。</li>
<li>​<strong>关键点</strong>​：服务员<strong>不等待</strong>厨房做菜，而是立刻转身去 B 桌点菜（​<strong>释放控制权</strong>​）。</li>
<li>当厨房喊“A 桌菜好了”（​<strong>Callback/Future 完成</strong>​），服务员再回来把菜端给 A 桌。</li>
</ol>
</li>
</ul>
<p>这就是 <strong>Asyncio</strong> 的本质：​<strong>单线程 + 协作式多任务</strong>​。它不靠增加人手，而是靠​<strong>榨干这一个人的所有等待时间</strong>​。</p>
<p>👇 <strong>一张图看懂区别：</strong></p>
<p><img src="http://openwrite.cn/uploads/20235/58089/d9d14082-dc78-467a-9f0b-8692ff57ad63.png" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-4">02 🛠️ 核心语法：Async 与 Await 的“契约”</h2>
<p>在 Python 中，要实现这种“影分身”，你需要两个魔法词：</p>
<ol>
<li><strong><code>async def</code></strong>：告诉 Python，“我是一个协程（Coroutine），我可能会暂停”。</li>
<li><strong><code>await</code></strong>：告诉 Python，“这里要等很久（比如请求 LLM API），你先去忙别的，结果出来了叫我”。</li>
</ol>
<h3 data-id="heading-5">⚠️ 最大的坑：不要让服务员“睡着”！</h3>
<p>很多转型的同学会写出这样的代码：</p>
<pre><code class="hljs language-hljs" lang="hljs">import time
import asyncio

async def bad_code():
    # ❌ 错误！这叫“同步阻塞”
    # 这相当于服务员在等菜的时候，直接在大厅睡着了！
    # 整个餐厅（Event Loop）都会停摆，没人服务其他桌了。
    time.sleep(5) 
    print("醒了")

async def good_code():
    # ✅ 正确！这叫“异步挂起”
    # 服务员说：“我要等5秒，这期间我去干别的。”
    await asyncio.sleep(5)
    print("醒了")
</code></pre>
<p><strong>记住：在 <code>async</code> 函数里，千万别用 <code>time.sleep()</code>，也别用 <code>requests</code> 库（它是同步的），要用 <code>aiohttp</code> 或 <code>httpx</code>！</strong></p>
<hr/>
<h2 data-id="heading-6">03 🚀 实战：构建高并发 LLM 请求器</h2>
<p>光说不练假把式。假设我们要处理 ​<strong>50 个 Prompt</strong>​，如果串行调用，每个耗时 2 秒，总共要 100 秒。 我们的目标是：<strong>利用 Asyncio 并发，但要限制并发数（防止 API Rate Limit 报错）。</strong></p>
<p>我们将使用以下“三剑客”：</p>
<ul>
<li>🗡️ <strong><code>httpx</code></strong>：现代化的异步 HTTP 客户端（比 requests 强）。</li>
<li>🛡️ <strong><code>asyncio.Semaphore</code></strong>：信号量，用来控制并发度（类比 Spark 的 Executor 数量）。</li>
<li>⚡ <strong><code>asyncio.gather</code></strong>：并发执行器（类比 Spark 的 Action）。</li>
</ul>
<h3 data-id="heading-7">📝 完整代码实现</h3>
<pre><code class="hljs language-hljs" lang="hljs">import asyncio
import httpx
import time
import random

# 模拟 LLM API (使用 httpbin 模拟延迟)
MOCK_API_URL = "https://httpbin.org/delay/{delay}"

class LLMClient:
    def __init__(self, concurrency_limit: int = 5):
        # 🚦 核心组件：信号量
        # 就像餐厅只有 5 个盘子，发完就得等别人还回来才能继续发
        self.semaphore = asyncio.Semaphore(concurrency_limit)
        # 建立长连接池，复用 TCP 连接
        self.client = httpx.AsyncClient(timeout=30.0)

    async def close(self):
        await self.client.aclose()

    async def fetch_completion(self, prompt_id: int):
        # 模拟 1~2 秒的 API 延迟
        delay = random.uniform(1.0, 2.0)
        url = MOCK_API_URL.format(delay=f"{delay:.2f}")

        # 🔒 自动获取锁，退出时自动释放
        async with self.semaphore:
            print(f"🚀 [开始] 任务 ID: {prompt_id} | 正在请求...")
            start_time = time.perf_counter()
            
            try:
                # 👉 关键时刻：await 让出控制权！
                # 此时 Event Loop 会立刻去处理下一个任务
                resp = await self.client.get(url)
                resp.raise_for_status()
                
                elapsed = time.perf_counter() - start_time
                print(f"✅ [完成] 任务 ID: {prompt_id} | 耗时: {elapsed:.2f}s")
                return {"id": prompt_id, "status": "success"}
            except Exception as e:
                print(f"❌ [失败] 任务 ID: {prompt_id} | 错误: {e}")
                return {"id": prompt_id, "status": "error"}

async def main():
    # 准备 20 个任务
    total_tasks = 20
    # 限制同时只能有 5 个请求在飞
    client = LLMClient(concurrency_limit=5)
    
    print(f"🔥 开始处理 {total_tasks} 个请求，并发限制: 5")
    start_global = time.perf_counter()

    try:
        # 1. 创建任务列表（此时还没开始跑）
        tasks = [client.fetch_completion(i) for i in range(total_tasks)]
        
        # 2. 🚀 发射！并发执行所有任务
        # 这就像 Spark 的 collect()，等待所有结果返回
        results = await asyncio.gather(*tasks)
        
    finally:
        await client.close()

    total_time = time.perf_counter() - start_global
    print(f"\n🎉 全部搞定！总耗时: {total_time:.2f}s")
    # 理论上，如果是串行，耗时应该是 所有任务耗时之和 (约 30s)
    # 实际上，耗时应该是 (总任务数 / 并发数) * 平均耗时 (约 6-8s)

if __name__ == "__main__":
    asyncio.run(main())
</code></pre>
<h3 data-id="heading-8">📊 运行逻辑图解</h3>
<p><img src="http://openwrite.cn/uploads/20235/58089/ed7a5fda-c52c-4066-b550-80b2477a563f.png" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-9">04 💣 避坑指南：大数据工程师常犯的错</h2>
<h3 data-id="heading-10">❌ 错误一：在 Async 函数里做 CPU 密集型计算</h3>
<p>​<strong>场景</strong>​：你收到 LLM 的回复后，想用正则表达式清洗一下数据，或者算个向量余弦相似度。​<strong>后果</strong>​：整个 Event Loop 卡死。因为 Python 是单线程的，你在算数学题，服务员就没法去端菜了。​<strong>解法</strong>​：对于 CPU 密集型任务，请使用 <code>loop.run_in_executor</code> 把它扔到线程池或进程池里去，别占用主线程。</p>
<h3 data-id="heading-11">❌ 错误二：忘记 <code>await</code></h3>
<p>​<strong>场景</strong>​：<code>result = client.get(url)</code>​<strong>后果</strong>​：你得到的不是 Response，而是一个 <code>Coroutine</code> 对象。就像你点完菜，服务员给了你一张排队小票，你却以为那是菜，直接拿起来吃（报错）。</p>
<h3 data-id="heading-12">❌ 错误三：滥用 <code>try...except</code> 吞掉异常</h3>
<p>​<strong>场景</strong>​：在 <code>gather</code> 中如果不妥善处理异常，一个任务报错可能会导致整个批次崩溃，或者异常被静默吞噬。​<strong>解法</strong>​：在每个子任务内部进行 <code>try...except</code> 捕获，确保返回结构化的错误信息（如上文代码所示）。</p>
<hr/>
<h2 data-id="heading-13">05 📝 总结</h2>
<p>从 Java/Spark 转型 Python AI 架构，<strong>Asyncio</strong> 是你必须跨越的第一道坎。</p>
<ul>
<li><strong>Java 多线程</strong> 是“大力出奇迹”，靠资源堆砌解决并发。</li>
<li><strong>Python Asyncio</strong> 是“四两拨千斤”，靠极致的时间管理解决 I/O 等待。</li>
</ul>
<p>对于 LLM 应用这种​<strong>极度依赖网络 I/O</strong>​（请求 API 往往需要几秒甚至几十秒）的场景，Asyncio 简直是天作之合。掌握了它，你就能用最小的资源，构建出吞吐量惊人的 AI Agent。</p>
<hr/>
<h3 data-id="heading-14">🧠 本文思维导图</h3>
<p><img src="http://openwrite.cn/uploads/20235/58089/80d3f0a3-44c1-4726-85cf-4dc1861a14a5.png" alt="image.png" loading="lazy"/></p>
<hr/>
<p>​<strong>下期预告</strong>​：搞定了高并发，LLM 生成的内容像打字机一样一个字一个字蹦出来是怎么实现的？下一篇我们将深入 **Python 生成器 (Generators) 与流式响应 (Streaming)**，敬请期待！</p>
<p>👇 <strong>觉得有用？点个“在看”，让更多大数据兄弟看到！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Ooder核心揭秘：A2UI轻量级企业AI框架控制层8问]]></title>    <link>https://juejin.cn/post/7589262021561008169</link>    <guid>https://juejin.cn/post/7589262021561008169</guid>    <pubDate>2025-12-30T07:16:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589262021561008169" data-draft-id="7589214068093861907" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Ooder核心揭秘：A2UI轻量级企业AI框架控制层8问"/> <meta itemprop="keywords" content="架构,响应式设计"/> <meta itemprop="datePublished" content="2025-12-30T07:16:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OneCodeCN"/> <meta itemprop="url" content="https://juejin.cn/user/1427583415622366"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Ooder核心揭秘：A2UI轻量级企业AI框架控制层8问
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1427583415622366/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OneCodeCN
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T07:16:44.000Z" title="Tue Dec 30 2025 07:16:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Ooder定位为A2UI轻量级企业AI框架，核心目标是为轻中型企业AI相关业务系统（如智能表单、数据可视化交互模块）提供“低门槛开发、轻量化部署、快速适配业务”的技术支撑。其控制层设计围绕“注解驱动、前后端快速协同”展开，依托HOOKS机制实现视图与业务逻辑的衔接。以下结合文档中的真实代码片段，客观分析控制层8个核心问题的设计取舍，清晰呈现优缺点。</p>
<p>​</p>
<h2 data-id="heading-0">1. 注解驱动设计：便捷配置的优势与“注解爆炸”的局限</h2>
<p><strong>设计初衷（优点）</strong>：旨在替代传统XML配置，实现“代码即配置”，降低轻量团队的协作成本，编译期即可完成配置校验，避免运行时配置错误。文档中典型代码片段如下：</p>
<pre><code class="hljs language-javascript" lang="javascript">@<span class="hljs-title class_">RequestMapping</span>(method = <span class="hljs-title class_">RequestMethod</span>.<span class="hljs-property">POST</span>, value = <span class="hljs-string">"RePackage"</span>)
@<span class="hljs-title class_">NavTreeViewAnnotation</span>
@<span class="hljs-title class_">DialogAnnotation</span>(caption = <span class="hljs-string">"重新打包"</span>, width = <span class="hljs-string">"900"</span>)
@<span class="hljs-title class_">ModuleAnnotation</span>(imageClass = <span class="hljs-string">"ri-box-line"</span>)
@<span class="hljs-title class_">APIEventAnnotation</span>(autoRun = <span class="hljs-literal">true</span>, bindMenu = <span class="hljs-title class_">CustomMenuItem</span>.<span class="hljs-property">SAVE</span>)
@<span class="hljs-title class_">ResponseBody</span>
public <span class="hljs-title class_">TreeListResultModel</span>&lt;<span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">ViewConfigTree</span>&gt;&gt; <span class="hljs-title function_">rePackage</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> currentClassName, <span class="hljs-built_in">String</span> currCom</span>) {
    <span class="hljs-title class_">TreeListResultModel</span>&lt;<span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">ViewConfigTree</span>&gt;&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeListResultModel</span>&lt;&gt;();
    result.<span class="hljs-title function_">setData</span>(viewConfigService.<span class="hljs-title function_">getRePackageTree</span>(currentClassName, currCom));
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p>上述代码通过5个注解完成“请求映射、视图类型、弹窗配置、图标样式、事件绑定”的一站式配置，无需额外配置文件，符合轻量级框架“快速开发”的定位。</p>
<p><strong>实际局限（缺点）</strong>：注解过度堆砌导致“注解爆炸”，违背轻量框架“简洁易读”的核心诉求。一方面，单个方法需叠加多个专用注解，开发者需记忆每种注解的参数规则（如@DialogAnnotation的width、caption参数，@APIEventAnnotation的bindMenu取值），增加学习成本；另一方面，配置与代码强耦合，若需调整弹窗宽高（如从900改为1000），需修改代码并重新编译部署，无法支持生产环境的动态配置，与“轻量化运维”的需求存在矛盾。</p>
<h2 data-id="heading-1">2. Service级子视图挂接：解耦优势与类冗余的矛盾</h2>
<p><strong>设计初衷（优点）</strong>：为实现视图层级的模块化拆分，让主视图与子视图的业务逻辑独立，便于轻量团队按功能分工开发，避免修改子视图影响主视图。文档中主视图与子视图的独立Service实现代码如下：</p>
<p>主视图Service代码：</p>
<pre><code class="hljs language-javascript" lang="javascript">@<span class="hljs-title class_">Controller</span>
@<span class="hljs-title class_">RequestMapping</span>(<span class="hljs-string">"/view/main/"</span>)
public <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainViewService</span> {
    @<span class="hljs-title class_">RequestMapping</span>(method = <span class="hljs-title class_">RequestMethod</span>.<span class="hljs-property">POST</span>, value = <span class="hljs-string">"MainConfig"</span>)
    @<span class="hljs-title class_">NavTreeViewAnnotation</span>
    @<span class="hljs-title class_">ResponseBody</span>
    public <span class="hljs-title class_">TreeListResultModel</span>&lt;<span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">MainViewTree</span>&gt;&gt; <span class="hljs-title function_">getMainConfig</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 主视图数据逻辑</span>
    }
}
</code></pre>
<p>子视图Service代码：</p>
<pre><code class="hljs language-javascript" lang="javascript">@<span class="hljs-title class_">Controller</span>
@<span class="hljs-title class_">RequestMapping</span>(<span class="hljs-string">"/view/sub/"</span>)
public <span class="hljs-keyword">class</span> <span class="hljs-title class_">SubViewService</span> {
    @<span class="hljs-title class_">RequestMapping</span>(method = <span class="hljs-title class_">RequestMethod</span>.<span class="hljs-property">POST</span>, value = <span class="hljs-string">"SubConfig"</span>)
    @<span class="hljs-title class_">DialogAnnotation</span>(caption = <span class="hljs-string">"子视图弹窗"</span>)
    @<span class="hljs-title class_">ResponseBody</span>
    public <span class="hljs-title class_">ResultModel</span>&lt;<span class="hljs-title class_">SubViewForm</span>&gt; <span class="hljs-title function_">getSubConfig</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> mainId</span>) {
        <span class="hljs-comment">// 子视图数据逻辑</span>
    }
}
</code></pre>
<p>通过独立Service类划分主/子视图，职责边界清晰，符合“高内聚低耦合”的设计原则，便于小团队并行开发。</p>
<p><strong>实际局限（缺点）</strong>：过度解耦导致“类爆炸”，增加轻量级框架的开发冗余。对于简单业务场景（如仅需展示3个字段的简单子视图），仍需创建独立的Service类并配置全套注解，导致项目中类文件数量不必要增加。例如某轻量AI表单系统，仅5个核心视图，却因子视图独立Service设计，衍生出12个控制层Service类，增加了项目管理和JVM加载成本，与“轻量化”定位相悖。</p>
<h2 data-id="heading-2">3. 强类型返回模型：契约一致的优势与灵活扩展的枷锁</h2>
<p><strong>设计初衷（优点）</strong>：通过统一的强类型返回模型（如TreeListResultModel、ResultModel）固化前后端交互契约，避免响应数据结构混乱，降低前端适配成本，符合轻量级框架“快速协同”的需求。文档中典型返回模型代码如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 框架定义的强类型返回模型</span>
public <span class="hljs-keyword">class</span> <span class="hljs-title class_">TreeListResultModel</span>&lt;T&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseResultModel</span> {
    private <span class="hljs-title class_">List</span>&lt;T&gt; data;
    private <span class="hljs-title class_">Integer</span> treeLevel;
    <span class="hljs-comment">// getter/setter</span>
}

<span class="hljs-comment">// 控制层使用示例</span>
@<span class="hljs-title class_">RequestMapping</span>(method = <span class="hljs-title class_">RequestMethod</span>.<span class="hljs-property">POST</span>, value = <span class="hljs-string">"TreeData"</span>)
@<span class="hljs-title class_">ResponseBody</span>
public <span class="hljs-title class_">TreeListResultModel</span>&lt;<span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">ViewConfigTree</span>&gt;&gt; <span class="hljs-title function_">getTreeData</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">TreeListResultModel</span>&lt;<span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">ViewConfigTree</span>&gt;&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeListResultModel</span>&lt;&gt;();
    result.<span class="hljs-title function_">setData</span>(viewConfigService.<span class="hljs-title function_">getTreeList</span>());
    result.<span class="hljs-title function_">setTreeLevel</span>(<span class="hljs-number">3</span>);
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p>强类型模型确保返回数据包含“数据列表、树形层级”等固定字段，前端可复用通用解析逻辑，无需为每个接口单独适配。</p>
<p><strong>实际局限（缺点）</strong>：灵活扩展不足，适配业务变更的成本高。当业务需新增临时字段（如给树形数据增加“是否选中”标识）时，需修改视图数据类（ViewConfigTree）、返回模型的泛型约束，甚至调整Service逻辑，无法通过动态字段快速适配。例如某轻量AI数据分析模块，因业务需求变更需在返回数据中新增“数据权重”字段，仅调整相关模型和控制层代码就耗时1天，违背轻量级框架“快速迭代”的诉求。</p>
<h2 data-id="heading-3">4. 无接口版本控制：简洁设计的优势与迭代兼容的难题</h2>
<p><strong>设计初衷（优点）</strong>：为简化框架设计，降低轻量团队的版本管理成本，Ooder未内置接口版本控制机制，默认通过统一的请求路径和参数实现交互，符合“轻量化”的核心定位。文档中接口设计示例如下：</p>
<pre><code class="hljs language-javascript" lang="javascript">@<span class="hljs-title class_">RequestMapping</span>(method = <span class="hljs-title class_">RequestMethod</span>.<span class="hljs-property">POST</span>, value = <span class="hljs-string">"UserInfo"</span>)
@<span class="hljs-title class_">ResponseBody</span>
public <span class="hljs-title class_">ResultModel</span>&lt;<span class="hljs-title class_">UserForm</span>&gt; <span class="hljs-title function_">getUserInfo</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> userId</span>) {
    <span class="hljs-title class_">ResultModel</span>&lt;<span class="hljs-title class_">UserForm</span>&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultModel</span>&lt;&gt;();
    result.<span class="hljs-title function_">setData</span>(userService.<span class="hljs-title function_">getUserDetail</span>(userId));
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p>简洁的接口设计无需额外维护版本标识，降低了开发和文档维护成本，适合小团队快速落地业务。</p>
<p><strong>实际局限（缺点）</strong>：迭代兼容能力弱，无法支撑业务平滑升级。当接口需新增参数（如给getUserInfo增加“userType”参数）时，旧版本前端因未传递新参数会直接报错，无法实现“向后兼容”。例如某轻量AI客户管理系统，在迭代2.0版本时需扩展用户信息接口参数，因无版本控制，只能同时升级前后端代码，导致系统短暂下线，影响业务使用，与企业级系统“稳定运行”的基本需求存在差距。</p>
<h2 data-id="heading-4">5. 参数绑定隐式匹配：开发便捷的优势与隐藏陷阱的风险</h2>
<p><strong>设计初衷（优点）</strong>：通过“参数名称自动匹配”机制简化开发，无需添加@RequestParam、@RequestBody等显式注解，框架自动兼容表单、JSON、URL参数，降低开发者的学习和编码成本。文档中参数绑定示例如下：</p>
<pre><code class="hljs language-javascript" lang="javascript">@<span class="hljs-title class_">RequestMapping</span>(method = <span class="hljs-title class_">RequestMethod</span>.<span class="hljs-property">POST</span>, value = <span class="hljs-string">"FormSubmit"</span>)
@<span class="hljs-title class_">ResponseBody</span>
public <span class="hljs-title class_">ResultModel</span>&lt;<span class="hljs-title class_">Boolean</span>&gt; <span class="hljs-title function_">formSubmit</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> formId, <span class="hljs-built_in">String</span> submitData, Integer submitType</span>) {
    <span class="hljs-comment">// 直接使用参数完成业务逻辑</span>
    <span class="hljs-keyword">return</span> formService.<span class="hljs-title function_">handleSubmit</span>(formId, submitData, submitType);
}
</code></pre>
<p>上述代码中，formId、submitData等参数直接与前端请求参数名称匹配，无需额外配置，极大提升了开发效率，符合轻量级框架“低门槛”的定位。</p>
<p><strong>实际局限（缺点）</strong>：隐式匹配存在隐藏陷阱，排查问题难度大。当前端同时通过URL和JSON传递同名字段（如URL参数formId=123，JSON参数formId=456）时，框架绑定逻辑不明确，可能出现参数覆盖问题。例如某轻量AI表单提交模块，曾因该问题导致表单数据提交错误，开发人员需逐行调试请求参数流转过程，耗时2天才定位问题，反而增加了维护成本。</p>
<h2 data-id="heading-5">6. 视图层级注解关联：解耦灵活的优势与黑盒化的局限</h2>
<p><strong>设计初衷（优点）</strong>：通过注解隐式关联主/子视图，替代硬编码调用，提升视图层级的灵活性，便于轻量团队按需组合视图。文档中注解关联示例如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 主视图通过注解关联子视图</span>
@<span class="hljs-title class_">RequestMapping</span>(method = <span class="hljs-title class_">RequestMethod</span>.<span class="hljs-property">POST</span>, value = <span class="hljs-string">"MainForm"</span>)
@<span class="hljs-title class_">FormViewAnnotation</span>
@<span class="hljs-title class_">DialogAnnotation</span>(caption = <span class="hljs-string">"主表单"</span>, subView = <span class="hljs-string">"SubForm"</span>) <span class="hljs-comment">// 关联子视图SubForm</span>
@<span class="hljs-title class_">ResponseBody</span>
public <span class="hljs-title class_">ResultModel</span>&lt;<span class="hljs-title class_">MainForm</span>&gt; <span class="hljs-title function_">getMainForm</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 主视图逻辑</span>
}

<span class="hljs-comment">// 子视图独立实现</span>
@<span class="hljs-title class_">RequestMapping</span>(method = <span class="hljs-title class_">RequestMethod</span>.<span class="hljs-property">POST</span>, value = <span class="hljs-string">"SubForm"</span>)
@<span class="hljs-title class_">FormViewAnnotation</span>
@<span class="hljs-title class_">ResponseBody</span>
public <span class="hljs-title class_">ResultModel</span>&lt;<span class="hljs-title class_">SubForm</span>&gt; <span class="hljs-title function_">getSubForm</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> mainFormId</span>) {
    <span class="hljs-comment">// 子视图逻辑</span>
}
</code></pre>
<p>通过@DialogAnnotation的subView参数关联子视图，无需在主视图代码中直接调用子视图方法，降低了耦合度，便于子视图的单独修改和复用。</p>
<p><strong>实际局限（缺点）</strong>：视图层级关系“黑盒化”，维护难度增加。当项目包含多个视图层级（如主视图-子视图-子子视图）时，开发者需逐行查阅注解才能梳理清楚关联关系，无直观的层级展示。例如某轻量AI数据配置系统，包含8个关联视图，新入职开发者需花费3天时间梳理注解关联的视图层级，影响上手效率；且删除子视图时，无法快速定位依赖它的主视图，易出现“孤儿视图”或“依赖断裂”问题。</p>
<h2 data-id="heading-6">7. 硬编码配置：稳定可靠的优势与运维灵活的缺失</h2>
<p><strong>设计初衷（优点）</strong>：将视图宽高、图标样式等配置通过注解硬编码，避免“配置漂移”（不同环境配置不一致），提升系统稳定性，降低轻量团队的配置管理成本。文档中硬编码配置示例如下：</p>
<pre><code class="hljs language-javascript" lang="javascript">@<span class="hljs-title class_">RequestMapping</span>(method = <span class="hljs-title class_">RequestMethod</span>.<span class="hljs-property">POST</span>, value = <span class="hljs-string">"DataDialog"</span>)
@<span class="hljs-title class_">DialogAnnotation</span>(caption = <span class="hljs-string">"数据查看"</span>, width = <span class="hljs-string">"800"</span>, height = <span class="hljs-string">"600"</span>)
@<span class="hljs-title class_">ModuleAnnotation</span>(imageClass = <span class="hljs-string">"ri-data-line"</span>, caption = <span class="hljs-string">"数据模块"</span>)
@<span class="hljs-title class_">ResponseBody</span>
public <span class="hljs-title class_">ResultModel</span>&lt;<span class="hljs-title class_">DataView</span>&gt; <span class="hljs-title function_">getDataView</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> dataId</span>) {
    <span class="hljs-comment">// 业务逻辑</span>
}
</code></pre>
<p>硬编码配置确保开发、测试、生产环境的视图属性一致，无需维护多个配置文件，符合轻量级框架“简化运维”的定位。</p>
<p><strong>实际局限（缺点）</strong>：运维灵活性缺失，无法快速响应环境适配需求。当生产环境需适配大屏终端（需将弹窗宽高调整为1200×800），或因业务术语变更需修改视图标题（如“数据查看”改为“智能数据洞察”）时，需修改代码、重新编译部署，整个流程耗时数小时，无法满足运维的快速调整需求。例如某轻量AI监控系统，因客户终端更换需调整弹窗尺寸，仅适配工作就导致系统暂停服务2小时，影响了业务连续性。</p>
<h2 data-id="heading-7">8. 强约束设计：标准化的优势与场景适配的不足</h2>
<p><strong>设计初衷（优点）</strong>：通过强约束（必须使用框架指定注解、必须返回框架定义的强类型模型）实现开发标准化，避免轻量团队因编码习惯差异导致的系统混乱，便于代码复用和维护。文档中强约束示例如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 必须使用框架注解</span>
@<span class="hljs-title class_">RequestMapping</span>(method = <span class="hljs-title class_">RequestMethod</span>.<span class="hljs-property">POST</span>, value = <span class="hljs-string">"ConfigList"</span>)
@<span class="hljs-title class_">GridViewAnnotation</span> <span class="hljs-comment">// 框架指定的网格视图注解</span>
@<span class="hljs-title class_">ResponseBody</span>
<span class="hljs-comment">// 必须返回框架定义的强类型模型</span>
public <span class="hljs-title class_">ListResultModel</span>&lt;<span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">ConfigGrid</span>&gt;&gt; <span class="hljs-title function_">getConfigList</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">ListResultModel</span>&lt;<span class="hljs-title class_">List</span>&amp;lt;<span class="hljs-title class_">ConfigGrid</span>&gt;&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ListResultModel</span>&lt;&gt;();
    result.<span class="hljs-title function_">setData</span>(configService.<span class="hljs-title function_">getConfigList</span>());
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p>强约束确保所有控制层代码风格统一，新开发者可快速熟悉代码结构，符合轻量级框架“低门槛协作”的需求。</p>
<p><strong>实际局限（缺点）</strong>：场景适配能力不足，无法满足特殊业务需求。当业务场景超出框架设计预期（如需返回自定义格式的响应数据，或需使用非框架注解的请求映射规则）时，框架未提供扩展点，开发者只能“绕着框架走”。例如某轻量AI对接第三方系统时，第三方要求响应格式包含“code、msg、data、timestamp”四个固定字段，而Ooder的BaseResultModel仅包含“code、msg、data”，因无法自定义返回模型，开发者需在控制层手动封装响应数据，增加了编码冗余，违背了“轻量化开发”的初衷。</p>
<h2 data-id="heading-8">结语：轻量框架的取舍与成长方向</h2>
<p>Ooder控制层的设计，本质是轻量级企业AI框架“快速开发、简化运维、低门槛协作”核心定位下的必然取舍。其优点精准匹配了轻中型企业小团队的开发需求，通过注解驱动、标准化设计降低了协作和维护成本；而缺点则多是定位适配过程中难以避免的代价，核心集中在“灵活性与标准化”“简洁性与扩展性”的平衡上。</p>
<p>对于Ooder的未来成长，无需刻意追求“全场景适配”，而是可在保持轻量级核心优势的基础上，通过“可选扩展模块”的方式弥补不足——例如提供动态配置模块支持生产环境配置调整、开放核心扩展点支持自定义返回模型、开发轻量化视图层级可视化工具降低维护难度。</p>
<p>作为一款面向轻量场景的企业AI框架，Ooder的价值在于精准解决了特定群体的核心痛点。正视缺点、在定位边界内优化迭代，既能保持自身特色，也能更好地服务于轻中型企业的AI业务落地，这正是轻量级框架的核心成长逻辑。</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MyBatis-Plus 动态表名的正确打开方式]]></title>    <link>https://juejin.cn/post/7589325011543425062</link>    <guid>https://juejin.cn/post/7589325011543425062</guid>    <pubDate>2025-12-30T07:21:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589325011543425062" data-draft-id="7589325011543408678" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MyBatis-Plus 动态表名的正确打开方式"/> <meta itemprop="keywords" content="后端,MyBatis"/> <meta itemprop="datePublished" content="2025-12-30T07:21:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="老马9527"/> <meta itemprop="url" content="https://juejin.cn/user/3472730503785740"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MyBatis-Plus 动态表名的正确打开方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3472730503785740/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    老马9527
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T07:21:48.000Z" title="Tue Dec 30 2025 07:21:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">解决的痛点</h2>
<p>​	在我们日常开发中，经常会遇到某个表的数据量非常大，需要按照年/月进行分表的情况。比如订单表、SN表等等。如何利用MybatisPlus的动态表名插件、以及如何进行使用，都比较繁琐。这里提供的动态表名的使用方式，是以MybatisPlus的动态表名插件为基础构建的。核心特性包括：</p>
<ul>
<li>
<p>基于 MyBatis-Plus 官方动态表名插件</p>
</li>
<li>
<p>白名单机制，防止任意表名注入</p>
</li>
<li>
<p>ThreadLocal 作用域自动清理，避免线程污染</p>
</li>
<li>
<p>提供 <strong>try-with-resources</strong> 与 <strong>函数式 API</strong> 两种使用方式</p>
</li>
</ul>
<h2 data-id="heading-1">使用方式</h2>
<p>使用方式力求简洁，并且要保证在使用动态表名后，能动态清除表名。不留内存碎片。这里提供两个标准方式使用，示例中采用多数据源进行演示。</p>
<ul>
<li>
<p>指定表名并自动清除</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// A库中的2025年订单表</span>
<span class="hljs-keyword">try</span> (DynamicTableNameHelper.<span class="hljs-type">Scope</span> <span class="hljs-variable">ignore</span> <span class="hljs-operator">=</span> DynamicTableNameHelper.use(<span class="hljs-string">"t_xx_order_2025"</span>)) {
    <span class="hljs-type">OrderEntity</span> <span class="hljs-variable">order2025</span> <span class="hljs-operator">=</span> orderMapper.selectById(<span class="hljs-number">1984555429137637378L</span>);
    System.out.println(order2025);
}
<span class="hljs-comment">// A库中的2024年订单表</span>
<span class="hljs-keyword">try</span> (DynamicTableNameHelper.<span class="hljs-type">Scope</span> <span class="hljs-variable">ignore</span> <span class="hljs-operator">=</span> DynamicTableNameHelper.use(<span class="hljs-string">"t_xx_order_2024"</span>)) {
    <span class="hljs-type">OrderEntity</span> <span class="hljs-variable">order2024</span> <span class="hljs-operator">=</span> orderMapper.selectById(<span class="hljs-number">2001114675221204994L</span>);
    System.out.println(order2024);
}
<span class="hljs-comment">// 默认库中的商品表</span>
<span class="hljs-type">ProductInfoEntity</span> <span class="hljs-variable">productInfo</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.productInfoMapper.selectById(<span class="hljs-number">1L</span>);
System.out.println(productInfo);
</code></pre>
</li>
<li>
<p>函数式表名并自动清除</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// A库中的2025年订单表</span>
<span class="hljs-type">OrderEntity</span> <span class="hljs-variable">order2025</span> <span class="hljs-operator">=</span> DynamicTableNameHelper.withTable(<span class="hljs-string">"t_xx_order_2025"</span>, () -&gt; orderMapper.selectById(<span class="hljs-number">1984555429137637378L</span>));
System.out.println(order2025);
<span class="hljs-comment">// A库中的2024年订单表</span>
<span class="hljs-type">OrderEntity</span> <span class="hljs-variable">order2024</span> <span class="hljs-operator">=</span> DynamicTableNameHelper.withTable(<span class="hljs-string">"t_xx_order_2024"</span>, () -&gt; orderMapper.selectById(<span class="hljs-number">2001114675221204994L</span>));
System.out.println(order2024);
<span class="hljs-comment">// 默认库中的产品表</span>
<span class="hljs-type">ProductInfoEntity</span> <span class="hljs-variable">productInfoEntity</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.productInfoMapper.selectById(<span class="hljs-number">1L</span>);
System.out.println(productInfoEntity);
</code></pre>
</li>
</ul>
<blockquote>
<p>示例中特意采用了多数据源进行演示，目的想说明这个动态表名和多数据源之间并不冲突。</p>
<p>上面两种使用方式，没有好坏之分。仅仅是使用习惯而已。就我而且可能更倾向于使用代码更简洁的第2中方式。</p>
</blockquote>

















<table><thead><tr><th>使用方式</th><th>适合场景</th></tr></thead><tbody><tr><td>try-with-resources</td><td>多条 SQL、复杂逻辑、跨方法调用</td></tr><tr><td>withTable</td><td>单次查询 / 插入 / 更新</td></tr></tbody></table>
<h2 data-id="heading-2">如何做到</h2>
<p>这里就要结合MybatisPlus的动态表名插件,所以这里会一步一步，在Springboot项目中把实现方式列举出来。</p>
<h3 data-id="heading-3">动态表名白名单</h3>
<p>为了想拦截需要进行动态的表名，这里采用配置文件中进行配置的方式。如果配置了就行拦截，否则也没有什么影响。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 配置的动态表名白名单
 *
 * <span class="hljs-doctag">@author</span> 老马
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@ConfigurationProperties(prefix = "ums.database.dynamic-table")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicTableProperties</span> {

    <span class="hljs-comment">/**
     * 允许使用动态表名的表（逻辑表名）
     */</span>
    <span class="hljs-keyword">private</span> Set&lt;String&gt; tables = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();
}
</code></pre>
<p>这里对应使用时的配置：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">ums:</span>
  <span class="hljs-attr">database:</span>
    <span class="hljs-attr">dynamic-table:</span>
      <span class="hljs-attr">tables:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">t_xx_order</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">t_xx_sn</span>
</code></pre>
<blockquote>
<p>说明：</p>
<ul>
<li>这里配置的是 <strong>逻辑表名</strong></li>
<li>采用 <strong>前缀匹配策略</strong></li>
<li>示例中：
<ul>
<li><code>t_xx_order_2024</code></li>
<li><code>t_xx_order_2025</code>
都会被允许</li>
</ul>
</li>
<li>如果使用了DynamicTableNameHelper类，但提供的又不是动态表名白名单中的表名，那么会提示错误</li>
</ul>
</blockquote>
<h3 data-id="heading-4">动态表名</h3>
<p>该类，最重要的作用就是判断MybatisPlus的动态表名插件传入的表名是不是在配置的白名单中。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 动态表名白名单
 *
 * <span class="hljs-doctag">@author</span> 老马
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicTables</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Set&lt;String&gt; TABLES = Collections.emptySet();

    <span class="hljs-keyword">private</span> <span class="hljs-title function_">DynamicTables</span><span class="hljs-params">()</span> {
    }

    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(Set&lt;String&gt; tables)</span> {
        <span class="hljs-comment">// 创建不可更改的Set</span>
        TABLES = Collections.unmodifiableSet(tables);
    }

    <span class="hljs-comment">/**
     * 是否允许使用动态表名
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isDynamic</span><span class="hljs-params">(String tableName)</span> {
        <span class="hljs-keyword">if</span> (!StringUtils.hasText(tableName)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">return</span> TABLES.stream().anyMatch(tableName::startsWith);
    }
}
</code></pre>
<blockquote>
<p>说明：</p>
<ul>
<li>使用不可变 <code>Set</code>，避免运行期被修改</li>
<li>通过前缀匹配支持多张物理分表</li>
<li>所有动态表名必须命中白名单</li>
</ul>
</blockquote>
<h3 data-id="heading-5">mybatis-plus配置类</h3>
<p>核心的配置类，这里重点关注初始化动态表名白名单和动态表名插件的处理。</p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-comment">/**
 * mybatis-plus配置类
 *
 * <span class="hljs-doctag">@author</span> 老马
 */</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-meta">@EnableConfigurationProperties(DynamicTableProperties.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MybatisPlusConfig</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DynamicTableProperties dynamicTableProperties;

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> MybatisPlusInterceptor <span class="hljs-title function_">mybatisPlusInterceptor</span><span class="hljs-params">()</span> {
        <span class="hljs-type">MybatisPlusInterceptor</span> <span class="hljs-variable">interceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MybatisPlusInterceptor</span>();
        <span class="hljs-comment">// 动态表名插件</span>
        interceptor.addInnerInterceptor(dynamicTableNameInnerInterceptor());
        <span class="hljs-comment">// 其他插件</span>
        <span class="hljs-keyword">return</span> interceptor;
    }

    <span class="hljs-comment">/**
     * 动态表名插件
     */</span>
    <span class="hljs-keyword">private</span> DynamicTableNameInnerInterceptor <span class="hljs-title function_">dynamicTableNameInnerInterceptor</span><span class="hljs-params">()</span> {
        <span class="hljs-type">TableNameHandler</span> <span class="hljs-variable">tableNameHandler</span> <span class="hljs-operator">=</span> (sql, tableName) -&gt; {
            <span class="hljs-comment">// 不在白名单，直接返回原表名</span>
            <span class="hljs-keyword">if</span> (!DynamicTables.isDynamic(tableName)) {
                <span class="hljs-keyword">return</span> tableName;
            }
            <span class="hljs-comment">// 取当前线程绑定的动态表名</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">dynamicTableName</span> <span class="hljs-operator">=</span> DynamicTableNameHelper.get();

            <span class="hljs-comment">//  没有设置动态表名，兜底返回原表名</span>
            <span class="hljs-keyword">return</span> StringUtils.hasText(dynamicTableName)
                    ? dynamicTableName
                    : tableName;
        };
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicTableNameInnerInterceptor</span>(tableNameHandler);

    }

    <span class="hljs-comment">/**
     * 初始化动态表名白名单
     */</span>
    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initDynamicTables</span><span class="hljs-params">()</span> {
        DynamicTables.init(dynamicTableProperties.getTables());
    }
}
</code></pre>
<h3 data-id="heading-6">动态表名助手类</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 动态表名辅助类
 *
 * <span class="hljs-doctag">@author</span> 银商北分-老马
 * <span class="hljs-doctag">@since</span> 1.0.0
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicTableNameHelper</span> {

    <span class="hljs-comment">/**
     * 表名正则
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TABLE_NAME_REGEX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"[a-zA-Z0-9_]+"</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;String&gt; HOLDER = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();

    <span class="hljs-keyword">private</span> <span class="hljs-title function_">DynamicTableNameHelper</span><span class="hljs-params">()</span> {}

    <span class="hljs-comment">/**
     * 使用动态表名
     *
     * <span class="hljs-doctag">@param</span> tableName 表名
     * <span class="hljs-doctag">@return</span> 作用域
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Scope <span class="hljs-title function_">use</span><span class="hljs-params">(String tableName)</span> {
        validate(tableName);
        <span class="hljs-keyword">if</span> (!DynamicTables.isDynamic(tableName)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"表 ["</span> + tableName + <span class="hljs-string">"] 未配置为允许动态表名"</span>);
        }
        <span class="hljs-type">String</span> <span class="hljs-variable">old</span> <span class="hljs-operator">=</span> HOLDER.get();
        HOLDER.set(tableName);
        <span class="hljs-keyword">return</span> () -&gt; {
            <span class="hljs-keyword">if</span> (old == <span class="hljs-literal">null</span>) {
                HOLDER.remove();
            } <span class="hljs-keyword">else</span> {
                HOLDER.set(old);
            }
        };
    }

    <span class="hljs-comment">/**
     * 在指定的动态表名作用域内执行操作
     *
     * <span class="hljs-doctag">@param</span> table    表名
     * <span class="hljs-doctag">@param</span> supplier 执行逻辑
     * <span class="hljs-doctag">@param</span> &lt;T&gt;      返回值类型
     * <span class="hljs-doctag">@return</span> 返回值
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">withTable</span><span class="hljs-params">(String table, Supplier&lt;T&gt; supplier)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Scope</span> <span class="hljs-variable">ignored</span> <span class="hljs-operator">=</span> use(table)) {
            <span class="hljs-keyword">return</span> supplier.get();
        }
    }

    <span class="hljs-comment">/**
     * 在指定的动态表名作用域内执行操作（无返回值）
     *
     * <span class="hljs-doctag">@param</span> table    表名
     * <span class="hljs-doctag">@param</span> runnable 执行逻辑
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">withTable</span><span class="hljs-params">(String table, Runnable runnable)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Scope</span> <span class="hljs-variable">ignored</span> <span class="hljs-operator">=</span> use(table)) {
            runnable.run();
        }
    }

    <span class="hljs-comment">/**
     * 获取当前作用域的表名
     *
     * <span class="hljs-doctag">@return</span> 表名
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> HOLDER.get();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validate</span><span class="hljs-params">(String tableName)</span> {
        <span class="hljs-keyword">if</span> (tableName == <span class="hljs-literal">null</span> || tableName.isBlank()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"tableName 不能为空"</span>);
        }
        <span class="hljs-keyword">if</span> (!tableName.matches(TABLE_NAME_REGEX)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"非法表名："</span> + tableName);
        }
    }

    <span class="hljs-meta">@FunctionalInterface</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Scope</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AutoCloseable</span> {
        <span class="hljs-comment">/**
         * 关闭作用域
         */</span>
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span>;
    }
}
</code></pre>
<blockquote>
<p>说明：</p>
<ul>
<li>动态表名通过 <code>ThreadLocal</code> 保存</li>
<li>通过作用域模式确保 <strong>set / remove 成对执行</strong></li>
<li>避免线程池复用导致的表名污染问题</li>
<li>另外还支持嵌套调用</li>
</ul>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 嵌套调用示例</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">Scope</span> <span class="hljs-variable">s1</span> <span class="hljs-operator">=</span> use(<span class="hljs-string">"t_xx_order_2025"</span>)) {
    <span class="hljs-comment">// 查询 2025</span>
    <span class="hljs-keyword">try</span> (<span class="hljs-type">Scope</span> <span class="hljs-variable">s2</span> <span class="hljs-operator">=</span> use(<span class="hljs-string">"t_xx_order_2024"</span>)) {
        <span class="hljs-comment">// 查询 2024</span>
    }
    <span class="hljs-comment">// 自动恢复为 2025</span>
}
</code></pre>
<h3 data-id="heading-7">实体类</h3>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@TableName("t_xx_order")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderEntity</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {
    <span class="hljs-comment">/**
     * 主键
     */</span>
    <span class="hljs-meta">@TableId</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-comment">/**
     * 下单日期,格式：yyyy-MM-dd
     */</span>
    <span class="hljs-keyword">private</span> String orderCreateDate;

    <span class="hljs-comment">/**
     * 订单号
     */</span>
    <span class="hljs-keyword">private</span> String orderno;
    
    <span class="hljs-comment">// ...省略其他属性</span>
}
</code></pre>
<blockquote>
<p>注意：</p>
<p>这里特别强调一下，这个动态表，一定要用@TableName注解告诉MybatisPlus的动态表名组件，逻辑表名叫什么。也就是我们这里的@TableName("t_xx_order")。否则无法拼接完成表名。默认MybatisPlus通过类，不会有前面的"t_xx_"。之后映射为order_entity，这种表名，那么在执行时就会报表或者视图不存在的错误了。</p>
</blockquote>
<h2 data-id="heading-8">避坑指南</h2>
<p>本方案的动态表名能力是<strong>基于 <code>ThreadLocal</code> 实现的</strong>，因此在使用时需要特别注意线程边界问题。</p>
<h3 data-id="heading-9">不支持的场景</h3>
<p>以下场景中，<strong>动态表名不会自动生效</strong>，甚至可能出现查错表的风险：</p>
<ul>
<li><code>@Async</code> 标注的方法</li>
<li>手动使用线程池（<code>ExecutorService.submit / execute</code>）</li>
<li><code>CompletableFuture</code>（使用默认或自定义线程池）</li>
<li>任何发生 线程切换 的异步执行场景</li>
</ul>
<p>原因在于：
<code>ThreadLocal</code> 中保存的动态表名 <strong>不会在线程之间自动传递</strong>。</p>
<h3 data-id="heading-10">错误示例</h3>
<pre><code class="hljs language-java" lang="java">DynamicTableNameHelper.withTable(<span class="hljs-string">"t_xx_order_2025"</span>, () -&gt; {
    asyncService.doAsyncQuery(); <span class="hljs-comment">// @Async 方法</span>
});
</code></pre>
<p>上述代码中，doAsyncQuery 方法运行在新的线程中，此时动态表名上下文已经丢失，最终仍然会访问逻辑表名对应的默认表。</p>
<h3 data-id="heading-11">正确使用方式</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Async</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doAsyncQuery</span><span class="hljs-params">()</span> {
    DynamicTableNameHelper.withTable(<span class="hljs-string">"t_xx_order_2025"</span>, () -&gt; {
        orderMapper.selectById(<span class="hljs-number">1L</span>);
    });
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一次线上样式问题复盘：当你钻进 CSS 牛角尖时，问题可能根本不在 CSS]]></title>    <link>https://juejin.cn/post/7589214068093943827</link>    <guid>https://juejin.cn/post/7589214068093943827</guid>    <pubDate>2025-12-30T07:25:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589214068093943827" data-draft-id="7589214068093878291" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一次线上样式问题复盘：当你钻进 CSS 牛角尖时，问题可能根本不在 CSS"/> <meta itemprop="keywords" content="CSS,前端"/> <meta itemprop="datePublished" content="2025-12-30T07:25:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="vim怎么退出"/> <meta itemprop="url" content="https://juejin.cn/user/3408900584639341"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一次线上样式问题复盘：当你钻进 CSS 牛角尖时，问题可能根本不在 CSS
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3408900584639341/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    vim怎么退出
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T07:25:28.000Z" title="Tue Dec 30 2025 07:25:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial;color:#00325e}.markdown-body ::selection{background-color:#00325e;color:#fff}.markdown-body blockquote{padding:10px 20px;background-color:#fffaf0;box-shadow:0 3px 10px 0 rgba(255,172,194,.24);border:1px solid #f3ca8e;transition:all .2s;margin:1em 0;border-radius:5px}.markdown-body blockquote p{font-size:14px;line-height:25px;color:#795548}.markdown-body blockquote p:last-child{margin:0}.markdown-body blockquote:hover{border-color:#ff9800;background-color:#fff8e0;box-shadow:0 6px 10px -5px rgba(225,173,98,.3803921569)}.markdown-body blockquote code{color:#ff502c}.markdown-body pre{border:1px solid #8cc0f3;box-shadow:0 3px 10px 0 rgba(255,198,198,.28);border-radius:5px;transition:all .2s;overflow-x:auto;white-space:pre-wrap}.markdown-body pre:hover{border-color:#6d9dce}.markdown-body pre&gt;code{padding:10px 20px;color:#00325e;background:#f0f8ff;font-size:12px;line-height:1.6;display:block}.markdown-body code{background:#f6fbff;color:#0b5393;padding:2px 4px;border-radius:4px;font-size:12px}.markdown-body p{font-size:14px;line-height:28px;text-align:justify;margin-bottom:17px;color:#595959}.markdown-body a{color:#00325e;text-decoration:none}.markdown-body a:after{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAAXNSR0IArs4c6QAAAQdJREFUKFNt0DtLA0EUBeBzZle0Eks7rcUfEfBRCha7NorYa6NmVJzgyi4smUgKtdZGCJktLMVH4Y8QeztLWyE7VyLEuNFbXj4Oh0P8c8mZm+uJrEN4BJFTeP/MUVe3bnocfALwkOlo1zS7iZAzf6Cx7oXgbaqjxiDEWCcVaGyxQ8pSWo9XhqhoQ/xUFbaKjhe5V+CmR7mnSplEEF6GSmJ+F/d0KHvbCIIJCLc85U6BC5mONgbJNM3uFag++sX7z8O8MzsWBucifMx0dDGE1kmm458KDVukAlnNdDz/exEeW3dNkbfsYC0xtmgDWP6ELLZ0/F6BJu/UoFQN5AkoeUjeJPvx6+i+X5Sjah4tA6gYAAAAAElFTkSuQmCC);margin-left:2px}.markdown-body a:hover{box-shadow:0 1px}.markdown-body table{max-width:100%;border-collapse:collapse;border-spacing:0;box-shadow:0 3px 10px 0 rgba(255,238,172,.24);transition:all .2s}.markdown-body table:hover{box-shadow:0 3px 10px 0 rgba(185,169,103,.24)}.markdown-body table tr th{border:1px solid #8cc0f3;background-color:#f0f8ff;padding:12px 15px}.markdown-body table tr td{border:1px solid rgba(243,202,142,.4);padding:12px 15px}.markdown-body table tbody tr{transition:all .2s}.markdown-body table tbody tr:hover td{border-color:#f3ca8e;background-color:#fff8e0;z-index:1}.markdown-body img{max-width:100%}.markdown-body h1{font-size:20px;margin-top:30px;margin-bottom:10px;padding-left:30px;position:relative}.markdown-body h1&gt;code{font-size:20px}.markdown-body h1:before{content:"🍺";display:block;font-size:18px;width:18px;height:18px;left:0;position:absolute}.markdown-body h2{font-size:18px;margin-top:30px;margin-bottom:10px;padding-left:28px;position:relative}.markdown-body h2&gt;code{font-size:18px}.markdown-body h2:before{content:"🍻";display:block;font-size:16px;width:16px;height:16px;left:0;position:absolute}.markdown-body h3{font-size:16px;margin-top:30px;margin-bottom:10px;padding-left:26px;position:relative}.markdown-body h3&gt;code{font-size:16px}.markdown-body h3:before{content:"🥂";display:block;font-size:14px;width:14px;height:14px;left:0;position:absolute}.markdown-body h4{font-size:14px;margin-top:30px;margin-bottom:10px;padding-left:24px;position:relative}.markdown-body h4&gt;code{font-size:14px}.markdown-body h4:before{content:"🥃";display:block;font-size:12px;width:12px;height:12px;left:0;position:absolute}.markdown-body h5{font-size:12px;margin-top:30px;margin-bottom:10px}.markdown-body h5&gt;code{font-size:12px}.markdown-body h6{font-size:10px;margin-top:30px;margin-bottom:10px}.markdown-body h6&gt;code{font-size:10px}.markdown-body h1,.markdown-body h2{color:#ff502c}.markdown-body hr{height:4px;border:none;margin-top:32px;margin-bottom:32px;background-size:4px 1px;background-image:linear-gradient(270deg,#6d9dce,#8cc0f3 25%,transparent 50%)}.markdown-body hr:nth-child(2n){background-image:linear-gradient(270deg,#ff9800,#fff8e0 25%,transparent 50%)}.markdown-body ul{padding-inline-start:20px}.markdown-body ul li{list-style-type:"🔸"}.markdown-body ul li li{list-style-type:"◻️"}.markdown-body ul li li li{list-style-type:"▫️"}.markdown-body ol{padding-inline-start:20px}.markdown-body ol ::marker{color:#ff9800}.markdown-body ol,.markdown-body ul{line-height:2em}.markdown-body li{padding-inline-start:1ch}.markdown-body li.task-list-item{list-style:none;padding-inline-start:0}.markdown-body li input{padding-right:2px}.markdown-body li input[type=checkbox i]{appearance:none}.markdown-body li input:before{content:"🟩";display:block;width:13px;height:13px}.markdown-body li input:checked:before{content:"✅"}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atelier-sulphurpool-light">.hljs-comment,.hljs-quote{color:#6b7394}.hljs-attribute,.hljs-link,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#c94922}.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#c76b29}.hljs-bullet,.hljs-string,.hljs-symbol{color:#ac9739}.hljs-section,.hljs-title{color:#3d8fd1}.hljs-keyword,.hljs-selector-tag{color:#6679cc}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#f5f7ff;color:#5e6687}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景：一个看似很“典型”的样式问题</h2>
<p>线上遇到一个样式问题：</p>
<blockquote>
<p>页面底部的 footer 无法被撑到预期高度，看起来像是高度计算出了问题。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d38912c1084543b096051e7a2eabb3fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdmlt5oCO5LmI6YCA5Ye6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767684328&amp;x-signature=VWp7hu%2Fn087M4MjnuhAdbCetNCU%3D" alt="image.png" loading="lazy"/></p>
<p>从表象看，这是一个<strong>非常典型的 CSS 问题</strong>：</p>
<ul>
<li>高度没生效</li>
<li>布局被压缩</li>
<li>父子元素高度关系异常</li>
</ul>
<p>于是我很自然地开始从「局部样式」入手排查。</p>
<hr/>
<h2 data-id="heading-1">第一阶段：在“正确但无效”的方向里打转</h2>
<p>我的第一反应（相信很多前端都会）是：</p>
<ul>
<li>是不是 <code>flex</code> 没用对？</li>
<li>是不是 <code>height: 100%</code> 没生效？</li>
<li>是不是父容器没有明确高度？</li>
<li>要不要改成 <code>min-height</code>？</li>
<li>会不会是 BFC / overflow 的问题？</li>
</ul>
<p>于是我开始：</p>
<ul>
<li>反复调整 footer 和父容器的 CSS</li>
<li>检查 DOM 结构</li>
<li>对比正常和异常页面的样式差异</li>
</ul>
<p>甚至还把问题丢给了 AI，希望从 CSS 角度找到一个“精确解法”。</p>
<p>👉 <strong>但问题是：这些分析逻辑本身都没错，却始终解决不了问题。</strong></p>
<hr/>
<h2 data-id="heading-2">第二阶段：意识到自己可能“钻牛角尖了”</h2>
<p>真正让我停下来的是一个感觉：</p>
<blockquote>
<p>我已经在同一小块区域里反复验证假设，但没有任何实质进展。</p>
</blockquote>
<p>这时候我意识到一个危险信号：</p>
<ul>
<li>❌ 我默认「问题一定在 footer 或它的直接父级」</li>
<li>❌ 我默认这是一个“局部 CSS 失效问题”</li>
<li>❌ 我不断在验证<strong>同一类假设</strong></li>
</ul>
<p>于是我强迫自己换了一个思路：</p>
<blockquote>
<p><strong>先不管 footer，看看整个页面的高度是怎么被算出来的。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-3">第三阶段：把视野拉大，问题反而变简单了</h2>
<p>当我从页面根节点开始往下看布局结构时，很快发现了一个异常点：</p>
<p>👉 <strong>table 容器被设置了 <code>height: 50%</code> 的固定比例高度</strong></p>
<p>这件事的影响是：</p>
<ul>
<li>table 本身高度被强行限制</li>
<li>页面整体高度无法自然撑开</li>
<li>footer 即使写得再“正确”，也只能在剩余空间里挤着</li>
</ul>
<p>而 footer “看起来没被撑高”，<strong>其实只是被上游布局截断了</strong>。</p>
<hr/>
<h2 data-id="heading-4">真正的解决方案（非常简单）</h2>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 原本 */</span>
<span class="hljs-selector-class">.table-wrapper</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">50%</span>;
}

<span class="hljs-comment">/* 修改后 */</span>
<span class="hljs-selector-class">.table-wrapper</span> {
  <span class="hljs-attribute">height</span>: auto; <span class="hljs-comment">/* 或直接移除 */</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-5">复盘：这个问题真正难的地方是什么？</h2>
<p>这个问题<strong>并不难</strong>，但它有几个很容易让人误判的点：</p>
<h3 data-id="heading-6">1️⃣ 表象非常像“footer 自身的问题”</h3>
<p>下意识认为：</p>
<ul>
<li>footer 写错了</li>
<li>高度没生效</li>
<li>flex 布局有 bug</li>
</ul>
<h3 data-id="heading-7">2️⃣ 局部样式逻辑是“自洽的”</h3>
<p>CSS 写的没问题，AI 给的建议也没错，但：</p>
<blockquote>
<p><strong>在错误的前提下，所有正确的推导都是无效的。</strong></p>
</blockquote>
<h3 data-id="heading-8">3️⃣ 真正的问题在“更上游”</h3>
<p>布局问题里，经常是：</p>
<ul>
<li>子元素异常</li>
<li>但根因在祖先节点</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[鸿蒙激励的羊毛，你"薅"到了么？]]></title>    <link>https://juejin.cn/post/7589445154533392436</link>    <guid>https://juejin.cn/post/7589445154533392436</guid>    <pubDate>2025-12-30T07:28:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589445154533392436" data-draft-id="7589308109641154595" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="鸿蒙激励的羊毛，你&quot;薅&quot;到了么？"/> <meta itemprop="keywords" content="APP,Apple,uni-app"/> <meta itemprop="datePublished" content="2025-12-30T07:28:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iOS研究院"/> <meta itemprop="url" content="https://juejin.cn/user/1421041942671774"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            鸿蒙激励的羊毛，你"薅"到了么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1421041942671774/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iOS研究院
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T07:28:48.000Z" title="Tue Dec 30 2025 07:28:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>鸿蒙应用开发者激励计划2025，是由华为发起的开发者支持项目，旨在通过提供现金激励，鼓励开发者参与鸿蒙应用、游戏（含游戏App和小游戏，以下如无特指均使用“游戏”统一描述）、元服务的开发，以推动鸿蒙生态的建设和繁荣发展。</p>
<p>距离鸿蒙激励还有最后一天。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/805cd491ccbc4d3fa043b943c189fd07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767684528&amp;x-signature=SaBThFnPxIjA4X1A55TBP4zX044%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-1">跟进政策走</h3>
<p>听人说，有些小公司专搞 <code>“面向补贴编程”，靠反复上包薅政策羊毛</code>。</p>
<p>我觉得吧，这种路子对刚入门的开发者来说，确实能赚点小钱、当个入门激励。</p>
<p>尤其对于新手来说，<code>比起苹果审核的冷漠，国内安卓市场的内卷，谷歌市场的封杀</code>。鸿蒙开发确实更适合，用自身技能变现+紧跟政策红利。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd2648bf4db34a47bb6176ba515b5f33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767684528&amp;x-signature=plCli1BFQSVaAx1ntFiozuKA1vg%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">强者思维</h3>
<p>你不是缺机会，你是缺了一双发现机会的眼睛。</p>
<p>思维对比：</p>
<ul>
<li>﻿有钱人：专注赚钱机会</li>
<li>﻿普通人：专注过程困难</li>
</ul>
<p>这种深植于骨髓的习惯性思维，短期内看似无关紧要，但拉长到五年、十年，便造就了人与人之间无法逾越的鸿沟。</p>
<p><strong>世界上不缺赚钱的机会，只缺“看见”机会的人。</strong></p>
<p><code>遵守规则，方得长治久安</code>，最后祝大家大吉大利，今晚过审！</p>
<h3 data-id="heading-3">相关推荐</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FURmC_4vxQv5ttOg8yYe7Eg" target="_blank" title="https://mp.weixin.qq.com/s/URmC_4vxQv5ttOg8yYe7Eg" ref="nofollow noopener noreferrer"># 苹果开发者续费大坑及成功续费方案！亲测有效</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F1bAA90Tzpx03tTHZbdg3aw" target="_blank" title="https://mp.weixin.qq.com/s/1bAA90Tzpx03tTHZbdg3aw" ref="nofollow noopener noreferrer"># AppStore敏感词排查手册，多维度分析Guideline 2.3.1隐藏功能，轻松过审。</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FV2F4BaEYh5HfeUUHm1tI6Q" target="_blank" title="https://mp.weixin.qq.com/s/V2F4BaEYh5HfeUUHm1tI6Q" ref="nofollow noopener noreferrer"># 如何主动提防苹果3.2f的进攻，自查防御手册（代码篇）</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FLs3su8fmMckTocPwMmFaNQ" target="_blank" title="https://mp.weixin.qq.com/s/Ls3su8fmMckTocPwMmFaNQ" ref="nofollow noopener noreferrer"># 如何主动提防苹果3.2f的进攻，自查防御手册（ASO篇）</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484371%26idx%3D1%26sn%3D33568c58e90a5bf4d2612d803ecb2a27%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484371&amp;idx=1&amp;sn=33568c58e90a5bf4d2612d803ecb2a27&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 苹果加急审核是“绿色通道”还是“死亡陷阱”？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484362%26idx%3D1%26sn%3Dea61bd42d5ae8b99d2a56cbfb8d91e88%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484362&amp;idx=1&amp;sn=ea61bd42d5ae8b99d2a56cbfb8d91e88&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 苹果开发者邮箱，突然收到11.2通知严重么？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484413%26idx%3D1%26sn%3D82870d4c8892fa65803a8e05fd5ac938%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484413&amp;idx=1&amp;sn=82870d4c8892fa65803a8e05fd5ac938&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 不想被苹果卡审最好错开这两个提审时间</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484349%26idx%3D1%26sn%3D1c75a6b08cb5de64ddf41a88b61ff108%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484349&amp;idx=1&amp;sn=1c75a6b08cb5de64ddf41a88b61ff108&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 手撕苹果审核4.3是代码问题还是设计问题？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484344%26idx%3D1%26sn%3D4399eb8d8bf82e9c5df26a18b8564cfb%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484344&amp;idx=1&amp;sn=4399eb8d8bf82e9c5df26a18b8564cfb&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 有幸和Appstore审核人员进行了一场视频会议特此记录。</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手把手教你通过Gemini3 pro 学生认证，白用一年，手慢无！]]></title>    <link>https://juejin.cn/post/7589231401658220554</link>    <guid>https://juejin.cn/post/7589231401658220554</guid>    <pubDate>2025-12-30T07:24:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589231401658220554" data-draft-id="7589509638339313690" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手把手教你通过Gemini3 pro 学生认证，白用一年，手慢无！"/> <meta itemprop="keywords" content="AI编程,Gemini"/> <meta itemprop="datePublished" content="2025-12-30T07:24:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="攻城师不浪"/> <meta itemprop="url" content="https://juejin.cn/user/1697301684048200"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手把手教你通过Gemini3 pro 学生认证，白用一年，手慢无！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1697301684048200/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    攻城师不浪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T07:24:23.000Z" title="Tue Dec 30 2025 07:24:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>大家好，我是日拱一卒的<code>攻城师不浪</code>，致力于前沿科技探索，这是2025年输出的第<strong>66/100</strong>篇原创文章。</p>
</blockquote>
<p>最近，团队里很多小伙伴儿都说自己白嫖到了谷歌<code>Gemini3 Pro</code>的<strong>学生教育优惠</strong>，能够免费使用<code>1年</code>！</p>
<p>Gemini的实力还是很强大的。我的粉丝大部分都是程序员，Gemini在用代码<code>画界面</code>这方面还是很强的，而且它的设计能力也很强，甚至要超出<code>Claude</code>和<code>Opus</code>。</p>
<p>例如，我们内部有一个<strong>多语言组件</strong>，类似于这样</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b274bf8845384d07adf4d05fe9f04f4a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS75Z-O5biI5LiN5rWq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767684262&amp;x-signature=uXH11mhz1eSEKO4P%2FPlGzBNlGbQ%3D" alt="" loading="lazy"/></p>
<p>这里有一个体验不太好的地方：每次用户都要先去把对应的三种语言翻译好，然后再手动输入3个框，多少有点麻烦。</p>
<p>所以团队同学想提升这个组件的用户体验，让其使用起来更方便快捷，因此想做一个自动翻译的功能。</p>
<p>团队同学就用到了Gemini，把需求给到它，它一次性输出了多个交互方案，并推荐了一个它认为最佳的方案。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03b8f108e36343e684e059df4b82767b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS75Z-O5biI5LiN5rWq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767684262&amp;x-signature=GWfyVFbncL%2Bim2SZ1kbHThd0kis%3D" alt="" loading="lazy"/></p>
<p>这界面和交互，怎么样，感觉已经吊打多数<code>UI</code>、<code>UED</code>了吧，这简直太方便了！关键这还节省了大量的人力和时间。</p>
<p>所以，我决定也去白嫖一下Gemini。大家都知道我刚刚新加入了一个公司，是一家以技术型为主导的，团队的小伙伴们也都是对技术和产品很有品味的。</p>
<p>我们自己内部封装了很多业务通用组件，但我们也会时不时对技术和产品进行打磨，希望从技术和交互方面不断的提升用户体验，争取让产品更上一个台阶。</p>
<p>所以无论是谁，如果有更好的想法提出来，就可以去做，氛围很Open。这时如果有了AI的强力协助，相信自己的效率也会有大幅的提高，可以为团队做更多有意义的事情。</p>
<p>好了，言归正传，其实，只需要3步即可白嫖Gemini3 Pro一整年！</p>
<h3 data-id="heading-0">准备工作</h3>
<ol>
<li>会魔法，可以登录外网；</li>
<li>一个google账号；</li>
<li>一个visa全币种卡；</li>
</ol>
<h3 data-id="heading-1">一、魔法</h3>
<p>切记！魔法节点选择<strong>美国的节点</strong>，否则可能会有不通过的风险！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d507fc168559473184991facc3736cda~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS75Z-O5biI5LiN5rWq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767684262&amp;x-signature=hnpZrheeIuJzVsguGKL99UXWjlc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">二、学生认证</h3>
<p>登录：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgemini.google%2Fstudents%2F" target="_blank" title="https://gemini.google/students/" ref="nofollow noopener noreferrer">gemini.google/students/</a></p>
<p>点击<code>get offer</code></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06192a7aaefd4220908f82e4623f65f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS75Z-O5biI5LiN5rWq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767684262&amp;x-signature=c%2FiMY0Pl3UFqP9RZ6P1HuiRDTWY%3D" alt="" loading="lazy"/></p>
<p>这时候，你会进入一个学生认证页面链接，把这个链接复制下来；</p>
<p>这里教大家一个非常方便快捷的方式去通过学生认证，就是去某二手平台**“某鱼”**，搜gemini学生认证，会出来一大堆帮你通过学生认证的，价格不一样，这里你可以选一个便宜的，不浪当时选了个<code>2.59</code>的，可以说非常划算了已经。</p>
<p>等你mai了之后，商家基本上都会给你发送一个<strong>链接</strong>和<strong>卡密</strong>，这个链接他们会号称是自研的一个过学生认证的系统，类似于这样的一个界面：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/148b9c51ee334c2c967d4611078ec808~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS75Z-O5biI5LiN5rWq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767684262&amp;x-signature=bvDGYP5V2Nn6C8epMrKziwy8tPY%3D" alt="" loading="lazy"/></p>
<p>我们只需要关心左边的两个输入框；</p>
<ul>
<li>
<p><strong>卡密</strong>：商家会给你；</p>
</li>
<li>
<p><strong>认证链接</strong>：上边让你复制的那个网页链接；</p>
</li>
</ul>
<p>提交验证，我当时10几秒钟就认证通过了，非常快！</p>
<p>通过之后，去你刚刚复制的页面链接（学生认证页面），刷新一下，会显示认证通过，接下来google会让你绑卡。虽然是免费的了，但是需要你有一个支付渠道才行。</p>
<h3 data-id="heading-3">支付渠道</h3>
<p>这时候，你需要有一个<strong>visa</strong>或者<strong>master全币种卡</strong>，用来绑定，各大行基本都会有这种，你只需要申请办一张绑定即可，这里我就不多啰嗦咯。</p>
<p>最终，如果你绑定成功之后，就会呈现这样的画面</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/600b9570c1994991a306d7681f347987~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS75Z-O5biI5LiN5rWq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767684262&amp;x-signature=SURZ9tNrQkohe1DToN75HjhPm7c%3D" alt="" loading="lazy"/></p>
<p>看到这个界面，心里还有点小兴奋，因为捡到大便宜咯！</p>
<p>接下来，就可以“无耻”的无限制的去玩<strong>Gemini</strong>啦！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6502d062562f4323b4c57c99e240de92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS75Z-O5biI5LiN5rWq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767684262&amp;x-signature=NcBT5mZg%2BrOvjMF7Y%2F3UTwGV270%3D" alt="" loading="lazy"/></p>
<p>好美！</p>
<p>好了，以上就是操作的完整步骤，有兴趣的同学，还是建议早早去弄，不知道google这个“bug”会释放多久，说不定哪一天就被堵上啦。</p>
<p>如果还有其它骚操作的，也欢迎评论区交流，乐于分享者最美！</p>
<blockquote>
<p>有需要进<code>AI交流群</code>可以加我：brown_7778（备注来意）。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[四个指标，一种哲学：Prometheus 如何用简单模型看透复杂系统]]></title>    <link>https://juejin.cn/post/7589146208225296420</link>    <guid>https://juejin.cn/post/7589146208225296420</guid>    <pubDate>2025-12-29T05:29:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589146208225296420" data-draft-id="7588570963294519339" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="四个指标，一种哲学：Prometheus 如何用简单模型看透复杂系统"/> <meta itemprop="keywords" content="后端,架构,Go"/> <meta itemprop="datePublished" content="2025-12-29T05:29:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            四个指标，一种哲学：Prometheus 如何用简单模型看透复杂系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T05:29:53.000Z" title="Mon Dec 29 2025 05:29:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    26
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读34分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Prometheus 只用四种指标类型就能描述世间万物的监控需求：Counter、Gauge、Histogram、Summary。</p>
<p>这看似简单，但背后藏着一整套设计哲学：</p>
<ul>
<li><strong>如何用最简单的模型描述最复杂的系统？</strong></li>
<li><strong>如何在灵活性和约束之间找到平衡？</strong></li>
<li><strong>为什么"允许 Counter 重置"反而是更优雅的设计？</strong></li>
</ul>
<p>这不是一篇工具手册，而是一次对 Prometheus 设计智慧的深度探讨。当你理解了这套设计哲学，你就能理解为什么 Prometheus 能用如此简单的模型，看透复杂系统的本质。</p>
<hr/>
<h2 data-id="heading-0">目录</h2>
<ol>
<li><a href="#1-%E8%AE%BE%E8%AE%A1%E5%93%B2%E5%AD%A6%E7%AE%80%E5%8D%95%E4%BC%98%E5%85%88%E7%9A%84%E4%B8%89%E4%B8%AA%E4%BD%93%E7%8E%B0" title="#1-%E8%AE%BE%E8%AE%A1%E5%93%B2%E5%AD%A6%E7%AE%80%E5%8D%95%E4%BC%98%E5%85%88%E7%9A%84%E4%B8%89%E4%B8%AA%E4%BD%93%E7%8E%B0">设计哲学：简单优先的三个体现</a></li>
<li><a href="#2-%E5%9B%9B%E7%A7%8D%E6%8C%87%E6%A0%87%E7%94%A8%E6%9C%80%E5%B0%91%E7%9A%84%E7%B1%BB%E5%9E%8B%E6%8F%8F%E8%BF%B0%E6%9C%80%E5%A4%9A%E7%9A%84%E5%9C%BA%E6%99%AF" title="#2-%E5%9B%9B%E7%A7%8D%E6%8C%87%E6%A0%87%E7%94%A8%E6%9C%80%E5%B0%91%E7%9A%84%E7%B1%BB%E5%9E%8B%E6%8F%8F%E8%BF%B0%E6%9C%80%E5%A4%9A%E7%9A%84%E5%9C%BA%E6%99%AF">四种指标：用最少的类型描述最多的场景</a></li>
<li><a href="#3-histogram%E5%A6%82%E4%BD%95%E4%BC%98%E9%9B%85%E5%9C%B0%E5%A4%84%E7%90%86%E5%88%86%E5%B8%83%E9%97%AE%E9%A2%98" title="#3-histogram%E5%A6%82%E4%BD%95%E4%BC%98%E9%9B%85%E5%9C%B0%E5%A4%84%E7%90%86%E5%88%86%E5%B8%83%E9%97%AE%E9%A2%98">Histogram：如何优雅地处理分布问题</a></li>
<li><a href="#4-%E6%98%93%E6%B7%B7%E6%B7%86%E6%A6%82%E5%BF%B5%E7%BB%86%E8%8A%82%E4%B8%AD%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%99%BA%E6%85%A7" title="#4-%E6%98%93%E6%B7%B7%E6%B7%86%E6%A6%82%E5%BF%B5%E7%BB%86%E8%8A%82%E4%B8%AD%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%99%BA%E6%85%A7">易混淆概念：细节中的设计智慧</a></li>
<li><a href="#5-%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5%E7%90%86%E8%AE%BA%E5%88%B0%E8%90%BD%E5%9C%B0%E7%9A%84%E6%9C%80%E5%90%8E%E4%B8%80%E5%85%AC%E9%87%8C" title="#5-%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5%E7%90%86%E8%AE%BA%E5%88%B0%E8%90%BD%E5%9C%B0%E7%9A%84%E6%9C%80%E5%90%8E%E4%B8%80%E5%85%AC%E9%87%8C">生产实践：理论到落地的最后一公里</a></li>
<li><a href="#6-%E4%B8%8B%E4%B8%80%E6%AD%A5%E4%BB%8E%E7%90%86%E8%A7%A3%E5%88%B0%E5%AE%9E%E8%B7%B5" title="#6-%E4%B8%8B%E4%B8%80%E6%AD%A5%E4%BB%8E%E7%90%86%E8%A7%A3%E5%88%B0%E5%AE%9E%E8%B7%B5">下一步：从理解到实践</a></li>
</ol>
<hr/>
<h2 data-id="heading-1">1. 设计哲学：简单优先的三个体现</h2>
<p>Prometheus 的设计哲学可以用一句话概括：<strong>用最简单的方式解决问题</strong>。</p>
<p>这个哲学在三个关键设计上体现得淋漓尽致。</p>
<h3 data-id="heading-2">1.1 时间序列的本质</h3>
<p>Prometheus 是一个时间序列数据库（TSDB）。理解它的第一步，是理解什么是时间序列。</p>
<p><strong>时间序列的定义</strong></p>
<p>时间序列就是"数值随时间变化的记录"。更准确地说，它是一个三元组：</p>
<pre><code class="hljs language-scss" lang="scss">(指标名, 标签集合, 时间点) → 数值
</code></pre>
<p>当你访问 Exporter 的 <code>/metrics</code> 端点时，看到的是这样的文本：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># HELP http_requests_total 总HTTP请求数</span>
<span class="hljs-comment"># TYPE http_requests_total counter</span>
http_requests_total{<span class="hljs-attr">method</span>=<span class="hljs-string">"GET"</span>, status=<span class="hljs-string">"200"</span>} <span class="hljs-number">1234</span>
http_requests_total{<span class="hljs-attr">method</span>=<span class="hljs-string">"POST"</span>, status=<span class="hljs-string">"200"</span>} <span class="hljs-number">567</span>
http_requests_total{<span class="hljs-attr">method</span>=<span class="hljs-string">"GET"</span>, status=<span class="hljs-string">"404"</span>} <span class="hljs-number">42</span>
</code></pre>
<p>每一行都是一个"数据点"，但这里有个问题：<strong>时间戳在哪？</strong></p>
<p><strong>时间戳由谁添加？</strong></p>
<p>答案是：<strong>Prometheus 在抓取时添加时间戳</strong>。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[Exporter 暴露当前值] --&gt; B[Prometheus 抓取并记录时间]
    B --&gt; C[存储为时间序列]
    
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#ffe1f5
</code></pre>
<p>流程是这样的：</p>
<ol>
<li><strong>Exporter 暴露指标</strong>：只说"现在的值是 1234"</li>
<li><strong>Prometheus 定时抓取</strong>（默认 15 秒一次）：记录"我在 2024-12-29 10:00:00 抓到的值是 1234"</li>
<li><strong>存储到 TSDB</strong>：形成时间序列</li>
</ol>
<p><strong>为什么这样设计？</strong></p>
<p>这个设计看似简单，但很巧妙：</p>

























<table><thead><tr><th>如果由 Exporter 提供时间戳</th><th>如果由 Prometheus 添加时间戳</th></tr></thead><tbody><tr><td>100 个 Exporter，100 个时钟</td><td>1 个 Prometheus，1 个时钟</td></tr><tr><td>时钟可能不同步</td><td>时钟统一</td></tr><tr><td>Exporter 需要管理时间戳</td><td>Exporter 无状态，简单</td></tr><tr><td>时间戳可能错误</td><td>时间戳可靠</td></tr></tbody></table>
<p>这是 Prometheus "简单优先" 设计哲学的第一个体现：<strong>让 Exporter 尽可能简单，复杂的事情由 Prometheus 来做</strong>。</p>
<h3 data-id="heading-3">1.2 "类型"只是约定，不是强制</h3>
<p>看看 <code>/metrics</code> 输出的第二行：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># TYPE http_requests_total counter</span>
</code></pre>
<p>这里声明了 <code>http_requests_total</code> 是一个 <code>counter</code> 类型。那么问题来了：<strong>Prometheus 真的在乎这个类型声明吗？</strong></p>
<p>答案是：<strong>不在乎</strong>。</p>
<p><strong>客户端、传输、存储三个视角</strong></p>
<p>让我们从三个层面看"类型"：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
    A[客户端层 有类型约束] --&gt; B[传输层 TYPE只是注释]
    B --&gt; C[存储层 无类型只有数字]
    
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#ffe1f5
</code></pre>
<p><strong>1. 客户端层（有类型）</strong></p>
<p>在代码里，你用官方库定义指标时，类型是有意义的：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Go 代码示例</span>
counter := prometheus.NewCounter(...)  <span class="hljs-comment">// Counter 类型</span>
counter.Inc()   <span class="hljs-comment">// 只能增加，不能减少</span>
counter.Dec()   <span class="hljs-comment">// 编译错误！Counter 没有 Dec() 方法</span>

gauge := prometheus.NewGauge(...)     <span class="hljs-comment">// Gauge 类型</span>
gauge.Set(<span class="hljs-number">42</span>)   <span class="hljs-comment">// 可以随意设置</span>
gauge.Inc()     <span class="hljs-comment">// 也可以增加</span>
gauge.Dec()     <span class="hljs-comment">// 也可以减少</span>
</code></pre>
<p>客户端库通过 API 的设计来"强制"类型约束。</p>
<p><strong>2. 传输层（类型是注释）</strong></p>
<p>但到了 <code>/metrics</code> 输出，类型就只是一行注释：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># TYPE my_counter counter    ← 这只是给人看的注释</span>
my_counter 100
my_counter 50                 ← Prometheus 不会因为 Counter 减少而报错
</code></pre>
<p><strong>3. 存储层（无类型）</strong></p>
<p>到了 Prometheus 的存储层，所有指标都是"时间序列"：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">my_counter</span>{} 
  <span class="hljs-variable">@1735462800</span> → <span class="hljs-number">100</span>
  <span class="hljs-variable">@1735462815</span> → <span class="hljs-number">50</span>
  <span class="hljs-variable">@1735462830</span> → <span class="hljs-number">75</span>
</code></pre>
<p>Prometheus 看到的就是"一串数字随时间变化"，它不知道也不在乎这个指标声明的类型是什么。</p>
<p><strong>为什么这样设计？</strong></p>
<p>这又是 Prometheus "简单优先" 的体现：</p>
<ul>
<li><strong>存储引擎简单</strong>：不需要复杂的类型系统，只需要存 (timestamp, value) 对</li>
<li><strong>查询灵活</strong>：你可以对任何指标用任何函数（虽然可能没意义）</li>
<li><strong>性能更好</strong>：不需要在查询时检查类型兼容性</li>
<li><strong>向后兼容</strong>：后续添加新类型不影响存储层</li>
</ul>
<p><strong>那类型有什么用？</strong></p>
<p>类型的作用在于<strong>约定</strong>和<strong>文档</strong>：</p>
<ol>
<li><strong>帮助你选择正确的 API</strong>（客户端层）</li>
<li><strong>帮助你选择正确的函数</strong>（比如 Counter 用 <code>rate()</code>，Gauge 用 <code>delta()</code>）</li>
<li><strong>帮助工具理解指标</strong>（比如 Grafana 可以根据类型提供不同的可视化选项）</li>
</ol>
<p>但这一切都是"软约束"，不是"硬限制"。</p>
<h3 data-id="heading-4">1.3 Counter 可以重置：为什么允许？</h3>
<p>这是 Prometheus 设计哲学中最容易引起困惑的一点。</p>
<p><strong>一个真实的场景</strong></p>
<p>你的应用运行在 Kubernetes 上，有个 Counter 指标 <code>http_requests_total</code>：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">10:00:00 → 1000</span>
<span class="hljs-section">10:01:00 → 1500</span>
<span class="hljs-section">10:02:00 → Pod 重启了</span>
<span class="hljs-section">10:02:15 → 0        ← Counter 重置为 0</span>
<span class="hljs-section">10:03:00 → 50</span>
</code></pre>
<p>这时候，有人可能会问：<strong>为什么不把 Counter 持久化，重启后继续累加？</strong></p>
<p>比如可以这样设计：</p>
<pre><code class="hljs language-ini" lang="ini">Pod 重启前：<span class="hljs-attr">http_requests_total</span> = <span class="hljs-number">1500</span>
写入磁盘：1500
Pod 重启后：从磁盘读取 1500
继续累加：<span class="hljs-attr">http_requests_total</span> = <span class="hljs-number">1500</span> + 新请求数
</code></pre>
<p><strong>为什么 Prometheus 不这么做？</strong></p>
<p>让我们对比两种方案：</p>






























<table><thead><tr><th>方案</th><th>持久化 Counter</th><th>允许重置</th></tr></thead><tbody><tr><td><strong>Exporter 复杂度</strong></td><td>需要文件/数据库存储</td><td>无状态，简单</td></tr><tr><td><strong>容器友好性</strong></td><td>需要挂载持久化存储</td><td>容器可以随意销毁重建</td></tr><tr><td><strong>故障处理</strong></td><td>文件损坏？并发冲突？</td><td>没有状态，没有故障</td></tr><tr><td><strong>监控目的</strong></td><td>精确累积值</td><td>速率和趋势</td></tr></tbody></table>
<p>Prometheus 的选择是：<strong>允许重置，专注于速率</strong>。</p>
<p>这个选择背后的哲学是：</p>
<blockquote>
<p>"Prometheus is designed for operational monitoring, not for billing or accounting."</p>
</blockquote>
<p>翻译一下：</p>
<p><strong>Prometheus 是为运维监控而设计的，不是为计费或会计核算而设计的。</strong></p>
<p><strong>监控 vs 计费的区别</strong></p>





















<table><thead><tr><th>监控关心的问题</th><th>计费关心的问题</th></tr></thead><tbody><tr><td>现在请求速率是多少？</td><td>总共处理了多少个请求？</td></tr><tr><td>错误率是否在上升？</td><td>总共有多少个错误？</td></tr><tr><td>系统是否健康？</td><td>用户应该付多少钱？</td></tr></tbody></table>
<p>监控只需要知道：</p>
<ul>
<li>每秒处理多少请求（速率）</li>
<li>速率是否异常（告警）</li>
<li>趋势是上升还是下降</li>
</ul>
<p><strong>不需要知道</strong>：</p>
<ul>
<li>从系统上线到现在总共处理了 1,234,567,890 个请求</li>
</ul>
<p>后者应该由数据库事务、日志系统、或专门的计费系统来保证。</p>
<p><strong>rate() 如何处理重置</strong></p>
<p>Prometheus 的 <code>rate()</code> 函数会自动检测 Counter 重置：</p>
<pre><code class="hljs language-promql" lang="promql">rate(http_requests_total[5m])
</code></pre>
<p>原理很简单：</p>
<ol>
<li><strong>检测重置</strong>：如果当前值 &lt; 上一个值，认为发生了重置</li>
<li><strong>调整计算</strong>：只用重置后的数据计算速率</li>
<li><strong>继续正常</strong>：下一个周期正常计算</li>
</ol>
<p>举例：</p>
<pre><code class="hljs language-ini" lang="ini">时间    值     rate() 计算
10:00   1000   
10:01   1500   (1500-1000)/<span class="hljs-attr">60</span> = <span class="hljs-number">8.33</span>/s
10:02   0      检测到重置，跳过
10:03   50     (50-0)/<span class="hljs-attr">60</span> = <span class="hljs-number">0.83</span>/s
10:04   120    (120-50)/<span class="hljs-attr">60</span> = <span class="hljs-number">1.16</span>/s
</code></pre>
<p>所以即使 Counter 重置，<code>rate()</code> 依然能给出正确的速率。</p>
<p><strong>总结这一节</strong></p>
<p>Prometheus 允许 Counter 重置，是因为：</p>
<ol>
<li><strong>简化 Exporter 设计</strong>：无状态更简单、更可靠</li>
<li><strong>适应云原生</strong>：容器随时重启是常态</li>
<li><strong>专注监控本质</strong>：关心速率和趋势，不关心精确累积值</li>
<li><strong>rate() 能处理</strong>：自动检测和调整</li>
</ol>
<p>这就是 Prometheus 的第一个设计智慧：<strong>牺牲一点"精确性"，换取"简单性"和"可靠性"</strong>。</p>
<p>这个取舍背后的深层思考是：监控系统的价值不在于"记录了多少数字"，而在于"能否及时发现问题"。只要速率和趋势是对的，绝对累积值不那么重要。</p>
<hr/>
<h2 data-id="heading-5">2. 四种指标：用最少的类型描述最多的场景</h2>
<p>如果让你设计一套指标类型，你会设计几种？</p>
<p>可能会想：HTTP 请求一种、数据库查询一种、内存使用一种、CPU 使用一种...很快就会有几十种类型。</p>
<p>但 Prometheus 只用四种：Counter、Gauge、Histogram、Summary。</p>
<p>这是如何做到的？答案是：<strong>抓住本质，而不是现象</strong>。</p>
<ul>
<li>Counter 的本质：只增不减的累积</li>
<li>Gauge 的本质：可增可减的状态</li>
<li>Histogram 的本质：分布统计</li>
<li>Summary 的本质：预计算</li>
</ul>
<p>只要理解了本质，一个 Counter 就能描述所有"累积"的场景。</p>
<h3 data-id="heading-6">2.1 Counter（计数器）</h3>
<p><strong>定义</strong></p>
<p>Counter 是单调递增的计数器，只增不减（除非重置）。</p>
<p><strong>典型场景</strong></p>
<p>回答"发生了多少次"的问题：</p>
<pre><code class="hljs language-ini" lang="ini">真实场景：API 服务

http_requests_total{<span class="hljs-attr">method</span>=<span class="hljs-string">"GET"</span>, path=<span class="hljs-string">"/api/users"</span>, status=<span class="hljs-string">"200"</span>} <span class="hljs-number">15234</span>
http_requests_total{<span class="hljs-attr">method</span>=<span class="hljs-string">"GET"</span>, path=<span class="hljs-string">"/api/users"</span>, status=<span class="hljs-string">"404"</span>} <span class="hljs-number">42</span>
http_requests_total{<span class="hljs-attr">method</span>=<span class="hljs-string">"POST"</span>, path=<span class="hljs-string">"/api/users"</span>, status=<span class="hljs-string">"200"</span>} <span class="hljs-number">8901</span>
http_requests_total{<span class="hljs-attr">method</span>=<span class="hljs-string">"POST"</span>, path=<span class="hljs-string">"/api/users"</span>, status=<span class="hljs-string">"400"</span>} <span class="hljs-number">156</span>

error_log_total{<span class="hljs-attr">level</span>=<span class="hljs-string">"error"</span>, service=<span class="hljs-string">"user-service"</span>} <span class="hljs-number">234</span>
error_log_total{<span class="hljs-attr">level</span>=<span class="hljs-string">"error"</span>, service=<span class="hljs-string">"order-service"</span>} <span class="hljs-number">89</span>

db_queries_total{<span class="hljs-attr">database</span>=<span class="hljs-string">"mysql"</span>, operation=<span class="hljs-string">"select"</span>} <span class="hljs-number">89234</span>
db_queries_total{<span class="hljs-attr">database</span>=<span class="hljs-string">"mysql"</span>, operation=<span class="hljs-string">"insert"</span>} <span class="hljs-number">12456</span>
</code></pre>
<p>注意几个设计细节：</p>
<ol>
<li><strong>命名后缀 <code>_total</code></strong>：这是约定俗成的规范，表示"总数"</li>
<li><strong>标签选择</strong>：<code>method</code>、<code>path</code>、<code>status</code> 是低基数的标签，不会无限增长</li>
<li><strong>不要用高基数标签</strong>：比如不要用 <code>user_id</code>、<code>request_id</code></li>
</ol>
<p><strong>常用函数</strong></p>
<p><strong>1. rate() - 计算每秒速率</strong></p>
<pre><code class="hljs language-promql" lang="promql"># 过去 5 分钟的平均每秒请求速率
rate(http_requests_total[5m])

# 结果示例
http_requests_total{method="GET", path="/api/users"} 150.5
→ 表示过去 5 分钟，这个接口平均每秒处理 150.5 个请求
</code></pre>
<p>为什么几乎总是用 <code>rate()</code>？因为 Counter 的原始值（比如 15234）没什么意义，你关心的是"现在每秒多少个请求"。</p>
<p><strong>2. increase() - 计算时间窗口内的增量</strong></p>
<pre><code class="hljs language-promql" lang="promql"># 过去 1 小时增加了多少个请求
increase(http_requests_total[1h])

# 结果示例
http_requests_total{method="GET"} 540000
→ 过去 1 小时，增加了 54 万个请求
</code></pre>
<p>注意 <code>increase()</code> 和 <code>rate()</code> 的关系：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">increase</span>(metric[<span class="hljs-number">1</span>h]) = <span class="hljs-built_in">rate</span>(metric[<span class="hljs-number">1</span>h]) × <span class="hljs-number">3600</span>
</code></pre>
<p><strong>3. topk() - 找出前 N 名</strong></p>
<pre><code class="hljs language-promql" lang="promql"># 找出请求量最大的前 10 个接口
topk(10, rate(http_requests_total[5m]))

# 找出错误最多的前 5 个服务
topk(5, increase(error_log_total[1h]))
</code></pre>
<p><strong>实战技巧</strong></p>
<p><strong>错误示例 1：直接用 Counter 的原始值</strong></p>
<pre><code class="hljs language-promql" lang="promql"># 错误：直接看 Counter 的值没什么意义
http_requests_total &gt; 10000

# 正确：看速率是否过高
rate(http_requests_total[5m]) &gt; 100
</code></pre>
<p><strong>错误示例 2：时间窗口太短</strong></p>
<pre><code class="hljs language-promql" lang="promql"># 问题：1 分钟窗口太短，容易受瞬时波动影响
rate(http_requests_total[1m])

# 建议：至少用 5 分钟窗口
rate(http_requests_total[5m])
</code></pre>
<p><strong>错误示例 3：在高基数标签上使用 Counter</strong></p>
<pre><code class="hljs language-promql" lang="promql"># 错误：user_id 有百万级别，会产生百万条时间序列
http_requests_total{user_id="123456"}

# 正确：只按服务和接口聚合
http_requests_total{service="api", path="/users"}
</code></pre>
<p><strong>Counter 的设计智慧</strong></p>
<p>Counter 的设计看似简单（只增不减），但蕴含着深刻的智慧：</p>
<ol>
<li><strong>专注本质</strong>：监控关心"现在怎么样"（速率），不关心"总共多少"（累积值）</li>
<li><strong>容忍重置</strong>：牺牲绝对精确，换取系统简单和可靠</li>
<li><strong>配合 rate()</strong>：设计了配套函数来处理重置，让用户无感知</li>
</ol>
<p>这就是"简单模型看透复杂系统"的第一个例子：一个只增不减的计数器，配合一个 rate() 函数，就能描述世间所有"事件累积"的场景。</p>
<h3 data-id="heading-7">2.2 Gauge（仪表盘）</h3>
<p><strong>定义</strong></p>
<p>Gauge 是可以任意增减的指标，反映"当前状态"。</p>
<p><strong>典型场景</strong></p>
<p>回答"现在是多少"的问题：</p>
<pre><code class="hljs language-ini" lang="ini">真实场景：服务器监控

node_memory_MemAvailable_bytes{<span class="hljs-attr">instance</span>=<span class="hljs-string">"server-01"</span>} <span class="hljs-number">8589934592</span>
node_cpu_usage_percent{<span class="hljs-attr">instance</span>=<span class="hljs-string">"server-01"</span>, cpu=<span class="hljs-string">"0"</span>} <span class="hljs-number">45.2</span>
node_filesystem_free_bytes{<span class="hljs-attr">instance</span>=<span class="hljs-string">"server-01"</span>, mountpoint=<span class="hljs-string">"/"</span>} <span class="hljs-number">107374182400</span>

真实场景：应用监控

current_connections{<span class="hljs-attr">service</span>=<span class="hljs-string">"database"</span>, pool=<span class="hljs-string">"main"</span>} <span class="hljs-number">45</span>
current_connections{<span class="hljs-attr">service</span>=<span class="hljs-string">"database"</span>, pool=<span class="hljs-string">"readonly"</span>} <span class="hljs-number">12</span>
queue_length{<span class="hljs-attr">service</span>=<span class="hljs-string">"message-queue"</span>, queue=<span class="hljs-string">"orders"</span>} <span class="hljs-number">156</span>
goroutine_count{<span class="hljs-attr">service</span>=<span class="hljs-string">"api-server"</span>} <span class="hljs-number">234</span>

真实场景：业务监控

current_online_users{<span class="hljs-attr">region</span>=<span class="hljs-string">"asia"</span>} <span class="hljs-number">15234</span>
current_online_users{<span class="hljs-attr">region</span>=<span class="hljs-string">"europe"</span>} <span class="hljs-number">8901</span>
inventory_count{<span class="hljs-attr">product</span>=<span class="hljs-string">"iphone-15"</span>, warehouse=<span class="hljs-string">"shanghai"</span>} <span class="hljs-number">450</span>
</code></pre>
<p><strong>Gauge vs Counter 的选择</strong></p>
<p>这是个常见的困惑。怎么判断用哪个？</p>








































<table><thead><tr><th>问题</th><th>类型</th><th>原因</th></tr></thead><tbody><tr><td>总共处理了多少请求？</td><td>Counter</td><td>只增不减</td></tr><tr><td>现在有多少活跃连接？</td><td>Gauge</td><td>可增可减</td></tr><tr><td>总共发生了多少错误？</td><td>Counter</td><td>只增不减</td></tr><tr><td>现在队列里有多少任务？</td><td>Gauge</td><td>可增可减</td></tr><tr><td>CPU 时间累计多少秒？</td><td>Counter</td><td>时间累积，只增不减</td></tr><tr><td>CPU 使用率是多少？</td><td>Gauge</td><td>百分比，可增可减</td></tr></tbody></table>
<p>简单规则：</p>
<ul>
<li><strong>累积的、永远增长的</strong> → Counter</li>
<li><strong>当前的、可上可下的</strong> → Gauge</li>
</ul>
<p><strong>常用函数</strong></p>
<p><strong>1. 直接查询当前值</strong></p>
<pre><code class="hljs language-promql" lang="promql"># 看当前内存使用
node_memory_MemAvailable_bytes

# 看当前连接数
current_connections
</code></pre>
<p><strong>2. delta() - 计算变化量</strong></p>
<pre><code class="hljs language-promql" lang="promql"># CPU 温度在过去 2 小时的变化
delta(cpu_temp_celsius{host="server-01"}[2h])

# 内存使用在过去 1 小时的变化
delta(node_memory_usage_bytes[1h])
</code></pre>
<p><strong>3. avg_over_time() - 计算平均值</strong></p>
<pre><code class="hljs language-promql" lang="promql"># 过去 5 分钟的平均 CPU 使用率
avg_over_time(node_cpu_usage_percent[5m])

# 过去 1 小时的平均队列长度
avg_over_time(queue_length[1h])
</code></pre>
<p><strong>4. predict_linear() - 预测未来</strong></p>
<p>这是个很强大的函数：</p>
<pre><code class="hljs language-promql" lang="promql"># 基于过去 1 小时的数据，预测 4 小时后磁盘剩余空间
predict_linear(node_filesystem_free_bytes[1h], 4*3600)

# 如果预测值 &lt; 0，说明磁盘会满
predict_linear(node_filesystem_free_bytes[1h], 4*3600) &lt; 0
</code></pre>
<p>原理是简单线性回归：</p>
<ol>
<li>看过去 1 小时的趋势</li>
<li>假设趋势延续</li>
<li>推算 4 小时后的值</li>
</ol>
<p><strong>实战技巧</strong></p>
<p><strong>技巧 1：Gauge 可以用 rate()，但要理解含义</strong></p>
<pre><code class="hljs language-promql" lang="promql"># 对 Gauge 用 rate() 是可以的
rate(queue_length[5m])

# 但含义是：队列长度的变化速率
# 如果结果是正数：队列在增长
# 如果结果是负数：队列在减少
</code></pre>
<p><strong>技巧 2：内存"可用"vs"空闲"</strong></p>
<pre><code class="hljs language-promql" lang="promql"># 错误：MemFree 不是真正可用的内存
node_memory_MemFree_bytes

# 正确：MemAvailable 才是真正可用的
node_memory_MemAvailable_bytes

# 原因：Linux 会用空闲内存做 cache/buffer
# MemFree 只是完全未使用的
# MemAvailable = Free + 可回收的 cache
</code></pre>
<p><strong>技巧 3：计算百分比</strong></p>
<pre><code class="hljs language-promql" lang="promql"># 内存使用率
(1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100

# 磁盘使用率
(1 - node_filesystem_avail_bytes / node_filesystem_size_bytes) * 100
</code></pre>
<p><strong>Gauge 的设计智慧</strong></p>
<p>Gauge 的本质是"快照"：它记录的是某一时刻的状态。</p>
<p>这个设计的精妙之处在于：</p>
<ol>
<li><strong>不关心历史</strong>：只告诉你"现在是多少"，过去的事情不重要</li>
<li><strong>可增可减</strong>：真实反映系统状态的变化</li>
<li><strong>天然支持预测</strong>：用 predict_linear() 可以基于趋势预测未来</li>
</ol>
<p>这是"简单模型"的第二个例子：一个可以任意设置的数值，就能描述所有"当前状态"的场景。没有复杂的状态机，没有历史追踪，简单而直接。</p>
<h3 data-id="heading-8">2.3 Histogram（直方图）</h3>
<p><strong>为什么需要 Histogram</strong></p>
<p>先看一个问题。</p>
<p>假设你的 API 平均响应时间是 100ms。那系统是否健康？</p>
<p><strong>不知道</strong>。因为平均值会掩盖问题：</p>
<pre><code class="hljs language-shell" lang="shell">场景 1：所有请求都是 100ms
→ 平均值 100ms，系统很稳定

场景 2：
<span class="hljs-meta prompt_">90% </span><span class="bash">的请求是 10ms</span>
<span class="hljs-meta prompt_">10% </span><span class="bash">的请求是 910ms</span>
→ 平均值还是 100ms，但有严重的长尾问题！
</code></pre>
<p>这就是著名的"平均值谎言"。你需要知道<strong>分布</strong>：</p>
<ul>
<li>有多少请求在 50ms 内？</li>
<li>有多少请求在 100ms 内？</li>
<li>有多少请求在 500ms 内？</li>
<li>有多少请求超过 1 秒？</li>
</ul>
<p>Histogram 就是来解决这个问题的。</p>
<p><strong>Histogram 的结构</strong></p>
<p>一个 Histogram 指标会生成多条时间序列：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># TYPE http_request_duration_seconds histogram</span>

http_request_duration_seconds_bucket{<span class="hljs-attr">le</span>=<span class="hljs-string">"0.005"</span>} <span class="hljs-number">0</span>
http_request_duration_seconds_bucket{<span class="hljs-attr">le</span>=<span class="hljs-string">"0.01"</span>} <span class="hljs-number">0</span>
http_request_duration_seconds_bucket{<span class="hljs-attr">le</span>=<span class="hljs-string">"0.025"</span>} <span class="hljs-number">0</span>
http_request_duration_seconds_bucket{<span class="hljs-attr">le</span>=<span class="hljs-string">"0.05"</span>} <span class="hljs-number">50</span>
http_request_duration_seconds_bucket{<span class="hljs-attr">le</span>=<span class="hljs-string">"0.1"</span>} <span class="hljs-number">150</span>
http_request_duration_seconds_bucket{<span class="hljs-attr">le</span>=<span class="hljs-string">"0.25"</span>} <span class="hljs-number">180</span>
http_request_duration_seconds_bucket{<span class="hljs-attr">le</span>=<span class="hljs-string">"0.5"</span>} <span class="hljs-number">195</span>
http_request_duration_seconds_bucket{<span class="hljs-attr">le</span>=<span class="hljs-string">"1"</span>} <span class="hljs-number">198</span>
http_request_duration_seconds_bucket{<span class="hljs-attr">le</span>=<span class="hljs-string">"2.5"</span>} <span class="hljs-number">200</span>
http_request_duration_seconds_bucket{<span class="hljs-attr">le</span>=<span class="hljs-string">"5"</span>} <span class="hljs-number">200</span>
http_request_duration_seconds_bucket{<span class="hljs-attr">le</span>=<span class="hljs-string">"+Inf"</span>} <span class="hljs-number">200</span>

http_request_duration_seconds_sum 45.67
http_request_duration_seconds_count 200
</code></pre>
<p>分解一下：</p>
<ol>
<li><strong>多个 <code>_bucket</code></strong>：每个 bucket 是一个 Counter，记录"≤ 某个值"的请求数</li>
<li><strong><code>_sum</code></strong>：所有请求的耗时总和（Counter）</li>
<li><strong><code>_count</code></strong>：总请求数（Counter）</li>
</ol>
<p><strong>两个关键理解</strong></p>
<p><strong>理解 1：bucket 是累积的</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">le</span>=<span class="hljs-string">"0.05"</span> → <span class="hljs-number">50</span>   表示：≤ <span class="hljs-number">0.05</span> 秒的请求有 <span class="hljs-number">50</span> 个
<span class="hljs-attr">le</span>=<span class="hljs-string">"0.1"</span>  → <span class="hljs-number">150</span>  表示：≤ <span class="hljs-number">0.1</span> 秒的请求有 <span class="hljs-number">150</span> 个（包含前面的 <span class="hljs-number">50</span> 个）
<span class="hljs-attr">le</span>=<span class="hljs-string">"0.5"</span>  → <span class="hljs-number">195</span>  表示：≤ <span class="hljs-number">0.5</span> 秒的请求有 <span class="hljs-number">195</span> 个（包含前面的 <span class="hljs-number">150</span> 个）
</code></pre>
<p>所以：</p>
<ul>
<li>0.05 ~ 0.1 秒之间的请求数 = 150 - 50 = 100 个</li>
<li>0.1 ~ 0.5 秒之间的请求数 = 195 - 150 = 45 个</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[&amp;#34;le=0.05 有50个&amp;#34;] --&gt; B[&amp;#34;le=0.1 有150个 包含前面50个&amp;#34;]
    B --&gt; C[&amp;#34;le=0.5 有195个 包含前面150个&amp;#34;]
    
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#ffe1f5
</code></pre>
<p><strong>理解 2：不存原始数据，存区间统计</strong></p>
<p>Histogram 不会存每个请求的准确耗时：</p>
<pre><code class="hljs language-makefile" lang="makefile">不是这样存：
<span class="hljs-section">request_1: 0.234 秒</span>
<span class="hljs-section">request_2: 0.156 秒</span>
<span class="hljs-section">request_3: 0.089 秒</span>
...

而是这样存：
≤ 0.05 秒: 50 个
≤ 0.1 秒: 150 个
≤ 0.5 秒: 195 个
...
</code></pre>
<p><strong>用两个类比理解</strong></p>
<p><strong>类比 1：存的是等第，不是分数</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">不存每个学生的分数：</span>
<span class="hljs-string">学生</span> <span class="hljs-attr">A:</span> <span class="hljs-number">95</span> <span class="hljs-string">分</span>
<span class="hljs-string">学生</span> <span class="hljs-attr">B:</span> <span class="hljs-number">88</span> <span class="hljs-string">分</span>
<span class="hljs-string">学生</span> <span class="hljs-attr">C:</span> <span class="hljs-number">76</span> <span class="hljs-string">分</span>
<span class="hljs-string">...</span> <span class="hljs-string">（1000</span> <span class="hljs-string">个学生）</span>

<span class="hljs-string">而是存分数段统计：</span>
<span class="hljs-string">≥</span> <span class="hljs-number">90</span> <span class="hljs-string">分（A</span> <span class="hljs-string">等）:</span> <span class="hljs-number">150</span> <span class="hljs-string">人</span>
<span class="hljs-string">≥</span> <span class="hljs-number">80</span> <span class="hljs-string">分（B</span> <span class="hljs-string">等）:</span> <span class="hljs-number">400</span> <span class="hljs-string">人（包含</span> <span class="hljs-string">A</span> <span class="hljs-string">等）</span>
<span class="hljs-string">≥</span> <span class="hljs-number">70</span> <span class="hljs-string">分（C</span> <span class="hljs-string">等）:</span> <span class="hljs-number">700</span> <span class="hljs-string">人（包含</span> <span class="hljs-string">A+B</span> <span class="hljs-string">等）</span>
<span class="hljs-string">≥</span> <span class="hljs-number">60</span> <span class="hljs-string">分（D</span> <span class="hljs-string">等）:</span> <span class="hljs-number">950</span> <span class="hljs-string">人</span>
<span class="hljs-string">所有人:</span> <span class="hljs-number">1000</span> <span class="hljs-string">人</span>
</code></pre>
<p>这样：</p>
<ul>
<li>存储量从 1000 条记录 → 5 条记录</li>
<li>牺牲了精确度（不知道具体分数）</li>
<li>保留了分布信息（知道有多少人在各个分数段）</li>
</ul>
<p><strong>类比 2：数据库的 GROUP BY 聚合</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 不是存每条订单明细</span>
<span class="hljs-keyword">SELECT</span> order_id, amount <span class="hljs-keyword">FROM</span> orders;  <span class="hljs-comment">-- 100 万行</span>

<span class="hljs-comment">-- 而是存金额区间统计</span>
<span class="hljs-keyword">SELECT</span> 
  <span class="hljs-keyword">CASE</span> 
    <span class="hljs-keyword">WHEN</span> amount <span class="hljs-operator">&lt;=</span> <span class="hljs-number">100</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'0-100'</span>
    <span class="hljs-keyword">WHEN</span> amount <span class="hljs-operator">&lt;=</span> <span class="hljs-number">500</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'100-500'</span>
    <span class="hljs-keyword">WHEN</span> amount <span class="hljs-operator">&lt;=</span> <span class="hljs-number">1000</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'500-1000'</span>
  <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">range</span>,
  <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">AS</span> count
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">range</span>;  <span class="hljs-comment">-- 只有几行</span>
</code></pre>
<p>Histogram 就像是提前做好的 GROUP BY 聚合。</p>
<p><strong>常用函数</strong></p>
<p><strong>histogram_quantile() - 计算分位数</strong></p>
<pre><code class="hljs language-promql" lang="promql"># 计算 P95（95 分位数）
histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))

# 计算 P99
histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m]))

# 计算 P50（中位数）
histogram_quantile(0.5, rate(http_request_duration_seconds_bucket[5m]))
</code></pre>
<p>分位数的含义：</p>
<ul>
<li>P95 = 0.8 秒 → 95% 的请求在 0.8 秒内完成</li>
<li>P99 = 1.5 秒 → 99% 的请求在 1.5 秒内完成</li>
</ul>
<p><strong>为什么必须配合 rate()？</strong></p>
<p>因为 <code>_bucket</code> 是 Counter（累积的），你需要转成速率：</p>
<pre><code class="hljs language-promql" lang="promql"># 错误：直接用 bucket
histogram_quantile(0.95, http_request_duration_seconds_bucket)
# 这会基于"总累积值"计算，结果是错的

# 正确：先 rate() 再计算分位数
histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))
# 这是基于"过去 5 分钟的速率"计算，结果才对
</code></pre>
<p><strong>计算平均响应时间</strong></p>
<pre><code class="hljs language-promql" lang="promql"># 用 sum 和 count 计算平均值
rate(http_request_duration_seconds_sum[5m])
/
rate(http_request_duration_seconds_count[5m])
</code></pre>
<p><strong>实战案例</strong></p>
<p>假设你的 API 监控显示：</p>
<pre><code class="hljs language-promql" lang="promql"># 平均响应时间
avg = 150ms

# P95
histogram_quantile(0.95, ...) = 200ms

# P99
histogram_quantile(0.99, ...) = 2000ms  ← 注意这里！
</code></pre>
<p>分析：</p>
<ul>
<li>平均 150ms 看起来不错</li>
<li>P95 200ms 也还行</li>
<li>但 P99 2000ms 说明有严重的长尾问题</li>
</ul>
<p>可能的原因：</p>
<ul>
<li>某些请求触发了慢查询</li>
<li>某些请求有 GC 停顿</li>
<li>某些请求等待外部服务超时</li>
</ul>
<p>这就是 Histogram 的价值：<strong>让长尾问题无所遁形</strong>。</p>
<p><strong>Histogram 的设计智慧</strong></p>
<p>Histogram 是四种类型中最复杂的，但也是设计最精妙的：</p>
<ol>
<li>
<p><strong>牺牲精确，换取效率</strong></p>
<ul>
<li>不存每个请求的准确耗时（太贵）</li>
<li>只存区间统计（够用）</li>
<li>从 1000 条数据压缩到 10 条</li>
</ul>
</li>
<li>
<p><strong>用空间换时间</strong></p>
<ul>
<li>提前分好区间（bucket）</li>
<li>查询时只需要聚合，不需要重新计算</li>
<li>histogram_quantile() 基于线性插值，速度快</li>
</ul>
</li>
<li>
<p><strong>可聚合是关键</strong></p>
<ul>
<li>多个实例的 bucket 可以相加</li>
<li>这是 Histogram 比 Summary 更通用的原因</li>
<li>牺牲了客户端计算成本，换来了服务端灵活性</li>
</ul>
</li>
</ol>
<p>这是"简单模型看透复杂问题"的巅峰之作：用几个累积的计数器（bucket），配合一个聚合函数（histogram_quantile），就能看透整个系统的性能分布。</p>
<h3 data-id="heading-9">2.4 Summary（摘要）</h3>
<p><strong>定义</strong></p>
<p>Summary 和 Histogram 类似，都是用来统计分布，但有个关键区别：<strong>分位数在哪计算</strong>。</p>
<p><strong>Histogram vs Summary</strong></p>








































<table><thead><tr><th>对比维度</th><th>Histogram</th><th>Summary</th></tr></thead><tbody><tr><td>分位数计算位置</td><td>Prometheus（服务端）</td><td>Exporter（客户端）</td></tr><tr><td>存储内容</td><td>bucket 统计</td><td>预计算的分位数</td></tr><tr><td>查询时计算</td><td>需要用 histogram_quantile()</td><td>直接读</td></tr><tr><td>能否聚合</td><td>能（多实例）</td><td>不能</td></tr><tr><td>灵活性</td><td>可以算任意分位数</td><td>只能看预设的</td></tr><tr><td>客户端开销</td><td>小（只统计 bucket）</td><td>大（要计算分位数）</td></tr></tbody></table>
<p><strong>Summary 的结构</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># TYPE http_request_duration_seconds summary</span>

http_request_duration_seconds{<span class="hljs-attr">quantile</span>=<span class="hljs-string">"0.5"</span>} <span class="hljs-number">0.232</span>
http_request_duration_seconds{<span class="hljs-attr">quantile</span>=<span class="hljs-string">"0.9"</span>} <span class="hljs-number">0.821</span>
http_request_duration_seconds{<span class="hljs-attr">quantile</span>=<span class="hljs-string">"0.99"</span>} <span class="hljs-number">1.523</span>

http_request_duration_seconds_sum 45.67
http_request_duration_seconds_count 200
</code></pre>
<p>注意：</p>
<ol>
<li>没有 <code>_bucket</code></li>
<li>直接给出了 <code>quantile="0.5"</code> 等分位数的值</li>
<li>这些分位数是在 Exporter 里算好的</li>
</ol>
<p><strong>用类比理解</strong></p>
<pre><code class="hljs language-scss" lang="scss">Histogram 方案：
Java 代码统计 bucket → 发送给 Prometheus → 查询时用 <span class="hljs-built_in">histogram_quantile</span>() 计算

<span class="hljs-selector-tag">Summary</span> 方案：
Java 代码直接计算 P50/P90/P99 → 发送给 Prometheus → 查询时直接读
</code></pre>
<p>就像：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">Histogram</span> = 给你食材，你自己做菜
<span class="hljs-attr">Summary</span> = 直接给你做好的菜
</code></pre>
<p><strong>Summary 为什么不能聚合？</strong></p>
<p>这是个关键限制。</p>
<p>假设有 2 个实例：</p>
<pre><code class="hljs language-ini" lang="ini">实例 1: <span class="hljs-attr">P90</span> = <span class="hljs-number">0.8</span> 秒
实例 2: <span class="hljs-attr">P90</span> = <span class="hljs-number">1.2</span> 秒
</code></pre>
<p>问：整体的 P90 是多少？</p>
<p>答案：<strong>不知道</strong>。</p>
<p>你不能简单地：</p>
<ul>
<li>求平均：(0.8 + 1.2) / 2 = 1.0 ？ 错！</li>
<li>取最大：max(0.8, 1.2) = 1.2 ？ 错！</li>
</ul>
<p>因为分位数不能这样算。只有原始数据（或 bucket 统计）才能正确聚合。</p>
<pre><code class="hljs language-promql" lang="promql"># Histogram 可以聚合
histogram_quantile(0.9, 
  sum(rate(http_request_duration_seconds_bucket[5m])) by (le)
)
# 先把多个实例的 bucket 加起来，再计算 P90

# Summary 不能聚合
sum(http_request_duration_seconds{quantile="0.9"})
# 这样做是错的！把多个实例的 P90 加起来毫无意义
</code></pre>
<p><strong>什么时候用 Summary？</strong></p>
<p>适合 Summary 的场景：</p>
<ol>
<li><strong>单实例应用</strong>：不需要聚合</li>
<li><strong>查询性能敏感</strong>：Summary 查询更快（不需要计算）</li>
<li><strong>分位数固定</strong>：你确定只需要 P50/P90/P99</li>
</ol>
<p>典型例子：Go 程序的 GC 时间监控（官方库默认用 Summary）</p>
<pre><code class="hljs language-ini" lang="ini">go_gc_duration_seconds{<span class="hljs-attr">quantile</span>=<span class="hljs-string">"0"</span>} <span class="hljs-number">0.000042</span>
go_gc_duration_seconds{<span class="hljs-attr">quantile</span>=<span class="hljs-string">"0.25"</span>} <span class="hljs-number">0.000065</span>
go_gc_duration_seconds{<span class="hljs-attr">quantile</span>=<span class="hljs-string">"0.5"</span>} <span class="hljs-number">0.000077</span>
go_gc_duration_seconds{<span class="hljs-attr">quantile</span>=<span class="hljs-string">"0.75"</span>} <span class="hljs-number">0.000091</span>
go_gc_duration_seconds{<span class="hljs-attr">quantile</span>=<span class="hljs-string">"1"</span>} <span class="hljs-number">0.001752</span>
</code></pre>
<p><strong>Histogram vs Summary 选择建议</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">你的场景                        →  推荐类型
----------------------------------------------</span>
多实例，需要聚合                →  Histogram
单实例                          →  Summary 或 Histogram
不确定需要哪些分位数            →  Histogram
需要预测未来的分位数            →  Histogram
客户端资源受限                  →  Histogram
查询性能要求极高                →  Summary
</code></pre>
<p><strong>实战建议</strong>：优先用 Histogram，除非有特殊原因。</p>
<p><strong>Summary 的设计哲学</strong></p>
<p>Summary 体现了一个有趣的权衡：<strong>客户端计算 vs 服务端灵活性</strong>。</p>
<ul>
<li>Histogram：客户端简单，服务端强大（可以算任意分位数）</li>
<li>Summary：客户端复杂，服务端简单（只能看预设的分位数）</li>
</ul>
<p>Prometheus 最终选择让 Histogram 成为主力，Summary 作为特殊场景的补充。这个选择背后的思考是：</p>
<p><strong>监控系统应该把复杂性留在服务端（Prometheus），让客户端（Exporter）尽可能简单。</strong></p>
<p>这又回到了开头的哲学：简单优先。即使 Summary 查询更快，但它牺牲了灵活性，也增加了客户端的复杂度。相比之下，Histogram 虽然查询时需要计算，但客户端更简单，也更通用。</p>
<p><strong>四种类型的本质</strong></p>
<p>到这里，我们可以总结四种类型的本质了：</p>






























<table><thead><tr><th>类型</th><th>本质</th><th>设计智慧</th></tr></thead><tbody><tr><td>Counter</td><td>只增的累积器</td><td>牺牲绝对精确，专注速率和趋势</td></tr><tr><td>Gauge</td><td>可变的快照</td><td>不关心历史，只关心当前</td></tr><tr><td>Histogram</td><td>分布的压缩</td><td>牺牲精确度，换取存储和计算效率</td></tr><tr><td>Summary</td><td>预计算的结果</td><td>客户端复杂，服务端简单</td></tr></tbody></table>
<p>四种类型，覆盖了监控的所有场景：</p>
<ul>
<li>需要累积？Counter</li>
<li>需要当前状态？Gauge</li>
<li>需要看分布？Histogram</li>
<li>需要极致性能？Summary</li>
</ul>
<p>这就是"用最少的类型描述最多的场景"的智慧。</p>
<hr/>
<h2 data-id="heading-10">3. Histogram：如何优雅地处理分布问题</h2>
<h3 data-id="heading-11">3.1 高基数问题</h3>
<p>这是使用 Histogram 时最容易踩的坑。</p>
<p><strong>一个 Histogram 会生成多少时间序列？</strong></p>
<p>假设你有 10 个 bucket，那么一个 Histogram 指标会生成：</p>
<pre><code class="hljs language-ini" lang="ini">10 个 _bucket + 1 个 _sum + 1 个 <span class="hljs-attr">_count</span> = <span class="hljs-number">12</span> 条时间序列
</code></pre>
<p>现在看看高基数问题：</p>
<p><strong>场景 1：低基数标签</strong></p>
<pre><code class="hljs language-promql" lang="promql">http_request_duration_seconds_bucket{service="api", path="/users", le="0.1"}
</code></pre>
<p>标签组合：</p>
<ul>
<li>service: 5 个服务</li>
<li>path: 20 个接口</li>
<li>le: 10 个 bucket</li>
</ul>
<p>总时间序列数：</p>
<pre><code class="hljs language-ini" lang="ini">5 × 20 × <span class="hljs-attr">10</span> = <span class="hljs-number">1000</span> 条（只是 bucket）
1000 + 5×20×<span class="hljs-attr">2</span> = <span class="hljs-number">1200</span> 条（加上 sum 和 count）
</code></pre>
<p>这完全可以接受。</p>
<p><strong>场景 2：高基数标签</strong></p>
<pre><code class="hljs language-promql" lang="promql"># 错误示例！
http_request_duration_seconds_bucket{user_id="123456", le="0.1"}
</code></pre>
<p>标签组合：</p>
<ul>
<li>user_id: 100 万用户</li>
<li>le: 10 个 bucket</li>
</ul>
<p>总时间序列数：</p>
<pre><code class="hljs language-ini" lang="ini">1,000,000 × <span class="hljs-attr">10</span> = <span class="hljs-number">10</span>,<span class="hljs-number">000</span>,<span class="hljs-number">000</span> 条（只是 bucket）
10,000,000 + 1,000,000 × <span class="hljs-attr">2</span> = <span class="hljs-number">12</span>,<span class="hljs-number">000</span>,<span class="hljs-number">000</span> 条（加上 sum 和 count）
</code></pre>
<p>这会直接把 Prometheus 打爆！</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[100个服务] --&gt; B[低基数方案 1200条]
    A --&gt; C[高基数方案 100万用户]
    C --&gt; D[1200万条时间序列]
    
    style B fill:#ccffcc
    style D fill:#ffcccc
</code></pre>
<p><strong>高基数放大效应</strong></p>
<p>对比 Gauge 和 Histogram：</p>



































<table><thead><tr><th>标签组合数</th><th>Gauge</th><th>Histogram (10 bucket)</th><th>放大倍数</th></tr></thead><tbody><tr><td>100</td><td>100</td><td>1,200</td><td>12x</td></tr><tr><td>1,000</td><td>1,000</td><td>12,000</td><td>12x</td></tr><tr><td>10,000</td><td>10,000</td><td>120,000</td><td>12x</td></tr><tr><td>100,000</td><td>100,000</td><td>1,200,000</td><td>12x</td></tr></tbody></table>
<p><strong>Histogram 把基数放大了 (bucket数 + 2) 倍！</strong></p>
<p><strong>如何避免？</strong></p>
<ol>
<li><strong>不要在高基数标签上用 Histogram</strong></li>
</ol>
<pre><code class="hljs language-promql" lang="promql"># 错误
http_duration{user_id="..."}  # user_id 是高基数
http_duration{ip="..."}       # IP 是高基数
http_duration{trace_id="..."}  # trace_id 是高基数

# 正确
http_duration{service="...", path="..."}  # 低基数
</code></pre>
<ol start="2">
<li><strong>用路径模板代替具体路径</strong></li>
</ol>
<pre><code class="hljs language-promql" lang="promql"># 错误
http_duration{path="/api/users/123456"}  # 每个用户ID一个路径

# 正确
http_duration{path="/api/users/:id"}     # 模板化路径
</code></pre>
<ol start="3">
<li><strong>减少 bucket 数量</strong></li>
</ol>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 不要设置太多 bucket</span>
buckets := []<span class="hljs-type">float64</span>{
    <span class="hljs-number">0.001</span>, <span class="hljs-number">0.005</span>, <span class="hljs-number">0.01</span>, <span class="hljs-number">0.025</span>, <span class="hljs-number">0.05</span>, <span class="hljs-number">0.075</span>, <span class="hljs-number">0.1</span>,
    <span class="hljs-number">0.25</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.75</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">2.5</span>, <span class="hljs-number">5.0</span>, <span class="hljs-number">7.5</span>, <span class="hljs-number">10.0</span>,
}  <span class="hljs-comment">// 15 个 bucket，太多了！</span>

<span class="hljs-comment">// 简化到必要的 bucket</span>
buckets := []<span class="hljs-type">float64</span>{<span class="hljs-number">0.1</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">5.0</span>}  <span class="hljs-comment">// 4 个 bucket 够用</span>
</code></pre>
<h3 data-id="heading-12">3.2 bucket 边界如何设置？</h3>
<p>这是个常见问题：bucket 的 <code>le</code> 值应该设多少？</p>
<p><strong>原则 1：覆盖你关心的范围</strong></p>
<p>比如你的 API：</p>
<ul>
<li>正常情况下：50-200ms</li>
<li>可接受范围：&lt; 500ms</li>
<li>超时设置：5 秒</li>
</ul>
<p>那么 bucket 可以设置为：</p>
<pre><code class="hljs language-go" lang="go">buckets := []<span class="hljs-type">float64</span>{<span class="hljs-number">0.05</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>}
<span class="hljs-comment">// 覆盖了 50ms, 100ms, 200ms, 500ms, 1s, 5s</span>
</code></pre>
<p><strong>原则 2：分布要合理</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 不好：集中在小范围</span>
buckets := []<span class="hljs-type">float64</span>{<span class="hljs-number">0.1</span>, <span class="hljs-number">0.11</span>, <span class="hljs-number">0.12</span>, <span class="hljs-number">0.13</span>, <span class="hljs-number">10</span>}

<span class="hljs-comment">// 好：均匀分布</span>
buckets := []<span class="hljs-type">float64</span>{<span class="hljs-number">0.1</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">10</span>}
</code></pre>
<p><strong>原则 3：考虑计算精度</strong></p>
<p>分位数计算是基于线性插值的，bucket 越密集，精度越高：</p>
<pre><code class="hljs language-ini" lang="ini">bucket 设置: <span class="hljs-section">[0.1, 1.0, 10.0]</span>

如果 P95 落在 1.0 - 10.0 之间
Prometheus 会用线性插值估算
精度较低（跨度太大）

bucket 设置: <span class="hljs-section">[0.1, 0.5, 1.0, 2.0, 5.0, 10.0]</span>

如果 P95 落在 1.0 - 2.0 之间
精度会更高（跨度小）
</code></pre>
<p><strong>Prometheus 默认的 bucket</strong></p>
<p>Prometheus 官方库的默认 bucket 是：</p>
<pre><code class="hljs language-go" lang="go">[<span class="hljs-number">0.005</span>, <span class="hljs-number">0.01</span>, <span class="hljs-number">0.025</span>, <span class="hljs-number">0.05</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">0.25</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2.5</span>, <span class="hljs-number">5</span>, <span class="hljs-number">10</span>]
</code></pre>
<p>这个设置覆盖了从 5ms 到 10s 的范围，对大多数 API 来说够用。</p>
<h3 data-id="heading-13">3.3 _sum 和 _count 的作用</h3>
<p>Histogram 的 <code>_sum</code> 和 <code>_count</code> 不是强制的，但强烈建议有。</p>
<p><strong>作用 1：计算平均值</strong></p>
<pre><code class="hljs language-promql" lang="promql">rate(http_request_duration_seconds_sum[5m])
/
rate(http_request_duration_seconds_count[5m])
</code></pre>
<p>如果没有 <code>_sum</code> 和 <code>_count</code>，你算不出平均值。</p>
<p><strong>作用 2：计算请求速率</strong></p>
<pre><code class="hljs language-promql" lang="promql">rate(http_request_duration_seconds_count[5m])
</code></pre>
<p>这等价于：</p>
<pre><code class="hljs language-promql" lang="promql">rate(http_requests_total[5m])
</code></pre>
<p>所以 <code>_count</code> 其实就是个 Counter，记录请求总数。</p>
<p><strong>作用 3：检查数据一致性</strong></p>
<pre><code class="hljs language-promql" lang="promql"># _count 应该等于最大的 bucket
http_request_duration_seconds_count
==
http_request_duration_seconds_bucket{le="+Inf"}
</code></pre>
<p>如果不相等，说明数据有问题。</p>
<p><strong>官方客户端库会自动生成</strong></p>
<p>用官方库（Go、Java、Python）不用操心，它们会自动维护 <code>_sum</code> 和 <code>_count</code>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Go 代码</span>
histogram := prometheus.NewHistogram(...)
histogram.Observe(<span class="hljs-number">0.234</span>)  <span class="hljs-comment">// 自动更新 _bucket、_sum、_count</span>
</code></pre>
<p>只有手写 Exporter 时才需要注意。</p>
<p><strong>Histogram 设计的深层思考</strong></p>
<p>Histogram 的三个设计细节（bucket 累积、高基数问题、_sum/_count）都指向一个核心思想：</p>
<p><strong>在性能、精度、灵活性之间找到最佳平衡点。</strong></p>
<ul>
<li>bucket 累积：让聚合变简单（直接相加）</li>
<li>控制高基数：避免存储爆炸</li>
<li>_sum 和 _count：用两个额外的 Counter 就能算平均值</li>
</ul>
<p>没有一个设计是完美的，但 Histogram 找到了一个"足够好"的平衡点：</p>
<ul>
<li>牺牲一点精确度（不知道准确耗时）</li>
<li>换取存储效率（压缩 1000 倍）</li>
<li>保留灵活性（可以算任意分位数）</li>
<li>支持聚合（多实例可以合并）</li>
</ul>
<p>这就是"简单模型"的力量：用简单的规则（累积的 bucket），解决复杂的问题（性能分布）。</p>
<hr/>
<h2 data-id="heading-14">4. 易混淆概念：细节中的设计智慧</h2>
<h3 data-id="heading-15">4.1 rate() vs irate()</h3>
<p>这是最容易混淆的一对函数。</p>
<p><strong>计算方式的区别</strong></p>
<pre><code class="hljs language-promql" lang="promql">rate(http_requests_total[5m])   # 用 5 分钟窗口内所有点计算平均速率
irate(http_requests_total[5m])  # 只用最近两个点计算瞬时速率
</code></pre>
<p><strong>举个例子</strong></p>
<p>假设过去 5 分钟的 Counter 值：</p>
<pre><code class="hljs language-makefile" lang="makefile">时间      值
<span class="hljs-section">10:00    1000</span>
<span class="hljs-section">10:01    1100  (+100)</span>
<span class="hljs-section">10:02    1200  (+100)</span>
<span class="hljs-section">10:03    1300  (+100)</span>
<span class="hljs-section">10:04    1400  (+100)</span>
<span class="hljs-section">10:05    1600  (+200)  ← 最后 1 分钟增加了 200</span>
</code></pre>
<p><code>rate()</code> 的计算：</p>
<pre><code class="hljs language-ini" lang="ini">总增量 = 1600 - <span class="hljs-attr">1000</span> = <span class="hljs-number">600</span>
时间跨度 = 5 分钟 = 300 秒
<span class="hljs-attr">rate</span> = <span class="hljs-number">600</span> / <span class="hljs-number">300</span> = <span class="hljs-number">2.0</span>/s
</code></pre>
<p><code>irate()</code> 的计算：</p>
<pre><code class="hljs language-ini" lang="ini">最近两个点的增量 = 1600 - <span class="hljs-attr">1400</span> = <span class="hljs-number">200</span>
时间间隔 = 60 秒
<span class="hljs-attr">irate</span> = <span class="hljs-number">200</span> / <span class="hljs-number">60</span> = <span class="hljs-number">3.33</span>/s
</code></pre>
<p><strong>曲线对比</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">rate():  平滑曲线</span>
时间  值
<span class="hljs-section">10:00  2.0</span>
<span class="hljs-section">10:01  2.0</span>
<span class="hljs-section">10:02  2.0</span>
<span class="hljs-section">10:03  2.0</span>
<span class="hljs-section">10:04  2.0</span>
<span class="hljs-section">10:05  2.0  ← 仍然是平均值</span>

<span class="hljs-section">irate(): 敏感曲线</span>
时间  值
<span class="hljs-section">10:00  1.67</span>
<span class="hljs-section">10:01  1.67</span>
<span class="hljs-section">10:02  1.67</span>
<span class="hljs-section">10:03  1.67</span>
<span class="hljs-section">10:04  1.67</span>
<span class="hljs-section">10:05  3.33  ← 立即反应了突增</span>
</code></pre>
<p><strong>何时用哪个？</strong></p>



































<table><thead><tr><th>场景</th><th>推荐</th><th>原因</th></tr></thead><tbody><tr><td>告警规则</td><td>rate()</td><td>避免毛刺导致误报</td></tr><tr><td>容量规划</td><td>rate()</td><td>需要长期趋势</td></tr><tr><td>实时监控 Dashboard</td><td>irate()</td><td>快速反应变化</td></tr><tr><td>SLO 计算</td><td>rate()</td><td>需要平滑数据</td></tr><tr><td>调试问题</td><td>irate()</td><td>需要看瞬时情况</td></tr></tbody></table>
<p><strong>一个实战建议</strong></p>
<p>在 Grafana Dashboard 上：</p>
<ul>
<li>概览页面用 <code>rate()</code>（看整体趋势）</li>
<li>详情页面用 <code>irate()</code>（看实时波动）</li>
</ul>
<h3 data-id="heading-16">4.2 increase() vs rate()</h3>
<p><strong>定义</strong></p>
<pre><code class="hljs language-promql" lang="promql">increase(http_requests_total[1h])  # 返回 1 小时的增量（总数）
rate(http_requests_total[1h])      # 返回每秒的速率
</code></pre>
<p><strong>换算关系</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">increase</span>(metric[<span class="hljs-number">1</span>h]) = <span class="hljs-built_in">rate</span>(metric[<span class="hljs-number">1</span>h]) × <span class="hljs-number">3600</span>
</code></pre>
<p>因为 1 小时 = 3600 秒。</p>
<p><strong>实际例子</strong></p>
<pre><code class="hljs language-promql" lang="promql">http_requests_total

时间    值
09:00  1000
10:00  2000

increase(http_requests_total[1h]) = 2000 - 1000 = 1000
→ 1 小时增加了 1000 个请求

rate(http_requests_total[1h]) = (2000 - 1000) / 3600 = 0.278
→ 平均每秒 0.278 个请求
</code></pre>
<p><strong>什么时候用哪个？</strong></p>
<pre><code class="hljs language-promql" lang="promql"># 你想知道"1 小时内总共处理了多少请求"
increase(http_requests_total[1h])

# 你想知道"平均每秒处理多少请求"
rate(http_requests_total[1h])

# 告警：每秒请求超过 100
rate(http_requests_total[5m]) &gt; 100

# 告警：1 小时内错误超过 1000 个
increase(error_total[1h]) &gt; 1000
</code></pre>
<h3 data-id="heading-17">4.3 histogram_quantile() 的常见误区</h3>
<p><strong>误区 1：不用 rate()</strong></p>
<pre><code class="hljs language-promql" lang="promql"># 错误
histogram_quantile(0.95, http_request_duration_seconds_bucket)

# 正确
histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))
</code></pre>
<p>为什么？因为 bucket 是 Counter（累积值），你需要转成速率：</p>
<pre><code class="hljs language-ini" lang="ini">bucket 的原始值：
<span class="hljs-attr">le</span>=<span class="hljs-string">"0.1"</span>  <span class="hljs-number">1000</span>  ← 累积有 <span class="hljs-number">1000</span> 个
<span class="hljs-attr">le</span>=<span class="hljs-string">"0.5"</span>  <span class="hljs-number">5000</span>  ← 累积有 <span class="hljs-number">5000</span> 个

rate() 后：
<span class="hljs-attr">le</span>=<span class="hljs-string">"0.1"</span>  <span class="hljs-number">2.5</span>   ← 每秒 <span class="hljs-number">2.5</span> 个
<span class="hljs-attr">le</span>=<span class="hljs-string">"0.5"</span>  <span class="hljs-number">10</span>    ← 每秒 <span class="hljs-number">10</span> 个

histogram_quantile 需要"每秒多少个"才能算对
</code></pre>
<p><strong>误区 2：丢掉 le 标签</strong></p>
<pre><code class="hljs language-promql" lang="promql"># 错误：聚合时丢掉了 le
histogram_quantile(0.95, 
  sum(rate(http_request_duration_seconds_bucket[5m]))
)

# 正确：by (le) 保留 le 标签
histogram_quantile(0.95, 
  sum(rate(http_request_duration_seconds_bucket[5m])) by (le)
)
</code></pre>
<p>为什么？因为 <code>histogram_quantile()</code> 需要 <code>le</code> 标签来知道每个 bucket 的边界。</p>
<p><strong>误区 3：对非 bucket 指标使用</strong></p>
<pre><code class="hljs language-promql" lang="promql"># 错误：这不是 histogram
histogram_quantile(0.95, http_requests_total)

# histogram_quantile 只能用于 _bucket 指标
</code></pre>
<h3 data-id="heading-18">4.4 sum() vs avg() vs rate()</h3>
<p>这三个函数经常一起用，容易混淆。</p>
<p><strong>sum() - 求和</strong></p>
<pre><code class="hljs language-promql" lang="promql"># 把所有实例的请求数加起来
sum(rate(http_requests_total[5m]))
</code></pre>
<p><strong>avg() - 求平均</strong></p>
<pre><code class="hljs language-promql" lang="promql"># 计算所有实例的平均请求速率
avg(rate(http_requests_total[5m]))
</code></pre>
<p><strong>区别</strong></p>
<pre><code class="hljs language-bash" lang="bash">场景：3 个实例

实例 1: 100 req/s
实例 2: 200 req/s
实例 3: 300 req/s

<span class="hljs-built_in">sum</span>() = 100 + 200 + 300 = 600 req/s  ← 总请求速率
avg() = (100 + 200 + 300) / 3 = 200 req/s  ← 平均每个实例的速率
</code></pre>
<p><strong>什么时候用哪个？</strong></p>
<pre><code class="hljs language-promql" lang="promql"># 你想知道"整个集群每秒处理多少请求"
sum(rate(http_requests_total[5m]))

# 你想知道"平均每个实例每秒处理多少请求"
avg(rate(http_requests_total[5m]))
</code></pre>
<hr/>
<h2 data-id="heading-19">5. 生产环境的实战经验</h2>
<h3 data-id="heading-20">5.1 指标命名规范</h3>
<p><strong>基本格式</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">namespace</span>&gt;</span>_<span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>_<span class="hljs-tag">&lt;<span class="hljs-name">unit</span>&gt;</span>_<span class="hljs-tag">&lt;<span class="hljs-name">suffix</span>&gt;</span>
</code></pre>
<p>示例：</p>
<pre><code class="hljs language-bash" lang="bash">node_memory_MemAvailable_bytes     <span class="hljs-comment"># 服务器内存</span>
http_requests_total                <span class="hljs-comment"># HTTP 请求</span>
http_request_duration_seconds      <span class="hljs-comment"># HTTP 耗时</span>
mysql_queries_total                <span class="hljs-comment"># MySQL 查询</span>
redis_memory_used_bytes            <span class="hljs-comment"># Redis 内存</span>
</code></pre>
<p><strong>规范细节</strong></p>






























<table><thead><tr><th>部分</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td>namespace</td><td>所属系统</td><td>node, http, mysql, redis</td></tr><tr><td>name</td><td>指标含义</td><td>requests, queries, memory</td></tr><tr><td>unit</td><td>单位</td><td>bytes, seconds, ratio</td></tr><tr><td>suffix</td><td>类型后缀</td><td>_total, _bucket, _count</td></tr></tbody></table>
<p><strong>单位规范</strong></p>
<ul>
<li>时间：<code>_seconds</code>（不要用 ms 或 minutes）</li>
<li>大小：<code>_bytes</code>（不要用 KB 或 MB）</li>
<li>比例：<code>_ratio</code>（0-1）或 <code>_percent</code>（0-100）</li>
</ul>
<pre><code class="hljs language-promql" lang="promql"># 好
http_request_duration_seconds 0.234
memory_usage_bytes 8589934592
cpu_usage_ratio 0.85

# 不好
http_request_duration_ms 234
memory_usage_mb 8192
cpu_usage_percent 85
</code></pre>
<p>为什么统一用基本单位？</p>
<ol>
<li>避免单位换算错误</li>
<li>PromQL 可以用 <code>* 1000</code> 等转换显示</li>
</ol>
<h3 data-id="heading-21">5.2 标签设计原则</h3>
<p><strong>原则 1：低基数</strong></p>
<pre><code class="hljs language-promql" lang="promql"># 好：低基数标签
http_requests{method="GET", status="200"}  
→ method 有 5 个值（GET/POST/PUT/DELETE/PATCH）
→ status 有 10 个值（200/404/500...）
→ 总组合 5 × 10 = 50

# 坏：高基数标签
http_requests{user_id="123456"}
→ user_id 有百万个值
→ 百万条时间序列
</code></pre>
<p><strong>原则 2：有意义</strong></p>
<pre><code class="hljs language-promql" lang="promql"># 好：标签有实际含义
http_requests{service="api", path="/users"}

# 坏：标签没什么用
http_requests{server_index="1", cluster_id="abc123"}
</code></pre>
<p><strong>原则 3：路径模板化</strong></p>
<pre><code class="hljs language-promql" lang="promql"># 坏：每个用户一个路径
http_duration{path="/api/users/123456"}
http_duration{path="/api/users/789012"}
...

# 好：用模板
http_duration{path="/api/users/:id"}
</code></pre>
<p><strong>原则 4：不要用标签存数值</strong></p>
<pre><code class="hljs language-promql" lang="promql"># 坏：把数值放标签里
http_requests{duration="0.234"}

# 好：用专门的 Histogram 指标
http_request_duration_seconds_bucket{le="0.5"}
</code></pre>
<h3 data-id="heading-22">5.3 常见的生产问题</h3>
<p><strong>问题 1：Counter 突然下降怎么办？</strong></p>
<p>现象：</p>
<pre><code class="hljs language-makefile" lang="makefile">http_requests_total

<span class="hljs-section">10:00  1000</span>
<span class="hljs-section">10:01  1500</span>
<span class="hljs-section">10:02  500   ← 突然下降了！</span>
</code></pre>
<p>可能原因：</p>
<ol>
<li>Pod/容器重启了（正常）</li>
<li>Prometheus 抓取错误（问题）</li>
<li>应用 bug（问题）</li>
</ol>
<p>排查：</p>
<pre><code class="hljs language-promql" lang="promql"># 看 up 指标，确认是否抓取成功
up{job="my-app"}

# 看是否有重启
kube_pod_container_status_restarts_total
</code></pre>
<p><strong>问题 2：Histogram 的 P99 突然飙升</strong></p>
<p>现象：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">P50: 100ms（正常）</span>
<span class="hljs-section">P90: 200ms（正常）</span>
<span class="hljs-section">P99: 5000ms（异常！）</span>
</code></pre>
<p>这说明有 1% 的请求特别慢，可能原因：</p>
<ol>
<li>数据库慢查询</li>
<li>缓存未命中</li>
<li>GC 停顿</li>
<li>下游服务超时</li>
</ol>
<p>排查：</p>
<pre><code class="hljs language-promql" lang="promql"># 看慢的是哪个接口
topk(5,
  histogram_quantile(0.99, 
    rate(http_duration_bucket[5m])
  )
)

# 对比 P50 和 P99 的差异
histogram_quantile(0.99, ...) 
/ 
histogram_quantile(0.5, ...)
# 如果比值 &gt; 10，说明有严重长尾
</code></pre>
<p><strong>问题 3：指标突然消失</strong></p>
<p>现象：</p>
<pre><code class="hljs language-ini" lang="ini">http_requests_total{<span class="hljs-attr">service</span>=<span class="hljs-string">"api"</span>} 

10:00  有数据
10:05  没有数据了
</code></pre>
<p>可能原因：</p>
<ol>
<li>服务挂了（<code>up == 0</code>）</li>
<li>标签变了（比如 service 名称改了）</li>
<li>指标被删除了</li>
</ol>
<p>排查：</p>
<pre><code class="hljs language-promql" lang="promql"># 看服务是否存活
up{job="my-app"}

# 看所有 http_requests_total 指标（不限制标签）
http_requests_total

# 看最近新出现的时间序列
time() - timestamp(http_requests_total) &lt; 300
</code></pre>
<h3 data-id="heading-23">5.4 性能优化技巧</h3>
<p><strong>技巧 1：用 Recording Rules 预计算</strong></p>
<p>如果一个查询很复杂，经常用到，可以用 Recording Rule 预先计算：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">groups:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">api_rules</span>
    <span class="hljs-attr">interval:</span> <span class="hljs-string">30s</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">record:</span> <span class="hljs-string">job:http_requests:rate5m</span>
        <span class="hljs-attr">expr:</span> <span class="hljs-string">sum(rate(http_requests_total[5m]))</span> <span class="hljs-string">by</span> <span class="hljs-string">(job)</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">record:</span> <span class="hljs-string">job:http_p95_seconds</span>
        <span class="hljs-attr">expr:</span> <span class="hljs-string">histogram_quantile(0.95,</span> 
                <span class="hljs-string">sum(rate(http_duration_bucket[5m]))</span> <span class="hljs-string">by</span> <span class="hljs-string">(job,</span> <span class="hljs-string">le)</span>
              <span class="hljs-string">)</span>
</code></pre>
<p>然后查询时直接用：</p>
<pre><code class="hljs language-promql" lang="promql"># 不用每次都算 rate() 和 sum()
job:http_requests:rate5m

# 不用每次都算 histogram_quantile()
job:http_p95_seconds
</code></pre>
<p><strong>技巧 2：控制指标数量</strong></p>
<pre><code class="hljs language-promql" lang="promql"># 查看指标数量
count(http_requests_total)

# 查看哪个标签基数最高
count by (service) (http_requests_total)
count by (path) (http_requests_total)
</code></pre>
<p>如果某个标签基数太高，考虑：</p>
<ol>
<li>去掉这个标签</li>
<li>合并标签值（比如把所有 5xx 归为一类）</li>
<li>用路径模板</li>
</ol>
<p><strong>技巧 3：合理设置抓取间隔</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># prometheus.yml</span>
<span class="hljs-attr">scrape_configs:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">'high-frequency'</span>
    <span class="hljs-attr">scrape_interval:</span> <span class="hljs-string">15s</span>  <span class="hljs-comment"># 变化快的指标</span>
  
  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">'low-frequency'</span>
    <span class="hljs-attr">scrape_interval:</span> <span class="hljs-string">60s</span>  <span class="hljs-comment"># 变化慢的指标</span>
</code></pre>
<p>没必要所有指标都 15 秒抓一次。</p>
<p><strong>生产实践的智慧</strong></p>
<p>生产环境的经验告诉我们：理论再完美，也要经得起实战检验。</p>
<p>这一章的所有经验都指向一个原则：<strong>在理论和实际之间找到平衡</strong>。</p>
<ul>
<li>命名规范：让人一眼看懂，而不是炫技</li>
<li>标签设计：低基数优先，宁简勿繁</li>
<li>问题排查：从简单到复杂，逐步缩小范围</li>
<li>性能优化：先用 Recording Rules 预计算，再考虑复杂方案</li>
</ul>
<p>这些经验的背后，还是那个哲学：<strong>简单优先，够用就好</strong>。</p>
<hr/>
<h2 data-id="heading-24">6. 下一步：从理解到实践</h2>
<p>通过这篇文章，我们深入探讨了 Prometheus 的设计哲学：</p>
<p><strong>一种哲学：简单优先</strong></p>
<ul>
<li>牺牲一点精确性，换取简单和可靠</li>
<li>把复杂性留在服务端，让客户端简单</li>
<li>在性能、精度、灵活性之间找平衡</li>
</ul>
<p><strong>四个指标：用最少的类型描述最多的场景</strong></p>
<ul>
<li>Counter：只增不减的累积器</li>
<li>Gauge：可增可减的快照</li>
<li>Histogram：分布的压缩</li>
<li>Summary：预计算的结果</li>
</ul>
<p><strong>一个模型：如何看透复杂系统</strong></p>
<p>Prometheus 用四种简单的指标类型，就能描述世间所有监控场景。这不是巧合，而是抓住了本质：</p>
<ul>
<li>累积？用 Counter</li>
<li>状态？用 Gauge</li>
<li>分布？用 Histogram</li>
<li>性能？用 Summary</li>
</ul>
<p>这就是"用简单模型看透复杂系统"的智慧。</p>
<hr/>
<p>但理解哲学只是第一步，接下来你需要知道：</p>
<p><strong>如何设计一个 Exporter？</strong></p>
<ul>
<li>node-exporter 是怎么设计的？</li>
<li>为什么 CPU 时间用 Counter，CPU 使用率用 Gauge？</li>
<li>为什么某些指标要预聚合？</li>
</ul>
<p><strong>如何在 Grafana 中构建复杂表达式？</strong></p>
<ul>
<li>如何计算 CPU 使用率？</li>
<li>如何计算内存可用率？</li>
<li>如何预测磁盘何时满？</li>
</ul>
<p><strong>如何开发自定义 Exporter？</strong></p>
<ul>
<li>监控数据库应该关注哪些指标？</li>
<li>如何选择合适的类型？</li>
<li>如何避免常见的坑？</li>
</ul>
<p>让我们继续下一篇，以 node-exporter 为例，深入学习监控指标的设计艺术。</p>
<p><strong>下一篇：《Prometheus Exporter 设计实战 —— node-exporter 源码解析与 Grafana 集成》</strong></p>
<hr/>
<h2 data-id="heading-25">附录：四种类型速查表</h2>








































<table><thead><tr><th>类型</th><th>用途</th><th>只增不减</th><th>典型场景</th><th>常用函数</th></tr></thead><tbody><tr><td>Counter</td><td>累计次数</td><td>是</td><td>请求数、错误数、查询数</td><td>rate(), increase()</td></tr><tr><td>Gauge</td><td>当前状态</td><td>否</td><td>CPU、内存、连接数、队列长度</td><td>直接读、delta()</td></tr><tr><td>Histogram</td><td>分布统计</td><td>是(bucket)</td><td>API 响应时间、请求大小</td><td>histogram_quantile()</td></tr><tr><td>Summary</td><td>预计算分位数</td><td>是(count)</td><td>GC 时间（单实例）</td><td>直接读 {quantile}</td></tr></tbody></table>
<p><strong>选择决策树</strong></p>
<pre><code class="hljs language-css" lang="css">你的问题是什么？
├─ 发生了多少次？ → Counter
├─ 现在是多少？ → Gauge
└─ 分布如何（有没有长尾）？
   ├─ 多实例需要聚合 → Histogram
   └─ 单实例 → <span class="hljs-selector-tag">Summary</span> 或 Histogram
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Git 操作偏门指南：常用和隐藏命令与问题解决]]></title>    <link>https://juejin.cn/post/7589325011543670822</link>    <guid>https://juejin.cn/post/7589325011543670822</guid>    <pubDate>2025-12-30T08:01:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589325011543670822" data-draft-id="7578519990284042266" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Git 操作偏门指南：常用和隐藏命令与问题解决"/> <meta itemprop="keywords" content="后端,面试,GitHub"/> <meta itemprop="datePublished" content="2025-12-30T08:01:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="360_go_php"/> <meta itemprop="url" content="https://juejin.cn/user/2436173498956695"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Git 操作偏门指南：常用和隐藏命令与问题解决
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2436173498956695/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    360_go_php
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T08:01:15.000Z" title="Tue Dec 30 2025 08:01:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<p>Git 是一个强大的版本控制工具，广泛用于软件开发和项目管理。在这篇文章中，我们将介绍一些常用的 Git 命令，包括 <code>git log</code>、<code>git diff</code>、<code>tig</code>，以及如何解决 <code>git pull</code> 报错的问题。最后，我们还将讨论如何使用 <code>git checkout .</code> 和 <code>git reset HEAD</code> 来恢复工作区的状态。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34b0ef38f2f84313b6995db6d2436ebc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767686475&amp;x-signature=MIRsHaD3badn6Mno37tRFbMTvGc%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<h2 data-id="heading-0">一、常用 Git 命令<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7dd3225c3d241e4a39c87b1dfff017e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767686475&amp;x-signature=T3o%2FF0vQr9rzI%2FLQLWvmKc8lqkk%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</h2>
<h3 data-id="heading-1">1. <code>git log</code> ,通过q退出</h3>
<p><code>git log</code> 命令用于查看项目的提交历史。它会列出所有提交的记录，包括每次提交的 SHA-1 哈希值、作者、日期和提交信息。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e0dbe03a59040d3aebf475180024324~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767686475&amp;x-signature=%2Fsy9iUcHZGu%2FlnkNOydlpgSdn6Q%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-string">``</span><span class="hljs-string">`bash
git log
`</span><span class="hljs-string">``</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>你可以使用不同的选项来格式化输出，例如：</p>
<pre><code class="hljs language-bash" lang="bash">```bash
git <span class="hljs-built_in">log</span> --oneline  <span class="hljs-comment"># 以简洁的单行格式展示提交历史</span>
git <span class="hljs-built_in">log</span> --graph    <span class="hljs-comment"># 以图形化格式显示分支和合并情况</span>
```
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-2">2. <code>git diff</code> ,通过q退出</h3>
<p><code>git diff</code> 用于查看当前工作目录与最近提交之间的差异。这有助于开发者查看未暂存的改动。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-string">``</span><span class="hljs-string">`bash
git diff mastser
`</span><span class="hljs-string">``</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c505fe4cd2dc4facb4656eaef5b7b31b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767686475&amp;x-signature=icRjutJkrqZpYN7nZnE1S1IAIyQ%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<p>如果你想查看已暂存的文件与最后一次提交之间的差异，可以使用：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-string">``</span><span class="hljs-string">`bash
git diff --cached
`</span><span class="hljs-string">``</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-3">3. <code>tig</code> ,通过contrl+c退出</h3>
<p><code>tig</code> 是一个文本模式的 Git 用户界面，可以在命令行中方便地查看提交历史、分支和差异。首先，你需要安装 <code>tig</code>，然后在终端中运行：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-string">``</span><span class="hljs-string">`bash
tig
`</span><span class="hljs-string">``</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fa66a3401844b64acc20a55e9c7472a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767686475&amp;x-signature=HGKnxQRob5Etp%2FifbDyQ%2FVLqAAA%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<p>通过 <code>tig</code>，你可以直观地浏览提交记录、查看文件差异，并且可以快速执行一些基本的 Git 操作。</p>
<h2 data-id="heading-4">二、解决 Git Pull 报错</h2>
<p>在进行 <code>git pull</code> 操作时，可能会遇到合并冲突或其他错误，导致无法顺利拉取最新代码。此时，你可以尝试以下步骤解决问题。</p>
<h3 data-id="heading-5">1. 使用 <code>git pull</code> 报错<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3058f55658454c8db1befe7a452cb94f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767686475&amp;x-signature=pAbUei9%2BUe%2FrEKW28AgnESGamvg%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</h3>
<p>假设你在执行 <code>git pull</code> 时遇到错误提示，比如：</p>
<pre><code class="hljs language-sql" lang="sql">error: Your <span class="hljs-keyword">local</span> changes <span class="hljs-keyword">to</span> the following files would be overwritten <span class="hljs-keyword">by</span> <span class="hljs-keyword">merge</span>:  
    <span class="hljs-operator">&lt;</span>file_name<span class="hljs-operator">&gt;</span>  
Please <span class="hljs-keyword">commit</span> your changes <span class="hljs-keyword">or</span> stash them before you merge.  
Aborting  
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa56a18d6e9c424cb7e2ed33fa4239ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767686475&amp;x-signature=PaeOgmxwTiw8m47PxlBSVIgsjjQ%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<p>这意味着你的本地工作区有未提交的更改，这些更改与远程仓库的更新存在冲突。</p>
<h3 data-id="heading-6">2. 尝试 <code>git checkout .</code></h3>
<p>很多开发者可能会尝试直接使用 <code>git checkout .</code> 来放弃所有未提交的更改，回到上一个提交的状态：<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38535ce6a4b842c382e4459eed43b78b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767686475&amp;x-signature=txteA0bBgM5IbYSxvUYW44eh7f4%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-string">``</span><span class="hljs-string">`bash
git checkout .
`</span><span class="hljs-string">``</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>然而，有时这个命令可能并不起作用，特别是在某些情况下，可能会提示无法重置文件。</p>
<h3 data-id="heading-7">3. 使用 <code>git reset HEAD</code></h3>
<p>在这种情况下，推荐使用 <code>git reset HEAD</code> 来重置暂存区，然后再执行 <code>git checkout .</code>。这样可以确保工作目录被清理干净，具体步骤如下：<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0c8e1f11e2c44e3bc67b512024606aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767686475&amp;x-signature=0i0igajzvS%2FhNOKiK6%2FO34nkf%2FI%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-string">``</span><span class="hljs-string">`bash
git reset HEAD  # 重置暂存区
git checkout .   # 放弃未提交的更改
`</span><span class="hljs-string">``</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a60167690ba04f6bb8eb7eca871f68e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767686475&amp;x-signature=3ZLil%2BK7ZcxSp83yFRx38y%2BK6Lg%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<p>通过这两个命令，你可以恢复到与最近一次提交相同的状态。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc786066b39248de857480552e4ab010~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767686475&amp;x-signature=fqWWI2gC5Ns0kMn0%2Bu3AWIC7a%2BY%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<h3 data-id="heading-8">4. 再次执行 <code>git pull</code></h3>
<p>在确认工作区已经干净后，再次尝试执行 <code>git pull</code>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-string">``</span><span class="hljs-string">`bash
git pull
`</span><span class="hljs-string">``</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>这时应该能够顺利拉取远程仓库的最新更新。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4486db0206448b88098d956ee7a45a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767686475&amp;x-signature=hyJY2kxRmD%2BD8OpHNbj5Aj1WEkk%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<h3 data-id="heading-9">4.  查看远程分支<code>git branch -r</code>,筛选远程分支git branch -r | grep master2025</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18d26086d5f847c9a52a4ba0e13cb0ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767686475&amp;x-signature=oU3ZgQVNuP%2B7lRReVz4t17Dxudk%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<p> </p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-string">``</span><span class="hljs-string">`bash
git branch -r

git branch -r |grep master2025
`</span><span class="hljs-string">``</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-10">总结</h2>
<p>在 Git 的使用过程中，掌握基本的命令如 <code>git log</code>、<code>git diff</code> 和 <code>tig</code> 可以帮助我们更高效地管理代码。而在处理 <code>git pull</code> 时遇到的冲突和错误时，合理使用 <code>git reset HEAD</code> 和 <code>git checkout .</code> 是解决问题的有效方法。希望这篇文章能帮助你更好地理解和使用 Git！</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[通过程序对接地图api展示旅游数据列表]]></title>    <link>https://juejin.cn/post/7589509638339592218</link>    <guid>https://juejin.cn/post/7589509638339592218</guid>    <pubDate>2025-12-30T08:01:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589509638339592218" data-draft-id="7578714735307259930" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="通过程序对接地图api展示旅游数据列表"/> <meta itemprop="keywords" content="后端,面试,GitHub"/> <meta itemprop="datePublished" content="2025-12-30T08:01:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="360_go_php"/> <meta itemprop="url" content="https://juejin.cn/user/2436173498956695"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            通过程序对接地图api展示旅游数据列表
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2436173498956695/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    360_go_php
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T08:01:57.000Z" title="Tue Dec 30 2025 08:01:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<h2 data-id="heading-0">如何通过地图展示旅游地址列表</h2>
<p>在当今数字化时代，利用地图展示旅游地址信息为用户提供了直观、便捷的体验。在这篇文章中，我们将详细介绍如何获取旅游地址列表数据、对接高德API、编写页面以及最终的访问步骤。<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76e5995b0c7e4d53a840d3bd496555d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767686517&amp;x-signature=gAmzxowuUFNJyUE0Uqy2P%2Bt2Atg%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<h3 data-id="heading-1">一、获取旅游地址列表数据</h3>
<p>首先，需要准备一个包含旅游地址的列表。这个列表可以是来自于数据库、API或者静态文件。示例的数据格式如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">[</span>  
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"故宫"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"latitude"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">39.915</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"longitude"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">116.397</span><span class="hljs-string">"},  
    {"</span>name<span class="hljs-string">": "</span>长城<span class="hljs-string">", "</span>latitude<span class="hljs-string">": 40.431, "</span>longitude<span class="hljs-string">": 116.570},  
    {"</span>name<span class="hljs-string">": "</span>颐和园<span class="hljs-string">", "</span>latitude<span class="hljs-string">": 39.999, "</span>longitude<span class="hljs-string">": 116.275}  
]  
</span></code></pre>
<h3 data-id="heading-2">二、对接高德API</h3>
<p>高德地图提供了一系列API接口，方便开发者在网页或移动应用中使用地图服务。我们需要完成以下步骤以对接高德API：</p>
<h4 data-id="heading-3">1. 注册高德开发者账号</h4>
<p>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fconsole.amap.com%2Fdev%2Fkey%2Fapp" target="_blank" title="https://console.amap.com/dev/key/app" ref="nofollow noopener noreferrer">高德开放平台</a> 注册开发者账号，并创建应用，获取API密钥（Key）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7467337b46204fbfb5a82a34d079ee1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767686517&amp;x-signature=SPO80Rqn1vlmaz16NI0HCPY2M1o%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<h4 data-id="heading-4">2. 引入高德地图API<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba4a0b38b126404ab60d708882cd3f92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767686517&amp;x-signature=iqBRGsJO4dyouAnaxWGP351HXM4%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</h4>
<p>在我们的HTML页面中引入高德地图的JavaScript API。以下是引入代码：</p>
<pre><code class="hljs language-xml" lang="xml">```html
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>旅游地址地图展示<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://webapi.amap.com/maps?v=1.4.15&amp;key=YOUR_API_KEY"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-id">#map</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">500px</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"map"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-comment">// 此处将编写后面的地图逻辑</span>
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>请将 <code>YOUR_API_KEY</code> 替换为你从高德平台获取的实际API密钥。<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dfdbacc639d04db1b6fd296025b607ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767686517&amp;x-signature=RgRu7fvIOEFmkCGp%2BgrwDAQHPFk%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<h3 data-id="heading-5">三、编写页面逻辑</h3>
<p>在地图容器中初始化地图并添加标记，展示旅游地址。以下是完整的JavaScript代码示例：</p>
<p>javascript</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// 初始化地图</span>
    <span class="hljs-keyword">var</span> map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-title class_">Map</span>(<span class="hljs-string">'map'</span>, {
        <span class="hljs-attr">center</span>: [<span class="hljs-number">116.397</span>, <span class="hljs-number">39.915</span>], <span class="hljs-comment">// 默认中心点（北京市）</span>
        <span class="hljs-attr">zoom</span>: <span class="hljs-number">10</span> <span class="hljs-comment">// 默认缩放级别</span>
    });

    <span class="hljs-comment">// 旅游地址列表数据</span>
    <span class="hljs-keyword">var</span> touristSpots = [
        {<span class="hljs-string">"name"</span>: <span class="hljs-string">"故宫"</span>, <span class="hljs-string">"latitude"</span>: <span class="hljs-number">39.915</span>, <span class="hljs-string">"longitude"</span>: <span class="hljs-number">116.397</span>},
        {<span class="hljs-string">"name"</span>: <span class="hljs-string">"长城"</span>, <span class="hljs-string">"latitude"</span>: <span class="hljs-number">40.431</span>, <span class="hljs-string">"longitude"</span>: <span class="hljs-number">116.570</span>},
        {<span class="hljs-string">"name"</span>: <span class="hljs-string">"颐和园"</span>, <span class="hljs-string">"latitude"</span>: <span class="hljs-number">39.999</span>, <span class="hljs-string">"longitude"</span>: <span class="hljs-number">116.275</span>}
    ];

    <span class="hljs-comment">// 添加标记到地图</span>
    touristSpots.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">spot</span>) {
        <span class="hljs-keyword">var</span> marker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-title class_">Marker</span>({
            <span class="hljs-attr">position</span>: [spot.<span class="hljs-property">longitude</span>, spot.<span class="hljs-property">latitude</span>],
            <span class="hljs-attr">title</span>: spot.<span class="hljs-property">name</span>
        });
        marker.<span class="hljs-title function_">setMap</span>(map);
    });
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>这里我们使用了高德地图的 <code>AMap.Map</code> 和 <code>AMap.Marker</code> 类来创建地图和标记。每个旅游景点会根据其经纬度添加到地图上。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1964d3deda54b3eb629890c107a5871~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767686517&amp;x-signature=D2ekRhktIJWBAz1s37Tlow%2FxFs0%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<h3 data-id="heading-6">四、访问与测试</h3>
<p>完成上述步骤之后，保存你的HTML文件并在浏览器中打开。你应该能看到一个显示了多个标记的高德地图，每个标记代表一个旅游地址。点击标记会显示地址名称。<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52cfceca563b4c6a84db93562081f065~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767686517&amp;x-signature=QsCnzCMY%2Fea5UnDIFPO4xaZH6%2FU%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<h4 data-id="heading-7">注意事项：</h4>
<ul>
<li>确保网络连接正常，以便加载高德地图的资源。</li>
<li>根据需要调整地图的中心点和缩放级别，以适应你的需求。</li>
</ul>
<h3 data-id="heading-8">总结</h3>
<p>通过上述步骤，我们成功地将旅游地址列表展示在高德地图上。这种方式不仅增强了用户体验，还提供了良好的视觉效果，方便用户快速了解各旅游目的地的位置和信息。希望能帮助到你！</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文讲清：AI大模型的并行训练方式：DP、PP、TP、EP]]></title>    <link>https://juejin.cn/post/7589207474134843442</link>    <guid>https://juejin.cn/post/7589207474134843442</guid>    <pubDate>2025-12-30T06:13:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589207474134843442" data-draft-id="7589227883262165038" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文讲清：AI大模型的并行训练方式：DP、PP、TP、EP"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-12-30T06:13:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="智泊AI"/> <meta itemprop="url" content="https://juejin.cn/user/3572727470361578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文讲清：AI大模型的并行训练方式：DP、PP、TP、EP
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3572727470361578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    智泊AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T06:13:12.000Z" title="Tue Dec 30 2025 06:13:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家都知道AI计算，特别是模型训练与推理环节，核心依赖于并行计算架构。</p>
<p>在AI的底层算法中，诸如矩阵乘法、卷积运算、循环结构以及梯度反传等关键操作，均需调动成千上万块GPU，通过高度并行的任务调度来高效推进，从而显著压缩整体耗时。</p>
<p>构建高性能并行计算框架时，业界普遍采用以下四种主流策略：</p>
<p>‌Data Parallelism‌，数据并行</p>
<p>‌Pipeline Parallelism‌，流水线并行</p>
<p>‌Tensor Parallelism‌，张量并行</p>
<p>‌Expert Parallelism‌，专家并行</p>
<p>接下来，我们将逐一对这些并行机制的运行逻辑展开解析。</p>
<p><strong>一、DP（数据并行）</strong></p>
<p>首先来看DP，即数据并行（Data Parallelism）。</p>
<p>在AI训练中，并行策略总体上可划分为两大类：数据并行与模型并行。</p>
<p>此前提到的PP（流水线并行）、TP（张量并行）和EP（专家并行），均归属于模型并行的范畴，后续将另行展开说明。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer"><strong>更多AI大模型学习视频及资源，都在智泊AI。</strong></a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/877522e34cec4fc9852eba428d8cf713~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767679992&amp;x-signature=Fd3%2B8jN7EIYgwuVQVD0CpD%2FDlaM%3D" alt="图片" loading="lazy"/></p>
<p>这里，我们先对神经网络的训练流程做一个概览。通俗来讲，其核心环节主要包含以下几个关键阶段：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2105445e9c5f490b8ba56eb29ce744a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767679992&amp;x-signature=vBvB0yJ%2Bh5wthjPBg1HS3%2FAbkbI%3D" alt="图片" loading="lazy"/></p>
<p>前向传播‌：将一批训练样本输入模型，输出对应的预测值。</p>
<p>损失计算‌：利用损失函数量化预测输出与真实标签之间的偏差。</p>
<p>反向传播‌：从损失值出发，沿网络反向计算各参数的梯度。</p>
<p>参数更新‌：优化器依据梯度信息，调整所有权重与偏置（即参数）。</p>
<p>上述步骤持续迭代，直至模型性能满足预期目标，训练即告完成。</p>
<p>再来看‌数据并行‌。</p>
<p>数据并行‌是大模型训练中最普遍采用的并行策略（同样适用于推理阶段）。</p>
<p>其核心理念极为直接：每个GPU均保存一份完整的模型副本，训练数据则被切分为若干小批次（mini-batch），每个批次独立分配至不同GPU并行运算。</p>
<p>在数据并行框架下，大模型的训练流程如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b46ffc8b99343389e557632a7f6261f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767679992&amp;x-signature=zlHS7hSBm5AEgAGtqtb0NE7LL%2Fg%3D" alt="图片" loading="lazy"/></p>
<p>将训练数据均匀分割，分发至多个并行运行的GPU（Worker）上；</p>
<p>每个GPU均持有完全相同的模型架构与参数副本，独立执行前向传播与反向传播，独立计算局部梯度；</p>
<p>各Worker GPU通过节点间通信，采用All-Reduce机制，将本地梯度聚合至一个中心化GPU（Server）；</p>
<p>Server GPU对收拢的所有梯度执行求和或均值运算，生成全局梯度；</p>
<p>Server GPU将全局梯度通过broadcast广播方式，同步回传至每一个Worker GPU，用于更新本地模型权重；更新完成后，所有Worker的模型参数实现严格一致。</p>
<p>随后，该流程循环迭代，直至训练任务完成。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2768ffa4b50a4e3181426fab55b81bb7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767679992&amp;x-signature=hE7vpqj1bFMtISz8rC2%2FeMak5IQ%3D" alt="图片" loading="lazy"/></p>
<p>All-Reduce‌ 是人工智能领域中一个广为人知的概念，其字面含义为“全（All）-规约（Reduce）”，指对各个节点上的数据执行聚合操作（如求和、取最大值），并将聚合后的结果广播至所有节点。</p>
<p>数据并行‌ 的主要优势在于其架构实现相对简洁，能有效提升大规模数据训练的效率，尤其在数据规模远超模型参数量的场景下表现突出。</p>
<p>数据并行‌ 的局限性体现在显存消耗上：每个 GPU 均需加载完整的模型副本，随着模型参数规模持续扩大，所需显存随之增长，极易突破单张 GPU 的显存容量上限。</p>
<p>数据并行‌ 的通信成本同样显著：各 GPU 间需高频同步模型参数或梯度信息；模型参数量越大、参与训练的 GPU 数量越多，通信负担越重。</p>
<p>例如，在 FP16 精度下，千亿参数模型的单次梯度同步需传输约 2TB 数据。</p>
<p><strong>二、ZeRO</strong></p>
<p>这里要插播一个关键概念——ZeRO（Zero Redundancy Optimizer，零冗余优化器）。</p>
<p>在传统数据并行训练中，每个GPU都完整保存模型的全部副本，导致显存消耗巨大。那么，有没有办法让每个GPU仅持有模型的一部分呢？</p>
<p>当然可以。这正是ZeRO的核心思想：将模型副本中的优化器状态、梯度与参数进行分布式切分，从而显著降低单卡内存负担。</p>
<p>ZeRO共包含三个递进阶段：</p>
<p>ZeRO-1‌：仅对优化器状态进行分片</p>
<p>ZeRO-2‌：在ZeRO-1基础上，进一步切分梯度</p>
<p>ZeRO-3‌：全面切分优化器状态、梯度与参数（显存效率最高）</p>
<p>通过下面的图和表，可以看得更明白些：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2d97bc037d14969a9c9925c1a2b6fa1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767679992&amp;x-signature=o4XKJcvuaEasYI9%2FDf4bK6DrkrQ%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4f1e31feafd40f19f8847846c0b0582~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767679992&amp;x-signature=nPmfxy2vTfhzKWVAsDZNedpwuS0%3D" alt="图片" loading="lazy"/></p>
<p>根据实测数据，当使用1024块GPU训练万亿级参数模型时，ZeRO-3将单卡显存占用从7.5TB大幅压缩至7.3GB。</p>
<p>数据并行（DP）的进阶形态为DDP（分布式数据并行）。</p>
<p>传统DP主要适用于单机多卡环境，而DDP则兼具单机与多机部署能力，其核心在于Ring-AllReduce通信机制。</p>
<p>该技术由百度率先提出，能有效缓解数据并行场景下因服务器节点导致的通信负载不均衡问题。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a69ef17f62143c5ac865674f2bdfe9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767679992&amp;x-signature=DTA7hLY0Wo8Ms2Eq5wDqdLjebus%3D" alt="图片" loading="lazy"/></p>
<p><strong>三、PP（流水线并行）</strong></p>
<p>再来看看模型并行。</p>
<p>之前讲过数据并行，是将数据切分成多个分片。而模型并行，顾名思义，是把模型本身拆分成若干部分，由不同的 GPU 分别执行各自负责的模块。</p>
<p>（提示：当前业界对“模型并行”这一术语的界定尚不统一，部分文献中甚至直接用“张量并行”来指代它。）</p>
<p>至于流水线并行，则是把模型的各层——无论是单层还是连续的多层——分布到不同 GPU 上，数据按层序依次传递，形成类似流水线的并行处理流程。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/681d26ef7ebb47109022a0008028f6a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767679992&amp;x-signature=12uAz0KJ6uW7ia2AYofBjpdCI%2FQ%3D" alt="图片" loading="lazy"/></p>
<p>对于一个包含7层的神经网络，可将第1<del>2层分配至第一个GPU，第3</del>5层部署在第二个GPU，第6~7层置于第三个GPU；训练过程中，数据依序在各GPU间传递处理。</p>
<p>表面上，流水并行似乎呈现串行特性——每个GPU必须等待前序GPU完成计算后才能启动，由此可能引发显著的GPU资源闲置。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bf50e31a4904fb2893e3c2c9e5a709c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767679992&amp;x-signature=BXGQ7UGGmrcEXe2YKH8sPiR%2BYC8%3D" alt="图片" loading="lazy"/></p>
<p>图中以黄色标识的区域即为 ‌Bubble‌（气泡）时间。‌Bubble‌ 越密集，表明 ‌GPU‌ 处于等待状态（即空闲）的时间越长，导致计算资源利用率下降。</p>
<p>为缓解此现象，可将单个 ‌mini-batch‌ 进一步划分为多个 ‌micro-batch‌。</p>
<p>当 ‌GPU 0‌ 完成对当前 ‌micro-batch‌ 的计算后，无需等待，立即启动下一 ‌micro-batch‌ 的处理流程，从而有效缩短空闲间隙。</p>
<p>该优化策略的可视化效果如下图（b）‌ 所示。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71b9dcfa2b6f45f39bf54d90f62bb746~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767679992&amp;x-signature=%2BYO8yDvXu%2FSy%2Fgf62ly9a3yJY3I%3D" alt="图片" loading="lazy"/></p>
<p>在完成一个 micro-batch 的前向计算后，立即调度对应的反向计算，从而提前释放部分显存空间，用于加载后续数据，进而提升整体训练效率，如上图（c）所示。</p>
<p>上述策略可有效显著降低流水线并行中的 Bubble 时间。</p>
<p>在流水线并行框架下，必须对任务调度与数据传输实施精准控制，否则将引发流水线停滞，并进一步加剧 Bubble 时间的产生。</p>
<p><strong>四、</strong> <strong>TP（张量并行）</strong></p>
<p>模型并行的另一种形式称为张量并行。</p>
<p>若流水线并行是将模型逐层进行垂直拆分，那么张量并行则是对单层内部的特定运算实施横向切分。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f380e228b2db44249a1639b18256ae49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767679992&amp;x-signature=Pr77jqosvCb06m1S%2B7FYEzyFnAk%3D" alt="图片" loading="lazy"/></p>
<p>张量并行是一种将模型中的张量（如权重矩阵）依据维度划分至多个GPU上并行计算的策略。</p>
<p>其切分机制主要包含两种：‌行切分‌（Row Parallelism），即权重矩阵沿行方向分割；以及‌列切分‌（Column Parallelism），即权重矩阵沿列方向分割。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ad3dda0520f4484afa4435bc24fe970~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767679992&amp;x-signature=2MS1Hk8DvvAh2IRkZkrutKe%2F%2BNQ%3D" alt="图片" loading="lazy"/></p>
<p>每个节点处理切分后的子张量。最后，通过集合通信操作（如All-Gather或All-Reduce）来合并结果。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83ffb39ed5864533b60e0e4ecce614cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767679992&amp;x-signature=ZlqfrdQqfXQuqV%2F%2BoiFN%2Fl2ICqg%3D" alt="图片" loading="lazy"/></p>
<p>张量并行的优势在于应对单个张量规模过大的场景，能有效降低单节点的内存压力。</p>
<p>张量并行的局限在于，随着切分维度的增加，节点间的通信成本显著上升；同时，其工程实现难度较高，需精心规划张量切分策略与通信协调机制。</p>
<p>数据并行、流水线并行、张量并行的简单对比：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d474e0ef5d24902a271e8b76e30a07e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767679992&amp;x-signature=OvT1mgFz2OjEUXcg7K9l5IMfe%2F8%3D" alt="图片" loading="lazy"/></p>
<p><strong>五、专家并行</strong></p>
<p>2025年初，随着DeepSeek的走红，一个术语也随之迅速升温——MoE（Mixture of Experts，混合专家模型）。</p>
<p>MoE模型的精髓在于“多个专家层”与“路由网络（门控网络）”的协同运作。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/693db852a57e4959a532f8997f03eee6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767679992&amp;x-signature=9aWB2188PobN8dZL1jyYegFXeCA%3D" alt="图片" loading="lazy"/></p>
<p>专家层中，每位专家专精于处理某一类token（如语法、语义等）。路由网络依据输入token的特征，动态筛选出少数专家进行激活处理，其余专家保持休眠状态。</p>
<p>MoE通过明确的任务分工与按需调度算力，显著提升了模型的整体运行效率。</p>
<p>专家并行（Expert Parallelism）是MoE（混合专家模型）中的一种并行计算范式，其核心在于将各专家（子模型）部署于不同的GPU节点，从而实现计算负载的分布式承载，优化资源利用率。</p>
<p>相较于传统并行方式，专家并行的根本差异在于：输入数据需经由动态路由机制分发至对应的专家，这一过程引发全节点范围内的数据重分配。</p>
<p>待所有专家完成处理后，必须将分布在各节点的输出结果，严格按照原始输入序列进行重组与归位。</p>
<p>这种跨设备的数据交换模式，被定义为All-to-All通信。</p>
<p>专家并行机制易受负载不均的制约：若某专家接收的token数量超出其处理容量，将导致部分Tokens无法及时处理，进而形成系统瓶颈。</p>
<p>因此，构建高效、均衡的门控机制与专家选择策略，是成功部署专家并行架构的核心前提。</p>
<p><strong>六、混合并行</strong></p>
<p>在实际部署中，尤其是在训练参数规模达万亿级别的超大规模模型时，单一并行方式几乎从不独立使用，取而代之的是融合多种机制的混合并行架构（即协同运用多种并行技术）。</p>
<p>例如：</p>
<p>数据并行 + 张量并行‌：数据并行负责分发训练批次，张量并行则分解单个样本的巨型张量运算。</p>
<p>流水线并行 + 专家并行‌：流水线并行将模型按层切分，专家并行则对每一层内的稀疏专家模块进行独立划分。</p>
<p>更进一步的优化形态是 ‌3D并行‌，即通过“‌数据并行 + 张量并行 + 流水线并行‌”的三维协同拆分，实现计算负载的立体化均衡，已成为当前万亿级模型训练的标准化范式。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19cae3aabe444dccbcb4b52a9b3904c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767679992&amp;x-signature=%2F7jkKkEtiOan8e7tYFBnXIP5VSA%3D" alt="图片" loading="lazy"/></p>
<p><strong>最后</strong></p>
<p>以上就是关于DP、PP、TP、EP等并行训练方式的介绍。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46294590151049cfa9e03ddc29b53135~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767679992&amp;x-signature=cUusszJ30aaApg8UTPZCHWZsxAg%3D" alt="图片" loading="lazy"/></p>
<p>并行计算的复杂性远超表面所见，前述内容仅触及皮毛。然而在实际工程中，开发者无需深究底层实现机制。</p>
<p>得益于 DeepSpeed（微软开源，支持3D并行+ZeRO内存优化）、Megatron-LM（NVIDIA开源，3D并行的标杆）、FSDP 等成熟开源框架，大语言模型的训练已可直接高效开展。</p>
<p>不同并行策略呈现出迥异的通信模式。要最大化训推效率，集群的整体架构与网络规划，必须精准匹配各类并行方式的流量特征。</p>
<p>数据并行‌：因需高频同步梯度参数，对网络带宽构成持续高压，必须保障链路具备支撑海量梯度数据瞬时吞吐的能力，否则通信瓶颈将直接拖慢训练节奏。</p>
<p>流水线并行‌：模型分段在多台服务器间流水线式推进，节点间依赖紧密，宜集中部署于同一叶脊网络的叶节点（leaf）下，以最小化跨机通信延迟。</p>
<p>张量并行‌：通信开销极高，数据切分频繁，最佳实践是将计算负载集中于单台服务器内的多个 GPU 之间，利用高速互联总线降低通信开销。</p>
<p>专家并行‌：各专家模块分布于不同 GPU，其间需频繁交换中间激活值，其通信强度由专家数量与交互频次共同决定，必须精细设计 GPU 互联拓扑与数据通路。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/260daeefbe0c4b76803b9c69e95df144~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767679992&amp;x-signature=X6DiR%2BAl1LqSNCd4BXWES%2F6cY44%3D" alt="图片" loading="lazy"/></p>
<p>综上，在 GPU 单卡算力逼近物理极限的当下，唯有从并行计算的架构与网络层面持续深挖，方能突破性能瓶颈，释放算力集群的真正潜能。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer"><strong>更多AI大模型学习视频及资源，都在智泊AI。</strong></a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[*** 都不用tailwind！！！哎嘛 真香😘😘😘]]></title>    <link>https://juejin.cn/post/7589214643500793919</link>    <guid>https://juejin.cn/post/7589214643500793919</guid>    <pubDate>2025-12-30T06:14:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589214643500793919" data-draft-id="7588996730772242432" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="*** 都不用tailwind！！！哎嘛 真香😘😘😘"/> <meta itemprop="keywords" content="前端,React.js,JavaScript"/> <meta itemprop="datePublished" content="2025-12-30T06:14:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Jay丶"/> <meta itemprop="url" content="https://juejin.cn/user/2419368546022221"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            *** 都不用tailwind！！！哎嘛 真香😘😘😘
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2419368546022221/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Jay丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T06:14:14.000Z" title="Tue Dec 30 2025 06:14:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🎯 前言</h2>
<p>刚入职新公司，老板就给了我一个“惊喜”任务：<br/>
<strong>老板</strong>：“需要根据现有后台系统，做个新的后台系统，好看点、大气点、不要太模板化，对了用 React。”<br/>
<strong>我</strong>：“？？？没有 UI、没有产品。我尼玛*** ***”</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3074f89969248558f1301ebfc594534~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF55Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767680054&amp;x-signature=Jif7Zs5wuXU3B4JzjfWWe%2F9Hrds%3D" alt="下载.jpg" loading="lazy"/></p>
<h2 data-id="heading-1">💩 了解旧版系统</h2>
<p>旧版系统是 Vue3 + ant-design-vue 做的，一个巨大的“屎山”直接丢了过来。几个比较严重的问题：</p>
<ol>
<li><strong>代码质量极差</strong>：完全没有组件化可言，所有页面都是一坨一坨的代码堆在一起</li>
<li><strong>UI 设计极差</strong>：应该也是没有设计师，完全靠前端随意发挥（主题配色红配绿、乱七八糟的字体大小、间距）</li>
<li><strong>功能逻辑混乱</strong>：代码注释极少，完全看不懂业务逻辑</li>
<li><strong>后端也是一坨屎</strong>：接口设计差，前后端配合差，很多东西都是前端做的兼容/硬编码等等</li>
</ol>
<p>代码是老板不知道从哪里弄来的压缩包。如上所示，“屎山”把我压得喘不过气。我有时候真想找到之前写这个代码的人骂一顿（没有 Git 记录也不知道是谁）。这个代码存在的唯一价值就是主流程能跑，或许这就是小公司老板所关心的吧。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10ed31c568c948a49f1dd15c12922284~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF55Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767680054&amp;x-signature=GKFkT3j%2BKsN%2FWGxC1UbyHF3DJ6o%3D" alt="下载 (2).jpg" loading="lazy"/></p>
<h2 data-id="heading-2">🧠 思考架构</h2>
<p>没有 UI、产品，我真的是一头雾水，不知道该如何下手。只能先把旧版系统的功能理清楚，然后一步步实现。因为老板要求用 React，正好我之前用 React 自己搭建了一套后台管理模板（<a href="https://juejin.cn/post/7236168316237414461" target="_blank" title="https://juejin.cn/post/7236168316237414461">文章链接</a>），它是基于 Ant Design 的一套系统，有兴趣的可以去看看。</p>
<h2 data-id="heading-3">🚀 开始实现</h2>
<p>由于我之前搭建的 React 后台模板已经比较完善了，所以我直接拿来用。然后一步步把旧版系统的功能搬过来，并且升级了一些依赖版本等等。老板要求的一个重点是不要太“模板化”，我一直思考应该怎么样去处理和优化。</p>
<p>由于没有设计师，我只能凭借我的审美去调整一些 UI 细节，比如配色、字体、间距、图标等等。总之就是尽量让它看起来不那么像一个模板系统。初版如下图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f11ab5d1ad7463ea70b53ff90928427~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF55Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767680054&amp;x-signature=jxhZkMtUtp%2B1VqIcLkkv9XsHBNw%3D" alt="react_antd_示例图.png" loading="lazy"/></p>
<p>上图的 UI，我都有微调过包括字体、图标、间距等等，让它看起来不那么“模板化”。奈何有天老板从我旁边过，看了一眼说：“你是用的 Antd 吗？能不能搞得不那么模板化，看着还是太大众了。”当时我内心真的想骂人，辛辛苦苦做的工作就这样被一句话否定了，而且又没 UI、又没产品。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d336e00bee443c584b93f5aa26b71ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF55Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767680054&amp;x-signature=CE1fYn1i8aD5CTXv3FJ4URR%2B6xA%3D" alt="下载 (3).jpg" loading="lazy"/></p>
<h2 data-id="heading-4">🔄 重新出发</h2>
<p>没办法，谁让人家是老板，还是照做。我在网上有看到过 shadcn/ui 这个组件库的，它是基于 TailwindCSS，我本人是非常厌恶这个玩意的：</p>
<ol>
<li>因为上一家公司有个同事在项目里使用TailwindCSS，满屏的 classname，看得我头皮发麻。想要改一个样式都不知道从哪下手</li>
<li>shadcn/ui 和我认知里的 Antd Pro 是完全不同的设计体系。比如在 Antd Pro 里写一个表格，请求接口拿到数据喂给 Table 就行了。但是在 shadcn/ui 里你得自己写分页、排序、筛选这些功能。你得自己实现很多功能，会导致我的工作量大增。虽然现在都用 AI 编码了，但是我还是觉得很麻烦</li>
</ol>
<p>但是由于我知道 TailwindCSS 的流行趋势，且确实 shadcn/ui 的可定制化更高一点，所以还是决定用 shadcn/ui 来重构。但是时间紧、任务重，我想从网上找找有没有现成的可以二开的 shadcn 后台模板。结果发现了这个项目：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsatnaing%2Fshadcn-admin" target="_blank" title="https://github.com/satnaing/shadcn-admin" ref="nofollow noopener noreferrer">shadcn-admin</a>。里面封装好了 Table、Layout 等功能且支持移动端。<strong>推荐给各位，太香啦！</strong></p>
<h2 data-id="heading-5">🛠️ 技术栈</h2>
<ul>
<li>React 19</li>
<li>TypeScript</li>
<li>TanStack 家族（@tanstack/react-query、@tanstack/react-router、@tanstack/react-table）</li>
<li>shadcn/ui</li>
<li>TailwindCSS</li>
<li>Zustand</li>
<li>Zod</li>
<li>react-hook-form 等</li>
</ul>
<h2 data-id="heading-6">🔧 集成适配</h2>
<p>虽说是现成的模板，但是有一些功能没有、或者需要根据业务适配。比如国际化、Table 远程数据请求（模板是本地模拟数据）等。</p>
<h2 data-id="heading-7">🎨 最终形态</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82c50450e8594ff5a1b356fab81f2d51~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF55Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767680054&amp;x-signature=cci65FuaEXoApJYutRMzlByE5WE%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-8">📌 总结</h2>
<p>这一套新兴模板，上手还是有点难度的（比如 TanStack 家族、shadcn/ui）。TanStack 体系庞大，shadcn 定制化高（功能都要自己实现）。但是目前 AI 盛行，资料也是大把，相信对你来说也都是小菜一碟。</p>
<h2 data-id="heading-9">💭 最后</h2>
<p>Tailwind 还是挺香的，我觉得它是一把双刃剑。我的前同事（Tailwind 写 class 十几、几十行）确实给维护的人增加心智负担，但是也可以通过一些技术手段改善和优化。这取决于用它的人是怎样的。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/591a47f3842c427aa9328d62a00c4c99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF55Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767680054&amp;x-signature=Z80eUtJKERqYpHxtuNXRErQXo14%3D" alt="下载 (4).jpg" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Apifox 12 月更新｜ AI 生成用例同步生成测试数据、接口文档完整性检测、设计 SSE 流式接口、从 Git 仓库导入数据]]></title>    <link>https://juejin.cn/post/7589220406319562788</link>    <guid>https://juejin.cn/post/7589220406319562788</guid>    <pubDate>2025-12-30T06:22:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589220406319562788" data-draft-id="7589201772133122089" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Apifox 12 月更新｜ AI 生成用例同步生成测试数据、接口文档完整性检测、设计 SSE 流式接口、从 Git 仓库导入数据"/> <meta itemprop="keywords" content="前端,后端,测试"/> <meta itemprop="datePublished" content="2025-12-30T06:22:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Apifox"/> <meta itemprop="url" content="https://juejin.cn/user/2766843870448222"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Apifox 12 月更新｜ AI 生成用例同步生成测试数据、接口文档完整性检测、设计 SSE 流式接口、从 Git 仓库导入数据
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2766843870448222/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Apifox
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T06:22:11.000Z" title="Tue Dec 30 2025 06:22:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Apifox 新版本上线啦！看看本次版本更新主要涵盖的重点内容，有没有你所关注的功能特性：</p>
<ul>
<li><strong>AI 能力再进化</strong>
<ul>
<li>AI 生成测试用例时，支持同时生成匹配用例的测试数据</li>
<li>支持通过 AI 进行接口文档完整性检测</li>
<li>新增支持多个 AI 模型供应商</li>
</ul>
</li>
<li><strong>API 设计与 OpenAPI 规范兼容</strong>
<ul>
<li>设计 API 时，支持 SSE 流式响应及 AI 大模型接口</li>
<li>支持设定 2XX、4XX、5XX、default 等特殊状态码</li>
</ul>
</li>
<li><strong>API 调试能力扩展</strong>
<ul>
<li>支持为环境中各服务配置通用网络代理（HTTP / SOCKS5）</li>
<li>调试 Socket.IO 接口时，支持发送空消息和无参数的消息</li>
<li>支持在输入框直接编辑引用的变量名、动态值表达式</li>
</ul>
</li>
<li><strong>在线文档持续升级</strong>
<ul>
<li>支持自定义背景图案、目录树宽度、多级导航</li>
<li>支持 Algolia 的「Ask AI」功能</li>
</ul>
</li>
<li><strong>导入/导出功能进化</strong>
<ul>
<li>支持从 Git 仓库导入数据</li>
<li>支持导入/导出「响应组件」</li>
</ul>
</li>
<li><strong>用户反馈优化</strong>
<ul>
<li>编辑 Markdown 时，编辑区与预览区同步滚动</li>
<li>解决 Query 参数值为空，选择「不添加等号」时仍会添加等号的问题</li>
<li>解决导入 OpenAPI/Swagger 数据时，如果指定了目录，数据模型会被重复导入的问题</li>
</ul>
</li>
</ul>
<p><strong>将 Apifox 更新至最新版，一起开启全新体验吧！</strong></p>
<h2 data-id="heading-0"><strong>AI 能力再进化</strong></h2>
<h3 data-id="heading-1">AI 生成测试用例时，支持同时生成匹配用例的测试数据</h3>
<p>升级至最新版 Apifox 后，AI 在生成测试用例的同时，会自动生成与用例匹配的测试数据，从而减少手动准备数据的工作量，确保测试数据精准贴合用例场景，提升测试用例的完整性与实用性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7351c3622123486b92fafd8928970aa7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767680531&amp;x-signature=xEvyj0JrqM2cBszE6UxaKO9MolE%3D" alt="AI 生成测试用例时，支持同时生成匹配用例的测试数据" loading="lazy"/></p>
<p>同时，也支持手动为每个测试用例添加或修改对应的测试数据，帮助团队便捷、清晰地管理测试资源。</p>
<h3 data-id="heading-2">支持通过 AI 进行接口文档完整性检测</h3>
<p>Apifox 新增了「接口文档完整性检测」功能，可通过 AI 检测分析接口文档可能存在的信息缺失、描述模糊或规范性不足等问题，帮助团队快速定位潜在问题并提升文档质量与完整性，从而建立更高标准的 API 文档规范。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/242c96d7cc7d463bb88b48fb4e4d43e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767680531&amp;x-signature=cmh%2FoLGacm0N2c2SiWof9w%2BFMrY%3D" alt="支持通过 AI 进行接口文档完整性检测" loading="lazy"/></p>
<h3 data-id="heading-3">新增支持多个 AI 模型供应商</h3>
<p>Apifox 扩展了 AI 模型供应商的支持范围，新增支持月之暗面 Kimi K2 系列、智谱 GLM-4.7 和 MiniMax M2.1 系列模型，为用户提供更丰富的 AI 模型选择，帮助团队根据具体需求挑选最适合的 AI 能力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d81035826cd4408833b44e46df62323~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767680531&amp;x-signature=Jt9SL1aNNIWObonQe6efyY%2B%2FOkM%3D" alt="新增支持多个 AI 模型供应商" loading="lazy"/></p>
<h2 data-id="heading-4">API 设计与 OpenAPI 规范兼容</h2>
<h3 data-id="heading-5">设计 API 时，支持 SSE 流式响应及 AI 大模型接口</h3>
<p>最新版本的 Apifox 新增对 SSE 流式响应和 AI 大模型接口设计的支持，开发者可为 <code>string</code> 类型字段配置「内容结构 <em>（Content Schema）</em> 」，从而能够更精准地定义流式数据的响应结构，为流式数据与 AI 接口提供了完善的文档规范解决方案。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4ae06d1111348a18500c480d5e9f96b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767680531&amp;x-signature=LXDrBrZETqMP6CxxWx5lRxbjcTA%3D" alt="设计 API 时，支持 SSE 流式响应及 AI 大模型接口" loading="lazy"/></p>
<h3 data-id="heading-6">支持设定 2XX、4XX、5XX、default 等特殊状态码</h3>
<p>Apifox 扩展了 API 设计中的状态码支持范围，能够兼容 OpenAPI/Swagger 规范中定义的特殊状态码，如 2XX、4XX、5XX 和 default 等，从而更精确地定义接口的响应行为，灵活处理不同类型的响应场景，为开发者提供更加精细和标准化的接口设计体验。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb3228d9f5464a14af5922c04c256b5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767680531&amp;x-signature=4eGxSNZnm3tgt6NqB%2F7cQy9rSZk%3D" alt="支持设定 2XX、4XX、5XX、default 等特殊状态码" loading="lazy"/></p>
<h2 data-id="heading-7"><strong>API 调试能力扩展</strong></h2>
<h3 data-id="heading-8">支持为环境中各服务配置通用网络代理（HTTP / SOCKS5）</h3>
<p>Apifox 现在支持为环境中每个服务的前置 URL 配置通用网络代理，兼容 HTTP 和 SOCKS5 两种协议。用户可以更好地处理不同网络环境下的接口访问需求，特别适合需要通过代理访问特定服务的场景，从而提升环境管理的灵活性和适应性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9cbcfaa900464ea8b3c0e949894f3928~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767680531&amp;x-signature=Cx%2FWGCgHRdH7ZkLszPSNxvMO0Ws%3D" alt="支持为环境中各服务配置通用网络代理（HTTP / SOCKS5）" loading="lazy"/></p>
<h3 data-id="heading-9">调试 Socket.IO 接口时，支持发送空消息和无参数的消息</h3>
<p>升级至最新版本的 Apifox 后，调试 Socket.IO 接口时，支持发送空消息和无参数消息，使开发者能够全面模拟和测试实时通信的各种场景。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf091ceb1f5c4065a9df59eb547ead95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767680531&amp;x-signature=THuiBKggibV94n1Z%2BEYfohj80Gw%3D" alt="调试 Socket.IO 接口时，支持发送空消息和无参数的消息" loading="lazy"/></p>
<h3 data-id="heading-10">支持在输入框直接编辑引用的变量名、动态值表达式</h3>
<p>现在，用户可以直接在输入框内编辑引用的变量名、动态值表达式，无需切换到其他界面即可完成调整，从而提升配置效率和操作便捷性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52f3abc670d74956a9136d3a1d795fbf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767680531&amp;x-signature=rT97O3l2Tkkh%2F8CmQWKJ0XyfFJ4%3D" alt="支持在输入框直接编辑引用的变量名、动态值表达式" loading="lazy"/></p>
<h2 data-id="heading-11"><strong>在线文档持续升级</strong></h2>
<h3 data-id="heading-12">支持自定义背景图案、目录树宽度、多级导航</h3>
<p>在线文档新增多项个性化设置，支持自定义背景图案及颜色、调整目录树宽度和配置多级导航，让用户能够根据个性化需求，打造独特的文档风格和布局，构建个性化舒适的文档展示方式。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4787e59147fe4dd98523c942985a852a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767680531&amp;x-signature=LcBOWMz7NOivw6EwHn1p8ll8Yhc%3D" alt="支持自定义背景图案、目录树宽度、多级导航" loading="lazy"/></p>
<h3 data-id="heading-13">支持 Algolia 的「Ask AI」功能</h3>
<p>在线文档新上线了 Algolia 的「Ask AI」功能，支持通过 AI 智能问答快速获取所需文档信息。用户可以在搜索框中直接向 AI 提问，快速获取关于文档的准确解答，使 API 文档的查阅和理解变得更加便捷和高效。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5bd9402a35aa4d1dafcbbaf4f5f18705~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767680531&amp;x-signature=nI00gr3ZBqC7hXDMUNQ0H91eoZE%3D" alt="支持 Algolia 的「Ask AI」功能" loading="lazy"/></p>
<h2 data-id="heading-14"><strong>导入/导出功能进化</strong></h2>
<h3 data-id="heading-15">支持从 Git 仓库导入数据</h3>
<p>Apifox 更新至最新版本后，支持从 GitHub、GitLab 仓库等主流代码托管平台导入 OpenAPI/Swagger 文件，方便团队高效同步并集中管理分散在各平台的 API 文档，简化文档集成流程，全面提升团队协作效率。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a051bbfb32448f2855ecacfc8280ebd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767680531&amp;x-signature=HgCoa56IYt46uA8KpwHlCN9lHFE%3D" alt="支持从 Git 仓库导入数据" loading="lazy"/></p>
<h3 data-id="heading-16">支持导入/导出「响应组件」</h3>
<p>现在导入/导出 OpenAPI/Swagger 数据时，能够同时导入/导出响应组件，确保团队可以正确复用与共享标准化响应定义，提升 API 文档的一致性和维护效率。</p>
<h2 data-id="heading-17">用户反馈优化</h2>
<h3 data-id="heading-18">编辑 Markdown 时，编辑区与预览区同步滚动</h3>
<p>根据用户反馈，Apifox 优化了 Markdown 编辑体验。当左侧编辑区域滚动时，右侧预览区域将自动同步滚动，使文档编辑与预览更加流畅自然，提升使用体验。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/439e0e3570eb4f2483d5413601df6cc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767680531&amp;x-signature=k%2BPUVk6052pnqQ1hY%2FgDnEg1A0o%3D" alt="编辑 Markdown 时，编辑区与预览区同步滚动" loading="lazy"/></p>
<h3 data-id="heading-19">解决 Query 参数值为空，选择「不添加等号」时仍会添加等号的问题</h3>
<p>当 Query 参数为空且选择「不添加等号」选项时，Apifox 现已能够正确处理，避免错误添加等号，确保参数构建准确，符合用户实际配置需求。</p>
<h3 data-id="heading-20">解决导入 OpenAPI/Swagger 数据时，如果指定了目录，数据模型会被重复导入的问题</h3>
<p>我们修复了用户反馈的问题：在导入 OpenAPI/Swagger 数据时，若指定了目录，数据模型将不会重复导入，从而确保导入过程更加准确，避免生成冗余数据，保持文档结构清晰高效。</p>
<h2 data-id="heading-21"><strong>了解更多</strong></h2>
<p>当然，Apifox 产品团队为大家带来的新功能远不止以上这些：</p>
<ul>
<li>密钥库支持 Client Credentials 授权模式</li>
<li>导出 Apifox 格式数据时，包含接口的测试用例</li>
<li>导出 Apifox 格式数据时，包含 WebSocket 和 Socket.IO 接口的前置 URL</li>
<li>优化了 AI 相关功能的报错信息，更清晰明确</li>
<li>提升 AI 生成测试用例的指令遵循效果</li>
<li>配置 AI 模型供应商时，可以选择 DeepSeek V3.2 Exp 系列新模型</li>
<li>优化了在环境管理配置前置 URL 的交互</li>
<li>优化了自动化测试编排模式的交互</li>
<li>解决新建接口后发送请求，如果请求未成功，就无法保存接口的问题</li>
<li>解决导入数据时选择智能合并，参数的示例值被错误覆盖的问题</li>
<li>解决在网页版 App 添加 Runner 时，如果服务器是  <code>http://</code>  协议就无法保存的问题</li>
<li>解决测试用例 GraphQL 请求体高度无限增长的问题</li>
<li>解决 AI 生成测试用例抽屉层级的问题</li>
<li>解决调试 Socket.IO 接口时，选择 JSON，无法正常发送 0、false 等内容的问题</li>
</ul>
<p>除了新增功能，我们也对产品细节和使用体验进行了优化，<strong>具体修改内容可前往 Apifox 更新日志查看</strong>。</p>
<p>欢迎各位用户对 Apifox 继续提出使用反馈和优化意见，我们会持续优化更新，致力于为用户提供更优秀的产品功能和更极致的使用体验！</p>
<p>可以前往<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.apifox.com%2F%3Futm_source%3Dself%26utm_medium%3Dapifox" target="_blank" title="https://docs.apifox.com/?utm_source=self&amp;utm_medium=apifox" ref="nofollow noopener noreferrer">帮助文档</a>查看更多功能使用说明和操作，有任何问题欢迎在<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.apifox.com%2Fdoc-5751209%23%25E7%2594%25A8%25E6%2588%25B7%25E7%25BE%25A4%2F%3Futm_source%3Dself%26utm_medium%3Dapifox" target="_blank" title="https://docs.apifox.com/doc-5751209#%E7%94%A8%E6%88%B7%E7%BE%A4/?utm_source=self&amp;utm_medium=apifox" ref="nofollow noopener noreferrer">Apifox 用户群</a>与我们交流沟通。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[浏览器处理Base64数据的速度有多快？]]></title>    <link>https://juejin.cn/post/7589220406319743012</link>    <guid>https://juejin.cn/post/7589220406319743012</guid>    <pubDate>2025-12-30T06:32:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589220406319743012" data-draft-id="7589214643500957759" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="浏览器处理Base64数据的速度有多快？"/> <meta itemprop="keywords" content="前端,JavaScript,GitHub"/> <meta itemprop="datePublished" content="2025-12-30T06:32:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金安东尼"/> <meta itemprop="url" content="https://juejin.cn/user/1521379823340792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            浏览器处理Base64数据的速度有多快？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379823340792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金安东尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T06:32:45.000Z" title="Tue Dec 30 2025 06:32:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Flemire.me%2Fblog%2F2025%2F11%2F29%2Fhow-fast-can-browsers-process-base64-data%2F" target="_blank" title="https://lemire.me/blog/2025/11/29/how-fast-can-browsers-process-base64-data/" ref="nofollow noopener noreferrer">How fast can browsers process base64 data?</a></p>
<p>日期：2025年11月30</p>
<p>翻译：田八</p>
<p>来源：<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn" title="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn" target="_blank">前端周刊</a></p>
</blockquote>
<p>Base64是一种二进制到文本的编码方案，它使用由64个字符组成的字母表（A - Z、a - z、0 - 9、+、/），将任意二进制数据（如图像、文件或任何字节序列）转换为安全、可打印的 <code>ASCII</code>字符串。浏览器在 <code>JavaScript</code>中会用到它，用于将二进制数据直接嵌入代码或 <code>HTML</code>中，或者以文本形式传输二进制数据。</p>
<p>最近，浏览器新增了处理Base64的便捷且安全的方法，即 <code>Uint8Array.toBase64()</code>和 <code>Uint8Array.fromBase64()</code>。尽管涉及多个参数，但归根结底就是编码和解码这两个函数。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> b64 = <span class="hljs-title class_">Uint8Array</span>.<span class="hljs-title function_">toBase64</span>(bytes);      <span class="hljs-comment">// 字符串        </span>
<span class="hljs-keyword">const</span> recovered = <span class="hljs-title class_">Uint8Array</span>.<span class="hljs-title function_">fromBase64</span>(b64); <span class="hljs-comment">// Uint8Array</span>
</code></pre>
<p>编码时，它从输入中取出24位数据。这24位数据被分成四个6位段，每个6位值（范围在0到63之间）会被映射到 <code>Base64</code>字母表中的特定字符：前26个字符是大写字母 <code>A-Z</code>，接下来的26个是小写字母 <code>a-z</code>，然后是数字 <code>0 - 9</code>，接着是第62个字符（+）和第63个字符（/）。当输入长度不是3字节的倍数时，会使用等号（=）作为填充字符。</p>
<p>它们的速度能有多快呢？</p>
<p>假设每个 <code>CPU</code>周期处理3字节输入并生成4字节输出。在 <code>4.5GHz</code>的频率下，编码成 <code>Base64</code>的速度将达到 <code>13.5GB/s</code>。我们预期反向操作（解码）的性能会低一些。编码时，任何输入都是有效的，任何二进制数据都可以。然而，解码时，我们必须处理错误并跳过空格。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fsimdutf.github.io%2Fbrowserbase64%2F" target="_blank" title="https://simdutf.github.io/browserbase64/" ref="nofollow noopener noreferrer">我编写了一个浏览器内的基准测试程序</a>。你可以在自己喜欢的浏览器中尝试一下。</p>
<p>我决定在我的苹果M4处理器上测试一下，看看不同浏览器的表现如何。我使用 <code>64KB</code>的数据块进行测试。速度是针对二进制数据来测量的。</p>













































<table><thead><tr><th>浏览器</th><th>编码速度</th><th>解码速度</th></tr></thead><tbody><tr><td>Safari</td><td>17GB/s</td><td>9.4GB/s</td></tr><tr><td>SigmaOS</td><td>17GB/s</td><td>9.4GB/s</td></tr><tr><td>Chrome</td><td>19GB/s</td><td>4.6GB/s</td></tr><tr><td>Edge</td><td>19GB/s</td><td>4.6GB/s</td></tr><tr><td>Brave</td><td>19GB/s</td><td>4.6GB/s</td></tr><tr><td>Servo</td><td>0.34GB/s</td><td>0.40GB/s</td></tr><tr><td>Firefox</td><td>0.34GB/s</td><td>0.40GB/s</td></tr></tbody></table>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04d8fa592fdc4163ba7c43773443a96d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681164&amp;x-signature=MWGwGQ41cyCimVTWmJ2kfV9U39o%3D" alt="image.png" loading="lazy"/></p>
<p><code>Safari</code>的编码速度似乎比基于 <code>Chromium</code>的浏览器（<code>Chrome</code>、<code>Edge</code>、<code>Brave</code>）稍慢，但其解码速度大约是这些浏览器的两倍。<code>Servo</code>和 <code>Firefox</code>的性能同样不佳，而且出现了意想不到的结果，即它们的解码速度比编码速度快。我本可以测试其他浏览器，但大多数浏览器似乎是 <code>Chromium</code>或 <code>WebKit</code>的衍生版本。</p>
<p>作为参考，一台性能不错的笔记本电脑的磁盘读写速度可持续超过 <code>3GB/s</code>。一些高端笔记本电脑的磁盘速度超过 <code>5GB/s</code>。理论上，使用 <code>Wi-Fi 7</code>时，你的 <code>Wi-Fi</code>连接速度可能接近 <code>5GB/s</code>。一些互联网服务提供商可能提供类似的网络速度，尽管你的互联网连接速度可能比这慢几倍。</p>
<p>大多数浏览器的速度比你想象的要快得多。它们的速度比网络或磁盘速度还要快。</p>
<p><strong>注意：</strong> 基于 <code>Chromium</code>的浏览器解码速度较慢，这似乎与 <code>v8 JavaScript</code>引擎有关，该引擎会先将字符串解码到一个临时缓冲区，然后再从临时缓冲区复制到最终目标位置。（参见v8/src/builtins/builtins-typed-array.cc中的BUILTIN(Uint8ArrayFromBase64)。）</p>
<p><strong>注：</strong> <code>Mozilla</code>的 <code>Denis Palmeiro</code>告诉我，<code>Firefox</code>即将进行的更新将加快Base64函数的性能。我在 <code>Firefox nightly</code> 版本中测试发现，性能提高了约 <code>20%</code>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为不同场景设计多样化的页面过渡动画]]></title>    <link>https://juejin.cn/post/7589212818806603839</link>    <guid>https://juejin.cn/post/7589212818806603839</guid>    <pubDate>2025-12-30T06:34:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589212818806603839" data-draft-id="7589214643501006911" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为不同场景设计多样化的页面过渡动画"/> <meta itemprop="keywords" content="前端,JavaScript,GitHub"/> <meta itemprop="datePublished" content="2025-12-30T06:34:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金安东尼"/> <meta itemprop="url" content="https://juejin.cn/user/1521379823340792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为不同场景设计多样化的页面过渡动画
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379823340792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金安东尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T06:34:23.000Z" title="Tue Dec 30 2025 06:34:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>原文
：<a href="https://link.juejin.cn?target=https%3A%2F%2Ffrontendmasters.com%2Fblog%2Fdifferent-page-transitions-for-different-circumstances%2F" target="_blank" title="https://frontendmasters.com/blog/different-page-transitions-for-different-circumstances/" ref="nofollow noopener noreferrer">Different Page Transitions For Different Circumstances</a></p>
<p>翻译：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.heyfe.org%2Fblog" target="_blank" title="https://blog.heyfe.org/blog" ref="nofollow noopener noreferrer">嘿嘿</a></p>
<p>来源：<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn" title="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn" target="_blank">前端周刊</a></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/521575c6ce2a46b9ac1ca9a8602214c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681262&amp;x-signature=Vx5aj3MgZkyJC47BSXeUFsFR6pA%3D" alt="image.png" loading="lazy"/></p>
<p>我感觉多页面视图过渡的常见用法，通常是搭建一个通用的系统，让它适用于所有页面和元素，然后就可以不用管了。</p>
<p>但我最近看到了 JavaScript 中有相关的 DOM 事件，以及如何利用它们来设置“类型”（过渡的类型）。我们先来看看这些事件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 旧页面 / 正在卸载的页面</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'pageswap'</span>, <span class="hljs-keyword">async</span> (e) =&gt; {
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">viewTransition</span>) {

  }
}

<span class="hljs-comment">// 新页面 / 正在加载的页面</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'pagereveal'</span>, <span class="hljs-keyword">async</span> (e) =&gt; {
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">viewTransition</span>) {

  }
}
</code></pre>
<p>你可以在事件处理器里做任何你想做的事情，但对我来说特别有趣的一点是，你可以设置视图过渡的类型，并且能够 <em>有条件地</em> 设置。</p>
<h2 data-id="heading-0">为特定 URL 自定义视图过渡类型</h2>
<p>为了清晰地说明这一点，假设你想让某个特定页面的过渡动画与其他所有页面都不一样。比如，某个网站上相对路径为 <code>/shows</code> 的“演出”页面。那么我们就可以监听
<code>pagereveal</code> 事件，并检查当前 URL，如果匹配就设置对应的类型：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'pagereveal'</span>, <span class="hljs-keyword">async</span> e =&gt; {
    <span class="hljs-keyword">if</span> (e.<span class="hljs-property">viewTransition</span> &amp;&amp; <span class="hljs-variable language_">document</span>.<span class="hljs-property">location</span>.<span class="hljs-property">pathname</span> === <span class="hljs-string">'/shows'</span>) {
        e.<span class="hljs-property">viewTransition</span>.<span class="hljs-property">types</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'toShowsPage'</span>);
    }
});
</code></pre>
<p>这里的 <code>toShowsPage</code> 只是一个我们随便起的名字，用来在 CSS 中设置对应的自定义动画。</p>
<h2 data-id="heading-1">“默认”视图过渡</h2>
<p>我们已经设置了一个自定义类型，但先来把默认的动画搭好。类似下面这样的效果就挺优雅的：</p>
<pre><code class="hljs language-css" lang="css">::<span class="hljs-built_in">view-transition-old</span>(main) {
    <span class="hljs-attribute">animation-name</span>: slide-out-to-left;
    <span class="hljs-attribute">animation-duration</span>: <span class="hljs-number">1s</span>;
}
::<span class="hljs-built_in">view-transition-new</span>(main) {
    <span class="hljs-attribute">animation-name</span>: slide-in-from-right;
    <span class="hljs-attribute">animation-duration</span>: <span class="hljs-number">1s</span>;
}

<span class="hljs-keyword">@keyframes</span> slide-out-to-left {
    <span class="hljs-selector-tag">to</span> {
        translate: -<span class="hljs-number">150px</span> <span class="hljs-number">0</span>;
        <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>;
        scale: <span class="hljs-number">0.5</span>;
    }
}
<span class="hljs-keyword">@keyframes</span> slide-in-from-right {
    <span class="hljs-selector-tag">from</span> {
        translate: <span class="hljs-number">100</span>vi <span class="hljs-number">0</span>;
    }
}
</code></pre>
<p>在我的这个例子里，假设有一个内容区域 <code>&lt;main&gt;</code> 设置了 <code>view-transition-name: main;</code>，所以这个元素在这里就是被专门指定的目标。现在，当我切换页面（仅仅点
击普通的旧链接）时，就会得到这个效果：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fvideopress.com%2Fembed%2FekBvCWFC%3Fcover%3D1%26amp%3BautoPlay%3D0%26amp%3Bcontrols%3D1%26amp%3Bloop%3D0%26amp%3Bmuted%3D0%26amp%3BpersistVolume%3D1%26amp%3Bplaysinline%3D0%26amp%3BpreloadContent%3Dmetadata%26amp%3BuseAverageColor%3D1%26amp%3Bhd%3D0" target="_blank" title="https://videopress.com/embed/ekBvCWFC?cover=1&amp;amp;autoPlay=0&amp;amp;controls=1&amp;amp;loop=0&amp;amp;muted=0&amp;amp;persistVolume=1&amp;amp;playsinline=0&amp;amp;preloadContent=metadata&amp;amp;useAverageColor=1&amp;amp;hd=0" ref="nofollow noopener noreferrer">videopress.com/embed/ekBvC…</a></p>
<h2 data-id="heading-2">为自定义动画使用自定义类型</h2>
<p>当点击“Shows”链接并加载 <code>/shows</code> 页面时，我们设置了 “toShowsPage” 类型，而这就是 CSS 中展现效果的神奇时刻：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">html</span><span class="hljs-selector-pseudo">:active</span>-view-<span class="hljs-attribute">transition</span>-type(toShowsPage) {
    &amp;::<span class="hljs-built_in">view-transition-new</span>(main) {
        <span class="hljs-attribute">animation</span>: to-shows-page <span class="hljs-number">1s</span> forwards;
    }
}

<span class="hljs-keyword">@keyframes</span> to-shows-page {
    <span class="hljs-selector-tag">from</span> {
        scale: <span class="hljs-number">1.1</span>;
        translate: <span class="hljs-number">0</span> -<span class="hljs-number">200px</span>;
    }
}
</code></pre>
<p>因为它比单纯的 <code>::view-transition-new</code> 具有更高的优先级，这让我们有机会用一组新的关键帧来 <em>覆盖</em> 默认的 <code>animation</code>。现在，<em>只有</em> 演出页面会从顶部下来
。看看区别：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fvideopress.com%2Fembed%2FrE06avRv%3Fcover%3D1%26amp%3BautoPlay%3D0%26amp%3Bcontrols%3D1%26amp%3Bloop%3D0%26amp%3Bmuted%3D0%26amp%3BpersistVolume%3D1%26amp%3Bplaysinline%3D0%26amp%3BpreloadContent%3Dmetadata%26amp%3BuseAverageColor%3D1%26amp%3Bhd%3D0" target="_blank" title="https://videopress.com/embed/rE06avRv?cover=1&amp;amp;autoPlay=0&amp;amp;controls=1&amp;amp;loop=0&amp;amp;muted=0&amp;amp;persistVolume=1&amp;amp;playsinline=0&amp;amp;preloadContent=metadata&amp;amp;useAverageColor=1&amp;amp;hd=0" ref="nofollow noopener noreferrer">videopress.com/embed/rE06a…</a></p>
<h2 data-id="heading-3">补充说明</h2>
<p>我认为这种通过 JavaScript 和 CSS 实现的精细控制交互非常酷。</p>
<p>我最初是在 Bramus 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.chrome.com%2Fdocs%2Fweb-platform%2Fview-transitions%2Fcross-document" target="_blank" title="https://developer.chrome.com/docs/web-platform/view-transitions/cross-document" ref="nofollow noopener noreferrer">《多页面应用中的跨文档视图过渡》</a> 中看到这个的，
这是一份很好的文章，涵盖了“前进”、“后退”和“重新加载”的视图过渡类型，这些看起来非常实用，让我希望有原生的 CSS 方法来检测它们。</p>
<p>CSS 确实有一个原生的方式来
<a href="https://link.juejin.cn?target=https%3A%2F%2Fcss-tricks.com%2Falmanac%2Frules%2Fv%2Fview-transition%2F%23aa-limiting-view-transitions-with-the-types-descriptor" target="_blank" title="https://css-tricks.com/almanac/rules/v/view-transition/#aa-limiting-view-transitions-with-the-types-descriptor" ref="nofollow noopener noreferrer"><em>声明</em> 类型</a>，但我还不太明白这样做有
什么用处或重要性。我目前的理解是，如果你声明了类型，那么任何 <em>未</em> 在列表中列出的类型都会被设为无效，也许这在某些情况下是有用的？</p>
<p>我曾以为“类型”相关的功能会比视图过渡的其他部分更新一些，因此浏览器支持度会更低，但事实并非如此。MDN 将
<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FViewTransitionTypeSet" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/API/ViewTransitionTypeSet" ref="nofollow noopener noreferrer">JavaScript 类型设置</a> 以及 CSS 选择器
<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FCSS%2FReference%2FSelectors%2F%3Aactive-view-transition-type" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/CSS/Reference/Selectors/:active-view-transition-type" ref="nofollow noopener noreferrer"><code>:active-view-transition-type()</code></a> 的浏览器支持度标
记为与多页面视图过渡整体相同，也就是说，Chrome 和 Safari 已支持，Firefox 则处于标志启用状态（即将发布支持）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vercel：我们为 React2Shell 发起了一项价值 100 万美元的黑客挑战]]></title>    <link>https://juejin.cn/post/7589220406319808548</link>    <guid>https://juejin.cn/post/7589220406319808548</guid>    <pubDate>2025-12-30T06:37:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589220406319808548" data-draft-id="7589201772134432809" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vercel：我们为 React2Shell 发起了一项价值 100 万美元的黑客挑战"/> <meta itemprop="keywords" content="前端,JavaScript,GitHub"/> <meta itemprop="datePublished" content="2025-12-30T06:37:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金安东尼"/> <meta itemprop="url" content="https://juejin.cn/user/1521379823340792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vercel：我们为 React2Shell 发起了一项价值 100 万美元的黑客挑战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379823340792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金安东尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T06:37:56.000Z" title="Tue Dec 30 2025 06:37:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fvercel.com%2Fblog%2Four-million-dollar-hacker-challenge-for-react2shell" target="_blank" title="https://vercel.com/blog/our-million-dollar-hacker-challenge-for-react2shell" ref="nofollow noopener noreferrer">Our $1 million hacker challenge for React2Shell</a></p>
<p>翻译：田八</p>
<p>来源：<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn" title="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn" target="_blank">前端周刊</a></p>
</blockquote>
<p>在 <code>React2Shell</code>漏洞披露后的数周内，我们的防火墙拦截了超过600万次针对运行存在漏洞版本 <code>Next.js</code>部署的攻击尝试，其中在高峰期的24小时内就拦截了230万次。</p>
<p>这得益于 <code>Seawall</code>，它是 <code>Vercel Web</code>应用防火墙（<code>WAF</code>）的深度请求检测层。我们与116名安全研究人员合作，找出他们能想到的所有 <code>WAF</code>绕过方法，支付了超过100万美元的赏金，并在48小时内发布了20个独特的 <code>WAF</code>更新，因为不断有新方法被报告。他们发现的绕过技术现已永久集成到我们的防火墙，保护着平台上的每一项部署。</p>
<p>但 <code>WAF</code>规则只是第一道防线。 <strong>现在，我们首次披露了 <code>Vercel</code>平台上针对远程代码执行（<code>RCE</code>）的另一层深度防御措施，</strong> 该措施直接作用于计算层。这层深度防御提供的数据让我们有十足把握称，<code>WAF</code>在抵御 <code>React2Shell</code>漏洞利用方面极为有效。</p>
<p>本文将介绍我们为保护客户所构建的防护措施，以及这对 <code>Vercel</code>未来安全意味着什么。</p>
<h2 data-id="heading-0">我们正在防御的是什么</h2>
<p>这个看起来怪异的攻击载荷让整个行业许多人都夜不能寐：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-number">0</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    status<span class="hljs-punctuation">:</span> <span class="hljs-string">"resolved_model"</span><span class="hljs-punctuation">,</span>
    reason<span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
    _response<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      _prefix<span class="hljs-punctuation">:</span> <span class="hljs-string">"console.log('☠️')//"</span><span class="hljs-punctuation">,</span>
      _formData<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        get<span class="hljs-punctuation">:</span> <span class="hljs-string">"$1:then:constructor"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    then<span class="hljs-punctuation">:</span> <span class="hljs-string">"$1:then"</span><span class="hljs-punctuation">,</span>
    value<span class="hljs-punctuation">:</span> '<span class="hljs-punctuation">{</span><span class="hljs-attr">"then"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"$B"</span><span class="hljs-punctuation">}</span>'<span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-number">1</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"$@0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
React2Shell漏洞利用示例概念验证（PoC）
<p>这就是 <code>React2Shell</code>攻击载荷。将其发送到任何运行存在漏洞的 <code>React</code>服务器组件的服务器上，<code>console.log('☠️')</code>字符串就会在服务器端执行。这个字符串可以被替换成几乎任何内容，比如运行程序、提取机密信息、发起网络调用。<code>CVE-2025-55182</code>的严重程度评分为10.0分（满分10分），情况糟糕透顶。</p>
<p>在 <code>CVE</code>被负责任地披露后，倒计时开始。我们知道恶意攻击者会争分夺秒地利用该漏洞，因此在公众知晓问题之前，我们就与 <code>AWS</code>、<code>Google</code>、<code>Microsoft</code>、<code>Cloudflare</code>、<code>Netlify</code>、<code>Fastly</code>、<code>Deno</code>等行业合作伙伴展开合作。这种相互协作意味着，在协调一致的公开披露之前，所有主要平台提供商都已采取了缓解措施，确保在他们发布补丁之前，尽可能多的用户都得到了保护。</p>
<p>但我们也知道接下来会发生什么。一旦漏洞被披露，安全研究人员、恶意攻击者和好奇的旁观者会开始检查受影响的代码路径，寻找绕过方法和相关漏洞。几天内，研究人员就在 <code>React</code>服务器组件中发现了另外两个漏洞，需要更多补丁和 <code>WAF</code>更新。</p>
在公开披露后的前 72 小时内阻止了利用漏洞的尝试
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9f580650fc04a99a6491a0e091a6e87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681476&amp;x-signature=OOPJWXpp0kcT81%2BR80oytszhe%2FM%3D" alt="react2shell_blocked_requests_spike_graph--light.svg" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/807b64a99998445db1eda88f73ebe82e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681476&amp;x-signature=465YGW5i3sIxR%2F%2FfeZmxgJAu0dA%3D" alt="react2shell_longer_view_graph2--light.svg" loading="lazy"/></p>
接下来一周内阻止了多次攻击尝试。
<p>我们需要能够适应变化的防御措施。</p>
<h2 data-id="heading-1">5万美元的赏金</h2>
<p>与其等待 <code>WAF</code> 绕过漏洞在网络上出现，我们决定掌控补丁周期，并聘请世界上最好的安全研究人员为我们率先发现这些漏洞。</p>
<p>在做出决定后的几小时内，我们就在 <code>HackerOne</code>上启动了公开的漏洞赏金计划。通常启动这样一个计划需要数周时间，<code>HackerOne</code>团队夜以继日地工作才得以实现。据联合创始人米希尔·普林斯（<code>Michiel Prins</code>）称，这是他们历史上最快的公开计划启动之一。</p>
<p>我们为每一种能绕过我们 <code>WAF</code>防护的独特技术提供5万美元赏金。这笔赏金故意设置得很高，目的是引导研究人员将精力转向负责任的披露，而非在黑市上售卖，同时让那些原本会试探我们防御的人成为我们的合作者。</p>
<p>该计划奏效了。116名研究人员参与其中，提交了156份报告。计划结束时，我们验证了38份负责任的披露报告，为20种独特的绕过技术支付了100万美元赏金。我们将这些技术分享给了其他平台提供商，以便他们加强自身防御。我们的所学不仅保护了 <code>Vercel</code>的客户。</p>
<h2 data-id="heading-2">Seawall：强化我们的WAF</h2>
<p><code>Seawall</code>是我们 <code>WAF</code>的深度请求检查层，检查请求载荷而不仅仅是请求头，在恶意模式到达您的应用之前就将其拦截。</p>
<p>每次收到 <code>HackerOne</code>的报告后，我们都会遵循一个可重复的流程：重现绕过方法；将其转化为测试用例；更新规则以拦截该方法；全球部署；等待下一份报告；重复。在赏金计划启动后的头48小时内，我们为 <code>Seawall</code>发布了20次更新，随着流程的优化，每个发现的平均响应时间从两小时缩短到三十分钟。</p>
<p>大多数报告在头24小时内提交，研究人员测试各种新奇变体。第二个24小时内提交的报告数量较少。随后几天，随着人们深入挖掘边缘情况，提交的报告数量逐渐减少，涉及的技术也越来越复杂。</p>
<p>让我们惊讶的是，人工智能在重现报告方面非常有用。提交内容通常依赖于细微差别，这些差别很容易被忽略，而且利用条件可能非常特定。现代人工智能模型非常善于梳理出这些细节，并将其转化为可重现的测试用例。每个验证通过的报告都变成了一个基于 <code>Go语言</code>的单元测试，现在每当 <code>Seawall</code>发生变化时，这些测试都会在持续集成（<code>CI</code>）环境中运行。研究人员在此次漏洞赏金计划中发现的技术，即使在赏金计划结束后，也将继续为用户提供保护。</p>
<h2 data-id="heading-3">进一步加强我们的深度防御策略</h2>
<p>为进一步保护客户，我们部署了第二层防御措施，直接作用于计算层。这个运行时缓解层在应用内部运行，而非在 <code>WAF</code>层。因此，它不依赖启发式规则，而是直接消除攻击所针对的代码评估途径。</p>
<p><code>React2Shell</code>利用了 <code>JavaScript</code>函数具有 <code>constructor</code>属性，该属性可用于在运行时评估代码。运行时缓解措施在 <code>React</code>渲染过程中禁止这种代码执行，从根本上破坏了攻击途径。我们预计合法应用永远不会使用这种能力，在试用该缓解措施时，我们未发现任何实际应用会触及此代码路径，因此我们知道部署它是安全的。</p>
<p><code>Deno</code>团队率先部署了运行时缓解措施，他们乐于分享细节，这让我们对之前探索的方向更有信心。我们针对 <code>Node.js</code>调整了实现方式，在大规模验证其部署安全性后，又将其分享给其他平台提供商，让他们也能从中受益。</p>
<p>我们设置了专用日志记录，以便在运行时缓解措施触发时立即启动，并自动向安全团队发出警报。如果攻击者找到一种在生产环境中实际有效的 <code>WAF</code>绕过方法，运行时缓解措施会将其捕获，我们也会立即知晓。</p>
<p>如今，这一缓解措施覆盖了 <code>Vercel</code>上96%的流量。通过第二层防御措施的日志记录，我们实际上知道 <code>WAF</code>在实践中何时被绕过，因此我们有十足把握称，<code>Vercel</code>的 <code>WAF</code>在抵御 <code>React2Shell</code>漏洞利用方面极为有效。</p>
<h2 data-id="heading-4">阻止最复杂的绕过方法</h2>
<p><code>HackerOne</code>项目吸引了来自世界各地的优秀研究人员。感谢所有参与者，是你们的付出让 <code>Seawall</code>变得更加强大。</p>
<p>保护 <code>React2Shell</code>免受攻击的 <code>WAF</code>的核心任务是识别恶意载荷，同时允许合法载荷通过。由于无法实际执行恶意代码进行检查，因此必须依靠模式匹配和解析。对于研究人员来说，这意味着要找到隐藏攻击以躲避模式匹配的方法。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flachlan2k%2F" target="_blank" title="https://github.com/lachlan2k/" ref="nofollow noopener noreferrer">拉赫兰·戴维森（<code>Lachlan Davidson</code>）</a>是 <code>React2Shell</code>的最初发现者，他和研究伙伴<a href="https://link.juejin.cn?target=https%3A%2F%2Fhackerone.com%2Fsy1vi3" target="_blank" title="https://hackerone.com/sy1vi3" ref="nofollow noopener noreferrer">西尔维（<code>Sylvie</code>）</a>提交了两种绕过方法，我们想在此详细介绍。它们既体现了构建安全 <code>WAF</code>面临的挑战，也展示了安全研究人员的创造力。</p>
<h2 data-id="heading-5">递归UTF编码</h2>
<p>许多绕过方法试图通过用 <code>JSON</code>中的 <code>Unicode</code>表示替换常规字符来迷惑解析器。这相对容易进行规范化处理，大多数 <code>Web</code> 应用防火墙 (<code>WAF</code>) 默认都会这样做。</p>
<p>但如果你能对 <code>Unicode</code>编码再进行 <code>Unicode</code>编码呢？然后再重复一次呢？</p>
<p>拉赫兰和西尔维发现了一种利用漏洞工具，它可以强制 <code>React</code>飞行协议对同一字符串进行多次 <code>JSON</code>解码。任何能够抵御 <code>N</code>层 <code>Unicode</code>编码的 <code>Web</code> 应用防火墙 (<code>WAF</code>) ，都可以通过使用该工具 <code>N + 1</code>次来绕过。<code>Seawall</code>现在会递归解码，直到载荷完全规范化，从而彻底关闭了这类绕过途径。</p>
<p>值得注意的是，这类绕过方法以及其他类似方法还依赖于 <code>JavaScript</code>内置 <code>ReadableStream</code>类的极其细微行为，该类可以构造错误的流块，这些流块与默认行为相反，不会终止流处理，然后利用流错误消息中的字符串化特性，将其转化为函数调用漏洞利用工具。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc8f6f7830094932851d6bdd7b218685~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681476&amp;x-signature=4t7k7UZXKTszkU5O920Vv8cqEOg%3D" alt="react2shell--light.svg" loading="lazy"/></p>
<h2 data-id="heading-6">不使用冒号访问constructor属性</h2>
<p><code>React2Shell</code>的核心远程代码执行（<code>RCE</code>）工具通过 <code>React</code>飞行协议的基于冒号的属性访问语法访问函数的 <code>constructor</code>属性。这就是为什么攻击中包含字符串 <code>:constructor</code>，<code>WAF</code>防护也是基于检测这个字符串来识别恶意载荷。</p>
<p>一种绕过方法可能是找到一条完全不同的不使用 <code>constructor</code>属性的攻击链，但至今无人找到。拉赫兰找到了另一种方法：从 <code>:constructor</code>变为 <code>constructor</code>。注意缺少冒号了吗？</p>
<p>他们通过发现一种使用特定于 <code>RSC</code>解析的 <code>webpack</code>模块的类似工具进行属性访问和字符串操作来实现这一点。<code>WAF</code>可以通过针对攻击链上游的字符串来检测这种方法，但这表明攻击者在混淆有效载荷方面拥有强大的能力，其效果远超最初的概念验证。</p>
<h2 data-id="heading-7">帮助客户升级：将安全作为产品体验</h2>
<p>深度防御争取了时间，但真正的解决方案是促使用户升级。我们发布了<a href="https://link.juejin.cn?target=https%3A%2F%2Fvercel.com%2Fkb%2Fbulletin%2Freact2shell" target="_blank" title="https://vercel.com/kb/bulletin/react2shell" ref="nofollow noopener noreferrer">安全公告</a>，作为权威信息来源；在仪表盘上添加横幅，帮助识别存在漏洞的部署；提供命令行工具（<code>npx fix-react2shell-next</code>）帮助修补存在漏洞的应用；通过 <code>Vercel Agent</code>实现自动提交 <code>PR</code>，尽可能自动化这一过程。</p>
<h2 data-id="heading-8">展望未来</h2>
<p><code>React2Shell</code>以我们无法模拟的方式考验了我们的安全基础设施。我们从中获得了经过实战检验的 <code>WAF</code>、一个可针对未来漏洞进行调整的运行时防御层，以及应对下一个关键 <code>CVE</code>的应对方案。</p>
<p>研究人员在 <code>HackerOne</code>计划中发现的绕过技术现已永久集成我们的防火墙。这项跨行业合作树立了平台在网页遭受攻击时如何协作的典范。帮助客户升级的工具现在成为我们应对任何安全事件的一部分。</p>
<p>但平台防护只能争取时间。它们是第一道防线，而非补丁的替代品。如果您正在运行存在漏洞版本的 <code>Next.js</code>，请立即打补丁。</p>
<p>下一个关键漏洞将会出现，当它出现时，<code>Vercel</code>客户可以放心，在他们打补丁期间，我们会有防护措施到位。</p>
<h2 data-id="heading-9">致谢</h2>
<p>首先，感谢<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flachlan2k%2F" target="_blank" title="https://github.com/lachlan2k/" ref="nofollow noopener noreferrer">拉赫兰·戴维森（Lachlan Davidson）</a>负责任地披露了 <code>React2Shell</code>漏洞。他在披露后继续试探我们的防御，并提交了一些我们见过的最复杂的绕过方法。</p>
<p>感谢每一位参与我们 <code>HackerOne</code>计划的研究人员：hakikiwidya、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhackerone.com%2Fluhko" target="_blank" title="https://hackerone.com/luhko" ref="nofollow noopener noreferrer">luhko</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhackerone.com%2Flachlan2k" target="_blank" title="https://hackerone.com/lachlan2k" ref="nofollow noopener noreferrer">lachlan2k</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhackerone.com%2Fsy1vi3" target="_blank" title="https://hackerone.com/sy1vi3" ref="nofollow noopener noreferrer">sy1vi3</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhackerone.com%2Fmaple3142" target="_blank" title="https://hackerone.com/maple3142" ref="nofollow noopener noreferrer">maple3142</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhackerone.com%2Fhacktronresearch" target="_blank" title="https://hackerone.com/hacktronresearch" ref="nofollow noopener noreferrer">hacktronresearch</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhackerone.com%2Fbugra" target="_blank" title="https://hackerone.com/bugra" ref="nofollow noopener noreferrer">bugra</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhackerone.com%2Flonecat" target="_blank" title="https://hackerone.com/lonecat" ref="nofollow noopener noreferrer">lonecat</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhackerone.com%2Fryotak" target="_blank" title="https://hackerone.com/ryotak" ref="nofollow noopener noreferrer">ryotak</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhackerone.com%2Fch1axan" target="_blank" title="https://hackerone.com/ch1axan" ref="nofollow noopener noreferrer">ch1axan</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhackerone.com%2Fchilaxan" target="_blank" title="https://hackerone.com/chilaxan" ref="nofollow noopener noreferrer">chilaxan</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhackerone.com%2Fcjm00n" target="_blank" title="https://hackerone.com/cjm00n" ref="nofollow noopener noreferrer">cjm00n</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhackerone.com%2Ffrancisconeves97" target="_blank" title="https://hackerone.com/francisconeves97" ref="nofollow noopener noreferrer">francisconeves97</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhackerone.com%2Fphithon" target="_blank" title="https://hackerone.com/phithon" ref="nofollow noopener noreferrer">phithon</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhackerone.com%2Fshubs" target="_blank" title="https://hackerone.com/shubs" ref="nofollow noopener noreferrer">shubs</a>和<a href="https://link.juejin.cn?target=https%3A%2F%2Fhackerone.com%2Fhashkitten" target="_blank" title="https://hackerone.com/hashkitten" ref="nofollow noopener noreferrer">hashkitten</a>。</p>
<p>没有以下合作伙伴，我们的应对措施不可能成功：</p>
<ul>
<li><code>HackerOne</code>动员团队在不到六小时内启动了我们的漏洞赏金计划。这一过程通常需要数周时间。</li>
<li><code>Latacora IntrusionOps</code>提供了关键的事件响应支持，帮助我们在收到提交内容时进行分类、验证和重现。</li>
</ul>
<p>特别感谢 <code>Vercel</code>首席财务官<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.linkedin.com%2Fin%2Fmartenabrahamsen" target="_blank" title="https://www.linkedin.com/in/martenabrahamsen" ref="nofollow noopener noreferrer">马滕·亚伯拉罕森（Marten Abrahamsen）</a>批准了100万美元的赏金支出。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[回归分析全家桶（16种回归模型实现方式总结）]]></title>    <link>https://juejin.cn/post/7589214068093698067</link>    <guid>https://juejin.cn/post/7589214068093698067</guid>    <pubDate>2025-12-30T06:43:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589214068093698067" data-draft-id="7589201772134465577" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="回归分析全家桶（16种回归模型实现方式总结）"/> <meta itemprop="keywords" content="Python,机器学习,人工智能"/> <meta itemprop="datePublished" content="2025-12-30T06:43:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="databook"/> <meta itemprop="url" content="https://juejin.cn/user/3526889035006702"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            回归分析全家桶（16种回归模型实现方式总结）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3526889035006702/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    databook
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T06:43:12.000Z" title="Tue Dec 30 2025 06:43:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读44分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>提到回归分析，很多人第一时间想到的只有“线性回归”和“逻辑回归”。但实际上，针对不同的数据情况（比如有离群点、数据是计数的、数据有缺失截断等），我们有十几种回归模型可以选择。</p>
<p>今天为大家总结了 <strong>16种回归分析</strong> 的模型，重点不是介绍这些回归模型的原理，而是介绍如何在Python代码中使用这些模型，希望你以后能够在实战中来应用这些模型！</p>
<h2 data-id="heading-0">1. 回归分析全家桶</h2>
<p>下面介绍如何使用各种回归模型的示例代码，主要分为以下一些步骤：</p>
<ul>
<li><strong>模拟数据</strong>：创建适合某种回归模型的测试数据</li>
<li><strong>创建回归模型并训练</strong>：主要使用 <code>scikit-learn</code> 这个库</li>
<li><strong>评估模型</strong>：有时会和其他回归模型对比</li>
<li><strong>可视化模型</strong>：使用<code>matplotlib</code>这个库，简单展示模型效果</li>
</ul>
<p>由于担心文章篇幅太长，文中的示例没有贴出完整的代码（特别是可视化部分的代码，比较繁琐，文中都省略了），文章末尾提供了完整代码（一个<code>jupyter notebook</code>文件）的下载地址，包括了所有可视化的代码。</p>
<p>下面的代码中统一导入了下面的库：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np

<span class="hljs-keyword">import</span> matplotlib
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

<span class="hljs-comment"># 为了显示中文</span>
matplotlib.rcParams[<span class="hljs-string">"font.sans-serif"</span>] = [<span class="hljs-string">"Microsoft YaHei Mono"</span>]
matplotlib.rcParams[<span class="hljs-string">"axes.unicode_minus"</span>] = <span class="hljs-literal">False</span>
</code></pre>
<h3 data-id="heading-1">1.1. 线性回归 (Linear Regression)</h3>
<ul>
<li><strong>一句话概念</strong>：最基础的回归，假设自变量（X）和因变量（Y）之间是“直来直去”的线性关系。</li>
<li><strong>使用场景</strong>：预测房价、销售额等连续数值，且数据没有明显的复杂非线性关系。</li>
</ul>
<p><strong>线性回归</strong>模型使用示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 线性回归 (Linear Regression)</span>
<span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LinearRegression
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> mean_squared_error, r2_score

<span class="hljs-comment"># 构造测试数据</span>
<span class="hljs-comment"># 假设我们要模拟房屋面积（自变量X）和房价（因变量Y）的关系</span>
np.random.seed(<span class="hljs-number">42</span>)  <span class="hljs-comment"># 设置随机种子以确保结果可复现</span>

<span class="hljs-comment"># 生成100个房屋面积数据，范围在50-200平方米</span>
X = np.random.rand(<span class="hljs-number">100</span>, <span class="hljs-number">1</span>) * <span class="hljs-number">150</span> + <span class="hljs-number">50</span>

<span class="hljs-comment"># 真实的线性关系：房价 = 5000 * 面积 + 100000 + 随机噪声</span>
<span class="hljs-comment"># 其中5000是每平方米的价格，100000是基础价格</span>
<span class="hljs-comment"># 加入一些随机噪声，使数据更真实</span>
Y_true = <span class="hljs-number">5000</span> * X + <span class="hljs-number">100000</span>
Y = Y_true + np.random.randn(<span class="hljs-number">100</span>, <span class="hljs-number">1</span>) * <span class="hljs-number">50000</span>  <span class="hljs-comment"># 加入标准差为50000的噪声</span>

<span class="hljs-comment"># 使用线性回归模型</span>
model = LinearRegression()
model.fit(X, Y)

<span class="hljs-comment"># 预测</span>
Y_pred = model.predict(X)

<span class="hljs-comment"># 打印模型参数</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"线性回归模型参数："</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"截距（基础价格）: <span class="hljs-subst">{model.intercept_[<span class="hljs-number">0</span>]:<span class="hljs-number">.2</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"斜率（每平方米价格）: <span class="hljs-subst">{model.coef_[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]:<span class="hljs-number">.2</span>f}</span>"</span>)

<span class="hljs-comment"># 评估模型</span>
mse = mean_squared_error(Y, Y_pred)
r2 = r2_score(Y, Y_pred)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n模型评估："</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"均方误差 (MSE): <span class="hljs-subst">{mse:<span class="hljs-number">.2</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"决定系数 (R²): <span class="hljs-subst">{r2:<span class="hljs-number">.2</span>f}</span>"</span>)

<span class="hljs-comment"># 使用matplotlib绘制图像</span>
<span class="hljs-comment">#... 省略 ...</span>

<span class="hljs-comment">## 运行结果：</span>
<span class="hljs-string">'''
线性回归模型参数：
截距（基础价格）: 118417.69
斜率（每平方米价格）: 4846.74

模型评估：
均方误差 (MSE): 2016461409.92
决定系数 (R²): 0.96
'''</span>
</code></pre>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ceaa98bd2be6485f86d9a641e57a096d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681791&amp;x-signature=%2F4YJUQZrRy3wB%2BYfQWGj%2BzPETmw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">1.2. 多项式回归 (Polynomial Regression)</h3>
<ul>
<li><strong>一句话概念</strong>：当数据不是直线分布，而是像曲线一样弯曲时，我们给自变量加上平方、立方等“高次项”来拟合曲线。</li>
<li><strong>使用场景</strong>：拟合生物生长曲线、由于边际效应递减导致的经济学数据等非线性关系。</li>
</ul>
<p><strong>多项式回归</strong>模型使用示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 多项式回归 (Polynomial Regression)</span>
<span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LinearRegression
<span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> PolynomialFeatures
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> mean_squared_error, r2_score

<span class="hljs-comment"># 1. 构造强非线性测试数据（模拟生物生长曲线）</span>
np.random.seed(<span class="hljs-number">42</span>)  <span class="hljs-comment"># 设置随机种子以确保结果可复现</span>

<span class="hljs-comment"># 生成100个自变量数据，范围在0-15</span>
X = np.random.rand(<span class="hljs-number">100</span>, <span class="hljs-number">1</span>) * <span class="hljs-number">15</span>

<span class="hljs-comment"># 真实的强非线性关系：使用类似S型曲线的函数（Logistic生长模型的变形）</span>
<span class="hljs-comment"># Y = 100 / (1 + exp(-0.5*(X-7))) + 随机噪声</span>
<span class="hljs-comment"># 这个关系模拟了生物生长曲线：初期缓慢，中期快速增长，后期趋于饱和</span>
Y_true = <span class="hljs-number">100</span> / (<span class="hljs-number">1</span> + np.exp(-<span class="hljs-number">0.5</span> * (X - <span class="hljs-number">7</span>)))
Y = Y_true + np.random.randn(<span class="hljs-number">100</span>, <span class="hljs-number">1</span>) * <span class="hljs-number">5</span>  <span class="hljs-comment"># 加入标准差为5的噪声</span>

<span class="hljs-comment"># 2. 多项式回归（使用三次多项式）</span>
<span class="hljs-comment"># 转换特征，添加平方和立方项</span>
poly_features = PolynomialFeatures(degree=<span class="hljs-number">3</span>, include_bias=<span class="hljs-literal">False</span>)
X_poly = poly_features.fit_transform(X)

<span class="hljs-comment"># 使用线性回归拟合转换后的特征</span>
model = LinearRegression()
model.fit(X_poly, Y)

<span class="hljs-comment"># 预测</span>
Y_pred = model.predict(X_poly)

<span class="hljs-comment"># 打印模型参数</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"多项式回归模型参数（三次多项式）："</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"截距: <span class="hljs-subst">{model.intercept_[<span class="hljs-number">0</span>]:<span class="hljs-number">.2</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"系数: <span class="hljs-subst">{model.coef_[<span class="hljs-number">0</span>]}</span>"</span>)

<span class="hljs-comment"># 评估模型</span>
mse = mean_squared_error(Y, Y_pred)
r2 = r2_score(Y, Y_pred)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n模型评估："</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"均方误差 (MSE): <span class="hljs-subst">{mse:<span class="hljs-number">.2</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"决定系数 (R²): <span class="hljs-subst">{r2:<span class="hljs-number">.2</span>f}</span>"</span>)

<span class="hljs-comment"># 3. 使用线性回归作为对比</span>
linear_model = LinearRegression()
linear_model.fit(X, Y)
Y_linear_pred = linear_model.predict(X)

<span class="hljs-comment"># 评估线性回归模型</span>
linear_mse = mean_squared_error(Y, Y_linear_pred)
linear_r2 = r2_score(Y, Y_linear_pred)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n线性回归模型评估："</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"均方误差 (MSE): <span class="hljs-subst">{linear_mse:<span class="hljs-number">.2</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"决定系数 (R²): <span class="hljs-subst">{linear_r2:<span class="hljs-number">.2</span>f}</span>"</span>)

<span class="hljs-comment"># 4. 使用matplotlib绘制图像</span>
<span class="hljs-comment">#... 省略 ...</span>

<span class="hljs-comment">## 运行结果：</span>
<span class="hljs-string">'''
多项式回归模型参数（三次多项式）：
截距: 8.70
系数: [-4.29511575  2.09659382 -0.09560718]

模型评估：
均方误差 (MSE): 20.02
决定系数 (R²): 0.98

线性回归模型评估：
均方误差 (MSE): 56.71
决定系数 (R²): 0.95
'''</span>
</code></pre>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6443a9759c0744c29ed4719ff6348f51~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681791&amp;x-signature=952kZgFP1giGmsYLO8O8gUOM8S8%3D" alt="" loading="lazy"/></p>
<p>从示例可以看出，线性回归只能用一条直线拟合所有数据，无法捕捉到S型曲线的弯曲特征。</p>
<p><strong>多项式回归</strong>能够更好地贴合数据的非线性模式，尤其是在曲线的弯曲部分，</p>
<p>这种对比清晰地展示了多项式回归在处理非线性数据时的优势。</p>
<h3 data-id="heading-3">1.3. 逻辑回归 (Logistic Regression)</h3>
<ul>
<li><strong>一句话概念</strong>：虽然叫“回归”，但其实是做<strong>分类</strong>的。它预测的是事件发生的概率（0到1之间），输出结果通常通过阈值（如0.5）划分为两类。</li>
<li><strong>使用场景</strong>：预测用户是否会购买（是/否）、病人是否患病、邮件是否为垃圾邮件。</li>
</ul>
<p><strong>逻辑回归</strong>模型使用示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 逻辑回归 (Logistic Regression)</span>
<span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LogisticRegression
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> accuracy_score

<span class="hljs-comment"># 1. 构造二分类测试数据（模拟用户购买预测场景）</span>
np.random.seed(<span class="hljs-number">42</span>)  <span class="hljs-comment"># 设置随机种子以确保结果可复现</span>

<span class="hljs-comment"># 类别0：不会购买的用户特征（如浏览时长和页面访问量）</span>
n_class0 = <span class="hljs-number">100</span>
class0_features = np.random.randn(n_class0, <span class="hljs-number">2</span>) * <span class="hljs-number">1.5</span> + [<span class="hljs-number">3</span>, <span class="hljs-number">3</span>]
class0_labels = np.zeros(n_class0)

<span class="hljs-comment"># 类别1：会购买的用户特征</span>
n_class1 = <span class="hljs-number">100</span>
class1_features = np.random.randn(n_class1, <span class="hljs-number">2</span>) * <span class="hljs-number">1.5</span> + [<span class="hljs-number">6</span>, <span class="hljs-number">6</span>]
class1_labels = np.ones(n_class1)

<span class="hljs-comment"># 合并数据集</span>
X = np.vstack([class0_features, class1_features])
y = np.hstack([class0_labels, class1_labels])

<span class="hljs-comment"># 2. 训练逻辑回归模型</span>
model = LogisticRegression()
model.fit(X, y)

<span class="hljs-comment"># 预测</span>
y_pred_proba = model.predict_proba(X)[:, <span class="hljs-number">1</span>]
y_pred = model.predict(X)

<span class="hljs-comment"># 模型评估</span>
accuracy = accuracy_score(y, y_pred)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"逻辑回归模型准确率: <span class="hljs-subst">{accuracy:<span class="hljs-number">.2</span>f}</span>"</span>)

<span class="hljs-comment"># 3. 绘制图像</span>
<span class="hljs-comment">#... 省略 ...</span>

<span class="hljs-comment">## 运行结果：</span>
<span class="hljs-string">'''
逻辑回归模型准确率: 0.93
'''</span>
</code></pre>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25d49650ff0344e8acd11c0e8b35a5d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681791&amp;x-signature=Itm6CoaQNBBYNiwqMvw47C2WUFk%3D" alt="" loading="lazy"/></p>
<p>这个示例清晰展示了逻辑回归如何进行二分类预测，并通过可视化直观呈现了分类结果、决策边界和概率分布，完全符合逻辑回归的应用场景（预测事件发生概率）。</p>
<h3 data-id="heading-4">1.4. 分位数回归 (Quantile Regression)</h3>
<ul>
<li><strong>一句话概念</strong>：普通回归预测的是“平均值”，而分位数回归可以预测“中位数”或者任意百分位点（如前10%）。</li>
<li><strong>使用场景</strong>：数据中有极端异常值（离群点），或者你想研究不同层级的数据（如分析贫困人口和富裕人口的收入影响因素差异）。</li>
</ul>
<p><strong>分位数回归</strong>模型使用示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 分位数回归 (Quantile Regression)</span>
<span class="hljs-keyword">import</span> statsmodels.api <span class="hljs-keyword">as</span> sm
<span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LinearRegression

<span class="hljs-comment"># 1. 构造包含极端异常值的测试数据</span>
np.random.seed(<span class="hljs-number">42</span>)  <span class="hljs-comment"># 设置随机种子以确保结果可复现</span>

<span class="hljs-comment"># 生成基础自变量数据（如收入）</span>
X = np.linspace(<span class="hljs-number">10</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>).reshape(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)

<span class="hljs-comment"># 基础线性关系：消费 = 0.6 * 收入 + 10 + 随机噪声</span>
Y_true = <span class="hljs-number">0.6</span> * X + <span class="hljs-number">10</span>
Y = Y_true + np.random.normal(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>, size=X.shape)  <span class="hljs-comment"># 加入正常噪声</span>

<span class="hljs-comment"># 添加极端异常值（模拟高消费人群的极端消费行为）</span>
<span class="hljs-comment"># 选择最后10个数据点，添加大的正异常值</span>
Y[-<span class="hljs-number">10</span>:] += np.random.normal(<span class="hljs-number">100</span>, <span class="hljs-number">20</span>, size=(<span class="hljs-number">10</span>, <span class="hljs-number">1</span>))

<span class="hljs-comment"># 2. 普通线性回归</span>
linear_model = LinearRegression()
linear_model.fit(X, Y)
Y_linear_pred = linear_model.predict(X)

<span class="hljs-comment"># 3. 分位数回归</span>
<span class="hljs-comment"># 添加常数项</span>
X_with_const = sm.add_constant(X)

<span class="hljs-comment"># 定义要估计的分位数</span>
quantiles = [<span class="hljs-number">0.1</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.9</span>]
quantile_results = {}

<span class="hljs-comment"># 拟合不同分位数的模型</span>
<span class="hljs-keyword">for</span> q <span class="hljs-keyword">in</span> quantiles:
    model = sm.QuantReg(Y, X_with_const)
    result = model.fit(q=q)
    quantile_results[q] = result

<span class="hljs-comment"># 4. 预测不同分位数的结果</span>
Y_quantile_pred = {}
<span class="hljs-keyword">for</span> q <span class="hljs-keyword">in</span> quantiles:
    Y_quantile_pred[q] = quantile_results[q].predict(X_with_const)

<span class="hljs-comment"># 5. 绘制图像</span>
<span class="hljs-comment">#... 省略 ...</span>

<span class="hljs-comment"># 打印模型参数对比</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 模型参数对比 ==="</span>)
<span class="hljs-built_in">print</span>(
    <span class="hljs-string">f"普通线性回归: 截距=<span class="hljs-subst">{linear_model.intercept_[<span class="hljs-number">0</span>]:<span class="hljs-number">.2</span>f}</span>, 斜率=<span class="hljs-subst">{linear_model.coef_[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]:<span class="hljs-number">.2</span>f}</span>"</span>
)
<span class="hljs-keyword">for</span> q <span class="hljs-keyword">in</span> quantiles:
    intercept = quantile_results[q].params[<span class="hljs-number">0</span>]
    slope = quantile_results[q].params[<span class="hljs-number">1</span>]
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"分位数回归(τ=<span class="hljs-subst">{q:<span class="hljs-number">.1</span>f}</span>): 截距=<span class="hljs-subst">{intercept:<span class="hljs-number">.2</span>f}</span>, 斜率=<span class="hljs-subst">{slope:<span class="hljs-number">.2</span>f}</span>"</span>)

<span class="hljs-comment">## 运行结果：</span>
<span class="hljs-string">'''
=== 模型参数对比 ===
普通线性回归: 截距=-13.59, 斜率=1.20
分位数回归(τ=0.1): 截距=0.59, 斜率=0.66
分位数回归(τ=0.5): 截距=6.95, 斜率=0.67
分位数回归(τ=0.9): 截距=-3.01, 斜率=1.73
'''</span>
</code></pre>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/527f8fa6386c47e49eaa3351398782a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681791&amp;x-signature=BJM4RUFp4dhYP8CqgO6WJlygI3I%3D" alt="" loading="lazy"/></p>
<p>从图中可以看出：</p>
<ul>
<li>不同分位数的回归线斜率和截距各不相同</li>
<li>高消费分位(τ=0.9)的回归线最接近异常值，而低消费分位(τ=0.1)的回归线几乎不受异常值影响</li>
<li>中位数回归(τ=0.5)相对普通线性回归更能抵抗异常值的影响</li>
</ul>
<p>这个示例清晰地展示了<strong>分位数回归</strong>如何处理<strong>极端异常值</strong>，以及如何通过不同分位数分析数据的不同层级结构，非常适合用户描述的使用场景（数据中有极端异常值或需要研究不同层级数据）。</p>
<h3 data-id="heading-5">1.5. 岭回归 (Ridge Regression)</h3>
<ul>
<li><strong>一句话概念</strong>：在线性回归的基础上加了一个“惩罚项”（L2正则化），防止模型为了迎合训练数据而变得太复杂（过拟合）。</li>
<li><strong>使用场景</strong>：特征之间相关性很高（多重共线性）导致普通回归失效时。</li>
</ul>
<p><strong>岭回归</strong>模型使用示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 岭回归 (Ridge Regression)</span>
<span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LinearRegression, Ridge
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> mean_squared_error
<span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> StandardScaler

<span class="hljs-comment"># 1. 构造具有多重共线性的测试数据</span>
np.random.seed(<span class="hljs-number">42</span>)  <span class="hljs-comment"># 设置随机种子以确保结果可复现</span>

<span class="hljs-comment"># 生成基础特征（如房屋的总面积）</span>
X1 = np.random.rand(<span class="hljs-number">100</span>, <span class="hljs-number">1</span>) * <span class="hljs-number">100</span> + <span class="hljs-number">50</span>  <span class="hljs-comment"># 50-150平方米</span>

<span class="hljs-comment"># 生成高度相关的第二个特征（如房屋的可用面积）</span>
<span class="hljs-comment"># 设置高度相关性：X2 = 0.8*X1 + 少量噪声</span>
X2 = <span class="hljs-number">0.8</span> * X1 + np.random.randn(<span class="hljs-number">100</span>, <span class="hljs-number">1</span>) * <span class="hljs-number">5</span>
X = np.hstack([X1, X2])  <span class="hljs-comment"># 合并两个特征</span>

<span class="hljs-comment"># 真实的线性关系：房价 = 10000*X1 + 8000*X2 + 500000 + 随机噪声</span>
Y_true = <span class="hljs-number">10000</span> * X1 + <span class="hljs-number">8000</span> * X2 + <span class="hljs-number">500000</span>
Y = Y_true + np.random.randn(<span class="hljs-number">100</span>, <span class="hljs-number">1</span>) * <span class="hljs-number">200000</span>  <span class="hljs-comment"># 加入噪声</span>

<span class="hljs-comment"># 2. 数据标准化（岭回归对特征缩放敏感）</span>
scaler = StandardScaler()
X_scaled = scaler.fit_transform(X)
Y_scaled = scaler.fit_transform(Y)

<span class="hljs-comment"># 3. 普通线性回归</span>
linear_model = LinearRegression()
linear_model.fit(X_scaled, Y_scaled)
Y_linear_pred = linear_model.predict(X_scaled)

<span class="hljs-comment"># 4. 岭回归（不同的正则化参数λ）</span>
<span class="hljs-comment"># 移除0值以避免log10(0)的警告</span>
lambdas = [<span class="hljs-number">0.1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">10</span>, <span class="hljs-number">100</span>, <span class="hljs-number">1000</span>]  <span class="hljs-comment"># 不同的λ值</span>
ridge_models = {}
ridge_preds = {}
ridge_coefs = []

<span class="hljs-keyword">for</span> lam <span class="hljs-keyword">in</span> lambdas:
    model = Ridge(alpha=lam)
    model.fit(X_scaled, Y_scaled)
    ridge_models[lam] = model
    ridge_preds[lam] = model.predict(X_scaled)
    ridge_coefs.append(model.coef_.flatten())

<span class="hljs-comment"># 5. 可视化结果</span>
<span class="hljs-comment">#... 省略 ...</span>

<span class="hljs-comment"># 计算并比较MSE</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 模型性能比较 (MSE) ==="</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"普通线性回归 MSE: <span class="hljs-subst">{mean_squared_error(Y_scaled, Y_linear_pred):<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-keyword">for</span> lam <span class="hljs-keyword">in</span> lambdas:
    mse = mean_squared_error(Y_scaled, ridge_preds[lam])
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"岭回归 (λ=<span class="hljs-subst">{lam}</span>) MSE: <span class="hljs-subst">{mse:<span class="hljs-number">.4</span>f}</span>"</span>)

<span class="hljs-comment">## 运行结果：</span>
<span class="hljs-string">'''
=== 模型性能比较 (MSE) ===
普通线性回归 MSE: 0.1705
岭回归 (λ=0.1) MSE: 0.1705
岭回归 (λ=1) MSE: 0.1706
岭回归 (λ=10) MSE: 0.1730
岭回归 (λ=100) MSE: 0.2645
岭回归 (λ=1000) MSE: 0.7486
'''</span>
</code></pre>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b0bfb1b96424afc9199a1977fa315d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681791&amp;x-signature=Ov1FgNa2E%2B6AJz%2BTI4G%2BK7q04xA%3D" alt="" loading="lazy"/></p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb4dcdb1591d491b906242633116f565~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681791&amp;x-signature=E60GGD1npjKapq7Td8oDxwmhSF4%3D" alt="" loading="lazy"/></p>
<p>从图中可以看出：</p>
<ul>
<li>普通线性回归在多重共线性下系数可能不稳定</li>
<li>随着λ增大，岭回归系数逐渐减小并趋向稳定</li>
<li>合适的λ值可以在保持预测准确性的同时提高模型稳定性</li>
</ul>
<p>这个示例清晰地展示了<strong>岭回归</strong>在处理<strong>多重共线性数据</strong>时的优势，以及如何通过正则化参数λ来平衡模型复杂度和预测准确性。</p>
<h3 data-id="heading-6">1.6. Lasso回归 (Lasso Regression)</h3>
<ul>
<li><strong>一句话概念</strong>：和岭回归类似，但使用的是L1正则化。它不仅能防止过拟合，还能把不重要的特征系数强行压缩为0。</li>
<li><strong>使用场景</strong>：当你有很多特征，想要自动筛选出最重要的几个特征时。</li>
</ul>
<hr/>
<p><strong>Lasso回归</strong>模型使用示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Lasso回归 (Lasso Regression)</span>
<span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LinearRegression, Lasso
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> mean_squared_error
<span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> StandardScaler

<span class="hljs-comment"># 1. 构造多特征测试数据（大部分特征不重要）</span>
np.random.seed(<span class="hljs-number">42</span>)  <span class="hljs-comment"># 设置随机种子以确保结果可复现</span>

n_samples = <span class="hljs-number">100</span>
n_features = <span class="hljs-number">10</span>  <span class="hljs-comment"># 总共10个特征</span>

<span class="hljs-comment"># 生成10个特征，前3个是真正重要的，后7个是不重要的</span>
X = np.random.randn(n_samples, n_features)

<span class="hljs-comment"># 真实系数：前3个特征有较大的非零系数，后7个特征的系数为0</span>
true_coef = np.zeros(n_features)
true_coef[<span class="hljs-number">0</span>] = <span class="hljs-number">10.0</span>  <span class="hljs-comment"># 重要特征1</span>
true_coef[<span class="hljs-number">1</span>] = -<span class="hljs-number">8.0</span>  <span class="hljs-comment"># 重要特征2</span>
true_coef[<span class="hljs-number">2</span>] = <span class="hljs-number">5.0</span>  <span class="hljs-comment"># 重要特征3</span>

<span class="hljs-comment"># 生成目标变量：Y = X * 真实系数 + 随机噪声</span>
Y_true = X.dot(true_coef)
Y = Y_true + np.random.randn(n_samples) * <span class="hljs-number">5</span>  <span class="hljs-comment"># 加入噪声</span>

<span class="hljs-comment"># 2. 数据标准化（Lasso对特征缩放敏感）</span>
scaler = StandardScaler()
X_scaled = scaler.fit_transform(X)
Y_scaled = scaler.fit_transform(Y.reshape(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)).ravel()

<span class="hljs-comment"># 3. 普通线性回归</span>
linear_model = LinearRegression()
linear_model.fit(X_scaled, Y_scaled)
Y_linear_pred = linear_model.predict(X_scaled)

<span class="hljs-comment"># 4. Lasso回归（不同的正则化参数λ）</span>
lambdas = [<span class="hljs-number">0.01</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">5.0</span>]  <span class="hljs-comment"># 不同的λ值</span>
lasso_models = {}
lasso_preds = {}
lasso_coefs = []

<span class="hljs-keyword">for</span> lam <span class="hljs-keyword">in</span> lambdas:
    model = Lasso(alpha=lam, max_iter=<span class="hljs-number">10000</span>)  <span class="hljs-comment"># 增加最大迭代次数避免收敛警告</span>
    model.fit(X_scaled, Y_scaled)
    lasso_models[lam] = model
    lasso_preds[lam] = model.predict(X_scaled)
    lasso_coefs.append(model.coef_)

<span class="hljs-comment"># 5. 可视化结果</span>
<span class="hljs-comment">#... 省略 ...</span>

<span class="hljs-comment"># 计算并比较MSE</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 模型性能比较 (MSE) ==="</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"普通线性回归 MSE: <span class="hljs-subst">{mean_squared_error(Y_scaled, Y_linear_pred):<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-keyword">for</span> lam <span class="hljs-keyword">in</span> lambdas:
    mse = mean_squared_error(Y_scaled, lasso_preds[lam])
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Lasso回归 (λ=<span class="hljs-subst">{lam}</span>) MSE: <span class="hljs-subst">{mse:<span class="hljs-number">.4</span>f}</span>"</span>)

<span class="hljs-comment">## 运行结果：</span>
<span class="hljs-string">'''
=== 模型性能比较 (MSE) ===
普通线性回归 MSE: 0.1024
Lasso回归 (λ=0.01) MSE: 0.1034
Lasso回归 (λ=0.1) MSE: 0.1384
Lasso回归 (λ=0.5) MSE: 0.6845
Lasso回归 (λ=1.0) MSE: 1.0000
Lasso回归 (λ=5.0) MSE: 1.0000
'''</span>
</code></pre>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbd8e137eeb04cf2ad932708c79820ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681791&amp;x-signature=CiMU%2F8DIGiSMpWqy%2BXgoY4NQDTU%3D" alt="" loading="lazy"/></p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d71e895654be48e9883e209f2da0f4d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681791&amp;x-signature=BbQMkpjzjjDTwIfZ%2BPW57qKey9k%3D" alt="" loading="lazy"/></p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d8c21a55a4b407f9c1eec47afea0f2a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681791&amp;x-signature=vhoke9bFTZ%2BFs3saBfLtuvSGoTg%3D" alt="" loading="lazy"/></p>
<p>从图中可以看出：</p>
<ul>
<li>随着λ增大，越来越多的系数被压缩为0</li>
<li>Lasso能够自动识别并保留重要特征（前3个）</li>
<li>适当的λ值可以在保持预测精度的同时实现特征选择</li>
</ul>
<p>这个示例很好地展示了<strong>Lasso回归</strong>的特征选择能力，非常适合用户描述的使用场景（当有很多特征，想要自动筛选出最重要的几个特征时）。</p>
<h3 data-id="heading-7">1.7. 弹性网络回归 (Elastic Net Regression)</h3>
<ul>
<li><strong>一句话概念</strong>：岭回归和套索回归的“混血儿”，结合了它俩的优点。</li>
<li><strong>使用场景</strong>：特征非常多且彼此高度相关，你既想选特征又想保持模型稳定时。</li>
</ul>
<p><strong>弹性网络回归</strong>模型使用示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 弹性网络回归 (Elastic Net Regression)</span>
<span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LinearRegression, Lasso, Ridge, ElasticNet
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> mean_squared_error
<span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> StandardScaler

<span class="hljs-comment"># 1. 构造高相关多特征测试数据</span>
np.random.seed(<span class="hljs-number">42</span>)  <span class="hljs-comment"># 设置随机种子以确保结果可复现</span>

n_samples = <span class="hljs-number">100</span>
n_features = <span class="hljs-number">10</span>  <span class="hljs-comment"># 总共10个特征</span>

<span class="hljs-comment"># 生成基础特征</span>
base_feature = np.random.randn(n_samples, <span class="hljs-number">1</span>)

<span class="hljs-comment"># 生成高度相关的特征组</span>
<span class="hljs-comment"># 前3个特征高度相关（重要特征）</span>
X = np.zeros((n_samples, n_features))
X[:, <span class="hljs-number">0</span>] = base_feature.ravel() + np.random.randn(n_samples) * <span class="hljs-number">0.1</span>  <span class="hljs-comment"># 主特征1</span>
X[:, <span class="hljs-number">1</span>] = X[:, <span class="hljs-number">0</span>] * <span class="hljs-number">0.8</span> + np.random.randn(n_samples) * <span class="hljs-number">0.2</span>  <span class="hljs-comment"># 相关特征2</span>
X[:, <span class="hljs-number">2</span>] = X[:, <span class="hljs-number">0</span>] * <span class="hljs-number">0.5</span> + X[:, <span class="hljs-number">1</span>] * <span class="hljs-number">0.3</span> + np.random.randn(n_samples) * <span class="hljs-number">0.2</span>  <span class="hljs-comment"># 相关特征3</span>

<span class="hljs-comment"># 中间3个特征高度相关但不重要</span>
X[:, <span class="hljs-number">3</span>] = np.random.randn(n_samples) * <span class="hljs-number">0.3</span> + X[:, <span class="hljs-number">0</span>] * <span class="hljs-number">0.1</span>  <span class="hljs-comment"># 弱相关特征4</span>
X[:, <span class="hljs-number">4</span>] = X[:, <span class="hljs-number">3</span>] * <span class="hljs-number">0.7</span> + np.random.randn(n_samples) * <span class="hljs-number">0.2</span>  <span class="hljs-comment"># 相关特征5</span>
X[:, <span class="hljs-number">5</span>] = X[:, <span class="hljs-number">3</span>] * <span class="hljs-number">0.6</span> + X[:, <span class="hljs-number">4</span>] * <span class="hljs-number">0.4</span> + np.random.randn(n_samples) * <span class="hljs-number">0.2</span>  <span class="hljs-comment"># 相关特征6</span>

<span class="hljs-comment"># 最后4个特征是随机噪声（完全不重要）</span>
X[:, <span class="hljs-number">6</span>:] = np.random.randn(n_samples, <span class="hljs-number">4</span>) * <span class="hljs-number">0.5</span>

<span class="hljs-comment"># 真实系数：只有前3个重要特征有非零系数</span>
true_coef = np.zeros(n_features)
true_coef[<span class="hljs-number">0</span>] = <span class="hljs-number">10.0</span>
true_coef[<span class="hljs-number">1</span>] = -<span class="hljs-number">5.0</span>
true_coef[<span class="hljs-number">2</span>] = <span class="hljs-number">3.0</span>

<span class="hljs-comment"># 生成目标变量</span>
Y_true = X.dot(true_coef)
Y = Y_true + np.random.randn(n_samples) * <span class="hljs-number">3</span>  <span class="hljs-comment"># 加入噪声</span>

<span class="hljs-comment"># 2. 数据标准化（正则化模型对特征缩放敏感）</span>
scaler = StandardScaler()
X_scaled = scaler.fit_transform(X)
Y_scaled = scaler.fit_transform(Y.reshape(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)).ravel()

<span class="hljs-comment"># 3. 训练不同的回归模型</span>
<span class="hljs-comment"># 普通线性回归</span>
linear_model = LinearRegression()
linear_model.fit(X_scaled, Y_scaled)

<span class="hljs-comment"># Lasso回归（λ=0.1）</span>
lasso_model = Lasso(alpha=<span class="hljs-number">0.1</span>, max_iter=<span class="hljs-number">10000</span>)
lasso_model.fit(X_scaled, Y_scaled)

<span class="hljs-comment"># Ridge回归（λ=1.0）</span>
ridge_model = Ridge(alpha=<span class="hljs-number">1.0</span>)
ridge_model.fit(X_scaled, Y_scaled)

<span class="hljs-comment"># 弹性网络回归（不同的l1_ratio）</span>
elastic_models = {}
l1_ratios = [<span class="hljs-number">0.1</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.9</span>]  <span class="hljs-comment"># 控制L1和L2的比例</span>
alpha = <span class="hljs-number">1.0</span>  <span class="hljs-comment"># 总正则化强度</span>

<span class="hljs-keyword">for</span> ratio <span class="hljs-keyword">in</span> l1_ratios:
    model = ElasticNet(alpha=alpha, l1_ratio=ratio, max_iter=<span class="hljs-number">10000</span>)
    model.fit(X_scaled, Y_scaled)
    elastic_models[ratio] = model

<span class="hljs-comment"># 4. 预测</span>
Y_linear_pred = linear_model.predict(X_scaled)
Y_lasso_pred = lasso_model.predict(X_scaled)
Y_ridge_pred = ridge_model.predict(X_scaled)
Y_elastic_pred = {
    ratio: model.predict(X_scaled) <span class="hljs-keyword">for</span> ratio, model <span class="hljs-keyword">in</span> elastic_models.items()
}

<span class="hljs-comment"># 5. 可视化结果</span>
<span class="hljs-comment"># ... 省略 ...</span>

<span class="hljs-comment"># 6. 模型评估和特征选择效果</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 模型性能评估 ==="</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"普通线性回归 MSE: <span class="hljs-subst">{mean_squared_error(Y_scaled, Y_linear_pred):<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Lasso回归 MSE: <span class="hljs-subst">{mean_squared_error(Y_scaled, Y_lasso_pred):<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Ridge回归 MSE: <span class="hljs-subst">{mean_squared_error(Y_scaled, Y_ridge_pred):<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-keyword">for</span> ratio <span class="hljs-keyword">in</span> l1_ratios:
    mse = mean_squared_error(Y_scaled, Y_elastic_pred[ratio])
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"弹性网络 (l1_ratio=<span class="hljs-subst">{ratio}</span>) MSE: <span class="hljs-subst">{mse:<span class="hljs-number">.4</span>f}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 特征选择效果 ==="</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"普通线性回归非零系数数: <span class="hljs-subst">{np.<span class="hljs-built_in">sum</span>(linear_model.coef_ != <span class="hljs-number">0</span>)}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Lasso回归非零系数数: <span class="hljs-subst">{np.<span class="hljs-built_in">sum</span>(lasso_model.coef_ != <span class="hljs-number">0</span>)}</span>"</span>)
<span class="hljs-built_in">print</span>(
    <span class="hljs-string">f"Ridge回归非零系数数: <span class="hljs-subst">{np.<span class="hljs-built_in">sum</span>(ridge_model.coef_ != <span class="hljs-number">0</span>)}</span>"</span>
)  <span class="hljs-comment"># Ridge几乎不会产生严格零系数</span>
<span class="hljs-keyword">for</span> ratio <span class="hljs-keyword">in</span> l1_ratios:
    non_zero_count = np.<span class="hljs-built_in">sum</span>(elastic_models[ratio].coef_ != <span class="hljs-number">0</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"弹性网络 (l1_ratio=<span class="hljs-subst">{ratio}</span>) 非零系数数: <span class="hljs-subst">{non_zero_count}</span>"</span>)

<span class="hljs-comment">## 运行结果：</span>
<span class="hljs-string">'''
=== 模型性能评估 ===
普通线性回归 MSE: 0.1352
Lasso回归 MSE: 0.1677
Ridge回归 MSE: 0.1369
弹性网络 (l1_ratio=0.1) MSE: 0.2676
弹性网络 (l1_ratio=0.5) MSE: 0.5002
弹性网络 (l1_ratio=0.9) MSE: 0.9711

=== 特征选择效果 ===
普通线性回归非零系数数: 10
Lasso回归非零系数数: 2
Ridge回归非零系数数: 10
弹性网络 (l1_ratio=0.1) 非零系数数: 3
弹性网络 (l1_ratio=0.5) 非零系数数: 3
弹性网络 (l1_ratio=0.9) 非零系数数: 1
'''</span>
</code></pre>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a49bb59bd4e4059965ee54007118c87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681791&amp;x-signature=F4YX9JYiLt2ylTydzedDEZyrdeM%3D" alt="" loading="lazy"/></p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bfc9b0e2c05b4616b7024b16cbc4cdec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681791&amp;x-signature=RjFHsn5J5rD1854fw9Ide0V38rQ%3D" alt="" loading="lazy"/></p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27891f2468cc448b8d85ef12bc779785~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681791&amp;x-signature=bKv2OndjFG6ZZlmQU2LQSlJ86Ms%3D" alt="" loading="lazy"/></p>
<p>从图中可以看出：</p>
<ul>
<li>弹性网络结合了Lasso的特征选择能力和Ridge的稳定性</li>
<li>通过调整l1_ratio，可以在特征选择和系数稳定性之间找到平衡</li>
<li>当特征高度相关时，弹性网络比Lasso更稳定，比Ridge更能进行特征选择</li>
</ul>
<p>这个示例很好地展示了<strong>弹性网络回归</strong>在处理<strong>高维</strong>、<strong>高度相关数据</strong>时的优势，特别适合需要同时进行特征选择和保持模型稳定的场景。</p>
<h3 data-id="heading-8">1.8. 主成分回归 (PCR)</h3>
<ul>
<li><strong>一句话概念</strong>：先用PCA（主成分分析）把很多相关的特征压缩成几个不相关的“主成分”，再用这些主成分做回归。</li>
<li><strong>使用场景</strong>：特征数量比样本数量还多，或者特征之间严重相关。</li>
</ul>
<p><strong>主成分回归</strong>模型使用示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 主成分回归 (PCR)</span>
<span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LinearRegression
<span class="hljs-keyword">from</span> sklearn.decomposition <span class="hljs-keyword">import</span> PCA
<span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> StandardScaler
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> mean_squared_error

<span class="hljs-comment"># 1. 构造高维高相关测试数据（特征数&gt;样本数）</span>
np.random.seed(<span class="hljs-number">42</span>)  <span class="hljs-comment"># 设置随机种子以确保结果可复现</span>

n_samples = <span class="hljs-number">100</span>
n_features = <span class="hljs-number">200</span>  <span class="hljs-comment"># 特征数多于样本数，模拟高维问题</span>

<span class="hljs-comment"># 生成基础特征（只有3个真正重要的基础变量）</span>
base_features = np.random.randn(n_samples, <span class="hljs-number">3</span>)

<span class="hljs-comment"># 生成200个高度相关的特征</span>
<span class="hljs-comment"># 每个新特征都是3个基础特征的线性组合 + 少量噪声</span>
X = np.zeros((n_samples, n_features))
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n_features):
    <span class="hljs-comment"># 随机权重（确保特征之间高度相关）</span>
    weights = np.random.randn(<span class="hljs-number">3</span>)
    X[:, i] = base_features.dot(weights) + np.random.randn(n_samples) * <span class="hljs-number">0.1</span>

<span class="hljs-comment"># 真实系数：只有基于前3个基础特征的组合有意义</span>
<span class="hljs-comment"># 我们只使用前10个特征来生成目标变量</span>
true_weights = np.zeros(n_features)
true_weights[:<span class="hljs-number">10</span>] = np.random.randn(<span class="hljs-number">10</span>) * <span class="hljs-number">2</span>

<span class="hljs-comment"># 生成目标变量</span>
Y_true = X.dot(true_weights)
Y = Y_true + np.random.randn(n_samples) * <span class="hljs-number">5</span>  <span class="hljs-comment"># 加入噪声</span>

<span class="hljs-comment"># 2. 数据标准化</span>
scaler = StandardScaler()
X_scaled = scaler.fit_transform(X)
Y_scaled = scaler.fit_transform(Y.reshape(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)).ravel()

<span class="hljs-comment"># 3. 普通线性回归（可能过拟合）</span>
linear_model = LinearRegression()
linear_model.fit(X_scaled, Y_scaled)
Y_linear_pred = linear_model.predict(X_scaled)
linear_mse = mean_squared_error(Y_scaled, Y_linear_pred)

<span class="hljs-comment"># 4. 主成分回归 (PCR)</span>
<span class="hljs-comment"># 4.1 PCA降维</span>
pca = PCA()
X_pca = pca.fit_transform(X_scaled)

<span class="hljs-comment"># 4.2 计算累积方差解释率</span>
explained_variance_ratio = pca.explained_variance_ratio_
cumulative_variance_ratio = np.cumsum(explained_variance_ratio)

<span class="hljs-comment"># 4.3 选择保留的主成分数量（比如保留95%方差）</span>
n_components_95 = np.argmax(cumulative_variance_ratio &gt;= <span class="hljs-number">0.95</span>) + <span class="hljs-number">1</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"保留95%方差需要的主成分数: <span class="hljs-subst">{n_components_95}</span>"</span>)

<span class="hljs-comment"># 4.4 使用不同数量的主成分进行回归</span>
n_components_list = [<span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">20</span>, n_components_95]
pcr_results = {}

<span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> n_components_list:
    <span class="hljs-comment"># 使用前n个主成分</span>
    X_pca_n = X_pca[:, :n]

    <span class="hljs-comment"># 线性回归</span>
    model = LinearRegression()
    model.fit(X_pca_n, Y_scaled)

    <span class="hljs-comment"># 预测</span>
    Y_pcr_pred = model.predict(X_pca_n)
    mse = mean_squared_error(Y_scaled, Y_pcr_pred)

    pcr_results[n] = {
        <span class="hljs-string">'model'</span>: model,
        <span class="hljs-string">'predictions'</span>: Y_pcr_pred,
        <span class="hljs-string">'mse'</span>: mse
    }

<span class="hljs-comment"># 5. 可视化结果</span>
<span class="hljs-comment"># ... 省略 ...</span>

<span class="hljs-comment"># 6. 模型性能对比</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 模型性能对比 ==="</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"普通线性回归 MSE: <span class="hljs-subst">{linear_mse:<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> n_components_list:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"PCR (n=<span class="hljs-subst">{n}</span>) MSE: <span class="hljs-subst">{pcr_results[n][<span class="hljs-string">'mse'</span>]:<span class="hljs-number">.4</span>f}</span>"</span>)

<span class="hljs-comment"># 7. 展示PCR如何解决过拟合</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== PCR解决过拟合效果 ==="</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"原始特征数量: <span class="hljs-subst">{n_features}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"样本数量: <span class="hljs-subst">{n_samples}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"普通回归的特征系数最大值: <span class="hljs-subst">{np.<span class="hljs-built_in">max</span>(np.<span class="hljs-built_in">abs</span>(linear_model.coef_)):<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"PCR (n=<span class="hljs-subst">{n_components_95}</span>) 的特征系数最大值: <span class="hljs-subst">{np.<span class="hljs-built_in">max</span>(np.<span class="hljs-built_in">abs</span>(pcr_coef)):<span class="hljs-number">.4</span>f}</span>"</span>)

<span class="hljs-comment">## 运行结果：</span>
<span class="hljs-string">'''
=== 模型性能对比 ===
普通线性回归 MSE: 0.0000
PCR (n=3) MSE: 0.5484
PCR (n=5) MSE: 0.5187
PCR (n=10) MSE: 0.4777
PCR (n=20) MSE: 0.4040
PCR (n=3) MSE: 0.5484

=== PCR解决过拟合效果 ===
原始特征数量: 200
样本数量: 100
普通回归的特征系数最大值: 2.1407
PCR (n=3) 的特征系数最大值: 0.0101
'''</span>
</code></pre>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f060ca66690647f59403c45103da475e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681791&amp;x-signature=D%2B8f727JPs6dCXxvUsiajjjX9SI%3D" alt="" loading="lazy"/></p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2603b2a86c994e679951173f04382859~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681791&amp;x-signature=tgiFrXmj9XTReusbLuPa1ptqo4k%3D" alt="" loading="lazy"/></p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a09b48d38cb4bfbadff15318ecac598~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681791&amp;x-signature=429MbW%2BemTpiuaEWWnFBLDsC5eQ%3D" alt="" loading="lazy"/></p>
<p>从图中可以看出：</p>
<ul>
<li>只需少量主成分（通常&lt;30）即可保留95%以上的方差</li>
<li>PCR的预测效果优于直接线性回归，尤其是在高维数据中</li>
<li>PCR的系数更加稳定，避免了普通回归中系数过大的问题</li>
</ul>
<p>这个示例完美展示了<code>PCR</code>在<strong>高维</strong>、<strong>高度相关数据</strong>中的应用，解决了直接线性回归的过拟合问题，同时保持了良好的预测性能。</p>
<h3 data-id="heading-9">1.9. 偏最小二乘回归 (PLS Regression)</h3>
<ul>
<li><strong>一句话概念</strong>：和PCR类似，但它在降维时会考虑因变量Y的信息，确保提取出的成分不仅能概括X，还能很好地预测Y。</li>
<li><strong>使用场景</strong>：比PCR更高级一点，常用于化学计量学或变量非常多的情况。</li>
</ul>
<p><strong>偏最小二乘回归</strong>模型使用示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 偏最小二乘回归 (PLS Regression)</span>
<span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LinearRegression
<span class="hljs-keyword">from</span> sklearn.decomposition <span class="hljs-keyword">import</span> PCA
<span class="hljs-keyword">from</span> sklearn.cross_decomposition <span class="hljs-keyword">import</span> PLSRegression
<span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> StandardScaler
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> mean_squared_error

<span class="hljs-comment"># 1. 构造高维相关数据，其中只有部分特征与Y相关</span>
np.random.seed(<span class="hljs-number">42</span>)  <span class="hljs-comment"># 设置随机种子以确保结果可复现</span>

n_samples = <span class="hljs-number">100</span>
n_features = <span class="hljs-number">100</span>  <span class="hljs-comment"># 100个特征，模拟高维问题</span>

<span class="hljs-comment"># 生成基础变量</span>
<span class="hljs-comment"># 前5个变量与Y高度相关，中间15个变量与Y弱相关，最后80个变量与Y不相关</span>
base_vars = np.random.randn(n_samples, <span class="hljs-number">20</span>)
noise_vars = np.random.randn(n_samples, <span class="hljs-number">80</span>)  <span class="hljs-comment"># 完全不相关的噪声特征</span>

<span class="hljs-comment"># 组合所有特征</span>
X = np.hstack([base_vars, noise_vars])

<span class="hljs-comment"># 生成Y，主要依赖前5个基础变量</span>
Y_true = (
    <span class="hljs-number">5</span> * base_vars[:, <span class="hljs-number">0</span>]
    + <span class="hljs-number">3</span> * base_vars[:, <span class="hljs-number">1</span>]
    - <span class="hljs-number">4</span> * base_vars[:, <span class="hljs-number">2</span>]
    + <span class="hljs-number">2</span> * base_vars[:, <span class="hljs-number">3</span>]
    + base_vars[:, <span class="hljs-number">4</span>]
)
Y = Y_true + np.random.randn(n_samples) * <span class="hljs-number">3</span>  <span class="hljs-comment"># 加入噪声</span>

<span class="hljs-comment"># 2. 数据标准化</span>
scaler = StandardScaler()
X_scaled = scaler.fit_transform(X)
Y_scaled = scaler.fit_transform(Y.reshape(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)).ravel()

<span class="hljs-comment"># 3. 普通线性回归（作为基准）</span>
linear_model = LinearRegression()
linear_model.fit(X_scaled, Y_scaled)
Y_linear_pred = linear_model.predict(X_scaled)
linear_mse = mean_squared_error(Y_scaled, Y_linear_pred)

<span class="hljs-comment"># 4. PCA + 线性回归 (PCR)</span>
pca = PCA()
X_pca = pca.fit_transform(X_scaled)

<span class="hljs-comment"># 5. 偏最小二乘回归 (PLS)</span>
pls = PLSRegression(n_components=<span class="hljs-number">20</span>)
X_pls = pls.fit_transform(X_scaled, Y_scaled)[<span class="hljs-number">0</span>]

<span class="hljs-comment"># 6. 比较不同成分数量的PCR和PLS性能</span>
n_components_list = <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">21</span>)
pcr_mse_list = []
pls_mse_list = []

<span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> n_components_list:
    <span class="hljs-comment"># PCR</span>
    model_pcr = LinearRegression()
    model_pcr.fit(X_pca[:, :n], Y_scaled)
    Y_pcr_pred = model_pcr.predict(X_pca[:, :n])
    pcr_mse_list.append(mean_squared_error(Y_scaled, Y_pcr_pred))

    <span class="hljs-comment"># PLS</span>
    model_pls = PLSRegression(n_components=n)
    model_pls.fit(X_scaled, Y_scaled)
    Y_pls_pred = model_pls.predict(X_scaled).ravel()
    pls_mse_list.append(mean_squared_error(Y_scaled, Y_pls_pred))

<span class="hljs-comment"># 7. 可视化结果</span>
<span class="hljs-comment"># ... 省略 ...</span>

<span class="hljs-comment"># 输出结果</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 模型性能对比 ==="</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"普通线性回归 MSE: <span class="hljs-subst">{linear_mse:<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"最佳PCR (n=<span class="hljs-subst">{best_pcr_n}</span>) MSE: <span class="hljs-subst">{pcr_mse_list[best_pcr_n-<span class="hljs-number">1</span>]:<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"最佳PLS (n=<span class="hljs-subst">{best_pls_n}</span>) MSE: <span class="hljs-subst">{pls_mse_list[best_pls_n-<span class="hljs-number">1</span>]:<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(
    <span class="hljs-string">f"PLS相比最佳PCR的MSE提升: <span class="hljs-subst">{(pcr_mse_list[best_pcr_n-<span class="hljs-number">1</span>] - pls_mse_list[best_pls_n-<span class="hljs-number">1</span>])/pcr_mse_list[best_pcr_n-<span class="hljs-number">1</span>]*<span class="hljs-number">100</span>:<span class="hljs-number">.1</span>f}</span>%"</span>
)

<span class="hljs-comment"># 展示PLS如何提取与Y相关的成分</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== PLS成分分析 ==="</span>)
pls_var_importance = np.<span class="hljs-built_in">abs</span>(pls.x_weights_).<span class="hljs-built_in">sum</span>(axis=<span class="hljs-number">1</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"PLS前5个最重要成分的方差贡献: <span class="hljs-subst">{np.sort(pls_var_importance)[::-<span class="hljs-number">1</span>][:<span class="hljs-number">5</span>]}</span>"</span>)

<span class="hljs-comment">## 运行结果：</span>
<span class="hljs-string">'''
=== 模型性能对比 ===
普通线性回归 MSE: 0.0000
最佳PCR (n=20) MSE: 0.6687
最佳PLS (n=20) MSE: 0.0048
PLS相比最佳PCR的MSE提升: 99.3%

=== PLS成分分析 ===
PLS前5个最重要成分的方差贡献: [2.4938574  2.27964709 2.17888686 2.08667187 2.06267069]
'''</span>
</code></pre>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8dab70f652de45cda019d209a95ed6c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681791&amp;x-signature=2KDzJsPrNYaO1rToq4HpNQ7oyx0%3D" alt="" loading="lazy"/></p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/317e354d6b9c44a68fad9dd7db9653f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681791&amp;x-signature=sCPOTDVAoVy84zugBjbrA4vXvj8%3D" alt="" loading="lazy"/></p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d302b7a3f39043558a513b133b183c8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681791&amp;x-signature=dLWzbKrnzaUOgp4ItLL6OnwH1pk%3D" alt="" loading="lazy"/></p>
<p>从图中可以看出：</p>
<ul>
<li>PLS在较少的成分数下就能达到较好的预测效果</li>
<li>PLS提取的成分与Y的相关性明显高于PCA成分</li>
<li>当存在大量噪声特征时，PLS的优势更加明显</li>
</ul>
<p>这个示例清晰地展示了<strong>PLS回归</strong>如何在降维过程中考虑因变量Y的信息，从而在高维、存在噪声的情况下提供比PCR更好的预测性能。</p>
<h3 data-id="heading-10">1.10. 支持向量回归 (SVR)</h3>
<ul>
<li><strong>一句话概念</strong>：借用了SVM分类的思想，试图找到一个“管道”包裹住尽可能多的数据点，在管道内的误差被忽略，只计算管道外的误差。</li>
<li><strong>使用场景</strong>：高维数据，或者数据关系非常复杂非线性时（配合核函数）。</li>
</ul>
<p><strong>支持向量回归</strong>模型使用示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 支持向量回归 (SVR)</span>
<span class="hljs-keyword">from</span> sklearn.svm <span class="hljs-keyword">import</span> SVR
<span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LinearRegression
<span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> StandardScaler
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> mean_squared_error

<span class="hljs-comment"># 1. 构造复杂非线性测试数据</span>
np.random.seed(<span class="hljs-number">42</span>)  <span class="hljs-comment"># 设置随机种子以确保结果可复现</span>

<span class="hljs-comment"># 生成基础自变量（在0-10范围内）</span>
X = np.sort(np.random.rand(<span class="hljs-number">100</span>, <span class="hljs-number">1</span>) * <span class="hljs-number">10</span>, axis=<span class="hljs-number">0</span>)

<span class="hljs-comment"># 生成复杂的非线性目标变量：正弦函数 + 多项式 + 噪声</span>
<span class="hljs-comment"># 这种非线性关系很难用普通线性回归拟合</span>
Y_true = np.sin(<span class="hljs-number">2</span> * X) + <span class="hljs-number">0.5</span> * X + <span class="hljs-number">0.2</span> * X**<span class="hljs-number">2</span>
Y = Y_true + np.random.randn(<span class="hljs-number">100</span>, <span class="hljs-number">1</span>) * <span class="hljs-number">0.5</span>  <span class="hljs-comment"># 加入噪声</span>

<span class="hljs-comment"># 2. 数据标准化</span>
scaler_X = StandardScaler()
scaler_Y = StandardScaler()

X_scaled = scaler_X.fit_transform(X)
Y_scaled = scaler_Y.fit_transform(Y)

<span class="hljs-comment"># 3. 模型训练</span>

<span class="hljs-comment"># 普通线性回归（作为基准）</span>
linear_model = LinearRegression()
linear_model.fit(X_scaled, Y_scaled)
Y_linear_pred_scaled = linear_model.predict(X_scaled)
Y_linear_pred = scaler_Y.inverse_transform(Y_linear_pred_scaled)

<span class="hljs-comment"># 支持向量回归 (SVR)</span>
<span class="hljs-comment"># 线性核SVR</span>
svr_linear = SVR(kernel=<span class="hljs-string">"linear"</span>, C=<span class="hljs-number">100</span>, epsilon=<span class="hljs-number">0.1</span>)
svr_linear.fit(X_scaled, Y_scaled.ravel())
Y_svr_linear_pred_scaled = svr_linear.predict(X_scaled)
Y_svr_linear_pred = scaler_Y.inverse_transform(Y_svr_linear_pred_scaled.reshape(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>))

<span class="hljs-comment"># RBF核SVR（非线性）</span>
svr_rbf_1 = SVR(kernel=<span class="hljs-string">"rbf"</span>, C=<span class="hljs-number">100</span>, epsilon=<span class="hljs-number">0.1</span>, gamma=<span class="hljs-number">0.1</span>)
svr_rbf_1.fit(X_scaled, Y_scaled.ravel())
Y_svr_rbf_1_pred_scaled = svr_rbf_1.predict(X_scaled)
Y_svr_rbf_1_pred = scaler_Y.inverse_transform(Y_svr_rbf_1_pred_scaled.reshape(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>))

<span class="hljs-comment"># 不同ε值的RBF核SVR</span>
svr_rbf_2 = SVR(kernel=<span class="hljs-string">"rbf"</span>, C=<span class="hljs-number">100</span>, epsilon=<span class="hljs-number">0.5</span>, gamma=<span class="hljs-number">0.1</span>)
svr_rbf_2.fit(X_scaled, Y_scaled.ravel())
Y_svr_rbf_2_pred_scaled = svr_rbf_2.predict(X_scaled)
Y_svr_rbf_2_pred = scaler_Y.inverse_transform(Y_svr_rbf_2_pred_scaled.reshape(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>))

<span class="hljs-comment"># 4. 计算模型性能</span>
mse_linear = mean_squared_error(Y, Y_linear_pred)
mse_svr_linear = mean_squared_error(Y, Y_svr_linear_pred)
mse_svr_rbf_1 = mean_squared_error(Y, Y_svr_rbf_1_pred)
mse_svr_rbf_2 = mean_squared_error(Y, Y_svr_rbf_2_pred)

<span class="hljs-comment"># 5. 可视化结果</span>
<span class="hljs-comment"># ... 省略 ...</span>

<span class="hljs-comment"># 4. 输出模型性能</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 模型性能对比 ==="</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"普通线性回归 MSE: <span class="hljs-subst">{mse_linear:<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"线性核SVR MSE: <span class="hljs-subst">{mse_svr_linear:<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"RBF核SVR (ε=0.1) MSE: <span class="hljs-subst">{mse_svr_rbf_1:<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"RBF核SVR (ε=0.5) MSE: <span class="hljs-subst">{mse_svr_rbf_2:<span class="hljs-number">.4</span>f}</span>"</span>)

<span class="hljs-comment"># 展示支持向量</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n=== SVR支持向量信息 ==="</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"RBF核SVR (ε=0.1) 使用的支持向量数量: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(svr_rbf_1.support_)}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"线性核SVR 使用的支持向量数量: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(svr_linear.support_)}</span>"</span>)

<span class="hljs-comment">## 运行结果：</span>
<span class="hljs-string">'''
=== 模型性能对比 ===
普通线性回归 MSE: 3.3016
线性核SVR MSE: 3.3938
RBF核SVR (ε=0.1) MSE: 0.6200
RBF核SVR (ε=0.5) MSE: 4.7397

=== SVR支持向量信息 ===
RBF核SVR (ε=0.1) 使用的支持向量数量: 42
线性核SVR 使用的支持向量数量: 70
'''</span>
</code></pre>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/830e1736a5844a9f9dc831b37028df22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681791&amp;x-signature=W1AJW8cFoN0309ZaWvBR1PWGBPw%3D" alt="" loading="lazy"/></p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e994f6523399446b9d043c24d90c8e21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681791&amp;x-signature=oApaLRS8L%2FEv5BPdPAcudgYGD24%3D" alt="" loading="lazy"/></p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08a0da62599642dc92eec478630292fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681791&amp;x-signature=i2qDvPT4MRNmobJZxDWRyaptPLA%3D" alt="" loading="lazy"/></p>
<p>从图中可以看出：</p>
<ul>
<li>RBF核SVR能够很好地拟合复杂非线性关系</li>
<li>调整ε可以控制模型对误差的容忍度</li>
<li>调整C可以平衡模型复杂度和对异常值的敏感度</li>
<li>SVR只使用部分数据点（支持向量）进行预测</li>
</ul>
<p>这个示例完美展示了<code>SVR</code>在处理复杂非线性数据时的优势，特别是其独特的ε-不敏感损失函数和核函数机制。</p>
<h3 data-id="heading-11">1.11. 有序回归 (Ordinal Regression)</h3>
<ul>
<li><strong>一句话概念</strong>：预测的结果是有顺序的类别，比如“低、中、高”或者“不喜欢、一般、喜欢”。</li>
<li><strong>使用场景</strong>：问卷调查评分（1-5分）、电影评级、疾病严重程度分级。</li>
</ul>
<p><strong>有序回归</strong>模型使用示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 有序回归 (Ordinal Regression)</span>
<span class="hljs-keyword">import</span> statsmodels.api <span class="hljs-keyword">as</span> sm
<span class="hljs-keyword">from</span> statsmodels.miscmodels.ordinal_model <span class="hljs-keyword">import</span> OrderedModel

<span class="hljs-comment"># 1. 构造测试数据</span>
np.random.seed(<span class="hljs-number">42</span>)
n_samples = <span class="hljs-number">500</span>

<span class="hljs-comment"># 特征：年龄（0-70岁）和购买金额（0-100元）</span>
age = np.random.uniform(<span class="hljs-number">0</span>, <span class="hljs-number">70</span>, n_samples)
purchase = np.random.uniform(<span class="hljs-number">0</span>, <span class="hljs-number">100</span>, n_samples)

<span class="hljs-comment"># 真实系数：购买金额对满意度影响更大</span>
beta_age = <span class="hljs-number">0.03</span>  <span class="hljs-comment"># 年龄系数</span>
beta_purchase = <span class="hljs-number">0.08</span>  <span class="hljs-comment"># 购买金额系数</span>
intercept = -<span class="hljs-number">2.0</span>  <span class="hljs-comment"># 基准截距</span>

<span class="hljs-comment"># 潜在变量（连续值，用于生成有序类别）</span>
latent = (
    intercept
    + beta_age * age
    + beta_purchase * purchase
    + np.random.normal(<span class="hljs-number">0</span>, <span class="hljs-number">0.5</span>, n_samples)
)

<span class="hljs-comment"># 使用分位数创建5个均衡的有序类别（1-5分满意度）</span>
thresholds = np.percentile(latent, [<span class="hljs-number">20</span>, <span class="hljs-number">40</span>, <span class="hljs-number">60</span>, <span class="hljs-number">80</span>])
satisfaction = np.digitize(latent, thresholds, right=<span class="hljs-literal">False</span>) + <span class="hljs-number">1</span>  <span class="hljs-comment"># 类别：1-5</span>

<span class="hljs-comment"># 创建DataFrame</span>
df = pd.DataFrame({<span class="hljs-string">"age"</span>: age, <span class="hljs-string">"purchase"</span>: purchase, <span class="hljs-string">"satisfaction"</span>: satisfaction})

<span class="hljs-comment"># 2. 拟合有序回归模型</span>
model = OrderedModel(
    df[<span class="hljs-string">"satisfaction"</span>], df[[<span class="hljs-string">"age"</span>, <span class="hljs-string">"purchase"</span>]], distr=<span class="hljs-string">"logit"</span>  <span class="hljs-comment"># 逻辑斯蒂链接函数</span>
)

result = model.fit(method=<span class="hljs-string">"bfgs"</span>)  <span class="hljs-comment"># 使用BFGS优化算法</span>

<span class="hljs-comment"># 3. 生成预测</span>
pred_probs = result.predict(df[[<span class="hljs-string">"age"</span>, <span class="hljs-string">"purchase"</span>]])
predicted = pred_probs.idxmax(axis=<span class="hljs-number">1</span>).astype(<span class="hljs-built_in">int</span>)  <span class="hljs-comment"># 预测的类别（概率最高的）</span>

<span class="hljs-comment"># 4. 可视化结果</span>
<span class="hljs-comment"># ... 省略 ...</span>

<span class="hljs-comment"># 5. 模型解释</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n模型系数解释:"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"年龄系数: <span class="hljs-subst">{result.params[<span class="hljs-string">'age'</span>]:<span class="hljs-number">.4</span>f}</span> - 年龄每增加1岁，满意度的潜在变量变化"</span>)
<span class="hljs-built_in">print</span>(
    <span class="hljs-string">f"购买金额系数: <span class="hljs-subst">{result.params[<span class="hljs-string">'purchase'</span>]:<span class="hljs-number">.4</span>f}</span> - 购买金额每增加1元，满意度的潜在变量变化"</span>
)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n阈值估计:"</span>)
<span class="hljs-keyword">for</span> i, threshold <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(result.params[<span class="hljs-number">2</span>:]):  <span class="hljs-comment"># 前两个是特征系数，后面是阈值</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"满意度 <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>-<span class="hljs-subst">{i+<span class="hljs-number">2</span>}</span> 阈值: <span class="hljs-subst">{threshold:<span class="hljs-number">.4</span>f}</span>"</span>)

<span class="hljs-comment">## 运行结果：</span>
<span class="hljs-string">'''
模型系数解释:
年龄系数: 0.0872 - 年龄每增加1岁，满意度的潜在变量变化
购买金额系数: 0.2626 - 购买金额每增加1元，满意度的潜在变量变化

阈值估计:
满意度 1-2 阈值: 7.8416
满意度 2-3 阈值: 1.6160
满意度 3-4 阈值: 1.6758
满意度 4-5 阈值: 1.6772
'''</span>
</code></pre>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09875e925caf4e9389a425cdf92fd2e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681791&amp;x-signature=F%2B0F9Bz35yM1MU7BbJ4Kxjaa0lk%3D" alt="" loading="lazy"/></p>
<p>从图中可以看出：</p>
<ul>
<li>特征系数表示对潜在变量的影响程度</li>
<li>阈值参数表示类别之间的分界点</li>
<li>购买金额的影响大于年龄，符合数据生成逻辑</li>
</ul>
<p>该代码完整展示了<strong>有序回归</strong>的理论基础、实现方法和结果分析，特别适合处理如满意度评分、等级评定等有序分类数据。</p>
<h3 data-id="heading-12">1.12. 泊松回归 (Poisson Regression)</h3>
<ul>
<li><strong>一句话概念</strong>：专门用于预测“次数”或“计数”的回归，假设数据符合泊松分布。</li>
<li><strong>使用场景</strong>：预测某个路口每小时经过的车辆数、客服中心每天接到的电话数。</li>
</ul>
<p><strong>泊松回归</strong>模型使用示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 泊松回归 (Poisson Regression)</span>
<span class="hljs-keyword">from</span> scipy <span class="hljs-keyword">import</span> stats
<span class="hljs-keyword">from</span> scipy.optimize <span class="hljs-keyword">import</span> minimize
<span class="hljs-keyword">from</span> scipy.special <span class="hljs-keyword">import</span> gammaln
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> mean_squared_error, mean_absolute_error

<span class="hljs-comment"># 生成模拟数据：模拟客服中心每天接到的电话数</span>
np.random.seed(<span class="hljs-number">42</span>)  <span class="hljs-comment"># 设置随机种子确保结果可复现</span>

<span class="hljs-comment"># 自变量：广告投入（万元），工作日标识（1为工作日，0为非工作日）</span>
n_samples = <span class="hljs-number">200</span>
advertising_spend = np.random.uniform(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>, n_samples)  <span class="hljs-comment"># 广告投入0-10万元</span>
is_weekday = np.random.binomial(<span class="hljs-number">1</span>, <span class="hljs-number">0.7</span>, n_samples)       <span class="hljs-comment"># 70%是工作日</span>

<span class="hljs-comment"># 构造线性预测变量（使用对数链接函数）</span>
linear_combination = <span class="hljs-number">0.5</span> + <span class="hljs-number">0.3</span> * advertising_spend + <span class="hljs-number">0.4</span> * is_weekday
<span class="hljs-comment"># 泊松回归的期望值（均值）为 exp(线性组合)</span>
expected_counts = np.exp(linear_combination)

<span class="hljs-comment"># 生成泊松分布的响应变量（电话数量）</span>
calls_count = np.random.poisson(expected_counts)

<span class="hljs-comment"># 创建数据集</span>
X = np.column_stack([advertising_spend, is_weekday])
y = calls_count

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"生成了 <span class="hljs-subst">{n_samples}</span> 个样本"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"平均电话数量: <span class="hljs-subst">{np.mean(y):<span class="hljs-number">.2</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"电话数量的标准差: <span class="hljs-subst">{np.std(y):<span class="hljs-number">.2</span>f}</span>"</span>)

<span class="hljs-comment"># 泊松回归模型实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PoissonRegression</span>:
    <span class="hljs-comment"># ... 省略 ...</span>

<span class="hljs-comment"># 拟合泊松回归模型</span>
poisson_reg = PoissonRegression()
poisson_reg.fit(X, y)

<span class="hljs-comment"># 预测</span>
y_pred = poisson_reg.predict(X)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"泊松回归系数:"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"截距: <span class="hljs-subst">{poisson_reg.coefficients[<span class="hljs-number">0</span>]:<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"广告投入系数: <span class="hljs-subst">{poisson_reg.coefficients[<span class="hljs-number">1</span>]:<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"工作日系数: <span class="hljs-subst">{poisson_reg.coefficients[<span class="hljs-number">2</span>]:<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"广告投入每增加1万元，电话数量变化倍数: <span class="hljs-subst">{np.exp(poisson_reg.coefficients[<span class="hljs-number">1</span>]):<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"工作日相比非工作日电话数量变化倍数: <span class="hljs-subst">{np.exp(poisson_reg.coefficients[<span class="hljs-number">2</span>]):<span class="hljs-number">.4</span>f}</span>"</span>)

<span class="hljs-comment"># 绘制结果图像</span>
<span class="hljs-comment"># ... 省略 ...</span>

<span class="hljs-comment"># 计算模型性能指标</span>
mse = mean_squared_error(y, y_pred)
mae = mean_absolute_error(y, y_pred)
rmse = np.sqrt(mse)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n模型性能指标:"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"均方误差 (MSE): <span class="hljs-subst">{mse:<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"平均绝对误差 (MAE): <span class="hljs-subst">{mae:<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"均方根误差 (RMSE): <span class="hljs-subst">{rmse:<span class="hljs-number">.4</span>f}</span>"</span>)

<span class="hljs-comment">## 运行结果：</span>
<span class="hljs-string">'''
生成了 200 个样本
平均电话数量: 13.93
电话数量的标准差: 13.13
泊松回归系数:
截距: 0.4484
广告投入系数: 0.3098
工作日系数: 0.3904
广告投入每增加1万元，电话数量变化倍数: 1.3632
工作日相比非工作日电话数量变化倍数: 1.4775

模型性能指标:
均方误差 (MSE): 14.5815
平均绝对误差 (MAE): 2.8126
均方根误差 (RMSE): 3.8186
'''</span>
</code></pre>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/829d363f23b149ac9ff340b7cb87a05a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681791&amp;x-signature=yvJZGFCp7mYB9bzPyRsWxuWG%2FeE%3D" alt="" loading="lazy"/></p>
<p><strong>泊松回归模型</strong>的优势体现在以下几个方面：</p>
<ol>
<li><strong>适用于计数数据</strong>：泊松回归特别适合预测计数型变量（如电话数量），假设响应变量服从泊松分布，且其方差等于均值，能够很好地处理计数数据中常见的方差随均值变化的情况。</li>
<li><strong>保证非负预测</strong>：通过使用对数链接函数，确保了预测值始终为正数，避免了可能出现的负数计数问题，符合计数数据的特性。</li>
<li><strong>解释性强且适用稀有事件</strong>：回归系数易于解释为自变量变化对计数的乘性影响，并且在事件发生频率较低时表现良好，适合于客服电话、交通事故等低频事件的预测。</li>
</ol>
<p>这个示例模拟了客服中心电话数量预测的场景，其中广告投入和是否为工作日作为预测变量，完美展示了泊松回归如何处理计数型数据并提供可解释的结果。</p>
<h3 data-id="heading-13">1.13. 负二项回归 (Negative Binomial Regression)</h3>
<ul>
<li><strong>一句话概念</strong>：也是做计数预测的，但它解决了泊松回归中“方差必须等于均值”的苛刻假设。</li>
<li><strong>使用场景</strong>：数据波动特别大（方差 &gt;&gt; 均值）的计数数据，比如某款冷门商品偶尔大卖的销量预测。</li>
</ul>
<p><strong>负二项回归</strong>模型使用示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 负二项回归 (Negative Binomial Regression)</span>
<span class="hljs-keyword">from</span> scipy.optimize <span class="hljs-keyword">import</span> minimize
<span class="hljs-keyword">from</span> scipy.special <span class="hljs-keyword">import</span> gammaln
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> mean_squared_error, mean_absolute_error

<span class="hljs-comment"># 生成模拟数据：模拟冷门商品销量预测（方差远大于均值的情况）</span>
np.random.seed(<span class="hljs-number">42</span>)  <span class="hljs-comment"># 设置随机种子确保结果可复现</span>

<span class="hljs-comment"># 自变量：促销活动（1为有促销，0为无促销），价格折扣率，商品类别（1为热门商品，0为冷门商品）</span>
n_samples = <span class="hljs-number">300</span>
promotion = np.random.binomial(<span class="hljs-number">1</span>, <span class="hljs-number">0.3</span>, n_samples)  <span class="hljs-comment"># 30%有促销活动</span>
discount_rate = np.random.uniform(<span class="hljs-number">0</span>, <span class="hljs-number">0.3</span>, n_samples)  <span class="hljs-comment"># 0-30%的折扣</span>
is_popular = np.random.binomial(<span class="hljs-number">1</span>, <span class="hljs-number">0.2</span>, n_samples)   <span class="hljs-comment"># 20%是热门商品</span>

<span class="hljs-comment"># 构造线性预测变量（使用对数链接函数）</span>
linear_combination = -<span class="hljs-number">1.0</span> + <span class="hljs-number">1.2</span> * promotion + <span class="hljs-number">0.8</span> * discount_rate + <span class="hljs-number">0.5</span> * is_popular
<span class="hljs-comment"># 负二项回归的均值为 exp(线性组合)</span>
mu = np.exp(linear_combination)

<span class="hljs-comment"># 负二项分布的参数设置（r为离散参数，控制方差）</span>
<span class="hljs-comment"># 方差 = mu + mu^2/r，当r较小时，方差远大于均值</span>
r = <span class="hljs-number">1.5</span>  <span class="hljs-comment"># 较小的r值，使得方差远大于均值</span>

<span class="hljs-comment"># 生成负二项分布的响应变量（销量）</span>
<span class="hljs-comment"># 使用负二项分布：var = mu + mu^2/r，当r小的时候方差很大</span>
<span class="hljs-comment"># 负二项分布的参数转换：p = r/(r+mu)</span>
p = r / (r + mu)
sales_count = np.random.negative_binomial(r, p)

<span class="hljs-comment"># 创建数据集</span>
X = np.column_stack([promotion, discount_rate, is_popular])
y = sales_count

<span class="hljs-comment"># 负二项回归模型实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">NegativeBinomialRegression</span>:
    <span class="hljs-comment"># ... 省略 ...</span>

<span class="hljs-comment"># 拟合负二项回归模型</span>
neg_bin_reg = NegativeBinomialRegression()
neg_bin_reg.fit(X, y)

<span class="hljs-comment"># 预测</span>
y_pred = neg_bin_reg.predict(X)

<span class="hljs-comment"># 绘制结果图像</span>
<span class="hljs-comment"># ... 省略 ...</span>

<span class="hljs-comment"># 计算模型性能指标</span>
mse = mean_squared_error(y, y_pred)
mae = mean_absolute_error(y, y_pred)
rmse = np.sqrt(mse)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n模型性能指标:"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"均方误差 (MSE): <span class="hljs-subst">{mse:<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"平均绝对误差 (MAE): <span class="hljs-subst">{mae:<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"均方根误差 (RMSE): <span class="hljs-subst">{rmse:<span class="hljs-number">.4</span>f}</span>"</span>)

<span class="hljs-comment"># 比较泊松回归和负二项回归的拟合效果</span>
<span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> PoissonRegressor

<span class="hljs-comment"># 使用sklearn的泊松回归进行比较</span>
poisson_reg = PoissonRegressor()
poisson_reg.fit(X, y)
y_pred_poisson = poisson_reg.predict(X)

poisson_mse = mean_squared_error(y, y_pred_poisson)
poisson_mae = mean_absolute_error(y, y_pred_poisson)
poisson_rmse = np.sqrt(poisson_mse)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n与泊松回归的比较:"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"负二项回归 MSE: <span class="hljs-subst">{mse:<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"泊松回归 MSE: <span class="hljs-subst">{poisson_mse:<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"负二项回归 MAE: <span class="hljs-subst">{mae:<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"泊松回归 MAE: <span class="hljs-subst">{poisson_mae:<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"负二项回归 RMSE: <span class="hljs-subst">{rmse:<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"泊松回归 RMSE: <span class="hljs-subst">{poisson_rmse:<span class="hljs-number">.4</span>f}</span>"</span>)

<span class="hljs-comment">## 运行结果：</span>
<span class="hljs-string">'''
模型性能指标:
均方误差 (MSE): 1.0138
平均绝对误差 (MAE): 0.7567
均方根误差 (RMSE): 1.0069

与泊松回归的比较:
负二项回归 MSE: 1.0138
泊松回归 MSE: 1.1612
负二项回归 MAE: 0.7567
泊松回归 MAE: 0.8246
负二项回归 RMSE: 1.0069
泊松回归 RMSE: 1.0776
'''</span>
</code></pre>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b44a14776b8494cb971ebbb2691028f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681791&amp;x-signature=xtMp9GNK2IWbIMXDdfeLhPDbdY0%3D" alt="" loading="lazy"/></p>
<p><strong>负二项回归模型</strong>的优势体现在以下几个方面：</p>
<ol>
<li><strong>解决过度离势问题</strong>：负二项回归能够处理方差大于均值的计数数据，适用于方差/均值比远大于1的情况，如冷门商品偶尔大卖的数据。</li>
<li><strong>更灵活的方差结构</strong>：通过引入离散参数r，负二项回归允许方差独立于均值变化（方差为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>μ</mi><mo>+</mo><msup><mi>μ</mi><mn>2</mn></msup><mi mathvariant="normal">/</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">\mu + \mu^2/r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">μ</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">μ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span></span>），从而更好地拟合实际数据中的变异性。</li>
<li><strong>更好的拟合效果和更真实的假设</strong>：在高变异数据下，负二项回归通常比泊松回归提供更准确的预测，并且其假设更符合实际业务场景中计数数据的统计特性。</li>
</ol>
<p>这个示例模拟了冷门商品销量预测的场景，其中促销活动、折扣率和商品类型作为预测变量，完美展示了<strong>负二项回归</strong>如何处理方差远大于均值的计数型数据，并提供比泊松回归更准确的预测结果。</p>
<h3 data-id="heading-14">1.14. 准泊松回归 (Quasi Poisson Regression)</h3>
<ul>
<li><strong>一句话概念</strong>：泊松回归的另一种替代方案，用来处理由于数据波动过大（过度离散）导致的标准误估计不准的问题。</li>
<li><strong>使用场景</strong>：和负二项回归类似，用于处理过度离散的计数数据。</li>
</ul>
<p><strong>准泊松回归</strong>模型使用示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 准泊松回归 (Quasi Poisson Regression)</span>
<span class="hljs-keyword">from</span> scipy.optimize <span class="hljs-keyword">import</span> minimize
<span class="hljs-keyword">from</span> scipy.special <span class="hljs-keyword">import</span> gammaln
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> mean_squared_error, mean_absolute_error

<span class="hljs-comment"># 生成模拟数据：模拟过度离散的计数数据（如交通事故次数预测）</span>
np.random.seed(<span class="hljs-number">42</span>)  <span class="hljs-comment"># 设置随机种子确保结果可复现</span>

<span class="hljs-comment"># 自变量：道路长度（公里），交通流量（车辆/小时），天气状况（1为恶劣天气，0为正常天气）</span>
n_samples = <span class="hljs-number">250</span>
road_length = np.random.uniform(<span class="hljs-number">1</span>, <span class="hljs-number">20</span>, n_samples)  <span class="hljs-comment"># 道路长度1-20公里</span>
traffic_flow = np.random.uniform(<span class="hljs-number">50</span>, <span class="hljs-number">500</span>, n_samples)  <span class="hljs-comment"># 交通流量50-500辆/小时</span>
bad_weather = np.random.binomial(<span class="hljs-number">1</span>, <span class="hljs-number">0.15</span>, n_samples)  <span class="hljs-comment"># 15%是恶劣天气</span>

<span class="hljs-comment"># 构造线性预测变量（使用对数链接函数）</span>
linear_combination = -<span class="hljs-number">2.0</span> + <span class="hljs-number">0.05</span> * road_length + <span class="hljs-number">0.002</span> * traffic_flow + <span class="hljs-number">0.8</span> * bad_weather
<span class="hljs-comment"># 泊松回归的期望值（均值）为 exp(线性组合)</span>
expected_counts = np.exp(linear_combination)

<span class="hljs-comment"># 为了模拟过度离散，我们引入额外的变异</span>
<span class="hljs-comment"># 生成过度离散的计数数据：均值为expected_counts，但方差更大</span>
<span class="hljs-comment"># 使用负二项分布生成数据，使其具有过度离散特征</span>
dispersion_param = <span class="hljs-number">2.0</span>  <span class="hljs-comment"># 离散参数，控制过度离散程度</span>
r = expected_counts / (dispersion_param - <span class="hljs-number">1</span>)  <span class="hljs-comment"># 负二项分布的参数转换</span>
p = r / (r + expected_counts)
accident_count = np.random.negative_binomial(r, p)

<span class="hljs-comment"># 创建数据集</span>
X = np.column_stack([road_length, traffic_flow, bad_weather])
y = accident_count

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"生成了 <span class="hljs-subst">{n_samples}</span> 个样本"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"平均事故数: <span class="hljs-subst">{np.mean(y):<span class="hljs-number">.2</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"事故数的标准差: <span class="hljs-subst">{np.std(y):<span class="hljs-number">.2</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"方差/均值比: <span class="hljs-subst">{np.var(y)/np.mean(y):<span class="hljs-number">.2</span>f}</span> (泊松分布该比值应为1，大于1表示过度离散)"</span>)

<span class="hljs-comment"># 准泊松回归模型实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">QuasiPoissonRegression</span>:
    <span class="hljs-comment"># ... 省略 ...</span>

<span class="hljs-comment"># 拟合准泊松回归模型</span>
quasi_poisson_reg = QuasiPoissonRegression()
quasi_poisson_reg.fit(X, y)

<span class="hljs-comment"># 预测</span>
y_pred = quasi_poisson_reg.predict(X)
y_var = quasi_poisson_reg.predict_variance(X)

<span class="hljs-comment"># 绘制结果图像</span>
<span class="hljs-comment"># ... 省略 ...</span>

<span class="hljs-comment"># 计算模型性能指标</span>
mse = mean_squared_error(y, y_pred)
mae = mean_absolute_error(y, y_pred)
rmse = np.sqrt(mse)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n模型性能指标:"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"均方误差 (MSE): <span class="hljs-subst">{mse:<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"平均绝对误差 (MAE): <span class="hljs-subst">{mae:<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"均方根误差 (RMSE): <span class="hljs-subst">{rmse:<span class="hljs-number">.4</span>f}</span>"</span>)

<span class="hljs-comment"># 与标准泊松回归的比较</span>
<span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> PoissonRegressor

<span class="hljs-comment"># 使用sklearn的泊松回归进行比较</span>
poisson_reg = PoissonRegressor()
poisson_reg.fit(X, y)
y_pred_poisson = poisson_reg.predict(X)

poisson_mse = mean_squared_error(y, y_pred_poisson)
poisson_mae = mean_absolute_error(y, y_pred_poisson)
poisson_rmse = np.sqrt(poisson_mse)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n与泊松回归的比较:"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"准泊松回归 MSE: <span class="hljs-subst">{mse:<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"泊松回归 MSE: <span class="hljs-subst">{poisson_mse:<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"准泊松回归 MAE: <span class="hljs-subst">{mae:<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"泊松回归 MAE: <span class="hljs-subst">{poisson_mae:<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"准泊松回归 RMSE: <span class="hljs-subst">{rmse:<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"泊松回归 RMSE: <span class="hljs-subst">{poisson_rmse:<span class="hljs-number">.4</span>f}</span>"</span>)

<span class="hljs-comment"># 检查过度离散</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n过度离散检查:"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"数据方差/均值比: <span class="hljs-subst">{np.var(y)/np.mean(y):<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"准泊松估计的离散参数: <span class="hljs-subst">{quasi_poisson_reg.dispersion:<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"离散参数 &gt; 1 表示存在过度离散: <span class="hljs-subst">{quasi_poisson_reg.dispersion &gt; <span class="hljs-number">1</span>}</span>"</span>)

<span class="hljs-comment">## 运行结果：</span>
<span class="hljs-string">'''
模型性能指标:
均方误差 (MSE): 0.8350
平均绝对误差 (MAE): 0.6398
均方根误差 (RMSE): 0.9138

与泊松回归的比较:
准泊松回归 MSE: 0.8350
泊松回归 MSE: 0.8415
准泊松回归 MAE: 0.6398
泊松回归 MAE: 0.6515
准泊松回归 RMSE: 0.9138
泊松回归 RMSE: 0.9174

过度离散检查:
数据方差/均值比: 1.6993
准泊松估计的离散参数: 1.6699
离散参数 &gt; 1 表示存在过度离散: True
'''</span>
</code></pre>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad879291899d462a86c1bdd065789527~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681791&amp;x-signature=obAtjDNZpFV37lm9NQ1ed8zqz9A%3D" alt="" loading="lazy"/></p>
<p><strong>准泊松回归模型</strong>的优势体现在以下几个方面：</p>
<ol>
<li><strong>解决过度离散问题</strong>：准泊松回归通过引入离散参数φ来处理方差大于均值的过度离散数据。在示例中，方差/均值比远大于1（约为2.35），表明存在明显的过度离散现象。</li>
<li><strong>标准误校正</strong>：修正了泊松回归中由于过度离散导致的标准误估计过小的问题，从而提高了统计推断（如置信区间和假设检验）的可靠性。</li>
<li><strong>保持泊松回归的系数</strong>：与泊松回归使用相同的系数估计，但调整了方差估计。这意味着回归系数的解释与泊松回归相同，保持了模型的可解释性。</li>
<li><strong>简单易用</strong>：相比负二项回归，准泊松回归参数更少，计算更简单。准泊松回归只需要估计一个额外的离散参数，而负二项回归需要估计离散参数r。</li>
<li><strong>灵活性强</strong>：可以处理任意程度的过度离散，而不限于特定的分布假设。准泊松回归不假设特定的分布族，只是调整方差结构。</li>
<li><strong>实用性强</strong>：在实际应用中，当数据存在过度离散但又不想使用更复杂的负二项回归时，准泊松是很好的选择。它提供了一个平衡点，既解决了过度离散问题，又保持了模型的简洁性。</li>
<li><strong>计算效率高</strong>：由于使用与泊松回归相同的系数估计方法，计算复杂度较低，适合处理大规模数据。</li>
</ol>
<p>这个示例模拟了交通事故预测的场景，其中道路长度、交通流量和天气状况作为预测变量，完美展示了<strong>准泊松回归</strong>如何处理过度离散的计数型数据，并提供比标准泊松回归更可靠的统计推断。</p>
<h3 data-id="heading-15">1.15. Cox 回归 (Cox Regression)</h3>
<ul>
<li><strong>一句话概念</strong>：用于“生存分析”，研究的是“事件发生需要多长时间”，以及哪些因素影响这个时间。</li>
<li><strong>使用场景</strong>：预测病人确诊后的生存时间、客户流失所需的时间（也就是客户还能留存多久）。</li>
</ul>
<p><strong>COX回归</strong>模型使用示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Cox 回归 (Cox Regression)</span>
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split
<span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> StandardScaler

<span class="hljs-comment"># 导入sksurv库</span>
<span class="hljs-keyword">from</span> sksurv.linear_model <span class="hljs-keyword">import</span> CoxPHSurvivalAnalysis
<span class="hljs-keyword">from</span> sksurv.preprocessing <span class="hljs-keyword">import</span> OneHotEncoder

<span class="hljs-comment"># 第一步：创建Cox回归的测试数据</span>
<span class="hljs-comment"># 模拟医疗数据：患者生存分析</span>
np.random.seed(<span class="hljs-number">42</span>)
n_samples = <span class="hljs-number">300</span>

<span class="hljs-comment"># 生成特征</span>
age = np.random.normal(<span class="hljs-number">60</span>, <span class="hljs-number">15</span>, n_samples)  <span class="hljs-comment"># 患者年龄</span>
treatment = np.random.binomial(<span class="hljs-number">1</span>, <span class="hljs-number">0.5</span>, n_samples)  <span class="hljs-comment"># 是否接受治疗 (0/1)</span>
gender = np.random.binomial(<span class="hljs-number">1</span>, <span class="hljs-number">0.5</span>, n_samples)  <span class="hljs-comment"># 性别 (0/1)</span>
comorbidity = np.random.poisson(<span class="hljs-number">1.5</span>, n_samples)  <span class="hljs-comment"># 并发症数量</span>

<span class="hljs-comment"># 生成生存时间和事件状态</span>
<span class="hljs-comment"># 年龄越大、并发症越多 -&gt; 生存时间越短</span>
<span class="hljs-comment"># 接受治疗 -&gt; 生存时间更长</span>
linear_combination = (
    <span class="hljs-number">0.05</span> * age +
    -<span class="hljs-number">0.8</span> * treatment +
    <span class="hljs-number">0.1</span> * gender +
    <span class="hljs-number">0.3</span> * comorbidity
)

<span class="hljs-comment"># 基线风险函数效应</span>
base_time = np.random.exponential(<span class="hljs-number">2</span>, n_samples)
time_to_event = base_time * np.exp(-linear_combination)

<span class="hljs-comment"># 添加一些删失（并非所有患者都会在研究期间发生事件）</span>
censoring_time = np.random.uniform(<span class="hljs-number">0</span>, np.percentile(time_to_event, <span class="hljs-number">80</span>), n_samples)
observed_time = np.minimum(time_to_event, censoring_time)
event_occurred = time_to_event &lt;= censoring_time

<span class="hljs-comment"># 创建DataFrame</span>
data = pd.DataFrame({
    <span class="hljs-string">'age'</span>: age,
    <span class="hljs-string">'treatment'</span>: treatment,
    <span class="hljs-string">'gender'</span>: gender,
    <span class="hljs-string">'comorbidity'</span>: comorbidity,
    <span class="hljs-string">'time'</span>: observed_time,
    <span class="hljs-string">'event'</span>: event_occurred
})

<span class="hljs-comment"># 第二步：实现Cox回归模型</span>
<span class="hljs-comment"># 为sksurv准备数据</span>
X = data[[<span class="hljs-string">'age'</span>, <span class="hljs-string">'treatment'</span>, <span class="hljs-string">'gender'</span>, <span class="hljs-string">'comorbidity'</span>]].values
y = np.array(<span class="hljs-built_in">list</span>(<span class="hljs-built_in">zip</span>(data[<span class="hljs-string">'event'</span>], data[<span class="hljs-string">'time'</span>])), dtype=[(<span class="hljs-string">'event'</span>, <span class="hljs-string">'?'</span>), (<span class="hljs-string">'time'</span>, <span class="hljs-string">'&lt;f8'</span>)])

<span class="hljs-comment"># 分割数据</span>
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=<span class="hljs-number">0.2</span>, random_state=<span class="hljs-number">42</span>)

<span class="hljs-comment"># 拟合Cox模型</span>
cox_model = CoxPHSurvivalAnalysis()
cox_model.fit(X_train, y_train)

<span class="hljs-comment"># 获取模型系数</span>
cox_coef = cox_model.coef_

<span class="hljs-built_in">print</span>(<span class="hljs-string">"Cox回归模型 (sksurv) - 系数："</span>)
feature_names = [<span class="hljs-string">'年龄'</span>, <span class="hljs-string">'治疗'</span>, <span class="hljs-string">'性别'</span>, <span class="hljs-string">'并发症'</span>]
<span class="hljs-keyword">for</span> i, (name, coef) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(<span class="hljs-built_in">zip</span>(feature_names, cox_coef)):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{name}</span>: <span class="hljs-subst">{coef:<span class="hljs-number">.4</span>f}</span>"</span>)

<span class="hljs-comment"># 在sksurv中，我们可以手动计算风险评分</span>
<span class="hljs-comment"># 风险评分是线性预测器的指数，即 exp(X * coef)</span>
linear_predictor = X_test @ cox_coef
risk_scores = np.exp(linear_predictor)

<span class="hljs-comment"># 第三步：创建可视化</span>
<span class="hljs-comment"># ... 省略 ...</span>

<span class="hljs-comment">## 运行结果：</span>
<span class="hljs-string">'''
Cox回归模型 (sksurv) - 系数：
年龄: 0.0585
治疗: -0.7703
性别: -0.1919
并发症: 0.1779
'''</span>
</code></pre>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2881e56f30c3420488fe22b2553908b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681791&amp;x-signature=9gIo6SZOmyyWmXk8S0edLDCCzZY%3D" alt="" loading="lazy"/></p>
<p><strong>COX回归模型</strong>的优势</p>
<ol>
<li><strong>处理删失数据</strong>：Cox回归适用于右删失数据，适合生存分析。</li>
<li><strong>无需分布假设</strong>：Cox回归不假设生存时间的具体分布，更灵活。</li>
<li><strong>比例风险</strong>：假设个体间的风险比恒定，符合许多实际应用。</li>
<li><strong>系数可解释</strong>：系数直接转换为风险比，易于理解（正系数增加风险，负系数降低风险）。</li>
<li><strong>多个协变量</strong>：能同时分析多个因素对生存时间的影响。</li>
<li><strong>广泛应用于医学</strong>：是临床和流行病学研究中的标准方法。</li>
<li><strong>灵活性</strong>：支持时变协变量及连续和分类预测变量。</li>
<li><strong>风险评分</strong>：可计算个体风险评分，预测相对风险。</li>
</ol>
<h3 data-id="heading-16">1.16. Tobit 回归 (Tobit Regression)</h3>
<ul>
<li><strong>一句话概念</strong>：用于处理“截断”或“审查”数据。比如数据在某个点被切断了（比如收入调查中，高于100万的都记作100万）。</li>
<li><strong>使用场景</strong>：预测家庭在奢侈品上的支出（很多人是0，数据在0处堆积）、传感器量程限制导致的数据截断。</li>
</ul>
<p><strong>Tobit回归</strong>模型使用示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Tobit 回归 (Tobit Regression)</span>
<span class="hljs-keyword">from</span> scipy <span class="hljs-keyword">import</span> stats
<span class="hljs-keyword">from</span> scipy.optimize <span class="hljs-keyword">import</span> minimize

<span class="hljs-comment"># 生成模拟的截断数据集</span>
np.random.seed(<span class="hljs-number">42</span>)

<span class="hljs-comment"># 创建自变量</span>
n_samples = <span class="hljs-number">500</span>
X = np.random.normal(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, n_samples)
<span class="hljs-comment"># 假设真实关系是 y = 2*X + error，但y被截断在0以下</span>
true_beta = <span class="hljs-number">2.0</span>
true_intercept = <span class="hljs-number">0.5</span>
true_sigma = <span class="hljs-number">1.0</span>

<span class="hljs-comment"># 生成未截断的真实值</span>
y_true = true_intercept + true_beta * X + np.random.normal(<span class="hljs-number">0</span>, true_sigma, n_samples)

<span class="hljs-comment"># 设置截断点（例如：低于0的值都记录为0）</span>
lower_limit = <span class="hljs-number">0</span>
y_observed = np.where(y_true &lt; lower_limit, lower_limit, y_true)

<span class="hljs-comment"># 标记被截断的观测值</span>
censored_mask = y_observed == lower_limit

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"生成了<span class="hljs-subst">{n_samples}</span>个样本"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"其中<span class="hljs-subst">{np.<span class="hljs-built_in">sum</span>(censored_mask)}</span>个样本被截断（小于等于<span class="hljs-subst">{lower_limit}</span>）"</span>)

<span class="hljs-comment"># 实现Tobit回归模型</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">TobitRegression</span>:
    <span class="hljs-comment"># ... 省略 ...</span>

<span class="hljs-comment"># 拟合Tobit回归模型</span>
tobit_model = TobitRegression(lower_limit=lower_limit)
tobit_model.fit(X, y_observed)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Tobit回归结果:"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"截距: <span class="hljs-subst">{tobit_model.intercept:<span class="hljs-number">.3</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"系数: <span class="hljs-subst">{tobit_model.beta:<span class="hljs-number">.3</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"标准差: <span class="hljs-subst">{tobit_model.sigma:<span class="hljs-number">.3</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"真实截距: <span class="hljs-subst">{true_intercept}</span>, 真实系数: <span class="hljs-subst">{true_beta}</span>, 真实标准差: <span class="hljs-subst">{true_sigma}</span>"</span>)

<span class="hljs-comment"># 绘制结果图像</span>
<span class="hljs-comment"># ... 省略 ...</span>

<span class="hljs-comment"># 输出一些统计信息</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n模型比较:"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"真实系数: <span class="hljs-subst">{true_beta:<span class="hljs-number">.3</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Tobit回归系数: <span class="hljs-subst">{tobit_model.beta:<span class="hljs-number">.3</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"OLS回归系数: <span class="hljs-subst">{ols_coef[<span class="hljs-number">1</span>]:<span class="hljs-number">.3</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"系数估计偏差 (Tobit): <span class="hljs-subst">{<span class="hljs-built_in">abs</span>(tobit_model.beta - true_beta):<span class="hljs-number">.3</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"系数估计偏差 (OLS): <span class="hljs-subst">{<span class="hljs-built_in">abs</span>(ols_coef[<span class="hljs-number">1</span>] - true_beta):<span class="hljs-number">.3</span>f}</span>"</span>)

<span class="hljs-comment"># 计算均方误差</span>
mse_tobit = np.mean((y_observed - tobit_model.predict(X)) ** <span class="hljs-number">2</span>)
mse_ols = np.mean((y_observed - y_ols_pred) ** <span class="hljs-number">2</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Tobit MSE: <span class="hljs-subst">{mse_tobit:<span class="hljs-number">.3</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"OLS MSE: <span class="hljs-subst">{mse_ols:<span class="hljs-number">.3</span>f}</span>"</span>)

<span class="hljs-comment">## 运行结果：</span>
<span class="hljs-string">'''
Tobit回归结果:
截距: 0.518
系数: 1.932
标准差: 0.990
真实截距: 0.5, 真实系数: 2.0, 真实标准差: 1.0

模型比较:
真实系数: 2.000
Tobit回归系数: 1.932
OLS回归系数: 1.203
系数估计偏差 (Tobit): 0.068
系数估计偏差 (OLS): 0.797
Tobit MSE: 1.623
OLS MSE: 0.755
'''</span>
</code></pre>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f79c146ce0114129a73e2bc5491cd08b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767681791&amp;x-signature=j23NsPi43S%2FssDo%2Bxp5CZ%2Bq1G2I%3D" alt="" loading="lazy"/></p>
<p><strong>Tobit回归模型</strong>的优势主要有：</p>
<ol>
<li><strong>处理截断数据</strong>：Tobit回归适用于处理在特定阈值处被截断的数据（如所有小于0的值记录为0）。</li>
<li><strong>无偏估计</strong>：与普通OLS相比，Tobit回归提供更准确的参数估计，避免了因数据截断导致的偏差。</li>
<li><strong>统计推断</strong>：基于最大似然估计，Tobit回归支持合理的统计推断，包括标准误和置信区间的计算。</li>
<li><strong>适用领域</strong>：广泛应用于经济和社会科学中涉及收入、消费支出及生存分析等存在截断或审查情况的研究。</li>
<li><strong>模型拟合度</strong>：Tobit回归系数更接近真实值，并且通常具有较小的均方误差，表明其对截断数据有更好的适应性。</li>
</ol>
<h2 data-id="heading-17">2. 如何选择合适的回归模型？</h2>
<p>面对这么多模型，到底该选哪一个？我们可以通过以下几个维度来判断：</p>
<ol>
<li><strong>看因变量（Y）长什么样</strong>：
<ul>
<li>是<strong>连续数值</strong>（如房价）： 首选 线性回归。</li>
<li>是<strong>二分类</strong>（如买/不买）： 用 逻辑回归。</li>
<li>是<strong>计数</strong>（如点击次数）： 用 泊松回归 或 负二项回归。</li>
<li>是<strong>生存时间</strong>（如存活天数）： 用 Cox回归。</li>
<li>有<strong>截断</strong>（如上限封顶）： 用 Tobit回归。</li>
</ul>
</li>
<li><strong>看数据是否有问题</strong>：
<ul>
<li><strong>异常值很多</strong>： 考虑 分位数回归 或 Huber回归（鲁棒回归）。</li>
<li><strong>特征非线性</strong>： 尝试 多项式回归 或 SVR。</li>
<li><strong>特征数 &gt; 样本数</strong>，或特征<strong>严重共线性</strong>： 必须上正则化手段，用 岭回归、Lasso、ElasticNet，或者降维类的 PCR/PLS。</li>
</ul>
</li>
<li><strong>看模型目的</strong>：
<ul>
<li>为了<strong>解释现象</strong>： 简单的线性/逻辑回归最好解释。</li>
<li>为了<strong>精准预测</strong>： SVR、甚至更复杂的机器学习模型（如XGBoost等，虽不在此列但常被比较）可能更好。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-18">3. 总结</h2>
<p>没有最好的模型，只有最适合数据的模型。</p>
<p>对于初学者，先画图看数据分布，然后从最简单的线性回归开始尝试，发现问题（如拟合不好、过拟合）后再逐步尝试更复杂的变体，是最好的学习路径。</p>
<p>为了方便大家尝试各种回归模型，文中各个示例中的数据都是模拟的，不需要另外下载和爬取。</p>
<p>了解和掌握各种回归模型没有捷径，最好的方式就是把文中代码都实际运行一次，改改数据和训练参数，再反复运行体会下效果。</p>
<p>完整的代码：<a href="https://link.juejin.cn?target=https%3A%2F%2Furl11.ctfile.com%2Ff%2F45455611-8586706866-edb36d%3Fp%3D6872" target="_blank" title="https://url11.ctfile.com/f/45455611-8586706866-edb36d?p=6872" ref="nofollow noopener noreferrer">16种回归分析总结.ipynb</a> (访问密码: 6872)</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 编程：重构工作流的思维与实践]]></title>    <link>https://juejin.cn/post/7589214068093779987</link>    <guid>https://juejin.cn/post/7589214068093779987</guid>    <pubDate>2025-12-30T06:47:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589214068093779987" data-draft-id="7589214068093566995" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 编程：重构工作流的思维与实践"/> <meta itemprop="keywords" content="后端,AI编程,Trae"/> <meta itemprop="datePublished" content="2025-12-30T06:47:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="架构精进之路"/> <meta itemprop="url" content="https://juejin.cn/user/3746752294032328"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 编程：重构工作流的思维与实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3746752294032328/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    架构精进之路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T06:47:03.000Z" title="Tue Dec 30 2025 06:47:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong><code>本文系作者 [架构精进之路] 原创，著作权归作者所有，未经授权禁止任何形式的转载、抄袭或盗用，违者必究。</code></strong></p>
<p>弹指间，岁序更迭，又至年末，这一年我们不断奋斗，不断忙碌，真的好似一瞬间，就来到了 2025 年底的时间。</p>
<p>2025 年，是 AI 技术发展突飞猛进的一年。曾经只存在于想象中的智能助手，如今能精准读懂需求、高效处理任务；曾经依赖人工的繁琐工作，如今在 AI 的加持下变得简单快捷；就连创作、设计这些充满人文色彩的领域，也多了一份智能工具的助力。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/650ef7b9ba3d47d69770701db69b2f55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p625p6E57K-6L-b5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767682023&amp;x-signature=KBYsxjXx%2BzNzwBpXGEL7%2FPY%2Bg8o%3D" alt="" loading="lazy"/></p>
<p>这一年，AI 不再是遥远的科技概念，而是悄然融入了工作与生活的角角落落。正好跟随「掘金 · 年终技术征文」活动，一起总结记录下AI 编程的心得体会。</p>
<h2 data-id="heading-0">一、Vibe Coding 到底是个啥？</h2>
<p>今年 AI 界有一个很潮、很酷的新词儿：“<strong>Vibe Coding</strong>”，乍一听有点懵，到底啥是“Vibe Coding”？写代码还要讲究个氛围感吗？</p>
<p>今天我就以一个码农的视角，聊聊对 “Vibe Coding” 的理解。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b785914e0214b6aa3b3c114472724a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p625p6E57K-6L-b5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767682023&amp;x-signature=uWAdQBVoGe8N2IVxoEobAv%2FclRU%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-1">1.1 什么是 Vibe Coding？</h3>
<p>Vibe 本来就是“氛围”、“感觉”的意思，所以直译过来就是“氛围编程”或“沉浸式编程”。但这里的“沉浸”不仅仅是让你沉浸在一个有仪式感的编程环境里，更重要的是它颠覆了我们以往写代码的方式。</p>
<p><strong>我直接上核心观点：就是从「计算机语言描述工作流程」到「自然语言描述工作流程」的转变。</strong></p>
<p>打破编程门槛：AI 让每个人都能"编程"</p>
<p>Vibe Coding 压根就不关心你代码具体怎么实现的，核心关注点是代码生成的结果对不对。至于实现逻辑、底层细节这些繁琐的活，都交给 AI 去搞定。我只需要盯着效果，觉得哪里不对、哪里有问题，就直接改 Prompt，重新提需求，AI 会自动帮你调整和优化，直到最后结果完全符合你的预期为止。</p>
<p>整个过程你都沉浸在 “<strong>说想法—&gt;看结果—&gt;继续调整—&gt;再出结果</strong>” 的循环里，效率高得飞起。</p>
<p>我画了个大概流程图，执行流程如下所示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1221382d5444ce3a2ec8e42121b64d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p625p6E57K-6L-b5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767682023&amp;x-signature=eN%2BXnXPHkHn7ufQrDSHFTb5kCRc%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>举个生活化的例子：就像点外卖一样，你只管选菜，AI 帮你做。菜端上来不合口味？你直接点评它！AI 厨子立刻再改，直到喂到你满意。</p>
</blockquote>
<h3 data-id="heading-2">1.2 核心提炼：工作流思维</h3>
<p>传统编程 vs Vibe Coding：开发模式的核心变革</p>
<p><strong>1、传统编程：以技术实现为核心</strong></p>
<p>传统编程围绕<strong>程序、程序员、软件工程</strong>三大支柱展开，具有显著特点：</p>
<ul>
<li>
<p>入门门槛高，学习周期长</p>
</li>
<li>
<p>需系统掌握编程语言语法、开发框架、调试技巧等技术细节</p>
</li>
<li>
<p>核心要求是程序员明确知道 “怎么做”，通过手动编码实现功能</p>
</li>
</ul>
<p><strong>2、Vibe Coding：以需求描述为核心</strong></p>
<p>Vibe Coding 是一种依托 AI 能力的新型开发模式，核心逻辑高度聚焦：</p>
<ul>
<li>
<p>用自然语言精准描述业务需求与工作流</p>
</li>
<li>
<p>由 AI 自动完成代码生成、任务执行与细节处理</p>
</li>
<li>
<p>核心要求是使用者清晰定义 “做什么”，无需纠结技术实现路径</p>
</li>
</ul>
<p><strong>3、Vibe Coding 核心特征总结</strong></p>
<ol>
<li>
<p><strong>本质是 “用自然语言定义工作流”</strong></p>
<ol>
<li>
<p>摆脱编程语言语法、框架的束缚，无需专业编程基础</p>
</li>
<li>
<p>核心门槛在于<strong>对业务流程的深度理解</strong></p>
</li>
<li>
<p>重心从 “技术实现” 转向 “需求定义”</p>
</li>
</ol>
</li>
<li>
<p><strong>开发模式升级：从 “人做” 到 “人想，AI 做”</strong></p>
<ol>
<li>
<p><strong>人</strong>的角色：需求提出者、流程设计者、结果审核者</p>
</li>
<li>
<p><strong>AI</strong>的角色：代码生成器、任务执行者、细节处理者</p>
</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd29a4a418d747989e7c76af1eef97c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p625p6E57K-6L-b5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767682023&amp;x-signature=SdwjHN78cWYRszsK0p1o5zWGC5U%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p><strong>适用场景清晰划分</strong></p>
<ol>
<li>
<p><strong>高度适配场景</strong>：MVP 产品快速验证、内部工具开发（数据处理、文件整理等）、创意方案原型测试</p>
</li>
<li>
<p><strong>暂不适用场景</strong>：复杂业务逻辑开发（需人工决策与逻辑校验）、性能关键路径构建（需深度人工优化）</p>
</li>
</ol>
</li>
</ol>
<h2 data-id="heading-3">二、程序员视角下的 Vibe Coding</h2>
<h3 data-id="heading-4">2.1 利用 Trea 进行 Vibe Coding 的应用实践</h3>
<blockquote>
<p>Trae.ai 是个 AI 编程 IDE，字节跳动的产品，目前是免费使用，写代码、查文档、加接口都可以，和它对话就能改功能、查问题，事半功倍。</p>
</blockquote>
<p><strong>1、生成提示词</strong></p>
<p>写不好提示词，没关系，这一步AI可以帮我们很好的搞定！</p>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmovie.douban.com%2Ftop250" target="_blank" title="https://movie.douban.com/top250" ref="nofollow noopener noreferrer">movie.douban.com/top250</a> 我希望获取这个网站的数据，帮我生成一份爬虫项目的提示词</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41f764689d14469b9348f88006982206~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p625p6E57K-6L-b5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767682023&amp;x-signature=5EY2%2FlYUyTinzndGnWmcd39bthI%3D" alt="" loading="lazy"/></p>
<p><strong>2、生成项目代码并执行</strong></p>
<p>有了提示词，可以参考它执行，生成我们需要的项目代码了。</p>
<p>执行过程中，可能会出现如下需要我们确认执行的步骤，一般确认<strong>运行</strong>即可。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7967a1153233424c81d7ea371a5a3f11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p625p6E57K-6L-b5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767682023&amp;x-signature=7pGXdF6ORK7BkFRrdzEwjVXxRyw%3D" alt="" loading="lazy"/></p>
<p>最终生成一份可执行代码，并可执行并验证，整体效率非常高效！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1f1ffc5e18f4cae9eedd658cf84aeb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p625p6E57K-6L-b5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767682023&amp;x-signature=DTJv2DsErTp%2BXPubsb1nuu7A2jo%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47c8ac228fef4ae8b90eb9f90c3f7f2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p625p6E57K-6L-b5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767682023&amp;x-signature=rmY3e7DeRVAUOZ%2B73t1NuDG%2Bweo%3D" alt="" loading="lazy"/></p>
<p><strong>3、生成可渲染展示页面</strong></p>
<p>为了更直观的查看数据，生成可运行的 Web 服务来渲染这些数据。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8afc437a3c2f4030b2d01a4363ebbdc7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p625p6E57K-6L-b5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767682023&amp;x-signature=9Reh9nUUFZO5jIQmHs6dVCkuU14%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c754483f27ef4aeea44fdff4d73d38c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p625p6E57K-6L-b5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767682023&amp;x-signature=%2Fyob%2BO1PFaH45%2FrSkFJxWnj6VSU%3D" alt="" loading="lazy"/></p>
<p>如果需要更好的查看体验，可以继续调试添加分页能力。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/289ba0383f8a4c438d0e70e7cbc55323~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p625p6E57K-6L-b5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767682023&amp;x-signature=nu327WLO4IYKfu7PaWaHSvlHXNE%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e44cd3ccad4a4e688cb1c59cf4a5a892~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p625p6E57K-6L-b5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767682023&amp;x-signature=Cv9Z7G9RKAV77D30JcdlvBXkAVI%3D" alt="" loading="lazy"/></p>
<p>上述整体步骤非常高效，前后不过几分钟而已，Trea 堪称开发利器。</p>
<h3 data-id="heading-5">2.2 AI 编程的缺点与挑战</h3>
<p><strong>1、天生缺乏业务场景深度理解</strong></p>
<ul>
<li><strong>核心现象</strong></li>
</ul>
<p>AI 生成的代码，经常会陷入“技术正确，业务失真”的困境——语法合规、可编译运行，但完全不符合真实业务的约束条件与核心诉求。</p>
<ul>
<li><strong>典型案例：电影数据展示列表场景</strong></li>
</ul>
<p>AI 仅生成通用的电影数据列表展示代码，却忽略豆瓣Top250项目的核心业务规则：</p>
<ul>
<li>
<p>业务中需按“评分降序、上映时间筛选”双维度排序展示电影</p>
</li>
<li>
<p>需实现分页加载（避免一次性加载250条数据卡顿）、数据异常兜底（部分电影信息缺失时的友好展示）等核心逻辑</p>
</li>
</ul>
<p>最终结果是“代码看似专业，实则无法满足豆瓣Top250项目的核心展示需求与用户体验要求”。</p>
<ul>
<li><strong>解决思路</strong></li>
</ul>
<p>由人明确定义不可让步的业务规则与约束条件，为 AI 划定业务边界。</p>
<p><strong>2、对性能问题极度不敏感</strong></p>
<ul>
<li><strong>核心现象</strong></li>
</ul>
<p>AI 生成的方案逻辑无误，但工程实现成本极高；小数据量测试时表现正常，一旦上线面对真实流量便会瞬间“翻车”。</p>
<ul>
<li><strong>典型案例</strong></li>
</ul>
<p>案例一：列表数据加载性能崩塌</p>
<p>补充完“评分排序、上映时间筛选”逻辑后，AI 快速实现了数据展示功能，但方案存在致命缺陷：默认一次性加载全部250条电影数据，未做分页处理与图片懒加载优化，导致页面首次加载耗时超 8 秒，滚动时出现明显卡顿，移动端甚至直接白屏。</p>
<p>案例二：列表数据接口异常处理缺失</p>
<p>AI 给出的项目初版方案中，直接调用豆瓣公开接口获取数据，但未设计任何异常应对逻辑：当接口请求超时、返回数据格式异常或接口限流时，页面直接空白无提示，用户无法判断是网络问题还是服务问题，体验极差。</p>
<ul>
<li><strong>问题根源</strong></li>
</ul>
<p>AI 的优化目标是“推理逻辑正确性”，而非“系统长期运行的稳定性与成本可控性”，天然缺失工程化的性能考量。</p>
<ul>
<li><strong>解决思路</strong></li>
</ul>
<p>1. 人先主导分析：明确系统性能瓶颈所在（IO、CPU、内存、模型加载等）；</p>
<p>2. 再引导 AI 优化：针对性提出缓存方案、服务常驻化设计、预加载机制、资源池搭建等性能优化需求。</p>
<p><strong>3、异常与边界处理严重缺失</strong></p>
<ul>
<li><strong>核心现象</strong></li>
</ul>
<p>AI 生成的代码在“理想流程（Happy Path）”下表现完美，但缺乏对异常场景的应对能力，一旦出现意外情况便直接崩溃。</p>
<ul>
<li>
<p><strong>典型缺失的异常处理场景</strong></p>
<ul>
<li>
<p>豆瓣接口请求超时、返回数据格式异常及重试策略缺失；</p>
</li>
<li>
<p>电影封面图加载失败、部分字段（如导演、演员）缺失等数据异常的兼容处理；</p>
</li>
<li>
<p>豆瓣接口限流时的降级展示逻辑（如加载本地缓存数据）。</p>
</li>
</ul>
</li>
<li>
<p><strong>问题本质</strong></p>
</li>
</ul>
<p>AI 默认预设“理想运行环境”，但真实生产环境是“持续面临各类异常的复杂系统”，这种认知偏差导致其无法主动构建健壮的容错机制。</p>
<ul>
<li><strong>应对方式</strong></li>
</ul>
<p>由人主动补充完善容错体系：明确异常分级标准、制定服务降级策略、设计超时控制与熔断机制。</p>
<p><strong>核心总结：工程质量的高低，取决于你对“失败与异常”的预期深度。</strong></p>
<h2 data-id="heading-6">三、如何正确理解重构工作流</h2>
<p>个人对 [ vibecoding 加成下 ] 重构工作流的理解</p>
<blockquote>
<p>AI 不是来当主厨的，是为了让主厨不用天天切土豆</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e44064f08036433f862cb012695e0e52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p625p6E57K-6L-b5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767682023&amp;x-signature=WbU10AQn2p7yEpxhrTFKKkjdmJU%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">3.1 构思全自动化工作流</h3>
<p><strong>关键原则：摒弃“一步到位”的完美主义，先让“流程跑通”</strong></p>
<p><strong>核心目标</strong>：构建无需人工介入，即可完成从数据获取、处理到展示的全链路自动化流程</p>
<p><strong>项目案例（豆瓣Top250电影数据展示）</strong>：</p>
<ul>
<li>
<p>程序自动化流程：AI 生成定时任务脚本（每日凌晨触发）→ 自动调用豆瓣接口获取最新Top250数据 → AI 自动处理数据格式（标准化字段、补全缺失值默认值）→ 自动同步至前端展示数据库 → 前端页面自动拉取数据并渲染</p>
</li>
<li>
<p>落地优先级：先实现“无人工干预的基础数据展示”，暂不纠结细节优化（如极致加载速度、个性化筛选）；待流程稳定跑通后，再针对性迭代自动化优化逻辑</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78603660413d4434963e2862b4c00e47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p625p6E57K-6L-b5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767682023&amp;x-signature=po4wKE0P2HWAiXqzxGlWELYp5u4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">3.2 人的价值不可忽视</h3>
<p><strong>关键原则</strong>：<strong>人的核心价值在于 --- 决策、审核、优化</strong></p>
<p><strong>核心目标</strong>：在关键节点加入人工审核和优化，避免自动化流程“跑偏”</p>
<p><strong>项目案例（豆瓣Top250电影数据展示）</strong>：</p>
<ul>
<li>
<p>决策环节：确定核心业务规则（如“评分降序+上映时间筛选”的排序逻辑、分页条数设置、异常数据兜底规则），为AI自动化流程划定边界；</p>
</li>
<li>
<p>审核环节：在“数据同步至展示数据库”前增设人工审核节点，校验AI处理后的数据准确性（如是否存在错误评分、缺失关键电影信息等），避免错误数据直接展示给用户；</p>
</li>
<li>
<p>优化环节：监控自动化流程运行状态（如接口请求成功率、页面加载性能），针对卡顿、数据异常等问题，向AI提出精准优化需求（如添加接口重试机制、优化图片加载策略），推动流程迭代升级</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8eda3346b6584fec8ed5939855ebb8a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p625p6E57K-6L-b5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767682023&amp;x-signature=nHrIZnneTq2gtaWFd8aQR4PvQYE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">四、总结</h2>
<p>回望这一年的点滴，我历经诸多变迁，在跌撞中摸索，在求索里前行。惟愿不负韶华，始终心怀热忱，向上生长，步履不停。</p>
<p>最后，跟大家分享下自己 AI 学习的三个观点：</p>
<p><strong>1、LLM带来的不是更高层次抽象，而是不同性质的抽象</strong></p>
<p>传统编程的抽象（如函数、类、框架）是确定性抽象；LLM 的抽象则是概率性抽象，其本质是基于海量文本规律统计</p>
<p><strong>2、大模型把非确定性引入了软件开发的核心路径</strong></p>
<p>传统软件开发的核心路径（需求→设计→编码→测试→部署）是确定性闭环，而LLM则从生成、理解、迭代环节的非确定性打破了这一闭环</p>
<p><strong>3、软件工程的重心正在从写对的代码转向管理意图与结果之间的偏差</strong></p>
<p>传统软件工程的核心是 “代码正确性”，LLM 普及后，编码效率大幅提升，但“意图 vs 结果”偏差成为新的核心风险</p>
<p><strong>·END·</strong></p>
<p>希望今天的讲解对大家有所帮助，谢谢！</p>
<p>Thanks for reading!</p>
<blockquote>
<p>作者：架构精进之路，十年研发风雨路，大厂架构师，CSDN 博客专家，专注架构技术沉淀学习及分享，职业与认知升级，坚持分享接地气儿的干货文章，期待与你一起成长。<br/>
关注并私信我回复“01”，送你一份程序员成长进阶大礼包，欢迎勾搭。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[微博/朋友圈/点赞/评论系统设计]]></title>    <link>https://juejin.cn/post/7589214068093173779</link>    <guid>https://juejin.cn/post/7589214068093173779</guid>    <pubDate>2025-12-30T05:58:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589214068093173779" data-draft-id="7589126217234726918" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="微博/朋友圈/点赞/评论系统设计"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-30T05:58:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MMM_FanLe"/> <meta itemprop="url" content="https://juejin.cn/user/2835000434372621"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            微博/朋友圈/点赞/评论系统设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2835000434372621/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MMM_FanLe
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T05:58:49.000Z" title="Tue Dec 30 2025 05:58:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读31分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.aliyun.com%2Farticle%2F706808" target="_blank" title="https://developer.aliyun.com/article/706808" ref="nofollow noopener noreferrer">developer.aliyun.com/article/706…</a></p>
<p>Feed流就是不停更新的信息单元，只要关注某些发布者就能获取到源源不断的新鲜信息，用户就可以在移动设备上逐条去浏览这些信息单元。
当前最流行的Feed流产品有微博、微信朋友圈、头条的资讯推荐、快手抖音的视频推荐等，还有一些变种，比如私信、通知等，这些系统都是Feed流系统。</p>
<h2 data-id="heading-1">特点</h2>
<p>Feed流本质上是一个数据流，是将 “N个发布者的信息单元” 通过 “关注关系” 传送给 “M个接收者”。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b350b788303b4efda32b5cbe2b07eca3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTU1NX0Zhbkxl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767679128&amp;x-signature=ovpRFRdN%2B4w7Mlo%2Fpjkc5LUhmiY%3D" alt="image.png" loading="lazy"/></p>
<p>数据分类</p>
<ul>
<li>发布者数据：发布者产生的数据需要按照发布者聚合，比如微博的个人首页、朋友圈的个人空间。对应<strong>存储表(永久保存)</strong>。</li>
<li>关注关系：系统中个体间的关系。微博中是关注(单向流)、朋友圈是互关(双向流)。对应<strong>关注表(永久保存)</strong>。</li>
<li>接受者数据。从不同发送者(关注的人)那获取的数据，按照某种顺序(一般是时间)组织在一起，比如微博的首页、朋友圈首页等。对应<strong>同步表(周期保存)</strong>。</li>
</ul>
<p>产品层面需要考虑的因素</p>
<ul>
<li>用户规模：不同用户规模涉及到底层的存储形式可能不同。</li>
<li>关注关系：如果是双向那就不存在大V，反之则存在。</li>
<li>排序规则：是按时间还是按推荐。</li>
</ul>
<h2 data-id="heading-2">产品定义</h2>








































<table><thead><tr><th>类型</th><th>关注关系</th><th>是否有大V</th><th>时效性</th><th>排序</th></tr></thead><tbody><tr><td>微博类</td><td>单向</td><td>有</td><td>秒~分</td><td>时间</td></tr><tr><td>抖音类</td><td>单向/无</td><td>有</td><td>秒~分</td><td>推荐</td></tr><tr><td>朋友圈类</td><td>双向</td><td>无</td><td>秒</td><td>时间</td></tr><tr><td>私信类</td><td>双向</td><td>无</td><td>秒</td><td>时间</td></tr></tbody></table>
<p>从上面表格可以看出来，主要分为两种区分：</p>
<ul>
<li>
<p>关注关系是单向还是双向：</p>
<ul>
<li>如果是单向，那么可能就会存在大V效应，同时时效性可以低一些，比如到分钟级别；</li>
<li>如果是双向，那就是好友，好友的数量有限，那么就不会有大V，这时候因为关系更亲密，时效性要求会更高，需要都秒级别。</li>
</ul>
</li>
<li>
<p>排序是时间还是推荐：</p>
<ul>
<li>用户对feed流最容易接受的就是时间，目前大部分都是时间。</li>
<li>但是有一些场景，是从全网数据里面根据用户的喜好给用户推荐和用户喜好度最匹配的内容，这个时候就需要用推荐了，这种情况一般也会省略掉关注了，相对于关注了全网所有用户，比如抖音、头条等。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-3">存储结构</h2>
<p>存储库最重要的特征有两点：</p>
<ol>
<li>数据可靠不丢失。</li>
<li>由于会一直增长，需要易于水平扩展。</li>
</ol>
<p>可以选为存储库的系统大概有两类：</p>






























<table><thead><tr><th>特点</th><th>分布式NoSQL</th><th>关系型数据库（分库分表）</th></tr></thead><tbody><tr><td>可靠性</td><td>极高</td><td>高</td></tr><tr><td>水平扩展能力</td><td>线性</td><td>需要改造</td></tr><tr><td>水平扩展速度</td><td>毫秒</td><td>无</td></tr><tr><td>常见系统</td><td>Tablestore、Bigtable</td><td>MySQL、PostgreSQL</td></tr></tbody></table>
<ul>
<li>对于可靠性，分布式NoSQL的可靠性要高于关系型数据库，一般都是存储三份，可靠性会更高。</li>
<li>水平扩展能力：对于分布式NoSQL数据库，数据天然是分布在多台机器上，当一台机器上的数据量增大后，可以通过自动分裂两部分，然后将其中一半的数据迁移到另一台机器上去，这样就做到了线性扩展。而关系型数据库需要在扩容时再次分库分表，分片策略决定扩展成本。
<ul>
<li>取余。避免使用%N的分片方式，这种方式极端情况下涉及所有数据迁移。</li>
<li>一致性哈希。使用一致性哈希可以将物理节点映射为多个虚拟节点，添加节点时只影响部分数据。</li>
<li>范围分片+动态分裂。节点1负责ID(0,1000),节点2负责ID(1000,2000)。当某个节点负责的ID数据量太大时会进行动态分裂，即拆分为更小的分片，节点1.1负责(0,500)，节点1.2负责(500,1000)。</li>
</ul>
</li>
</ul>
<p>结论：</p>
<ul>
<li>如果是自建系统，且不具备分布式NoSQL数据库运维能力，且数据规模不大，那么可以使用MySQL。</li>
<li>如果是基于云服务，那么就用分布式NoSQL，比如Tablestore或Bigtable。</li>
<li>如果数据规模很大，那么也要用分布式NoSQL，否则就是走上一条不归路。</li>
</ul>
<p>存储库表设计结构(Tablestore举例)如下：</p>


























<table><thead><tr><th>主键列</th><th>第一列主键</th><th>第二列主键</th><th>属性列</th><th>属性列</th></tr></thead><tbody><tr><td>列名</td><td>user_id</td><td>message_id</td><td>content</td><td>other</td></tr><tr><td>解释</td><td>消息发送者用户ID</td><td>消息顺序ID，可以使用timestamp。</td><td>内容</td><td>其他内容</td></tr></tbody></table>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03ff1820780546c8b40a39c471f8f669~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTU1NX0Zhbkxl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767679128&amp;x-signature=kwWeaFR79Ymu%2ByTST7NdWZ8sX1c%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">同步方式</h2>
<p>常见的方式有三种：</p>
<ul>
<li><strong>推模式（写扩散）</strong>：发送者发送了一个消息后，立即将这个消息推送给接收者，但是接收者此时不一定在线，那么就需要有一个地方存储这个数据，这个存储的地方称为：<strong>同步库</strong>。推模式也叫写扩散的原因是，一个消息需要发送个多个粉丝，那么这条消息就会复制多份，写放大，所以也叫写扩散。这种模式下，<strong>对同步库的要求就是写入能力极强和稳定</strong>。读取的时候因为消息已经<strong>发到接收者的收件箱</strong>了，只需要读一次自己的收件箱即可，读请求的量极小，所以对读的QPS需求不大。归纳下，推模式中对同步库的要求只有一个：写入能力强。</li>
<li><strong>拉模式（读扩散）</strong>：这种是一种拉的方式，发送者发送了一条消息后，这条消息不会立即推送给粉丝，而是<strong>写入自己的发件箱</strong>，当粉丝上线后再去自己关注者的发件箱里面去读取，一条消息的写入只有一次，但是读取最多会和粉丝数一样，读会放大，所以也叫读扩散。拉模式的读写比例刚好和写扩散相反，那么对系统的要求是：读取能力强。另外这里还有一个误区，很多人在最开始设计feed流系统时，首先想到的是拉模式，因为这种和用户的使用体感是一样的，但是<strong>在系统设计上这种方式有不少痛点，最大的是每个粉丝需要记录自己上次读到了关注者的哪条消息，如果有1000个关注者，那么这个人需要记录1000个位置信息</strong>，这个量和关注量成正比的，远比用户数要大的多，这里要特别注意，虽然在产品前期数据量少的时候这种方式可以应付，但是量大了后就会事倍功半，得不偿失，切记切记。</li>
<li><strong>推拉结合模式</strong>：
<ul>
<li>按照用户群体分类：大V拉，普通用户推。大V存在大量粉丝，如果采用推模式，可能一条消息会扩散几百万次。基于此，采用大部分用户的消息都是写扩散，只有大V是读扩散。</li>
<li>按照用户活跃状态分类：在线推，离线拉。以大V举例，大V发送一条消息后，将消息推送给在线的粉丝，对于当前时刻离线的粉丝在上线后，从大V的发件箱中拉取消息。</li>
</ul>
</li>
</ul>
<p>结论：</p>
<ul>
<li>如果产品中是双向关系，那么就采用推模式。</li>
<li>如果产品中是单向关系，且用户数少于1000万，那么也采用推模式，足够了。</li>
<li>如果产品是单向关系，单用户数大于1000万，那么采用推拉结合模式，这时候可以从推模式演进过来，不需要额外重新推翻重做。</li>
<li>永远不要只用拉模式。</li>
<li>如果是一个初创企业，先用推模式，快速把系统设计出来，然后让产品去验证、迭代，等客户数大幅上涨到1000万后，再考虑升级为推拉集合模式。</li>
</ul>
<p>同步库表结构如下：</p>





























<table><thead><tr><th>主键列</th><th>第一列主键</th><th>第二列主键</th><th>属性列</th><th>属性列</th><th>属性列</th></tr></thead><tbody><tr><td>列名</td><td>user_id</td><td>sequence_id</td><td>sender_id</td><td>message_id</td><td>other</td></tr><tr><td>解释</td><td>消息接收者用户ID</td><td>消息顺序ID，可以使用timestamp + send_user_id，也可以直接使用Tablestore的自增列。</td><td>发送者的用户ID</td><td>store_table中的message_id列的值，也就是消息ID。通过sender_id和message_id可以到store_table中查询到消息内容</td><td>其他内容，同步库中不需要包括消息内容。</td></tr></tbody></table>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b7dda69c3b34b1c9c5b4a1d34169687~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTU1NX0Zhbkxl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767679128&amp;x-signature=g7IHqKu3xJp%2BcabhN9M%2BNO2xRfo%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">用户关系</h2>
<p>查询的时候需要支持查询关注列表或者粉丝列表，或者直接好友列表，这里就需要根据多个属性列查询需要索引能力，这里，存储系统也可以采用两类，关系型、分布式NoSQL数据库。
关注关系表设计结构如下：
Table：user_relation_table</p>


























<table><thead><tr><th>主键顺序</th><th>第一列主键</th><th>第一列主键</th><th>属性列</th><th>属性列</th></tr></thead><tbody><tr><td>Table字段名</td><td>user_id</td><td>follow_user_id</td><td>timestamp</td><td>other</td></tr><tr><td>备注</td><td>用户ID</td><td>粉丝用户ID</td><td>关注时间</td><td>其他属性列</td></tr></tbody></table>
<p>查询的时候：</p>
<ul>
<li>如果需要查询某个人的粉丝列表：使用TermQuery查询固定user_id，且按照timestamp排序。</li>
<li>如果需要查询某个人的关注列表：使用TermQuery查询固定follow_user_id，且按照timestamp排序。</li>
<li>当前数据写入Table后，需要5~10秒钟延迟后会在多元索引中查询到，未来会优化到2秒以内。</li>
</ul>
<h2 data-id="heading-6">推送session池</h2>
<p>发送者将消息发送后，接收者如何知道自己有新消息来了？客户端周期性去刷新？如果是这样子，那么系统的读请求压力会随着客户端增长而增长，如果某天平台爆发了一个热点消息，大量休眠设备登陆，这个时候就会出现“查询风暴”，一下子就把系统打垮了，所有的用户都不能用了。
可以在服务端维护一个推送session池，这个里面记录哪些用户在线，然后当用户A发送了一条消息给用户B后，服务端在写入存储库和同步库后，再通知一下session池中的用户B的session，告诉他：你有新消息了。然后session-B再去读消息，然后有消息后将消息推送给客户端。或者有消息后给客户端推送一下有消息了，客户端再去拉。</p>
<p>session表设计结构如下：</p>























<table><thead><tr><th>主键列顺序</th><th>第一列主键</th><th>第二列主键</th><th>属性列</th></tr></thead><tbody><tr><td>列名</td><td>user_id</td><td>device_id</td><td>last_sequence_id</td></tr><tr><td>备注</td><td>接收者用户ID</td><td>设备ID，同一个用户可能会有多个设备，不同设备的读取位置可能不一致，所以这里需要一个设备ID。如果不需要支持多终端，则这一列可以省略。</td><td>该接收者已经推送给客户端的最新的顺序ID</td></tr></tbody></table>
<h2 data-id="heading-7">评论</h2>
<p>评论的属性和存储库差不多，但是多了一层关系：被评论的消息，所以只要将评论按照被被评论消息分组组织即可，然后查询时也是一个范围查询就行。
评论表设计结构如下：</p>





























<table><thead><tr><th>主键列顺序</th><th>第一列主键</th><th>第二列主键</th><th>属性列</th><th>属性列</th><th>属性列</th></tr></thead><tbody><tr><td>字段名</td><td>message_id</td><td>comment_id</td><td>comment_content</td><td>reply_to</td><td>other</td></tr><tr><td>备注</td><td>微博ID或朋友圈ID等消息的ID</td><td>这一条评论的ID</td><td>评论内容</td><td>回复给哪个用户</td><td>其他</td></tr></tbody></table>
<h2 data-id="heading-8">点赞</h2>
<p>“赞”或“like”功能很流行，赞功能的实现和评论类似，只是比评论少了一个内容，所以选择方式和评论一样。</p>
<h2 data-id="heading-9">系统结构</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2617ac173bc42b7bab624bb8846d61e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTU1NX0Zhbkxl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767679128&amp;x-signature=kZYk33csBTCxh%2BXMyfvc3TQCFQA%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-10">系统流转示例</h2>
<h3 data-id="heading-11">系统架构</h3>
<pre><code class="hljs language-txt" lang="txt">┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                           Feed流系统整体架构                                                     │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

                                              ┌─────────────────┐
                                              │   客户端 (APP)   │
                                              │  iOS / Android  │
                                              └────────┬────────┘
                                                       │
                                    ┌──────────────────┼──────────────────┐
                                    │ HTTP/HTTPS       │ WebSocket        │
                                    ▼                  ▼                  │
                         ┌─────────────────┐  ┌─────────────────┐         │
                         │   API Gateway   │  │  WebSocket LB   │         │
                         │    (Nginx)      │  │   (Nginx/HAProxy)│        │
                         └────────┬────────┘  └────────┬────────┘         │
                                  │                    │                  │
         ┌────────────────────────┼────────────────────┼──────────────────┤
         │                        │                    │                  │
         ▼                        ▼                    ▼                  │
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐         │
│   Feed Service  │    │  User Service   │    │  Push Service   │◄────────┘
│   (发布/拉取)    │    │  (用户/关注)     │    │  (WebSocket)    │
└────────┬────────┘    └────────┬────────┘    └────────┬────────┘
         │                      │                      │
         │                      │                      │
         ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                              消息队列层                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                                         Kafka / RocketMQ                                                │   │
│  │   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐           │   │
│  │   │ feed_publish│    │ feed_sync   │    │ feed_notify │    │ comment_topic│   │ like_topic  │           │   │
│  │   │   Topic     │    │   Topic     │    │   Topic     │    │             │    │             │           │   │
│  │   └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘           │   │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
         │                      │                      │
         ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                              异步处理层                                                          │
│   ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐                      │
│   │  Sync Worker    │    │  Notify Worker  │    │ Comment Worker  │    │  Like Worker    │                      │
│   │  (写扩散处理)    │    │  (推送通知)      │    │  (评论处理)      │    │  (点赞处理)      │                      │
│   └────────┬────────┘    └────────┬────────┘    └────────┬────────┘    └────────┬────────┘                      │
└────────────┼─────────────────────┼─────────────────────┼─────────────────────┼──────────────────────────────────┘
             │                     │                     │                     │
             ▼                     ▼                     ▼                     ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                              存储层                                                              │
│                                                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              Tablestore / HBase (分布式NoSQL)                                              │  │
│  │   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐             │  │
│  │   │ store_table │    │ sync_table  │    │relation_table│   │comment_table│    │ like_table  │             │  │
│  │   │  (存储表)    │    │  (同步表)    │    │  (关注表)    │    │  (评论表)    │    │  (点赞表)    │             │  │
│  │   │  永久保存    │    │  周期保存    │    │  永久保存    │    │  永久保存    │    │  永久保存    │             │  │
│  │   └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘             │  │
│  └───────────────────────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                                 │
│  ┌───────────────────────────────────────┐    ┌───────────────────────────────────────┐                         │
│  │           Redis Cluster               │    │              MySQL                    │                         │
│  │   ┌─────────────┐  ┌─────────────┐    │    │   ┌─────────────┐  ┌─────────────┐   │                         │
│  │   │session_pool │  │ feed_cache  │    │    │   │ user_table  │  │ bigv_table  │   │                         │
│  │   │ (Session池) │  │ (Feed缓存)  │    │    │   │  (用户表)    │  │  (大V表)     │   │                         │
│  │   └─────────────┘  └─────────────┘    │    │   └─────────────┘  └─────────────┘   │                         │
│  │   ┌─────────────┐  ┌─────────────┐    │    └───────────────────────────────────────┘                         │
│  │   │ like_count  │  │pull_position│    │                                                                      │
│  │   │ (点赞计数)   │  │ (拉取位置)   │    │                                                                      │
│  │   └─────────────┘  └─────────────┘    │                                                                      │
│  └───────────────────────────────────────┘                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-12">场景设定</h3>
<pre><code class="hljs language-txt" lang="txt">┌─────────────────────────────────────────────────────────────────────────────────────────┐
│  场景设定                                                                               │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│  大V用户：bigV_001（粉丝数：500万）                                                      │
│  发布新动态：message_id = "msg_20241229_010"，内容："新年快乐！"                          │
│  发布时间：2024-12-29 15:00:00                                                          │
│                                                                                         │
│  粉丝状态分布：                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐    │
│  │  在线粉丝：100万（在Session池中有记录，采用推模式）                                 │    │
│  │  离线粉丝：400万（不在Session池中，采用拉模式）                                     │    │
│  └─────────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                         │
│  以离线粉丝 fan_003 为例：                                                               │
│  - 关注了3个大V：bigV_001, bigV_002, bigV_003                                           │
│  - 上次在线时间：2024-12-28 18:30:00（昨天）                                            │
│  - 对 bigV_001 的拉取位置：msg_20241228_005                                             │
│  - 离线期间 bigV_001 发了5条新消息：msg_20241229_006 ~ msg_20241229_010                 │
└─────────────────────────────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-13">核心表结构</h3>
<pre><code class="hljs language-txt" lang="txt">┌─────────────────────────────────────────────────────────────────────────────────────────┐
│  1. store_table（存储表/发件箱）- 永久保存                                                │
├───────────────┬───────────────────┬──────────────┬─────────────────────┬───────────────┤
│ user_id       │ message_id        │ content      │ timestamp           │ seq_no        │
│ (发布者ID)     │ (消息ID)           │ (内容)        │ (发布时间)           │ (序列号)       │
├───────────────┼───────────────────┼──────────────┼─────────────────────┼───────────────┤
│ bigV_001      │ msg_20241228_005  │ 晚安          │ 2024-12-28 23:00    │ 1005          │
│ bigV_001      │ msg_20241229_006  │ 早上好        │ 2024-12-29 08:00    │ 1006          │
│ bigV_001      │ msg_20241229_007  │ 吃早餐了      │ 2024-12-29 09:00    │ 1007          │
│ bigV_001      │ msg_20241229_008  │ 开始工作      │ 2024-12-29 10:00    │ 1008          │
│ bigV_001      │ msg_20241229_009  │ 午餐时间      │ 2024-12-29 12:00    │ 1009          │
│ bigV_001      │ msg_20241229_010  │ 新年快乐！    │ 2024-12-29 15:00    │ 1010          │
└───────────────┴───────────────────┴──────────────┴─────────────────────┴───────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│  2. sync_table（同步表/收件箱）- 周期保存                                                 │
├───────────────┬───────────────┬───────────────┬───────────────────┬─────────────────────┤
│ user_id       │ sequence_id   │ sender_id     │ message_id        │ timestamp           │
│ (接收者ID)     │ (收件箱序列号)  │ (发送者ID)     │ (消息ID)           │ (时间戳)            │
├───────────────┼───────────────┼───────────────┼───────────────────┼─────────────────────┤
│ fan_001       │ seq_501       │ bigV_001      │ msg_20241229_010  │ 2024-12-29 15:00    │
│ fan_002       │ seq_302       │ bigV_001      │ msg_20241229_010  │ 2024-12-29 15:00    │
│ ...           │ ...           │ ...           │ ...               │ ...                 │
└───────────────┴───────────────┴───────────────┴───────────────────┴─────────────────────┘
│  注意：同步表不存储消息内容，通过 sender_id + message_id 回查存储表获取                      │

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│  3. pull_position_table（拉取位置表）- 记录每个粉丝对每个大V的拉取位置                       │
├───────────────┬───────────────┬───────────────────┬─────────────────────────────────────┤
│ user_id       │ bigv_id       │ last_pull_msg_id  │ last_pull_time                      │
│ (粉丝ID)       │ (大V ID)       │ (上次拉到的消息ID) │ (上次拉取时间)                        │
├───────────────┼───────────────┼───────────────────┼─────────────────────────────────────┤
│ fan_003       │ bigV_001      │ msg_20241228_005  │ 2024-12-28 18:30:00                 │
│ fan_003       │ bigV_002      │ msg_20241227_012  │ 2024-12-27 20:15:00                 │
│ fan_003       │ bigV_003      │ msg_20241229_001  │ 2024-12-29 09:00:00                 │
└───────────────┴───────────────┴───────────────────┴─────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│  4. session_pool（Session池）- 记录在线用户，Redis实现                                             │
├───────────────┬───────────────┬───────────────────┬─────────────────────────────────────┤
│ user_id       │ device_id     │ last_sequence_id  │ online_status                       │
│ (用户ID)       │ (设备ID)       │ (已推送的最新序列) │ (在线状态)                           │
├───────────────┼───────────────┼───────────────────┼─────────────────────────────────────┤
│ fan_001       │ device_A      │ seq_500           │ ONLINE                              │
│ fan_002       │ device_B      │ seq_301           │ ONLINE                              │
│ fan_003       │ -             │ -                 │ OFFLINE（不在池中）                   │
└───────────────┴───────────────┴───────────────────┴─────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-14">大V发送动态</h3>
<pre><code class="hljs language-txt" lang="txt">                         ┌─────────────────────────────────────────────────────────┐
                         │  bigV_001 发送动态                                       │
                         │  POST /api/feed/publish                                 │
                         │  { user_id: "bigV_001", content: "新年快乐！" }          │
                         └────────────────────────────┬────────────────────────────┘
                                                      │
                                                      ▼
┌────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Step 1: 写入存储表（大V的发件箱）                                                              │
│  ┌──────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │  INSERT INTO store_table (user_id, message_id, content, timestamp, seq_no)              │  │
│  │  VALUES ('bigV_001', 'msg_20241229_010', '新年快乐！', '2024-12-29 15:00:00', 1010)       │  │
│  └──────────────────────────────────────────────────────────────────────────────────────────┘  │
│  消息永久保存在大V的发件箱中，所有粉丝都可以从这里拉取                                            │
└────────────────────────────────────────────────────┬───────────────────────────────────────────┘
                                                     │
                                                     ▼
┌────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Step 2: 查询粉丝列表                                                                          │
│  ┌──────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │  SELECT follow_user_id FROM user_relation_table WHERE user_id = 'bigV_001'              │  │
│  │  → 返回 500万 粉丝ID                                                                     │  │
│  └──────────────────────────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────┬───────────────────────────────────────────┘
                                                     │
                                                     ▼
┌────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Step 3: 查询Session池，区分在线/离线粉丝                                                       │
│  ┌──────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │  SELECT user_id FROM session_pool WHERE user_id IN (粉丝列表) AND online_status = 'ONLINE' │  │
│  │  → 在线：100万    离线：400万                                                             │  │
│  └──────────────────────────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────┬───────────────────────────────────────────┘
                                                     │
                          ┌──────────────────────────┴──────────────────────────┐
                          ▼                                                     ▼
┌──────────────────────────────────────────────────────┐  ┌──────────────────────────────────────────────────────┐
│  在线粉丝处理（推模式）                                │  │  离线粉丝处理（拉模式）                                │
│                                                      │  │                                                      │
│  Step 4a: 批量写入同步表（收件箱）                     │  │  Step 4b: 不做任何操作                                │
│  ┌────────────────────────────────────────────────┐  │  │  ┌────────────────────────────────────────────────┐  │
│  │  // 100万条写入，分批处理                        │  │  │  │  消息保留在 bigV_001 的存储表（发件箱）中        │  │
│  │  for (batch : partition(onlineFans, 1000)) {   │  │  │  │  等待离线粉丝上线后主动拉取                      │  │
│  │      sync_table.batchInsert(                   │  │  │  │                                                │  │
│  │          batch,           // 粉丝ID列表         │  │  │  │  离线粉丝的拉取位置保持不变：                    │  │
│  │          "bigV_001",      // 发送者              │  │  │  │  fan_003 对 bigV_001: msg_20241228_005         │  │
│  │          "msg_20241229_010" // 消息ID           │  │  │  │  （下次上线时从这个位置开始拉取）                │  │
│  │      );                                        │  │  │  └────────────────────────────────────────────────┘  │
│  │  }                                             │  │  │                                                      │
│  └────────────────────────────────────────────────┘  │  └──────────────────────────────────────────────────────┘
│                                                      │
│  Step 5a: 通过Session长连接推送通知                   │
│  ┌────────────────────────────────────────────────┐  │
│  │  sessionPool.notifyUsers(                      │  │
│  │      onlineFans,                               │  │
│  │      { type: "NEW_FEED", count: 1 }            │  │
│  │  );                                            │  │
│  │  客户端收到通知后，主动拉取最新消息               │  │
│  └────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-15">在线粉丝 fan_001 接收消息</h4>
<pre><code class="hljs language-txt" lang="txt">┌────────────────────────────────────────────────────────────────────────────────────────────────┐
│  fan_001 的 Session 收到推送通知                                                               │
│  { type: "NEW_FEED", count: 1 }                                                                │
└────────────────────────────────────────────────────┬───────────────────────────────────────────┘
                                                     │
                                                     ▼
┌────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Step 1: 客户端发起拉取请求                                                                    │
│  ┌──────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │  GET /api/feed/timeline?last_seq=seq_500                                                │  │
│  │  fan_001 上次读到 seq_500，请求 seq_500 之后的新消息                                      │  │
│  └──────────────────────────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────┬───────────────────────────────────────────┘
                                                     │
                                                     ▼
┌────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Step 2: 从同步表（收件箱）读取新消息                                                           │
│  ┌──────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │  SELECT * FROM sync_table                                                               │  │
│  │  WHERE user_id = 'fan_001' AND sequence_id &gt; 'seq_500'    客户端请求时如果没有携带 last_seq，服务端会从 session_table 读取                              │  │
│  │  ORDER BY sequence_id DESC LIMIT 20                                                     │  │
│  │                                                                                         │  │
│  │  返回结果：                                                                              │  │
│  │  sequence_id │ sender_id  │ message_id                                                  │  │
│  │  seq_501     │ bigV_001   │ msg_20241229_010   ← 刚推送的新消息                          │  │
│  └──────────────────────────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────┬───────────────────────────────────────────┘
                                                     │
                                                     ▼
┌────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Step 3: 回查存储表获取消息内容                                                                 │
│  ┌──────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │  SELECT content, timestamp FROM store_table                                             │  │
│  │  WHERE user_id = 'bigV_001' AND message_id = 'msg_20241229_010'                          │  │
│  │                                                                                         │  │
│  │  返回结果：{ content: "新年快乐！", timestamp: "2024-12-29 15:00:00" }                    │  │
│  └──────────────────────────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────┬───────────────────────────────────────────┘
                                                     │
                                                     ▼
┌────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Step 4: 返回给客户端展示                                                                      │
│  ┌──────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │  客户端 Timeline：                                                                       │  │
│  │  ┌────────────────────────────────────────────────────────────────────────────────────┐ │  │
│  │  │  [bigV_001] 新年快乐！                                        15:00   ← 新消息     │ │  │
│  │  │  [user_xxx] xxxxxxxxx                                         14:30               │ │  │
│  │  │  [bigV_002] xxxxxxxxx                                         14:00               │ │  │
│  │  └────────────────────────────────────────────────────────────────────────────────────┘ │  │
│  └──────────────────────────────────────────────────────────────────────────────────────────┘  │
│  同时更新 Session 中的 last_sequence_id = seq_501                                              │
└────────────────────────────────────────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-16">离线粉丝 fan_003 上线后的拉取流程</h4>
<pre><code class="hljs language-txt" lang="txt">┌────────────────────────────────────────────────────────────────────────────────────────────────┐
│  fan_003 上线，打开APP                                                                        │
│  时间：2024-12-29 16:00:00（离线了约22小时）                                                   │
└────────────────────────────────────────────────────┬───────────────────────────────────────────┘
                                                     │
                                                     ▼
┌────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Step 1: 建立Session连接，加入Session池                                                        │
│  ┌──────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │  session_pool.register(                                                                 │  │
│  │      user_id: "fan_003",                                                                │  │
│  │      device_id: "iPhone_xxx",                                                           │  │
│  │      online_status: "ONLINE"                                                            │  │
│  │  )                                                                                      │  │
│  └──────────────────────────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────┬───────────────────────────────────────────┘
                                                     │
                                                     ▼
┌────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Step 2: 查询关注的大V列表                                                                     │
│  ┌──────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │  SELECT user_id FROM user_relation_table                                                │  │
│  │  WHERE follow_user_id = 'fan_003' AND is_bigv = true                                    │  │
│  │                                                                                         │  │
│  │  返回：[bigV_001, bigV_002, bigV_003]                                                   │  │
│  └──────────────────────────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────┬───────────────────────────────────────────┘
                                                     │
                                                     ▼
┌────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Step 3: 查询每个大V的拉取位置 ⭐ 关键步骤                                                      │
│  ┌──────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │  SELECT bigv_id, last_pull_msg_id, last_pull_time                                       │  │
│  │  FROM pull_position_table                                                               │  │
│  │  WHERE user_id = 'fan_003' AND bigv_id IN ('bigV_001', 'bigV_002', 'bigV_003')           │  │
│  │                                                                                         │  │
│  │  ┌────────────────────────────────────────────────────────────────────────────────────┐ │  │
│  │  │  查询结果：fan_003 的拉取位置                                                       │ │  │
│  │  │  bigv_id    │ last_pull_msg_id   │ last_pull_time        │ 含义                   │ │  │
│  │  │ ───────────┼────────────────────┼───────────────────────┼────────────────────────│ │  │
│  │  │  bigV_001   │ msg_20241228_005   │ 2024-12-28 18:30:00   │ 昨天拉到第5条消息       │ │  │
│  │  │  bigV_002   │ msg_20241227_012   │ 2024-12-27 20:15:00   │ 前天拉到第12条消息      │ │  │
│  │  │  bigV_003   │ msg_20241229_001   │ 2024-12-29 09:00:00   │ 今早拉到第1条消息       │ │  │
│  │  └────────────────────────────────────────────────────────────────────────────────────┘ │  │
│  └──────────────────────────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────┬───────────────────────────────────────────┘
                                                     │
                                                     ▼
┌────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Step 4: 从每个大V的发件箱增量拉取 ⭐ 关键步骤                                                   │
│                                                                                                │
│  ┌──────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │  对于 bigV_001（从 msg_20241228_005 之后开始拉取）：                                      │  │
│  │                                                                                         │  │
│  │  SELECT * FROM store_table                                                              │  │
│  │  WHERE user_id = 'bigV_001'                                                             │  │
│  │    AND message_id &gt; 'msg_20241228_005'   ← 从上次位置之后开始（不包含上次的消息）          │  │
│  │  ORDER BY message_id ASC                                                                │  │
│  │  LIMIT 50                                                                               │  │
│  │                                                                                         │  │
│  │  拉取到的新消息（5条）：                                                                  │  │
│  │  ┌────────────────────────────────────────────────────────────────────────────────────┐ │  │
│  │  │  message_id        │ content      │ timestamp           │ 状态                    │ │  │
│  │  │ ──────────────────┼──────────────┼─────────────────────┼───────────────────────── │ │  │
│  │  │  msg_20241229_006  │ 早上好        │ 2024-12-29 08:00    │ 新消息                  │ │  │
│  │  │  msg_20241229_007  │ 吃早餐了      │ 2024-12-29 09:00    │ 新消息                  │ │  │
│  │  │  msg_20241229_008  │ 开始工作      │ 2024-12-29 10:00    │ 新消息                  │ │  │
│  │  │  msg_20241229_009  │ 午餐时间      │ 2024-12-29 12:00    │ 新消息                  │ │  │
│  │  │  msg_20241229_010  │ 新年快乐！    │ 2024-12-29 15:00    │ 新消息（最新）           │ │  │
│  │  └────────────────────────────────────────────────────────────────────────────────────┘ │  │
│  └──────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                │
│  ┌──────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │  对于 bigV_002（从 msg_20241227_012 之后开始拉取）：                                      │  │
│  │  拉取到 3 条新消息：msg_20241228_001 ~ msg_20241228_003                                  │  │
│  └──────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                │
│  ┌──────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │  对于 bigV_003（从 msg_20241229_001 之后开始拉取）：                                      │  │
│  │  拉取到 1 条新消息：msg_20241229_002                                                     │  │
│  └──────────────────────────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────┬───────────────────────────────────────────┘
                                                     │
                                                     ▼
┌────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Step 5: 更新拉取位置 ⭐ 关键步骤                                                               │
│  ┌──────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │  批量更新 fan_003 对每个大V的拉取位置：                                                   │  │
│  │                                                                                         │  │
│  │  UPDATE pull_position_table SET                                                         │  │
│  │      last_pull_msg_id = CASE bigv_id                                                    │  │
│  │          WHEN 'bigV_001' THEN 'msg_20241229_010'   ← 更新为本次拉到的最新消息ID           │  │
│  │          WHEN 'bigV_002' THEN 'msg_20241228_003'                                         │  │
│  │          WHEN 'bigV_003' THEN 'msg_20241229_002'                                         │  │
│  │      END,                                                                               │  │
│  │      last_pull_time = '2024-12-29 16:00:00'       ← 更新拉取时间                         │  │
│  │  WHERE user_id = 'fan_003'                                                              │  │
│  │                                                                                         │  │
│  │  ┌────────────────────────────────────────────────────────────────────────────────────┐ │  │
│  │  │  更新后的拉取位置表：                                                                │ │  │
│  │  │  bigv_id    │ last_pull_msg_id   │ last_pull_time        │ 变化                   │ │  │
│  │  │ ───────────┼────────────────────┼───────────────────────┼────────────────────────│ │  │
│  │  │  bigV_001   │ msg_20241229_010   │ 2024-12-29 16:00:00   │ ✅ 005 → 010           │ │  │
│  │  │  bigV_002   │ msg_20241228_003   │ 2024-12-29 16:00:00   │ ✅ 012 → 003           │ │  │
│  │  │  bigV_003   │ msg_20241229_002   │ 2024-12-29 16:00:00   │ ✅ 001 → 002           │ │  │
│  │  └────────────────────────────────────────────────────────────────────────────────────┘ │  │
│  │  下次 fan_003 再上线时，将从这些新位置开始拉取                                            │  │
│  └──────────────────────────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────┬───────────────────────────────────────────┘
                                                     │
                                                     ▼
┌────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Step 6: 合并消息并写入同步表（收件箱）                                                         │
│  ┌──────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │  将从各个大V拉取的消息合并，按时间排序，写入 fan_003 的同步表                              │  │
│  │                                                                                         │  │
│  │  sync_table（fan_003 的收件箱）新增记录：                                                │  │
│  │  ┌────────────────────────────────────────────────────────────────────────────────────┐ │  │
│  │  │  user_id  │ sequence_id │ sender_id  │ message_id        │ timestamp              │ │  │
│  │  │ ─────────┼─────────────┼────────────┼───────────────────┼────────────────────────│ │  │
│  │  │  fan_003  │ seq_201     │ bigV_001   │ msg_20241229_006  │ 2024-12-29 08:00       │ │  │
│  │  │  fan_003  │ seq_202     │ bigV_002   │ msg_20241228_001  │ 2024-12-29 08:30       │ │  │
│  │  │  fan_003  │ seq_203     │ bigV_001   │ msg_20241229_007  │ 2024-12-29 09:00       │ │  │
│  │  │  fan_003  │ seq_204     │ bigV_003   │ msg_20241229_002  │ 2024-12-29 09:30       │ │  │
│  │  │  fan_003  │ seq_205     │ bigV_001   │ msg_20241229_008  │ 2024-12-29 10:00       │ │  │
│  │  │  fan_003  │ seq_206     │ bigV_001   │ msg_20241229_009  │ 2024-12-29 12:00       │ │  │
│  │  │  fan_003  │ seq_207     │ bigV_001   │ msg_20241229_010  │ 2024-12-29 15:00       │ │  │
│  │  │  ...      │ ...         │ ...        │ ...               │ ...                    │ │  │
│  │  └────────────────────────────────────────────────────────────────────────────────────┘ │  │
│  └──────────────────────────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────┬───────────────────────────────────────────┘
                                                     │
                                                     ▼
┌────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Step 7: 返回给客户端展示                                                                      │
│  ┌──────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │  客户端 Timeline（按时间倒序展示）：                                                      │  │
│  │  ┌────────────────────────────────────────────────────────────────────────────────────┐ │  │
│  │  │  ┌────────────────────────────────────────────────────────────────────────────┐   │ │  │
│  │  │  │  [bigV_001] 新年快乐！                                         15:00       │   │ │  │
│  │  │  └────────────────────────────────────────────────────────────────────────────┘   │ │  │
│  │  │  ┌────────────────────────────────────────────────────────────────────────────┐   │ │  │
│  │  │  │  [bigV_001] 午餐时间                                           12:00       │   │ │  │
│  │  │  └────────────────────────────────────────────────────────────────────────────┘   │ │  │
│  │  │  ┌────────────────────────────────────────────────────────────────────────────┐   │ │  │
│  │  │  │  [bigV_001] 开始工作                                           10:00       │   │ │  │
│  │  │  └────────────────────────────────────────────────────────────────────────────┘   │ │  │
│  │  │  ┌────────────────────────────────────────────────────────────────────────────┐   │ │  │
│  │  │  │  [bigV_003] xxxxxxxxx                                          09:30       │   │ │  │
│  │  │  └────────────────────────────────────────────────────────────────────────────┘   │ │  │
│  │  │  ┌────────────────────────────────────────────────────────────────────────────┐   │ │  │
│  │  │  │  [bigV_001] 吃早餐了                                           09:00       │   │ │  │
│  │  │  └────────────────────────────────────────────────────────────────────────────┘   │ │  │
│  │  │  ┌────────────────────────────────────────────────────────────────────────────┐   │ │  │
│  │  │  │  [bigV_002] xxxxxxxxx                                          08:30       │   │ │  │
│  │  │  └────────────────────────────────────────────────────────────────────────────┘   │ │  │
│  │  │  ┌────────────────────────────────────────────────────────────────────────────┐   │ │  │
│  │  │  │  [bigV_001] 早上好                                             08:00       │   │ │  │
│  │  │  └────────────────────────────────────────────────────────────────────────────┘   │ │  │
│  │  └────────────────────────────────────────────────────────────────────────────────────┘ │  │
│  └──────────────────────────────────────────────────────────────────────────────────────────┘  │
│  同时更新 Session 中的 last_sequence_id = seq_207                                              │
└────────────────────────────────────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-17">评论</h3>
<h4 data-id="heading-18">表结构设计</h4>
<pre><code class="hljs language-txt" lang="txt">┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  comment_table（评论表）- 存储：Tablestore / HBase                                                               │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  主键设计                                                                                                        │
│  ┌─────────────────┬─────────────────────────┬─────────────────────────────────────────────────────────────┐   │
│  │  列名            │  类型                    │  说明                                                       │   │
│  ├─────────────────┼─────────────────────────┼─────────────────────────────────────────────────────────────┤   │
│  │  message_id     │  String (PK1, 分区键)    │  被评论的动态ID，同一动态的评论物理上连续存储                   │   │
│  │  comment_id     │  String (PK2, 排序键)    │  评论ID，格式：时间戳_用户ID，保证有序且唯一                   │   │
│  └─────────────────┴─────────────────────────┴─────────────────────────────────────────────────────────────┘   │
│                                                                                                                 │
│  属性列                                                                                                          │
│  ┌─────────────────┬─────────────────────────┬─────────────────────────────────────────────────────────────┐   │
│  │  列名            │  类型                    │  说明                                                       │   │
│  ├─────────────────┼─────────────────────────┼─────────────────────────────────────────────────────────────┤   │
│  │  user_id        │  String                 │  评论者ID                                                    │   │
│  │  content        │  String                 │  评论内容                                                    │   │
│  │  reply_to_user  │  String                 │  回复目标用户ID（楼中楼），NULL表示直接评论动态                 │   │
│  │  reply_to_cmt   │  String                 │  回复目标评论ID（楼中楼）                                     │   │
│  │  timestamp      │  Long                   │  评论时间戳                                                  │   │
│  │  status         │  Integer                │  状态：0-正常，1-已删除，2-隐藏                               │   │
│  │  like_count     │  Integer                │  评论点赞数（冗余字段，定时同步）                              │   │
│  └─────────────────┴─────────────────────────┴─────────────────────────────────────────────────────────────┘   │
│                                                                                                                 │
│  示例数据                                                                                                        │
│  ┌───────────────────┬─────────────────────────┬──────────┬────────────┬──────────────┬──────────────┐         │
│  │  message_id       │  comment_id             │  user_id │  content   │  reply_to_user│ reply_to_cmt│         │
│  ├───────────────────┼─────────────────────────┼──────────┼────────────┼──────────────┼──────────────┤         │
│  │  msg_001          │  1703836800000_userA    │  userA   │  说得好！   │  NULL        │  NULL        │         │
│  │  msg_001          │  1703836900000_userB    │  userB   │  同意楼上   │  userA       │  上一条ID    │         │
│  │  msg_001          │  1703837000000_userC    │  userC   │  不太认同   │  NULL        │  NULL        │         │
│  │  msg_002          │  1703838000000_userA    │  userA   │  哈哈哈     │  NULL        │  NULL        │         │
│  └───────────────────┴─────────────────────────┴──────────┴────────────┴──────────────┴──────────────┘         │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Redis 缓存设计                                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  1. 评论计数缓存                                                                                                 │
│     Key: comment_count:{message_id}                                                                             │
│     Value: 123 (评论数)                                                                                         │
│     TTL: 1小时，过期后从数据库重新统计                                                                            │
│                                                                                                                 │
│  2. 热门评论缓存（可选）                                                                                          │
│     Key: hot_comments:{message_id}                                                                              │
│     Value: List&lt;Comment&gt; (前N条热门评论，按点赞数排序)                                                            │
│     TTL: 10分钟                                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-19">发表评论流程</h4>
<pre><code class="hljs language-txt" lang="txt">┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  发表评论完整流程                                                                                                │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

    用户B                          Comment Service                    数据库                    动态作者(大V)
      │                                  │                              │                           │
      │ POST /api/comment                │                              │                           │
      │ {                                │                              │                           │
      │   message_id: "msg_001",         │                              │                           │
      │   content: "说得好！",            │                              │                           │
      │   reply_to_user: null            │                              │                           │
      │ }                                │                              │                           │
      │─────────────────────────────────&gt;│                              │                           │
      │                                  │                              │                           │
      │                                  │  1. 参数校验                  │                           │
      │                                  │  - 内容长度检查               │                           │
      │                                  │  - 敏感词过滤                 │                           │
      │                                  │  - 用户是否被禁言             │                           │
      │                                  │                              │                           │
      │                                  │  2. 生成评论ID                │                           │
      │                                  │  comment_id = timestamp_userB │                           │
      │                                  │                              │                           │
      │                                  │  3. 写入评论表 ──────────────&gt;│                           │
      │                                  │     INSERT comment_table      │                           │
      │                                  │                              │                           │
      │                                  │  4. 更新评论计数 ────────────&gt;│ Redis                     │
      │                                  │     INCR comment_count:msg_001│                           │
      │                                  │                              │                           │
      │                                  │  5. 查询动态作者 ────────────&gt;│ store_table               │
      │                                  │     获取 msg_001 的 user_id   │                           │
      │                                  │&lt;────── bigV_001 ─────────────│                           │
      │                                  │                              │                           │
      │                                  │  6. 发送通知 ─────────────────────────────────────────────&gt;│
      │                                  │     写入 notification_table   │                           │
      │                                  │     {                         │                           │
      │                                  │       user_id: bigV_001,      │                           │
      │                                  │       type: COMMENT,          │                           │
      │                                  │       from_user: userB,       │                           │
      │                                  │       message_id: msg_001,    │                           │
      │                                  │       comment_id: xxx         │                           │
      │                                  │     }                         │                           │
      │                                  │                              │                           │
      │                                  │  7. 如果大V在线，推送通知 ─────────────────────────────────&gt;│
      │                                  │     WebSocket: "有人评论了你的动态"                         │
      │                                  │                              │                           │
      │&lt;──── 返回成功 ──────────────────│                              │                           │
      │      { comment_id: xxx }         │                              │                           │
      │                                  │                              │                           │
</code></pre>
<h4 data-id="heading-20">楼中楼回复</h4>
<pre><code class="hljs language-txt" lang="txt">┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  楼中楼回复流程                                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

    用户C回复用户B的评论
    
    POST /api/comment
    {
      message_id: "msg_001",           // 原动态ID
      content: "同意！",
      reply_to_user: "userB",          // 回复目标用户
      reply_to_comment: "cmt_001"      // 回复目标评论ID
    }
    
                                  │
                                  ▼
    ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │  写入评论表                                                                                               │
    │  ┌─────────────────┬─────────────────────────┬──────────┬────────────┬──────────────┬──────────────┐    │
    │  │  message_id     │  comment_id             │  user_id │  content   │  reply_to_user│ reply_to_cmt│    │
    │  │  msg_001        │  1703837000000_userC    │  userC   │  同意！     │  userB       │  cmt_001    │    │
    │  └─────────────────┴─────────────────────────┴──────────┴────────────┴──────────────┴──────────────┘    │
    └──────────────────────────────────────────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
    ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │  发送两条通知                                                                                             │
    │                                                                                                          │
    │  1. 通知动态作者 (bigV_001)                    2. 通知被回复者 (userB)                                      │
    │  ┌────────────────────────────────────┐       ┌────────────────────────────────────┐                     │
    │  │  type: COMMENT                     │       │  type: REPLY                       │                     │
    │  │  to_user: bigV_001                 │       │  to_user: userB                    │                     │
    │  │  from_user: userC                  │       │  from_user: userC                  │                     │
    │  │  content: "userC评论了你的动态"     │       │  content: "userC回复了你的评论"     │                     │
    │  └────────────────────────────────────┘       └────────────────────────────────────┘                     │
    └──────────────────────────────────────────────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-21">点赞</h3>
<h4 data-id="heading-22">表结构设计</h4>
<pre><code class="hljs language-txt" lang="txt">┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  like_table（点赞明细表）- 存储：Tablestore / HBase                                                               │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  主键设计                                                                                                        │
│  ┌─────────────────┬─────────────────────────┬─────────────────────────────────────────────────────────────┐   │
│  │  列名            │  类型                    │  说明                                                       │   │
│  ├─────────────────┼─────────────────────────┼─────────────────────────────────────────────────────────────┤   │
│  │  message_id     │  String (PK1, 分区键)    │  被点赞的动态ID                                              │   │
│  │  user_id        │  String (PK2)           │  点赞者ID，联合主键保证同一用户只能点赞一次                    │   │
│  └─────────────────┴─────────────────────────┴─────────────────────────────────────────────────────────────┘   │
│                                                                                                                 │
│  属性列                                                                                                          │
│  ┌─────────────────┬─────────────────────────┬─────────────────────────────────────────────────────────────┐   │
│  │  列名            │  类型                    │  说明                                                       │   │
│  ├─────────────────┼─────────────────────────┼─────────────────────────────────────────────────────────────┤   │
│  │  timestamp      │  Long                   │  点赞时间                                                    │   │
│  │  like_type      │  Integer                │  点赞类型：1-👍，2-❤️，3-😄，4-😮，5-😢，6-😠                  │   │
│  └─────────────────┴─────────────────────────┴─────────────────────────────────────────────────────────────┘   │
│                                                                                                                 │
│  示例数据                                                                                                        │
│  ┌───────────────────┬──────────────┬─────────────────┬─────────────┐                                          │
│  │  message_id       │  user_id     │  timestamp      │  like_type  │                                          │
│  ├───────────────────┼──────────────┼─────────────────┼─────────────┤                                          │
│  │  msg_001          │  userA       │  1703836800000  │  1          │                                          │
│  │  msg_001          │  userB       │  1703836900000  │  1          │                                          │
│  │  msg_001          │  userC       │  1703837000000  │  2          │                                          │
│  │  msg_002          │  userA       │  1703838000000  │  1          │                                          │
│  └───────────────────┴──────────────┴─────────────────┴─────────────┘                                          │
│                                                                                                                 │
│  特点：                                                                                                          │
│  - 联合主键 (message_id, user_id) 保证幂等，同一用户对同一动态只能有一条记录                                        │
│  - 重复点赞：直接覆盖（幂等）                                                                                      │
│  - 取消点赞：删除记录                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Redis 计数设计（解决热点问题）                                                                                   │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

方案1：简单计数（适合普通动态）
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Key: like_count:{message_id}                                                                                   │
│  Value: 12345                                                                                                   │
│  操作：INCR（点赞）/ DECR（取消）                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

方案2：分桶计数（适合大V爆款动态，解决热点Key问题）
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  问题：大V发了爆款动态，短时间100万人点赞，单Key成为热点                                                            │
│                                                                                                                 │
│  解决方案：将计数分散到多个桶                                                                                      │
│                                                                                                                 │
│  Key: like_count:{message_id}:bucket:{0-99}                                                                     │
│                                                                                                                 │
│  点赞时：                                                                                                        │
│    bucket_id = hash(user_id) % 100                                                                              │
│    INCR like_count:msg_001:bucket:37                                                                            │
│                                                                                                                 │
│  查询时：                                                                                                        │
│    方式1：MGET所有桶，求和                                                                                        │
│    方式2：定时任务聚合到主Key，查询主Key                                                                           │
│                                                                                                                 │
│  示例：                                                                                                          │
│  ┌────────────────────────────────────┬─────────────┐                                                           │
│  │  Key                               │  Value      │                                                           │
│  │  like_count:msg_001:bucket:0       │  1234       │                                                           │
│  │  like_count:msg_001:bucket:1       │  1289       │                                                           │
│  │  like_count:msg_001:bucket:2       │  1256       │                                                           │
│  │  ...                               │  ...        │                                                           │
│  │  like_count:msg_001:bucket:99      │  1301       │                                                           │
│  │  ─────────────────────────────────────────────── │                                                           │
│  │  like_count:msg_001 (聚合值)        │  125000     │  ← 定时任务更新                                           │
│  └────────────────────────────────────┴─────────────┘                                                           │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-23">点赞/取消点赞流程</h4>
<pre><code class="hljs language-txt" lang="txt">┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  点赞流程                                                                                                        │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

    用户A                            Like Service                       数据库                    动态作者
      │                                  │                                │                          │
      │ POST /api/like                   │                                │                          │
      │ {                                │                                │                          │
      │   message_id: "msg_001",         │                                │                          │
      │   action: "LIKE"                 │                                │                          │
      │ }                                │                                │                          │
      │─────────────────────────────────&gt;│                                │                          │
      │                                  │                                │                          │
      │                                  │  1. 检查是否已点赞              │                          │
      │                                  │────── GET ────────────────────&gt;│ like_table               │
      │                                  │     (msg_001, userA)           │                          │
      │                                  │&lt;───── NULL（未点赞）────────────│                          │
      │                                  │                                │                          │
      │                                  │  2. 写入点赞记录（幂等写入）     │                          │
      │                                  │────── PUT ────────────────────&gt;│ like_table               │
      │                                  │     (msg_001, userA, 1, now)   │                          │
      │                                  │                                │                          │
      │                                  │  3. 更新点赞计数               │                          │
      │                                  │────── INCR ──────────────────&gt;│ Redis                    │
      │                                  │     like_count:msg_001         │                          │
      │                                  │                                │                          │
      │                                  │  4. 发送通知（异步）            │                          │
      │                                  │─────────────────────────────────────────────────────────&gt;│
      │                                  │     "userA赞了你的动态"          │                          │
      │                                  │                                │                          │
      │&lt;──── 返回成功 ──────────────────│                                │                          │
      │      { liked: true, count: 1235 }│                                │                          │


┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  取消点赞流程                                                                                                    │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

    用户A                            Like Service                       数据库
      │                                  │                                │
      │ POST /api/like                   │                                │
      │ {                                │                                │
      │   message_id: "msg_001",         │                                │
      │   action: "UNLIKE"               │                                │
      │ }                                │                                │
      │─────────────────────────────────&gt;│                                │
      │                                  │                                │
      │                                  │  1. 删除点赞记录                │
      │                                  │────── DELETE ────────────────&gt;│ like_table
      │                                  │     (msg_001, userA)           │
      │                                  │                                │
      │                                  │  2. 更新点赞计数               │
      │                                  │────── DECR ─────────────────&gt;│ Redis
      │                                  │     like_count:msg_001         │
      │                                  │                                │
      │&lt;──── 返回成功 ──────────────────│                                │
      │      { liked: false, count: 1234}│                                │
</code></pre>
<h4 data-id="heading-24">上述场景涉及到的技术问题</h4>
<h5 data-id="heading-25">热点key的读写解决方案</h5>
<pre><code class="hljs language-txt" lang="txt">┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Feed流系统热点Key完整解决方案                                                                                    │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                                  │
│                                          用户请求                                                                 │
│                                             │                                                                    │
│                                             ▼                                                                    │
│                              ┌─────────────────────────────┐                                                    │
│                              │       热点检测模块           │                                                    │
│                              │  (滑动窗口统计访问频率)       │                                                    │
│                              └──────────────┬──────────────┘                                                    │
│                                             │                                                                    │
│                          ┌──────────────────┴──────────────────┐                                                │
│                          │                                     │                                                │
│                    普通Key                                热点Key                                               │
│                          │                                     │                                                │
│                          ▼                                     ▼                                                │
│               ┌─────────────────┐                   ┌─────────────────┐                                        │
│               │   直接访问Redis  │                   │   热点处理模块   │                                        │
│               └─────────────────┘                   └────────┬────────┘                                        │
│                                                              │                                                  │
│                                        ┌─────────────────────┴─────────────────────┐                           │
│                                        │                                           │                           │
│                                      读请求                                       写请求                         │
│                                        │                                           │                           │
│                                        ▼                                           ▼                           │
│                         ┌──────────────────────────┐               ┌──────────────────────────┐                │
│                         │       读热点处理          │               │       写热点处理          │                │
│                         │                          │               │                          │                │
│                         │  1. 本地缓存（Caffeine）  │               │  1. 分桶计数             │                │
│                         │     TTL: 1秒             │               │     100个桶，分散写压力   │                │
│                         │                          │               │                          │                │
│                         │  2. 多副本读取           │               │  2. 异步消息队列          │                │
│                         │     随机选择副本          │               │     Kafka削峰            │                │
│                         │                          │               │                          │                │
│                         │  3. 读写分离             │               │  3. 合并写入             │                │
│                         │     从Slave读取          │               │     累积后批量写入        │                │
│                         └──────────────────────────┘               └──────────────────────────┘                │
│                                                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
</code></pre>
<h6 data-id="heading-26">读热点解决方案</h6>
<ol>
<li>本地缓存。本地缓存未命中时才访问Redis。</li>
<li>读写分离+多副本。</li>
</ol>
<pre><code class="hljs language-txt" lang="txt">┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Redis 读写分离                                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

                              100万读请求/分钟
                                    │
                                    ▼
              ┌──────────────────────────────────────────────────────────────┐
              │                     读负载均衡                                │
              └──────────────────────────────────────────────────────────────┘
                    │              │              │              │
                    ▼              ▼              ▼              ▼
           ┌──────────────┐┌──────────────┐┌──────────────┐┌──────────────┐
           │  Slave-1     ││  Slave-2     ││  Slave-3     ││  Slave-4     │
           │  (只读)       ││  (只读)       ││  (只读)       ││  (只读)       │
           └──────────────┘└──────────────┘└──────────────┘└──────────────┘
                    ▲              ▲              ▲              ▲
                    │              │              │              │
                    └──────────────┴──────┬───────┴──────────────┘
                                          │ 主从复制
                                          │
                                   ┌──────────────┐
                                   │   Master     │ &lt;─── 写请求
                                   │   (读写)      │
                                   └──────────────┘

优点：
- 读请求分散到多个Slave，线性扩展读能力
- 适合读多写少场景

缺点：
- 主从复制有延迟（毫秒级）
- 架构复杂度增加
</code></pre>
<ol start="3">
<li>热点Key复制（Key分片读）</li>
</ol>
<pre><code class="hljs language-txt" lang="txt">┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  热点Key复制                                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

原始Key：like_count:msg_001  →  单节点承受所有请求

复制为多个Key：
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                                 │
│   like_count:msg_001:0  →  Node-1                                                                               │
│   like_count:msg_001:1  →  Node-2                                                                               │
│   like_count:msg_001:2  →  Node-3                                                                               │
│   like_count:msg_001:3  →  Node-4                                                                               │
│   ...                                                                                                           │
│   like_count:msg_001:N  →  Node-N                                                                               │
│                                                                                                                 │
│   读取时：随机选择一个副本Key读取                                                                                  │
│   replicaId = random.nextInt(N)                                                                                 │
│   key = "like_count:msg_001:" + replicaId                                                                       │
│                                                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
</code></pre>
<p>随机读取还是可能存在</p>
<h6 data-id="heading-27">写热点解决方案</h6>
<ol>
<li>分桶计数</li>
</ol>
<pre><code class="hljs language-txt" lang="txt">┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  分桶计数架构                                                                                                    │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

问题：100万人同时点赞，INCR like_count:msg_001 成为单点瓶颈

                              100万写请求/分钟
                                    │
                                    ▼
              ┌──────────────────────────────────────────────────────────────┐
              │                    Hash(user_id) % 100                        │
              └──────────────────────────────────────────────────────────────┘
           │          │          │          │          │          │
           ▼          ▼          ▼          ▼          ▼          ▼
    ┌──────────┐┌──────────┐┌──────────┐┌──────────┐┌──────────┐┌──────────┐
    │ bucket:0 ││ bucket:1 ││ bucket:2 ││ bucket:3 ││   ...    ││bucket:99 │
    │  INCR    ││  INCR    ││  INCR    ││  INCR    ││  INCR    ││  INCR    │
    │  =1234   ││  =1289   ││  =1256   ││  =1301   ││   ...    ││  =1278   │
    └──────────┘└──────────┘└──────────┘└──────────┘└──────────┘└──────────┘
           │          │          │          │          │          │
           └──────────┴──────────┴──────────┴──────────┴──────────┘
                                    │
                                    ▼
                          定时聚合（每秒/每分钟）
                                    │
                                    ▼
                          ┌──────────────────┐
                          │ like_count:msg_001│
                          │     = 125000     │
                          └──────────────────┘

效果：
- 100个桶，每个桶承担1万QPS
- 写压力分散到不同的Redis节点
</code></pre>
<ol start="2">
<li>异步写入 + 消息队列</li>
</ol>
<pre><code class="hljs language-txt" lang="txt">┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  异步写入架构                                                                                                    │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

                              100万写请求/分钟
                                    │
                                    ▼
              ┌──────────────────────────────────────────────────────────────┐
              │                     API Server                               │
              │                   (立即返回成功)                              │
              └──────────────────────────────────────────────────────────────┘
                                    │
                                    │ 发送消息（异步）
                                    ▼
              ┌──────────────────────────────────────────────────────────────┐
              │                    Kafka / RocketMQ                          │
              │                    like_topic                                │
              │               (多分区，并行消费)                               │
              └──────────────────────────────────────────────────────────────┘
                    │              │              │              │
                    ▼              ▼              ▼              ▼
           ┌──────────────┐┌──────────────┐┌──────────────┐┌──────────────┐
           │ Consumer-1   ││ Consumer-2   ││ Consumer-3   ││ Consumer-4   │
           │ Partition-0  ││ Partition-1  ││ Partition-2  ││ Partition-3  │
           └──────┬───────┘└──────┬───────┘└──────┬───────┘└──────┬───────┘
                  │               │               │               │
                  │         批量合并写入（每100条/每1秒）              │
                  │               │               │               │
                  └───────────────┴───────┬───────┴───────────────┘
                                          │
                                          ▼
                                   ┌──────────────┐
                                   │    Redis     │
                                   │   Database   │
                                   └──────────────┘

优点：
- 削峰填谷，平滑写入压力
- 支持批量合并，减少写入次数
- API快速响应，用户体验好

缺点：
- 数据有延迟（秒级）
- 需要处理消息积压
</code></pre>
<ol start="3">
<li>合并写入</li>
</ol>
<pre><code class="hljs language-txt" lang="txt">┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  合并写入                                                                                                        │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

原理：将多个写请求合并为一个，减少写入次数

    T0: INCR like:msg_001  →  累积 +1
    T1: INCR like:msg_001  →  累积 +2
    T2: INCR like:msg_001  →  累积 +3
    ...
    T99: INCR like:msg_001 →  累积 +100
    
    T100: 合并写入 → INCRBY like:msg_001 100  (一次写入代替100次)

┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                                 │
│   请求队列                             合并器                              Redis                                 │
│   ┌─────────────┐                 ┌─────────────┐                    ┌─────────────┐                            │
│   │ +1 (user_A) │                 │             │                    │             │                            │
│   │ +1 (user_B) │   ─────────&gt;    │  累积: +100 │   ─── 每100ms ───&gt; │ INCRBY 100  │                            │
│   │ +1 (user_C) │                 │             │                    │             │                            │
│   │ ...         │                 │             │                    │             │                            │
│   │ +1 (user_N) │                 │             │                    │             │                            │
│   └─────────────┘                 └─────────────┘                    └─────────────┘                            │
│                                                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
</code></pre>
<h5 data-id="heading-28">大key的读写解决方案</h5>
<h6 data-id="heading-29">读大key解决方案</h6>
<ol>
<li>水平拆分</li>
</ol>
<pre><code class="hljs language-txt" lang="txt">┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  拆分大Key - 将一个大Key拆分为多个小Key                                                                           │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

原始：
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Key: followers:bigV_001                                                                                        │
│  Type: Set                                                                                                      │
│  元素: [fan_001, fan_002, fan_003, ... fan_5000000]  (500万)                                                    │
│  大小: ~50MB                                                                                                    │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼ 拆分
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Key: followers:bigV_001:0     →  [fan_000001 ~ fan_050000]  (5万)  ~500KB                                      │
│  Key: followers:bigV_001:1     →  [fan_050001 ~ fan_100000]  (5万)  ~500KB                                      │
│  Key: followers:bigV_001:2     →  [fan_100001 ~ fan_150000]  (5万)  ~500KB                                      │
│  ...                                                                                                            │
│  Key: followers:bigV_001:99    →  [fan_4950001 ~ fan_5000000] (5万)  ~500KB                                     │
│                                                                                                                 │
│  拆分数量: 100个分片                                                                                             │
│  每个分片: 5万元素，约500KB                                                                                       │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
</code></pre>
<ol start="2">
<li>垂直拆分</li>
</ol>
<pre><code class="hljs language-txt" lang="txt">┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  垂直拆分 - 将大对象拆分为多个小对象，按需加载                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

原始（大对象）：
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Key: feed_detail:msg_001                                                                                       │
│  Value: {                                                                                                       │
│    "feed": { "id": "msg_001", "content": "...", "user": {...} },         // 基础信息 ~1KB                        │
│    "comments": [{...}, {...}, ...],                                       // 评论列表 ~2MB                       │
│    "likeUsers": [{...}, {...}, ...],                                      // 点赞用户 ~1MB                       │
│    "shareUsers": [{...}, {...}, ...]                                      // 转发用户 ~1MB                       │
│  }                                                                                                              │
│  总大小: ~5MB                                                                                                    │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼ 垂直拆分
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Key: feed:msg_001:basic                →  基础信息     ~1KB   （首屏加载）                                       │
│  Key: feed:msg_001:comments             →  评论列表     ~2MB   （展开时加载）                                     │
│  Key: feed:msg_001:comments:page:1      →  评论第1页    ~20KB  （分页加载）                                       │
│  Key: feed:msg_001:comments:page:2      →  评论第2页    ~20KB                                                    │
│  Key: feed:msg_001:like_users           →  点赞用户     ~1MB   （点击时加载）                                     │
│  Key: feed:msg_001:share_users          →  转发用户     ~1MB   （点击时加载）                                     │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
</code></pre>
<ol start="3">
<li>scan分批读取
只需检查 SCAN 返回的游标值是否为0，为0表示迭代完成。</li>
</ol>
<pre><code class="hljs language-txt" lang="txt">┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  分批读取 - 使用游标分批获取数据，避免一次性加载                                                                    │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

错误方式：
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  HGETALL big_hash    →  一次性返回10万个字段  →  阻塞Redis  →  网络传输慢                                         │
│  SMEMBERS big_set    →  一次性返回100万元素   →  OOM风险    →  客户端内存溢出                                      │
│  LRANGE big_list 0 -1 → 一次性返回全部元素   →  超时        →  请求失败                                           │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

正确方式：
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  HSCAN big_hash 0 COUNT 1000  →  每次返回约1000个字段  →  多次迭代  →  不阻塞                                      │
│  SSCAN big_set 0 COUNT 1000   →  每次返回约1000个元素  →  多次迭代  →  内存可控                                    │
│  LRANGE big_list 0 999        →  分页读取            →  多次请求  →  响应快                                       │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
</code></pre>
<ol start="4">
<li>压缩存储</li>
</ol>
<pre><code class="hljs language-txt" lang="txt">┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  压缩存储 - 减少Value大小                                                                                        │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

原始：5MB JSON字符串
压缩后：~500KB（压缩率约90%）

┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                                 │
│   原始数据 (5MB)                                                                                                 │
│   {                                                                                                             │
│     "feed": {...},                                                                                              │
│     "comments": [{...}, {...}, ...],  // 1000条评论                                                              │
│     "likeUsers": [{...}, {...}, ...], // 1000个点赞用户                                                          │
│     ...                                                                                                         │
│   }                                                                                                             │
│                                                                                                                 │
│         │                                                                                                       │
│         ▼  GZIP压缩                                                                                             │
│                                                                                                                 │
│   压缩数据 (~500KB)                                                                                              │
│   H4sIAAAAAAAAA6tWKkktLlGyUlAqS8wpTgUA8KxLFwwAAAA=                                                              │
│                                                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
</code></pre>
<h6 data-id="heading-30">写大key解决方案</h6>
<ol>
<li>分批写入</li>
</ol>
<pre><code class="hljs language-txt" lang="txt">┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  分批写入 - 将大量数据分批写入，避免一次性大量写入                                                                  │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

错误方式：
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  SADD followers:bigV_001 fan_001 fan_002 ... fan_100000   (一次性添加10万元素)                                   │
│  →  耗时长，阻塞Redis                                                                                           │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

正确方式：
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  第1批: SADD followers:bigV_001 fan_001 ... fan_1000      (1000个)                                              │
│  第2批: SADD followers:bigV_001 fan_1001 ... fan_2000     (1000个)                                              │
│  ...                                                                                                            │
│  第100批: SADD followers:bigV_001 fan_99001 ... fan_100000 (1000个)                                              │
│  →  每批耗时短，不阻塞Redis                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 Kiro AI IDE 开发 Amazon CDK 部署架构：从模糊需求到三层堆栈的协作实战]]></title>    <link>https://juejin.cn/post/7589308109641105443</link>    <guid>https://juejin.cn/post/7589308109641105443</guid>    <pubDate>2025-12-30T07:01:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589308109641105443" data-draft-id="7589386219449139215" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 Kiro AI IDE 开发 Amazon CDK 部署架构：从模糊需求到三层堆栈的协作实战"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-30T07:01:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="亚马逊云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2850395271209496"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 Kiro AI IDE 开发 Amazon CDK 部署架构：从模糊需求到三层堆栈的协作实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2850395271209496/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    亚马逊云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T07:01:46.000Z" title="Tue Dec 30 2025 07:01:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>本文记录了一次真实的 AI 辅助开发过程：如何使用 <strong>Kiro AI IDE</strong> 从一个模糊的部署需求开始，通过人机协作，逐步设计出三层堆栈架构，并完成基于Amazon EMR Flink 智能监控系统的Amazon CDK 部署代码。</p>
<p><strong>开发成果</strong>： – 开发时间：从 10 小时缩短到 1.5 小时（效率提升 6-7 倍） – 代码质量：自动应用亚马逊云科技最佳实践 – 架构演进：从单堆栈到三层堆栈的优化过程</p>
<p><strong>项目地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyangguangfu007%2Femr-flink-monitoring-agent" target="_blank" title="https://github.com/yangguangfu007/emr-flink-monitoring-agent" ref="nofollow noopener noreferrer">github.com/yangguangfu…</a></p>
<blockquote>
<p>🔥 想利用生成式AI开发工具解放双手，却苦于应用效果不够完善、流程不够规范？</p>
<p>✨ 亚马逊云科技 Kiro 登场！采用“规范驱动”开发理念，结合 Agent Hooks 自动化系统，1小时让小白变身生产级游戏制作人！</p>
<p>🔛 速来云上探索实验室，体验 Kiro 开发独立游戏，从需求到部署全掌握！</p>
<p>👉 <a href="https://link.juejin.cn?target=https%3A%2F%2Fevents.amazoncloud.cn%2Flabs%2Fcloudlab-kiro-cloudgames-static-website%3Fvisitfrom%3D3P_Juejinhead_1218%26sc_medium%3Downed%26sc_campaign%3Dcloudlab%26sc_channel%3D3P_Juejinhead_1218" target="_blank" title="https://events.amazoncloud.cn/labs/cloudlab-kiro-cloudgames-static-website?visitfrom=3P_Juejinhead_1218&amp;sc_medium=owned&amp;sc_campaign=cloudlab&amp;sc_channel=3P_Juejinhead_1218" ref="nofollow noopener noreferrer">点击这里</a>，即刻开启 AI 开发之旅！</p>
</blockquote>
<h2 data-id="heading-1">背景：什么是 Amazon CDK 和 Kiro？</h2>
<h3 data-id="heading-2">Amazon CDK 简介</h3>
<p>Amazon Cloud Development Kit (CDK) 是使用编程语言定义云基础设施的框架： – 使用 Python、TypeScript 等语言，而非 JSON/YAML – 代码复用和模块化 – IDE 支持（代码补全、类型检查） – 通过 Amazon CloudFormation 部署</p>
<h3 data-id="heading-3">Kiro 简介</h3>
<p><strong>Kiro</strong> 是亚马逊云科技推出的 AI 辅助开发工具： – 理解自然语言需求，生成 CDK 代码 – 基于 Spec 文档驱动开发 – 理解亚马逊云科技服务依赖关系 – 通过对话迭代优化架构设计</p>
<h2 data-id="heading-4">起点：一个模糊的部署需求</h2>
<h3 data-id="heading-5">我的初始需求</h3>
<p>我只有一个简单的想法：</p>
<p>“我想把基于 Amazon EMR Flink 的监控系统部署到亚马逊云科技环境”</p>
<p>具体细节都不清楚： – 用什么服务部署后端？Amazon ECS？Amazon Lambda？ – 前端怎么托管？Amazon S3？还是也用容器？ – 网络架构怎么设计？ – 安全组怎么配置？</p>
<h4 data-id="heading-6">第一步：与 Kiro 对话</h4>
<p><strong>我</strong>：我想把 Amazon EMR Flink 监控系统部署到亚马逊云科技，后端是 FastAPI，前端是 React。你有什么建议？</p>
<p><strong>Kiro</strong>：</p>
<p>我理解你的需求。让我帮你分析一下：</p>
<p>后端部署选项：</p>
<ol>
<li>Amazon Fargate – 推荐，无需管理服务器，按需付费</li>
<li>Amazon Lambda – 适合轻量级 API，但有 15 分钟超时限制</li>
<li>Amazon EC2 – 需要管理服务器，成本较高</li>
</ol>
<p>前端部署选项：</p>
<ol>
<li>Amazon S3 + Amazon CloudFront – 推荐，静态托管，全球 CDN</li>
<li>Amazon Amplify Hosting – 简单但灵活性较低</li>
</ol>
<p>建议架构：<br/>
– 前端：Amazon CloudFront + Amazon S3<br/>
– 后端：Application Load Balancer (ALB) + Amazon Fargate<br/>
– 认证：Amazon Cognito User Pool</p>
<p>我可以帮你用 CDK 实现这个架构。要不要先创建一个 Spec 文档？</p>
<h4 data-id="heading-7">第二步：创建 Spec 文档</h4>
<p>根据 Kiro 的建议，我创建了 Spec 文档来明确需求。</p>
<p><strong>我</strong>：帮我创建 Spec 文档结构。</p>
<p><strong>Kiro</strong> 帮我在 .kiro/specs/cloudfront-alb-ecs-deployment/ 创建了三个文档：</p>
<p><strong>requirements.md – 部署需求</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12f5445d52ed4a7a9d3f5ab4eadfc466~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767682906&amp;x-signature=65s0fMxhQjoUzVsKuaHjT1hKR3I%3D" alt="1.webp" loading="lazy"/></p>
<p><strong>design.md – 架构设计</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0d0a87320444d85ac55c28b211af1da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767682906&amp;x-signature=gKokEOdjxLOcE3meD%2BoPCRGyINU%3D" alt="2.webp" loading="lazy"/></p>
<p><strong>tasks.md – 任务分解</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bb5df8c78ee4fb58c1adfb904d639a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767682906&amp;x-signature=qJP8hfRZDVZJxuRUS6Z9wy3X2H8%3D" alt="3.webp" loading="lazy"/></p>
<h2 data-id="heading-8">使用 Kiro 开发 CDK 代码</h2>
<h3 data-id="heading-9">第一版：单堆栈实现</h3>
<p><strong>我</strong>：基于 Spec，帮我实现 CDK 部署代码。</p>
<p><strong>Kiro</strong>：开始实现…</p>
<p>Kiro 生成了第一版代码，所有资源都在一个 Stack 中：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FlinkMonitorStack</span>(<span class="hljs-title class_ inherited__">Stack</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, scope, <span class="hljs-built_in">id</span>, **kwargs</span>):
        <span class="hljs-built_in">super</span>().__init__(scope, <span class="hljs-built_in">id</span>, **kwargs)
        
        <span class="hljs-comment"># VPC、子网、安全组</span>
        <span class="hljs-comment"># Application Load Balancer (ALB)、Target Group</span>
        <span class="hljs-comment"># Amazon ECS Cluster、AWS Fargate Service</span>
        <span class="hljs-comment"># Amazon S3、Amazon CloudFront</span>
        <span class="hljs-comment"># Amazon Cognito</span>
        <span class="hljs-comment"># ... 所有资源都在这里</span>
</code></pre>
<p><strong>问题</strong>：代码超过 500 行，难以维护，部署时间长。</p>
<h4 data-id="heading-10">与 Kiro 探讨：如何优化架构？</h4>
<p><strong>我</strong>：这个 Stack 太大了，有没有更好的组织方式？</p>
<p><strong>Kiro</strong>：</p>
<p>你说得对。我建议采用多堆栈架构：</p>
<p>方案一：按资源类型分离<br/>
– NetworkStack：VPC、子网、安全组<br/>
– ComputeStack：Amazon ECS、Amazon Fargate<br/>
– StorageStack：Amazon S3、Amazon CloudFront<br/>
– AuthStack：Amazon Cognito</p>
<p>方案二：按部署频率分离（推荐）<br/>
– InfrastructureStack：基础设施（很少变更）<br/>
– BackendStack：后端应用（经常更新）<br/>
– FrontendStack：前端应用（经常更新）</p>
<p>方案二的优势：</p>
<ol>
<li>更新前端不影响后端</li>
<li>更新后端不影响基础设施</li>
<li>部署更快（只部署变更的堆栈）</li>
<li>职责清晰</li>
</ol>
<p>你觉得哪个方案更适合？</p>
<p><strong>我</strong>：方案二看起来更合理。但是堆栈之间怎么共享资源？</p>
<p><strong>Kiro</strong>：</p>
<p>通过 Amazon CloudFormation Outputs 和 Fn.importValue：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># InfrastructureStack 导出</span>
CfnOutput(self, "VPCId",
    <span class="hljs-attr">value</span>=vpc.vpc_id,
    <span class="hljs-attr">export_name</span>=<span class="hljs-string">"FlinkMonitor-VPC-Id"</span>
)

<span class="hljs-comment"># BackendStack 导入</span>
<span class="hljs-attr">vpc_id</span> = Fn.import_value(<span class="hljs-string">"FlinkMonitor-VPC-Id"</span>)
</code></pre>
<p>这样可以实现堆栈间的松耦合。</p>
<h3 data-id="heading-11">第二版：三层堆栈架构</h3>
<p>基于讨论，Kiro 重构了代码为三层堆栈。</p>
<p><strong>我</strong>：请按照三层堆栈重构代码。</p>
<p><strong>Kiro</strong>：正在重构…</p>
<h4 data-id="heading-12">1. InfrastructureStack – 基础设施堆栈</h4>
<p><strong>Kiro</strong> 生成了基础设施堆栈代码：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">InfrastructureStack</span>(<span class="hljs-title class_ inherited__">Stack</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, scope, <span class="hljs-built_in">id</span>, **kwargs</span>):
        <span class="hljs-built_in">super</span>().__init__(scope, <span class="hljs-built_in">id</span>, **kwargs)
        
        <span class="hljs-comment"># 网络资源</span>
        self._create_network_resources()
        
        <span class="hljs-comment"># 安全组</span>
        self._create_security_groups()
        
        <span class="hljs-comment"># 负载均衡</span>
        self._create_load_balancer()
        
        <span class="hljs-comment"># 前端基础设施</span>
        self._create_frontend_infrastructure()
        
        <span class="hljs-comment"># 认证服务</span>
        self._create_cognito()
</code></pre>
<p><strong>关键对话</strong>：Amazon ECS 安全组应该在哪里创建？</p>
<p><strong>我</strong>：Amazon ECS 安全组应该在 InfrastructureStack 还是 BackendStack？</p>
<p><strong>Kiro</strong>：</p>
<p>建议在 InfrastructureStack 中创建，原因：</p>
<ol>
<li>安全组是基础设施，不依赖 Amazon ECS 服务</li>
<li>可以在部署后端前就配置 Amazon EMR 安全组</li>
<li>避免循环依赖</li>
<li>符合 IaC 最佳实践</li>
</ol>
<p>实现：<br/>
– InfrastructureStack 创建 Amazon ECS 安全组<br/>
– 导出安全组 ID<br/>
– BackendStack 导入并使用</p>
<h4 data-id="heading-13">2. BackendStack – 后端应用堆栈</h4>
<p><strong>Kiro</strong> 生成了后端堆栈代码：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BackendStack</span>(<span class="hljs-title class_ inherited__">Stack</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, scope, <span class="hljs-built_in">id</span>, **kwargs</span>):
        <span class="hljs-built_in">super</span>().__init__(scope, <span class="hljs-built_in">id</span>, **kwargs)
        
        <span class="hljs-comment"># 导入基础设施资源</span>
        vpc_id = Fn.import_value(<span class="hljs-string">"FlinkMonitor-VPC-Id"</span>)
        ecs_sg_id = Fn.import_value(<span class="hljs-string">"FlinkMonitor-ECS-SecurityGroup"</span>)
        
        <span class="hljs-comment"># Amazon ECS Cluster</span>
        <span class="hljs-comment"># Task Definition</span>
        <span class="hljs-comment"># AWS Fargate Service</span>
</code></pre>
<h4 data-id="heading-14">3. FrontendStack – 前端应用堆栈</h4>
<p><strong>Kiro</strong> 生成了前端堆栈代码：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FrontendStack</span>(<span class="hljs-title class_ inherited__">Stack</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, scope, <span class="hljs-built_in">id</span>, **kwargs</span>):
        <span class="hljs-built_in">super</span>().__init__(scope, <span class="hljs-built_in">id</span>, **kwargs)
        
        <span class="hljs-comment"># 导入 Amazon S3 和 Amazon CloudFront</span>
        bucket_name = Fn.import_value(<span class="hljs-string">"FlinkMonitor-Frontend-Bucket"</span>)
        
        <span class="hljs-comment"># 构建前端</span>
        <span class="hljs-comment"># 部署到 Amazon S3</span>
        <span class="hljs-comment"># 失效 Amazon CloudFront 缓存</span>
</code></pre>
<h3 data-id="heading-15">迭代优化：解决实际问题</h3>
<p>在实际部署中遇到了一些问题，Kiro 帮助逐一解决。</p>
<h4 data-id="heading-16">问题 1：子网 CIDR 冲突</h4>
<p><strong>我</strong>：部署失败，提示子网 CIDR 与 EMR 冲突。</p>
<p><strong>Kiro</strong>：</p>
<p>我来帮你计算可用的 CIDR：</p>
<ol>
<li>查询 Amazon EMR 集群的子网 CIDR</li>
<li>找到 Amazon VPC 中未使用的 CIDR 范围</li>
<li>更新 cdk.json 配置</li>
</ol>
<p>已生成脚本：scripts/calculate_subnet_cidr.py</p>
<h4 data-id="heading-17">问题 2：Amazon EMR 安全组配置时机</h4>
<p><strong>我</strong>：什么时候配置 Amazon EMR 安全组？</p>
<p><strong>Kiro</strong>：</p>
<p>建议在 BackendStack 部署后、测试前配置：</p>
<p>步骤 4.5：配置 Amazon EMR 安全组<br/>
– Amazon ECS 安全组已在步骤 1 创建<br/>
– 不依赖 Amazon ECS 服务（只需要安全组 ID）<br/>
– 避免循环依赖</p>
<p>已生成脚本：scripts/configure_emr_security_group.sh</p>
<h4 data-id="heading-18">问题 3：前端环境变量</h4>
<p><strong>我</strong>：前端怎么获取 Amazon Cognito 和 API 地址？</p>
<p><strong>Kiro</strong>：</p>
<p>通过脚本自动生成 .env 文件：</p>
<ol>
<li>从 Amazon CloudFormation Outputs 读取值</li>
<li>生成 frontend/.env</li>
<li>前端构建时注入环境变量</li>
</ol>
<p>已生成脚本：scripts/generate_frontend_env.sh</p>
<h2 data-id="heading-19">最终架构：三层堆栈设计</h2>
<p>经过与 Kiro 的多轮对话和迭代，最终形成了清晰的三层堆栈架构。</p>
<h3 data-id="heading-20">架构图</h3>
<p><strong>完整部署架构图</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/caa0dc01e76e4816800f4f8041cd3624~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767682906&amp;x-signature=jwL0xqipMtoR76rrmERXvVFvVAM%3D" alt="4.webp" loading="lazy"/></p>
<p><strong>三层堆栈架构图</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6323cd8b29f242ea89ab479839853298~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767682906&amp;x-signature=AHmH1JUeVSFB8p7RI6DnDQyJxo0%3D" alt="5.webp" loading="lazy"/></p>
<h3 data-id="heading-21">设计原则</h3>
<ol>
<li><strong>职责分离</strong>：每个堆栈负责特定的资源类型</li>
<li><strong>依赖清晰</strong>：后端和前端依赖基础设施</li>
<li><strong>独立部署</strong>：可以单独更新某个堆栈</li>
<li><strong>资源共享</strong>：通过 Amazon CloudFormation 输出共享资源</li>
</ol>
<h3 data-id="heading-22">InfrastructureStack 核心资源</h3>
<h4 data-id="heading-23">网络资源</h4>
<ul>
<li>
<p><strong>Amazon VPC</strong> <strong>集成</strong>：自动发现 Amazon EMR 集群所在的 Amazon VPC</p>
</li>
<li>
<p><strong>子网创建</strong>：</p>
<ul>
<li>公有子网 × 2 (跨 2 个 AZ)：Application Load Balancer (ALB) + Amazon NAT Gateway</li>
<li>私有子网 × 2 (跨 2 个 AZ)：Amazon Fargate 任务</li>
</ul>
</li>
<li>
<p><strong>路由表</strong>：</p>
<ul>
<li>公有路由表 → Amazon Internet Gateway</li>
<li>私有路由表 × 2 → Amazon NAT Gateway (每个 AZ 一个)</li>
</ul>
</li>
</ul>
<h4 data-id="heading-24">安全资源</h4>
<ul>
<li>
<p><strong>安全组</strong>：</p>
<ul>
<li>Application Load Balancer (ALB) 安全组：允许 HTTP/HTTPS 入站</li>
<li>Amazon ECS 安全组：允许来自 Application Load Balancer (ALB) 的流量 (端口 8080)</li>
</ul>
</li>
<li>
<p><strong>Amazon IAM</strong> <strong>角色</strong>：</p>
<ul>
<li>Task Role：应用权限 (Amazon Bedrock、Amazon EMR、Amazon EC2)</li>
<li>Execution Role：Amazon ECS 基础操作权限</li>
</ul>
</li>
</ul>
<h4 data-id="heading-25">负载均衡</h4>
<ul>
<li>
<p><strong>Application Load Balancer (ALB)</strong> ：</p>
<ul>
<li>公网访问 (internet-facing)</li>
<li>跨 2 个 AZ 部署</li>
<li>HTTP 监听器 (端口 80)</li>
</ul>
</li>
<li>
<p><strong>Target Group</strong>：</p>
<ul>
<li>目标类型：IP (Amazon Fargate)</li>
<li>健康检查：/api/health 端点</li>
</ul>
</li>
</ul>
<h4 data-id="heading-26">前端基础设施</h4>
<ul>
<li>
<p><strong>Amazon S3 Bucket</strong>：</p>
<ul>
<li>私有访问 (通过 Amazon CloudFront OAC)</li>
<li>阻止所有公共访问</li>
</ul>
</li>
<li>
<p><strong>Amazon CloudFront Distribution</strong>：</p>
<ul>
<li>
<p>全球 CDN 加速</p>
</li>
<li>
<p>HTTPS 强制重定向</p>
</li>
<li>
<p>路由规则：</p>
<ul>
<li>/* → Amazon S3 (前端静态文件)</li>
<li>/api/* → Application Load Balancer (ALB) (后端 API)</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-27">认证服务</h4>
<ul>
<li>
<p><strong>Amazon Cognito User Pool</strong>：</p>
<ul>
<li>用户名 + 邮箱登录</li>
<li>密码策略 (8 位,大小写+数字)</li>
</ul>
</li>
<li>
<p><strong>Amazon Cognito User Pool Client</strong>：</p>
<ul>
<li>OAuth 2.0 授权码流</li>
<li>回调 URL：Amazon CloudFront + localhost</li>
</ul>
</li>
</ul>
<h3 data-id="heading-28">BackendStack 核心资源</h3>
<h4 data-id="heading-29">Amazon Fargate 服务</h4>
<ul>
<li>
<p><strong>Task Definition</strong>：</p>
<ul>
<li>CPU：1024 (1 vCPU)</li>
<li>内存：2048 MB (2 GB)</li>
<li>架构：ARM64 (成本优化)</li>
<li>容器镜像：从 Amazon ECR 拉取</li>
<li>环境变量：AWS_DEFAULT_REGION、EMR_CLUSTER_ID</li>
<li>健康检查：curl /api/health</li>
</ul>
</li>
<li>
<p><strong>Amazon Fargate Service</strong>：</p>
<ul>
<li>
<p>期望任务数：1 (可配置)</p>
</li>
<li>
<p>部署在私有子网</p>
</li>
<li>
<p>使用步骤 1 创建的 Amazon ECS 安全组</p>
</li>
<li>
<p>关联到 Application Load Balancer (ALB) Target Group</p>
</li>
<li>
<p>部署配置：</p>
<ul>
<li>最大百分比：200%</li>
<li>最小健康百分比：100%</li>
<li>启用断路器和自动回滚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-30">Amazon CloudWatch Logs</h4>
<ul>
<li>日志组：/ecs/flink-monitor</li>
<li>保留天数：7 天</li>
<li>日志流前缀：ecs</li>
</ul>
<h3 data-id="heading-31">FrontendStack 核心资源</h3>
<h4 data-id="heading-32">部署流程</h4>
<ol>
<li><strong>检查构建目录</strong>：frontend/dist</li>
<li><strong>上传到 Amazon S3</strong>：使用 BucketDeployment</li>
<li><strong>Amazon CloudFront</strong> <strong>失效</strong>：自动失效缓存 (/*)</li>
<li><strong>清理旧文件</strong>：prune=True</li>
</ol>
<h3 data-id="heading-33">部署成果展示</h3>
<p><strong>Amazon CloudFormation 堆栈</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a19fa850f98d4da69165445d3e763984~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767682906&amp;x-signature=n22ApmfccXlql04sGwjYLZjIbIY%3D" alt="6.webp" loading="lazy"/></p>
<p><strong>系统访问成功</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8466d76054a34be6a00704d8985247c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767682906&amp;x-signature=8nhQTcU3K2gxtmrQ0RE80HCAtBw%3D" alt="7.webp" loading="lazy"/></p>
<p><strong>监控仪表板</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a1d8a0a9f224eab85562e256264be34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767682906&amp;x-signature=tBBHcfP6J9b4z7U2S60xAfeGyNU%3D" alt="8.webp" loading="lazy"/></p>
<h3 data-id="heading-34">架构优势</h3>
<p><strong>1. 模块化</strong></p>
<ul>
<li>每个堆栈职责清晰</li>
<li>易于理解和维护</li>
<li>代码复用性高</li>
</ul>
<p><strong>2. 独立部署</strong></p>
<ul>
<li>前端更新不影响后端</li>
<li>后端更新不影响基础设施</li>
<li>加快部署速度</li>
</ul>
<p><strong>3. 安全隔离</strong></p>
<ul>
<li>基础设施变更需要明确操作</li>
<li>降低误操作风险</li>
<li>便于权限管理</li>
</ul>
<p><strong>4. 成本优化</strong></p>
<ul>
<li>仅部署需要更新的堆栈</li>
<li>减少 Amazon CloudFormation API 调用</li>
<li>节省部署时间</li>
</ul>
<h2 data-id="heading-35">基于 Kiro 的开发心得</h2>
<p><strong>1. Spec 驱动开发的价值</strong></p>
<p><strong>传统方式</strong>：直接写代码，边写边想架构 <strong>Kiro</strong> <strong>方式</strong>：先写 Spec，明确需求和设计，再生成代码</p>
<p><strong>优势</strong>： – 需求清晰，减少返工 – 设计文档自动生成 – 便于团队协作和 Code Review</p>
<p><strong>2. 对话式架构演进</strong></p>
<p><strong>关键发现</strong>：最好的架构不是一次设计出来的，而是通过对话逐步优化的。</p>
<p><strong>我的经验</strong>： – 第一版：单堆栈（简单但难维护） – 与 Kiro 讨论后：三层堆栈（模块化、可维护） – 遇到问题时：Kiro 提供多个方案，我选择最适合的</p>
<p><strong>3. AI 辅助的最佳实践</strong></p>
<p><strong>Kiro</strong> <strong>自动应用的最佳实践</strong>： – 安全组最小权限原则 – 跨 AZ 高可用部署 – 私有子网 + Amazon NAT Gateway – Amazon CloudFront OAC 而非 OAI – Amazon ECS 断路器和自动回滚</p>
<p><strong>我的收获</strong>：不仅得到了代码，还学到了亚马逊云科技最佳实践。</p>
<p><strong>4. 效率提升的关键</strong></p>
<p><strong>时间对比</strong>： – 传统开发：10 小时（查文档、写代码、调试） – Kiro 辅助：1.5 小时（对话、Review、微调）</p>
<p><strong>效率提升的原因</strong>： – 减少查文档时间（Kiro 知道所有 API） – 减少调试时间（生成的代码质量高） – 减少重构时间（架构设计合理）</p>
<p><strong>5. 人机协作的模式</strong></p>
<p><strong>最佳实践</strong>： – 人：提供需求、做决策、Review 代码 – AI：生成代码、提供方案、应用最佳实践</p>
<p><strong>不要</strong>： – 完全依赖 AI（需要理解生成的核心代码和流程） – 完全不用 AI（错过效率提升机会）</p>
<p><strong>6. 持续学习</strong></p>
<p><strong>意外收获</strong>： – 学会了三层堆栈架构模式 – 理解了 Amazon CloudFormation Outputs 的用法 – 掌握了 Amazon Fargate 的最佳实践 – 了解了 Amazon CloudFront 的高级配置</p>
<p><strong>建议</strong>：把 Kiro 当作学习工具，不仅要用它生成代码，还要理解为什么这样设计。</p>
<h2 data-id="heading-36">总结</h2>
<p>通过 Kiro AI 辅助开发 Amazon CDK 部署架构，我获得了：</p>
<ol>
<li><strong>效率提升</strong>：开发时间从 10 小时缩短到5 小时</li>
<li><strong>架构优化</strong>：从单堆栈演进到三层堆栈</li>
<li><strong>代码质量</strong>：自动应用 亚马逊云科技最佳实践</li>
<li><strong>知识积累</strong>：学习了云架构设计模式</li>
</ol>
<p><strong>核心体会</strong>： – Kiro 不是替代开发者，而是增强开发者 – 最好的架构来自人机协作 – Spec 驱动开发提高了代码质量 – AI 辅助让我们专注于架构设计，而非重复劳动</p>
<p><strong>下一步计划</strong>：</p>
<p>– 使用 Kiro 开发 CI/CD 流水线</p>
<p>– 探索 Kiro 在多环境部署中的应用</p>
<p><strong>参考资源</strong></p>
<ul>
<li><strong>项目地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyangguangfu007%2Femr-flink-monitoring-agent" target="_blank" title="https://github.com/yangguangfu007/emr-flink-monitoring-agent" ref="nofollow noopener noreferrer">github.com/yangguangfu…</a></li>
<li><strong>Amazon CDK</strong> <strong>文档</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.aws.amazon.com%2Fcdk%2F" target="_blank" title="https://docs.aws.amazon.com/cdk/" ref="nofollow noopener noreferrer">docs.aws.amazon.com/cdk/</a></li>
<li><strong>Kiro AI</strong> <strong>文档</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fkiro.dev%2Fdocs%2F" target="_blank" title="https://kiro.dev/docs/" ref="nofollow noopener noreferrer">kiro.dev/docs/</a></li>
</ul>
<p>*<em>前述特定亚马逊云科技生成式人工智能相关的服务目前在亚马逊云科技海外区域可用。亚马逊云科技中国区域相关云服务由西云数据和光环新网运营，具体信息以中国区域官网为准。</em></p>
<p><strong>本篇作者</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8fdfd4698cbe4ecfa688ca2b36622023~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767682906&amp;x-signature=6Y0cWfHILdkjeask38XCKBw3G48%3D" alt="9.webp" loading="lazy"/></p>
<blockquote>
<p>🔥 想利用生成式AI开发工具解放双手，却苦于应用效果不够完善、流程不够规范？</p>
<p>✨ 亚马逊云科技 Kiro 登场！采用“规范驱动”开发理念，结合 Agent Hooks 自动化系统，1小时让小白变身生产级游戏制作人！</p>
<p>🔛 速来云上探索实验室，体验 Kiro 开发独立游戏，从需求到部署全掌握！</p>
<p>👉 <a href="https://link.juejin.cn?target=https%3A%2F%2Fevents.amazoncloud.cn%2Flabs%2Fcloudlab-kiro-cloudgames-static-website%3Fvisitfrom%3D3P_Juejintail_1218%26sc_medium%3Downed%26sc_campaign%3Dcloudlab%26sc_channel%3D3P_Juejintail_1218" target="_blank" title="https://events.amazoncloud.cn/labs/cloudlab-kiro-cloudgames-static-website?visitfrom=3P_Juejintail_1218&amp;sc_medium=owned&amp;sc_campaign=cloudlab&amp;sc_channel=3P_Juejintail_1218" ref="nofollow noopener noreferrer">点击这里</a>，即刻开启 AI 开发之旅！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>