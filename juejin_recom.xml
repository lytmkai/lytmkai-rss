<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[剑指offer-38、⼆叉树的深度]]></title>    <link>https://juejin.cn/post/7573579203460513843</link>    <guid>https://juejin.cn/post/7573579203460513843</guid>    <pubDate>2025-11-18T01:12:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573579203460513843" data-draft-id="7572566115848798258" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="剑指offer-38、⼆叉树的深度"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-11-18T01:12:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            剑指offer-38、⼆叉树的深度
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T01:12:48.000Z" title="Tue Nov 18 2025 01:12:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">题⽬描述</h2>
<p>输⼊⼀棵⼆叉树，求该树的深度。从根结点到叶结点依次经过的结点（含根、叶结点）形成树的⼀条路径，最⻓路径的⻓度为树的深度。</p>
<p>示例1
输⼊：{1,2,3,4,5,#,6,#,#,7}
返回值：4</p>
<h2 data-id="heading-1">思路及解答</h2>
<p>声明：这⾥的输⼊是⼀个数的根节点，也就是从根节点，我们就可以获取到树的所有节点，⽽类似数组的表达⽅式 {1,2,3,4,5,#,6,#,#,7} ，则是按照层次来放的。(⽐如这个树就是4层)</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8da78b9033b49a8ab2ab2c0db621ad8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764033168&amp;x-signature=yd%2F6utyQW120c%2F1lli9SAfdg6tQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">递归</h3>
<p>第⼀种⽅法⽐较容易想到，对于任意⼀个节点 node ⽽⾔，我要想知道当前 node 节点（包括当前节点）的深度，肯定得求当前节点的左边节点（设为 left ）的深度 leftDeepth ，以及获取右节点（设为 right ）的深度 rightDeepth ，然后求两者最⼤+1（ Max{leftDeepth,rightDeepth}+1 ），就是当前节点的深度。</p>
<p>思路：二叉树的深度 = max(左子树深度, 右子树深度) + 1</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3b5a62a8a244fb082de720e34813910~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764033168&amp;x-signature=d8URAlqbKLcnFVhBoHeiJByq0kU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b7f5fefa5914e5e992d14aa5c2fefc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764033168&amp;x-signature=lYOodImiRMHQ49rSPWj6UYSpi5A%3D" alt="" loading="lazy"/></p>
<p>⽽递归中⽐较重要的⼀点，是结束条件。在这道题中，如果⼀个节点为 null ，就结束，并且当前节点的深度是 0 。代码超级⽆敌短：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
     <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">TreeDepth</span><span class="hljs-params">(TreeNode root)</span> {
         <span class="hljs-keyword">if</span>(root==<span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
         <span class="hljs-keyword">return</span> Math.max(TreeDepth(root.left),TreeDepth(root.right))+<span class="hljs-number">1</span>;
     }
}
</code></pre>
<p>以上解法要是看不明白，可以看详细点的：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">TreeDepth</span><span class="hljs-params">(TreeNode root)</span> {
        <span class="hljs-comment">// 递归终止条件：空节点深度为0</span>
        <span class="hljs-keyword">if</span> (root == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }
        
        <span class="hljs-comment">// 递归计算左子树深度</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">leftDepth</span> <span class="hljs-operator">=</span> maxDepth(root.left);
        <span class="hljs-comment">// 递归计算右子树深度</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">rightDepth</span> <span class="hljs-operator">=</span> maxDepth(root.right);
        
        <span class="hljs-comment">// 当前树深度 = 左右子树最大深度 + 1（当前节点）</span>
        <span class="hljs-keyword">return</span> Math.max(leftDepth, rightDepth) + <span class="hljs-number">1</span>;
    }
}
</code></pre>
<ul>
<li><strong>时间复杂度</strong>：O(n)，需要访问每个节点一次</li>
<li><strong>空间复杂度</strong>：O(h)，递归栈深度等于树高，最坏情况（链表）为O(n)</li>
</ul>
<h3 data-id="heading-3">迭代遍历</h3>
<p>思路是如果树的根节点不为空，则将根节点放进队列中。也就是，每遍历一层，深度加1，直到遍历完所有层</p>
<p>设置深度 deep 为0。使⽤ while 循环，只要队列不为空，则执⾏下⾯操作：</p>
<ol>
<li>获取队列的⼤⼩ size 。</li>
<li>依次取出队列的前 size 个元素，如果该元素的左边节点不为空，则将左边节点放进队列，如果该元素的右边节点不为空，则将该元素的右边节点放进队列。</li>
<li>层次 deep+1</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">TreeDepth</span><span class="hljs-params">(TreeNode root)</span> {
        <span class="hljs-keyword">if</span> (root == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        
        Queue&lt;TreeNode&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
        queue.offer(root);
        <span class="hljs-type">int</span> <span class="hljs-variable">depth</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-keyword">while</span> (!queue.isEmpty()) {
            <span class="hljs-comment">// 当前层的节点个数</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">levelSize</span> <span class="hljs-operator">=</span> queue.size();
            
            <span class="hljs-comment">// 遍历当前层的所有节点</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; levelSize; i++) {
                <span class="hljs-type">TreeNode</span> <span class="hljs-variable">currentNode</span> <span class="hljs-operator">=</span> queue.poll();
                
                <span class="hljs-comment">// 将下一层节点加入队列</span>
                <span class="hljs-keyword">if</span> (currentNode.left != <span class="hljs-literal">null</span>) {
                    queue.offer(currentNode.left);
                }
                <span class="hljs-keyword">if</span> (currentNode.right != <span class="hljs-literal">null</span>) {
                    queue.offer(currentNode.right);
                }
            }
            
            <span class="hljs-comment">// 完成一层遍历，深度加1</span>
            depth++;
        }
        
        <span class="hljs-keyword">return</span> depth;
    }
}
</code></pre>
<ul>
<li>时间复杂度为：O(n)，所有的节点需要进⼊队列，再出队列</li>
<li>空间复杂度：O(n),借助了额外的队列空间。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[剖析 LangGraph 的 Super-step 概念]]></title>    <link>https://juejin.cn/post/7573512056089952291</link>    <guid>https://juejin.cn/post/7573512056089952291</guid>    <pubDate>2025-11-18T01:14:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573512056089952291" data-draft-id="7573299401047031854" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="剖析 LangGraph 的 Super-step 概念"/> <meta itemprop="keywords" content="LangChain"/> <meta itemprop="datePublished" content="2025-11-18T01:14:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ALLINAI"/> <meta itemprop="url" content="https://juejin.cn/user/4001878056639549"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            剖析 LangGraph 的 Super-step 概念
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4001878056639549/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ALLINAI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T01:14:39.000Z" title="Tue Nov 18 2025 01:14:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>Super-step 是 LangGraph 的执行单位 —— 一个“同步的批处理轮次”</strong>。在每个 super-step 中，框架会并行/批量地运行当前所有可执行节点，收集它们的写入（updates），用事先定义好的 reducer 把写入合并成一个新的全局状态（snapshot），然后进入下一个 super-step。每个 super-step 结束都会形成一个 checkpoint（快照），用于持久化、恢复、回放与时间旅行。</p>
</blockquote>
<p>下面把这个概念从高层到细节、从设计思想到工程实现，系统讲清楚——包括为什么要这样做、底层如何实现、并发模型如何介入、与 checkpoint 的关系、常见用法与调试技巧等。</p>
<hr/>
<h2 data-id="heading-0">1. 概念速览（一句话）</h2>
<p><strong>super-step = 一轮并行执行 + 收集所有节点写入 + 用 reducer 原子合并到全局状态 + 生成 checkpoint</strong>。
它来源于 Pregel / BSP（Bulk Synchronous Parallel）模型，是 LangGraph 的核心执行语义。</p>
<hr/>
<h2 data-id="heading-1">2. 为什么用 super-step（设计动机）</h2>
<ul>
<li><strong>一致性</strong>：在同一轮次内所有节点看到的状态相同（读时点一致，Read-time Consistency），写入合并时统一处理，避免交叉依赖导致的不确定性。</li>
<li><strong>可恢复 / 可回放</strong>：每轮结束即 checkpoint，便于恢复、时间旅行、human-in-the-loop。</li>
<li><strong>并行表达力</strong>：多个逻辑上独立的节点可以在同一轮次中并发执行，适合并行任务与 agent 协作场景。</li>
<li><strong>明确的合并语义</strong>：通过 reducer（或默认覆盖规则）定义如何把多个节点的写入合并为一个状态，便于设计累积型字段（例如列表累加）。</li>
</ul>
<hr/>
<h2 data-id="heading-2">3. super-step 的执行流程（分步骤详解）</h2>
<ol>
<li>
<p><strong>发现 active nodes</strong></p>
<ul>
<li>根据当前 state、图结构以及上次合并结果决定哪些节点在本轮可执行（runnable / active）。</li>
</ul>
</li>
<li>
<p><strong>执行 active nodes（并发或串行）</strong></p>
<ul>
<li>执行函数/节点体，得到每个节点的输出（通常包含 <code>update</code> 字段，和 <code>goto</code> / control 指令）。</li>
<li>节点输出先写入临时缓冲区（不会立即改变全局 state）。</li>
</ul>
</li>
<li>
<p><strong>收集所有 writes</strong></p>
<ul>
<li>汇总所有节点的 <code>update</code>（状态写入）。</li>
</ul>
</li>
<li>
<p><strong>对每个字段执行 reducer 合并</strong></p>
<ul>
<li>如果字段被 Annotated 指定了合并策略（例如 <code>add</code>），就用该策略合并；否则按默认规则（通常覆盖）。</li>
</ul>
</li>
<li>
<p><strong>生成新的 state snapshot（StateSnapshot）</strong></p>
<ul>
<li>包含 <code>values</code>（合并后状态）、<code>next</code>（下轮要执行的节点）、<code>metadata</code>、<code>tasks</code> 等。</li>
</ul>
</li>
<li>
<p><strong>持久化 checkpoint（checkpointer）</strong></p>
<ul>
<li>把 snapshot 写入保存器（InMemory/SQLite/Postgres 等），用于恢复与回放。</li>
</ul>
</li>
<li>
<p><strong>循环或结束</strong></p>
<ul>
<li>如果还有可执行节点，继续下一轮 super-step，否则图执行结束。</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-3">4. 底层实现：调度器、并发、同步（关键点与伪代码）</h2>
<p><strong>关键点：super-step 是调度模型，不是并发模型。</strong> 调度器负责分阶段执行与合并，但是否并发取决于节点本身或运行时选择。</p>
<p>伪代码（高度概括）：</p>
<pre><code class="hljs language-python" lang="python">state = initial_state
<span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> finished(state):
    active_nodes = discover_active_nodes(state)
    <span class="hljs-comment"># 1) 并发执行或串行执行 active nodes 的 node.run</span>
    results = parallel_map(execute_node, active_nodes)  <span class="hljs-comment"># 可以是并行，也可以是同步</span>
    <span class="hljs-comment"># 2) 收集所有 writes</span>
    all_writes = collect_writes(results)
    <span class="hljs-comment"># 3) 按字段 reducer 合并成 new_state</span>
    new_state = reduce_state(state, all_writes)
    <span class="hljs-comment"># 4) 生成并持久化 checkpoint</span>
    checkpointer.save(snapshot=new_state, metadata=...)
    state = new_state
</code></pre>
<p>说明：</p>
<ul>
<li><code>parallel_map</code> 可以用 <code>asyncio.gather</code>（若节点为 async）或 <code>ThreadPoolExecutor</code>（若你希望线程并发），也可以是普通 for-loop（单线程）。框架本身并不强制创建线程。</li>
<li><code>reduce_state</code> 是原子操作：基于每个字段的合并策略（Annotated metadata），把所有写入合并成一份一致状态。</li>
</ul>
<hr/>
<h2 data-id="heading-4">5. state 合并（reducers / Annotated 的角色）</h2>
<ul>
<li>
<p>LangGraph 使用 Python 类型注解（<code>typing.Annotated</code>）来为状态字段<strong>附加元数据</strong>，其中常见元数据是“合并函数”（reducer）。</p>
</li>
<li>
<p>例如：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">State</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    foo: <span class="hljs-built_in">str</span>                  <span class="hljs-comment"># 覆盖式（默认）</span>
    bar: Annotated[<span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>], add]  <span class="hljs-comment"># 使用 add 合并（列表拼接）</span>
</code></pre>
</li>
<li>
<p>在一个 super-step 中，若两个节点都写 <code>bar</code>，框架会调用 <code>add(existing, new)</code> 而不是简单替换，从而实现累积语义（例如消息队列、事件收集、结果合并）。</p>
</li>
</ul>
<p>这是 LangGraph 支持并行节点写入而仍能保证确定性的关键机制。</p>
<hr/>
<h2 data-id="heading-5">6. super-step 与 checkpoint / 持久化的关系</h2>
<ul>
<li><strong>每个 super-step 结束都会产生一个 checkpoint（StateSnapshot）</strong>，包含当时的 <code>values</code>, <code>metadata</code>, <code>next</code>, <code>tasks</code> 等。</li>
<li>Checkpoint 提供能力：<strong>恢复（restore）、回放（replay）、时间旅行（fork）、人机中断/resume（interrupt）</strong>。</li>
<li>底层实现是可插拔的 <code>checkpointer</code>（InMemorySaver、SqliteSaver、PostgresSaver 等），并配合 <code>Serializer</code>（JsonPlus/EncryptedSerializer）做序列化/加密。</li>
</ul>
<p>因此 super-step ≈ 执行单位，checkpoint ≈ 记忆/持久化副本，两者合起来就是可恢复可审计的有状态执行引擎。</p>
<hr/>
<h2 data-id="heading-6">7. 并发模型：多线程、协程还是同步？（工程实践）</h2>
<ul>
<li>
<p><strong>super-step 本身是同步的、分阶段的调度模型</strong>（BSP）。</p>
</li>
<li>
<p><strong>LangGraph 不强制使用多线程或协程</strong>。它在设计上允许并发执行节点，但并发是“可选的执行策略”，由运行时与节点类型决定。</p>
<ul>
<li>节点如果是 <code>async def</code>，框架可以用 <code>asyncio</code> 执行（协程）。</li>
<li>你也可以在节点内部自己使用线程池（<code>ThreadPoolExecutor</code>）或外部并发资源。</li>
</ul>
</li>
<li>
<p>优点：让状态合并与确定性留在框架层（避免 race condition），并发交给可控的执行策略（用户显式开启）。</p>
</li>
<li>
<p>设计理由：<strong>可重现性与确定性</strong>。自动多线程会带来写入顺序不确定，影响 reducer 行为与 snapshot 一致性。</p>
</li>
</ul>
<p>简言之：<strong>super-step 保证“何时合并”，并发实现决定“如何并发执行节点”。</strong></p>
<hr/>
<h2 data-id="heading-7">8. 常见模式与示例（含 Email Agent 场景）</h2>
<h3 data-id="heading-8">8.1 并行决策（B 和 C 同轮执行）</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
START --&gt; A --&gt; B
A --&gt; C --&gt; END
</code></pre>
<p>执行：</p>
<ul>
<li>step 1：执行 A，合并 state，checkpoint</li>
<li>step 2：同时运行 B 和 C（同一 super-step），收集两者写入并合并，checkpoint</li>
</ul>
<h3 data-id="heading-9">8.2 Email Agent</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75c9dae04ea644ab9ca9dff9182a4c5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUxMSU5BSQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764033279&amp;x-signature=O0g8DHMtWcyRYzD1CG%2F9X%2FQOfXU%3D" alt="graph.png" loading="lazy"/></p>
<ul>
<li>初始：<code>read_email</code> → <code>classify_intent</code></li>
<li>若分类为 <code>billing</code> 且 <code>critical</code>：路由到 <code>human_review</code>（interrupt）</li>
<li>human_review 会触发 interrupt（中断）并生成 checkpoint；第一次 invoke 返回中断 payload（没有 <code>draft_response</code>），等待外部 resume（人工审核）</li>
<li>当 resume 提交（<code>app.invoke(resume)</code>）时，从中断点继续执行，进入下一轮 super-step 并合并来自人工输入的更新（例如已批准的 <code>draft_response</code>），然后发送邮件（send_reply）</li>
</ul>
<hr/>
<h2 data-id="heading-10">9. 优势、权衡与限制</h2>
<h3 data-id="heading-11">优势</h3>
<ul>
<li><strong>确定性</strong>：相同输入和相同 reducer 配置，执行可重复（对于调试与合规重要）。</li>
<li><strong>并行表达力</strong>：可以在一轮里并执行多个逻辑独立节点。</li>
<li><strong>强大的持久化</strong>：每步 snapshot 都可回放与恢复，是构建长期任务与对话记忆的基础。</li>
<li><strong>清晰的合并语义</strong>：通过 Annotated 指定 reducer，避免竞态写入歧义。</li>
</ul>
<h3 data-id="heading-12">权衡与限制</h3>
<ul>
<li><strong>延迟的可见性</strong>：节点写入在本轮结束之前对其他节点不可见（这既是特性也是限制）。某些紧耦合场景需更细粒度交互。</li>
<li><strong>并发不自动化</strong>：需要工程上显式选择 async/thread 才能并行，增加使用复杂度。</li>
<li><strong>设计成本</strong>：需要为状态字段考虑合并策略（哪些字段应累积、覆盖、或用自定义 reducer）。</li>
<li><strong>复杂 debug</strong>：多轮 super-step 与 reducer 行为结合时，理解历史演变需要读取 checkpoints（好处是可读，但需要工具）。</li>
</ul>
<hr/>
<h2 data-id="heading-13">10. 实战建议与调试要点</h2>
<ul>
<li><strong>为每个状态字段明确 reducer</strong>（用 <code>Annotated</code> 标注），比如列表用 <code>add</code>，字典可能用 <code>dict_merge</code>，某些字段采用覆盖策略。</li>
<li><strong>使用 thread_id 与 checkpoint 恰当分割会话</strong>，对话/任务用独立线程 ID，便于并行用户隔离与回放。</li>
<li><strong>在需要并发节点时</strong>：优先使用 async 节点或显式线程池；但要确保 reducer 正确，避免顺序依赖。</li>
<li><strong>检查点与中断调试</strong>：当出现 KeyError（例如 <code>draft_response</code> 不存在），检查首次 invoke 是否停在 interrupt（human_review）节点 —— 因为 interrupt 会暂停执行且不会写回某些字段。</li>
<li><strong>记录 metadata</strong>：开启或丰富 snapshot 的 metadata（比如哪个节点写了哪个字段），便于日后排查。</li>
<li><strong>限制 snapshot 历史</strong>：在生产系统中需要合适保留策略或归档旧 checkpoint，避免无限膨胀。</li>
<li><strong>加密/合规</strong>：持久化对话数据敏感时，用 <code>EncryptedSerializer</code> 并选择可靠后端（Postgres + AES key 管理）。</li>
</ul>
<hr/>
<h2 data-id="heading-14">结语</h2>
<p>LangGraph 的 <strong>super-step</strong> 并非简单的“每次执行一个节点”，而是一个有意识的<strong>分阶段执行模型</strong>：保证并行表达、状态一致性与可恢复性的同时，把并发策略留给开发者显式掌控。正是这个设计，使 LangGraph 在构建复杂工作流、agent 协作、人机中断与长期记忆等场景时，既灵活又可控。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端小白Express入门：初识Web框架与项目搭建]]></title>    <link>https://juejin.cn/post/7573525634213560363</link>    <guid>https://juejin.cn/post/7573525634213560363</guid>    <pubDate>2025-11-18T01:16:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573525634213560363" data-draft-id="7573535624533377043" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端小白Express入门：初识Web框架与项目搭建"/> <meta itemprop="keywords" content="Node.js,Express,前端"/> <meta itemprop="datePublished" content="2025-11-18T01:16:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大前端历险记"/> <meta itemprop="url" content="https://juejin.cn/user/395479916219517"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端小白Express入门：初识Web框架与项目搭建
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/395479916219517/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大前端历险记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T01:16:27.000Z" title="Tue Nov 18 2025 01:16:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前端小白Express入门：初识Web框架与项目搭建</h2>
<h3 data-id="heading-1">前言：前端为什么需要学习Express？</h3>
<p>在开始学习Express之前，很多前端同学可能会问：我已经会React/Vue了，为什么还要学习后端框架？前端工程师不是应该专注于界面和用户体验吗？</p>
<p><strong>答案在于：现代前端开发已经远远超越了"切图写界面"的范畴。全栈能力正在成为前端工程师的核心竞争力，而Express是理解Web开发全貌的最佳入口。</strong></p>
<h3 data-id="heading-2">一、原生HTTP模块 vs Express：直观对比</h3>
<p>让我们通过一个简单的例子来感受两者的区别。</p>
<h4 data-id="heading-3">1.1 使用Node.js原生HTTP模块创建服务器</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);

<span class="hljs-comment">// 创建HTTP服务器</span>
<span class="hljs-keyword">const</span> server = http.<span class="hljs-title function_">createServer</span>(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-comment">// 手动解析URL和请求方法</span>
  <span class="hljs-keyword">const</span> { url, method } = req;
  
  <span class="hljs-comment">// 简单的路由判断</span>
  <span class="hljs-keyword">if</span> (url === <span class="hljs-string">'/'</span> &amp;&amp; method === <span class="hljs-string">'GET'</span>) {
    res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">200</span>, { <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/html'</span> });
    res.<span class="hljs-title function_">end</span>(<span class="hljs-string">'&lt;h1&gt;欢迎来到首页&lt;/h1&gt;'</span>);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (url === <span class="hljs-string">'/api/users'</span> &amp;&amp; method === <span class="hljs-string">'GET'</span>) {
    res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">200</span>, { <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span> });
    res.<span class="hljs-title function_">end</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">users</span>: [<span class="hljs-string">'张三'</span>, <span class="hljs-string">'李四'</span>] }));
  } <span class="hljs-keyword">else</span> {
    res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">404</span>, { <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/html'</span> });
    res.<span class="hljs-title function_">end</span>(<span class="hljs-string">'&lt;h1&gt;页面未找到&lt;/h1&gt;'</span>);
  }
});

<span class="hljs-comment">// 启动服务器</span>
server.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'服务器运行在 http://localhost:3000'</span>);
});
</code></pre>
<p><strong>痛点分析：</strong></p>
<ul>
<li>需要手动解析URL和请求方法</li>
<li>路由处理变得复杂且难以维护</li>
<li>缺少中间件等高级功能</li>
<li>代码组织不够直观</li>
</ul>
<h4 data-id="heading-4">1.2 使用Express实现相同功能</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PORT</span> = <span class="hljs-number">3000</span>;

<span class="hljs-comment">// 路由处理变得极其简单</span>
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">'&lt;h1&gt;欢迎来到首页&lt;/h1&gt;'</span>);
});

app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/users'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">users</span>: [<span class="hljs-string">'张三'</span>, <span class="hljs-string">'李四'</span>] });
});

<span class="hljs-comment">// 404处理</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-string">'*'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">status</span>(<span class="hljs-number">404</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">'&lt;h1&gt;页面未找到&lt;/h1&gt;'</span>);
});

app.<span class="hljs-title function_">listen</span>(<span class="hljs-variable constant_">PORT</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Express服务器运行在 http://localhost:<span class="hljs-subst">${PORT}</span>`</span>);
});
</code></pre>
<p><strong>Express优势：</strong></p>
<ul>
<li>简洁的路由定义</li>
<li>内置的响应方法（<code>send</code>, <code>json</code>等）</li>
<li>清晰的错误处理</li>
<li>易于扩展的中间件体系</li>
</ul>
<h3 data-id="heading-5">二、快速创建Express项目</h3>
<h4 data-id="heading-6">2.1 环境准备</h4>
<p>首先确保你的系统已经安装Node.js（建议版本14+）：</p>
<pre><code class="hljs language-bash" lang="bash">node --version  <span class="hljs-comment"># 检查Node.js版本</span>
npm --version   <span class="hljs-comment"># 检查npm版本</span>
</code></pre>
<h4 data-id="heading-7">2.2 初始化项目</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建项目目录</span>
<span class="hljs-built_in">mkdir</span> my-express-app
<span class="hljs-built_in">cd</span> my-express-app

<span class="hljs-comment"># 初始化package.json</span>
npm init -y

<span class="hljs-comment"># 安装Express</span>
npm install express
</code></pre>
<h4 data-id="heading-8">2.3 项目结构规划</h4>
<p>建议采用清晰的项目结构：</p>
<pre><code class="hljs language-csharp" lang="csharp">my-express-app/
├── src/
│   ├── app.js          <span class="hljs-meta"># Express应用实例</span>
│   ├── routes/         <span class="hljs-meta"># 路由文件</span>
│   ├── middleware/     <span class="hljs-meta"># 自定义中间件</span>
│   └── <span class="hljs-keyword">public</span>/         <span class="hljs-meta"># 静态资源</span>
├── package.json
└── README.md
</code></pre>
<h4 data-id="heading-9">2.4 使用Express应用生成器（脚手架）</h4>
<p>对于更复杂的项目，推荐使用官方生成器：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 全局安装express-generator</span>
npm install -g express-generator

<span class="hljs-comment"># 创建项目</span>
express --view=ejs my-advanced-app

<span class="hljs-comment"># 安装依赖</span>
<span class="hljs-built_in">cd</span> my-advanced-app
npm install

<span class="hljs-comment"># 启动项目</span>
npm start
</code></pre>
<p>生成的项目结构更加完整：</p>
<pre><code class="hljs language-csharp" lang="csharp">my-advanced-app/
├── bin/
│   └── www            <span class="hljs-meta"># 服务器启动文件</span>
├── <span class="hljs-keyword">public</span>/            <span class="hljs-meta"># 静态资源</span>
├── routes/            <span class="hljs-meta"># 路由文件</span>
├── views/             <span class="hljs-meta"># 模板文件</span>
├── app.js             <span class="hljs-meta"># 主应用文件</span>
└── package.json
</code></pre>
<h3 data-id="heading-10">三、中间件概念初探：Express的核心灵魂</h3>
<h4 data-id="heading-11">3.1 什么是中间件？</h4>
<p><strong>中间件（Middleware）</strong> 是Express中最核心的概念。你可以把它想象成一个<strong>处理流水线</strong>，每个中间件就像是流水线上的一个工作站，对请求进行加工处理。</p>
<h4 data-id="heading-12">3.2 中间件的基本结构</h4>
<p>每个中间件函数都遵循相同的模式：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">middleware</span>(<span class="hljs-params">req, res, next</span>) {
  <span class="hljs-comment">// 对请求进行处理</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${req.method}</span> <span class="hljs-subst">${req.url}</span>`</span>);
  
  <span class="hljs-comment">// 调用next()将控制权交给下一个中间件</span>
  <span class="hljs-title function_">next</span>();
}
</code></pre>
<h4 data-id="heading-13">3.3 实际应用示例</h4>
<p>让我们创建一个完整的示例来理解中间件的工作流程：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();

<span class="hljs-comment">// 1. 日志记录中间件</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> timestamp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[<span class="hljs-subst">${timestamp}</span>] <span class="hljs-subst">${req.method}</span> <span class="hljs-subst">${req.url}</span>`</span>);
  <span class="hljs-title function_">next</span>(); <span class="hljs-comment">// 必须调用next()！</span>
});

<span class="hljs-comment">// 2. 静态文件服务中间件</span>
app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">static</span>(<span class="hljs-string">'public'</span>));

<span class="hljs-comment">// 3.  body解析中间件</span>
app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">json</span>()); <span class="hljs-comment">// 解析JSON格式的请求体</span>
app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">urlencoded</span>({ <span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span> })); <span class="hljs-comment">// 解析表单数据</span>

<span class="hljs-comment">// 4. 自定义认证中间件（模拟）</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-string">'/api'</span>, <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-comment">// 检查API请求的认证信息</span>
  <span class="hljs-keyword">const</span> token = req.<span class="hljs-property">headers</span>.<span class="hljs-property">authorization</span>;
  
  <span class="hljs-keyword">if</span> (!token) {
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">401</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">error</span>: <span class="hljs-string">'未提供认证令牌'</span> });
  }
  
  <span class="hljs-comment">// 模拟token验证</span>
  <span class="hljs-keyword">if</span> (token !== <span class="hljs-string">'Bearer valid-token'</span>) {
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">403</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">error</span>: <span class="hljs-string">'认证失败'</span> });
  }
  
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'认证通过'</span>);
  <span class="hljs-title function_">next</span>();
});

<span class="hljs-comment">// 5. 业务路由</span>
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">'欢迎来到首页！'</span>);
});

app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/api/data'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'接收到的数据:'</span>, req.<span class="hljs-property">body</span>);
  res.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'数据接收成功'</span>, <span class="hljs-attr">data</span>: req.<span class="hljs-property">body</span> });
});

<span class="hljs-comment">// 6. 404处理中间件（放在最后）</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-string">'*'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">status</span>(<span class="hljs-number">404</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">'页面未找到'</span>);
});

<span class="hljs-comment">// 7. 错误处理中间件（四个参数）</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">err, req, res, next</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'发生错误:'</span>, err);
  res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">error</span>: <span class="hljs-string">'服务器内部错误'</span> });
});

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PORT</span> = <span class="hljs-number">3000</span>;
app.<span class="hljs-title function_">listen</span>(<span class="hljs-variable constant_">PORT</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`服务器运行在 http://localhost:<span class="hljs-subst">${PORT}</span>`</span>);
});
</code></pre>
<h4 data-id="heading-14">3.4 中间件的执行顺序</h4>
<p>理解中间件的执行顺序至关重要：</p>
<pre><code class="hljs language-css" lang="css">请求进入
    ↓
日志中间件（记录请求信息）
    ↓
静态文件中间件（如果是静态文件请求，直接返回）
    ↓
<span class="hljs-selector-tag">Body</span>解析中间件（解析请求体数据）
    ↓
认证中间件（检查API认证）
    ↓
路由处理（业务逻辑）
    ↓
<span class="hljs-number">404</span>处理（如果没有匹配的路由）
    ↓
错误处理（如果发生错误）
</code></pre>
<h3 data-id="heading-15">四、最佳实践与常见陷阱</h3>
<h4 data-id="heading-16">4.1 项目初始化最佳实践</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// package.json 建议配置</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-express-app"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Express实战项目"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/app.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node src/app.js"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"nodemon src/app.js"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"test"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"jest"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"keywords"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"express"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"nodejs"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"你的名字"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MIT"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-17">4.2 常见陷阱及解决方案</h4>
<p><strong>陷阱1：忘记调用next()</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 错误示例</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'这个中间件会阻塞整个应用！'</span>);
  <span class="hljs-comment">// 忘记调用next()，请求会一直挂起</span>
});

<span class="hljs-comment">// 正确做法</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'正确处理请求'</span>);
  <span class="hljs-title function_">next</span>(); <span class="hljs-comment">// 必须调用！</span>
});
</code></pre>
<p><strong>陷阱2：中间件顺序错误</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 错误顺序 - 404处理放在前面</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-string">'*'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">status</span>(<span class="hljs-number">404</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">'页面未找到'</span>);
});

<span class="hljs-comment">// 后面的路由永远不会执行</span>
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">'这个页面永远不会被访问到'</span>);
});

<span class="hljs-comment">// 正确顺序</span>
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">'首页'</span>);
});

app.<span class="hljs-title function_">use</span>(<span class="hljs-string">'*'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {  <span class="hljs-comment">// 404处理放在最后</span>
  res.<span class="hljs-title function_">status</span>(<span class="hljs-number">404</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">'页面未找到'</span>);
});
</code></pre>
<h3 data-id="heading-18">五、实战练习</h3>
<p>为了巩固理解，请尝试完成以下练习：</p>
<ol>
<li>
<p><strong>创建一个Express服务器</strong>，实现以下路由：</p>
<ul>
<li><code>GET /</code>：返回"首页欢迎语"</li>
<li><code>GET /about</code>：返回"关于我们"</li>
<li><code>POST /contact</code>：接收并返回联系人信息</li>
</ul>
</li>
<li>
<p><strong>添加自定义中间件</strong>：</p>
<ul>
<li>请求日志记录</li>
<li>API请求时间计算</li>
<li>简单的请求频率限制</li>
</ul>
</li>
<li>
<p><strong>组织项目结构</strong>：</p>
<ul>
<li>将路由分离到单独的文件中</li>
<li>创建自定义中间件目录</li>
</ul>
</li>
</ol>
<h3 data-id="heading-19">总结</h3>
<p>通过本文的学习，你应该已经掌握了：</p>
<ul>
<li>✅ Express相对于原生HTTP模块的优势</li>
<li>✅ 如何从零搭建Express项目</li>
<li>✅ 中间件的核心概念和工作原理</li>
<li>✅ 合理的项目结构规划</li>
<li>✅ 常见的陷阱和最佳实践</li>
</ul>
<p><strong>Express的精髓在于"约定优于配置"</strong> - 它提供了一套优雅的约定，让Web开发变得更加愉快和高效。</p>
<p>在下一篇文章中，我们将深入探讨<strong>Express的路由系统</strong>，学习如何构建复杂的API接口和RESTful服务。</p>
<hr/>
<p><strong>动手时间</strong>：按照文中的示例代码，亲手搭建你的第一个Express应用。遇到问题欢迎在评论区留言讨论！</p>
<p><em>提示：记得安装nodemon用于开发时的自动重启：<code>npm install -D nodemon</code></em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[智能体与小模型：AI迈向平民化的新浪潮]]></title>    <link>https://juejin.cn/post/7573528564027080750</link>    <guid>https://juejin.cn/post/7573528564027080750</guid>    <pubDate>2025-11-18T01:20:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573528564027080750" data-draft-id="7573528564026834990" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="智能体与小模型：AI迈向平民化的新浪潮"/> <meta itemprop="keywords" content="算法,计算机视觉,深度学习"/> <meta itemprop="datePublished" content="2025-11-18T01:20:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            智能体与小模型：AI迈向平民化的新浪潮
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T01:20:35.000Z" title="Tue Nov 18 2025 01:20:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>数百亿参数、庞大算力需求、昂贵的部署成本……当科技巨头们还在追求“更大更强”的AI模型时，一股反向而行的趋势正悄然兴起，并可能彻底改变人工智能的应用格局。</p>
<p>过去一年，AI智能体（AI Agent）热度急剧攀升，成为人工智能领域最受关注的话题之一。从科技巨头到初创企业，纷纷加入这场智能体竞赛。</p>
<p>然而，在这波智能体浪潮背后，一个关键转变正在发生：小而专的模型正取代庞大而全的模型，成为推动智能体普及的核心力量。</p>
<h2 data-id="heading-0"><strong>智能体热潮</strong></h2>
<p>2025年被业界广泛称为 <strong>“AI Agent元年”</strong> 。今年上半年，随着OpenAI相继发布Operator（执行简单任务的Agent）与Deep Research（进行深度研究的Agent），AI智能体领域的竞争骤然加剧。</p>
<p>智能体与早期AI应用有着根本区别。</p>
<p>AI应用经历了从提示词到工作流，再到智能体的三个发展阶段。最初的提示词阶段，用户通过对话与大模型交互；工作流阶段则通过预设的节点与路径多步骤完成任务。</p>
<p>而智能体是“能够自主感知环境、自主决策、执行任务并达成目标的智能系统”。其核心优势在于感知环境、自主决策及工具使用能力。</p>
<p>科技巨头纷纷押注智能体赛道：Google预计发布能够操作浏览器和其他软件的Project Mariner，百度推出“心响”APP，阿里的“心流”项目则深入探索Agent的人机协同效率。</p>
<h2 data-id="heading-1"><strong>小模型崛起：AI平民化的关键推力</strong></h2>
<p>当众多企业还在追逐更大参数、更强能力的大模型时，小模型正以惊人的速度填补着大模型无法覆盖的市场空白。</p>
<p>据英伟达突破性研究显示，40%至70%的企业级AI任务可以通过小型语言模型更高效地处理——这些参数少于100亿的模型速度比巨型模型<strong>快10倍</strong>，部署和维护成本降低<strong>5-20倍</strong>。</p>
<p>小模型之所以重要，是因为它们解决了大模型在实际部署中的根本痛点：<strong>庞大的计算需求、高昂的推理成本以及对硬件的苛刻要求。</strong></p>
<p align="center">**<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cdefc2041c594bf684d965832fdc6e4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764033634&amp;x-signature=KlosFRICae%2Fbj2JvXSmGrWR6Q3w%3D" alt="v2_3ba9d2b90a5b44af957964942c6dfb05@000000_oswg1382235oswg1000oswg1000_img_000.jpg" loading="lazy"/>**</p>
<p>在资源受限的环境中，如智能手机、工厂车间、医疗仪器等边缘设备，小模型几乎是唯一可行的选择。</p>
<p>像Coovally这样的AI开发平台，进一步降低了小模型的应用门槛。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/271e0a80230a4f0086f8821fba9dba21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764033634&amp;x-signature=qtnr4KLjooR1%2BT5QUoQRWbh9q3E%3D" alt="Coovally操作动图.gif" loading="lazy"/></p>
<p>它提供从数据预处理、智能标注到模型训练和部署的一站式服务，使开发者无需深厚的专业知识也能快速构建和部署AI模型。这种平民化工具的出现，正让小模型从研究机构的实验室走向千行百业的实际应用。</p>
<h2 data-id="heading-2"><strong>视觉小模型：智能体的“慧眼”</strong></h2>
<p>在计算机视觉领域，小模型同样展现出令人惊叹的表现。</p>
<p>IDEA计算机视觉与机器人研究中心发布的<strong>Rex-Omni</strong>是一款仅30亿参数的多模态大语言模型，它提升了模型对复杂语义和空间关系的理解水平，使目标检测能力实现跃进。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44e05eade6d64a20bd87de69bd680db5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764033634&amp;x-signature=h04QWrrjWEJpSzHM4QLeJgd2JuU%3D" alt="rex-Demo-gif.gif" loading="lazy"/></p>
<p>Rex-Omni将所有视觉感知任务统一到“坐标预测框架”下，即每个任务均被构建为“生成坐标序列”，通过创新的任务构建、数据引擎和训练流程，解决了现有多模态大语言模型“语言强但定位弱”的痛点。</p>
<p>同样，小红书团队推出的<strong>DeepEyesV2</strong>多模态AI模型通过智能利用外部工具，在多项任务中超越了更大型的模型。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29df23b478f64a9596a7208fa1bbbddc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764033634&amp;x-signature=aqi2MIzITgZdNhzgiblUlOgxeLM%3D" alt="screenshot_2025-11-17_16-20-06.png" loading="lazy"/></p>
<p>该模型能组合使用代码执行、图像搜索和文本搜索三类工具，把图像操作、Python执行和图像/文本搜索整合起来，灵活应对各种查询。</p>
<h2 data-id="heading-3"><strong>小模型逆袭的关键</strong></h2>
<p>小模型之所以能在智能体中发挥重要作用，关键在于<strong>工具使用能力</strong>的突破。</p>
<p>2025年，Agent的核心变化在于Tool Use能力取得了实质性进展。从编程到browser-use（Agent模拟用户在浏览器中的操作），再到computer-use（Agent操控计算机系统），Agent的工具使用能力得到显著增强。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e05e46503884e75b569d358b7282dd9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764033634&amp;x-signature=Zk2d2Jrdk6JNv0A1RyAOB%2FWSIpw%3D" alt="v2_43ea98184f7041b7a23f0318f6303793@000000_oswg980865oswg1000oswg1000_img_000.jpg" loading="lazy"/></p>
<p>DeepEyesV2的研究团队发现，仅靠强化学习，模型无法稳定地用工具完成多模态任务。他们开发出<strong>两阶段的训练流程</strong>：第一阶段学习把图像理解和工具使用结合起来；第二阶段再用强化学习优化这些行为。</p>
<p>工具使用能力的提升，使小模型能够突破参数限制，利用外部资源扩展自身能力。这类似于一个人学会使用图书馆，不必记忆所有知识，却能在需要时获取所需信息。</p>
<h2 data-id="heading-4"><strong>为何小模型更适合智能体</strong></h2>
<p>与小模型相比，大型模型在部署上面临重重困难。传统闭源AI解决方案部署成本通常在<strong>50万到数百万人民币</strong>，而通过开源社区支持，中小企业仅需20-50万元即可完成小模型部署。</p>
<p>私有化部署虽然解决了数据安全与定制化需求，却带来了一系列新问题：市场碎片化、资源重复投入、计算资源利用率低。</p>
<p>思瀚产业研究院数据显示，近60%企业选择在本地数据中心或私有云和边缘位置部署AI推理模型，显示出对私有部署的偏好。</p>
<p>这种“重硬轻软”的投资惯性，导致硬件重复投资，增加财政负担和企业成本。</p>
<p>小模型则以其<strong>轻量、高效、低成本</strong>的特性，成为智能体普及的理想选择：参数更少、快速推理、资源高效、特定任务优化、注重隐私、成本效益高、更易于微调、便携易部署。</p>
<h2 data-id="heading-5"><strong>小模型智能体已无处不在</strong></h2>
<p>在智慧城市领域，联想集团在武夷山、宜昌等城市相继落地 <strong>“城市超级智能体”</strong> ，将AI能力输送给城市的各行各业和市民游客，实现从政务到民生、产业的全面智能化。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/779ec3b251704edaaaad19d27cbf7d9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764033634&amp;x-signature=HYLlnbdo0RK9Iu0OvZHoFEzqDE8%3D" alt="dll8cyjpendofof9uobxneyd6yjash572342.jpg" loading="lazy"/></p>
<p>在机器人领域，Google DeepMind上线的<strong>SIMA 2预览版</strong>依托轻量级的Gemini 2.5 Flash-lite模型，任务成功率相较于SIMA 1大幅提高，能在从未见过的新环境里完成复杂指令，还具备自我改进能力。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77db5dbc545e4a2ba071c7c96da066c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764033634&amp;x-signature=YSTP1PEUf0UV%2FXPnTQErQfD%2BwGw%3D" alt="screenshot_2025-11-17_16-37-05.png" loading="lazy"/></p>
<p>在内容创作、知识问答、智能助理、AI搜索等场景中，基于小模型的智能体也已实现广泛应用。</p>
<p>中国信息通信研究院云计算与大数据研究所副所长栗蔚表示，在企业级应用方面，可以应用智能体推动企业降本增效和数据驱动决策的进一步实践。</p>
<p><strong>在Coovally上，持续集成和开源多类高质量数据集，</strong> 覆盖无人机巡检、智慧农业、智慧渔业等多个领域，推动AI开发更加高效与开放。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/050651adbc7e4c1cac57f88cea84414b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764033634&amp;x-signature=FYRba416dSkYqs33Tx7LdJDSteo%3D" alt="模型数据集.GIF" loading="lazy"/></p>
<p><strong>！！点击下方链接，立即体验Coovally！！</strong></p>
<p><strong>平台链接：</strong> <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.coovally.com" target="_blank" title="https://www.coovally.com" ref="nofollow noopener noreferrer">www.coovally.com</a></strong></p>
<h2 data-id="heading-6"><strong>小模型智能体的发展路径</strong></h2>
<p>小模型智能体的发展不会取代大模型，而是形成一种<strong>互补共生的关系</strong>。企业正在将两者结合起来，构建混合架构，以优化不同的使用场景：大模型处理复杂的推理、战略规划和创造性任务；</p>
<p>SLM执行器管理高频次、特定任务的操作，例如客户支持、数据处理和监控。</p>
<p>这种分工协作既能实现最佳资源分配，又能保持复杂工作流程所需的智能性。</p>
<p>未来，<strong>强化学习驱动的持续迭代</strong>将是Agent发展的关键路径。随着工具使用能力的进一步突破，小模型智能体将能在更复杂的环境中感知、决策和行动，真正成为人类的智能助手。</p>
<p>AI智能体正在走出实验室，走进普通人的日常生活。它们不再是被大型科技公司垄断的尖端技术，而是成为中小企业甚至个人都能驾驭的智能工具。</p>
<p>计算机视觉小模型与智能体的结合，预示着一个全新方向的诞生——人工智能不再追求“更大更全”，而是朝着“小而专、专而精”的方向演化。</p>
<p>这或许才是人工智能真正走向普及、走向平民化的必经之路。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[云原生游戏网关架构：EKS + APISIX + Graviton 构建高性能游戏服务网关]]></title>    <link>https://juejin.cn/post/7573592952242323508</link>    <guid>https://juejin.cn/post/7573592952242323508</guid>    <pubDate>2025-11-18T01:37:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573592952242323508" data-draft-id="7573504290066694159" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="云原生游戏网关架构：EKS + APISIX + Graviton 构建高性能游戏服务网关"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-18T01:37:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="亚马逊云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2850395271209496"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            云原生游戏网关架构：EKS + APISIX + Graviton 构建高性能游戏服务网关
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2850395271209496/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    亚马逊云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T01:37:18.000Z" title="Tue Nov 18 2025 01:37:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在现代游戏运营环境中，随着游戏服务器规模的不断扩大，传统的服务器代理方案面临着诸多挑战。本文将介绍如何使用 API Six 这一高性能网关来解决大规模游戏服务器代理的问题，特别是针对需要使用多个 Network Load Balancer (NLB) 的场景，提供一个更加优雅和高效的解决方案。
在游戏服务架构中，我们经常遇到以下几个关键挑战：</p>
<p>1、 服务器规模问题</p>
<ul>
<li>随着游戏的成功运营，服务器数量可能从最初的几台扩展到成百上千台</li>
<li>传统的使用多个 NLB 进行代理的方案在管理和维护上变得越来越复杂</li>
<li>成本问题：每增加一个 NLB 都会带来额外的费用支出</li>
</ul>
<p>2、 安全性考虑</p>
<ul>
<li>游戏服务器需要防护各种网络攻击</li>
<li>传统的 TCP 协议缺乏足够的安全保护机制</li>
<li>需要在不影响性能的前提下提供安全保障</li>
</ul>
<p>3、运维复杂性</p>
<ul>
<li>多个 NLB 的配置管理较为繁琐</li>
<li>服务器扩缩容时需要频繁调整负载均衡配置</li>
<li>监控和故障排查的难度随着规模增加而增加</li>
</ul>
<p>面对这些挑战，我们需要一个更现代化的解决方案。API Six 作为一个高性能、可扩展的网关，结合 TLS 加密，能够很好地解决这些问题。在接下来的内容中，我们将详细介绍如何使用 API Six 构建一个高效、安全、易于管理的游戏服务网关系统。</p>
<blockquote>
<p>📢限时插播：在本次实验中，你可以在基于 Graviton 的 EC2 实例上轻松启动 Milvus 向量数据库，加速您的生成式 AI 应用。</p>
<p>⏩快快点击进入《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.amazoncloud.cn%2Fexperience%2Fcloudlab%3Fid%3D668dfdebee6ab158880f2852%26visitfrom%3D3P_Juejinhead_0618%26sc_medium%3Downed%26sc_campaign%3Dcloudlab%26sc_channel%3D3P_Juejinhead_0618" target="_blank" title="https://dev.amazoncloud.cn/experience/cloudlab?id=668dfdebee6ab158880f2852&amp;visitfrom=3P_Juejinhead_0618&amp;sc_medium=owned&amp;sc_campaign=cloudlab&amp;sc_channel=3P_Juejinhead_0618" ref="nofollow noopener noreferrer">创新基石 —— 基于 Graviton 构建差异化生成式AI向量数据库</a>》实验</p>
<p>📱 即刻在云上探索实验室，开启构建开发者探索之旅吧</p>
</blockquote>
<h2 data-id="heading-1">架构介绍</h2>
<h3 data-id="heading-2">1. 架构整体说明</h3>
<p>APIsix核心组件运行于 Amazon EKS（Elastic Kubernetes Service）集群内部。整个系统主要分为两大访问入口：运维（Ops）和玩家（Players），分别通过独立的 ELB（Elastic Load Balancer）接入.(在此建议咱们在部署环境前可以先手动创建ELB, 在EKS中通过TargetGroupBinding的方式来进行绑定服务,这样可以保证后续服务变更时前端接入ELB为同一个.)</p>
<h3 data-id="heading-3">2. 流量入口</h3>
<ul>
<li>Ops（运维）入口
运维人员通过 ELB 访问 EKS 集群中的 Admin API，实现对平台的管理和监控。</li>
<li>Players（玩家）入口
玩家流量同样通过独立的 ELB 进入 EKS 集群，主要访问 API Gateway，进而路由到具体的游戏服务（Game Server）或平台服务（Platform Service）。</li>
</ul>
<h3 data-id="heading-4">3. EKS 集群内部结构</h3>
<ul>
<li>Admin API 层
提供管理接口，供运维人员操作和管理整个系统。</li>
<li>etcd 层
作为分布式键值存储，负责服务发现、配置管理等核心功能。Admin API 会将变更写入 etcd，API Gateway 通过 watch 机制实时感知服务变化。</li>
<li>API Gateway 层
这一层是玩家访问的主要入口，API Gateway 负责根据 etcd 的服务发现信息，将玩家请求路由到后端的具体服务（如 Platform Service 或 Game Server）。</li>
<li>业务服务层
包含平台服务（Platform Service）和多个游戏服（Game Server1、Game Server2 等），这些服务是最终处理玩家请求的核心业务组件。</li>
</ul>
<h2 data-id="heading-5">方案部署</h2>
<p>下面我们将逐步来验证整个方案, 方案中我们将采用模拟TCP协议的游戏服务,通过ELB来实现不同游戏服的路由功能.首先我们需要创建一个实验EKS集群, 参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.aws.amazon.com%2Feks%2Flatest%2Fuserguide%2Fgetting-started.html" target="_blank" title="https://docs.aws.amazon.com/eks/latest/userguide/getting-started.html" ref="nofollow noopener noreferrer">EKS文档</a> 创建EKS.</p>
<h3 data-id="heading-6">创建好EKS后, 添加用户权限</h3>
<p>然后创建Access Entry</p>
<h3 data-id="heading-7">使用Helm来安装部署APISix</h3>
<p>本文采用的部署目标服务器为亚马逊云科技Graviton机型,可以帮助我们发挥APISix的最大性能. 参考步骤如下:</p>
<p>1、添加相关helm库</p>
<pre><code class="hljs language-csharp" lang="csharp">helm repo <span class="hljs-keyword">add</span> apisix https:<span class="hljs-comment">//charts.apiseven.com</span>
helm repo update
</code></pre>
<p>2、整理apisix-values.yaml</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># Tolerations for Graviton nodes (if needed)</span>
<span class="hljs-attr">tolerations:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">"kubernetes.io/arch"</span>
    <span class="hljs-attr">operator:</span> <span class="hljs-string">"Equal"</span>
    <span class="hljs-attr">value:</span> <span class="hljs-string">"arm64"</span>
    <span class="hljs-attr">effect:</span> <span class="hljs-string">"NoSchedule"</span>

<span class="hljs-comment"># Affinity to prefer Graviton nodes</span>
<span class="hljs-attr">affinity:</span>
  <span class="hljs-attr">nodeAffinity:</span>
    <span class="hljs-attr">preferredDuringSchedulingIgnoredDuringExecution:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">weight:</span> <span class="hljs-number">100</span>
      <span class="hljs-attr">preference:</span>
        <span class="hljs-attr">matchExpressions:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">kubernetes.io/arch</span>
          <span class="hljs-attr">operator:</span> <span class="hljs-string">In</span>
<span class="hljs-comment">### values:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">arm64</span>
</code></pre>
<p>3、执行命令更新服务</p>
<pre><code class="hljs language-css" lang="css">helm install apisix apisix/apisix <span class="hljs-attr">--create-namespace</span> <span class="hljs-attr">--namespace</span> ingress-apisix \
<span class="hljs-attr">--values</span> apisix-values<span class="hljs-selector-class">.yaml</span>
</code></pre>
<p>4、如果此处部署有问题,一定要关注一下当前的storageclass是否存在.</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">etcd:</span>
  <span class="hljs-attr">persistence:</span>
    <span class="hljs-attr">storageClass:</span> <span class="hljs-string">efs-sc</span> <span class="hljs-comment"># 请格外注意此处,否则可能方案部署失败.</span>
</code></pre>
<p>另推荐一个小技巧,如果部署出现问题,可以使用Amazon Q CLI来做诊断,整个过程完全自动化,下面是我的步骤截图.</p>
<h3 data-id="heading-8">部署 游戏服务</h3>
<p>模拟游戏服代码</p>
<pre><code class="hljs language-python" lang="python"> <span class="hljs-comment"># Bind to all interfaces</span>
    server.bind((<span class="hljs-string">'0.0.0.0'</span>, port))
    server.listen(<span class="hljs-number">5</span>)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[*] <span class="hljs-subst">{server_name}</span> listening on 0.0.0.0:<span class="hljs-subst">{port}</span>"</span>)
    
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            client, addr = server.accept()
            client_handler = threading.Thread(target=handle_client, args=(client, addr))
            client_handler.daemon = <span class="hljs-literal">True</span>
            client_handler.start()
    <span class="hljs-keyword">except</span> KeyboardInterrupt:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[<span class="hljs-subst">{server_name}</span>] Shutting down server"</span>)
        server.close()

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    start_server(<span class="hljs-number">9000</span>)
</code></pre>
<p>模拟EKS中的服务部署代码: test-server-1.yaml</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">test-server-1</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">game</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">test-server-1</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">test-server-1</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">test-server-1</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">tcp-server</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">python:3.9-slim</span>
        <span class="hljs-attr">command:</span> [<span class="hljs-string">"python"</span>]
        <span class="hljs-attr">args:</span> [<span class="hljs-string">"-u"</span>, <span class="hljs-string">"/app/tcp-echo-server.py"</span>, <span class="hljs-string">"test-server-1"</span>]
        <span class="hljs-attr">ports:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">9000</span>
        <span class="hljs-attr">volumeMounts:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">script-volume</span>
          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/app</span>
      <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">script-volume</span>
        <span class="hljs-attr">configMap:</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">tcp-echo-server</span>
          <span class="hljs-attr">defaultMode:</span> <span class="hljs-number">0777</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">gs-1</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">game</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">test-server-1</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">test-server-1</span>
  <span class="hljs-attr">ports:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">9000</span>
    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">9000</span>
    <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span> 
<span class="hljs-string">test-server-2.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">test-server-2</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">game</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">test-server-2</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">test-server-2</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">test-server-2</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">tcp-server</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">python:3.9-slim</span>
        <span class="hljs-attr">command:</span> [<span class="hljs-string">"python"</span>]
        <span class="hljs-attr">args:</span> [<span class="hljs-string">"-u"</span>, <span class="hljs-string">"/app/tcp-echo-server.py"</span>, <span class="hljs-string">"test-server-2"</span>]
        <span class="hljs-attr">ports:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">9000</span>
        <span class="hljs-attr">volumeMounts:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">script-volume</span>
          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/app</span>
      <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">script-volume</span>
        <span class="hljs-attr">configMap:</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">tcp-echo-server</span>
          <span class="hljs-attr">defaultMode:</span> <span class="hljs-number">0777</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">gs-2</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">game</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">test-server-2</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">test-server-2</span>
  <span class="hljs-attr">ports:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">9000</span>
    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">9000</span>
    <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span>
</code></pre>
<p>部署服务</p>
<pre><code class="hljs language-vbscript" lang="vbscript">kubectl create namespace game
kubectl create configmap tcp-echo-<span class="hljs-built_in">server</span> --from-file=tcp-echo-<span class="hljs-built_in">server</span>.py --namespace game
kubectl apply -f test-<span class="hljs-built_in">server</span><span class="hljs-number">-1.</span>yaml
kubectl apply -f test-<span class="hljs-built_in">server</span><span class="hljs-number">-2.</span>yaml
</code></pre>
<h3 data-id="heading-9">配置证书</h3>
<p>当使用TLS的SNI功能时,每个你想要使用SNI的域名或主机名都需要一个有效的证书。这是因为SNI允许从同一个IP地址和端口提供多个主机名服务,而证书用于验证服务器的身份并与客户端建立加密连接。使用OpenSSL为2个Game Server服务生成证书文件和密钥文件。</p>
<p>1、生成证书</p>
<pre><code class="hljs language-csharp" lang="csharp">openssl req -<span class="hljs-keyword">new</span> -newkey rsa:<span class="hljs-number">2048</span> -days <span class="hljs-number">365</span> -nodes -x509 -keyout gs<span class="hljs-number">-1.</span>key -<span class="hljs-keyword">out</span> gs<span class="hljs-number">-1.</span>crt -subj <span class="hljs-string">"/CN=gs-1.com"</span>
openssl req -<span class="hljs-keyword">new</span> -newkey rsa:<span class="hljs-number">2048</span> -days <span class="hljs-number">365</span> -nodes -x509 -keyout gs<span class="hljs-number">-2.</span>key -<span class="hljs-keyword">out</span> gs<span class="hljs-number">-2.</span>crt -subj <span class="hljs-string">"/CN=gs-2.com"</span>
</code></pre>
<p>2、上传证书到apisix</p>
<pre><code class="hljs language-javascript" lang="javascript">kubectl port-forward -n ingress-apisix svc/apisix-admin <span class="hljs-number">9180</span>:<span class="hljs-number">9180</span> &amp;
sleep <span class="hljs-number">3</span>
curl  -X <span class="hljs-variable constant_">POST</span> <span class="hljs-attr">http</span>:<span class="hljs-comment">//127.0.0.1:9180/apisix/admin/ssls -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -d '</span>
{
    <span class="hljs-string">"cert"</span>: <span class="hljs-string">"'"</span>$(cat gs-<span class="hljs-number">1.</span>crt)<span class="hljs-string">"'"</span>,
    <span class="hljs-string">"key"</span>: <span class="hljs-string">"'"</span>$(cat gs-<span class="hljs-number">1.</span>key)<span class="hljs-string">"'"</span>,
    <span class="hljs-string">"snis"</span>: [<span class="hljs-string">"gs-1.com"</span>]
}<span class="hljs-string">'
# Create SSL certificate for gs-2.com
curl -X POST http://127.0.0.1:9180/apisix/admin/ssls -H '</span>X-<span class="hljs-variable constant_">API</span>-<span class="hljs-attr">KEY</span>: edd1c9f034335f136f87ad84b625c8f1<span class="hljs-string">'  -d '</span>
{
    <span class="hljs-string">"cert"</span>: <span class="hljs-string">"'"</span>$(cat gs-<span class="hljs-number">2.</span>crt)<span class="hljs-string">"'"</span>,
    <span class="hljs-string">"key"</span>: <span class="hljs-string">"'"</span>$(cat gs-<span class="hljs-number">2.</span>key)<span class="hljs-string">"'"</span>,
    <span class="hljs-string">"snis"</span>: [<span class="hljs-string">"gs-2.com"</span>]
}<span class="hljs-string">'
kill %1
</span></code></pre>
<p>3、验证证书上传</p>
<pre><code class="hljs language-ruby" lang="ruby">curl -X <span class="hljs-variable constant_">GET</span> <span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/127.0.0.1:9180/apisix</span><span class="hljs-regexp">/admin/ssls</span> -H <span class="hljs-string">'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1'</span> 

</code></pre>
<h3 data-id="heading-10">配置路由</h3>
<p>下面我们基于已经配置好的证书来配置相关的路由信息, 也就是通常我们在平台服配置好证书后,可以调用相关API来配置路由,命令信息如下:</p>
<pre><code class="hljs language-vbnet" lang="vbnet">kubectl port-forward -n ingress-apisix svc/apisix-admin <span class="hljs-number">9180</span>:<span class="hljs-number">9180</span> &amp;
sleep <span class="hljs-number">3</span>
curl -i -X POST http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">9180</span>/apisix/admin/stream_routes -H <span class="hljs-comment">'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -d '{</span>
  <span class="hljs-string">"upstream"</span>: {
    <span class="hljs-string">"nodes"</span>: {
      <span class="hljs-string">"gs-1.game.svc.cluster.local:9000"</span>: <span class="hljs-number">1</span>
    },
    <span class="hljs-string">"type"</span>: <span class="hljs-string">"roundrobin"</span>
  },
  <span class="hljs-string">"sni"</span>: <span class="hljs-string">"gs-1.com"</span>
}<span class="hljs-comment">'</span>

curl -i -X POST http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">9180</span>/apisix/admin/stream_routes -H <span class="hljs-comment">'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -d '{</span>
  <span class="hljs-string">"upstream"</span>: {
    <span class="hljs-string">"nodes"</span>: {
      <span class="hljs-string">"gs-2.game.svc.cluster.local:9000"</span>: <span class="hljs-number">1</span>
    },
    <span class="hljs-string">"type"</span>: <span class="hljs-string">"roundrobin"</span>
  },
  <span class="hljs-string">"sni"</span>: <span class="hljs-string">"gs-2.com"</span>
}<span class="hljs-comment">'</span>
</code></pre>
<h3 data-id="heading-11">测试基于SNI的访问</h3>
<p>首先获取对应APIsix服务的ALB地址</p>
<pre><code class="hljs language-arduino" lang="arduino">&gt; kubectl get svc -n ingress-apisix apisix-gateway
NAME             TYPE           CLUSTER-IP      <span class="hljs-literal">EXTERNAL</span>-<span class="hljs-function">IP                                                                     <span class="hljs-title">PORT</span><span class="hljs-params">(S)</span>                       AGE
apisix-gateway   LoadBalancer   10.100.xxxx.12   k8s-ingressa-apisixga-xxxxxxx-xxx.elb.us-east-1.amazonaws.com   80:<span class="hljs-number">30496</span>/TCP,<span class="hljs-number">8888</span>:<span class="hljs-number">30694</span>/TCP   <span class="hljs-number">3</span>d2h

</span></code></pre>
<p>通过上面返回获取的ALB的地址</p>
<pre><code class="hljs language-arduino" lang="arduino">openssl s_client -connect k8s-ingressa-apisixga-xxxxx.xxxx.elb.ap-northeast<span class="hljs-number">-1.</span>amazonaws.com:<span class="hljs-number">8888</span> \
-servername gs<span class="hljs-number">-1.</span>com -quiet
openssl s_client -connect k8s-ingressa-apisixga-xxxx.xxxx.elb.ap-northeast<span class="hljs-number">-1.</span>amazonaws.com:<span class="hljs-number">8888</span> \
-servername gs<span class="hljs-number">-2.</span>com -quiet
</code></pre>
<p>至此可以看到通过不同的SNI我就可以访问到不同的游戏服了,也就解决了使用同一个NLB+APIsix的访问不同的游戏服了.</p>
<h3 data-id="heading-12">APISix dashboard访问 (Optional)</h3>
<p>我们也可以通过Dashboard来访问当前的APIsix系统,查看相关的配置数据. 不过这里需要我们确认一下ALB的certificate ARN 是不是正确.</p>
<p><code>kubectl get ingress -n ingress-apisix</code></p>
<h2 data-id="heading-13">APISix 部署亚马逊云科技最佳实践</h2>
<p>在生产环境中部署 Apache APISIX 时的关键最佳实践，帮助提升稳定性、性能与可维护性。</p>
<h3 data-id="heading-14">核心架构与组件分离</h3>
<h4 data-id="heading-15">为了保证系统可扩展与高可用，推荐将 APISIX 各核心组件解耦部署：</h4>
<ul>
<li>控制平面（etcd）：使用单独部署的 etcd 集群存储路由与插件配置，建议在部署APISix的时候直接指向预先部署好的etcd，至少部署 3 节点，开启数据持久化与快照备份，防止单点故障。</li>
<li>数据平面（APISIX 节点）：外部请求由多个 APISIX 实例处理，按需水平扩容。每个实例仅负责流量转发与插件执行，配置从 etcd 动态拉取。</li>
<li>运维监控（Prometheus &amp; Grafana）：部署专用的监控系统，采集 APISIX 及 etcd 的指标与日志，实时告警与可视化。</li>
</ul>
<h4 data-id="heading-16">部署模式与扩展策略</h4>
<ul>
<li>无状态部署
APISIX 实例本身应保持无状态，所有动态配置均存储在 etcd。容器化或虚拟机化均可，借助 Kubernetes 等平台实现自动伸缩与滚动升级。</li>
<li>水平扩展
根据 QPS 与响应延迟指标，动态扩缩容。建议在 Kubernetes 中配置 HPA（Horizontal Pod Autoscaler），结合自定义指标（如 CPU、内存或请求速率）自动调整实例数。</li>
<li>灰度发布与回滚
配合 Kubernetes Deployment 或其它发布工具，利用 canary 发布策略逐步下发新版本。在出现问题时，可快速回滚至稳定版本，且不中断大部分流量。</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">lifecycle:
  preStop:
    <span class="hljs-built_in">exec</span>:
      <span class="hljs-built_in">command</span>: [<span class="hljs-string">"sh"</span>, <span class="hljs-string">"-c"</span>, <span class="hljs-string">"sleep 15 &amp;&amp; apisix quit"</span>]
</code></pre>
<h3 data-id="heading-17">网络与安全</h3>
<ul>
<li>高性能网络
采用 L4 负载均衡（如 Nginx Stream、LVS）将流量分发至 APISIX，避免在 L7 层引入过多额外延迟。</li>
<li>TLS 终端
如需 HTTPS 支持，推荐在边缘层（L4）终端 TLS，再以 HTTP 通信至 APISIX；或直接在 APISIX 上使用 ssl 插件终端 TLS，并结合 Cert-Manager 自动续签证书。</li>
<li>访问控制与认证
启用 IP 黑白名单、ACL 插件，并根据业务需求接入 JWT、OAuth2 等认证插件，确保后端服务安全。</li>
</ul>
<h3 data-id="heading-18">配置管理与版本控制</h3>
<ul>
<li>基础配置与热更新
把路由、上游服务、插件配置以 YAML/JSON 格式存储于代码仓库，结合 CI/CD 流水线自动同步至 etcd，实现配置即代码（Configuration as Code）。</li>
<li>版本管理
每次配置变更都需打 tag 并在流水线中校验（lint、单元测试、灰度发布），确保变更可追溯、可回滚。</li>
<li>选择稳定版本,并及时跟进社区的更新.</li>
<li>升级版本时需要进行完整的回归测试,保证新版本的兼容性问题.</li>
</ul>
<h3 data-id="heading-19">性能优化与插件治理</h3>
<ul>
<li>实例选择
优先选择Graviton类型主机，经过多轮测试发现Graviton的机型相对于x86机型可以提供至少2两倍的性能提升，具体请参考社区 Benchmark <a href="https://link.juejin.cn?target=https%3A%2F%2Fapisix.apache.org%2Fblog%2F2022%2F08%2F12%2Farm-performance-google-aws-azure-with-apisix%2F" target="_blank" title="https://apisix.apache.org/blog/2022/08/12/arm-performance-google-aws-azure-with-apisix/" ref="nofollow noopener noreferrer">链接</a>：.</li>
<li>插件开关粒度</li>
</ul>
<p>仅在需要的路由上启用插件，避免全局加载过多插件导致请求路径冗余执行。</p>
<ul>
<li>缓存与限流
利用 proxy-cache 插件对静态或可缓存响应进行本地缓存，减轻后端压力；结合 limit-req、limit-count 插件防止流量突发与恶意攻击。</li>
<li>日志与追踪
启用 skywalking、zipkin 或 opentelemetry 插件，将请求链路与指标上报至分布式追踪系统，快速定位性能瓶颈。</li>
</ul>
<h3 data-id="heading-20">监控告警与健康检查</h3>
<ul>
<li>健康探针
在 Kubernetes 中配置 LivenessProbe 与 ReadinessProbe，APISIX 节点异常时可自动剔除。</li>
<li>关键指标
重点监控请求速率、响应延迟、错误率，以及 etcd 的延迟与 leader 选举状态。根据阈值配置告警规则，保证故障可被及时发现与响应</li>
<li>在实际生产中，如果service数量比较多以及并发大的情况下，需要对netfilter.nf_conntrack_max进行调整。建议结合prometheus和grafana进行告警，及时发现问题并优化相关参数。我们也可以通过采用类似C7gn的机型来提升网络吞吐。</li>
</ul>
<h3 data-id="heading-21">灾备与高可用设计</h3>
<ul>
<li>跨可用区部署
将 etcd 和 APISIX 实例分布在多个可用区或机房，保证单区故障时仍有服务可用。</li>
<li>定期备份
对 etcd 数据进行周期性全量与增量备份，并在异地存储；同时验证备份可用性与恢复流程。</li>
</ul>
<p>通过上述最佳实践，可以构建一套 高可用、可扩展、易运维 的 APISIX 服务部署体系，满足业务在复杂流量下的稳定运行与快速迭代需求。</p>
<h2 data-id="heading-22">总结</h2>
<p>借助以上方案通过将所有玩家和运维流量先汇聚到单个NLB，再由部署在 EKS 集群内的 Apache APISIX 按 TLS SNI 把请求精准分发到各游戏服，从而用最少的负载均衡实例实现统一路由、动态服务发现和全链路加密，不仅显著降低 NLB 成本和配置复杂度，还能在服务器扩缩容时保持流量无感知切换，成为高并发游戏场景下经济、高效且易维护的网关架构，同时，借助Graviton，APISix能够实现极高的性价比。</p>
<p><strong>参考内容</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fapi7.ai%2Fblog%2Fapi7-latency" target="_blank" title="https://api7.ai/blog/api7-latency" ref="nofollow noopener noreferrer">api7.ai/blog/api7-l…</a>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fapisix.apache.org%2Fblog%2F2022%2F08%2F12%2Farm-performance-google-aws-azure-with-apisix%2F" target="_blank" title="https://apisix.apache.org/blog/2022/08/12/arm-performance-google-aws-azure-with-apisix/" ref="nofollow noopener noreferrer">apisix.apache.org/blog/2022/0…</a></p>
<p><strong>本篇作者</strong>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0dbcc637dd954715884de9dbe304a8bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764034638&amp;x-signature=77S98A2q6FfnfTPi%2FFXqUcqOsKs%3D" alt="本篇作者.webp" loading="lazy"/></p>
<blockquote>
<p>本期最新实验为《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.amazoncloud.cn%2Fexperience%2Fcloudlab%3Fid%3D668dfdebee6ab158880f2852%26visitfrom%3D3P_Juejintail_0418%26sc_medium%3Downed%26sc_campaign%3Dcloudlab%26sc_channel%3D3P_Juejintail_0418" target="_blank" title="https://dev.amazoncloud.cn/experience/cloudlab?id=668dfdebee6ab158880f2852&amp;visitfrom=3P_Juejintail_0418&amp;sc_medium=owned&amp;sc_campaign=cloudlab&amp;sc_channel=3P_Juejintail_0418" ref="nofollow noopener noreferrer">创新基石 —— 基于 Graviton 构建差异化生成式AI向量数据库</a>》</p>
<p>✨ 在本次实验中，你可以在基于 Graviton 的 EC2 实例上轻松启动 Milvus 向量数据库，加速您的生成式 AI 应用。基于 Graviton 的 EC2 实例为您提供极佳性价比的向量数据库部署选项。</p>
<p>📱 即刻在云上探索实验室，开启构建开发者探索之旅吧！</p>
<p>⏩[<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.amazoncloud.cn%2Fexperience%2Fcloudlab%3Fid%3D668dfdebee6ab158880f2852%26visitfrom%3D3P_Juejintail_0418%26sc_medium%3Downed%26sc_campaign%3Dcloudlab%26sc_channel%3D3P_Juejintail_0418" target="_blank" title="https://dev.amazoncloud.cn/experience/cloudlab?id=668dfdebee6ab158880f2852&amp;visitfrom=3P_Juejintail_0418&amp;sc_medium=owned&amp;sc_campaign=cloudlab&amp;sc_channel=3P_Juejintail_0418" ref="nofollow noopener noreferrer">点击进入实验</a>] 构建无限, 探索启程！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于UniappX开发电销APP，实现通话录音上传、通时通次]]></title>    <link>https://juejin.cn/post/7573528564025802798</link>    <guid>https://juejin.cn/post/7573528564025802798</guid>    <pubDate>2025-11-17T10:41:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573528564025802798" data-draft-id="7573508048141385737" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于UniappX开发电销APP，实现通话录音上传、通时通次"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-17T10:41:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱心发电丶"/> <meta itemprop="url" content="https://juejin.cn/user/79577698543709"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于UniappX开发电销APP，实现通话录音上传、通时通次
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/79577698543709/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱心发电丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T10:41:45.000Z" title="Mon Nov 17 2025 10:41:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnicen.cn%2F8524.html" target="_blank" title="https://nicen.cn/8524.html" ref="nofollow noopener noreferrer">nicen.cn/8524.html</a></p>
<p>之前通过Uniapp+Html5plus实现过实现通话录音上传的功能，一直有一个痛点：录音文件很多的时候通过htmlplus来获取录音文件会很卡。</p>
<p>刚好看到新出的UniappX可以直接把类似ts的uts代码编译成原生代码，而且整个开发流程都可以在Hbuilder内完成，于是乎来了兴趣，试上一试！</p>
<h2 data-id="heading-0">开发思路</h2>
<p>既然可以通过uts来实现原生开发，但是又想保持Web来进行APP的前端开发，那就直接用老一套的混合开发的方式：通过JS调用写好的原生方法。</p>
<p>相关代码已开源，Github：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffriend-nicen%2Funicall" target="_blank" title="https://github.com/friend-nicen/unicall" ref="nofollow noopener noreferrer">github.com/friend-nice…</a></p>
<h3 data-id="heading-1">1.通过uts实现读取录音文件</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/* 将功能封装为类：在构造函数中设置 audioPath */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Scanner</span> {

    ....

<span class="hljs-comment">/* 读取目录下最新的录音文件 */</span>
<span class="hljs-title function_">getLatestAudio</span>(option : <span class="hljs-title class_">QueryLatest</span>) : <span class="hljs-title class_">LatestAudioResult</span> {

    <span class="hljs-comment">/*  定义录音文件路径 */</span>
    <span class="hljs-keyword">if</span> (option.<span class="hljs-property">audioPath</span> != <span class="hljs-literal">null</span>) {
        option.<span class="hljs-property">audioPath</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">sdRoot</span> + option.<span class="hljs-property">audioPath</span>;
        <span class="hljs-keyword">const</span> initDir = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(option.<span class="hljs-property">audioPath</span> <span class="hljs-keyword">as</span> string);
        <span class="hljs-keyword">if</span> (!initDir.<span class="hljs-title function_">exists</span>() || !!initDir.<span class="hljs-title function_">isDirectory</span>()) {
            option.<span class="hljs-property">audioPath</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getDevicePath</span>();
        }
    } <span class="hljs-keyword">else</span> {
        option.<span class="hljs-property">audioPath</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getDevicePath</span>();
    }

    <span class="hljs-comment">/* 目录对象 */</span>
    <span class="hljs-keyword">const</span> dir = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(option.<span class="hljs-property">audioPath</span> <span class="hljs-keyword">as</span> string);

    <span class="hljs-keyword">if</span> (!dir.<span class="hljs-title function_">exists</span>() || !dir.<span class="hljs-title function_">isDirectory</span>()) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UniError</span>(<span class="hljs-string">'scanner'</span>, <span class="hljs-number">0</span>, <span class="hljs-string">'录音文件目录不存在'</span>);
    }

    <span class="hljs-keyword">const</span> files = dir.<span class="hljs-title function_">listFiles</span>();
    <span class="hljs-keyword">if</span> (files == <span class="hljs-literal">null</span> || files.<span class="hljs-property">size</span> == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UniError</span>(<span class="hljs-string">'scanner'</span>, <span class="hljs-number">0</span>, <span class="hljs-string">'本次通话没有产生录音文件'</span>);
    }

    <span class="hljs-keyword">let</span> latest : <span class="hljs-title class_">File</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">const</span> countInt : <span class="hljs-title class_">Int</span> = files.<span class="hljs-property">size</span>;
    <span class="hljs-keyword">const</span> count : number = countInt;
    option.<span class="hljs-property">latestTime</span> = option.<span class="hljs-property">latestTime</span> * <span class="hljs-number">1000</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i : <span class="hljs-title class_">Int</span> = <span class="hljs-number">0</span>; i &lt; countInt; i = i + <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">const</span> f = files[i];
        <span class="hljs-keyword">if</span> (f != <span class="hljs-literal">null</span> &amp;&amp; f.<span class="hljs-title function_">isFile</span>()) {
            <span class="hljs-keyword">const</span> lm = f.<span class="hljs-title function_">lastModified</span>();
            <span class="hljs-keyword">if</span> (lm &gt;= option.<span class="hljs-property">latestTime</span>) {
                latest = f;
                option.<span class="hljs-property">latestTime</span> = lm;
            }
        }
    }

    <span class="hljs-keyword">if</span> (latest != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">file</span>: latest.<span class="hljs-title function_">getAbsolutePath</span>(), <span class="hljs-attr">count</span>: count };
    }

    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UniError</span>(<span class="hljs-string">'scanner'</span>, <span class="hljs-number">0</span>, <span class="hljs-string">'本次通话没有产生录音文件'</span>);
}

	....
}
</code></pre>
<p>以下省略了若干代码，仅展示核心代码，完整代码请查看上方开源项目</p>
<h3 data-id="heading-2">2.通过webview对象向js提供直接调用的方法</h3>
<p>通过监听webview组件的message事件，来获取js发送过来的消息，然后进行对应的处理，最后通过webview对象的evalJs方法，将结果回调给前端。相关代码如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/* 消息监听 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">onPostMessage</span> = (<span class="hljs-params">e</span>) =&gt; {

  <span class="hljs-comment">/* 数据 */</span>
  <span class="hljs-keyword">const</span> _list = e.<span class="hljs-property">detail</span>.<span class="hljs-property">data</span>;
  <span class="hljs-keyword">const</span> _action = _list[<span class="hljs-number">0</span>].<span class="hljs-property">action</span>;
  <span class="hljs-keyword">const</span> _data = _list[<span class="hljs-number">0</span>].<span class="hljs-property">data</span>;


  <span class="hljs-comment">/* 初始化 */</span>
  <span class="hljs-keyword">if</span> (!_wv) {

    <span class="hljs-comment">/* 获取webview对象 */</span>
    <span class="hljs-keyword">const</span> _wvs = plus.<span class="hljs-property">webview</span>.<span class="hljs-title function_">getDisplayWebview</span>().<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">wv</span> =&gt;</span> {
      <span class="hljs-keyword">return</span> wv.<span class="hljs-title function_">getURL</span>().<span class="hljs-title function_">indexOf</span>(host) &gt; -<span class="hljs-number">1</span>;
    });

    <span class="hljs-comment">/* 弹出异常 */</span>
    <span class="hljs-keyword">if</span> (!_wvs.<span class="hljs-property">length</span>) {
      load.<span class="hljs-title function_">toast</span>(<span class="hljs-string">"服务异常"</span>);
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">/* webview对象 */</span>
    _wv = _wvs[<span class="hljs-number">0</span>];
    _wv.<span class="hljs-property">onCall</span> = <span class="hljs-function">(<span class="hljs-params">action, success, payload</span>) =&gt;</span> {
      _wv.evalJS(<span class="hljs-string">'window.__onCall(`'</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
        action,
        success,
        payload
      }) + <span class="hljs-string">'`)'</span>);
    }
  }

  <span class="hljs-comment">/* 判断对象是否有这个属性 */</span>
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">if</span> (!!scanner[_action]) {
      _wv.<span class="hljs-title function_">onCall</span>(_action, <span class="hljs-literal">true</span>, scanner[_action](_data));
    }
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">const</span> match = e.<span class="hljs-property">message</span>.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/errMsg='([^']+)'/</span>);
    _wv.<span class="hljs-title function_">onCall</span>(_action, <span class="hljs-literal">false</span>, match &amp;&amp; match[<span class="hljs-number">1</span>] ? match[<span class="hljs-number">1</span>] : <span class="hljs-string">'系统异常'</span>);
  }


}
</code></pre>
<h3 data-id="heading-3">3.前端JS封装和APP通信的方法</h3>
<p>通过下方封装的模块，可以直接通过await同步调用APP对应的方法。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * NativeBridge.es6.js
 * ES Module，action 级回调，默认 15 s 超时
 * import { invoke } from './NativeBridge.es6.js';
 * await invoke({ action:'getDeviceId', timeout:10_000 });
 */</span>
<span class="hljs-keyword">const</span> pool = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-literal">null</span>);   <span class="hljs-comment">// action -&gt; {resolve, reject, timer}</span>

<span class="hljs-comment">/**
 * App 回传结果的唯一全局钩子
 * 调用方式（Android）：
 * webView.evaluateJavascript('window.__onCall('{"action":"getDeviceId","success":true,"payload":"fake-123"}')', null);
 * payload 可省略。
 */</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-property">__onCall</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">json</span>) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> {action, success, payload} = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(json);
        <span class="hljs-comment">/* 格式非法，直接丢弃 */</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> action !== <span class="hljs-string">'string'</span>) <span class="hljs-keyword">return</span>;

        <span class="hljs-keyword">const</span> item = pool[action];
        <span class="hljs-comment">/* 已超时或重复回调 */</span>
        <span class="hljs-keyword">if</span> (!item) <span class="hljs-keyword">return</span>;

        <span class="hljs-keyword">const</span> {resolve, reject, timer} = item;
        <span class="hljs-built_in">clearTimeout</span>(timer);
        <span class="hljs-keyword">delete</span> pool[action];

        success ? <span class="hljs-title function_">resolve</span>(payload) : <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(payload ?? <span class="hljs-string">'native error'</span>));
    } <span class="hljs-keyword">catch</span> {
        <span class="hljs-comment">/* 非合法 JSON，直接忽略 */</span>
    }
};

<span class="hljs-comment">/**
 * 调用 App 内部方法
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">opt</span>
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} opt.action   - 必填，方法名
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">any</span>}    [opt.params] - 选填，参数，默认空对象
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} [opt.timeout=15000] - 选填，超时毫秒
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Promise&lt;any&gt;</span>}
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">invoke</span>(<span class="hljs-params">opt = {}</span>) {

    <span class="hljs-comment">/* 默认配置 */</span>
    <span class="hljs-keyword">const</span> {action, data = {}, timeout = <span class="hljs-number">15000</span>} = opt;

    <span class="hljs-comment">/* 参数校验 */</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> action !== <span class="hljs-string">'string'</span> || !action)
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'action is required'</span>));

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {

        <span class="hljs-comment">/* 如果已存在同 action 的未完成调用，先清掉 */</span>
        <span class="hljs-keyword">if</span> (pool[action]) {
            <span class="hljs-built_in">clearTimeout</span>(pool[action].<span class="hljs-property">timer</span>);
            pool[action].<span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'covered by new call'</span>));
        }

        <span class="hljs-comment">/* 超时器，防止调用超时 */</span>
        <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-keyword">delete</span> pool[action];
            <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`invoke <span class="hljs-subst">${action}</span> timeout`</span>));
        }, timeout);

        <span class="hljs-comment">/* 回调 */</span>
        pool[action] = {resolve, reject, timer};

        <span class="hljs-comment">/* 发送消息 */</span>
        uni.<span class="hljs-title function_">postMessage</span>({
            <span class="hljs-attr">data</span>: {
                action,
                <span class="hljs-attr">data</span>: data
            }
        });

    });
}
</code></pre>
<h3 data-id="heading-4">4.相关扩展</h3>
<p>上方展示了一个通过UniappX简单实现的混合开发的框架，在此基础上可以实现更多的原生方法来扩展功能，同时兼顾性能和Web开发的便捷。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ThreadLocal底层实现原理深度解析]]></title>    <link>https://juejin.cn/post/7573506713866600499</link>    <guid>https://juejin.cn/post/7573506713866600499</guid>    <pubDate>2025-11-17T10:53:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573506713866600499" data-draft-id="7573508048141418505" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ThreadLocal底层实现原理深度解析"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-11-17T10:53:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户683335666080"/> <meta itemprop="url" content="https://juejin.cn/user/4418313847836760"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ThreadLocal底层实现原理深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4418313847836760/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户683335666080
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T10:53:40.000Z" title="Mon Nov 17 2025 10:53:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、核心问题：为什么MDC.put会为线程创建ThreadLocal？</h2>
<h3 data-id="heading-1">1.1 问题的本质</h3>
<p>当我们调用 <code>MDC.put("tid", "abc123")</code> 时，底层发生了什么？</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 我们看到的代码</span>
MDC.put(<span class="hljs-string">"tid"</span>, <span class="hljs-string">"abc123"</span>);

<span class="hljs-comment">// 底层实际执行</span>
ThreadLocal&lt;Map&lt;String, String&gt;&gt; contextMap = ...;
contextMap.set(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;());  <span class="hljs-comment">// 为当前线程创建ThreadLocal</span>
</code></pre>
<p><strong>关键点</strong>：ThreadLocal本身不存储数据，数据存储在<strong>Thread对象</strong>中！</p>
<h2 data-id="heading-2">二、ThreadLocal的底层数据结构</h2>
<h3 data-id="heading-3">2.1 Thread对象内部结构</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Thread类的简化结构（JDK源码）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Thread</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> {
    <span class="hljs-comment">// 每个Thread对象都有一个ThreadLocalMap</span>
    ThreadLocal.<span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">threadLocals</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    
    <span class="hljs-comment">// 用于InheritableThreadLocal（可继承的ThreadLocal）</span>
    ThreadLocal.<span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">inheritableThreadLocals</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<p><strong>关键理解</strong>：</p>
<ul>
<li>ThreadLocalMap 不是存储在 ThreadLocal 中，而是存储在 <strong>Thread 对象</strong>中</li>
<li>每个 Thread 对象都有自己的 ThreadLocalMap</li>
<li>ThreadLocal 只是一个"钥匙"，用来访问 Thread 对象中的 Map</li>
</ul>
<h3 data-id="heading-4">2.2 ThreadLocalMap的内部结构</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ThreadLocalMap的简化实现</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadLocalMap</span> {
    <span class="hljs-comment">// 内部使用Entry数组存储，类似HashMap</span>
    <span class="hljs-keyword">private</span> Entry[] table;
    
    <span class="hljs-comment">// Entry是弱引用，key是ThreadLocal实例，value是实际存储的值</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Entry</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WeakReference</span>&lt;ThreadLocal&lt;?&gt;&gt; {
        Object value;  <span class="hljs-comment">// 实际存储的值</span>
        
        Entry(ThreadLocal&lt;?&gt; k, Object v) {
            <span class="hljs-built_in">super</span>(k);  <span class="hljs-comment">// ThreadLocal作为key，使用弱引用</span>
            value = v;  <span class="hljs-comment">// 实际值</span>
        }
    }
}
</code></pre>
<p><strong>内存结构图</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">Thread对象 (Thread-1)
  └─ threadLocals: ThreadLocalMap
      └─ table: Entry<span class="hljs-section">[]</span>
          ├─ Entry<span class="hljs-section">[0]</span>: <span class="hljs-attr">key</span>=MDC的ThreadLocal实例(弱引用), value=Map{<span class="hljs-string">"tid"</span>: <span class="hljs-string">"abc123"</span>}
          ├─ Entry<span class="hljs-section">[1]</span>: <span class="hljs-attr">key</span>=其他ThreadLocal实例(弱引用), value=其他值
          └─ Entry<span class="hljs-section">[2]</span>: null
</code></pre>
<h2 data-id="heading-5">三、MDC.put的完整执行过程</h2>
<h3 data-id="heading-6">3.1 代码追踪</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ========== 第1步：调用MDC.put ==========</span>
MDC.put(<span class="hljs-string">"tid"</span>, <span class="hljs-string">"abc123"</span>);

<span class="hljs-comment">// ========== 第2步：MDC内部实现 ==========</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MDC</span> {
    <span class="hljs-comment">// MDC内部有一个静态的ThreadLocal实例</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ThreadLocal&lt;Map&lt;String, String&gt;&gt; contextMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(String key, String value)</span> {
        <span class="hljs-comment">// 2.1 获取当前线程的Map</span>
        Map&lt;String, String&gt; map = contextMap.get();
        <span class="hljs-comment">// 这里会触发ThreadLocal.get()方法</span>
        
        <span class="hljs-comment">// 2.2 如果Map不存在，创建新Map</span>
        <span class="hljs-keyword">if</span> (map == <span class="hljs-literal">null</span>) {
            map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
            contextMap.set(map);  <span class="hljs-comment">// 这里会触发ThreadLocal.set()方法</span>
        }
        
        <span class="hljs-comment">// 2.3 存储key-value</span>
        map.put(key, value);
    }
}
</code></pre>
<h3 data-id="heading-7">3.2 ThreadLocal.get()的底层实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ThreadLocal.get()的完整实现（JDK源码简化版）</span>
<span class="hljs-keyword">public</span> T <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 1. 获取当前线程对象</span>
    <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> Thread.currentThread();
    
    <span class="hljs-comment">// 2. 获取线程对象中的ThreadLocalMap</span>
    <span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> getMap(t);
    <span class="hljs-comment">// getMap(t) 实际就是: return t.threadLocals;</span>
    
    <span class="hljs-comment">// 3. 如果Map存在，从Map中获取值</span>
    <span class="hljs-keyword">if</span> (map != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 3.1 以当前ThreadLocal实例为key，查找Entry</span>
        ThreadLocalMap.<span class="hljs-type">Entry</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> map.getEntry(<span class="hljs-built_in">this</span>);
        <span class="hljs-comment">// this 是 MDC的ThreadLocal实例</span>
        
        <span class="hljs-comment">// 3.2 如果找到Entry，返回value</span>
        <span class="hljs-keyword">if</span> (e != <span class="hljs-literal">null</span>) {
            <span class="hljs-type">T</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> (T)e.value;
            <span class="hljs-keyword">return</span> result;
        }
    }
    
    <span class="hljs-comment">// 4. 如果Map不存在或找不到Entry，返回null</span>
    <span class="hljs-keyword">return</span> setInitialValue();
}
</code></pre>
<p><strong>执行流程图</strong>：</p>
<pre><code class="hljs language-csharp" lang="csharp">MDC.put(<span class="hljs-string">"tid"</span>, <span class="hljs-string">"abc123"</span>)
  ↓
contextMap.<span class="hljs-keyword">get</span>()
  ↓
Thread.currentThread()  → 获取当前线程对象
  ↓
t.threadLocals  → 获取线程的ThreadLocalMap
  ↓
如果threadLocals == <span class="hljs-literal">null</span>
  ↓
返回<span class="hljs-literal">null</span>（第一次调用时）
  ↓
contextMap.<span class="hljs-keyword">set</span>(<span class="hljs-keyword">new</span> HashMap&lt;&gt;())
</code></pre>
<h3 data-id="heading-8">3.3 ThreadLocal.set()的底层实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ThreadLocal.set()的完整实现（JDK源码简化版）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(T value)</span> {
    <span class="hljs-comment">// 1. 获取当前线程对象</span>
    <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> Thread.currentThread();
    
    <span class="hljs-comment">// 2. 获取线程对象中的ThreadLocalMap</span>
    <span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> getMap(t);
    <span class="hljs-comment">// getMap(t) 实际就是: return t.threadLocals;</span>
    
    <span class="hljs-comment">// 3. 如果Map存在，直接设置值</span>
    <span class="hljs-keyword">if</span> (map != <span class="hljs-literal">null</span>) {
        map.set(<span class="hljs-built_in">this</span>, value);
        <span class="hljs-comment">// this 是 MDC的ThreadLocal实例</span>
        <span class="hljs-comment">// value 是 new HashMap&lt;&gt;()</span>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 4. 如果Map不存在，创建新的ThreadLocalMap</span>
        createMap(t, value);
        <span class="hljs-comment">// createMap(t, value) 实际就是:</span>
        <span class="hljs-comment">//     t.threadLocals = new ThreadLocalMap(this, value);</span>
    }
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li><code>createMap(t, value)</code> 会创建新的 ThreadLocalMap 并赋值给 <code>t.threadLocals</code></li>
<li>这就是"为线程创建ThreadLocal"的本质：<strong>在Thread对象中创建ThreadLocalMap</strong></li>
</ul>
<h3 data-id="heading-9">3.4 createMap的详细过程</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ThreadLocal.createMap()的实现</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">createMap</span><span class="hljs-params">(Thread t, T firstValue)</span> {
    <span class="hljs-comment">// 创建新的ThreadLocalMap，并赋值给线程的threadLocals字段</span>
    t.threadLocals = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocalMap</span>(<span class="hljs-built_in">this</span>, firstValue);
    <span class="hljs-comment">// this 是 MDC的ThreadLocal实例</span>
    <span class="hljs-comment">// firstValue 是 new HashMap&lt;&gt;()</span>
}

<span class="hljs-comment">// ThreadLocalMap的构造函数</span>
ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) {
    <span class="hljs-comment">// 1. 创建Entry数组（初始容量16）</span>
    table = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>[INITIAL_CAPACITY];
    
    <span class="hljs-comment">// 2. 计算ThreadLocal实例的hash值，确定在数组中的位置</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - <span class="hljs-number">1</span>);
    
    <span class="hljs-comment">// 3. 创建Entry并存储到数组中</span>
    table[i] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>(firstKey, firstValue);
    <span class="hljs-comment">// Entry存储：</span>
    <span class="hljs-comment">//   - key: MDC的ThreadLocal实例（弱引用）</span>
    <span class="hljs-comment">//   - value: new HashMap&lt;&gt;()</span>
    
    size = <span class="hljs-number">1</span>;
}
</code></pre>
<h2 data-id="heading-10">四、完整的内存模型</h2>
<h3 data-id="heading-11">4.1 第一次调用MDC.put时的内存状态</h3>
<pre><code class="hljs language-csharp" lang="csharp">┌─────────────────────────────────────────────────────────────────┐
│ 执行前：                                                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│ Thread<span class="hljs-number">-1</span>对象                                                      │
│   └─ threadLocals: <span class="hljs-literal">null</span>  ← 还没有ThreadLocalMap                 │
│                                                                   │
│ MDC类（静态）                                                     │
│   └─ contextMap: ThreadLocal实例（所有线程共享这个实例）          │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ 执行: MDC.put(<span class="hljs-string">"tid"</span>, <span class="hljs-string">"abc123"</span>)                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│ 第<span class="hljs-number">1</span>步: contextMap.<span class="hljs-keyword">get</span>()                                          │
│   ├─ Thread.currentThread() → Thread<span class="hljs-number">-1</span>对象                       │
│   ├─ Thread<span class="hljs-number">-1.</span>threadLocals → <span class="hljs-literal">null</span>                              │
│   └─ 返回<span class="hljs-literal">null</span>                                                    │
│                                                                   │
│ 第<span class="hljs-number">2</span>步: contextMap.<span class="hljs-keyword">set</span>(<span class="hljs-keyword">new</span> HashMap&lt;&gt;())                           │
│   ├─ Thread.currentThread() → Thread<span class="hljs-number">-1</span>对象                       │
│   ├─ Thread<span class="hljs-number">-1.</span>threadLocals → <span class="hljs-literal">null</span>（不存在）                     │
│   ├─ createMap(Thread<span class="hljs-number">-1</span>, <span class="hljs-keyword">new</span> HashMap&lt;&gt;())                       │
│   │   └─ Thread<span class="hljs-number">-1.</span>threadLocals = <span class="hljs-keyword">new</span> ThreadLocalMap(...)       │
│   │       └─ table[<span class="hljs-number">0</span>] = Entry(MDC的ThreadLocal实例, HashMap)    │
│   └─ 现在Thread<span class="hljs-number">-1</span>有了ThreadLocalMap                             │
│                                                                   │
│ 第<span class="hljs-number">3</span>步: map.put(<span class="hljs-string">"tid"</span>, <span class="hljs-string">"abc123"</span>)                                 │
│   └─ 在HashMap中存储key-<span class="hljs-keyword">value</span>                                    │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ 执行后：                                                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│ Thread<span class="hljs-number">-1</span>对象                                                      │
│   └─ threadLocals: ThreadLocalMap                                │
│       └─ table: Entry[]                                          │
│           └─ Entry[<span class="hljs-number">0</span>]:                                           │
│               ├─ key: MDC的ThreadLocal实例（弱引用）             │
│               └─ <span class="hljs-keyword">value</span>: HashMap{<span class="hljs-string">"tid"</span>: <span class="hljs-string">"abc123"</span>}                 │
│                                                                   │
│ Thread<span class="hljs-number">-2</span>对象（另一个线程）                                       │
│   └─ threadLocals: <span class="hljs-literal">null</span>  ← 还没有调用MDC.put                    │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-12">4.2 第二次调用MDC.put时的内存状态</h3>
<pre><code class="hljs language-css" lang="css">┌─────────────────────────────────────────────────────────────────┐
│ 执行: MDC.<span class="hljs-built_in">put</span>(<span class="hljs-string">"EagleEye-TraceID"</span>, <span class="hljs-string">"abc123"</span>)                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│ 第<span class="hljs-number">1</span>步: contextMap.<span class="hljs-built_in">get</span>()                                          │
│   ├─ Thread.<span class="hljs-built_in">currentThread</span>() → Thread-<span class="hljs-number">1</span>对象                       │
│   ├─ Thread-<span class="hljs-number">1</span>.threadLocals → ThreadLocalMap（已存在）            │
│   ├─ map.<span class="hljs-built_in">getEntry</span>(MDC的ThreadLocal实例)                         │
│   │   └─ 在table中找到Entry[<span class="hljs-number">0</span>]                                  │
│   └─ 返回: HashMap{"tid": <span class="hljs-string">"abc123"</span>}                             │
│                                                                   │
│ 第<span class="hljs-number">2</span>步: map.<span class="hljs-built_in">put</span>(<span class="hljs-string">"EagleEye-TraceID"</span>, <span class="hljs-string">"abc123"</span>)                    │
│   └─ 在已有的HashMap中添加新的key-value                          │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ 执行后：                                                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│ Thread-<span class="hljs-number">1</span>对象                                                      │
│   └─ threadLocals: ThreadLocalMap（同一个Map）                   │
│       └─ table: Entry[]                                          │
│           └─ Entry[<span class="hljs-number">0</span>]:                                           │
│               ├─ key: MDC的ThreadLocal实例（弱引用）             │
│               └─ value: HashMap{                                 │
│                     "tid": <span class="hljs-string">"abc123"</span>,                             │
│                     <span class="hljs-string">"EagleEye-TraceID"</span>: <span class="hljs-string">"abc123"</span>                 │
│                   }                                               │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h2 data-id="heading-13">五、ThreadLocalMap的哈希算法</h2>
<h3 data-id="heading-14">5.1 为什么使用数组而不是HashMap？</h3>
<p><strong>ThreadLocalMap使用数组+开放地址法</strong>，而不是HashMap的数组+链表/红黑树：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ThreadLocalMap的哈希算法</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getIndex</span><span class="hljs-params">(ThreadLocal&lt;?&gt; key)</span> {
    <span class="hljs-comment">// 1. 获取ThreadLocal实例的hashCode</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">hashCode</span> <span class="hljs-operator">=</span> key.threadLocalHashCode;
    
    <span class="hljs-comment">// 2. 计算数组索引（取模运算）</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> hashCode &amp; (table.length - <span class="hljs-number">1</span>);
    <span class="hljs-comment">// 等价于: index = hashCode % table.length</span>
    <span class="hljs-comment">// 但位运算更快</span>
    
    <span class="hljs-keyword">return</span> index;
}
</code></pre>
<p><strong>为什么使用开放地址法？</strong></p>
<ul>
<li>ThreadLocal的数量通常很少（每个线程可能只有几个ThreadLocal）</li>
<li>开放地址法在数据量小时性能更好，内存占用更少</li>
<li>避免链表/红黑树的额外内存开销</li>
</ul>
<h3 data-id="heading-15">5.2 ThreadLocal的hashCode生成</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ThreadLocal类中</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadLocal</span>&lt;T&gt; {
    <span class="hljs-comment">// 每个ThreadLocal实例都有一个唯一的hashCode</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">threadLocalHashCode</span> <span class="hljs-operator">=</span> nextHashCode();
    
    <span class="hljs-comment">// 静态计数器，每次创建ThreadLocal实例时递增</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">nextHashCode</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>();
    
    <span class="hljs-comment">// 每次递增的值（黄金比例相关，用于更好的哈希分布）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">HASH_INCREMENT</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x61c88647</span>;
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">nextHashCode</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> nextHashCode.getAndAdd(HASH_INCREMENT);
    }
}
</code></pre>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建第一个ThreadLocal</span>
ThreadLocal&lt;Map&gt; contextMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();
<span class="hljs-comment">// threadLocalHashCode = 0</span>

<span class="hljs-comment">// 创建第二个ThreadLocal</span>
ThreadLocal&lt;String&gt; otherMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();
<span class="hljs-comment">// threadLocalHashCode = 0x61c88647</span>

<span class="hljs-comment">// 创建第三个ThreadLocal</span>
ThreadLocal&lt;Integer&gt; anotherMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();
<span class="hljs-comment">// threadLocalHashCode = 0x61c88647 * 2</span>
</code></pre>
<h2 data-id="heading-16">六、弱引用的作用</h2>
<h3 data-id="heading-17">6.1 Entry使用弱引用的原因</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Entry</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WeakReference</span>&lt;ThreadLocal&lt;?&gt;&gt; {
    Object value;
    
    Entry(ThreadLocal&lt;?&gt; k, Object v) {
        <span class="hljs-built_in">super</span>(k);  <span class="hljs-comment">// ThreadLocal作为key，使用弱引用</span>
        value = v;
    }
}
</code></pre>
<p><strong>为什么key使用弱引用？</strong></p>
<p><strong>问题场景</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 如果key使用强引用</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span> {
    ThreadLocal&lt;Map&gt; local = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();
    local.set(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;());
    <span class="hljs-comment">// local变量超出作用域，但ThreadLocalMap中的Entry仍然持有强引用</span>
    <span class="hljs-comment">// ThreadLocal对象无法被GC回收 → 内存泄漏</span>
}

<span class="hljs-comment">// 如果key使用弱引用</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span> {
    ThreadLocal&lt;Map&gt; local = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();
    local.set(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;());
    <span class="hljs-comment">// local变量超出作用域</span>
    <span class="hljs-comment">// ThreadLocal对象可以被GC回收（因为只有弱引用）</span>
    <span class="hljs-comment">// 但value仍然存在 → 需要手动清理</span>
}
</code></pre>
<p><strong>内存泄漏风险</strong>：</p>
<pre><code class="hljs language-css" lang="css">Thread-<span class="hljs-number">1</span><span class="hljs-selector-class">.threadLocals</span>
  └─ Entry<span class="hljs-selector-attr">[0]</span>:
      ├─ key: ThreadLocal实例（弱引用）← 可以被GC回收
      └─ value: HashMap（强引用）← 如果ThreadLocal被回收，这个value就<span class="hljs-string">"泄漏"</span>了
</code></pre>
<p><strong>解决方案</strong>：</p>
<ul>
<li>ThreadLocalMap在get/set时会清理key为null的Entry（stale entries）</li>
<li>但最好的做法是：<strong>使用完后调用remove()或clear()</strong></li>
</ul>
<h2 data-id="heading-18">七、完整执行流程示例</h2>
<h3 data-id="heading-19">7.1 第一次调用MDC.put的完整过程</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ========== 代码调用 ==========</span>
MDC.put(<span class="hljs-string">"tid"</span>, <span class="hljs-string">"abc123"</span>);

<span class="hljs-comment">// ========== 第1步：MDC.put()方法 ==========</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(String key, String value)</span> {
    Map&lt;String, String&gt; map = contextMap.get();
    <span class="hljs-comment">// 调用ThreadLocal.get()</span>
}

<span class="hljs-comment">// ========== 第2步：ThreadLocal.get() ==========</span>
<span class="hljs-keyword">public</span> T <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {
    <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> Thread.currentThread();
    <span class="hljs-comment">// t = Thread-http-nio-8001-exec-1对象</span>
    
    <span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> getMap(t);
    <span class="hljs-comment">// getMap(t) = t.threadLocals</span>
    <span class="hljs-comment">// 此时 t.threadLocals = null（第一次调用）</span>
    
    <span class="hljs-keyword">if</span> (map != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 不执行（map为null）</span>
    }
    
    <span class="hljs-keyword">return</span> setInitialValue();
    <span class="hljs-comment">// 调用setInitialValue()</span>
}

<span class="hljs-comment">// ========== 第3步：ThreadLocal.setInitialValue() ==========</span>
<span class="hljs-keyword">private</span> T <span class="hljs-title function_">setInitialValue</span><span class="hljs-params">()</span> {
    <span class="hljs-type">T</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> initialValue();
    <span class="hljs-comment">// initialValue()返回null（ThreadLocal的默认实现）</span>
    
    <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> Thread.currentThread();
    <span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> getMap(t);
    <span class="hljs-comment">// map = null</span>
    
    <span class="hljs-keyword">if</span> (map != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 不执行</span>
    } <span class="hljs-keyword">else</span> {
        createMap(t, value);
        <span class="hljs-comment">// 创建ThreadLocalMap</span>
    }
    
    <span class="hljs-keyword">return</span> value;  <span class="hljs-comment">// 返回null</span>
}

<span class="hljs-comment">// ========== 第4步：ThreadLocal.createMap() ==========</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">createMap</span><span class="hljs-params">(Thread t, T firstValue)</span> {
    t.threadLocals = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocalMap</span>(<span class="hljs-built_in">this</span>, firstValue);
    <span class="hljs-comment">// this = MDC的ThreadLocal实例</span>
    <span class="hljs-comment">// firstValue = null（但后面会重新set）</span>
}

<span class="hljs-comment">// ========== 第5步：ThreadLocalMap构造函数 ==========</span>
ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) {
    table = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>[INITIAL_CAPACITY];  <span class="hljs-comment">// 创建16大小的数组</span>
    
    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - <span class="hljs-number">1</span>);
    <span class="hljs-comment">// 计算哈希索引，假设 i = 3</span>
    
    table[i] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>(firstKey, firstValue);
    <span class="hljs-comment">// table[3] = Entry(MDC的ThreadLocal实例, null)</span>
    
    size = <span class="hljs-number">1</span>;
}

<span class="hljs-comment">// ========== 第6步：回到MDC.put() ==========</span>
Map&lt;String, String&gt; map = contextMap.get();
<span class="hljs-comment">// map = null（因为setInitialValue返回null）</span>

<span class="hljs-keyword">if</span> (map == <span class="hljs-literal">null</span>) {
    map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    contextMap.set(map);
    <span class="hljs-comment">// 调用ThreadLocal.set()</span>
}

<span class="hljs-comment">// ========== 第7步：ThreadLocal.set() ==========</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(T value)</span> {
    <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> Thread.currentThread();
    <span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> getMap(t);
    <span class="hljs-comment">// map = ThreadLocalMap（已存在）</span>
    
    <span class="hljs-keyword">if</span> (map != <span class="hljs-literal">null</span>) {
        map.set(<span class="hljs-built_in">this</span>, value);
        <span class="hljs-comment">// 在ThreadLocalMap中设置值</span>
    }
}

<span class="hljs-comment">// ========== 第8步：ThreadLocalMap.set() ==========</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(ThreadLocal&lt;?&gt; key, Object value)</span> {
    Entry[] tab = table;
    <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> tab.length;
    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> key.threadLocalHashCode &amp; (len - <span class="hljs-number">1</span>);
    <span class="hljs-comment">// 计算索引，假设 i = 3</span>
    
    <span class="hljs-comment">// 查找Entry（处理哈希冲突）</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">Entry</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> tab[i]; e != <span class="hljs-literal">null</span>; e = tab[i = nextIndex(i, len)]) {
        ThreadLocal&lt;?&gt; k = e.get();
        
        <span class="hljs-keyword">if</span> (k == key) {
            <span class="hljs-comment">// 找到对应的Entry，更新value</span>
            e.value = value;
            <span class="hljs-keyword">return</span>;
        }
        
        <span class="hljs-keyword">if</span> (k == <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// key被GC回收了，替换这个stale entry</span>
            replaceStaleEntry(key, value, i);
            <span class="hljs-keyword">return</span>;
        }
    }
    
    <span class="hljs-comment">// 没找到，创建新Entry</span>
    tab[i] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>(key, value);
    <span class="hljs-comment">// table[3].value = new HashMap&lt;&gt;()</span>
    
    <span class="hljs-type">int</span> <span class="hljs-variable">sz</span> <span class="hljs-operator">=</span> ++size;
    <span class="hljs-keyword">if</span> (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold) {
        rehash();  <span class="hljs-comment">// 扩容</span>
    }
}

<span class="hljs-comment">// ========== 第9步：回到MDC.put() ==========</span>
map.put(<span class="hljs-string">"tid"</span>, <span class="hljs-string">"abc123"</span>);
<span class="hljs-comment">// 在HashMap中存储key-value</span>
</code></pre>
<h3 data-id="heading-20">7.2 内存状态变化</h3>
<pre><code class="hljs language-ini" lang="ini">执行前：
<span class="hljs-attr">Thread-1.threadLocals</span> = null

执行createMap后：
<span class="hljs-attr">Thread-1.threadLocals</span> = ThreadLocalMap {
    table<span class="hljs-section">[3]</span> = Entry(MDC的ThreadLocal实例, null)
}

执行set后：
<span class="hljs-attr">Thread-1.threadLocals</span> = ThreadLocalMap {
    table<span class="hljs-section">[3]</span> = Entry(MDC的ThreadLocal实例, HashMap{})
}

执行map.put后：
<span class="hljs-attr">Thread-1.threadLocals</span> = ThreadLocalMap {
    table<span class="hljs-section">[3]</span> = Entry(MDC的ThreadLocal实例, HashMap{"tid": "abc123"})
}
</code></pre>
<h2 data-id="heading-21">八、为什么每个线程的ThreadLocal是独立的？</h2>
<h3 data-id="heading-22">8.1 关键机制</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ThreadLocal.get()的实现</span>
<span class="hljs-keyword">public</span> T <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {
    <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> Thread.currentThread();  <span class="hljs-comment">// ← 关键：获取当前线程</span>
    <span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> getMap(t);     <span class="hljs-comment">// ← 关键：从当前线程获取Map</span>
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ol>
<li><code>Thread.currentThread()</code> 返回的是<strong>当前执行代码的线程对象</strong></li>
<li>每个线程对象都有自己独立的 <code>threadLocals</code> 字段</li>
<li>所以每个线程访问的是自己的 ThreadLocalMap</li>
</ol>
<h3 data-id="heading-23">8.2 多线程示例</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 线程1执行</span>
Thread-<span class="hljs-number">1</span>: 
  Thread.currentThread() → Thread-<span class="hljs-number">1</span>对象
  Thread-<span class="hljs-number">1.</span>threadLocals → Thread-<span class="hljs-number">1</span>的ThreadLocalMap
  MDC.get(<span class="hljs-string">"tid"</span>) → 从Thread-<span class="hljs-number">1</span>的Map读取

<span class="hljs-comment">// 线程2执行（同时）</span>
Thread-<span class="hljs-number">2</span>:
  Thread.currentThread() → Thread-<span class="hljs-number">2</span>对象
  Thread-<span class="hljs-number">2.</span>threadLocals → Thread-<span class="hljs-number">2</span>的ThreadLocalMap
  MDC.get(<span class="hljs-string">"tid"</span>) → 从Thread-<span class="hljs-number">2</span>的Map读取

<span class="hljs-comment">// 两个线程互不干扰</span>
</code></pre>
<h2 data-id="heading-24">九、总结</h2>
<h3 data-id="heading-25">9.1 核心原理</h3>
<ol>
<li><strong>ThreadLocal不存储数据</strong>：ThreadLocal只是一个"钥匙"</li>
<li><strong>数据存储在Thread对象中</strong>：每个Thread对象有<code>threadLocals</code>字段</li>
<li><strong>ThreadLocalMap是实际存储</strong>：类似HashMap，但使用数组+开放地址法</li>
<li><strong>第一次调用时创建</strong>：调用<code>set()</code>时，如果Thread的<code>threadLocals</code>为null，会创建新的ThreadLocalMap</li>
</ol>
<h3 data-id="heading-26">9.2 执行流程</h3>
<pre><code class="hljs language-scss" lang="scss">MDC<span class="hljs-selector-class">.put</span>("tid", "abc123")
  ↓
ThreadLocal<span class="hljs-selector-class">.get</span>()
  ↓
Thread<span class="hljs-selector-class">.currentThread</span>() → 获取当前线程对象
  ↓
t<span class="hljs-selector-class">.threadLocals</span> → 获取线程的ThreadLocalMap（可能为null）
  ↓
如果为null → <span class="hljs-built_in">createMap</span>() → 创建ThreadLocalMap并赋值给t<span class="hljs-selector-class">.threadLocals</span>
  ↓
ThreadLocal<span class="hljs-selector-class">.set</span>() → 在ThreadLocalMap中存储值
  ↓
Thread-<span class="hljs-number">1</span><span class="hljs-selector-class">.threadLocals</span><span class="hljs-selector-class">.table</span><span class="hljs-selector-attr">[i]</span> = <span class="hljs-built_in">Entry</span>(ThreadLocal实例, HashMap)
</code></pre>
<h3 data-id="heading-27">9.3 关键理解</h3>
<p><strong>"为线程创建ThreadLocal"的本质</strong>：</p>
<ul>
<li>不是在ThreadLocal中创建数据</li>
<li>而是在<strong>Thread对象中创建ThreadLocalMap</strong></li>
<li>ThreadLocal只是用来访问Thread对象中数据的"钥匙"</li>
</ul>
<p><strong>内存模型</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">Thread对象
  └─ threadLocals: ThreadLocalMap（每个线程独立）
      └─ table: Entry<span class="hljs-section">[]</span>（存储实际数据）
          └─ Entry: <span class="hljs-attr">key</span>=ThreadLocal实例, value=实际值
</code></pre>
<p>这就是为什么每个线程的MDC是独立的，互不干扰的根本原因！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解决 JavaScript Number 精度问题：处理超大 Long 类型 ID]]></title>    <link>https://juejin.cn/post/7573525927793000474</link>    <guid>https://juejin.cn/post/7573525927793000474</guid>    <pubDate>2025-11-17T11:36:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573525927793000474" data-draft-id="7573519273029959726" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解决 JavaScript Number 精度问题：处理超大 Long 类型 ID"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-11-17T11:36:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OlahOlah"/> <meta itemprop="url" content="https://juejin.cn/user/1576016232062667"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解决 JavaScript Number 精度问题：处理超大 Long 类型 ID
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1576016232062667/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OlahOlah
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T11:36:58.000Z" title="Mon Nov 17 2025 11:36:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在前后端交互中，常常需要传递 <code>Long</code> 类型的 ID。但 JavaScript 的 <code>Number</code> 类型基于 IEEE 754 标准，最大只能精确表示 15 到 17 位的整数，超过这个范围会丢失精度。为了避免这种问题，本文介绍如何处理超大数字。</p>
<h4 data-id="heading-0">问题描述</h4>
<p>JavaScript 的 <code>Number</code> 类型的最大安全整数是 <code>9007199254740991</code>，超过这个值的数字会出现精度丢失。例如，<code>1234567890123456789</code> 会被转为 <code>1234567890123456700</code>，导致错误。</p>
<h4 data-id="heading-1">问题的根源</h4>
<p><code>Long</code> 类型是许多后端语言（如 Java）用于表示大整数的类型，而 JavaScript 的 <code>Number</code> 类型不能正确表示如此大的数字。</p>
<pre><code class="hljs language-ini" lang="ini">// 后端：Java
Long <span class="hljs-attr">longId</span> = <span class="hljs-number">1234567890123456789</span>L<span class="hljs-comment">;</span>
</code></pre>
<p>前端接收到该 ID 后，会出现精度丢失：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 前端：JavaScript</span>
<span class="hljs-keyword">let</span> itemId = <span class="hljs-number">1234567890123456789</span>;  <span class="hljs-comment">// 错误，精度丢失</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(itemId);  <span class="hljs-comment">// 输出：1234567890123456700</span>
</code></pre>
<h4 data-id="heading-2">解决方案</h4>
<p>将 <code>Long</code> 类型 ID 转为字符串，并确保前后端都使用字符串形式传递 ID，避免精度丢失。</p>
<ul>
<li><strong>后台</strong>：将 <code>Long</code> 类型 ID 转为字符串。</li>
<li><strong>前端</strong>：接收 ID 时保持字符串类型，避免转换为 <code>Number</code>。</li>
</ul>
<h4 data-id="heading-3">实施方案</h4>
<h5 data-id="heading-4">后端（Java 示例）：</h5>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@RestController</span>
public class ItemController {
    <span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">"/items/{id}"</span>)
    public ResponseEntity&lt;ItemVO&gt; <span class="hljs-built_in">getItem</span>(<span class="hljs-variable">@PathVariable</span> Long id) {
        <span class="hljs-selector-tag">Item</span> <span class="hljs-selector-tag">item</span> = <span class="hljs-selector-tag">itemService</span><span class="hljs-selector-class">.getItemById</span>(id);
​
        <span class="hljs-selector-tag">ItemVO</span> <span class="hljs-selector-tag">itemVO</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">ItemVO</span>();
        <span class="hljs-selector-tag">itemVO</span><span class="hljs-selector-class">.setId</span>(String.<span class="hljs-built_in">valueOf</span>(id));
​
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.ok</span>(itemVO);
    }
}
</code></pre>
<h5 data-id="heading-5">前端（JavaScript 示例）：</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用 axios 请求 API</span>
axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/items/1234567890123456789'</span>)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> itemId = response.<span class="hljs-property">data</span>.<span class="hljs-property">id</span>;  <span class="hljs-comment">// 保持为字符串</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(itemId);  <span class="hljs-comment">// 输出原始字符串</span>
  })
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Error:'</span>, error);
  });
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python编程实战：综合项目 —— 迷你爬虫项目]]></title>    <link>https://juejin.cn/post/7573595009552154634</link>    <guid>https://juejin.cn/post/7573595009552154634</guid>    <pubDate>2025-11-18T01:46:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573595009552154634" data-draft-id="7573579203460874291" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python编程实战：综合项目 —— 迷你爬虫项目"/> <meta itemprop="keywords" content="后端,Python,面试"/> <meta itemprop="datePublished" content="2025-11-18T01:46:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python编程实战：综合项目 —— 迷你爬虫项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T01:46:59.000Z" title="Tue Nov 18 2025 01:46:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>这个实战专门让你体验“从零搭一个可用的小爬虫”，功能虽然轻量，但结构、流程、容错、模块化都完整得像样，是一个非常适合作为综合训练的项目。</p>
</blockquote>
<hr/>
<h3 data-id="heading-0">一、项目目标</h3>
<p>开发一个迷你爬虫，实现：</p>
<ol>
<li>输入一个网页 URL</li>
<li>自动发起请求并获取网页内容</li>
<li>提取网页中的标题、正文文字、链接</li>
<li>将结果保存到本地</li>
<li>提供基础的异常处理（网络错误、解析错误等）</li>
<li>使用模块化结构可扩展</li>
</ol>
<p>这是一个“只用 Python 标准库 + requests + BeautifulSoup”就能完成的轻量项目。</p>
<hr/>
<h3 data-id="heading-1">二、所需库</h3>
<pre><code class="hljs language-bash" lang="bash">pip install requests beautifulsoup4 lxml
</code></pre>
<p>项目中需要用到：</p>
<ul>
<li>requests：用于发送 HTTP 请求</li>
<li>bs4（BeautifulSoup）：用于解析网页</li>
<li>lxml：加速解析并提升稳定性</li>
</ul>
<hr/>
<h3 data-id="heading-2">三、项目结构设计</h3>
<p>推荐这样的结构：</p>
<pre><code class="hljs language-bash" lang="bash">mini_spider/
│── main.py            <span class="hljs-comment"># 主程序入口</span>
│── fetcher.py         <span class="hljs-comment"># 网络请求模块</span>
│── parser.py          <span class="hljs-comment"># 数据解析模块</span>
│── saver.py           <span class="hljs-comment"># 文件保存模块</span>
│── output/            <span class="hljs-comment"># 保存爬取结果</span>
</code></pre>
<p>这会让程序更像“可维护的小项目”，而不是零散脚本。</p>
<hr/>
<h2 data-id="heading-3">四、编写网络请求模块 fetcher.py</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests

<span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_html</span>(<span class="hljs-params">url, timeout=<span class="hljs-number">10</span></span>):
    headers = {
        <span class="hljs-string">"User-Agent"</span>: <span class="hljs-string">"Mozilla/5.0 (Mini Spider Project)"</span>
    }
    <span class="hljs-keyword">try</span>:
        resp = requests.get(url, headers=headers, timeout=timeout)
        resp.raise_for_status()
        resp.encoding = resp.apparent_encoding
        <span class="hljs-keyword">return</span> resp.text
    <span class="hljs-keyword">except</span> requests.RequestException <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"请求失败: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
</code></pre>
<p>功能亮点：</p>
<ul>
<li>自定义 UA 防止部分网站拒绝</li>
<li><code>raise_for_status()</code> 帮你捕获 404/500</li>
<li>timeout 防止卡死</li>
<li>稳健的异常处理</li>
</ul>
<hr/>
<h2 data-id="heading-4">五、编写解析模块 parser.py</h2>
<p>示例：提取文章标题、正文文本、所有超链接。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> bs4 <span class="hljs-keyword">import</span> BeautifulSoup

<span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_page</span>(<span class="hljs-params">html</span>):
    <span class="hljs-keyword">try</span>:
        soup = BeautifulSoup(html, <span class="hljs-string">"lxml"</span>)

        title = soup.title.string <span class="hljs-keyword">if</span> soup.title <span class="hljs-keyword">else</span> <span class="hljs-string">"无标题"</span>

        <span class="hljs-comment"># 提取正文</span>
        paragraphs = [p.get_text(strip=<span class="hljs-literal">True</span>) <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> soup.find_all(<span class="hljs-string">"p"</span>)]
        content = <span class="hljs-string">"\n"</span>.join(paragraphs)

        <span class="hljs-comment"># 提取链接</span>
        links = [a[<span class="hljs-string">'href'</span>] <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> soup.find_all(<span class="hljs-string">"a"</span>, href=<span class="hljs-literal">True</span>)]

        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"title"</span>: title,
            <span class="hljs-string">"content"</span>: content,
            <span class="hljs-string">"links"</span>: links
        }

    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"解析失败: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
</code></pre>
<p>这个解析逻辑简单但通用，能适配大部分普通网页。</p>
<hr/>
<h2 data-id="heading-5">六、保存模块 saver.py</h2>
<p>把爬取结果保存为 txt 文件。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os

<span class="hljs-keyword">def</span> <span class="hljs-title function_">save_result</span>(<span class="hljs-params">data, filename=<span class="hljs-string">"result.txt"</span></span>):
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(<span class="hljs-string">"output"</span>):
        os.makedirs(<span class="hljs-string">"output"</span>)

    filepath = os.path.join(<span class="hljs-string">"output"</span>, filename)

    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(filepath, <span class="hljs-string">"w"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
        f.write(<span class="hljs-string">f"标题：<span class="hljs-subst">{data[<span class="hljs-string">'title'</span>]}</span>\n\n"</span>)
        f.write(<span class="hljs-string">"正文内容：\n"</span>)
        f.write(data[<span class="hljs-string">"content"</span>])
        f.write(<span class="hljs-string">"\n\n链接列表：\n"</span>)
        <span class="hljs-keyword">for</span> link <span class="hljs-keyword">in</span> data[<span class="hljs-string">"links"</span>]:
            f.write(link + <span class="hljs-string">"\n"</span>)

    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"已保存到 <span class="hljs-subst">{filepath}</span>"</span>)
</code></pre>
<p>你也可以扩展成：</p>
<ul>
<li>保存为 JSON</li>
<li>保存为 CSV</li>
<li>保存为 HTML</li>
<li>保存为知识库</li>
</ul>
<hr/>
<h2 data-id="heading-6">七、主程序 main.py</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fetcher <span class="hljs-keyword">import</span> fetch_html
<span class="hljs-keyword">from</span> parser <span class="hljs-keyword">import</span> parse_page
<span class="hljs-keyword">from</span> saver <span class="hljs-keyword">import</span> save_result

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    url = <span class="hljs-built_in">input</span>(<span class="hljs-string">"请输入要爬取的URL："</span>)

    html = fetch_html(url)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> html:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"获取网页失败"</span>)
        <span class="hljs-keyword">return</span>

    data = parse_page(html)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> data:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"解析失败"</span>)
        <span class="hljs-keyword">return</span>

    save_result(data, filename=<span class="hljs-string">"爬取结果.txt"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"爬取完成！"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()
</code></pre>
<p>运行效果：</p>
<pre><code class="hljs language-arduino" lang="arduino">请输入要爬取的URL：http:<span class="hljs-comment">//example.com</span>
正在保存...
爬取完成！
</code></pre>
<hr/>
<h2 data-id="heading-7">八、项目特色亮点</h2>
<p>这个“迷你爬虫项目”虽然简单，但框架很专业，因为它包含：</p>
<ul>
<li>模块化开发</li>
<li>独立网络层 + 解析层 + 存储层</li>
<li>异常处理全链路</li>
<li>对网页按结构信息拆解</li>
<li>工程结构可扩展性强</li>
</ul>
<p>你稍微扩展一下就能变成：</p>
<p>✔ 批量 URL 爬虫
✔ 采集新闻网站文章
✔ 采集商品标题价格
✔ 监控网页变化
✔ 小规模数据采集脚本</p>
<hr/>
<h2 data-id="heading-8">九、可扩展方向（项目升级建议）</h2>
<p>如果你想进一步强化，可以加入：</p>
<h4 data-id="heading-9">1. 批量 URL 爬取</h4>
<p>从文件读取 URL 列表，一次抓一批。</p>
<h4 data-id="heading-10">2. 自动限速 &amp; 重试机制</h4>
<p>降低被封风险。</p>
<h4 data-id="heading-11">3. 代理池</h4>
<p>提高稳定性。</p>
<h4 data-id="heading-12">4. 结构化存储（JSON/CSV）</h4>
<p>方便后续分析。</p>
<h4 data-id="heading-13">5. GUI 图形界面（Tkinter）</h4>
<p>变成真正的桌面工具。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python编程实战：综合项目 —— Flask 迷你博客]]></title>    <link>https://juejin.cn/post/7573601651781943323</link>    <guid>https://juejin.cn/post/7573601651781943323</guid>    <pubDate>2025-11-18T01:48:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573601651781943323" data-draft-id="7573601651781926939" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python编程实战：综合项目 —— Flask 迷你博客"/> <meta itemprop="keywords" content="后端,面试,Python"/> <meta itemprop="datePublished" content="2025-11-18T01:48:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python编程实战：综合项目 —— Flask 迷你博客
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T01:48:21.000Z" title="Tue Nov 18 2025 01:48:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>这个项目是典型的 Web 入门实战 —— 用 Flask 搭建一个“小而完整”的博客系统，让你掌握后端接口开发、模板渲染、数据存储、表单处理等核心技能。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、项目目标</h2>
<p>构建一个迷你博客，实现：</p>
<ol>
<li>发布文章（标题 + 内容）</li>
<li>展示所有文章</li>
<li>查看单篇文章详情</li>
<li>文章持久化存储（本地 JSON 或 SQLite）</li>
<li>模板渲染（Jinja2）</li>
<li>简单的路由和表单处理</li>
</ol>
<p>整个项目结构小巧，但逻辑完整，可扩展性高。</p>
<hr/>
<h2 data-id="heading-1">二、项目目录结构</h2>
<p>我们使用 Flask 推荐的基本结构：</p>
<pre><code class="hljs language-csharp" lang="csharp">flask_blog/
│── app.py                <span class="hljs-meta"># 主程序</span>
│── models.py             <span class="hljs-meta"># 数据读写模块</span>
│── <span class="hljs-keyword">static</span>/               <span class="hljs-meta"># 静态文件（css/js/img）</span>
│── templates/
│     ├── <span class="hljs-keyword">base</span>.html
│     ├── index.html
│     ├── post.html
│     ├── new_post.html
│── data/
      └── posts.json      <span class="hljs-meta"># 存储文章</span>
</code></pre>
<hr/>
<h2 data-id="heading-2">三、环境安装</h2>
<pre><code class="hljs language-bash" lang="bash">pip install flask
</code></pre>
<p>如果你想升级，可加：</p>
<pre><code class="hljs language-bash" lang="bash">pip install flask-wtf
</code></pre>
<p>但基础项目不强制。</p>
<hr/>
<h2 data-id="heading-3">四、构建数据模型（models.py）</h2>
<p>这里我们使用一个简单的 JSON 文件保存文章。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime

DATA_FILE = <span class="hljs-string">"data/posts.json"</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">load_posts</span>():
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(DATA_FILE):
        <span class="hljs-keyword">return</span> []
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(DATA_FILE, <span class="hljs-string">"r"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
        <span class="hljs-keyword">return</span> json.load(f)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">save_posts</span>(<span class="hljs-params">posts</span>):
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(DATA_FILE, <span class="hljs-string">"w"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
        json.dump(posts, f, ensure_ascii=<span class="hljs-literal">False</span>, indent=<span class="hljs-number">4</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">add_post</span>(<span class="hljs-params">title, content</span>):
    posts = load_posts()
    new_post = {
        <span class="hljs-string">"id"</span>: <span class="hljs-built_in">len</span>(posts) + <span class="hljs-number">1</span>,
        <span class="hljs-string">"title"</span>: title,
        <span class="hljs-string">"content"</span>: content,
        <span class="hljs-string">"created_at"</span>: datetime.now().strftime(<span class="hljs-string">"%Y-%m-%d %H:%M:%S"</span>)
    }
    posts.append(new_post)
    save_posts(posts)
</code></pre>
<hr/>
<h2 data-id="heading-4">五、核心后端逻辑（app.py）</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, render_template, request, redirect, url_for
<span class="hljs-keyword">from</span> models <span class="hljs-keyword">import</span> load_posts, add_post

app = Flask(__name__)

<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">"/"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():
    posts = load_posts()
    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">"index.html"</span>, posts=posts)

<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">"/post/&lt;int:post_id&gt;"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">post_detail</span>(<span class="hljs-params">post_id</span>):
    posts = load_posts()
    post = <span class="hljs-built_in">next</span>((p <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> posts <span class="hljs-keyword">if</span> p[<span class="hljs-string">"id"</span>] == post_id), <span class="hljs-literal">None</span>)
    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">"post.html"</span>, post=post)

<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">"/new"</span>, methods=[<span class="hljs-string">"GET"</span>, <span class="hljs-string">"POST"</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">new_post</span>():
    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">"POST"</span>:
        title = request.form.get(<span class="hljs-string">"title"</span>)
        content = request.form.get(<span class="hljs-string">"content"</span>)
        add_post(title, content)
        <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">"index"</span>))
    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">"new_post.html"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    app.run(debug=<span class="hljs-literal">True</span>)
</code></pre>
<p>功能点：</p>
<ul>
<li>GET 展示表单</li>
<li>POST 提交文章</li>
<li>首页展示文章列表</li>
<li>/post/id 展示文章详情</li>
</ul>
<p>架构简洁但非常清晰。</p>
<hr/>
<h2 data-id="heading-5">六、模板文件（templates）</h2>
<h3 data-id="heading-6">1. base.html</h3>
<p>所有页面的公共布局：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>迷你博客<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/static/style.css"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">header</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/"</span>&gt;</span>迷你博客<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/"</span>&gt;</span>首页<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/new"</span>&gt;</span>写文章<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
        {% block content %}{% endblock %}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-7">2. index.html（首页）</h3>
<pre><code class="hljs language-html" lang="html">{% extends "base.html" %}
{% block content %}
<span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>文章列表<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
{% for p in posts %}
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/post/{{ p.id }}"</span>&gt;</span>{{ p.title }}<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">small</span>&gt;</span>{{ p.created_at }}<span class="hljs-tag">&lt;/<span class="hljs-name">small</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
{% endfor %}
<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>

{% endblock %}
</code></pre>
<hr/>
<h3 data-id="heading-8">3. post.html（文章详情）</h3>
<pre><code class="hljs language-html" lang="html">{% extends "base.html" %}
{% block content %}
<span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>{{ post.title }}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ post.content }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">small</span>&gt;</span>发布时间：{{ post.created_at }}<span class="hljs-tag">&lt;/<span class="hljs-name">small</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
{% endblock %}
</code></pre>
<hr/>
<h3 data-id="heading-9">4. new_post.html（新增文章表单）</h3>
<pre><code class="hljs language-html" lang="html">{% extends "base.html" %}
{% block content %}

<span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>写文章<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"post"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>标题：<span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"title"</span> <span class="hljs-attr">required</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>内容：<span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">textarea</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"content"</span> <span class="hljs-attr">rows</span>=<span class="hljs-string">"10"</span> <span class="hljs-attr">required</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">textarea</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>发布<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>

{% endblock %}
</code></pre>
<hr/>
<h2 data-id="heading-10">七、静态样式（static/style.css）可选</h2>
<p>你可以随意写点：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">body</span> {
    <span class="hljs-attribute">font-family</span>: Arial, sans-serif;
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
}
<span class="hljs-selector-tag">header</span> {
    <span class="hljs-attribute">background</span>: <span class="hljs-number">#333</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">15px</span>;
}
<span class="hljs-selector-tag">header</span> <span class="hljs-selector-tag">a</span> {
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
    <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">10px</span>;
    <span class="hljs-attribute">text-decoration</span>: none;
}
<span class="hljs-selector-class">.container</span> {
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
}
</code></pre>
<hr/>
<h2 data-id="heading-11">八、运行项目</h2>
<p>进入目录执行：</p>
<pre><code class="hljs language-bash" lang="bash">python app.py
</code></pre>
<p>打开：</p>
<pre><code class="hljs language-arduino" lang="arduino">http:<span class="hljs-comment">//127.0.0.1:5000</span>
</code></pre>
<p>你就能看到自己的迷你博客啦！</p>
<hr/>
<h2 data-id="heading-12">九、项目可扩展方向</h2>
<p>这个项目基础但可扩展性超级强，可以继续升级：</p>
<ol>
<li>使用 SQLite 数据库（SQLAlchemy）</li>
<li>加上用户登录系统</li>
<li>博客支持 Markdown</li>
<li>图片上传</li>
<li>分页</li>
<li>评论系统</li>
<li>后台管理界面</li>
<li>打包为 Docker 部署</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Dart 3.10中的新的lint规则]]></title>    <link>https://juejin.cn/post/7573601651781877787</link>    <guid>https://juejin.cn/post/7573601651781877787</guid>    <pubDate>2025-11-18T01:43:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573601651781877787" data-draft-id="7572793505900724275" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Dart 3.10中的新的lint规则"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-18T01:43:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JarvanMo"/> <meta itemprop="url" content="https://juejin.cn/user/2348212565845704"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Dart 3.10中的新的lint规则
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2348212565845704/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JarvanMo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T01:43:04.000Z" title="Tue Nov 18 2025 01:43:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前几天，<code>Flutter 3.38</code> &amp; <code>Dart 3.10</code>正式发布，详情参考<a href="https://juejin.cn/user/2348212565845704/posts" target="_blank" title="https://juejin.cn/user/2348212565845704/posts">Flutter3.38 带来了什么</a>。这其中包括了一项新的lint:</p>
<h3 data-id="heading-0"><a href="https://link.juejin.cn?target=https%3A%2F%2Fdart.dev%2Ftools%2Fdiagnostics%2Fremove_deprecations_in_breaking_versions" target="_blank" title="https://dart.dev/tools/diagnostics/remove_deprecations_in_breaking_versions" ref="nofollow noopener noreferrer">remove_deprecations_in_breaking_versions</a></h3>
<p>说人话就是:<strong>在主要版本中移除弃用功能</strong>。</p>
<p><strong>欢迎关注我的微信公众号：OpenFlutter，谢谢</strong></p>
<p>当你想要在软件包中移除某些 API 时，你不会立即执行，而是会<strong>分阶段地逐渐淘汰</strong>。一旦您决定某个功能将在某个时间点移除，您就会在其上加上 <code>@Deprecated</code> 注解：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-meta">@Deprecated</span>(<span class="hljs-string">'This sucks. Use Class2'</span>)  
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Class1</span> </span>{}  
  
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Class2</span> </span>{}
</code></pre>
<p>然后，任何使用您软件包的用户，只要使用了被这样注解（即 <code>@Deprecated</code>）的任何功能，就会收到一条 <code>deprecated_member_use</code> 诊断消息。</p>
<p><strong>那么，何时应该移除您之前声明已弃用的 API 呢？</strong> 这就是版本号约定发挥作用的时候了。最常见的约定被称为 <strong>SemVer（语义化版本控制）</strong> ，其定义可在 <code>https://semver.org</code> 查阅。</p>
<p>SemVer 规定，版本号必须包含三个数字：<strong>主版本号 (Major).次版本号 (Minor).修订号 (Patch)</strong> 。例如，Dart 的当前版本是 <code>3.10.0</code>：</p>
<ul>
<li><strong>3</strong> 是主版本号。</li>
<li><strong>10</strong> 是次版本号。</li>
<li><strong>0</strong> 是修订号。</li>
</ul>
<p>当您发布一个新版本，它<strong>只修复了错误</strong>，而没有破坏任何您的软件包用户可能依赖的东西时，您应该增加<strong>修订号 (Patch)</strong> 。例如，Dart 的上一个版本是 <code>3.9.2</code>，这意味着他们发布了三个 <code>3.9.x</code> 版本，其中最后两个修复了一些错误。</p>
<p>当您发布一个新版本，它<strong>增加了新功能</strong>，但仍然没有破坏任何您的软件包用户可能依赖的东西时，您应该增加<strong>次版本号 (Minor)</strong> 。例如，从 <code>3.9.2</code> 到 <code>3.10.0</code>，Dart 增加了您的代码可以使用的<strong>新功能</strong>，但保证所有原本可以在 <code>3.9.2</code> 上构建的代码仍然可以在 <code>3.10.0</code> 上构建。</p>
<p>当您发布一个<strong>不兼容版本（breaking version）</strong> 时，您需要增加<strong>主版本号 (Major)</strong> 。</p>
<p>Dart 社区<a href="https://link.juejin.cn?target=https%3A%2F%2Fdart.dev%2Ftools%2Fpub%2Fversioning%23semantic-versions" target="_blank" title="https://dart.dev/tools/pub/versioning#semantic-versions" ref="nofollow noopener noreferrer">采纳了</a>这一标准，但增加了一个额外的限制。尽管标准不保证第一个稳定版本 (<code>1.0.0</code>) 之前的版本之间有任何兼容性，但 Dart 仍然<strong>语义化地</strong>处理这些版本：在 <code>1.0.0</code> 之前，<strong>次版本号 (minor)</strong> 的增加意味着<strong>不兼容的变更 (breaking changes)</strong> 。这使得我们在宣布稳定版本之前，可以多次发出不兼容版本的信号，以改进我们的软件包。</p>
<p>不兼容版本对您的用户来说简直是地狱，因为除非他们在 <code>pubspec.yaml</code> 中明确允许，否则它不会自动被拉入他们的项目。他们使用的一些软件包可能需要您的新主版本，而其他软件包可能与它不兼容。这就是<strong>依赖地狱 (dependency hell)</strong> 。您必须避免过于频繁地发布新的主版本。</p>
<p>这就是为什么如果您计划进行不兼容的更改，您通常希望通过一个主版本<strong>尽可能多地一次性进行所有破坏性更改</strong>，以便您的用户只需适应一次。</p>
<p>因此，如果您发布了一个新的主版本，却忘记移除您原本想移除的东西，那将是非常可惜的。</p>
<p>因此，引入了新的代码风格检查工具（lint）来帮助您解决这个问题。</p>
<p>如果在您的 <code>pubspec.yaml</code> 中，您设置了<strong>不兼容的版本号</strong>（<code>x.0.0</code> 或 <code>0.x.0</code>），这个 lint 就会标记出您可能仍然拥有的所有 <code>@Deprecated</code> 注解。</p>
<p>一个有趣的推论是：您<strong>不应该</strong>在一个不兼容版本中引入新的弃用。如果您这样做，lint 会标记它，您将不得不忽略它。一旦您决定在某处忽略它，您就有可能忽略那些应该被移除但被您遗忘的旧弃用功能所引发的合理警告。</p>
<p>因此，请首先发布一个<strong>正常的不兼容版本（其中不包含任何弃用）</strong> ，然后在<strong>下一个版本</strong>中弃用一些东西。顺便说一句，如果您引入了弃用功能，您应该增加<strong>次版本号 (Minor)</strong> ，而不仅仅是修订号 (Patch)。</p>
<p>这是因为您软件包的一些用户可能在他们的持续集成（CI）中设置了静态分析，并且有一个规则是<strong>不使用任何弃用的代码</strong>。当您弃用某个功能时，这个 CI 就会中断。因此，SemVer 标准中有一项约定，即<strong>修订号 (patch) 更新不会中断</strong>这种检查。</p>
<p><strong>何时应该使用这个 linter 规则呢？</strong> 显然，对于那些构建并交付给用户的常规应用程序来说，它没有任何意义，因为这些用户看不到或使用任何代码。这条规则<strong>仅对可发布的软件包（publishable packages）有意义</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Groovy翻译系列三】Groovy应用集成]]></title>    <link>https://juejin.cn/post/7573525927793377306</link>    <guid>https://juejin.cn/post/7573525927793377306</guid>    <pubDate>2025-11-17T14:15:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573525927793377306" data-draft-id="7573525927793344538" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Groovy翻译系列三】Groovy应用集成"/> <meta itemprop="keywords" content="Groovy"/> <meta itemprop="datePublished" content="2025-11-17T14:15:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="星火1024"/> <meta itemprop="url" content="https://juejin.cn/user/3353967687906576"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Groovy翻译系列三】Groovy应用集成
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3353967687906576/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    星火1024
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T14:15:09.000Z" title="Mon Nov 17 2025 14:15:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>原文档链接：​<a href="https://link.juejin.cn?target=https%3A%2F%2Fgroovy-lang.org%2Fintegrating.html" target="_blank" title="https://groovy-lang.org/integrating.html" ref="nofollow noopener noreferrer">​https://groovy-lang.org/integrating.html​</a>​</p>
</blockquote>
<p>Groovy是一门基于JVM的语言，堪称动态语言版Java，其各种动态语言特性填补了Java的各种空缺，让人拍案叫绝……有幸接触Groovy，遂手动翻译三篇官方文档，以便于读者从Java到Groovy的快速迁移。</p>
<hr/>
<p>Groovy 语言提出了几种在运行时将自身集成到应用程序（Java 甚至 Groovy）中的方法，从最基本的简单代码执行到最完整的集成缓存和编译器定制。</p>
<blockquote>
<p>本节中编写的所有示例都使用 Groovy，但可以在 Java 中使用相同的集成机制。</p>
</blockquote>






<table><thead><tr><th/></tr></thead></table>
<h4 data-id="heading-0">1.1. Eval</h4>
<p>这个​<code>​groovy.util.Eval​</code>​​类是最简单的方式在运行时动态的执行Groovy。可以使用​<code>​me​</code>​方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> groovy.util.Evalassert Eval.me(<span class="hljs-string">'33*3'</span>) == <span class="hljs-number">99</span>
<span class="hljs-keyword">assert</span> Eval.me(<span class="hljs-string">'"foo".toUpperCase()'</span>) == <span class="hljs-string">'FOO'</span>
</code></pre>
<p>​<code>​Eval​</code>​支持多种参数接收变体来支持简易的表达式：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">assert</span> Eval.x(<span class="hljs-number">4</span>, <span class="hljs-string">'2*x'</span>) == <span class="hljs-number">8</span>                (<span class="hljs-number">1</span>)
<span class="hljs-keyword">assert</span> Eval.me(<span class="hljs-string">'k'</span>, <span class="hljs-number">4</span>, <span class="hljs-string">'2*k'</span>) == <span class="hljs-number">8</span>          (<span class="hljs-number">2</span>)
<span class="hljs-keyword">assert</span> Eval.xy(<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-string">'x*y'</span>) == <span class="hljs-number">20</span>           (<span class="hljs-number">3</span>)
<span class="hljs-keyword">assert</span> Eval.xyz(<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-string">'x*y+z'</span>) == <span class="hljs-number">26</span>     (<span class="hljs-number">4</span>)
</code></pre>





















<table><thead><tr><th><strong>1</strong></th><th>一个绑定了名称为​<code>​x​</code>​参数的简易表达式</th></tr></thead><tbody><tr><td><strong>2</strong></td><td>跟上面的一样，一个绑定了名称为​<code>​k​</code>​参数的简易表达式</td></tr><tr><td><strong>3</strong></td><td>一个绑定了​<code>​x​</code>​​和​<code>​y​</code>​两个绑定参数的简易表达式</td></tr><tr><td><strong>4</strong></td><td>一个绑定了​<code>​x​</code>​​、​<code>​y​</code>​​和​<code>​z​</code>​三个绑定参数的简易表达式</td></tr></tbody></table>
<p>​<code>​Eval​</code>​类使得执行简易的脚本变得容易，但是对于大规模的脚本不行：没有脚本缓存，而且不能执行超过一行的表达式。</p>
<h4 data-id="heading-1">1.2. GroovyShell</h4>
<h5 data-id="heading-2">1.2.1. 多种来源</h5>
<p>​<code>​groovy.lang.GroovyShell​</code>​​类是执行脚本的首选方式，能够缓存生成的脚本实例。尽管​<code>​Eval​</code>​​类能够返回编译后脚本的执行结果，​<code>​GroovyShell​</code>​可以提供更多的选择。</p>
<pre><code class="hljs language-ini" lang="ini">def <span class="hljs-attr">shell</span> = new GroovyShell()                           (<span class="hljs-number">1</span>)
def <span class="hljs-attr">result</span> = shell.evaluate <span class="hljs-string">'3*5'</span>                       (<span class="hljs-number">2</span>)
def <span class="hljs-attr">result2</span> = shell.evaluate(new StringReader(<span class="hljs-string">'3*5'</span>))   (<span class="hljs-number">3</span>)
assert <span class="hljs-attr">result</span> == result2
def <span class="hljs-attr">script</span> = shell.parse <span class="hljs-string">'3*5'</span>                          (<span class="hljs-number">4</span>)
assert script instanceof groovy.lang.Script
assert script.run() == 15                               (5)
</code></pre>

























<table><thead><tr><th><strong>1</strong></th><th>创建一个新的​<code>​GroovyShell​</code>​实例</th></tr></thead><tbody><tr><td><strong>2</strong></td><td>可以作为​<code>​Eval​</code>​直接执行代码</td></tr><tr><td><strong>3</strong></td><td>能够从很多源读取（​<code>​String​</code>​​,​<code>​Reader​</code>​​,​<code>​File​</code>​​,​<code>​InputStream​</code>​）</td></tr><tr><td><strong>4</strong></td><td>可以延迟脚本的执行。使用​<code>​parse​</code>​​方法返回一个​<code>​Script​</code>​实例</td></tr><tr><td><strong>5</strong></td><td>​<code>​Script​</code>​​定义了一个​<code>​run​</code>​方法</td></tr></tbody></table>
<h5 data-id="heading-3">1.2.2. 在脚本和应用间共享数据</h5>
<p>通过使用​<code>​groovy.lang.Binding​</code>​去在脚本和应用间共享数据：</p>
<pre><code class="hljs language-scss" lang="scss">def sharedData = new <span class="hljs-built_in">Binding</span>()                          (<span class="hljs-number">1</span>)
def shell = new <span class="hljs-built_in">GroovyShell</span>(sharedData)                 (<span class="hljs-number">2</span>)
def now = new <span class="hljs-built_in">Date</span>()
sharedData<span class="hljs-selector-class">.setProperty</span>('text', 'I am shared data!')     (<span class="hljs-number">3</span>)
sharedData<span class="hljs-selector-class">.setProperty</span>('date', now)                     (<span class="hljs-number">4</span>)
String result = shell<span class="hljs-selector-class">.evaluate</span>('"At $date, $text"')     (<span class="hljs-number">5</span>)
assert result == "At <span class="hljs-variable">$now</span>, <span class="hljs-selector-tag">I</span> am shared data!"
</code></pre>

























<table><thead><tr><th><strong>1</strong></th><th>创建一个包含共享数据的新​<code>​Binding​</code>​</th></tr></thead><tbody><tr><td><strong>2</strong></td><td>使用共享数据创建一个​<code>​GroovyShell​</code>​</td></tr><tr><td><strong>3</strong></td><td>添加字符串到绑定中</td></tr><tr><td><strong>4</strong></td><td>添加一个日期到绑定中（你可以不必限制于简单的类型）</td></tr><tr><td><strong>5</strong></td><td>执行脚本</td></tr></tbody></table>
<p>注意，也有可以在脚本中写入绑定：</p>
<pre><code class="hljs language-scss" lang="scss">def sharedData = new <span class="hljs-built_in">Binding</span>()                          (<span class="hljs-number">1</span>)
def shell = new <span class="hljs-built_in">GroovyShell</span>(sharedData)                 (<span class="hljs-number">2</span>)

shell<span class="hljs-selector-class">.evaluate</span>('foo=<span class="hljs-number">123</span>')                               (<span class="hljs-number">3</span>)
assert sharedData<span class="hljs-selector-class">.getProperty</span>('foo') == <span class="hljs-number">123</span>             (<span class="hljs-number">4</span>)
</code></pre>





















<table><thead><tr><th><strong>1</strong></th><th>创建一个​<code>​Binding​</code>​实例</th></tr></thead><tbody><tr><td><strong>2</strong></td><td>使用共享数据创建一个新的​<code>​GroovyShell​</code>​</td></tr><tr><td><strong>3</strong></td><td>在绑定中使用一个<strong>未声明的</strong>变量去存储结果</td></tr><tr><td><strong>4</strong></td><td>在回调中读取结果</td></tr></tbody></table>
<p>如果你想使用绑定，一个未声明变量是很重要的。像下面例子一样使用​<code>​def​</code>​​或者​<code>​explicit​</code>​类型将会失败，因为你将会创建一个<em>本地</em>变量：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">def</span> <span class="hljs-variable">sharedData</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Binding</span>()
<span class="hljs-type">def</span> <span class="hljs-variable">shell</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GroovyShell</span>(sharedData)

shell.evaluate(<span class="hljs-string">'int foo=123'</span>)<span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">assert</span> sharedData.getProperty(<span class="hljs-string">'foo'</span>)
} <span class="hljs-keyword">catch</span> (MissingPropertyException e) {
    println <span class="hljs-string">"foo is defined as a local variable"</span>
}
</code></pre>






<table><thead><tr><th/></tr></thead></table>
<blockquote>
<p>你在多线程中使用共享变量时必须非常小心。传递给GroovyShell的Binding实例不是线程安全的，会被所有的脚本共享。</p>
</blockquote>
<p>可以通过利用​<code>​parse​</code>​​返回的​<code>​Script​</code>​​实例来解决​<code>​Binding​</code>​的共享实例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">def</span> <span class="hljs-variable">shell</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GroovyShell</span>()<span class="hljs-type">def</span> <span class="hljs-variable">b1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Binding</span>(x:<span class="hljs-number">3</span>)                       (<span class="hljs-number">1</span>)
<span class="hljs-type">def</span> <span class="hljs-variable">b2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Binding</span>(x:<span class="hljs-number">4</span>)                       (<span class="hljs-number">2</span>)
<span class="hljs-type">def</span> <span class="hljs-variable">script</span> <span class="hljs-operator">=</span> shell.parse(<span class="hljs-string">'x = 2*x'</span>)
script.binding = b1
script.run()
script.binding = b2
script.run()
<span class="hljs-keyword">assert</span> b1.getProperty(<span class="hljs-string">'x'</span>) == <span class="hljs-number">6</span>
<span class="hljs-keyword">assert</span> b2.getProperty(<span class="hljs-string">'x'</span>) == <span class="hljs-number">8</span>
<span class="hljs-keyword">assert</span> b1 != b2
</code></pre>













<table><thead><tr><th><strong>1</strong></th><th>将​<code>​x​</code>​​变量存储在​<code>​b1​</code>​中</th></tr></thead><tbody><tr><td><strong>2</strong></td><td>将​<code>​x​</code>​​变量存储在​<code>​b2​</code>​中</td></tr></tbody></table>
<p>但是，你必须知道你仍在共享<strong>同一脚本实例</strong>。因此，如果你有两个线程处理同一个脚本，则无法使用此技术。在这种情况下，你必须确保创建两个不同的脚本实例：</p>
<pre><code class="hljs language-scss" lang="scss">def shell = new <span class="hljs-built_in">GroovyShell</span>()def b1 = new <span class="hljs-built_in">Binding</span>(x:<span class="hljs-number">3</span>)
def b2 = new <span class="hljs-built_in">Binding</span>(x:<span class="hljs-number">4</span>)
def script1 = shell<span class="hljs-selector-class">.parse</span>('x = <span class="hljs-number">2</span>*x')            (<span class="hljs-number">1</span>)
def script2 = shell<span class="hljs-selector-class">.parse</span>('x = <span class="hljs-number">2</span>*x')            (<span class="hljs-number">2</span>)
assert script1 != script2
script1<span class="hljs-selector-class">.binding</span> = b1                            (<span class="hljs-number">3</span>)
script2<span class="hljs-selector-class">.binding</span> = b2                            (<span class="hljs-number">4</span>)
def t1 = Thread<span class="hljs-selector-class">.start</span> { script1<span class="hljs-selector-class">.run</span>() }         (<span class="hljs-number">5</span>)
def t2 = Thread<span class="hljs-selector-class">.start</span> { script2<span class="hljs-selector-class">.run</span>() }         (<span class="hljs-number">6</span>)
<span class="hljs-selector-attr">[t1,t2]</span>*<span class="hljs-selector-class">.join</span>()                                 (<span class="hljs-number">7</span>)
assert b1<span class="hljs-selector-class">.getProperty</span>('x') == <span class="hljs-number">6</span>
assert b2<span class="hljs-selector-class">.getProperty</span>('x') == <span class="hljs-number">8</span>
assert b1 != b2
</code></pre>

































<table><thead><tr><th><strong>1</strong></th><th>为线程1创建一个实例</th></tr></thead><tbody><tr><td><strong>2</strong></td><td>为线程2创建一个实例</td></tr><tr><td><strong>3</strong></td><td>将第一个绑定分配给脚本1</td></tr><tr><td><strong>4</strong></td><td>将第一个绑定分配给脚本2</td></tr><tr><td><strong>5</strong></td><td>在单独的线程中启动第一个脚本</td></tr><tr><td><strong>6</strong></td><td>在单独的线程中启动第二个脚本</td></tr><tr><td><strong>7</strong></td><td>等待完成</td></tr></tbody></table>
<p>如果你需要像这里这样的线程安全，建议直接使用 GroovyClassLoader。</p>
<h5 data-id="heading-4">1.2.3. 自定义脚本类</h5>
<p>我们可以看到​<code>​parse​</code>​​方法返回一个​<code>​groovy.lang.Script​</code>​​的实例，但是有可能需要去使用一个自定义的类去扩展​<code>​Script​</code>​本身。它可用于为脚本提供额外的行为，如下例所示：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyScript</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Script</span> </span>{
    <span class="hljs-type">String</span> name

    <span class="hljs-type">String</span> greet() {
        <span class="hljs-string">"Hello, $name!"</span>
    }
}
</code></pre>
<p>这个自定义类定义了一个叫做​<code>​name​</code>​​的参数和一个叫做​<code>​greet​</code>​的方法。这个类可以通过一个自定义的配置来被用作脚本的基础类：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.codehaus.groovy.control.<span class="hljs-type">CompilerConfigurationdef</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompilerConfiguration</span>()                                    (<span class="hljs-number">1</span>)
config.scriptBaseClass = <span class="hljs-string">'MyScript'</span>                                         (<span class="hljs-number">2</span>)
<span class="hljs-type">def</span> <span class="hljs-variable">shell</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GroovyShell</span>(<span class="hljs-built_in">this</span>.class.classLoader, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Binding</span>(), config)  (<span class="hljs-number">3</span>)
<span class="hljs-type">def</span> <span class="hljs-variable">script</span> <span class="hljs-operator">=</span> shell.parse(<span class="hljs-string">'greet()'</span>)                                         (<span class="hljs-number">4</span>)
<span class="hljs-keyword">assert</span> script <span class="hljs-keyword">instanceof</span> MyScript
script.setName(<span class="hljs-string">'Michel'</span>)
<span class="hljs-keyword">assert</span> script.run() == <span class="hljs-string">'Hello, Michel!'</span>
</code></pre>





















<table><thead><tr><th><strong>1</strong></th><th>创建一个​<code>​CompilerConfiguration​</code>​实例</th></tr></thead><tbody><tr><td><strong>2</strong></td><td>指定​<code>​MyScript​</code>​作为脚本的基础类</td></tr><tr><td><strong>3</strong></td><td>然后在创建 shell 时使用编译器配置</td></tr><tr><td><strong>4</strong></td><td>该脚本现在可以访问新方法​<code>​greet​</code>​</td></tr></tbody></table>






<table><thead><tr><th/></tr></thead></table>
<blockquote>
<p>你不仅局限于唯一的<em>scriptBaseClass</em>配置。你能够调整任意的编译器配置，包括​<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.groovy-lang.org%2Flatest%2Fhtml%2Fdocumentation%2Fcore-domain-specific-languages.html%23compilation-customizers" target="_blank" title="https://docs.groovy-lang.org/latest/html/documentation/core-domain-specific-languages.html#compilation-customizers" ref="nofollow noopener noreferrer">​compilation customizers​</a>​。</p>
</blockquote>
<h4 data-id="heading-5">1.3. GroovyClassLoader</h4>
<p>在上一节，我们已经展示了​<code>​GroovyShell​</code>​​是一个执行脚本的简单工具，但是除了脚本之外，编译任何东西都变得很复杂。在内部，它使用​<code>​groovy.lang.GroovyClassLoader​</code>​ ，这是运行时编译和加载类的核心。</p>
<p>通过使用​<code>​GroovyClassLoader​</code>​​替代​<code>​GroovyShell​</code>​，你将能够加载类，而不是脚本实例：</p>
<pre><code class="hljs language-ini" lang="ini">import groovy.lang.GroovyClassLoaderdef <span class="hljs-attr">gcl</span> = new GroovyClassLoader()                                           (<span class="hljs-number">1</span>)
def <span class="hljs-attr">clazz</span> = gcl.parseClass(<span class="hljs-string">'class Foo { void doIt() { println "ok" } }'</span>)    (<span class="hljs-number">2</span>)
assert <span class="hljs-attr">clazz.name</span> == <span class="hljs-string">'Foo'</span>                                                  (<span class="hljs-number">3</span>)
def <span class="hljs-attr">o</span> = clazz.newInstance()                                                 (<span class="hljs-number">4</span>)
o.doIt()                                                                    (5)
</code></pre>

























<table><thead><tr><th><strong>1</strong></th><th>创建一个新的​<code>​GroovyClassLoader​</code>​</th></tr></thead><tbody><tr><td><strong>2</strong></td><td>​<code>​parseClass​</code>​​将会返回​<code>​Class​</code>​的实例</td></tr><tr><td><strong>3</strong></td><td>你可以检查返回的类是否真的是脚本中定义的类</td></tr><tr><td><strong>4</strong></td><td>你可以创建一个新的类实例，它不是脚本</td></tr><tr><td><strong>5</strong></td><td>然后调用它的任何方法</td></tr></tbody></table>
<blockquote>
<p>GroovyClassLoader保留了它创建的所有类的引用，因此很容易造成内存泄漏。特别是，如果你执行两次相同的脚本，如果它是一个字符串，那么你将获得两个不同的类！</p>
</blockquote>






<table><thead><tr><th/></tr></thead></table>
<pre><code class="hljs language-ini" lang="ini">import groovy.lang.GroovyClassLoaderdef <span class="hljs-attr">gcl</span> = new GroovyClassLoader()
def <span class="hljs-attr">clazz1</span> = gcl.parseClass(<span class="hljs-string">'class Foo { }'</span>)                                (<span class="hljs-number">1</span>)
def <span class="hljs-attr">clazz2</span> = gcl.parseClass(<span class="hljs-string">'class Foo { }'</span>)                                (<span class="hljs-number">2</span>)
assert <span class="hljs-attr">clazz1.name</span> == <span class="hljs-string">'Foo'</span>                                                 (<span class="hljs-number">3</span>)
assert <span class="hljs-attr">clazz2.name</span> == <span class="hljs-string">'Foo'</span>
assert clazz1 != clazz2                                                     (4)
</code></pre>





















<table><thead><tr><th><strong>1</strong></th><th>动态创建一个名为“Foo”的类</th></tr></thead><tbody><tr><td><strong>2</strong></td><td>使用单独的​<code>​parseClass​</code>​调用创建一个外观相同的类</td></tr><tr><td><strong>3</strong></td><td>确保两个类具有相同的名称</td></tr><tr><td><strong>4</strong></td><td>但它们实际上是不同的！</td></tr></tbody></table>
<p>原因是​<code>​GroovyClassLoader​</code>​不跟踪源文本。如果你想拥有相同的实例，则源<strong>必须</strong>是一个文件，如下例所示：</p>
<pre><code class="hljs language-ini" lang="ini">def <span class="hljs-attr">gcl</span> = new GroovyClassLoader()
def <span class="hljs-attr">clazz1</span> = gcl.parseClass(file)                                           (<span class="hljs-number">1</span>)
def <span class="hljs-attr">clazz2</span> = gcl.parseClass(new File(file.absolutePath))                    (<span class="hljs-number">2</span>)
assert <span class="hljs-attr">clazz1.name</span> == <span class="hljs-string">'Foo'</span>                                                 (<span class="hljs-number">3</span>)
assert <span class="hljs-attr">clazz2.name</span> == <span class="hljs-string">'Foo'</span>
assert <span class="hljs-attr">clazz1</span> == clazz2                                                     (<span class="hljs-number">4</span>)
</code></pre>





















<table><thead><tr><th><strong>1</strong></th><th>从​<code>​文件​</code>​中解析一个类</th></tr></thead><tbody><tr><td><strong>2</strong></td><td>从不同的文件实例解析一个类，但指向同一个物理文件</td></tr><tr><td><strong>3</strong></td><td>确保我们的类具有相同的名称</td></tr><tr><td><strong>4</strong></td><td>但现在，它们是同一个实例</td></tr></tbody></table>
<p>使用一个​<code>​File​</code>​​作为输入，​<code>​GroovyClassLoader​</code>​是有能力<strong>缓存</strong>生成的类文件的，这样能够避免在运行时创建多个同源类。</p>
<h4 data-id="heading-6">1.4. GroovyScriptEngine</h4>
<p>​<code>​groovy.util.GroovyScriptEngine​</code>​​类为有脚本依赖的应用程序提供了灵活的脚本重载基础。虽然​<code>​GroovyShell​</code>​​专注于独立脚本，而​<code>​GroovyClassLoader​</code>​​处理任何 Groovy 类的动态编译和加载，但是​<code>​GroovyScriptEngine​</code>​​将在​<code>​GroovyClassLoader​</code>​之上添加一个层来处理脚本依赖关系和重新加载。</p>
<p>为了说明这一点，我们将创建一个脚本引擎并在无限循环中执行代码。首先，你需要创建一个目录，其中包含以下脚本：</p>
<p>ReloadingTest.groovy</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Greeter</span> {
    <span class="hljs-title class_">String</span> <span class="hljs-title function_">sayHello</span>(<span class="hljs-params"/>) {
        def greet = <span class="hljs-string">"Hello, world!"</span>
        greet
    }
}<span class="hljs-keyword">new</span> <span class="hljs-title class_">Greeter</span>()
</code></pre>
<p>然后你可以使用​<code>​GroovyScriptEngine​</code>​执行此代码：</p>
<pre><code class="hljs language-scss" lang="scss">def binding = new <span class="hljs-built_in">Binding</span>()
def engine = new <span class="hljs-built_in">GroovyScriptEngine</span>([tmpDir.toURI()<span class="hljs-selector-class">.toURL</span>()] as URL<span class="hljs-selector-attr">[]</span>)          (<span class="hljs-number">1</span>)while (true) {
    def greeter = engine<span class="hljs-selector-class">.run</span>('ReloadingTest.groovy', binding)                   (<span class="hljs-number">2</span>)
    println greeter<span class="hljs-selector-class">.sayHello</span>()                                                  (<span class="hljs-number">3</span>)
    Thread<span class="hljs-selector-class">.sleep</span>(<span class="hljs-number">1000</span>)
}
</code></pre>

















<table><thead><tr><th><strong>1</strong></th><th>创建一个脚本引擎，它将在我们的源目录中查找源</th></tr></thead><tbody><tr><td><strong>2</strong></td><td>执行脚本，它将返回一个​<code>​Greeter​</code>​的实例</td></tr><tr><td><strong>3</strong></td><td>打印问候语</td></tr></tbody></table>
<p>此时，你应该会看到每秒打印一条消息：</p>
<p>Hello, world!Hello, world!...</p>
<p>在<strong>不中断</strong>脚本执行的情况下，现在将​<code>​ReloadingTest​</code>​文件的内容替换为：</p>
<p>ReloadingTest.groovy</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Greeter</span> {
    <span class="hljs-title class_">String</span> <span class="hljs-title function_">sayHello</span>(<span class="hljs-params"/>) {
        def greet = <span class="hljs-string">"Hello, Groovy!"</span>
        greet
    }
}<span class="hljs-keyword">new</span> <span class="hljs-title class_">Greeter</span>()
</code></pre>
<p>消息应更改为：</p>
<p>Hello, world!...Hello, Groovy!Hello, Groovy!...</p>
<p>但也可能依赖于另一个脚本。为了说明这一点，在同一目录中创建以下文件，而不中断正在执行的脚本：</p>
<p>Dependency.groovy</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Dependency</span> {
    <span class="hljs-type">String</span> message = <span class="hljs-string">'Hello, dependency 1'</span>
}
</code></pre>
<p>并像这样更新​<code>​ReloadingTest​</code>​脚本：</p>
<p>ReloadingTest.groovy</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Dependencyclass</span> <span class="hljs-title class_">Greeter</span> {
    <span class="hljs-title class_">String</span> <span class="hljs-title function_">sayHello</span>(<span class="hljs-params"/>) {
        def greet = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dependency</span>().<span class="hljs-property">message</span>
        greet
    }
}<span class="hljs-keyword">new</span> <span class="hljs-title class_">Greeter</span>()
</code></pre>
<p>这一次，消息应该变为：</p>
<p>Hello, Groovy!...Hello, dependency 1!Hello, dependency 1!...</p>
<p>作为最后一个测试，你可以更新​<code>​Dependency.groovy​</code>​​文件，而无需触及​<code>​ReloadingTest​</code>​文件：</p>
<p>Dependency.groovy</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Dependency</span> {
    <span class="hljs-type">String</span> message = <span class="hljs-string">'Hello, dependency 2'</span>
}
</code></pre>
<p>你应该观察到依赖文件已重新加载：</p>
<p>Hello, dependency 1!...Hello, dependency 2!Hello, dependency 2!</p>
<h4 data-id="heading-7">1.5. CompilationUnit</h4>
<p>最终，通过直接依赖​<code>​org.codehaus.groovy.control.CompilationUnit​</code>​类，可以在编译期间执行更多操作。该类负责确定编译的各个步骤，并允许你引入新步骤，甚至在各个阶段停止编译。例如，对于联合编译器，存根生成是如何完成的。</p>
<p>但是，不建议覆盖​<code>​CompilationUnit​</code>​，只有在没有其他标准解决方案有效的情况下才应该这样做。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[救命！Spring 启动又崩了？！循环依赖又踩坑]]></title>    <link>https://juejin.cn/post/7573523709300408355</link>    <guid>https://juejin.cn/post/7573523709300408355</guid>    <pubDate>2025-11-17T15:58:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573523709300408355" data-draft-id="7573512056089608227" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="救命！Spring 启动又崩了？！循环依赖又踩坑"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-17T15:58:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="秧歌star519"/> <meta itemprop="url" content="https://juejin.cn/user/2385260356310428"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            救命！Spring 启动又崩了？！循环依赖又踩坑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2385260356310428/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    秧歌star519
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T15:58:10.000Z" title="Mon Nov 17 2025 15:58:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">循环依赖问题：当循环依赖遇上 AOP</h2>
<p>最近工作中遇到一个业务场景：教师修改试卷的正确答案后，系统需要<strong>异步重新批改</strong>所有学生已提交的答案。</p>
<ul>
<li>主服务（实现类 A）负责更新标准答案并触发异步任务；</li>
<li>异步服务（服务 B）执行批量重判，并调用 A 中的辅助方法（如判断答案正误、计算得分等）。</li>
</ul>
<p>结果应用启动时报错：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">BeanCurrentlyInCreationException:</span> 
Requested bean <span class="hljs-built_in">is</span> currently <span class="hljs-keyword">in</span> creation: 
<span class="hljs-built_in">Is</span> there an unresolvable circular reference?
</code></pre>
<p>这是一个典型的 <strong>循环依赖 + AOP（@Async / @Transactional）</strong> 问题。正常情况下，Spring 能通过三级缓存解决普通循环依赖，但一旦涉及 AOP，就无能为力了。下面我将从原理到实践完整梳理这个问题的来龙去脉和可行的解决方案。</p>
<hr/>
<h3 data-id="heading-1">根本原因：AOP 代理与三级缓存的冲突</h3>
<p>要理解为什么失败，必须先搞清楚 <strong>Spring 的代理机制</strong> 和 <strong>Bean 创建流程</strong>。</p>
<h4 data-id="heading-2">Spring AOP 代理机制详解</h4>
<h5 data-id="heading-3">什么是代理对象？</h5>
<ul>
<li><strong>目标对象（Target）</strong>：你写的实现类实例（如 <code>OrderService</code>）。</li>
<li><strong>代理对象（Proxy）</strong>：Spring 动态生成的一个“包装类”，外观与目标对象一致（实现相同接口或继承相同父类），但方法调用会被拦截，在前后插入额外逻辑（如事务、异步、日志等）。</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">placeOrder</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 扣库存</span>
        <span class="hljs-comment">// 建订单</span>
        <span class="hljs-comment">// 扣款</span>
    }
}
</code></pre>
<p>其调用过程如下：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Client
    participant Proxy as 代理对象
    participant Target as 原始OrderService

    Client-&gt;&gt;Proxy: placeOrder()
    Proxy-&gt;&gt;Proxy: AOP检查 → 开启数据库事务
    Proxy-&gt;&gt;Target: 调用原始placeOrder()方法
    Target--&gt;&gt;Proxy: 方法执行完毕
    Proxy-&gt;&gt;Proxy: 提交/回滚事务
    Proxy--&gt;&gt;Client: 返回结果
</code></pre>
<h5 data-id="heading-4">Spring 的两种代理方式</h5>




















<table><thead><tr><th>代理类型</th><th>触发条件</th><th>实现方式</th></tr></thead><tbody><tr><td>JDK 动态代理</td><td>目标类实现了至少一个接口</td><td>生成 <code>$Proxy0</code> 类，实现相同接口，通过 <code>InvocationHandler.invoke()</code> 拦截</td></tr><tr><td>CGLIB 代理</td><td>目标类没有接口</td><td>生成目标类的子类，重写非 <code>final</code> 方法，在方法中插入拦截逻辑</td></tr></tbody></table>
<blockquote>
<p>JDK 代理是“兄弟关系”（同接口），CGLIB 是“父子关系”（继承）。</p>
</blockquote>
<hr/>
<h4 data-id="heading-5">代理对象何时创建？</h4>
<p>Spring 在启动时会扫描所有 Bean，检查是否包含 AOP 注解（如 <code>@Async</code>、<code>@Transactional</code>）。这个过程由 <strong>BeanPostProcessor（后置处理器）</strong> 完成，例如：</p>
<ul>
<li><code>AsyncAnnotationBeanPostProcessor</code>（处理 <code>@Async</code>）</li>
<li><code>InfrastructureAdvisorAutoProxyCreator</code>（处理 <code>@Transactional</code> 等）</li>
</ul>
<p>它们会在 <strong>Bean 初始化阶段（post-process）</strong> 判断：</p>
<ul>
<li>类或方法上是否有 AOP 注解？</li>
<li>是否启用了相关功能（如 <code>@EnableAsync</code>）？</li>
<li>应该使用 JDK 还是 CGLIB 代理？</li>
</ul>
<p><strong>关键点</strong>：<br/>
<strong>代理对象的创建不能在构造函数阶段完成</strong>，因为：</p>
<ul>
<li>注解元数据需通过反射读取；</li>
<li>代理类型需根据类结构动态决定；</li>
<li>AOP 配置（如切面表达式）也需在初始化后才能评估。</li>
</ul>
<p>因此，<strong>代理对象是在 Bean 实例化 + 属性填充 + 初始化完成后才生成的</strong>。</p>
<hr/>
<h4 data-id="heading-6">三级缓存机制（无 AOP 场景）</h4>
<p>对于普通单例 Bean，Spring 使用三级缓存解决循环依赖：</p>
<ul>
<li><strong>一级缓存（<code>singletonObjects</code>）</strong>：存放完全初始化好的 Bean。</li>
<li><strong>二级缓存（<code>earlySingletonObjects</code>）</strong>：存放“早期引用”（已实例化，未初始化）。</li>
<li><strong>三级缓存（<code>singletonFactories</code>）</strong>：存放 <code>ObjectFactory</code>，用于按需生成早期引用。</li>
</ul>
<blockquote>
<p>核心思想：允许在 Bean 尚未完全初始化前，将其“原始对象”提前暴露给其他依赖方。</p>
</blockquote>
<h5 data-id="heading-7">普通循环依赖解决流程（A → B，B → A）</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Spring as Spring容器
    participant A as Service A (QuestionAnswerService)
    participant B as Service B (AsyncRegradeTaskService)

    Spring-&gt;&gt;A: 1. 创建 A（new）
    A--&gt;&gt;Spring: 2. 将 A 的 ObjectFactory 放入三级缓存
    Spring-&gt;&gt;A: 3. 填充 A 属性 → 需要 B
    Spring-&gt;&gt;B: 4. 创建 B（new）
    B--&gt;&gt;Spring: 5. 将 B 的 ObjectFactory 放入三级缓存
    Spring-&gt;&gt;B: 6. 填充 B 属性 → 需要 A
    Spring-&gt;&gt;Spring: 7. 从三级缓存获取 A 的工厂
    Spring-&gt;&gt;A: 8. 调用 factory.getObject() → 获取原始 A
    Spring--&gt;&gt;B: 9. 将原始 A 注入 B
    B--&gt;&gt;Spring: 10. B 初始化完成 → 放入一级缓存
    Spring--&gt;&gt;A: 11. 将完整 B 注入 A
    A--&gt;&gt;Spring: 12. A 初始化完成 → 放入一级缓存

    Note right of Spring: ✅ 循环依赖成功解决
</code></pre>
<p>成功的关键：<strong>注入的是原始对象（raw instance）</strong>，不需要代理。</p>
<hr/>
<h4 data-id="heading-8">含 AOP 的循环依赖为何失败？</h4>
<p>当 B 带有 <code>@Async</code>（或 <code>@Transactional</code>）时，Spring 必须为其创建 <strong>代理对象</strong>。但代理只能在 B <strong>完全初始化后</strong>生成。</p>
<p>而在循环依赖中：</p>
<ul>
<li>A 创建时需要 B；</li>
<li>B 创建时需要 A；</li>
<li>Spring 试图从三级缓存中提供 B 的“早期引用” → 但此时只有 <strong>原始 B</strong>，没有 <strong>代理 B</strong>；</li>
<li>A 注入的是原始 B，调用 <code>@Async</code> 方法时 <strong>不会触发异步</strong>（因为没走代理）；</li>
<li>更严重的是：<strong>Spring 在创建 B 时发现它需要代理，但又无法在“半成品”阶段生成代理</strong> → 抛出异常。</li>
</ul>
<h5 data-id="heading-9">含 AOP 的循环依赖失败流程</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Spring as Spring容器
    participant A as Service A
    participant B as Service B (@Async)

    Spring-&gt;&gt;A: 1. 创建 A（new）
    A--&gt;&gt;Spring: 2. A 的工厂放入三级缓存
    Spring-&gt;&gt;A: 3. 填充 A 属性 → 需要 B
    Spring-&gt;&gt;B: 4. 创建 B（new）
    B--&gt;&gt;Spring: 5. B 的工厂放入三级缓存
    Spring-&gt;&gt;B: 6. 填充 B 属性 → 需要 A
    Spring-&gt;&gt;Spring: 7. 从三级缓存获取 A 的原始对象
    Spring--&gt;&gt;B: 8. 将原始 A 注入 B
    Spring-&gt;&gt;B: 9. B 初始化 → 需为 @Async 创建代理
    Note over Spring,B: ⚠️ 代理创建需 B 完整，但 B 尚未完成！
    Spring-&gt;&gt;A: 10. A 继续初始化 → 需要完整 B
    Spring-&gt;&gt;B: 11. 请求 B 实例
    Note over Spring: B 仍在创建中 → 循环依赖未解
    Spring--&gt;&gt;A: 12. 抛出 BeanCurrentlyInCreationException

    Note right of Spring: ❌ 启动失败：无法生成 B 的代理
</code></pre>
<blockquote>
<p>即使 A 不带 AOP，只要 B 带 <code>@Async</code>，且互相依赖，就会失败。</p>
</blockquote>
<hr/>
<h3 data-id="heading-10">代码示例</h3>
<h4 data-id="heading-11">主服务（Service A）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">QuestionAnswerService</span> { <span class="hljs-comment">// ← A</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> AsyncRegradeTaskService asyncTaskService; <span class="hljs-comment">// 依赖 B</span>

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">modifyStandardAnswer</span><span class="hljs-params">(AnswerUpdateRequest request)</span> {
        updateStandardAnswerInDB(request);
        asyncTaskService.regradeAllSubmissionsAsync(request.getQuestionId(), request.getGroupId());
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateStandardAnswerInDB</span><span class="hljs-params">(AnswerUpdateRequest request)</span> {
        <span class="hljs-comment">// DB 更新</span>
    }

    <span class="hljs-comment">// 被异步服务调用的辅助方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">evaluateSubmission</span><span class="hljs-params">(String studentAnswer, String correctAnswer)</span> {
        <span class="hljs-keyword">return</span> studentAnswer.equals(correctAnswer);
    }
}
</code></pre>
<h4 data-id="heading-12">异步服务（Service B）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncRegradeTaskService</span> { <span class="hljs-comment">// ← B</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> QuestionAnswerService mainService; <span class="hljs-comment">// 依赖 A</span>

    <span class="hljs-meta">@Async</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;Void&gt; <span class="hljs-title function_">regradeAllSubmissionsAsync</span><span class="hljs-params">(Long questionId, Long groupId)</span> {
        List&lt;UserSubmission&gt; submissions = fetchSubmissions(questionId, groupId);
        <span class="hljs-keyword">for</span> (UserSubmission sub : submissions) {
            <span class="hljs-type">boolean</span> <span class="hljs-variable">correct</span> <span class="hljs-operator">=</span> mainService.evaluateSubmission(sub.getContent(), getCorrectAnswer(questionId));
            <span class="hljs-comment">// ...</span>
        }
        <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(<span class="hljs-literal">null</span>);
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-13">解决方案一：使用 <code>@Lazy</code>（临时修复）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">QuestionAnswerService</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-meta">@Lazy</span> <span class="hljs-comment">// 👈 延迟加载</span>
    <span class="hljs-keyword">private</span> AsyncRegradeTaskService asyncTaskService;
}
</code></pre>
<blockquote>
<p><strong>深入理解：为什么 <code>@Lazy</code> 能解决 AOP 循环依赖？</strong></p>
<p>表面上看，<code>@Lazy</code> 和三级缓存都涉及“非直接注入真实对象”，但它们的机制和目的截然不同：</p>
<ul>
<li><strong>三级缓存</strong> 在 Bean 创建过程中暴露一个<strong>原始对象（raw instance）</strong>，用于解决普通循环依赖；</li>
<li><strong><code>@Lazy</code></strong> 则注入一个<strong>懒加载代理（lazy proxy）</strong>，该代理在首次方法调用时才从容器获取真实 Bean。</li>
</ul>
<p>问题的关键在于：<strong>Spring 的 AOP 代理（如 <code>@Async</code>）必须在目标 Bean 完全初始化后才能创建</strong>。而在循环依赖场景中，若两个 Bean 互相依赖且其中一方需代理，Spring 就无法在“半成品”阶段提供有效的代理对象——三级缓存只能提供原始对象，而原始对象不具备 AOP 行为。</p>
<p><code>@Lazy</code> 的巧妙之处在于：<strong>它将依赖的解析时机从“Bean 创建期”推迟到“方法首次调用期”</strong>。此时，被依赖的 Bean 已经完成初始化并存在于一级缓存中，其代理也已生成，从而安全地满足 AOP 要求。</p>
<p>换句话说，<code>@Lazy</code> 并没有改变 AOP 对“完整对象”的需求，而是<strong>绕开了创建阶段的依赖死锁</strong>。</p>
</blockquote>
<hr/>
<h3 data-id="heading-14">解决方案二：重构设计（推荐长期方案）</h3>
<p>抽取公共逻辑到独立服务：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GradingLogicService</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">evaluateSubmission</span><span class="hljs-params">(String studentAnswer, String correctAnswer)</span> {
        <span class="hljs-keyword">return</span> studentAnswer.equals(correctAnswer);
    }
}
</code></pre>
<ul>
<li>A 和 B 都依赖 <code>GradingLogicService</code>；</li>
<li>彻底消除 A ↔ B 的双向依赖。</li>
</ul>
<p>✅ 代码更清晰、可测试、可维护。</p>
<hr/>
<h3 data-id="heading-15">补充：关于 Spring 代理的两个常见误区</h3>
<h4 data-id="heading-16">1. 只有容器管理的对象才是代理</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 正确</span>
<span class="hljs-type">OrderService</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> context.getBean(OrderService.class); <span class="hljs-comment">// 代理</span>

<span class="hljs-comment">// 错误</span>
<span class="hljs-type">OrderService</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderService</span>(); <span class="hljs-comment">// 无代理，@Transactional 失效</span>
</code></pre>
<h4 data-id="heading-17">2. 同类方法调用绕过代理</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyService</span> {
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">methodA</span><span class="hljs-params">()</span> { ... }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">methodB</span><span class="hljs-params">()</span> {
        methodA(); <span class="hljs-comment">// this.methodA()，不走代理，事务失效！</span>
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-18">总结</h3>




















<table><thead><tr><th>场景</th><th>Spring 能否解决循环依赖</th><th>原因</th></tr></thead><tbody><tr><td>普通单例 Bean（无 AOP）</td><td>✅ 能</td><td>三级缓存提供原始对象作为早期引用</td></tr><tr><td>含 <code>@Async</code> / <code>@Transactional</code> 的 Bean</td><td>❌ 不能</td><td>代理需完整对象，但循环依赖要求提前暴露“半成品”</td></tr></tbody></table>
<h4 data-id="heading-19">最佳实践建议：</h4>
<ul>
<li>优先通过 <strong>职责拆分 + 服务抽取</strong> 消除循环依赖；</li>
<li>临时方案可用 <code>@Lazy</code>，但不宜长期依赖；</li>
<li>避免在 Service 内部直接调用自身带 AOP 的方法；</li>
<li>所有 Service 必须由 Spring 容器管理，禁止 <code>new</code>。</li>
</ul>
<hr/>
<h3 data-id="heading-20">经验总结</h3>
<blockquote>
<p>“能用 <code>@Lazy</code> 解决的问题，往往说明你的模块耦合太紧。”<br/>
—— 好的设计，本就不该有循环依赖。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uniapp源码解析（Vue3/Vite版）]]></title>    <link>https://juejin.cn/post/7573524348129116223</link>    <guid>https://juejin.cn/post/7573524348129116223</guid>    <pubDate>2025-11-17T10:55:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573524348129116223" data-draft-id="7572389069705707530" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uniapp源码解析（Vue3/Vite版）"/> <meta itemprop="keywords" content="前端,Vue.js,uni-app"/> <meta itemprop="datePublished" content="2025-11-17T10:55:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="夏目友人爱吃豆腐"/> <meta itemprop="url" content="https://juejin.cn/user/550207995511645"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uniapp源码解析（Vue3/Vite版）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/550207995511645/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    夏目友人爱吃豆腐
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T10:55:00.000Z" title="Mon Nov 17 2025 10:55:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">背景</h3>
<p>项目中遇到一个需求，路由不写在pages.json文件中，需要在解析pages.json文件前，把写在其他地方的路由，复制到pages.json中。</p>
<p>因此我需要了解uniapp中pages.json的解析逻辑，借此机会，正好解析一下uniapp的vite框架源码，搞起搞起。</p>
<h3 data-id="heading-1">步骤一 uni命令做了什么？</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41767c8295dc418ba05571c15471ccaf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSP55uu5Y-L5Lq654ix5ZCD6LGG6IWQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763981699&amp;x-signature=NdYQvyYskE3PDQ1R9hvXA4FePx0%3D" alt="image.png" loading="lazy"/></p>
<p>按照<a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Fquickstart-cli.html" target="_blank" title="https://uniapp.dcloud.net.cn/quickstart-cli.html" ref="nofollow noopener noreferrer">uniapp官方教程</a>，创建uniapp-vite新项目=》pnpm i安装依赖</p>
<h5 data-id="heading-2">找"dev:h5": "uni"的命令</h5>
<p>scipts的执行路径在node_modules/.bin。找到uni.CMD(window系统是这个），在uni.CMD中，找到执行文件是\node_modules@dcloudio\vite-plugin-uni\bin\uni.js。uni.js执行../dist/cli/index.js文件</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08ec5a70ae2343c5b3e2359c761975a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSP55uu5Y-L5Lq654ix5ZCD6LGG6IWQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763981699&amp;x-signature=kxwD%2FoReqyuKAxev7b2was8lxCs%3D" alt="image.png" loading="lazy"/></p>
<p>\node_modules@dcloudio\vite-plugin-uniceshi\dist\cli\index.js是核心文件。主要是处理命令中携带的参数。例如：打包后文件的目录。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a371d7bbc3474e56a3fe38637f30aca1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSP55uu5Y-L5Lq654ix5ZCD6LGG6IWQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763981699&amp;x-signature=7M7VnapucaF8bHWVnQ%2Fdl%2B%2B7fts%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a45063365a54fe6b1778321def2f7f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSP55uu5Y-L5Lq654ix5ZCD6LGG6IWQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763981699&amp;x-signature=dOd0LMB2d9j0NaVANcqB5hAX9Dk%3D" alt="image.png" loading="lazy"/></p>
<p>由于我执行的是最基础的命令"dev:h5": "uni"。这个我可以不理，直接看配置完文件后，uniapp做了什么。追寻过程不赘述。最终执行的是\node_modules@dcloudio\vite-plugin-uni\dist\cli\server.js文件里面的createServer方法。也就是启动了vite的本地服务。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13d6488e12da4de6a091bd07c9fe5482~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSP55uu5Y-L5Lq654ix5ZCD6LGG6IWQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763981699&amp;x-signature=s%2BH%2FJlQQrqvBdMgW2drvRaxdBII%3D" alt="image.png" loading="lazy"/></p>
<p><strong>总结:</strong>"dev:h5": "uni"命令作用是将命令行的参数进行来配置，最终启动了vite的服务。由于"dev:h5": "uni"命令是最基础的命令，因此启动的也是最基础的vite服务。整个过程中，没有对代码文件进行任何处理。那么说明uniapp是通过vite插件对代码文件进行处理。</p>
<h3 data-id="heading-3">步骤二 uniapp的vite插件做了什么？</h3>
<p>uniapp的vite插件十分简单，vite.config.ts文件引入一个vite-plugin-uni插件即可。不过随着深入探索，发现并不简单。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">//vite.config.ts文件</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">"vite"</span>;
<span class="hljs-keyword">import</span> uni <span class="hljs-keyword">from</span> <span class="hljs-string">"@dcloudio/vite-plugin-uni"</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>:  [<span class="hljs-title function_">uni</span>()],
});

</code></pre>
<p>查阅@dcloudio/vite-plugin-uni的文件，发现编译后的代码有点难读懂。上uniapp官网找源码，没找到。官网没有，那就在GitHub找，GitHub也没有，那就上gitee找。本想gitee希望不大，没想到源码就在gitee。nice！<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fdcloud%2Funi-app" target="_blank" title="https://gitee.com/dcloud/uni-app" ref="nofollow noopener noreferrer">源码链接</a></p>
<p>我仅知道这三个源码渠道，大佬如果有其他渠道跪求推荐一下，多条路子。</p>
<p>下载源码uni-app-next。源码版本是：3.0.0-alpha-4060120250328001。那么我们的示例也pnpm更新到此版本，避免差异。</p>
<p>源码pnpm i按照完依赖后。我图省事，将vite-plugin-uni插件直接复制到示例代码上，直接开干。事实证明歪路子看起来省事，实则麻烦更多。大家别学我，总之还是正道好。正道应该是按照别人插件库提供的测试方法，进行调试。如果舍不得弃之前的示例，可以将整个示例复制过去，然后使用pnpm的link方法，改变依赖引用路径即可。</p>
<p>以上准备就绪后，开始对着源码，解析vite-plugin-uni插件。
插件路径：packages\vite-plugin-uni\src\index.ts</p>
<p>先打印插件最终的结果看看。发现vite-plugin-uni最终分裂出了一堆插件。我的思路是：查看是如何分裂出来的，然后根据我现在的业务需求，找到pages.json的处理插件，了解其原理看看怎么调整。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/290f792cf6e74a978afee00907f5139a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSP55uu5Y-L5Lq654ix5ZCD6LGG6IWQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763981699&amp;x-signature=h7hN8avVJae0EJPetc75pSH42g0%3D" alt="image.png" loading="lazy"/></p>
<p>对packages\vite-plugin-uni\src\index.ts进行解读，入口方法是uniPlugin()。追寻路径是uniPlugin()=&gt;createPlugins()=&gt;./utils/plugin.ts目录=&gt;initExtraPlugins()=&gt;resolvePluginsByCliRoot()=&gt;resolvePlugins()。</p>
<p>resolvePluginsByCliRoot和resolvePlugins方法就是vite-plugin-uni分裂出了一堆插件的始作俑者。
resolvePluginsByCliRoot读取项目的package.json文件，导入项目全部的依赖。resolvePlugins方法则是筛选出需要用到的依赖。筛选的方式是根据依赖的package.json文件，比如@dcloudio/uni-h5依赖目录下的package.json文件。判断package.json内容是否含有"uni-app"这个字段。</p>
<p>举个例子：</p>
<pre><code class="hljs language-ts" lang="ts">{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"@dcloudio/uni-h5"</span>,
  <span class="hljs-string">"version"</span>: <span class="hljs-string">"3.0.0-alpha-4060120250328001"</span>
   <span class="hljs-comment">//这个字段是关键！！！</span>
    <span class="hljs-comment">//这个字段是关键！！！</span>
     <span class="hljs-comment">//这个字段是关键！！！</span>
 <span class="hljs-string">"uni-app"</span>: {
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"uni-h5"</span>,
    <span class="hljs-string">"apply"</span>: [
      <span class="hljs-string">"app"</span>,
      <span class="hljs-string">"h5"</span>,
      <span class="hljs-string">"mp-weixin"</span>,
    ],
    <span class="hljs-string">"uvue"</span>: <span class="hljs-literal">true</span>
  },
  <span class="hljs-string">"dependencies"</span>: {
    <span class="hljs-string">"@dcloudio/uni-cli-shared"</span>: <span class="hljs-string">"workspace:*"</span>,
    <span class="hljs-string">"detect-port"</span>: <span class="hljs-string">"^1.5.1"</span>,
    <span class="hljs-string">"express"</span>: <span class="hljs-string">"catalog:"</span>,
  }
} 
</code></pre>
<p>筛选出含有"uni-app"的依赖后，还需要通过[uni-app][apply]进行二次筛选。比如上面示例中，apply对象包含"app"， "h5","mp-weixin"。则是在app，h5,微信小程序三种环境下，都需要运行此依赖。若apply只有“h5”,则只有编译H5才会使用此依赖。</p>
<p><strong>总结:</strong> vite-plugin-uni除了导入自身的插件，还会根据不同的运行环境（比如H5，微信小程序）导入项目package.json中有特殊标记的依赖。</p>
<p>这样的设计思路，可以简化vite插件引入，vite.config.ts文件中只需要引入一个插件即可。且后续更新，也可以按照模块化进行更新，不需要把全部的内容都放到一个插件中。vite-plugin-uni插件的作用是制定了一套插件引入的规则，大家可以按照这个规则导入或开发所需要的插件。</p>
<h3 data-id="heading-4">步骤三 uniapp是怎么运作的？</h3>
<p>由于我运行的环境是H5，我仅用H5进行举例。大家可根据此思路，解析自己所在运行环境的源码。</p>
<p>写个简单插件看一下代码文件编译的路径</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">Plugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"vite"</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>): <span class="hljs-title class_">Plugin</span> {
    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"测试插件"</span>,
        <span class="hljs-title function_">transform</span>(<span class="hljs-params">code, id</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'查看编译的文件顺序和代码'</span>, id, code)
        },
    };

}
</code></pre>
<p>路径和vite的入口文件一致，都是从@/src/main.ts开始。main.ts经过h5-manifest-json插件的作用，编译结果如下图：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5494bff7791f4a7cacea6061493efc03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSP55uu5Y-L5Lq654ix5ZCD6LGG6IWQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763981699&amp;x-signature=TKjN9gOU2Yf5%2FaGJR%2F3oPtSNiPo%3D" alt="image.png" loading="lazy"/></p>
<p>可以看到h5-manifest-json插件除了增加了一些配置外，还引入了pages.json文件，这正是我想了解的部分。</p>
<p>翻阅了一下源码，找到了处理pages.json的插件是uni:h5-pages-json。这插件的作用大概是加入了各种全局的方法、样式、变量等，把pages.json的路径，转换成页面的路由。插件编译结果如下图：：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7a05e15963b4093bdb7c49624cde55e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSP55uu5Y-L5Lq654ix5ZCD6LGG6IWQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763981699&amp;x-signature=VxISBWf5ZNqPDUsPuo%2BnG4EyrdQ%3D" alt="image.png" loading="lazy"/></p>
<p>其他运行环境如微信小程序，APP等，估计还需要更多的插件进行改造。但H5不需要做太多的转义，直接按vite正常服务启动即可，uniapp的运作思路，大致就是如此。我就不一一解析每个插件的作用了。</p>
<p>依据我项目的需求，我原本是想着做一个插件，在uniapp插件之前生效，对pages.json文件进行改造，然后结束后再恢复原样，这样就能完全和uniapp的插件进行解构，但这样做弊端其实很多。但不和uniapp插件进行解耦，我又担心uniapp插件，我不可控。</p>
<p>这时候解析源码的好处就来了，我在uni:h5-pages-json插件中，发现了一个方法指向pages.json文件的方法defineUniPagesJsonPlugin。原来uniapp有专门的指向方法。这我就不用担心uniapp他们引入pages.json的方式变化，可以轻松的在uniapp插件修改pages.json之前，我们自己先行一步进行修改。</p>
<p>我的插件代码：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">"fs"</span>;
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">"path"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">Plugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"vite"</span>;
<span class="hljs-keyword">import</span> {
  defineUniPagesJsonPlugin
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@dcloudio/uni-cli-shared'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>): <span class="hljs-title class_">Plugin</span> {
<span class="hljs-comment">//使用uniapp提供的封装方法</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">defineUniPagesJsonPlugin</span>(<span class="hljs-function">(<span class="hljs-params">opts</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">name</span>: <span class="hljs-string">"vite-plugin-handleFile"</span>,
      <span class="hljs-attr">enforce</span>: <span class="hljs-string">'pre'</span>,<span class="hljs-comment">//uniapp插件也是提前生效的，因此我们也要如此</span>
      <span class="hljs-title function_">transform</span>(<span class="hljs-params">code, id</span>) {
        <span class="hljs-comment">//使用uniapp提供的方法，找到pages.json文件，对pages.json进行处理</span>
        <span class="hljs-keyword">if</span> (opts.<span class="hljs-title function_">filter</span>(id)) {
            .....
            ....
            ....<span class="hljs-comment">//项目业务代码</span>
        }
      },
    };
  })
}
</code></pre>
<h4 data-id="heading-5">结语</h4>
<p>这篇uniapp源码写得简约，甚至可以说是简陋，哈哈哈。不过，思路应该是没有问题的。掌握解析源码的思路，后面的自然就水到渠成了。</p>
<p>个人总结的思路大致是：</p>
<ol>
<li>找一个需求（有实际的业务需求最好），带着问题去找结果。</li>
<li>找到源码，跑起来，做好测试环境（这个非常重要，代码要不停的console，打印查看各个节点的结果，才能知道是怎么运作的）。</li>
<li>解析源码是怎样开局的。</li>
<li>根据需求开发一个相关联的插件或内容。</li>
</ol>
<p>现在微信小程序也很火，挖个坑，下次有空，也解析uniapp的微信小程序看看。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[wangeditor自定义扩展设置图片宽高]]></title>    <link>https://juejin.cn/post/7573273271799644200</link>    <guid>https://juejin.cn/post/7573273271799644200</guid>    <pubDate>2025-11-17T11:26:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573273271799644200" data-draft-id="7570978150010339366" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="wangeditor自定义扩展设置图片宽高"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-17T11:26:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="yannick_liu"/> <meta itemprop="url" content="https://juejin.cn/user/1732486057956782"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            wangeditor自定义扩展设置图片宽高
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1732486057956782/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    yannick_liu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T11:26:46.000Z" title="Mon Nov 17 2025 11:26:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">背景</h4>
<p>当前项目中用到wangeditor 插件， 需要扩展图片宽高</p>
<p>项目背景 ： vue2</p>
<h4 data-id="heading-1">项目最终效果</h4>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6602f80274d4f06b836b8953a11a393~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeWFubmlja19saXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763983606&amp;x-signature=WjzveT3xAc77N0Kpsf2gSC5gQtM%3D" alt="image.png" width="100%" loading="lazy"/>
<h4 data-id="heading-2">wangeditor的安装</h4>
<pre><code class="hljs language-bash" lang="bash">npm install wangeditor/editor
npm install wangeditor/editor-for-vue
</code></pre>
<h4 data-id="heading-3">基本使用</h4>
<pre><code class="hljs language-xml" lang="xml">// 可直接运行
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">el-dialog</span>
    <span class="hljs-attr">:visible.sync</span>=<span class="hljs-string">"dialogVisible"</span>
    <span class="hljs-attr">:close-on-click-modal</span>=<span class="hljs-string">"false"</span>
    <span class="hljs-attr">fullscreen</span>
  &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">title</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"editor-title1 flex justify-between"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"font-bold"</span>&gt;</span>标题：{{ title }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"flex item-center"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-color-picker</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"color"</span> @<span class="hljs-attr">change</span>=<span class="hljs-string">"handleColorChange"</span> /&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"dialogVisible = false"</span>&gt;</span>取消<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"!disabled"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleSubmit"</span>&gt;</span>确定<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"article-content"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"dialogVisible"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"left-box"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Toolbar</span> <span class="hljs-attr">:editor</span>=<span class="hljs-string">"editor"</span> <span class="hljs-attr">:default-config</span>=<span class="hljs-string">"toolbarConfig"</span> <span class="hljs-attr">:mode</span>=<span class="hljs-string">"mode"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Editor</span>
          <span class="hljs-attr">v-model</span>=<span class="hljs-string">"html"</span>
          <span class="hljs-attr">style</span>=<span class="hljs-string">"height: 82vh; overflow-y: hidden;"</span>
          <span class="hljs-attr">:default-config</span>=<span class="hljs-string">"editorConfig"</span>
          <span class="hljs-attr">:mode</span>=<span class="hljs-string">"mode"</span>
          @<span class="hljs-attr">onCreated</span>=<span class="hljs-string">"onCreated"</span>
        /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"right-box"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"preview-content"</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ background: color, padding: '16px' }"</span> <span class="hljs-attr">v-html</span>=<span class="hljs-string">"html"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">el-dialog</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { uploadCmsImage } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/api/cms/index'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Editor</span>, <span class="hljs-title class_">Toolbar</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@wangeditor/editor-for-vue'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Boot</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@wangeditor/editor'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ImageWidthMenu</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./a.js'</span>

<span class="hljs-comment">// 注册插件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">components</span>: { <span class="hljs-title class_">Editor</span>, <span class="hljs-title class_">Toolbar</span> },  <span class="hljs-comment">// 引入必须组件</span>
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">color</span>: <span class="hljs-string">'#000'</span>, <span class="hljs-comment">// 设置背景色，便于在不同的背景中显示</span>
      <span class="hljs-attr">title</span>: <span class="hljs-string">''</span>,
      <span class="hljs-attr">disabled</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">dialogVisible</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">editor</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">html</span>: <span class="hljs-string">''</span>,
      <span class="hljs-attr">showUploading</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">toolbarConfig</span>: {},
      <span class="hljs-attr">editorConfig</span>: {},
      <span class="hljs-attr">mode</span>: <span class="hljs-string">'default'</span> <span class="hljs-comment">// or 'simple'</span>
    }
  },
  <span class="hljs-title function_">created</span>(<span class="hljs-params"/>) {
   <span class="hljs-comment">// 核心代码， 自定义扩展图片宽度 ----start----</span>
    <span class="hljs-keyword">const</span> imageWidth75 = {
      <span class="hljs-attr">key</span>: <span class="hljs-string">'imageWidth75'</span>,
      <span class="hljs-title function_">factory</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ImageWidthMenu</span>(<span class="hljs-string">'75%'</span>)
      }
    }
    <span class="hljs-keyword">const</span> imageWidth80 = {
      <span class="hljs-attr">key</span>: <span class="hljs-string">'imageWidth80'</span>,
      <span class="hljs-title function_">factory</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ImageWidthMenu</span>(<span class="hljs-string">'80%'</span>)
      }
    }
    <span class="hljs-keyword">const</span> imageWidth85 = {
      <span class="hljs-attr">key</span>: <span class="hljs-string">'imageWidth85'</span>,
      <span class="hljs-title function_">factory</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ImageWidthMenu</span>(<span class="hljs-string">'85%'</span>)
      }
    }
    <span class="hljs-title class_">Boot</span>.<span class="hljs-title function_">registerMenu</span>(imageWidth75)
    <span class="hljs-title class_">Boot</span>.<span class="hljs-title function_">registerMenu</span>(imageWidth80)
    <span class="hljs-title class_">Boot</span>.<span class="hljs-title function_">registerMenu</span>(imageWidth85)
     <span class="hljs-comment">// 核心代码， 自定义扩展图片宽度 ----end----</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">editorConfig</span> = {
      <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'请输入内容...'</span>,
      <span class="hljs-attr">MENU_CONF</span>: {
      <span class="hljs-comment">//  自定义图片上传接口</span>
        <span class="hljs-attr">uploadImage</span>: {
          <span class="hljs-attr">customUpload</span>: <span class="hljs-title function_">async</span>(file, insertFn) =&gt; {
            <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleCustomUpload</span>(file, insertFn)
          }
        },
      <span class="hljs-comment">//  自定义视频上传接口</span>
        <span class="hljs-attr">uploadVideo</span>: {
          <span class="hljs-attr">customUpload</span>: <span class="hljs-title function_">async</span>(file, insertFn) =&gt; {
            <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleCustomUpload</span>(file, insertFn)
          }
        }
      },
      <span class="hljs-attr">hoverbarKeys</span>: {
        <span class="hljs-attr">image</span>: {
          <span class="hljs-attr">menuKeys</span>: [
            <span class="hljs-string">'imageWidth30'</span>, 
            <span class="hljs-string">'imageWidth50'</span>,
            <span class="hljs-string">'imageWidth75'</span>,  <span class="hljs-comment">// 核心代码， 自定义扩展图片宽度</span>
            <span class="hljs-string">'imageWidth80'</span>, <span class="hljs-comment">// 核心代码， 自定义扩展图片宽度</span>
            <span class="hljs-string">'imageWidth85'</span>, <span class="hljs-comment">// 核心代码， 自定义扩展图片宽度</span>
            <span class="hljs-string">'imageWidth100'</span>,
            <span class="hljs-string">'editImage'</span>,
            <span class="hljs-string">'viewImageLink'</span>,
            <span class="hljs-string">'deleteImage'</span>
          ]
        }
      }
    }
  },
  <span class="hljs-title function_">beforeDestroy</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> editor = <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>
    <span class="hljs-keyword">if</span> (editor == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>
    editor.<span class="hljs-title function_">destroy</span>() <span class="hljs-comment">// 组件销毁时，及时销毁编辑器</span>
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-comment">// 打开弹窗</span>
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">open</span>(<span class="hljs-params">data, disabled</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">title</span> = data.<span class="hljs-property">title</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">html</span> = data.<span class="hljs-property">content</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">disabled</span> = disabled
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">dialogVisible</span> = <span class="hljs-literal">true</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">color</span> = <span class="hljs-string">'#000'</span>
    },

    <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleCustomUpload</span>(<span class="hljs-params">file, insertFn</span>) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>()
        params.<span class="hljs-title function_">append</span>(<span class="hljs-string">'file'</span>, file)
        params.<span class="hljs-title function_">append</span>(<span class="hljs-string">'path'</span>, <span class="hljs-string">'cms'</span>)
        <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">uploadCmsImage</span>(params)
        <span class="hljs-title function_">insertFn</span>(res.<span class="hljs-property">data</span>.<span class="hljs-property">url</span>, file.<span class="hljs-property">name</span>, res.<span class="hljs-property">data</span>.<span class="hljs-property">url</span>)
      } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e)
      }
    },

    <span class="hljs-title function_">onCreated</span>(<span class="hljs-params">editor</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">seal</span>(editor) <span class="hljs-comment">// 一定要用 Object.seal() ，否则会报错</span>
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">const</span> textContainer = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.w-e-text-container'</span>)
        <span class="hljs-keyword">if</span> (textContainer) {
          textContainer.<span class="hljs-property">style</span>.<span class="hljs-property">fontSize</span> = <span class="hljs-string">'24px'</span>
        }
      }, <span class="hljs-number">100</span>)
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementsByClassName</span>(<span class="hljs-string">'w-e-text-container'</span>)[<span class="hljs-number">0</span>].<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'style'</span>, <span class="hljs-string">`background-color: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.color}</span>;`</span>)
    },

    <span class="hljs-comment">// 提交数据</span>
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleSubmit</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.$emit(<span class="hljs-string">'updateContent'</span>, <span class="hljs-string">'edit'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">html</span>)
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">dialogVisible</span> = <span class="hljs-literal">false</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">html</span> = <span class="hljs-string">''</span>
    },

    <span class="hljs-title function_">handleColorChange</span>(<span class="hljs-params">color</span>) {
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementsByClassName</span>(<span class="hljs-string">'w-e-text-container'</span>)[<span class="hljs-number">0</span>].<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'style'</span>, <span class="hljs-string">`background-color: <span class="hljs-subst">${color}</span>;`</span>)
    }

  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"@wangeditor/editor/dist/css/style.css"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span>&gt;</span><span class="css">
// 弹窗
<span class="hljs-selector-class">.editor-dialog1</span> {
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">0</span>;

  <span class="hljs-selector-class">.el-dialog__headerbtn</span> {
    <span class="hljs-attribute">display</span>: none;
  }

  <span class="hljs-selector-class">.el-dialog__body</span> {
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-number">16px</span>;
  }
}

<span class="hljs-selector-class">.w-e-text-container</span> <span class="hljs-selector-tag">h1</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">29px</span> <span class="hljs-meta">!important</span>;
}

<span class="hljs-selector-class">.w-e-text-container</span> <span class="hljs-selector-tag">h2</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">27px</span> <span class="hljs-meta">!important</span>;
}

<span class="hljs-selector-class">.w-e-text-container</span> <span class="hljs-selector-tag">h3</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">25px</span> <span class="hljs-meta">!important</span>;
}

<span class="hljs-selector-tag">video</span> {
  <span class="hljs-attribute">display</span>: block;
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
// 内容
<span class="hljs-selector-class">.article-content</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">height</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-number">100vh</span> - <span class="hljs-number">90px</span>);
  <span class="hljs-attribute">justify-content</span>: space-between;
  <span class="hljs-attribute">box-sizing</span>: border-box;

  <span class="hljs-selector-class">.left-box</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">49%</span>;
    <span class="hljs-attribute">border-right</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ccc</span>;
    <span class="hljs-attribute">padding-right</span>: <span class="hljs-number">10px</span>;
  }

  <span class="hljs-selector-class">.right-box</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">50%</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
    <span class="hljs-attribute">overflow-y</span>: auto;
  }
}

//标题
<span class="hljs-selector-class">.editor-title1</span> {
  <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">2px</span> solid <span class="hljs-number">#ddd</span>;
  <span class="hljs-attribute">padding-bottom</span>: <span class="hljs-number">10px</span>;
  <span class="hljs-attribute">box-sizing</span>: border-box;

  <span class="hljs-selector-class">.el-color-picker</span> {
    <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">10px</span>;
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>

</code></pre>
<p>核心代码， 扩展代码</p>
<pre><code class="hljs language-a.js" lang="a.js">import { DomEditor, SlateTransforms } from '@wangeditor/editor'
export default class ImageWidthMenu {
  constructor(width) {
    this.title = width || '70%'
    this.tag = 'button'
    this.width = width || '70%'
    // this.iconSvg = '&lt;svg width="18" height="18" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"&gt;&lt;path d="M832 192H192c-17.7 0-32 14.3-32 32v576c0 17.7 14.3 32 32 32h640c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32z m-40 560H232V264h560v488z" fill="#333"/&gt;&lt;/svg&gt;'
  }

  getValue(editor) {
    return ''
  }

  // 获取选中的图片节点
  getSelectedNode(editor) {
    const { selection } = editor
    if (!selection) return null
    return DomEditor.getSelectedNodeByType(editor, 'image')
  }

  // 检查是否激活（当前宽度是否为指定宽度）
  isActive(editor) {
    return false
    // const node = this.getSelectedNode(editor)
    // if (!node) return false
    // return node.style.width === this.width
  }

  // 没有选中图片则禁用

  isDisabled(editor) {
    if (editor.selection == null) return true

    const imageNode = this.getSelectedNode(editor)
    if (imageNode == null) {
      // 选区未处于 image node ，则禁用
      return true
    }
    return false
  }

  exec(editor) {
    if (this.isDisabled(editor)) return

    const imageNode = this.getSelectedNode(editor)
    if (imageNode == null) return

    // 隐藏 hoverbar
    const hoverbar = DomEditor.getHoverbar(editor)
    if (hoverbar) hoverbar.hideAndClean()

    const { style = {}} = imageNode // 假设 imageNode 是 ImageElement 类型
    const props = {
      style: {
        ...style,
        width: this.width, // 使用传入的 width 参数
        height: '' // 清空 height
      }
    }

    SlateTransforms.setNodes(editor, props, {
      match: n =&gt; DomEditor.checkNodeType(n, 'image')
    })
  }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[鸿蒙开发：支持自定义组件的跑马灯]]></title>    <link>https://juejin.cn/post/7573549302620045355</link>    <guid>https://juejin.cn/post/7573549302620045355</guid>    <pubDate>2025-11-18T01:52:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573549302620045355" data-draft-id="7573549302619979819" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="鸿蒙开发：支持自定义组件的跑马灯"/> <meta itemprop="keywords" content="HarmonyOS,Android,iOS"/> <meta itemprop="datePublished" content="2025-11-18T01:52:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员一鸣"/> <meta itemprop="url" content="https://juejin.cn/user/1398234520239095"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            鸿蒙开发：支持自定义组件的跑马灯
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1398234520239095/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员一鸣
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T01:52:38.000Z" title="Tue Nov 18 2025 01:52:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">前言</h2>
<p>最近的项目中用到了，可以连续滚动的跑马灯，并且滚动的不仅仅是纯文字，还有图片等其他的组件，那么这种情况下，系统为我们提供的Text组件或者Marquee组件就无法来实现了，只能自己自定义了。</p>
<p>我们先看下自定义后的效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/528c04f8d8dc4e04ac7eb28c606e747c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764035558&amp;x-signature=ovZlPfPRgVSDm%2BvOzBm3rZylIYI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/940f02a3055445f18f7aeb27f115b10f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764035558&amp;x-signature=eV66ilK5RvxLRbAl3CI7zz2YGIk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a36b4e1cb5e43b699cadc2f4aa47fff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764035558&amp;x-signature=8SmxC5F2gGKeaOQFL2WNL1B6z1o%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9443fdc9c86b4e84ae0d5b3db836b086~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764035558&amp;x-signature=LmpM5RRS7zd7Qo4JG8KeIqAb3mA%3D" alt="" loading="lazy"/></p>
<p>总体而言，自定义之后的跑马灯，无论是纵向滚动还是横向滚动，是连续滚动还是停顿滚动，基本上都实现了，可以说，满足了实际开发中的大多数场景，那么如何实现以上的效果呢?其实很简单，一个Swiper组件和一个属性动画就可以实现了。</p>
<p>那么在自定义实现之前，有两个问题询问大家，<strong>第一个问题是，系统的Text组件或者Marquee组件，支持纵向滚动吗？</strong></p>
<p><strong>第二个问题是，如果我想连续滚动图文结构的内容，或者自定义组件滚动，系统是否为我们提供了可用组件？</strong></p>
<p>可以明确的是，以上两个问题的答案都是否定的，系统的Text组件或者Marquee组件，只支持文本滚动，并且也支持横向滚动，所以，如果你想实现非文本滚动，或者纵向滚动，只能自己动手来实现。</p>
<p>本篇文章的大致内容如下：</p>
<p><strong>1、停顿跑马灯实现</strong></p>
<p><strong>2、连续跑马灯实现</strong></p>
<p><strong>3、marquee组件全实现</strong></p>
<p><strong>4、相关总结</strong></p>
<h2 data-id="heading-1">停顿跑马灯实现</h2>
<p>所谓的停顿，就是跑马灯数据，暂停一些时间，然后再去轮动下一个，周而复始的展示；这种方式实现起来最简单，相信聪明的你，一下就能想起来了如何实现，没错，就是使用Swiper组件。</p>
<p>系统的Swiper组件，一般用于轮播图的实现，但是可以发现，这个暂停的跑马灯，其实就是一个轮播图。</p>
<p>横向也好，纵向也好，通过vertical属性便可轻松搞定，为true就纵向，fasle就是横向；对于时间上的控制，可以使用interval属性来设置。</p>
<p>简单的案例代码如下：</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"> <span class="hljs-title class_">Swiper</span>() {
          <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">marqueeData</span>, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">Object</span>, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">marqueeLayout</span>(item, index)
          })
        }
        .<span class="hljs-title function_">vertical</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">marqueeDirection</span> == <span class="hljs-title class_">MarqueeDirection</span>.<span class="hljs-property">vertical</span> ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>)
        .<span class="hljs-title function_">autoPlay</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">autoPlay</span>) <span class="hljs-comment">//是否是自动循环</span>
        .<span class="hljs-title function_">loop</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">isLoop</span>)
        .<span class="hljs-title function_">interval</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">interval</span>) <span class="hljs-comment">//间隔时间</span>
        .<span class="hljs-title function_">indicator</span>(<span class="hljs-literal">false</span>)
        .<span class="hljs-title function_">disableSwipe</span>(<span class="hljs-literal">true</span>)
</code></pre>
<p>Swiper组件是支持任意的自定义组件的，所以，如果你的项目中有停顿跑马灯效果的话，完全可以进行使用。</p>
<h2 data-id="heading-2">连续跑马灯实现</h2>
<p>连续的跑马灯，就是一直滚动，不存在中间停顿的时间，上一个滚动完成之后，接着就滚动下一个，纯文本的横向滚动，我们可以使用系统的Text组件或者Marquee组件来实现，如果滚动的是非文本，那么就需要自定义来实现了。</p>
<p>自定义起来也是非常的简单，只需要两个属性便可以搞定，一个是平移属性动画，一个是设置动画参数，如果是横向，那么就设置x坐标，如果是纵向，就设置y坐标。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"> .<span class="hljs-title function_">translate</span>({ <span class="hljs-attr">y</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">offsetY</span> })
            .<span class="hljs-title function_">animation</span>({
              <span class="hljs-attr">duration</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">interval</span>,
              <span class="hljs-attr">curve</span>: <span class="hljs-title class_">Curve</span>.<span class="hljs-property">Linear</span>, <span class="hljs-comment">// 线性速度</span>
              <span class="hljs-attr">iterations</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">isLoop</span> ? -<span class="hljs-number">1</span> : <span class="hljs-variable language_">this</span>.<span class="hljs-property">iterations</span>, <span class="hljs-comment">// 无限循环</span>
              <span class="hljs-attr">playMode</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">marqueeFromStart</span> ? <span class="hljs-title class_">PlayMode</span>.<span class="hljs-property">Normal</span> : <span class="hljs-title class_">PlayMode</span>.<span class="hljs-property">Reverse</span>, <span class="hljs-comment">// 单向播放</span>
            })
</code></pre>
<p>无论是纵向移动还是横向移动，所移动的距离，一定是整个组件的距离，需要自己动态来计算，比如纵向滚动，单个组件高度为50，共有5个组件需要轮动，那就是5*5，也就是轮动的组件数量乘以单个组件的高度。</p>
<h2 data-id="heading-3">marquee组件全实现</h2>
<p>无论连续还是停顿，文本还是非文本，目前这些功能我全部已经封装完毕，发布到了中心仓库中，大家可以直接依赖使用。</p>
<p>地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fohpm.openharmony.cn%2F%23%2Fcn%2Fdetail%2F%40abner%252Fmarquee" target="_blank" title="https://ohpm.openharmony.cn/#/cn/detail/@abner%2Fmarquee" ref="nofollow noopener noreferrer">ohpm.openharmony.cn/#/cn/detail…</a></p>
<h3 data-id="heading-4">快速使用</h3>
<p>方式一：在Terminal窗口中，执行如下命令安装三方包，DevEco Studio会自动在工程的oh-package.json5中自动添加三方包依赖。</p>
<p><strong>建议：在使用的模块路径下进行执行命令。</strong></p>
<pre><code class="hljs language-TypeScript" lang="TypeScript">ohpm install <span class="hljs-meta">@abner</span>/marquee
</code></pre>
<p>方式二：在工程模块的oh-package.json5中设置三方包依赖，配置示例如下：</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-string">"dependencies"</span>: { <span class="hljs-string">"@abner/marquee"</span>: <span class="hljs-string">"^1.0.0"</span>}
</code></pre>
<h3 data-id="heading-5">代码使用</h3>
<h4 data-id="heading-6">1、纯文字跑马灯</h4>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-title class_">MarqueeView</span>({
  <span class="hljs-attr">marqueeText</span>: <span class="hljs-string">"我是一段纯文本内容，主要用来展示跑马灯效果，来吧，我们一起看一下吧"</span>,
})
</code></pre>
<p><strong>属性介绍</strong></p>


















































<table><thead><tr><th><strong>属性</strong></th><th><strong>类型</strong></th><th><strong>概述</strong></th></tr></thead><tbody><tr><td>marqueeText</td><td>string/Resource</td><td>跑马灯文本数据</td></tr><tr><td>marqueeTextAttribute</td><td>MarqueeTextAttribute</td><td>跑马灯文本属性，设置颜色大小等</td></tr><tr><td>marqueeStart</td><td>boolean</td><td>控制跑马灯播放和停止，true播放，false暂停</td></tr><tr><td>marqueeTextStep</td><td>number</td><td>滚动动画文本滚动步长。默认值：4.0vp</td></tr><tr><td>marqueeFromStart</td><td>boolean</td><td>设置文本从头开始滚动或反向滚动。true表示从头开始滚动，false表示反向滚动。默认值：true</td></tr><tr><td>marqueeTextDelay</td><td>number</td><td>设置每次滚动的时间间隔。默认值：0单位：毫秒</td></tr><tr><td>marqueeTextLoop</td><td>number</td><td>设置重复滚动的次数，小于等于零时无限循环。默认值：-1</td></tr><tr><td>marqueeTextFadeout</td><td>boolean</td><td>设置文字超长时的渐隐效果。true表示支持渐隐效果，false表示不支持渐隐效果。</td></tr></tbody></table>
<p><strong>MarqueeTextAttribute</strong></p>



































<table><thead><tr><th><strong>属性</strong></th><th><strong>类型</strong></th><th><strong>概述</strong></th></tr></thead><tbody><tr><td>fontColor</td><td>ResourceColor</td><td>跑马灯文本颜色</td></tr><tr><td>fontSize</td><td>number / string/ Resource</td><td>跑马灯文本颜色</td></tr><tr><td>fontFamily</td><td>string / Resource</td><td>字体族。默认字体'HarmonyOS Sans'。</td></tr><tr><td>fontStyle</td><td>FontStyle</td><td>字体样式。默认值：FontStyle.Normal</td></tr><tr><td>fontWeight</td><td>number / FontWeight / ResourceStr</td><td>文本的字体粗细</td></tr></tbody></table>
<h4 data-id="heading-7">2、纵向停顿跑马灯</h4>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-meta">@Entry</span>
  <span class="hljs-meta">@Component</span>
  struct <span class="hljs-title class_">VerticalPausePage</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-attr">marqueeDataArray</span>: <span class="hljs-built_in">string</span>[] = [
      <span class="hljs-string">"公告：我是测试消息第一条"</span>,
      <span class="hljs-string">"公告：我是测试消息第二条"</span>,
      <span class="hljs-string">"公告：我是测试消息第三条"</span>
    ]

    <span class="hljs-comment">/**
   *AUTHOR:AbnerMing
   *INTRODUCE:可以是任意布局
   */</span>
    <span class="hljs-meta">@Builder</span>
    <span class="hljs-title function_">marqueeLayout</span>(<span class="hljs-params">item: <span class="hljs-built_in">string</span>, _: <span class="hljs-built_in">number</span></span>) {
      <span class="hljs-title class_">Row</span>() {
        <span class="hljs-title class_">SymbolGlyph</span>($r(<span class="hljs-string">'sys.symbol.bell_fill'</span>))
          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">18</span>)
          .<span class="hljs-title function_">renderingStrategy</span>(<span class="hljs-title class_">SymbolRenderingStrategy</span>.<span class="hljs-property">SINGLE</span>)
          .<span class="hljs-title function_">fontColor</span>([<span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span>])
          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">5</span> })
        <span class="hljs-title class_">Text</span>(item)
          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">16</span>)
          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)
          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">5</span> })
      }.<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>)
    }

    <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
      <span class="hljs-title class_">RelativeContainer</span>() {
        <span class="hljs-title class_">ActionBar</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">"纵向停顿跑马灯"</span> })

        <span class="hljs-title class_">Column</span>() {
          <span class="hljs-title class_">MarqueeView</span>({
            <span class="hljs-attr">marqueeData</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">marqueeDataArray</span>, <span class="hljs-comment">//可以传递任意类型数据数组</span>
            <span class="hljs-attr">marqueeType</span>: <span class="hljs-title class_">MarqueeType</span>.<span class="hljs-property">pause</span>,
            <span class="hljs-attr">interval</span>:<span class="hljs-number">1000</span>,
            <span class="hljs-attr">marqueeLayout</span>: <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">Object</span>, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
              <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">marqueeLayout</span>(item <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>, index)
            }
          })
        }.<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">color</span>: <span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span> })
          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">right</span>: <span class="hljs-number">10</span> })
          .<span class="hljs-title function_">alignRules</span>({
            <span class="hljs-attr">center</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span> },
            <span class="hljs-attr">middle</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span> }
          })
      }
      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
    }
  }
</code></pre>
<p><strong>属性介绍</strong></p>


















































<table><thead><tr><th><strong>属性</strong></th><th><strong>类型</strong></th><th><strong>概述</strong></th></tr></thead><tbody><tr><td>marqueeData</td><td>Object[]</td><td>跑马灯数据数组</td></tr><tr><td>marqueeLayout</td><td>@BuilderParam</td><td>用于传递跑马灯自定义组件，可以自定义@Builder来实现</td></tr><tr><td>isLoop</td><td>boolean</td><td>是否是循环播放，默认true为循环</td></tr><tr><td>interval</td><td>number</td><td>跑马灯间隔时间,默认是3000毫秒</td></tr><tr><td>autoPlay</td><td>boolean</td><td>是否是自动播放，默认true，是</td></tr><tr><td>marqueeType</td><td>MarqueeType</td><td>跑马灯类型，默认为文本类型，MarqueeType.text，pause：停顿类型，continuous：连续类型</td></tr><tr><td>iterations</td><td>number</td><td>循环次数，默认无限次</td></tr><tr><td>marqueeStart</td><td>boolean</td><td>true播放，false暂停</td></tr></tbody></table>
<h4 data-id="heading-8">3、纵向连续跑马灯</h4>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-meta">@Entry</span>
  <span class="hljs-meta">@Component</span>
  struct <span class="hljs-title class_">VerticalContinuousPage</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-attr">marqueeDataArray</span>: <span class="hljs-built_in">string</span>[] = [
      <span class="hljs-string">"公告：我是测试消息第一条"</span>,
      <span class="hljs-string">"公告：我是测试消息第二条"</span>,
      <span class="hljs-string">"公告：我是测试消息第三条"</span>,
      <span class="hljs-string">"公告：我是测试消息第四条"</span>,
      <span class="hljs-string">"公告：我是测试消息第五条"</span>
    ]

    <span class="hljs-comment">/**
   *AUTHOR:AbnerMing
   *INTRODUCE:可以是任意布局
   */</span>
    <span class="hljs-meta">@Builder</span>
    <span class="hljs-title function_">marqueeLayout</span>(<span class="hljs-params">item: <span class="hljs-built_in">string</span>, _: <span class="hljs-built_in">number</span></span>) {
      <span class="hljs-title class_">Row</span>() {
        <span class="hljs-title class_">SymbolGlyph</span>($r(<span class="hljs-string">'sys.symbol.bell_fill'</span>))
          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">18</span>)
          .<span class="hljs-title function_">renderingStrategy</span>(<span class="hljs-title class_">SymbolRenderingStrategy</span>.<span class="hljs-property">SINGLE</span>)
          .<span class="hljs-title function_">fontColor</span>([<span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span>])
          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">5</span> })
        <span class="hljs-title class_">Text</span>(item)
          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">16</span>)
          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)
          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">5</span> })
      }.<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>)
    }

    <span class="hljs-comment">/**
   *AUTHOR:AbnerMing
   *INTRODUCE:可以是任意布局
   */</span>
    <span class="hljs-meta">@Builder</span>
    <span class="hljs-title function_">marqueeText</span>(<span class="hljs-params">item: <span class="hljs-built_in">string</span>, _: <span class="hljs-built_in">number</span></span>) {
      <span class="hljs-title class_">Text</span>(item)
        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">16</span>)
        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)
        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">5</span> })
        .<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>)

    }

    <span class="hljs-comment">/**
   *AUTHOR:AbnerMing
   *INTRODUCE:可以是任意布局
   */</span>
    <span class="hljs-meta">@Builder</span>
    <span class="hljs-title function_">marqueeLayout2</span>(<span class="hljs-params">item: <span class="hljs-built_in">string</span>, _: <span class="hljs-built_in">number</span></span>) {
      <span class="hljs-title class_">Column</span>() {
        <span class="hljs-title class_">Image</span>(<span class="hljs-string">"https://loveharmony.oss-cn-beijing.aliyuncs.com/banner/banner_01.jpg"</span>)
          .<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)
          .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)
        <span class="hljs-title class_">Text</span>(item)
          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">16</span>)
          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)
          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">5</span>, <span class="hljs-attr">top</span>: <span class="hljs-number">10</span> })
      }.<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)
        .<span class="hljs-title function_">padding</span>(<span class="hljs-number">10</span>)
    }

    <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
      <span class="hljs-title class_">Column</span>() {
        <span class="hljs-title class_">ActionBar</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">"纵向连续跑马灯"</span> })

        <span class="hljs-comment">//纯文本</span>
        <span class="hljs-title class_">MarqueeView</span>({
          <span class="hljs-attr">marqueeData</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">marqueeDataArray</span>, <span class="hljs-comment">//可以传递任意类型数据数组</span>
          <span class="hljs-attr">marqueeType</span>: <span class="hljs-title class_">MarqueeType</span>.<span class="hljs-property">continuous</span>, <span class="hljs-comment">//连续滚动</span>
          <span class="hljs-attr">marqueeLayout</span>: <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">Object</span>, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">marqueeText</span>(item <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>, index)
          }
        }).<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">color</span>: <span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span> })

        <span class="hljs-comment">//自定义布局1</span>
        <span class="hljs-title class_">MarqueeView</span>({
          <span class="hljs-attr">marqueeData</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">marqueeDataArray</span>, <span class="hljs-comment">//可以传递任意类型数据数组</span>
          <span class="hljs-attr">marqueeType</span>: <span class="hljs-title class_">MarqueeType</span>.<span class="hljs-property">continuous</span>, <span class="hljs-comment">//连续滚动</span>
          <span class="hljs-attr">marqueeLayout</span>: <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">Object</span>, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">marqueeLayout</span>(item <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>, index)
          }
        }).<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">color</span>: <span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span> })
          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">20</span> })

        <span class="hljs-comment">//自定义布局2</span>
        <span class="hljs-title class_">MarqueeView</span>({
          <span class="hljs-attr">marqueeData</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">marqueeDataArray</span>, <span class="hljs-comment">//可以传递任意类型数据数组</span>
          <span class="hljs-attr">marqueeType</span>: <span class="hljs-title class_">MarqueeType</span>.<span class="hljs-property">continuous</span>, <span class="hljs-comment">//连续滚动</span>
          <span class="hljs-attr">marqueeLayout</span>: <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">Object</span>, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">marqueeLayout2</span>(item <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>, index)
          }
        }).<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">color</span>: <span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span> })
          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">20</span> })

      }.<span class="hljs-title function_">padding</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">20</span>, <span class="hljs-attr">right</span>: <span class="hljs-number">20</span> })
        .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
    }
  }
</code></pre>
<h4 data-id="heading-9">4、横向停顿跑马灯</h4>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-meta">@Entry</span>
  <span class="hljs-meta">@Component</span>
  struct <span class="hljs-title class_">HorizontalPausePage</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-attr">marqueeDataArray</span>: <span class="hljs-built_in">string</span>[] = [
      <span class="hljs-string">"公告：我是测试消息第一条"</span>,
      <span class="hljs-string">"公告：我是测试消息第二条"</span>,
      <span class="hljs-string">"公告：我是测试消息第三条"</span>
    ]

    <span class="hljs-comment">/**
   *AUTHOR:AbnerMing
   *INTRODUCE:可以是任意布局
   */</span>
    <span class="hljs-meta">@Builder</span>
    <span class="hljs-title function_">marqueeLayout</span>(<span class="hljs-params">item: <span class="hljs-built_in">string</span>, index: <span class="hljs-built_in">number</span></span>) {
      <span class="hljs-title class_">Row</span>() {
        <span class="hljs-title class_">SymbolGlyph</span>($r(<span class="hljs-string">'sys.symbol.bell_fill'</span>))
          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">18</span>)
          .<span class="hljs-title function_">renderingStrategy</span>(<span class="hljs-title class_">SymbolRenderingStrategy</span>.<span class="hljs-property">SINGLE</span>)
          .<span class="hljs-title function_">fontColor</span>([<span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span>])
          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">5</span> })
        <span class="hljs-title class_">Text</span>(item)
          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">16</span>)
          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)
          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">5</span> })
      }.<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>)
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>) <span class="hljs-comment">//内容居中</span>
    }

    <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
      <span class="hljs-title class_">Column</span>() {
        <span class="hljs-title class_">ActionBar</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">"横向停顿跑马灯"</span> })
        <span class="hljs-title class_">Column</span>() {
          <span class="hljs-title class_">MarqueeView</span>({
            <span class="hljs-attr">marqueeData</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">marqueeDataArray</span>, <span class="hljs-comment">//可以传递任意类型数据数组</span>
            <span class="hljs-attr">marqueeDirection</span>: <span class="hljs-title class_">MarqueeDirection</span>.<span class="hljs-property">horizontal</span>, <span class="hljs-comment">//横向滚动</span>
            <span class="hljs-attr">marqueeType</span>: <span class="hljs-title class_">MarqueeType</span>.<span class="hljs-property">pause</span>,
            <span class="hljs-attr">marqueeLayout</span>: <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">Object</span>, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
              <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">marqueeLayout</span>(item <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>, index)
            }
          })
        }.<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">color</span>: <span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span> })
          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">right</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">top</span>: <span class="hljs-number">50</span> })
      }
      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
    }
  }
</code></pre>
<h4 data-id="heading-10">5、横向连续跑马灯</h4>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-meta">@Entry</span>
  <span class="hljs-meta">@Component</span>
  struct <span class="hljs-title class_">HorizontalContinuousPage</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-attr">marqueeDataArray</span>: <span class="hljs-built_in">string</span>[] = [
      <span class="hljs-string">"公告：我是测试消息第一条"</span>,
      <span class="hljs-string">"公告：我是测试消息第二条"</span>,
      <span class="hljs-string">"公告：我是测试消息第三条"</span>
    ]

    <span class="hljs-comment">/**
   *AUTHOR:AbnerMing
   *INTRODUCE:可以是任意布局
   */</span>
    <span class="hljs-meta">@Builder</span>
    <span class="hljs-title function_">marqueeText</span>(<span class="hljs-params">item: <span class="hljs-built_in">string</span>, _: <span class="hljs-built_in">number</span></span>) {
      <span class="hljs-title class_">Text</span>(item)
        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">16</span>)
        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)
        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">5</span> })
        .<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>)

    }

    <span class="hljs-comment">/**
   *AUTHOR:AbnerMing
   *INTRODUCE:可以是任意布局
   */</span>
    <span class="hljs-meta">@Builder</span>
    <span class="hljs-title function_">marqueeLayout</span>(<span class="hljs-params">item: <span class="hljs-built_in">string</span>, _: <span class="hljs-built_in">number</span></span>) {
      <span class="hljs-title class_">Row</span>() {
        <span class="hljs-title class_">SymbolGlyph</span>($r(<span class="hljs-string">'sys.symbol.bell_fill'</span>))
          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">18</span>)
          .<span class="hljs-title function_">renderingStrategy</span>(<span class="hljs-title class_">SymbolRenderingStrategy</span>.<span class="hljs-property">SINGLE</span>)
          .<span class="hljs-title function_">fontColor</span>([<span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span>])
          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">5</span> })
        <span class="hljs-title class_">Text</span>(item)
          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">16</span>)
          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)
          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">5</span> })
      }.<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>)
    }


    <span class="hljs-comment">/**
   *AUTHOR:AbnerMing
   *INTRODUCE:可以是任意布局
   */</span>
    <span class="hljs-meta">@Builder</span>
    <span class="hljs-title function_">marqueeLayout2</span>(<span class="hljs-params">item: <span class="hljs-built_in">string</span>, _: <span class="hljs-built_in">number</span></span>) {
      <span class="hljs-title class_">Column</span>() {
        <span class="hljs-title class_">Image</span>(<span class="hljs-string">"https://loveharmony.oss-cn-beijing.aliyuncs.com/banner/banner_01.jpg"</span>)
          .<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)
          .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)
        <span class="hljs-title class_">Text</span>(item)
          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">16</span>)
          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)
          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">5</span>, <span class="hljs-attr">top</span>: <span class="hljs-number">10</span> })
      }.<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)
        .<span class="hljs-title function_">padding</span>(<span class="hljs-number">10</span>)
    }

    <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
      <span class="hljs-title class_">Column</span>() {
        <span class="hljs-title class_">ActionBar</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">"横向连续跑马灯"</span> })

        <span class="hljs-comment">//纯文本</span>
        <span class="hljs-title class_">MarqueeView</span>({
          <span class="hljs-attr">marqueeData</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">marqueeDataArray</span>, <span class="hljs-comment">//可以传递任意类型数据数组</span>
          <span class="hljs-attr">marqueeType</span>: <span class="hljs-title class_">MarqueeType</span>.<span class="hljs-property">continuous</span>, <span class="hljs-comment">//连续滚动</span>
          <span class="hljs-attr">marqueeDirection</span>: <span class="hljs-title class_">MarqueeDirection</span>.<span class="hljs-property">horizontal</span>, <span class="hljs-comment">//横向</span>
          <span class="hljs-attr">marqueeLayout</span>: <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">Object</span>, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">marqueeText</span>(item <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>, index)
          }
        }).<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">color</span>: <span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span> })

        <span class="hljs-comment">//自定义布局1</span>
        <span class="hljs-title class_">MarqueeView</span>({
          <span class="hljs-attr">marqueeData</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">marqueeDataArray</span>, <span class="hljs-comment">//可以传递任意类型数据数组</span>
          <span class="hljs-attr">marqueeType</span>: <span class="hljs-title class_">MarqueeType</span>.<span class="hljs-property">continuous</span>, <span class="hljs-comment">//连续滚动</span>
          <span class="hljs-attr">marqueeDirection</span>: <span class="hljs-title class_">MarqueeDirection</span>.<span class="hljs-property">horizontal</span>, <span class="hljs-comment">//横向</span>
          <span class="hljs-attr">marqueeLayout</span>: <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">Object</span>, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">marqueeLayout</span>(item <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>, index)
          }
        }).<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">color</span>: <span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span> })
          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">20</span> })

        <span class="hljs-comment">//自定义布局2</span>
        <span class="hljs-title class_">MarqueeView</span>({
          <span class="hljs-attr">marqueeData</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">marqueeDataArray</span>, <span class="hljs-comment">//可以传递任意类型数据数组</span>
          <span class="hljs-attr">marqueeType</span>: <span class="hljs-title class_">MarqueeType</span>.<span class="hljs-property">continuous</span>, <span class="hljs-comment">//连续滚动</span>
          <span class="hljs-attr">marqueeDirection</span>: <span class="hljs-title class_">MarqueeDirection</span>.<span class="hljs-property">horizontal</span>, <span class="hljs-comment">//横向</span>
          <span class="hljs-attr">marqueeLayout</span>: <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">Object</span>, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">marqueeLayout2</span>(item <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>, index)
          }
        }).<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">color</span>: <span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span> })
          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">20</span> })

      }
      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
        .<span class="hljs-title function_">padding</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">right</span>: <span class="hljs-number">10</span> })
    }
  }
</code></pre>
<h2 data-id="heading-11">相关总结</h2>
<p>在实际的开发中，如果是横向的连续滚动，并且是文本类型的，那么建议直接使用系统的Text组件或者Marquee组件，当然了，也可以使用，我开发好的marquee组件，里面也实现了系统的能力，其实是一样的。如果是非文本，那没有别的办法，只能使用自定义的marquee组件。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript原型与原型链：深入理解面向对象编程的基石]]></title>    <link>https://juejin.cn/post/7573530680886542370</link>    <guid>https://juejin.cn/post/7573530680886542370</guid>    <pubDate>2025-11-17T13:30:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573530680886542370" data-draft-id="7573508361741795328" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript原型与原型链：深入理解面向对象编程的基石"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-11-17T13:30:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="进击的野人"/> <meta itemprop="url" content="https://juejin.cn/user/1458425238667008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript原型与原型链：深入理解面向对象编程的基石
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1458425238667008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    进击的野人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T13:30:11.000Z" title="Mon Nov 17 2025 13:30:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在JavaScript的世界中，原型（Prototype）是一个核心概念，它构成了JavaScript面向对象编程的基石。对于许多初学者来说，原型和原型链可能是最令人困惑的概念之一，但一旦深入理解，就会发现它实际上是JavaScript最强大、最灵活的特性之一。本文将通过详细的理论解释和丰富的代码示例，全面剖析JavaScript中的原型对象、原型继承以及原型链机制。</p>
<h2 data-id="heading-1">一、原型对象：共享属性和方法的智慧</h2>
<h3 data-id="heading-2">1.1 什么是原型对象</h3>
<p>在JavaScript中，每个函数都有一个特殊的属性<code>prototype</code>，这就是我们所说的原型对象。这个属性指向一个对象，其主要目的是包含可以由特定类型的所有实例共享的属性和方法。</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Star</span>(<span class="hljs-params">uname</span>){
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">uname</span> = uname;
}
<span class="hljs-comment">// 通过构造函数的prototype属性访问原型对象</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Star</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// 输出原型对象</span>
</code></pre>
<h3 data-id="heading-3">1.2 为什么需要原型对象</h3>
<p>考虑以下场景：我们创建了一个构造函数，并实例化了多个对象。如果每个对象都有自己独立的方法副本，会造成内存的极大浪费。</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 不推荐的方式：每个实例都有独立的方法副本</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Star</span>(<span class="hljs-params">uname</span>){
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">uname</span> = uname;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">sing</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uname</span> + <span class="hljs-string">'会唱歌'</span>);
  }
}

<span class="hljs-keyword">const</span> ldh = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Star</span>(<span class="hljs-string">'刘德华'</span>);
<span class="hljs-keyword">const</span> zxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Star</span>(<span class="hljs-string">'张学友'</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ldh.<span class="hljs-property">sing</span> === zxy.<span class="hljs-property">sing</span>); <span class="hljs-comment">// false，方法是不同的函数实例</span>
</code></pre>
<p>使用原型对象可以优雅地解决这个问题：</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 推荐的方式：方法定义在原型上，所有实例共享</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Star</span>(<span class="hljs-params">uname</span>){
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">uname</span> = uname;
}

<span class="hljs-title class_">Star</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sing</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uname</span> + <span class="hljs-string">'会唱歌'</span>);
}

<span class="hljs-keyword">const</span> ldh = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Star</span>(<span class="hljs-string">'刘德华'</span>);
<span class="hljs-keyword">const</span> zxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Star</span>(<span class="hljs-string">'张学友'</span>);

ldh.<span class="hljs-title function_">sing</span>(); <span class="hljs-comment">// 刘德华会唱歌</span>
zxy.<span class="hljs-title function_">sing</span>(); <span class="hljs-comment">// 张学友会唱歌</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ldh.<span class="hljs-property">sing</span> === zxy.<span class="hljs-property">sing</span>); <span class="hljs-comment">// true，所有实例共享同一个方法</span>
</code></pre>
<h3 data-id="heading-4">1.3 原型对象的工作原理</h3>
<p>当我们访问一个对象的属性或方法时，JavaScript引擎会首先在对象自身查找，如果找不到，就会沿着原型链向上查找，直到找到该属性或到达原型链的末端。</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Star</span>(<span class="hljs-params">uname</span>){
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">uname</span> = uname;
}

<span class="hljs-title class_">Star</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sing</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uname</span> + <span class="hljs-string">'会唱歌'</span>);
}

<span class="hljs-keyword">const</span> ldh = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Star</span>(<span class="hljs-string">'刘德华'</span>);

<span class="hljs-comment">// ldh对象本身没有sing方法，但通过原型链可以访问到</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ldh.<span class="hljs-title function_">hasOwnProperty</span>(<span class="hljs-string">'sing'</span>)); <span class="hljs-comment">// false</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'sing'</span> <span class="hljs-keyword">in</span> ldh); <span class="hljs-comment">// true</span>
ldh.<span class="hljs-title function_">sing</span>(); <span class="hljs-comment">// 刘德华会唱歌</span>
</code></pre>
<h3 data-id="heading-5">1.4 原型对象中的this指向</h3>
<p>一个重要的细节是：无论方法定义在构造函数中还是原型对象中，方法内部的this都指向调用该方法的实例对象。</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Star</span>(<span class="hljs-params">uname</span>){
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">uname</span> = uname;
}

<span class="hljs-title class_">Star</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sing</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
  <span class="hljs-comment">// 这里的this指向调用该方法的实例对象</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uname</span> + <span class="hljs-string">'会唱歌'</span>);
}

<span class="hljs-keyword">const</span> ldh = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Star</span>(<span class="hljs-string">'刘德华'</span>);
ldh.<span class="hljs-title function_">sing</span>(); <span class="hljs-comment">// 输出"刘德华会唱歌"，this指向ldh实例</span>
</code></pre>
<h2 data-id="heading-6">二、constructor属性：连接实例与构造函数的桥梁</h2>
<h3 data-id="heading-7">2.1 原型对象中的constructor属性</h3>
<p>每个原型对象都有一个<code>constructor</code>属性，默认指向该原型对象所属的构造函数。</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-ini" lang="ini">function Star(uname){
  <span class="hljs-attr">this.uname</span> = uname<span class="hljs-comment">;</span>
}

console.log(<span class="hljs-attr">Star.prototype.constructor</span> === Star)<span class="hljs-comment">; // true</span>
</code></pre>
<h3 data-id="heading-8">2.2 实例对象中的constructor属性</h3>
<p>通过实例对象访问constructor属性时，实际上是通过原型链访问到原型对象的constructor属性。</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-ini" lang="ini">function Star(uname){
  <span class="hljs-attr">this.uname</span> = uname<span class="hljs-comment">;</span>
}

const <span class="hljs-attr">ldh</span> = new Star(<span class="hljs-string">'刘德华'</span>)<span class="hljs-comment">;</span>
console.log(<span class="hljs-attr">ldh.constructor</span> === Star)<span class="hljs-comment">; // true</span>
</code></pre>
<h3 data-id="heading-9">2.3 重写原型对象时的constructor问题</h3>
<p>当我们完全重写原型对象时，会丢失原有的constructor属性，需要手动重新指向。</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Star</span>(<span class="hljs-params">uname</span>){
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">uname</span> = uname;
}

<span class="hljs-comment">// 完全重写原型对象</span>
<span class="hljs-title class_">Star</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = {
  <span class="hljs-attr">sing</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uname</span> + <span class="hljs-string">'会唱歌'</span>);
  },
  <span class="hljs-attr">dance</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uname</span> + <span class="hljs-string">'会跳舞'</span>);
  }
};

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Star</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> === <span class="hljs-title class_">Star</span>); <span class="hljs-comment">// false</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Star</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> === <span class="hljs-title class_">Object</span>); <span class="hljs-comment">// true</span>

<span class="hljs-comment">// 正确的方式：重写原型对象时手动设置constructor</span>
<span class="hljs-title class_">Star</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = {
  <span class="hljs-attr">constructor</span>: <span class="hljs-title class_">Star</span>, <span class="hljs-comment">// 手动指向构造函数</span>
  <span class="hljs-attr">sing</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uname</span> + <span class="hljs-string">'会唱歌'</span>);
  },
  <span class="hljs-attr">dance</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uname</span> + <span class="hljs-string">'会跳舞'</span>);
  }
};

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Star</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> === <span class="hljs-title class_">Star</span>); <span class="hljs-comment">// true</span>
</code></pre>
<h2 data-id="heading-10">三、对象原型：<code>__proto__</code>与原型链的纽带</h2>
<h3 data-id="heading-11">3.1 什么是对象原型</h3>
<p>每个JavaScript对象（除null外）都有一个内置属性<code>[[Prototype]]</code>，在大多数浏览器中可以通过<code>__proto__</code>属性访问。这个属性指向创建该对象的构造函数的原型对象。</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-ini" lang="ini">function Star(uname){
  <span class="hljs-attr">this.uname</span> = uname<span class="hljs-comment">;</span>
}

const <span class="hljs-attr">ldh</span> = new Star(<span class="hljs-string">'刘德华'</span>)<span class="hljs-comment">;</span>

// 实例对象的__proto__指向构造函数的原型对象
console.log(<span class="hljs-attr">ldh.__proto__</span> === Star.prototype)<span class="hljs-comment">; // true</span>
</code></pre>
<h3 data-id="heading-12">3.2 <code>__proto__</code>与prototype的关系</h3>
<ul>
<li><code>prototype</code>是构造函数的属性，指向原型对象</li>
<li><code>__proto__</code>是实例对象的属性，指向构造函数的原型对象</li>
</ul>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-ini" lang="ini">function Star(uname){
  <span class="hljs-attr">this.uname</span> = uname<span class="hljs-comment">;</span>
}

const <span class="hljs-attr">ldh</span> = new Star(<span class="hljs-string">'刘德华'</span>)<span class="hljs-comment">;</span>

// 三者关系
console.log(<span class="hljs-attr">ldh.__proto__</span> === Star.prototype)<span class="hljs-comment">; // true</span>
console.log(<span class="hljs-attr">Star.prototype.constructor</span> === Star)<span class="hljs-comment">; // true</span>
console.log(<span class="hljs-attr">ldh.constructor</span> === Star)<span class="hljs-comment">; // true</span>
</code></pre>
<h3 data-id="heading-13">3.3 对象原型的实际意义</h3>
<p>对象原型<code>__proto__</code>的主要意义在于为对象成员查找机制提供一个方向，或者说一条路线，这就是我们接下来要讨论的原型链。</p>
<h2 data-id="heading-14">四、原型继承：实现代码复用的优雅方式</h2>
<h3 data-id="heading-15">4.1 什么是原型继承</h3>
<p>原型继承是JavaScript中实现继承的主要方式。其核心思想是：让一个构造函数的原型对象等于另一个构造函数的实例，这样前者就可以继承后者的属性和方法。</p>
<h3 data-id="heading-16">4.2 原型继承的实现</h3>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-ini" lang="ini">// 父类
function Person(){
  <span class="hljs-attr">this.eyes</span> = <span class="hljs-number">2</span><span class="hljs-comment">;</span>
  <span class="hljs-attr">this.head</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
}

// 子类
function Woman(sex){
  <span class="hljs-attr">this.sex</span> = sex<span class="hljs-comment">;</span>
}

function Man(sex){
  <span class="hljs-attr">this.sex</span> = sex<span class="hljs-comment">;</span>
}

// 实现继承：子类的原型对象是父类的实例
<span class="hljs-attr">Woman.prototype</span> = new Person()<span class="hljs-comment">;</span>
// 修复constructor指向
<span class="hljs-attr">Woman.prototype.constructor</span> = Woman<span class="hljs-comment">;</span>

<span class="hljs-attr">Man.prototype</span> = new Person()<span class="hljs-comment">;</span>
<span class="hljs-attr">Man.prototype.constructor</span> = Man<span class="hljs-comment">;</span>

const <span class="hljs-attr">red</span> = new Woman(<span class="hljs-string">'女'</span>)<span class="hljs-comment">;</span>
console.log(red.eyes)<span class="hljs-comment">; // 2，继承自Person</span>
console.log(red.head)<span class="hljs-comment">; // 1，继承自Person</span>
console.log(red.sex)<span class="hljs-comment">; // 女，自身的属性</span>

const <span class="hljs-attr">blue</span> = new Man(<span class="hljs-string">'男'</span>)<span class="hljs-comment">;</span>
console.log(blue.eyes)<span class="hljs-comment">; // 2，继承自Person</span>
console.log(blue.head)<span class="hljs-comment">; // 1，继承自Person</span>
console.log(blue.sex)<span class="hljs-comment">; // 男，自身的属性</span>
</code></pre>
<h3 data-id="heading-17">4.3 原型继承的内存效率</h3>
<p>通过原型继承，所有子类实例共享父类原型上的方法，这大大提高了内存使用效率。</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-ini" lang="ini">function Person(){
  <span class="hljs-attr">this.eyes</span> = <span class="hljs-number">2</span><span class="hljs-comment">;</span>
}

<span class="hljs-attr">Person.prototype.breathe</span> = function(){
  console.log('呼吸')<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

function Woman(sex){
  <span class="hljs-attr">this.sex</span> = sex<span class="hljs-comment">;</span>
}

<span class="hljs-attr">Woman.prototype</span> = new Person()<span class="hljs-comment">;</span>
<span class="hljs-attr">Woman.prototype.constructor</span> = Woman<span class="hljs-comment">;</span>

const <span class="hljs-attr">red</span> = new Woman(<span class="hljs-string">'女'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">pink</span> = new Woman(<span class="hljs-string">'女'</span>)<span class="hljs-comment">;</span>

// 两个实例共享同一个breathe方法
console.log(<span class="hljs-attr">red.breathe</span> === pink.breathe)<span class="hljs-comment">; // true</span>
</code></pre>
<h3 data-id="heading-18">4.4 方法重写与属性屏蔽</h3>
<p>子类可以重写父类的方法，或者在实例上定义与原型链上同名的属性，实现属性屏蔽。</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params"/>){
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">eyes</span> = <span class="hljs-number">2</span>;
}

<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">see</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'用眼睛看'</span>);
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Superman</span>(<span class="hljs-params"/>){
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">eyes</span> = <span class="hljs-number">3</span>; <span class="hljs-comment">// 属性屏蔽</span>
}

<span class="hljs-title class_">Superman</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();
<span class="hljs-title class_">Superman</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Superman</span>;

<span class="hljs-comment">// 方法重写</span>
<span class="hljs-title class_">Superman</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">see</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'用超级眼睛看'</span>);
};

<span class="hljs-keyword">const</span> clark = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Superman</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(clark.<span class="hljs-property">eyes</span>); <span class="hljs-comment">// 3，访问的是自身属性</span>
clark.<span class="hljs-title function_">see</span>(); <span class="hljs-comment">// "用超级眼睛看"，调用的是重写后的方法</span>
</code></pre>
<h2 data-id="heading-19">五、原型链：JavaScript对象查找机制的核心</h2>
<h3 data-id="heading-20">5.1 什么是原型链</h3>
<p>原型链是JavaScript中实现继承和属性查找的机制。当访问一个对象的属性时，JavaScript引擎会执行以下步骤：</p>
<ol>
<li>首先在对象自身查找该属性</li>
<li>如果找不到，则在该对象的原型（<code>__proto__</code>指向的对象）上查找</li>
<li>如果还找不到，则继续在原型的原型上查找</li>
<li>依此类推，直到找到该属性或到达原型链的顶端（null）</li>
</ol>
<h3 data-id="heading-21">5.2 原型链的图示与理解</h3>
<p>考虑以下代码：</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-ini" lang="ini">function Person(name){
  <span class="hljs-attr">this.name</span> = name<span class="hljs-comment">;</span>
}

<span class="hljs-attr">Person.prototype.sayHello</span> = function(){
  console.log('Hello, I am ' + this.name)<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

function Student(name, grade){
  <span class="hljs-attr">this.name</span> = name<span class="hljs-comment">;</span>
  <span class="hljs-attr">this.grade</span> = grade<span class="hljs-comment">;</span>
}

// 实现继承
<span class="hljs-attr">Student.prototype</span> = new Person()<span class="hljs-comment">;</span>
<span class="hljs-attr">Student.prototype.constructor</span> = Student<span class="hljs-comment">;</span>

<span class="hljs-attr">Student.prototype.study</span> = function(){
  console.log(this.name + ' is studying')<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

const <span class="hljs-attr">tom</span> = new Student(<span class="hljs-string">'Tom'</span>, <span class="hljs-number">5</span>)<span class="hljs-comment">;</span>
</code></pre>
<p>此时的原型链关系为：</p>
<p>text</p>
<p>复制下载</p>
<pre><code class="hljs language-javascript" lang="javascript">tom -&gt; <span class="hljs-title class_">Student</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> -&gt; <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> -&gt; <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> -&gt; <span class="hljs-literal">null</span>
</code></pre>
<p>属性查找过程：</p>
<ul>
<li><code>tom.grade</code>：在tom对象自身找到</li>
<li><code>tom.study</code>：在Student.prototype中找到</li>
<li><code>tom.sayHello</code>：在Person.prototype中找到</li>
<li><code>tom.toString</code>：在Object.prototype中找到</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9bcb99d126514872abf8071b32e005d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-b5Ye755qE6YeO5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763991011&amp;x-signature=47n9oWTIVto3%2FIjXZtdbgG49MxQ%3D" alt="9f7a6fe1f768b069e3c5125a949cf993.png" loading="lazy"/></p>
<h3 data-id="heading-22">5.3 原型链的终点</h3>
<p>所有普通的原型链最终都会指向Object.prototype，而Object.prototype的<code>__proto__</code>指向null，这是原型链的终点。</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params"/>){}

<span class="hljs-keyword">const</span> person = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span> === <span class="hljs-literal">null</span>); <span class="hljs-comment">// true</span>
</code></pre>
<h3 data-id="heading-23">5.4 instanceof操作符</h3>
<p><code>instanceof</code>运算符用于检测构造函数的prototype属性是否出现在某个实例对象的原型链上。</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params"/>){}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Student</span>(<span class="hljs-params"/>){}

<span class="hljs-title class_">Student</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();
<span class="hljs-title class_">Student</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Student</span>;

<span class="hljs-keyword">const</span> tom = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(tom <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Student</span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(tom <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Person</span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(tom <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Object</span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(tom <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Array</span>); <span class="hljs-comment">// false</span>
</code></pre>
<h3 data-id="heading-24">5.5 原型链与性能考虑</h3>
<p>虽然原型链提供了强大的继承机制，但过长的原型链可能会影响性能，因为属性查找需要遍历整个原型链。在实际开发中，应尽量避免过深的继承层次。</p>
<h2 data-id="heading-25">六、实际应用与最佳实践</h2>
<h3 data-id="heading-26">6.1 组合使用构造函数和原型模式</h3>
<p>这是创建自定义类型的最常见方式，通过构造函数定义实例属性，通过原型定义共享的方法和属性。</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 最佳实践：组合使用构造函数和原型模式</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name, age</span>){
  <span class="hljs-comment">// 实例属性</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
}

<span class="hljs-comment">// 共享方法</span>
<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayHello</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Hello, I am '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
};

<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
  <span class="hljs-keyword">return</span> <span class="hljs-string">'[Person: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> + <span class="hljs-string">', '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> + <span class="hljs-string">']'</span>;
};

<span class="hljs-keyword">const</span> alice = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'Alice'</span>, <span class="hljs-number">25</span>);
<span class="hljs-keyword">const</span> bob = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'Bob'</span>, <span class="hljs-number">30</span>);

alice.<span class="hljs-title function_">sayHello</span>(); <span class="hljs-comment">// Hello, I am Alice</span>
bob.<span class="hljs-title function_">sayHello</span>(); <span class="hljs-comment">// Hello, I am Bob</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(alice.<span class="hljs-title function_">toString</span>()); <span class="hljs-comment">// [Person: Alice, 25]</span>
</code></pre>
<h3 data-id="heading-27">6.2 原型与对象创建性能</h3>
<p>在需要创建大量相似对象的场景中，使用原型可以显著提高性能。</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 性能对比：使用原型 vs 不使用原型</span>

<span class="hljs-comment">// 方式1：不使用原型（性能较差）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createUserWithoutPrototype</span>(<span class="hljs-params">name, email</span>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">name</span>: name,
    <span class="hljs-attr">email</span>: email,
    <span class="hljs-attr">getInfo</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> + <span class="hljs-string">' &lt;'</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">email</span> + <span class="hljs-string">'&gt;'</span>;
    }
  };
}

<span class="hljs-comment">// 方式2：使用原型（性能较好）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">User</span>(<span class="hljs-params">name, email</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">email</span> = email;
}

<span class="hljs-title class_">User</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">getInfo</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> + <span class="hljs-string">' &lt;'</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">email</span> + <span class="hljs-string">'&gt;'</span>;
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">createUserWithPrototype</span>(<span class="hljs-params">name, email</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(name, email);
}

<span class="hljs-comment">// 测试性能</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'Without Prototype'</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100000</span>; i++) {
  <span class="hljs-title function_">createUserWithoutPrototype</span>(<span class="hljs-string">'user'</span> + i, <span class="hljs-string">'user'</span> + i + <span class="hljs-string">'@example.com'</span>);
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'Without Prototype'</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'With Prototype'</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100000</span>; i++) {
  <span class="hljs-title function_">createUserWithPrototype</span>(<span class="hljs-string">'user'</span> + i, <span class="hljs-string">'user'</span> + i + <span class="hljs-string">'@example.com'</span>);
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'With Prototype'</span>);
</code></pre>
<h2 data-id="heading-28">七、常见问题与解决方案</h2>
<h3 data-id="heading-29">7.1 原型对象共享引用类型值的问题</h3>
<p>当原型对象包含引用类型值时，所有实例会共享同一个引用，这可能导致意外的行为。</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-ini" lang="ini">// 问题：共享引用类型值
function Person(name){
  <span class="hljs-attr">this.name</span> = name<span class="hljs-comment">;</span>
}

<span class="hljs-attr">Person.prototype.friends</span> = []<span class="hljs-comment">; // 引用类型值</span>

const <span class="hljs-attr">alice</span> = new Person(<span class="hljs-string">'Alice'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">bob</span> = new Person(<span class="hljs-string">'Bob'</span>)<span class="hljs-comment">;</span>

alice.friends.push('Charlie')<span class="hljs-comment">;</span>
console.log(bob.friends)<span class="hljs-comment">; // ['Charlie']，bob也受到了影响</span>

// 解决方案：在构造函数中定义引用类型属性
function BetterPerson(name){
  <span class="hljs-attr">this.name</span> = name<span class="hljs-comment">;</span>
  <span class="hljs-attr">this.friends</span> = []<span class="hljs-comment">; // 每个实例有自己的friends数组</span>
}

<span class="hljs-attr">BetterPerson.prototype.addFriend</span> = function(friend){
  this.friends.push(friend)<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

const <span class="hljs-attr">carol</span> = new BetterPerson(<span class="hljs-string">'Carol'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">dave</span> = new BetterPerson(<span class="hljs-string">'Dave'</span>)<span class="hljs-comment">;</span>

carol.addFriend('Eve')<span class="hljs-comment">;</span>
console.log(carol.friends)<span class="hljs-comment">; // ['Eve']</span>
console.log(dave.friends)<span class="hljs-comment">; // []，dave不受影响</span>
</code></pre>
<h3 data-id="heading-30">7.2 原型链与枚举属性</h3>
<p>使用<code>for...in</code>循环时会遍历对象自身和原型链上的可枚举属性，这可能不是我们想要的行为。</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name</span>){
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
}

<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayHello</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Hello'</span>);
};

<span class="hljs-keyword">const</span> person = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'Alice'</span>);

<span class="hljs-comment">// for...in会遍历原型链上的属性</span>
<span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> person){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key); <span class="hljs-comment">// 输出: name, sayHello</span>
}

<span class="hljs-comment">// 解决方案：使用hasOwnProperty过滤</span>
<span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> person){
  <span class="hljs-keyword">if</span>(person.<span class="hljs-title function_">hasOwnProperty</span>(key)){
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key); <span class="hljs-comment">// 只输出: name</span>
  }
}
</code></pre>
<h2 data-id="heading-31">结论</h2>
<p>JavaScript的原型机制是其面向对象编程的核心，理解原型对象、原型继承和原型链对于掌握JavaScript至关重要。通过原型，JavaScript实现了高效的代码复用和灵活的继承机制。虽然ES6引入了class语法，使其更接近传统面向对象语言，但底层仍然是基于原型的继承。</p>
<p>在实际开发中，我们应该：</p>
<ol>
<li>理解原型链的工作原理，避免过深的继承层次</li>
<li>合理使用原型共享方法，提高内存效率</li>
<li>注意引用类型值的共享问题</li>
<li>掌握现代class语法，同时理解其背后的原型机制</li>
</ol>
<p>通过深入理解和合理应用原型相关概念，我们能够编写出更加高效、可维护的JavaScript代码，充分利用JavaScript这门语言的强大特性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3项目记录]]></title>    <link>https://juejin.cn/post/7573521516324585499</link>    <guid>https://juejin.cn/post/7573521516324585499</guid>    <pubDate>2025-11-17T14:31:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573521516324585499" data-draft-id="7573528564026294318" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3项目记录"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-11-17T14:31:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="呵阿咯咯"/> <meta itemprop="url" content="https://juejin.cn/user/26044011932647"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3项目记录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/26044011932647/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    呵阿咯咯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T14:31:43.000Z" title="Mon Nov 17 2025 14:31:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、Vue 绑定属性的核心问题</h2>
<h3 data-id="heading-1">（一）核心问题</h3>
<p>绑定属性时，即使绑定的值是常量 <code>false</code>，也需要使用 <code>:</code> 前缀。关键认知：<code>:</code> 的作用是区分字符串 vs JavaScript 值，而非 “固定值 vs 变量”。</p>
<h3 data-id="heading-2">（二）关键对比</h3>
<h4 data-id="heading-3">1. 不用 <code>:</code>（HTML 属性）</h4>
<pre><code class="hljs language-ini" lang="ini">&lt;el-form <span class="hljs-attr">hide-required-asterisk</span>=<span class="hljs-string">"false"</span>&gt;
</code></pre>
<ul>
<li>浏览器解析结果：<code>props.hideRequiredAsterisk = "false"</code>（字符串类型）</li>
<li>JavaScript 中逻辑：非空字符串均为 truthy，<code>if ("false")</code> 会执行，最终等效于 <code>true</code></li>
</ul>
<h4 data-id="heading-4">2. 用 <code>:</code>（JavaScript 表达式）</h4>
<pre><code class="hljs language-ruby" lang="ruby">&lt;el-form <span class="hljs-symbol">:hide-required-asterisk=<span class="hljs-string">"false"</span>&gt;</span>
</code></pre>
<ul>
<li>Vue 解析结果：<code>props.hideRequiredAsterisk = false</code>（布尔类型）</li>
<li>JavaScript 中逻辑：<code>if (false)</code> 不会执行，符合预期效果</li>
</ul>
<h3 data-id="heading-5">（三）实际测试验证</h3>

























<table><thead><tr><th>代码写法</th><th>解析结果</th><th>是否正确</th></tr></thead><tbody><tr><td><code>&lt;el-form hide-required-asterisk="false"&gt;</code></td><td>等效于 <code>:hide-required-asterisk="'false'"</code></td><td>❌</td></tr><tr><td><code>&lt;el-form :hide-required-asterisk="'false'"&gt;</code></td><td>等效于 <code>:hide-required-asterisk="true"</code></td><td>❌</td></tr><tr><td><code>&lt;el-form :hide-required-asterisk="false"&gt;</code></td><td>解析为布尔值 <code>false</code></td><td>✅</td></tr></tbody></table>
<h3 data-id="heading-6">（四）<code>:</code> 的真正作用</h3>
<p>告诉 Vue：“把引号里的内容当作 JavaScript 代码执行，而非字符串”。</p>
<h3 data-id="heading-7">（五）完整使用示例</h3>
<h4 data-id="heading-8">场景 1：传递字符串（无需 <code>:</code>）</h4>
<pre><code class="hljs language-ini" lang="ini">&lt;el-input <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入"</span>&gt;
</code></pre>
<ul>
<li>解析结果：<code>placeholder = "请输入"</code>（字符串类型）</li>
</ul>
<h4 data-id="heading-9">场景 2：传递数字（需要 <code>:</code>）</h4>
<pre><code class="hljs language-ini" lang="ini">&lt;el-input :<span class="hljs-attr">maxlength</span>=<span class="hljs-string">"100"</span>&gt;
</code></pre>
<ul>
<li>解析结果：<code>maxlength = 100</code>（数字类型，非字符串 "100"）</li>
</ul>
<h4 data-id="heading-10">场景 3：传递布尔值（需要 <code>:</code>）</h4>
<pre><code class="hljs language-ruby" lang="ruby">&lt;el-form <span class="hljs-symbol">:hide-required-asterisk=<span class="hljs-string">"false"</span>&gt;</span>
</code></pre>
<ul>
<li>解析结果：<code>hideRequiredAsterisk = false</code>（布尔类型）</li>
</ul>
<h4 data-id="heading-11">场景 4：传递对象（需要 <code>:</code>）</h4>
<pre><code class="hljs language-ini" lang="ini">&lt;el-form :<span class="hljs-attr">model</span>=<span class="hljs-string">"{ name: 'test' }"</span>&gt;
</code></pre>
<ul>
<li>解析结果：<code>model = { name: 'test' }</code>（对象类型）</li>
</ul>
<h4 data-id="heading-12">场景 5：传递变量（需要 <code>:</code>）</h4>
<pre><code class="hljs language-ruby" lang="ruby">&lt;el-form <span class="hljs-symbol">:hide-required-asterisk=<span class="hljs-string">"isReadOnly"</span>&gt;</span>
</code></pre>
<ul>
<li>解析结果：<code>hideRequiredAsterisk = isReadOnly</code>（变量对应的值）</li>
</ul>
<h3 data-id="heading-13">（六）代码结论</h3>
<pre><code class="hljs language-ruby" lang="ruby">&lt;el-form <span class="hljs-symbol">:hide-required-asterisk=<span class="hljs-string">"false"</span>&gt;</span>
</code></pre>
<ul>
<li><code>false</code> 是固定值，此表述正确</li>
<li>必须使用 <code>:</code>，原因是要传递布尔类型（JavaScript 值），而非字符串</li>
<li>使用 <code>:</code> 的核心依据是值的类型，而非 “是否会变化”</li>
</ul>
<h3 data-id="heading-14">（七）总结</h3>
<p><code>:</code> 的核心作用是区分 “字符串” 与 “JavaScript 代码执行结果”，而非 “固定值 vs 变量”。本质：<code>:</code> 表示 “这是 JavaScript 代码，请执行它”。</p>
<hr/>
<h2 data-id="heading-15">二、computed/useMemo 触发差异（Vue3/React 响应式本质区别）</h2>
<h3 data-id="heading-16">（一）核心问题</h3>
<p>Vue3 中 computed 函数是否会在 “依赖更新” 和 “视图渲染” 时多次触发？为何与 React useMemo 行为不同？这一差异的本质是框架响应式设计理念的区别吗？</p>
<h3 data-id="heading-17">（二）核心结论</h3>
<p>Vue3 computed 函数仅在<strong>依赖数据变化时重新执行</strong>，视图渲染时若依赖未变则复用缓存，不会额外触发；其与 React useMemo 的行为差异，核心是 Vue “响应式 getter 驱动” 与 React “声明式依赖数组驱动” 的设计理念不同，而非 “两次触发” 的差异。</p>
<h3 data-id="heading-18">（三）框架响应式本质差异（Vue3 vs React）</h3>
<h4 data-id="heading-19">1. Vue3 Computed 工作原理</h4>
<ul>
<li>
<p>核心定位：computed 是 “响应式的 getter”，与响应式数据（ref/reactive）深度绑定。</p>
</li>
<li>
<p>触发逻辑：</p>
<ol>
<li>当依赖的响应式数据（如 <code>snapshotData.value</code>）发生变化时，computed 函数会自动重新执行。</li>
<li>模板中读取 <code>{{ formatAmount }}</code> 时，仅当依赖已变化，才会触发重新计算；依赖未变则直接复用缓存结果。</li>
</ol>
</li>
<li>
<p>代码示例：</p>
</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> formatAmount = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"snapshotData.value"</span>, snapshotData.<span class="hljs-property">value</span>); <span class="hljs-comment">// 仅依赖变化时打印</span>
  <span class="hljs-keyword">return</span> snapshotData.<span class="hljs-property">value</span> ? <span class="hljs-string">`+<span class="hljs-subst">${snapshotData.value.amount}</span>`</span> : <span class="hljs-string">"+0"</span>;
});
</code></pre>
<h4 data-id="heading-20">2. React useMemo 工作原理</h4>
<ul>
<li>
<p>核心定位：useMemo 是 “声明式的缓存计算工具”，依赖显式配置的依赖数组。</p>
</li>
<li>
<p>触发逻辑：</p>
<ol>
<li>仅在 “依赖数组中的值变化” 或 “组件首次渲染” 时，执行计算函数。</li>
<li>JSX 中使用 <code>{formatAmount}</code> 仅为读取缓存值，无论视图如何渲染，只要依赖未变，都不会重新执行计算函数。</li>
</ol>
</li>
<li>
<p>代码示例：</p>
</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> formatAmount = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"snapshotData"</span>, snapshotData); <span class="hljs-comment">// 仅依赖数组变化时打印</span>
  <span class="hljs-keyword">return</span> snapshotData ? <span class="hljs-string">`+<span class="hljs-subst">${snapshotData.amount}</span>`</span> : <span class="hljs-string">"+0"</span>;
}, [snapshotData]); <span class="hljs-comment">// 显式依赖数组</span>
</code></pre>
<h3 data-id="heading-21">（四）关键特性对比表</h3>



































<table><thead><tr><th>特性</th><th>Vue3 Computed</th><th>React useMemo</th></tr></thead><tbody><tr><td>核心定位</td><td>响应式 getter</td><td>声明式缓存计算工具</td></tr><tr><td>触发时机</td><td>依赖响应式数据变化时</td><td>依赖数组变化 / 组件首次渲染时</td></tr><tr><td>视图使用时</td><td>依赖已变则重新计算，否则复用缓存</td><td>仅读取缓存值，不触发重新计算</td></tr><tr><td>依赖配置</td><td>自动追踪响应式依赖，无需手动配置</td><td>需显式声明依赖数组</td></tr><tr><td>内部打印行为</td><td>依赖变化时打印（与计算执行同步）</td><td>依赖数组变化时打印（仅执行一次）</td></tr></tbody></table>
<h3 data-id="heading-22">（五）“打印多次” 的真实原因</h3>
<p>并非 “依赖更新 + 视图渲染” 两次触发，而是：</p>
<ol>
<li>初始渲染时，依赖数据（如 <code>snapshotData.value</code>）为初始值（如 <code>null</code>），computed 执行一次并打印。</li>
<li>业务操作后（如提交表单），依赖数据更新（如变为 <code>{ amount: 100 }</code>），computed 再次执行并打印。</li>
<li>两次打印均是 “依赖变化” 导致的计算执行，与视图渲染本身无直接关联。</li>
</ol>
<h3 data-id="heading-23">（六）优化建议（避免不必要的打印 / 计算）</h3>
<ol>
<li>调试场景：使用 Vue3 的 <code>watchEffect</code> 专门监听数据变化，替代 computed 内打印。</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">watchEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"snapshotData 变化了:"</span>, snapshotData.<span class="hljs-property">value</span>); <span class="hljs-comment">// 仅监听变化打印</span>
});
</code></pre>
<ol start="2">
<li>业务场景：在数据更新的源头（如提交函数、赋值逻辑）打印，明确数据变更时机。</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">handleSubmit</span> = () =&gt; {
  <span class="hljs-attr">snapshotData.value</span> = { amount: formData.amount }<span class="hljs-comment">;</span>
  console.log("快照数据更新:", snapshotData.value)<span class="hljs-comment">; // 源头打印更精准</span>
}<span class="hljs-comment">;</span>
</code></pre>
<ol start="3">
<li>生产环境：移除 computed 内的调试打印，避免冗余执行。</li>
</ol>
<h3 data-id="heading-24">（七）总结</h3>
<ul>
<li>差异本质：Vue3 是 “响应式驱动”，computed 自动追踪依赖、依赖变则计算；React 是 “声明式驱动”，useMemo 仅按依赖数组变化执行计算，二者是框架设计理念的差异，无优劣之分。</li>
<li>关键认知：Vue3 computed 不会因 “单纯视图渲染” 额外触发，多次执行均源于依赖变化；这一特性是 Vue 响应式系统的体现，而非设计缺陷。</li>
</ul>
<hr/>
<h2 data-id="heading-25">三、Vue3 <code>reactive</code> </h2>
<h3 data-id="heading-26">（一）核心定义</h3>
<p><code>reactive</code> 是 Vue 3 Composition API 中用来创建<strong>响应式对象</strong>的核心函数，作用是让数据具备 “变化自动触发视图更新” 的特性。</p>
<h3 data-id="heading-27">（二）基本概念</h3>
<h4 data-id="heading-28">1. 什么是响应式？</h4>
<p>响应式意味着：当数据变化时，使用这些数据的地方（如模板、计算属性等）会<strong>自动更新</strong>。</p>
<pre><code class="hljs language-php" lang="php">import { reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;

<span class="hljs-comment">// 创建响应式对象</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">state</span> = <span class="hljs-title function_ invoke__">reactive</span>({
  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">message</span>: <span class="hljs-string">"Hello"</span>
});

<span class="hljs-comment">// 数据修改后，依赖该数据的视图自动更新</span>
state.count++;
</code></pre>
<h4 data-id="heading-29">2. 实际代码应用（金额调整组件）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> formData = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">adjustType</span>: <span class="hljs-number">1</span>,        <span class="hljs-comment">// 调整类型（+/-）</span>
  <span class="hljs-attr">amount</span>: <span class="hljs-literal">undefined</span>,    <span class="hljs-comment">// 金额</span>
  <span class="hljs-attr">remark</span>: <span class="hljs-string">""</span>           <span class="hljs-comment">// 说明</span>
});
</code></pre>
<ul>
<li>表单绑定 <code>v-model="formData.amount"</code> 时，用户输入会自动同步到 <code>formData.amount</code>。</li>
<li>确认弹窗中 <code>{{ formatAmount }}</code> 依赖 <code>formData</code>，会随数据变化自动更新。</li>
</ul>
<h3 data-id="heading-30">（三）响应式工作原理</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 1. 显示数据：依赖 formData.amount --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>金额：{{ formData.amount }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  
  <span class="hljs-comment">&lt;!-- 2. 修改数据：v-model 绑定响应式属性 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"formData.amount"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;

<span class="hljs-keyword">const</span> formData = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">amount</span>: <span class="hljs-number">0</span>
});

<span class="hljs-comment">// 3. 输入框值改变 → formData.amount 自动更新 → 模板显示同步更新</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-31">（四）<code>reactive</code> vs 普通对象</h3>




















<table><thead><tr><th>类型</th><th>代码示例</th><th>响应式效果</th></tr></thead><tbody><tr><td>普通对象</td><td><code>const formData = { amount: 0 }; formData.amount = 300;</code></td><td>❌ 模板不会更新</td></tr><tr><td>响应式对象</td><td><code>const formData = reactive({ amount: 0 }); formData.amount = 300;</code></td><td>✅ 模板自动更新</td></tr></tbody></table>
<h3 data-id="heading-32">（五）<code>reactive</code> 的核心特点</h3>
<ol>
<li>
<p><strong>仅支持对象类型</strong></p>
<ul>
<li>支持：对象、数组、Map 等复杂类型（<code>reactive({ count: 0 })</code>、<code>reactive([1,2,3])</code>）。</li>
<li>不支持：数字、字符串等基本类型（<code>reactive(0)</code> 无效，需用 <code>ref</code>）。</li>
</ul>
</li>
<li>
<p><strong>深层响应式</strong>嵌套对象的属性同样具备响应式，修改任意层级属性都会触发更新：</p>
</li>
</ol>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">state</span> = <span class="hljs-title function_ invoke__">reactive</span>({
  <span class="hljs-attr">user</span>: {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"张三"</span>,
    <span class="hljs-attr">address</span>: { <span class="hljs-attr">city</span>: <span class="hljs-string">"上海"</span> }
  }
});
state.user.address.city = <span class="hljs-string">"北京"</span>; <span class="hljs-comment">// ✅ 触发响应式更新</span>
</code></pre>
<ol start="3">
<li><strong>直接访问属性</strong>无需 <code>.value</code>，直接读写属性即可：</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">formData</span> = reactive({ amount: <span class="hljs-number">300</span> })<span class="hljs-comment">;</span>
console.log(formData.amount)<span class="hljs-comment">; // 300（直接访问）</span>
<span class="hljs-attr">formData.amount</span> = <span class="hljs-number">500</span><span class="hljs-comment">;        // 直接赋值修改</span>
</code></pre>
<h3 data-id="heading-33">（六）<code>reactive</code> vs <code>ref</code> 对比</h3>






























<table><thead><tr><th>特性</th><th><code>reactive</code></th><th><code>ref</code></th></tr></thead><tbody><tr><td>适用类型</td><td>对象、数组等复杂类型</td><td>任何类型（基本类型、对象）</td></tr><tr><td>访问方式</td><td>直接访问：<code>state.count</code></td><td>脚本中需 <code>.value</code>：<code>count.value</code></td></tr><tr><td>模板中使用</td><td><code>{{ state.count }}</code></td><td><code>{{ count }}</code>（自动解包，无需 <code>.value</code>）</td></tr><tr><td>解构特性</td><td>❌ 直接解构会失去响应式</td><td>✅ 配合 <code>toRefs</code> 可保持响应式</td></tr></tbody></table>
<h4 data-id="heading-34">代码示例对比</h4>
<pre><code class="hljs language-ini" lang="ini">import { reactive, ref } from "vue"<span class="hljs-comment">;</span>

// reactive 用法（对象）
const <span class="hljs-attr">formData</span> = reactive({ amount: <span class="hljs-number">0</span> })<span class="hljs-comment">;</span>
<span class="hljs-attr">formData.amount</span> = <span class="hljs-number">300</span><span class="hljs-comment">;</span>

// ref 用法（基本类型）
const <span class="hljs-attr">count</span> = ref(<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
<span class="hljs-attr">count.value</span> = <span class="hljs-number">300</span><span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-35">（七）实际应用场景</h3>
<ol>
<li><strong>表单数据管理</strong>（如金额调整组件）</li>
</ol>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">formData</span> = <span class="hljs-title function_ invoke__">reactive</span>({ <span class="hljs-attr">adjustType</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">amount</span>: undefined, <span class="hljs-attr">remark</span>: <span class="hljs-string">""</span> });
</code></pre>
<ol start="2">
<li><strong>组件状态管理</strong></li>
</ol>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">state</span> = <span class="hljs-title function_ invoke__">reactive</span>({ <span class="hljs-attr">user</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">isLoading</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">error</span>: <span class="hljs-literal">null</span> });
state.isLoading = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 状态变化触发视图更新</span>
</code></pre>
<ol start="3">
<li><strong>列表数据处理</strong></li>
</ol>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">todoList</span> = <span class="hljs-title function_ invoke__">reactive</span>({ <span class="hljs-attr">items</span>: [], <span class="hljs-attr">filter</span>: <span class="hljs-string">"all"</span> });
todoList.items.<span class="hljs-title function_ invoke__">push</span>({ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">"学习 Vue 3"</span> }); <span class="hljs-comment">// 列表更新自动渲染</span>
</code></pre>
<h3 data-id="heading-36">（八）注意事项（避免失去响应式）</h3>
<ol>
<li>
<p><strong>禁止直接解构</strong></p>
<ul>
<li>错误：<code>const { count } = reactive({ count: 0 }); count++</code>（失去响应式）。</li>
<li>正确：使用 <code>toRefs</code> 保持响应式：</li>
</ul>
</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">import { toRefs } from "vue"<span class="hljs-comment">;</span>
const <span class="hljs-attr">state</span> = reactive({ count: <span class="hljs-number">0</span> })<span class="hljs-comment">;</span>
const { count } = toRefs(state)<span class="hljs-comment">;</span>
count.value++<span class="hljs-comment">; // ✅ 正常触发更新</span>
</code></pre>
<ol start="2">
<li>
<p><strong>不能整体替换对象</strong></p>
<ul>
<li>错误：<code>let state = reactive({ count: 0 }); state = reactive({ count: 100 })</code>（原响应式关联失效）。</li>
<li>正确：修改属性或使用 <code>Object.assign</code>：</li>
</ul>
</li>
</ol>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">state.count</span> = <span class="hljs-number">100</span><span class="hljs-comment">; // 直接修改属性</span>
Object.assign(state, { count: 100 })<span class="hljs-comment">; // 合并更新</span>
</code></pre>
<h3 data-id="heading-37">（九）总结</h3>
<p><code>reactive</code> 的核心价值是为对象类型数据添加 “自动响应式” 能力：</p>
<ol>
<li>✅ 数据变化 → 视图自动同步，无需手动操作 DOM。</li>
<li>✅ 适配表单、状态、列表等多种业务场景。</li>
<li>✅ 深层响应式设计，嵌套对象无需额外处理。</li>
<li>⚠️ 注意避免 “解构” 和 “整体替换”，防止失去响应式。</li>
<li>⚠️ 基本类型需用 <code>ref</code>，<code>reactive</code> 仅适用于复杂对象类型。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Trae Solo 开发体验：从零到完整考试备考平台的奇妙之旅]]></title>    <link>https://juejin.cn/post/7573519273030221870</link>    <guid>https://juejin.cn/post/7573519273030221870</guid>    <pubDate>2025-11-17T13:50:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573519273030221870" data-draft-id="7573525927793246234" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Trae Solo 开发体验：从零到完整考试备考平台的奇妙之旅"/> <meta itemprop="keywords" content="Trae,前端"/> <meta itemprop="datePublished" content="2025-11-17T13:50:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="yigenhuochai"/> <meta itemprop="url" content="https://juejin.cn/user/3139860942044942"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Trae Solo 开发体验：从零到完整考试备考平台的奇妙之旅
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3139860942044942/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    yigenhuochai
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T13:50:33.000Z" title="Mon Nov 17 2025 13:50:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Trae Solo 开发体验：从零到完整考试备考平台的奇妙之旅</h2>
<blockquote>
<p><strong>项目背景</strong>：使用 Trae Solo 开发一个功能完整的考试备考应用「考试宝」，模拟真实考试软件的功能和体验。</p>
</blockquote>
<h3 data-id="heading-1">🎯 项目起源</h3>
<p>一切始于一个简单的需求："从头编写一个开发类似考试宝的应用，不需要支付功能。用户应该有：选择题库、练习、背诵、模拟考试、错题、收藏等功能。"</p>
<p>这个需求看似简单，但当我深入思考后，意识到这是一个相当完整的应用开发挑战。从用户界面设计到数据管理，从学习逻辑到统计分析，每一个环节都需要精心设计和实现。</p>
<h3 data-id="heading-2">🚀 Trae Solo 的魔法开始</h3>
<h4 data-id="heading-3">智能需求分析</h4>
<p>Trae Solo 的第一步让我印象深刻。它没有急于开始编码，而是首先创建了详细的产品需求文档：</p>
<ul>
<li><strong>核心功能模块</strong>：题库选择、练习模式、背诵模式、模拟考试、错题管理、收藏功能</li>
<li><strong>用户系统设计</strong>：注册登录、个人中心、学习统计</li>
<li><strong>技术架构规划</strong>：React + TypeScript + Vite + Tailwind CSS</li>
<li><strong>数据模型设计</strong>：完整的 TypeScript 接口定义</li>
</ul>
<p>这种系统化的思考方式，让整个开发过程有了清晰的方向。</p>
<h4 data-id="heading-4">项目初始化</h4>
<p>在技术选型上，Trae Solo 展现了其专业性：</p>
<pre><code class="hljs language-bash" lang="bash">npm create vite@latest . --template react-ts
</code></pre>
<p>选择了 React + TypeScript 的现代化技术栈，搭配 Vite 的快速构建能力，为后续开发奠定了坚实基础。</p>
<h3 data-id="heading-5">🎨 开发过程的精彩瞬间</h3>
<h4 data-id="heading-6">1. 架构设计的艺术</h4>
<p>Trae Solo 采用了模块化的项目结构：</p>
<pre><code class="hljs language-bash" lang="bash">src/
├── components/     <span class="hljs-comment"># 可复用组件</span>
├── pages/         <span class="hljs-comment"># 页面组件</span>
├── stores/        <span class="hljs-comment"># 状态管理</span>
├── data/          <span class="hljs-comment"># 数据层</span>
├── types/         <span class="hljs-comment"># TypeScript类型</span>
└── contexts/      <span class="hljs-comment"># React上下文</span>
</code></pre>
<p>这种清晰的架构设计让代码维护变得异常简单，每个模块都有明确的职责边界。</p>
<h4 data-id="heading-7">2. 状态管理的优雅实现</h4>
<p>使用 Zustand 作为状态管理工具，轻量级却功能强大：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">AppState</span> {
  <span class="hljs-attr">currentUser</span>: <span class="hljs-title class_">User</span> | <span class="hljs-literal">null</span>;
  <span class="hljs-attr">selectedBank</span>: <span class="hljs-title class_">QuestionBank</span> | <span class="hljs-literal">null</span>;
  <span class="hljs-attr">currentQuestion</span>: <span class="hljs-title class_">Question</span> | <span class="hljs-literal">null</span>;
  <span class="hljs-comment">// ... 其他状态</span>
}
</code></pre>
<p>相比 Redux 的复杂性，Zustand 提供了更简洁的 API，让状态管理变得直观易懂。</p>
<h4 data-id="heading-8">3. 组件化开发的魅力</h4>
<p>每个组件都遵循单一职责原则，保持代码的简洁性和可维护性：</p>
<ul>
<li><strong>FavoriteButton</strong>: 动画收藏按钮，支持多种尺寸</li>
<li><strong>StudyStatsChart</strong>: 学习统计图表，集成 Recharts 数据可视化</li>
<li><strong>QuestionFilter</strong>: 智能题目筛选器，支持多维度筛选</li>
<li><strong>StudyReminder</strong>: 学习提醒系统，自定义提醒规则</li>
</ul>
<h4 data-id="heading-9">4. 数据可视化的震撼</h4>
<p>集成 Recharts 库，创建了令人印象深刻的数据可视化：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 正确率分布饼图</span>
&lt;<span class="hljs-title class_">PieChart</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Pie</span> <span class="hljs-attr">data</span>=<span class="hljs-string">{accuracyData}</span>&gt;</span>
    {accuracyData.map((entry, index) =&gt; (
      <span class="hljs-tag">&lt;<span class="hljs-name">Cell</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">cell-</span>${<span class="hljs-attr">index</span>}`} <span class="hljs-attr">fill</span>=<span class="hljs-string">{COLORS[index</span> % <span class="hljs-attr">COLORS.length</span>]} /&gt;</span>
    ))}
  <span class="hljs-tag">&lt;/<span class="hljs-name">Pie</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">PieChart</span>&gt;

<span class="hljs-comment">// 学习趋势折线图</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">LineChart</span> <span class="hljs-attr">data</span>=<span class="hljs-string">{weeklyData}</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">XAxis</span> <span class="hljs-attr">dataKey</span>=<span class="hljs-string">"day"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">YAxis</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Line</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"monotone"</span> <span class="hljs-attr">dataKey</span>=<span class="hljs-string">"correct"</span> <span class="hljs-attr">stroke</span>=<span class="hljs-string">"#10b981"</span> <span class="hljs-attr">strokeWidth</span>=<span class="hljs-string">{2}</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">LineChart</span>&gt;</span></span>
</code></pre>
<p>这些图表不仅美观，更重要的是提供了有价值的学习洞察。</p>
<h3 data-id="heading-10">🛠️ 技术亮点解析</h3>
<h4 data-id="heading-11">1. TypeScript 的类型安全</h4>
<p>完整的类型定义确保了代码的健壮性：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Question</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">content</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">options</span>: <span class="hljs-built_in">string</span>[];
  <span class="hljs-attr">correctAnswer</span>: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">string</span>[];
  explanation?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">difficulty</span>: <span class="hljs-string">'easy'</span> | <span class="hljs-string">'medium'</span> | <span class="hljs-string">'hard'</span>;
  <span class="hljs-attr">knowledgePoints</span>: <span class="hljs-built_in">string</span>[];
}
</code></pre>
<p>编译时的类型检查大大减少了运行时错误。</p>
<h4 data-id="heading-12">2. 响应式设计的完美实现</h4>
<p>使用 Tailwind CSS 实现了真正的移动端优先设计：</p>
<pre><code class="hljs language-tsx" lang="tsx">&lt;div className=<span class="hljs-string">"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"</span>&gt;
  {<span class="hljs-comment">/* 自适应布局 */</span>}
&lt;/div&gt;
</code></pre>
<p>从手机到平板再到桌面，每个设备都有最佳的显示效果。</p>
<h4 data-id="heading-13">3. 智能交互体验</h4>
<p>动画效果增强了用户体验：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.transition-all</span> {
  <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span> ease;
}

<span class="hljs-selector-class">.hover</span>\:scale-<span class="hljs-number">105</span>:hover {
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-number">1.05</span>);
}
</code></pre>
<p>按钮悬停、卡片切换、收藏动画，每个细节都经过精心设计。</p>
<h3 data-id="heading-14">🎪 功能展示</h3>
<h4 data-id="heading-15">核心学习模式</h4>
<ol>
<li><strong>练习模式</strong>：顺序答题，即时反馈</li>
<li><strong>背诵模式</strong>：隐藏答案，自我检测</li>
<li><strong>模拟考试</strong>：限时答题，真实模拟</li>
</ol>
<h4 data-id="heading-16">智能管理系统</h4>
<ol>
<li><strong>错题自动收集</strong>：答错题目自动进入错题本</li>
<li><strong>收藏功能</strong>：重要题目一键收藏</li>
<li><strong>进度跟踪</strong>：实时显示学习进度和正确率</li>
</ol>
<h4 data-id="heading-17">数据洞察</h4>
<ol>
<li><strong>学习统计</strong>：总答题数、正确率、学习天数</li>
<li><strong>图表分析</strong>：正确率分布、学习趋势</li>
<li><strong>详细报告</strong>：按题库、题型、难度的多维度分析</li>
</ol>
<h3 data-id="heading-18">🚀 开发效率的提升</h3>
<h4 data-id="heading-19">1. 智能代码生成</h4>
<p>Trae Solo 的代码生成质量令人惊讶：</p>
<ul>
<li><strong>逻辑完整性</strong>：考虑了各种边界情况</li>
<li><strong>最佳实践</strong>：遵循 React 和 TypeScript 的最佳实践</li>
<li><strong>性能优化</strong>：避免不必要的重新渲染</li>
<li><strong>可维护性</strong>：代码结构清晰，注释适当</li>
</ul>
<h4 data-id="heading-20">2. 实时错误修复</h4>
<p>开发过程中遇到的错误都能快速定位和修复：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 修复前：日期格式化错误</span>
currentUser.<span class="hljs-property">createdAt</span>.<span class="hljs-title function_">toLocaleDateString</span>() <span class="hljs-comment">// ❌ 可能报错</span>

<span class="hljs-comment">// 修复后：类型安全的日期处理</span>
currentUser.<span class="hljs-property">createdAt</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Date</span> 
  ? currentUser.<span class="hljs-property">createdAt</span>.<span class="hljs-title function_">toLocaleDateString</span>() 
  : <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(currentUser.<span class="hljs-property">createdAt</span>).<span class="hljs-title function_">toLocaleDateString</span>() <span class="hljs-comment">// ✅ 安全处理</span>
</code></pre>
<h4 data-id="heading-21">3. 文档自动生成</h4>
<p>完整的文档生成，包括：</p>
<ul>
<li><strong>API 文档</strong>：详细的接口说明</li>
<li><strong>使用指南</strong>：step-by-step 的操作说明</li>
<li><strong>开发指南</strong>：如何扩展和维护项目</li>
</ul>
<h3 data-id="heading-22">💡 开发感悟</h3>
<h4 data-id="heading-23">1. AI 辅助开发的威力</h4>
<p>Trae Solo 展现了 AI 在软件开发中的巨大潜力：</p>
<ul>
<li><strong>效率提升</strong>：传统需要数周的项目，现在几天就能完成</li>
<li><strong>质量保证</strong>：自动遵循最佳实践，减少低级错误</li>
<li><strong>学习价值</strong>：生成的代码本身就是很好的学习材料</li>
</ul>
<h4 data-id="heading-24">2. 人机协作的完美平衡</h4>
<p>AI 不是替代开发者，而是成为强大的助手：</p>
<ul>
<li><strong>创意实现</strong>：将抽象的需求转化为具体的实现</li>
<li><strong>技术选型</strong>：根据项目特点选择合适的技术栈</li>
<li><strong>架构设计</strong>：提供合理的项目结构和模块划分</li>
</ul>
<h4 data-id="heading-25">3. 持续迭代的力量</h4>
<p>项目的成功在于持续的改进和完善：</p>
<ul>
<li><strong>需求理解</strong>：从基本功能到完整体验的演进</li>
<li><strong>技术优化</strong>：从能用到好用的提升</li>
<li><strong>用户体验</strong>：从功能实现到体验优化的关注</li>
</ul>
<h3 data-id="heading-26">🎨 项目成果展示</h3>
<h4 data-id="heading-27">核心数据</h4>
<ul>
<li><strong>代码行数</strong>：超过 3000 行高质量 TypeScript 代码</li>
<li><strong>组件数量</strong>：20+ 个精心设计的 React 组件</li>
<li><strong>功能模块</strong>：10+ 个完整的业务功能模块</li>
<li><strong>开发时间</strong>：数小时完成完整应用开发</li>
</ul>
<h4 data-id="heading-28">技术亮点</h4>
<ul>
<li><strong>类型安全</strong>：100% TypeScript 类型覆盖</li>
<li><strong>响应式设计</strong>：完美的移动端适配</li>
<li><strong>性能优化</strong>：组件级别的性能优化</li>
<li><strong>用户体验</strong>：流畅的动画和交互效果</li>
</ul>
<h3 data-id="heading-29">🚀 未来展望</h3>
<p>这个项目的成功让我对 AI 辅助开发充满信心：</p>
<h4 data-id="heading-30">短期目标</h4>
<ul>
<li><strong>功能增强</strong>：添加更多学习模式和题库类型</li>
<li><strong>性能优化</strong>：进一步优化加载速度和响应性能</li>
<li><strong>用户体验</strong>：持续改进界面设计和交互流程</li>
</ul>
<h4 data-id="heading-31">长期愿景</h4>
<ul>
<li><strong>智能化升级</strong>：集成 AI 推荐算法，个性化学习路径</li>
<li><strong>社交功能</strong>：添加学习社区和竞赛功能</li>
<li><strong>多端同步</strong>：支持跨设备数据同步</li>
</ul>
<h3 data-id="heading-32">📝 总结</h3>
<p>通过 Trae Solo 开发「考试宝」项目，我深刻体会到了 AI 辅助开发的强大威力：</p>
<ol>
<li><strong>效率革命</strong>：开发效率提升 10 倍以上</li>
<li><strong>质量保证</strong>：自动遵循最佳实践，代码质量有保障</li>
<li><strong>学习成长</strong>：在项目中学习到了很多新技术和设计模式</li>
<li><strong>创意实现</strong>：将抽象的想法快速转化为现实</li>
</ol>
<p>Trae Solo 不仅是一个开发工具，更是开发者的得力助手。它让开发变得更有趣，让创意更容易实现，让技术更有温度。</p>
<blockquote>
<p><strong>项目代码地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2FAlexander360%2Ftrae_tiku" target="_blank" title="https://gitee.com/Alexander360/trae_tiku" ref="nofollow noopener noreferrer">gitee.com/Alexander36…</a><br/>
<strong>技术栈</strong>：React + TypeScript + Vite + Tailwind CSS + Zustand + Recharts<br/>
<strong>开发工具</strong>：Trae Solo AI 编程助手</p>
</blockquote>
<p>这次开发经历让我相信，AI 辅助开发不是未来，而是现在。拥抱 AI，让开发更高效，让创意更自由！</p>
<hr/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24e632891205458c82c63cc8d0faa3f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeWlnZW5odW9jaGFp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763992233&amp;x-signature=1DSBLUqa28tDo4No9LHjp5juo6o%3D" alt="1.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b8ba50840db43a0a0734bea715e6459~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeWlnZW5odW9jaGFp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763992233&amp;x-signature=ck9R4D2uJ635J8oRcPUMPtIn%2FHk%3D" alt="2.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d57f5bca127d49d094d3466e048bcc53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeWlnZW5odW9jaGFp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763992233&amp;x-signature=ucR5o1g3ljM8E7NTEG2EBAw1CvE%3D" alt="3.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/258386c868084909ac1fb91e503b5d38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeWlnZW5odW9jaGFp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763992233&amp;x-signature=s%2FUMdeKEUFAwpkLwteAcWDZj7HA%3D" alt="4.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[优化 WebView 图片长按体验：JS Bridge 实现原生与网页端分发机制]]></title>    <link>https://juejin.cn/post/7573511426867855379</link>    <guid>https://juejin.cn/post/7573511426867855379</guid>    <pubDate>2025-11-17T12:32:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573511426867855379" data-draft-id="7573525634212266027" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="优化 WebView 图片长按体验：JS Bridge 实现原生与网页端分发机制"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-17T12:32:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户4165967369355"/> <meta itemprop="url" content="https://juejin.cn/user/1146150492576877"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            优化 WebView 图片长按体验：JS Bridge 实现原生与网页端分发机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1146150492576877/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户4165967369355
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T12:32:07.000Z" title="Mon Nov 17 2025 12:32:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读52分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://juejin.cn/post/7571378103282237446" target="_blank" title="https://juejin.cn/post/7571378103282237446">之前的文章</a>中处理了WebView中图片长按保存的逻辑，但有时我们的业务中还存在着一些JS的长按交互逻辑，这时<strong>原生 (Native) 端</strong> 弹出菜单（如保存图片、识别二维码）和<strong>网页 (JS) 端</strong> 自行处理就可能会存在冲突。本文就尝试解决这一问题。</p>
<hr/>
<h2 data-id="heading-0">🎯 核心问题与解决方案</h2>
<h3 data-id="heading-1">问题：</h3>
<ol>
<li><strong>长按事件分发：</strong> 如何在原生端的 <code>onLongPress</code> 或类似回调中，判断当前被长按的图片是否应该被原生接管？</li>
<li><strong>Data URI 处理：</strong> 对于 <code>data:image/jpeg;base64,...</code> 格式的图片，其 URL 字符串往往非常长，直接作为 Key 传递和存储效率极低，且可能超出某些系统限制。</li>
</ol>
<h3 data-id="heading-2">解决方案：</h3>
<p>引入一个 <strong><code>ImageLpRegistry</code></strong>（长按图片注册表）作为 Native 和 JS 之间的桥梁。</p>
<ul>
<li><strong>JS 侧：</strong> 负责收集需要原生处理的长按图片（通过特定属性如 <code>data-lp='native'</code> 标识），并将其 <strong>规范化的 Key</strong> 通过 JS Bridge 注册到 Native 侧。</li>
<li><strong>Native 侧：</strong> 通过 <code>ImageLpRegistry</code> 维护已注册图片的 Key 集合，并在接收到长按事件时，根据 Key 快速判断是否应该由原生处理。</li>
</ul>
<hr/>
<h2 data-id="heading-3">🏗️ <code>ImageLpRegistry</code>：图片 Key 的规范化管理</h2>
<p>为了解决 Data URI 的存储和传输问题，我们采用 <strong>MD5 摘要</strong> 作为其在注册表中的 Key。</p>
<h3 data-id="heading-4">1. Key 的规范化规则</h3>
<p><code>ImageLpRegistry</code> 统一了两种图片 Key 的格式：</p>




















<table><thead><tr><th><strong>图片类型</strong></th><th><strong>JS 侧生成 Key 规则</strong></th><th><strong>Native 侧存储 Key 示例</strong></th></tr></thead><tbody><tr><td><strong>普通 URL</strong></td><td>原始 URL 字符串</td><td><code>https://example.com/img.jpg</code></td></tr><tr><td><strong>Data URI</strong></td><td><code>md5:</code> + Data URI 内容的 MD5 摘要</td><td><code>md5:e10adc3949ba59abbe56e057f20f883e</code></td></tr></tbody></table>
<blockquote>
<p>🔑 <strong>关键优势：</strong> MD5 摘要显著缩短了 Key 的长度，且 JS/Native <strong>只需要保证 MD5 算法一致</strong> 即可实现准确匹配。同时，Native 侧不再重复计算 MD5，而是直接使用 JS 传入的 Key，避免重复计算和潜在的兼容性问题。</p>
</blockquote>
<h3 data-id="heading-5">2. 代码实现细节 (<code>ImageLpRegistry</code>)</h3>
<p>Kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ImageLpRegistry</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> <span class="hljs-keyword">set</span> = ConcurrentHashMap.newKeySet&lt;String&gt;()

  <span class="hljs-meta">@JavascriptInterface</span>
  <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">put</span><span class="hljs-params">(key: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-keyword">if</span> (key.isEmpty()) <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">set</span>.add(key)
  }

  <span class="hljs-meta">@JavascriptInterface</span>
  <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">remove</span><span class="hljs-params">(key: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-keyword">if</span> (key.isEmpty()) <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">set</span>.remove(key)
  }

  <span class="hljs-meta">@JavascriptInterface</span>
  <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">update</span><span class="hljs-params">(oldKey: <span class="hljs-type">String</span>, newKey: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-keyword">if</span> (oldKey.isNotEmpty()) <span class="hljs-keyword">set</span>.remove(oldKey)
    <span class="hljs-keyword">if</span> (newKey.isNotEmpty()) <span class="hljs-keyword">set</span>.add(newKey)
  }

  <span class="hljs-comment">// ---- Native 辅助：根据 raw src 或已传入的 key 规范化 ----</span>
  <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">md5</span><span class="hljs-params">(raw: <span class="hljs-type">String</span>)</span></span>: String {
    <span class="hljs-keyword">val</span> md = MessageDigest.getInstance(<span class="hljs-string">"MD5"</span>)
    <span class="hljs-keyword">val</span> digest = md.digest(raw.toByteArray(Charsets.UTF_8))
    <span class="hljs-keyword">val</span> joinToString = digest.joinToString(<span class="hljs-string">""</span>) {b -&gt; <span class="hljs-string">"%02x"</span>.format(b)}
    <span class="hljs-keyword">return</span> joinToString
  }

  <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">normalizeKey</span><span class="hljs-params">(input: <span class="hljs-type">String</span>)</span></span>: String {
    <span class="hljs-keyword">if</span> (input.startsWith(<span class="hljs-string">"md5:"</span>)) <span class="hljs-keyword">return</span> input <span class="hljs-comment">// 已经是 key</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (input.startsWith(<span class="hljs-string">"data:"</span>)) <span class="hljs-string">"md5:<span class="hljs-subst">${md5(input)}</span>"</span> <span class="hljs-keyword">else</span> input
  }

  <span class="hljs-comment">/**
   * 是否为已注册图片（传入原始 src 或 key 均可）
   */</span>
  <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isNative</span><span class="hljs-params">(rawOrKey: <span class="hljs-type">String</span>?)</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">if</span> (rawOrKey.isNullOrEmpty()) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-comment">// 先直接查原值，再哈希规范化（避免重复 md5）</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">set</span>.contains(rawOrKey)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    <span class="hljs-keyword">val</span> key = normalizeKey(rawOrKey)
    <span class="hljs-keyword">val</span> exists = <span class="hljs-keyword">set</span>.contains(key)
    <span class="hljs-keyword">return</span> exists
  }

  <span class="hljs-comment">/**
   * 获取注册时的 key（md5:xxxx 或原始 URL），不存在返回 null
   */</span>
  <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">keyFor</span><span class="hljs-params">(rawOrKey: <span class="hljs-type">String</span>?)</span></span>: String? {
    <span class="hljs-keyword">if</span> (rawOrKey.isNullOrEmpty()) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">set</span>.contains(rawOrKey)) <span class="hljs-keyword">return</span> rawOrKey
    <span class="hljs-keyword">val</span> key = normalizeKey(rawOrKey)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">set</span>.contains(key)) key <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span>
  }

  <span class="hljs-comment">/** JS 可选直接查询（传入 raw 或 key） */</span>
  <span class="hljs-meta">@JavascriptInterface</span>
  <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">query</span><span class="hljs-params">(rawOrKey: <span class="hljs-type">String</span>)</span></span>: <span class="hljs-built_in">Boolean</span> = isNative(rawOrKey)

  <span class="hljs-comment">/** 兼容旧接口：存在则返回 "native" */</span>
  <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">get</span><span class="hljs-params">(key: <span class="hljs-type">String</span>?)</span></span>: String? = <span class="hljs-keyword">if</span> (isNative(key)) <span class="hljs-string">"native"</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span>

  <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">clear</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">set</span>.clear()
  }
}
</code></pre>
<ul>
<li><strong>线程安全：</strong> 使用 <code>ConcurrentHashMap.newKeySet()</code> 确保线程安全，因为 <code>@JavascriptInterface</code> 方法在 JS Bridge 线程执行，而 Native 查询可能在主线程或其他线程执行。</li>
</ul>
<hr/>
<h2 data-id="heading-6">💻 注入与协同：JS/Native 协作流程</h2>
<p>为了让这套机制工作，我们需要在 WebView 加载完成后注入 JS 脚本，实现图片的观察和注册。</p>
<h3 data-id="heading-7">1. Native 侧注入 (<code>IWebviewImageLpHandler</code>)</h3>
<p>Kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">IWebviewImageLpHandler</span> {
  <span class="hljs-keyword">var</span> imageLpRegistry: ImageLpRegistry?

  <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">registerImageLp</span><span class="hljs-params">(view: <span class="hljs-type">WebView</span>)</span></span> {
    <span class="hljs-comment">// 初始化注册表并注入 JS Bridge 对象</span>
    <span class="hljs-keyword">val</span> registry = imageLpRegistry ?: ImageLpRegistry().also { imageLpRegistry = it }
    view.addJavascriptInterface(registry, <span class="hljs-string">"AndroidLp"</span>)
  }


    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">injectCollector</span><span class="hljs-params">(view: <span class="hljs-type">WebView</span>?)</span></span> {
      view ?: <span class="hljs-keyword">return</span>
      <span class="hljs-keyword">val</span> cryptoJsScript = withContext(Dispatchers.IO) {
        view.context?.readJsFromAssets(<span class="hljs-string">"crypto-js.min.js"</span>)
      }
      <span class="hljs-keyword">if</span> (cryptoJsScript.isNullOrEmpty()) { 
        <span class="hljs-keyword">return</span>
      }

      <span class="hljs-keyword">val</span> logicScript = withContext(Dispatchers.IO) {view.context?.readJsFromAssets(<span class="hljs-string">"image_lp_logic.js"</span>)}
      <span class="hljs-keyword">if</span> (logicScript.isNullOrEmpty()) { <span class="hljs-comment">// Consider logging this failure.</span>
        <span class="hljs-keyword">return</span>
      }
      <span class="hljs-keyword">val</span> fullScript = <span class="hljs-string">"<span class="hljs-variable">$cryptoJsScript</span>\n<span class="hljs-variable">$logicScript</span>"</span>
      view.evaluateJavascript(fullScript, <span class="hljs-literal">null</span>)
    }
}
</code></pre>
<p>JavaScript</p>
<pre><code class="hljs language-css" lang="css">//js中不同的md5方法计算出来的值可能和安卓平台计算的值不一样，经测试，以下js中的计算结果与安卓平台结果一致
//crypto-js<span class="hljs-selector-class">.min</span><span class="hljs-selector-class">.js</span> 
!function(t,e){"<span class="hljs-selector-tag">object</span>"==typeof exports?module<span class="hljs-selector-class">.exports</span>=exports=e():<span class="hljs-string">"function"</span>==typeof define&amp;&amp;define.amd?<span class="hljs-built_in">define</span>([],e):t.AndroidCryptoJS=<span class="hljs-built_in">e</span>()}(this,function(){<span class="hljs-selector-tag">var</span> W,O,<span class="hljs-selector-tag">I</span>,U,K,X,L,l,j,T,t,N,<span class="hljs-selector-tag">q</span>,e,Z,V,G,J,<span class="hljs-selector-tag">Q</span>,Y,$,t1,e1,r1,i1,o1,n1,s,s1,c1,a1,<span class="hljs-selector-tag">h1</span>,l1,o,f1,r,d1,u1,n,c,<span class="hljs-selector-tag">a</span>,h,f,d,<span class="hljs-selector-tag">i</span>=function(h){<span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">i</span>;if("undefined"!=typeof window&amp;&amp;window<span class="hljs-selector-class">.crypto</span>&amp;&amp;(<span class="hljs-selector-tag">i</span>=window<span class="hljs-selector-class">.crypto</span>),"undefined"!=typeof self&amp;&amp;self<span class="hljs-selector-class">.crypto</span>&amp;&amp;(<span class="hljs-selector-tag">i</span>=self<span class="hljs-selector-class">.crypto</span>),!(<span class="hljs-selector-tag">i</span>=!(<span class="hljs-selector-tag">i</span>=!(<span class="hljs-selector-tag">i</span>="undefined"!=typeof globalThis&amp;&amp;globalThis<span class="hljs-selector-class">.crypto</span>?globalThis<span class="hljs-selector-class">.crypto</span>:i)&amp;&amp;<span class="hljs-string">"undefined"</span>!=typeof window&amp;&amp;window.msCrypto?window.msCrypto:i)&amp;&amp;<span class="hljs-string">"undefined"</span>!=typeof global&amp;&amp;global.crypto?global.crypto:i)&amp;&amp;<span class="hljs-string">"function"</span>==typeof require)try{<span class="hljs-selector-tag">i</span>=require("crypto")}catch(t){}<span class="hljs-selector-tag">var</span> r=<span class="hljs-selector-tag">Object</span><span class="hljs-selector-class">.create</span>||function(t){return e<span class="hljs-selector-class">.prototype</span>=t,t=new e,e<span class="hljs-selector-class">.prototype</span>=null,t};function e(){}<span class="hljs-selector-tag">var</span> t={},o=t<span class="hljs-selector-class">.lib</span>={},n=o<span class="hljs-selector-class">.Base</span>={extend:<span class="hljs-built_in">function</span>(t){<span class="hljs-selector-tag">var</span> e=r(this);return t&amp;&amp;e<span class="hljs-selector-class">.mixIn</span>(t),e<span class="hljs-selector-class">.hasOwnProperty</span>("init")&amp;&amp;this<span class="hljs-selector-class">.init</span>!==e<span class="hljs-selector-class">.init</span>||(e<span class="hljs-selector-class">.init</span>=function(){e.$super<span class="hljs-selector-class">.init</span><span class="hljs-selector-class">.apply</span>(this,arguments)}),(e<span class="hljs-selector-class">.init</span><span class="hljs-selector-class">.prototype</span>=e).$super=this,e},create:<span class="hljs-built_in">function</span>(){<span class="hljs-selector-tag">var</span> t=this<span class="hljs-selector-class">.extend</span>();return t<span class="hljs-selector-class">.init</span><span class="hljs-selector-class">.apply</span>(t,arguments),t},init:<span class="hljs-built_in">function</span>(){},mixIn:<span class="hljs-built_in">function</span>(t){for(<span class="hljs-selector-tag">var</span> e in t)t<span class="hljs-selector-class">.hasOwnProperty</span>(e)&amp;&amp;(this<span class="hljs-selector-attr">[e]</span>=t<span class="hljs-selector-attr">[e]</span>);t<span class="hljs-selector-class">.hasOwnProperty</span>("toString")&amp;&amp;(this<span class="hljs-selector-class">.toString</span>=t<span class="hljs-selector-class">.toString</span>)},clone:<span class="hljs-built_in">function</span>(){return this<span class="hljs-selector-class">.init</span><span class="hljs-selector-class">.prototype</span><span class="hljs-selector-class">.extend</span>(this)}},l=o<span class="hljs-selector-class">.WordArray</span>=n<span class="hljs-selector-class">.extend</span>({init:<span class="hljs-built_in">function</span>(t,e){t=this<span class="hljs-selector-class">.words</span>=t||<span class="hljs-selector-attr">[]</span>,this<span class="hljs-selector-class">.sigBytes</span>=null!=e?e:<span class="hljs-number">4</span>*t.length},toString:<span class="hljs-built_in">function</span>(t){return(t||c)<span class="hljs-selector-class">.stringify</span>(this)},concat:<span class="hljs-built_in">function</span>(t){<span class="hljs-selector-tag">var</span> e=this<span class="hljs-selector-class">.words</span>,r=t<span class="hljs-selector-class">.words</span>,<span class="hljs-selector-tag">i</span>=this<span class="hljs-selector-class">.sigBytes</span>,o=t<span class="hljs-selector-class">.sigBytes</span>;if(this<span class="hljs-selector-class">.clamp</span>(),<span class="hljs-selector-tag">i</span>%<span class="hljs-number">4</span>)for(<span class="hljs-selector-tag">var</span> n=<span class="hljs-number">0</span>;n&lt;o;n++){<span class="hljs-selector-tag">var</span> s=r<span class="hljs-selector-attr">[n&gt;&gt;&gt;2]</span>&gt;&gt;&gt;<span class="hljs-number">24</span>-n%<span class="hljs-number">4</span>*<span class="hljs-number">8</span>&amp;<span class="hljs-number">255</span>;e<span class="hljs-selector-attr">[i+n&gt;&gt;&gt;2]</span>|=s&lt;&lt;<span class="hljs-number">24</span>-(<span class="hljs-selector-tag">i</span>+n)%<span class="hljs-number">4</span>*<span class="hljs-number">8</span>}else for(<span class="hljs-selector-tag">var</span> c=<span class="hljs-number">0</span>;c&lt;o;c+=<span class="hljs-number">4</span>)e<span class="hljs-selector-attr">[i+c&gt;&gt;&gt;2]</span>=r<span class="hljs-selector-attr">[c&gt;&gt;&gt;2]</span>;return this<span class="hljs-selector-class">.sigBytes</span>+=o,this},clamp:<span class="hljs-built_in">function</span>(){<span class="hljs-selector-tag">var</span> t=this<span class="hljs-selector-class">.words</span>,e=this<span class="hljs-selector-class">.sigBytes</span>;t<span class="hljs-selector-attr">[e&gt;&gt;&gt;2]</span>&amp;=<span class="hljs-number">4294967295</span>&lt;&lt;<span class="hljs-number">32</span>-e%<span class="hljs-number">4</span>*<span class="hljs-number">8</span>,t<span class="hljs-selector-class">.length</span>=h<span class="hljs-selector-class">.ceil</span>(e/<span class="hljs-number">4</span>)},clone:<span class="hljs-built_in">function</span>(){<span class="hljs-selector-tag">var</span> t=n<span class="hljs-selector-class">.clone</span><span class="hljs-selector-class">.call</span>(this);return t<span class="hljs-selector-class">.words</span>=this<span class="hljs-selector-class">.words</span><span class="hljs-selector-class">.slice</span>(<span class="hljs-number">0</span>),t},random:<span class="hljs-built_in">function</span>(t){for(<span class="hljs-selector-tag">var</span> e=<span class="hljs-selector-attr">[]</span>,r=<span class="hljs-number">0</span>;r&lt;t;r+=<span class="hljs-number">4</span>)e<span class="hljs-selector-class">.push</span>(function(){if(<span class="hljs-selector-tag">i</span>){if("function"==typeof <span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.getRandomValues</span>)try{return <span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.getRandomValues</span>(new Uint32Array(<span class="hljs-number">1</span>))<span class="hljs-selector-attr">[0]</span>}catch(t){}if("function"==typeof <span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.randomBytes</span>)try{return <span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.randomBytes</span>(<span class="hljs-number">4</span>)<span class="hljs-selector-class">.readInt32LE</span>()}catch(t){}}throw new Error("Native crypto module could not be used <span class="hljs-selector-tag">to</span> get secure random number.")}());return new l<span class="hljs-selector-class">.init</span>(e,t)}}),s=t<span class="hljs-selector-class">.enc</span>={},c=s<span class="hljs-selector-class">.Hex</span>={stringify:<span class="hljs-built_in">function</span>(t){for(<span class="hljs-selector-tag">var</span> e=t<span class="hljs-selector-class">.words</span>,r=t<span class="hljs-selector-class">.sigBytes</span>,<span class="hljs-selector-tag">i</span>=<span class="hljs-selector-attr">[]</span>,o=<span class="hljs-number">0</span>;o&lt;r;o++){<span class="hljs-selector-tag">var</span> n=e<span class="hljs-selector-attr">[o&gt;&gt;&gt;2]</span>&gt;&gt;&gt;<span class="hljs-number">24</span>-o%<span class="hljs-number">4</span>*<span class="hljs-number">8</span>&amp;<span class="hljs-number">255</span>;<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.push</span>((n&gt;&gt;&gt;<span class="hljs-number">4</span>)<span class="hljs-selector-class">.toString</span>(<span class="hljs-number">16</span>)),<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.push</span>((<span class="hljs-number">15</span>&amp;n)<span class="hljs-selector-class">.toString</span>(<span class="hljs-number">16</span>))}return <span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.join</span>("")},parse:<span class="hljs-built_in">function</span>(t){for(<span class="hljs-selector-tag">var</span> e=t<span class="hljs-selector-class">.length</span>,r=<span class="hljs-selector-attr">[]</span>,<span class="hljs-selector-tag">i</span>=<span class="hljs-number">0</span>;<span class="hljs-selector-tag">i</span>&lt;e;<span class="hljs-selector-tag">i</span>+=<span class="hljs-number">2</span>)r<span class="hljs-selector-attr">[i&gt;&gt;&gt;3]</span>|=parseInt(t<span class="hljs-selector-class">.substr</span>(<span class="hljs-selector-tag">i</span>,<span class="hljs-number">2</span>),<span class="hljs-number">16</span>)&lt;&lt;<span class="hljs-number">24</span>-<span class="hljs-selector-tag">i</span>%<span class="hljs-number">8</span>*<span class="hljs-number">4</span>;return new l<span class="hljs-selector-class">.init</span>(r,e/<span class="hljs-number">2</span>)}},<span class="hljs-selector-tag">a</span>=s<span class="hljs-selector-class">.Latin1</span>={stringify:<span class="hljs-built_in">function</span>(t){for(<span class="hljs-selector-tag">var</span> e=t<span class="hljs-selector-class">.words</span>,r=t<span class="hljs-selector-class">.sigBytes</span>,<span class="hljs-selector-tag">i</span>=<span class="hljs-selector-attr">[]</span>,o=<span class="hljs-number">0</span>;o&lt;r;o++){<span class="hljs-selector-tag">var</span> n=e<span class="hljs-selector-attr">[o&gt;&gt;&gt;2]</span>&gt;&gt;&gt;<span class="hljs-number">24</span>-o%<span class="hljs-number">4</span>*<span class="hljs-number">8</span>&amp;<span class="hljs-number">255</span>;<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.push</span>(String<span class="hljs-selector-class">.fromCharCode</span>(n))}return <span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.join</span>("")},parse:<span class="hljs-built_in">function</span>(t){for(<span class="hljs-selector-tag">var</span> e=t<span class="hljs-selector-class">.length</span>,r=<span class="hljs-selector-attr">[]</span>,<span class="hljs-selector-tag">i</span>=<span class="hljs-number">0</span>;<span class="hljs-selector-tag">i</span>&lt;e;<span class="hljs-selector-tag">i</span>++)r<span class="hljs-selector-attr">[i&gt;&gt;&gt;2]</span>|=(<span class="hljs-number">255</span>&amp;t<span class="hljs-selector-class">.charCodeAt</span>(<span class="hljs-selector-tag">i</span>))&lt;&lt;<span class="hljs-number">24</span>-<span class="hljs-selector-tag">i</span>%<span class="hljs-number">4</span>*<span class="hljs-number">8</span>;return new l<span class="hljs-selector-class">.init</span>(r,e)}},f=s<span class="hljs-selector-class">.Utf8</span>={stringify:<span class="hljs-built_in">function</span>(t){try{return decodeURIComponent(escape(<span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.stringify</span>(t)))}catch(t){throw new Error("Malformed UTF-<span class="hljs-number">8</span> data")}},parse:<span class="hljs-built_in">function</span>(t){return <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.parse</span>(unescape(encodeURIComponent(t)))}},d=o<span class="hljs-selector-class">.BufferedBlockAlgorithm</span>=n<span class="hljs-selector-class">.extend</span>({reset:<span class="hljs-built_in">function</span>(){this._data=new l<span class="hljs-selector-class">.init</span>,this._nDataBytes=<span class="hljs-number">0</span>},_append:<span class="hljs-built_in">function</span>(t){"string"==typeof t&amp;&amp;(t=f<span class="hljs-selector-class">.parse</span>(t)),this._data<span class="hljs-selector-class">.concat</span>(t),this._nDataBytes+=t<span class="hljs-selector-class">.sigBytes</span>},_process:<span class="hljs-built_in">function</span>(t){<span class="hljs-selector-tag">var</span> e,r=this._data,<span class="hljs-selector-tag">i</span>=r<span class="hljs-selector-class">.words</span>,o=r<span class="hljs-selector-class">.sigBytes</span>,n=this<span class="hljs-selector-class">.blockSize</span>,s=o/(<span class="hljs-number">4</span>*n),c=(s=t?h<span class="hljs-selector-class">.ceil</span>(s):h.<span class="hljs-built_in">max</span>((<span class="hljs-number">0</span>|s)-this._minBufferSize,<span class="hljs-number">0</span>))*n,t=h.<span class="hljs-built_in">min</span>(<span class="hljs-number">4</span>*c,o);if(c){for(<span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">a</span>=<span class="hljs-number">0</span>;<span class="hljs-selector-tag">a</span>&lt;c;<span class="hljs-selector-tag">a</span>+=n)this._doProcessBlock(<span class="hljs-selector-tag">i</span>,<span class="hljs-selector-tag">a</span>);e=<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.splice</span>(<span class="hljs-number">0</span>,c),r<span class="hljs-selector-class">.sigBytes-</span>=t}return new l<span class="hljs-selector-class">.init</span>(e,t)},clone:<span class="hljs-built_in">function</span>(){<span class="hljs-selector-tag">var</span> t=n<span class="hljs-selector-class">.clone</span><span class="hljs-selector-class">.call</span>(this);return t._data=this._data<span class="hljs-selector-class">.clone</span>(),t},_minBufferSize:<span class="hljs-number">0</span>}),u=(o<span class="hljs-selector-class">.Hasher</span>=d<span class="hljs-selector-class">.extend</span>({cfg:n.<span class="hljs-built_in">extend</span>(),init:<span class="hljs-built_in">function</span>(t){this<span class="hljs-selector-class">.cfg</span>=this<span class="hljs-selector-class">.cfg</span><span class="hljs-selector-class">.extend</span>(t),this<span class="hljs-selector-class">.reset</span>()},reset:<span class="hljs-built_in">function</span>(){d<span class="hljs-selector-class">.reset</span><span class="hljs-selector-class">.call</span>(this),this._doReset()},update:<span class="hljs-built_in">function</span>(t){return this._append(t),this._process(),this},finalize:<span class="hljs-built_in">function</span>(t){return t&amp;&amp;this._append(t),this._doFinalize()},blockSize:<span class="hljs-number">16</span>,_createHelper:<span class="hljs-built_in">function</span>(r){return function(t,e){return new r<span class="hljs-selector-class">.init</span>(e)<span class="hljs-selector-class">.finalize</span>(t)}},_createHmacHelper:<span class="hljs-built_in">function</span>(r){return function(t,e){return new u<span class="hljs-selector-class">.HMAC</span><span class="hljs-selector-class">.init</span>(r,e)<span class="hljs-selector-class">.finalize</span>(t)}}}),t<span class="hljs-selector-class">.algo</span>={});return t}(Math),u=(u=(<span class="hljs-selector-tag">p</span>=<span class="hljs-selector-tag">i</span>)<span class="hljs-selector-class">.lib</span>,W=u<span class="hljs-selector-class">.Base</span>,O=u<span class="hljs-selector-class">.WordArray</span>,(u=<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.x64</span>={})<span class="hljs-selector-class">.Word</span>=W<span class="hljs-selector-class">.extend</span>({init:<span class="hljs-built_in">function</span>(t,e){this<span class="hljs-selector-class">.high</span>=t,this<span class="hljs-selector-class">.low</span>=e}}),u<span class="hljs-selector-class">.WordArray</span>=W<span class="hljs-selector-class">.extend</span>({init:<span class="hljs-built_in">function</span>(t,e){t=this<span class="hljs-selector-class">.words</span>=t||<span class="hljs-selector-attr">[]</span>,this<span class="hljs-selector-class">.sigBytes</span>=null!=e?e:<span class="hljs-number">8</span>*t.length},toX32:<span class="hljs-built_in">function</span>(){for(<span class="hljs-selector-tag">var</span> t=this<span class="hljs-selector-class">.words</span>,e=t<span class="hljs-selector-class">.length</span>,r=<span class="hljs-selector-attr">[]</span>,<span class="hljs-selector-tag">i</span>=<span class="hljs-number">0</span>;<span class="hljs-selector-tag">i</span>&lt;e;<span class="hljs-selector-tag">i</span>++){<span class="hljs-selector-tag">var</span> o=t<span class="hljs-selector-attr">[i]</span>;r<span class="hljs-selector-class">.push</span>(o<span class="hljs-selector-class">.high</span>),r<span class="hljs-selector-class">.push</span>(o<span class="hljs-selector-class">.low</span>)}return O<span class="hljs-selector-class">.create</span>(r,this<span class="hljs-selector-class">.sigBytes</span>)},clone:<span class="hljs-built_in">function</span>(){for(<span class="hljs-selector-tag">var</span> t=W<span class="hljs-selector-class">.clone</span><span class="hljs-selector-class">.call</span>(this),e=t<span class="hljs-selector-class">.words</span>=this<span class="hljs-selector-class">.words</span><span class="hljs-selector-class">.slice</span>(<span class="hljs-number">0</span>),r=e<span class="hljs-selector-class">.length</span>,<span class="hljs-selector-tag">i</span>=<span class="hljs-number">0</span>;<span class="hljs-selector-tag">i</span>&lt;r;<span class="hljs-selector-tag">i</span>++)e<span class="hljs-selector-attr">[i]</span>=e<span class="hljs-selector-attr">[i]</span><span class="hljs-selector-class">.clone</span>();return t}}),"function"==typeof ArrayBuffer&amp;&amp;(<span class="hljs-selector-tag">p</span>=<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.lib</span><span class="hljs-selector-class">.WordArray</span>,<span class="hljs-selector-tag">I</span>=<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.init</span>,(<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.init</span>=function(t){if((t=(t=t instanceof ArrayBuffer?new Uint8Array(t):t)instanceof Int8Array||<span class="hljs-string">"undefined"</span>!=typeof Uint8ClampedArray&amp;&amp;t instanceof Uint8ClampedArray||t instanceof Int16Array||t instanceof Uint16Array||t instanceof Int32Array||t instanceof Uint32Array||t instanceof Float32Array||t instanceof Float64Array?new <span class="hljs-built_in">Uint8Array</span>(t.buffer,t.byteOffset,t.byteLength):t)instanceof Uint8Array){for(<span class="hljs-selector-tag">var</span> e=t<span class="hljs-selector-class">.byteLength</span>,r=<span class="hljs-selector-attr">[]</span>,<span class="hljs-selector-tag">i</span>=<span class="hljs-number">0</span>;<span class="hljs-selector-tag">i</span>&lt;e;<span class="hljs-selector-tag">i</span>++)r<span class="hljs-selector-attr">[i&gt;&gt;&gt;2]</span>|=t<span class="hljs-selector-attr">[i]</span>&lt;&lt;<span class="hljs-number">24</span>-<span class="hljs-selector-tag">i</span>%<span class="hljs-number">4</span>*<span class="hljs-number">8</span>;<span class="hljs-selector-tag">I</span><span class="hljs-selector-class">.call</span>(this,r,e)}else <span class="hljs-selector-tag">I</span><span class="hljs-selector-class">.apply</span>(this,arguments)})<span class="hljs-selector-class">.prototype</span>=<span class="hljs-selector-tag">p</span>),<span class="hljs-selector-tag">i</span>),p1=u<span class="hljs-selector-class">.lib</span><span class="hljs-selector-class">.WordArray</span>;function _1(t){return t&lt;&lt;<span class="hljs-number">8</span>&amp;<span class="hljs-number">4278255360</span>|t&gt;&gt;&gt;<span class="hljs-number">8</span>&amp;<span class="hljs-number">16711935</span>}(u=u<span class="hljs-selector-class">.enc</span>)<span class="hljs-selector-class">.Utf16</span>=u<span class="hljs-selector-class">.Utf16BE</span>={stringify:<span class="hljs-built_in">function</span>(t){for(<span class="hljs-selector-tag">var</span> e=t<span class="hljs-selector-class">.words</span>,r=t<span class="hljs-selector-class">.sigBytes</span>,<span class="hljs-selector-tag">i</span>=<span class="hljs-selector-attr">[]</span>,o=<span class="hljs-number">0</span>;o&lt;r;o+=<span class="hljs-number">2</span>){<span class="hljs-selector-tag">var</span> n=e<span class="hljs-selector-attr">[o&gt;&gt;&gt;2]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>-o%<span class="hljs-number">4</span>*<span class="hljs-number">8</span>&amp;<span class="hljs-number">65535</span>;<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.push</span>(String<span class="hljs-selector-class">.fromCharCode</span>(n))}return <span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.join</span>("")},parse:<span class="hljs-built_in">function</span>(t){for(<span class="hljs-selector-tag">var</span> e=t<span class="hljs-selector-class">.length</span>,r=<span class="hljs-selector-attr">[]</span>,<span class="hljs-selector-tag">i</span>=<span class="hljs-number">0</span>;<span class="hljs-selector-tag">i</span>&lt;e;<span class="hljs-selector-tag">i</span>++)r<span class="hljs-selector-attr">[i&gt;&gt;&gt;1]</span>|=t<span class="hljs-selector-class">.charCodeAt</span>(<span class="hljs-selector-tag">i</span>)&lt;&lt;<span class="hljs-number">16</span>-<span class="hljs-selector-tag">i</span>%<span class="hljs-number">2</span>*<span class="hljs-number">16</span>;return p1<span class="hljs-selector-class">.create</span>(r,<span class="hljs-number">2</span>*e)}},u<span class="hljs-selector-class">.Utf16LE</span>={stringify:<span class="hljs-built_in">function</span>(t){for(<span class="hljs-selector-tag">var</span> e=t<span class="hljs-selector-class">.words</span>,r=t<span class="hljs-selector-class">.sigBytes</span>,<span class="hljs-selector-tag">i</span>=<span class="hljs-selector-attr">[]</span>,o=<span class="hljs-number">0</span>;o&lt;r;o+=<span class="hljs-number">2</span>){<span class="hljs-selector-tag">var</span> n=_1(e<span class="hljs-selector-attr">[o&gt;&gt;&gt;2]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>-o%<span class="hljs-number">4</span>*<span class="hljs-number">8</span>&amp;<span class="hljs-number">65535</span>);<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.push</span>(String<span class="hljs-selector-class">.fromCharCode</span>(n))}return <span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.join</span>("")},parse:<span class="hljs-built_in">function</span>(t){for(<span class="hljs-selector-tag">var</span> e=t<span class="hljs-selector-class">.length</span>,r=<span class="hljs-selector-attr">[]</span>,<span class="hljs-selector-tag">i</span>=<span class="hljs-number">0</span>;<span class="hljs-selector-tag">i</span>&lt;e;<span class="hljs-selector-tag">i</span>++)r<span class="hljs-selector-attr">[i&gt;&gt;&gt;1]</span>|=_1(t<span class="hljs-selector-class">.charCodeAt</span>(<span class="hljs-selector-tag">i</span>)&lt;&lt;<span class="hljs-number">16</span>-<span class="hljs-selector-tag">i</span>%<span class="hljs-number">2</span>*<span class="hljs-number">16</span>);return p1<span class="hljs-selector-class">.create</span>(r,<span class="hljs-number">2</span>*e)}},U=(<span class="hljs-selector-tag">p</span>=<span class="hljs-selector-tag">i</span>)<span class="hljs-selector-class">.lib</span><span class="hljs-selector-class">.WordArray</span>,<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.enc</span><span class="hljs-selector-class">.Base64</span>={stringify:<span class="hljs-built_in">function</span>(t){for(<span class="hljs-selector-tag">var</span> e=t<span class="hljs-selector-class">.words</span>,r=t<span class="hljs-selector-class">.sigBytes</span>,<span class="hljs-selector-tag">i</span>=this._map,o=(t<span class="hljs-selector-class">.clamp</span>(),<span class="hljs-selector-attr">[]</span>),n=<span class="hljs-number">0</span>;n&lt;r;n+=<span class="hljs-number">3</span>)for(<span class="hljs-selector-tag">var</span> s=(e<span class="hljs-selector-attr">[n&gt;&gt;&gt;2]</span>&gt;&gt;&gt;<span class="hljs-number">24</span>-n%<span class="hljs-number">4</span>*<span class="hljs-number">8</span>&amp;<span class="hljs-number">255</span>)&lt;&lt;<span class="hljs-number">16</span>|(e<span class="hljs-selector-attr">[n+1&gt;&gt;&gt;2]</span>&gt;&gt;&gt;<span class="hljs-number">24</span>-(n+<span class="hljs-number">1</span>)%<span class="hljs-number">4</span>*<span class="hljs-number">8</span>&amp;<span class="hljs-number">255</span>)&lt;&lt;<span class="hljs-number">8</span>|e<span class="hljs-selector-attr">[n+2&gt;&gt;&gt;2]</span>&gt;&gt;&gt;<span class="hljs-number">24</span>-(n+<span class="hljs-number">2</span>)%<span class="hljs-number">4</span>*<span class="hljs-number">8</span>&amp;<span class="hljs-number">255</span>,c=<span class="hljs-number">0</span>;c&lt;<span class="hljs-number">4</span>&amp;&amp;n+.<span class="hljs-number">75</span>*c&lt;r;c++)o<span class="hljs-selector-class">.push</span>(<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.charAt</span>(s&gt;&gt;&gt;<span class="hljs-number">6</span>*(<span class="hljs-number">3</span>-c)&amp;<span class="hljs-number">63</span>));<span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">a</span>=<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.charAt</span>(<span class="hljs-number">64</span>);if(<span class="hljs-selector-tag">a</span>)for(;o<span class="hljs-selector-class">.length</span>%<span class="hljs-number">4</span>;)o<span class="hljs-selector-class">.push</span>(<span class="hljs-selector-tag">a</span>);return o<span class="hljs-selector-class">.join</span>("")},parse:<span class="hljs-built_in">function</span>(t){<span class="hljs-selector-tag">var</span> e=t<span class="hljs-selector-class">.length</span>,r=this._map;if(!(<span class="hljs-selector-tag">i</span>=this._reverseMap))for(<span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">i</span>=this._reverseMap=<span class="hljs-selector-attr">[]</span>,o=<span class="hljs-number">0</span>;o&lt;r<span class="hljs-selector-class">.length</span>;o++)<span class="hljs-selector-tag">i</span><span class="hljs-selector-attr">[r.charCodeAt(o)]</span>=o;for(<span class="hljs-selector-tag">var</span> n,s,c=r<span class="hljs-selector-class">.charAt</span>(<span class="hljs-number">64</span>),<span class="hljs-selector-tag">a</span>=(!c||-<span class="hljs-number">1</span>!==(c=t<span class="hljs-selector-class">.indexOf</span>(c))&amp;&amp;(e=c),t),h=e,l=<span class="hljs-selector-tag">i</span>,f=<span class="hljs-selector-attr">[]</span>,d=<span class="hljs-number">0</span>,u=<span class="hljs-number">0</span>;u&lt;h;u++)u%<span class="hljs-number">4</span>&amp;&amp;(s=l<span class="hljs-selector-attr">[a.charCodeAt(u-1)]</span>&lt;&lt;u%<span class="hljs-number">4</span>*<span class="hljs-number">2</span>,n=l<span class="hljs-selector-attr">[a.charCodeAt(u)]</span>&gt;&gt;&gt;<span class="hljs-number">6</span>-u%<span class="hljs-number">4</span>*<span class="hljs-number">2</span>,s=s|n,f<span class="hljs-selector-attr">[d&gt;&gt;&gt;2]</span>|=s&lt;&lt;<span class="hljs-number">24</span>-d%<span class="hljs-number">4</span>*<span class="hljs-number">8</span>,d++);return U<span class="hljs-selector-class">.create</span>(f,d)},_map:<span class="hljs-string">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="</span>},K=(u=<span class="hljs-selector-tag">i</span>)<span class="hljs-selector-class">.lib</span><span class="hljs-selector-class">.WordArray</span>,u<span class="hljs-selector-class">.enc</span><span class="hljs-selector-class">.Base64url</span>={stringify:<span class="hljs-built_in">function</span>(t,e){for(<span class="hljs-selector-tag">var</span> r=t<span class="hljs-selector-class">.words</span>,<span class="hljs-selector-tag">i</span>=t<span class="hljs-selector-class">.sigBytes</span>,o=(e=void <span class="hljs-number">0</span>===e?!<span class="hljs-number">0</span>:e)?this._safe_map:this._map,n=(t.<span class="hljs-built_in">clamp</span>(),[]),s=<span class="hljs-number">0</span>;s&lt;<span class="hljs-selector-tag">i</span>;s+=<span class="hljs-number">3</span>)for(<span class="hljs-selector-tag">var</span> c=(r<span class="hljs-selector-attr">[s&gt;&gt;&gt;2]</span>&gt;&gt;&gt;<span class="hljs-number">24</span>-s%<span class="hljs-number">4</span>*<span class="hljs-number">8</span>&amp;<span class="hljs-number">255</span>)&lt;&lt;<span class="hljs-number">16</span>|(r<span class="hljs-selector-attr">[s+1&gt;&gt;&gt;2]</span>&gt;&gt;&gt;<span class="hljs-number">24</span>-(s+<span class="hljs-number">1</span>)%<span class="hljs-number">4</span>*<span class="hljs-number">8</span>&amp;<span class="hljs-number">255</span>)&lt;&lt;<span class="hljs-number">8</span>|r<span class="hljs-selector-attr">[s+2&gt;&gt;&gt;2]</span>&gt;&gt;&gt;<span class="hljs-number">24</span>-(s+<span class="hljs-number">2</span>)%<span class="hljs-number">4</span>*<span class="hljs-number">8</span>&amp;<span class="hljs-number">255</span>,<span class="hljs-selector-tag">a</span>=<span class="hljs-number">0</span>;<span class="hljs-selector-tag">a</span>&lt;<span class="hljs-number">4</span>&amp;&amp;s+.<span class="hljs-number">75</span>*<span class="hljs-selector-tag">a</span>&lt;<span class="hljs-selector-tag">i</span>;<span class="hljs-selector-tag">a</span>++)n<span class="hljs-selector-class">.push</span>(o<span class="hljs-selector-class">.charAt</span>(c&gt;&gt;&gt;<span class="hljs-number">6</span>*(<span class="hljs-number">3</span>-<span class="hljs-selector-tag">a</span>)&amp;<span class="hljs-number">63</span>));<span class="hljs-selector-tag">var</span> h=o<span class="hljs-selector-class">.charAt</span>(<span class="hljs-number">64</span>);if(h)for(;n<span class="hljs-selector-class">.length</span>%<span class="hljs-number">4</span>;)n<span class="hljs-selector-class">.push</span>(h);return n<span class="hljs-selector-class">.join</span>("")},parse:<span class="hljs-built_in">function</span>(t,e){<span class="hljs-selector-tag">var</span> r=t<span class="hljs-selector-class">.length</span>,<span class="hljs-selector-tag">i</span>=(e=void <span class="hljs-number">0</span>===e?!<span class="hljs-number">0</span>:e)?this._safe_map:this._map;if(!(o=this._reverseMap))for(<span class="hljs-selector-tag">var</span> o=this._reverseMap=<span class="hljs-selector-attr">[]</span>,n=<span class="hljs-number">0</span>;n&lt;<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.length</span>;n++)o<span class="hljs-selector-attr">[i.charCodeAt(n)]</span>=n;for(<span class="hljs-selector-tag">var</span> s,c,e=<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.charAt</span>(<span class="hljs-number">64</span>),<span class="hljs-selector-tag">a</span>=(!e||-<span class="hljs-number">1</span>!==(e=t<span class="hljs-selector-class">.indexOf</span>(e))&amp;&amp;(r=e),t),h=r,l=o,f=<span class="hljs-selector-attr">[]</span>,d=<span class="hljs-number">0</span>,u=<span class="hljs-number">0</span>;u&lt;h;u++)u%<span class="hljs-number">4</span>&amp;&amp;(c=l<span class="hljs-selector-attr">[a.charCodeAt(u-1)]</span>&lt;&lt;u%<span class="hljs-number">4</span>*<span class="hljs-number">2</span>,s=l<span class="hljs-selector-attr">[a.charCodeAt(u)]</span>&gt;&gt;&gt;<span class="hljs-number">6</span>-u%<span class="hljs-number">4</span>*<span class="hljs-number">2</span>,c=c|s,f<span class="hljs-selector-attr">[d&gt;&gt;&gt;2]</span>|=c&lt;&lt;<span class="hljs-number">24</span>-d%<span class="hljs-number">4</span>*<span class="hljs-number">8</span>,d++);return K<span class="hljs-selector-class">.create</span>(f,d)},_map:<span class="hljs-string">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="</span>,_safe_map:<span class="hljs-string">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"</span>};for(<span class="hljs-selector-tag">var</span> y1=Math,<span class="hljs-selector-tag">p</span>=<span class="hljs-selector-tag">i</span>,g1=(u=<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.lib</span>)<span class="hljs-selector-class">.WordArray</span>,v1=u<span class="hljs-selector-class">.Hasher</span>,u=<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.algo</span>,<span class="hljs-selector-tag">A</span>=<span class="hljs-selector-attr">[]</span>,B1=<span class="hljs-number">0</span>;B1&lt;<span class="hljs-number">64</span>;B1++)<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[B1]</span>=<span class="hljs-number">4294967296</span>*y1<span class="hljs-selector-class">.abs</span>(y1<span class="hljs-selector-class">.sin</span>(B1+<span class="hljs-number">1</span>))|<span class="hljs-number">0</span>;function z(t,e,r,<span class="hljs-selector-tag">i</span>,o,n,s){t=t+(e&amp;r|~e&amp;<span class="hljs-selector-tag">i</span>)+o+s;return(t&lt;&lt;n|t&gt;&gt;&gt;<span class="hljs-number">32</span>-n)+e}function H(t,e,r,<span class="hljs-selector-tag">i</span>,o,n,s){t=t+(e&amp;<span class="hljs-selector-tag">i</span>|r&amp;~<span class="hljs-selector-tag">i</span>)+o+s;return(t&lt;&lt;n|t&gt;&gt;&gt;<span class="hljs-number">32</span>-n)+e}function C(t,e,r,<span class="hljs-selector-tag">i</span>,o,n,s){t=t+(e^r^<span class="hljs-selector-tag">i</span>)+o+s;return(t&lt;&lt;n|t&gt;&gt;&gt;<span class="hljs-number">32</span>-n)+e}function R(t,e,r,<span class="hljs-selector-tag">i</span>,o,n,s){t=t+(r^(e|~<span class="hljs-selector-tag">i</span>))+o+s;return(t&lt;&lt;n|t&gt;&gt;&gt;<span class="hljs-number">32</span>-n)+e}u=u<span class="hljs-selector-class">.MD5</span>=v1<span class="hljs-selector-class">.extend</span>({_doReset:<span class="hljs-built_in">function</span>(){this._hash=new g1<span class="hljs-selector-class">.init</span>(<span class="hljs-selector-attr">[1732584193,4023233417,2562383102,271733878]</span>)},_doProcessBlock:<span class="hljs-built_in">function</span>(t,e){for(<span class="hljs-selector-tag">var</span> r=<span class="hljs-number">0</span>;r&lt;<span class="hljs-number">16</span>;r++){<span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">i</span>=e+r,o=t<span class="hljs-selector-attr">[i]</span>;t<span class="hljs-selector-attr">[i]</span>=<span class="hljs-number">16711935</span>&amp;(o&lt;&lt;<span class="hljs-number">8</span>|o&gt;&gt;&gt;<span class="hljs-number">24</span>)|<span class="hljs-number">4278255360</span>&amp;(o&lt;&lt;<span class="hljs-number">24</span>|o&gt;&gt;&gt;<span class="hljs-number">8</span>)}<span class="hljs-selector-tag">var</span> n=this._hash<span class="hljs-selector-class">.words</span>,s=t<span class="hljs-selector-attr">[e+0]</span>,c=t<span class="hljs-selector-attr">[e+1]</span>,<span class="hljs-selector-tag">a</span>=t<span class="hljs-selector-attr">[e+2]</span>,h=t<span class="hljs-selector-attr">[e+3]</span>,l=t<span class="hljs-selector-attr">[e+4]</span>,f=t<span class="hljs-selector-attr">[e+5]</span>,d=t<span class="hljs-selector-attr">[e+6]</span>,u=t<span class="hljs-selector-attr">[e+7]</span>,<span class="hljs-selector-tag">p</span>=t<span class="hljs-selector-attr">[e+8]</span>,_=t<span class="hljs-selector-attr">[e+9]</span>,y=t<span class="hljs-selector-attr">[e+10]</span>,g=t<span class="hljs-selector-attr">[e+11]</span>,v=t<span class="hljs-selector-attr">[e+12]</span>,<span class="hljs-selector-tag">B</span>=t<span class="hljs-selector-attr">[e+13]</span>,w=t<span class="hljs-selector-attr">[e+14]</span>,k=t<span class="hljs-selector-attr">[e+15]</span>,x=z(n<span class="hljs-selector-attr">[0]</span>,S=n<span class="hljs-selector-attr">[1]</span>,m=n<span class="hljs-selector-attr">[2]</span>,<span class="hljs-selector-tag">b</span>=n<span class="hljs-selector-attr">[3]</span>,s,<span class="hljs-number">7</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[0]</span>),<span class="hljs-selector-tag">b</span>=z(<span class="hljs-selector-tag">b</span>,x,S,m,c,<span class="hljs-number">12</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[1]</span>),m=z(m,<span class="hljs-selector-tag">b</span>,x,S,<span class="hljs-selector-tag">a</span>,<span class="hljs-number">17</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[2]</span>),S=z(S,m,<span class="hljs-selector-tag">b</span>,x,h,<span class="hljs-number">22</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[3]</span>);x=z(x,S,m,<span class="hljs-selector-tag">b</span>,l,<span class="hljs-number">7</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[4]</span>),<span class="hljs-selector-tag">b</span>=z(<span class="hljs-selector-tag">b</span>,x,S,m,f,<span class="hljs-number">12</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[5]</span>),m=z(m,<span class="hljs-selector-tag">b</span>,x,S,d,<span class="hljs-number">17</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[6]</span>),S=z(S,m,<span class="hljs-selector-tag">b</span>,x,u,<span class="hljs-number">22</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[7]</span>),x=z(x,S,m,<span class="hljs-selector-tag">b</span>,<span class="hljs-selector-tag">p</span>,<span class="hljs-number">7</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[8]</span>),<span class="hljs-selector-tag">b</span>=z(<span class="hljs-selector-tag">b</span>,x,S,m,_,<span class="hljs-number">12</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[9]</span>),m=z(m,<span class="hljs-selector-tag">b</span>,x,S,y,<span class="hljs-number">17</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[10]</span>),S=z(S,m,<span class="hljs-selector-tag">b</span>,x,g,<span class="hljs-number">22</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[11]</span>),x=z(x,S,m,<span class="hljs-selector-tag">b</span>,v,<span class="hljs-number">7</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[12]</span>),<span class="hljs-selector-tag">b</span>=z(<span class="hljs-selector-tag">b</span>,x,S,m,<span class="hljs-selector-tag">B</span>,<span class="hljs-number">12</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[13]</span>),m=z(m,<span class="hljs-selector-tag">b</span>,x,S,w,<span class="hljs-number">17</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[14]</span>),x=H(x,S=z(S,m,<span class="hljs-selector-tag">b</span>,x,k,<span class="hljs-number">22</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[15]</span>),m,<span class="hljs-selector-tag">b</span>,c,<span class="hljs-number">5</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[16]</span>),<span class="hljs-selector-tag">b</span>=H(<span class="hljs-selector-tag">b</span>,x,S,m,d,<span class="hljs-number">9</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[17]</span>),m=H(m,<span class="hljs-selector-tag">b</span>,x,S,g,<span class="hljs-number">14</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[18]</span>),S=H(S,m,<span class="hljs-selector-tag">b</span>,x,s,<span class="hljs-number">20</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[19]</span>),x=H(x,S,m,<span class="hljs-selector-tag">b</span>,f,<span class="hljs-number">5</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[20]</span>),<span class="hljs-selector-tag">b</span>=H(<span class="hljs-selector-tag">b</span>,x,S,m,y,<span class="hljs-number">9</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[21]</span>),m=H(m,<span class="hljs-selector-tag">b</span>,x,S,k,<span class="hljs-number">14</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[22]</span>),S=H(S,m,<span class="hljs-selector-tag">b</span>,x,l,<span class="hljs-number">20</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[23]</span>),x=H(x,S,m,<span class="hljs-selector-tag">b</span>,_,<span class="hljs-number">5</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[24]</span>),<span class="hljs-selector-tag">b</span>=H(<span class="hljs-selector-tag">b</span>,x,S,m,w,<span class="hljs-number">9</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[25]</span>),m=H(m,<span class="hljs-selector-tag">b</span>,x,S,h,<span class="hljs-number">14</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[26]</span>),S=H(S,m,<span class="hljs-selector-tag">b</span>,x,<span class="hljs-selector-tag">p</span>,<span class="hljs-number">20</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[27]</span>),x=H(x,S,m,<span class="hljs-selector-tag">b</span>,<span class="hljs-selector-tag">B</span>,<span class="hljs-number">5</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[28]</span>),<span class="hljs-selector-tag">b</span>=H(<span class="hljs-selector-tag">b</span>,x,S,m,<span class="hljs-selector-tag">a</span>,<span class="hljs-number">9</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[29]</span>),m=H(m,<span class="hljs-selector-tag">b</span>,x,S,u,<span class="hljs-number">14</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[30]</span>),x=C(x,S=H(S,m,<span class="hljs-selector-tag">b</span>,x,v,<span class="hljs-number">20</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[31]</span>),m,<span class="hljs-selector-tag">b</span>,f,<span class="hljs-number">4</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[32]</span>),<span class="hljs-selector-tag">b</span>=C(<span class="hljs-selector-tag">b</span>,x,S,m,<span class="hljs-selector-tag">p</span>,<span class="hljs-number">11</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[33]</span>),m=C(m,<span class="hljs-selector-tag">b</span>,x,S,g,<span class="hljs-number">16</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[34]</span>),S=C(S,m,<span class="hljs-selector-tag">b</span>,x,w,<span class="hljs-number">23</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[35]</span>),x=C(x,S,m,<span class="hljs-selector-tag">b</span>,c,<span class="hljs-number">4</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[36]</span>),<span class="hljs-selector-tag">b</span>=C(<span class="hljs-selector-tag">b</span>,x,S,m,l,<span class="hljs-number">11</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[37]</span>),m=C(m,<span class="hljs-selector-tag">b</span>,x,S,u,<span class="hljs-number">16</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[38]</span>),S=C(S,m,<span class="hljs-selector-tag">b</span>,x,y,<span class="hljs-number">23</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[39]</span>),x=C(x,S,m,<span class="hljs-selector-tag">b</span>,<span class="hljs-selector-tag">B</span>,<span class="hljs-number">4</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[40]</span>),<span class="hljs-selector-tag">b</span>=C(<span class="hljs-selector-tag">b</span>,x,S,m,s,<span class="hljs-number">11</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[41]</span>),m=C(m,<span class="hljs-selector-tag">b</span>,x,S,h,<span class="hljs-number">16</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[42]</span>),S=C(S,m,<span class="hljs-selector-tag">b</span>,x,d,<span class="hljs-number">23</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[43]</span>),x=C(x,S,m,<span class="hljs-selector-tag">b</span>,_,<span class="hljs-number">4</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[44]</span>),<span class="hljs-selector-tag">b</span>=C(<span class="hljs-selector-tag">b</span>,x,S,m,v,<span class="hljs-number">11</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[45]</span>),m=C(m,<span class="hljs-selector-tag">b</span>,x,S,k,<span class="hljs-number">16</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[46]</span>),x=R(x,S=C(S,m,<span class="hljs-selector-tag">b</span>,x,<span class="hljs-selector-tag">a</span>,<span class="hljs-number">23</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[47]</span>),m,<span class="hljs-selector-tag">b</span>,s,<span class="hljs-number">6</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[48]</span>),<span class="hljs-selector-tag">b</span>=R(<span class="hljs-selector-tag">b</span>,x,S,m,u,<span class="hljs-number">10</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[49]</span>),m=R(m,<span class="hljs-selector-tag">b</span>,x,S,w,<span class="hljs-number">15</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[50]</span>),S=R(S,m,<span class="hljs-selector-tag">b</span>,x,f,<span class="hljs-number">21</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[51]</span>),x=R(x,S,m,<span class="hljs-selector-tag">b</span>,v,<span class="hljs-number">6</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[52]</span>),<span class="hljs-selector-tag">b</span>=R(<span class="hljs-selector-tag">b</span>,x,S,m,h,<span class="hljs-number">10</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[53]</span>),m=R(m,<span class="hljs-selector-tag">b</span>,x,S,y,<span class="hljs-number">15</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[54]</span>),S=R(S,m,<span class="hljs-selector-tag">b</span>,x,c,<span class="hljs-number">21</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[55]</span>),x=R(x,S,m,<span class="hljs-selector-tag">b</span>,<span class="hljs-selector-tag">p</span>,<span class="hljs-number">6</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[56]</span>),<span class="hljs-selector-tag">b</span>=R(<span class="hljs-selector-tag">b</span>,x,S,m,k,<span class="hljs-number">10</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[57]</span>),m=R(m,<span class="hljs-selector-tag">b</span>,x,S,d,<span class="hljs-number">15</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[58]</span>),S=R(S,m,<span class="hljs-selector-tag">b</span>,x,<span class="hljs-selector-tag">B</span>,<span class="hljs-number">21</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[59]</span>),x=R(x,S,m,<span class="hljs-selector-tag">b</span>,l,<span class="hljs-number">6</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[60]</span>),<span class="hljs-selector-tag">b</span>=R(<span class="hljs-selector-tag">b</span>,x,S,m,g,<span class="hljs-number">10</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[61]</span>),m=R(m,<span class="hljs-selector-tag">b</span>,x,S,<span class="hljs-selector-tag">a</span>,<span class="hljs-number">15</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[62]</span>),S=R(S,m,<span class="hljs-selector-tag">b</span>,x,_,<span class="hljs-number">21</span>,<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[63]</span>),n<span class="hljs-selector-attr">[0]</span>=n<span class="hljs-selector-attr">[0]</span>+x|<span class="hljs-number">0</span>,n<span class="hljs-selector-attr">[1]</span>=n<span class="hljs-selector-attr">[1]</span>+S|<span class="hljs-number">0</span>,n<span class="hljs-selector-attr">[2]</span>=n<span class="hljs-selector-attr">[2]</span>+m|<span class="hljs-number">0</span>,n<span class="hljs-selector-attr">[3]</span>=n<span class="hljs-selector-attr">[3]</span>+<span class="hljs-selector-tag">b</span>|<span class="hljs-number">0</span>},_doFinalize:<span class="hljs-built_in">function</span>(){for(<span class="hljs-selector-tag">var</span> t=this._data,e=t<span class="hljs-selector-class">.words</span>,r=<span class="hljs-number">8</span>*this._nDataBytes,<span class="hljs-selector-tag">i</span>=<span class="hljs-number">8</span>*t<span class="hljs-selector-class">.sigBytes</span>,o=(e<span class="hljs-selector-attr">[i&gt;&gt;&gt;5]</span>|=<span class="hljs-number">128</span>&lt;&lt;<span class="hljs-number">24</span>-<span class="hljs-selector-tag">i</span>%<span class="hljs-number">32</span>,y1<span class="hljs-selector-class">.floor</span>(r/<span class="hljs-number">4294967296</span>)),o=(e<span class="hljs-selector-attr">[15+(64+i&gt;&gt;&gt;9&lt;&lt;4)]</span>=<span class="hljs-number">16711935</span>&amp;(o&lt;&lt;<span class="hljs-number">8</span>|o&gt;&gt;&gt;<span class="hljs-number">24</span>)|<span class="hljs-number">4278255360</span>&amp;(o&lt;&lt;<span class="hljs-number">24</span>|o&gt;&gt;&gt;<span class="hljs-number">8</span>),e<span class="hljs-selector-attr">[14+(64+i&gt;&gt;&gt;9&lt;&lt;4)]</span>=<span class="hljs-number">16711935</span>&amp;(r&lt;&lt;<span class="hljs-number">8</span>|r&gt;&gt;&gt;<span class="hljs-number">24</span>)|<span class="hljs-number">4278255360</span>&amp;(r&lt;&lt;<span class="hljs-number">24</span>|r&gt;&gt;&gt;<span class="hljs-number">8</span>),t<span class="hljs-selector-class">.sigBytes</span>=<span class="hljs-number">4</span>*(e<span class="hljs-selector-class">.length</span>+<span class="hljs-number">1</span>),this._process(),this._hash),n=o<span class="hljs-selector-class">.words</span>,s=<span class="hljs-number">0</span>;s&lt;<span class="hljs-number">4</span>;s++){<span class="hljs-selector-tag">var</span> c=n<span class="hljs-selector-attr">[s]</span>;n<span class="hljs-selector-attr">[s]</span>=<span class="hljs-number">16711935</span>&amp;(c&lt;&lt;<span class="hljs-number">8</span>|c&gt;&gt;&gt;<span class="hljs-number">24</span>)|<span class="hljs-number">4278255360</span>&amp;(c&lt;&lt;<span class="hljs-number">24</span>|c&gt;&gt;&gt;<span class="hljs-number">8</span>)}return o},clone:<span class="hljs-built_in">function</span>(){<span class="hljs-selector-tag">var</span> t=v1<span class="hljs-selector-class">.clone</span><span class="hljs-selector-class">.call</span>(this);return t._hash=this._hash<span class="hljs-selector-class">.clone</span>(),t}}),<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.MD5</span>=v1._createHelper(u),<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.HmacMD5</span>=v1._createHmacHelper(u),u=(<span class="hljs-selector-tag">p</span>=<span class="hljs-selector-tag">i</span>)<span class="hljs-selector-class">.lib</span>,X=u<span class="hljs-selector-class">.WordArray</span>,L=u<span class="hljs-selector-class">.Hasher</span>,u=<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.algo</span>,l=<span class="hljs-selector-attr">[]</span>,u=u<span class="hljs-selector-class">.SHA1</span>=L<span class="hljs-selector-class">.extend</span>({_doReset:<span class="hljs-built_in">function</span>(){this._hash=new X<span class="hljs-selector-class">.init</span>(<span class="hljs-selector-attr">[1732584193,4023233417,2562383102,271733878,3285377520]</span>)},_doProcessBlock:<span class="hljs-built_in">function</span>(t,e){for(<span class="hljs-selector-tag">var</span> r=this._hash<span class="hljs-selector-class">.words</span>,<span class="hljs-selector-tag">i</span>=r<span class="hljs-selector-attr">[0]</span>,o=r<span class="hljs-selector-attr">[1]</span>,n=r<span class="hljs-selector-attr">[2]</span>,s=r<span class="hljs-selector-attr">[3]</span>,c=r<span class="hljs-selector-attr">[4]</span>,<span class="hljs-selector-tag">a</span>=<span class="hljs-number">0</span>;<span class="hljs-selector-tag">a</span>&lt;<span class="hljs-number">80</span>;<span class="hljs-selector-tag">a</span>++){<span class="hljs-selector-tag">a</span>&lt;<span class="hljs-number">16</span>?l<span class="hljs-selector-attr">[a]</span>=<span class="hljs-number">0</span>|t<span class="hljs-selector-attr">[e+a]</span>:(h=l[a-<span class="hljs-number">3</span>]^l[a-<span class="hljs-number">8</span>]^l[a-<span class="hljs-number">14</span>]^l[a-<span class="hljs-number">16</span>],l[a]=h&lt;&lt;<span class="hljs-number">1</span>|h&gt;&gt;&gt;<span class="hljs-number">31</span>);<span class="hljs-selector-tag">var</span> h=(<span class="hljs-selector-tag">i</span>&lt;&lt;<span class="hljs-number">5</span>|<span class="hljs-selector-tag">i</span>&gt;&gt;&gt;<span class="hljs-number">27</span>)+c+l<span class="hljs-selector-attr">[a]</span>;h+=<span class="hljs-selector-tag">a</span>&lt;<span class="hljs-number">20</span>?<span class="hljs-number">1518500249</span>+(o&amp;n|~o&amp;s):a&lt;<span class="hljs-number">40</span>?<span class="hljs-number">1859775393</span>+(o^n^s):a&lt;<span class="hljs-number">60</span>?(o&amp;n|o&amp;s|n&amp;s)-<span class="hljs-number">1894007588</span>:(o^n^s)-<span class="hljs-number">899497514</span>,c=s,s=n,n=o&lt;&lt;<span class="hljs-number">30</span>|o&gt;&gt;&gt;<span class="hljs-number">2</span>,o=i,i=h}r<span class="hljs-selector-attr">[0]</span>=r<span class="hljs-selector-attr">[0]</span>+<span class="hljs-selector-tag">i</span>|<span class="hljs-number">0</span>,r<span class="hljs-selector-attr">[1]</span>=r<span class="hljs-selector-attr">[1]</span>+o|<span class="hljs-number">0</span>,r<span class="hljs-selector-attr">[2]</span>=r<span class="hljs-selector-attr">[2]</span>+n|<span class="hljs-number">0</span>,r<span class="hljs-selector-attr">[3]</span>=r<span class="hljs-selector-attr">[3]</span>+s|<span class="hljs-number">0</span>,r<span class="hljs-selector-attr">[4]</span>=r<span class="hljs-selector-attr">[4]</span>+c|<span class="hljs-number">0</span>},_doFinalize:<span class="hljs-built_in">function</span>(){<span class="hljs-selector-tag">var</span> t=this._data,e=t<span class="hljs-selector-class">.words</span>,r=<span class="hljs-number">8</span>*this._nDataBytes,<span class="hljs-selector-tag">i</span>=<span class="hljs-number">8</span>*t<span class="hljs-selector-class">.sigBytes</span>;return e<span class="hljs-selector-attr">[i&gt;&gt;&gt;5]</span>|=<span class="hljs-number">128</span>&lt;&lt;<span class="hljs-number">24</span>-<span class="hljs-selector-tag">i</span>%<span class="hljs-number">32</span>,e<span class="hljs-selector-attr">[14+(64+i&gt;&gt;&gt;9&lt;&lt;4)]</span>=Math<span class="hljs-selector-class">.floor</span>(r/<span class="hljs-number">4294967296</span>),e<span class="hljs-selector-attr">[15+(64+i&gt;&gt;&gt;9&lt;&lt;4)]</span>=r,t<span class="hljs-selector-class">.sigBytes</span>=<span class="hljs-number">4</span>*e<span class="hljs-selector-class">.length</span>,this._process(),this._hash},clone:<span class="hljs-built_in">function</span>(){<span class="hljs-selector-tag">var</span> t=L<span class="hljs-selector-class">.clone</span><span class="hljs-selector-class">.call</span>(this);return t._hash=this._hash<span class="hljs-selector-class">.clone</span>(),t}}),<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.SHA1</span>=L._createHelper(u),<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.HmacSHA1</span>=L._createHmacHelper(u);<span class="hljs-selector-tag">var</span> w1=Math,<span class="hljs-selector-tag">p</span>=<span class="hljs-selector-tag">i</span>,k1=(u=<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.lib</span>)<span class="hljs-selector-class">.WordArray</span>,x1=u<span class="hljs-selector-class">.Hasher</span>,u=<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.algo</span>,b1=<span class="hljs-selector-attr">[]</span>,m1=<span class="hljs-selector-attr">[]</span>;function S1(t){return <span class="hljs-number">4294967296</span>*(t-(<span class="hljs-number">0</span>|t))|<span class="hljs-number">0</span>}for(<span class="hljs-selector-tag">var</span> A1=<span class="hljs-number">2</span>,z1=<span class="hljs-number">0</span>;z1&lt;<span class="hljs-number">64</span>;)!function(t){for(<span class="hljs-selector-tag">var</span> e=w1<span class="hljs-selector-class">.sqrt</span>(t),r=<span class="hljs-number">2</span>;r&lt;=e;r++)if(!(t%r))return;return <span class="hljs-number">1</span>}(A1)||(z1&lt;<span class="hljs-number">8</span>&amp;&amp;(b1<span class="hljs-selector-attr">[z1]</span>=S1(w1<span class="hljs-selector-class">.pow</span>(A1,.<span class="hljs-number">5</span>))),m1<span class="hljs-selector-attr">[z1]</span>=S1(w1<span class="hljs-selector-class">.pow</span>(A1,<span class="hljs-number">1</span>/<span class="hljs-number">3</span>)),z1++),A1++;<span class="hljs-selector-tag">var</span> _=<span class="hljs-selector-attr">[]</span>,u=u<span class="hljs-selector-class">.SHA256</span>=x1<span class="hljs-selector-class">.extend</span>({_doReset:<span class="hljs-built_in">function</span>(){this._hash=new k1<span class="hljs-selector-class">.init</span>(b1<span class="hljs-selector-class">.slice</span>(<span class="hljs-number">0</span>))},_doProcessBlock:<span class="hljs-built_in">function</span>(t,e){for(<span class="hljs-selector-tag">var</span> r=this._hash<span class="hljs-selector-class">.words</span>,<span class="hljs-selector-tag">i</span>=r<span class="hljs-selector-attr">[0]</span>,o=r<span class="hljs-selector-attr">[1]</span>,n=r<span class="hljs-selector-attr">[2]</span>,s=r<span class="hljs-selector-attr">[3]</span>,c=r<span class="hljs-selector-attr">[4]</span>,<span class="hljs-selector-tag">a</span>=r<span class="hljs-selector-attr">[5]</span>,h=r<span class="hljs-selector-attr">[6]</span>,l=r<span class="hljs-selector-attr">[7]</span>,f=<span class="hljs-number">0</span>;f&lt;<span class="hljs-number">64</span>;f++){f&lt;<span class="hljs-number">16</span>?_<span class="hljs-selector-attr">[f]</span>=<span class="hljs-number">0</span>|t<span class="hljs-selector-attr">[e+f]</span>:(d=_[f-<span class="hljs-number">15</span>],u=_[f-<span class="hljs-number">2</span>],_[f]=((d&lt;&lt;<span class="hljs-number">25</span>|d&gt;&gt;&gt;<span class="hljs-number">7</span>)^(d&lt;&lt;<span class="hljs-number">14</span>|d&gt;&gt;&gt;<span class="hljs-number">18</span>)^d&gt;&gt;&gt;<span class="hljs-number">3</span>)+_[f-<span class="hljs-number">7</span>]+((u&lt;&lt;<span class="hljs-number">15</span>|u&gt;&gt;&gt;<span class="hljs-number">17</span>)^(u&lt;&lt;<span class="hljs-number">13</span>|u&gt;&gt;&gt;<span class="hljs-number">19</span>)^u&gt;&gt;&gt;<span class="hljs-number">10</span>)+_[f-<span class="hljs-number">16</span>]);<span class="hljs-selector-tag">var</span> d=<span class="hljs-selector-tag">i</span>&amp;o^<span class="hljs-selector-tag">i</span>&amp;n^o&amp;n,u=l+((c&lt;&lt;<span class="hljs-number">26</span>|c&gt;&gt;&gt;<span class="hljs-number">6</span>)^(c&lt;&lt;<span class="hljs-number">21</span>|c&gt;&gt;&gt;<span class="hljs-number">11</span>)^(c&lt;&lt;<span class="hljs-number">7</span>|c&gt;&gt;&gt;<span class="hljs-number">25</span>))+(c&amp;<span class="hljs-selector-tag">a</span>^~c&amp;h)+m1<span class="hljs-selector-attr">[f]</span>+_<span class="hljs-selector-attr">[f]</span>,l=h,h=<span class="hljs-selector-tag">a</span>,<span class="hljs-selector-tag">a</span>=c,c=s+u|<span class="hljs-number">0</span>,s=n,n=o,o=<span class="hljs-selector-tag">i</span>,<span class="hljs-selector-tag">i</span>=u+(((<span class="hljs-selector-tag">i</span>&lt;&lt;<span class="hljs-number">30</span>|<span class="hljs-selector-tag">i</span>&gt;&gt;&gt;<span class="hljs-number">2</span>)^(<span class="hljs-selector-tag">i</span>&lt;&lt;<span class="hljs-number">19</span>|<span class="hljs-selector-tag">i</span>&gt;&gt;&gt;<span class="hljs-number">13</span>)^(<span class="hljs-selector-tag">i</span>&lt;&lt;<span class="hljs-number">10</span>|<span class="hljs-selector-tag">i</span>&gt;&gt;&gt;<span class="hljs-number">22</span>))+d)|<span class="hljs-number">0</span>}r<span class="hljs-selector-attr">[0]</span>=r<span class="hljs-selector-attr">[0]</span>+<span class="hljs-selector-tag">i</span>|<span class="hljs-number">0</span>,r<span class="hljs-selector-attr">[1]</span>=r<span class="hljs-selector-attr">[1]</span>+o|<span class="hljs-number">0</span>,r<span class="hljs-selector-attr">[2]</span>=r<span class="hljs-selector-attr">[2]</span>+n|<span class="hljs-number">0</span>,r<span class="hljs-selector-attr">[3]</span>=r<span class="hljs-selector-attr">[3]</span>+s|<span class="hljs-number">0</span>,r<span class="hljs-selector-attr">[4]</span>=r<span class="hljs-selector-attr">[4]</span>+c|<span class="hljs-number">0</span>,r<span class="hljs-selector-attr">[5]</span>=r<span class="hljs-selector-attr">[5]</span>+<span class="hljs-selector-tag">a</span>|<span class="hljs-number">0</span>,r<span class="hljs-selector-attr">[6]</span>=r<span class="hljs-selector-attr">[6]</span>+h|<span class="hljs-number">0</span>,r<span class="hljs-selector-attr">[7]</span>=r<span class="hljs-selector-attr">[7]</span>+l|<span class="hljs-number">0</span>},_doFinalize:<span class="hljs-built_in">function</span>(){<span class="hljs-selector-tag">var</span> t=this._data,e=t<span class="hljs-selector-class">.words</span>,r=<span class="hljs-number">8</span>*this._nDataBytes,<span class="hljs-selector-tag">i</span>=<span class="hljs-number">8</span>*t<span class="hljs-selector-class">.sigBytes</span>;return e<span class="hljs-selector-attr">[i&gt;&gt;&gt;5]</span>|=<span class="hljs-number">128</span>&lt;&lt;<span class="hljs-number">24</span>-<span class="hljs-selector-tag">i</span>%<span class="hljs-number">32</span>,e<span class="hljs-selector-attr">[14+(64+i&gt;&gt;&gt;9&lt;&lt;4)]</span>=w1<span class="hljs-selector-class">.floor</span>(r/<span class="hljs-number">4294967296</span>),e<span class="hljs-selector-attr">[15+(64+i&gt;&gt;&gt;9&lt;&lt;4)]</span>=r,t<span class="hljs-selector-class">.sigBytes</span>=<span class="hljs-number">4</span>*e<span class="hljs-selector-class">.length</span>,this._process(),this._hash},clone:<span class="hljs-built_in">function</span>(){<span class="hljs-selector-tag">var</span> t=x1<span class="hljs-selector-class">.clone</span><span class="hljs-selector-class">.call</span>(this);return t._hash=this._hash<span class="hljs-selector-class">.clone</span>(),t}}),<span class="hljs-selector-tag">p</span>=(<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.SHA256</span>=x1._createHelper(u),<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.HmacSHA256</span>=x1._createHmacHelper(u),j=(<span class="hljs-selector-tag">p</span>=<span class="hljs-selector-tag">i</span>)<span class="hljs-selector-class">.lib</span><span class="hljs-selector-class">.WordArray</span>,u=<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.algo</span>,T=u<span class="hljs-selector-class">.SHA256</span>,u=u<span class="hljs-selector-class">.SHA224</span>=T<span class="hljs-selector-class">.extend</span>({_doReset:<span class="hljs-built_in">function</span>(){this._hash=new j<span class="hljs-selector-class">.init</span>(<span class="hljs-selector-attr">[3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428]</span>)},_doFinalize:<span class="hljs-built_in">function</span>(){<span class="hljs-selector-tag">var</span> t=T._doFinalize<span class="hljs-selector-class">.call</span>(this);return t<span class="hljs-selector-class">.sigBytes-</span>=<span class="hljs-number">4</span>,t}}),<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.SHA224</span>=T._createHelper(u),<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.HmacSHA224</span>=T._createHmacHelper(u),<span class="hljs-selector-tag">i</span>),<span class="hljs-selector-tag">H1</span>=<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.lib</span><span class="hljs-selector-class">.Hasher</span>,y=(u=<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.x64</span>)<span class="hljs-selector-class">.Word</span>,C1=u<span class="hljs-selector-class">.WordArray</span>,u=<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.algo</span>;function g(){return y<span class="hljs-selector-class">.create</span><span class="hljs-selector-class">.apply</span>(y,arguments)}for(<span class="hljs-selector-tag">var</span> R1=<span class="hljs-selector-attr">[g(1116352408,3609767458),g(1899447441,602891725),g(3049323471,3964484399),g(3921009573,2173295548),g(961987163,4081628472),g(1508970993,3053834265),g(2453635748,2937671579),g(2870763221,3664609560),g(3624381080,2734883394),g(310598401,1164996542),g(607225278,1323610764),g(1426881987,3590304994),g(1925078388,4068182383),g(2162078206,991336113),g(2614888103,633803317),g(3248222580,3479774868),g(3835390401,2666613458),g(4022224774,944711139),g(264347078,2341262773),g(604807628,2007800933),g(770255983,1495990901),g(1249150122,1856431235),g(1555081692,3175218132),g(1996064986,2198950837),g(2554220882,3999719339),g(2821834349,766784016),g(2952996808,2566594879),g(3210313671,3203337956),g(3336571891,1034457026),g(3584528711,2466948901),g(113926993,3758326383),g(338241895,168717936),g(666307205,1188179964),g(773529912,1546045734),g(1294757372,1522805485),g(1396182291,2643833823),g(1695183700,2343527390),g(1986661051,1014477480),g(2177026350,1206759142),g(2456956037,344077627),g(2730485921,1290863460),g(2820302411,3158454273),g(3259730800,3505952657),g(3345764771,106217008),g(3516065817,3606008344),g(3600352804,1432725776),g(4094571909,1467031594),g(275423344,851169720),g(430227734,3100823752),g(506948616,1363258195),g(659060556,3750685593),g(883997877,3785050280),g(958139571,3318307427),g(1322822218,3812723403),g(1537002063,2003034995),g(1747873779,3602036899),g(1955562222,1575990012),g(2024104815,1125592928),g(2227730452,2716904306),g(2361852424,442776044),g(2428436474,593698344),g(2756734187,3733110249),g(3204031479,2999351573),g(3329325298,3815920427),g(3391569614,3928383900),g(3515267271,566280711),g(3940187606,3454069534),g(4118630271,4000239992),g(116418474,1914138554),g(174292421,2731055270),g(289380356,3203993006),g(460393269,320620315),g(685471733,587496836),g(852142971,1086792851),g(1017036298,365543100),g(1126000580,2618297676),g(1288033470,3409855158),g(1501505948,4234509866),g(1607167915,987167468),g(1816402316,1246189591)]</span>,D1=<span class="hljs-selector-attr">[]</span>,E1=<span class="hljs-number">0</span>;E1&lt;<span class="hljs-number">80</span>;E1++)D1<span class="hljs-selector-attr">[E1]</span>=g();u=u<span class="hljs-selector-class">.SHA512</span>=<span class="hljs-selector-tag">H1</span><span class="hljs-selector-class">.extend</span>({_doReset:<span class="hljs-built_in">function</span>(){this._hash=new C1<span class="hljs-selector-class">.init</span>(<span class="hljs-selector-attr">[new y.init(1779033703,4089235720),new y.init(3144134277,2227873595),new y.init(1013904242,4271175723),new y.init(2773480762,1595750129),new y.init(1359893119,2917565137),new y.init(2600822924,725511199),new y.init(528734635,4215389547),new y.init(1541459225,327033209)]</span>)},_doProcessBlock:<span class="hljs-built_in">function</span>(W,O){for(<span class="hljs-selector-tag">var</span> t=this._hash<span class="hljs-selector-class">.words</span>,e=t<span class="hljs-selector-attr">[0]</span>,r=t<span class="hljs-selector-attr">[1]</span>,<span class="hljs-selector-tag">i</span>=t<span class="hljs-selector-attr">[2]</span>,o=t<span class="hljs-selector-attr">[3]</span>,n=t<span class="hljs-selector-attr">[4]</span>,s=t<span class="hljs-selector-attr">[5]</span>,c=t<span class="hljs-selector-attr">[6]</span>,t=t<span class="hljs-selector-attr">[7]</span>,<span class="hljs-selector-tag">I</span>=e<span class="hljs-selector-class">.high</span>,<span class="hljs-selector-tag">a</span>=e<span class="hljs-selector-class">.low</span>,U=r<span class="hljs-selector-class">.high</span>,h=r<span class="hljs-selector-class">.low</span>,K=<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.high</span>,l=<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.low</span>,X=o<span class="hljs-selector-class">.high</span>,f=o<span class="hljs-selector-class">.low</span>,L=n<span class="hljs-selector-class">.high</span>,d=n<span class="hljs-selector-class">.low</span>,j=s<span class="hljs-selector-class">.high</span>,u=s<span class="hljs-selector-class">.low</span>,T=c<span class="hljs-selector-class">.high</span>,<span class="hljs-selector-tag">p</span>=c<span class="hljs-selector-class">.low</span>,N=t<span class="hljs-selector-class">.high</span>,_=t<span class="hljs-selector-class">.low</span>,y=<span class="hljs-selector-tag">I</span>,g=<span class="hljs-selector-tag">a</span>,v=U,<span class="hljs-selector-tag">B</span>=h,w=K,k=l,<span class="hljs-selector-tag">q</span>=X,x=f,<span class="hljs-selector-tag">b</span>=L,m=d,Z=j,S=u,V=T,G=<span class="hljs-selector-tag">p</span>,J=N,<span class="hljs-selector-tag">Q</span>=_,<span class="hljs-selector-tag">A</span>=<span class="hljs-number">0</span>;<span class="hljs-selector-tag">A</span>&lt;<span class="hljs-number">80</span>;<span class="hljs-selector-tag">A</span>++)<span class="hljs-selector-tag">var</span> z,H,C=D1<span class="hljs-selector-attr">[A]</span>,R=(<span class="hljs-selector-tag">A</span>&lt;<span class="hljs-number">16</span>?(H=C<span class="hljs-selector-class">.high</span>=<span class="hljs-number">0</span>|W<span class="hljs-selector-attr">[O+2*A]</span>,z=C<span class="hljs-selector-class">.low</span>=<span class="hljs-number">0</span>|W<span class="hljs-selector-attr">[O+2*A+1]</span>):(F=(P=D1[A-<span class="hljs-number">15</span>]).high,P=P.low,M=(E=D1[A-<span class="hljs-number">2</span>]).high,E=E.low,D=(R=D1[A-<span class="hljs-number">7</span>]).high,R=R.low,$=(Y=D1[A-<span class="hljs-number">16</span>]).high,H=(H=((F&gt;&gt;&gt;<span class="hljs-number">1</span>|P&lt;&lt;<span class="hljs-number">31</span>)^(F&gt;&gt;&gt;<span class="hljs-number">8</span>|P&lt;&lt;<span class="hljs-number">24</span>)^F&gt;&gt;&gt;<span class="hljs-number">7</span>)+D+((z=(D=(P&gt;&gt;&gt;<span class="hljs-number">1</span>|F&lt;&lt;<span class="hljs-number">31</span>)^(P&gt;&gt;&gt;<span class="hljs-number">8</span>|F&lt;&lt;<span class="hljs-number">24</span>)^(P&gt;&gt;&gt;<span class="hljs-number">7</span>|F&lt;&lt;<span class="hljs-number">25</span>))+R)&gt;&gt;&gt;<span class="hljs-number">0</span>&lt;D&gt;&gt;&gt;<span class="hljs-number">0</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>))+((M&gt;&gt;&gt;<span class="hljs-number">19</span>|E&lt;&lt;<span class="hljs-number">13</span>)^(M&lt;&lt;<span class="hljs-number">3</span>|E&gt;&gt;&gt;<span class="hljs-number">29</span>)^M&gt;&gt;&gt;<span class="hljs-number">6</span>)+((z+=P=(E&gt;&gt;&gt;<span class="hljs-number">19</span>|M&lt;&lt;<span class="hljs-number">13</span>)^(E&lt;&lt;<span class="hljs-number">3</span>|M&gt;&gt;&gt;<span class="hljs-number">29</span>)^(E&gt;&gt;&gt;<span class="hljs-number">6</span>|M&lt;&lt;<span class="hljs-number">26</span>))&gt;&gt;&gt;<span class="hljs-number">0</span>&lt;P&gt;&gt;&gt;<span class="hljs-number">0</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>),z+=F=Y.low,C.high=H=H+$+(z&gt;&gt;&gt;<span class="hljs-number">0</span>&lt;F&gt;&gt;&gt;<span class="hljs-number">0</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>),C.low=z),b&amp;Z^~b&amp;V),D=m&amp;S^~m&amp;G,E=y&amp;v^y&amp;w^v&amp;w,M=(g&gt;&gt;&gt;<span class="hljs-number">28</span>|y&lt;&lt;<span class="hljs-number">4</span>)^(g&lt;&lt;<span class="hljs-number">30</span>|y&gt;&gt;&gt;<span class="hljs-number">2</span>)^(g&lt;&lt;<span class="hljs-number">25</span>|y&gt;&gt;&gt;<span class="hljs-number">7</span>),P=R1[A],Y=P.high,$=P.low,F=Q+((m&gt;&gt;&gt;<span class="hljs-number">14</span>|b&lt;&lt;<span class="hljs-number">18</span>)^(m&gt;&gt;&gt;<span class="hljs-number">18</span>|b&lt;&lt;<span class="hljs-number">14</span>)^(m&lt;&lt;<span class="hljs-number">23</span>|b&gt;&gt;&gt;<span class="hljs-number">9</span>)),C=J+((b&gt;&gt;&gt;<span class="hljs-number">14</span>|m&lt;&lt;<span class="hljs-number">18</span>)^(b&gt;&gt;&gt;<span class="hljs-number">18</span>|m&lt;&lt;<span class="hljs-number">14</span>)^(b&lt;&lt;<span class="hljs-number">23</span>|m&gt;&gt;&gt;<span class="hljs-number">9</span>))+(F&gt;&gt;&gt;<span class="hljs-number">0</span>&lt;Q&gt;&gt;&gt;<span class="hljs-number">0</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>),t1=M+(g&amp;B^g&amp;k^B&amp;k),J=V,Q=G,V=Z,G=S,Z=b,S=m,b=q+(C=C+R+((F=F+D)&gt;&gt;&gt;<span class="hljs-number">0</span>&lt;D&gt;&gt;&gt;<span class="hljs-number">0</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>)+Y+((F=F+$)&gt;&gt;&gt;<span class="hljs-number">0</span>&lt;$&gt;&gt;&gt;<span class="hljs-number">0</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>)+H+((F=F+z)&gt;&gt;&gt;<span class="hljs-number">0</span>&lt;z&gt;&gt;&gt;<span class="hljs-number">0</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>))+((m=x+F|<span class="hljs-number">0</span>)&gt;&gt;&gt;<span class="hljs-number">0</span>&lt;x&gt;&gt;&gt;<span class="hljs-number">0</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>)|<span class="hljs-number">0</span>,q=w,x=k,w=v,k=B,v=y,B=g,y=C+(((y&gt;&gt;&gt;<span class="hljs-number">28</span>|g&lt;&lt;<span class="hljs-number">4</span>)^(y&lt;&lt;<span class="hljs-number">30</span>|g&gt;&gt;&gt;<span class="hljs-number">2</span>)^(y&lt;&lt;<span class="hljs-number">25</span>|g&gt;&gt;&gt;<span class="hljs-number">7</span>))+E+(t1&gt;&gt;&gt;<span class="hljs-number">0</span>&lt;M&gt;&gt;&gt;<span class="hljs-number">0</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>))+((g=F+t1|<span class="hljs-number">0</span>)&gt;&gt;&gt;<span class="hljs-number">0</span>&lt;F&gt;&gt;&gt;<span class="hljs-number">0</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>)|<span class="hljs-number">0</span>;<span class="hljs-selector-tag">a</span>=e<span class="hljs-selector-class">.low</span>=<span class="hljs-selector-tag">a</span>+g,e<span class="hljs-selector-class">.high</span>=<span class="hljs-selector-tag">I</span>+y+(<span class="hljs-selector-tag">a</span>&gt;&gt;&gt;<span class="hljs-number">0</span>&lt;g&gt;&gt;&gt;<span class="hljs-number">0</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>),h=r.low=h+B,r.high=U+v+(h&gt;&gt;&gt;<span class="hljs-number">0</span>&lt;B&gt;&gt;&gt;<span class="hljs-number">0</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>),l=i.low=l+k,i.high=K+w+(l&gt;&gt;&gt;<span class="hljs-number">0</span>&lt;k&gt;&gt;&gt;<span class="hljs-number">0</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>),f=o.low=f+x,o.high=X+q+(f&gt;&gt;&gt;<span class="hljs-number">0</span>&lt;x&gt;&gt;&gt;<span class="hljs-number">0</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>),d=n.low=d+m,n.high=L+b+(d&gt;&gt;&gt;<span class="hljs-number">0</span>&lt;m&gt;&gt;&gt;<span class="hljs-number">0</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>),u=s.low=u+S,s.high=j+Z+(u&gt;&gt;&gt;<span class="hljs-number">0</span>&lt;S&gt;&gt;&gt;<span class="hljs-number">0</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>),p=c.low=p+G,c.high=T+V+(p&gt;&gt;&gt;<span class="hljs-number">0</span>&lt;G&gt;&gt;&gt;<span class="hljs-number">0</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>),_=t.low=_+Q,t.high=N+J+(_&gt;&gt;&gt;<span class="hljs-number">0</span>&lt;Q&gt;&gt;&gt;<span class="hljs-number">0</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>)},_doFinalize:<span class="hljs-built_in">function</span>(){<span class="hljs-selector-tag">var</span> t=this._data,e=t<span class="hljs-selector-class">.words</span>,r=<span class="hljs-number">8</span>*this._nDataBytes,<span class="hljs-selector-tag">i</span>=<span class="hljs-number">8</span>*t<span class="hljs-selector-class">.sigBytes</span>;return e<span class="hljs-selector-attr">[i&gt;&gt;&gt;5]</span>|=<span class="hljs-number">128</span>&lt;&lt;<span class="hljs-number">24</span>-<span class="hljs-selector-tag">i</span>%<span class="hljs-number">32</span>,e<span class="hljs-selector-attr">[30+(128+i&gt;&gt;&gt;10&lt;&lt;5)]</span>=Math<span class="hljs-selector-class">.floor</span>(r/<span class="hljs-number">4294967296</span>),e<span class="hljs-selector-attr">[31+(128+i&gt;&gt;&gt;10&lt;&lt;5)]</span>=r,t<span class="hljs-selector-class">.sigBytes</span>=<span class="hljs-number">4</span>*e<span class="hljs-selector-class">.length</span>,this._process(),this._hash<span class="hljs-selector-class">.toX32</span>()},clone:<span class="hljs-built_in">function</span>(){<span class="hljs-selector-tag">var</span> t=<span class="hljs-selector-tag">H1</span><span class="hljs-selector-class">.clone</span><span class="hljs-selector-class">.call</span>(this);return t._hash=this._hash<span class="hljs-selector-class">.clone</span>(),t},blockSize:<span class="hljs-number">32</span>}),<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.SHA512</span>=<span class="hljs-selector-tag">H1</span>._createHelper(u),<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.HmacSHA512</span>=<span class="hljs-selector-tag">H1</span>._createHmacHelper(u),u=(<span class="hljs-selector-tag">p</span>=<span class="hljs-selector-tag">i</span>)<span class="hljs-selector-class">.x64</span>,t=u<span class="hljs-selector-class">.Word</span>,N=u<span class="hljs-selector-class">.WordArray</span>,u=<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.algo</span>,<span class="hljs-selector-tag">q</span>=u<span class="hljs-selector-class">.SHA512</span>,u=u<span class="hljs-selector-class">.SHA384</span>=<span class="hljs-selector-tag">q</span><span class="hljs-selector-class">.extend</span>({_doReset:<span class="hljs-built_in">function</span>(){this._hash=new N<span class="hljs-selector-class">.init</span>(<span class="hljs-selector-attr">[new t.init(3418070365,3238371032),new t.init(1654270250,914150663),new t.init(2438529370,812702999),new t.init(355462360,4144912697),new t.init(1731405415,4290775857),new t.init(2394180231,1750603025),new t.init(3675008525,1694076839),new t.init(1203062813,3204075428)]</span>)},_doFinalize:<span class="hljs-built_in">function</span>(){<span class="hljs-selector-tag">var</span> t=<span class="hljs-selector-tag">q</span>._doFinalize<span class="hljs-selector-class">.call</span>(this);return t<span class="hljs-selector-class">.sigBytes-</span>=<span class="hljs-number">16</span>,t}}),<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.SHA384</span>=<span class="hljs-selector-tag">q</span>._createHelper(u),<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.HmacSHA384</span>=<span class="hljs-selector-tag">q</span>._createHmacHelper(u);for(<span class="hljs-selector-tag">var</span> M1=Math,<span class="hljs-selector-tag">p</span>=<span class="hljs-selector-tag">i</span>,P1=(u=<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.lib</span>)<span class="hljs-selector-class">.WordArray</span>,F1=u<span class="hljs-selector-class">.Hasher</span>,W1=<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.x64</span><span class="hljs-selector-class">.Word</span>,u=<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.algo</span>,O1=<span class="hljs-selector-attr">[]</span>,I1=<span class="hljs-selector-attr">[]</span>,U1=<span class="hljs-selector-attr">[]</span>,v=<span class="hljs-number">1</span>,<span class="hljs-selector-tag">B</span>=<span class="hljs-number">0</span>,K1=<span class="hljs-number">0</span>;K1&lt;<span class="hljs-number">24</span>;K1++){O1<span class="hljs-selector-attr">[v+5*B]</span>=(K1+<span class="hljs-number">1</span>)*(K1+<span class="hljs-number">2</span>)/<span class="hljs-number">2%</span><span class="hljs-number">64</span>;<span class="hljs-selector-tag">var</span> X1=(<span class="hljs-number">2</span>*v+<span class="hljs-number">3</span>*<span class="hljs-selector-tag">B</span>)%<span class="hljs-number">5</span>;v=<span class="hljs-selector-tag">B</span>%<span class="hljs-number">5</span>,<span class="hljs-selector-tag">B</span>=X1}for(v=<span class="hljs-number">0</span>;v&lt;<span class="hljs-number">5</span>;v++)for(<span class="hljs-selector-tag">B</span>=<span class="hljs-number">0</span>;<span class="hljs-selector-tag">B</span>&lt;<span class="hljs-number">5</span>;<span class="hljs-selector-tag">B</span>++)I1<span class="hljs-selector-attr">[v+5*B]</span>=<span class="hljs-selector-tag">B</span>+(<span class="hljs-number">2</span>*v+<span class="hljs-number">3</span>*<span class="hljs-selector-tag">B</span>)%<span class="hljs-number">5</span>*<span class="hljs-number">5</span>;for(<span class="hljs-selector-tag">var</span> L1=<span class="hljs-number">1</span>,j1=<span class="hljs-number">0</span>;j1&lt;<span class="hljs-number">24</span>;j1++){for(<span class="hljs-selector-tag">var</span> T1,N1=<span class="hljs-number">0</span>,q1=<span class="hljs-number">0</span>,Z1=<span class="hljs-number">0</span>;Z1&lt;<span class="hljs-number">7</span>;Z1++)<span class="hljs-number">1</span>&amp;L1&amp;&amp;((T1=(<span class="hljs-number">1</span>&lt;&lt;Z1)-<span class="hljs-number">1</span>)&lt;<span class="hljs-number">32</span>?q1^=<span class="hljs-number">1</span>&lt;&lt;T1:N1^=<span class="hljs-number">1</span>&lt;&lt;T1-<span class="hljs-number">32</span>),<span class="hljs-number">128</span>&amp;L1?L1=L1&lt;&lt;<span class="hljs-number">1</span>^<span class="hljs-number">113</span>:L1&lt;&lt;=<span class="hljs-number">1</span>;U1<span class="hljs-selector-attr">[j1]</span>=W1<span class="hljs-selector-class">.create</span>(N1,q1)}for(<span class="hljs-selector-tag">var</span> D=<span class="hljs-selector-attr">[]</span>,V1=<span class="hljs-number">0</span>;V1&lt;<span class="hljs-number">25</span>;V1++)D<span class="hljs-selector-attr">[V1]</span>=W1<span class="hljs-selector-class">.create</span>();function G1(t,e,r){return t&amp;e|~t&amp;r}function J1(t,e,r){return t&amp;r|e&amp;~r}function Q1(t,e){return t&lt;&lt;e|t&gt;&gt;&gt;<span class="hljs-number">32</span>-e}function Y1(t){return"string"==typeof t?f1:o}function $<span class="hljs-number">1</span>(t,e,r){<span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">i</span>,o=this._iv;o?(<span class="hljs-selector-tag">i</span>=o,this._iv=void <span class="hljs-number">0</span>):i=this._prevBlock;for(<span class="hljs-selector-tag">var</span> n=<span class="hljs-number">0</span>;n&lt;r;n++)t<span class="hljs-selector-attr">[e+n]</span>^=<span class="hljs-selector-tag">i</span><span class="hljs-selector-attr">[n]</span>}function t2(t,e,r,<span class="hljs-selector-tag">i</span>){<span class="hljs-selector-tag">var</span> o,n=this._iv;n?(o=n<span class="hljs-selector-class">.slice</span>(<span class="hljs-number">0</span>),this._iv=void <span class="hljs-number">0</span>):o=this._prevBlock,i.<span class="hljs-built_in">encryptBlock</span>(o,<span class="hljs-number">0</span>);for(<span class="hljs-selector-tag">var</span> s=<span class="hljs-number">0</span>;s&lt;r;s++)t<span class="hljs-selector-attr">[e+s]</span>^=o<span class="hljs-selector-attr">[s]</span>}function e2(t){<span class="hljs-selector-tag">var</span> e,r,<span class="hljs-selector-tag">i</span>;return <span class="hljs-number">255</span>==(t&gt;&gt;<span class="hljs-number">24</span>&amp;<span class="hljs-number">255</span>)?(r=t&gt;&gt;<span class="hljs-number">8</span>&amp;<span class="hljs-number">255</span>,<span class="hljs-selector-tag">i</span>=<span class="hljs-number">255</span>&amp;t,<span class="hljs-number">255</span>===(e=t&gt;&gt;<span class="hljs-number">16</span>&amp;<span class="hljs-number">255</span>)?(e=<span class="hljs-number">0</span>,<span class="hljs-number">255</span>===r?(r=<span class="hljs-number">0</span>,<span class="hljs-number">255</span>===<span class="hljs-selector-tag">i</span>?<span class="hljs-selector-tag">i</span>=<span class="hljs-number">0</span>:++i):++r):++e,t=<span class="hljs-number">0</span>,t=(t+=e&lt;&lt;<span class="hljs-number">16</span>)+(r&lt;&lt;<span class="hljs-number">8</span>)+i):t+=<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">24</span>,t}u=u<span class="hljs-selector-class">.SHA3</span>=F1<span class="hljs-selector-class">.extend</span>({cfg:F1.cfg.<span class="hljs-built_in">extend</span>({outputLength:<span class="hljs-number">512</span>}),_doReset:<span class="hljs-built_in">function</span>(){for(<span class="hljs-selector-tag">var</span> t=this._state=<span class="hljs-selector-attr">[]</span>,e=<span class="hljs-number">0</span>;e&lt;<span class="hljs-number">25</span>;e++)t<span class="hljs-selector-attr">[e]</span>=new W1<span class="hljs-selector-class">.init</span>;this<span class="hljs-selector-class">.blockSize</span>=(<span class="hljs-number">1600</span>-<span class="hljs-number">2</span>*this<span class="hljs-selector-class">.cfg</span><span class="hljs-selector-class">.outputLength</span>)/<span class="hljs-number">32</span>},_doProcessBlock:<span class="hljs-built_in">function</span>(t,e){for(<span class="hljs-selector-tag">var</span> r=this._state,<span class="hljs-selector-tag">i</span>=this<span class="hljs-selector-class">.blockSize</span>/<span class="hljs-number">2</span>,o=<span class="hljs-number">0</span>;o&lt;<span class="hljs-selector-tag">i</span>;o++){<span class="hljs-selector-tag">var</span> n=t<span class="hljs-selector-attr">[e+2*o]</span>,s=t<span class="hljs-selector-attr">[e+2*o+1]</span>,n=<span class="hljs-number">16711935</span>&amp;(n&lt;&lt;<span class="hljs-number">8</span>|n&gt;&gt;&gt;<span class="hljs-number">24</span>)|<span class="hljs-number">4278255360</span>&amp;(n&lt;&lt;<span class="hljs-number">24</span>|n&gt;&gt;&gt;<span class="hljs-number">8</span>);(x=r<span class="hljs-selector-attr">[o]</span>)<span class="hljs-selector-class">.high</span>^=<span class="hljs-number">16711935</span>&amp;(s&lt;&lt;<span class="hljs-number">8</span>|s&gt;&gt;&gt;<span class="hljs-number">24</span>)|<span class="hljs-number">4278255360</span>&amp;(s&lt;&lt;<span class="hljs-number">24</span>|s&gt;&gt;&gt;<span class="hljs-number">8</span>),x<span class="hljs-selector-class">.low</span>^=n}for(<span class="hljs-selector-tag">var</span> c=<span class="hljs-number">0</span>;c&lt;<span class="hljs-number">24</span>;c++){for(<span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">a</span>=<span class="hljs-number">0</span>;<span class="hljs-selector-tag">a</span>&lt;<span class="hljs-number">5</span>;<span class="hljs-selector-tag">a</span>++){for(<span class="hljs-selector-tag">var</span> h=<span class="hljs-number">0</span>,l=<span class="hljs-number">0</span>,f=<span class="hljs-number">0</span>;f&lt;<span class="hljs-number">5</span>;f++)h^=(x=r<span class="hljs-selector-attr">[a+5*f]</span>)<span class="hljs-selector-class">.high</span>,l^=x<span class="hljs-selector-class">.low</span>;<span class="hljs-selector-tag">var</span> d=D<span class="hljs-selector-attr">[a]</span>;d<span class="hljs-selector-class">.high</span>=h,d<span class="hljs-selector-class">.low</span>=l}for(<span class="hljs-selector-tag">a</span>=<span class="hljs-number">0</span>;<span class="hljs-selector-tag">a</span>&lt;<span class="hljs-number">5</span>;<span class="hljs-selector-tag">a</span>++)for(<span class="hljs-selector-tag">var</span> u=D<span class="hljs-selector-attr">[(a+4)%5]</span>,<span class="hljs-selector-tag">p</span>=D<span class="hljs-selector-attr">[(a+1)%5]</span>,_=<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.high</span>,<span class="hljs-selector-tag">p</span>=<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.low</span>,h=u<span class="hljs-selector-class">.high</span>^(_&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-selector-tag">p</span>&gt;&gt;&gt;<span class="hljs-number">31</span>),l=u<span class="hljs-selector-class">.low</span>^(<span class="hljs-selector-tag">p</span>&lt;&lt;<span class="hljs-number">1</span>|_&gt;&gt;&gt;<span class="hljs-number">31</span>),f=<span class="hljs-number">0</span>;f&lt;<span class="hljs-number">5</span>;f++)(x=r<span class="hljs-selector-attr">[a+5*f]</span>)<span class="hljs-selector-class">.high</span>^=h,x<span class="hljs-selector-class">.low</span>^=l;for(<span class="hljs-selector-tag">var</span> y=<span class="hljs-number">1</span>;y&lt;<span class="hljs-number">25</span>;y++){<span class="hljs-selector-tag">var</span> g=(x=r<span class="hljs-selector-attr">[y]</span>)<span class="hljs-selector-class">.high</span>,v=x<span class="hljs-selector-class">.low</span>,<span class="hljs-selector-tag">B</span>=O1<span class="hljs-selector-attr">[y]</span>,g=(l=<span class="hljs-selector-tag">B</span>&lt;<span class="hljs-number">32</span>?(h=g&lt;&lt;<span class="hljs-selector-tag">B</span>|v&gt;&gt;&gt;<span class="hljs-number">32</span>-<span class="hljs-selector-tag">B</span>,v&lt;&lt;<span class="hljs-selector-tag">B</span>|g&gt;&gt;&gt;<span class="hljs-number">32</span>-<span class="hljs-selector-tag">B</span>):(h=v&lt;&lt;B-<span class="hljs-number">32</span>|g&gt;&gt;&gt;<span class="hljs-number">64</span>-B,g&lt;&lt;B-<span class="hljs-number">32</span>|v&gt;&gt;&gt;<span class="hljs-number">64</span>-B),D[I1[y]]);g<span class="hljs-selector-class">.high</span>=h,g<span class="hljs-selector-class">.low</span>=l}<span class="hljs-selector-tag">var</span> w=D<span class="hljs-selector-attr">[0]</span>,k=r<span class="hljs-selector-attr">[0]</span>;w<span class="hljs-selector-class">.high</span>=k<span class="hljs-selector-class">.high</span>,w<span class="hljs-selector-class">.low</span>=k<span class="hljs-selector-class">.low</span>;for(<span class="hljs-selector-tag">a</span>=<span class="hljs-number">0</span>;<span class="hljs-selector-tag">a</span>&lt;<span class="hljs-number">5</span>;<span class="hljs-selector-tag">a</span>++)for(f=<span class="hljs-number">0</span>;f&lt;<span class="hljs-number">5</span>;f++){<span class="hljs-selector-tag">var</span> x=r<span class="hljs-selector-attr">[y=a+5*f]</span>,<span class="hljs-selector-tag">b</span>=D<span class="hljs-selector-attr">[y]</span>,m=D<span class="hljs-selector-attr">[(a+1)%5+5*f]</span>,S=D<span class="hljs-selector-attr">[(a+2)%5+5*f]</span>;x<span class="hljs-selector-class">.high</span>=<span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.high</span>^~m<span class="hljs-selector-class">.high</span>&amp;S<span class="hljs-selector-class">.high</span>,x<span class="hljs-selector-class">.low</span>=<span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.low</span>^~m<span class="hljs-selector-class">.low</span>&amp;S<span class="hljs-selector-class">.low</span>}x=r<span class="hljs-selector-attr">[0]</span>,w=U1<span class="hljs-selector-attr">[c]</span>;x<span class="hljs-selector-class">.high</span>^=w<span class="hljs-selector-class">.high</span>,x<span class="hljs-selector-class">.low</span>^=w<span class="hljs-selector-class">.low</span>}},_doFinalize:<span class="hljs-built_in">function</span>(){for(<span class="hljs-selector-tag">var</span> t=this._data,e=t<span class="hljs-selector-class">.words</span>,r=(this._nDataBytes,<span class="hljs-number">8</span>*t<span class="hljs-selector-class">.sigBytes</span>),<span class="hljs-selector-tag">i</span>=<span class="hljs-number">32</span>*this<span class="hljs-selector-class">.blockSize</span>,o=(e<span class="hljs-selector-attr">[r&gt;&gt;&gt;5]</span>|=<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">24</span>-r%<span class="hljs-number">32</span>,e<span class="hljs-selector-attr">[(M1.ceil((1+r)/i)*i&gt;&gt;&gt;5)-1]</span>|=<span class="hljs-number">128</span>,t<span class="hljs-selector-class">.sigBytes</span>=<span class="hljs-number">4</span>*e<span class="hljs-selector-class">.length</span>,this._process(),this._state),r=this<span class="hljs-selector-class">.cfg</span><span class="hljs-selector-class">.outputLength</span>/<span class="hljs-number">8</span>,n=r/<span class="hljs-number">8</span>,s=<span class="hljs-selector-attr">[]</span>,c=<span class="hljs-number">0</span>;c&lt;n;c++){<span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">a</span>=o<span class="hljs-selector-attr">[c]</span>,h=<span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.high</span>,<span class="hljs-selector-tag">a</span>=<span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.low</span>,h=<span class="hljs-number">16711935</span>&amp;(h&lt;&lt;<span class="hljs-number">8</span>|h&gt;&gt;&gt;<span class="hljs-number">24</span>)|<span class="hljs-number">4278255360</span>&amp;(h&lt;&lt;<span class="hljs-number">24</span>|h&gt;&gt;&gt;<span class="hljs-number">8</span>);s<span class="hljs-selector-class">.push</span>(<span class="hljs-number">16711935</span>&amp;(<span class="hljs-selector-tag">a</span>&lt;&lt;<span class="hljs-number">8</span>|<span class="hljs-selector-tag">a</span>&gt;&gt;&gt;<span class="hljs-number">24</span>)|<span class="hljs-number">4278255360</span>&amp;(<span class="hljs-selector-tag">a</span>&lt;&lt;<span class="hljs-number">24</span>|<span class="hljs-selector-tag">a</span>&gt;&gt;&gt;<span class="hljs-number">8</span>)),s<span class="hljs-selector-class">.push</span>(h)}return new P1<span class="hljs-selector-class">.init</span>(s,r)},clone:<span class="hljs-built_in">function</span>(){for(<span class="hljs-selector-tag">var</span> t=F1<span class="hljs-selector-class">.clone</span><span class="hljs-selector-class">.call</span>(this),e=t._state=this._state<span class="hljs-selector-class">.slice</span>(<span class="hljs-number">0</span>),r=<span class="hljs-number">0</span>;r&lt;<span class="hljs-number">25</span>;r++)e<span class="hljs-selector-attr">[r]</span>=e<span class="hljs-selector-attr">[r]</span><span class="hljs-selector-class">.clone</span>();return t}}),<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.SHA3</span>=F1._createHelper(u),<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.HmacSHA3</span>=F1._createHmacHelper(u),Math,u=(<span class="hljs-selector-tag">p</span>=<span class="hljs-selector-tag">i</span>)<span class="hljs-selector-class">.lib</span>,e=u<span class="hljs-selector-class">.WordArray</span>,Z=u<span class="hljs-selector-class">.Hasher</span>,u=<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.algo</span>,V=e<span class="hljs-selector-class">.create</span>(<span class="hljs-selector-attr">[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,7,4,13,1,10,6,15,3,12,0,9,5,2,14,11,8,3,10,14,4,9,15,8,1,2,7,0,6,13,11,5,12,1,9,11,10,0,8,12,4,13,3,7,15,14,5,6,2,4,0,5,9,7,12,2,10,14,1,3,8,11,6,15,13]</span>),G=e<span class="hljs-selector-class">.create</span>(<span class="hljs-selector-attr">[5,14,7,0,9,2,11,4,13,6,15,8,1,10,3,12,6,11,3,7,0,13,5,10,14,15,8,12,4,9,1,2,15,5,1,3,7,14,6,9,11,8,12,2,10,0,4,13,8,6,4,1,3,11,15,0,5,12,2,13,9,7,10,14,12,15,10,4,1,5,8,7,6,2,13,14,0,3,9,11]</span>),J=e<span class="hljs-selector-class">.create</span>(<span class="hljs-selector-attr">[11,14,15,12,5,8,7,9,11,13,14,15,6,7,9,8,7,6,8,13,11,9,7,15,7,12,15,9,11,7,13,12,11,13,6,7,14,9,13,15,14,8,13,6,5,12,7,5,11,12,14,15,14,15,9,8,9,14,5,6,8,6,5,12,9,15,5,11,6,8,13,12,5,12,13,14,11,8,5,6]</span>),<span class="hljs-selector-tag">Q</span>=e<span class="hljs-selector-class">.create</span>(<span class="hljs-selector-attr">[8,9,9,11,13,15,15,5,7,7,8,11,14,14,12,6,9,13,15,7,12,8,9,11,7,7,12,7,6,15,13,11,9,7,15,11,8,6,6,14,12,13,5,14,13,13,7,5,15,5,8,11,14,14,6,14,6,9,12,9,12,5,15,8,8,5,12,9,12,5,14,6,8,13,6,5,15,13,11,11]</span>),Y=e<span class="hljs-selector-class">.create</span>(<span class="hljs-selector-attr">[0,1518500249,1859775393,2400959708,2840853838]</span>),$=e<span class="hljs-selector-class">.create</span>(<span class="hljs-selector-attr">[1352829926,1548603684,1836072691,2053994217,0]</span>),u=u<span class="hljs-selector-class">.RIPEMD160</span>=Z<span class="hljs-selector-class">.extend</span>({_doReset:<span class="hljs-built_in">function</span>(){this._hash=e<span class="hljs-selector-class">.create</span>(<span class="hljs-selector-attr">[1732584193,4023233417,2562383102,271733878,3285377520]</span>)},_doProcessBlock:<span class="hljs-built_in">function</span>(t,e){for(<span class="hljs-selector-tag">var</span> r=<span class="hljs-number">0</span>;r&lt;<span class="hljs-number">16</span>;r++){<span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">i</span>=e+r,o=t<span class="hljs-selector-attr">[i]</span>;t<span class="hljs-selector-attr">[i]</span>=<span class="hljs-number">16711935</span>&amp;(o&lt;&lt;<span class="hljs-number">8</span>|o&gt;&gt;&gt;<span class="hljs-number">24</span>)|<span class="hljs-number">4278255360</span>&amp;(o&lt;&lt;<span class="hljs-number">24</span>|o&gt;&gt;&gt;<span class="hljs-number">8</span>)}for(<span class="hljs-selector-tag">var</span> n,s,c,<span class="hljs-selector-tag">a</span>,h,l,f=this._hash<span class="hljs-selector-class">.words</span>,d=Y<span class="hljs-selector-class">.words</span>,u=$<span class="hljs-selector-class">.words</span>,<span class="hljs-selector-tag">p</span>=V<span class="hljs-selector-class">.words</span>,_=G<span class="hljs-selector-class">.words</span>,y=J<span class="hljs-selector-class">.words</span>,g=<span class="hljs-selector-tag">Q</span><span class="hljs-selector-class">.words</span>,v=n=f<span class="hljs-selector-attr">[0]</span>,<span class="hljs-selector-tag">B</span>=s=f<span class="hljs-selector-attr">[1]</span>,w=c=f<span class="hljs-selector-attr">[2]</span>,k=<span class="hljs-selector-tag">a</span>=f<span class="hljs-selector-attr">[3]</span>,x=h=f<span class="hljs-selector-attr">[4]</span>,r=<span class="hljs-number">0</span>;r&lt;<span class="hljs-number">80</span>;r+=<span class="hljs-number">1</span>)l=(l=Q1(l=(l=n+t<span class="hljs-selector-attr">[e+p[r]</span>]|<span class="hljs-number">0</span>)+(r&lt;<span class="hljs-number">16</span>?(s^c^<span class="hljs-selector-tag">a</span>)+d<span class="hljs-selector-attr">[0]</span>:r&lt;<span class="hljs-number">32</span>?<span class="hljs-built_in">G1</span>(s,c,a)+d[<span class="hljs-number">1</span>]:r&lt;<span class="hljs-number">48</span>?((s|~c)^a)+d[<span class="hljs-number">2</span>]:r&lt;<span class="hljs-number">64</span>?<span class="hljs-built_in">J1</span>(s,c,a)+d[<span class="hljs-number">3</span>]:(s^(c|~a))+d[<span class="hljs-number">4</span>])|<span class="hljs-number">0</span>,y[r]))+h|<span class="hljs-number">0</span>,n=h,h=a,a=<span class="hljs-built_in">Q1</span>(c,<span class="hljs-number">10</span>),c=s,s=l,l=(l=<span class="hljs-built_in">Q1</span>(l=(l=v+t[e+_[r]]|<span class="hljs-number">0</span>)+(r&lt;<span class="hljs-number">16</span>?(B^(w|~k))+u[<span class="hljs-number">0</span>]:r&lt;<span class="hljs-number">32</span>?<span class="hljs-built_in">J1</span>(B,w,k)+u[<span class="hljs-number">1</span>]:r&lt;<span class="hljs-number">48</span>?((B|~w)^k)+u[<span class="hljs-number">2</span>]:r&lt;<span class="hljs-number">64</span>?<span class="hljs-built_in">G1</span>(B,w,k)+u[<span class="hljs-number">3</span>]:(B^w^k)+u[<span class="hljs-number">4</span>])|<span class="hljs-number">0</span>,g[r]))+x|<span class="hljs-number">0</span>,v=x,x=k,k=<span class="hljs-built_in">Q1</span>(w,<span class="hljs-number">10</span>),w=B,B=l;l=f<span class="hljs-selector-attr">[1]</span>+c+k|<span class="hljs-number">0</span>,f<span class="hljs-selector-attr">[1]</span>=f<span class="hljs-selector-attr">[2]</span>+<span class="hljs-selector-tag">a</span>+x|<span class="hljs-number">0</span>,f<span class="hljs-selector-attr">[2]</span>=f<span class="hljs-selector-attr">[3]</span>+h+v|<span class="hljs-number">0</span>,f<span class="hljs-selector-attr">[3]</span>=f<span class="hljs-selector-attr">[4]</span>+n+<span class="hljs-selector-tag">B</span>|<span class="hljs-number">0</span>,f<span class="hljs-selector-attr">[4]</span>=f<span class="hljs-selector-attr">[0]</span>+s+w|<span class="hljs-number">0</span>,f<span class="hljs-selector-attr">[0]</span>=l},_doFinalize:<span class="hljs-built_in">function</span>(){for(<span class="hljs-selector-tag">var</span> t=this._data,e=t<span class="hljs-selector-class">.words</span>,r=<span class="hljs-number">8</span>*this._nDataBytes,<span class="hljs-selector-tag">i</span>=<span class="hljs-number">8</span>*t<span class="hljs-selector-class">.sigBytes</span>,<span class="hljs-selector-tag">i</span>=(e<span class="hljs-selector-attr">[i&gt;&gt;&gt;5]</span>|=<span class="hljs-number">128</span>&lt;&lt;<span class="hljs-number">24</span>-<span class="hljs-selector-tag">i</span>%<span class="hljs-number">32</span>,e<span class="hljs-selector-attr">[14+(64+i&gt;&gt;&gt;9&lt;&lt;4)]</span>=<span class="hljs-number">16711935</span>&amp;(r&lt;&lt;<span class="hljs-number">8</span>|r&gt;&gt;&gt;<span class="hljs-number">24</span>)|<span class="hljs-number">4278255360</span>&amp;(r&lt;&lt;<span class="hljs-number">24</span>|r&gt;&gt;&gt;<span class="hljs-number">8</span>),t<span class="hljs-selector-class">.sigBytes</span>=<span class="hljs-number">4</span>*(e<span class="hljs-selector-class">.length</span>+<span class="hljs-number">1</span>),this._process(),this._hash),o=<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.words</span>,n=<span class="hljs-number">0</span>;n&lt;<span class="hljs-number">5</span>;n++){<span class="hljs-selector-tag">var</span> s=o<span class="hljs-selector-attr">[n]</span>;o<span class="hljs-selector-attr">[n]</span>=<span class="hljs-number">16711935</span>&amp;(s&lt;&lt;<span class="hljs-number">8</span>|s&gt;&gt;&gt;<span class="hljs-number">24</span>)|<span class="hljs-number">4278255360</span>&amp;(s&lt;&lt;<span class="hljs-number">24</span>|s&gt;&gt;&gt;<span class="hljs-number">8</span>)}return <span class="hljs-selector-tag">i</span>},clone:<span class="hljs-built_in">function</span>(){<span class="hljs-selector-tag">var</span> t=Z<span class="hljs-selector-class">.clone</span><span class="hljs-selector-class">.call</span>(this);return t._hash=this._hash<span class="hljs-selector-class">.clone</span>(),t}}),<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.RIPEMD160</span>=Z._createHelper(u),<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.HmacRIPEMD160</span>=Z._createHmacHelper(u),u=(<span class="hljs-selector-tag">p</span>=<span class="hljs-selector-tag">i</span>)<span class="hljs-selector-class">.lib</span><span class="hljs-selector-class">.Base</span>,t1=<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.enc</span><span class="hljs-selector-class">.Utf8</span>,<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.algo</span><span class="hljs-selector-class">.HMAC</span>=u<span class="hljs-selector-class">.extend</span>({init:<span class="hljs-built_in">function</span>(t,e){t=this._hasher=new t<span class="hljs-selector-class">.init</span>,"string"==typeof e&amp;&amp;(e=t1<span class="hljs-selector-class">.parse</span>(e));for(<span class="hljs-selector-tag">var</span> r=t<span class="hljs-selector-class">.blockSize</span>,<span class="hljs-selector-tag">i</span>=<span class="hljs-number">4</span>*r,t=((e=e<span class="hljs-selector-class">.sigBytes</span>&gt;<span class="hljs-selector-tag">i</span>?t<span class="hljs-selector-class">.finalize</span>(e):e).<span class="hljs-built_in">clamp</span>(),this._oKey=e.<span class="hljs-built_in">clone</span>()),e=this._iKey=e.<span class="hljs-built_in">clone</span>(),o=t.words,n=e.words,s=<span class="hljs-number">0</span>;s&lt;r;s++)o<span class="hljs-selector-attr">[s]</span>^=<span class="hljs-number">1549556828</span>,n<span class="hljs-selector-attr">[s]</span>^=<span class="hljs-number">909522486</span>;t<span class="hljs-selector-class">.sigBytes</span>=e<span class="hljs-selector-class">.sigBytes</span>=<span class="hljs-selector-tag">i</span>,this<span class="hljs-selector-class">.reset</span>()},reset:<span class="hljs-built_in">function</span>(){<span class="hljs-selector-tag">var</span> t=this._hasher;t<span class="hljs-selector-class">.reset</span>(),t<span class="hljs-selector-class">.update</span>(this._iKey)},update:<span class="hljs-built_in">function</span>(t){return this._hasher<span class="hljs-selector-class">.update</span>(t),this},finalize:<span class="hljs-built_in">function</span>(t){<span class="hljs-selector-tag">var</span> e=this._hasher,t=e<span class="hljs-selector-class">.finalize</span>(t);return e<span class="hljs-selector-class">.reset</span>(),e<span class="hljs-selector-class">.finalize</span>(this._oKey<span class="hljs-selector-class">.clone</span>()<span class="hljs-selector-class">.concat</span>(t))}}),u=(<span class="hljs-selector-tag">p</span>=<span class="hljs-selector-tag">i</span>)<span class="hljs-selector-class">.lib</span>,w=u<span class="hljs-selector-class">.Base</span>,e1=u<span class="hljs-selector-class">.WordArray</span>,u=<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.algo</span>,<span class="hljs-selector-tag">P</span>=u<span class="hljs-selector-class">.SHA256</span>,r1=u<span class="hljs-selector-class">.HMAC</span>,i1=u<span class="hljs-selector-class">.PBKDF2</span>=w<span class="hljs-selector-class">.extend</span>({cfg:w.<span class="hljs-built_in">extend</span>({keySize:<span class="hljs-number">4</span>,hasher:P,iterations:<span class="hljs-number">25</span>e4}),init:<span class="hljs-built_in">function</span>(t){this<span class="hljs-selector-class">.cfg</span>=this<span class="hljs-selector-class">.cfg</span><span class="hljs-selector-class">.extend</span>(t)},compute:<span class="hljs-built_in">function</span>(t,e){for(<span class="hljs-selector-tag">var</span> r=this<span class="hljs-selector-class">.cfg</span>,<span class="hljs-selector-tag">i</span>=r1<span class="hljs-selector-class">.create</span>(r<span class="hljs-selector-class">.hasher</span>,t),o=e1<span class="hljs-selector-class">.create</span>(),n=e1<span class="hljs-selector-class">.create</span>(<span class="hljs-selector-attr">[1]</span>),s=o<span class="hljs-selector-class">.words</span>,c=n<span class="hljs-selector-class">.words</span>,<span class="hljs-selector-tag">a</span>=r<span class="hljs-selector-class">.keySize</span>,h=r<span class="hljs-selector-class">.iterations</span>;s<span class="hljs-selector-class">.length</span>&lt;<span class="hljs-selector-tag">a</span>;){for(<span class="hljs-selector-tag">var</span> l=<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.update</span>(e)<span class="hljs-selector-class">.finalize</span>(n),f=(<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.reset</span>(),l<span class="hljs-selector-class">.words</span>),d=f<span class="hljs-selector-class">.length</span>,u=l,<span class="hljs-selector-tag">p</span>=<span class="hljs-number">1</span>;<span class="hljs-selector-tag">p</span>&lt;h;<span class="hljs-selector-tag">p</span>++){u=<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.finalize</span>(u),<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.reset</span>();for(<span class="hljs-selector-tag">var</span> _=u<span class="hljs-selector-class">.words</span>,y=<span class="hljs-number">0</span>;y&lt;d;y++)f<span class="hljs-selector-attr">[y]</span>^=_<span class="hljs-selector-attr">[y]</span>}o<span class="hljs-selector-class">.concat</span>(l),c<span class="hljs-selector-attr">[0]</span>++}return o<span class="hljs-selector-class">.sigBytes</span>=<span class="hljs-number">4</span>*<span class="hljs-selector-tag">a</span>,o}}),<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.PBKDF2</span>=function(t,e,r){return i1<span class="hljs-selector-class">.create</span>(r)<span class="hljs-selector-class">.compute</span>(t,e)},w=(u=<span class="hljs-selector-tag">i</span>)<span class="hljs-selector-class">.lib</span>,<span class="hljs-selector-tag">P</span>=w<span class="hljs-selector-class">.Base</span>,o1=w<span class="hljs-selector-class">.WordArray</span>,w=u<span class="hljs-selector-class">.algo</span>,<span class="hljs-selector-tag">p</span>=w<span class="hljs-selector-class">.MD5</span>,n1=w<span class="hljs-selector-class">.EvpKDF</span>=<span class="hljs-selector-tag">P</span><span class="hljs-selector-class">.extend</span>({cfg:P.<span class="hljs-built_in">extend</span>({keySize:<span class="hljs-number">4</span>,hasher:p,iterations:<span class="hljs-number">1</span>}),init:<span class="hljs-built_in">function</span>(t){this<span class="hljs-selector-class">.cfg</span>=this<span class="hljs-selector-class">.cfg</span><span class="hljs-selector-class">.extend</span>(t)},compute:<span class="hljs-built_in">function</span>(t,e){for(<span class="hljs-selector-tag">var</span> r,<span class="hljs-selector-tag">i</span>=this<span class="hljs-selector-class">.cfg</span>,o=<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.hasher</span><span class="hljs-selector-class">.create</span>(),n=o1<span class="hljs-selector-class">.create</span>(),s=n<span class="hljs-selector-class">.words</span>,c=<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.keySize</span>,<span class="hljs-selector-tag">a</span>=<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.iterations</span>;s<span class="hljs-selector-class">.length</span>&lt;c;){r&amp;&amp;o<span class="hljs-selector-class">.update</span>(r),r=o<span class="hljs-selector-class">.update</span>(t)<span class="hljs-selector-class">.finalize</span>(e),o<span class="hljs-selector-class">.reset</span>();for(<span class="hljs-selector-tag">var</span> h=<span class="hljs-number">1</span>;h&lt;<span class="hljs-selector-tag">a</span>;h++)r=o<span class="hljs-selector-class">.finalize</span>(r),o<span class="hljs-selector-class">.reset</span>();n<span class="hljs-selector-class">.concat</span>(r)}return n<span class="hljs-selector-class">.sigBytes</span>=<span class="hljs-number">4</span>*c,n}}),u<span class="hljs-selector-class">.EvpKDF</span>=function(t,e,r){return n1<span class="hljs-selector-class">.create</span>(r)<span class="hljs-selector-class">.compute</span>(t,e)},<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.lib</span><span class="hljs-selector-class">.Cipher</span>||(<span class="hljs-selector-tag">P</span>=(w=<span class="hljs-selector-tag">i</span>)<span class="hljs-selector-class">.lib</span>,<span class="hljs-selector-tag">p</span>=<span class="hljs-selector-tag">P</span><span class="hljs-selector-class">.Base</span>,s=<span class="hljs-selector-tag">P</span><span class="hljs-selector-class">.WordArray</span>,s1=<span class="hljs-selector-tag">P</span><span class="hljs-selector-class">.BufferedBlockAlgorithm</span>,(u=w<span class="hljs-selector-class">.enc</span>)<span class="hljs-selector-class">.Utf8</span>,c1=u<span class="hljs-selector-class">.Base64</span>,a1=w<span class="hljs-selector-class">.algo</span><span class="hljs-selector-class">.EvpKDF</span>,<span class="hljs-selector-tag">h1</span>=<span class="hljs-selector-tag">P</span><span class="hljs-selector-class">.Cipher</span>=s1<span class="hljs-selector-class">.extend</span>({cfg:p.<span class="hljs-built_in">extend</span>(),createEncryptor:<span class="hljs-built_in">function</span>(t,e){return this<span class="hljs-selector-class">.create</span>(this._ENC_XFORM_MODE,t,e)},createDecryptor:<span class="hljs-built_in">function</span>(t,e){return this<span class="hljs-selector-class">.create</span>(this._DEC_XFORM_MODE,t,e)},init:<span class="hljs-built_in">function</span>(t,e,r){this<span class="hljs-selector-class">.cfg</span>=this<span class="hljs-selector-class">.cfg</span><span class="hljs-selector-class">.extend</span>(r),this._xformMode=t,this._key=e,this<span class="hljs-selector-class">.reset</span>()},reset:<span class="hljs-built_in">function</span>(){s1<span class="hljs-selector-class">.reset</span><span class="hljs-selector-class">.call</span>(this),this._doReset()},process:<span class="hljs-built_in">function</span>(t){return this._append(t),this._process()},finalize:<span class="hljs-built_in">function</span>(t){return t&amp;&amp;this._append(t),this._doFinalize()},keySize:<span class="hljs-number">4</span>,ivSize:<span class="hljs-number">4</span>,_ENC_XFORM_MODE:<span class="hljs-number">1</span>,_DEC_XFORM_MODE:<span class="hljs-number">2</span>,_createHelper:<span class="hljs-built_in">function</span>(i){return{encrypt:<span class="hljs-built_in">function</span>(t,e,r){return Y1(e)<span class="hljs-selector-class">.encrypt</span>(<span class="hljs-selector-tag">i</span>,t,e,r)},decrypt:<span class="hljs-built_in">function</span>(t,e,r){return Y1(e)<span class="hljs-selector-class">.decrypt</span>(<span class="hljs-selector-tag">i</span>,t,e,r)}}}}),<span class="hljs-selector-tag">P</span><span class="hljs-selector-class">.StreamCipher</span>=<span class="hljs-selector-tag">h1</span><span class="hljs-selector-class">.extend</span>({_doFinalize:<span class="hljs-built_in">function</span>(){return this._process(!<span class="hljs-number">0</span>)},blockSize:<span class="hljs-number">1</span>}),u=w<span class="hljs-selector-class">.mode</span>={},r=<span class="hljs-selector-tag">P</span><span class="hljs-selector-class">.BlockCipherMode</span>=<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.extend</span>({createEncryptor:<span class="hljs-built_in">function</span>(t,e){return this<span class="hljs-selector-class">.Encryptor</span><span class="hljs-selector-class">.create</span>(t,e)},createDecryptor:<span class="hljs-built_in">function</span>(t,e){return this<span class="hljs-selector-class">.Decryptor</span><span class="hljs-selector-class">.create</span>(t,e)},init:<span class="hljs-built_in">function</span>(t,e){this._cipher=t,this._iv=e}}),r=u<span class="hljs-selector-class">.CBC</span>=((u=r<span class="hljs-selector-class">.extend</span>())<span class="hljs-selector-class">.Encryptor</span>=u<span class="hljs-selector-class">.extend</span>({processBlock:<span class="hljs-built_in">function</span>(t,e){<span class="hljs-selector-tag">var</span> r=this._cipher,<span class="hljs-selector-tag">i</span>=r<span class="hljs-selector-class">.blockSize</span>;$<span class="hljs-number">1</span><span class="hljs-selector-class">.call</span>(this,t,e,<span class="hljs-selector-tag">i</span>),r<span class="hljs-selector-class">.encryptBlock</span>(t,e),this._prevBlock=t<span class="hljs-selector-class">.slice</span>(e,e+<span class="hljs-selector-tag">i</span>)}}),u<span class="hljs-selector-class">.Decryptor</span>=u<span class="hljs-selector-class">.extend</span>({processBlock:<span class="hljs-built_in">function</span>(t,e){<span class="hljs-selector-tag">var</span> r=this._cipher,<span class="hljs-selector-tag">i</span>=r<span class="hljs-selector-class">.blockSize</span>,o=t<span class="hljs-selector-class">.slice</span>(e,e+<span class="hljs-selector-tag">i</span>);r<span class="hljs-selector-class">.decryptBlock</span>(t,e),$<span class="hljs-number">1</span><span class="hljs-selector-class">.call</span>(this,t,e,<span class="hljs-selector-tag">i</span>),this._prevBlock=o}}),u),u=(w<span class="hljs-selector-class">.pad</span>={})<span class="hljs-selector-class">.Pkcs7</span>={pad:<span class="hljs-built_in">function</span>(t,e){for(<span class="hljs-selector-tag">var</span> e=<span class="hljs-number">4</span>*e,r=e-t<span class="hljs-selector-class">.sigBytes</span>%e,<span class="hljs-selector-tag">i</span>=r&lt;&lt;<span class="hljs-number">24</span>|r&lt;&lt;<span class="hljs-number">16</span>|r&lt;&lt;<span class="hljs-number">8</span>|r,o=<span class="hljs-selector-attr">[]</span>,n=<span class="hljs-number">0</span>;n&lt;r;n+=<span class="hljs-number">4</span>)o<span class="hljs-selector-class">.push</span>(<span class="hljs-selector-tag">i</span>);e=s<span class="hljs-selector-class">.create</span>(o,r);t<span class="hljs-selector-class">.concat</span>(e)},unpad:<span class="hljs-built_in">function</span>(t){<span class="hljs-selector-tag">var</span> e=<span class="hljs-number">255</span>&amp;t<span class="hljs-selector-class">.words</span><span class="hljs-selector-attr">[t.sigBytes-1&gt;&gt;&gt;2]</span>;t<span class="hljs-selector-class">.sigBytes-</span>=e}},<span class="hljs-selector-tag">P</span><span class="hljs-selector-class">.BlockCipher</span>=<span class="hljs-selector-tag">h1</span><span class="hljs-selector-class">.extend</span>({cfg:h1.cfg.<span class="hljs-built_in">extend</span>({mode:r,padding:u}),reset:<span class="hljs-built_in">function</span>(){<span class="hljs-selector-tag">h1</span><span class="hljs-selector-class">.reset</span><span class="hljs-selector-class">.call</span>(this);<span class="hljs-selector-tag">var</span> t,e=this<span class="hljs-selector-class">.cfg</span>,r=e<span class="hljs-selector-class">.iv</span>,e=e<span class="hljs-selector-class">.mode</span>;this._xformMode==this._ENC_XFORM_MODE?t=e<span class="hljs-selector-class">.createEncryptor</span>:(t=e.createDecryptor,this._minBufferSize=<span class="hljs-number">1</span>),this._mode&amp;&amp;this._mode.__creator==t?this._mode.<span class="hljs-built_in">init</span>(this,r&amp;&amp;r.words):(this._mode=t.<span class="hljs-built_in">call</span>(e,this,r&amp;&amp;r.words),this._mode.__creator=t)},_doProcessBlock:<span class="hljs-built_in">function</span>(t,e){this._mode<span class="hljs-selector-class">.processBlock</span>(t,e)},_doFinalize:<span class="hljs-built_in">function</span>(){<span class="hljs-selector-tag">var</span> t,e=this<span class="hljs-selector-class">.cfg</span><span class="hljs-selector-class">.padding</span>;return this._xformMode==this._ENC_XFORM_MODE?(e<span class="hljs-selector-class">.pad</span>(this._data,this<span class="hljs-selector-class">.blockSize</span>),t=this._process(!<span class="hljs-number">0</span>)):(t=this.<span class="hljs-built_in">_process</span>(!<span class="hljs-number">0</span>),e.<span class="hljs-built_in">unpad</span>(t)),t},blockSize:<span class="hljs-number">4</span>}),l1=<span class="hljs-selector-tag">P</span><span class="hljs-selector-class">.CipherParams</span>=<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.extend</span>({init:<span class="hljs-built_in">function</span>(t){this<span class="hljs-selector-class">.mixIn</span>(t)},toString:<span class="hljs-built_in">function</span>(t){return(t||this<span class="hljs-selector-class">.formatter</span>)<span class="hljs-selector-class">.stringify</span>(this)}}),r=(w<span class="hljs-selector-class">.format</span>={})<span class="hljs-selector-class">.OpenSSL</span>={stringify:<span class="hljs-built_in">function</span>(t){<span class="hljs-selector-tag">var</span> e=t<span class="hljs-selector-class">.ciphertext</span>,t=t<span class="hljs-selector-class">.salt</span>,t=t?s<span class="hljs-selector-class">.create</span>(<span class="hljs-selector-attr">[1398893684,1701076831]</span>)<span class="hljs-selector-class">.concat</span>(t)<span class="hljs-selector-class">.concat</span>(e):e;return t<span class="hljs-selector-class">.toString</span>(c1)},parse:<span class="hljs-built_in">function</span>(t){<span class="hljs-selector-tag">var</span> e,t=c1<span class="hljs-selector-class">.parse</span>(t),r=t<span class="hljs-selector-class">.words</span>;return <span class="hljs-number">1398893684</span>==r<span class="hljs-selector-attr">[0]</span>&amp;&amp;<span class="hljs-number">1701076831</span>==r<span class="hljs-selector-attr">[1]</span>&amp;&amp;(e=s<span class="hljs-selector-class">.create</span>(r<span class="hljs-selector-class">.slice</span>(<span class="hljs-number">2</span>,<span class="hljs-number">4</span>)),r<span class="hljs-selector-class">.splice</span>(<span class="hljs-number">0</span>,<span class="hljs-number">4</span>),t<span class="hljs-selector-class">.sigBytes-</span>=<span class="hljs-number">16</span>),l1<span class="hljs-selector-class">.create</span>({ciphertext:t,salt:e})}},o=<span class="hljs-selector-tag">P</span><span class="hljs-selector-class">.SerializableCipher</span>=<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.extend</span>({cfg:p.<span class="hljs-built_in">extend</span>({format:r}),encrypt:<span class="hljs-built_in">function</span>(t,e,r,i){<span class="hljs-selector-tag">i</span>=this<span class="hljs-selector-class">.cfg</span><span class="hljs-selector-class">.extend</span>(<span class="hljs-selector-tag">i</span>);<span class="hljs-selector-tag">var</span> o=t<span class="hljs-selector-class">.createEncryptor</span>(r,<span class="hljs-selector-tag">i</span>),e=o<span class="hljs-selector-class">.finalize</span>(e),o=o<span class="hljs-selector-class">.cfg</span>;return l1<span class="hljs-selector-class">.create</span>({ciphertext:e,key:r,iv:o.iv,algorithm:t,mode:o.mode,padding:o.padding,blockSize:t.blockSize,formatter:i.format})},decrypt:<span class="hljs-built_in">function</span>(t,e,r,i){return <span class="hljs-selector-tag">i</span>=this<span class="hljs-selector-class">.cfg</span><span class="hljs-selector-class">.extend</span>(<span class="hljs-selector-tag">i</span>),e=this._parse(e,<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.format</span>),t<span class="hljs-selector-class">.createDecryptor</span>(r,<span class="hljs-selector-tag">i</span>)<span class="hljs-selector-class">.finalize</span>(e<span class="hljs-selector-class">.ciphertext</span>)},_parse:<span class="hljs-built_in">function</span>(t,e){return"string"==typeof t?e<span class="hljs-selector-class">.parse</span>(t,this):t}}),u=(w<span class="hljs-selector-class">.kdf</span>={})<span class="hljs-selector-class">.OpenSSL</span>={execute:<span class="hljs-built_in">function</span>(t,e,r,i,o){<span class="hljs-selector-tag">i</span>=<span class="hljs-selector-tag">i</span>||s<span class="hljs-selector-class">.random</span>(<span class="hljs-number">8</span>),o=(o?a1<span class="hljs-selector-class">.create</span>({keySize:e+r,hasher:o}):a1.<span class="hljs-built_in">create</span>({keySize:e+r}))<span class="hljs-selector-class">.compute</span>(t,<span class="hljs-selector-tag">i</span>);t=s<span class="hljs-selector-class">.create</span>(o<span class="hljs-selector-class">.words</span><span class="hljs-selector-class">.slice</span>(e),<span class="hljs-number">4</span>*r);return o<span class="hljs-selector-class">.sigBytes</span>=<span class="hljs-number">4</span>*e,l1<span class="hljs-selector-class">.create</span>({key:o,iv:t,salt:i})}},f1=<span class="hljs-selector-tag">P</span><span class="hljs-selector-class">.PasswordBasedCipher</span>=o<span class="hljs-selector-class">.extend</span>({cfg:o.cfg.<span class="hljs-built_in">extend</span>({kdf:u}),encrypt:<span class="hljs-built_in">function</span>(t,e,r,i){r=(<span class="hljs-selector-tag">i</span>=this<span class="hljs-selector-class">.cfg</span><span class="hljs-selector-class">.extend</span>(<span class="hljs-selector-tag">i</span>))<span class="hljs-selector-class">.kdf</span><span class="hljs-selector-class">.execute</span>(r,t<span class="hljs-selector-class">.keySize</span>,t<span class="hljs-selector-class">.ivSize</span>,<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.salt</span>,<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.hasher</span>),<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.iv</span>=r<span class="hljs-selector-class">.iv</span>,t=o<span class="hljs-selector-class">.encrypt</span><span class="hljs-selector-class">.call</span>(this,t,e,r<span class="hljs-selector-class">.key</span>,<span class="hljs-selector-tag">i</span>);return t<span class="hljs-selector-class">.mixIn</span>(r),t},decrypt:<span class="hljs-built_in">function</span>(t,e,r,i){<span class="hljs-selector-tag">i</span>=this<span class="hljs-selector-class">.cfg</span><span class="hljs-selector-class">.extend</span>(<span class="hljs-selector-tag">i</span>),e=this._parse(e,<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.format</span>);r=<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.kdf</span><span class="hljs-selector-class">.execute</span>(r,t<span class="hljs-selector-class">.keySize</span>,t<span class="hljs-selector-class">.ivSize</span>,e<span class="hljs-selector-class">.salt</span>,<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.hasher</span>);return <span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.iv</span>=r<span class="hljs-selector-class">.iv</span>,o<span class="hljs-selector-class">.decrypt</span><span class="hljs-selector-class">.call</span>(this,t,e,r<span class="hljs-selector-class">.key</span>,<span class="hljs-selector-tag">i</span>)}})),<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.mode</span><span class="hljs-selector-class">.CFB</span>=((<span class="hljs-selector-tag">p</span>=<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.lib</span><span class="hljs-selector-class">.BlockCipherMode</span><span class="hljs-selector-class">.extend</span>())<span class="hljs-selector-class">.Encryptor</span>=<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.extend</span>({processBlock:<span class="hljs-built_in">function</span>(t,e){<span class="hljs-selector-tag">var</span> r=this._cipher,<span class="hljs-selector-tag">i</span>=r<span class="hljs-selector-class">.blockSize</span>;t2<span class="hljs-selector-class">.call</span>(this,t,e,<span class="hljs-selector-tag">i</span>,r),this._prevBlock=t<span class="hljs-selector-class">.slice</span>(e,e+<span class="hljs-selector-tag">i</span>)}}),<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.Decryptor</span>=<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.extend</span>({processBlock:<span class="hljs-built_in">function</span>(t,e){<span class="hljs-selector-tag">var</span> r=this._cipher,<span class="hljs-selector-tag">i</span>=r<span class="hljs-selector-class">.blockSize</span>,o=t<span class="hljs-selector-class">.slice</span>(e,e+<span class="hljs-selector-tag">i</span>);t2<span class="hljs-selector-class">.call</span>(this,t,e,<span class="hljs-selector-tag">i</span>,r),this._prevBlock=o}}),<span class="hljs-selector-tag">p</span>),<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.mode</span><span class="hljs-selector-class">.CTR</span>=(r=<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.lib</span><span class="hljs-selector-class">.BlockCipherMode</span><span class="hljs-selector-class">.extend</span>(),w=r<span class="hljs-selector-class">.Encryptor</span>=r<span class="hljs-selector-class">.extend</span>({processBlock:<span class="hljs-built_in">function</span>(t,e){<span class="hljs-selector-tag">var</span> r=this._cipher,<span class="hljs-selector-tag">i</span>=r<span class="hljs-selector-class">.blockSize</span>,o=this._iv,n=this._counter,s=(o&amp;&amp;(n=this._counter=o<span class="hljs-selector-class">.slice</span>(<span class="hljs-number">0</span>),this._iv=void <span class="hljs-number">0</span>),n<span class="hljs-selector-class">.slice</span>(<span class="hljs-number">0</span>));r<span class="hljs-selector-class">.encryptBlock</span>(s,<span class="hljs-number">0</span>),n<span class="hljs-selector-attr">[i-1]</span>=n<span class="hljs-selector-attr">[i-1]</span>+<span class="hljs-number">1</span>|<span class="hljs-number">0</span>;for(<span class="hljs-selector-tag">var</span> c=<span class="hljs-number">0</span>;c&lt;<span class="hljs-selector-tag">i</span>;c++)t<span class="hljs-selector-attr">[e+c]</span>^=s<span class="hljs-selector-attr">[c]</span>}}),r<span class="hljs-selector-class">.Decryptor</span>=w,r),<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.mode</span><span class="hljs-selector-class">.CTRGladman</span>=(<span class="hljs-selector-tag">P</span>=<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.lib</span><span class="hljs-selector-class">.BlockCipherMode</span><span class="hljs-selector-class">.extend</span>(),u=<span class="hljs-selector-tag">P</span><span class="hljs-selector-class">.Encryptor</span>=<span class="hljs-selector-tag">P</span><span class="hljs-selector-class">.extend</span>({processBlock:<span class="hljs-built_in">function</span>(t,e){<span class="hljs-selector-tag">var</span> r=this._cipher,<span class="hljs-selector-tag">i</span>=r<span class="hljs-selector-class">.blockSize</span>,o=this._iv,n=this._counter,s=(o&amp;&amp;(n=this._counter=o<span class="hljs-selector-class">.slice</span>(<span class="hljs-number">0</span>),this._iv=void <span class="hljs-number">0</span>),<span class="hljs-number">0</span>===((o=n)<span class="hljs-selector-attr">[0]</span>=e2(o<span class="hljs-selector-attr">[0]</span>))&amp;&amp;(o<span class="hljs-selector-attr">[1]</span>=e2(o<span class="hljs-selector-attr">[1]</span>)),n<span class="hljs-selector-class">.slice</span>(<span class="hljs-number">0</span>));r<span class="hljs-selector-class">.encryptBlock</span>(s,<span class="hljs-number">0</span>);for(<span class="hljs-selector-tag">var</span> c=<span class="hljs-number">0</span>;c&lt;<span class="hljs-selector-tag">i</span>;c++)t<span class="hljs-selector-attr">[e+c]</span>^=s<span class="hljs-selector-attr">[c]</span>}}),<span class="hljs-selector-tag">P</span><span class="hljs-selector-class">.Decryptor</span>=u,<span class="hljs-selector-tag">P</span>),<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.mode</span><span class="hljs-selector-class">.OFB</span>=(<span class="hljs-selector-tag">p</span>=<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.lib</span><span class="hljs-selector-class">.BlockCipherMode</span><span class="hljs-selector-class">.extend</span>(),w=<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.Encryptor</span>=<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.extend</span>({processBlock:<span class="hljs-built_in">function</span>(t,e){<span class="hljs-selector-tag">var</span> r=this._cipher,<span class="hljs-selector-tag">i</span>=r<span class="hljs-selector-class">.blockSize</span>,o=this._iv,n=this._keystream;o&amp;&amp;(n=this._keystream=o<span class="hljs-selector-class">.slice</span>(<span class="hljs-number">0</span>),this._iv=void <span class="hljs-number">0</span>),r<span class="hljs-selector-class">.encryptBlock</span>(n,<span class="hljs-number">0</span>);for(<span class="hljs-selector-tag">var</span> s=<span class="hljs-number">0</span>;s&lt;<span class="hljs-selector-tag">i</span>;s++)t<span class="hljs-selector-attr">[e+s]</span>^=n<span class="hljs-selector-attr">[s]</span>}}),<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.Decryptor</span>=w,<span class="hljs-selector-tag">p</span>),<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.mode</span><span class="hljs-selector-class">.ECB</span>=((u=<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.lib</span><span class="hljs-selector-class">.BlockCipherMode</span><span class="hljs-selector-class">.extend</span>())<span class="hljs-selector-class">.Encryptor</span>=u<span class="hljs-selector-class">.extend</span>({processBlock:<span class="hljs-built_in">function</span>(t,e){this._cipher<span class="hljs-selector-class">.encryptBlock</span>(t,e)}}),u<span class="hljs-selector-class">.Decryptor</span>=u<span class="hljs-selector-class">.extend</span>({processBlock:<span class="hljs-built_in">function</span>(t,e){this._cipher<span class="hljs-selector-class">.decryptBlock</span>(t,e)}}),u),<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.pad</span><span class="hljs-selector-class">.AnsiX923</span>={pad:<span class="hljs-built_in">function</span>(t,e){<span class="hljs-selector-tag">var</span> r=t<span class="hljs-selector-class">.sigBytes</span>,e=<span class="hljs-number">4</span>*e,e=e-r%e,r=r+e-<span class="hljs-number">1</span>;t<span class="hljs-selector-class">.clamp</span>(),t<span class="hljs-selector-class">.words</span><span class="hljs-selector-attr">[r&gt;&gt;&gt;2]</span>|=e&lt;&lt;<span class="hljs-number">24</span>-r%<span class="hljs-number">4</span>*<span class="hljs-number">8</span>,t<span class="hljs-selector-class">.sigBytes</span>+=e},unpad:<span class="hljs-built_in">function</span>(t){<span class="hljs-selector-tag">var</span> e=<span class="hljs-number">255</span>&amp;t<span class="hljs-selector-class">.words</span><span class="hljs-selector-attr">[t.sigBytes-1&gt;&gt;&gt;2]</span>;t<span class="hljs-selector-class">.sigBytes-</span>=e}},<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.pad</span><span class="hljs-selector-class">.Iso10126</span>={pad:<span class="hljs-built_in">function</span>(t,e){e*=<span class="hljs-number">4</span>,e-=t<span class="hljs-selector-class">.sigBytes</span>%e;t<span class="hljs-selector-class">.concat</span>(<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.lib</span><span class="hljs-selector-class">.WordArray</span><span class="hljs-selector-class">.random</span>(e-<span class="hljs-number">1</span>))<span class="hljs-selector-class">.concat</span>(<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.lib</span><span class="hljs-selector-class">.WordArray</span><span class="hljs-selector-class">.create</span>(<span class="hljs-selector-attr">[e&lt;&lt;24]</span>,<span class="hljs-number">1</span>))},unpad:<span class="hljs-built_in">function</span>(t){<span class="hljs-selector-tag">var</span> e=<span class="hljs-number">255</span>&amp;t<span class="hljs-selector-class">.words</span><span class="hljs-selector-attr">[t.sigBytes-1&gt;&gt;&gt;2]</span>;t<span class="hljs-selector-class">.sigBytes-</span>=e}},<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.pad</span><span class="hljs-selector-class">.Iso97971</span>={pad:<span class="hljs-built_in">function</span>(t,e){t<span class="hljs-selector-class">.concat</span>(<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.lib</span><span class="hljs-selector-class">.WordArray</span><span class="hljs-selector-class">.create</span>(<span class="hljs-selector-attr">[2147483648]</span>,<span class="hljs-number">1</span>)),<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.pad</span><span class="hljs-selector-class">.ZeroPadding</span><span class="hljs-selector-class">.pad</span>(t,e)},unpad:<span class="hljs-built_in">function</span>(t){<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.pad</span><span class="hljs-selector-class">.ZeroPadding</span><span class="hljs-selector-class">.unpad</span>(t),t<span class="hljs-selector-class">.sigBytes--</span>}},<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.pad</span><span class="hljs-selector-class">.ZeroPadding</span>={pad:<span class="hljs-built_in">function</span>(t,e){e*=<span class="hljs-number">4</span>;t<span class="hljs-selector-class">.clamp</span>(),t<span class="hljs-selector-class">.sigBytes</span>+=e-(t<span class="hljs-selector-class">.sigBytes</span>%e||e)},unpad:<span class="hljs-built_in">function</span>(t){for(<span class="hljs-selector-tag">var</span> e=t<span class="hljs-selector-class">.words</span>,r=t<span class="hljs-selector-class">.sigBytes-1</span>,r=t<span class="hljs-selector-class">.sigBytes-1</span>;<span class="hljs-number">0</span>&lt;=r;r--)if(e<span class="hljs-selector-attr">[r&gt;&gt;&gt;2]</span>&gt;&gt;&gt;<span class="hljs-number">24</span>-r%<span class="hljs-number">4</span>*<span class="hljs-number">8</span>&amp;<span class="hljs-number">255</span>){t<span class="hljs-selector-class">.sigBytes</span>=r+<span class="hljs-number">1</span>;break}}},<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.pad</span><span class="hljs-selector-class">.NoPadding</span>={pad:<span class="hljs-built_in">function</span>(){},unpad:<span class="hljs-built_in">function</span>(){}},d1=(<span class="hljs-selector-tag">P</span>=<span class="hljs-selector-tag">i</span>)<span class="hljs-selector-class">.lib</span><span class="hljs-selector-class">.CipherParams</span>,u1=<span class="hljs-selector-tag">P</span><span class="hljs-selector-class">.enc</span><span class="hljs-selector-class">.Hex</span>,<span class="hljs-selector-tag">P</span><span class="hljs-selector-class">.format</span><span class="hljs-selector-class">.Hex</span>={stringify:<span class="hljs-built_in">function</span>(t){return t<span class="hljs-selector-class">.ciphertext</span><span class="hljs-selector-class">.toString</span>(u1)},parse:<span class="hljs-built_in">function</span>(t){t=u1<span class="hljs-selector-class">.parse</span>(t);return d1<span class="hljs-selector-class">.create</span>({ciphertext:t})}};for(<span class="hljs-selector-tag">var</span> w=<span class="hljs-selector-tag">i</span>,<span class="hljs-selector-tag">p</span>=w<span class="hljs-selector-class">.lib</span><span class="hljs-selector-class">.BlockCipher</span>,u=w<span class="hljs-selector-class">.algo</span>,k=<span class="hljs-selector-attr">[]</span>,r2=<span class="hljs-selector-attr">[]</span>,i2=<span class="hljs-selector-attr">[]</span>,o2=<span class="hljs-selector-attr">[]</span>,n2=<span class="hljs-selector-attr">[]</span>,s2=<span class="hljs-selector-attr">[]</span>,c2=<span class="hljs-selector-attr">[]</span>,a2=<span class="hljs-selector-attr">[]</span>,<span class="hljs-selector-tag">h2</span>=<span class="hljs-selector-attr">[]</span>,l2=<span class="hljs-selector-attr">[]</span>,x=<span class="hljs-selector-attr">[]</span>,<span class="hljs-selector-tag">b</span>=<span class="hljs-number">0</span>;<span class="hljs-selector-tag">b</span>&lt;<span class="hljs-number">256</span>;<span class="hljs-selector-tag">b</span>++)x<span class="hljs-selector-attr">[b]</span>=<span class="hljs-selector-tag">b</span>&lt;<span class="hljs-number">128</span>?<span class="hljs-selector-tag">b</span>&lt;&lt;<span class="hljs-number">1</span>:b&lt;&lt;<span class="hljs-number">1</span>^<span class="hljs-number">283</span>;for(<span class="hljs-selector-tag">var</span> m=<span class="hljs-number">0</span>,S=<span class="hljs-number">0</span>,<span class="hljs-selector-tag">b</span>=<span class="hljs-number">0</span>;<span class="hljs-selector-tag">b</span>&lt;<span class="hljs-number">256</span>;<span class="hljs-selector-tag">b</span>++){<span class="hljs-selector-tag">var</span> E=S^S&lt;&lt;<span class="hljs-number">1</span>^S&lt;&lt;<span class="hljs-number">2</span>^S&lt;&lt;<span class="hljs-number">3</span>^S&lt;&lt;<span class="hljs-number">4</span>,f2=(k<span class="hljs-selector-attr">[m]</span>=E=E&gt;&gt;&gt;<span class="hljs-number">8</span>^<span class="hljs-number">255</span>&amp;E^<span class="hljs-number">99</span>,x<span class="hljs-selector-attr">[r2[E]</span>=m]),d2=x<span class="hljs-selector-attr">[f2]</span>,u2=x<span class="hljs-selector-attr">[d2]</span>,M=<span class="hljs-number">257</span>*x<span class="hljs-selector-attr">[E]</span>^<span class="hljs-number">16843008</span>*E;i2<span class="hljs-selector-attr">[m]</span>=M&lt;&lt;<span class="hljs-number">24</span>|M&gt;&gt;&gt;<span class="hljs-number">8</span>,o2<span class="hljs-selector-attr">[m]</span>=M&lt;&lt;<span class="hljs-number">16</span>|M&gt;&gt;&gt;<span class="hljs-number">16</span>,n2<span class="hljs-selector-attr">[m]</span>=M&lt;&lt;<span class="hljs-number">8</span>|M&gt;&gt;&gt;<span class="hljs-number">24</span>,s2<span class="hljs-selector-attr">[m]</span>=M,c2<span class="hljs-selector-attr">[E]</span>=(M=<span class="hljs-number">16843009</span>*u2^<span class="hljs-number">65537</span>*d2^<span class="hljs-number">257</span>*f2^<span class="hljs-number">16843008</span>*m)&lt;&lt;<span class="hljs-number">24</span>|M&gt;&gt;&gt;<span class="hljs-number">8</span>,a2<span class="hljs-selector-attr">[E]</span>=M&lt;&lt;<span class="hljs-number">16</span>|M&gt;&gt;&gt;<span class="hljs-number">16</span>,<span class="hljs-selector-tag">h2</span><span class="hljs-selector-attr">[E]</span>=M&lt;&lt;<span class="hljs-number">8</span>|M&gt;&gt;&gt;<span class="hljs-number">24</span>,l2<span class="hljs-selector-attr">[E]</span>=M,m?(m=f2^x<span class="hljs-selector-attr">[x[x[u2^f2]</span>]],S^=x<span class="hljs-selector-attr">[x[S]</span>]):m=S=<span class="hljs-number">1</span>}<span class="hljs-selector-tag">var</span> p2=<span class="hljs-selector-attr">[0,1,2,4,8,16,32,64,128,27,54]</span>,u=u<span class="hljs-selector-class">.AES</span>=<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.extend</span>({_doReset:<span class="hljs-built_in">function</span>(){if(!this._nRounds||this._keyPriorReset!==this._key){for(<span class="hljs-selector-tag">var</span> t=this._keyPriorReset=this._key,e=t<span class="hljs-selector-class">.words</span>,r=t<span class="hljs-selector-class">.sigBytes</span>/<span class="hljs-number">4</span>,<span class="hljs-selector-tag">i</span>=<span class="hljs-number">4</span>*(<span class="hljs-number">1</span>+(this._nRounds=<span class="hljs-number">6</span>+r)),o=this._keySchedule=<span class="hljs-selector-attr">[]</span>,n=<span class="hljs-number">0</span>;n&lt;<span class="hljs-selector-tag">i</span>;n++)n&lt;r?o<span class="hljs-selector-attr">[n]</span>=e<span class="hljs-selector-attr">[n]</span>:(a=o[n-<span class="hljs-number">1</span>],n%r?<span class="hljs-number">6</span>&lt;r&amp;&amp;n%r==<span class="hljs-number">4</span>&amp;&amp;(a=k[a&gt;&gt;&gt;<span class="hljs-number">24</span>]&lt;&lt;<span class="hljs-number">24</span>|k[a&gt;&gt;&gt;<span class="hljs-number">16</span>&amp;<span class="hljs-number">255</span>]&lt;&lt;<span class="hljs-number">16</span>|k[a&gt;&gt;&gt;<span class="hljs-number">8</span>&amp;<span class="hljs-number">255</span>]&lt;&lt;<span class="hljs-number">8</span>|k[<span class="hljs-number">255</span>&amp;a]):(a=k[(a=a&lt;&lt;<span class="hljs-number">8</span>|a&gt;&gt;&gt;<span class="hljs-number">24</span>)&gt;&gt;&gt;<span class="hljs-number">24</span>]&lt;&lt;<span class="hljs-number">24</span>|k[a&gt;&gt;&gt;<span class="hljs-number">16</span>&amp;<span class="hljs-number">255</span>]&lt;&lt;<span class="hljs-number">16</span>|k[a&gt;&gt;&gt;<span class="hljs-number">8</span>&amp;<span class="hljs-number">255</span>]&lt;&lt;<span class="hljs-number">8</span>|k[<span class="hljs-number">255</span>&amp;a],a^=p2[n/r|<span class="hljs-number">0</span>]&lt;&lt;<span class="hljs-number">24</span>),o[n]=o[n-r]^a);for(<span class="hljs-selector-tag">var</span> s=this._invKeySchedule=<span class="hljs-selector-attr">[]</span>,c=<span class="hljs-number">0</span>;c&lt;<span class="hljs-selector-tag">i</span>;c++){<span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">a</span>,n=<span class="hljs-selector-tag">i</span>-c;<span class="hljs-selector-tag">a</span>=c%<span class="hljs-number">4</span>?o<span class="hljs-selector-attr">[n]</span>:o[n-<span class="hljs-number">4</span>],s[c]=c&lt;<span class="hljs-number">4</span>||n&lt;=<span class="hljs-number">4</span>?a:c2[k[a&gt;&gt;&gt;<span class="hljs-number">24</span>]]^a2[k[a&gt;&gt;&gt;<span class="hljs-number">16</span>&amp;<span class="hljs-number">255</span>]]^h2[k[a&gt;&gt;&gt;<span class="hljs-number">8</span>&amp;<span class="hljs-number">255</span>]]^l2[k[<span class="hljs-number">255</span>&amp;a]]}}},encryptBlock:<span class="hljs-built_in">function</span>(t,e){this._doCryptBlock(t,e,this._keySchedule,i2,o2,n2,s2,k)},decryptBlock:<span class="hljs-built_in">function</span>(t,e){<span class="hljs-selector-tag">var</span> r=t<span class="hljs-selector-attr">[e+1]</span>,r=(t<span class="hljs-selector-attr">[e+1]</span>=t<span class="hljs-selector-attr">[e+3]</span>,t<span class="hljs-selector-attr">[e+3]</span>=r,this._doCryptBlock(t,e,this._invKeySchedule,c2,a2,<span class="hljs-selector-tag">h2</span>,l2,r2),t<span class="hljs-selector-attr">[e+1]</span>);t<span class="hljs-selector-attr">[e+1]</span>=t<span class="hljs-selector-attr">[e+3]</span>,t<span class="hljs-selector-attr">[e+3]</span>=r},_doCryptBlock:<span class="hljs-built_in">function</span>(t,e,r,i,o,n,s,c){for(<span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">a</span>=this._nRounds,h=t<span class="hljs-selector-attr">[e]</span>^r<span class="hljs-selector-attr">[0]</span>,l=t<span class="hljs-selector-attr">[e+1]</span>^r<span class="hljs-selector-attr">[1]</span>,f=t<span class="hljs-selector-attr">[e+2]</span>^r<span class="hljs-selector-attr">[2]</span>,d=t<span class="hljs-selector-attr">[e+3]</span>^r<span class="hljs-selector-attr">[3]</span>,u=<span class="hljs-number">4</span>,<span class="hljs-selector-tag">p</span>=<span class="hljs-number">1</span>;<span class="hljs-selector-tag">p</span>&lt;<span class="hljs-selector-tag">a</span>;<span class="hljs-selector-tag">p</span>++)<span class="hljs-selector-tag">var</span> _=<span class="hljs-selector-tag">i</span><span class="hljs-selector-attr">[h&gt;&gt;&gt;24]</span>^o<span class="hljs-selector-attr">[l&gt;&gt;&gt;16&amp;255]</span>^n<span class="hljs-selector-attr">[f&gt;&gt;&gt;8&amp;255]</span>^s<span class="hljs-selector-attr">[255&amp;d]</span>^r<span class="hljs-selector-attr">[u++]</span>,y=<span class="hljs-selector-tag">i</span><span class="hljs-selector-attr">[l&gt;&gt;&gt;24]</span>^o<span class="hljs-selector-attr">[f&gt;&gt;&gt;16&amp;255]</span>^n<span class="hljs-selector-attr">[d&gt;&gt;&gt;8&amp;255]</span>^s<span class="hljs-selector-attr">[255&amp;h]</span>^r<span class="hljs-selector-attr">[u++]</span>,g=<span class="hljs-selector-tag">i</span><span class="hljs-selector-attr">[f&gt;&gt;&gt;24]</span>^o<span class="hljs-selector-attr">[d&gt;&gt;&gt;16&amp;255]</span>^n<span class="hljs-selector-attr">[h&gt;&gt;&gt;8&amp;255]</span>^s<span class="hljs-selector-attr">[255&amp;l]</span>^r<span class="hljs-selector-attr">[u++]</span>,v=<span class="hljs-selector-tag">i</span><span class="hljs-selector-attr">[d&gt;&gt;&gt;24]</span>^o<span class="hljs-selector-attr">[h&gt;&gt;&gt;16&amp;255]</span>^n<span class="hljs-selector-attr">[l&gt;&gt;&gt;8&amp;255]</span>^s<span class="hljs-selector-attr">[255&amp;f]</span>^r<span class="hljs-selector-attr">[u++]</span>,h=_,l=y,f=g,d=v;_=(c<span class="hljs-selector-attr">[h&gt;&gt;&gt;24]</span>&lt;&lt;<span class="hljs-number">24</span>|c<span class="hljs-selector-attr">[l&gt;&gt;&gt;16&amp;255]</span>&lt;&lt;<span class="hljs-number">16</span>|c<span class="hljs-selector-attr">[f&gt;&gt;&gt;8&amp;255]</span>&lt;&lt;<span class="hljs-number">8</span>|c<span class="hljs-selector-attr">[255&amp;d]</span>)^r<span class="hljs-selector-attr">[u++]</span>,y=(c<span class="hljs-selector-attr">[l&gt;&gt;&gt;24]</span>&lt;&lt;<span class="hljs-number">24</span>|c<span class="hljs-selector-attr">[f&gt;&gt;&gt;16&amp;255]</span>&lt;&lt;<span class="hljs-number">16</span>|c<span class="hljs-selector-attr">[d&gt;&gt;&gt;8&amp;255]</span>&lt;&lt;<span class="hljs-number">8</span>|c<span class="hljs-selector-attr">[255&amp;h]</span>)^r<span class="hljs-selector-attr">[u++]</span>,g=(c<span class="hljs-selector-attr">[f&gt;&gt;&gt;24]</span>&lt;&lt;<span class="hljs-number">24</span>|c<span class="hljs-selector-attr">[d&gt;&gt;&gt;16&amp;255]</span>&lt;&lt;<span class="hljs-number">16</span>|c<span class="hljs-selector-attr">[h&gt;&gt;&gt;8&amp;255]</span>&lt;&lt;<span class="hljs-number">8</span>|c<span class="hljs-selector-attr">[255&amp;l]</span>)^r<span class="hljs-selector-attr">[u++]</span>,v=(c<span class="hljs-selector-attr">[d&gt;&gt;&gt;24]</span>&lt;&lt;<span class="hljs-number">24</span>|c<span class="hljs-selector-attr">[h&gt;&gt;&gt;16&amp;255]</span>&lt;&lt;<span class="hljs-number">16</span>|c<span class="hljs-selector-attr">[l&gt;&gt;&gt;8&amp;255]</span>&lt;&lt;<span class="hljs-number">8</span>|c<span class="hljs-selector-attr">[255&amp;f]</span>)^r<span class="hljs-selector-attr">[u++]</span>;t<span class="hljs-selector-attr">[e]</span>=_,t<span class="hljs-selector-attr">[e+1]</span>=y,t<span class="hljs-selector-attr">[e+2]</span>=g,t<span class="hljs-selector-attr">[e+3]</span>=v},keySize:<span class="hljs-number">8</span>}),<span class="hljs-selector-tag">P</span>=(w<span class="hljs-selector-class">.AES</span>=<span class="hljs-selector-tag">p</span>._createHelper(u),<span class="hljs-selector-tag">i</span>),_2=(w=<span class="hljs-selector-tag">P</span><span class="hljs-selector-class">.lib</span>)<span class="hljs-selector-class">.WordArray</span>,w=w<span class="hljs-selector-class">.BlockCipher</span>,<span class="hljs-selector-tag">p</span>=<span class="hljs-selector-tag">P</span><span class="hljs-selector-class">.algo</span>,y2=<span class="hljs-selector-attr">[57,49,41,33,25,17,9,1,58,50,42,34,26,18,10,2,59,51,43,35,27,19,11,3,60,52,44,36,63,55,47,39,31,23,15,7,62,54,46,38,30,22,14,6,61,53,45,37,29,21,13,5,28,20,12,4]</span>,g2=<span class="hljs-selector-attr">[14,17,11,24,1,5,3,28,15,6,21,10,23,19,12,4,26,8,16,7,27,20,13,2,41,52,31,37,47,55,30,40,51,45,33,48,44,49,39,56,34,53,46,42,50,36,29,32]</span>,v2=<span class="hljs-selector-attr">[1,2,4,6,8,10,12,14,15,17,19,21,23,25,27,28]</span>,B2=<span class="hljs-selector-attr">[{0:8421888,268435456:32768,536870912:8421378,805306368:2,1073741824:512,1342177280:8421890,1610612736:8389122,1879048192:8388608,2147483648:514,2415919104:8389120,2684354560:33280,2952790016:8421376,3221225472:32770,3489660928:8388610,3758096384:0,4026531840:33282,134217728:0,402653184:8421890,671088640:33282,939524096:32768,1207959552:8421888,1476395008:512,1744830464:8421378,2013265920:2,2281701376:8389120,2550136832:33280,2818572288:8421376,3087007744:8389122,3355443200:8388610,3623878656:32770,3892314112:514,4160749568:8388608,1:32768,268435457:2,536870913:8421888,805306369:8388608,1073741825:8421378,1342177281:33280,1610612737:512,1879048193:8389122,2147483649:8421890,2415919105:8421376,2684354561:8388610,2952790017:33282,3221225473:514,3489660929:8389120,3758096385:32770,4026531841:0,134217729:8421890,402653185:8421376,671088641:8388608,939524097:512,1207959553:32768,1476395009:8388610,1744830465:2,2013265921:33282,2281701377:32770,2550136833:8389122,2818572289:514,3087007745:8421888,3355443201:8389120,3623878657:0,3892314113:33280,4160749569:8421378},{0:1074282512,16777216:16384,33554432:524288,50331648:1074266128,67108864:1073741840,83886080:1074282496,100663296:1073758208,117440512:16,134217728:540672,150994944:1073758224,167772160:1073741824,184549376:540688,201326592:524304,218103808:0,234881024:16400,251658240:1074266112,8388608:1073758208,25165824:540688,41943040:16,58720256:1073758224,75497472:1074282512,92274688:1073741824,109051904:524288,125829120:1074266128,142606336:524304,159383552:0,176160768:16384,192937984:1074266112,209715200:1073741840,226492416:540672,243269632:1074282496,260046848:16400,268435456:0,285212672:1074266128,301989888:1073758224,318767104:1074282496,335544320:1074266112,352321536:16,369098752:540688,385875968:16384,402653184:16400,419430400:524288,436207616:524304,452984832:1073741840,469762048:540672,486539264:1073758208,503316480:1073741824,520093696:1074282512,276824064:540688,293601280:524288,310378496:1074266112,327155712:16384,343932928:1073758208,360710144:1074282512,377487360:16,394264576:1073741824,411041792:1074282496,427819008:1073741840,444596224:1073758224,461373440:524304,478150656:0,494927872:16400,511705088:1074266128,528482304:540672},{0:260,1048576:0,2097152:67109120,3145728:65796,4194304:65540,5242880:67108868,6291456:67174660,7340032:67174400,8388608:67108864,9437184:67174656,10485760:65792,11534336:67174404,12582912:67109124,13631488:65536,14680064:4,15728640:256,524288:67174656,1572864:67174404,2621440:0,3670016:67109120,4718592:67108868,5767168:65536,6815744:65540,7864320:260,8912896:4,9961472:256,11010048:67174400,12058624:65796,13107200:65792,14155776:67109124,15204352:67174660,16252928:67108864,16777216:67174656,17825792:65540,18874368:65536,19922944:67109120,20971520:256,22020096:67174660,23068672:67108868,24117248:0,25165824:67109124,26214400:67108864,27262976:4,28311552:65792,29360128:67174400,30408704:260,31457280:65796,32505856:67174404,17301504:67108864,18350080:260,19398656:67174656,20447232:0,21495808:65540,22544384:67109120,23592960:256,24641536:67174404,25690112:65536,26738688:67174660,27787264:65796,28835840:67108868,29884416:67109124,30932992:67174400,31981568:4,33030144:65792},{0:2151682048,65536:2147487808,131072:4198464,196608:2151677952,262144:0,327680:4198400,393216:2147483712,458752:4194368,524288:2147483648,589824:4194304,655360:64,720896:2147487744,786432:2151678016,851968:4160,917504:4096,983040:2151682112,32768:2147487808,98304:64,163840:2151678016,229376:2147487744,294912:4198400,360448:2151682112,425984:0,491520:2151677952,557056:4096,622592:2151682048,688128:4194304,753664:4160,819200:2147483648,884736:4194368,950272:4198464,1015808:2147483712,1048576:4194368,1114112:4198400,1179648:2147483712,1245184:0,1310720:4160,1376256:2151678016,1441792:2151682048,1507328:2147487808,1572864:2151682112,1638400:2147483648,1703936:2151677952,1769472:4198464,1835008:2147487744,1900544:4194304,1966080:64,2031616:4096,1081344:2151677952,1146880:2151682112,1212416:0,1277952:4198400,1343488:4194368,1409024:2147483648,1474560:2147487808,1540096:64,1605632:2147483712,1671168:4096,1736704:2147487744,1802240:2151678016,1867776:4160,1933312:2151682048,1998848:4194304,2064384:4198464},{0:128,4096:17039360,8192:262144,12288:536870912,16384:537133184,20480:16777344,24576:553648256,28672:262272,32768:16777216,36864:537133056,40960:536871040,45056:553910400,49152:553910272,53248:0,57344:17039488,61440:553648128,2048:17039488,6144:553648256,10240:128,14336:17039360,18432:262144,22528:537133184,26624:553910272,30720:536870912,34816:537133056,38912:0,43008:553910400,47104:16777344,51200:536871040,55296:553648128,59392:16777216,63488:262272,65536:262144,69632:128,73728:536870912,77824:553648256,81920:16777344,86016:553910272,90112:537133184,94208:16777216,98304:553910400,102400:553648128,106496:17039360,110592:537133056,114688:262272,118784:536871040,122880:0,126976:17039488,67584:553648256,71680:16777216,75776:17039360,79872:537133184,83968:536870912,88064:17039488,92160:128,96256:553910272,100352:262272,104448:553910400,108544:0,112640:553648128,116736:16777344,120832:262144,124928:537133056,129024:536871040},{0:268435464,256:8192,512:270532608,768:270540808,1024:268443648,1280:2097152,1536:2097160,1792:268435456,2048:0,2304:268443656,2560:2105344,2816:8,3072:270532616,3328:2105352,3584:8200,3840:270540800,128:270532608,384:270540808,640:8,896:2097152,1152:2105352,1408:268435464,1664:268443648,1920:8200,2176:2097160,2432:8192,2688:268443656,2944:270532616,3200:0,3456:270540800,3712:2105344,3968:268435456,4096:268443648,4352:270532616,4608:270540808,4864:8200,5120:2097152,5376:268435456,5632:268435464,5888:2105344,6144:2105352,6400:0,6656:8,6912:270532608,7168:8192,7424:268443656,7680:270540800,7936:2097160,4224:8,4480:2105344,4736:2097152,4992:268435464,5248:268443648,5504:8200,5760:270540808,6016:270532608,6272:270540800,6528:270532616,6784:8192,7040:2105352,7296:2097160,7552:0,7808:268435456,8064:268443656},{0:1048576,16:33555457,32:1024,48:1049601,64:34604033,80:0,96:1,112:34603009,128:33555456,144:1048577,160:33554433,176:34604032,192:34603008,208:1025,224:1049600,240:33554432,8:34603009,24:0,40:33555457,56:34604032,72:1048576,88:33554433,104:33554432,120:1025,136:1049601,152:33555456,168:34603008,184:1048577,200:1024,216:34604033,232:1,248:1049600,256:33554432,272:1048576,288:33555457,304:34603009,320:1048577,336:33555456,352:34604032,368:1049601,384:1025,400:34604033,416:1049600,432:1,448:0,464:34603008,480:33554433,496:1024,264:1049600,280:33555457,296:34603009,312:1,328:33554432,344:1048576,360:1025,376:34604032,392:33554433,408:34603008,424:0,440:34604033,456:1049601,472:1024,488:33555456,504:1048577},{0:134219808,1:131072,2:134217728,3:32,4:131104,5:134350880,6:134350848,7:2048,8:134348800,9:134219776,10:133120,11:134348832,12:2080,13:0,14:134217760,15:133152,2147483648:2048,2147483649:134350880,2147483650:134219808,2147483651:134217728,2147483652:134348800,2147483653:133120,2147483654:133152,2147483655:32,2147483656:134217760,2147483657:2080,2147483658:131104,2147483659:134350848,2147483660:0,2147483661:134348832,2147483662:134219776,2147483663:131072,16:133152,17:134350848,18:32,19:2048,20:134219776,21:134217760,22:134348832,23:131072,24:0,25:131104,26:134348800,27:134219808,28:134350880,29:133120,30:2080,31:134217728,2147483664:131072,2147483665:2048,2147483666:134348832,2147483667:133152,2147483668:32,2147483669:134348800,2147483670:134217728,2147483671:134219808,2147483672:134350880,2147483673:134217760,2147483674:134219776,2147483675:0,2147483676:133120,2147483677:2080,2147483678:131104,2147483679:134350848}]</span>,w2=<span class="hljs-selector-attr">[4160749569,528482304,33030144,2064384,129024,8064,504,2147483679]</span>,k2=<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.DES</span>=w<span class="hljs-selector-class">.extend</span>({_doReset:<span class="hljs-built_in">function</span>(){for(<span class="hljs-selector-tag">var</span> t=this._key<span class="hljs-selector-class">.words</span>,e=<span class="hljs-selector-attr">[]</span>,r=<span class="hljs-number">0</span>;r&lt;<span class="hljs-number">56</span>;r++){<span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">i</span>=y2<span class="hljs-selector-attr">[r]</span>-<span class="hljs-number">1</span>;e<span class="hljs-selector-attr">[r]</span>=t<span class="hljs-selector-attr">[i&gt;&gt;&gt;5]</span>&gt;&gt;&gt;<span class="hljs-number">31</span>-<span class="hljs-selector-tag">i</span>%<span class="hljs-number">32</span>&amp;<span class="hljs-number">1</span>}for(<span class="hljs-selector-tag">var</span> o=this._subKeys=<span class="hljs-selector-attr">[]</span>,n=<span class="hljs-number">0</span>;n&lt;<span class="hljs-number">16</span>;n++){for(<span class="hljs-selector-tag">var</span> s=o<span class="hljs-selector-attr">[n]</span>=<span class="hljs-selector-attr">[]</span>,c=v2<span class="hljs-selector-attr">[n]</span>,r=<span class="hljs-number">0</span>;r&lt;<span class="hljs-number">24</span>;r++)s<span class="hljs-selector-attr">[r/6|0]</span>|=e<span class="hljs-selector-attr">[(g2[r]</span>-<span class="hljs-number">1</span>+c)%<span class="hljs-number">28</span>]&lt;&lt;<span class="hljs-number">31</span>-r%<span class="hljs-number">6</span>,s<span class="hljs-selector-attr">[4+(r/6|0)]</span>|=e<span class="hljs-selector-attr">[28+(g2[r+24]</span>-<span class="hljs-number">1</span>+c)%<span class="hljs-number">28</span>]&lt;&lt;<span class="hljs-number">31</span>-r%<span class="hljs-number">6</span>;s<span class="hljs-selector-attr">[0]</span>=s<span class="hljs-selector-attr">[0]</span>&lt;&lt;<span class="hljs-number">1</span>|s<span class="hljs-selector-attr">[0]</span>&gt;&gt;&gt;<span class="hljs-number">31</span>;for(r=<span class="hljs-number">1</span>;r&lt;<span class="hljs-number">7</span>;r++)s<span class="hljs-selector-attr">[r]</span>=s<span class="hljs-selector-attr">[r]</span>&gt;&gt;&gt;<span class="hljs-number">4</span>*(r-<span class="hljs-number">1</span>)+<span class="hljs-number">3</span>;s<span class="hljs-selector-attr">[7]</span>=s<span class="hljs-selector-attr">[7]</span>&lt;&lt;<span class="hljs-number">5</span>|s<span class="hljs-selector-attr">[7]</span>&gt;&gt;&gt;<span class="hljs-number">27</span>}for(<span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">a</span>=this._invSubKeys=<span class="hljs-selector-attr">[]</span>,r=<span class="hljs-number">0</span>;r&lt;<span class="hljs-number">16</span>;r++)<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[r]</span>=o<span class="hljs-selector-attr">[15-r]</span>},encryptBlock:<span class="hljs-built_in">function</span>(t,e){this._doCryptBlock(t,e,this._subKeys)},decryptBlock:<span class="hljs-built_in">function</span>(t,e){this._doCryptBlock(t,e,this._invSubKeys)},_doCryptBlock:<span class="hljs-built_in">function</span>(t,e,r){this._lBlock=t<span class="hljs-selector-attr">[e]</span>,this._rBlock=t<span class="hljs-selector-attr">[e+1]</span>,x2<span class="hljs-selector-class">.call</span>(this,<span class="hljs-number">4</span>,<span class="hljs-number">252645135</span>),x2<span class="hljs-selector-class">.call</span>(this,<span class="hljs-number">16</span>,<span class="hljs-number">65535</span>),b2<span class="hljs-selector-class">.call</span>(this,<span class="hljs-number">2</span>,<span class="hljs-number">858993459</span>),b2<span class="hljs-selector-class">.call</span>(this,<span class="hljs-number">8</span>,<span class="hljs-number">16711935</span>),x2<span class="hljs-selector-class">.call</span>(this,<span class="hljs-number">1</span>,<span class="hljs-number">1431655765</span>);for(<span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">i</span>=<span class="hljs-number">0</span>;<span class="hljs-selector-tag">i</span>&lt;<span class="hljs-number">16</span>;<span class="hljs-selector-tag">i</span>++){for(<span class="hljs-selector-tag">var</span> o=r<span class="hljs-selector-attr">[i]</span>,n=this._lBlock,s=this._rBlock,c=<span class="hljs-number">0</span>,<span class="hljs-selector-tag">a</span>=<span class="hljs-number">0</span>;<span class="hljs-selector-tag">a</span>&lt;<span class="hljs-number">8</span>;<span class="hljs-selector-tag">a</span>++)c|=B2<span class="hljs-selector-attr">[a]</span><span class="hljs-selector-attr">[((s^o[a]</span>)&amp;w2<span class="hljs-selector-attr">[a]</span>)&gt;&gt;&gt;<span class="hljs-number">0</span>];this._lBlock=s,this._rBlock=n^c}<span class="hljs-selector-tag">var</span> h=this._lBlock;this._lBlock=this._rBlock,this._rBlock=h,x2<span class="hljs-selector-class">.call</span>(this,<span class="hljs-number">1</span>,<span class="hljs-number">1431655765</span>),b2<span class="hljs-selector-class">.call</span>(this,<span class="hljs-number">8</span>,<span class="hljs-number">16711935</span>),b2<span class="hljs-selector-class">.call</span>(this,<span class="hljs-number">2</span>,<span class="hljs-number">858993459</span>),x2<span class="hljs-selector-class">.call</span>(this,<span class="hljs-number">16</span>,<span class="hljs-number">65535</span>),x2<span class="hljs-selector-class">.call</span>(this,<span class="hljs-number">4</span>,<span class="hljs-number">252645135</span>),t<span class="hljs-selector-attr">[e]</span>=this._lBlock,t<span class="hljs-selector-attr">[e+1]</span>=this._rBlock},keySize:<span class="hljs-number">2</span>,ivSize:<span class="hljs-number">2</span>,blockSize:<span class="hljs-number">2</span>});function x2(t,e){e=(this._lBlock&gt;&gt;&gt;t^this._rBlock)&amp;e;this._rBlock^=e,this._lBlock^=e&lt;&lt;t}function b2(t,e){e=(this._rBlock&gt;&gt;&gt;t^this._lBlock)&amp;e;this._lBlock^=e,this._rBlock^=e&lt;&lt;t}<span class="hljs-selector-tag">P</span><span class="hljs-selector-class">.DES</span>=w._createHelper(k2),<span class="hljs-selector-tag">p</span>=<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.TripleDES</span>=w<span class="hljs-selector-class">.extend</span>({_doReset:<span class="hljs-built_in">function</span>(){<span class="hljs-selector-tag">var</span> t=this._key<span class="hljs-selector-class">.words</span>;if(<span class="hljs-number">2</span>!==t<span class="hljs-selector-class">.length</span>&amp;&amp;<span class="hljs-number">4</span>!==t<span class="hljs-selector-class">.length</span>&amp;&amp;t<span class="hljs-selector-class">.length</span>&lt;<span class="hljs-number">6</span>)throw new Error("Invalid key length - <span class="hljs-number">3</span>DES requires the key length <span class="hljs-selector-tag">to</span> be <span class="hljs-number">64</span>, <span class="hljs-number">128</span>, <span class="hljs-number">192</span> or &gt;<span class="hljs-number">192</span>.");<span class="hljs-selector-tag">var</span> e=t<span class="hljs-selector-class">.slice</span>(<span class="hljs-number">0</span>,<span class="hljs-number">2</span>),r=t<span class="hljs-selector-class">.length</span>&lt;<span class="hljs-number">4</span>?t<span class="hljs-selector-class">.slice</span>(<span class="hljs-number">0</span>,<span class="hljs-number">2</span>):t.<span class="hljs-built_in">slice</span>(<span class="hljs-number">2</span>,<span class="hljs-number">4</span>),t=t.length&lt;<span class="hljs-number">6</span>?t.<span class="hljs-built_in">slice</span>(<span class="hljs-number">0</span>,<span class="hljs-number">2</span>):t.<span class="hljs-built_in">slice</span>(<span class="hljs-number">4</span>,<span class="hljs-number">6</span>);this._des1=k2<span class="hljs-selector-class">.createEncryptor</span>(_2<span class="hljs-selector-class">.create</span>(e)),this._des2=k2<span class="hljs-selector-class">.createEncryptor</span>(_2<span class="hljs-selector-class">.create</span>(r)),this._des3=k2<span class="hljs-selector-class">.createEncryptor</span>(_2<span class="hljs-selector-class">.create</span>(t))},encryptBlock:<span class="hljs-built_in">function</span>(t,e){this._des1<span class="hljs-selector-class">.encryptBlock</span>(t,e),this._des2<span class="hljs-selector-class">.decryptBlock</span>(t,e),this._des3<span class="hljs-selector-class">.encryptBlock</span>(t,e)},decryptBlock:<span class="hljs-built_in">function</span>(t,e){this._des3<span class="hljs-selector-class">.decryptBlock</span>(t,e),this._des2<span class="hljs-selector-class">.encryptBlock</span>(t,e),this._des1<span class="hljs-selector-class">.decryptBlock</span>(t,e)},keySize:<span class="hljs-number">6</span>,ivSize:<span class="hljs-number">2</span>,blockSize:<span class="hljs-number">2</span>}),<span class="hljs-selector-tag">P</span><span class="hljs-selector-class">.TripleDES</span>=w._createHelper(<span class="hljs-selector-tag">p</span>);<span class="hljs-selector-tag">var</span> u=<span class="hljs-selector-tag">i</span>,<span class="hljs-selector-tag">P</span>=u<span class="hljs-selector-class">.lib</span><span class="hljs-selector-class">.StreamCipher</span>,w=u<span class="hljs-selector-class">.algo</span>,m2=w<span class="hljs-selector-class">.RC4</span>=<span class="hljs-selector-tag">P</span><span class="hljs-selector-class">.extend</span>({_doReset:<span class="hljs-built_in">function</span>(){for(<span class="hljs-selector-tag">var</span> t=this._key,e=t<span class="hljs-selector-class">.words</span>,r=t<span class="hljs-selector-class">.sigBytes</span>,<span class="hljs-selector-tag">i</span>=this._S=<span class="hljs-selector-attr">[]</span>,o=<span class="hljs-number">0</span>;o&lt;<span class="hljs-number">256</span>;o++)<span class="hljs-selector-tag">i</span><span class="hljs-selector-attr">[o]</span>=o;for(<span class="hljs-selector-tag">var</span> o=<span class="hljs-number">0</span>,n=<span class="hljs-number">0</span>;o&lt;<span class="hljs-number">256</span>;o++){<span class="hljs-selector-tag">var</span> s=o%r,s=e<span class="hljs-selector-attr">[s&gt;&gt;&gt;2]</span>&gt;&gt;&gt;<span class="hljs-number">24</span>-s%<span class="hljs-number">4</span>*<span class="hljs-number">8</span>&amp;<span class="hljs-number">255</span>,n=(n+<span class="hljs-selector-tag">i</span><span class="hljs-selector-attr">[o]</span>+s)%<span class="hljs-number">256</span>,s=<span class="hljs-selector-tag">i</span><span class="hljs-selector-attr">[o]</span>;<span class="hljs-selector-tag">i</span><span class="hljs-selector-attr">[o]</span>=<span class="hljs-selector-tag">i</span><span class="hljs-selector-attr">[n]</span>,<span class="hljs-selector-tag">i</span><span class="hljs-selector-attr">[n]</span>=s}this._i=this._j=<span class="hljs-number">0</span>},_doProcessBlock:<span class="hljs-built_in">function</span>(t,e){t<span class="hljs-selector-attr">[e]</span>^=S2<span class="hljs-selector-class">.call</span>(this)},keySize:<span class="hljs-number">8</span>,ivSize:<span class="hljs-number">0</span>});function S2(){for(<span class="hljs-selector-tag">var</span> t=this._S,e=this._i,r=this._j,<span class="hljs-selector-tag">i</span>=<span class="hljs-number">0</span>,o=<span class="hljs-number">0</span>;o&lt;<span class="hljs-number">4</span>;o++){<span class="hljs-selector-tag">var</span> r=(r+t<span class="hljs-selector-attr">[e=(e+1)%256]</span>)%<span class="hljs-number">256</span>,n=t<span class="hljs-selector-attr">[e]</span>;t<span class="hljs-selector-attr">[e]</span>=t<span class="hljs-selector-attr">[r]</span>,t<span class="hljs-selector-attr">[r]</span>=n,<span class="hljs-selector-tag">i</span>|=t<span class="hljs-selector-attr">[(t[e]</span>+t<span class="hljs-selector-attr">[r]</span>)%<span class="hljs-number">256</span>]&lt;&lt;<span class="hljs-number">24</span>-<span class="hljs-number">8</span>*o}return this._i=e,this._j=r,<span class="hljs-selector-tag">i</span>}function A2(){for(<span class="hljs-selector-tag">var</span> t=this._X,e=this._C,r=<span class="hljs-number">0</span>;r&lt;<span class="hljs-number">8</span>;r++)c<span class="hljs-selector-attr">[r]</span>=e<span class="hljs-selector-attr">[r]</span>;e<span class="hljs-selector-attr">[0]</span>=e<span class="hljs-selector-attr">[0]</span>+<span class="hljs-number">1295307597</span>+this._b|<span class="hljs-number">0</span>,e<span class="hljs-selector-attr">[1]</span>=e<span class="hljs-selector-attr">[1]</span>+<span class="hljs-number">3545052371</span>+(e<span class="hljs-selector-attr">[0]</span>&gt;&gt;&gt;<span class="hljs-number">0</span>&lt;c<span class="hljs-selector-attr">[0]</span>&gt;&gt;&gt;<span class="hljs-number">0</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>)|<span class="hljs-number">0</span>,e[<span class="hljs-number">2</span>]=e[<span class="hljs-number">2</span>]+<span class="hljs-number">886263092</span>+(e[<span class="hljs-number">1</span>]&gt;&gt;&gt;<span class="hljs-number">0</span>&lt;c[<span class="hljs-number">1</span>]&gt;&gt;&gt;<span class="hljs-number">0</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>)|<span class="hljs-number">0</span>,e[<span class="hljs-number">3</span>]=e[<span class="hljs-number">3</span>]+<span class="hljs-number">1295307597</span>+(e[<span class="hljs-number">2</span>]&gt;&gt;&gt;<span class="hljs-number">0</span>&lt;c[<span class="hljs-number">2</span>]&gt;&gt;&gt;<span class="hljs-number">0</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>)|<span class="hljs-number">0</span>,e[<span class="hljs-number">4</span>]=e[<span class="hljs-number">4</span>]+<span class="hljs-number">3545052371</span>+(e[<span class="hljs-number">3</span>]&gt;&gt;&gt;<span class="hljs-number">0</span>&lt;c[<span class="hljs-number">3</span>]&gt;&gt;&gt;<span class="hljs-number">0</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>)|<span class="hljs-number">0</span>,e[<span class="hljs-number">5</span>]=e[<span class="hljs-number">5</span>]+<span class="hljs-number">886263092</span>+(e[<span class="hljs-number">4</span>]&gt;&gt;&gt;<span class="hljs-number">0</span>&lt;c[<span class="hljs-number">4</span>]&gt;&gt;&gt;<span class="hljs-number">0</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>)|<span class="hljs-number">0</span>,e[<span class="hljs-number">6</span>]=e[<span class="hljs-number">6</span>]+<span class="hljs-number">1295307597</span>+(e[<span class="hljs-number">5</span>]&gt;&gt;&gt;<span class="hljs-number">0</span>&lt;c[<span class="hljs-number">5</span>]&gt;&gt;&gt;<span class="hljs-number">0</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>)|<span class="hljs-number">0</span>,e[<span class="hljs-number">7</span>]=e[<span class="hljs-number">7</span>]+<span class="hljs-number">3545052371</span>+(e[<span class="hljs-number">6</span>]&gt;&gt;&gt;<span class="hljs-number">0</span>&lt;c[<span class="hljs-number">6</span>]&gt;&gt;&gt;<span class="hljs-number">0</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>)|<span class="hljs-number">0</span>,this._b=e[<span class="hljs-number">7</span>]&gt;&gt;&gt;<span class="hljs-number">0</span>&lt;c[<span class="hljs-number">7</span>]&gt;&gt;&gt;<span class="hljs-number">0</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>;for(r=<span class="hljs-number">0</span>;r&lt;<span class="hljs-number">8</span>;r++){<span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">i</span>=t<span class="hljs-selector-attr">[r]</span>+e<span class="hljs-selector-attr">[r]</span>,o=<span class="hljs-number">65535</span>&amp;<span class="hljs-selector-tag">i</span>,n=<span class="hljs-selector-tag">i</span>&gt;&gt;&gt;<span class="hljs-number">16</span>;<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[r]</span>=((o*o&gt;&gt;&gt;<span class="hljs-number">17</span>)+o*n&gt;&gt;&gt;<span class="hljs-number">15</span>)+n*n^((<span class="hljs-number">4294901760</span>&amp;<span class="hljs-selector-tag">i</span>)*<span class="hljs-selector-tag">i</span>|<span class="hljs-number">0</span>)+((<span class="hljs-number">65535</span>&amp;<span class="hljs-selector-tag">i</span>)*<span class="hljs-selector-tag">i</span>|<span class="hljs-number">0</span>)}t<span class="hljs-selector-attr">[0]</span>=<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[0]</span>+(<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[7]</span>&lt;&lt;<span class="hljs-number">16</span>|<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[7]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>)+(<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[6]</span>&lt;&lt;<span class="hljs-number">16</span>|<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[6]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>)|<span class="hljs-number">0</span>,t<span class="hljs-selector-attr">[1]</span>=<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[1]</span>+(<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[0]</span>&lt;&lt;<span class="hljs-number">8</span>|<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[0]</span>&gt;&gt;&gt;<span class="hljs-number">24</span>)+<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[7]</span>|<span class="hljs-number">0</span>,t<span class="hljs-selector-attr">[2]</span>=<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[2]</span>+(<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[1]</span>&lt;&lt;<span class="hljs-number">16</span>|<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[1]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>)+(<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[0]</span>&lt;&lt;<span class="hljs-number">16</span>|<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[0]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>)|<span class="hljs-number">0</span>,t<span class="hljs-selector-attr">[3]</span>=<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[3]</span>+(<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[2]</span>&lt;&lt;<span class="hljs-number">8</span>|<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[2]</span>&gt;&gt;&gt;<span class="hljs-number">24</span>)+<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[1]</span>|<span class="hljs-number">0</span>,t<span class="hljs-selector-attr">[4]</span>=<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[4]</span>+(<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[3]</span>&lt;&lt;<span class="hljs-number">16</span>|<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[3]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>)+(<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[2]</span>&lt;&lt;<span class="hljs-number">16</span>|<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[2]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>)|<span class="hljs-number">0</span>,t<span class="hljs-selector-attr">[5]</span>=<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[5]</span>+(<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[4]</span>&lt;&lt;<span class="hljs-number">8</span>|<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[4]</span>&gt;&gt;&gt;<span class="hljs-number">24</span>)+<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[3]</span>|<span class="hljs-number">0</span>,t<span class="hljs-selector-attr">[6]</span>=<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[6]</span>+(<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[5]</span>&lt;&lt;<span class="hljs-number">16</span>|<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[5]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>)+(<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[4]</span>&lt;&lt;<span class="hljs-number">16</span>|<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[4]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>)|<span class="hljs-number">0</span>,t<span class="hljs-selector-attr">[7]</span>=<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[7]</span>+(<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[6]</span>&lt;&lt;<span class="hljs-number">8</span>|<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[6]</span>&gt;&gt;&gt;<span class="hljs-number">24</span>)+<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[5]</span>|<span class="hljs-number">0</span>}function z2(){for(<span class="hljs-selector-tag">var</span> t=this._X,e=this._C,r=<span class="hljs-number">0</span>;r&lt;<span class="hljs-number">8</span>;r++)f<span class="hljs-selector-attr">[r]</span>=e<span class="hljs-selector-attr">[r]</span>;e<span class="hljs-selector-attr">[0]</span>=e<span class="hljs-selector-attr">[0]</span>+<span class="hljs-number">1295307597</span>+this._b|<span class="hljs-number">0</span>,e<span class="hljs-selector-attr">[1]</span>=e<span class="hljs-selector-attr">[1]</span>+<span class="hljs-number">3545052371</span>+(e<span class="hljs-selector-attr">[0]</span>&gt;&gt;&gt;<span class="hljs-number">0</span>&lt;f<span class="hljs-selector-attr">[0]</span>&gt;&gt;&gt;<span class="hljs-number">0</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>)|<span class="hljs-number">0</span>,e[<span class="hljs-number">2</span>]=e[<span class="hljs-number">2</span>]+<span class="hljs-number">886263092</span>+(e[<span class="hljs-number">1</span>]&gt;&gt;&gt;<span class="hljs-number">0</span>&lt;f[<span class="hljs-number">1</span>]&gt;&gt;&gt;<span class="hljs-number">0</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>)|<span class="hljs-number">0</span>,e[<span class="hljs-number">3</span>]=e[<span class="hljs-number">3</span>]+<span class="hljs-number">1295307597</span>+(e[<span class="hljs-number">2</span>]&gt;&gt;&gt;<span class="hljs-number">0</span>&lt;f[<span class="hljs-number">2</span>]&gt;&gt;&gt;<span class="hljs-number">0</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>)|<span class="hljs-number">0</span>,e[<span class="hljs-number">4</span>]=e[<span class="hljs-number">4</span>]+<span class="hljs-number">3545052371</span>+(e[<span class="hljs-number">3</span>]&gt;&gt;&gt;<span class="hljs-number">0</span>&lt;f[<span class="hljs-number">3</span>]&gt;&gt;&gt;<span class="hljs-number">0</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>)|<span class="hljs-number">0</span>,e[<span class="hljs-number">5</span>]=e[<span class="hljs-number">5</span>]+<span class="hljs-number">886263092</span>+(e[<span class="hljs-number">4</span>]&gt;&gt;&gt;<span class="hljs-number">0</span>&lt;f[<span class="hljs-number">4</span>]&gt;&gt;&gt;<span class="hljs-number">0</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>)|<span class="hljs-number">0</span>,e[<span class="hljs-number">6</span>]=e[<span class="hljs-number">6</span>]+<span class="hljs-number">1295307597</span>+(e[<span class="hljs-number">5</span>]&gt;&gt;&gt;<span class="hljs-number">0</span>&lt;f[<span class="hljs-number">5</span>]&gt;&gt;&gt;<span class="hljs-number">0</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>)|<span class="hljs-number">0</span>,e[<span class="hljs-number">7</span>]=e[<span class="hljs-number">7</span>]+<span class="hljs-number">3545052371</span>+(e[<span class="hljs-number">6</span>]&gt;&gt;&gt;<span class="hljs-number">0</span>&lt;f[<span class="hljs-number">6</span>]&gt;&gt;&gt;<span class="hljs-number">0</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>)|<span class="hljs-number">0</span>,this._b=e[<span class="hljs-number">7</span>]&gt;&gt;&gt;<span class="hljs-number">0</span>&lt;f[<span class="hljs-number">7</span>]&gt;&gt;&gt;<span class="hljs-number">0</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>;for(r=<span class="hljs-number">0</span>;r&lt;<span class="hljs-number">8</span>;r++){<span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">i</span>=t<span class="hljs-selector-attr">[r]</span>+e<span class="hljs-selector-attr">[r]</span>,o=<span class="hljs-number">65535</span>&amp;<span class="hljs-selector-tag">i</span>,n=<span class="hljs-selector-tag">i</span>&gt;&gt;&gt;<span class="hljs-number">16</span>;d<span class="hljs-selector-attr">[r]</span>=((o*o&gt;&gt;&gt;<span class="hljs-number">17</span>)+o*n&gt;&gt;&gt;<span class="hljs-number">15</span>)+n*n^((<span class="hljs-number">4294901760</span>&amp;<span class="hljs-selector-tag">i</span>)*<span class="hljs-selector-tag">i</span>|<span class="hljs-number">0</span>)+((<span class="hljs-number">65535</span>&amp;<span class="hljs-selector-tag">i</span>)*<span class="hljs-selector-tag">i</span>|<span class="hljs-number">0</span>)}t<span class="hljs-selector-attr">[0]</span>=d<span class="hljs-selector-attr">[0]</span>+(d<span class="hljs-selector-attr">[7]</span>&lt;&lt;<span class="hljs-number">16</span>|d<span class="hljs-selector-attr">[7]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>)+(d<span class="hljs-selector-attr">[6]</span>&lt;&lt;<span class="hljs-number">16</span>|d<span class="hljs-selector-attr">[6]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>)|<span class="hljs-number">0</span>,t<span class="hljs-selector-attr">[1]</span>=d<span class="hljs-selector-attr">[1]</span>+(d<span class="hljs-selector-attr">[0]</span>&lt;&lt;<span class="hljs-number">8</span>|d<span class="hljs-selector-attr">[0]</span>&gt;&gt;&gt;<span class="hljs-number">24</span>)+d<span class="hljs-selector-attr">[7]</span>|<span class="hljs-number">0</span>,t<span class="hljs-selector-attr">[2]</span>=d<span class="hljs-selector-attr">[2]</span>+(d<span class="hljs-selector-attr">[1]</span>&lt;&lt;<span class="hljs-number">16</span>|d<span class="hljs-selector-attr">[1]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>)+(d<span class="hljs-selector-attr">[0]</span>&lt;&lt;<span class="hljs-number">16</span>|d<span class="hljs-selector-attr">[0]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>)|<span class="hljs-number">0</span>,t<span class="hljs-selector-attr">[3]</span>=d<span class="hljs-selector-attr">[3]</span>+(d<span class="hljs-selector-attr">[2]</span>&lt;&lt;<span class="hljs-number">8</span>|d<span class="hljs-selector-attr">[2]</span>&gt;&gt;&gt;<span class="hljs-number">24</span>)+d<span class="hljs-selector-attr">[1]</span>|<span class="hljs-number">0</span>,t<span class="hljs-selector-attr">[4]</span>=d<span class="hljs-selector-attr">[4]</span>+(d<span class="hljs-selector-attr">[3]</span>&lt;&lt;<span class="hljs-number">16</span>|d<span class="hljs-selector-attr">[3]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>)+(d<span class="hljs-selector-attr">[2]</span>&lt;&lt;<span class="hljs-number">16</span>|d<span class="hljs-selector-attr">[2]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>)|<span class="hljs-number">0</span>,t<span class="hljs-selector-attr">[5]</span>=d<span class="hljs-selector-attr">[5]</span>+(d<span class="hljs-selector-attr">[4]</span>&lt;&lt;<span class="hljs-number">8</span>|d<span class="hljs-selector-attr">[4]</span>&gt;&gt;&gt;<span class="hljs-number">24</span>)+d<span class="hljs-selector-attr">[3]</span>|<span class="hljs-number">0</span>,t<span class="hljs-selector-attr">[6]</span>=d<span class="hljs-selector-attr">[6]</span>+(d<span class="hljs-selector-attr">[5]</span>&lt;&lt;<span class="hljs-number">16</span>|d<span class="hljs-selector-attr">[5]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>)+(d<span class="hljs-selector-attr">[4]</span>&lt;&lt;<span class="hljs-number">16</span>|d<span class="hljs-selector-attr">[4]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>)|<span class="hljs-number">0</span>,t<span class="hljs-selector-attr">[7]</span>=d<span class="hljs-selector-attr">[7]</span>+(d<span class="hljs-selector-attr">[6]</span>&lt;&lt;<span class="hljs-number">8</span>|d<span class="hljs-selector-attr">[6]</span>&gt;&gt;&gt;<span class="hljs-number">24</span>)+d<span class="hljs-selector-attr">[5]</span>|<span class="hljs-number">0</span>}u<span class="hljs-selector-class">.RC4</span>=<span class="hljs-selector-tag">P</span>._createHelper(m2),w=w<span class="hljs-selector-class">.RC4Drop</span>=m2<span class="hljs-selector-class">.extend</span>({cfg:m2.cfg.<span class="hljs-built_in">extend</span>({drop:<span class="hljs-number">192</span>}),_doReset:<span class="hljs-built_in">function</span>(){m2._doReset<span class="hljs-selector-class">.call</span>(this);for(<span class="hljs-selector-tag">var</span> t=this<span class="hljs-selector-class">.cfg</span><span class="hljs-selector-class">.drop</span>;<span class="hljs-number">0</span>&lt;t;t--)S2<span class="hljs-selector-class">.call</span>(this)}}),u<span class="hljs-selector-class">.RC4Drop</span>=<span class="hljs-selector-tag">P</span>._createHelper(w),u=(<span class="hljs-selector-tag">p</span>=<span class="hljs-selector-tag">i</span>)<span class="hljs-selector-class">.lib</span><span class="hljs-selector-class">.StreamCipher</span>,<span class="hljs-selector-tag">P</span>=<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.algo</span>,n=<span class="hljs-selector-attr">[]</span>,c=<span class="hljs-selector-attr">[]</span>,<span class="hljs-selector-tag">a</span>=<span class="hljs-selector-attr">[]</span>,<span class="hljs-selector-tag">P</span>=<span class="hljs-selector-tag">P</span><span class="hljs-selector-class">.Rabbit</span>=u<span class="hljs-selector-class">.extend</span>({_doReset:<span class="hljs-built_in">function</span>(){for(<span class="hljs-selector-tag">var</span> t=this._key<span class="hljs-selector-class">.words</span>,e=this<span class="hljs-selector-class">.cfg</span><span class="hljs-selector-class">.iv</span>,r=<span class="hljs-number">0</span>;r&lt;<span class="hljs-number">4</span>;r++)t<span class="hljs-selector-attr">[r]</span>=<span class="hljs-number">16711935</span>&amp;(t<span class="hljs-selector-attr">[r]</span>&lt;&lt;<span class="hljs-number">8</span>|t<span class="hljs-selector-attr">[r]</span>&gt;&gt;&gt;<span class="hljs-number">24</span>)|<span class="hljs-number">4278255360</span>&amp;(t<span class="hljs-selector-attr">[r]</span>&lt;&lt;<span class="hljs-number">24</span>|t<span class="hljs-selector-attr">[r]</span>&gt;&gt;&gt;<span class="hljs-number">8</span>);for(<span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">i</span>=this._X=<span class="hljs-selector-attr">[t[0]</span>,t<span class="hljs-selector-attr">[3]</span>&lt;&lt;<span class="hljs-number">16</span>|t<span class="hljs-selector-attr">[2]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>,t<span class="hljs-selector-attr">[1]</span>,t<span class="hljs-selector-attr">[0]</span>&lt;&lt;<span class="hljs-number">16</span>|t<span class="hljs-selector-attr">[3]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>,t<span class="hljs-selector-attr">[2]</span>,t<span class="hljs-selector-attr">[1]</span>&lt;&lt;<span class="hljs-number">16</span>|t<span class="hljs-selector-attr">[0]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>,t<span class="hljs-selector-attr">[3]</span>,t<span class="hljs-selector-attr">[2]</span>&lt;&lt;<span class="hljs-number">16</span>|t<span class="hljs-selector-attr">[1]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>],o=this._C=<span class="hljs-selector-attr">[t[2]</span>&lt;&lt;<span class="hljs-number">16</span>|t<span class="hljs-selector-attr">[2]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>,<span class="hljs-number">4294901760</span>&amp;t<span class="hljs-selector-attr">[0]</span>|<span class="hljs-number">65535</span>&amp;t<span class="hljs-selector-attr">[1]</span>,t<span class="hljs-selector-attr">[3]</span>&lt;&lt;<span class="hljs-number">16</span>|t<span class="hljs-selector-attr">[3]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>,<span class="hljs-number">4294901760</span>&amp;t<span class="hljs-selector-attr">[1]</span>|<span class="hljs-number">65535</span>&amp;t<span class="hljs-selector-attr">[2]</span>,t<span class="hljs-selector-attr">[0]</span>&lt;&lt;<span class="hljs-number">16</span>|t<span class="hljs-selector-attr">[0]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>,<span class="hljs-number">4294901760</span>&amp;t<span class="hljs-selector-attr">[2]</span>|<span class="hljs-number">65535</span>&amp;t<span class="hljs-selector-attr">[3]</span>,t<span class="hljs-selector-attr">[1]</span>&lt;&lt;<span class="hljs-number">16</span>|t<span class="hljs-selector-attr">[1]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>,<span class="hljs-number">4294901760</span>&amp;t<span class="hljs-selector-attr">[3]</span>|<span class="hljs-number">65535</span>&amp;t<span class="hljs-selector-attr">[0]</span>],r=this._b=<span class="hljs-number">0</span>;r&lt;<span class="hljs-number">4</span>;r++)A2<span class="hljs-selector-class">.call</span>(this);for(r=<span class="hljs-number">0</span>;r&lt;<span class="hljs-number">8</span>;r++)o<span class="hljs-selector-attr">[r]</span>^=<span class="hljs-selector-tag">i</span><span class="hljs-selector-attr">[r+4&amp;7]</span>;if(e){<span class="hljs-selector-tag">var</span> e=e<span class="hljs-selector-class">.words</span>,n=e<span class="hljs-selector-attr">[0]</span>,e=e<span class="hljs-selector-attr">[1]</span>,n=<span class="hljs-number">16711935</span>&amp;(n&lt;&lt;<span class="hljs-number">8</span>|n&gt;&gt;&gt;<span class="hljs-number">24</span>)|<span class="hljs-number">4278255360</span>&amp;(n&lt;&lt;<span class="hljs-number">24</span>|n&gt;&gt;&gt;<span class="hljs-number">8</span>),e=<span class="hljs-number">16711935</span>&amp;(e&lt;&lt;<span class="hljs-number">8</span>|e&gt;&gt;&gt;<span class="hljs-number">24</span>)|<span class="hljs-number">4278255360</span>&amp;(e&lt;&lt;<span class="hljs-number">24</span>|e&gt;&gt;&gt;<span class="hljs-number">8</span>),s=n&gt;&gt;&gt;<span class="hljs-number">16</span>|<span class="hljs-number">4294901760</span>&amp;e,c=e&lt;&lt;<span class="hljs-number">16</span>|<span class="hljs-number">65535</span>&amp;n;o<span class="hljs-selector-attr">[0]</span>^=n,o<span class="hljs-selector-attr">[1]</span>^=s,o<span class="hljs-selector-attr">[2]</span>^=e,o<span class="hljs-selector-attr">[3]</span>^=c,o<span class="hljs-selector-attr">[4]</span>^=n,o<span class="hljs-selector-attr">[5]</span>^=s,o<span class="hljs-selector-attr">[6]</span>^=e,o<span class="hljs-selector-attr">[7]</span>^=c;for(r=<span class="hljs-number">0</span>;r&lt;<span class="hljs-number">4</span>;r++)A2<span class="hljs-selector-class">.call</span>(this)}},_doProcessBlock:<span class="hljs-built_in">function</span>(t,e){<span class="hljs-selector-tag">var</span> r=this._X;A2<span class="hljs-selector-class">.call</span>(this),n<span class="hljs-selector-attr">[0]</span>=r<span class="hljs-selector-attr">[0]</span>^r<span class="hljs-selector-attr">[5]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>^r<span class="hljs-selector-attr">[3]</span>&lt;&lt;<span class="hljs-number">16</span>,n<span class="hljs-selector-attr">[1]</span>=r<span class="hljs-selector-attr">[2]</span>^r<span class="hljs-selector-attr">[7]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>^r<span class="hljs-selector-attr">[5]</span>&lt;&lt;<span class="hljs-number">16</span>,n<span class="hljs-selector-attr">[2]</span>=r<span class="hljs-selector-attr">[4]</span>^r<span class="hljs-selector-attr">[1]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>^r<span class="hljs-selector-attr">[7]</span>&lt;&lt;<span class="hljs-number">16</span>,n<span class="hljs-selector-attr">[3]</span>=r<span class="hljs-selector-attr">[6]</span>^r<span class="hljs-selector-attr">[3]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>^r<span class="hljs-selector-attr">[1]</span>&lt;&lt;<span class="hljs-number">16</span>;for(<span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">i</span>=<span class="hljs-number">0</span>;<span class="hljs-selector-tag">i</span>&lt;<span class="hljs-number">4</span>;<span class="hljs-selector-tag">i</span>++)n<span class="hljs-selector-attr">[i]</span>=<span class="hljs-number">16711935</span>&amp;(n<span class="hljs-selector-attr">[i]</span>&lt;&lt;<span class="hljs-number">8</span>|n<span class="hljs-selector-attr">[i]</span>&gt;&gt;&gt;<span class="hljs-number">24</span>)|<span class="hljs-number">4278255360</span>&amp;(n<span class="hljs-selector-attr">[i]</span>&lt;&lt;<span class="hljs-number">24</span>|n<span class="hljs-selector-attr">[i]</span>&gt;&gt;&gt;<span class="hljs-number">8</span>),t<span class="hljs-selector-attr">[e+i]</span>^=n<span class="hljs-selector-attr">[i]</span>},blockSize:<span class="hljs-number">4</span>,ivSize:<span class="hljs-number">2</span>}),<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.Rabbit</span>=u._createHelper(<span class="hljs-selector-tag">P</span>),<span class="hljs-selector-tag">p</span>=(w=<span class="hljs-selector-tag">i</span>)<span class="hljs-selector-class">.lib</span><span class="hljs-selector-class">.StreamCipher</span>,u=w<span class="hljs-selector-class">.algo</span>,h=<span class="hljs-selector-attr">[]</span>,f=<span class="hljs-selector-attr">[]</span>,d=<span class="hljs-selector-attr">[]</span>,u=u<span class="hljs-selector-class">.RabbitLegacy</span>=<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.extend</span>({_doReset:<span class="hljs-built_in">function</span>(){for(<span class="hljs-selector-tag">var</span> t=this._key<span class="hljs-selector-class">.words</span>,e=this<span class="hljs-selector-class">.cfg</span><span class="hljs-selector-class">.iv</span>,r=this._X=<span class="hljs-selector-attr">[t[0]</span>,t<span class="hljs-selector-attr">[3]</span>&lt;&lt;<span class="hljs-number">16</span>|t<span class="hljs-selector-attr">[2]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>,t<span class="hljs-selector-attr">[1]</span>,t<span class="hljs-selector-attr">[0]</span>&lt;&lt;<span class="hljs-number">16</span>|t<span class="hljs-selector-attr">[3]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>,t<span class="hljs-selector-attr">[2]</span>,t<span class="hljs-selector-attr">[1]</span>&lt;&lt;<span class="hljs-number">16</span>|t<span class="hljs-selector-attr">[0]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>,t<span class="hljs-selector-attr">[3]</span>,t<span class="hljs-selector-attr">[2]</span>&lt;&lt;<span class="hljs-number">16</span>|t<span class="hljs-selector-attr">[1]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>],<span class="hljs-selector-tag">i</span>=this._C=<span class="hljs-selector-attr">[t[2]</span>&lt;&lt;<span class="hljs-number">16</span>|t<span class="hljs-selector-attr">[2]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>,<span class="hljs-number">4294901760</span>&amp;t<span class="hljs-selector-attr">[0]</span>|<span class="hljs-number">65535</span>&amp;t<span class="hljs-selector-attr">[1]</span>,t<span class="hljs-selector-attr">[3]</span>&lt;&lt;<span class="hljs-number">16</span>|t<span class="hljs-selector-attr">[3]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>,<span class="hljs-number">4294901760</span>&amp;t<span class="hljs-selector-attr">[1]</span>|<span class="hljs-number">65535</span>&amp;t<span class="hljs-selector-attr">[2]</span>,t<span class="hljs-selector-attr">[0]</span>&lt;&lt;<span class="hljs-number">16</span>|t<span class="hljs-selector-attr">[0]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>,<span class="hljs-number">4294901760</span>&amp;t<span class="hljs-selector-attr">[2]</span>|<span class="hljs-number">65535</span>&amp;t<span class="hljs-selector-attr">[3]</span>,t<span class="hljs-selector-attr">[1]</span>&lt;&lt;<span class="hljs-number">16</span>|t<span class="hljs-selector-attr">[1]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>,<span class="hljs-number">4294901760</span>&amp;t<span class="hljs-selector-attr">[3]</span>|<span class="hljs-number">65535</span>&amp;t<span class="hljs-selector-attr">[0]</span>],o=this._b=<span class="hljs-number">0</span>;o&lt;<span class="hljs-number">4</span>;o++)z2<span class="hljs-selector-class">.call</span>(this);for(o=<span class="hljs-number">0</span>;o&lt;<span class="hljs-number">8</span>;o++)<span class="hljs-selector-tag">i</span><span class="hljs-selector-attr">[o]</span>^=r<span class="hljs-selector-attr">[o+4&amp;7]</span>;if(e){<span class="hljs-selector-tag">var</span> t=e<span class="hljs-selector-class">.words</span>,e=t<span class="hljs-selector-attr">[0]</span>,t=t<span class="hljs-selector-attr">[1]</span>,e=<span class="hljs-number">16711935</span>&amp;(e&lt;&lt;<span class="hljs-number">8</span>|e&gt;&gt;&gt;<span class="hljs-number">24</span>)|<span class="hljs-number">4278255360</span>&amp;(e&lt;&lt;<span class="hljs-number">24</span>|e&gt;&gt;&gt;<span class="hljs-number">8</span>),t=<span class="hljs-number">16711935</span>&amp;(t&lt;&lt;<span class="hljs-number">8</span>|t&gt;&gt;&gt;<span class="hljs-number">24</span>)|<span class="hljs-number">4278255360</span>&amp;(t&lt;&lt;<span class="hljs-number">24</span>|t&gt;&gt;&gt;<span class="hljs-number">8</span>),n=e&gt;&gt;&gt;<span class="hljs-number">16</span>|<span class="hljs-number">4294901760</span>&amp;t,s=t&lt;&lt;<span class="hljs-number">16</span>|<span class="hljs-number">65535</span>&amp;e;<span class="hljs-selector-tag">i</span><span class="hljs-selector-attr">[0]</span>^=e,<span class="hljs-selector-tag">i</span><span class="hljs-selector-attr">[1]</span>^=n,<span class="hljs-selector-tag">i</span><span class="hljs-selector-attr">[2]</span>^=t,<span class="hljs-selector-tag">i</span><span class="hljs-selector-attr">[3]</span>^=s,<span class="hljs-selector-tag">i</span><span class="hljs-selector-attr">[4]</span>^=e,<span class="hljs-selector-tag">i</span><span class="hljs-selector-attr">[5]</span>^=n,<span class="hljs-selector-tag">i</span><span class="hljs-selector-attr">[6]</span>^=t,<span class="hljs-selector-tag">i</span><span class="hljs-selector-attr">[7]</span>^=s;for(o=<span class="hljs-number">0</span>;o&lt;<span class="hljs-number">4</span>;o++)z2<span class="hljs-selector-class">.call</span>(this)}},_doProcessBlock:<span class="hljs-built_in">function</span>(t,e){<span class="hljs-selector-tag">var</span> r=this._X;z2<span class="hljs-selector-class">.call</span>(this),h<span class="hljs-selector-attr">[0]</span>=r<span class="hljs-selector-attr">[0]</span>^r<span class="hljs-selector-attr">[5]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>^r<span class="hljs-selector-attr">[3]</span>&lt;&lt;<span class="hljs-number">16</span>,h<span class="hljs-selector-attr">[1]</span>=r<span class="hljs-selector-attr">[2]</span>^r<span class="hljs-selector-attr">[7]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>^r<span class="hljs-selector-attr">[5]</span>&lt;&lt;<span class="hljs-number">16</span>,h<span class="hljs-selector-attr">[2]</span>=r<span class="hljs-selector-attr">[4]</span>^r<span class="hljs-selector-attr">[1]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>^r<span class="hljs-selector-attr">[7]</span>&lt;&lt;<span class="hljs-number">16</span>,h<span class="hljs-selector-attr">[3]</span>=r<span class="hljs-selector-attr">[6]</span>^r<span class="hljs-selector-attr">[3]</span>&gt;&gt;&gt;<span class="hljs-number">16</span>^r<span class="hljs-selector-attr">[1]</span>&lt;&lt;<span class="hljs-number">16</span>;for(<span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">i</span>=<span class="hljs-number">0</span>;<span class="hljs-selector-tag">i</span>&lt;<span class="hljs-number">4</span>;<span class="hljs-selector-tag">i</span>++)h<span class="hljs-selector-attr">[i]</span>=<span class="hljs-number">16711935</span>&amp;(h<span class="hljs-selector-attr">[i]</span>&lt;&lt;<span class="hljs-number">8</span>|h<span class="hljs-selector-attr">[i]</span>&gt;&gt;&gt;<span class="hljs-number">24</span>)|<span class="hljs-number">4278255360</span>&amp;(h<span class="hljs-selector-attr">[i]</span>&lt;&lt;<span class="hljs-number">24</span>|h<span class="hljs-selector-attr">[i]</span>&gt;&gt;&gt;<span class="hljs-number">8</span>),t<span class="hljs-selector-attr">[e+i]</span>^=h<span class="hljs-selector-attr">[i]</span>},blockSize:<span class="hljs-number">4</span>,ivSize:<span class="hljs-number">2</span>}),w<span class="hljs-selector-class">.RabbitLegacy</span>=<span class="hljs-selector-tag">p</span>._createHelper(u);{w=(<span class="hljs-selector-tag">P</span>=<span class="hljs-selector-tag">i</span>)<span class="hljs-selector-class">.lib</span><span class="hljs-selector-class">.BlockCipher</span>,<span class="hljs-selector-tag">p</span>=<span class="hljs-selector-tag">P</span><span class="hljs-selector-class">.algo</span>;const F=<span class="hljs-number">16</span>,D2=<span class="hljs-selector-attr">[608135816,2242054355,320440878,57701188,2752067618,698298832,137296536,3964562569,1160258022,953160567,3193202383,887688300,3232508343,3380367581,1065670069,3041331479,2450970073,2306472731]</span>,E2=<span class="hljs-selector-attr">[[3509652390,2564797868,805139163,3491422135,3101798381,1780907670,3128725573,4046225305,614570311,3012652279,134345442,2240740374,1667834072,1901547113,2757295779,4103290238,227898511,1921955416,1904987480,2182433518,2069144605,3260701109,2620446009,720527379,3318853667,677414384,3393288472,3101374703,2390351024,1614419982,1822297739,2954791486,3608508353,3174124327,2024746970,1432378464,3864339955,2857741204,1464375394,1676153920,1439316330,715854006,3033291828,289532110,2706671279,2087905683,3018724369,1668267050,732546397,1947742710,3462151702,2609353502,2950085171,1814351708,2050118529,680887927,999245976,1800124847,3300911131,1713906067,1641548236,4213287313,1216130144,1575780402,4018429277,3917837745,3693486850,3949271944,596196993,3549867205,258830323,2213823033,772490370,2760122372,1774776394,2652871518,566650946,4142492826,1728879713,2882767088,1783734482,3629395816,2517608232,2874225571,1861159788,326777828,3124490320,2130389656,2716951837,967770486,1724537150,2185432712,2364442137,1164943284,2105845187,998989502,3765401048,2244026483,1075463327,1455516326,1322494562,910128902,469688178,1117454909,936433444,3490320968,3675253459,1240580251,122909385,2157517691,634681816,4142456567,3825094682,3061402683,2540495037,79693498,3249098678,1084186820,1583128258,426386531,1761308591,1047286709,322548459,995290223,1845252383,2603652396,3431023940,2942221577,3202600964,3727903485,1712269319,422464435,3234572375,1170764815,3523960633,3117677531,1434042557,442511882,3600875718,1076654713,1738483198,4213154764,2393238008,3677496056,1014306527,4251020053,793779912,2902807211,842905082,4246964064,1395751752,1040244610,2656851899,3396308128,445077038,3742853595,3577915638,679411651,2892444358,2354009459,1767581616,3150600392,3791627101,3102740896,284835224,4246832056,1258075500,768725851,2589189241,3069724005,3532540348,1274779536,3789419226,2764799539,1660621633,3471099624,4011903706,913787905,3497959166,737222580,2514213453,2928710040,3937242737,1804850592,3499020752,2949064160,2386320175,2390070455,2415321851,4061277028,2290661394,2416832540,1336762016,1754252060,3520065937,3014181293,791618072,3188594551,3933548030,2332172193,3852520463,3043980520,413987798,3465142937,3030929376,4245938359,2093235073,3534596313,375366246,2157278981,2479649556,555357303,3870105701,2008414854,3344188149,4221384143,3956125452,2067696032,3594591187,2921233993,2428461,544322398,577241275,1471733935,610547355,4027169054,1432588573,1507829418,2025931657,3646575487,545086370,48609733,2200306550,1653985193,298326376,1316178497,3007786442,2064951626,458293330,2589141269,3591329599,3164325604,727753846,2179363840,146436021,1461446943,4069977195,705550613,3059967265,3887724982,4281599278,3313849956,1404054877,2845806497,146425753,1854211946]</span>,<span class="hljs-selector-attr">[1266315497,3048417604,3681880366,3289982499,290971e4,1235738493,2632868024,2414719590,3970600049,1771706367,1449415276,3266420449,422970021,1963543593,2690192192,3826793022,1062508698,1531092325,1804592342,2583117782,2714934279,4024971509,1294809318,4028980673,1289560198,2221992742,1669523910,35572830,157838143,1052438473,1016535060,1802137761,1753167236,1386275462,3080475397,2857371447,1040679964,2145300060,2390574316,1461121720,2956646967,4031777805,4028374788,33600511,2920084762,1018524850,629373528,3691585981,3515945977,2091462646,2486323059,586499841,988145025,935516892,3367335476,2599673255,2839830854,265290510,3972581182,2759138881,3795373465,1005194799,847297441,406762289,1314163512,1332590856,1866599683,4127851711,750260880,613907577,1450815602,3165620655,3734664991,3650291728,3012275730,3704569646,1427272223,778793252,1343938022,2676280711,2052605720,1946737175,3164576444,3914038668,3967478842,3682934266,1661551462,3294938066,4011595847,840292616,3712170807,616741398,312560963,711312465,1351876610,322626781,1910503582,271666773,2175563734,1594956187,70604529,3617834859,1007753275,1495573769,4069517037,2549218298,2663038764,504708206,2263041392,3941167025,2249088522,1514023603,1998579484,1312622330,694541497,2582060303,2151582166,1382467621,776784248,2618340202,3323268794,2497899128,2784771155,503983604,4076293799,907881277,423175695,432175456,1378068232,4145222326,3954048622,3938656102,3820766613,2793130115,2977904593,26017576,3274890735,3194772133,1700274565,1756076034,4006520079,3677328699,720338349,1533947780,354530856,688349552,3973924725,1637815568,332179504,3949051286,53804574,2852348879,3044236432,1282449977,3583942155,3416972820,4006381244,1617046695,2628476075,3002303598,1686838959,431878346,2686675385,1700445008,1080580658,1009431731,832498133,3223435511,2605976345,2271191193,2516031870,1648197032,4164389018,2548247927,300782431,375919233,238389289,3353747414,2531188641,2019080857,1475708069,455242339,2609103871,448939670,3451063019,1395535956,2413381860,1841049896,1491858159,885456874,4264095073,4001119347,1565136089,3898914787,1108368660,540939232,1173283510,2745871338,3681308437,4207628240,3343053890,4016749493,1699691293,1103962373,3625875870,2256883143,3830138730,1031889488,3479347698,1535977030,4236805024,3251091107,2132092099,1774941330,1199868427,1452454533,157007616,2904115357,342012276,595725824,1480756522,206960106,497939518,591360097,863170706,2375253569,3596610801,1814182875,2094937945,3421402208,1082520231,3463918190,2785509508,435703966,3908032597,1641649973,2842273706,3305899714,1510255612,2148256476,2655287854,3276092548,4258621189,236887753,3681803219,274041037,1734335097,3815195456,3317970021,1899903192,1026095262,4050517792,356393447,2410691914,3873677099,3682840055]</span>,<span class="hljs-selector-attr">[3913112168,2491498743,4132185628,2489919796,1091903735,1979897079,3170134830,3567386728,3557303409,857797738,1136121015,1342202287,507115054,2535736646,337727348,3213592640,1301675037,2528481711,1895095763,1721773893,3216771564,62756741,2142006736,835421444,2531993523,1442658625,3659876326,2882144922,676362277,1392781812,170690266,3921047035,1759253602,3611846912,1745797284,664899054,1329594018,3901205900,3045908486,2062866102,2865634940,3543621612,3464012697,1080764994,553557557,3656615353,3996768171,991055499,499776247,1265440854,648242737,3940784050,980351604,3713745714,1749149687,3396870395,4211799374,3640570775,1161844396,3125318951,1431517754,545492359,4268468663,3499529547,1437099964,2702547544,3433638243,2581715763,2787789398,1060185593,1593081372,2418618748,4260947970,69676912,2159744348,86519011,2512459080,3838209314,1220612927,3339683548,133810670,1090789135,1078426020,1569222167,845107691,3583754449,4072456591,1091646820,628848692,1613405280,3757631651,526609435,236106946,48312990,2942717905,3402727701,1797494240,859738849,992217954,4005476642,2243076622,3870952857,3732016268,765654824,3490871365,2511836413,1685915746,3888969200,1414112111,2273134842,3281911079,4080962846,172450625,2569994100,980381355,4109958455,2819808352,2716589560,2568741196,3681446669,3329971472,1835478071,660984891,3704678404,4045999559,3422617507,3040415634,1762651403,1719377915,3470491036,2693910283,3642056355,3138596744,1364962596,2073328063,1983633131,926494387,3423689081,2150032023,4096667949,1749200295,3328846651,309677260,2016342300,1779581495,3079819751,111262694,1274766160,443224088,298511866,1025883608,3806446537,1145181785,168956806,3641502830,3584813610,1689216846,3666258015,3200248200,1692713982,2646376535,4042768518,1618508792,1610833997,3523052358,4130873264,2001055236,3610705100,2202168115,4028541809,2961195399,1006657119,2006996926,3186142756,1430667929,3210227297,1314452623,4074634658,4101304120,2273951170,1399257539,3367210612,3027628629,1190975929,2062231137,2333990788,2221543033,2438960610,1181637006,548689776,2362791313,3372408396,3104550113,3145860560,296247880,1970579870,3078560182,3769228297,1714227617,3291629107,3898220290,166772364,1251581989,493813264,448347421,195405023,2709975567,677966185,3703036547,1463355134,2715995803,1338867538,1343315457,2802222074,2684532164,233230375,2599980071,2000651841,3277868038,1638401717,4028070440,3237316320,6314154,819756386,300326615,590932579,1405279636,3267499572,3150704214,2428286686,3959192993,3461946742,1862657033,1266418056,963775037,2089974820,2263052895,1917689273,448879540,3550394620,3981727096,150775221,3627908307,1303187396,508620638,2975983352,2726630617,1817252668,1876281319,1457606340,908771278,3720792119,3617206836,2455994898,1729034894,1080033504]</span>,<span class="hljs-selector-attr">[976866871,3556439503,2881648439,1522871579,1555064734,1336096578,3548522304,2579274686,3574697629,3205460757,3593280638,3338716283,3079412587,564236357,2993598910,1781952180,1464380207,3163844217,3332601554,1699332808,1393555694,1183702653,3581086237,1288719814,691649499,2847557200,2895455976,3193889540,2717570544,1781354906,1676643554,2592534050,3230253752,1126444790,2770207658,2633158820,2210423226,2615765581,2414155088,3127139286,673620729,2805611233,1269405062,4015350505,3341807571,4149409754,1057255273,2012875353,2162469141,2276492801,2601117357,993977747,3918593370,2654263191,753973209,36408145,2530585658,25011837,3520020182,2088578344,530523599,2918365339,1524020338,1518925132,3760827505,3759777254,1202760957,3985898139,3906192525,674977740,4174734889,2031300136,2019492241,3983892565,4153806404,3822280332,352677332,2297720250,60907813,90501309,3286998549,1016092578,2535922412,2839152426,457141659,509813237,4120667899,652014361,1966332200,2975202805,55981186,2327461051,676427537,3255491064,2882294119,3433927263,1307055953,942726286,933058658,2468411793,3933900994,4215176142,1361170020,2001714738,2830558078,3274259782,1222529897,1679025792,2729314320,3714953764,1770335741,151462246,3013232138,1682292957,1483529935,471910574,1539241949,458788160,3436315007,1807016891,3718408830,978976581,1043663428,3165965781,1927990952,4200891579,2372276910,3208408903,3533431907,1412390302,2931980059,4132332400,1947078029,3881505623,4168226417,2941484381,1077988104,1320477388,886195818,18198404,3786409e3,2509781533,112762804,3463356488,1866414978,891333506,18488651,661792760,1628790961,3885187036,3141171499,876946877,2693282273,1372485963,791857591,2686433993,3759982718,3167212022,3472953795,2716379847,445679433,3561995674,3504004811,3574258232,54117162,3331405415,2381918588,3769707343,4154350007,1140177722,4074052095,668550556,3214352940,367459370,261225585,2610173221,4209349473,3468074219,3265815641,314222801,3066103646,3808782860,282218597,3406013506,3773591054,379116347,1285071038,846784868,2669647154,3771962079,3550491691,2305946142,453669953,1268987020,3317592352,3279303384,3744833421,2610507566,3859509063,266596637,3847019092,517658769,3462560207,3443424879,370717030,4247526661,2224018117,4143653529,4112773975,2788324899,2477274417,1456262402,2901442914,1517677493,1846949527,2295493580,3734397586,2176403920,1280348187,1908823572,3871786941,846861322,1172426758,3287448474,3383383037,1655181056,3139813346,901632758,1897031941,2986607138,3066810236,3447102507,1393639104,373351379,950779232,625454576,3124240540,4148612726,2007998917,544563296,2244738638,2330496472,2058025392,1291430526,424198748,50039436,29584100,3605783033,2429876329,2791104160,1057563949,3255363231,3075367218,3463963227,1469046755,985887462]</span>];<span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">H2</span>={pbox:[],sbox:[]};function C2(t,e){<span class="hljs-selector-tag">var</span> r=t<span class="hljs-selector-class">.sbox</span><span class="hljs-selector-attr">[0]</span><span class="hljs-selector-attr">[e&gt;&gt;24&amp;255]</span>+t<span class="hljs-selector-class">.sbox</span><span class="hljs-selector-attr">[1]</span><span class="hljs-selector-attr">[e&gt;&gt;16&amp;255]</span>;return r=(r^=t<span class="hljs-selector-class">.sbox</span><span class="hljs-selector-attr">[2]</span><span class="hljs-selector-attr">[e&gt;&gt;8&amp;255]</span>)+t<span class="hljs-selector-class">.sbox</span><span class="hljs-selector-attr">[3]</span><span class="hljs-selector-attr">[255&amp;e]</span>}function R2(e,t,r){let <span class="hljs-selector-tag">i</span>=t,o=r,n;for(let t=<span class="hljs-number">0</span>;t&lt;F;++t)<span class="hljs-selector-tag">i</span>^=e<span class="hljs-selector-class">.pbox</span><span class="hljs-selector-attr">[t]</span>,o=C2(e,<span class="hljs-selector-tag">i</span>)^o,n=<span class="hljs-selector-tag">i</span>,<span class="hljs-selector-tag">i</span>=o,o=n;return n=<span class="hljs-selector-tag">i</span>,<span class="hljs-selector-tag">i</span>=o,o=n,o^=e<span class="hljs-selector-class">.pbox</span><span class="hljs-selector-attr">[F]</span>,{<span class="hljs-attribute">left</span>:i^=e.pbox[F+<span class="hljs-number">1</span>],right:o}}<span class="hljs-selector-tag">p</span>=<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.Blowfish</span>=w<span class="hljs-selector-class">.extend</span>({_doReset:<span class="hljs-built_in">function</span>(){if(this._keyPriorReset!==this._key){<span class="hljs-selector-tag">var</span> t=this._keyPriorReset=this._key,n=t<span class="hljs-selector-class">.words</span>,t=t<span class="hljs-selector-class">.sigBytes</span>/<span class="hljs-number">4</span>;{<span class="hljs-selector-tag">var</span> s=<span class="hljs-selector-tag">H2</span>,c=n,<span class="hljs-selector-tag">a</span>=t;for(let e=<span class="hljs-number">0</span>;e&lt;<span class="hljs-number">4</span>;e++){s<span class="hljs-selector-class">.sbox</span><span class="hljs-selector-attr">[e]</span>=<span class="hljs-selector-attr">[]</span>;for(let t=<span class="hljs-number">0</span>;t&lt;<span class="hljs-number">256</span>;t++)s<span class="hljs-selector-class">.sbox</span><span class="hljs-selector-attr">[e]</span><span class="hljs-selector-attr">[t]</span>=E2<span class="hljs-selector-attr">[e]</span><span class="hljs-selector-attr">[t]</span>}let e=<span class="hljs-number">0</span>;for(let t=<span class="hljs-number">0</span>;t&lt;F+<span class="hljs-number">2</span>;t++)s<span class="hljs-selector-class">.pbox</span><span class="hljs-selector-attr">[t]</span>=D2<span class="hljs-selector-attr">[t]</span>^c<span class="hljs-selector-attr">[e]</span>,++e&gt;=<span class="hljs-selector-tag">a</span>&amp;&amp;(e=<span class="hljs-number">0</span>);let r=<span class="hljs-number">0</span>,<span class="hljs-selector-tag">i</span>=<span class="hljs-number">0</span>,o=<span class="hljs-number">0</span>;for(let t=<span class="hljs-number">0</span>;t&lt;F+<span class="hljs-number">2</span>;t+=<span class="hljs-number">2</span>)o=R2(s,r,<span class="hljs-selector-tag">i</span>),r=o<span class="hljs-selector-class">.left</span>,<span class="hljs-selector-tag">i</span>=o<span class="hljs-selector-class">.right</span>,s<span class="hljs-selector-class">.pbox</span><span class="hljs-selector-attr">[t]</span>=r,s<span class="hljs-selector-class">.pbox</span><span class="hljs-selector-attr">[t+1]</span>=<span class="hljs-selector-tag">i</span>;for(let e=<span class="hljs-number">0</span>;e&lt;<span class="hljs-number">4</span>;e++)for(let t=<span class="hljs-number">0</span>;t&lt;<span class="hljs-number">256</span>;t+=<span class="hljs-number">2</span>)o=R2(s,r,<span class="hljs-selector-tag">i</span>),r=o<span class="hljs-selector-class">.left</span>,<span class="hljs-selector-tag">i</span>=o<span class="hljs-selector-class">.right</span>,s<span class="hljs-selector-class">.sbox</span><span class="hljs-selector-attr">[e]</span><span class="hljs-selector-attr">[t]</span>=r,s<span class="hljs-selector-class">.sbox</span><span class="hljs-selector-attr">[e]</span><span class="hljs-selector-attr">[t+1]</span>=<span class="hljs-selector-tag">i</span>}}},encryptBlock:<span class="hljs-built_in">function</span>(t,e){<span class="hljs-selector-tag">var</span> r=R2(<span class="hljs-selector-tag">H2</span>,t<span class="hljs-selector-attr">[e]</span>,t<span class="hljs-selector-attr">[e+1]</span>);t<span class="hljs-selector-attr">[e]</span>=r<span class="hljs-selector-class">.left</span>,t<span class="hljs-selector-attr">[e+1]</span>=r<span class="hljs-selector-class">.right</span>},decryptBlock:<span class="hljs-built_in">function</span>(t,e){<span class="hljs-selector-tag">var</span> r=function(e,t,r){let <span class="hljs-selector-tag">i</span>=t,o=r,n;for(let t=F+<span class="hljs-number">1</span>;<span class="hljs-number">1</span>&lt;t;<span class="hljs-attr">--t</span>)<span class="hljs-selector-tag">i</span>^=e<span class="hljs-selector-class">.pbox</span><span class="hljs-selector-attr">[t]</span>,o=C2(e,<span class="hljs-selector-tag">i</span>)^o,n=<span class="hljs-selector-tag">i</span>,<span class="hljs-selector-tag">i</span>=o,o=n;return n=<span class="hljs-selector-tag">i</span>,<span class="hljs-selector-tag">i</span>=o,o=n,o^=e<span class="hljs-selector-class">.pbox</span><span class="hljs-selector-attr">[1]</span>,{<span class="hljs-attribute">left</span>:i^=e.pbox[<span class="hljs-number">0</span>],right:o}}(<span class="hljs-selector-tag">H2</span>,t<span class="hljs-selector-attr">[e]</span>,t<span class="hljs-selector-attr">[e+1]</span>);t<span class="hljs-selector-attr">[e]</span>=r<span class="hljs-selector-class">.left</span>,t<span class="hljs-selector-attr">[e+1]</span>=r<span class="hljs-selector-class">.right</span>},blockSize:<span class="hljs-number">2</span>,keySize:<span class="hljs-number">4</span>,ivSize:<span class="hljs-number">2</span>}),<span class="hljs-selector-tag">P</span><span class="hljs-selector-class">.Blowfish</span>=w._createHelper(<span class="hljs-selector-tag">p</span>)}return <span class="hljs-selector-tag">i</span>});
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 监听页面内图片变化</span>
<span class="hljs-comment">// image_lp_logic.js</span>
(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>){<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">__lp_injected__</span>)<span class="hljs-keyword">return</span>;<span class="hljs-variable language_">window</span>.<span class="hljs-property">__lp_injected__</span>=!<span class="hljs-number">0</span>;<span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">AndroidCryptoJS</span>===<span class="hljs-string">'undefined'</span>||!<span class="hljs-title class_">AndroidCryptoJS</span>.<span class="hljs-property">MD5</span>)<span class="hljs-keyword">return</span>;<span class="hljs-keyword">function</span> <span class="hljs-title function_">md5</span>(<span class="hljs-params">s</span>){<span class="hljs-keyword">return</span> <span class="hljs-title class_">AndroidCryptoJS</span>.<span class="hljs-title class_">MD5</span>(s).<span class="hljs-title function_">toString</span>()}<span class="hljs-keyword">var</span> md5Cache=<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-literal">null</span>);<span class="hljs-keyword">function</span> <span class="hljs-title function_">hashedSrc</span>(<span class="hljs-params">src</span>){<span class="hljs-keyword">if</span>(src.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'data:'</span>)){<span class="hljs-keyword">if</span>(md5Cache[src])<span class="hljs-keyword">return</span><span class="hljs-string">'md5:'</span>+md5Cache[src];<span class="hljs-keyword">var</span> h=<span class="hljs-title function_">md5</span>(src);md5Cache[src]=h;<span class="hljs-keyword">return</span><span class="hljs-string">'md5:'</span>+h}<span class="hljs-keyword">return</span> src}<span class="hljs-keyword">function</span> <span class="hljs-title function_">mode</span>(<span class="hljs-params">img</span>){<span class="hljs-keyword">return</span>(img.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">'data-lp'</span>)||<span class="hljs-string">''</span>).<span class="hljs-title function_">toLowerCase</span>()}<span class="hljs-keyword">function</span> <span class="hljs-title function_">currentSrc</span>(<span class="hljs-params">img</span>){<span class="hljs-keyword">return</span> img.<span class="hljs-property">currentSrc</span>||img.<span class="hljs-property">src</span>||<span class="hljs-string">''</span>}<span class="hljs-keyword">function</span> <span class="hljs-title function_">register</span>(<span class="hljs-params">img</span>){<span class="hljs-keyword">if</span>(img.<span class="hljs-property">__lp_registered__</span>)<span class="hljs-keyword">return</span>;<span class="hljs-keyword">var</span> raw=<span class="hljs-title function_">currentSrc</span>(img);<span class="hljs-keyword">if</span>(!raw)<span class="hljs-keyword">return</span>;<span class="hljs-keyword">if</span>(<span class="hljs-title function_">mode</span>(img)===<span class="hljs-string">'native'</span>){<span class="hljs-keyword">var</span> key=<span class="hljs-title function_">hashedSrc</span>(raw);<span class="hljs-keyword">try</span>{<span class="hljs-variable language_">window</span>.<span class="hljs-property">AndroidLp</span>.<span class="hljs-title function_">put</span>(key);img.<span class="hljs-property">__lp_registered__</span>=key}<span class="hljs-keyword">catch</span>(e){}}}<span class="hljs-keyword">function</span> <span class="hljs-title function_">unregister</span>(<span class="hljs-params">img</span>){<span class="hljs-keyword">if</span>(!img.<span class="hljs-property">__lp_registered__</span>)<span class="hljs-keyword">return</span>;<span class="hljs-keyword">try</span>{<span class="hljs-variable language_">window</span>.<span class="hljs-property">AndroidLp</span>.<span class="hljs-title function_">remove</span>(img.<span class="hljs-property">__lp_registered__</span>)}<span class="hljs-keyword">catch</span>(e){}<span class="hljs-keyword">delete</span> img.<span class="hljs-property">__lp_registered__</span>}<span class="hljs-keyword">function</span> <span class="hljs-title function_">updateSrc</span>(<span class="hljs-params">img</span>){<span class="hljs-keyword">if</span>(!img.<span class="hljs-property">__lp_registered__</span>)<span class="hljs-keyword">return</span>;<span class="hljs-keyword">var</span> raw=<span class="hljs-title function_">currentSrc</span>(img);<span class="hljs-keyword">if</span>(!raw){<span class="hljs-title function_">unregister</span>(img);<span class="hljs-keyword">return</span>}<span class="hljs-keyword">var</span> key=<span class="hljs-title function_">hashedSrc</span>(raw);<span class="hljs-keyword">if</span>(key!==img.<span class="hljs-property">__lp_registered__</span>){<span class="hljs-keyword">try</span>{<span class="hljs-variable language_">window</span>.<span class="hljs-property">AndroidLp</span>.<span class="hljs-title function_">update</span>(img.<span class="hljs-property">__lp_registered__</span>,key)}<span class="hljs-keyword">catch</span>(e){}img.<span class="hljs-property">__lp_registered__</span>=key}}<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleModeChange</span>(<span class="hljs-params">img</span>){<span class="hljs-keyword">var</span> m=<span class="hljs-title function_">mode</span>(img);<span class="hljs-keyword">if</span>(m===<span class="hljs-string">'native'</span>){<span class="hljs-title function_">register</span>(img)}<span class="hljs-keyword">else</span>{<span class="hljs-title function_">unregister</span>(img)}}<span class="hljs-keyword">function</span> <span class="hljs-title function_">observe</span>(<span class="hljs-params">img</span>){<span class="hljs-keyword">if</span>(img.<span class="hljs-property">__lp_obs__</span>)<span class="hljs-keyword">return</span>;img.<span class="hljs-property">__lp_obs__</span>=!<span class="hljs-number">0</span>;<span class="hljs-keyword">var</span> mo=<span class="hljs-keyword">new</span> <span class="hljs-title class_">MutationObserver</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">muts</span>){muts.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">m</span>){<span class="hljs-keyword">if</span>(m.<span class="hljs-property">type</span>===<span class="hljs-string">'attributes'</span>){<span class="hljs-keyword">if</span>(m.<span class="hljs-property">attributeName</span>===<span class="hljs-string">'src'</span>){<span class="hljs-title function_">updateSrc</span>(img)}<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(m.<span class="hljs-property">attributeName</span>===<span class="hljs-string">'data-lp'</span>){<span class="hljs-title function_">handleModeChange</span>(img)}}})});mo.<span class="hljs-title function_">observe</span>(img,{<span class="hljs-attr">attributes</span>:!<span class="hljs-number">0</span>,<span class="hljs-attr">attributeFilter</span>:[<span class="hljs-string">'src'</span>,<span class="hljs-string">'data-lp'</span>]})}<span class="hljs-keyword">function</span> <span class="hljs-title function_">initialScan</span>(<span class="hljs-params"/>){<span class="hljs-keyword">var</span> imgs=<span class="hljs-variable language_">document</span>.<span class="hljs-property">images</span>;<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>;i&lt;imgs.<span class="hljs-property">length</span>;i++){<span class="hljs-title function_">register</span>(imgs[i]);<span class="hljs-title function_">observe</span>(imgs[i])}}<span class="hljs-keyword">var</span> rootObs=<span class="hljs-keyword">new</span> <span class="hljs-title class_">MutationObserver</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">muts</span>){muts.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">m</span>){<span class="hljs-keyword">if</span>(m.<span class="hljs-property">type</span>===<span class="hljs-string">'childList'</span>){m.<span class="hljs-property">addedNodes</span>&amp;&amp;m.<span class="hljs-property">addedNodes</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">n</span>){<span class="hljs-keyword">if</span>(n.<span class="hljs-property">tagName</span>===<span class="hljs-string">'IMG'</span>){<span class="hljs-title function_">register</span>(n);<span class="hljs-title function_">observe</span>(n)}<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(n.<span class="hljs-property">querySelectorAll</span>){n.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'img'</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">img</span>){<span class="hljs-title function_">register</span>(img);<span class="hljs-title function_">observe</span>(img)})}});m.<span class="hljs-property">removedNodes</span>&amp;&amp;m.<span class="hljs-property">removedNodes</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">n</span>){<span class="hljs-keyword">if</span>(n.<span class="hljs-property">tagName</span>===<span class="hljs-string">'IMG'</span>){<span class="hljs-title function_">unregister</span>(n)}<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(n.<span class="hljs-property">querySelectorAll</span>){n.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'img'</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">img</span>){<span class="hljs-title function_">unregister</span>(img)})}})}})});rootObs.<span class="hljs-title function_">observe</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>,{<span class="hljs-attr">childList</span>:!<span class="hljs-number">0</span>,<span class="hljs-attr">subtree</span>:!<span class="hljs-number">0</span>});<span class="hljs-keyword">function</span> <span class="hljs-title function_">ready</span>(<span class="hljs-params">fn</span>){<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-property">readyState</span>===<span class="hljs-string">'interactive'</span>||<span class="hljs-variable language_">document</span>.<span class="hljs-property">readyState</span>===<span class="hljs-string">'complete'</span>){<span class="hljs-title function_">fn</span>()}<span class="hljs-keyword">else</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'DOMContentLoaded'</span>,fn)}<span class="hljs-title function_">ready</span>(initialScan)})();
</code></pre>
<h3 data-id="heading-8">2. JS 侧逻辑 (<code>image_lp_logic.js</code>)</h3>
<p>JS 侧主要完成以下工作：</p>
<ol>
<li>
<p><strong>DOM 监听：</strong> 使用 <code>MutationObserver</code> 或在 DOM Ready 后遍历，查找带有 <code>data-lp='native'</code> 属性的 <code>&lt;img&gt;</code> 元素。</p>
</li>
<li>
<p><strong>Key 生成：</strong></p>
<ul>
<li>如果是普通 URL，直接使用 <code>img.src</code>。</li>
<li>如果是 Data URI，则使用注入的 <strong><code>crypto-js</code></strong> 库计算其内容的 MD5 摘要，并拼接成 <code>md5:&lt;digest&gt;</code> 格式。</li>
</ul>
</li>
<li>
<p><strong>注册/更新：</strong> 调用 Native 注册方法。</p>
<p>JavaScript</p>
<pre><code class="hljs language-ini" lang="ini">// JS 侧示例调用
const <span class="hljs-attr">key</span> = isDataUri ? <span class="hljs-string">'md5:'</span> + CryptoJS.MD5(img.src).toString() : img.src<span class="hljs-comment">;</span>
window.AndroidLp.put(key)<span class="hljs-comment">;</span>
</code></pre>
</li>
</ol>
<h3 data-id="heading-9">3. Native 侧长按分发</h3>
<p>当原生端捕获到长按事件时（例如通过 <code>WebView.HitTestResult</code> 获取到图片 URL <code>src</code>），立即执行判断：</p>
<p>Kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin">setOnLongClickListener {
  <span class="hljs-keyword">val</span> hitTestResult = hitTestResult
  <span class="hljs-keyword">if</span> (hitTestResult.type == WebView.HitTestResult.IMAGE_TYPE ||
    hitTestResult.type == WebView.HitTestResult.SRC_IMAGE_ANCHOR_TYPE
  ) {
    <span class="hljs-keyword">val</span> extra = hitTestResult.extra
    <span class="hljs-keyword">val</span> mode = lpHandler.imageLpRegistry?.<span class="hljs-keyword">get</span>(extra) ?: <span class="hljs-string">""</span>

    <span class="hljs-keyword">if</span> (mode == <span class="hljs-string">"native"</span>) {
      showNativeImageMenu(extra)
      <span class="hljs-keyword">return</span><span class="hljs-symbol">@setOnLongClickListener</span> <span class="hljs-literal">true</span> <span class="hljs-comment">// 消耗事件</span>
    }
  }
  <span class="hljs-keyword">return</span><span class="hljs-symbol">@setOnLongClickListener</span> <span class="hljs-literal">false</span> <span class="hljs-comment">// 不处理，让 WebView 执行默认行为</span>
}
</code></pre>
<h2 data-id="heading-10">总结</h2>
<p>通过引入 <strong><code>ImageLpRegistry</code></strong> 和 <strong>MD5 规范化 Key</strong>，这里构建了一个WebView 图片长按事件分发机制：</p>
<ul>
<li>✅ <strong>性能优化：</strong> 避免在 Native/JS 之间传输和存储超长的 Data URI 字符串。</li>
<li>✅ <strong>逻辑分离：</strong> JS 负责 Key 的生成和注册，Native 负责 Key 的存储和查询，职责清晰。</li>
<li>✅ <strong>线程安全：</strong> <code>ConcurrentHashMap</code> 确保了跨线程调用的可靠性。</li>
</ul>
<p>这套机制极大地提升了处理 Data URI 图片的效率，为 WebView 的图片长按体验提供了灵活且可靠的 Native 增强能力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大部分人都错了！这才是chrome插件多脚本通信的正确姿势]]></title>    <link>https://juejin.cn/post/7573521516324732955</link>    <guid>https://juejin.cn/post/7573521516324732955</guid>    <pubDate>2025-11-18T00:06:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573521516324732955" data-draft-id="7572481101711097910" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大部分人都错了！这才是chrome插件多脚本通信的正确姿势"/> <meta itemprop="keywords" content="前端,浏览器,JavaScript"/> <meta itemprop="datePublished" content="2025-11-18T00:06:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不一样的少年_"/> <meta itemprop="url" content="https://juejin.cn/user/3035079961218551"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大部分人都错了！这才是chrome插件多脚本通信的正确姿势
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3035079961218551/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不一样的少年_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T00:06:38.000Z" title="Tue Nov 18 2025 00:06:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>昨天一个实习生同事来找我：“哥们，我的Chrome插件遇到个奇怪问题，为什么我插入到页面的内容脚本content.js，重写页面脚本的方法没有生效？”</p>
<p>其实类似的问题我也经常碰到，比如：“为什么popup页面调用不了content.js的函数？”、“插入到页面的内容脚本为啥访问不到Vue实例？”、“background脚本为啥不能访问页面的dom节点”?………这些问题在插件开发里真的挺常见的，大家都容易踩坑。</p>
<p>所以今天，我想用最通俗的方式，把自己遇到的问题和一些小经验分享出来：</p>
<ul>
<li>为什么Chrome要把插件分成这么多脚本？它们之间到底啥关系？</li>
<li>那些“看起来应该能用，但就是不行”的通信方式，背后的原因是什么？</li>
<li>怎么让插件的各个部分配合得更顺畅？</li>
</ul>
<p>放心，没有复杂的术语，用图解的方式来梳理脉络，希望这些内容能帮到大家，也欢迎大家一起交流！</p>
</blockquote>
<h3 data-id="heading-0">前置知识：</h3>
<p>要搞懂插件通信，首先得了解浏览器的架构。现在的 Chrome 浏览器采用的是“多进程架构”，什么意思呢？直接看图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef2bd5d3aa8b482ab9bbdb857454ceef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764030308&amp;x-signature=7yzcvj7a%2Fjb7HV2lR4B5yKQD2Yg%3D" alt="" loading="lazy"/></p>
<p>上图中，我们浏览器架构是由、渲染进程、插件进程、网路进程、浏览器主进程、gpu进程等组成的</p>
<ul>
<li>
<p><code>浏览器主进程</code>: 相当于公司的大老板，负责整个公司的运转。比如你要开新窗口、切换标签、下载文件、弹出权限提示，都是浏览器主进程安排的。</p>
<p>其他进程有啥事也都得跟主进程报备，主进程来调度。</p>
</li>
<li>
<p><code>渲染进程</code>：平时我们使用浏览器打开的每一个网页，都是由渲染进程进行渲染的。插件注入的内容脚本也在这里运行，不过处于“隔离世界”，与页面脚本相互隔离，这个后面我们会详细讲</p>
</li>
<li>
<p><code>网络进程</code>：处理所有页面与扩展的请求，我们网页中或者插件中的接口请求这种脏活累活都由它来干</p>
</li>
<li>
<p><code>GPU进程</code>：网页中有炫酷动画、视频、3D效果啥的，GPU进程就会帮你画的又快又漂亮。</p>
</li>
<li>
<p><code>插件进程</code>：运行我们平时所装的浏览器插件，我们装的不同的插件都会分配到不同的插件进程中，互不干扰，谁家插件出了问题，最多自己崩，不会影响到其他插件和页面的运行</p>
</li>
</ul>
<p>Chrome 浏览器其实就是把各种工作分开来做，谁负责啥都很清楚。<code>主进程</code>管大局，<code>渲染进</code>程负责把网页内容展示出来，<code>网络进程</code>专门搞数据传输，<code>GPU进程</code>让动画和视频更流畅，<code>插件进程</code>则让你装的各种扩展各自独立运行。大家各干各的，互不影响，这样浏览器用起来才又快又稳还安全。</p>
<h3 data-id="heading-1">插件各部分的角色与能力</h3>
<p><a href="https://juejin.cn/column/7548643621609193482" target="_blank" title="https://juejin.cn/column/7548643621609193482">浏览器插件开发实践 - 不一样的少年_的专栏 - 掘金</a></p>
<p>大家看到我的插件专栏里的插件目录，大致是这样：</p>
<pre><code class="hljs language-js" lang="js">demo
├── manifest.<span class="hljs-property">json</span> # 扩展的<span class="hljs-string">"身份证"</span>
├── background.<span class="hljs-property">js</span> # 插件后台脚本
├── injected.<span class="hljs-property">js</span> # 注入页面脚本
├── content.<span class="hljs-property">js</span> # 内容脚本
└── popup.<span class="hljs-property">html</span> # 弹窗页面
</code></pre>
<p>我们来简单聊聊每个文件的作用：</p>
<h4 data-id="heading-2">manifest.json —— 插件的“身份证”</h4>
<p>这个文件就像插件的身份证，里面写明了插件的名字、版本、权限、各个脚本的入口。比如你这个插件是弹窗类型，还是需要内容脚本、后台脚本，都要在这里声明清楚。没有它，浏览器都不认你这个插件。</p>
<h4 data-id="heading-3">popup.html —— 弹窗页面</h4>
<p>这个文件就是你点浏览器右上角插件图标弹出来的小窗口。写法跟普通网页一样，可以放按钮、输入框、结果展示区。</p>
<p>如下红色框住的就是popup页面：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/903ab19c88c74d078203bb1649f097ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764030308&amp;x-signature=ieAxHX%2Bg9XMG0Ddukiq4QXQ5BQw%3D" alt="" loading="lazy"/></p>
<p>这个popup页面，浏览器会分配一个渲染进程来进行渲染，如下图：</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9021eb9b881c4d8cbc75bf3718accc39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764030308&amp;x-signature=7kKDVAg%2B30Si0NFY6H7TG1h83hc%3D" alt="" width="70%" loading="lazy"/>
<h4 data-id="heading-4">background.js —— 后台脚本</h4>
<p>后台脚本是插件的大脑，负责处理各种“后台任务”。比如监听消息、和服务器通信、管理数据。它不直接操作页面内容，但能帮你做很多“脏活累活”，比如跨域请求、定时任务、权限控制。弹窗页面、内容脚本都可以和它发消息，让它帮忙干活。</p>
<p>这个后台脚本，浏览器会开一个service worker服务进程来运行，如下图：</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8eb0c1e3ccac481b894a0accd1bfb9c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764030308&amp;x-signature=oxLS2mtX4iK69PkiEr4EYik3Odc%3D" alt="" width="70%" loading="lazy"/>
<p><strong>举例</strong>： <code>popup页面和插件后台的通信</code></p>
<p>比如你做了一个“天气查询”插件，用户在弹窗页面输入城市名，点击“查询”按钮，弹窗页面就会通过 chrome.runtime.sendMessage 把城市名发给后台脚本，后台脚本收到后去请求天气接口，然后把结果返回给弹窗页面显示。</p>
<p><code>图解</code>：</p>
<ul>
<li>
<p>用户操作 popup 页面</p>
</li>
<li>
<p>popup 页面用 chrome.runtime.sendMessage 发消息给后台脚本</p>
</li>
<li>
<p>后台脚本处理请求，返回结果给 popup 页面</p>
</li>
</ul>
<p>虽然都popup页面和service worker属于同一个扩展，但它们运行在不同进程/沙箱中，无法直接共享内存或调用函数，必须通过浏览器主进程的消息路由（IPC）中转，如下图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/444bdaa4c84048a6b4e93ca0c366757e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764030308&amp;x-signature=DLOsh8XJPpFdUfR7Pul5dhEeaYU%3D" alt="" loading="lazy"/></p>
<p>我们打开chrome的任务管理器看一个插件，可以看出service worker和popup分别在两个进程中运行，如下图：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16e2c6d77b0f48ddbd2d44dccd26b671~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764030308&amp;x-signature=5naYwG9g0KItupj50%2BBN9Pa27Q0%3D" alt="image.png" loading="lazy"/></p>
<p>代码示例：</p>
<p><code>popup.htm</code>l</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"city"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"城市名"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"btn"</span>&gt;</span>查天气<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"result"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">const</span> btn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'btn'</span>)
      btn.<span class="hljs-property">onclick</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> city = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'city'</span>).<span class="hljs-property">value</span>;
        <span class="hljs-comment">// popup向background.js发送查询消息</span>
        chrome.<span class="hljs-property">runtime</span>.<span class="hljs-title function_">sendMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'getWeather'</span>, city }, <span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) {
            <span class="hljs-comment">// background.js返回的消息</span>
          <span class="hljs-keyword">const</span> data =  response.<span class="hljs-property">weather</span> 
          <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'result'</span>).<span class="hljs-property">textContent</span> = data || <span class="hljs-string">'查询失败'</span>;
        });
      };
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p><code>background.js</code></p>
<pre><code class="hljs language-js" lang="js">chrome.<span class="hljs-property">runtime</span>.<span class="hljs-property">onMessage</span>.<span class="hljs-title function_">addListener</span>(<span class="hljs-function">(<span class="hljs-params">msg, sender, sendResponse</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (msg.<span class="hljs-property">type</span> === <span class="hljs-string">'getWeather'</span>) {
    <span class="hljs-comment">// 这里只做演示，实际开发可以用 fetch 去请求真实接口</span>
    <span class="hljs-keyword">const</span> fakeWeather = <span class="hljs-string">`<span class="hljs-subst">${msg.city}</span>：晴，25°C`</span>;
    <span class="hljs-title function_">sendResponse</span>({ <span class="hljs-attr">weather</span>: fakeWeather });
    <span class="hljs-comment">// 如果是异步操作（比如 fetch），需要 return true</span>
  }
});
</code></pre>
<p>这样，弹窗页面和后台脚本就能通过消息机制实现通信，弹窗页面只负责收集用户输入和展示结果，后台脚本负责处理数据和业务逻辑，分工明确，开发起来也很清晰！</p>
<h4 data-id="heading-5">content.js —— 内容脚本</h4>
<p>内容脚本是插件派到网页里的“卧底”，所以这个content.js是在页面的渲染进程中运行的，不是在插件中运行的</p>
<p>我们画个图来解释下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/795107b9fbfb4fed82e87c49023499c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764030308&amp;x-signature=G6bvhyGv%2FXAqgAM5K3mh6XL%2FmWk%3D" alt="" loading="lazy"/></p>
<p>当我们用浏览器打开掘金网站时，浏览器会启动一个渲染进程来负责页面的展示。掘金网站自己的 JS 变量和运行环境都在 Main World（页面脚本环境）里，比如你用 React/Vue 写的代码、window 上挂的变量，都是属于这个世界。</p>
<p>如果你这时候装了一个护眼插件，想让页面变成护眼模式（比如把背景色调成绿色），插件会通过内容脚本来操作页面的 DOM，比如直接修改 body 的样式。这段内容脚本其实是在另一个独立的 JS 环境里运行，也就是图里的 Isolated World（内容脚本环境）。</p>
<p>虽然内容脚本和页面脚本的执行环境是隔离开的，互相访问不到对方的变量，但它们可以一起操作和共享页面上的 DOM（比如 document.body），所以内容脚本能帮你改页面样式、加按钮、弹提示，但没法直接拿到页面里的 JS 变量。如果内容脚本真要和页面脚本通信，可以用 window.postMessage 这种方式来“搭桥”。</p>
<p>这样设计既保证了安全，又能让插件灵活地扩展页面功能。</p>
<h5 data-id="heading-6">内容脚本是怎么进到页面里的呢？</h5>
<p>内容脚本是插件派到网页里的“卧底”，其实它的“卧底”过程也是有讲究的：</p>
<p>有两种方式，第一种是声明式的，另一种是编程式的</p>
<h6 data-id="heading-7">声明式：</h6>
<p>浏览器根据插件的 manifest.json 配置，自动帮你注入到指定网页的渲染进程里。 比如你在 manifest.json 里写了：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"content_scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"matches"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"https://juejin.cn/*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"js"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"content.js"</span><span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">]</span>
</code></pre>
<p>只要你打开掘金网站，浏览器就会自动把 content.js 注入到页面的渲染进程里，让它在 Isolated World（隔离环境）里运行。</p>
<h6 data-id="heading-8">编程式（按需注入）</h6>
<p>这里有个很重要的概念： 浏览器里不同进程之间（比如主进程、渲染进程、插件进程）要互相传递消息，靠的就是 IPC（Inter-Process Communication）机制，翻译过来就是“进程间通信”。</p>
<ul>
<li>
<p>比如你在后台脚本（background.js）或弹窗页面（popup）里调用 chrome.scripting.executeScript ，就能按需把内容脚本注入到指定网站页面里。</p>
</li>
<li>
<p>这个过程其实是：插件发起注入请求后，浏览器主进程会先受理这个请求，然后通过 IPC机制，把要注入的内容脚本安全地传递给目标页面的渲染进程。</p>
</li>
<li>
<p>渲染进程收到脚本后，就会在页面的隔离环境（Isolated World）里执行内容脚本，这样内容脚本就真正“落地”到页面中了。</p>
</li>
</ul>
<p>所以，整个流程就是： 插件调用 chrome.scripting.executeScript → 浏览器主进程受理并通过 IPC 转发 → 页面渲染进程执行内容脚本。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59eb3f573d1745afbcfe59271299a3d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764030308&amp;x-signature=eu2jgqSschAUiZwNvSjVnjTbupo%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-9">injected.js —— 注入页面脚本</h4>
<p>前面说过，页面的 JS 环境和内容脚本的 JS 环境是互相隔离的，彼此访问不到对方的变量和方法，但它们共享同一个 DOM 树。 如果你想直接改页面里的 JS 环境，比如重写 fetch 或 XMLHttpRequest，实现像 mock 接口这样的功能，就不能只靠内容脚本了。</p>
<p>这时候就需要用“注入脚本”的方式： 我们可以在内容脚本里创建一个 script 标签，把要改写的代码（比如新的 fetch 实现）写进去，然后把这个标签插入到页面的 DOM 里。这样，页面会像加载普通 JS 文件一样执行这段代码，最终就能覆盖页面原生的 fetch 和 xhr 方法。</p>
<p>这种做法的好处是：</p>
<ul>
<li>
<p>能直接影响页面自己的 JS 环境，实现更强的功能扩展</p>
</li>
<li>
<p>只要 DOM 是共享的，插入 script 标签就能让页面执行我们的代码</p>
</li>
<li>
<p>很适合做 mock、日志劫持、性能监控等插件功能</p>
</li>
</ul>
<p>比如我最近写的一个基础的 mock 插件(<a href="https://juejin.cn/post/7570984257666056238)%EF%BC%8C%E5%B0%B1%E6%98%AF%E7%94%A8%E8%BF%99%E7%A7%8D%E6%96%B9%E5%BC%8F%EF%BC%8C%E5%9C%A8%E9%A1%B5%E9%9D%A2%E5%8A%A0%E8%BD%BD%E5%89%8D%E5%81%B7%E5%81%B7%E6%8A%8A" target="_blank" title="https://juejin.cn/post/7570984257666056238)%EF%BC%8C%E5%B0%B1%E6%98%AF%E7%94%A8%E8%BF%99%E7%A7%8D%E6%96%B9%E5%BC%8F%EF%BC%8C%E5%9C%A8%E9%A1%B5%E9%9D%A2%E5%8A%A0%E8%BD%BD%E5%89%8D%E5%81%B7%E5%81%B7%E6%8A%8A">juejin.cn/post/757098…</a> fetch 和 XMLHttpRequest 替换成我重写的，让所有网络请求都能被插件拦截和处理。</p>
<h5 data-id="heading-10">跨环境通信流程举例</h5>
<p>有时候，我们的注入页面脚本（injected.js）需要用到插件进程里的数据，比如判断某个 fetch 请求是否命中插件配置的规则。但页面环境是拿不到插件进程里的配置的，不过内容脚本可以帮忙“中转”。</p>
<p>比如我们在 injected.js 里重写了 fetch 方法，页面发起请求后，需要查一下插件里有没有对应的 mock 规则。整个数据流可以这样走：</p>
<ul>
<li>
<ol>
<li>注入脚本（injected.js）拦截到 fetch 请求，发现需要插件里的规则配置。</li>
</ol>
</li>
<li>
<ol start="2">
<li>注入脚本用 window.postMessage 向内容脚本发消息，请求规则数据。</li>
</ol>
</li>
<li>
<ol start="3">
<li>内容脚本收到消息后，再用 chrome.runtime.sendMessage 向插件进程（比如后台脚本）发起请求，获取最新规则。</li>
</ol>
</li>
<li>
<ol start="4">
<li>插件进程通过 IPC 机制把规则数据返回给内容脚本。</li>
</ol>
</li>
<li>
<ol start="5">
<li>内容脚本拿到数据后，再用 window.postMessage 把结果传回 injected.js。</li>
</ol>
</li>
<li>
<ol start="6">
<li>注入脚本拿到规则，判断请求是否命中，然后做后续处理（比如 mock、拦截、日志等）。</li>
</ol>
</li>
</ul>
<p>这样一来，页面脚本、内容脚本、插件进程就能通过消息链路把数据安全地串联起来，实现复杂的功能扩展。 整个过程就像“接力传话”，每个环节各司其职，既保证了安全，又让插件和页面能灵活协作</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/398541a9c4df48e2b4d612ffefa12615~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764030308&amp;x-signature=Sxn6lGnybbxPsmCRtNIELYg8%2B24%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">总结：插件多脚本通信，没那么难！</h3>
<p>看到这里，相信你已经对Chrome插件中的多脚本通信有了清晰的认识。让我们简单回顾一下今天学到的关键知识：</p>
<ol>
<li>为什么需要多脚本？</li>
</ol>
<ul>
<li>Chrome的多进程架构是为了安全和稳定性，不是为了故意为难开发者</li>
</ul>
<ol start="2">
<li>各脚本的角色：</li>
</ol>
<ul>
<li>background.js ：常驻后台，负责大部分逻辑和权限，是插件的大脑。</li>
<li>content.js ：嵌入页面，能操作DOM，但和页面JS是隔离的，像是派驻到页面的特工。</li>
<li>popup.html ：弹窗页面，主要负责UI交互，关闭就“失忆”，但用起来很方便。</li>
<li>injected.js ：直接注入页面，能访问和修改页面环境，类似卧底。</li>
</ul>
<ol start="3">
<li>通信秘诀：</li>
</ol>
<ul>
<li>background ↔ popup ：用 chrome.runtime.sendMessage</li>
<li>background ↔ content ：用 chrome.tabs.sendMessage 或 chrome.runtime.sendMessage</li>
<li>content ↔ 页面JS ：用 window.postMessage</li>
</ul>
<p>还记得开头那位苦恼的同事吗？现在你不仅知道为什么他的变量“死活拿不到”，更重要的是，掌握了正确的解决方法！</p>
<p>希望这篇文章能帮你少踩坑、多收获。如果觉得有用，欢迎点赞、收藏，你的支持是我持续分享的动力！</p>
<p>有任何问题，欢迎在评论区讨论。下期见！👋</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React性能优化实战：我用这5个技巧将组件渲染速度提升了70%]]></title>    <link>https://juejin.cn/post/7573504290067169295</link>    <guid>https://juejin.cn/post/7573504290067169295</guid>    <pubDate>2025-11-18T00:16:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573504290067169295" data-draft-id="7573508361742123008" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React性能优化实战：我用这5个技巧将组件渲染速度提升了70%"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-18T00:16:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT_陈寒"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React性能优化实战：我用这5个技巧将组件渲染速度提升了70%
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT_陈寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T00:16:51.000Z" title="Tue Nov 18 2025 00:16:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>React性能优化实战：我用这5个技巧将组件渲染速度提升了70%</strong></h2>
<h3 data-id="heading-1">引言</h3>
<p>在现代前端开发中，React因其声明式编程模型和高效的虚拟DOM机制而广受欢迎。然而，随着应用规模的扩大和复杂度的提升，性能问题往往会逐渐显现。特别是在大型应用中，组件的频繁重新渲染可能导致明显的性能瓶颈。</p>
<p>本文将分享我在实际项目中通过5个关键技巧将React组件渲染速度提升70%的实战经验。这些方法不仅经过了生产环境的验证，而且都有坚实的理论基础和社区实践支持。无论你是React新手还是资深开发者，这些优化技巧都能为你的应用带来显著的性能提升。</p>
<h3 data-id="heading-2">一、理解React的渲染机制</h3>
<p>在深入优化技巧之前，我们需要先理解React的核心渲染机制：</p>
<ol>
<li><strong>虚拟DOM与协调(Reconciliation)</strong>：React通过比较新旧虚拟DOM树的差异来最小化实际DOM操作</li>
<li><strong>组件生命周期与重新渲染触发条件</strong>：props或state的变化会触发重新渲染</li>
<li><strong>批量更新(Batching)</strong>：React会将多个setState调用合并为单一更新</li>
</ol>
<p>常见的性能问题通常源于：</p>
<ul>
<li>不必要的重新渲染</li>
<li>昂贵的计算在每次渲染时重复执行</li>
<li>大型列表的低效处理</li>
<li>Context API的不合理使用</li>
</ul>
<h3 data-id="heading-3">二、关键优化技巧实战</h3>
<h4 data-id="heading-4">1. 合理使用React.memo进行组件记忆化</h4>
<p><code>React.memo</code>是一个高阶组件，它会对props进行浅比较来决定是否跳过重新渲染。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title class_">ExpensiveComponent</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<span class="hljs-keyword">function</span> <span class="hljs-title function_">ExpensiveComponent</span>(<span class="hljs-params">{ data }</span>) {
  <span class="hljs-comment">// 组件实现</span>
});
</code></pre>
<p><strong>最佳实践</strong>：</p>
<ul>
<li>对于纯展示型组件优先使用memo</li>
<li>props中包含复杂对象时配合自定义比较函数</li>
<li>避免内联函数和对象作为props</li>
</ul>
<p><strong>案例分析</strong>：
在一个包含100+子组件的列表中，使用memo后减少了约85%的不必要渲染。</p>
<h4 data-id="heading-5">2. useCallback与useMemo的正确用法</h4>
<p>这两个Hook可以分别缓存函数引用和计算结果：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> memoizedCallback = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">doSomething</span>(a, b);
}, [a, b]);

<span class="hljs-keyword">const</span> memoizedValue = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">computeExpensiveValue</span>(a, b), [a, b]);
</code></pre>
<p><strong>关键区别</strong>：</p>
<ul>
<li><code>useCallback</code>缓存函数实例本身</li>
<li><code>useMemo</code>缓存函数的返回值</li>
</ul>
<p><strong>常见误区修正</strong>：</p>
<ul>
<li>不是所有函数都需要useCallback - 仅在作为依赖项或prop传递时需要</li>
<li>useMemo的依赖数组要精确包含所有变化因素</li>
</ul>
<h4 data-id="heading-6">3. 虚拟化长列表（Windowizing）</h4>
<p>对于包含大量元素的列表（如1000+项），常规渲染会导致严重性能问题。解决方案是只渲染可视区域内的元素：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">FixedSizeList</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">List</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-window'</span>;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">List</span> 
  <span class="hljs-attr">height</span>=<span class="hljs-string">{600}</span>
  <span class="hljs-attr">itemCount</span>=<span class="hljs-string">{1000}</span>
  <span class="hljs-attr">itemSize</span>=<span class="hljs-string">{35}</span>
&gt;</span>
{({ index, style }) =&gt; (
   <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{style}</span>&gt;</span>Row {index}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
 )}
<span class="hljs-tag">&lt;/<span class="hljs-name">List</span>&gt;</span></span>
</code></pre>
<p><strong>主流库选择</strong>：</p>
<ul>
<li>react-window：轻量级基础方案</li>
<li>react-virtualized：功能更全面但体积较大</li>
</ul>
<p>在我们的电商项目中，5000项商品列表的滚动性能从8FPS提升到了60FPS。</p>
<h4 data-id="heading-7">4. Context API的分治策略</h4>
<p>Context的价值变化会导致所有消费组件重新渲染。优化方法包括：</p>
<ol>
<li><strong>拆分Context</strong>：按功能领域分成多个Context</li>
<li><strong>记忆化消费者</strong>：</li>
</ol>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title class_">ThemeLabel</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<span class="hljs-function">(<span class="hljs-params">{ theme }</span>) =&gt;</span> (
   <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">color:</span> <span class="hljs-attr">theme.color</span> }}&gt;</span>Theme<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span>
));

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ThemeLabelWrapper</span>(<span class="hljs-params"/>) {
   <span class="hljs-keyword">const</span> theme = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ThemeContext</span>);
   <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemeLabel</span> <span class="hljs-attr">theme</span>=<span class="hljs-string">{theme}</span> /&gt;</span></span>
}
</code></pre>
<ol start="3">
<li><strong>使用发布订阅模式替代部分Context场景</strong></li>
</ol>
<h4 data-id="heading-8">5. Code Splitting与懒加载</h4>
<p>利用动态import实现按需加载：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title class_">OtherComponent</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./OtherComponent'</span>));

<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyComponent</span>(<span class="hljs-params"/>) {
   <span class="hljs-keyword">return</span> (
     <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>Loading...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
       <span class="hljs-tag">&lt;<span class="hljs-name">OtherComponent</span> /&gt;</span>
     <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span>
   );
}
</code></pre>
<p><strong>进阶用法</strong>：</p>
<ul>
<li>Prefetching：预测用户行为提前加载模块（Next.js等框架内置支持）</li>
<li>Webpack魔法注释指定chunk名称</li>
</ul>
<p>在我们的管理后台应用中，初始加载时间从4.2s减少到1.8s。</p>
<h3 data-id="heading-9">三、高级调试与分析技术</h3>
<p>优化的前提是准确识别瓶颈。推荐的工具和方法：</p>
<ol>
<li><strong>React DevTools Profiler</strong>
<ul>
<li>Record交互过程分析火焰图</li>
<li>Commit-by-Commit分析组件生命周期</li>
</ul>
</li>
<li><strong>Chrome Performance Tab</strong>
<ul>
<li>JS执行时间分析</li>
<li>Layout Thrashing检测</li>
</ul>
</li>
<li><strong>自定义测量Hook</strong></li>
</ol>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useRenderTime</span>(<span class="hljs-params">name</span>) {
   <span class="hljs-keyword">const</span> start = performance.<span class="hljs-title function_">now</span>();
   
   <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> end = performance.<span class="hljs-title function_">now</span>();
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${name}</span> render time:`</span>, end - start);
   });
}
</code></pre>
<ol start="4">
<li>Production环境下的Performance Monitoring（如Sentry）捕获真实用户体验数据</li>
</ol>
<h3 data-id="heading-10">四、架构层面的优化考量</h3>
<p>除了上述具体技术外，还有一些更高层次的优化原则：</p>
<ol>
<li><strong>状态管理的最小化原则</strong>
<ul>
<li>Redux等全局状态仅用于真正全局的数据</li>
<li>colocate状态到尽可能小的子树</li>
</ul>
</li>
<li><strong>不可变数据结构的优势</strong>
<ul>
<li>Immer简化不可变更新逻辑</li>
</ul>
</li>
<li><strong>服务端优化的协同效应</strong>
<ul>
<li>GraphQL的数据精确获取优于RESTful瀑布请求</li>
</ul>
</li>
<li>WASM处理CPU密集型任务的可能性探索（如表格数据处理）</li>
</ol>
<h3 data-id="heading-11">五、权衡的艺术：何时不优化？</h3>
<p>值得注意的是，"过早优化是万恶之源"。在实践中需要平衡：</p>
<ol>
<li><strong>可维护性与性能的trade-off</strong></li>
<li>ROI考量：90/10法则（90%的性能问题来自10%的关键路径）</li>
<li>A/B测试验证优化的实际效果而非臆测<br/>
4."足够好"原则满足业务需求即可停止进一步优化</li>
</ol>
<p>###总结</p>
<p>通过实施上述五个核心策略——明智地使用memoization、正确应用Hooks、虚拟化长列表、精细控制Context以及代码分割——我们成功地将关键页面的交互延迟降低了70%，同时保持了代码的可维护性。</p>
<p>记住，性能优化是一个持续的过程而非一次性任务。建议建立定期的performance audit文化，结合自动化监控工具及时发现问题。最重要的是保持对React核心原理的深入理解——知其所以然才能做出最恰当的优化决策。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[节省 60% Token 的新数据格式「GitHub 热点速览」]]></title>    <link>https://juejin.cn/post/7573519273030713390</link>    <guid>https://juejin.cn/post/7573519273030713390</guid>    <pubDate>2025-11-18T00:19:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573519273030713390" data-draft-id="7573521516324716571" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="节省 60% Token 的新数据格式「GitHub 热点速览」"/> <meta itemprop="keywords" content="GitHub,开源"/> <meta itemprop="datePublished" content="2025-11-18T00:19:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="HelloGitHub"/> <meta itemprop="url" content="https://juejin.cn/user/1574156384091320"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            节省 60% Token 的新数据格式「GitHub 热点速览」
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1574156384091320/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    HelloGitHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T00:19:23.000Z" title="Tue Nov 18 2025 00:19:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/882e904909784484a303bb2d81b41619~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764029963&amp;x-signature=k%2BB9TNx8LGrjViqAe2qS7EP77YQ%3D" alt="" loading="lazy"/></p>
<p>我最近琐事缠身，连续好几周没发「GitHub 热点速览」了，这样不行得赶紧续上。</p>
<p>首先映入眼帘的是可节省 60% Token 的新数据序列化格式 TOON，其官方开源的 TypeScript 实现在 GitHub 上一周便斩获了 3.5k Star，而且热度还在持续上涨。Snapchat 团队开源的跨平台 UI 框架 Valdi，不仅能够用 TypeScript 写跨平台 UI 而且无需重新编译即可在毫秒内看到改动效果。话说我也有看走眼的时候...TrendRadar 是一款基于 AI 的全网热点资讯追踪助手，最近持续霸榜一周涨了 10k Star，我初见它的时候 Star 才刚破千！</p>
<p>这期热榜上没有 Web 应用，所以「HelloGitHub 热评」我选了极简的个人云相册平台 ChronoFrame 和清爽的轻量级内容分享平台 Ech0，希望大家能够喜欢。</p>
<ul>
<li>本文目录
<ul>
<li>1. 热门开源项目
<ul>
<li>1.1 跨平台原生性能的 UI 框架：Valdi</li>
<li>1.2 一键配置 Arch Linux 开发环境：HyDE</li>
<li>1.3 节省 Token 的数据格式：TOON</li>
<li>1.4 开源 AI 安全检测工具：Strix</li>
<li>1.5 AI 驱动的全网热点追踪助手：TrendRadar</li>
</ul>
</li>
<li>2. HelloGitHub 热评
<ul>
<li>2.1 极简的个人云相册平台：ChronoFrame</li>
<li>2.2 清爽的轻量级内容分享平台：Ech0</li>
</ul>
</li>
<li>3. 结尾</li>
</ul>
</li>
</ul>
<h2 data-id="heading-0">1. 热门开源项目</h2>
<h3 data-id="heading-1">1.1 跨平台原生性能的 UI 框架：Valdi</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a914cef871664dcdbe3c7b13ecd4eb59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764029963&amp;x-signature=OUWsZi3CyqChJMl%2FNeFnyoCU0B0%3D" alt="" loading="lazy"/></p>
<p><strong>主语言：C++、TypeScript</strong>，<strong>Star：9.8k</strong>，<strong>周增长：5.4k</strong></p>
<p>该项目是 Snapchat 团队开源的跨平台 UI 框架，支持使用 TypeScript 编写 UI 并直接编译为 iOS、Android 和 macOS 原生视图，不依赖 WebView 和 JavaScript 桥接，无需重新编译即可在毫秒内看到改动效果，并支持在 VSCode 中设置断点、检查变量、分析性能等功能，适用于追求原生性能体验的跨平台移动应用开发等场景。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Component</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'valdi_core/src/Component'</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloWorld</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Component</span> {
  <span class="hljs-title function_">onRender</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> message = <span class="hljs-string">'Hello World! 👻'</span>;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">backgroundColor</span>=<span class="hljs-string">'#FFFC00'</span> <span class="hljs-attr">padding</span>=<span class="hljs-string">{30}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">color</span>=<span class="hljs-string">'black'</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{message}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span></span>;
  }
}
</code></pre>
<blockquote>
<p>GitHub 地址→<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi" target="_blank" title="https://github.com/Snapchat/Valdi" ref="nofollow noopener noreferrer">github.com/Snapchat/Va…</a></p>
</blockquote>
<h3 data-id="heading-2">1.2 一键配置 Arch Linux 开发环境：HyDE</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15a5b50f3a8a4b879d830732299d970b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764029963&amp;x-signature=cJXzWmcdMw6A%2B3PMJ%2Bo1fxGkQyM%3D" alt="" loading="lazy"/></p>
<p><strong>主语言：Shell、Python</strong>，<strong>Star：7.1k</strong></p>
<p>该项目是为 Arch Linux 用户设计的 Hyprland 桌面环境一键安装脚本，内置主题管理和 Hyprland 窗口管理器，支持自动安装 NVIDIA 显卡驱动、开发环境和生成配置备份等功能。</p>
<blockquote>
<p>GitHub 地址→<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FHyDE-Project%2FHyDE" target="_blank" title="https://github.com/HyDE-Project/HyDE" ref="nofollow noopener noreferrer">github.com/HyDE-Projec…</a></p>
</blockquote>
<h3 data-id="heading-3">1.3 节省 Token 的数据格式：TOON</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/260441ae61254e1793d7154648574166~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764029963&amp;x-signature=Yge4BQAg125Xp0WbN4DR9BHcoGI%3D" alt="" loading="lazy"/></p>
<p><strong>主语言：TypeScript</strong>，<strong>Star：17k</strong>，<strong>周增长：3.5k</strong></p>
<p>这是一种专为 LLM 提示词设计的数据序列化格式，比 JSON 节省 30-60% 的 Token。它融合了 YAML 和 CSV 的特点，紧凑且容易理解。官方提供了 TypeScript SDK 和命令行工具，能够轻松将 JSON 数据转换为 TOON 格式。</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">context:</span>
  task: Our favorite hikes together
  location: Boulder
  season: spring_2025

friends[<span class="hljs-number">3</span>]: ana,luis,sam

hikes[<span class="hljs-number">3</span>]{id,name,distanceKm,elevationGain,companion,wasSunny}:
  <span class="hljs-number">1</span>,Blue Lake Trail,<span class="hljs-number">7.5</span>,<span class="hljs-number">320</span>,ana,<span class="hljs-literal">true</span>
  <span class="hljs-number">2</span>,Ridge Overlook,<span class="hljs-number">9.2</span>,<span class="hljs-number">540</span>,luis,<span class="hljs-literal">false</span>
  <span class="hljs-number">3</span>,Wildflower <span class="hljs-keyword">Loop</span>,<span class="hljs-number">5.1</span>,<span class="hljs-number">180</span>,sam,<span class="hljs-literal">true</span>
</code></pre>
<blockquote>
<p>GitHub 地址→<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftoon-format%2Ftoon" target="_blank" title="https://github.com/toon-format/toon" ref="nofollow noopener noreferrer">github.com/toon-format…</a></p>
</blockquote>
<h3 data-id="heading-4">1.4 开源 AI 安全检测工具：Strix</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72703cba0a3f473098ca741a92b43d45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764029963&amp;x-signature=UHRzB6NInn7QBl1J1fRfpj64xb0%3D" alt="" loading="lazy"/></p>
<p><strong>主语言：Python</strong>，<strong>Star：11k</strong>，<strong>周增长：2k</strong></p>
<p>这是一款基于 AI 的安全测试工具，可自动对应用进行安全测试的 AI Agent。它能够集成到 CI/CD 流程，实现自动拉取代码并启动应用，然后模拟黑客行为寻找隐藏漏洞，支持漏洞检测/复现、自动修复、生成报告等功能。</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">Install Strix</span>
pipx install strix-agent
<span class="hljs-meta prompt_">
# </span><span class="bash">Configure your AI provider</span>
export STRIX_LLM="openai/gpt-5"
export LLM_API_KEY="your-api-key"
<span class="hljs-meta prompt_">
# </span><span class="bash">Run your first security assessment</span>
strix --target ./app-directory
</code></pre>
<blockquote>
<p>GitHub 地址→<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fusestrix%2Fstrix" target="_blank" title="https://github.com/usestrix/strix" ref="nofollow noopener noreferrer">github.com/usestrix/st…</a></p>
</blockquote>
<h3 data-id="heading-5">1.5 AI 驱动的全网热点追踪助手：TrendRadar</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/320886c689424ca0aa05e1e239822de9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764029963&amp;x-signature=Ws5RKVUVfpghGA4q60Fqg7jFI%2Bk%3D" alt="" loading="lazy"/></p>
<p><strong>主语言：Python</strong>，<strong>Star：16k</strong>，<strong>周增长：10k</strong></p>
<p>这是一款开箱即用的热点资讯追踪助手，告别无效刷屏只看真正关心的新闻资讯。它基于 GitHub Actions 自动监控全网热点，支持 AI 智能分析可用自然语言提问。提供当日汇总、当前榜单、增量监控三种推送模式，可通过飞书、钉钉和邮件等方式将热点资讯推送至手机。</p>
<blockquote>
<p>GitHub 地址→<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsansan0%2FTrendRadar" target="_blank" title="https://github.com/sansan0/TrendRadar" ref="nofollow noopener noreferrer">github.com/sansan0/Tre…</a></p>
</blockquote>
<h2 data-id="heading-6">2. HelloGitHub 热评</h2>
<p>在此章节中，我们将为大家介绍本周 HelloGitHub 网站上的热门开源项目，我们不仅希望您能从中收获开源神器和编程知识，更渴望“听”到您的声音。欢迎您与我们分享使用这些<strong>开源项目的亲身体验和评价</strong>，用最真实反馈为开源项目的作者注入动力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd6daa5d9290475aae30046c3766deb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764029963&amp;x-signature=%2BrroLasnRistPhhHhXCpmlkGhDM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">2.1 极简的个人云相册平台：ChronoFrame</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/651f34adab144ed4abdaaee5fc454cda~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764029963&amp;x-signature=gq9PB%2F5FKNsgEA6%2F7Grvm%2BLPLOk%3D" alt="" loading="lazy"/></p>
<p><strong>主语言：Vue</strong></p>
<p>这是一款功能强大的自托管个人相册应用，专为展示与分享个人摄影作品而设计。它提供简洁易用的 Web 界面，可轻松管理和浏览照片，支持 Live Photo 与 Motion Photo 格式，并具备 EXIF 信息解析、地理位置识别和地图探索等功能。</p>
<blockquote>
<p>项目详情→<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Frepository%2FHoshinoSuzumi%2Fchronoframe" target="_blank" title="https://hellogithub.com/repository/HoshinoSuzumi/chronoframe" ref="nofollow noopener noreferrer">hellogithub.com/repository/…</a></p>
</blockquote>
<h3 data-id="heading-8">2.2 清爽的轻量级内容分享平台：Ech0</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2337901ecdfc4615821e69d7fb4f7d69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764029963&amp;x-signature=DhgvJsdqn%2FfkbG1RyyICyihKyvk%3D" alt="7" loading="lazy"/></p>
<p><strong>主语言：Go</strong></p>
<p>这是一款开源、自托管的轻量级内容发布平台，专注于思想流动和快速分享。它拥有简洁直观的操作界面，支持发布和分享想法、文字、图片和链接。同时，支持类似 ActivityPub 的联邦协议，实现不同实例（站点）之间的互联互通，让内容不再局限于单一孤立的网站。</p>
<blockquote>
<p>项目详情→<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Frepository%2Flin-snow%2FEch0" target="_blank" title="https://hellogithub.com/repository/lin-snow/Ech0" ref="nofollow noopener noreferrer">hellogithub.com/repository/…</a></p>
</blockquote>
<h2 data-id="heading-9">3. 结尾</h2>
<p>以上就是本期「GitHub 热点速览」的全部内容，希望这些开源项目能激发你的兴趣，帮助你找到下一个想要尝试的工具！如果你也发现了好玩、有趣的 GitHub 开源项目想要分享，欢迎来 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com" target="_blank" title="https://hellogithub.com" ref="nofollow noopener noreferrer">HelloGitHub</a> 与我们交流心得、讨论使用体验。</p>
<p><strong>往期回顾</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fn_junef2MC3GTV7leQy-Ww" target="_blank" title="https://mp.weixin.qq.com/s/n_junef2MC3GTV7leQy-Ww" ref="nofollow noopener noreferrer">DIY ChatGPT 一周狂揽 27k Star</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fh9QRvsP58MGhRyK8WfFxcg" target="_blank" title="https://mp.weixin.qq.com/s/h9QRvsP58MGhRyK8WfFxcg" ref="nofollow noopener noreferrer">终端里跑图形应用</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[详解React组件状态管理useState]]></title>    <link>https://juejin.cn/post/7573776814926315539</link>    <guid>https://juejin.cn/post/7573776814926315539</guid>    <pubDate>2025-11-18T00:20:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573776814926315539" data-draft-id="7568527869187997739" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="详解React组件状态管理useState"/> <meta itemprop="keywords" content="前端,React.js,JavaScript"/> <meta itemprop="datePublished" content="2025-11-18T00:20:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏多多"/> <meta itemprop="url" content="https://juejin.cn/user/747323639737191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            详解React组件状态管理useState
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/747323639737191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏多多
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T00:20:24.000Z" title="Tue Nov 18 2025 00:20:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><h2 data-id="heading-0">1. 前言</h2>
<p>在 React 的世界里，组件是构建用户界面的基石，而状态（state）则赋予了这些组件动态变化的能力。其中，useState作为 React 提供的一种强大的状态管理工具，极大地简化了函数式组件中的状态处理，成为了 React 开发者不可或缺的利器。本文将带你深入理解useState的工作原理、使用方法及常见场景，帮助你在 React 开发中更加得心应手地管理组件状态。</p>
<h2 data-id="heading-1">2. useState介绍</h2>
<p>useState是 React 提供的一个 Hook 函数，专门用于在函数式组件中添加状态。在 React 早期，状态管理主要依赖于类组件（class components），通过this.state来定义和管理状态。然而，类组件的语法相对复杂，代码结构不够简洁。React Hook 的出现改变了这一局面，useState让函数式组件也能轻松拥有状态管理能力，使得代码更加简洁、易读和维护。</p>
<h3 data-id="heading-2">2.1 基本语法</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> [state, setState] = <span class="hljs-title function_">useState</span>(initialState);
</code></pre>
<p>这里，useState接受一个参数initialState，即状态的初始值。它返回一个数组，数组的第一个元素state是当前状态的值，第二个元素setState是一个函数，用于更新状态。</p>
<p>举个简单的例子，创建一个计数器组件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState } <span class="hljs-keyword">from</span><span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 使用useState创建一个名为count的状态变量，初始值为0</span>
  <span class="hljs-comment">// setCount是用来更新count状态的函数</span>
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Count: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      {/* 点击按钮时调用setCount来更新count状态 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;Increment<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Counter</span>;
</code></pre>
<p>在这个例子中，count初始值为 0，当用户点击按钮时，setCount(count + 1)会将count的值加 1，并触发组件重新渲染，从而在页面上显示更新后的count值。</p>
<h3 data-id="heading-3">2.2. 动态设置初始状态</h3>
<p>initialState不仅可以是一个固定的值，还可以是一个函数。当initialState是函数时，这个函数只会在组件初始渲染时执行一次，其返回值作为状态的初始值。这种方式在初始状态需要通过复杂计算或依赖其他变量时非常有用。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 进行一些复杂计算</span>
  <span class="hljs-keyword">const</span> initialCount = <span class="hljs-title function_">someExpensiveComputation</span>();
  <span class="hljs-keyword">return</span> initialCount;
});
</code></pre>
<h3 data-id="heading-4">2.3. 更新状态的方式</h3>
<p>状态更新有好几种方式，可以根据需求采用不同的方式。</p>
<ul>
<li>直接更新</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">setCount</span>(<span class="hljs-number">5</span>);
</code></pre>
<p>这是最常见的方式，直接传入新的值给setState函数。这种方式会直接用新值替换当前的状态值。但在实际应用中，更多时候我们需要基于当前状态进行更新。</p>
<ul>
<li>基于前一个状态更新</li>
</ul>
<p>当更新状态依赖于前一个状态时，应该传入一个函数给setState。这个函数接受前一个状态作为参数，并返回新的状态值。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prevCount</span> =&gt;</span> prevCount + <span class="hljs-number">1</span>);
</code></pre>
<p>这种方式确保了状态更新是基于最新的状态，避免了在异步更新或多次连续更新时可能出现的问题。例如，在下面的代码中，如果连续调用setCount并传入固定值，可能无法得到预期的结果，如下错误示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 错误示例</span>
<span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);
<span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);
<span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);
</code></pre>
<p>因为 React 的状态更新是异步的，在这三次调用时，count的值可能还是初始值，最终只会更新一次，结果并非我们期望的增加了 3次。下面是一个正确示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 正确示例</span>
<span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prevCount</span> =&gt;</span> prevCount + <span class="hljs-number">1</span>);
<span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prevCount</span> =&gt;</span> prevCount + <span class="hljs-number">1</span>);
<span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prevCount</span> =&gt;</span> prevCount + <span class="hljs-number">1</span>);
</code></pre>
<p>React 会依次处理这些更新函数，确保每次更新都是基于前一个状态，最终count会正确地增加 3。</p>
<h2 data-id="heading-5">3. 组件渲染</h2>
<p>当调用setState更新状态时，React 会触发组件的重新渲染。在重新渲染过程中，useState会返回最新的状态值，组件会根据这些新值重新计算并更新 UI。</p>
<p>需要注意的是，React 的渲染机制是高效的，它会进行浅比较（shallow comparison）来判断是否需要真正更新 DOM。对于复杂数据类型（如对象和数组），如果直接修改内部属性而不改变其引用，React 可能无法检测到状态的变化，从而不会触发重新渲染。例如下面：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> [person, setPerson] = <span class="hljs-title function_">useState</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'John'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span> });

<span class="hljs-comment">// 错误方式，不会触发重新渲染</span>
person.<span class="hljs-property">age</span> = <span class="hljs-number">31</span>;
<span class="hljs-title function_">setPerson</span>(person);

<span class="hljs-comment">// 正确方式，通过创建新对象来更新状态</span>
<span class="hljs-title function_">setPerson</span>({...person, <span class="hljs-attr">age</span>: <span class="hljs-number">31</span> });
</code></pre>
<p>在更新对象或数组状态时，应该始终创建新的对象或数组，以确保 React 能够检测到状态变化并触发重新渲染。</p>
<h2 data-id="heading-6">4. 常见应用场景</h2>
<ul>
<li>表单处理</li>
</ul>
<p>在处理表单输入时，useState可以方便地管理输入值。例如，创建一个文本输入框组件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState } <span class="hljs-keyword">from</span><span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Input</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [inputValue, setInputValue] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChange</span> = (<span class="hljs-params">e</span>) =&gt; {
    <span class="hljs-title function_">setInputValue</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>);
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{inputValue}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleChange}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>You typed: {inputValue}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Input</span>;
</code></pre>
<p>在这个例子中，inputValue状态存储了输入框的值，每次输入框内容变化时，通过setInputValue更新状态，同时也更新了输入框的显示值。</p>
<ul>
<li>切换布尔状态</li>
</ul>
<p>useState也常用于切换布尔类型的状态，比如控制元素的显示与隐藏、按钮的选中状态等。以下是一个简单的开关按钮示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState } <span class="hljs-keyword">from</span><span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ToggleButton</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [isOn, setIsOn] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setIsOn</span>(!isOn);
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span>
      {isOn? 'ON' : 'OFF'}
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">ToggleButton</span>;
</code></pre>
<p>点击按钮时，setIsOn(!isOn)会取反isOn的状态，从而切换按钮的显示文本。</p>
<h2 data-id="heading-7">5. 常见面试要点</h2>
<ul>
<li><strong>同一个组件渲染多次会互相影响吗？</strong>
<ul>
<li>State 是组件实例内部的状态，隔离且私有的。如果你渲染同一个组件两次，每个组件都会有完全隔离的 state，改变其中一个不会影响另一个。</li>
</ul>
</li>
<li><strong>为什么要在setState中使用回调函数更新状态？</strong>
<ul>
<li>当状态更新依赖前一个状态时，此时值可能还是初始值。而使用回调函数能确保获取到最新的状态值进行更新，避免异步更新带来的问题。</li>
</ul>
</li>
<li><strong>如何正确更新对象或数组类型的状态？</strong>
<ul>
<li>通过创建新的对象或数组，使用展开运算符（...）等方式，确保状态的引用发生变化，从而触发 React 的重新渲染。</li>
</ul>
</li>
<li><strong>useState和类组件中的this.state有什么区别？</strong>
<ul>
<li>useState用于函数式组件，语法更简洁，基于 Hook 机制；而类组件中的this.state通过this.setState更新状态，语法相对复杂，还涉及生命周期函数等概念。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-8">6. 实现原理和仿写</h2>
<p>useState的实现原理与 React 的底层架构和运行机制紧密相关，具体实现如下：</p>
<ul>
<li>状态存储：在 React 内部，每个函数式组件都维护着一个状态链表。当组件首次渲染时，useState会将传入的initialState存入这个链表中。每调用一次useState，就会在链表中新增一个状态节点，并且useState返回对应的状态值和更新函数。比如在一个组件中多次使用useState分别管理不同状态，这些状态就会依次存入链表，彼此独立又有序关联 。其实，在 React 内部，为每个组件保存了一个数组，其中每一项都是一个 state 对。它维护当前 state 对的索引值，在渲染之前将其设置为 “0”。每次调用 useState 时，React 都会为你提供一个 state 对并增加索引值。</li>
<li>更新机制：当setState被调用时，React 并不会立即更新状态。而是会将更新任务放入一个队列中，等到合适的时机（如浏览器空闲时）进行批量处理。React 会根据更新的顺序找到状态链表中对应的状态节点，更新其值。更新完成后，React 会触发组件的重新渲染。在重新渲染过程中，useState会从状态链表中获取最新的状态值并返回，以便组件根据新值重新计算并更新 UI。</li>
<li>Fiber 架构：React 的更新机制基于Fiber架构，Fiber是一种数据结构，它为 React 带来了可中断和恢复的渲染能力。setState调用后，React 会基于Fiber进行调度和协调更新任务。这使得 React 在面对复杂交互场景和长时间运行任务时，能够合理分配渲染时间，避免主线程阻塞，提升应用的响应性能和用户体验。同时，Fiber架构也帮助 React 更高效地管理组件的更新过程，确保状态更新和重新渲染的准确性与稳定性。</li>
</ul>
<p>这个是官方的实现Demo，可以让我们了解 useState 在内部是如何工作的：<a href="https://link.juejin.cn?target=https%3A%2F%2Fzh-hans.react.dev%2Flearn%2Fstate-a-components-memory%23giving-a-component-multiple-state-variables" target="_blank" title="https://zh-hans.react.dev/learn/state-a-components-memory#giving-a-component-multiple-state-variables" ref="nofollow noopener noreferrer">传送门</a></p>
<h2 data-id="heading-9">6. 总结</h2>
<p>useState作为 React 函数式组件中状态管理的核心工具，为开发者提供了简洁而强大的状态处理能力。通过理解其基本用法、更新机制以及在常见场景中的应用，你可以更加高效地构建动态、交互式的 React 应用。而在项目中使用useState时，每个useState尽量只管理一个逻辑相关的状态，保持状态的单一职责。</p>
<hr/>
<blockquote>
<p>本次分享就到这儿啦，我是鹏多多，深耕前端的技术创作者，如果您看了觉得有帮助，欢迎评论，关注，点赞，转发，我们下次见~</p>
</blockquote>
<p>PS：在本页按F12，在console中输入document.getElementsByClassName('panel-btn')[0].click();有惊喜哦~</p>
<p><code>往期文章</code></p>
<ul>
<li><a href="https://juejin.cn/post/7568192652286754870" target="_blank" title="https://juejin.cn/post/7568192652286754870">纯前端提取图片颜色插件Color-Thief教学+实战完整指南</a></li>
<li><a href="https://juejin.cn/post/7565737512816771135" target="_blank" title="https://juejin.cn/post/7565737512816771135">react-konva实战指南：Canvas高性能+易维护的组件化图形开发实现教程</a></li>
<li><a href="https://juejin.cn/post/7560905838074462271" target="_blank" title="https://juejin.cn/post/7560905838074462271">React无限滚动插件react-infinite-scroll-component的配置+优化+避坑指南</a></li>
<li><a href="https://juejin.cn/post/7560542615484137491" target="_blank" title="https://juejin.cn/post/7560542615484137491">前端音频兼容解决：音频神器howler.js从基础到进阶完整使用指南</a></li>
<li><a href="https://juejin.cn/post/7559871680015024169" target="_blank" title="https://juejin.cn/post/7559871680015024169">使用React-OAuth进行Google/GitHub登录的教程和案例</a></li>
<li><a href="https://juejin.cn/post/7550585427834404927" target="_blank" title="https://juejin.cn/post/7550585427834404927">纯前端人脸识别利器：face-api.js手把手深入解析教学</a></li>
<li><a href="https://juejin.cn/post/7553865490732433462" target="_blank" title="https://juejin.cn/post/7553865490732433462">关于React父组件调用子组件方法forwardRef的详解和案例</a></li>
<li><a href="https://juejin.cn/post/7553484874609410074" target="_blank" title="https://juejin.cn/post/7553484874609410074">React跨组件数据共享useContext详解和案例</a></li>
<li><a href="https://juejin.cn/post/7545087762837815334" target="_blank" title="https://juejin.cn/post/7545087762837815334">Web图像编辑神器tui.image-editor从基础到进阶的实战指南</a></li>
<li><a href="https://juejin.cn/post/7544323659788288046" target="_blank" title="https://juejin.cn/post/7544323659788288046">开发个人微信小程序类目选择/盈利方式/成本控制与服务器接入指南</a></li>
<li><a href="https://juejin.cn/post/7541741121400864778" target="_blank" title="https://juejin.cn/post/7541741121400864778">前端图片裁剪Cropper.js核心功能与实战技巧详解</a></li>
<li><a href="https://juejin.cn/post/7536530451461472265" target="_blank" title="https://juejin.cn/post/7536530451461472265">编辑器也有邪修？盘点VS Code邪门/有趣的扩展</a></li>
<li><a href="https://juejin.cn/post/7535005018257981466" target="_blank" title="https://juejin.cn/post/7535005018257981466">js使用IntersectionObserver实现目标元素可见度的交互</a></li>
<li><a href="https://juejin.cn/post/7534547200330121225" target="_blank" title="https://juejin.cn/post/7534547200330121225">Web前端页面开发阿拉伯语种适配指南</a></li>
<li><a href="https://juejin.cn/post/7516122409948020736" target="_blank" title="https://juejin.cn/post/7516122409948020736">让网页拥有App体验？PWA 将网页变为桌面应用的保姆级教程PWA</a></li>
<li><a href="https://juejin.cn/post/6953803916484018206" target="_blank" title="https://juejin.cn/post/6953803916484018206">使用nvm管理node.js版本以及更换npm淘宝镜像源</a></li>
<li><a href="https://juejin.cn/post/7140443283209060383" target="_blank" title="https://juejin.cn/post/7140443283209060383">手把手教你搭建规范的团队vue项目，包含commitlint，eslint，prettier，husky，commitizen等等</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何将 MP4 文件转换为 M3U8 格式并实现流媒体播放]]></title>    <link>https://juejin.cn/post/7573525927793950746</link>    <guid>https://juejin.cn/post/7573525927793950746</guid>    <pubDate>2025-11-18T00:20:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573525927793950746" data-draft-id="7573519273030729774" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何将 MP4 文件转换为 M3U8 格式并实现流媒体播放"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-18T00:20:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="excel"/> <meta itemprop="url" content="https://juejin.cn/user/2911162520062862"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何将 MP4 文件转换为 M3U8 格式并实现流媒体播放
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2911162520062862/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    excel
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T00:20:18.000Z" title="Tue Nov 18 2025 00:20:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">引言</h3>
<p>在现代的流媒体传输中，<strong>HLS（HTTP Live Streaming）</strong> 协议因其高效、灵活的特点广泛应用于视频直播和点播。HLS 将视频文件分割成多个小的 <code>.ts</code>（MPEG-TS）片段，并通过 M3U8 播放列表来管理这些片段的加载顺序。本文将详细介绍如何将常见的 MP4 文件转换为 M3U8 格式，以及这一过程对流媒体播放带来的优势。</p>
<h3 data-id="heading-1">为什么需要 M3U8 和 HLS？</h3>
<p>HLS 协议与 M3U8 格式紧密结合，共同作用于流媒体播放。其主要优势体现在以下几个方面：</p>
<ol>
<li><strong>提高加载速度</strong>：传统视频需要一次性加载整个文件，等待缓冲后才可播放，而 HLS 使用 M3U8 文件将视频切割成多个短小的片段，可以逐片加载，播放更迅速。</li>
<li><strong>自适应流</strong>：HLS 支持根据用户的网络带宽动态选择视频分段的质量，这保证了不同网络条件下的流畅播放。</li>
<li><strong>容错性高</strong>：视频分段文件可以在网络中断的情况下从中断处继续播放，避免了重新加载整个视频的麻烦。</li>
<li><strong>广泛的兼容性</strong>：由于 HLS 基于 HTTP 协议，几乎所有现代浏览器和设备都能支持。</li>
</ol>
<h3 data-id="heading-2">如何将 MP4 转换为 M3U8 格式？</h3>
<p>将 MP4 文件转换为 M3U8 格式并生成多个视频片段的过程主要依赖于 <strong>FFmpeg</strong> 工具。以下是转换步骤：</p>
<h4 data-id="heading-3">步骤 1：安装 FFmpeg</h4>
<p>FFmpeg 是一个强大的多媒体处理工具，可以处理几乎所有视频格式的转换和流式传输。您可以在 FFmpeg 官网下载并安装该工具。</p>
<p><strong>Windows 安装命令</strong>：</p>
<ol>
<li>下载 <a href="https://link.juejin.cn?target=https%3A%2F%2Fffmpeg.org%2Fdownload.html" target="_blank" title="https://ffmpeg.org/download.html" ref="nofollow noopener noreferrer">FFmpeg</a> 安装包。</li>
<li>配置环境变量，确保在命令行中可以直接使用 <code>ffmpeg</code> 命令。</li>
</ol>
<p><strong>Linux 安装命令</strong>：</p>
<pre><code class="hljs language-sql" lang="sql">sudo apt <span class="hljs-keyword">update</span>
sudo apt install ffmpeg
</code></pre>
<h4 data-id="heading-4">步骤 2：将 MP4 转换为 M3U8</h4>
<p>使用以下命令将 MP4 文件转换为 M3U8 格式，并将视频切割成多个 <code>.ts</code> 片段：</p>
<pre><code class="hljs language-css" lang="css">ffmpeg -<span class="hljs-selector-tag">i</span> <span class="hljs-selector-tag">video</span><span class="hljs-selector-class">.mp4</span> -profile:v baseline -level <span class="hljs-number">3.0</span> -start_number <span class="hljs-number">0</span> -hls_time <span class="hljs-number">10</span> -hls_list_size <span class="hljs-number">0</span> -f hls output.m3u8
</code></pre>
<h5 data-id="heading-5">参数解析：</h5>
<ul>
<li><strong>-i video.mp4</strong>：输入文件为 <code>video.mp4</code>。</li>
<li><strong>-profile:v baseline -level 3.0</strong>：设置视频编码的兼容性，确保能够在低带宽设备上播放。</li>
<li><strong>-start_number 0</strong>：定义分段编号从 0 开始。</li>
<li><strong>-hls_time 10</strong>：设置每个 <code>.ts</code> 文件的时长为 10 秒（可以根据需求调整）。</li>
<li><strong>-hls_list_size 0</strong>：指定播放列表包含所有片段，不做限制。</li>
<li><strong>-f hls</strong>：指定输出格式为 HLS。</li>
<li><strong>output.m3u8</strong>：输出的播放列表文件名。</li>
</ul>
<p>执行后，您将得到一个 M3U8 播放列表文件（<code>output.m3u8</code>）和多个 <code>.ts</code> 文件（视频分片），比如：</p>
<pre><code class="hljs language-bash" lang="bash">output.m3u8       <span class="hljs-comment"># 播放列表</span>
output0.ts        <span class="hljs-comment"># 第一段视频</span>
output1.ts        <span class="hljs-comment"># 第二段视频</span>
output2.ts        <span class="hljs-comment"># 第三段视频</span>
...
</code></pre>
<h3 data-id="heading-6">3. 如何播放 M3U8 文件</h3>
<p>在转换完成后，您可以使用浏览器播放器播放这些视频。通过 <strong>HLS.js</strong> 库，您可以将 M3U8 文件与 HTML5 <code>&lt;video&gt;</code> 元素结合使用。</p>
<h4 data-id="heading-7">示例 HTML 播放器：</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">video</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"video"</span> <span class="hljs-attr">controls</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>您的浏览器不支持视频播放。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">video</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.jsdelivr.net/npm/hls.js@latest"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">var</span> video = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'video'</span>);
  <span class="hljs-keyword">var</span> hls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hls</span>();

  <span class="hljs-comment">// 如果浏览器支持 HLS.js</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Hls</span>.<span class="hljs-title function_">isSupported</span>()) {
    hls.<span class="hljs-title function_">loadSource</span>(<span class="hljs-string">'output.m3u8'</span>);
    hls.<span class="hljs-title function_">attachMedia</span>(video);
  }
  <span class="hljs-comment">// 如果浏览器原生支持 HLS</span>
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (video.<span class="hljs-title function_">canPlayType</span>(<span class="hljs-string">'application/vnd.apple.mpegurl'</span>)) {
    video.<span class="hljs-property">src</span> = <span class="hljs-string">'output.m3u8'</span>;
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>这段代码会自动加载并播放通过 M3U8 播放列表提供的视频片段。HLS.js 会确保播放器在不同网络条件下自动适应并加载合适的视频分段。</p>
<h3 data-id="heading-8">4. 分段加载的优势</h3>
<h4 data-id="heading-9">4.1 快速加载</h4>
<p>由于视频被切分为多个小的 <code>.ts</code> 文件，播放器可以在第一段加载完成后立即开始播放视频，而不需要等到整个视频文件下载完成。这样不仅加速了播放的启动时间，也提升了用户体验。</p>
<h4 data-id="heading-10">4.2 灵活的码率切换</h4>
<p>HLS 协议支持根据带宽的变化动态调整视频质量。如果用户的网络状况不佳，播放器可以自动选择低质量的视频流，从而避免缓冲或卡顿。这种自适应的流式传输方式大大提升了视频播放的稳定性。</p>
<h4 data-id="heading-11">4.3 网络容错性</h4>
<p>如果用户在观看过程中网络中断或连接不稳定，HLS 协议可以从断点处继续加载视频分片，而不需要从头开始加载整个视频。这样可以大大减少因网络波动带来的播放中断。</p>
<h4 data-id="heading-12">4.4 跨平台支持</h4>
<p>HLS 基于 HTTP 协议，支持各种平台，包括桌面浏览器、移动设备、智能电视等。而且，HLS.js 使得在不支持 HLS 原生播放的浏览器上也能正常播放 M3U8 格式的视频。</p>
<h3 data-id="heading-13">总结</h3>
<p>通过将 MP4 文件转换为 M3U8 格式，视频可以被切割成多个小片段，按需加载并顺序播放。使用 FFmpeg 工具进行转换，不仅操作简单，还能在 HLS 协议下提高流媒体播放的效率和容错能力。HLS 使得视频能够根据网络带宽自适应调整质量，同时提供更好的用户体验，尤其在实时直播和点播场景中表现尤为突出。</p>
<hr/>
<p>本文部分内容借助 AI 辅助生成，并由作者整理审核。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LiteLLM 快速入门]]></title>    <link>https://juejin.cn/post/7573528564026589230</link>    <guid>https://juejin.cn/post/7573528564026589230</guid>    <pubDate>2025-11-18T00:12:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573528564026589230" data-draft-id="7573525927793901594" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LiteLLM 快速入门"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-18T00:12:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="日习一技"/> <meta itemprop="url" content="https://juejin.cn/user/3913917125896190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LiteLLM 快速入门
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3913917125896190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    日习一技
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.1 初学乍练
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.1 初学乍练" title="VIP.1 初学乍练" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T00:12:25.000Z" title="Tue Nov 18 2025 00:12:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 AI 应用的开发过程中，开发者们往往面临一个共同的难题：如何高效地集成多家 LLM 服务商的接口？不同的服务商提供的 API 设计各不相同，OpenAI 有自己的风格，Anthropic 有另一套标准，Azure OpenAI、Google Vertex AI 又有各自的特色。每次需要切换服务商或支持多家模型时，开发者都要费力去学习和适配新的 API 规范，这无疑增加了开发成本和维护难度。</p>
<p>LiteLLM 正是为了解决这个问题而诞生的。它是一个开源的 Python 库，提供了一个统一的接口来调用 100+ 个 LLM 服务商的模型，无论是 OpenAI、Anthropic、Google、Cohere，还是国内的 DeepSeek、Qwen 等，都可以通过相同的 API 来调用。更强大的是，LiteLLM 不仅可以作为客户端 SDK 集成到你的应用中，还提供了一个功能丰富的 Proxy Server，可以用作 LLM Gateway 来统一管理和路由所有的 LLM 请求。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30f7f3e11fa143e88ac91fe4908ce77b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764029545&amp;x-signature=Pr3pIIXd9NhQdco%2FvY%2BN97W3kK0%3D" alt="icon.png" loading="lazy"/></p>
<p>这篇文章是我们 LiteLLM 学习系列的第一篇，今天就让我们一起快速上手 LiteLLM，了解它的核心特性和基本用法。</p>
<h2 data-id="heading-0">LiteLLM 概览</h2>
<p>LiteLLM 的核心价值主要体现在以下几个方面：</p>
<p><strong>统一的 API 接口</strong>：LiteLLM 将所有 LLM 服务商的 API 都转换为 OpenAI 的 API 格式，这意味着你只需要学习一套 API，就可以调用任何支持的模型。无论服务商更换、模型迭代，你的代码基本不需要改动。
<strong>完善的重试和容错机制</strong>：通过 Router 和 Fallback 功能，LiteLLM 支持在多个模型部署之间进行负载均衡和自动容错，当某个服务商出现故障时，可以自动切换到备用方案，确保服务的可用性。
<strong>成本追踪和预算管理</strong>：LiteLLM 可以自动计算每次 API 调用的成本，并支持设定每个用户或团队的预算限额，帮助企业更好地控制成本。
<strong>Proxy Server 网关</strong>：LiteLLM 提供的代理服务器可以作为一个中心化的 LLM 网关，统一处理认证、速率限制、成本追踪等问题，特别适合大型组织内部部署。</p>
<p>目前有<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2Fproject" target="_blank" title="https://docs.litellm.ai/docs/project" ref="nofollow noopener noreferrer">不少开源项目</a>使用了 LiteLLM，比如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhuggingface%2Fsmolagents" target="_blank" title="https://github.com/huggingface/smolagents" ref="nofollow noopener noreferrer">smolagents</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopeninterpreter%2Fopen-interpreter" target="_blank" title="https://github.com/openinterpreter/open-interpreter" ref="nofollow noopener noreferrer">Open Interpreter</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FQuivrHQ%2Fquivr" target="_blank" title="https://github.com/QuivrHQ/quivr" ref="nofollow noopener noreferrer">Quivr</a> 等：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7fdff3b5cc4a42bea25d60b051da705d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764029545&amp;x-signature=97o50TVnY%2F4PPTQ4QR9YY%2FCb7Qs%3D" alt="projects.png" loading="lazy"/></p>
<p>我们之前学习的 Surfsense、Mem0、Claude Code、Chat2Graph 等项目，都或多或少地有着 LiteLLM 的影子。</p>
<h2 data-id="heading-1">作为客户端 SDK 使用</h2>
<p>LiteLLM 最简单的使用方式就是作为 Python 客户端库，直接在你的应用中调用。首先安装依赖：</p>
<pre><code class="hljs language-bash" lang="bash">$ pip install litellm
</code></pre>
<h3 data-id="heading-2">基础调用</h3>
<p>下面是最基础的使用示例，调用 OpenAI 的 gpt-4o 模型：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> litellm <span class="hljs-keyword">import</span> completion
<span class="hljs-keyword">import</span> os

<span class="hljs-comment"># 设置 API Key（也可以通过环境变量设置）</span>
os.environ[<span class="hljs-string">"OPENAI_API_KEY"</span>] = <span class="hljs-string">"sk-xxx"</span>

<span class="hljs-comment"># 发送请求</span>
response = completion(
  model=<span class="hljs-string">"openai/gpt-4o"</span>,
  messages=[
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你好，请自我介绍一下"</span>}
  ]
)

<span class="hljs-comment"># 打印响应</span>
<span class="hljs-built_in">print</span>(response.choices[<span class="hljs-number">0</span>].message.content)
</code></pre>
<p>这里的 <code>model</code> 参数遵循 <code>provider/model_name</code> 的格式，LiteLLM 通过这个格式来识别应该用哪个服务商的 API。响应格式完全兼容 OpenAI 的 API，所以如果你之前用过 OpenAI SDK，会发现非常熟悉。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"chatcmpl-CWZUWaec9CC3vYyH5WlJN5LJ6tGxj"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"created"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1761878960</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"gpt-4o-2024-08-06"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"object"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"chat.completion"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"system_fingerprint"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"choices"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"finish_reason"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"stop"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"index"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"你好！我是一个由人工智能驱动的助手 ..."</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"assistant"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"tool_calls"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"function_call"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"usage"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"completion_tokens"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">68</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"prompt_tokens"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">13</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"total_tokens"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">81</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"completion_tokens_details"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"prompt_tokens_details"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"audio_tokens"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"cached_tokens"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"cache_creation_input_tokens"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"cache_read_input_tokens"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-3">丰富的模型支持</h3>
<p>LiteLLM 支持 100+ 个模型，包括：</p>
<ul>
<li><strong>商业模型</strong>：OpenAI、Anthropic、Google Gemini、Cohere、Mistral 等</li>
<li><strong>国内模型</strong>：DeepSeek、通义千问、智谱 GLM、百川、千帆 等</li>
<li><strong>本地模型</strong>：Ollama、Hugging Face、vLLM 等</li>
<li><strong>企业服务</strong>：Azure OpenAI、AWS Bedrock、Google Vertex AI 等</li>
</ul>
<p>这里是完整的模型供应商列表：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2Fproviders" target="_blank" title="https://docs.litellm.ai/docs/providers" ref="nofollow noopener noreferrer">docs.litellm.ai/docs/provid…</a></li>
</ul>
<p>例如，如果你想切换到 Claude，代码只需要改一行：</p>
<pre><code class="hljs language-python" lang="python">os.environ[<span class="hljs-string">"ANTHROPIC_API_KEY"</span>] = <span class="hljs-string">"sk-xxx"</span>

response = completion(
  model=<span class="hljs-string">"anthropic/claude-sonnet-4-20250514"</span>,
  messages=[
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你好，请自我介绍一下"</span>}
  ]
)
</code></pre>
<p>或者使用国内的 DeepSeek：</p>
<pre><code class="hljs language-python" lang="python">os.environ[<span class="hljs-string">"DEEPSEEK_API_KEY"</span>] = <span class="hljs-string">"sk-xxx"</span>

response = completion(
  model=<span class="hljs-string">"deepseek/deepseek-chat"</span>,
  messages=[
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你好，请自我介绍一下"</span>}
  ]
)
</code></pre>
<h3 data-id="heading-4">流式响应</h3>
<p>对于需要实时流式输出的应用（比如对话应用），LiteLLM 通过传入 <code>stream=True</code> 参数来支持流式响应：</p>
<pre><code class="hljs language-python" lang="python">response = completion(
  model=<span class="hljs-string">"openai/gpt-4o"</span>,
  messages=[
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"写一首关于春天的诗"</span>}
  ],
  stream=<span class="hljs-literal">True</span>
)

<span class="hljs-comment"># 逐块输出响应</span>
<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> response:
  content = chunk.choices[<span class="hljs-number">0</span>].delta.content
  <span class="hljs-keyword">if</span> content:
    <span class="hljs-built_in">print</span>(content, end=<span class="hljs-string">""</span>)
</code></pre>
<h3 data-id="heading-5">异步调用</h3>
<p>LiteLLM 也提供了异步 API <code>acompletion</code>，方便在异步框架中使用：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">from</span> litellm <span class="hljs-keyword">import</span> acompletion

<span class="hljs-comment"># 异步请求</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">chat</span>():
  response = <span class="hljs-keyword">await</span> acompletion(
    model=<span class="hljs-string">"openai/gpt-4o"</span>,
    messages=[
      {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你好，请自我介绍一下"</span>}
    ]
  )
  <span class="hljs-keyword">return</span> response

<span class="hljs-comment"># 运行异步函数</span>
response = asyncio.run(chat())
<span class="hljs-built_in">print</span>(response.choices[<span class="hljs-number">0</span>].message.content)
</code></pre>
<h3 data-id="heading-6">异常处理</h3>
<p>LiteLLM 会将所有服务商的异常都映射到 OpenAI 的异常类型，这样你就可以用统一的方式处理各种错误：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> openai.error <span class="hljs-keyword">import</span> APIError, RateLimitError
<span class="hljs-keyword">from</span> litellm <span class="hljs-keyword">import</span> completion

<span class="hljs-keyword">try</span>:
  response = completion(
    model=<span class="hljs-string">"openai/gpt-4o"</span>,
    messages=[{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你好"</span>}]
  )
<span class="hljs-keyword">except</span> RateLimitError:
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"请求过于频繁，请稍后重试"</span>)
<span class="hljs-keyword">except</span> APIError <span class="hljs-keyword">as</span> e:
  <span class="hljs-built_in">print</span>(<span class="hljs-string">f"API 错误: <span class="hljs-subst">{e}</span>"</span>)
</code></pre>
<p>关于异常映射的详细信息可参考下面的文档：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2Fexception_mapping" target="_blank" title="https://docs.litellm.ai/docs/exception_mapping" ref="nofollow noopener noreferrer">docs.litellm.ai/docs/except…</a></li>
</ul>
<h3 data-id="heading-7">丰富的接口支持</h3>
<p>除了 <code>completion</code> 文本补全接口，LiteLLM 还<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2Fsupported_endpoints" target="_blank" title="https://docs.litellm.ai/docs/supported_endpoints" ref="nofollow noopener noreferrer">兼容大量供应商的接口</a>，比如：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2Fassistants" target="_blank" title="https://docs.litellm.ai/docs/assistants" ref="nofollow noopener noreferrer">/assistants</a> - 兼容 OpenAI 的 Assistants API（目前已废弃，使用 Responses API 替代）</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2Faudio_transcription" target="_blank" title="https://docs.litellm.ai/docs/audio_transcription" ref="nofollow noopener noreferrer">/audio/transcriptions</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2Ftext_to_speech" target="_blank" title="https://docs.litellm.ai/docs/text_to_speech" ref="nofollow noopener noreferrer">/audio/speech</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2Fbatches" target="_blank" title="https://docs.litellm.ai/docs/batches" ref="nofollow noopener noreferrer">/batches</a> - 兼容 OpenAI 的批处理接口</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2Fcontainers" target="_blank" title="https://docs.litellm.ai/docs/containers" ref="nofollow noopener noreferrer">/containers</a> - 兼容 OpenAI 的容器管理接口，为代码解释器创建隔离的执行环境</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2Fcompletion" target="_blank" title="https://docs.litellm.ai/docs/completion" ref="nofollow noopener noreferrer">/chat/completion</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2Ftext_completion" target="_blank" title="https://docs.litellm.ai/docs/text_completion" ref="nofollow noopener noreferrer">/completions</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2Fbedrock_converse" target="_blank" title="https://docs.litellm.ai/docs/bedrock_converse" ref="nofollow noopener noreferrer">/converse</a> - 兼容 Amazon Bedrock 的会话接口</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2Fembedding%2Fsupported_embedding" target="_blank" title="https://docs.litellm.ai/docs/embedding/supported_embedding" ref="nofollow noopener noreferrer">/embeddings</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2Ffiles_endpoints" target="_blank" title="https://docs.litellm.ai/docs/files_endpoints" ref="nofollow noopener noreferrer">/files</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2Ffine_tuning" target="_blank" title="https://docs.litellm.ai/docs/fine_tuning" ref="nofollow noopener noreferrer">/fine_tuning</a> - 兼容 OpenAI 的模型微调接口</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2FgenerateContent" target="_blank" title="https://docs.litellm.ai/docs/generateContent" ref="nofollow noopener noreferrer">/generateContent</a> - 兼容 Google AI 的文本生成和多模交互接口</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2Fapply_guardrail" target="_blank" title="https://docs.litellm.ai/docs/apply_guardrail" ref="nofollow noopener noreferrer">/guardrails/apply_guardrail</a> - 调用内容审核接口</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2Fbedrock_invoke" target="_blank" title="https://docs.litellm.ai/docs/bedrock_invoke" ref="nofollow noopener noreferrer">/invoke</a> - 兼容 Amazon Bedrock 的会话接口</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2Fimage_edits" target="_blank" title="https://docs.litellm.ai/docs/image_edits" ref="nofollow noopener noreferrer">/images/edits</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2Fimage_generation" target="_blank" title="https://docs.litellm.ai/docs/image_generation" ref="nofollow noopener noreferrer">/images/generations</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2Fimage_variations" target="_blank" title="https://docs.litellm.ai/docs/image_variations" ref="nofollow noopener noreferrer">/image/variations</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2Fvideos" target="_blank" title="https://docs.litellm.ai/docs/videos" ref="nofollow noopener noreferrer">/videos</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2Fmcp" target="_blank" title="https://docs.litellm.ai/docs/mcp" ref="nofollow noopener noreferrer">/mcp</a> - 查看和调用 MCP 工具</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2Fanthropic_unified" target="_blank" title="https://docs.litellm.ai/docs/anthropic_unified" ref="nofollow noopener noreferrer">/v1/messages</a> - 兼容 Anthropic 的大模型对话接口</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2Fmoderation" target="_blank" title="https://docs.litellm.ai/docs/moderation" ref="nofollow noopener noreferrer">/moderations</a> - 兼容 OpenAI 的内容审核接口</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2Focr" target="_blank" title="https://docs.litellm.ai/docs/ocr" ref="nofollow noopener noreferrer">/ocr</a> - 兼容 Mistral 的 OCR API</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2Frealtime" target="_blank" title="https://docs.litellm.ai/docs/realtime" ref="nofollow noopener noreferrer">/realtime</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2Frerank" target="_blank" title="https://docs.litellm.ai/docs/rerank" ref="nofollow noopener noreferrer">/rerank</a> - 兼容 Cohere 的 Rerank API</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2Fresponse_api" target="_blank" title="https://docs.litellm.ai/docs/response_api" ref="nofollow noopener noreferrer">/responses</a> - 兼容 OpenAI 的 Responses API</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2Fsearch%2F" target="_blank" title="https://docs.litellm.ai/docs/search/" ref="nofollow noopener noreferrer">/search</a> - 兼容 Perplexity 的 Search API</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2Fvector_stores%2Fcreate" target="_blank" title="https://docs.litellm.ai/docs/vector_stores/create" ref="nofollow noopener noreferrer">/vector_stores</a> - 创建向量存储</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2Fvector_stores%2Fsearch" target="_blank" title="https://docs.litellm.ai/docs/vector_stores/search" ref="nofollow noopener noreferrer">/vector_stores/search</a> - 检索向量存储</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2Fpass_through%2Fintro" target="_blank" title="https://docs.litellm.ai/docs/pass_through/intro" ref="nofollow noopener noreferrer">其他透传接口</a></li>
</ul>
<h2 data-id="heading-8">作为 Proxy Server 使用</h2>
<p>除了作为 SDK 使用，LiteLLM 还提供了一个企业级的 <strong>代理服务器（Proxy Server）</strong>，可以作为一个 <strong>大模型网关（LLM Gateway）</strong> 来使用。这对于需要统一管理多个服务商、对接多个应用的场景特别有价值。</p>
<h3 data-id="heading-9">核心功能</h3>
<p>LiteLLM Proxy 主要有以下功能：</p>
<p><strong>多模型管理和负载均衡</strong>：可以配置多个模型和多个部署，Proxy 会自动进行负载均衡，分散请求到不同的模型部署，提高整体吞吐量。
<strong>密钥管理和成本追踪</strong>：为每个团队或用户生成虚拟 API Key，追踪每个 Key 的成本消耗，支持设定使用预算和速率限制。
<strong>统一的认证和授权</strong>：Proxy 可以作为中心化的认证层，所有应用通过它来访问 LLM 服务，避免将各种 API Key 散布在各个应用中。
<strong>可观测性和日志</strong>：支持与 Langfuse、Helicone、LunaryAI 等可观测平台集成，记录所有 API 调用的详细信息，便于监控和调试。</p>
<h3 data-id="heading-10">快速启动</h3>
<p>安装 Proxy 服务器需要额外的依赖：</p>
<pre><code class="hljs language-bash" lang="bash">$ pip install <span class="hljs-string">'litellm[proxy]'</span>
</code></pre>
<p>最简单的启动方式，只需一条命令：</p>
<pre><code class="hljs language-bash" lang="bash">$ litellm --model openai/gpt-4o

<span class="hljs-comment"># INFO: Uvicorn running on http://0.0.0.0:4000</span>
</code></pre>
<p>这样就启动了一个代理服务器，默认监听在 <code>4000</code> 端口上，直接浏览器打开可以看到它的 Swagger 文档页面，这里列出了 LiteLLM Proxy 的所有接口：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec37e10240904ed9a806dab89518f312~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764029545&amp;x-signature=lOSx8dh1ZmrEy4w4NFNtZA%2BE7DU%3D" alt="swagger.png" loading="lazy"/></p>
<blockquote>
<p>可以通过 <code>--port</code> 参数修改监听的端口。</p>
</blockquote>
<h3 data-id="heading-11">使用 Config.yaml 配置</h3>
<p>如果你想用其他模型或配置多个模型，可以使用配置文件。创建一个 <code>config.yaml</code> 文件来配置多个模型：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">model_list:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">model_name:</span> <span class="hljs-string">gpt-4o</span>
    <span class="hljs-attr">litellm_params:</span>
      <span class="hljs-attr">model:</span> <span class="hljs-string">openai/gpt-4o</span>
      <span class="hljs-attr">api_key:</span> <span class="hljs-string">os.environ/OPENAI_API_KEY</span>

  <span class="hljs-bullet">-</span> <span class="hljs-attr">model_name:</span> <span class="hljs-string">claude</span>
    <span class="hljs-attr">litellm_params:</span>
      <span class="hljs-attr">model:</span> <span class="hljs-string">anthropic/claude-sonnet-4-20250514</span>
      <span class="hljs-attr">api_key:</span> <span class="hljs-string">os.environ/ANTHROPIC_API_KEY</span>

  <span class="hljs-bullet">-</span> <span class="hljs-attr">model_name:</span> <span class="hljs-string">deepseek</span>
    <span class="hljs-attr">litellm_params:</span>
      <span class="hljs-attr">model:</span> <span class="hljs-string">deepseek/deepseek-chat</span>
      <span class="hljs-attr">api_key:</span> <span class="hljs-string">os.environ/DEEPSEEK_API_KEY</span>

<span class="hljs-attr">general_settings:</span>
  <span class="hljs-attr">master_key:</span> <span class="hljs-string">sk-1234</span>  <span class="hljs-comment"># 管理员密钥</span>
</code></pre>
<blockquote>
<p>完整的配置文件参数参考官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2Fproxy%2Fconfigs" target="_blank" title="https://docs.litellm.ai/docs/proxy/configs" ref="nofollow noopener noreferrer">docs.litellm.ai/docs/proxy/…</a></p>
</blockquote>
<p>然后用配置文件启动：</p>
<pre><code class="hljs language-bash" lang="bash">$ litellm --config config.yaml

<span class="hljs-comment"># INFO: Uvicorn running on http://0.0.0.0:4000</span>
</code></pre>
<h3 data-id="heading-12">调用 Proxy</h3>
<p>启动后，你可以通过 OpenAI SDK 或任何兼容 OpenAI API 的工具来调用 Proxy。Proxy 的 API 与 OpenAI 完全兼容，这意味着你可以无缝地将现有的 OpenAI 集成改为使用 LiteLLM Proxy。</p>
<p>使用 OpenAI Python SDK：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> openai

client = openai.OpenAI(
  api_key=<span class="hljs-string">"sk-1234"</span>,
  base_url=<span class="hljs-string">"http://127.0.0.1:4000"</span>
)

response = client.chat.completions.create(
  model=<span class="hljs-string">"gpt-4o"</span>,  <span class="hljs-comment"># 使用配置中的模型名</span>
  messages=[{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你好"</span>}]
)

<span class="hljs-built_in">print</span>(response.choices[<span class="hljs-number">0</span>].message.content)
</code></pre>
<p>使用 cURL：</p>
<pre><code class="hljs language-bash" lang="bash">$ curl -X POST <span class="hljs-string">'http://127.0.0.1:4000/chat/completions'</span> \
  -H <span class="hljs-string">'Authorization: Bearer sk-1234'</span> \
  -H <span class="hljs-string">'Content-Type: application/json'</span> \
  -d <span class="hljs-string">'{
    "model": "gpt-4o",
    "messages": [{"role": "user", "content": "你好"}]
  }'</span>
</code></pre>
<h3 data-id="heading-13">Docker 部署</h3>
<p>对于生产环境，LiteLLM 提供了<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.litellm.ai%2Fdocs%2Fproxy%2Fdeploy" target="_blank" title="https://docs.litellm.ai/docs/proxy/deploy" ref="nofollow noopener noreferrer">完整的 Docker 支持</a>。最简单的方式是使用 Docker Compose：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 下载 Docker Compose 配置</span>
$ curl -O https://raw.githubusercontent.com/BerriAI/litellm/main/docker-compose.yml

<span class="hljs-comment"># 创建 .env 文件设置必要的环境变量</span>
$ <span class="hljs-built_in">cat</span> &gt; .<span class="hljs-built_in">env</span> &lt;&lt;<span class="hljs-string">EOF
LITELLM_MASTER_KEY="sk-1234"
OPENAI_API_KEY="your-api-key"
EOF</span>

<span class="hljs-comment"># 启动服务</span>
$ docker compose up -d
</code></pre>
<p>或者直接使用 Docker 运行：</p>
<pre><code class="hljs language-bash" lang="bash">docker run \
  -v $(<span class="hljs-built_in">pwd</span>)/config.yaml:/app/config.yaml \
  -e OPENAI_API_KEY=<span class="hljs-string">"your-api-key"</span> \
  -p 4000:4000 \
  ghcr.io/berriai/litellm:main-stable \
  --config /app/config.yaml
</code></pre>
<h3 data-id="heading-14">Web UI 和管理界面</h3>
<p>此外，LiteLLM Proxy 还提供了一个管理后台，方便我们添加新的模型配置、查看调用日志、监控成本和使用情况等。启动 Proxy 之后，首次访问 <code>http://127.0.0.1:4000/ui</code> 进入登录页面：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73545e440cea459d84638bb8fc6fb5ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764029545&amp;x-signature=q%2BAY%2FqGeLvTGcI%2F7SqclqJ%2Bx6Js%3D" alt="login.png" loading="lazy"/></p>
<p>默认用户名为 <code>admin</code>，密码为 <code>config.yaml</code> 文件中配置的 <code>master_key</code>，默认就是 <code>sk-1234</code>，登录成功后即可进入管理界面：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6baee399e1d42a6935a0426fed7c98b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764029545&amp;x-signature=3bikqxtdfWskWl5%2BmMi9PcCkDoc%3D" alt="admin-ui.png" loading="lazy"/></p>
<p>可以在 <code>.env</code> 文件中通过 <code>UI_USERNAME</code> 和 <code>UI_PASSWORD</code> 修改管理员的用户名和密码：</p>
<pre><code class="hljs language-sh" lang="sh">UI_USERNAME=aneasystone
UI_PASSWORD=12345678
</code></pre>
<p>另外，对于不希望有管理后台的用户，可以通过 <code>DISABLE_ADMIN_UI</code> 参数关闭 Web UI 功能：</p>
<pre><code class="hljs language-sh" lang="sh">DISABLE_ADMIN_UI=True
</code></pre>
<h2 data-id="heading-15">小结</h2>
<p>这篇文章作为 LiteLLM 学习系列的开篇，我们快速了解了 LiteLLM 的核心特性和两种主要的使用方式：</p>
<ol>
<li><strong>作为 Python SDK</strong>：简单易用，适合快速集成和个人项目，只需几行代码就能调用任何模型；</li>
<li><strong>作为 Proxy Server</strong>：功能完整，适合企业级部署，可以统一管理多个模型，实现成本追踪、速率限制、虚拟 Key 管理等功能；</li>
</ol>
<p>LiteLLM 通过统一的 API 接口解决了多模型集成的复杂性问题，而 Proxy Server 则进一步提供了一个企业级的 LLM 网关解决方案。在后续的系列文章中，我们将深入探讨 LiteLLM 的高级功能，包括路由和负载均衡、成本追踪和预算管理的细节、与可观测性平台的集成等。</p>
<p>敬请期待！</p>
<h2 data-id="heading-16">欢迎关注</h2>
<p>如果这篇文章对您有所帮助，欢迎关注我的同名公众号：<a href="https://link.juejin.cn?target=https%3A%2F%2Fi-study-everyday.online%2Fabout-me.html" target="_blank" title="https://i-study-everyday.online/about-me.html" ref="nofollow noopener noreferrer">日习一技，每天学一点新技术</a>。</p>
<p>我会每天花一个小时，记录下我学习的点点滴滴。内容包括但不限于：</p>
<ul>
<li>某个产品的使用小窍门</li>
<li>开源项目的实践和心得</li>
<li>技术点的简单解读</li>
</ul>
<p>目标是让大家用5分钟读完就能有所收获，不需要太费劲，但却可以轻松获取一些干货。不管你是技术新手还是老鸟，欢迎给我提建议，如果有想学习的技术，也欢迎交流！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[EMQX：开源MQTT消息中间件王者，百万级物联网连接的首选引擎]]></title>    <link>https://juejin.cn/post/7573523709300621347</link>    <guid>https://juejin.cn/post/7573523709300621347</guid>    <pubDate>2025-11-18T00:52:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573523709300621347" data-draft-id="7537484912815947828" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="EMQX：开源MQTT消息中间件王者，百万级物联网连接的首选引擎"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-18T00:52:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="YL_jia"/> <meta itemprop="url" content="https://juejin.cn/user/1467226241383211"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            EMQX：开源MQTT消息中间件王者，百万级物联网连接的首选引擎
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1467226241383211/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    YL_jia
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T00:52:27.000Z" title="Tue Nov 18 2025 00:52:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">EMQX：开源MQTT消息中间件王者，百万级物联网连接的首选引擎</h2>
<blockquote>
<p>从车联网到工业4.0，解密全球部署超2万节点的消息基础设施</p>
</blockquote>
<h3 data-id="heading-1">引言：当万物互联遇见消息洪流</h3>
<p>2025年，某新能源车企<strong>50万辆智能汽车</strong>同时在线升级，每秒处理<strong>120万条</strong>车辆状态消息；某智慧城市项目需管理<strong>200万+物联网设备</strong>，日均消息量<strong>90亿条</strong>——这些数字背后，是<strong>传统消息中间件难以逾越的性能鸿沟</strong>。而<strong>EMQX</strong>作为全球领先的开源MQTT消息中间件，以<strong>单节点500万连接+毫秒级延迟+企业级高可用</strong>的卓越表现，成为物联网基础设施的核心支柱。本文将深入解析其技术架构，手把手教你构建亿级吞吐的消息处理平台。</p>
<hr/>
<h3 data-id="heading-2">一、EMQX核心优势：重新定义MQTT性能边界</h3>
<h4 data-id="heading-3">1. <strong>性能标杆：打破物理限制的消息引擎</strong></h4>



































<table><thead><tr><th><strong>指标</strong></th><th>传统MQTT Broker</th><th>EMQX 5.0</th><th>提升幅度</th></tr></thead><tbody><tr><td>单节点连接数</td><td>10万级</td><td><strong>500万+</strong></td><td>50倍</td></tr><tr><td>消息吞吐量</td><td>50万TPS</td><td><strong>1000万TPS</strong></td><td>20倍</td></tr><tr><td>端到端延迟</td><td>20ms</td><td><strong>&lt;1ms</strong></td><td>95%↓</td></tr><tr><td>集群节点数</td><td>10节点</td><td><strong>100+节点</strong></td><td>10倍</td></tr></tbody></table>
<p><em>数据来源：EMQX 5.0基准测试（32核/128GB环境）</em></p>
<h4 data-id="heading-4">2. <strong>分层架构解析</strong></h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[MQTT客户端] --&gt; B(接入层)
    B --&gt; C{路由层}
    C --&gt; D[节点1]
    C --&gt; E[节点2]
    D --&gt; F[数据持久化]
    E --&gt; F
    F --&gt; G[(后端服务)]
</code></pre>
<ul>
<li><strong>接入层</strong>：基于Erlang OTP的软实时系统，单连接内存低至5KB</li>
<li><strong>路由层</strong>：独创的<code>主题树+路由表</code>双索引，寻址效率提升300%</li>
<li><strong>持久化层</strong>：支持Kafka/Pulsar/RocketMQ等14种数据桥接</li>
</ul>
<h4 data-id="heading-5">3. <strong>企业级关键特性</strong></h4>
<ul>
<li><strong>零宕机升级</strong>：热代码加载实现业务无感更新</li>
<li><strong>全方位安全</strong>：
<ul>
<li>TLS 1.3加密传输</li>
<li>JWT/PSK认证</li>
<li>基于SQL的精细权限控制</li>
</ul>
</li>
<li><strong>百万级设备管理</strong>：
<ul>
<li>在线状态追踪</li>
<li>批量指令下发</li>
<li>连接画像分析</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-6">二、十五分钟极速部署：全场景安装指南</h3>
<h4 data-id="heading-7">1. <strong>Docker单节点部署（开发测试）</strong></h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动带Dashboard的EMQX</span>
docker run -d --name emqx \
  -p 1883:1883 -p 8083:8083 -p 8084:8084 -p 18083:18083 \
  -e EMQX_DASHBOARD__DEFAULT_USERNAME=admin \
  -e EMQX_DASHBOARD__DEFAULT_PASSWORD=public \
  emqx/emqx:5.4.1
</code></pre>
<p>访问Dashboard：<code>http://localhost:18083</code><br/>
<img alt="EMQX Dashboard截图转存失败，建议直接上传图片文件" src="" loading="lazy"/></p>
<h4 data-id="heading-8">2. <strong>Kubernetes生产集群部署</strong></h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># emqx-cluster.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">StatefulSet</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">emqx</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">serviceName:</span> <span class="hljs-string">emqx</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">emqx</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">emqx/emqx:5.4.1</span>
        <span class="hljs-attr">env:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">EMQX_CLUSTER__DISCOVERY_STRATEGY</span>
          <span class="hljs-attr">value:</span> <span class="hljs-string">k8s</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">EMQX_CLUSTER__K8S__APISERVER</span>
          <span class="hljs-attr">value:</span> <span class="hljs-string">"https://kubernetes.default.svc:443"</span>
        <span class="hljs-attr">ports:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">1883</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">mqtt</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8081</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">dashboard</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">emqx</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">ports:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">1883</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">mqtt</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">8081</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">dashboard</span>
  <span class="hljs-attr">clusterIP:</span> <span class="hljs-string">None</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">emqx</span>
</code></pre>
<h4 data-id="heading-9">3. <strong>千万级连接调优参数</strong></h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># emqx.conf 关键配置</span>
node {
  process_limit = 2097152    <span class="hljs-comment"># Erlang进程数</span>
  max_ports = 1048576        <span class="hljs-comment"># 最大端口数</span>
}

listeners.tcp.default {
  max_connections = 1000000  <span class="hljs-comment"># 单节点最大连接数</span>
  zone = external
}
</code></pre>
<hr/>
<h3 data-id="heading-10">三、企业级实战：四大物联场景深度解析</h3>
<h4 data-id="heading-11">案例1：智能网联汽车平台（50万车辆）</h4>
<p><strong>挑战</strong>：</p>
<ul>
<li>车辆在线率 &gt;99.99%</li>
<li>指令下发延迟 &lt;100ms</li>
<li>日均消息量80亿条</li>
</ul>
<p><strong>EMQX解决方案</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[车载终端] --&gt; B(EMQX边缘集群)
    B --&gt; C[区域中心]
    C --&gt; D[EMQX中心集群]
    D --&gt; E[大数据平台]
</code></pre>
<ol>
<li><strong>分层部署</strong>：
<ul>
<li>边缘节点：覆盖全国30个省份，处理实时控制消息</li>
<li>中心集群：汇聚数据至Hadoop生态</li>
</ul>
</li>
<li><strong>质量保障</strong>：
<ul>
<li>QoS2保证关键指令可靠传输</li>
<li>$SYS主题实时监控集群健康</li>
</ul>
</li>
<li><strong>成效</strong>：
<ul>
<li>远程升级成功率99.992%</li>
<li>紧急制动指令延迟&lt;50ms</li>
</ul>
</li>
</ol>
<h4 data-id="heading-12">案例2：智慧工厂设备监控（10万+传感器）</h4>
<p><strong>痛点</strong>：</p>
<ul>
<li>Modbus/OPC UA等多协议接入</li>
<li>实时预警响应&lt;200ms</li>
</ul>
<p><strong>架构设计</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 协议转换伪代码</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">opcua_to_mqtt</span>(<span class="hljs-params">node_data</span>):
    <span class="hljs-keyword">for</span> tag <span class="hljs-keyword">in</span> node_data:
        topic = <span class="hljs-string">f"factory/<span class="hljs-subst">{line_id}</span>/<span class="hljs-subst">{device_id}</span>/<span class="hljs-subst">{tag.name}</span>"</span>
        payload = json.dumps({<span class="hljs-string">"value"</span>: tag.value, <span class="hljs-string">"timestamp"</span>: time.time()})
        emqx.publish(topic, payload, qos=<span class="hljs-number">1</span>)
</code></pre>
<ol>
<li><strong>统一接入</strong>：
<ul>
<li>工业网关协议转换</li>
<li>消息统一入口：<code>factory/+/+/+</code></li>
</ul>
</li>
<li><strong>规则引擎处理</strong>：
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> 
  payload.temp <span class="hljs-keyword">as</span> temperature, 
  clientid 
<span class="hljs-keyword">FROM</span> 
  "factory/#" 
<span class="hljs-keyword">WHERE</span> 
  temperature <span class="hljs-operator">&gt;</span> <span class="hljs-number">85</span>   <span class="hljs-comment">--&gt; 触发冷却系统</span>
</code></pre>
</li>
<li><strong>成果</strong>：
<ul>
<li>设备故障发现速度提升10倍</li>
<li>每年避免停工损失$1200万</li>
</ul>
</li>
</ol>
<h4 data-id="heading-13">案例3：国家电网智能电表（200万终端）</h4>
<p><strong>需求</strong>：</p>
<ul>
<li>等保四级安全要求</li>
<li>数据采集完整性&gt;99.999%</li>
</ul>
<p><strong>安全架构</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[电表] --&gt;|PSK加密| B(EMQX)
    B --&gt;|TLS双向认证| C[Kafka]
    C --&gt; D[计费系统]
    B --&gt; E[审计日志]
</code></pre>
<ol>
<li><strong>安全加固</strong>：
<ul>
<li>设备证书预置</li>
<li>消息完整性校验</li>
</ul>
</li>
<li><strong>数据保障</strong>：
<ul>
<li>离线消息存储（最多72小时）</li>
<li>断网续传机制</li>
</ul>
</li>
<li><strong>成效</strong>：
<ul>
<li>通过国家电网安全认证</li>
<li>数据丢失率&lt;0.0001%</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-14">四、高阶应用：规则引擎与数据桥接</h3>
<h4 data-id="heading-15">1. 实时流处理示例</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> 
  payload.temperature <span class="hljs-keyword">as</span> temp,
  <span class="hljs-type">timestamp</span> <span class="hljs-keyword">as</span> ts,
  clientid 
<span class="hljs-keyword">FROM</span> 
  "sensor/#"
<span class="hljs-keyword">WHERE</span> 
  temp <span class="hljs-operator">&gt;</span> <span class="hljs-number">30</span> 
  <span class="hljs-keyword">AND</span> temp <span class="hljs-operator">-</span> <span class="hljs-keyword">last</span>(temp) <span class="hljs-operator">&gt;</span> <span class="hljs-number">5</span>   <span class="hljs-comment">-- 温度骤升检测</span>
</code></pre>
<h4 data-id="heading-16">2. 多数据源桥接配置</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 桥接至Kafka</span>
bridges.kafka {
  <span class="hljs-built_in">enable</span> = <span class="hljs-literal">true</span>
  servers = <span class="hljs-string">"kafka1:9092,kafka2:9092"</span>
  topic = <span class="hljs-string">"emqx_messages"</span>
  producer {
    key = <span class="hljs-string">"<span class="hljs-variable">${clientid}</span>"</span>  -- 按设备ID分区
  }
}
</code></pre>
<h4 data-id="heading-17">3. 设备联动规则</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 当温度&gt;30且湿度&lt;40%时开启空调</span>
rule {
  sql = <span class="hljs-string">"SELECT * FROM 'env/#' WHERE payload.temp&gt;30 AND payload.humidity&lt;40"</span>
  actions = [
    {
      <span class="hljs-keyword">function</span> = republish
      args = {
        topic = <span class="hljs-string">"cmd/air_conditioner/<span class="hljs-variable">${clientid}</span>/on"</span>
        payload = <span class="hljs-string">"{ \"power\": 1 }"</span>
      }
    }
  ]
}
</code></pre>
<hr/>
<h3 data-id="heading-18">五、性能调优：亿级消息场景实战</h3>
<h4 data-id="heading-19">1. 集群规模规划公式</h4>
<pre><code class="hljs language-scss" lang="scss">所需节点数 = 总连接数 / 单节点容量 × 冗余系数(<span class="hljs-number">1.3</span>)
单节点容量 = <span class="hljs-built_in">min</span>(CPU核心×<span class="hljs-number">50</span>万, 内存GB/<span class="hljs-number">0.02</span>)
</code></pre>
<h4 data-id="heading-20">2. 监控指标看板</h4>
<p><img alt="EMQX监控仪表盘转存失败，建议直接上传图片文件" src="" loading="lazy"/><br/>
关键指标：</p>
<ul>
<li><code>connections.count</code>：实时连接数</li>
<li><code>messages.rate</code>：消息吞吐速率</li>
<li><code>rule_engine.matched.rate</code>：规则触发频率</li>
</ul>
<h4 data-id="heading-21">3. 故障排查工具集</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看热点主题</span>
emqx_ctl topics list

<span class="hljs-comment"># 追踪客户端消息流</span>
emqx_ctl trace client <span class="hljs-string">"device_123"</span> <span class="hljs-string">"log/trace.log"</span>

<span class="hljs-comment"># 诊断网络瓶颈</span>
emqx_ctl observer
</code></pre>
<hr/>
<h3 data-id="heading-22">六、生态全景与未来演进</h3>
<h4 data-id="heading-23">EMQX 6.0技术前瞻：</h4>
<ol>
<li><strong>QUIC协议支持</strong>：弱网环境消息传输成功率提升300%</li>
<li><strong>流数据库集成</strong>：内置eKuiper实现边缘流处理</li>
<li><strong>WebAssembly扩展</strong>：安全运行用户自定义逻辑</li>
</ol>
<h4 data-id="heading-24">竞品对比矩阵：</h4>









































<table><thead><tr><th><strong>能力</strong></th><th>Mosquitto</th><th>HiveMQ</th><th><strong>EMQX</strong></th></tr></thead><tbody><tr><td>最大连接数</td><td>10万</td><td>50万</td><td><strong>500万+</strong></td></tr><tr><td>消息持久化</td><td>有限</td><td>企业版支持</td><td><strong>开箱即用</strong></td></tr><tr><td>规则引擎</td><td>无</td><td>基础</td><td><strong>类SQL完整</strong></td></tr><tr><td>集群扩展性</td><td>难扩展</td><td>商业方案</td><td><strong>原生支持</strong></td></tr><tr><td>协议扩展</td><td>MQTT only</td><td>插件扩展</td><td><strong>20+协议</strong></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-25">结语：物联网时代的消息基础设施</h3>
<p>EMQX用开源力量重塑了消息中间件的技术边界——从单机设备到国家级项目，从毫秒级车控指令到百亿级数据洪流。正如某全球车企CTO所言：“<strong>当50万车辆在暴雨天同时上报路况时，是EMQX的稳定性保障了我们的用户安全</strong>”。</p>
<blockquote>
<p><strong>立即体验</strong>：<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fdemo.emqx.io" target="_blank" title="https://demo.emqx.io" ref="nofollow noopener noreferrer">在线Demo</a> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Femqx%2Femqx" target="_blank" title="https://github.com/emqx/emqx" ref="nofollow noopener noreferrer">GitHub仓库</a></p>
</blockquote>
<p><strong>资源包下载</strong>：</p>
<ul>
<li>[生产部署检查清单]</li>
<li>[千万连接调优指南]</li>
<li>[物联网安全白皮书]</li>
</ul>
<p><strong>讨论话题</strong>：<br/>
👉 你在MQTT应用中遇到的最大挑战？<br/>
👉 最期待EMQX新增哪些边缘计算能力？</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在使用Windows系统，特别是Windows Update更新你的系统时，可能会遇到错误代码0x80070422。]]></title>    <link>https://juejin.cn/post/7573595009551712266</link>    <guid>https://juejin.cn/post/7573595009551712266</guid>    <pubDate>2025-11-18T00:54:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573595009551712266" data-draft-id="7567190160461004835" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在使用Windows系统，特别是Windows Update更新你的系统时，可能会遇到错误代码0x80070422。"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-11-18T00:54:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="搜罗万相"/> <meta itemprop="url" content="https://juejin.cn/user/4116175105041085"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在使用Windows系统，特别是Windows Update更新你的系统时，可能会遇到错误代码0x80070422。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4116175105041085/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    搜罗万相
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T00:54:26.000Z" title="Tue Nov 18 2025 00:54:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">在使用Windows系统，特别是Windows Update更新你的系统时，可能会遇到错误代码0x80070422。</h2>
<h3 data-id="heading-1">一.为什么会出现错误0x80070422</h3>
<p>错误代码0x80070422通常是因为Windows Update服务没有被启动或其相关的服务未能正常运行引起的。这可能是由于系统设置改变、病毒感染、或者是某些系统文件损坏等原因导致的。</p>
<h3 data-id="heading-2">解决方法一：检查Windows Update服务是否启动</h3>
<p>操作步骤：</p>
<ol>
<li>按下Win+R组合键打开"运行"对话框。</li>
<li>输入“services.msc”并按回车，打开服务面板。</li>
<li>在列表中找到 Windows Update 服务，双击进入属性。</li>
<li>如果服务状态为停止，请点击“启动”按钮。确保启动类型设置为“自动”。</li>
</ol>
<p>​<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c99ac8362364aefaf35e6d5d7db089e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pCc572X5LiH55u4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764032066&amp;x-signature=397pkV0x04vxGYvnWkRog3aALDU%3D" alt="alt text" loading="lazy"/>​</p>
<h3 data-id="heading-3">解决方法二：关闭网络地址转换</h3>
<p>操作步骤：</p>
<ol>
<li>按下Win+R组合键打开"运行"对话框。</li>
<li>输入"services.msc"并按回车，打开服务面板。</li>
<li>在列表中找到“网络连接共享（ICS）”服务，双击打开属性页面。</li>
<li>将启动类型设置为"禁用"，然后点击"停止"，最后点击"应用"和"确定”。</li>
</ol>
<h3 data-id="heading-4">解决方法三：第三方软件解决</h3>
<p>这个方法可能是最快的了，因为只要点击一键修复就行，推荐使用DirectX Repair增强版​。</p>
<p>可用于多个操作系统，如Windows XP、Windows Vista、Windows 7、Windows 8、Windows 8.1、Windows 8.1 Update、Windows 10、Windows 11，同时兼容32位操作系统和64位操作系统。本程序会根据系统的不同，自动调整任务模式，无需用户进行设置。</p>
<h4 data-id="heading-5">安装地址获取</h4>
<p>​<a href="https://link.juejin.cn?target=https%3A%2F%2Fpan.quark.cn%2Fs%2F055d2a1282c0%25E2%2580%258B" target="_blank" title="https://pan.quark.cn/s/055d2a1282c0%E2%80%8B" ref="nofollow noopener noreferrer">pan.quark.cn/s/055d2a128…</a></p>
<p>​<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6729740dc61340b39126dde17017737a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pCc572X5LiH55u4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764032066&amp;x-signature=4Za7MS1k2zOuDsK%2BHfJHwoiTgzo%3D" alt="image" loading="lazy"/>​</p>
<p>​<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a4c06f294bc49c982edcbcef2cafdfd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pCc572X5LiH55u4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764032066&amp;x-signature=PHGlFb4NB8oYFtLRfSjJO8QTTvk%3D" alt="alt text" loading="lazy"/>​</p>
<p>操作简单，点击修复就可以：</p>
<p>​<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5a77d2d905e4bd9b3ddb0358b939be9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pCc572X5LiH55u4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764032066&amp;x-signature=hbuhQK2VTPLHGfa96lrAGWzFECA%3D" alt="alt text" loading="lazy"/>​</p>
<h3 data-id="heading-6">解决方法四：执行系统文件检查工具</h3>
<p>操作步骤：</p>
<ol>
<li>在开始菜单搜索栏中输入"cmd"，右键点击命令提示符并选择"以管理员身份运行"。</li>
<li>在命令提示符窗口中输入"sfc /scannow"然后按回车，系统将开始扫描和修复损坏的系统文件。</li>
</ol>
<p>​<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a47b9bb8d3d46b3852fe0646df2d4fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pCc572X5LiH55u4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764032066&amp;x-signature=wZegGrl77hra4UJopKGrp6sbqws%3D" alt="alt text" loading="lazy"/>​</p>
<p>‍</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[电商大厂面试题解答与场景解析(二)]]></title>    <link>https://juejin.cn/post/7573587915809275945</link>    <guid>https://juejin.cn/post/7573587915809275945</guid>    <pubDate>2025-11-18T00:55:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573587915809275945" data-draft-id="7573776814926430227" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="电商大厂面试题解答与场景解析(二)"/> <meta itemprop="keywords" content="后端,面试,架构"/> <meta itemprop="datePublished" content="2025-11-18T00:55:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="360_go_php"/> <meta itemprop="url" content="https://juejin.cn/user/2436173498956695"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            电商大厂面试题解答与场景解析(二)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2436173498956695/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    360_go_php
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T00:55:21.000Z" title="Tue Nov 18 2025 00:55:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在电商大厂的技术面试中，面试官不仅考察候选人的理论基础，还要评估其解决实际问题的能力。以下是一些常见的技术面试题目和解答，希望能为正在面试的你提供帮助。</p>
<h4 data-id="heading-0">1. <strong>一个8G的服务器，堆的大小应该设置成多少？</strong></h4>
<p>   在设置堆大小时，通常会考虑以下几个因素：<br/>
- <strong>JVM的内存限制</strong>：通常，服务器上的总内存不宜超过80%-85%用于JVM堆，以确保操作系统和其他进程有足够的内存。因此，对于8G的服务器，可以将堆的最大值（<code>-Xmx</code>）设置为6.4G左右。<br/>
- <strong>新生代与老年代的比例</strong>：堆内存分为新生代（Young Generation）和老年代（Old Generation）。一般来说，默认情况下新生代的内存占堆内存的1/3，老年代占2/3。但可以根据实际应用的GC行为进行调整。<br/>
- <strong>实际应用场景</strong>：根据应用的内存需求，可能需要进行调优。</p>
<p>   <strong>建议设置</strong>：<br/>
- 最大堆大小：<code>-Xmx6g</code><br/>
- 初始堆大小：<code>-Xms4g</code>，避免JVM频繁扩展堆的大小。<br/>
</p>
<h4 data-id="heading-1">2. <strong>海量数据求频率最多的100个？</strong></h4>
<p>   处理海量数据时，可以采用以下方法来获取频率最多的100个数据：<br/>
- <strong>哈希表（HashMap）</strong>：用哈希表存储数据和其频率。每遇到一个数据，更新它的频率。这个方法简单高效，但对于海量数据，内存消耗较大。<br/>
- <strong>堆排序</strong>：使用一个最小堆（大小为100）来存储频率最高的100个数据。每当堆中元素超过100个时，删除最小的元素。这样可以在遍历完所有数据后得到频率最高的100个数据。<br/>
- <strong>外部排序</strong>：当数据量过大时，可以考虑将数据分割成多个块，分别计算每块的频率，然后将结果合并后进行最终的排序。</p>
<h4 data-id="heading-2">3. <strong>Spring一个事务中调用另外一个事务，另一个事务发生异常会怎么样？</strong></h4>
<p>   在Spring框架中，事务管理是通过声明式事务（<code>@Transactional</code>）来实现的。<br/>
- <strong>传播行为</strong>：如果一个事务方法调用另一个事务方法，并且第二个方法抛出异常，事务的行为取决于事务的传播属性（例如<code>Propagation.REQUIRED</code>）。默认情况下，Spring会将异常抛出并回滚外部事务。<br/>
- <strong>事务回滚</strong>：如果在方法A中调用方法B，并且方法B抛出未被捕获的异常，Spring会回滚方法A的事务，除非在<code>@Transactional</code>注解中明确指定不回滚。</p>
<h4 data-id="heading-3">4. <strong>一个父类加载器能不能加载一个子类加载器，为什么？</strong></h4>
<p>   - <strong>答案</strong>：不能。父类加载器只能加载父类及其父类的类，而不能加载子类及其子类的类。Java的类加载器遵循父委托模型，即子类加载器只能加载子类及子类的类，而父类加载器无法加载子类的类。<br/>
- <strong>原因</strong>：这主要是为了防止类的重复加载和确保类加载的层次结构。</p>
<h4 data-id="heading-4">5. <strong><code>select * from A where id in (select id from B)</code> 怎么优化？</strong></h4>
<p>   这类查询通常会导致性能问题，尤其是当表B的数据量很大时。可以考虑以下优化方案：<br/>
- <strong>使用JOIN替代子查询</strong>：<code>select A.* from A join B on A.id = B.id</code>。这种方式通常比<code>IN</code>更高效。<br/>
- <strong>索引优化</strong>：确保<code>A.id</code>和<code>B.id</code>字段有索引，这样可以加快查询的速度。<br/>
- **避免SELECT ***：仅查询需要的字段，避免浪费资源。</p>
<h4 data-id="heading-5">6. <strong>一个16G的内存堆分配多少，采用什么垃圾收集器，为什么用CMS不用G1，为什么？</strong></h4>
<p>   - <strong>堆内存分配</strong>：对于16G的堆内存，可以将初始堆大小（<code>-Xms</code>）和最大堆大小（<code>-Xmx</code>）设置为相同的值（如16G），以避免JVM动态调整堆内存的开销。<br/>
- <strong>垃圾收集器选择</strong>：  <br/>
- <strong>CMS（Concurrent Mark-Sweep）</strong>：适合低延迟的应用，特别是对响应时间敏感的应用。CMS垃圾收集器的优点是能在应用线程运行时进行垃圾回收，减少了停顿时间。<br/>
- <strong>G1（Garbage-First）</strong>：G1更适用于大内存堆的场景，能够提供更可预测的垃圾回收停顿时间，并且可以更好地管理大内存的回收。相较于CMS，G1更复杂，适用于大内存和需要更多控制的场景。<br/>
- <strong>为什么选择CMS而不是G1</strong>：CMS适用于低延迟场景，尤其是在较为稳定的内存使用下。而G1收集器相对较重，适用于大内存和长期运行的应用，但CMS可能在短期内表现得更为稳定。</p>
<h4 data-id="heading-6">7. <strong>多线程解析一个超大文件怎么处理，如果文件切分的时候关键信息被分到了不同的解析线程中怎么办？</strong></h4>
<p>   - <strong>多线程切分文件</strong>：可以使用<code>ExecutorService</code>来管理多线程，每个线程负责解析文件的一部分。<br/>
- <strong>关键信息处理</strong>：如果文件中的关键信息分布在不同的部分，可以采取两种策略：<br/>
- <strong>全局合并</strong>：在文件切分后，使用一个全局的合并步骤来处理关键信息。例如，通过共享数据结构来合并各个线程的结果。<br/>
- <strong>数据同步</strong>：使用<code>ThreadLocal</code>或线程安全的数据结构（如<code>ConcurrentHashMap</code>）来保证每个线程的解析结果不会被错误覆盖。</p>
<h4 data-id="heading-7">8. <strong>HashSet是如何判断两个对象相等的？</strong></h4>
<p>   - <strong>HashSet的实现</strong>：HashSet内部使用<code>HashMap</code>来存储元素，每个元素都会调用<code>hashCode()</code>方法来确定存储位置。<br/>
- <strong>判断相等</strong>：HashSet会通过<code>hashCode()</code>方法和<code>equals()</code>方法来判断两个对象是否相等。如果两个对象的<code>hashCode()</code>相同，再通过<code>equals()</code>方法检查它们的内容是否相等。</p>
<h4 data-id="heading-8">9. <strong>如何让两个对象相等？equals和hashCode这两个方法要怎么重写？</strong></h4>
<p>   - <strong><code>equals()</code>方法</strong>：判断两个对象是否相等。常见的实现步骤包括：<br/>
1. 比较对象的类型。<br/>
2. 比较对象的每个字段值。<br/>
- <strong><code>hashCode()</code>方法</strong>：返回对象的哈希值。根据<code>equals()</code>的实现，<code>hashCode()</code>的值应该根据对象的字段计算，确保相等的对象具有相同的哈希值。<br/>
- <strong>重写时的注意事项</strong>：如果重写<code>equals()</code>，则必须重写<code>hashCode()</code>，否则HashSet等容器无法正确工作。</p>
<h4 data-id="heading-9">10. <strong>Hash算法（面试官一直问为什么使用CMS或G1，为什么）</strong></h4>
<p>   面试官可能是希望你讲解<strong>哈希冲突处理</strong>。常见的哈希算法包括：<br/>
- <strong>拉链法（链表法）</strong>：当发生哈希冲突时，将冲突的元素存储在一个链表中。<br/>
- <strong>开放地址法</strong>：通过探测来寻找下一个空位存储冲突的元素（如线性探测、二次探测等）。<br/>
- <strong>质数取余法</strong>：使用质数对哈希值进行取余操作，以减少哈希冲突。</p>
<p>   如果面试官提到G1或CMS的选择，可能是想考察你对垃圾回收器选择的理解，如何根据具体场景做出合适的技术决策。</p>
<hr/>
<p>这些问题涉及了Java开发、数据库优化、并发编程等方面的知识，是大厂面试中常见的考察点。掌握这些知识点，能够帮助你更好地应对技术面试中的挑战。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【高斯泼溅】深度解析Three.js 加载3D Gaussian Splatting模型]]></title>    <link>https://juejin.cn/post/7573512056089886755</link>    <guid>https://juejin.cn/post/7573512056089886755</guid>    <pubDate>2025-11-18T00:55:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573512056089886755" data-draft-id="7573512056089870371" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【高斯泼溅】深度解析Three.js 加载3D Gaussian Splatting模型"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-18T00:55:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mapmost"/> <meta itemprop="url" content="https://juejin.cn/user/1679709496936343"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【高斯泼溅】深度解析Three.js 加载3D Gaussian Splatting模型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1679709496936343/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mapmost
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T00:55:47.000Z" title="Tue Nov 18 2025 00:55:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb6eebc9cdb44ebe80e902142a378e6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764032146&amp;x-signature=FmbUZ6ob0jnBJ1iRYurbIi3m4B8%3D" alt="" loading="lazy"/></p>
<p>在三维重建与实时渲染领域，3D Gaussian Splatting(以下简称 3DGS)成为近年来炙手可热的技术之一。本文将从<strong>开源框架解析</strong>出发，剖析其<strong>核心模块与思路。</strong></p>
<h2 data-id="heading-0">什么是3D Gaussian Splatting？</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2d03b6f5c1a41b9b0b708a6e1a117ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764032146&amp;x-signature=IK3%2BDmhRoZvAOcTALkEkI0YG%2BiU%3D" alt="" loading="lazy"/></p>
<p>简单来说，3DGS是一种将场景用大量**3D 高斯体(ellipsoids)**来表示的显式辐射场(Radiance Field)技术。</p>
<ul>
<li>每一个Gaussian(高斯体)具备：位置(x,y,z)、协方差矩阵(描述形状/方向/尺度)、颜色(RGB)、透明度(α)等属性。</li>
<li>渲染时，这些高斯体被 “splat”(散射／点绘)到屏幕空间：即每‐体在屏幕上投影为一个椭圆或模糊斑点，累加得出像素颜色与透明度。</li>
<li>与传统网格(三角形)或隐式神经表示(如NeRF)相比，3DGS在实时渲染、高保真Novel View Synthesis(新视角渲染)上具备显著优势。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e237163e8915491c99075efd63cc862a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764032146&amp;x-signature=%2FC9ie7vQA0ggb6ZILNgrG%2BycrcM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">核心模块与实现思路</h2>
<p>下面从架构与模块维度，拆解一个用<strong>Three.js框架加载以及渲染的过程</strong>，以理解其核心逻辑与在现代WebGL渲染体系中的落地方式。</p>
<h3 data-id="heading-2">1、数据输入与Scene初始化</h3>
<p>目前最常见的3DGS数据格式是<strong>点云文件(.PLY)<strong>或自定义的</strong>.SPLAT/.KSPLAT</strong> 。</p>
<p>加载的流程通常包括以下步骤：</p>
<ul>
<li>
<p><strong>解析输入数据：将每个点或点云块映射为Gaussian对象，包含属性：</strong></p>
</li>
<li>
<p>位置(Position)</p>
</li>
<li>
<p>协方差矩阵(Covariance，用于描述形状与方向)</p>
</li>
<li>
<p>颜色(RGB)</p>
</li>
<li>
<p>透明度(α)</p>
</li>
<li>
<p><strong>生成初始Buffer数据：为后续GPU上传准备好线性数组或结构化纹理。</strong></p>
</li>
</ul>
<h3 data-id="heading-3">2、渲染准备与排序体系</h3>
<p>在正式渲染之前，框架会执行一系列准备工作，用以保证透明度正确混合、绘制顺序合理及性能稳定。</p>
<p><strong>（1）距离计算</strong><br/>
每帧更新时，系统需计算Camera与每个Gaussian中心的距离(或深度Z值)，作为透明排序与LOD依据。</p>
<p><strong>（2）透明排序(Sorting)</strong><br/>
高斯体通常半透明(具有α通道)，因此绘制顺序直接影响最终颜色混合结果。常用做法：</p>
<ul>
<li>**CPU排序：**直接在 JS 层执行快速排序，适合中小场景；</li>
<li><strong>WASM+SIMD排序：</strong> 使用WASM模块进行距离排序，显著提升性能。</li>
</ul>
<p><strong>（3）剔除(Culling)</strong><br/>
通过视锥剔除、遮挡剔除或LOD简化去除不可见或贡献极低的 Gaussian，减少渲染压力。</p>
<p><strong>（4）GPU数据准备</strong><br/>
将属性(位置、协方差、颜色、透明度等)打包为：</p>
<ul>
<li><strong>InstancedBufferAttribute</strong></li>
<li><strong>Texture Buffer</strong></li>
</ul>
<p><strong>（5）实例化绘制(Instancing)</strong><br/>
GPU端批量绘制高斯体实例，通常“一次Draw调用”即可渲染成千上万个 Gaussian。</p>
<p><strong>（6）Shader细化</strong><br/>
在Vertex与Fragment Shader中完成以下逻辑：</p>
<ul>
<li>将Gaussian中心投影至屏幕空间；</li>
<li>根据协方差矩阵计算椭圆投影形状(Ellipsoid → Screen)；</li>
<li>按EWA(Elliptical Weighted Average)或近似算法进行加权混合；</li>
</ul>
<h3 data-id="heading-4">3、渲染主流程</h3>
<p>整体渲染逻辑可概括为以下步骤：</p>
<p><strong>（1）从Camera获取矩阵</strong></p>
<ul>
<li>提取<code>ViewMatrix</code>与<code>ProjectionMatrix</code>，传入Shader。</li>
</ul>
<p><strong>(2) 刷新可见列表</strong></p>
<ul>
<li>根据相机位置、可视范围及LOD策略，生成当前帧的可见Gaussian索引。</li>
</ul>
<p><strong>（3）上传属性Buffer</strong></p>
<ul>
<li>将Gaussian属性同步至GPU；</li>
<li>如数据无变化，则复用上一帧的Buffer以减少传输。</li>
</ul>
<p><strong>（4）执行绘制(Instanced Draw)</strong></p>
<ul>
<li>调用<code>drawArraysInstanced</code>或<code>drawElementsInstanced</code>；</li>
<li>在Shader中计算每个Gaussian的屏幕椭圆投影并进行混合。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1a0fc787d2a447b8f9d5f5b4f04e0a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764032146&amp;x-signature=7nigQFVd8Vma8WmIAm86E1Qq%2Bds%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">Mapmost的支持</h2>
<p><strong>Mapmost SDK for WebGL</strong>本身是一个<strong>高性能的地理三维可视化引擎</strong>，通过参考<strong>Three.js的3DGS渲染实现</strong>，在其原有的地理场景管理和GPU渲染框架基础上，<strong>扩展了对3DGS数据的加载与渲染支持</strong>。</p>
<p>具体来说，框架在加载阶段解析<code>.PLY</code>或<code>.SPLAT</code>文件，将点云数据转换为高斯体对象，并构建GPU Buffer；同时利用<strong>WASM模块加速相机空间距离计算与透明度排序</strong>，确保<strong>在高密度点云下仍能保持正确的深度混合</strong>。</p>
<p>在GPU渲染阶段，框架通过<strong>Instanced Draw批量绘制上百万个高斯体</strong>，Shader层实现<strong>EWA投影与α混合</strong>，呈现出柔和连续的体积光照与真实的景深效果。<br/>
这一改进使得<strong>Mapmost SDK能够在WebGL环境中实现与Three.js同级的3DGS实时渲染性能，<strong>同时兼具</strong>地理坐标体系与多源数据管理能力</strong>，为地理级3D重建与在线渲染提供了完整支持。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7136b4e8388c456bb1f1463d3f46366d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764032146&amp;x-signature=SH4sqb%2FcSTn7xCqa49WR2RYEJDw%3D" alt="" loading="lazy"/></p>
<p><em>加载效果</em></p>
<p>申请试用，请至<a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fwww.mapmost.com%2F%2523%2F" target="_blank" title="https://link.zhihu.com/?target=https%3A//www.mapmost.com/%23/" ref="nofollow noopener noreferrer">Mapmost</a>官网联系客服</p>
<p>**特别预告：**Mapmost Model Online 在线体验版 ，11月上线倒计时～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[某电商大厂场景面试相关的技术文章]]></title>    <link>https://juejin.cn/post/7573776814926479379</link>    <guid>https://juejin.cn/post/7573776814926479379</guid>    <pubDate>2025-11-18T00:57:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573776814926479379" data-draft-id="7573525634213445675" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="某电商大厂场景面试相关的技术文章"/> <meta itemprop="keywords" content="后端,面试,架构"/> <meta itemprop="datePublished" content="2025-11-18T00:57:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="360_go_php"/> <meta itemprop="url" content="https://juejin.cn/user/2436173498956695"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            某电商大厂场景面试相关的技术文章
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2436173498956695/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    360_go_php
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T00:57:28.000Z" title="Tue Nov 18 2025 00:57:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在某些电商大厂的面试中，技术面试不仅涉及编码能力的考察，还包括了对系统设计、性能优化、算法分析等方面的深度了解。今天，我们将讨论一些常见的技术应用场景和问题，涵盖JVM调优、垃圾回收、并发处理等方面。</p>
<h4 data-id="heading-0">1. 四个引用的具体应用场景</h4>
<p>在Java中，对象引用分为四种类型：强引用、软引用、弱引用和虚引用。它们在不同的应用场景中具有重要作用：</p>
<ul>
<li><strong>强引用</strong>：最常见的引用类型，只有强引用的对象会被垃圾回收器回收。在正常的开发中，如果一个对象有强引用，它就不会被回收。例如：<code>Object obj = new Object();</code></li>
<li><strong>软引用</strong>：适用于缓存机制，当内存不足时，软引用对象会被回收。例如：缓存大数据时，可以使用软引用来存储缓存数据。只有在JVM内存紧张时，软引用的对象才会被回收。</li>
<li><strong>弱引用</strong>：弱引用的对象在下一次垃圾回收时会被回收。适合应用于系统缓存中的一些临时对象，避免内存泄漏。例如：引用一些不需要长时间存活的对象，如会话信息。</li>
<li><strong>虚引用</strong>：虚引用用于追踪对象的垃圾回收过程，几乎不用于实际开发，只在一些底层应用中使用，比如用来实现对象的清理操作。</li>
</ul>
<h4 data-id="heading-1">2. 垃圾回收器具体应用场景</h4>
<p>垃圾回收器的主要任务是自动回收不再使用的内存，Java的垃圾回收器根据应用场景不同有不同的选择：</p>
<ul>
<li><strong>Serial垃圾回收器</strong>：适用于单核小型应用，它的停顿时间比较长，但实现简单。</li>
<li><strong>Parallel垃圾回收器</strong>：适用于多核机器，适合高吞吐量的场景，如大数据处理系统，能够并行化回收。</li>
<li><strong>CMS垃圾回收器</strong>：适用于低延迟系统，常用于电商网站和金融行业等对响应时间有较高要求的场景。</li>
<li><strong>G1垃圾回收器</strong>：适用于大内存应用，能够在大数据量的情况下提供较好的延迟控制，常用于需要大堆内存和低延迟的场景，如大规模电商平台。</li>
</ul>
<h4 data-id="heading-2">3. 可达性分析算法具体应用场景</h4>
<p>可达性分析算法主要用于确定哪些对象是可以到达的，也就是哪些对象是活跃的，需要被保留。通常用于垃圾回收的标记阶段。以下是一些应用场景：</p>
<ul>
<li><strong>GC标记阶段</strong>：在执行垃圾回收时，JVM会使用可达性分析算法来找出所有从GC Root可达的对象。这是垃圾回收的一部分。</li>
<li><strong>内存泄漏检测</strong>：如果一个对象不再被任何可达路径引用，但仍然存在内存中，可能会导致内存泄漏，使用可达性分析可以帮助发现这种情况。</li>
</ul>
<h4 data-id="heading-3">4. 垃圾回收器参数调优（并发低延时）</h4>
<p>在某些高并发且要求低延时的应用场景中，需要对垃圾回收器进行调优：</p>
<ul>
<li><strong>G1垃圾回收器</strong>：使用<code>-XX:+UseG1GC</code>开启G1垃圾回收器，并通过<code>-XX:MaxGCPauseMillis</code>来限制最大GC停顿时间。例如，<code>-XX:MaxGCPauseMillis=200</code> 表示最大停顿时间为200毫秒。</li>
<li><strong>CMS调优</strong>：使用<code>-XX:+UseConcMarkSweepGC</code>开启CMS垃圾回收器，<code>-XX:CMSInitiatingOccupancyFraction</code>用于设置触发并发标记清除的内存占用百分比，适合在高并发场景下优化延迟。</li>
<li><strong>调优堆大小</strong>：<code>-Xmx</code>和<code>-Xms</code>参数设置JVM堆内存的大小，可以根据实际应用来进行调整，避免堆内存过小导致频繁GC，或者过大导致内存浪费。</li>
</ul>
<h4 data-id="heading-4">5. 高并发多连接JVM线程池参数调优</h4>
<p>高并发应用中的线程池调优至关重要，以下是常见的调优策略：</p>
<ul>
<li><strong>线程池大小</strong>：根据CPU核数和任务的CPU密集型/IO密集型性质来设置线程池大小。通常，CPU密集型任务的线程池大小为<code>CPU核心数 + 1</code>，IO密集型则可以适当增大。</li>
<li><strong>核心线程数和最大线程数</strong>：<code>ThreadPoolExecutor</code>的<code>corePoolSize</code>和<code>maximumPoolSize</code>应根据业务负载来调整，核心线程数可以适当增加，但最大线程数要控制，防止过多线程导致系统过载。</li>
<li><strong>队列大小</strong>：如果系统承受高并发时任务提交的负载，可以使用<code>LinkedBlockingQueue</code>作为队列，避免直接抛弃任务。</li>
</ul>
<h4 data-id="heading-5">6. 高并发系统调优</h4>
<p>高并发系统调优通常涉及多个层面，包括数据库、JVM、线程池、缓存等。常见的优化方法包括：</p>
<ul>
<li><strong>数据库连接池优化</strong>：调整连接池大小，避免过多的数据库连接阻塞。可以使用<code>HikariCP</code>等高性能连接池。</li>
<li><strong>异步请求处理</strong>：对于长时间执行的任务，可以考虑异步执行，通过消息队列异步处理，减少主线程的阻塞。</li>
<li><strong>缓存优化</strong>：利用Redis或Memcached等缓存机制来减少数据库访问，提升响应速度。</li>
<li><strong>请求限流</strong>：使用令牌桶或漏桶算法来限制请求流量，避免高并发请求导致的系统过载。</li>
</ul>
<h4 data-id="heading-6">7. 队列与栈的应用场景</h4>
<ul>
<li><strong>队列</strong>：先进先出（FIFO）结构，适用于任务调度、消息队列、处理任务队列等场景。例如：生产者-消费者问题、异步任务处理等。</li>
<li><strong>栈</strong>：后进先出（LIFO）结构，适用于递归调用、括号匹配、表达式求值等场景。例如：函数调用栈、深度优先搜索（DFS）等。</li>
</ul>
<h4 data-id="heading-7">8. 点赞高并发怎么办？</h4>
<p>在高并发点赞系统中，采用以下优化策略：</p>
<ul>
<li><strong>使用缓存</strong>：将点赞数据保存在Redis等内存数据库中，减少数据库的访问。</li>
<li><strong>异步更新</strong>：点赞操作可以先写入队列，后端异步处理更新数据库。</li>
<li><strong>分布式锁</strong>：防止重复点赞时发生数据不一致，可以使用分布式锁，如Redis分布式锁。</li>
</ul>
<h4 data-id="heading-8">9. 消息中间件用过么？怎么自己设计一个消息中间件？</h4>
<p>消息中间件的设计需要考虑以下几个方面：</p>
<ul>
<li><strong>消息队列</strong>：设计一个消息队列系统，支持消息的异步传输。</li>
<li><strong>持久化机制</strong>：保证消息不会丢失，即使在系统崩溃时也能够恢复消息。</li>
<li><strong>消费者机制</strong>：设计多个消费者处理消息，支持消息的并发消费。</li>
<li><strong>可靠性和高可用性</strong>：实现消息确认机制，保证消息可靠传递。</li>
</ul>
<h4 data-id="heading-9">10. 假设catch，finally，catch中有return，那么finally还会不会执行？</h4>
<p><code>finally</code>块中的代码会在<code>try</code>或<code>catch</code>执行后执行，无论是否有<code>return</code>。但是，如果<code>catch</code>中有<code>return</code>，<code>finally</code>块的执行不会被跳过。</p>
<h4 data-id="heading-10">11. 假设1亿的11位的手机号，运行空间128M，如果要进行排序，那么要怎么设计？</h4>
<p>对于大量数据（例如1亿个手机号），采用外部排序方法比较合适：</p>
<ul>
<li><strong>分块排序</strong>：将1亿条手机号分成多个小块，每块数据可以放入内存中进行排序。</li>
<li><strong>归并排序</strong>：对每块数据进行排序后，使用归并排序将所有块的数据合并到一起，最终得到全局有序的数据。</li>
</ul>
<p>通过将数据分块存储和排序，可以有效减少内存消耗，并实现排序功能。</p>
<hr/>
<p>这篇文章介绍了在面试中可能遇到的几个典型场景和相关技术应用，希望能够帮助你在面试中表现出色。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Angular v21 无 Zone 模式前瞻：新特性、性能提升与迁移方案]]></title>    <link>https://juejin.cn/post/7573511426868674579</link>    <guid>https://juejin.cn/post/7573511426868674579</guid>    <pubDate>2025-11-17T22:57:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573511426868674579" data-draft-id="7573511426868658195" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Angular v21 无 Zone 模式前瞻：新特性、性能提升与迁移方案"/> <meta itemprop="keywords" content="前端,JavaScript,Angular.js"/> <meta itemprop="datePublished" content="2025-11-17T22:57:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Moment"/> <meta itemprop="url" content="https://juejin.cn/user/3782764966460398"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Angular v21 无 Zone 模式前瞻：新特性、性能提升与迁移方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3782764966460398/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Moment
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T22:57:49.000Z" title="Mon Nov 17 2025 22:57:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>最近在使用 NestJs 和 NextJs 在做一个协同文档 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxun082%2FDocFlow" target="_blank" title="https://github.com/xun082/DocFlow" ref="nofollow noopener noreferrer">DocFlow</a>，如果感兴趣，欢迎 star，有任何疑问，欢迎加我微信进行咨询 <code>yunmz777</code></p>
<p>如果说 Signals 是 Angular 的"顿悟"时刻，那么无 Zone（Zoneless）则是"这感觉真流畅"的时刻。在 Angular v21 中，新应用默认使用无 Zone 的变更检测方式，这意味着不再有 Zone.js 在幕后运行——只有通过 Signals 实现的明确、可预测的响应式编程。</p>
<p>简而言之：告别 Zone.js，迎来更小的包体积、更清晰的堆栈追踪，以及仅在您指定时（通过 Signals 和事件）更新的变更检测。</p>
<h2 data-id="heading-0">什么是无 Zone 模式？</h2>
<p>从历史上看，Angular 使用 Zone.js 来修补异步 API（如定时器、事件、Promises）并自动触发变更检测。这种方式虽然方便，但有时会过于积极，导致不必要的检查。</p>
<p>无 Zone 模式完全移除了 Zone.js，转而依赖 Signals 和模板事件来确定何时更新 UI。这意味着：</p>
<ul>
<li>变更检测只在明确需要时触发（Signals 变化、输入变化、模板事件）</li>
<li>不再有全局的异步操作监听</li>
<li>更少的运行时开销，更好的性能表现</li>
</ul>
<p>结果是更少的工作量、更少的意外情况，以及更好的性能。</p>
<h2 data-id="heading-1">v21 的新特性</h2>
<h3 data-id="heading-2">新项目默认采用无 Zone 模式</h3>
<p>v20.2 稳定了该 API（<code>provideZonelessChangeDetection()</code>），而 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fangular%2Fangular%2Fpull%2F63382" target="_blank" title="https://github.com/angular/angular/pull/63382" ref="nofollow noopener noreferrer">PR #63382</a> 使其成为 <code>ng new</code> 的默认设置。现有应用可以通过一行提供者代码选择加入。</p>
<h3 data-id="heading-3">更清洁的构建</h3>
<p>在无 Zone 模式下，您的包中不再包含 Zone.js，这意味着：</p>
<ul>
<li>更小的包体积（减少约 30KB）</li>
<li>更清晰的堆栈追踪</li>
<li>更少的运行时开销</li>
</ul>
<h3 data-id="heading-4">SSR 和错误处理已就绪</h3>
<p>在迈向无 Zone 的过程中，Angular 添加了强大的错误处理程序和 SSR 钩子，因此默认设置已可用于生产环境。</p>
<blockquote>
<p>注意：v20.2 正式将无 Zone 提升为稳定版。v21 是第一个将其作为新应用默认设置的主要版本。</p>
</blockquote>
<h2 data-id="heading-5">是否需要迁移现有应用？</h2>
<p>简短回答：是的，建议计划迁移。您可能会看到更少的不必要检查和更流畅的思维模型——特别是如果您已经在使用 Signals。</p>
<h3 data-id="heading-6">迁移带来的收益</h3>
<ul>
<li>
<p>可预测性：变更检测在输入、Signals 或事件更改时运行，而不是"每当某处发生任何异步操作时"。您可以清楚地知道何时会触发变更检测。</p>
</li>
<li>
<p>性能提升：减少过度检查，减少修补操作带来的开销。应用运行更流畅，响应更快。</p>
</li>
<li>
<p>开发体验：更清晰的堆栈追踪，减少"这个变更检测从哪里来的？"这类困惑。调试更容易，问题定位更准确。</p>
</li>
</ul>
<h2 data-id="heading-7">迁移指南</h2>
<h3 data-id="heading-8">步骤 1：移除 Zone.js</h3>
<p>从 <code>angular.json</code> 的 polyfills（构建和测试）中删除 Zone.js（包括 zone.js/testing）。如果您有 <code>polyfills.ts</code> 文件，请移除 <code>import 'zone.js'</code> 这一行。</p>
<h3 data-id="heading-9">步骤 2：启用无 Zone 的变更检测</h3>
<p>在应用启动时添加无 Zone 变更检测提供者：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> {
  bootstrapApplication,
  provideZonelessChangeDetection,
} <span class="hljs-keyword">from</span> <span class="hljs-string">"@angular/core"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppComponent</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./app/app.component"</span>;

<span class="hljs-title function_">bootstrapApplication</span>(<span class="hljs-title class_">AppComponent</span>, {
  <span class="hljs-attr">providers</span>: [<span class="hljs-title function_">provideZonelessChangeDetection</span>()],
});
</code></pre>
<h3 data-id="heading-10">步骤 3：添加浏览器错误监听器（推荐）</h3>
<p>为了更好的错误处理，建议同时添加浏览器全局错误监听器：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { provideBrowserGlobalErrorListeners } <span class="hljs-keyword">from</span> <span class="hljs-string">"@angular/core"</span>;

<span class="hljs-title function_">bootstrapApplication</span>(<span class="hljs-title class_">AppComponent</span>, {
  <span class="hljs-attr">providers</span>: [
    <span class="hljs-title function_">provideZonelessChangeDetection</span>(),
    <span class="hljs-title function_">provideBrowserGlobalErrorListeners</span>(),
  ],
});
</code></pre>
<h3 data-id="heading-11">步骤 4：运行测试并移除警告</h3>
<p>运行应用和测试，如果看到 <code>NG0914: using zoneless but still loading Zone.js</code> 警告，说明您遗漏了一个 polyfill。清理后重新运行即可。</p>
<h2 data-id="heading-12">无 Zone 模式下的变更检测</h2>
<h3 data-id="heading-13">仍然会触发变更检测的情况</h3>
<p>是的，完全没问题。以下情况仍会触发变更检测：</p>
<ul>
<li>模板事件（如 <code>(click)</code>、<code>(input)</code> 等）</li>
<li>Signals 值的变化</li>
<li>组件输入（@Input）的变化</li>
</ul>
<h3 data-id="heading-14">不再自动触发的情况</h3>
<p>您失去的是"所有异步操作都会触发变更检测"的全局行为。例如：</p>
<ul>
<li><code>setTimeout</code>、<code>setInterval</code> 不会自动触发</li>
<li>Promise 的 <code>then</code> 回调不会自动触发</li>
<li>第三方库的异步操作不会自动触发</li>
</ul>
<p>如果您之前隐式依赖于此，现在需要显式地进行——这对性能和代码清晰度都是有益的。</p>
<h3 data-id="heading-15">仍然有效的常见模式</h3>
<p>以下模式在无 Zone 模式下依然有效：</p>
<h4 data-id="heading-16">Signals 驱动 UI</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// model signal</span>
<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">signal</span>(<span class="hljs-number">0</span>);
<span class="hljs-keyword">const</span> double = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">count</span>() * <span class="hljs-number">2</span>);

<span class="hljs-comment">// event updates the signal</span>
<span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) { count.<span class="hljs-title function_">set</span>(<span class="hljs-title function_">count</span>() + <span class="hljs-number">1</span>); }
</code></pre>
<h4 data-id="heading-17">HTTP + Signals</h4>
<p>将 HTTP 请求的结果分配给一个 signal（或 resource），并在模板中绑定它；当 signal 更改时，UI 会自动更新。</p>
<h4 data-id="heading-18">markForCheck</h4>
<p>调用 <code>markForCheck</code> 会触发应用渲染，因此有时不需要重构为 signals，使用 <code>markForCheck</code> 也能正常工作。</p>
<h2 data-id="heading-19">迁移注意事项</h2>
<p>在迁移过程中，请注意以下几点：</p>
<h3 data-id="heading-20">第三方库兼容性</h3>
<p>大多数主要库已支持无 Zone，但如果某些库修补了定时器或直接使用了 Zone API，您可能需要更新或进行小的调整。好消息是：Angular CDK 和 Angular Material 已完全支持无 Zone。</p>
<h3 data-id="heading-21">避免隐式依赖</h3>
<p>如果您之前依赖于随机的 <code>setTimeout</code> 来"触发"变更检测，请切换到 signals 或分派适当的事件。例如：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 不推荐：依赖 setTimeout 触发变更检测</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = newData;
}, <span class="hljs-number">100</span>);

<span class="hljs-comment">// 推荐：使用 signal 或显式触发</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSignal</span>.<span class="hljs-title function_">set</span>(newData);
<span class="hljs-comment">// 或</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = newData;
<span class="hljs-variable language_">this</span>.<span class="hljs-property">cdr</span>.<span class="hljs-title function_">markForCheck</span>();
</code></pre>
<h2 data-id="heading-22">常见问题解答</h2>
<h3 data-id="heading-23">我需要将所有内容重写为 Signals 吗？</h3>
<p>不需要。但您的状态越多地由 signals 驱动，您就越能感受到其优势。已经使用 Inputs 和事件的组件将顺利迁移。您可以逐步迁移，不需要一次性重写所有代码。</p>
<h3 data-id="heading-24">SSR/水合（hydration）怎么办？</h3>
<p>无 Zone 已通过 SSR 错误处理和刷新时机进行了强化。如果您使用的是 v20+ 的 SSR，迁移到 v21 没有问题。Angular 团队已经确保 SSR 场景下的稳定性。</p>
<h3 data-id="heading-25">无 Zone 实际上稳定吗？</h3>
<p>是的。v20.2 将其提升为稳定版；v21 使其成为新应用的默认设置。这意味着它已经过充分测试，可以安全地用于生产环境。</p>
<h2 data-id="heading-26">总结</h2>
<p>Angular v21 中的无 Zone 不仅仅是内部的清理——它是一个新的默认设置，使 Angular 感觉更轻盈、更敏捷、更有目的性。您保留了良好的开发体验（事件、Inputs、Signals），同时减少了运行时开销。如果您一直在犹豫，v21 是您迈出这一步的推动力。</p>
<h3 data-id="heading-27">团队行动计划</h3>
<ol>
<li>
<p>先在开发模式下尝试无 Zone，确认无误后，在生产环境中保持启用。</p>
</li>
<li>
<p>验证第三方库的兼容性，确保所有依赖都能正常工作。</p>
</li>
<li>
<p>全应用范围内推广，并享受更平静、可预测的渲染体验。</p>
</li>
</ol>
<p>祝您升级顺利——并享受 Zone.js 的沉默。🥂</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[.NET Web 应用 Linux 部署全指南：从环境搭建到生产上线]]></title>    <link>https://juejin.cn/post/7573549302619340843</link>    <guid>https://juejin.cn/post/7573549302619340843</guid>    <pubDate>2025-11-17T23:32:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573549302619340843" data-draft-id="7573776814926200851" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=".NET Web 应用 Linux 部署全指南：从环境搭建到生产上线"/> <meta itemprop="keywords" content="C#,.NET"/> <meta itemprop="datePublished" content="2025-11-17T23:32:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="唐青枫"/> <meta itemprop="url" content="https://juejin.cn/user/3737995266234280"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            .NET Web 应用 Linux 部署全指南：从环境搭建到生产上线
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3737995266234280/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    唐青枫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T23:32:41.000Z" title="Mon Nov 17 2025 23:32:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">简介</h3>
<h3 data-id="heading-1">背景和优势</h3>
<p><code>ASP.NET Core</code> 自 <code>.NET Core 1.0</code>（2016 年）起支持跨平台，<code>Linux</code> 部署具有以下优势：</p>
<ul>
<li>
<p>高性能：<code>Linux</code> 服务器（如 <code>Ubuntu</code>）资源占用低，适合高并发。</p>
</li>
<li>
<p>成本效益：开源操作系统，降低服务器成本。</p>
</li>
<li>
<p>生态支持：支持 <code>MySQL、Docker、Nginx</code> 等，适配微服务和云原生。</p>
</li>
<li>
<p>社区活跃：<code>Linux</code> 是云部署（如 <code>AWS、Azure</code>）的首选。</p>
</li>
</ul>
<h3 data-id="heading-2">部署方式</h3>
<p><code>ASP.NET Core Web</code> 项目在 <code>Linux</code> 上有以下主要部署方式：</p>
<ul>
<li>
<p>独立部署（<code>Self-contained</code>）：</p>
<ul>
<li>
<p>打包应用和 <code>.NET</code> 运行时，独立运行。</p>
</li>
<li>
<p>适合无 <code>.NET</code> 运行时的 <code>Linux</code> 服务器。</p>
</li>
</ul>
</li>
<li>
<p>框架依赖部署（<code>Framework-dependent</code>）：</p>
<ul>
<li>
<p>仅打包应用，依赖服务器安装的 <code>.NET SDK</code>/运行时。</p>
</li>
<li>
<p>适合已配置 <code>.NET</code> 环境的服务器。</p>
</li>
</ul>
</li>
<li>
<p><code>Docker</code> 容器部署：</p>
<ul>
<li>
<p>使用 <code>Docker</code> 容器封装应用和依赖。</p>
</li>
<li>
<p>适合微服务、云原生和 <code>CI/CD</code>。</p>
</li>
</ul>
</li>
<li>
<p>云平台部署：</p>
<ul>
<li>
<p>使用云服务（如 <code>Azure App Service、AWS Elastic Beanstalk</code>）。</p>
</li>
<li>
<p>适合快速部署和扩展。</p>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-3">前提条件</h3>
<h4 data-id="heading-4">目标机器</h4>
<ul>
<li>
<p>发行版（<code>Ubuntu、CentOS、Debian、Alpine</code> 等）</p>
</li>
<li>
<p>已安装 <code>.NET</code> 运行时或 <code>SDK</code>（建议至少 <code>.NET 6 LTS</code> 及以上）</p>
</li>
</ul>
<h4 data-id="heading-5"><code>.NET</code> 安装</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">以 Ubuntu 为例，安装 .NET 6 运行时</span>
wget https://packages.microsoft.com/config/ubuntu/22.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
sudo dpkg -i packages-microsoft-prod.deb
sudo apt update
sudo apt install -y aspnetcore-runtime-6.0
</code></pre>
<h4 data-id="heading-6">防火墙与端口</h4>
<p>确保托管应用使用的端口（如 <code>5000</code> 或 <code>80/443</code>）在防火墙/安全组中开放。</p>
<h3 data-id="heading-7">发布与运行（Self-Contained vs Framework-Dependent）</h3>
<h4 data-id="heading-8"><code>Framework-Dependent</code> 部署</h4>
<p>依赖目标主机已安装 <code>.NET</code> 运行时，发布包更小。</p>
<pre><code class="hljs language-shell" lang="shell">dotnet publish -c Release -o ./publish
</code></pre>
<h4 data-id="heading-9"><code>Self-Contained</code> 部署</h4>
<p>包含运行时，无需预装 <code>.NET</code>，但体积更大。</p>
<pre><code class="hljs language-shell" lang="shell">dotnet publish -c Release -r linux-x64 --self-contained true -o ./publish
</code></pre>
<ul>
<li>
<p><code>-c Release</code>：发布优化版本。</p>
</li>
<li>
<p><code>-o ./publish</code>：输出到 <code>publish</code> 目录。</p>
</li>
<li>
<p><code>--self-contained true</code>：包含 <code>.NET</code> 运行时。</p>
</li>
<li>
<p><code>-r linux-x64</code>：目标运行时（<code>Linux 64</code> 位）。</p>
</li>
</ul>
<p>运行：<code>./publish/YourApp</code></p>
<h3 data-id="heading-10">部署应用</h3>
<h4 data-id="heading-11">传输文件</h4>
<ul>
<li>使用 <code>scp</code> 或 <code>rsync</code> 将 <code>publish</code> 目录上传到 <code>Linux</code> 服务器：</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">scp -r ./publish user@server:/var/www/yourapp
</code></pre>
<h4 data-id="heading-12">设置权限</h4>
<pre><code class="hljs language-shell" lang="shell">sudo chown -R www-data:www-data /var/www/yourapp
sudo chmod -R 755 /var/www/yourapp
</code></pre>
<h3 data-id="heading-13">直接运行（Kestrel 自托管）</h3>
<h4 data-id="heading-14">启动应用</h4>
<pre><code class="hljs language-shell" lang="shell">cd yourapp
dotnet YourApp.dll        # Framework-Dependent
<span class="hljs-meta prompt_"># </span><span class="bash">或 ./YourApp             <span class="hljs-comment"># Self-Contained</span></span>
</code></pre>
<h4 data-id="heading-15">监听所有接口</h4>
<p>在 <code>appsettings.json</code> 或环境变量中配置：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"Kestrel"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"Endpoints"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"Http"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"Url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://0.0.0.0:5000"</span> <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>或：</p>
<pre><code class="hljs language-shell" lang="shell">export ASPNETCORE_URLS="http://0.0.0.0:5000"
dotnet YourApp.dll
</code></pre>
<ul>
<li>
<p>优点：部署简单；</p>
</li>
<li>
<p>缺点：缺少负载均衡、<code>TLS</code> 终端、日志管理等企业特性。</p>
</li>
</ul>
<h3 data-id="heading-16">使用 systemd 守护进程</h3>
<p>将应用作为服务后台运行并随系统启动。</p>
<h4 data-id="heading-17">创建 <code>systemd Unit</code> 文件 <code>/etc/systemd/system/kestrel-yourapp.service</code>：</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[Unit]</span>
<span class="hljs-attr">Description</span>=YourApp ASP.NET Core Service
<span class="hljs-attr">After</span>=network.target

<span class="hljs-section">[Service]</span>
<span class="hljs-attr">WorkingDirectory</span>=/var/www/yourapp
<span class="hljs-attr">ExecStart</span>=/usr/bin/dotnet /var/www/yourapp/YourApp.dll
<span class="hljs-attr">Restart</span>=always
<span class="hljs-attr">RestartSec</span>=<span class="hljs-number">10</span>
<span class="hljs-attr">Environment</span>=ASPNETCORE_ENVIRONMENT=Production
<span class="hljs-attr">Environment</span>=ASPNETCORE_URLS=http://<span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>:<span class="hljs-number">5000</span>

<span class="hljs-section">[Install]</span>
<span class="hljs-attr">WantedBy</span>=multi-user.target
</code></pre>
<h4 data-id="heading-18">启动与启用</h4>
<pre><code class="hljs language-shell" lang="shell">sudo systemctl daemon-reload
sudo systemctl start kestrel-yourapp
sudo systemctl enable kestrel-yourapp
sudo journalctl -fu kestrel-yourapp
</code></pre>
<h3 data-id="heading-19">反向代理（Nginx/Apache）+ Kestrel</h3>
<p>推荐生产环境中使用反向代理，实现静态文件缓存、<code>TLS</code> 终端、路径重写等。</p>
<h4 data-id="heading-20">安装 Nginx</h4>
<pre><code class="hljs language-shell" lang="shell">sudo apt install -y nginx
</code></pre>
<h4 data-id="heading-21">配置 Nginx</h4>
<p>在 <code>/etc/nginx/sites-available/yourapp</code> 中：</p>
<pre><code class="hljs language-nginx" lang="nginx">server {
    listen 80;
    server_name your.domain.com;

    # 将 HTTP 重定向到 HTTPS（可选）
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name your.domain.com;

    ssl_certificate     /etc/ssl/certs/your.crt;
    ssl_certificate_key /etc/ssl/private/your.key;

    location / {
        proxy_pass         http://127.0.0.1:5000;
        proxy_http_version 1.1;
        proxy_set_header   Upgrade $http_upgrade;
        proxy_set_header   Connection keep-alive;
        proxy_set_header   Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }

    # 可选：静态文件直连
    location /static/ {
        root /var/www/yourapp/wwwroot;
        expires 30d;
    }
}
</code></pre>
<p>启用配置并重启 <code>Nginx</code>：</p>
<pre><code class="hljs language-shell" lang="shell">sudo ln -s /etc/nginx/sites-available/yourapp /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
</code></pre>
<h3 data-id="heading-22">容器化部署（Docker）</h3>
<p>使用 <code>Docker</code> 将环境一致性和可移植性做到极致。</p>
<h4 data-id="heading-23">Dockerfile 示例</h4>
<pre><code class="hljs language-dockerfile" lang="dockerfile">FROM mcr.microsoft.com/dotnet/aspnet:6.0 AS base
WORKDIR /app
EXPOSE 80

FROM mcr.microsoft.com/dotnet/sdk:6.0 AS build
WORKDIR /src
COPY ["YourApp.csproj", "./"]
RUN dotnet restore
COPY . .
RUN dotnet publish -c Release -o /app/publish

FROM base AS final
WORKDIR /app
COPY --from=build /app/publish .
ENTRYPOINT ["dotnet", "YourApp.dll"]
</code></pre>
<h4 data-id="heading-24">构建与运行</h4>
<pre><code class="hljs language-shell" lang="shell">docker build -t yourapp:1.0 .
docker run -d -p 80:80 --name yourapp -e ASPNETCORE_ENVIRONMENT=Production yourapp:1.0
</code></pre>
<h4 data-id="heading-25">使用 Docker Compose</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">'3.8'</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">web:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">yourapp:latest</span>
    <span class="hljs-attr">build:</span>
      <span class="hljs-attr">context:</span> <span class="hljs-string">.</span>
      <span class="hljs-attr">dockerfile:</span> <span class="hljs-string">Dockerfile</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"8080:80"</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">ASPNETCORE_ENVIRONMENT=Production</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">mysql</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">app-network</span>

  <span class="hljs-attr">mysql:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">mysql:8.0</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">MYSQL_ROOT_PASSWORD=password</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">mysql-data:/var/lib/mysql</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"3306:3306"</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">app-network</span>
  <span class="hljs-attr">nginx:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:latest</span>
    <span class="hljs-attr">ports:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">"80:80"</span>
    <span class="hljs-attr">volumes:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">./nginx.conf:/etc/nginx/nginx.conf</span>
    <span class="hljs-attr">depends_on:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">web</span>
    <span class="hljs-attr">networks:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">app-network</span>  

<span class="hljs-attr">networks:</span>
  <span class="hljs-attr">app-network:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">bridge</span>

<span class="hljs-attr">volumes:</span>
  <span class="hljs-attr">mysql-data:</span>
</code></pre>
<p><code>Nginx</code> 配置（<code>nginx.conf</code>）：</p>
<pre><code class="hljs language-nginx" lang="nginx">events {}
http {
    server {
        listen 80;
        location / {
            proxy_pass http://web:80;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }
}
</code></pre>
<h3 data-id="heading-26">PaaS 平台部署</h3>
<p>若不想自管服务器，可选用云厂商 <code>PaaS</code>：</p>
<ul>
<li>
<p>Azure App Service for Linux</p>
</li>
<li>
<p>AWS Elastic Beanstalk (Docker/.NET Core 平台)</p>
</li>
<li>
<p>Google Cloud Run (容器化)</p>
</li>
<li>
<p>Heroku (使用 Docker buildpacks)</p>
</li>
</ul>
<p>这些平台通常只需推送代码或镜像，自动完成构建、运行、负载均衡与 <code>TLS</code>。</p>
<h3 data-id="heading-27">运维与监控</h3>
<ul>
<li>日志集中</li>
</ul>
<p>使用 <code>Microsoft.Extensions.Logging</code> 输出到文件、<code>Syslog</code>、<code>ELK/EFK</code> 或 <code>Prometheus</code>。</p>
<ul>
<li>健康检查</li>
</ul>
<p>在 <code>Startup</code> 配置健康检查端点 <code>app.MapHealthChecks("/health")</code>，并让负载均衡器探活。</p>
<ul>
<li>自动重启</li>
</ul>
<p><code>systemd</code> 的 <code>Restart=always</code> 或 <code>Kubernetes</code> 的 <code>livenessProbe</code>。</p>
<ul>
<li>性能分析</li>
</ul>
<p>利用 <code>dotnet-counters、dotnet-trace、Application Insights、Prometheus + Grafana</code> 等。</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">安装 dotnet-counters</span>
dotnet tool install -g dotnet-counters
<span class="hljs-meta prompt_">
# </span><span class="bash">监控应用性能</span>
dotnet-counters monitor -n your-app --counters System.Runtime,Microsoft.AspNetCore.Http
<span class="hljs-meta prompt_">
# </span><span class="bash">安装 dotnet-trace</span>
dotnet tool install -g dotnet-trace
<span class="hljs-meta prompt_">
# </span><span class="bash">收集性能跟踪</span>
dotnet-trace collect -n your-app --format Speedscope
</code></pre>
<p><strong>关键诊断命令</strong></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">检查端口监听</span>
sudo ss -tulpn | grep ':5000\|:5001'
<span class="hljs-meta prompt_">
# </span><span class="bash">查看应用日志</span>
journalctl -u your-app --since "10 minutes ago" -f
<span class="hljs-meta prompt_">
# </span><span class="bash">测试数据库连接</span>
psql -h localhost -U your_app_user -d your_app_db -c "SELECT 1"
<span class="hljs-meta prompt_">
# </span><span class="bash">网络连通性测试</span>
curl -v http://localhost:5000/health
<span class="hljs-meta prompt_">
# </span><span class="bash">分析内存使用</span>
top -p $(pgrep -f YourApp)
</code></pre>
<h3 data-id="heading-28">最佳实践清单</h3>
<h4 data-id="heading-29">环境标准化：</h4>
<ul>
<li>
<p>使用相同版本的 <code>OS</code> 和 <code>.NET</code> 运行时</p>
</li>
<li>
<p>配置统一的环境变量管理</p>
</li>
</ul>
<h4 data-id="heading-30">安全优先：</h4>
<ul>
<li>
<p>最小权限原则（非 <code>root</code> 用户运行）</p>
</li>
<li>
<p>定期更新安全补丁</p>
</li>
<li>
<p>强制 <code>HTTPS</code> 连接</p>
</li>
</ul>
<h4 data-id="heading-31">可靠部署：</h4>
<ul>
<li>
<p>使用 <code>CI/CD</code> 流水线自动化部署</p>
</li>
<li>
<p>实现蓝绿部署或金丝雀发布</p>
</li>
<li>
<p>保留上一个版本的回滚能力</p>
</li>
</ul>
<h4 data-id="heading-32">性能优化：</h4>
<ul>
<li>
<p>启用 <code>ReadyToRun</code> 编译</p>
</li>
<li>
<p>配置响应压缩</p>
</li>
<li>
<p>使用负载均衡和水平扩展</p>
</li>
</ul>
<h4 data-id="heading-33">监控告警：</h4>
<ul>
<li>
<p>实现全面的健康检查</p>
</li>
<li>
<p>集成 <code>APM</code> 工具（如 <code>Application Insights</code>）</p>
</li>
<li>
<p>设置关键指标告警（CPU、内存、错误率）</p>
</li>
</ul>
<h4 data-id="heading-34">灾难恢复：</h4>
<ul>
<li>
<p>定期备份数据库和应用配置</p>
</li>
<li>
<p>制定并测试恢复计划</p>
</li>
<li>
<p>多区域部署关键应用</p>
</li>
</ul>
<h3 data-id="heading-35">小结</h3>



































<table><thead><tr><th>方式</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td><strong>直接运行（Kestrel）</strong></td><td>最简单、零依赖</td><td>缺少 TLS、负载均衡</td></tr><tr><td><strong>systemd 管理</strong></td><td>稳定重启、开机自启</td><td>无反向代理、证书管理需额外</td></tr><tr><td><strong>Nginx/Apache 反向代理 + systemd</strong></td><td>TLS 终端、路径重写、静态缓存</td><td>配置略复杂</td></tr><tr><td><strong>Docker 容器化</strong></td><td>环境隔离、可移植、高度一致</td><td>学习成本、镜像管理</td></tr><tr><td><strong>云 PaaS</strong></td><td>最少运维、自动伸缩</td><td>平台依赖、成本相对较高</td></tr></tbody></table>
<h3 data-id="heading-36">资源和文档</h3>
<p>官方文档：</p>
<ul>
<li>
<p><code>ASP.NET Core on Linux</code>：<a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fen-us%2Faspnet%2Fcore%2Fhost-and-deploy%2Flinux-nginx" target="_blank" title="https://learn.microsoft.com/en-us/aspnet/core/host-and-deploy/linux-nginx" ref="nofollow noopener noreferrer">learn.microsoft.com/en-us/aspne…</a></p>
</li>
<li>
<p><code>Docker with ASP.NET Core</code>：<a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fen-us%2Faspnet%2Fcore%2Fhost-and-deploy%2Fdocker" target="_blank" title="https://learn.microsoft.com/en-us/aspnet/core/host-and-deploy/docker" ref="nofollow noopener noreferrer">learn.microsoft.com/en-us/aspne…</a></p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue组件开发避坑指南：循环引用、更新控制与模板替代]]></title>    <link>https://juejin.cn/post/7573776814926217235</link>    <guid>https://juejin.cn/post/7573776814926217235</guid>    <pubDate>2025-11-17T23:37:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573776814926217235" data-draft-id="7573525634213232683" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue组件开发避坑指南：循环引用、更新控制与模板替代"/> <meta itemprop="keywords" content="Vue.js,JavaScript,前端"/> <meta itemprop="datePublished" content="2025-11-17T23:37:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="良山有风来"/> <meta itemprop="url" content="https://juejin.cn/user/3940246036939358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue组件开发避坑指南：循环引用、更新控制与模板替代
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3940246036939358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    良山有风来
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T23:37:43.000Z" title="Mon Nov 17 2025 23:37:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你是不是曾经在开发Vue组件时遇到过这样的困扰？组件之间相互引用导致无限循环，页面更新不受控制白白消耗性能，或者在某些特殊场景下标准模板无法满足需求。这些问题看似棘手，但只要掌握了正确的方法，就能轻松应对。</p>
<p>今天我就来分享Vue组件开发中三个边界情况的处理技巧，这些都是我在实际项目中踩过坑后总结出的宝贵经验。读完本文，你将能够优雅地解决组件循环引用问题，精准控制组件更新时机，并在需要时灵活运用模板替代方案。</p>
<h2 data-id="heading-0">组件循环引用的智慧解法</h2>
<p>先来说说循环引用这个让人头疼的问题。想象一下，你正在构建一个文件管理器，文件夹组件需要包含子文件夹，而子文件夹本质上也是文件夹组件。这就产生了组件自己引用自己的情况。</p>
<p>在实际项目中，我遇到过这样的场景：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 错误示范：这会导致循环引用问题</span>
<span class="hljs-attr">components</span>: {
  <span class="hljs-title class_">Folder</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./Folder.vue'</span>)
}
</code></pre>
<p>那么正确的做法是什么呢？Vue提供了异步组件的方式来打破这个循环：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 方案一：使用异步组件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Folder'</span>,
  <span class="hljs-attr">components</span>: {
    <span class="hljs-title class_">Folder</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./Folder.vue'</span>)
  }
}
</code></pre>
<p>但有时候我们可能需要更明确的控制，这时候可以用条件渲染：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 方案二：条件渲染避免循环</span>
&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ folder.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"hasSubfolders"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Folder</span>
        <span class="hljs-attr">v-for</span>=<span class="hljs-string">"subfolder in folder.children"</span>
        <span class="hljs-attr">:key</span>=<span class="hljs-string">"subfolder.id"</span>
        <span class="hljs-attr">:folder</span>=<span class="hljs-string">"subfolder"</span>
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Folder'</span>,
  <span class="hljs-attr">props</span>: [<span class="hljs-string">'folder'</span>],
  <span class="hljs-attr">computed</span>: {
    <span class="hljs-title function_">hasSubfolders</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">folder</span>.<span class="hljs-property">children</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">folder</span>.<span class="hljs-property">children</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<p>还有一种情况是组件之间的相互引用，比如Article组件引用Comment组件，而Comment组件又需要引用Article组件。这时候我们可以使用beforeCreate钩子来延迟组件的注册：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 方案三：在beforeCreate中注册组件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Article'</span>,
  <span class="hljs-title function_">beforeCreate</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">components</span>.<span class="hljs-property">Comment</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./Comment.vue'</span>).<span class="hljs-property">default</span>
  }
}
</code></pre>
<p>这些方法都能有效解决循环引用问题，关键是要根据具体场景选择最适合的方案。</p>
<h2 data-id="heading-1">精准控制组件更新的实战技巧</h2>
<p>接下来聊聊组件更新控制。在复杂应用中，不必要的组件更新会严重影响性能。我曾经优化过一个数据大屏项目，通过精准控制更新，让页面性能提升了3倍以上。</p>
<p>首先来看看最常用的key属性技巧：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用key强制重新渲染</span>
&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ExpensiveComponent</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"componentKey"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"refreshComponent"</span>&gt;</span>刷新组件<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">componentKey</span>: <span class="hljs-number">0</span>
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">refreshComponent</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">componentKey</span> += <span class="hljs-number">1</span>
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<p>但有时候我们并不需要完全重新渲染组件，只是希望跳过某些更新。这时候v-once就派上用场了：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用v-once避免重复渲染静态内容</span>
&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">v-once</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{{ title }}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ subtitle }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">main</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- 动态内容 --&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;
</code></pre>
<p>对于更复杂的更新控制，我们可以使用计算属性的缓存特性：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 利用计算属性优化渲染</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">items</span>: [],
      <span class="hljs-attr">filter</span>: <span class="hljs-string">''</span>
    }
  },
  <span class="hljs-attr">computed</span>: {
    <span class="hljs-title function_">filteredItems</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 只有items或filter变化时才会重新计算</span>
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> 
        item.<span class="hljs-property">name</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">filter</span>)
      )
    }
  }
}
</code></pre>
<p>在某些极端情况下，我们可能需要手动控制更新流程。这时候可以使用nextTick：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 手动控制更新时机</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">updateData</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">true</span>
      
      <span class="hljs-comment">// 先更新loading状态</span>
      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.$nextTick()
      
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> newData = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchData</span>()
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span> = newData
      } <span class="hljs-keyword">finally</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span>
      }
    }
  }
}
</code></pre>
<p>记住，更新的控制要恰到好处，过度优化反而会让代码变得复杂难维护。</p>
<h2 data-id="heading-2">模板替代方案的创造性应用</h2>
<p>最后我们来探讨模板替代方案。虽然Vue的单文件组件很好用，但在某些场景下，我们可能需要更灵活的模板处理方式。</p>
<p>首先是最基础的动态组件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 动态组件使用</span>
&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">component</span> <span class="hljs-attr">:is</span>=<span class="hljs-string">"currentComponent"</span> <span class="hljs-attr">:props</span>=<span class="hljs-string">"componentProps"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">currentComponent</span>: <span class="hljs-string">'ComponentA'</span>,
      <span class="hljs-attr">componentProps</span>: { <span class="hljs-comment">/* ... */</span> }
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<p>但动态组件有时候不够灵活，这时候渲染函数就派上用场了：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用渲染函数创建动态内容</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">props</span>: [<span class="hljs-string">'type'</span>, <span class="hljs-string">'content'</span>],
  <span class="hljs-title function_">render</span>(<span class="hljs-params">h</span>) {
    <span class="hljs-keyword">const</span> tag = <span class="hljs-variable language_">this</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'header'</span> ? <span class="hljs-string">'h1'</span> : <span class="hljs-string">'p'</span>
    
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">h</span>(tag, {
      <span class="hljs-attr">class</span>: {
        <span class="hljs-string">'text-primary'</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'header'</span>,
        <span class="hljs-string">'text-content'</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'paragraph'</span>
      }
    }, <span class="hljs-variable language_">this</span>.<span class="hljs-property">content</span>)
  }
}
</code></pre>
<p>渲染函数虽然强大，但写起来比较繁琐。这时候JSX就是一个很好的折中方案：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用JSX编写灵活组件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">props</span>: [<span class="hljs-string">'items'</span>, <span class="hljs-string">'layout'</span>],
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">{this.layout}</span>&gt;</span>
        {this.items.map(item =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>{item.title}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{item.description}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        ))}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
  }
}
</code></pre>
<p>对于需要完全自定义渲染逻辑的场景，我们可以使用作用域插槽：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用作用域插槽提供最大灵活性</span>
&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">DataFetcher</span> <span class="hljs-attr">:url</span>=<span class="hljs-string">"apiUrl"</span> <span class="hljs-attr">v-slot</span>=<span class="hljs-string">"{ data, loading }"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"loading"</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">:data</span>=<span class="hljs-string">"data"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">DataFetcher</span>&gt;</span></span>
&lt;/template&gt;
</code></pre>
<p>甚至我们可以组合使用这些技术，创建出真正强大的抽象：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 组合使用多种模板技术</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">render</span>(<span class="hljs-params">h</span>) {
    <span class="hljs-comment">// 根据条件选择不同的渲染策略</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">useScopedSlot</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$scopedSlots</span>.<span class="hljs-title function_">default</span>({
        <span class="hljs-attr">data</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">internalData</span>
      })
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">useJSX</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">renderJSX</span>(h)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">renderTemplate</span>(h)
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">renderJSX</span>(<span class="hljs-params">h</span>) {
      <span class="hljs-comment">// JSX渲染逻辑</span>
    },
    <span class="hljs-title function_">renderTemplate</span>(<span class="hljs-params">h</span>) {
      <span class="hljs-comment">// 传统渲染函数逻辑</span>
    }
  }
}
</code></pre>
<h2 data-id="heading-3">实战案例：构建灵活的数据表格组件</h2>
<p>现在让我们把这些技巧综合运用到一个实际案例中。假设我们要构建一个高度灵活的数据表格组件，它需要处理各种边界情况。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 灵活的数据表格组件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'SmartTable'</span>,
  <span class="hljs-attr">props</span>: {
    <span class="hljs-attr">data</span>: <span class="hljs-title class_">Array</span>,
    <span class="hljs-attr">columns</span>: <span class="hljs-title class_">Array</span>,
    <span class="hljs-attr">keyField</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-string">'id'</span>
    }
  },
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">sortKey</span>: <span class="hljs-string">''</span>,
      <span class="hljs-attr">sortOrder</span>: <span class="hljs-string">'asc'</span>
    }
  },
  <span class="hljs-attr">computed</span>: {
    <span class="hljs-title function_">sortedData</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">sortKey</span>) <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>
      
      <span class="hljs-keyword">return</span> [...<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>].<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> aVal = a[<span class="hljs-variable language_">this</span>.<span class="hljs-property">sortKey</span>]
        <span class="hljs-keyword">const</span> bVal = b[<span class="hljs-variable language_">this</span>.<span class="hljs-property">sortKey</span>]
        
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">sortOrder</span> === <span class="hljs-string">'asc'</span>) {
          <span class="hljs-keyword">return</span> aVal &lt; bVal ? -<span class="hljs-number">1</span> : <span class="hljs-number">1</span>
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">return</span> aVal &gt; bVal ? -<span class="hljs-number">1</span> : <span class="hljs-number">1</span>
        }
      })
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">handleSort</span>(<span class="hljs-params">key</span>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">sortKey</span> === key) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">sortOrder</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">sortOrder</span> === <span class="hljs-string">'asc'</span> ? <span class="hljs-string">'desc'</span> : <span class="hljs-string">'asc'</span>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">sortKey</span> = key
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">sortOrder</span> = <span class="hljs-string">'asc'</span>
      }
    }
  },
  <span class="hljs-title function_">render</span>(<span class="hljs-params">h</span>) {
    <span class="hljs-comment">// 处理空数据情况</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">h</span>(<span class="hljs-string">'div'</span>, { <span class="hljs-attr">class</span>: <span class="hljs-string">'empty-state'</span> }, <span class="hljs-string">'暂无数据'</span>)
    }
    
    <span class="hljs-comment">// 使用JSX渲染表格</span>
    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"smart-table"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">table</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">thead</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>
              {this.columns.map(col =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">th</span> 
                  <span class="hljs-attr">key</span>=<span class="hljs-string">{col.key}</span>
                  <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> this.handleSort(col.key)}
                  class={{ sortable: col.sortable }}
                &gt;
                  {col.title}
                  {this.sortKey === col.key &amp;&amp; (
                    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">sort-icon</span> ${<span class="hljs-attr">this.sortOrder</span>}`} /&gt;</span>
                  )}
                <span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
              ))}
            <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">thead</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">tbody</span>&gt;</span>
            {this.sortedData.map(item =&gt; (
              <span class="hljs-tag">&lt;<span class="hljs-name">tr</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item[this.keyField]}</span>&gt;</span>
                {this.columns.map(col =&gt; (
                  <span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{col.key}</span>&gt;</span>
                    {col.render 
                      ? col.render(h, item)
                      : item[col.key]
                    }
                  <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
                ))}
              <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
            ))}
          <span class="hljs-tag">&lt;/<span class="hljs-name">tbody</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
  }
}
</code></pre>
<p>这个组件展示了如何综合运用我们之前讨论的各种技巧：使用计算属性优化性能，用渲染函数提供灵活性，处理边界情况，以及提供扩展点让使用者自定义渲染逻辑。</p>
<h2 data-id="heading-4">总结与思考</h2>
<p>通过今天的分享，我们深入探讨了Vue组件开发中的三个关键边界情况：循环引用、更新控制和模板替代。这些技巧虽然针对的是边界情况，但在实际项目中却经常能发挥关键作用。</p>
<p>处理循环引用时，我们要理解组件注册的时机和方式，通过异步加载、条件渲染等技巧打破循环。控制组件更新时，要善用Vue的响应式系统特性，在必要的时候进行精准控制。而模板替代方案则为我们提供了突破模板限制的能力，让组件设计更加灵活。</p>
<p>这些解决方案背后体现的是一个重要的开发理念：理解框架的工作原理，在框架的约束下找到创造性的解决方案。只有这样，我们才能写出既优雅又实用的代码。</p>
<p>你在Vue组件开发中还遇到过哪些棘手的边界情况？又是如何解决的呢？欢迎在评论区分享你的经验和见解，让我们共同进步！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何使用 Spec Kit 工具进行规范驱动开发？]]></title>    <link>https://juejin.cn/post/7573512056089739299</link>    <guid>https://juejin.cn/post/7573512056089739299</guid>    <pubDate>2025-11-17T23:43:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573512056089739299" data-draft-id="7573512056089722915" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何使用 Spec Kit 工具进行规范驱动开发？"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-17T23:43:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="磊磊落落"/> <meta itemprop="url" content="https://juejin.cn/user/3054882885469577"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何使用 Spec Kit 工具进行规范驱动开发？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3054882885469577/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    磊磊落落
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T23:43:39.000Z" title="Mon Nov 17 2025 23:43:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>大家好，我是磊磊落落，目前我在技术上主要关注：Java、Golang、AI、架构设计、云原生和自动化测试。欢迎来我的博客（<a href="https://link.juejin.cn?target=https%3A%2F%2Fleileiluoluo.com%2Fposts%2Fhow-to-use-spec-kit.html" target="_blank" title="https://leileiluoluo.com/posts/how-to-use-spec-kit.html" ref="nofollow noopener noreferrer">leileiluoluo.com</a>）获取我的最近更新！</p>
</blockquote>
<p>由上文「<a href="https://link.juejin.cn?target=https%3A%2F%2Fleileiluoluo.com%2Fposts%2Fthe-universal-programming-language-of-the-ai-era.html" target="_blank" title="https://leileiluoluo.com/posts/the-universal-programming-language-of-the-ai-era.html" ref="nofollow noopener noreferrer">Markdown 将成为 AI 时代的通用编程语言？</a>」可以知道，规范驱动开发可能成为 AI 时代的开发新范式。</p>
<p>在传统软件开发流程中，规范只是编码前的临时脚手架，开发者一旦进入编码阶段，便将规范束之高阁。而进入 AI 时代，「规范驱动开发」想彻底改变这一现状，即让规范贯穿整个软件开发生命周期、让规范变得可执行、让规范成为代码。</p>
<p>上文也简单介绍过，规范驱动开发的工作流一般有三个阶段：需求 -&gt; 设计 -&gt; 任务，如果每一阶段的规范都依赖人工完成，会给人带来不小的负担。所以，业界推出了相应的工具来自动化规范的编写和流程的管理，从而为开发者减轻负担。</p>
<p>本文即介绍一个「规范驱动开发」工具的使用，它叫 Spec Kit，由 GitHub 推出，与市面上流行的 AI 助手（如 Cursor、VS Code、Claude、Windsurf 等）均能很好的集成。</p>
<h2 data-id="heading-0">1 安装 Spec Kit 和初始化一个项目</h2>
<p>安装 Spec Kit 前，首先要安装 <code>uv</code>。<code>uv</code> 命令安装成功后，可以使用如下命令查看 <code>uv</code> 的版本。</p>
<pre><code class="hljs language-shell" lang="shell">uv --version
</code></pre>
<p>接着，就可以使用 <code>uv</code> 命令安装 Spec Kit 了。</p>
<pre><code class="hljs language-shell" lang="shell">uv tool install specify-cli --from git+https://github.com/github/spec-kit.git
</code></pre>
<p>Spec Kit 安装成功后，可以使用 <code>specify init</code> 命令来初始化一个项目。</p>
<pre><code class="hljs language-shell" lang="shell">specify init spec-kit-demo
</code></pre>
<p>然后，Spec Kit 会让我们选择对应的 AI 助手，我想在 Copilot 中使用它，所以选择 Copilot。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f18ae59d4dac4eaba6e081ea1651dd2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK56OK6JC96JC9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764027819&amp;x-signature=ZQHs%2BuBQApzzYVYhj%2FSir6ZEsBE%3D" alt="Spec Kit 初始化项目时选择 AI 助手" loading="lazy"/></p>
<p>接着，Spec Kit 让我们选择生成脚本的类型，因为我使用的是 Mac OS，所以选择 Shell。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/690bc7a68ff54fdd9366a8e739aef4e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK56OK6JC96JC9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764027819&amp;x-signature=039NHyJY0LycBYZH8o2XNwNp4eI%3D" alt="Spec Kit 初始化项目时选择脚本类型" loading="lazy"/></p>
<p>选择完成后，项目开始初始化。初始化完成后，Spec Kit 会在项目 <code>spec-kit-demo</code> 下生成一个 <code>.specify</code> 文件夹，其下又会生成 <code>memory</code>、<code>scripts/bash</code>、<code>templates</code> 三个子文件夹。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34e16238d6bb4e1b89961f2ccaacc6b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK56OK6JC96JC9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764027819&amp;x-signature=swxxwyOcQBWPDA%2BshZNn93RC%2Bmc%3D" alt="Spec Kit 项目初始化后生成的文件" loading="lazy"/></p>
<ul>
<li>
<p>Memory</p>
<p>Spec Kit 的记忆目录，包含一个 <code>constitution.md</code> 文件。Constitution 意为宪章，所以该文件用于指定整个开发流程中不可违背的根本原则。</p>
</li>
<li>
<p>Scripts/bash</p>
<p>一组 Shell 脚本，供大语言模型调用来生成 Spec Kit 工作流中各个阶段的规范文件。</p>
</li>
<li>
<p>Templates</p>
<p>生成规范文件时的参考模板。</p>
</li>
</ul>
<h2 data-id="heading-1">2 在 Copilot 中使用斜杠命令来生成规范</h2>
<p>Spec Kit 的工作流包含五个阶段：Constitution、Specify、Plan、Tasks、Implement，分别用于指定宪章（根本原则）、需求（不包含技术栈）、细化需求（包含技术栈与架构）、具体任务、实现。</p>
<p>下面我们使用 VS Code 打开上一步初始化完成的项目 <code>spec-kit-demo</code>，然后尝试使用 Spec Kit 来做一个博客聚合网站。</p>
<h3 data-id="heading-2">2.1 Constitution</h3>
<p>Constitution 阶段用于指定整个项目生命周期都不可违背的根本原则。</p>
<p>为了简便起见，这个博客聚合网站暂时不想做后端，所以数据需要使用 JSON 的方式存在前端。下面在 Copilot Chat 中使用斜杠命令 <code>/speckit.constitution</code> 来指定一下这个基本原则。</p>
<pre><code class="hljs language-text" lang="text">/speckit.constitution 该项目为一个纯前端的演示项目，暂不涉及后端服务，若有请求 API 获取数据的场景，一概使用本地 JSON 模拟。
</code></pre>
<p>执行完成后，可以看到 <code>.specify</code> 文件夹下的 <code>memory/constitution.md</code> 文件被更新，我们的要求被更加细化的写进了「宪章」。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/949cb7c6efff449784975356d41b5aab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK56OK6JC96JC9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764027819&amp;x-signature=ZSpOqtbB2eP2T020MzvbtDJY0PQ%3D" alt="Spec Kit Constitution" loading="lazy"/></p>
<h3 data-id="heading-3">2.2 Specify</h3>
<p>下面进入 Specify 阶段，该阶段需要进行需求概述，不需要指定开发所使用的技术栈。</p>
<p>在 Copilot Chat 中使用斜杠命令 <code>/speckit.specify</code> 来指定一下这个博客聚合网站的页面和功能。</p>
<pre><code class="hljs language-text" lang="text">/speckit.specify 帮我创建一个博客聚合网站，有博客提交、博客审核、审核状态和博客展示功能。该网站的使用者有两类，一类是管理员，另一类是访客。访客无需登录即可进行博客提交、查看所有博客、查看审核状态；管理员需要登录才能进行博客审核。
</code></pre>
<p>执行完成后，可以看到 Spec Kit 会在项目 <code>spec-kit-demo</code> 的同一级生成一个 <code>specs</code> 文件夹，然后在其下生成一个 <code>002-blog-aggregation</code> 子文件夹，子文件夹下会生成一个 <code>spec.md</code> 文件，然后将我们的需求自动拆分为一个个 Story 并写入该文件。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73badfa0ed5941ca890b46abfabaf441~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK56OK6JC96JC9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764027819&amp;x-signature=YhoQMbyioHvBiiQWAWs5tg%2FMScU%3D" alt="Spec Kit Specify" loading="lazy"/></p>
<h3 data-id="heading-4">2.3 Plan</h3>
<p>下面进入 Plan 阶段，Plan 阶段是对需求的近一步细化，以及对所用技术栈和架构的指定。</p>
<p>在 Copilot Chat 中使用斜杠命令 <code>/speckit.plan</code> 来指定这个前端项目的技术栈为 TypeScript + React，样式库为 Tailwind CSS，然后细述各个页面的功能。</p>
<pre><code class="hljs language-text" lang="text">/speckit.plan 请基于 TypeScript 和 React 实现该项目，样式库请使用 Tailwind CSS。请严格遵照 TypeScript 标准语法和最佳实践，遵照 React 标准项目结构、路由配置和组件设计规范，实现的页面要美观、大方、易用。博客提交是一个表单页面；博客审核是一个管理员页面，展示博客的名称和通过状态；审核状态是一个展示博客是否通过的页面；博客展示是一个列表页面，按照提交时间倒序展示所有已审核通过的博客。
</code></pre>
<p>执行完成后，可以看到，<code>specs/002-blog-aggregation</code> 文件夹下生成了一个新文件 <code>plan.md</code>，技术栈、代码结构被写入了该文件。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/940f60c0903449989556c380f1163ad1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK56OK6JC96JC9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764027819&amp;x-signature=tD1ClhvyyIdextyDiwh4Kxjglh0%3D" alt="Spec Kit Plan" loading="lazy"/></p>
<h3 data-id="heading-5">2.4 Tasks</h3>
<p>下面进入 Tasks 阶段，该阶段用于指定具体的实现步骤。</p>
<p>在 Copilot Chat 使用斜杠命令 <code>/speckit.tasks</code> 来指定这些页面的基本实现步骤。</p>
<pre><code class="hljs language-text" lang="text">/speckit.tasks 请首先为管理员实现一个登录页面，登录后可以对所提交的博客进行管理，如审核通过和驳回。然后实现访客可以浏览的页面：博客提交、博客展示、审核状态。访客提交博客时需要填写博客名称、博客创建时间、博主名称和博客地址。访客提交博客后，管理员可以在后台看到新提交的博客，并进行审核或驳回；审核通过后，博客会显示到博客展示页面；驳回后，博客的被驳回状态会在审核状态页面显示。
</code></pre>
<p>执行完成后，<code>specs/002-blog-aggregation</code> 文件夹下生成了一个新文件 <code>tasks.md</code>，详细实现步骤被写入了该文件。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98f742d297d9472bafd30e40b7994658~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK56OK6JC96JC9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764027819&amp;x-signature=tr94HTPhPcnHywUVPAxUOBF5TCA%3D" alt="Spec Kit Tasks" loading="lazy"/></p>
<p>至此，所有需要人工介入的步骤都以完成。</p>
<p>下面我们将 Spec Kit 生成的、与项目 <code>spec-kit-demo</code> 同一级的 <code>specs</code> 文件夹拷贝到 <code>spec-kit-demo</code> 的 <code>.specify</code> 目录下。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b803cd4db1714393bab24b80e6f6df0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK56OK6JC96JC9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764027819&amp;x-signature=bNbkS0ncVyXu%2FpLF7uLe3aESwYs%3D" alt="Spec Kit Specs" loading="lazy"/></p>
<p>拷贝完成后，进入 Spec Kit 的第五步，实现阶段。</p>
<h3 data-id="heading-6">2.5 Implement</h3>
<p>这一步无需提示词，直接在 Copilot Chat 使用斜杠命令 <code>/speckit.implement</code> 进行实现即可。</p>
<pre><code class="hljs language-text" lang="text">/speckit.implement
</code></pre>
<p>可以看到，代码结构、包管理文件 <code>package.json</code> 、打包配置文件 <code>vite.config.ts</code> 等先被自动创建；接着，<code>main.tsx</code>、<code>App.tsx</code>、各个页面组件、可服用组件、工具类等被依次创建。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44677d91eb2040f98d27c128d69f3cf1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK56OK6JC96JC9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764027819&amp;x-signature=amT3X8On8CzxxCat1qTXqQaSUGQ%3D" alt="Spec Kit 生成的代码" loading="lazy"/></p>
<p>几分钟后，整个项目编码完成，Copilot Chat 提示我们可以安装和运行了。</p>
<h2 data-id="heading-7">3 运行和测试</h2>
<p>下面，按照提示的命令进行依赖安装和项目运行。</p>
<pre><code class="hljs language-shell" lang="shell">npm install
npm run dev
</code></pre>
<p>还算顺利，没有错误，项目被成功启动。浏览器访问相应地址，可以看到，一个博客聚合网站被使用「规范驱动开发」的方式实现了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3e6f74f907443aab3fab6acc745b78e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK56OK6JC96JC9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764027819&amp;x-signature=1Oiepsckg3YznQ13ZcTsi5MlkZo%3D" alt="Spec Kit Blog Demo" loading="lazy"/></p>
<h2 data-id="heading-8">4 小结</h2>
<p>综上，本文首先初始化了一个 Spec Kit 样例项目；然后以实现一个博客聚合网站为需求，在 VS Code 的 Copilot AI 助手中依次执行了 Spec Kit 的 Constitution、Specify、Plan、Tasks、Implement 阶段；最后生成了完整的项目代码并进行了启动和测试。</p>
<p>总体感觉，使用 Spec Kit 开发一个新项目（0 到 1）比 Vibe Coding 要靠谱一些，但 Spec Kit 这种「规范驱动开发」的模式能否胜任真实的项目演进（1 到 N），还有待进一步的探索。</p>
<p>本文完整样例工程已提交至 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fleileiluoluo%2Freact-exercises%2Ftree%2Fmain%2Fspec-kit-demo" target="_blank" title="https://github.com/leileiluoluo/react-exercises/tree/main/spec-kit-demo" ref="nofollow noopener noreferrer">GitHub</a>，欢迎有需要的同学参考。</p>
<blockquote>
<p>参考资料</p>
<p>[1] GitHub: Spec Kit, a toolkit to help you get started with Spec-Driven Development - <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgithub%2Fspec-kit" target="_blank" title="https://github.com/github/spec-kit" ref="nofollow noopener noreferrer">github.com/github/spec…</a></p>
<p>[2] YouTube: GitHub 最火的 Spec Kit 项目深度解析 - <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DPtIGaAPzCR0" target="_blank" title="https://www.youtube.com/watch?v=PtIGaAPzCR0" ref="nofollow noopener noreferrer">www.youtube.com/watch?v=PtI…</a></p>
<p>[3] YouTube: The ONLY guide you'll need for GitHub Spec Kit - <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3Da9eR1xsfvHg" target="_blank" title="https://www.youtube.com/watch?v=a9eR1xsfvHg" ref="nofollow noopener noreferrer">www.youtube.com/watch?v=a9e…</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 为啥能回答你的问题？大模型 5 步工作流程，看完秒懂！]]></title>    <link>https://juejin.cn/post/7573530680886919202</link>    <guid>https://juejin.cn/post/7573530680886919202</guid>    <pubDate>2025-11-17T23:43:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573530680886919202" data-draft-id="7573508361742041088" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 为啥能回答你的问题？大模型 5 步工作流程，看完秒懂！"/> <meta itemprop="keywords" content="人工智能,LLM"/> <meta itemprop="datePublished" content="2025-11-17T23:43:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="印刻君"/> <meta itemprop="url" content="https://juejin.cn/user/572216818014568"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 为啥能回答你的问题？大模型 5 步工作流程，看完秒懂！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/572216818014568/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    印刻君
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T23:43:14.000Z" title="Mon Nov 17 2025 23:43:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如今，大语言模型(LLM)已成为我们学习和工作中的常用工具。当你在对话框输入问题时，或许会好奇，这些模型为何能精准、迅速地生成回答？本文将用通俗易懂的语言，为你拆解背后的核心工作流程。</p>
<p>简单来说，大模型处理问题主要包含五个关键环节，分别是：</p>
<ol>
<li>分词(Tokenization)</li>
<li>词嵌入(Word Embedding)</li>
<li>位置编码(Positional Encoding)</li>
<li>自注意力机制(Self-Attention)</li>
<li>自回归生成(Autoregressive Generation)</li>
</ol>
<p>这些专业名词虽然看起来吓人，但只要理清它们各自要解决的核心问题，理解起来其实并不难。</p>
<p>我是印刻君，一位探索 AI 的程序员，关注我，了解更多有温度的轻知识，有深度的硬内容。</p>
<h3 data-id="heading-0">1. 分词(Tokenization)：将语言转化为数字信号</h3>
<p>计算机无法直接处理自然语言，仅能识别和处理数字。因此模型接收问题后，首要任务是<strong>分词 (Tokenization)</strong>——将文本拆解成一系列有意义的基本单元，也就是<strong>词元 (Token)</strong>。这是后续所有处理的基础。</p>
<p>举个例子，输入文本："沙特王子喜欢买苹果股票，女人喜欢用苹果拍照，仓鼠喜欢吃苹果。三个苹果区别在哪里？"。</p>
<p>分词后会得到：<code>["沙特", "王子", "喜欢", "买", "苹果", "股票", "，", "女人", "喜欢", "用", "苹果", "拍照", "，", "仓鼠", "喜欢", "吃", "苹果", ...]</code></p>
<p>完成分词后，每个词元会被映射到唯一的数字 ID。假设模型词典中 “沙特” 对应 1345、“王子” 对应 5369、“苹果” 对应 8568，那么部分词元序列会转化为数字串 <code>[1345, 5369, ..., 8568, 9102, ...]</code>。</p>
<p>需要注意的是，此时模型仅获得文本的数字化形式，尚未理解语义。比如句中三个 “苹果” 的 ID 完全相同(均为 8568)，模型无法区分其具体指向 —— 是苹果公司、苹果手机，还是作为水果的苹果。</p>
<h3 data-id="heading-1">2. 词嵌入(Word Embedding)：为词元赋予意义</h3>
<p>仅靠数字 ID 无法表达词元的含义，第二步 <strong>词嵌入(Word Embedding)</strong> 就是为每个词元生成包含语义信息的数学表示 ——<strong>词向量(Word Vector)</strong>。</p>
<p>词向量本质是高维空间中的坐标点，由一串浮点数组成。例如简化版 “苹果” 词向量为：<code>[0.12, -0.45, 0.67, 0.88, ..., -0.24]</code>(真实维度通常达数百甚至数千维)。你可将其理解为 “语义空间” 中的精准定位，核心特点是：<strong>语义越相近的词，空间坐标越靠近</strong>。</p>
<p>为了更直观理解，我们可以参考简化的二维坐标系：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d084acb6393a43c5b6088ac8372572db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2w5Yi75ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764027793&amp;x-signature=gfIV6g9u04cfx14KB97JmiJW6mQ%3D" alt="image.png" loading="lazy"/></p>
<p>从简化图中能看到，“王子”“公主” 聚集在右上角，二者语义相近；“老鼠”“仓鼠” 则聚集在左下角，与 “王子” 的语义差异较大。</p>
<p>更有趣的是，这些向量支持有意义的数学运算，比如 王子 - 男人 + 女人 ≈ 公主。这意味着模型不仅能学习词义，还能捕捉词与词之间的逻辑关系(如性别、身份差异)。</p>
<p>对于 “苹果” 这类多义词，此阶段会生成融合多种含义(公司、设备、水果)的通用向量，其具体含义将在后续步骤中结合上下文进一步精准定义。</p>
<h3 data-id="heading-2">3.  位置编码(Positional Encoding)：引入位置概念</h3>
<p>词序直接决定句意，“仓鼠喜欢吃苹果” 与 “苹果喜欢吃仓鼠” 的含义天差地别。为让模型理解词元的排列顺序，第三步需引入<strong>位置编码(Positional Encoding)</strong> —— 为序列中每个位置生成独特的位置向量，再与对应词元的词向量整合(通常为相加)。</p>
<p>然后，这个位置向量会与对应位置的词向量进行整合(通常是相加)。举个简化的例子，假设：</p>
<p>简化示例：</p>
<ul>
<li>词向量(“苹果”)= <code>[0.1, 0.2, 0.3, ...]</code></li>
<li>位置向量(第 5 个位置)= <code>[0.0, 0.5, 0.1, ...]</code></li>
<li>整合后向量 = <code>[0.1, 0.7, 0.4, ...]</code></li>
</ul>
<p>整合后的向量同时包含<strong>语义信息(来自词嵌入)<strong>和</strong>位置信息(来自位置编码)</strong>。即便三个 “苹果” 词元相同，因所处位置不同，最终向量也会存在差异，为后续区分含义提供基础。</p>
<h3 data-id="heading-3">4. 自注意力机制(Self-Attention)：构建深层语义联系</h3>
<p>完成前三步后，模型已获得含语义和位置信息的词元向量，但还需理解词元间的关联，才能掌握句子深层含义。目前主流大语言模型(如 GPT 系列)均基于 Transformer 架构构建，其核心正是自注意力机制(Self-Attention Mechanism)。</p>
<p>在 Transformer 出现前，旧模型采用逐词顺序处理模式，存在明显缺陷：理解当前词元时，仅能依赖前文信息，无法提前获取后文内容。以三个 “苹果” 为例：</p>
<ul>
<li>读到第一个 “苹果” 时，仅能看到 “沙特王子喜欢买”，无法判断是公司、手机还是水果；</li>
<li>读到第二个 “苹果” 时，虽看到 “女人喜欢用”，但未看到 “拍照” 前仍无法确定是电子设备；</li>
<li>第三个 “苹果” 也需结合后文 “吃” 才能精准判断为水果。</li>
</ul>
<p>这种 “单向语境” 不仅难以捕捉长距离语义关联，计算效率也较低。而 Transformer 抛弃循环结构，允许模型同时处理所有词元，核心就在于自注意力机制——每个词元会 “审视” 序列中所有其他词元，计算 “注意力分数”(衡量关联强度)，并根据分数从其他词元中吸收有效信息，更新自身向量表示</p>
<p>简单来说，就是每个词元，都会关注上下文，结合上下文信息明确自身含义。</p>
<p>回到示例：</p>
<ul>
<li>第一个 “苹果” 会重点关联 “王子、买、股票”，向量被修正为 “公司 - 苹果”；</li>
<li>第二个 “苹果” 会聚焦 “女人、用、拍照”，向量更新为 “设备 - 苹果”；</li>
<li>第三个 “苹果” 会关联 “仓鼠、吃”，向量定义为 “水果 - 苹果”。</li>
</ul>
<p>这一过程会在模型的多层 Transformer 模块中反复进行，不断精炼语义理解，最终形成对句子全面、深刻的认知。</p>
<h3 data-id="heading-4">5. 自回归生成(Autoregressive Generation)：逐词构建连贯回答</h3>
<p>在充分理解输入信息后，模型开始生成回答。它并非先构思完整提纲再落笔，而是采用 “边写边想” 的模式，从第一个词开始，逐个拼接出完整回答，这就是 “自回归生成”—— 简单说，就是 “写一个词，再根据这个词写下一个，循环直至回答完成”。</p>
<p>还是以 “三个苹果区别” 的问题为例，模型生成答案过程如下：</p>
<ol>
<li>预测概率分布，确定开头第一个词：模型先明确问题核心是 “区分三个‘苹果’的含义”，随后在词汇库中计算所有词作为回答开头的 “可能性”，形成概率排行。</li>
</ol>





























<table><thead><tr><th>词元</th><th>概率</th></tr></thead><tbody><tr><td>三个</td><td>40%</td></tr><tr><td>这</td><td>25%</td></tr><tr><td>第一个</td><td>15%</td></tr><tr><td>不同</td><td>8%</td></tr><tr><td>无关词</td><td>...</td></tr></tbody></table>
<ol start="2">
<li>
<p>采样与选择开头词(温度参数影响选择)：模型从概率排行中选择第一个词，“温度(temperature)” 参数决定选择方式。低温模式(0.1，偏保守)会直接选概率最高的 “三个”；高温模式(1.5，偏灵活)可能选概率较低但更有画面感的 “这”。</p>
</li>
<li>
<p>循环生成(逐词接写，直到完成)：选好第一个词后，它会被加入 “上下文”，模型基于 “已写词语 + 原始问题” 继续预测下一个词，循环往复。</p>
</li>
</ol>
<p>以低温模式为例：</p>
<ul>
<li>输出：“三个”，预测下一个词排行：“苹果”(60%)&gt;“场景”(10%)→选 “苹果”</li>
<li>输出：“三个苹果”，预测下一个词：“的”(55%)&gt;“分别”(20%)→选 “的”</li>
<li>输出：“三个苹果的”，预测下一个词：“区别”(70%)&gt;“含义”(15%)→选 “区别”</li>
<li>输出：“三个苹果的区别”，预测下一个词：“在于”(45%)&gt;“是”(25%)→选 “在于”</li>
<li>输出：“三个苹果的区别在于”，预测下一个词：“指代”(30%)&gt;“对应”(20%)→选 “指代”</li>
<li>输出：“三个苹果的区别在于指代”，预测下一个词：“不同”(50%)→选 “不同”</li>
<li>输出：“三个苹果的区别在于指代不同”，预测下一个词：“：”(35%)→选 “：”</li>
</ul>
<p>如果生成中出现偏差，比如低温模式下第 7 步错把冒号预测为逗号，后续可能变成 “三个苹果的区别在于指代不同，第一个苹果指代苹果手机”(本该是 “苹果公司”).</p>
<p>模型会基于 “苹果手机” 继续写：“第一个苹果指代苹果手机，适合沙特王子购买股票…”，后续内容全跟着错，这就是模型 “幻觉” 现象的一种表现。</p>
<h2 data-id="heading-5">总结：大模型应答的核心流程</h2>
<ol>
<li><strong>分词 (Tokenization)</strong>：将输入文本分解为数字化的词元序列。</li>
<li><strong>词嵌入 (Word Embedding)</strong>：将每个词元ID映射到高维语义空间中的一个向量。</li>
<li><strong>位置编码 (Positional Encoding)</strong>：为词元向量注入序列位置信息。</li>
<li><strong>自注意力机制 (Self-Attention)</strong>：通过计算词元间的关联度，动态更新每个词元的向量表示，使其融入上下文信息。</li>
<li><strong>自回归生成 (Autoregressive Generation)</strong>：基于最终的理解，逐个词元地预测并构建出完整的回答。</li>
</ol>
<p>整个过程虽涉及复杂的数学计算，但其核心目标是就是人类理解语言、思考并作出回应，希望我的文章，让你更清晰地看懂大模型的工作原理。</p>
<p>我是印刻君，一位探索 AI 的程序员，关注我，了解更多有温度的轻知识，有深度的硬内容。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32f17b9e576e465d98936fc8c8d01696~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2w5Yi75ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764027793&amp;x-signature=yXjub3PPbYvSa1k3uH8Eg5sPQxQ%3D" alt="exported_image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Homebrew 5.0：并行加速、MCP 加持，与 Intel 的最后倒计时 -- 肘子的 Swift 周报 #0111]]></title>    <link>https://juejin.cn/post/7573523709300490275</link>    <guid>https://juejin.cn/post/7573523709300490275</guid>    <pubDate>2025-11-17T23:59:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573523709300490275" data-draft-id="7572403510468083755" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Homebrew 5.0：并行加速、MCP 加持，与 Intel 的最后倒计时  -- 肘子的 Swift 周报 #0111"/> <meta itemprop="keywords" content="Swift,SwiftUI,Rust"/> <meta itemprop="datePublished" content="2025-11-17T23:59:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="东坡肘子"/> <meta itemprop="url" content="https://juejin.cn/user/1548526032528727"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Homebrew 5.0：并行加速、MCP 加持，与 Intel 的最后倒计时  -- 肘子的 Swift 周报 #0111
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1548526032528727/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    东坡肘子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T23:59:06.000Z" title="Mon Nov 17 2025 23:59:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c6f5385fefd494a86e9c58956eeafc4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lic5Z2h6IKY5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764028745&amp;x-signature=RuH0LvFBXD1ikaMLJ4TDC0Qoezg%3D" alt="issue111.webp" loading="lazy"/></p>
<blockquote>
<p>📮 想持续关注 Swift 技术前沿？</p>
<p>每周一期《肘子的 Swift 周报》，为你精选本周最值得关注的 Swift、SwiftUI 技术文章、开源项目和社区动态。</p>
<ul>
<li>📬 在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fweekly.fatbobman.com" target="_blank" title="https://weekly.fatbobman.com" ref="nofollow noopener noreferrer">weekly.fatbobman.com</a> 免费订阅</li>
<li>💬 加入 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscord.com%2Finvite%2F7FedN5E2QQ" target="_blank" title="https://discord.com/invite/7FedN5E2QQ" ref="nofollow noopener noreferrer">Discord</a> 与中文 Swift 开发者深入交流</li>
<li>📚 访问 <a href="https://link.juejin.cn?target=http%3A%2F%2Ffatbobman.com" target="_blank" title="http://fatbobman.com" ref="nofollow noopener noreferrer">fatbobman.com</a> 查看数百篇深度原创教程 </li>
</ul>
<p>一起构建更好的 Swift 应用！🚀</p>
</blockquote>
<h2 data-id="heading-0">Homebrew 5.0：并行加速、MCP 加持，与 Intel 的最后倒计时</h2>
<p>几天前，我像往常一样在输入 <code>brew update</code> 后顺手执行了 <code>brew upgrade</code>。出乎意料的是，终端里突然出现了从未见过的画面——大量组件与工具并行下载、整齐排列、同时推进。短暂的惊讶之后，我才从新闻中得知：<a href="https://link.juejin.cn?target=https%3A%2F%2Fbrew.sh%2F2025%2F11%2F12%2Fhomebrew-5.0.0%2F%3Futm_source%3Dfatbobman%2520weekly%2520issue%2520111%26utm_medium%3Dweb" target="_blank" title="https://brew.sh/2025/11/12/homebrew-5.0.0/?utm_source=fatbobman%20weekly%20issue%20111&amp;utm_medium=web" ref="nofollow noopener noreferrer">Homebrew 已经发布了 5.0 版本</a>。</p>
<p>此次更新内容相当丰富。除了默认启用并行下载外，还正式将 Raspberry Pi、ARM 迷你 PC、Windows ARM 上的 WSL2 等 ARM64/AArch64 设备纳入 Tier 1 支持，并新增多项指令与能力。其中，官方提供的本地 MCP 服务尤为引人注目。通过 <code>brew mcp-server</code>，开发者可以让 AI Agent 自动操作 Homebrew，意味着 brew 也顺利接入了正在兴起的 AI 工作流。这是一项颇具时代感的更新。</p>
<p>不过，并非所有消息都同样令人愉快。随着 macOS Tahoe 26 大概率成为最后一个支持 Intel x86_64 的版本，Homebrew 也相应调整了自身的支持策略：从 2026 年 9 月起，Intel Mac 将被降级为 Tier 3；到 2027 年 9 月（或更晚），对 Intel 的支持则可能完全终止。</p>
<p>不可否认，在过去十余年里，Intel 架构为苹果带来了庞大的“潜在用户”：它能原生运行 Windows，让许多本不属于 Mac 生态的用户因兼容性而选择苹果设备，为苹果的市场份额提供了关键支撑。如今，随着 Apple Silicon 的成熟，Intel Mac 注定会与 MOS 6502、PowerPC 等一同成为苹果硬件发展史上的重要篇章，在不久的将来缓缓落幕。</p>
<p>回顾历史，每次 CPU 架构转换都激发了苹果在产品设计上的创新灵感，催生出许多具有时代印记的经典产品——从 68k 时代的 Lisa 开创图形界面先河，到 PowerPC 时代的 iMac G3 半透明美学和彩色贝壳本，再到 Intel 时代的小白/小黑 MacBook 以及重新定义轻薄的 MacBook Air。在 M 系列芯片时代，Apple 在性能、能效与系统集成上实现了跨越式提升，但在硬件外观与工业设计语言上，尚未出现能够留下强烈时代烙印的革新之作。</p>
<p>期待尽早看到可以计入史册的新设计，别让我们等太久。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-111%2F" target="_blank" title="https://fatbobman.com/zh/weekly/issue-111/" ref="nofollow noopener noreferrer">本期内容</a> | <a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-110%2F" target="_blank" title="https://fatbobman.com/zh/weekly/issue-110/" ref="nofollow noopener noreferrer">前一期内容</a> | <a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2F" target="_blank" title="https://fatbobman.com/zh/weekly/" ref="nofollow noopener noreferrer">全部周报列表</a></p>
<h2 data-id="heading-1">近期推荐</h2>
<h3 data-id="heading-2"><a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fposts%2Fgrow-on-ios26%2F%3Futm_source%3Dfatbobman%2520weekly%2520issue%2520111%26utm_medium%3Dweb" target="_blank" title="https://fatbobman.com/zh/posts/grow-on-ios26/?utm_source=fatbobman%20weekly%20issue%20111&amp;utm_medium=web" ref="nofollow noopener noreferrer">Grow on iOS 26：UIKit + SwiftUI 混合架构下的 Liquid Glass 适配实战</a></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fapps.apple.com%2Fcn%2Fapp%2Fgrowpal-health-fitness%2Fid1560604814" target="_blank" title="https://apps.apple.com/cn/app/growpal-health-fitness/id1560604814" ref="nofollow noopener noreferrer">Grow</a> 是一款在 173 个国家和地区获得 App Store 编辑推荐、拥有超过 18 万五星评价的健康管理应用。在适配 iOS 26 的 Liquid Glass 设计语言时，团队遇到了不少挑战：如何在 UIKit + SwiftUI 混合架构下实现原生的 morph 效果？如何精确控制 Scroll Edge Effect？如何处理自定义导航栏元素的动态尺寸？Grow 的开发者之一 <a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2FNSShuhari" target="_blank" title="https://x.com/NSShuhari" ref="nofollow noopener noreferrer">Shuhari</a>，分享了团队在这次适配过程中的实战经验。文章涵盖 Sheet、Navigation、Popover 等场景的改造方案，深入探讨 <code>UIBarButtonItem</code> 尺寸计算、<code>CABackdropLayer</code> 副作用处理等底层细节，还展示了如何利用 Core Text 创造“玻璃文字”效果。所有核心概念都配有完整的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzhangqifan%2FInsights%3Futm_source%3Dfatbobman%2520weekly%2520issue%2520111%26utm_medium%3Dweb" target="_blank" title="https://github.com/zhangqifan/Insights?utm_source=fatbobman%20weekly%20issue%20111&amp;utm_medium=web" ref="nofollow noopener noreferrer">Demo 工程</a>。</p>
<hr/>
<h3 data-id="heading-3"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0111-01" target="_blank" title="https://l.fatbobman.com/w0111-01" ref="nofollow noopener noreferrer">警惕参数化测试中的陷阱 (Pitfalls of Parameterized Tests)</a></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fposts%2Fmastering-the-swift-testing-framework%2F%23%25E5%258F%2582%25E6%2595%25B0%25E5%258C%2596%25E6%25B5%258B%25E8%25AF%2595-parameterized-testing" target="_blank" title="https://fatbobman.com/zh/posts/mastering-the-swift-testing-framework/#%E5%8F%82%E6%95%B0%E5%8C%96%E6%B5%8B%E8%AF%95-parameterized-testing" ref="nofollow noopener noreferrer">参数化测试 (Parameterized Tests)</a>是 Swift Testing 中颇具代表性的新特性，它让开发者能够在最小化重复代码的同时扩大测试覆盖范围，为同一逻辑轻松验证多组输入。然而 <a href="https://link.juejin.cn?target=https%3A%2F%2Ftwitter.com%2FAlexOzun" target="_blank" title="https://twitter.com/AlexOzun" ref="nofollow noopener noreferrer">Alex Ozun</a> 在大规模迁移实践中发现，这项功能虽然便捷，却也暗藏不少容易忽略的陷阱，甚至可能悄悄降低测试的有效性。文章结合多个示例展示了一些常见陷阱，并提出了如避免在 <code>#expect</code> 两侧重复使用测试参数、明确区分示例测试与属性测试等多项实践建议。</p>
<hr/>
<h3 data-id="heading-4"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0111-02" target="_blank" title="https://l.fatbobman.com/w0111-02" ref="nofollow noopener noreferrer">为任务显式指定“身份” (Task Identity)</a></h3>
<p>在 SwiftUI 中，<code>task / onAppear</code> 会在视图“出现”时执行一次，但它们并不会像视图那样自动跟踪依赖——如果任务闭包依赖了某个状态，该状态变化后任务本身不会自动重新触发。<a href="https://link.juejin.cn?target=https%3A%2F%2Fm.objc.io%2F%40chris" target="_blank" title="https://m.objc.io/@chris" ref="nofollow noopener noreferrer">Chris Eidhof</a> 以加载远程图片为例，展示了这一容易被忽略的问题，并建议为任务显式指定“身份”（identity），例如使用 <code>.task(id: url)</code>，让相关依赖（如 URL 或由多个值组合而成的复合标识）参与任务的重新执行条件，使 SwiftUI 能在依赖更新时取消旧任务并启动新任务。作者提醒，凡是在视图中使用 <code>task / onAppear</code> 时，都应确保相关的依赖已经体现在任务的身份（identity）中。</p>
<hr/>
<h3 data-id="heading-5"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0111-03" target="_blank" title="https://l.fatbobman.com/w0111-03" ref="nofollow noopener noreferrer">Objective-C API 引发的 Unicode 错误 (One Swift mistake everyone should stop making today)</a></h3>
<p>Swift 已经诞生十年了，但在日常开发中开发者使用的很多 Swift API 仍只是对 Objective-C API 的简单包装，这可能会引发一些容易忽视的严重问题。<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Ftwostraws" target="_blank" title="https://x.com/twostraws" ref="nofollow noopener noreferrer">Paul Hudson</a> 在本文中就通过 <code>replacingOccurrences(of:with:)</code> 展示了这种情况：在处理由多个 Unicode 标量组成的字符（如国旗表情）时，该方法可能会“误拆”字符、匹配不存在的序列，从而生成完全错误的结果。Paul 的建议非常简单：在 Swift 中应优先使用原生的 <code>replacing(_:with:)</code>，它能够正确地按字符语义处理 Unicode，避免这些诡异且难以排查的字符串错误。</p>
<blockquote>
<p>随着 Foundation 在 Swift 社区重构完成，在 macOS 等平台上，对于具备类似功能的 API，通常应优先选择新 Foundation 中提供的 Swift 原生版本。这样不仅可以避免上述问题，而且也提前为跨平台做好准备。</p>
</blockquote>
<hr/>
<h3 data-id="heading-6"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0111-04" target="_blank" title="https://l.fatbobman.com/w0111-04" ref="nofollow noopener noreferrer">和 Christian 一起学习 Swift 并发 (Learning About Swift Concurrency (from Matt Massicotte’s Blog) with a Zettelkasten)</a></h3>
<p>Swift 的并发演进并非一帆风顺，引入 <em>Approachable Concurrency</em> 概念后，不同编译选项组合甚至可能得到完全不同的编译结果，理解成本也随之水涨船高。<a href="https://link.juejin.cn?target=https%3A%2F%2Fmastodon.social%2F%40ctietze" target="_blank" title="https://mastodon.social/@ctietze" ref="nofollow noopener noreferrer">Christian Tietze</a> 原本只打算做一个简短演示：展示如何使用<a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FZettelkasten" target="_blank" title="https://en.wikipedia.org/wiki/Zettelkasten" ref="nofollow noopener noreferrer">卡片盒笔记法</a>（Zettelkasten）来消化 Matt Massicotte 关于 Swift 并发的博客文章，结果在实作过程中不断撞见更深层的复杂性——例如：actor 无法直接满足带有 <code>nonisolated</code> 要求的 Sendable 协议，除非显式将成员标记为 <code>nonisolated</code> 或 <code>nonisolated(unsafe)</code>。等他回过神来，视频已经录到了 80 分钟。</p>
<blockquote>
<p>视频很好地呈现了“深入学技术”的真实面貌：不是线性的知识堆叠，而是充满困惑、假设以及有待日后用代码与文档验证的开放问题。同时也侧面证明，卡片盒笔记法非常适合应对 Swift 并发这类复杂且持续演进的主题，通过构建可搜索、可链接的笔记网络，承载理解在时间维度上的逐步收敛。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0111-05" target="_blank" title="https://l.fatbobman.com/w0111-05" ref="nofollow noopener noreferrer">Claude Code Skills 功能介绍以及使用经验</a></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Feinverne" target="_blank" title="https://x.com/einverne" ref="nofollow noopener noreferrer">Ein Verne</a> 在本文中介绍了 Claude 新推出的 Skills 机制 —— 一种用于扩展 Claude 能力的模块化体系。相比 MCP、Slash Commands 和传统插件，Skills 更强调可组合性、可移植性以及对上下文窗口的友好使用方式。每个 Skill 都以独立文件夹的形式存在，包含名称、描述、操作指令（SKILL.md）、可执行脚本、参考文档与资源文件等。Claude 会在执行任务时自动扫描并匹配合适的技能，并通过“渐进式披露（Progressive Disclosure）”按需加载细节，从而显著降低上下文消耗。作者认为，Skills 本质上将“提示词工程”演进为“工作流工程”，让 Claude 从通用智能助手进一步迈向可维护的智能基础设施形态。</p>
<hr/>
<h3 data-id="heading-8"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0111-06" target="_blank" title="https://l.fatbobman.com/w0111-06" ref="nofollow noopener noreferrer">在 iOS 中集成 Rust：基于 UniFFI 的多平台工作流 (Multiplatform with Rust on iOS)</a></h3>
<p>就像许多 Swift 开发者希望把代码带出苹果生态一样，iOS 本身也对其他开发语言保持着相当开放的态度。<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Ftjeerdintveen" target="_blank" title="https://x.com/tjeerdintveen" ref="nofollow noopener noreferrer">Tjeerd in 't Veen</a> 在这篇文章中分享了一份详实的 Rust + iOS 集成指南，展示如何通过 Mozilla 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmozilla.github.io%2Funiffi-rs%2Flatest%2F" target="_blank" title="https://mozilla.github.io/uniffi-rs/latest/" ref="nofollow noopener noreferrer">UniFFI</a> 将 Rust 代码优雅地接入到 iOS 项目中。UniFFI 能将 Rust 的 enum 自动映射为 Swift enum，并把函数名从 <code>snake_case</code> 转为 <code>camelCase</code>，让 Rust 模块在 Swift 侧看起来就像原生 API。</p>
<p>文章给出了一整套可落地的工作流：从创建 Rust 库、为多种 iOS 架构构建静态库、打包 XCFramework，到最终封装成 Swift Package，每一步都有详细说明与常见陷阱提示。这套方案不仅让 iOS 工程可以像使用普通 Swift 包一样消费 Rust 逻辑，也为后续在 Android 等平台复用同一份 Rust 代码打下了良好基础。</p>
<h2 data-id="heading-9">工具</h2>
<h3 data-id="heading-10"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0111-07" target="_blank" title="https://l.fatbobman.com/w0111-07" ref="nofollow noopener noreferrer">VisualDiffer 2：从 Objective-C 到 Swift 的重生</a></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fdafi" target="_blank" title="https://x.com/dafi" ref="nofollow noopener noreferrer">Davide Ficano</a> 将其经营多年的 macOS 文件对比工具 <a href="https://link.juejin.cn?target=https%3A%2F%2Fvisualdiffer.com%2F" target="_blank" title="https://visualdiffer.com/" ref="nofollow noopener noreferrer">VisualDiffer</a> 完全开源，并从 Objective-C 彻底重写为 Swift。这不是简单的语言迁移或 AI 辅助转换，而是一次从零开始的手工重构。</p>
<p>核心功能保持不变：</p>
<ul>
<li>🟩 <strong>直观对比</strong> - 并排展示目录差异，用颜色标识新增、修改或缺失的文件</li>
<li>🧩 <strong>深入分析</strong> - 支持文件级别的逐行对比（基于 UNIX diff）</li>
<li>🧹 <strong>智能过滤</strong> - 自动排除版本控制文件（.git、.svn）和系统文件（.DS_Store）</li>
<li>⚡ <strong>性能优化</strong> - 支持多种对比策略，从快速的日期/大小对比到精确的逐字节对比</li>
</ul>
<p>在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.reddit.com%2Fr%2Fswift%2Fcomments%2F1on3ry9%2Fvisualdiffer_rewritten_in_swift_62%2F" target="_blank" title="https://www.reddit.com/r/swift/comments/1on3ry9/visualdiffer_rewritten_in_swift_62/" ref="nofollow noopener noreferrer">Reddit</a> 上，作者坦言自己依旧非常欣赏 Objective-C，但 Swift 的潜力让他愿意承受迁移的巨大成本。UI 层（特别是 NSTableView 与 delegate 模式）的重写过程尤为艰难，早期充满了并发属性标注，但随着理解加深，Swift 的优势逐渐显现。</p>
<hr/>
<h3 data-id="heading-11"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0111-08" target="_blank" title="https://l.fatbobman.com/w0111-08" ref="nofollow noopener noreferrer">FSWatcher：高性能的 Swift 原生文件系统监控库</a></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fokooo5km" target="_blank" title="https://x.com/okooo5km" ref="nofollow noopener noreferrer">十里</a> 在开发图片压缩工具 <a href="https://link.juejin.cn?target=https%3A%2F%2Fzipic.app%2F%3Futm_source%3Dfatbobman%2520weekly%2520issue%2520111%26utm_medium%3Dweb" target="_blank" title="https://zipic.app/?utm_source=fatbobman%20weekly%20issue%20111&amp;utm_medium=web" ref="nofollow noopener noreferrer">Zipic</a> 时，需要实时感知图片文件变化以便进行及时处理，为此开发了 FSWatcher。这是一个基于 macOS/iOS 底层 kqueue 机制的文件系统监控库，采用事件驱动而非轮询方式，资源消耗极低。</p>
<p>核心特性：</p>
<ul>
<li>🎯 <strong>智能过滤</strong>：支持按文件类型、大小、修改时间等多维度过滤，并可链式组合</li>
<li>🔍 <strong>预测性忽略</strong>：自动识别并跳过自身生成的输出文件（如 *_compressed.jpg），避免循环触发</li>
<li>📁 <strong>递归监控</strong>：可监控整棵目录树，支持深度限制与排除规则</li>
<li>⚡ <strong>现代 API</strong>：完整支持 Combine、async/await 以及传统闭包回调模式</li>
</ul>
<p>该库非常适合作为图片处理流程的监听器、开发工具的热重载组件，或构建轻量化自动备份系统等需要实时文件变动感知的场景。</p>
<hr/>
<h3 data-id="heading-12"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0111-09" target="_blank" title="https://l.fatbobman.com/w0111-09" ref="nofollow noopener noreferrer">SFSymbolKit：零维护的类型安全 SF Symbols 库</a></h3>
<p>市面上已有不少用于改进 SF Symbols 使用体验的库，但 <a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2FLiYanan2004" target="_blank" title="https://x.com/LiYanan2004" ref="nofollow noopener noreferrer">LiYanan</a> 的 SFSymbolKit 仍然颇具特色：所有符号与可用性信息都由工具直接从系统框架自动生成，一键即可完成更新，真正做到无需人工维护。</p>
<p>核心优势：</p>
<ul>
<li>✅ <strong>数据源可靠</strong>：直接读取 <code>/System/Library/PrivateFrameworks/SFSymbols.framework/</code>，与系统 100% 同步</li>
<li>✅ <strong>完全自动化</strong>：运行 <code>./update_symbols.sh</code> 即可更新，无需手动添加新符号</li>
<li>✅ <strong>版本感知</strong>：自动生成 <code>@available</code> 属性，编译时检查符号兼容性</li>
<li>✅ <strong>用户自助</strong>：任何人都可以在本地更新，不依赖作者发版</li>
</ul>
<h2 data-id="heading-13">往期内容</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-110%2F" target="_blank" title="https://fatbobman.com/zh/weekly/issue-110/" ref="nofollow noopener noreferrer">Skip Fuse现在对独立开发者免费！- #110</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhttps%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-109%2F" target="_blank" title="https://https://fatbobman.com/zh/weekly/issue-109/" ref="nofollow noopener noreferrer">惊险但幸运，两次！ - #109</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-108%2F" target="_blank" title="https://fatbobman.com/zh/weekly/issue-108/" ref="nofollow noopener noreferrer">Swift 官方发布 Android SDK - #108</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-107%2F" target="_blank" title="https://fatbobman.com/zh/weekly/issue-107/" ref="nofollow noopener noreferrer">去 Apple Store 修手机 - #107</a></li>
</ul>
<h2 data-id="heading-14">THANK YOU</h2>
<p>如果你觉得这份周报或者我的文章对你有所帮助，欢迎 <strong>点赞</strong> 并将其 <strong>转发</strong> 给更多的朋友。</p>
<blockquote>
<p>📮 想持续关注 Swift 技术前沿？</p>
<p>每周一期《肘子的 Swift 周报》，为你精选本周最值得关注的 Swift、SwiftUI 技术文章、开源项目和社区动态。</p>
<ul>
<li>📬 在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fweekly.fatbobman.com" target="_blank" title="https://weekly.fatbobman.com" ref="nofollow noopener noreferrer">weekly.fatbobman.com</a> 免费订阅</li>
<li>💬 加入 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscord.com%2Finvite%2F7FedN5E2QQ" target="_blank" title="https://discord.com/invite/7FedN5E2QQ" ref="nofollow noopener noreferrer">Discord</a> 与中文 Swift 开发者深入交流</li>
<li>📚 访问 <a href="https://link.juejin.cn?target=http%3A%2F%2Ffatbobman.com" target="_blank" title="http://fatbobman.com" ref="nofollow noopener noreferrer">fatbobman.com</a> 查看数百篇深度原创教程 </li>
</ul>
<p>一起构建更好的 Swift 应用！🚀</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis（131）Redis的整数集合（Intset）是如何实现的？]]></title>    <link>https://juejin.cn/post/7573525927793868826</link>    <guid>https://juejin.cn/post/7573525927793868826</guid>    <pubDate>2025-11-17T23:03:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573525927793868826" data-draft-id="7573519273030680622" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis（131）Redis的整数集合（Intset）是如何实现的？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-17T23:03:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis（131）Redis的整数集合（Intset）是如何实现的？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T23:03:10.000Z" title="Mon Nov 17 2025 23:03:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>整数集合（Intset）是Redis中的一种紧凑型数据结构，专门用于存储整数集合。这种集合通过数组保存数据，并根据需要动态调整数组的大小和整数的存储格式（16位、32位或64位），从而实现高效的存储和查询。</p>
<h3 data-id="heading-0">主要结构</h3>
<p>整数集合的基本结构包括一个头部和一个整数数组。头部包含了整数集合的元数据，如编码方式、元素数量等。数组部分则用于存储实际的整数数据。</p>
<h4 data-id="heading-1">头部结构</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">intset</span> {</span>
    <span class="hljs-type">uint32_t</span> encoding;   <span class="hljs-comment">// 编码方式：表示当前使用的整数类型（16位、32位或64位）</span>
    <span class="hljs-type">uint32_t</span> length;     <span class="hljs-comment">// 集合中的元素数量</span>
    <span class="hljs-type">int8_t</span> contents[];   <span class="hljs-comment">// 整数数组，实际存储数据的地方</span>
} intset;
</code></pre>
<h3 data-id="heading-2">主要操作</h3>
<h4 data-id="heading-3">1. 创建整数集合</h4>
<p>创建一个新的整数集合并初始化。</p>
<pre><code class="hljs language-c" lang="c">intset *<span class="hljs-title function_">intsetNew</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> {
    intset *is = zmalloc(<span class="hljs-keyword">sizeof</span>(intset));
    is-&gt;encoding = intrev32ifbe(INTSET_ENC_INT16);  <span class="hljs-comment">// 默认编码方式为16位整数</span>
    is-&gt;length = <span class="hljs-number">0</span>;  <span class="hljs-comment">// 初始集合长度为0</span>
    <span class="hljs-keyword">return</span> is;
}
</code></pre>
<h4 data-id="heading-4">2. 查找操作</h4>
<p>查找一个整数是否存在于集合中。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">uint8_t</span> <span class="hljs-title function_">intsetFind</span><span class="hljs-params">(intset *is, <span class="hljs-type">int64_t</span> value)</span> {
    <span class="hljs-type">uint32_t</span> pos;
    <span class="hljs-keyword">if</span> (intsetSearch(is, value, &amp;pos)) {
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-type">int</span> <span class="hljs-title function_">intsetSearch</span><span class="hljs-params">(intset *is, <span class="hljs-type">int64_t</span> value, <span class="hljs-type">uint32_t</span> *pos)</span> {
    <span class="hljs-type">int</span> min = <span class="hljs-number">0</span>, max = intrev32ifbe(is-&gt;length) - <span class="hljs-number">1</span>, mid = <span class="hljs-number">-1</span>;
    <span class="hljs-type">int64_t</span> cur;
    <span class="hljs-keyword">if</span> (intrev32ifbe(is-&gt;length) == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">if</span> (pos) *pos = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }

    <span class="hljs-keyword">while</span> (max &gt;= min) {
        mid = (min + max) / <span class="hljs-number">2</span>;
        cur = intsetGetEncoded(is, mid);
        <span class="hljs-keyword">if</span> (value &gt; cur) {
            min = mid + <span class="hljs-number">1</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value &lt; cur) {
            max = mid - <span class="hljs-number">1</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">break</span>;
        }
    }

    <span class="hljs-keyword">if</span> (value == cur) {
        <span class="hljs-keyword">if</span> (pos) *pos = mid;
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (pos) *pos = min;
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }
}
</code></pre>
<h4 data-id="heading-5">3. 插入操作</h4>
<p>向整数集合中插入一个整数。根据需要调整编码方式并重新分配内存。</p>
<pre><code class="hljs language-c" lang="c">intset *<span class="hljs-title function_">intsetAdd</span><span class="hljs-params">(intset *is, <span class="hljs-type">int64_t</span> value, <span class="hljs-type">uint8_t</span> *success)</span> {
    <span class="hljs-type">uint8_t</span> valenc = _intsetValueEncoding(value);
    <span class="hljs-type">uint32_t</span> pos;
    <span class="hljs-keyword">if</span> (success) *success = <span class="hljs-number">1</span>;

    <span class="hljs-comment">// 查找插入位置</span>
    <span class="hljs-keyword">if</span> (intsetSearch(is, value, &amp;pos)) {
        <span class="hljs-keyword">if</span> (success) *success = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">return</span> is;
    }

    <span class="hljs-comment">// 如果需要更大的编码格式</span>
    <span class="hljs-keyword">if</span> (valenc &gt; intrev32ifbe(is-&gt;encoding)) {
        <span class="hljs-keyword">return</span> intsetUpgradeAndAdd(is, value);
    }

    <span class="hljs-comment">// 为新元素分配空间</span>
    is = intsetResize(is, intrev32ifbe(is-&gt;length) + <span class="hljs-number">1</span>);

    <span class="hljs-comment">// 移动元素以腾出插入位置</span>
    <span class="hljs-keyword">if</span> (pos &lt; intrev32ifbe(is-&gt;length)) {
        intsetMoveTail(is, pos, intrev32ifbe(is-&gt;length) - pos);
    }

    <span class="hljs-comment">// 插入新元素</span>
    intsetSet(is, pos, value);
    is-&gt;length = intrev32ifbe(intrev32ifbe(is-&gt;length) + <span class="hljs-number">1</span>);

    <span class="hljs-keyword">return</span> is;
}

<span class="hljs-type">static</span> <span class="hljs-type">uint8_t</span> _intsetValueEncoding(<span class="hljs-type">int64_t</span> v) {
    <span class="hljs-keyword">if</span> (v &lt; INT32_MIN || v &gt; INT32_MAX) <span class="hljs-keyword">return</span> INTSET_ENC_INT64;
    <span class="hljs-keyword">if</span> (v &lt; INT16_MIN || v &gt; INT16_MAX) <span class="hljs-keyword">return</span> INTSET_ENC_INT32;
    <span class="hljs-keyword">return</span> INTSET_ENC_INT16;
}
</code></pre>
<h4 data-id="heading-6">4. 删除操作</h4>
<p>从整数集合中删除一个整数。</p>
<pre><code class="hljs language-c" lang="c">intset *<span class="hljs-title function_">intsetRemove</span><span class="hljs-params">(intset *is, <span class="hljs-type">int64_t</span> value, <span class="hljs-type">int</span> *success)</span> {
    <span class="hljs-type">uint8_t</span> valenc = _intsetValueEncoding(value);
    <span class="hljs-type">uint32_t</span> pos;
    <span class="hljs-keyword">if</span> (success) *success = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">if</span> (valenc &lt;= intrev32ifbe(is-&gt;encoding) &amp;&amp; intsetSearch(is, value, &amp;pos)) {
        <span class="hljs-type">uint32_t</span> len = intrev32ifbe(is-&gt;length);

        <span class="hljs-comment">// 移动尾部元素以覆盖被删除元素</span>
        <span class="hljs-keyword">if</span> (pos &lt; (len - <span class="hljs-number">1</span>)) {
            intsetMoveTail(is, pos + <span class="hljs-number">1</span>, len - (pos + <span class="hljs-number">1</span>));
        }
        is = intsetResize(is, len - <span class="hljs-number">1</span>);
        is-&gt;length = intrev32ifbe(len - <span class="hljs-number">1</span>);
        <span class="hljs-keyword">if</span> (success) *success = <span class="hljs-number">1</span>;
    }

    <span class="hljs-keyword">return</span> is;
}
</code></pre>
<h3 data-id="heading-7">辅助函数</h3>
<h4 data-id="heading-8">获取和设置元素</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> <span class="hljs-type">int64_t</span> <span class="hljs-title function_">intsetGetEncoded</span><span class="hljs-params">(intset *is, <span class="hljs-type">int</span> pos)</span> {
    <span class="hljs-type">int64_t</span> v64;
    <span class="hljs-type">int32_t</span> v32;
    <span class="hljs-type">int16_t</span> v16;
    <span class="hljs-type">uint32_t</span> encoding = intrev32ifbe(is-&gt;encoding);

    <span class="hljs-keyword">if</span> (encoding == INTSET_ENC_INT64) {
        <span class="hljs-built_in">memcpy</span>(&amp;v64, ((<span class="hljs-type">int64_t</span>*)is-&gt;contents) + pos, <span class="hljs-keyword">sizeof</span>(v64));
        <span class="hljs-keyword">return</span> intrev64ifbe(v64);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (encoding == INTSET_ENC_INT32) {
        <span class="hljs-built_in">memcpy</span>(&amp;v32, ((<span class="hljs-type">int32_t</span>*)is-&gt;contents) + pos, <span class="hljs-keyword">sizeof</span>(v32));
        <span class="hljs-keyword">return</span> intrev32ifbe(v32);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">memcpy</span>(&amp;v16, ((<span class="hljs-type">int16_t</span>*)is-&gt;contents) + pos, <span class="hljs-keyword">sizeof</span>(v16));
        <span class="hljs-keyword">return</span> intrev16ifbe(v16);
    }
}

<span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">intsetSet</span><span class="hljs-params">(intset *is, <span class="hljs-type">int</span> pos, <span class="hljs-type">int64_t</span> value)</span> {
    <span class="hljs-type">uint32_t</span> encoding = intrev32ifbe(is-&gt;encoding);

    <span class="hljs-keyword">if</span> (encoding == INTSET_ENC_INT64) {
        ((<span class="hljs-type">int64_t</span>*)is-&gt;contents)[pos] = intrev64ifbe(value);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (encoding == INTSET_ENC_INT32) {
        ((<span class="hljs-type">int32_t</span>*)is-&gt;contents)[pos] = intrev32ifbe(value);
    } <span class="hljs-keyword">else</span> {
        ((<span class="hljs-type">int16_t</span>*)is-&gt;contents)[pos] = intrev16ifbe(value);
    }
}
</code></pre>
<h4 data-id="heading-9">调整内存大小</h4>
<pre><code class="hljs language-c" lang="c">intset *<span class="hljs-title function_">intsetResize</span><span class="hljs-params">(intset *is, <span class="hljs-type">uint32_t</span> len)</span> {
    <span class="hljs-type">uint32_t</span> size = len * intrev32ifbe(is-&gt;encoding);
    is = zrealloc(is, <span class="hljs-keyword">sizeof</span>(intset) + size);
    <span class="hljs-keyword">return</span> is;
}
</code></pre>
<h3 data-id="heading-10">示例使用</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    intset *is = intsetNew();
    <span class="hljs-type">uint8_t</span> success;

    <span class="hljs-comment">// 插入整数</span>
    is = intsetAdd(is, <span class="hljs-number">10</span>, &amp;success);
    is = intsetAdd(is, <span class="hljs-number">20</span>, &amp;success);
    is = intsetAdd(is, <span class="hljs-number">30</span>, &amp;success);

    <span class="hljs-comment">// 查找整数</span>
    <span class="hljs-keyword">if</span> (intsetFind(is, <span class="hljs-number">20</span>)) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"20 exists in the set.\n"</span>);
    }

    <span class="hljs-comment">// 删除整数</span>
    is = intsetRemove(is, <span class="hljs-number">20</span>, &amp;success);
    <span class="hljs-keyword">if</span> (!intsetFind(is, <span class="hljs-number">20</span>)) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"20 has been removed from the set.\n"</span>);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>总结：整数集合（Intset）通过紧凑的内存布局和灵活的编码方式实现了高效的存储和查询操作。它适用于存储小范围的整数集合，通过精心设计的数据结构，保证了高效的插入、删除和查找操作。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis（130）Redis的压缩列表（Ziplist）是如何实现的？]]></title>    <link>https://juejin.cn/post/7573519273030664238</link>    <guid>https://juejin.cn/post/7573519273030664238</guid>    <pubDate>2025-11-17T23:02:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573519273030664238" data-draft-id="7573528564026556462" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis（130）Redis的压缩列表（Ziplist）是如何实现的？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-17T23:02:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis（130）Redis的压缩列表（Ziplist）是如何实现的？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T23:02:08.000Z" title="Mon Nov 17 2025 23:02:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>压缩列表（Ziplist）是Redis中一种紧凑型的数据结构，用于存储小量的字符串或整数。它的设计初衷是为了节省内存，尤其适用于存储短小数据的场景，如列表或哈希表中的少量元素。Ziplist通过连续的内存块存储数据，并使用一种紧凑的编码方式来表示字符串和整数，从而减少内存占用。</p>
<h3 data-id="heading-0">主要结构</h3>
<p>Ziplist的结构可以分为三部分：表头、数据项和表尾。</p>
<ol>
<li><strong>表头</strong>：包含两个字段：<code>zlbytes</code>和<code>zltail</code>。
<ul>
<li><code>zlbytes</code>：整个压缩列表所占的字节数。</li>
<li><code>zltail</code>：到压缩列表尾部的偏移量。</li>
<li><code>zllen</code>：压缩列表包含的节点数。</li>
</ul>
</li>
<li><strong>数据项</strong>：每个数据项都有三部分：前置节点长度、编码方式和实际数据。</li>
<li><strong>表尾</strong>：用一个字节<code>0xFF</code>标识压缩列表的结束。</li>
</ol>
<h4 data-id="heading-1">压缩列表的完整结构</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">/*  
 * |&lt;zlbytes&gt;|&lt;zltail&gt;|&lt;zllen&gt;|&lt;entry&gt;...|&lt;entry&gt;|&lt;zlend&gt;|
 */</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ziplist</span> {</span>
    <span class="hljs-type">uint32_t</span> zlbytes;  <span class="hljs-comment">// 压缩列表所占用的总字节数</span>
    <span class="hljs-type">uint32_t</span> zltail;   <span class="hljs-comment">// 到压缩列表尾部的偏移量</span>
    <span class="hljs-type">uint16_t</span> zllen;    <span class="hljs-comment">// 压缩列表包含的节点数</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> entries[]; <span class="hljs-comment">// 压缩列表的实际数据部分</span>
} ziplist;
</code></pre>
<h3 data-id="heading-2">数据项的结构</h3>
<p>每个数据项由以下部分组成：</p>
<ol>
<li><strong>前置节点长度（PrevEntryLength）</strong>：表示前一个节点的长度。</li>
<li><strong>编码方式（Encoding）</strong>：表示当前节点的类型和编码方式。</li>
<li><strong>实际数据（Content）</strong>：当前节点的实际数据。</li>
</ol>
<h4 data-id="heading-3">数据项的结构定义</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ziplistEntry</span> {</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> prevrawlen;  <span class="hljs-comment">// 前一个节点的长度</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> encoding;    <span class="hljs-comment">// 当前节点的数据类型和编码方式</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *p;         <span class="hljs-comment">// 指向实际数据的指针</span>
} ziplistEntry;
</code></pre>
<h3 data-id="heading-4">主要操作</h3>
<h4 data-id="heading-5">1. 压缩列表的创建</h4>
<p>创建一个新的压缩列表，并初始化其头部和尾部。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *<span class="hljs-title function_">ziplistNew</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> {
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> bytes = ZIPLIST_HEADER_SIZE+<span class="hljs-number">1</span>; <span class="hljs-comment">// 头部 + 尾部</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *zl = zmalloc(bytes);

    ZIPLIST_BYTES(zl) = intrev32ifbe(bytes);  <span class="hljs-comment">// 设置 zlbytes</span>
    ZIPLIST_TAIL_OFFSET(zl) = intrev32ifbe(ZIPLIST_HEADER_SIZE);  <span class="hljs-comment">// 设置 zltail</span>
    ZIPLIST_LENGTH(zl) = <span class="hljs-number">0</span>;  <span class="hljs-comment">// 设置 zllen</span>
    zl[bytes<span class="hljs-number">-1</span>] = ZIP_END;  <span class="hljs-comment">// 设置 zlend</span>

    <span class="hljs-keyword">return</span> zl;
}
</code></pre>
<h4 data-id="heading-6">2. 插入操作</h4>
<p>插入一个新的数据项到压缩列表中。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *<span class="hljs-title function_">ziplistInsert</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *zl, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *p, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *s, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> slen)</span> {
    <span class="hljs-type">size_t</span> curlen = intrev32ifbe(ZIPLIST_BYTES(zl));
    <span class="hljs-type">size_t</span> reqlen;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> encoding = <span class="hljs-number">0</span>;
    <span class="hljs-type">long</span> <span class="hljs-type">long</span> value;

    <span class="hljs-comment">// 计算插入数据所需的空间</span>
    <span class="hljs-keyword">if</span> (zipTryEncoding(s, slen, &amp;value, &amp;encoding)) {
        reqlen = zipIntSize(encoding);
    } <span class="hljs-keyword">else</span> {
        reqlen = slen;
    }

    <span class="hljs-comment">// 计算新节点的总长度</span>
    reqlen += zipStorePrevEntryLength(<span class="hljs-literal">NULL</span>, curlen);
    reqlen += zipStoreEntryEncoding(<span class="hljs-literal">NULL</span>, encoding, slen);

    zl = zrealloc(zl, curlen + reqlen);
    p = zl + (p - zl);

    <span class="hljs-comment">// 更新头部信息</span>
    memmove(p + reqlen, p, curlen - (p - zl));
    zipStorePrevEntryLength(p, curlen);
    p += zipStoreEntryEncoding(p, encoding, slen);
    
    <span class="hljs-keyword">if</span> (encoding == ZIP_INT_8B) {
        p[<span class="hljs-number">0</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>)value;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (encoding == ZIP_INT_16B) {
        <span class="hljs-type">int16_t</span> i16 = (<span class="hljs-type">int16_t</span>)value;
        <span class="hljs-built_in">memcpy</span>(p, &amp;i16, <span class="hljs-keyword">sizeof</span>(i16));
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (encoding == ZIP_INT_32B) {
        <span class="hljs-type">int32_t</span> i32 = (<span class="hljs-type">int32_t</span>)value;
        <span class="hljs-built_in">memcpy</span>(p, &amp;i32, <span class="hljs-keyword">sizeof</span>(i32));
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (encoding == ZIP_INT_64B) {
        <span class="hljs-type">int64_t</span> i64 = (<span class="hljs-type">int64_t</span>)value;
        <span class="hljs-built_in">memcpy</span>(p, &amp;i64, <span class="hljs-keyword">sizeof</span>(i64));
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">memcpy</span>(p, s, slen);
    }

    ZIPLIST_BYTES(zl) = intrev32ifbe(curlen + reqlen);
    ZIPLIST_TAIL_OFFSET(zl) = intrev32ifbe(curlen + reqlen - (p - zl));
    ZIPLIST_LENGTH(zl) = intrev16ifbe(intrev16ifbe(ZIPLIST_LENGTH(zl)) + <span class="hljs-number">1</span>);

    <span class="hljs-keyword">return</span> zl;
}
</code></pre>
<h4 data-id="heading-7">3. 删除操作</h4>
<p>从压缩列表中删除一个数据项。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *<span class="hljs-title function_">ziplistDelete</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *zl, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> **p)</span> {
    <span class="hljs-type">size_t</span> curlen = intrev32ifbe(ZIPLIST_BYTES(zl));
    <span class="hljs-type">size_t</span> reqlen = zipRawEntryLength(*p);
    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *ptr = *p;
    <span class="hljs-type">size_t</span> offset = ptr - zl;

    <span class="hljs-comment">// 删除节点</span>
    memmove(ptr, ptr+reqlen, curlen-(offset+reqlen));
    zl = zrealloc(zl, curlen-reqlen);

    <span class="hljs-comment">// 更新头部信息</span>
    ZIPLIST_BYTES(zl) = intrev32ifbe(curlen-reqlen);
    ZIPLIST_TAIL_OFFSET(zl) = intrev32ifbe(intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))-reqlen);
    ZIPLIST_LENGTH(zl) = intrev16ifbe(intrev16ifbe(ZIPLIST_LENGTH(zl))<span class="hljs-number">-1</span>);

    <span class="hljs-keyword">return</span> zl;
}
</code></pre>
<h3 data-id="heading-8">辅助函数</h3>
<h4 data-id="heading-9">编码和存储长度</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">zipStorePrevEntryLength</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *p, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> len)</span> {
    <span class="hljs-keyword">if</span> (p == <span class="hljs-literal">NULL</span>) {
        <span class="hljs-keyword">return</span> (len &lt; ZIP_BIG_PREVLEN) ? <span class="hljs-number">1</span> : <span class="hljs-number">5</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (len &lt; ZIP_BIG_PREVLEN) {
            p[<span class="hljs-number">0</span>] = len;
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        } <span class="hljs-keyword">else</span> {
            p[<span class="hljs-number">0</span>] = ZIP_BIG_PREVLEN;
            <span class="hljs-built_in">memcpy</span>(p+<span class="hljs-number">1</span>, &amp;len, <span class="hljs-keyword">sizeof</span>(len));
            <span class="hljs-keyword">return</span> <span class="hljs-number">5</span>;
        }
    }
}

<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">zipStoreEntryEncoding</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *p, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> encoding, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> rawlen)</span> {
    <span class="hljs-keyword">if</span> (p == <span class="hljs-literal">NULL</span>) {
        <span class="hljs-keyword">if</span> (ZIP_IS_STR(encoding)) {
            <span class="hljs-keyword">if</span> (rawlen &lt;= <span class="hljs-number">0x3f</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rawlen &lt;= <span class="hljs-number">0x3fff</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-number">5</span>;
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        }
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (ZIP_IS_STR(encoding)) {
            <span class="hljs-keyword">if</span> (rawlen &lt;= <span class="hljs-number">0x3f</span>) {
                p[<span class="hljs-number">0</span>] = ZIP_STR_06B | rawlen;
                <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rawlen &lt;= <span class="hljs-number">0x3fff</span>) {
                p[<span class="hljs-number">0</span>] = ZIP_STR_14B | ((rawlen &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0x3f</span>);
                p[<span class="hljs-number">1</span>] = rawlen &amp; <span class="hljs-number">0xff</span>;
                <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;
            } <span class="hljs-keyword">else</span> {
                p[<span class="hljs-number">0</span>] = ZIP_STR_32B;
                <span class="hljs-built_in">memcpy</span>(p+<span class="hljs-number">1</span>, &amp;rawlen, <span class="hljs-keyword">sizeof</span>(rawlen));
                <span class="hljs-keyword">return</span> <span class="hljs-number">5</span>;
            }
        } <span class="hljs-keyword">else</span> {
            p[<span class="hljs-number">0</span>] = encoding;
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        }
    }
}
</code></pre>
<h3 data-id="heading-10">示例使用</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *zl = ziplistNew();
    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *p;

    <span class="hljs-comment">// 插入数据项</span>
    zl = ziplistInsert(zl, zl + ZIPLIST_HEADER_SIZE, (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)<span class="hljs-string">"hello"</span>, <span class="hljs-number">5</span>);
    zl = ziplistInsert(zl, zl + ZIPLIST_HEADER_SIZE, (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)<span class="hljs-string">"world"</span>, <span class="hljs-number">5</span>);

    p = zl + ZIPLIST_HEADER_SIZE;
    <span class="hljs-keyword">while</span> (*p != ZIP_END) {
        <span class="hljs-comment">// 访问数据项</span>
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s\n"</span>, p + <span class="hljs-number">1</span>); <span class="hljs-comment">// 打印数据项内容</span>
        p += zipRawEntryLength(p);
    }

    <span class="hljs-comment">// 删除数据项</span>
    zl = ziplistDelete(zl, &amp;p);

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>总结：压缩列表（ziplist）通过紧凑的内存布局和灵活的编码方式实现了高效的内存利用。它适用于存储短小数据的场景，通过精心设计的数据结构，保证了高效的插入、删除和查找操作。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Swift 6 迁移常见 crash: _dispatch_assert_queue_fail]]></title>    <link>https://juejin.cn/post/7573525927793737754</link>    <guid>https://juejin.cn/post/7573525927793737754</guid>    <pubDate>2025-11-17T17:21:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573525927793737754" data-draft-id="7573519273030615086" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Swift 6 迁移常见 crash: _dispatch_assert_queue_fail"/> <meta itemprop="keywords" content="Swift,SwiftUI"/> <meta itemprop="datePublished" content="2025-11-17T17:21:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RickeyBoy"/> <meta itemprop="url" content="https://juejin.cn/user/2928754706626136"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Swift 6 迁移常见 crash: _dispatch_assert_queue_fail
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2928754706626136/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RickeyBoy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T17:21:00.000Z" title="Mon Nov 17 2025 17:21:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>我的 Github：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FRickeyBoy%2FRickey-iOS-Notes%3Ftab%3Dreadme-ov-file" target="_blank" title="https://github.com/RickeyBoy/Rickey-iOS-Notes?tab=readme-ov-file" ref="nofollow noopener noreferrer">github.com/RickeyBoy/R…</a></p>
<p>大量 iOS 内容欢迎大家关注~</p>
</blockquote>
<p>最近在将公司项目迁移到 Swift 6 的过程中，解决了好几个相似的 crash。关键字如下</p>
<pre><code class="hljs language-Swift" lang="Swift">    _dispatch_assert_queue_fail
    
    <span class="hljs-string">"%sBlock was %sexpected to execute on queue [%s (%p)]
    
    Task 208: EXC_BREAKPOINT (code=1, subcode=0x103546f18)
</span></code></pre>
<p>在这里记录和分享，希望遇到相似的问题之后能够更快的解决。</p>
<h2 data-id="heading-0">Crash 1 信息</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/401aa2b8456a451bb9126dd29819f501~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmlja2V5Qm95:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764004859&amp;x-signature=sV5ZX53rOCnMQ%2BKlFTYgA33EDyk%3D" alt="image1.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b72bb0e8bcc94b5698585bd52d77b9a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmlja2V5Qm95:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764004859&amp;x-signature=Tmroj40eTshiska0Z8maHeMOmmI%3D" alt="image2.png" loading="lazy"/></p>
<h2 data-id="heading-1">原因与解决 1</h2>
<p>首先根据 crash 的提示，可以清楚地知道：Block 预期在一个线程上执行，而实际在另一个线程上执行。第一反应：大概率是主线程 vs 后台线程之间的不一致导致的。</p>
<p>如果经常熟练处理 Swift 6 升级的小伙伴就知道，一定是有地方标记了 <code>@MainActor</code>，也就意味着相对应的方法一定是要在主线程上执行的；而实际阴差阳错，在后台线程执行了。</p>
<p>所以接下来可能需要找，到底哪里线程不一致呢？我们根据代码来寻找即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93196cc2304f412f8b3d4580ce12f5b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmlja2V5Qm95:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764004859&amp;x-signature=SJBKdw4GxcAi2mhkHFKGz7G%2Bods%3D" alt="image3.png" loading="lazy"/></p>
<p>不难找到，根据 Combine 调用链，可以发现其中一处对于 <code>userPublisher</code> 的监听时，选择了在 <code>global</code> 上去执行后面的操作，所以这里需要将这一个逻辑去掉。</p>
<p>于此同时，对于 <code>userPublisher</code> 的发布，我们也最好将其默认放在主线程上，因为他是和 UI 相关的，所以需要做这样的改动：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb6c0a185cd74042976a3644d48f7a3e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmlja2V5Qm95:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764004859&amp;x-signature=Ie%2BLXY%2BIXpAVE5HaVNlrqjaviVA%3D" alt="image4.png" loading="lazy"/></p>
<h2 data-id="heading-2">坑点</h2>
<p>目前是不是觉得好像这个类型的 crash 不算很难解决？没错，这个 crash 的提示相对清楚，知道大概原因后去找就相对容易了。</p>
<p>不过需要注意的是，当使用 Combine 框架遇上这类型的 crash 时，crash 断点只会发生在 <code>Publisher</code> 而不是 <code>Observer</code> 处，所以我们需要自己去寻找调用方，看下在哪里出现了线程使用不一致的问题。</p>
<h2 data-id="heading-3">Crash 2 信息</h2>
<p>好的，那么同类型的一个 crash 再来看看：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88360664b0a04f2ba0986ce8914e539c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmlja2V5Qm95:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764004859&amp;x-signature=1I9XKAmFoHeK61qR8KQ5hS%2FqL84%3D" alt="image5.png" loading="lazy"/></p>
<p>报错信息就不贴了，和上一个 crash 是一样的，都是：<code>"%sBlock was %sexpected to execute on queue [%s (%p)]</code></p>
<p>这里可以看到，crash 断点处在子线程，也是在 AsyncStream 发布处断点。那么根据经验推断，可以大概知道原因：</p>
<ol start="0">
<li>此处发布的时候，处在子线程</li>
<li>下游调用方，一定有某个地方要求在主线程</li>
<li>实际线程与要求线程不一致，所以导致 crash</li>
</ol>
<h2 data-id="heading-4">原因与解决 2</h2>
<p>这里寻找过程就不赘述了。原来的发布者是处在子线程，而后面的监听者处在主线程，因此需要改在主线程发布。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ee6ac69b29b438e9a54cf895bdcd5c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmlja2V5Qm95:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764004859&amp;x-signature=GLnKOIsF5re2WosQBb6XKtl%2BXrw%3D" alt="image6.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[学习编写chrome插件：Hello World 扩展]]></title>    <link>https://juejin.cn/post/7573525927793721370</link>    <guid>https://juejin.cn/post/7573525927793721370</guid>    <pubDate>2025-11-17T16:51:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573525927793721370" data-draft-id="7573579203460038707" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="学习编写chrome插件：Hello World 扩展"/> <meta itemprop="keywords" content="Chrome,前端"/> <meta itemprop="datePublished" content="2025-11-17T16:51:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Keely40285"/> <meta itemprop="url" content="https://juejin.cn/user/2594503171249997"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            学习编写chrome插件：Hello World 扩展
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2594503171249997/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Keely40285
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T16:51:05.000Z" title="Mon Nov 17 2025 16:51:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">编写 Hello World</h2>
<p>以下内容主要参考： <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.chrome.com%2Fdocs%2Fextensions%2Fget-started%2Ftutorial%2Fhello-world%3Fhl%3Dzh-cn" target="_blank" title="https://developer.chrome.com/docs/extensions/get-started/tutorial/hello-world?hl=zh-cn" ref="nofollow noopener noreferrer">chrome文档-Hello World 扩展</a></p>
<h3 data-id="heading-1">1. 创建项目</h3>
<p>创建项目，在根目录创建 manifest.json 文件，添加如下内容：</p>
<ul>
<li>文件中的各个字段含义清单请<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.chrome.com%2Fdocs%2Fextensions%2Freference%2Fmanifest%3Fhl%3Dzh-cn" target="_blank" title="https://developer.chrome.com/docs/extensions/reference/manifest?hl=zh-cn" ref="nofollow noopener noreferrer">点击查看清单文件格式</a></li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Hello Keely"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"keely的插件"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"manifest_version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"default_popup"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"hello.html"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"default_icon"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"hello.png"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>创建 hello.html，填入如下内容</p>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">html</span>&gt;
  &lt;<span class="hljs-selector-tag">body</span>&gt;
    &lt;<span class="hljs-selector-tag">h1</span>&gt;Hello Keely&lt;/<span class="hljs-selector-tag">h1</span>&gt;
  &lt;/<span class="hljs-selector-tag">body</span>&gt;
&lt;/<span class="hljs-selector-tag">html</span>&gt;
</code></pre>
<p>项目结构如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66c17c9d7ccd454e80593c7c14f107de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2VlbHk0MDI4NQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764003065&amp;x-signature=FzKWN4pqmmCSVoWsIVjXtZkX%2Bq0%3D" alt="项目目录如下.png" loading="lazy"/></p>
<h3 data-id="heading-2">2. 加载未打包的扩展程序</h3>
<ul>
<li>在chrome新标签页中输入 <code>chrome://extensions</code> 即可前往“扩展程序”页面。</li>
<li>打开开发者模式</li>
<li>加载未打包扩展程序：选择刚才创建的项目目录即可</li>
<li>每次程序更新后，可以点击右下角的<strong>刷新icon</strong>进行插件的刷新</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cf538b26f034fcaa06c07b7c9b106cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2VlbHk0MDI4NQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764003065&amp;x-signature=6t4ahSP%2FmQs7OepqHzq3x3IH8aU%3D" alt="扩展程序.png" loading="lazy"/></p>
<h3 data-id="heading-3">3. 查看扩展程序：</h3>
<p>点击扩展程序的icon，找到刚才导入的插件</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df0fb69c0191466f80586c7c18faa3ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2VlbHk0MDI4NQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764003065&amp;x-signature=t4wNkmuPwTcahdC0lKuT7jwxWNA%3D" alt="扩展程序.png" loading="lazy"/></p>
<p>点击插件效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9056af9bd63418cb1aeadde480c94a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2VlbHk0MDI4NQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764003065&amp;x-signature=qqD8n6CzXuYrZ87Cy9UOrhr4QM8%3D" alt="hello keely.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Langchain Template 全面指南]]></title>    <link>https://juejin.cn/post/7573535624532639763</link>    <guid>https://juejin.cn/post/7573535624532639763</guid>    <pubDate>2025-11-17T16:51:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573535624532639763" data-draft-id="7573524348130050111" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Langchain Template 全面指南"/> <meta itemprop="keywords" content="LangChain,OpenAI"/> <meta itemprop="datePublished" content="2025-11-17T16:51:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端小东"/> <meta itemprop="url" content="https://juejin.cn/user/932815872994359"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Langchain Template 全面指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/932815872994359/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端小东
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T16:51:42.000Z" title="Mon Nov 17 2025 16:51:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p><code>LangChain Template</code> 是 LangChain 提示工程的核心组件，用于动态生成模型的输入。</p>
<p>🎯 <strong>Template</strong> 的核心概念：</p>
<p><strong>Template</strong> 本质是一个带有<strong>占位符</strong>的文本字符串，这些占位符会在运行时被具体的值填充。它的主要目的是将<strong>提示逻辑</strong>与<strong>业务数据</strong>分离。</p>
<h2 data-id="heading-1">模板分类</h2>
<h3 data-id="heading-2">1. 🎯 基础模板类（Core Templates）</h3>
<h4 data-id="heading-3">(1) <code>PromptTemplate</code></h4>
<p><strong>最基础的文本模板</strong></p>
<pre><code class="hljs language-ini" lang="ini">from langchain.prompts import PromptTemplate

<span class="hljs-comment"># 创建模板的两种方式</span>
<span class="hljs-comment"># 方式1: 使用 from_template (推荐)</span>
<span class="hljs-attr">template</span> = PromptTemplate.from_template(<span class="hljs-string">"请把{text}翻译成{language}"</span>)
<span class="hljs-attr">result</span> = template.format(text=<span class="hljs-string">"Hello"</span>, language=<span class="hljs-string">"中文"</span>)
print(result)  <span class="hljs-comment"># 输出: "请把Hello翻译成中文"</span>

<span class="hljs-comment"># 方式2: 传统创建方式</span>
<span class="hljs-attr">template</span> = PromptTemplate(
    <span class="hljs-attr">input_variables</span>=[<span class="hljs-string">"text"</span>, <span class="hljs-string">"language"</span>],
    <span class="hljs-attr">template</span>=<span class="hljs-string">"请把{text}翻译成{language}"</span>
)

<span class="hljs-comment"># 实际应用示例</span>
<span class="hljs-attr">translation_template</span> = PromptTemplate.from_template(
    "将以下{source_lang}文本翻译成{target_lang}：{text}"
)
<span class="hljs-attr">translation_result</span> = translation_template.format(
    <span class="hljs-attr">source_lang</span>=<span class="hljs-string">"英文"</span>,
    <span class="hljs-attr">target_lang</span>=<span class="hljs-string">"中文"</span>, 
    <span class="hljs-attr">text</span>=<span class="hljs-string">"Hello, how are you?"</span>
)
</code></pre>
<h4 data-id="heading-4">(2) <code>ChatPromptTemplate</code></h4>
<p><strong>聊天消息模板（最常用）</strong></p>
<pre><code class="hljs language-ini" lang="ini">from langchain.prompts import ChatPromptTemplate

<span class="hljs-comment"># 创建聊天提示模板</span>
<span class="hljs-attr">chat_prompt</span> = ChatPromptTemplate.from_messages([
    (<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是一个{role}"</span>),
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"请回答：{question}"</span>)
])

<span class="hljs-comment"># 格式化模板</span>
<span class="hljs-attr">messages</span> = chat_prompt.format_messages(
    <span class="hljs-attr">role</span>=<span class="hljs-string">"数学老师"</span>,
    <span class="hljs-attr">question</span>=<span class="hljs-string">"什么是勾股定理？"</span>
)

<span class="hljs-comment"># 实际应用：客服机器人模板</span>
<span class="hljs-attr">customer_service_prompt</span> = ChatPromptTemplate.from_messages([
    (<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是{company}的客服代表，专门处理{department}问题"</span>),
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"我遇到了一个问题：{issue_description}"</span>),
    (<span class="hljs-string">"ai"</span>, <span class="hljs-string">"我很理解您的情况，让我来帮您解决。"</span>),
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"具体的细节是：{details}"</span>)
])
</code></pre>
<h3 data-id="heading-5">2. 👥 消息模板类（Message Templates）</h3>
<p>这些是 <code>ChatPromptTemplate</code> 的组成部分：</p>
<pre><code class="hljs language-ini" lang="ini">from langchain.prompts import (
    SystemMessagePromptTemplate,
    HumanMessagePromptTemplate,
    AIMessagePromptTemplate,
    FunctionMessagePromptTemplate
)

<span class="hljs-comment"># 创建各种消息模板</span>
<span class="hljs-attr">system_template</span> = SystemMessagePromptTemplate.from_template(
    "你是{role}，具有{expertise}专业知识"
)
<span class="hljs-attr">human_template</span> = HumanMessagePromptTemplate.from_template(
    "我的问题是：{question}"
)
<span class="hljs-attr">ai_template</span> = AIMessagePromptTemplate.from_template(
    "根据我的知识，{answer}"
)

<span class="hljs-comment"># 组合使用</span>
<span class="hljs-attr">chat_prompt</span> = ChatPromptTemplate.from_messages([
    system_template, 
    human_template,
    ai_template
])

<span class="hljs-comment"># 完整示例：编程助手</span>
<span class="hljs-attr">programming_prompt</span> = ChatPromptTemplate.from_messages([
    SystemMessagePromptTemplate.from_template(
        <span class="hljs-string">"你是{language}编程专家，擅长{domain}开发"</span>
    ),
    HumanMessagePromptTemplate.from_template(
        <span class="hljs-string">"请帮我解决这个编程问题：{problem}"</span>
    ),
    AIMessagePromptTemplate.from_template(
        <span class="hljs-string">"我会按照以下思路解决：{approach}"</span>
    ),
    HumanMessagePromptTemplate.from_template(
        <span class="hljs-string">"具体实现代码是？"</span>
    )
])
</code></pre>
<h3 data-id="heading-6">3. 🎪 高级模板类（Advanced Templates）</h3>
<h4 data-id="heading-7">(7) <code>FewShotPromptTemplate</code></h4>
<p><strong>少样本学习模板</strong></p>
<pre><code class="hljs language-ini" lang="ini">from langchain.prompts import FewShotPromptTemplate, PromptTemplate

<span class="hljs-comment"># 定义示例数据</span>
<span class="hljs-attr">examples</span> = [
    {
        <span class="hljs-string">"input"</span>: <span class="hljs-string">"The weather is nice today"</span>, 
        <span class="hljs-string">"output"</span>: <span class="hljs-string">"今天天气很好"</span>
    },
    {
        <span class="hljs-string">"input"</span>: <span class="hljs-string">"I love programming"</span>, 
        <span class="hljs-string">"output"</span>: <span class="hljs-string">"我喜欢编程"</span>
    },
    {
        <span class="hljs-string">"input"</span>: <span class="hljs-string">"The meeting starts at 3 PM"</span>, 
        <span class="hljs-string">"output"</span>: <span class="hljs-string">"会议下午三点开始"</span>
    }
]

<span class="hljs-comment"># 定义单个示例的模板</span>
<span class="hljs-attr">example_template</span> = PromptTemplate.from_template(
    "英文: {input}\n中文: {output}"
)

<span class="hljs-comment"># 创建少样本提示模板</span>
<span class="hljs-attr">few_shot_prompt</span> = FewShotPromptTemplate(
    <span class="hljs-attr">examples</span>=examples,
    <span class="hljs-attr">example_prompt</span>=example_template,
    <span class="hljs-attr">prefix</span>=<span class="hljs-string">"请根据以下示例将英文翻译成中文："</span>,
    <span class="hljs-attr">suffix</span>=<span class="hljs-string">"英文: {input}\n中文:"</span>,
    <span class="hljs-attr">input_variables</span>=[<span class="hljs-string">"input"</span>]
)

<span class="hljs-comment"># 使用示例</span>
<span class="hljs-attr">result</span> = few_shot_prompt.format(input=<span class="hljs-string">"Thank you for your help"</span>)
print("=== 生成的提示 ===")
print(result)

<span class="hljs-comment"># 实际应用：情感分析少样本模板</span>
<span class="hljs-attr">sentiment_examples</span> = [
    {<span class="hljs-string">"text"</span>: <span class="hljs-string">"这个产品太棒了！"</span>, <span class="hljs-string">"sentiment"</span>: <span class="hljs-string">"正面"</span>},
    {<span class="hljs-string">"text"</span>: <span class="hljs-string">"服务很差，很不满意"</span>, <span class="hljs-string">"sentiment"</span>: <span class="hljs-string">"负面"</span>},
    {<span class="hljs-string">"text"</span>: <span class="hljs-string">"还可以，一般般"</span>, <span class="hljs-string">"sentiment"</span>: <span class="hljs-string">"中性"</span>}
]

<span class="hljs-attr">sentiment_template</span> = FewShotPromptTemplate(
    <span class="hljs-attr">examples</span>=sentiment_examples,
    <span class="hljs-attr">example_prompt</span>=PromptTemplate.from_template(
        "文本: {text}\n情感: {sentiment}"
    ),
    <span class="hljs-attr">prefix</span>=<span class="hljs-string">"分析以下文本的情感倾向："</span>,
    <span class="hljs-attr">suffix</span>=<span class="hljs-string">"文本: {text}\n情感:"</span>,
    <span class="hljs-attr">input_variables</span>=[<span class="hljs-string">"text"</span>]
)
</code></pre>
<h4 data-id="heading-8">(8) <code>FewShotChatMessagePromptTemplate</code></h4>
<p><strong>聊天版的少样本模板</strong></p>
<pre><code class="hljs language-ini" lang="ini">from langchain.prompts import FewShotChatMessagePromptTemplate, ChatPromptTemplate

<span class="hljs-comment"># 定义聊天示例</span>
<span class="hljs-attr">chat_examples</span> = [
    {
        <span class="hljs-string">"input"</span>: <span class="hljs-string">"今天的天气怎么样？"</span>,
        <span class="hljs-string">"output"</span>: <span class="hljs-string">"我无法获取实时天气信息，请查看天气预报应用。"</span>
    },
    {
        <span class="hljs-string">"input"</span>: <span class="hljs-string">"现在几点了？"</span>,
        <span class="hljs-string">"output"</span>: <span class="hljs-string">"我无法获取当前时间，请查看您的设备时钟。"</span>
    },
    {
        <span class="hljs-string">"input"</span>: <span class="hljs-string">"我的快递到哪里了？"</span>, 
        <span class="hljs-string">"output"</span>: <span class="hljs-string">"我无法查询物流信息，请使用快递公司的官方应用查询。"</span>
    }
]

<span class="hljs-comment"># 创建示例模板</span>
<span class="hljs-attr">example_prompt</span> = ChatPromptTemplate.from_messages([
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{input}"</span>),
    (<span class="hljs-string">"ai"</span>, <span class="hljs-string">"{output}"</span>)
])

<span class="hljs-comment"># 创建少样本聊天模板</span>
<span class="hljs-attr">few_shot_chat</span> = FewShotChatMessagePromptTemplate(
    <span class="hljs-attr">examples</span>=chat_examples,
    <span class="hljs-attr">example_prompt</span>=example_prompt
)

<span class="hljs-comment"># 组合到完整提示中</span>
<span class="hljs-attr">final_prompt</span> = ChatPromptTemplate.from_messages([
    (<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是一个有帮助的AI助手，请礼貌地回答用户问题。"</span>),
    few_shot_chat,
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{user_input}"</span>)
])

<span class="hljs-comment"># 使用示例</span>
<span class="hljs-attr">messages</span> = final_prompt.format_messages(
    <span class="hljs-attr">user_input</span>=<span class="hljs-string">"我的银行余额是多少？"</span>
)
</code></pre>
<h3 data-id="heading-9">4. 🧩 特殊用途模板</h3>
<h4 data-id="heading-10">(9) <code>MessagesPlaceholder</code></h4>
<p><strong>消息占位符（用于动态插入消息）</strong></p>
<pre><code class="hljs language-ini" lang="ini">from langchain.prompts import MessagesPlaceholder, ChatPromptTemplate

<span class="hljs-comment"># 创建带消息占位符的模板</span>
<span class="hljs-attr">prompt_with_history</span> = ChatPromptTemplate.from_messages([
    (<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是专业的{expert_role}"</span>),
    MessagesPlaceholder(variable_name=<span class="hljs-string">"chat_history"</span>),
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{current_question}"</span>)
])

<span class="hljs-comment"># 模拟对话历史</span>
<span class="hljs-attr">chat_history</span> = [
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"human"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"什么是Python？"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"ai"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"Python是一种编程语言。"</span>}
]

<span class="hljs-comment"># 格式化模板</span>
<span class="hljs-attr">messages</span> = prompt_with_history.format_messages(
    <span class="hljs-attr">expert_role</span>=<span class="hljs-string">"编程教师"</span>,
    <span class="hljs-attr">chat_history</span>=chat_history,
    <span class="hljs-attr">current_question</span>=<span class="hljs-string">"Python有什么特点？"</span>
)

<span class="hljs-comment"># 实际应用：带记忆的对话系统</span>
<span class="hljs-attr">memory_prompt</span> = ChatPromptTemplate.from_messages([
    (<span class="hljs-string">"system"</span>, <span class="hljs-string">"""你是{assistant_name}，具有以下特点：
    - 专业领域: {expertise}
    - 回答风格: {style}
    - 语言: {language}"""</span>),
    
    MessagesPlaceholder(variable_name=<span class="hljs-string">"conversation_history"</span>),
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{current_input}"</span>)
])
</code></pre>
<h2 data-id="heading-11">🔗 Template 关系图谱</h2>
<pre><code class="hljs language-scss" lang="scss">PromptTemplate (基类)
    │
    ├── ChatPromptTemplate (组合多个消息)
    │       ├── SystemMessagePromptTemplate
    │       ├── HumanMessagePromptTemplate  
    │       ├── AIMessagePromptTemplate
    │       └── FunctionMessagePromptTemplate
    │
    ├── FewShotPromptTemplate (包含example_prompt)
    │
    └── FewShotChatMessagePromptTemplate (专门用于聊天)
</code></pre>
<h2 data-id="heading-12">🎯 核心关系说明</h2>
<h3 data-id="heading-13">关系1：<strong>包含关系</strong></h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># FewShotPromptTemplate 包含 PromptTemplate</span>
<span class="hljs-attr">examples</span> = [
    {<span class="hljs-string">"input"</span>: <span class="hljs-string">"hello"</span>, <span class="hljs-string">"output"</span>: <span class="hljs-string">"你好"</span>},
    {<span class="hljs-string">"input"</span>: <span class="hljs-string">"goodbye"</span>, <span class="hljs-string">"output"</span>: <span class="hljs-string">"再见"</span>}
]

<span class="hljs-attr">example_prompt</span> = PromptTemplate.from_template(
    "输入: {input}\n输出: {output}"
)

<span class="hljs-attr">few_shot_prompt</span> = FewShotPromptTemplate(
    <span class="hljs-attr">example_prompt</span>=example_prompt,  <span class="hljs-comment"># 包含关系</span>
    <span class="hljs-attr">examples</span>=examples,
    <span class="hljs-attr">prefix</span>=<span class="hljs-string">"翻译任务："</span>,
    <span class="hljs-attr">suffix</span>=<span class="hljs-string">"输入: {input}\n输出:"</span>,
    <span class="hljs-attr">input_variables</span>=[<span class="hljs-string">"input"</span>]
)

<span class="hljs-comment"># ChatPromptTemplate 包含 MessagePromptTemplates</span>
<span class="hljs-attr">system_template</span> = SystemMessagePromptTemplate.from_template(<span class="hljs-string">"系统: {role}"</span>)
<span class="hljs-attr">human_template</span> = HumanMessagePromptTemplate.from_template(<span class="hljs-string">"用户: {question}"</span>)

<span class="hljs-attr">chat_prompt</span> = ChatPromptTemplate.from_messages([
    system_template,    <span class="hljs-comment"># 包含关系</span>
    human_template      <span class="hljs-comment"># 包含关系</span>
])
</code></pre>
<h3 data-id="heading-14">关系2：<strong>组合关系</strong></h3>
<pre><code class="hljs language-ini" lang="ini">from langchain.prompts import ChatPromptTemplate, FewShotChatMessagePromptTemplate

<span class="hljs-comment"># 创建少样本部分</span>
<span class="hljs-attr">few_shot_examples</span> = [
    {<span class="hljs-string">"input"</span>: <span class="hljs-string">"如何学习编程？"</span>, <span class="hljs-string">"output"</span>: <span class="hljs-string">"建议从基础语法开始..."</span>},
    {<span class="hljs-string">"input"</span>: <span class="hljs-string">"最好的编程语言？"</span>, <span class="hljs-string">"output"</span>: <span class="hljs-string">"这取决于你的目标..."</span>}
]

<span class="hljs-attr">few_shot_section</span> = FewShotChatMessagePromptTemplate(
    <span class="hljs-attr">example_prompt</span>=ChatPromptTemplate.from_messages([
        (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{input}"</span>),
        (<span class="hljs-string">"ai"</span>, <span class="hljs-string">"{output}"</span>)
    ]),
    <span class="hljs-attr">examples</span>=few_shot_examples
)

<span class="hljs-comment"># FewShotChatMessagePromptTemplate 作为 ChatPromptTemplate 的一部分</span>
<span class="hljs-attr">final_prompt</span> = ChatPromptTemplate.from_messages([
    (<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是{teacher_type}老师"</span>),
    few_shot_section,  <span class="hljs-comment"># 组合关系</span>
    MessagesPlaceholder(variable_name=<span class="hljs-string">"history"</span>),  <span class="hljs-comment"># 组合关系</span>
    HumanMessagePromptTemplate.from_template(<span class="hljs-string">"{current_input}"</span>)
])

<span class="hljs-comment"># 使用组合模板</span>
<span class="hljs-attr">formatted_messages</span> = final_prompt.format_messages(
    <span class="hljs-attr">teacher_type</span>=<span class="hljs-string">"编程"</span>,
    <span class="hljs-attr">history</span>=[],
    <span class="hljs-attr">current_input</span>=<span class="hljs-string">"如何调试代码？"</span>
)
</code></pre>
<h2 data-id="heading-15">🛠️ 实际使用场景对比</h2>
<h3 data-id="heading-16">场景1：简单文本生成 → <code>PromptTemplate</code></h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 诗歌生成</span>
<span class="hljs-attr">poem_template</span> = PromptTemplate.from_template(<span class="hljs-string">"""
请以{style}风格写一首关于{topic}的诗。

要求：
- 意境: {mood}
- 长度: {length}
- 语言: {language}

诗歌：
"""</span>)

<span class="hljs-attr">poem_prompt</span> = poem_template.format(
    <span class="hljs-attr">style</span>=<span class="hljs-string">"浪漫"</span>,
    <span class="hljs-attr">topic</span>=<span class="hljs-string">"春天"</span>, 
    <span class="hljs-attr">mood</span>=<span class="hljs-string">"欢快"</span>,
    <span class="hljs-attr">length</span>=<span class="hljs-string">"八句"</span>,
    <span class="hljs-attr">language</span>=<span class="hljs-string">"中文"</span>
)
</code></pre>
<h3 data-id="heading-17">场景2：聊天对话 → <code>ChatPromptTemplate</code> + <code>MessageTemplates</code></h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 专业咨询对话</span>
<span class="hljs-attr">system_msg</span> = SystemMessagePromptTemplate.from_template(<span class="hljs-string">"""
你是{profession}顾问，具有以下资质：
- 经验: {experience}
- 专长: {specialization} 
- 认证: {certifications}
"""</span>)

<span class="hljs-attr">human_msg</span> = HumanMessagePromptTemplate.from_template(<span class="hljs-string">"""
我的咨询问题是：{question}

背景信息：
{context}
"""</span>)

<span class="hljs-attr">chat_prompt</span> = ChatPromptTemplate.from_messages([system_msg, human_msg])

<span class="hljs-comment"># 使用示例</span>
<span class="hljs-attr">messages</span> = chat_prompt.format_messages(
    <span class="hljs-attr">profession</span>=<span class="hljs-string">"法律"</span>,
    <span class="hljs-attr">experience</span>=<span class="hljs-string">"10年"</span>,
    <span class="hljs-attr">specialization</span>=<span class="hljs-string">"合同法"</span>,
    <span class="hljs-attr">certifications</span>=<span class="hljs-string">"律师执业证"</span>,
    <span class="hljs-attr">question</span>=<span class="hljs-string">"合同违约如何处理？"</span>,
    <span class="hljs-attr">context</span>=<span class="hljs-string">"甲方未按约定时间付款"</span>
)
</code></pre>
<h3 data-id="heading-18">场景3：示例学习 → <code>FewShotPromptTemplate</code></h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 代码生成少样本学习</span>
<span class="hljs-attr">code_examples</span> = [
    {
        <span class="hljs-string">"requirement"</span>: <span class="hljs-string">"计算列表平均值"</span>,
        <span class="hljs-string">"code"</span>: <span class="hljs-string">"def calculate_average(numbers):\n    return sum(numbers) / len(numbers)"</span>
    },
    {
        <span class="hljs-string">"requirement"</span>: <span class="hljs-string">"反转字符串"</span>, 
        <span class="hljs-string">"code"</span>: <span class="hljs-string">"def reverse_string(s):\n    return s[::-1]"</span>
    }
]

<span class="hljs-attr">code_template</span> = FewShotPromptTemplate(
    <span class="hljs-attr">examples</span>=code_examples,
    <span class="hljs-attr">example_prompt</span>=PromptTemplate.from_template(
        "需求: {requirement}\n代码: {code}"
    ),
    <span class="hljs-attr">prefix</span>=<span class="hljs-string">"请根据示例编写Python代码："</span>,
    <span class="hljs-attr">suffix</span>=<span class="hljs-string">"需求: {requirement}\n代码:"</span>,
    <span class="hljs-attr">input_variables</span>=[<span class="hljs-string">"requirement"</span>]
)

<span class="hljs-attr">code_prompt</span> = code_template.format(
    <span class="hljs-attr">requirement</span>=<span class="hljs-string">"检查字符串是否是回文"</span>
)
</code></pre>
<h3 data-id="heading-19">场景4：复杂聊天 + 示例 → 组合使用</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 1. 创建少样本部分</span>
<span class="hljs-attr">few_shot_examples</span> = [
    {
        <span class="hljs-string">"situation"</span>: <span class="hljs-string">"用户询问个人隐私信息"</span>,
        <span class="hljs-string">"response"</span>: <span class="hljs-string">"出于安全考虑，我无法访问或提供个人隐私信息。"</span>
    },
    {
        <span class="hljs-string">"situation"</span>: <span class="hljs-string">"用户要求违法帮助"</span>, 
        <span class="hljs-string">"response"</span>: <span class="hljs-string">"抱歉，我无法提供任何违法或不道德行为的帮助。"</span>
    }
]

<span class="hljs-attr">few_shot_section</span> = FewShotChatMessagePromptTemplate(
    <span class="hljs-attr">example_prompt</span>=ChatPromptTemplate.from_messages([
        (<span class="hljs-string">"human"</span>, <span class="hljs-string">"情境: {situation}"</span>),
        (<span class="hljs-string">"ai"</span>, <span class="hljs-string">"回复: {response}"</span>)
    ]),
    <span class="hljs-attr">examples</span>=few_shot_examples
)

<span class="hljs-comment"># 2. 创建完整聊天提示</span>
<span class="hljs-attr">final_prompt</span> = ChatPromptTemplate.from_messages([
    SystemMessagePromptTemplate.from_template(<span class="hljs-string">"""
    你是{assistant_name}，安全准则：
    - {safety_guidelines}
    - 始终遵守{regulations}
    """</span>),
    
    few_shot_section,  <span class="hljs-comment"># 包含少样本示例</span>
    
    MessagesPlaceholder(variable_name=<span class="hljs-string">"conversation_history"</span>),  <span class="hljs-comment"># 动态历史</span>
    
    HumanMessagePromptTemplate.from_template(<span class="hljs-string">"当前查询: {current_query}"</span>)
])

<span class="hljs-comment"># 使用示例</span>
<span class="hljs-attr">messages</span> = final_prompt.format_messages(
    <span class="hljs-attr">assistant_name</span>=<span class="hljs-string">"安全助手"</span>,
    <span class="hljs-attr">safety_guidelines</span>=<span class="hljs-string">"不分享个人信息，不提供违法建议"</span>,
    <span class="hljs-attr">regulations</span>=<span class="hljs-string">"AI使用规范"</span>,
    <span class="hljs-attr">conversation_history</span>=[],
    <span class="hljs-attr">current_query</span>=<span class="hljs-string">"你能告诉我别人的电话号码吗？"</span>
)
</code></pre>
<h2 data-id="heading-20">📝 使用频率总结</h2>


















































<table><thead><tr><th>Template 类型</th><th>用途</th><th>使用频率</th></tr></thead><tbody><tr><td><code>PromptTemplate</code></td><td>基础文本模板</td><td>⭐⭐⭐⭐</td></tr><tr><td><code>ChatPromptTemplate</code></td><td>聊天消息组合</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><code>SystemMessagePromptTemplate</code></td><td>系统消息</td><td>⭐⭐⭐⭐</td></tr><tr><td><code>HumanMessagePromptTemplate</code></td><td>用户消息</td><td>⭐⭐⭐⭐</td></tr><tr><td><code>AIMessagePromptTemplate</code></td><td>AI消息</td><td>⭐⭐⭐</td></tr><tr><td><code>FewShotPromptTemplate</code></td><td>少样本学习</td><td>⭐⭐⭐</td></tr><tr><td><code>FewShotChatMessagePromptTemplate</code></td><td>聊天少样本</td><td>⭐⭐</td></tr><tr><td><code>MessagesPlaceholder</code></td><td>动态消息占位</td><td>⭐⭐</td></tr></tbody></table>
<h2 data-id="heading-21">总结</h2>
<p><code>LangChain Template</code> 提供了强大而灵活的提示工程能力：</p>
<ul>
<li><strong>🎯 精准控制</strong>: 通过模板精确控制模型输入，确保提示的一致性</li>
<li><strong>♻️ 可复用性</strong>: 一次创建，多处使用，提高开发效率</li>
<li><strong>🔧 模块化</strong>: 像搭积木一样组合模板，支持复杂场景</li>
<li><strong>🛡️ 可靠性</strong>: 类型安全和错误检查，减少运行时错误</li>
<li><strong>🚀 高效开发</strong>: 加速 AI 应用开发流程，降低维护成本</li>
</ul>
<p>掌握 <code>LangChain Template</code> 是构建高质量大模型应用的关键技能，它让提示工程从艺术走向工程化。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手搓一个简易Agent]]></title>    <link>https://juejin.cn/post/7573512056089493539</link>    <guid>https://juejin.cn/post/7573512056089493539</guid>    <pubDate>2025-11-17T14:52:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573512056089493539" data-draft-id="7573512056089231395" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手搓一个简易Agent"/> <meta itemprop="keywords" content="前端,后端,人工智能"/> <meta itemprop="datePublished" content="2025-11-17T14:52:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="桜吹雪"/> <meta itemprop="url" content="https://juejin.cn/user/1179091901098269"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手搓一个简易Agent
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1179091901098269/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    桜吹雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T14:52:13.000Z" title="Mon Nov 17 2025 14:52:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果跟着我完成了前面的一些学习，相信你也对ai有一定程度的了解了，话不多说我们下一步继续学手搓一个简单的ReAct Agent，如果你不了解什么是ReAct的话可以百度或者问一下AI，相信AI可以给你很详细的解答。</p>
<h2 data-id="heading-0">起步</h2>
<p>既然是手搓的话，咱们就先不用前面用到的Langchain.js了（手搓完再展示Langchain.js v1.0的createAgent），这里使用一个非常轻便的库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fxsai.js.org%2F" target="_blank" title="https://xsai.js.org/" ref="nofollow noopener noreferrer">xsai</a>，相对于Langchain.js动不动几十MB的安装依赖，xsai就要小很多了</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee2ae3a950be4df7880684b95a44ebbe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qGc5ZC56Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763996127&amp;x-signature=TZJypm8maaI9%2Fk4HDFMaIwPoORs%3D" alt="image.png" loading="lazy"/></p>
<p>然后js运行时咱们选非常好用的Bun，因为内置了很多好用的工具，比如Monorepo、env管理等等</p>
<p>然后模型选择，既然叫ReAct，那么我们需要一个能够推理思考的模型，当然你也可以写提示词让非推理模型生成推理链，不过现在是5202年末，各大厂商都有推出非常牛逼的推理模型，那么咱们简单点选个推理模型就好了，这里我选择了Qwen3-8B，使用ollama本地运行（其实是最近换了新显卡发现本地跑小模型也挺快的），当然也可以选择一些云计算平台，比如火山、百炼等等，都有几十上百万的免费token，要是用完了想白嫖也可以选择硅基流动的免费模型！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d8eb806efdf469aa61055e3340c772b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qGc5ZC56Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763996127&amp;x-signature=Py9gBpv6mcKqtMD906vpd6pzcrk%3D" alt="image.png" loading="lazy"/></p>
<p>除此之外也没啥多余的东西了，那么开始操作吧</p>
<pre><code class="hljs language-sh" lang="sh">bun init                                                                 
                                                                           
✓ Select a project template: Blank

 + .gitignore
 + index.ts
 + tsconfig.json (<span class="hljs-keyword">for</span> editor autocomplete)
 + README.md

To get started, run:

    bun run index.ts

</code></pre>
<pre><code class="hljs language-sh" lang="sh">bun add @xsai/shared-chat @xsai/tool @xsai/utils-chat zod
</code></pre>
<h2 data-id="heading-1">编写代码</h2>
<p>为了方便演示，代码就不拆分文件了，直接写到底，并用简单说明一下：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> {
  chat,
  <span class="hljs-keyword">type</span> <span class="hljs-title class_">AssistantMessage</span>,
  <span class="hljs-keyword">type</span> <span class="hljs-title class_">FinishReason</span>,
  <span class="hljs-keyword">type</span> <span class="hljs-title class_">Message</span>,
  <span class="hljs-keyword">type</span> <span class="hljs-title class_">Tool</span>,
  <span class="hljs-keyword">type</span> <span class="hljs-title class_">Usage</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">"@xsai/shared-chat"</span>;
<span class="hljs-keyword">import</span> { tool } <span class="hljs-keyword">from</span> <span class="hljs-string">"@xsai/tool"</span>;
<span class="hljs-keyword">import</span> { message } <span class="hljs-keyword">from</span> <span class="hljs-string">"@xsai/utils-chat"</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> z <span class="hljs-keyword">from</span> <span class="hljs-string">"zod"</span>;

<span class="hljs-comment">//#region openai 返回结构</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Choice</span> {
  <span class="hljs-attr">finish_reason</span>: <span class="hljs-title class_">FinishReason</span>;
  <span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">message</span>: <span class="hljs-title class_">AssistantMessage</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ChatCompletionsResponse</span> {
  <span class="hljs-attr">choices</span>: <span class="hljs-title class_">Choice</span>[];
  <span class="hljs-attr">created</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">model</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">object</span>: <span class="hljs-string">"chat.completion"</span>;
  <span class="hljs-attr">system_fingerprint</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">usage</span>: <span class="hljs-title class_">Usage</span>;
}
<span class="hljs-comment">//#endregion</span>

<span class="hljs-comment">// 方便生成message</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> assistant = message.<span class="hljs-property">assistant</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> system = message.<span class="hljs-property">system</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> user = message.<span class="hljs-property">user</span>;

<span class="hljs-comment">// 用来创建agent</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createAgent</span>(<span class="hljs-params">options: {
  provider: {
    baseURL: <span class="hljs-built_in">string</span>;
    apiKey: <span class="hljs-built_in">string</span>;
    model: <span class="hljs-built_in">string</span>;
  };
  tools?: Tool[];
}</span>) {
  <span class="hljs-comment">// call：让agent开始工作</span>
  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">call</span>(<span class="hljs-params">
    messages: Message[],
    callOptions: { maxRoundTrip: <span class="hljs-built_in">number</span> } = { maxRoundTrip: <span class="hljs-number">10</span> }
  </span>) {
    <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;
    <span class="hljs-comment">// 限制一下agent最大运行步数</span>
    <span class="hljs-keyword">while</span> (count &lt; callOptions.<span class="hljs-property">maxRoundTrip</span>) {
      <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">chat</span>({
        ...options.<span class="hljs-property">provider</span>,
        <span class="hljs-attr">baseURL</span>: options.<span class="hljs-property">provider</span>.<span class="hljs-property">baseURL</span>,
        <span class="hljs-attr">model</span>: options.<span class="hljs-property">provider</span>.<span class="hljs-property">model</span>,
        messages,
        <span class="hljs-attr">tools</span>: options.<span class="hljs-property">tools</span>,
      });
      <span class="hljs-keyword">const</span> cmplResp = (<span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>()) <span class="hljs-keyword">as</span> <span class="hljs-title class_">ChatCompletionsResponse</span>;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(cmplResp.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>], <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));
      <span class="hljs-keyword">const</span> toolCalls = cmplResp.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>]?.<span class="hljs-property">message</span>.<span class="hljs-property">tool_calls</span>;
      <span class="hljs-comment">// 判断是否函数调用，如果没有函数调用说明结束工作，已经得到结果</span>
      <span class="hljs-keyword">if</span> (!toolCalls?.<span class="hljs-property">length</span>) {
        <span class="hljs-keyword">return</span> cmplResp;
      }
      <span class="hljs-comment">// 将tool_calls加入到messages上下文中，方便ai判读已经调用过说明函数</span>
      messages.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">assistant</span>(toolCalls[<span class="hljs-number">0</span>]));
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> choice <span class="hljs-keyword">of</span> cmplResp.<span class="hljs-property">choices</span>) {
        <span class="hljs-keyword">if</span> (!choice.<span class="hljs-property">message</span>.<span class="hljs-property">tool_calls</span>) {
          <span class="hljs-keyword">continue</span>;
        }
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> toolCall <span class="hljs-keyword">of</span> choice.<span class="hljs-property">message</span>.<span class="hljs-property">tool_calls</span>) {
          <span class="hljs-comment">// 找到tool</span>
          <span class="hljs-keyword">const</span> foundTool = options.<span class="hljs-property">tools</span>?.<span class="hljs-title function_">find</span>(
            <span class="hljs-function">(<span class="hljs-params">tool</span>) =&gt;</span> tool.<span class="hljs-property">function</span>.<span class="hljs-property">name</span> === toolCall.<span class="hljs-property">function</span>.<span class="hljs-property">name</span>
          );
          <span class="hljs-keyword">if</span> (!foundTool) {
            <span class="hljs-keyword">continue</span>;
          }
          <span class="hljs-comment">// 调用tool拿到结果</span>
          <span class="hljs-keyword">const</span> invokeResult = <span class="hljs-keyword">await</span> foundTool.<span class="hljs-title function_">execute</span>(
            <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(toolCall.<span class="hljs-property">function</span>.<span class="hljs-property">arguments</span> || <span class="hljs-string">"{}"</span>),
            {
              messages,
              <span class="hljs-attr">toolCallId</span>: toolCall.<span class="hljs-property">id</span>,
            }
          );
          <span class="hljs-comment">// 将结果加入到上下文中</span>
          messages.<span class="hljs-title function_">push</span>({
            <span class="hljs-attr">role</span>: <span class="hljs-string">"tool"</span>,
            <span class="hljs-attr">content</span>:
              invokeResult === <span class="hljs-string">"string"</span>
                ? invokeResult
                : <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(invokeResult),
            <span class="hljs-attr">tool_call_id</span>: toolCall.<span class="hljs-property">id</span>,
          });
        }
      }
      <span class="hljs-comment">// 完成一次函数调用</span>
      count++;
    }
  }
  <span class="hljs-keyword">return</span> { call };
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 创建工具</span>
  <span class="hljs-keyword">const</span> getCity = <span class="hljs-keyword">await</span> <span class="hljs-title function_">tool</span>({
    <span class="hljs-attr">name</span>: <span class="hljs-string">"getCity"</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">"Get the user's city"</span>,
    <span class="hljs-attr">execute</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-string">"广州"</span>,
    <span class="hljs-attr">parameters</span>: z.<span class="hljs-title function_">object</span>({}),
  });
  <span class="hljs-keyword">const</span> getCityCode = <span class="hljs-keyword">await</span> <span class="hljs-title function_">tool</span>({
    <span class="hljs-attr">name</span>: <span class="hljs-string">"getCityCode"</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">"Get the user's city code with search"</span>,
    <span class="hljs-attr">execute</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-string">"Guangzhou"</span>,
    <span class="hljs-attr">parameters</span>: z.<span class="hljs-title function_">object</span>({
      <span class="hljs-attr">location</span>: z
        .<span class="hljs-title function_">string</span>()
        .<span class="hljs-title function_">min</span>(<span class="hljs-number">1</span>)
        .<span class="hljs-title function_">describe</span>(<span class="hljs-string">"Get the user's city code with search"</span>),
    }),
  });
  <span class="hljs-keyword">const</span> getWeather = <span class="hljs-keyword">await</span> <span class="hljs-title function_">tool</span>({
    <span class="hljs-attr">name</span>: <span class="hljs-string">"getWeather"</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">"Get the city code weather"</span>,
    <span class="hljs-attr">execute</span>: <span class="hljs-function">(<span class="hljs-params">{ cityCode }</span>) =&gt;</span> ({
      <span class="hljs-attr">city</span>: <span class="hljs-string">`广州`</span>,
      cityCode,
      <span class="hljs-attr">weather</span>: <span class="hljs-string">"sunny"</span>,
      <span class="hljs-attr">degreesCelsius</span>: <span class="hljs-number">26</span>,
    }),
    <span class="hljs-attr">parameters</span>: z.<span class="hljs-title function_">object</span>({
      <span class="hljs-attr">cityCode</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">min</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_">describe</span>(<span class="hljs-string">"Get the city code weather"</span>),
    }),
  });
  <span class="hljs-comment">// 创建agent</span>
  <span class="hljs-keyword">const</span> { call } = <span class="hljs-title function_">createAgent</span>({
    <span class="hljs-attr">provider</span>: {
      <span class="hljs-attr">baseURL</span>: <span class="hljs-string">"http://localhost:11434/v1"</span>,
      <span class="hljs-attr">apiKey</span>: <span class="hljs-string">"unused"</span>,
      <span class="hljs-attr">model</span>: <span class="hljs-string">"qwen3:8b"</span>,
    },
    <span class="hljs-attr">tools</span>: [getCity, getCityCode, getWeather],
  });
  <span class="hljs-comment">// 运行</span>
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">call</span>([
    <span class="hljs-title function_">system</span>(
      <span class="hljs-string">"我是一名乐于助人的助手，负责为用户提供所需信息。用户可能提出任何问题，请识别用户的需求，并选用合适的工具来获取必要信息。"</span>
    ),
    <span class="hljs-title function_">user</span>(<span class="hljs-string">"今天天气怎么样?"</span>),
  ]);
  <span class="hljs-comment">// 观察执行结果</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res?.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>]?.<span class="hljs-property">message</span>.<span class="hljs-property">content</span>);
}

<span class="hljs-title function_">main</span>();
</code></pre>
<p>执行一下，查看结果：</p>
<pre><code class="hljs language-sh" lang="sh">bun index.ts

今天广州的天气是晴天，气温28摄氏度。
</code></pre>
<p>是不是很简单通俗易懂。</p>
<h2 data-id="heading-2">邪修（bushi）快捷办法</h2>
<p>当然你可以参考上面的办法简单封装一下，或者，也不是不可以用别人写好的办法，比如langchain.js的办法</p>
<pre><code class="hljs language-sh" lang="sh">bun add langchain @langchain/openai
</code></pre>
<p>编写代码！</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatOpenAI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/openai"</span>;
<span class="hljs-keyword">import</span> { createAgent, tool } <span class="hljs-keyword">from</span> <span class="hljs-string">"langchain"</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> z <span class="hljs-keyword">from</span> <span class="hljs-string">"zod"</span>;

<span class="hljs-keyword">const</span> getCity = <span class="hljs-title function_">tool</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-string">"广州"</span>, {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"getCity"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"Get the user's city"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({}),
});

<span class="hljs-keyword">const</span> getCityCode = <span class="hljs-title function_">tool</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-string">"Guangzhou"</span>, {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"getCityCode"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"Get the user's city code with search"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">location</span>: z
      .<span class="hljs-title function_">string</span>()
      .<span class="hljs-title function_">min</span>(<span class="hljs-number">1</span>)
      .<span class="hljs-title function_">describe</span>(<span class="hljs-string">"Get the user's city code with search"</span>),
  }),
});
<span class="hljs-keyword">const</span> getWeather = <span class="hljs-title function_">tool</span>(
  <span class="hljs-function">(<span class="hljs-params">{ cityCode }</span>) =&gt;</span> ({
    <span class="hljs-attr">city</span>: <span class="hljs-string">`广州`</span>,
    cityCode,
    <span class="hljs-attr">weather</span>: <span class="hljs-string">"sunny"</span>,
    <span class="hljs-attr">degreesCelsius</span>: <span class="hljs-number">28</span>,
  }),
  {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"getWeather"</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">"Get the city code weather"</span>,
    <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
      <span class="hljs-attr">cityCode</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">min</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_">describe</span>(<span class="hljs-string">"Get the city code weather"</span>),
    }),
  }
);

<span class="hljs-keyword">const</span> agent = <span class="hljs-title function_">createAgent</span>({
  <span class="hljs-attr">model</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>({
    <span class="hljs-attr">configuration</span>: {
      <span class="hljs-attr">baseURL</span>: <span class="hljs-string">"http://localhost:11434/v1"</span>,
    },
    <span class="hljs-attr">apiKey</span>: <span class="hljs-string">"unused"</span>,
    <span class="hljs-attr">model</span>: <span class="hljs-string">"qwen3:8b"</span>,
  }),
  <span class="hljs-attr">tools</span>: [getCity, getCityCode, getWeather],
  <span class="hljs-attr">systemPrompt</span>: <span class="hljs-string">"You are a helpful assistant."</span>,
});

<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> agent.<span class="hljs-title function_">invoke</span>({
  <span class="hljs-attr">messages</span>: [{ <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">"今天天气怎么样"</span> }],
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result.<span class="hljs-property">messages</span>.<span class="hljs-title function_">at</span>(-<span class="hljs-number">1</span>)?.<span class="hljs-property">content</span>);
</code></pre>
<pre><code class="hljs language-sh" lang="sh">bun langchain-agent.ts                                                                                   
今天广州的天气晴朗，气温28摄氏度。
</code></pre>
<p>嗯，很简单粗暴，很邪修（</p>
<p>你学废了吗!</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SourceMap数据生成核心原理：简化字段与Base64VLQ编码]]></title>    <link>https://juejin.cn/post/7573486671297560618</link>    <guid>https://juejin.cn/post/7573486671297560618</guid>    <pubDate>2025-11-17T15:10:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573486671297560618" data-draft-id="7573486671297511466" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SourceMap数据生成核心原理：简化字段与Base64VLQ编码"/> <meta itemprop="keywords" content="前端,JavaScript,算法"/> <meta itemprop="datePublished" content="2025-11-17T15:10:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="漂流瓶jz"/> <meta itemprop="url" content="https://juejin.cn/user/3694779980078877"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SourceMap数据生成核心原理：简化字段与Base64VLQ编码
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3694779980078877/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    漂流瓶jz
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T15:10:12.000Z" title="Mon Nov 17 2025 15:10:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">简述</h2>
<p>SourceMap提供了从源代码到生成代码之间的转换关系，通过它使得各类代码生成工具生成的代码调试变得简单。前面我们写过两篇文章描述过SourceMap的历史，使用方式和生成工具等，对SourceMap有了一定的了解：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fjzplp.github.io%2F2025%2Fjs-sourcemap.html" target="_blank" title="https://jzplp.github.io/2025/js-sourcemap.html" ref="nofollow noopener noreferrer">快速定位源码问题：SourceMap的生成/使用/文件格式与历史</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fjzplp.github.io%2F2025%2Fwebpack-sourcemap.html" target="_blank" title="https://jzplp.github.io/2025/webpack-sourcemap.html" ref="nofollow noopener noreferrer">Webpack中各种devtool配置的含义与SourceMap生成逻辑</a></li>
</ul>
<p>但是对于SourceMap数据中最重要的内容，记录着转换前后代码中变量/属性名的位置关系的mappings字段却没有介绍。这也是SourceMap的核心生成原理。那么它是如何关联位置的，以及如何生成和解析这段字符串，这篇文章将会一一解答。</p>
<h2 data-id="heading-1">创建SourceMap示例</h2>
<p>在正式的介绍之前，为了方便后面描述，首先让我们创建一个SourceMap的示例，后面会一直用这个例子。这里采用Terser生成，首先看下源代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/index.js</span>
<span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">const</span> sum = jzplp + <span class="hljs-number">10</span>;
} <span class="hljs-keyword">catch</span> (err) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err);
  <span class="hljs-keyword">throw</span> err;
}
</code></pre>
<p>然后执行命令，生成代码和SourceMap。注意这里为了展示两行场景，没有开启代码压缩。semicolons=false表示不采用分号，而使用换行符。</p>
<pre><code class="hljs language-sh" lang="sh">terser src/index.js --mangle --format semicolons=<span class="hljs-literal">false</span> -o dist.js --source-map url=dist.js.map
</code></pre>
<p>然后看下生成的结果：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// dist.js</span>
<span class="hljs-keyword">try</span>{<span class="hljs-keyword">const</span> o=jzplp+<span class="hljs-number">10</span>}<span class="hljs-keyword">catch</span>(o){<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(o)
<span class="hljs-keyword">throw</span> o}
<span class="hljs-comment">//# sourceMappingURL/* 防止报错 */=dist.js.map</span>

<span class="hljs-comment">// dist.js.map</span>
{
  <span class="hljs-string">"version"</span>: <span class="hljs-number">3</span>,
  <span class="hljs-string">"names"</span>: [<span class="hljs-string">"sum"</span>, <span class="hljs-string">"jzplp"</span>, <span class="hljs-string">"err"</span>, <span class="hljs-string">"console"</span>, <span class="hljs-string">"log"</span>],
  <span class="hljs-string">"sources"</span>: [<span class="hljs-string">"src/index.js"</span>],
  <span class="hljs-string">"mappings"</span>: <span class="hljs-string">"AAAA,IACE,MAAMA,EAAMC,MAAQ,EACtB,CAAE,MAAOC,GACPC,QAAQC,IAAIF;AACZ,MAAMA,CACR"</span>,
  <span class="hljs-string">"ignoreList"</span>: []
}
</code></pre>
<p>还有一个index.html，后面在浏览器中查看效果使用：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./dist.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>最后还有一个解析SourceMap数据的工具，这里我们直接采用这篇文章中使用的解析SourceMap工具代码即可，<a href="https://link.juejin.cn?target=https%3A%2F%2Fjzplp.github.io%2F2025%2Fwebpack-sourcemap.html" target="_blank" title="https://jzplp.github.io/2025/webpack-sourcemap.html" ref="nofollow noopener noreferrer">Webpack中各种devtool配置的含义与SourceMap生成逻辑</a>。注意要修改下文件路径。</p>
<p>source-map中的行号从1开始，列号从0开始。但是我们为了符合SourceMap数据规范，后面所有的标号都从0开始，包括行号和列号。因此我们对代码稍作改造，后面都按照这个标准来计算。这里解析上面生成的SourceMap数据结果如下：</p>
<pre><code class="hljs language-ruby" lang="ruby">生成代码行<span class="hljs-number">0</span>  列<span class="hljs-number">0</span>  源代码行<span class="hljs-number">0</span>  列<span class="hljs-number">0</span>  源名称-            源文件<span class="hljs-symbol">:src/index</span>.js
生成代码行<span class="hljs-number">0</span>  列<span class="hljs-number">4</span>  源代码行<span class="hljs-number">1</span>  列<span class="hljs-number">2</span>  源名称-            源文件<span class="hljs-symbol">:src/index</span>.js
生成代码行<span class="hljs-number">0</span>  列<span class="hljs-number">10</span> 源代码行<span class="hljs-number">1</span>  列<span class="hljs-number">8</span>  源名称sum          源文件<span class="hljs-symbol">:src/index</span>.js
生成代码行<span class="hljs-number">0</span>  列<span class="hljs-number">12</span> 源代码行<span class="hljs-number">1</span>  列<span class="hljs-number">14</span> 源名称jzplp        源文件<span class="hljs-symbol">:src/index</span>.js
生成代码行<span class="hljs-number">0</span>  列<span class="hljs-number">18</span> 源代码行<span class="hljs-number">1</span>  列<span class="hljs-number">22</span> 源名称-            源文件<span class="hljs-symbol">:src/index</span>.js
生成代码行<span class="hljs-number">0</span>  列<span class="hljs-number">20</span> 源代码行<span class="hljs-number">2</span>  列<span class="hljs-number">0</span>  源名称-            源文件<span class="hljs-symbol">:src/index</span>.js
生成代码行<span class="hljs-number">0</span>  列<span class="hljs-number">21</span> 源代码行<span class="hljs-number">2</span>  列<span class="hljs-number">2</span>  源名称-            源文件<span class="hljs-symbol">:src/index</span>.js
生成代码行<span class="hljs-number">0</span>  列<span class="hljs-number">27</span> 源代码行<span class="hljs-number">2</span>  列<span class="hljs-number">9</span>  源名称err          源文件<span class="hljs-symbol">:src/index</span>.js
生成代码行<span class="hljs-number">0</span>  列<span class="hljs-number">30</span> 源代码行<span class="hljs-number">3</span>  列<span class="hljs-number">2</span>  源名称console      源文件<span class="hljs-symbol">:src/index</span>.js
生成代码行<span class="hljs-number">0</span>  列<span class="hljs-number">38</span> 源代码行<span class="hljs-number">3</span>  列<span class="hljs-number">10</span> 源名称log          源文件<span class="hljs-symbol">:src/index</span>.js
生成代码行<span class="hljs-number">0</span>  列<span class="hljs-number">42</span> 源代码行<span class="hljs-number">3</span>  列<span class="hljs-number">14</span> 源名称err          源文件<span class="hljs-symbol">:src/index</span>.js
生成代码行<span class="hljs-number">1</span>  列<span class="hljs-number">0</span>  源代码行<span class="hljs-number">4</span>  列<span class="hljs-number">2</span>  源名称-            源文件<span class="hljs-symbol">:src/index</span>.js
生成代码行<span class="hljs-number">1</span>  列<span class="hljs-number">6</span>  源代码行<span class="hljs-number">4</span>  列<span class="hljs-number">8</span>  源名称err          源文件<span class="hljs-symbol">:src/index</span>.js
生成代码行<span class="hljs-number">1</span>  列<span class="hljs-number">7</span>  源代码行<span class="hljs-number">5</span>  列<span class="hljs-number">0</span>  源名称-            源文件<span class="hljs-symbol">:src/index</span>.js
</code></pre>
<h2 data-id="heading-2">整理对应关系</h2>
<p>首先第一步，我们分析源代码和生成代码，将对应关系整理出来。先列一下对应关系拥有的字段，这些字段值对于SourceMap转换来说是必须的。</p>
<ul>
<li>源代码文件名</li>
<li>源代码行号</li>
<li>源代码列号</li>
<li>源代码标识符</li>
<li>生成代码文件名</li>
<li>生成代码行号</li>
<li>生成代码列号</li>
<li>生成代码标识符</li>
</ul>





















































































<table><thead><tr><th>源代码文件名</th><th>源代码标识符</th><th>源代码行号</th><th>源代码列号</th><th>生成代码文件名</th><th>生成代码标识符</th><th>生成代码行号</th><th>生成代码列号</th></tr></thead><tbody><tr><td>src/index.js</td><td>sum</td><td>1</td><td>8</td><td>dist.js</td><td>o</td><td>0</td><td>10</td></tr><tr><td>src/index.js</td><td>jzplp</td><td>1</td><td>14</td><td>dist.js</td><td>jzplp</td><td>0</td><td>12</td></tr><tr><td>src/index.js</td><td>err</td><td>2</td><td>9</td><td>dist.js</td><td>o</td><td>0</td><td>27</td></tr><tr><td>src/index.js</td><td>console</td><td>3</td><td>2</td><td>dist.js</td><td>console</td><td>0</td><td>30</td></tr><tr><td>src/index.js</td><td>log</td><td>3</td><td>10</td><td>dist.js</td><td>log</td><td>0</td><td>38</td></tr><tr><td>src/index.js</td><td>err</td><td>3</td><td>14</td><td>dist.js</td><td>o</td><td>0</td><td>42</td></tr><tr><td>src/index.js</td><td>err</td><td>4</td><td>8</td><td>dist.js</td><td>o</td><td>1</td><td>6</td></tr></tbody></table>
<p>可以看到这个表格和上面我们解析SourceMap数据得到的值是一样的。但是前面SourceMap中还多了一些没有标识符的对应关系数据，通过对比了解那是代码中其它内容的对应，这里我们忽略，按照标准的标识符关系来计算。此时我们创建一个JSON，存放我们生成的SourceMap数据。现在里面只有版本号：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>下面我们开始一步一步进行精简流程，目的是保证信息量不减少的情况下，减少最后形成的字符串长度。</p>
<h2 data-id="heading-3">文件名精简</h2>
<p>生成代码文件名这个字段无需表示，因为SourceMap数据是从生成文件的注释中指定的，那么SourceMap数据对应的生成文件就是这个指定的文件，无需标明。</p>
<p>然后是源代码文件名，这个我们用一个专门的数组存放，取名叫做sources。此时我们的SourceMap内容如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/index.js"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>然后记录表格中的源代码文件名变成数组的下标，从0开始。这时我们的表格变成了这样：</p>













































































<table><thead><tr><th>源代码文件名下标</th><th>源代码标识符</th><th>源代码行号</th><th>源代码列号</th><th>生成代码标识符</th><th>生成代码行号</th><th>生成代码列号</th></tr></thead><tbody><tr><td>0</td><td>sum</td><td>1</td><td>8</td><td>o</td><td>0</td><td>10</td></tr><tr><td>0</td><td>jzplp</td><td>1</td><td>14</td><td>jzplp</td><td>0</td><td>12</td></tr><tr><td>0</td><td>err</td><td>2</td><td>9</td><td>o</td><td>0</td><td>27</td></tr><tr><td>0</td><td>console</td><td>3</td><td>2</td><td>console</td><td>0</td><td>30</td></tr><tr><td>0</td><td>log</td><td>3</td><td>10</td><td>log</td><td>0</td><td>38</td></tr><tr><td>0</td><td>err</td><td>3</td><td>14</td><td>o</td><td>0</td><td>42</td></tr><tr><td>0</td><td>err</td><td>4</td><td>8</td><td>o</td><td>1</td><td>6</td></tr></tbody></table>
<h2 data-id="heading-4">代码标识符精简</h2>
<p>关于生成代码标识符，既然我们有了SourceMap数据指定的行列号，生成代码本身又是可见的，就可以从代码中定位到生成代码标识符，无需在表格中列出。</p>
<p>然后是源代码标识符，可以看到有很多重复出现的标识符，我们将这些标识符用一个专门的数组存放，取名叫做names。此时我们的SourceMap内容如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"names"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"sum"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"jzplp"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"err"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"console"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"log"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/index.js"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>然后再将表格中的源代码标识符简化为源代码标识符下标，可以看到现在表格中全都是数字了。</p>





































































<table><thead><tr><th>源代码文件名下标</th><th>源代码标识符下标</th><th>源代码行号</th><th>源代码列号</th><th>生成代码行号</th><th>生成代码列号</th></tr></thead><tbody><tr><td>0</td><td>0</td><td>1</td><td>8</td><td>0</td><td>10</td></tr><tr><td>0</td><td>1</td><td>1</td><td>14</td><td>0</td><td>12</td></tr><tr><td>0</td><td>2</td><td>2</td><td>9</td><td>0</td><td>27</td></tr><tr><td>0</td><td>3</td><td>3</td><td>2</td><td>0</td><td>30</td></tr><tr><td>0</td><td>4</td><td>3</td><td>10</td><td>0</td><td>38</td></tr><tr><td>0</td><td>2</td><td>3</td><td>14</td><td>0</td><td>42</td></tr><tr><td>0</td><td>2</td><td>4</td><td>8</td><td>1</td><td>6</td></tr></tbody></table>
<h2 data-id="heading-5">表格转为字符串</h2>
<p>SourceMap数据中的mappings是一个字符串，但我们是一个表格，这一步我们将表格转化为字符串。将每一个对应关系用逗号分隔，对应关系中间的六个数字我们用|分隔。那么数据可以被转为这样：</p>
<pre><code class="hljs">0|0|1|8|0|10,0|1|1|14|0|12,0|2|2|9|0|27,0|3|3|2|0|30,0|4|3|10|0|38,0|2|3|14|0|42,0|2|4|8|1|6
</code></pre>
<p>为了便于生成代码查找，我们将生成代码的每行做分隔，中间用分号表示，例如 第一行,第一行;第二行;;第四行。这种方式可以去掉数据中的行号列。这样我们的数据可以被转为这样：</p>
<pre><code class="hljs language-ini" lang="ini">0|0|1|8|10,0|1|1|14|12,0|2|2|9|27,0|3|3|2|30,0|4|3|10|38,0|2|3|14|42<span class="hljs-comment">;0|2|4|8|6</span>
</code></pre>
<p>这份数据对应的表格表示如下：</p>





























































<table><thead><tr><th>源代码文件名下标</th><th>源代码标识符下标</th><th>源代码行号</th><th>源代码列号</th><th>生成代码列号</th></tr></thead><tbody><tr><td>0</td><td>0</td><td>1</td><td>8</td><td>10</td></tr><tr><td>0</td><td>1</td><td>1</td><td>14</td><td>12</td></tr><tr><td>0</td><td>2</td><td>2</td><td>9</td><td>27</td></tr><tr><td>0</td><td>3</td><td>3</td><td>2</td><td>30</td></tr><tr><td>0</td><td>4</td><td>3</td><td>10</td><td>38</td></tr><tr><td>0</td><td>2</td><td>3</td><td>14</td><td>42</td></tr><tr><td>0</td><td>2</td><td>4</td><td>8</td><td>6</td></tr></tbody></table>
<h2 data-id="heading-6">数字转为增量计数</h2>
<p>从上面的字符串可以看到，行号列号数字是不断增长的。我们的代码非常短不明显，在大项目中行号列号可能会到数万行，这样还是会导致字符串长度过长。针对这个问题，可以使用增量计数的方式精简。</p>
<p>增量计数指的是，后面的数字以前一个数字为基准，只记录增加的数字。例如原始的数据为：[1, 3, 8, 6, 10]。我们将每一个数据减去前一个数据，就得到了增量数组：[1, 2, 5, -2, 4]。从例子中可以看到，如果这个数字相比于前一个数字是减小的，那么这个增量就是负值。</p>
<p>按照这个方式，我们将所有数据进一步精简：</p>





























































<table><thead><tr><th>源代码文件名下标增量</th><th>源代码标识符下标增量</th><th>源代码行号增量</th><th>源代码列号增量</th><th>生成代码列号增量</th></tr></thead><tbody><tr><td>0</td><td>0</td><td>1</td><td>8</td><td>10</td></tr><tr><td>0</td><td>1</td><td>0</td><td>6</td><td>2</td></tr><tr><td>0</td><td>1</td><td>1</td><td>-5</td><td>15</td></tr><tr><td>0</td><td>1</td><td>1</td><td>-7</td><td>3</td></tr><tr><td>0</td><td>1</td><td>0</td><td>8</td><td>8</td></tr><tr><td>0</td><td>-2</td><td>0</td><td>4</td><td>4</td></tr><tr><td>0</td><td>0</td><td>1</td><td>-6</td><td>-38</td></tr></tbody></table>
<p>可以看到，虽然整体得到了精简，但是还有一些负值存在，尤其是当换行之后，列号会从很大的数字变为很少的数字，这时候可能会出现一个较大的负值。不过常规情况下，每换一行也只会出现这一次。然后我们将数据字段位置按照规范调整一下：</p>





























































<table><thead><tr><th>生成代码列号增量</th><th>源代码文件名下标增量</th><th>源代码行号增量</th><th>源代码列号增量</th><th>源代码标识符下标增量</th></tr></thead><tbody><tr><td>10</td><td>0</td><td>1</td><td>8</td><td>0</td></tr><tr><td>2</td><td>0</td><td>0</td><td>6</td><td>1</td></tr><tr><td>15</td><td>0</td><td>1</td><td>-5</td><td>1</td></tr><tr><td>3</td><td>0</td><td>1</td><td>-7</td><td>1</td></tr><tr><td>8</td><td>0</td><td>0</td><td>8</td><td>1</td></tr><tr><td>4</td><td>0</td><td>0</td><td>4</td><td>-2</td></tr><tr><td>-38</td><td>0</td><td>1</td><td>-6</td><td>0</td></tr></tbody></table>
<p>转成字符串形式如下：</p>
<pre><code class="hljs language-ini" lang="ini">10|0|1|8|0,2|0|0|6|1,15|0|1|-5|1,3|0|1|-7|1,8|0|0|8|1,4|0|0|4|-2<span class="hljs-comment">;-38|0|1|-6|0</span>
</code></pre>
<h2 data-id="heading-7">Base64VLQ编码</h2>
<h3 data-id="heading-8">VLQ编码</h3>
<p>在上一步中形成的字符串里，占用最多空间的是分隔符|，在这一步中的首要任务就是要去掉它。直接去掉肯定不行，例如15|0|1|-5|1，去掉之后是1501-51，我们根本不知道如何将数字分隔开。这时就需要采用VLQ编码来实现。</p>
<p>VLQ编码(Variable Length Quantity)是一种将任意大小的数字转化为连续二进制码的一种编码方式，默认是采用8位来编码。这里由于需要适配Base64编码，因此改为了6位编码。我们举三个例子介绍一下编码方式，数字3，数字-38，数字4268。</p>
<p>首先将这两个数字的绝对值转成二进制，然后正数在后面补0，负数在后面补1。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-number">3</span>     <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">11</span>             <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">110</span>
-<span class="hljs-number">38</span>   <span class="hljs-punctuation">-&gt;</span> -<span class="hljs-number">100110</span>        <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">1001101</span>
<span class="hljs-number">4268</span>  <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">1000010101100</span>  <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">10000101011000</span>
</code></pre>
<p>然后再按照五个二进制位分为一组，不足五位的在前面补齐0。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-number">3</span>     <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">110</span>            <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">00110</span>            <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">00110</span>
-<span class="hljs-number">38</span>   <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">1001101</span>        <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">10</span> <span class="hljs-number">01101</span>         <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">00010</span> <span class="hljs-number">01101</span>
<span class="hljs-number">4268</span>  <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">10000101011000</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">1000</span> <span class="hljs-number">01010</span> <span class="hljs-number">11000</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">01000</span> <span class="hljs-number">01010</span> <span class="hljs-number">11000</span>
</code></pre>
<p>然后将这几组的顺序倒转。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-number">3</span>     <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">00110</span>              <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">00110</span>
-<span class="hljs-number">38</span>   <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">00010</span> <span class="hljs-number">01101</span>        <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">01101</span> <span class="hljs-number">00010</span>
<span class="hljs-number">4268</span>  <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">01000</span> <span class="hljs-number">01010</span> <span class="hljs-number">11000</span>  <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">11000</span> <span class="hljs-number">01010</span> <span class="hljs-number">01000</span>
</code></pre>
<p>然后就是去掉分隔符的关键步骤，将每一组最前面补一位：1表示还没结束，后面还有表示同一个数字的其他组；0表示这个数字在这一组已经结束了。到这里，VLQ编码就完成了。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-number">3</span>     <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">00110</span>              <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">000110</span>
-<span class="hljs-number">38</span>   <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">01101</span> <span class="hljs-number">00010</span>        <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">101101</span> <span class="hljs-number">000010</span>
<span class="hljs-number">4268</span>  <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">11000</span> <span class="hljs-number">01010</span> <span class="hljs-number">01000</span>  <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">111000</span> <span class="hljs-number">101010</span> <span class="hljs-number">001000</span>
</code></pre>
<h3 data-id="heading-9">Base64编码</h3>
<p>我们很久之前介绍过Base64编码，那时候是将3个字节转换为4个Base64编码值：因为 3<em>8=24, 6</em>4=24，位数相同正好能转换。但是这里由于我们在VLQ编码的时候就已经设置了6位，因此就不需要合并字节了，而是直接把一组二进制数转为对应字符即可：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/291d9e4be2f14a79830328e521785888~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ryC5rWB55O2ano=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763997012&amp;x-signature=XzOiIR0WYR5A4c9aoKomXttNzrk%3D" alt="sourcemap-principle-1.png" loading="lazy"/>
表格来源于百度百科</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-number">3</span>     <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">000110</span>               <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">6</span>        <span class="hljs-punctuation">-&gt;</span> G
-<span class="hljs-number">38</span>   <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">101101</span> <span class="hljs-number">000010</span>        <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">45</span> <span class="hljs-number">2</span>     <span class="hljs-punctuation">-&gt;</span> tC
<span class="hljs-number">4268</span>  <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">111000</span> <span class="hljs-number">101010</span> <span class="hljs-number">001000</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">56</span> <span class="hljs-number">42</span> <span class="hljs-number">8</span>  <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">4</span>qI
</code></pre>
<p>通过<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.murzwin.com%2Fbase64vlq.html" target="_blank" title="https://www.murzwin.com/base64vlq.html" ref="nofollow noopener noreferrer">在线的BASE64VLQ转换工具</a>，得到的结果是一致的，证明我们的算法是正确的。</p>
<h3 data-id="heading-10">最终生成SourceMap</h3>
<p>由于这种编码方式可以通过第一个二进制位表示数字是否已经结束，因此不再需要分隔符了。上面前面三个数字的例子可以被表示为：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-number">3</span>|-<span class="hljs-number">38</span>|<span class="hljs-number">4268</span> <span class="hljs-punctuation">-&gt;</span> GtC4qI
</code></pre>
<p>我们用这个方式，将每个数字都进行编码，结果如下。这里分别列出了数字和对应的编码，中间用空格分隔：</p>





























































<table><thead><tr><th>生成代码列号增量</th><th>源代码文件名下标增量</th><th>源代码行号增量</th><th>源代码列号增量</th><th>源代码标识符下标增量</th></tr></thead><tbody><tr><td>10 U</td><td>0 A</td><td>1 C</td><td>8 Q</td><td>0 A</td></tr><tr><td>2 E</td><td>0 A</td><td>0 A</td><td>6 M</td><td>1 C</td></tr><tr><td>15 e</td><td>0 A</td><td>1 C</td><td>-5 L</td><td>1 C</td></tr><tr><td>3 G</td><td>0 A</td><td>1 C</td><td>-7 P</td><td>1 C</td></tr><tr><td>8 Q</td><td>0 A</td><td>0 A</td><td>8 Q</td><td>1 C</td></tr><tr><td>4 I</td><td>0 A</td><td>0 A</td><td>4 I</td><td>-2 F</td></tr><tr><td>-38 tC</td><td>0 A</td><td>1 C</td><td>-6 N</td><td>0 A</td></tr></tbody></table>
<p>转成字符串形式如下：</p>
<pre><code class="hljs language-css" lang="css">编码
U|<span class="hljs-selector-tag">A</span>|C|<span class="hljs-selector-tag">Q</span>|<span class="hljs-selector-tag">A</span>,E|<span class="hljs-selector-tag">A</span>|<span class="hljs-selector-tag">A</span>|M|C,e|<span class="hljs-selector-tag">A</span>|C|L|C,G|<span class="hljs-selector-tag">A</span>|C|<span class="hljs-selector-tag">P</span>|C,<span class="hljs-selector-tag">Q</span>|<span class="hljs-selector-tag">A</span>|<span class="hljs-selector-tag">A</span>|<span class="hljs-selector-tag">Q</span>|C,<span class="hljs-selector-tag">I</span>|<span class="hljs-selector-tag">A</span>|<span class="hljs-selector-tag">A</span>|<span class="hljs-selector-tag">I</span>|F;tC|<span class="hljs-selector-tag">A</span>|C|N|<span class="hljs-selector-tag">A</span>
去掉分隔符
UACQA,EAAMC,eACLC,GACPC,QAAQC,IAAIF;tCACNA
</code></pre>
<p>最后生成真正的SourceMap完整数据文件：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"names"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"sum"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"jzplp"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"err"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"console"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"log"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/index.js"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"mappings"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"UACQA,EAAMC,eACLC,GACPC,QAAQC,IAAIF;tCACNA"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这里和Terser生成的SourceMap数据不同，因为它多生成了一些没有标识符的对应关系。如果对应关系中没有标识符，那么生成的结果中不存在对应数字即可，例如Terser生成的SourceMap数据中四个字母的数据，就肯定是没有标识符的。</p>
<h2 data-id="heading-11">浏览器测试</h2>
<p>使用自己手工生成的完整的SourceMap数据，替换掉Terser生成的SourceMap文件内容。然后在浏览器中打开查看效果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/594b1fc72ce441ee9f1c2967853bd4a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ryC5rWB55O2ano=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763997012&amp;x-signature=i7jDQjOefMMtbHZJVzdMxfGddTI%3D" alt="sourcemap-principle-2.png" loading="lazy"/></p>
<p>可以看到，报错位置成功的被转换为源文件index.js中的报错位置（浏览器行号列号都从1开始）。因此这说明我们手工生成的SourceMap是有效的。</p>
<h2 data-id="heading-12">参考</h2>
<ul>
<li>快速定位源码问题：SourceMap的生成/使用/文件格式与历史<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fjzplp.github.io%2F2025%2Fjs-sourcemap.html" target="_blank" title="https://jzplp.github.io/2025/js-sourcemap.html" ref="nofollow noopener noreferrer">jzplp.github.io/2025/js-sou…</a></li>
<li>Webpack中各种devtool配置的含义与SourceMap生成逻辑<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fjzplp.github.io%2F2025%2Fwebpack-sourcemap.html" target="_blank" title="https://jzplp.github.io/2025/webpack-sourcemap.html" ref="nofollow noopener noreferrer">jzplp.github.io/2025/webpac…</a></li>
<li>Terser 文档<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fterser.org%2F" target="_blank" title="https://terser.org/" ref="nofollow noopener noreferrer">terser.org/</a></li>
<li>sourcemap 这么讲，我彻底理解了<br/>
<a href="https://juejin.cn/post/7199895323187347514" target="_blank" title="https://juejin.cn/post/7199895323187347514">juejin.cn/post/719989…</a></li>
<li>Base64编码详解与URL安全的Base64编码<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fjzplp.github.io%2F2021%2Fbase64-safe.html" target="_blank" title="https://jzplp.github.io/2021/base64-safe.html" ref="nofollow noopener noreferrer">jzplp.github.io/2021/base64…</a></li>
<li>JavaScript Source Map 详解
<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ruanyifeng.com%2Fblog%2F2013%2F01%2Fjavascript_source_map.html" target="_blank" title="https://www.ruanyifeng.com/blog/2013/01/javascript_source_map.html" ref="nofollow noopener noreferrer">www.ruanyifeng.com/blog/2013/0…</a></li>
<li>BASE64 VLQ CODEC (COder/DECoder) AND SOURCEMAP V3 / ECMA-426 MAPPINGS PARSER<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.murzwin.com%2Fbase64vlq.html" target="_blank" title="https://www.murzwin.com/base64vlq.html" ref="nofollow noopener noreferrer">www.murzwin.com/base64vlq.h…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Jetpack Compose Navigation3：返回栈管理、大屏适配与自定义策略]]></title>    <link>https://juejin.cn/post/7573506713867288627</link>    <guid>https://juejin.cn/post/7573506713867288627</guid>    <pubDate>2025-11-17T15:08:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573506713867288627" data-draft-id="7572776177691049993" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Jetpack Compose Navigation3：返回栈管理、大屏适配与自定义策略"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-17T15:08:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨白"/> <meta itemprop="url" content="https://juejin.cn/user/2549135752044601"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Jetpack Compose Navigation3：返回栈管理、大屏适配与自定义策略
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2549135752044601/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨白
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T15:08:57.000Z" title="Mon Nov 17 2025 15:08:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Navigation3 相比 Navigation2 来说，区别主要有两点：</p>
<ol>
<li>导航返回栈从由 Navigation 内部控制，变为由开发者控制。</li>
<li>Navigation2 只适用于单页模式，一个屏幕只能显示一个路由对应的页面。而 Navigation3 可适配大屏。</li>
</ol>
<h2 data-id="heading-0">添加依赖</h2>
<pre><code class="hljs language-kotlin" lang="kotlin">plugins {
    <span class="hljs-comment">// Kotlin serialization plugin</span>
    id(<span class="hljs-string">"org.jetbrains.kotlin.plugin.serialization"</span>) version <span class="hljs-string">"2.0.21"</span>
}

dependencies {
    <span class="hljs-comment">// Navigation3</span>
    implementation(<span class="hljs-string">"androidx.navigation3:navigation3-runtime:1.0.0-rc01"</span>)
    implementation(<span class="hljs-string">"androidx.navigation3:navigation3-ui:1.0.0-rc01"</span>)

    <span class="hljs-comment">// Navigation3 Adaptive</span>
    implementation(<span class="hljs-string">"androidx.compose.material3.adaptive:adaptive-navigation3:1.3.0-alpha03"</span>)

    <span class="hljs-comment">// Kotlin Serialization</span>
    implementation(<span class="hljs-string">"org.jetbrains.kotlinx:kotlinx-serialization-core:1.6.0"</span>)

    <span class="hljs-comment">// Navigation3 ViewModel</span>
    implementation(<span class="hljs-string">"androidx.lifecycle:lifecycle-viewmodel-navigation3:2.10.0-rc01"</span>)
}
</code></pre>
<p><code>compileSdkVersion</code> 需要 36 以上：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">android {
    compileSdk = <span class="hljs-number">36</span>
}
</code></pre>
<h2 data-id="heading-1">简单用法</h2>
<p>我们以商品列表页和商品详情页为例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">object</span> ProductList
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductDetail</span>(
    <span class="hljs-keyword">val</span> name: String,
    <span class="hljs-keyword">val</span> description: String
)

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ProductList</span><span class="hljs-params">(
    products: <span class="hljs-type">List</span>&lt;<span class="hljs-type">ProductDetail</span>&gt;,
    onProductClick: (<span class="hljs-type">ProductDetail</span>) -&gt; <span class="hljs-type">Unit</span>,
    modifier: <span class="hljs-type">Modifier</span> = Modifier
)</span></span> {
    LazyColumn(modifier = modifier.fillMaxSize()) {
        items(products) { product -&gt;
            Text(
                text = product.name,
                modifier = Modifier
                    .fillMaxSize()
                    .clickable { onProductClick(product) }
                    .padding(<span class="hljs-number">16.</span>dp)
            )
        }
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ProductDetail</span><span class="hljs-params">(
    product: <span class="hljs-type">ProductDetail</span>,
    modifier: <span class="hljs-type">Modifier</span> = Modifier
)</span></span> {
    Column(
        modifier = modifier
            .fillMaxSize()
            .padding(<span class="hljs-number">16.</span>dp),
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        Text(
            text = product.name,
            fontWeight = FontWeight.Bold,
            fontSize = <span class="hljs-number">30.</span>sp
        )
        Column(
            modifier = Modifier
                .fillMaxSize()
                .weight(<span class="hljs-number">1f</span>),
            verticalArrangement = Arrangement.Center,
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            Text(
                text = product.description,
                fontSize = <span class="hljs-number">26.</span>sp
            )
        }
    }
}
</code></pre>
<p>注意：<code>ProductDetail</code> 和 <code>ProductList</code> 有两重意思：既封装了页面的数据，又作为页面的导航节点。</p>
<p>然后是 <code>MyApp</code> 函数：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">ComponentActivity</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        enableEdgeToEdge()
        setContent {
            ComposeNavigation3TestTheme {
                MyApp()
            }
        }
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MyApp</span><span class="hljs-params">(modifier: <span class="hljs-type">Modifier</span> = Modifier)</span></span> {
    <span class="hljs-comment">// 返回栈，初始页面是商品列表</span>
    <span class="hljs-comment">// Navigation3 会自动展示栈顶页面</span>
    <span class="hljs-keyword">val</span> backStack = remember { mutableStateListOf&lt;Any&gt;(ProductList) }
    NavDisplay( <span class="hljs-comment">// 入口函数</span>
        backStack = backStack, <span class="hljs-comment">// backStack参数是导航返回栈</span>
        onBack = { <span class="hljs-comment">// onBack回调是返回的监听</span>
            <span class="hljs-comment">// 返回逻辑为：移除栈顶元素</span>
            backStack.removeLastOrNull()
        },
        entryProvider = { key -&gt; <span class="hljs-comment">// entryProvider回调用于定义每个页面的NavEntry</span>
            <span class="hljs-keyword">when</span> (key) {
                <span class="hljs-comment">// 商品列表页面</span>
                <span class="hljs-keyword">is</span> ProductList -&gt; NavEntry(key) {
                    <span class="hljs-keyword">val</span> products = mutableListOf&lt;ProductDetail&gt;()
                    repeat(<span class="hljs-number">30</span>) {
                        products.add(ProductDetail(<span class="hljs-string">"Product <span class="hljs-variable">$it</span>"</span>, <span class="hljs-string">"Description of Product <span class="hljs-variable">$it</span>"</span>))
                    }
                    ProductList(
                        products = products,
                        onProductClick = { product -&gt;
                            <span class="hljs-comment">// 跳转到商品详情页面</span>
                            backStack.add(ProductDetail(product.name, product.description))
                        },
                        modifier
                    )
                }
                <span class="hljs-comment">// 商品详情页面</span>
                <span class="hljs-keyword">is</span> ProductDetail -&gt; NavEntry(key) {
                    ProductDetail(
                        product = key,
                        modifier
                    )
                }

                <span class="hljs-keyword">else</span> -&gt; error(<span class="hljs-string">"Unknown key: <span class="hljs-variable">$key</span>"</span>)
            }
        }
    )
}
</code></pre>
<p>运行效果：</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56edff5cc8ce4dfa9d5245af97722608~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo55m9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763996936&amp;x-signature=sexqMGLp9RLuuLnk%2FehteOqwBwA%3D" alt="Screen_recording_20251117_162824.gif" width="50%" loading="lazy"/>
<p>可以看到，商品列表页向商品详情页传递数据非常容易，只需将数据加入到返回栈，详情页自然能在 <code>entryProvider</code> 回调中收到。</p>
<h2 data-id="heading-2">保存和管理导航状态</h2>
<p>现在，我们旋转屏幕，会导致 Activity 的重建，导致返回栈被清空。</p>
<p>解决方法也很简单：只需给每一个 data class 加上 <code>@Serializable</code> 注解，然后实现 <code>NavKey</code> 接口。</p>
<blockquote>
<p>状态恢复要求数据是可序列化的</p>
</blockquote>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Serializable</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">object</span> ProductList : NavKey

<span class="hljs-meta">@Serializable</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductDetail</span>(
    <span class="hljs-keyword">val</span> name: String,
    <span class="hljs-keyword">val</span> description: String
) : NavKey
</code></pre>
<p>再将返回栈的声明改为 <code>val backStack = rememberNavBackStack(ProductList)</code> 即可。</p>
<h2 data-id="heading-3">大屏适配</h2>
<p>Navigation 3 中的场景（<code>Scene</code>）解决了大屏适配的问题，它可以显示一个或多个 <code>NavEntry</code> 实例，也就是同时显示多个 <code>NavEntry</code> 页面。</p>
<p>我们可以给 <code>NavDisplay</code> 函数传入一个 <code>sceneStrategy</code> 参数，来指定场景策略。默认策略是 <code>SinglePaneSceneStrategy</code>，单页场景模式。</p>
<p>我们来使用 <code>ListDetailSceneStrategy</code>，列表详情页面场景策略，它会自动根据当前屏幕大小进行页面分配。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@OptIn(ExperimentalMaterial3AdaptiveApi::class)</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MyApp</span><span class="hljs-params">(modifier: <span class="hljs-type">Modifier</span> = Modifier)</span></span> {
    <span class="hljs-keyword">val</span> backStack = rememberNavBackStack(ProductList)
    <span class="hljs-comment">// 创建ListDetailSceneStrategy实例</span>
    <span class="hljs-keyword">val</span> listDetailStrategy = rememberListDetailSceneStrategy&lt;Any&gt;()
    NavDisplay(
        backStack = backStack,
        onBack = {
            backStack.removeLastOrNull()
        },
        sceneStrategy = listDetailStrategy, <span class="hljs-comment">// 使用ListDetailSceneStrategy</span>
        entryProvider = { key -&gt;
            <span class="hljs-keyword">when</span> (key) {
                <span class="hljs-keyword">is</span> ProductList -&gt; NavEntry(
                    key = key,
                    metadata = ListDetailSceneStrategy.listPane( <span class="hljs-comment">// 修改处</span>
                        detailPlaceholder = {
                            Column(
                                modifier = Modifier
                                    .fillMaxSize(),
                                verticalArrangement = Arrangement.Center,
                                horizontalAlignment = Alignment.CenterHorizontally
                            ) {
                                Text(<span class="hljs-string">"Choose a product from the list"</span>, fontSize = <span class="hljs-number">26.</span>sp)
                            }
                        }
                    )
                ) {
                    <span class="hljs-keyword">val</span> products = mutableListOf&lt;ProductDetail&gt;()
                    repeat(<span class="hljs-number">30</span>) {
                        products.add(ProductDetail(<span class="hljs-string">"Product <span class="hljs-variable">$it</span>"</span>, <span class="hljs-string">"Description of Product <span class="hljs-variable">$it</span>"</span>))
                    }
                    ProductList(
                        products = products,
                        onProductClick = { product -&gt;
                            backStack.add(ProductDetail(product.name, product.description))
                        },
                        modifier
                    )
                }

                <span class="hljs-keyword">is</span> ProductDetail -&gt; NavEntry(
                    key = key,
                    metadata = ListDetailSceneStrategy.detailPane() <span class="hljs-comment">// 修改处</span>
                ) {
                    ProductDetail(
                        product = key,
                        modifier
                    )
                }

                <span class="hljs-keyword">else</span> -&gt; error(<span class="hljs-string">"Unknown key: <span class="hljs-variable">$key</span>"</span>)
            }
        }
    )
}
</code></pre>
<p>我们给列表页和详情页的 <code>NavEntry</code> 都传入了 <code>metadata</code> 参数，通过 <code>listPane()</code> 和 <code>detailPane()</code> 来告知了 <code>Navigation</code> 列表页和详情页的 <code>NavEntry</code> 分别是哪个。</p>
<p>我们还给 <code>listPane()</code> 传入了 <code>detailPlaceholder</code>（详情页占位符）参数，这样未选中列表项时，会默认显示占位的内容。</p>
<p>运行效果：</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb3fe9416eaa48aeb53170cbb30c884e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo55m9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763996936&amp;x-signature=Tg%2B0MjeKfgn7e4u05ANVZlryvWQ%3D" alt="Screen_recording_20251117_183726.gif" width="100%" loading="lazy"/>
<h2 data-id="heading-4">自定义场景</h2>
<p>为了完成自定义场景，我们先来简单看看内置的单页模式场景的源码：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">internal</span> <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SinglePaneScene</span>&lt;<span class="hljs-type">T : Any</span>&gt;(
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> key: Any, <span class="hljs-comment">// 唯一标识符，用于动画</span>
    <span class="hljs-keyword">val</span> entry: NavEntry&lt;T&gt;, <span class="hljs-comment">// 当前页的 NavEntry</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> previousEntries: List&lt;NavEntry&lt;T&gt;&gt;,  <span class="hljs-comment">// 添加当前页之前的 NavEntry 列表，用于预测性返回动画</span>
) : Scene&lt;T&gt; { <span class="hljs-comment">// 实现 Scene 接口</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> entries: List&lt;NavEntry&lt;T&gt;&gt; = listOf(entry) <span class="hljs-comment">// 当前场景需要显示的 NavEntry</span>

    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> content: <span class="hljs-meta">@Composable</span> () -&gt; <span class="hljs-built_in">Unit</span> = { entry.Content() } <span class="hljs-comment">// 当前场景的内容</span>

    <span class="hljs-comment">// equals、hashCode、toString 方法</span>
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SinglePaneSceneStrategy</span>&lt;<span class="hljs-type">T : Any</span>&gt; : <span class="hljs-type">SceneStrategy</span>&lt;<span class="hljs-type">T</span>&gt; {
    
    <span class="hljs-comment">// 返回场景类实例，它决定了最终界面的显示内容</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> SceneStrategyScope<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">calculateScene</span><span class="hljs-params">(entries: <span class="hljs-type">List</span>&lt;<span class="hljs-type">NavEntry</span>&lt;<span class="hljs-type">T</span>&gt;&gt;)</span></span>: Scene&lt;T&gt; {
        <span class="hljs-keyword">return</span> SinglePaneScene(
            key = entries.last().contentKey,
            entry = entries.last(),
            previousEntries = entries.dropLast(<span class="hljs-number">1</span>),
        )
    }
}
</code></pre>
<p>简单了解过后，我们来完成双页模式场景：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DoublePaneScene</span>&lt;<span class="hljs-type">T : Any</span>&gt;(
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> key: Any,
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> previousEntries: List&lt;NavEntry&lt;T&gt;&gt;,
    <span class="hljs-keyword">val</span> startEntry: NavEntry&lt;T&gt;, <span class="hljs-comment">// 左侧面板导航条目</span>
    <span class="hljs-keyword">val</span> endEntry: NavEntry&lt;T&gt; <span class="hljs-comment">// 右侧面板导航条目</span>
) : Scene&lt;T&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> entries: List&lt;NavEntry&lt;T&gt;&gt; = listOf(startEntry, endEntry)

    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> content: <span class="hljs-meta">@Composable</span> (() -&gt; <span class="hljs-built_in">Unit</span>) = {
        <span class="hljs-comment">// 获取窗口大小信息</span>
        <span class="hljs-keyword">val</span> windowSizeClass = currentWindowAdaptiveInfo().windowSizeClass
        <span class="hljs-comment">// 如果宽度大于等于中屏，则显示双列</span>
        <span class="hljs-keyword">if</span> (windowSizeClass.isWidthAtLeastBreakpoint(WIDTH_DP_MEDIUM_LOWER_BOUND)) {
            Row(modifier = Modifier.fillMaxSize()) {
                Column(modifier = Modifier.weight(<span class="hljs-number">0.22f</span>)) {
                    startEntry.Content()
                }
                Column(modifier = Modifier.weight(<span class="hljs-number">0.78f</span>)) {
                    endEntry.Content()
                }
            }
        } <span class="hljs-keyword">else</span> {
            endEntry.Content()
        }
    }

    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">internal</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> START_PANE_KEY = <span class="hljs-string">"StartPane"</span>
        <span class="hljs-keyword">internal</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> END_PANE_KEY = <span class="hljs-string">"EndPane"</span>
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startPane</span><span class="hljs-params">()</span></span> = mapOf(START_PANE_KEY to <span class="hljs-literal">true</span>)
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">endPane</span><span class="hljs-params">()</span></span> = mapOf(END_PANE_KEY to <span class="hljs-literal">true</span>)
    }
}
</code></pre>
<p>首先，我们接收了两个 <code>NavEntry</code> 实例，待会将会传递进来，分别代表了左侧和右侧的页面。</p>
<p>然后在 <code>content</code> 中，完成了页面的布局：如果是大屏设备，则双列显示；否则，只显示右侧页面。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DoublePaneSceneStrategy</span>&lt;<span class="hljs-type">T : Any</span>&gt; : <span class="hljs-type">SceneStrategy</span>&lt;<span class="hljs-type">T</span>&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> SceneStrategyScope<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">calculateScene</span><span class="hljs-params">(entries: <span class="hljs-type">List</span>&lt;<span class="hljs-type">NavEntry</span>&lt;<span class="hljs-type">T</span>&gt;&gt;)</span></span>: Scene&lt;T&gt;? {
        <span class="hljs-comment">// 过滤出拥有特定元数据的 NavEntry</span>
        <span class="hljs-keyword">val</span> startPane =
            entries.filter { it.metadata.containsKey(DoublePaneScene.START_PANE_KEY) }
        <span class="hljs-keyword">val</span> endPane =
            entries.filter { it.metadata.containsKey(DoublePaneScene.END_PANE_KEY) }
        <span class="hljs-keyword">if</span> (startPane.isEmpty() || endPane.isEmpty()) {
            <span class="hljs-comment">// 不同时存在两个面板，说明当前场景策略无法处理</span>
            <span class="hljs-comment">// 默认会被单页模式场景策略处理</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        }

        <span class="hljs-keyword">val</span> startEntry = startPane.last()
        <span class="hljs-keyword">val</span> endEntry = endPane.last()
        <span class="hljs-comment">// 构建一个 Key 用于标识场景</span>
        <span class="hljs-keyword">val</span> sceneKey = Pair(startEntry, endEntry)
        <span class="hljs-keyword">return</span> DoublePaneScene(
            key = sceneKey,
            previousEntries = entries.dropLast(<span class="hljs-number">1</span>),
            startEntry = startEntry,
            endEntry = endEntry
        )
    }

}
</code></pre>
<p>我们找到特定的两个 <code>NavEntry</code>（待会使用时，需要将指定的元数据传入），然后创建 <code>DoublePaneScene</code> 实例返回即可。</p>
<p>具体使用：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MyApp</span><span class="hljs-params">(modifier: <span class="hljs-type">Modifier</span> = Modifier)</span></span> {
    <span class="hljs-keyword">val</span> backStack = rememberNavBackStack(ProductList)
    NavDisplay(
        backStack = backStack,
        onBack = {
            backStack.removeLastOrNull()
        },
        sceneStrategy = DoublePaneSceneStrategy(), <span class="hljs-comment">// 使用DoublePaneScene</span>
        entryProvider = { key -&gt;
            <span class="hljs-keyword">when</span> (key) {
                <span class="hljs-keyword">is</span> ProductList -&gt; NavEntry(
                    key = key,
                    <span class="hljs-comment">// 传递特定元数据</span>
                    metadata = DoublePaneScene.startPane()
                ) {
                    <span class="hljs-keyword">val</span> products = mutableListOf&lt;ProductDetail&gt;()
                    repeat(<span class="hljs-number">30</span>) {
                        products.add(ProductDetail(<span class="hljs-string">"Product <span class="hljs-variable">$it</span>"</span>, <span class="hljs-string">"Description of Product <span class="hljs-variable">$it</span>"</span>))
                    }
                    ProductList(
                        products = products,
                        onProductClick = { product -&gt;
                            backStack.add(ProductDetail(product.name, product.description))
                        },
                        modifier
                    )
                }

                <span class="hljs-keyword">is</span> ProductDetail -&gt; NavEntry(
                    key = key,
                    <span class="hljs-comment">// 传递特定元数据</span>
                    metadata = DoublePaneScene.endPane()
                ) {
                    ProductDetail(
                        product = key,
                        modifier
                    )
                }

                <span class="hljs-keyword">else</span> -&gt; error(<span class="hljs-string">"Unknown key: <span class="hljs-variable">$key</span>"</span>)
            }
        }
    )
}
</code></pre>
<p>运行效果：</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbb6ca4e66ab4ecd98d06f17a27e5ba8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo55m9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763996936&amp;x-signature=i%2BJXN0irWkCj99CzlfGC8qttvmU%3D" alt="Screen_recording_20251117_192709.gif" width="100%" loading="lazy"/>
<p>可以看到，每次点击列表项时，左侧的列表页都会“闪烁”一下。并且按下返回键时，会回到上一个详情页。</p>
<p>这与官方的 <code>ListDetailSceneStrategy</code> 效果并不同，这是因为官方的 <code>ListDetailSceneStrategy</code> 会安装自己的 <code>BackHandler</code>，在大屏幕设备上，按下返回键会直接清空堆栈。而我们的 <code>DoublePaneSceneStrategy</code> 只负责显示，并不会有额外的优化。</p>
<p>“闪烁”是因为 <code>NavDisplay</code> 依靠 <code>sceneKey</code> 来判断是否是同一个场景，当我们点击了新的列表项后，<code>NavDisplay</code> 发现场景已经变化，会销毁并重建整个场景，而这个过程就是我们看到的“闪烁”。</p>
<h2 data-id="heading-5">参考</h2>
<p>参考郭霖大佬的博客：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F0-43B2VbQHSYxABXckJJbQ" target="_blank" title="https://mp.weixin.qq.com/s/0-43B2VbQHSYxABXckJJbQ" ref="nofollow noopener noreferrer">写给初学者的Jetpack Compose教程，Navigation 3</a>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[项目太大，AI无法理解？试试这3种思路]]></title>    <link>https://juejin.cn/post/7573525634212626475</link>    <guid>https://juejin.cn/post/7573525634212626475</guid>    <pubDate>2025-11-17T15:12:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573525634212626475" data-draft-id="7573468493570474020" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="项目太大，AI无法理解？试试这3种思路"/> <meta itemprop="keywords" content="AI编程,人工智能"/> <meta itemprop="datePublished" content="2025-11-17T15:12:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="飞哥数智谈"/> <meta itemprop="url" content="https://juejin.cn/user/3825956195409223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            项目太大，AI无法理解？试试这3种思路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3825956195409223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    飞哥数智谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T15:12:00.000Z" title="Mon Nov 17 2025 15:12:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>上周六的活动中交流了一个问题：<strong>如何解决 AI 在大项目理解中的瓶颈</strong>。</p>
<p>活动结束后，我一直在思考，这个场景确实是个非常普遍的痛点，很可能会造成原本很好的工具无法使用。</p>
<p>于是，我决定好好的研究下，今天，就把目前的思考内容和大家分享下，抛砖引玉。</p>
<h2 data-id="heading-0">处理大项目的思路</h2>
<p>首先，有一个背景，我们需要达成一致。</p>
<p>在超级模型出现前，将整个项目代码一次性塞入 <code>AI</code> 中是不现实，现有思路的关键都在于<strong>如何更加精确、动态地找到回答问题所需的代码片段</strong>。</p>
<p>整理了如下几个思路：</p>
<ul>
<li>人工划分降低理解难度</li>
<li>借助工具实现代码图谱</li>
<li>Claude Skills按需加载上下文</li>
</ul>
<p>这几个思路并不是完全并列，而是可以<strong>同时使用，相互结合</strong>的。</p>
<h2 data-id="heading-1">人工划分降低理解难度</h2>
<p>最难的，也是最简单的思路。</p>
<p>“<strong>难</strong>”在于这个过程需要人工处理，工作量比较大；“<strong>简单</strong>”在于不需要额外的知识辅助，也不需要引入新的工具。</p>
<ul>
<li>可以通过分层的方式，比如：服务层、业务层、数据层等。</li>
<li>可以通过分模块的方式，比如：合同模块、支付模块、日志模块等。</li>
</ul>
<p>所有的措施都是为了缩小检索空间，只要划分后的上下文，AI 可以“吃”下，那就可以了。</p>
<h2 data-id="heading-2">借助工具实现代码图谱</h2>
<p>上面的思路估计很多人会望而却步，毕竟，大项目最难着手的就是分析。</p>
<p>这时候，还有另一种思路，借助专门的“<strong>代码图谱</strong>”工具进行分析。</p>
<p>“代码图谱”可以理解为一种专门的“知识图谱”，通过解析 <code>AST</code>、<code>调用关系</code>和<code>数据依赖</code>，构建项目级的语义索引，支持基于<strong>结构的精准检索</strong>。</p>
<p>相比纯向量检索，代码图谱更能捕捉函数调用、继承等结构化关系，适合深度理解。</p>
<p>我找到了一个比较不错的落地工具：<code>Sourcegraph Cody</code>，支持 <code>VS Code</code> 系列插件安装。</p>
<p>目前尚未来得及实测，大家感兴趣可以先行尝试。</p>
<h2 data-id="heading-3">按需加载上下文</h2>
<p>“代码图谱”已经提供了一个比较智能的上下文自动划分思路，但这个思路更多的解决重点其实是在单次 AI 对话的上下文上。</p>
<p>如果某个任务特别复杂，单次 AI 对话无法解决，需要多次交互，那上下文依然会出现无法满足的情况。</p>
<p>这时候就需要“按需加载上下文”这种思路去进一步优化了。</p>
<p>这一思路主要是引入一个<strong>动态决策</strong>的智能体，它先将复杂任务拆解为的多个步骤，并针对<strong>每一步的请求内容</strong>，动态分析<strong>所需的上下文</strong>（在代码图谱基础上，再次按需索取），然后循环迭代，直至计划执行完毕。</p>
<p>其实就是 <code>Claude Skills</code> 的设计思路，可以在 <code>Plan</code> 阶段生成的文档<strong>计划</strong>中，支持自动/手动<strong>配置相关上下文</strong>。</p>
<p>但是，目前尚未找到完美的落地方案。如果你有合适推荐，欢迎留言指导。</p>
<h2 data-id="heading-4">结语</h2>
<p>以上就是这两天了解到的<strong>AI 理解大项目</strong>的几个思路，可以结合起来，逐步应用。</p>
<p>你遇到大项目理解难题时，是怎么破局的？欢迎留言交流！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Coze Studio 源码分析（一）后端架构及数据流分析]]></title>    <link>https://juejin.cn/post/7573468493570506788</link>    <guid>https://juejin.cn/post/7573468493570506788</guid>    <pubDate>2025-11-17T15:21:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573468493570506788" data-draft-id="7573511426868133907" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Coze Studio 源码分析（一）后端架构及数据流分析"/> <meta itemprop="keywords" content="Coze"/> <meta itemprop="datePublished" content="2025-11-17T15:21:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="DevYK"/> <meta itemprop="url" content="https://juejin.cn/user/3368559355637566"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Coze Studio 源码分析（一）后端架构及数据流分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3368559355637566/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    DevYK
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T15:21:57.000Z" title="Mon Nov 17 2025 15:21:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读24分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">目录</h2>
<ul>
<li><a href="#1-%E9%A1%B9%E7%9B%AE%E6%A6%82%E8%BF%B0" title="#1-%E9%A1%B9%E7%9B%AE%E6%A6%82%E8%BF%B0">1. 项目概述</a></li>
<li><a href="#2-%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1" title="#2-%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1">2. 整体架构设计</a></li>
<li><a href="#3-%E6%A0%B8%E5%BF%83%E5%88%86%E5%B1%82%E6%9E%B6%E6%9E%84" title="#3-%E6%A0%B8%E5%BF%83%E5%88%86%E5%B1%82%E6%9E%B6%E6%9E%84">3. 核心分层架构</a></li>
<li><a href="#4-%E5%85%B3%E9%94%AE%E6%8A%80%E6%9C%AF%E6%A0%88" title="#4-%E5%85%B3%E9%94%AE%E6%8A%80%E6%9C%AF%E6%A0%88">4. 关键技术栈</a></li>
<li><a href="#5-%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90" title="#5-%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90">5. 目录结构分析</a></li>
<li><a href="#6-%E6%A0%B8%E5%BF%83%E6%A8%A1%E5%9D%97%E8%AF%A6%E8%A7%A3" title="#6-%E6%A0%B8%E5%BF%83%E6%A8%A1%E5%9D%97%E8%AF%A6%E8%A7%A3">6. 核心模块详解</a></li>
<li><a href="#7-%E6%95%B0%E6%8D%AE%E6%B5%81%E5%88%86%E6%9E%90%E7%AE%80%E5%8D%95%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A4%BA%E4%BE%8B" title="#7-%E6%95%B0%E6%8D%AE%E6%B5%81%E5%88%86%E6%9E%90%E7%AE%80%E5%8D%95%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A4%BA%E4%BE%8B">7. 数据流分析：简单工作流示例</a></li>
<li><a href="#8-%E6%80%BB%E7%BB%93%E4%B8%8E%E5%B1%95%E6%9C%9B" title="#8-%E6%80%BB%E7%BB%93%E4%B8%8E%E5%B1%95%E6%9C%9B">8. 总结与展望</a></li>
</ul>
<hr/>
<h2 data-id="heading-1">1. 项目概述</h2>
<h3 data-id="heading-2">1.1 Coze Studio 简介</h3>
<p>Coze Studio 是一个开源的 AI Agent 开发平台，提供从开发到部署的全流程支持。后端采用 <strong>Golang</strong> 开发，前端使用 <strong>React + TypeScript</strong>，整体架构基于<strong>微服务</strong>和**领域驱动设计（DDD）**原则构建。</p>
<p><strong>核心特性</strong>：</p>
<ul>
<li>🎯 提供 AI Agent 开发所需的核心技术：Prompt、RAG、Plugin、Workflow</li>
<li>🚀 低代码/无代码的可视化开发工具</li>
<li>🔧 完整的模型管理、知识库、MCP(<code>在 coze-studio-plus 中实现了</code>)、插件系统</li>
<li>📊 强大的 Workflow 编排引擎</li>
<li>🌐 RESTful API 和 SDK 支持</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f5970d1ecab44b49c09e4d87b9b9eaf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGV2WUs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763997717&amp;x-signature=HDvz85uFjpHQ7N7WzHHCZzdC0qs%3D" alt="20251117225049" loading="lazy"/></p>
<h3 data-id="heading-3">1.2 技能点</h3>





































<table><thead><tr><th>技术</th><th>描述</th></tr></thead><tbody><tr><td><strong>Golang</strong></td><td>高性能、并发友好、部署简单</td></tr><tr><td><strong>Hertz</strong></td><td>CloudWeGo 高性能 HTTP 框架</td></tr><tr><td><strong>Eino</strong></td><td>AI Workflow 运行时引擎,类似于 python 的 LangGraph</td></tr><tr><td><strong>DDD</strong></td><td>复杂业务逻辑的最佳实践</td></tr><tr><td><strong>MySQL</strong></td><td>主数据存储</td></tr><tr><td><strong>Redis</strong></td><td>缓存和 Checkpoint 存储</td></tr><tr><td><strong>Elasticsearch</strong></td><td>搜索和知识库检索</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-4">2. 整体架构设计</h2>
<h3 data-id="heading-5">2.1 宏观架构图</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph L7["第7层：客户端层 Client Layer"]
        direction LR
        A["Web Frontend&lt;br/&gt;React + TypeScript&lt;br/&gt;Web前端界面"]
        B["API/SDK Client&lt;br/&gt;API和SDK客户端&lt;br/&gt;第三方系统集成"]
    end
    
    subgraph L6["第6层：接入层 API Layer"]
        direction LR
        C["Hertz HTTP Server&lt;br/&gt;:8888&lt;br/&gt;HTTP服务器，接收请求"]
        D["Middleware Stack&lt;br/&gt;Auth/Log/CORS&lt;br/&gt;中间件栈：认证/日志/跨域"]
        E["Router&lt;br/&gt;API Routes&lt;br/&gt;路由分发，API路由注册"]
    end
    
    subgraph L5["第5层：应用服务层 Application Layer"]
        direction LR
        F1["WorkflowApp&lt;br/&gt;工作流应用服务&lt;br/&gt;编排工作流业务流程"]
        F2["SingleAgentApp&lt;br/&gt;单智能体应用服务&lt;br/&gt;管理Agent创建和执行"]
        F3["PluginApp&lt;br/&gt;插件应用服务&lt;br/&gt;管理插件生命周期"]
        F4["KnowledgeApp&lt;br/&gt;知识库应用服务&lt;br/&gt;管理知识库CRUD"]
        F5["ConversationApp&lt;br/&gt;对话应用服务&lt;br/&gt;管理对话会话"]
    end
    
    subgraph L4["第4层：领域层 Domain Layer"]
        direction LR
        G1["Workflow Domain&lt;br/&gt;工作流领域服务&lt;br/&gt;核心工作流业务逻辑"]
        G2["Agent Domain&lt;br/&gt;智能体领域服务&lt;br/&gt;Agent核心业务逻辑"]
        G3["Plugin Domain&lt;br/&gt;插件领域服务&lt;br/&gt;插件核心业务逻辑"]
        G4["Knowledge Domain&lt;br/&gt;知识库领域服务&lt;br/&gt;知识库核心逻辑"]
    end
    
    subgraph L3["第3层：跨域服务层 Cross Domain Layer"]
        direction LR
        H1["Workflow Cross&lt;br/&gt;工作流跨域服务"]
        H2["Message Cross&lt;br/&gt;消息跨域服务"]
        H3["Database Cross&lt;br/&gt;数据库跨域服务"]
        H4["Plugin Cross&lt;br/&gt;插件跨域服务"]
    end
    
    subgraph L2["第2层：基础设施层 Infrastructure Layer"]
        direction LR
        I1[("MySQL&lt;br/&gt;关系型数据库")]
        I2[("Redis&lt;br/&gt;内存数据库")]
        I3[("Elasticsearch&lt;br/&gt;搜索引擎")]
        I4["OSS&lt;br/&gt;对象存储"]
        I5["EventBus&lt;br/&gt;事件总线"]
        I6["CodeRunner&lt;br/&gt;代码执行器"]
    end
    
    subgraph L1["第1层：外部服务层 External Services"]
        direction LR
        J["LLM Providers&lt;br/&gt;OpenAI/Claude/..."]
        K["Embedding Service&lt;br/&gt;向量嵌入服务"]
    end
    
    %% 客户端到接入层
    A --&gt; C
    B --&gt; C
    
    %% 接入层内部流转（顺序执行）
    C --&gt; D
    D --&gt; E
    
    %% 接入层到应用服务层（路由分发）
    E --&gt; F1
    E --&gt; F2
    E --&gt; F3
    E --&gt; F4
    E --&gt; F5
    
    %% 应用服务层到领域层（主要调用关系，对齐减少交叉）
    F1 --&gt; G1
    F2 --&gt; G2
    F3 --&gt; G3
    F4 --&gt; G4
    F5 --&gt; G1
    F5 --&gt; G2
    
    %% 领域层到跨域服务层（虚线表示间接调用）
    G1 -.-&gt; H1
    G2 -.-&gt; H2
    G3 -.-&gt; H4
    G4 -.-&gt; H3
    
    %% 跨域服务层到基础设施层
    H1 --&gt; I1
    H2 --&gt; I2
    H3 --&gt; I1
    H4 --&gt; I1
    
    %% 领域层直接访问基础设施（主要依赖，简化连接）
    G1 --&gt; I2
    G1 --&gt; I5
    G4 --&gt; I3
    G3 --&gt; I4
    G3 --&gt; I6
    
    %% 领域层到外部服务
    G1 --&gt; J
    G2 --&gt; J
    G4 --&gt; K
    
    %% 样式
    style L7 fill:#e1f5ff
    style L6 fill:#fff4e1
    style L5 fill:#e8f5e9
    style L4 fill:#f3e5f5
    style L3 fill:#fce4ec
    style L2 fill:#fff9c4
    style L1 fill:#f5f5f5
</code></pre>
<h3 data-id="heading-6">2.2 架构特点分析</h3>







































































<table><thead><tr><th>层级/模块</th><th>职责（简述）</th><th>依赖关系（→ 表示依赖）</th><th>主要联系方式</th></tr></thead><tbody><tr><td><strong>API</strong> (backend/api)</td><td>暴露 HTTP 接口层，使用 Hertz（Go 的高性能 Web 框架）处理请求、路由和响应组装。</td><td>API → Application API → Types</td><td>- 通过 Application 的服务接口调用业务逻辑。 - 使用 Types 定义请求/响应 DTO（数据传输对象）。 - 与前端 IDL 联动，确保 API 契约一致。</td></tr><tr><td><strong>Application</strong> (backend/application)</td><td>应用层：协调领域层和基础设施，封装业务用例（如 API 聚合、事务管理）。不含核心业务逻辑。</td><td>Application → Domain Application → Infra (Contract) Application → Pkg</td><td>- 调用 Domain 的聚合根/服务执行业务。 - 通过 Infra Contract 的接口（如 Repository）访问数据。 - 使用 Pkg 的工具（如依赖注入）组装组件。</td></tr><tr><td><strong>Domain</strong> (backend/domain)</td><td>领域层：DDD 核心，封装实体、值对象、聚合、领域服务和事件。纯业务逻辑，无技术细节。</td><td>Domain ← (无依赖，独立) Domain → Crossdomain (可选共享)</td><td>- 被 Application 调用，提供行为方法（如 Order.Create()）。 - 通过领域事件（Domain Event）与 Crossdomain 通信，解耦跨域逻辑。 - 定义 Infra 的合约接口（如 Repository 接口）。</td></tr><tr><td><strong>Crossdomain</strong> (backend/crossdomain)</td><td>跨领域层：处理多限界上下文（Bounded Context）间的共享模型、事件和规则（如全局用户 ID）。</td><td>Crossdomain → Domain (部分) Crossdomain ← Application (调用)</td><td>- 作为 Domain 的补充，提供共享值对象/事件。 - 通过事件总线（Event Bus）与多个 Domain 交互，避免直接耦合。</td></tr><tr><td><strong>Infra/contract</strong> (backend/infra/contract)</td><td>基础设施合约层：定义抽象接口（如 Repository、Cache 接口），由 Domain 驱动。</td><td>Infra/Contract ← Domain (接口由 Domain 定义) Infra/Contract → Impl</td><td>- 为 Domain 提供“门面”，隐藏实现细节。 - Application 通过这些接口间接访问 Impl。 - 确保可替换性（e.g., 换数据库）。</td></tr><tr><td><strong>Infra/Impl</strong> (backend/infra/impl)</td><td>基础设施实现层：具体实现合约，如数据库（GORM/MySQL）、缓存（Redis）、消息队列。</td><td>Infra/Impl → Contract (实现接口)</td><td>- 注入到 Application/Domain 中（通过 Pkg 的 DI 容器）。 - 只响应合约调用，不反向影响业务层。</td></tr><tr><td><strong>Pkg</strong> (backend/pkg)</td><td>共享包层：工具和依赖注入（如 Wire），跨层复用。</td><td>Pkg ← (所有层可选依赖)</td><td>- 提供 DI（依赖注入）框架，连接 Application 与 Infra。 - 包含通用工具（如日志、配置），减少重复代码。</td></tr><tr><td><strong>Types</strong> (backend/types)</td><td>类型定义层：共享数据结构（如枚举、结构体），用于 DTO 和内部类型。</td><td>Types ← API/Application (引用)</td><td>- 统一类型系统，避免散乱定义。 - 与 IDL 同步，确保前后端类型一致。</td></tr><tr><td><strong>Common</strong> (backend/common)</td><td>通用组件层：基础工具（如错误码、常量）。</td><td>Common ← (辅助其他层)</td><td>- 被所有层引用，提供底层支持（如日志中间件）。</td></tr><tr><td><strong>Docker</strong> (backend/docker)</td><td>部署配置层：Dockerfile 和 Compose，用于容器化。</td><td>Docker ← (外部，无直接依赖)</td><td>- 打包整个后端服务，支持微服务部署。 - 与整体项目集成，无业务联系。</td></tr></tbody></table>
<p>Coze Studio 的 DDD 架构遵循四层洋葱模型（API → Application → Domain → Infra）辅以共享层（Pkg/Types/Crossdomain），数据流为：外部 HTTP 请求经 API 层路由/验证后传入 Application 协调用例与事务，调用 Domain 层纯业务实体/聚合/事件处理核心逻辑（如代理创建），Domain 通过合约接口（如 Repository）驱动 Infra 层实现持久化（OceanBase/ES）、缓存（Cache）与事件分发（EventBus），处理结果经 Crossdomain 共享跨域数据后逆向回流至 API 响应前端，同时 Pkg 注入依赖与 Types 统一类型确保全链路一致性。</p>
<h4 data-id="heading-7">2.2.2 DDD 实践</h4>
<p><strong>领域驱动设计核心要素</strong>：</p>
<ul>
<li><strong>实体（Entity）</strong>：具有唯一标识的领域对象</li>
<li><strong>值对象（Value Object）</strong>：无标识的不可变对象</li>
<li><strong>聚合根（Aggregate Root）</strong>：管理一组相关对象的生命周期</li>
<li><strong>领域服务（Domain Service）</strong>：跨实体的业务逻辑</li>
<li><strong>仓储（Repository）</strong>：数据访问抽象层</li>
<li><strong>应用服务（Application Service）</strong>：用例协调者</li>
</ul>
<h4 data-id="heading-8">2.2.3 依赖倒置原则</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph BT
    A[Domain Layer&lt;br/&gt;领域接口定义] 
    B[Application Layer&lt;br/&gt;依赖接口]
    C[Infrastructure Layer&lt;br/&gt;实现接口]
    D[Cross Domain&lt;br/&gt;依赖接口]
    
    B --&gt;|依赖| A
    C -.-&gt;|实现| A
    D --&gt;|依赖| A
    
    style A fill:#f9f,stroke:#333,stroke-width:4px
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>✅ 核心业务逻辑不依赖基础设施</li>
<li>✅ 易于测试（可 Mock）</li>
<li>✅ 灵活替换底层实现</li>
</ul>
<hr/>
<h2 data-id="heading-9">3. 核心分层架构</h2>
<h3 data-id="heading-10">3.1 各层详细职责</h3>
<h4 data-id="heading-11">3.1.1 API 层（<code>/backend/api</code>）</h4>
<pre><code class="hljs language-bash" lang="bash">api/
├── handler/          <span class="hljs-comment"># HTTP 请求处理器</span>
│   └── coze/         <span class="hljs-comment"># 具体业务 Handler</span>
├── middleware/       <span class="hljs-comment"># 中间件（认证、日志、CORS）</span>
├── model/           <span class="hljs-comment"># API 数据模型（DTO）</span>
└── router/          <span class="hljs-comment"># 路由注册</span>
</code></pre>
<p><strong>核心职责</strong>：</p>
<ul>
<li>🔸 接收 HTTP 请求，解析参数</li>
<li>🔸 调用 Application Service</li>
<li>🔸 返回统一格式的响应</li>
<li>🔸 参数校验和错误处理</li>
</ul>
<p><strong>关键代码示例</strong>（<code>main.go</code>）：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    ctx := context.Background()
    
    <span class="hljs-comment">// 1. 加载环境变量</span>
    loadEnv()
    
    <span class="hljs-comment">// 2. 初始化所有服务（依赖注入）</span>
    application.Init(ctx)
    
    <span class="hljs-comment">// 3. 启动 HTTP 服务器</span>
    startHttpServer()
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">startHttpServer</span><span class="hljs-params">()</span></span> {
    s := server.Default(opts...)
    
    <span class="hljs-comment">// 中间件链（顺序很重要！）</span>
    s.Use(middleware.ContextCacheMW())      <span class="hljs-comment">// 上下文缓存</span>
    s.Use(middleware.RequestInspectorMW())  <span class="hljs-comment">// 请求检查</span>
    s.Use(middleware.SetHostMW())           <span class="hljs-comment">// 设置主机信息</span>
    s.Use(middleware.SetLogIDMW())          <span class="hljs-comment">// 日志ID</span>
    s.Use(corsHandler)                      <span class="hljs-comment">// CORS</span>
    s.Use(middleware.AccessLogMW())         <span class="hljs-comment">// 访问日志</span>
    s.Use(middleware.OpenapiAuthMW())       <span class="hljs-comment">// OpenAPI 认证</span>
    s.Use(middleware.SessionAuthMW())       <span class="hljs-comment">// Session 认证</span>
    s.Use(middleware.I18nMW())              <span class="hljs-comment">// 国际化</span>
    
    router.GeneratedRegister(s)
    s.Spin()
}
</code></pre>
<p><strong>中间件执行顺序</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[HTTP Request] --&gt; B[ContextCache]
    B --&gt; C[RequestInspector]
    C --&gt; D[SetHost]
    D --&gt; E[SetLogID]
    E --&gt; F[CORS]
    F --&gt; G[AccessLog]
    G --&gt; H[OpenapiAuth]
    H --&gt; I[SessionAuth]
    I --&gt; J[I18n]
    J --&gt; K[Handler]
    K --&gt; L[Response]
    
    style A fill:#e3f2fd
    style K fill:#c8e6c9
    style L fill:#fff9c4
</code></pre>
<h4 data-id="heading-12">3.1.2 应用服务层（<code>/backend/application</code>）</h4>
<pre><code class="hljs language-bash" lang="bash">── application/      <span class="hljs-comment"># 应用层，组合领域对象和基础设施实现</span>
   ├── app/          <span class="hljs-comment"># 应用服务</span>
   ├── conversation/ <span class="hljs-comment"># 会话应用服务</span>
   ├── knowledge/    <span class="hljs-comment"># 知识应用服务</span>
   ├── memory/       <span class="hljs-comment"># 内存应用服务</span>
   ├── modelmgr/     <span class="hljs-comment"># 模型管理应用服务</span>
   ├── plugin/       <span class="hljs-comment"># 插件应用服务</span>
   ├── prompt/       <span class="hljs-comment"># 提示词应用服务</span>
   ├── search/       <span class="hljs-comment"># 搜索应用服务</span>
   ├── singleagent/  <span class="hljs-comment"># 单一代理应用服务</span>
   ├── user/         <span class="hljs-comment"># 用户应用服务</span>
   └── workflow/     <span class="hljs-comment"># 工作流应用服务</span>
</code></pre>
<p><strong>核心职责</strong>：</p>
<ul>
<li>🔸 编排多个 Domain Service 完成业务用例</li>
<li>🔸 事务管理</li>
<li>🔸 权限检查</li>
<li>🔸 事件发布</li>
</ul>
<p><strong>服务初始化</strong>（<code>application.go</code>）：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Init</span><span class="hljs-params">(ctx context.Context)</span></span> (err <span class="hljs-type">error</span>) {
	<span class="hljs-comment">// 1. 初始化上下文缓存</span>
	ctx = ctxcache.Init(ctx)
	<span class="hljs-comment">// 2. 初始化基础设施</span>
	infra, err := appinfra.Init(ctx)

	<span class="hljs-comment">// 3. 初始化事件总线(依赖基础设施)</span>
	eventbus := initEventBus(infra)

	<span class="hljs-comment">// 4. 初始化基础服务(依赖基础设施和事件总线)</span>
	basicServices, err := initBasicServices(ctx, infra, eventbus)

	<span class="hljs-comment">// 5. 初始化主服务(依赖基础服务)</span>
	primaryServices, err := initPrimaryServices(ctx, basicServices)

	<span class="hljs-comment">// 6. 初始化复杂服务(依赖主服务)</span>
	complexServices, err := initComplexServices(ctx, primaryServices)

	<span class="hljs-comment">// 7. 配置跨域服务</span>
	crossconnector.SetDefaultSVC(connectorImpl.InitDomainService(basicServices.connectorSVC.DomainSVC))
	crossdatabase.SetDefaultSVC(databaseImpl.InitDomainService(primaryServices.memorySVC.DatabaseDomainSVC))
	crossknowledge.SetDefaultSVC(knowledgeImpl.InitDomainService(primaryServices.knowledgeSVC.DomainSVC))
	crossplugin.SetDefaultSVC(pluginImpl.InitDomainService(primaryServices.pluginSVC.DomainSVC, infra.OSS))
	...
	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}
</code></pre>
<p><strong>服务依赖简要关系图</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    subgraph "Infrastructure 基础设施"
        I1[DB/Redis/OSS/ES]
    end
    
    subgraph "Basic Services 基础服务"
        B1[ModelMgr]
        B2[Connector]
        B3[User]
        B4[Upload]
    end
    
    subgraph "Primary Services 主要服务"
        P1[Plugin]
        P2[Memory]
        P3[Knowledge]
        P4[Workflow]
    end
    
    subgraph "Complex Services 复杂服务"
        C1[SingleAgent]
        C2[App]
        C3[Conversation]
    end
    
    I1 --&gt; B1
    I1 --&gt; B2
    I1 --&gt; B3
    I1 --&gt; B4
    
    B1 --&gt; P1
    B2 --&gt; P2
    B3 --&gt; P3
    B4 --&gt; P4
    
    P1 --&gt; C1
    P2 --&gt; C1
    P3 --&gt; C2
    P4 --&gt; C2
    
    C1 --&gt; C3
    C2 --&gt; C3
    
    style I1 fill:#fff9c4
    style P1 fill:#c8e6c9
    style P2 fill:#c8e6c9
    style P3 fill:#c8e6c9
    style P4 fill:#c8e6c9
    style C1 fill:#f8bbd0
    style C2 fill:#f8bbd0
    style C3 fill:#f8bbd0
</code></pre>
<h4 data-id="heading-13">3.1.3 领域层（<code>/backend/domain</code>）</h4>
<pre><code class="hljs language-bash" lang="bash">── domain/           <span class="hljs-comment"># 领域层，包含核心业务逻辑</span>
   ├── agent/        <span class="hljs-comment"># 代理领域逻辑</span>
   ├── app/          <span class="hljs-comment"># 应用领域逻辑</span>
   ├── conversation/ <span class="hljs-comment"># 会话领域逻辑</span>
   ├── knowledge/    <span class="hljs-comment"># 知识领域逻辑</span>
   ├── memory/       <span class="hljs-comment"># 内存领域逻辑</span>
   ├── modelmgr/     <span class="hljs-comment"># 模型管理领域逻辑</span>
   ├── plugin/       <span class="hljs-comment"># 插件领域逻辑</span>
   ├── prompt/       <span class="hljs-comment"># 提示词领域逻辑</span>
   ├── search/       <span class="hljs-comment"># 搜索领域逻辑</span>
   ├── user/         <span class="hljs-comment"># 用户领域逻辑</span>
   └── workflow/     <span class="hljs-comment"># 工作流领域逻辑</span>
</code></pre>
<p><strong>领域模型核心</strong>：</p>
<p><strong>Entity 示例</strong>（<code>domain/workflow/entity/workflow.go</code>）：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Workflow 实体（聚合根）</span>
<span class="hljs-keyword">type</span> Workflow <span class="hljs-keyword">struct</span> {
    ID          <span class="hljs-type">int64</span>
    SpaceID     <span class="hljs-type">int64</span>
    AppID       *<span class="hljs-type">int64</span>
    Name        <span class="hljs-type">string</span>
    Description <span class="hljs-type">string</span>
    Mode        WorkflowMode  <span class="hljs-comment">// CHATFLOW | WORKFLOW</span>
    Canvas      <span class="hljs-type">string</span>        <span class="hljs-comment">// JSON schema</span>
    Version     <span class="hljs-type">string</span>
    Status      Status
    CreatedAt   time.Time
    UpdatedAt   time.Time
}

<span class="hljs-comment">// 业务方法</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *Workflow)</span></span> GetBasic() *BasicInfo { ... }
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *Workflow)</span></span> GetVersion() <span class="hljs-type">string</span> { ... }
</code></pre>
<p><strong>Domain Service 接口</strong>（<code>domain/workflow/interface.go</code>）：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> Service <span class="hljs-keyword">interface</span> {
    <span class="hljs-comment">// 元数据管理</span>
    Create(ctx context.Context, meta *vo.MetaCreate) (<span class="hljs-type">int64</span>, <span class="hljs-type">error</span>)
    Get(ctx context.Context, policy *vo.GetPolicy) (*entity.Workflow, <span class="hljs-type">error</span>)
    Delete(ctx context.Context, policy *vo.DeletePolicy) ([]<span class="hljs-type">int64</span>, <span class="hljs-type">error</span>)
    UpdateMeta(ctx context.Context, id <span class="hljs-type">int64</span>, metaUpdate *vo.MetaUpdate) <span class="hljs-type">error</span>
    
    <span class="hljs-comment">// 执行相关</span>
    Executable  <span class="hljs-comment">// 嵌入执行接口</span>
    AsTool      <span class="hljs-comment">// 作为工具使用</span>
    
    <span class="hljs-comment">// Workflow 特有逻辑</span>
    Publish(ctx context.Context, policy *vo.PublishPolicy) <span class="hljs-type">error</span>
    WorkflowSchemaCheck(ctx context.Context, wf *entity.Workflow, checks []workflow.CheckType) ([]*workflow.CheckResult, <span class="hljs-type">error</span>)
    
    <span class="hljs-comment">// 会话相关</span>
    ChatFlowRole
    Conversation
}
</code></pre>
<h4 data-id="heading-14">3.1.4 跨域服务层（<code>/backend/crossdomain</code>）</h4>
<p><strong>设计目的</strong>：</p>
<ul>
<li>解决循环依赖问题</li>
<li>提供统一的跨领域调用接口</li>
<li>隔离不同领域的实现细节</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">├── crossdomain/      <span class="hljs-comment"># 跨领域防腐层</span>
│   ├── contract/     <span class="hljs-comment"># 跨领域接口定义</span>
│   ├── impl/         <span class="hljs-comment"># 跨领域接口实现</span>
│   └── workflow/     <span class="hljs-comment"># 工作流跨领域实现</span>

<span class="hljs-comment">#示例</span>
crossdomain/
├── workflow/
│   ├── contract.go       <span class="hljs-comment"># 接口定义</span>
│   ├── impl/            <span class="hljs-comment"># 接口实现（适配器）</span>
│   └── model/           <span class="hljs-comment"># 跨域数据模型</span>
├── knowledge/
├── plugin/
└── ...


</code></pre>
<p><strong>使用模式</strong>：</p>
<blockquote>
<p><strong>注意</strong>：以下代码为<strong>伪代码示例</strong>，用于说明跨域调用的概念模式。实际代码中的函数名和方法名可能不同。</p>
</blockquote>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 伪代码示例：在 Plugin Domain 中调用 Workflow</span>
<span class="hljs-keyword">import</span> crossworkflow <span class="hljs-string">"github.com/coze-dev/coze-studio/backend/crossdomain/workflow"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *PluginService)</span></span> UseInWorkflow(ctx context.Context, wfID <span class="hljs-type">int64</span>) <span class="hljs-type">error</span> {
    <span class="hljs-comment">// 通过 crossdomain 接口调用（伪代码）</span>
    wf, err := crossworkflow.GetDefaultSVC().GetWorkflow(ctx, wfID)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> err
    }
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p><strong>真实代码示例</strong>（来自 <code>backend/domain/agent/singleagent/internal/agentflow/node_tool_workflow.go</code>）：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 真实代码：在 Agent Domain 中调用 Workflow</span>
<span class="hljs-keyword">import</span> crossworkflow <span class="hljs-string">"github.com/coze-dev/coze-studio/backend/crossdomain/workflow"</span>

<span class="hljs-comment">// 获取 Workflow 作为工具使用</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newWorkflowTools</span><span class="hljs-params">(ctx context.Context, conf *workflowConfig)</span></span> ([]workflow.ToolFromWorkflow, <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">struct</span>{}, <span class="hljs-type">error</span>) {
	<span class="hljs-keyword">var</span> policies []*vo.GetPolicy

  ...

	workflowTools, err := crossworkflow.DefaultSVC().WorkflowAsModelTool(ctx, policies)

  ...
	<span class="hljs-keyword">return</span> workflowTools, toolsReturnDirectly, err
}
</code></pre>
<h4 data-id="heading-15">3.1.5 基础设施层（<code>/backend/infra</code>）</h4>
<pre><code class="hljs language-bash" lang="bash">infra/
├── orm/              <span class="hljs-comment"># ORM 封装</span>
├── rdb/              <span class="hljs-comment"># 关系数据库</span>
├── cache/            <span class="hljs-comment"># Redis 缓存</span>
├── es/               <span class="hljs-comment"># Elasticsearch</span>
├── storage/          <span class="hljs-comment"># 对象存储（OSS）</span>
├── eventbus/         <span class="hljs-comment"># 事件总线</span>
├── embedding/        <span class="hljs-comment"># 向量嵌入</span>
├── coderunner/       <span class="hljs-comment"># 代码执行沙箱</span>
├── checkpoint/       <span class="hljs-comment"># 检查点存储</span>
└── ...
</code></pre>
<p><strong>核心职责</strong>：</p>
<ul>
<li>🔸 封装技术实现细节（数据库、缓存、消息队列等）</li>
<li>🔸 提供统一的接口抽象，不依赖具体实现</li>
<li>🔸 实现依赖倒置，领域层只依赖接口</li>
</ul>
<p><strong>代码示例</strong>：</p>
<p><strong>1. Elasticsearch 使用示例</strong></p>
<p><code>application-&gt;domain-&gt;infra   </code></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">//coze-studio/backend/application/application.go</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">initComplexServices</span><span class="hljs-params">(ctx context.Context, p *primaryServices)</span></span> (*complexServices, <span class="hljs-type">error</span>) {
	...

	searchSVC, err := search.InitService(ctx, p.toSearchServiceComponents(singleAgentSVC, appSVC))
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
	}

	...
}

<span class="hljs-comment">//coze-studio/backend/application/search/init.go</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitService</span><span class="hljs-params">(ctx context.Context, s *ServiceComponents)</span></span> (*SearchApplicationService, <span class="hljs-type">error</span>) {
	searchDomainSVC := search.NewDomainService(ctx, s.ESClient)

	...

	<span class="hljs-keyword">return</span> SearchSVC, <span class="hljs-literal">nil</span>
}

<span class="hljs-comment">//coze-studio/backend/domain/search/service/search.go</span>
<span class="hljs-comment">// 领域服务通过依赖注入获取 ES 客户端</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewDomainService</span><span class="hljs-params">(ctx context.Context, e es.Client)</span></span> Search {
    <span class="hljs-keyword">return</span> &amp;searchImpl{
        esClient: e,
    }
}

<span class="hljs-comment">// 使用 ES 进行全文检索</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *searchImpl)</span></span> SearchProjects(ctx context.Context, req *SearchRequest) <span class="hljs-type">error</span> {
    searchReq := &amp;es.Request{
        Query: &amp;es.Query{
            Bool: &amp;es.BoolQuery{
                Must: []es.Query{
                    es.NewEqualQuery(<span class="hljs-string">"space_id"</span>, strconv.FormatInt(req.SpaceID, <span class="hljs-number">10</span>)),
                },
            },
        },
    }
    
    result, err := s.esClient.Search(ctx, <span class="hljs-string">"project_index"</span>, searchReq)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> err
    }
    <span class="hljs-comment">// 处理搜索结果...</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}

<span class="hljs-comment">//coze-studio/backend/infra/es/es.go</span>
<span class="hljs-keyword">type</span> Client <span class="hljs-keyword">interface</span> {
...
	Search(ctx context.Context, index <span class="hljs-type">string</span>, req *Request) (*Response, <span class="hljs-type">error</span>)
...
}
<span class="hljs-comment">//最后会根据实例化的 es 去调用</span>
impl/es
	es_impl.<span class="hljs-keyword">go</span>
	es7.<span class="hljs-keyword">go</span>
	es8.<span class="hljs-keyword">go</span>
	...
</code></pre>
<p><strong>2. Storage（对象存储）使用示例</strong>（来自 <code>backend/domain/plugin/service/exec_tool.go</code>）：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> toolExecutor <span class="hljs-keyword">struct</span> {
    <span class="hljs-comment">// 通过依赖注入获取存储服务</span>
    oss storage.Storage
}

<span class="hljs-comment">// 上传文件到对象存储</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(t *toolExecutor)</span></span> uploadFile(ctx context.Context, content []<span class="hljs-type">byte</span>, objectKey <span class="hljs-type">string</span>) <span class="hljs-type">error</span> {
    <span class="hljs-keyword">return</span> t.oss.PutObject(ctx, objectKey, content)
}

<span class="hljs-comment">// 获取文件的预签名URL</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(t *toolExecutor)</span></span> getFileUrl(ctx context.Context, objectKey <span class="hljs-type">string</span>) (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) {
    <span class="hljs-keyword">return</span> t.oss.GetObjectUrl(ctx, objectKey, storage.WithExpiration(time.Hour))
}
</code></pre>
<p><strong>3. Cache（Redis）使用示例</strong>（来自 <code>backend/domain/workflow/internal/nodes/llm/llm.go</code>）：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 使用上下文缓存（基于 Redis）</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">"github.com/coze-dev/coze-studio/backend/pkg/ctxcache"</span>

<span class="hljs-comment">// 存储数据到缓存</span>
ctxcache.Store(ctx, <span class="hljs-string">"raw_output_key"</span>, outputData)
ctxcache.Store(ctx, <span class="hljs-string">"chat_history_key"</span>, messages)

<span class="hljs-comment">// 从缓存读取数据</span>
rawOutput, found := ctxcache.Get[<span class="hljs-type">string</span>](ctx, <span class="hljs-string">"raw_output_key"</span>)
<span class="hljs-keyword">if</span> found {
    <span class="hljs-comment">// 使用缓存的数据</span>
}
</code></pre>
<p><strong>4. EventBus（事件总线）接口定义</strong>（来自 <code>backend/infra/eventbus/eventbus.go</code>）：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 事件生产者接口</span>
<span class="hljs-keyword">type</span> Producer <span class="hljs-keyword">interface</span> {
    Send(ctx context.Context, body []<span class="hljs-type">byte</span>, opts ...SendOpt) <span class="hljs-type">error</span>
    BatchSend(ctx context.Context, bodyArr [][]<span class="hljs-type">byte</span>, opts ...SendOpt) <span class="hljs-type">error</span>
}

<span class="hljs-comment">// 事件消费者接口</span>
<span class="hljs-keyword">type</span> ConsumerHandler <span class="hljs-keyword">interface</span> {
    HandleMessage(ctx context.Context, msg *Message) <span class="hljs-type">error</span>
}

<span class="hljs-comment">// 使用示例：发布事件</span>
producer.Send(ctx, eventData, eventbus.WithTopic(<span class="hljs-string">"workflow_events"</span>))

<span class="hljs-comment">// 使用示例：消费事件</span>
eventbus.GetDefaultSVC().RegisterConsumer(
    <span class="hljs-string">"server"</span>, <span class="hljs-string">"workflow_events"</span>, <span class="hljs-string">"group1"</span>, 
    &amp;MyHandler{}, 
)
</code></pre>
<hr/>
<h2 data-id="heading-16">4. 关键技术栈</h2>
<h3 data-id="heading-17">4.1 核心框架</h3>
<h4 data-id="heading-18">4.1.1 Hertz - HTTP 框架</h4>
<ul>
<li>🚀 CloudWeGo 生态，性能优异</li>
<li>🔧 中间件机制完善</li>
<li>📦 代码生成支持（基于 IDL）</li>
</ul>
<h4 data-id="heading-19">4.1.2 Eino - AI Workflow 引擎</h4>
<p><strong>Eino</strong>  是字节开源的 Go 语言编写的终极大型语言模型（LLM）应用开发框架，它从开源社区中的诸多优秀 LLM 应用开发框架，如 LangChain 和 LlamaIndex 等获取灵感，同时借鉴前沿研究成果与实际应用，提供了一个强调简洁性、可扩展性、可靠性与有效性，且更符合 Go 语言编程惯例的 LLM 应用开发框架。</p>
<p>Github: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcloudwego%2Feino%2Fblob%2Fmain%2FREADME.zh_CN.md" target="_blank" title="https://github.com/cloudwego/eino/blob/main/README.zh_CN.md" ref="nofollow noopener noreferrer">github.com/cloudwego/e…</a></p>
<p><strong>核心概念</strong>：</p>
<ul>
<li><strong>Runnable</strong>: 可执行单元的抽象</li>
<li><strong>Compose</strong>: 组合模式，构建复杂 Workflow</li>
<li><strong>Schema</strong>: 数据流定义</li>
<li><strong>Checkpoint</strong>: 状态持久化，支持中断恢复</li>
</ul>
<p><strong>使用示例</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">import</span> <span class="hljs-string">"github.com/cloudwego/eino/compose"</span>

<span class="hljs-comment">// 创建 Workflow</span>
wf := compose.NewWorkflow[<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any, <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any](
    compose.WithGenLocalState(GenState()),
)

<span class="hljs-comment">// 添加节点</span>
wf.AddLambdaNode(<span class="hljs-string">"llm_node"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, input <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any)</span></span> (<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 调用 LLM</span>
    <span class="hljs-keyword">return</span> llmService.Chat(ctx, input)
})

<span class="hljs-comment">// 编译运行</span>
runner, _ := wf.Compile(ctx, compose.WithCheckPointStore(store))
output, _ := runner.Invoke(ctx, input)
</code></pre>
<h3 data-id="heading-20">4.2 数据存储</h3>






























<table><thead><tr><th>存储</th><th>用途</th><th>示例</th></tr></thead><tbody><tr><td><strong>MySQL</strong></td><td>主数据存储</td><td>Workflow 元数据、用户信息</td></tr><tr><td><strong>Redis</strong></td><td>缓存 + Checkpoint</td><td>执行状态、临时数据</td></tr><tr><td><strong>Elasticsearch</strong></td><td>全文检索</td><td>资源搜索、知识库检索</td></tr><tr><td><strong>OSS</strong></td><td>对象存储</td><td>文件上传、图片、模型文件</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-21">5. 目录结构分析</h2>
<h3 data-id="heading-22">5.1 完整目录树</h3>
<pre><code class="hljs language-csharp" lang="csharp">├── backend/              <span class="hljs-meta"># 后端服务</span>
│   ├── api/              <span class="hljs-meta"># API 处理器和路由</span>
│   │   ├── handler/      <span class="hljs-meta"># 处理器</span>
│   │   ├── <span class="hljs-keyword">internal</span>/     <span class="hljs-meta"># 内部工具</span>
│   │   ├── middleware/   <span class="hljs-meta"># 中间件组件</span>
│   │   ├── model/        <span class="hljs-meta"># API 模型定义</span>
│   │   └── router/       <span class="hljs-meta"># 路由定义</span>
│   ├── application/      <span class="hljs-meta"># 应用层，组合领域对象和基础设施实现</span>
│   │   ├── app/          <span class="hljs-meta"># 应用服务</span>
│   │   ├── conversation/ <span class="hljs-meta"># 会话应用服务</span>
│   │   ├── knowledge/    <span class="hljs-meta"># 知识应用服务</span>
│   │   ├── memory/       <span class="hljs-meta"># 内存应用服务</span>
│   │   ├── modelmgr/     <span class="hljs-meta"># 模型管理应用服务</span>
│   │   ├── plugin/       <span class="hljs-meta"># 插件应用服务</span>
│   │   ├── prompt/       <span class="hljs-meta"># 提示词应用服务</span>
│   │   ├── search/       <span class="hljs-meta"># 搜索应用服务</span>
│   │   ├── singleagent/  <span class="hljs-meta"># 单一代理应用服务</span>
│   │   ├── user/         <span class="hljs-meta"># 用户应用服务</span>
│   │   └── workflow/     <span class="hljs-meta"># 工作流应用服务</span>
│   ├── conf/             <span class="hljs-meta"># 配置文件</span>
│   │   ├── model/        <span class="hljs-meta"># 模型配置</span>
│   │   ├── plugin/       <span class="hljs-meta"># 插件配置</span>
│   │   └── prompt/       <span class="hljs-meta"># 提示词配置</span>
│   ├── crossdomain/      <span class="hljs-meta"># 跨领域防腐层</span>
│   │   ├── contract/     <span class="hljs-meta"># 跨领域接口定义</span>
│   │   ├── impl/         <span class="hljs-meta"># 跨领域接口实现</span>
│   │   └── workflow/     <span class="hljs-meta"># 工作流跨领域实现</span>
│   ├── domain/           <span class="hljs-meta"># 领域层，包含核心业务逻辑</span>
│   │   ├── agent/        <span class="hljs-meta"># 代理领域逻辑</span>
│   │   ├── app/          <span class="hljs-meta"># 应用领域逻辑</span>
│   │   ├── conversation/ <span class="hljs-meta"># 会话领域逻辑</span>
│   │   ├── knowledge/    <span class="hljs-meta"># 知识领域逻辑</span>
│   │   ├── memory/       <span class="hljs-meta"># 内存领域逻辑</span>
│   │   ├── modelmgr/     <span class="hljs-meta"># 模型管理领域逻辑</span>
│   │   ├── plugin/       <span class="hljs-meta"># 插件领域逻辑</span>
│   │   ├── prompt/       <span class="hljs-meta"># 提示词领域逻辑</span>
│   │   ├── search/       <span class="hljs-meta"># 搜索领域逻辑</span>
│   │   ├── user/         <span class="hljs-meta"># 用户领域逻辑</span>
│   │   └── workflow/     <span class="hljs-meta"># 工作流领域逻辑</span>
│   ├── infra/            <span class="hljs-meta"># 基础设施实现层</span>
│   │   ├── contract/     <span class="hljs-meta"># 基础设施接口定义</span>
│   │   └── impl/         <span class="hljs-meta"># 基础设施接口实现</span>
│   ├── pkg/              <span class="hljs-meta"># 无外部依赖的工具方法</span>
│   │   ├── ctxcache/     <span class="hljs-meta"># 上下文缓存工具</span>
│   │   ├── errorx/       <span class="hljs-meta"># 错误处理工具</span>
│   │   ├── goutil/       <span class="hljs-meta"># Go 语言工具</span>
│   │   ├── logs/         <span class="hljs-meta"># 日志工具</span>
│   │   └── safego/       <span class="hljs-meta"># 安全 Go 工具</span>
│   └── types/            <span class="hljs-meta"># 类型定义</span>
│       ├── consts/       <span class="hljs-meta"># 常量定义</span>
│       ├── ddl/          <span class="hljs-meta"># 数据定义语言</span>
│       └── errno/        <span class="hljs-meta"># 错误码定义</span>
├── frontend/             <span class="hljs-meta"># 前端应用</span>
...
├── idl/                  <span class="hljs-meta"># 接口定义语言文件</span>
</code></pre>
<h3 data-id="heading-23">5.2 目录职责矩阵</h3>








































<table><thead><tr><th>目录</th><th>职责</th><th>依赖方向</th></tr></thead><tbody><tr><td><code>api</code></td><td>HTTP 请求处理</td><td>→ application</td></tr><tr><td><code>application</code></td><td>业务流程编排</td><td>→ domain</td></tr><tr><td><code>domain</code></td><td>核心业务逻辑</td><td>→ crossdomain</td></tr><tr><td><code>crossdomain</code></td><td>跨域服务抽象</td><td>→ domain (interface)</td></tr><tr><td><code>infra</code></td><td>技术实现细节</td><td>← domain (实现接口)</td></tr><tr><td><code>pkg</code></td><td>通用工具</td><td>被所有层使用</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-24">6. 核心模块详解</h2>
<h4 data-id="heading-25">6.1.1 Workflow 架构</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "Workflow Domain"
        A[Service Interface]
        B[Service Implementation]
        C[Entity/VO]
        
        subgraph "Internal 内部实现"
            D[Schema - 数据流定义]
            E[Compose - 编排引擎]
            F[Nodes - 节点实现]
            G[Execute - 执行引擎]
            H[Repository - 仓储]
        end
    end
    
    A --&gt; B
    B --&gt; D
    B --&gt; E
    B --&gt; H
    D --&gt; E
    E --&gt; F
    E --&gt; G
    F --&gt; G
    
    style D fill:#e1f5ff
    style E fill:#fff4e1
    style F fill:#e8f5e9
    style G fill:#f3e5f5
</code></pre>
<h4 data-id="heading-26">6.1.2 核心组件</h4>
<h5 data-id="heading-27">Schema（数据流定义）</h5>
<p><strong>职责</strong>：定义 Workflow 的结构和数据流</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// backend/domain/workflow/internal/schema/workflow_schema.go WorkflowSchema 定义 Workflow 的完整结构</span>
<span class="hljs-keyword">type</span> WorkflowSchema <span class="hljs-keyword">struct</span> {
    Nodes       []*NodeSchema                <span class="hljs-string">`json:"nodes"`</span>
    Connections []*Connection                <span class="hljs-string">`json:"connections"`</span>
    Hierarchy   <span class="hljs-keyword">map</span>[vo.NodeKey]vo.NodeKey    <span class="hljs-string">`json:"hierarchy,omitempty"`</span> <span class="hljs-comment">// child node key-&gt; parent node key</span>
    Branches    <span class="hljs-keyword">map</span>[vo.NodeKey]*BranchSchema <span class="hljs-string">`json:"branches,omitempty"`</span>
    
    GeneratedNodes []vo.NodeKey <span class="hljs-string">`json:"generated_nodes,omitempty"`</span> <span class="hljs-comment">// generated nodes for the nodes in batch mode</span>
    
    nodeMap           <span class="hljs-keyword">map</span>[vo.NodeKey]*NodeSchema <span class="hljs-comment">// won't serialize this</span>
    compositeNodes    []*CompositeNode           <span class="hljs-comment">// won't serialize this</span>
    requireCheckPoint <span class="hljs-type">bool</span>                       <span class="hljs-comment">// won't serialize this</span>
    requireStreaming  <span class="hljs-type">bool</span>
    historyRounds     <span class="hljs-type">int64</span>
}

<span class="hljs-comment">// Connection 定义节点之间的连接关系</span>
<span class="hljs-keyword">type</span> Connection <span class="hljs-keyword">struct</span> {
    FromNode vo.NodeKey <span class="hljs-string">`json:"from_node"`</span>
    ToNode   vo.NodeKey <span class="hljs-string">`json:"to_node"`</span>
    FromPort *<span class="hljs-type">string</span>    <span class="hljs-string">`json:"from_port,omitempty"`</span>
}
</code></pre>
<h5 data-id="heading-28">Compose（编排引擎）</h5>
<p><strong>职责</strong>：将 Schema 编译成可执行的 Workflow</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">//backend/domain/workflow/internal/compose/workflow.go NewWorkflow 创建 Workflow 实例</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewWorkflow</span><span class="hljs-params">(ctx context.Context, sc *schema.WorkflowSchema, opts ...WorkflowOption)</span></span> (*Workflow, <span class="hljs-type">error</span>) {
    sc.Init() <span class="hljs-comment">// 初始化 Schema，构建 nodeMap 等内部结构</span>
    
    wf := &amp;Workflow{
        workflow:    compose.NewWorkflow[<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any, <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any](
            compose.WithGenLocalState(GenState()),
        ),
        hierarchy:   sc.Hierarchy,
        connections: sc.Connections,
        schema:      sc,
    }
    
    wf.streamRun = sc.RequireStreaming()
    wf.requireCheckpoint = sc.RequireCheckpoint()
    
    <span class="hljs-comment">// 处理选项</span>
    wfOpts := &amp;workflowOptions{}
    <span class="hljs-keyword">for</span> _, opt := <span class="hljs-keyword">range</span> opts {
        opt(wfOpts)
    }
    
    <span class="hljs-comment">// 添加所有复合节点（包含子工作流的节点）</span>
    compositeNodes := sc.GetCompositeNodes()
    <span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> compositeNodes {
        cNode := compositeNodes[i]
        <span class="hljs-keyword">if</span> err := wf.AddCompositeNode(ctx, cNode); err != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
        }
    }
    
    <span class="hljs-comment">// 添加所有普通节点</span>
    <span class="hljs-keyword">for</span> _, ns := <span class="hljs-keyword">range</span> sc.Nodes {
        <span class="hljs-keyword">if</span> err := wf.AddNode(ctx, ns); err != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
        }
    }
    
    <span class="hljs-comment">// 编译成可执行的 Runner</span>
    runner, err := wf.Compile(ctx, wfOpts.compileOpts...)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }
    wf.Runner = runner
    
    <span class="hljs-keyword">return</span> wf, <span class="hljs-literal">nil</span>
}
</code></pre>
<h5 data-id="heading-29">Nodes（节点实现）</h5>
<p><strong>支持的节点类型</strong>：</p>




























































<table><thead><tr><th>节点类型</th><th>功能</th><th>实现路径</th></tr></thead><tbody><tr><td><strong>Entry</strong></td><td>工作流入口</td><td><code>nodes/entry</code></td></tr><tr><td><strong>Exit</strong></td><td>工作流出口</td><td><code>nodes/exit</code></td></tr><tr><td><strong>LLM</strong></td><td>大模型调用</td><td><code>nodes/llm</code></td></tr><tr><td><strong>Plugin</strong></td><td>插件调用</td><td><code>nodes/plugin</code></td></tr><tr><td><strong>Code</strong></td><td>代码执行</td><td><code>nodes/code</code></td></tr><tr><td><strong>Knowledge</strong></td><td>知识库检索</td><td><code>nodes/knowledge</code></td></tr><tr><td><strong>Database</strong></td><td>数据库操作</td><td><code>nodes/database</code></td></tr><tr><td><strong>Selector</strong></td><td>条件分支</td><td><code>nodes/selector</code></td></tr><tr><td><strong>Loop</strong></td><td>循环迭代</td><td><code>nodes/loop</code></td></tr><tr><td><strong>HTTPRequester</strong></td><td>HTTP 请求</td><td><code>nodes/httprequester</code></td></tr></tbody></table>
<p><strong>节点构建机制</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">//backend/domain/workflow/internal/compose/node_builder.go New 从 NodeSchema 实例化实际的节点类型</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">New</span><span class="hljs-params">(ctx context.Context, s *schema.NodeSchema,
    inner compose.Runnable[<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any, <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any], // 复合节点的内部工作流
    sc *schema.WorkflowSchema, // 节点所在的工作流 Schema
    deps *dependencyInfo, // 节点的依赖信息
    requireCheckpoint <span class="hljs-type">bool</span>,
)</span></span> (_ *Node, err <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 如果 NodeSchema 的 Configs 实现了 NodeBuilder 接口，使用它来构建节点</span>
    nb, ok := s.Configs.(schema.NodeBuilder)
    <span class="hljs-keyword">if</span> ok {
        opts := []schema.BuildOption{
            schema.WithWorkflowSchema(sc),
            schema.WithInnerWorkflow(inner),
        }
        
        <span class="hljs-comment">// 构建实际的 InvokableNode 等</span>
        n, err := nb.Build(ctx, s, opts...)
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
        }
        
        <span class="hljs-comment">// 将 InvokableNode 包装成 NodeRunner，转换为 eino 的 Lambda</span>
        <span class="hljs-keyword">return</span> toNode(s, n), <span class="hljs-literal">nil</span>
    }
    
    <span class="hljs-comment">// 处理特殊节点类型</span>
    <span class="hljs-keyword">switch</span> s.Type {
    <span class="hljs-keyword">case</span> entity.NodeTypeLambda:
        <span class="hljs-keyword">return</span> &amp;Node{Lambda: s.Lambda}, <span class="hljs-literal">nil</span>
    <span class="hljs-keyword">case</span> entity.NodeTypeSubWorkflow:
        subWorkflow, err := buildSubWorkflow(ctx, s, requireCheckpoint)
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
        }
        <span class="hljs-keyword">return</span> toNode(s, subWorkflow), <span class="hljs-literal">nil</span>
    <span class="hljs-keyword">default</span>:
        <span class="hljs-built_in">panic</span>(fmt.Sprintf(<span class="hljs-string">"node schema's Configs does not implement NodeBuilder. type: %v"</span>, s.Type))
    }
}
</code></pre>
<p><strong>说明</strong>：LLM 节点通过实现 <code>NodeBuilder</code> 接口来构建，具体实现在 <code>backend/domain/workflow/internal/nodes/llm/llm.go</code> 中。</p>
<h5 data-id="heading-30">Execute（执行引擎）</h5>
<p><strong>核心功能</strong>：</p>
<ul>
<li>🔸 执行上下文管理</li>
<li>🔸 事件发送（开始、结束、错误）</li>
<li>🔸 流式输出支持</li>
<li>🔸 中断和恢复</li>
</ul>
<p><strong>事件类型</strong>（真实代码来自 <code>backend/domain/workflow/internal/execute/event.go</code>）：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> EventType <span class="hljs-type">string</span>

<span class="hljs-keyword">const</span> (
    <span class="hljs-comment">// 工作流级别事件</span>
    WorkflowStart         EventType = <span class="hljs-string">"workflow_start"</span>
    WorkflowSuccess       EventType = <span class="hljs-string">"workflow_success"</span>
    WorkflowFailed        EventType = <span class="hljs-string">"workflow_failed"</span>
    WorkflowCancel        EventType = <span class="hljs-string">"workflow_cancel"</span>
    WorkflowInterrupt     EventType = <span class="hljs-string">"workflow_interrupt"</span>
    WorkflowResume        EventType = <span class="hljs-string">"workflow_resume"</span>
    
    <span class="hljs-comment">// 节点级别事件</span>
    NodeStart             EventType = <span class="hljs-string">"node_start"</span>
    NodeEnd               EventType = <span class="hljs-string">"node_end"</span>
    NodeEndStreaming      EventType = <span class="hljs-string">"node_end_streaming"</span> <span class="hljs-comment">// 绝对结束，所有流式内容发送完毕</span>
    NodeError             EventType = <span class="hljs-string">"node_error"</span>
    NodeStreamingInput    EventType = <span class="hljs-string">"node_streaming_input"</span>
    NodeStreamingOutput   EventType = <span class="hljs-string">"node_streaming_output"</span>
    
    <span class="hljs-comment">// 工具调用事件</span>
    FunctionCall          EventType = <span class="hljs-string">"function_call"</span>
    ToolResponse          EventType = <span class="hljs-string">"tool_response"</span>
    ToolStreamingResponse EventType = <span class="hljs-string">"tool_streaming_response"</span>
    ToolError             EventType = <span class="hljs-string">"tool_error"</span>
)
</code></pre>
<h4 data-id="heading-31">6.1.3 Workflow 生命周期</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Client
    participant Handler
    participant AppService
    participant DomainService
    participant Compose
    participant Eino
    participant Node
    
    Client-&gt;&gt;Handler: POST /api/workflow/execute
    Handler-&gt;&gt;AppService: Execute(config, input)
    AppService-&gt;&gt;DomainService: SyncExecute(config, input)
    
    DomainService-&gt;&gt;DomainService: Get Workflow Entity
    DomainService-&gt;&gt;DomainService: Parse Canvas to Schema
    DomainService-&gt;&gt;Compose: NewWorkflow(schema)
    
    Compose-&gt;&gt;Compose: AddNodes
    Compose-&gt;&gt;Compose: Compile
    Compose--&gt;&gt;DomainService: Return Runner
    
    DomainService-&gt;&gt;Eino: Runner.Invoke(ctx, input)
    
    loop For each node
        Eino-&gt;&gt;Node: Execute(input)
        Node--&gt;&gt;Eino: output
        Eino-&gt;&gt;Eino: Emit Event
    end
    
    Eino--&gt;&gt;DomainService: Final Output
    DomainService--&gt;&gt;AppService: WorkflowExecution
    AppService--&gt;&gt;Handler: Result
    Handler--&gt;&gt;Client: HTTP Response
</code></pre>
<h3 data-id="heading-32">6.2 Plugin 模块</h3>
<h4 data-id="heading-33">6.2.1 Plugin 架构</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "Plugin Domain"
        A[Plugin Service]
        B[Plugin Entity]
        C[Plugin Repository]
        
        subgraph "Plugin Types"
            D1[HTTP Plugin]
            D2[Code Plugin]
            D3[System Plugin]
        end
        
        A --&gt; B
        A --&gt; C
        A --&gt; D1
        A --&gt; D2
        A --&gt; D3
    end
    
    subgraph "Workflow Integration"
        E[Plugin Node]
        F[Tool Wrapper]
    end
    
    A --&gt; E
    E --&gt; F
    
    style A fill:#e1f5ff
    style E fill:#fff4e1
</code></pre>
<h4 data-id="heading-34">6.2.2 Plugin 调用流程</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">//backend/domain/workflow/internal/nodes/plugin/exec.go Plugin 节点执行（简化版，展示核心逻辑）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(n *PluginNode)</span></span> execute(ctx context.Context, input <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any) (<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 1. 准备执行请求</span>
    req := &amp;model.ExecuteToolRequest{
        PluginID:  pe.PluginID,
        ToolID:    pe.ToolID,
        Input:     input,
        <span class="hljs-comment">// ... 其他配置</span>
    }
    
    execOpts := []model.ExecuteToolOpt{
        model.WithInvalidRespProcessStrategy(consts.InvalidResponseProcessStrategyOfReturnDefault),
    }
    
    <span class="hljs-keyword">if</span> pe.PluginVersion != <span class="hljs-literal">nil</span> {
        execOpts = <span class="hljs-built_in">append</span>(execOpts, model.WithToolVersion(*pe.PluginVersion))
    }
    
    <span class="hljs-comment">// 2. 通过跨域服务调用 Plugin（注意：使用 DefaultSVC() 而不是 GetDefaultSVC()）</span>
    r, err := crossplugin.DefaultSVC().ExecuteTool(ctx, req, execOpts...)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-comment">// 处理中断事件（如需要 OAuth 授权）</span>
        <span class="hljs-keyword">if</span> extra, ok := compose.IsInterruptRerunError(err); ok {
            pluginTIE, ok := extra.(*model.ToolInterruptEvent)
            <span class="hljs-keyword">if</span> ok {
                <span class="hljs-comment">// 创建工作流中断事件</span>
                <span class="hljs-comment">// ...</span>
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }
    
    <span class="hljs-comment">// 3. 返回执行结果</span>
    <span class="hljs-keyword">return</span> r.Output, <span class="hljs-literal">nil</span>
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li>使用 <code>crossplugin.DefaultSVC()</code> 而不是 <code>crossplugin.GetDefaultSVC()</code></li>
<li>支持工具版本控制</li>
<li>支持中断和恢复机制（如 OAuth 授权）</li>
</ul>
<h3 data-id="heading-35">6.3 Knowledge 模块</h3>
<h4 data-id="heading-36">6.3.1 RAG 流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant LLMNode
    participant KnowledgeSVC
    participant Embedding
    participant VectorDB
    participant Reranker
    
    LLMNode-&gt;&gt;KnowledgeSVC: Query(question)
    KnowledgeSVC-&gt;&gt;Embedding: Embed(question)
    Embedding--&gt;&gt;KnowledgeSVC: vector
    
    KnowledgeSVC-&gt;&gt;VectorDB: Search(vector, topK)
    VectorDB--&gt;&gt;KnowledgeSVC: candidates
    
    KnowledgeSVC-&gt;&gt;Reranker: Rerank(candidates, question)
    Reranker--&gt;&gt;KnowledgeSVC: top results
    
    KnowledgeSVC--&gt;&gt;LLMNode: context + references
    LLMNode-&gt;&gt;LLMNode: Build Prompt with context
</code></pre>
<hr/>
<h2 data-id="heading-37">7. 数据流分析：简单工作流示例</h2>
<h3 data-id="heading-38">7.1 场景描述</h3>
<p>我们分析一个<strong>最简单的 Workflow</strong>：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[开始]</span> → <span class="hljs-selector-attr">[大模型]</span> → <span class="hljs-selector-attr">[结束]</span>
</code></pre>
<p><strong>说明</strong>：本节以 <strong>OpenAPI 方式</strong>执行 Workflow 为例进行分析。Coze Studio 提供两套 API：</p>























<table><thead><tr><th>API 类型</th><th>路径前缀</th><th>用途</th><th>认证方式</th></tr></thead><tbody><tr><td><strong>OpenAPI</strong></td><td><code>/v1/</code></td><td>对外开放的 API，供第三方调用</td><td>API Key（Personal Access Token）</td></tr><tr><td><strong>内部 API</strong></td><td><code>/api/</code></td><td>Web 前端使用的内部 API</td><td>Session 认证</td></tr></tbody></table>
<p>本节重点分析 OpenAPI 的执行流程，因为它更完整地展示了认证、权限校验、版本控制等机制。</p>
<p><strong>Canvas JSON 结构</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"nodes"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"entry"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"entry"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"outputs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"user_input"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"llm_1"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"llm"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"config"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"gpt-4"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"prompt"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{{user_input}}"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"exit"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"exit"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"inputs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"output"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"connections"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"from"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"entry.user_input"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"to"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"llm_1.input"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"from"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"llm_1.output"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"to"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"exit.output"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-39">7.2 完整数据流图</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "1. HTTP 请求入口（`backend/api/handler/coze/workflow_service.go`）"
        A1["POST /v1/workflow/run&lt;br/&gt;workflow_id:123&lt;br/&gt;input:user_input=Hello&lt;br/&gt;外部调用入口"]
    end
    
    subgraph "2. API 层（Hertz Handler）"
        B1["WorkflowExecuteHandler&lt;br/&gt;OpenAPI入口处理器"]
        B2["Parse Request Body&lt;br/&gt;解析请求体"]
        B3["Validate Parameters&lt;br/&gt;参数校验"]
    end
    
    subgraph "3. 应用层（`application/workflow`）"
        C1["WorkflowApp.Execute/OpenAPIRun&lt;br/&gt;应用服务编排"]
        C2["Build ExecuteConfig&lt;br/&gt;构建执行配置"]
        C3["Call Domain Service&lt;br/&gt;调用领域服务"]
    end
    
    subgraph "4. 领域层预处理（`domain/workflow`）"
        D1["WorkflowService.SyncExecute&lt;br/&gt;领域服务执行入口"]
        D2["Get Workflow Entity&lt;br/&gt;查询workflow_meta + version"]
        D3["Parse Canvas JSON&lt;br/&gt;转换为 WorkflowSchema"]
        D4["WorkflowSchema&lt;br/&gt;节点: entry/llm/exit&lt;br/&gt;连接关系/类型定义"]
    end
    
    subgraph "5. Compose 构建阶段（`domain/workflow/internal/compose`）"
        E1["compose.NewWorkflow&lt;br/&gt;初始化可执行图"]
        E2["AddNode: Entry&lt;br/&gt;输出 user_input"]
        E3["AddNode: LLM&lt;br/&gt;模型+Prompt配置"]
        E4["AddNode: Exit&lt;br/&gt;输入 output"]
        E5["Compile to Runner&lt;br/&gt;编译为 Eino Runner"]
    end
    
    subgraph "6. Execute 运行阶段"
        F1["Runner.Invoke&lt;br/&gt;输入user_input=Hello"]
        F2["Entry Node Execute&lt;br/&gt;发射 user_input"]
        F3["LLM Node Execute&lt;br/&gt;构建Prompt→调用LLM→拿到回复"]
        F4["Exit Node Execute&lt;br/&gt;收集最终输出"]
        F5["Return Final Output&lt;br/&gt;形成完整响应体"]
    end
    
    subgraph "7. 事件发射（`domain/workflow/internal/execute`）"
        G1["WorkflowStart Event&lt;br/&gt;工作流开始"]
        G2["NodeStart: entry"]
        G3["NodeSuccess: entry"]
        G4["NodeStart: llm_1"]
        G5["NodeSuccess: llm_1&lt;br/&gt;附带 token 使用"]
        G6["NodeStart: exit"]
        G7["NodeSuccess: exit"]
        G8["WorkflowSuccess Event&lt;br/&gt;总耗时 / 总 token"]
    end
    
    subgraph "8. HTTP 响应输出"
        H1["Build WorkflowExecution Entity&lt;br/&gt;构建执行记录 + token info"]
        H2["Return HTTP Response&lt;br/&gt;返回 code/data"]
    end
    
    A1 --&gt; B1
    B1 --&gt; B2
    B2 --&gt; B3
    B3 --&gt; C1
    
    C1 --&gt; C2
    C2 --&gt; C3
    C3 --&gt; D1
    
    D1 --&gt; D2
    D2 --&gt; D3
    D3 --&gt; D4
    D4 --&gt; E1
    
    E1 --&gt; E2
    E2 --&gt; E3
    E3 --&gt; E4
    E4 --&gt; E5
    E5 --&gt; F1
    
    F1 --&gt; F2
    F2 --&gt; F3
    F3 --&gt; F4
    F4 --&gt; F5
    
    F1 -.-&gt;|emit| G1
    F2 -.-&gt;|emit| G2
    F2 -.-&gt;|emit| G3
    F3 -.-&gt;|emit| G4
    F3 -.-&gt;|emit| G5
    F4 -.-&gt;|emit| G6
    F4 -.-&gt;|emit| G7
    F5 -.-&gt;|emit| G8
    
    F5 --&gt; H1
    H1 --&gt; H2
    
    style D4 fill:#e1f5ff
    style E5 fill:#fff4e1
    style F3 fill:#ffe0e0
    style G8 fill:#e8f5e9

</code></pre>
<h3 data-id="heading-40">7.3 详细执行步骤</h3>
<h4 data-id="heading-41">Step 1: HTTP 请求到达</h4>
<pre><code class="hljs language-http" lang="http">POST /v1/workflow/run HTTP/1.1
Content-Type: application/json
Authorization: Bearer &lt;API_KEY&gt;

{
  "workflow_id": "123",
  "parameters": "{\"user_input\": \"Hello, AI!\"}"
}
</code></pre>
<p><strong>说明</strong>：</p>
<ul>
<li>OpenAPI 使用 <code>/v1/workflow/run</code> 路径</li>
<li>需要 API Key 认证</li>
<li><code>parameters</code> 是 JSON 字符串格式</li>
</ul>
<h4 data-id="heading-42">Step 2: API Handler 处理</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// backend/api/handler/coze/workflow_service.go</span>
<span class="hljs-comment">// OpenAPIRunFlow .</span>
<span class="hljs-comment">// @router /v1/workflow/run [POST]</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">OpenAPIRunFlow</span><span class="hljs-params">(ctx context.Context, c *app.RequestContext)</span></span> {
    <span class="hljs-keyword">var</span> err <span class="hljs-type">error</span>

    <span class="hljs-comment">// 预处理请求体</span>
    <span class="hljs-keyword">if</span> err = preprocessWorkflowRequestBody(ctx, c); err != <span class="hljs-literal">nil</span> {
        invalidParamRequestResponse(c, err.Error())
        <span class="hljs-keyword">return</span>
    }

    <span class="hljs-comment">// 绑定和验证参数</span>
    <span class="hljs-keyword">var</span> req workflow.OpenAPIRunFlowRequest
    err = c.BindAndValidate(&amp;req)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        invalidParamRequestResponse(c, err.Error())
        <span class="hljs-keyword">return</span>
    }
    
    <span class="hljs-comment">// 调用 Application Service</span>
    resp, err := appworkflow.SVC.OpenAPIRun(ctx, &amp;req)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-comment">// 处理 Workflow 特定错误</span>
        <span class="hljs-keyword">var</span> se vo.WorkflowError
        <span class="hljs-keyword">if</span> errors.As(err, &amp;se) {
            resp = <span class="hljs-built_in">new</span>(workflow.OpenAPIRunFlowResponse)
            resp.Code = <span class="hljs-type">int64</span>(se.OpenAPICode())
            resp.Msg = ptr.Of(se.Msg())
            debugURL := se.DebugURL()
            <span class="hljs-keyword">if</span> debugURL != <span class="hljs-string">""</span> {
                resp.DebugUrl = ptr.Of(debugURL)
            }
            c.JSON(consts.StatusOK, resp)
            <span class="hljs-keyword">return</span>
        }

        internalServerErrorResponse(ctx, c, err)
        <span class="hljs-keyword">return</span>
    }

    c.JSON(consts.StatusOK, resp)
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li>使用 <code>OpenAPIRunFlowRequest</code></li>
<li>包含完整的错误处理逻辑</li>
<li>支持返回 debug URL</li>
</ul>
<h4 data-id="heading-43">Step 3: Application Service 编排</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// backend/application/workflow/workflow.go</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *ApplicationService)</span></span> OpenAPIRun(ctx context.Context, req *workflow.OpenAPIRunFlowRequest) (
    _ *workflow.OpenAPIRunFlowResponse, err <span class="hljs-type">error</span>,
) {
    <span class="hljs-comment">// 1. 获取 API 认证信息</span>
    apiKeyInfo := ctxutil.GetApiAuthFromCtx(ctx)
    userID := apiKeyInfo.UserID

    <span class="hljs-comment">// 2. 解析参数</span>
    parameters := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any)
    <span class="hljs-keyword">if</span> req.Parameters != <span class="hljs-literal">nil</span> {
        err := sonic.UnmarshalString(*req.Parameters, &amp;parameters)
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, vo.WrapError(errno.ErrInvalidParameter, err)
        }
    }

    <span class="hljs-comment">// 3. 获取 Workflow 元数据</span>
    meta, err := GetWorkflowDomainSVC().Get(ctx, &amp;vo.GetPolicy{
        ID:       mustParseInt64(req.GetWorkflowID()),
        MetaOnly: <span class="hljs-literal">true</span>,
    })
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }

    <span class="hljs-comment">// 4. 检查是否已发布</span>
    <span class="hljs-keyword">if</span> meta.LatestPublishedVersion == <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, vo.NewError(errno.ErrWorkflowNotPublished)
    }

    <span class="hljs-comment">// 5. 权限检查</span>
    <span class="hljs-keyword">if</span> err = checkUserSpace(ctx, userID, meta.SpaceID); err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }

    <span class="hljs-comment">// 6. 构建执行配置</span>
    exeCfg := workflowModel.ExecuteConfig{
        ID:            meta.ID,
        From:          workflowModel.FromSpecificVersion,
        Version:       *meta.LatestPublishedVersion,
        Operator:      userID,
        Mode:          workflowModel.ExecuteModeRelease,
        ConnectorID:   apiKeyInfo.ConnectorID,
        ConnectorUID:  strconv.FormatInt(userID, <span class="hljs-number">10</span>),
        InputFailFast: <span class="hljs-literal">true</span>,
        BizType:       workflowModel.BizTypeWorkflow,
    }

    <span class="hljs-comment">// 7. 判断同步/异步执行</span>
    <span class="hljs-keyword">if</span> req.GetIsAsync() {
        <span class="hljs-comment">// 异步执行</span>
        exeCfg.SyncPattern = workflowModel.SyncPatternAsync
        exeCfg.TaskType = workflowModel.TaskTypeBackground
        exeID, err := GetWorkflowDomainSVC().AsyncExecute(ctx, exeCfg, parameters)
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
        }
        <span class="hljs-keyword">return</span> &amp;workflow.OpenAPIRunFlowResponse{
            ExecuteID: ptr.Of(strconv.FormatInt(exeID, <span class="hljs-number">10</span>)),
            DebugUrl:  ptr.Of(debugutil.GetWorkflowDebugURL(ctx, meta.ID, meta.SpaceID, exeID)),
        }, <span class="hljs-literal">nil</span>
    }
    
    <span class="hljs-comment">// 8. 同步执行</span>
    exeCfg.SyncPattern = workflowModel.SyncPatternSync
    exeCfg.TaskType = workflowModel.TaskTypeForeground
    wfExe, tPlan, err := GetWorkflowDomainSVC().SyncExecute(ctx, exeCfg, parameters)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }

    <span class="hljs-comment">// 9. 构建返回结果</span>
    <span class="hljs-keyword">return</span> buildOpenAPIRunResponse(ctx, wfExe, tPlan, meta)
}
</code></pre>
<p><strong>关键流程</strong>：</p>
<ol>
<li>✅ API 认证和用户识别</li>
<li>✅ 参数解析（JSON 字符串 → map）</li>
<li>✅ Workflow 元数据获取</li>
<li>✅ 发布状态检查</li>
<li>✅ 权限校验</li>
<li>✅ 执行配置构建</li>
<li>✅ 支持同步/异步模式</li>
<li>✅ 调用 Domain Service 执行</li>
</ol>
<h4 data-id="heading-44">Step 4: Domain Service 执行</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// backend/domain/workflow/service/executable_impl.go</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(i *impl)</span></span> SyncExecute(ctx context.Context, config workflowModel.ExecuteConfig, input <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any) (*entity.WorkflowExecution, vo.TerminatePlan, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 1. 获取 Workflow 实体</span>
    wfEntity, _ := i.Get(ctx, &amp;vo.GetPolicy{
        ID:    config.ID,
        QType: config.From,
    })
    
    <span class="hljs-comment">// 2. 解析 Canvas 为 Schema</span>
    canvas := &amp;vo.Canvas{}
    sonic.UnmarshalString(wfEntity.Canvas, canvas)
    workflowSC, _ := adaptor.CanvasToWorkflowSchema(ctx, canvas)
    
    <span class="hljs-comment">// 3. 创建 Workflow</span>
    wf, _ := compose.NewWorkflow(ctx, workflowSC, 
        compose.WithIDAsName(wfEntity.ID))
    
    <span class="hljs-comment">// 4. 准备执行上下文</span>
    cancelCtx, executeID, opts, lastEventChan, _ := compose.NewWorkflowRunner(
        wfEntity.GetBasic(), 
        workflowSC, 
        config,
        compose.WithInput(inputStr),
    ).Prepare(ctx)
    
    <span class="hljs-comment">// 5. 同步执行</span>
    startTime := time.Now()
    out, err := wf.SyncRun(cancelCtx, input, opts...)
    
    <span class="hljs-comment">// 6. 等待最后一个事件</span>
    lastEvent := &lt;-lastEventChan
    
    <span class="hljs-comment">// 7. 构建返回结果</span>
    <span class="hljs-keyword">return</span> &amp;entity.WorkflowExecution{
        ID:         executeID,
        WorkflowID: wfEntity.ID,
        Status:     entity.WorkflowSuccess,
        Output:     ptr.Of(outputStr),
        TokenInfo:  &amp;entity.TokenUsage{
            InputTokens:  lastEvent.GetInputTokens(),
            OutputTokens: lastEvent.GetOutputTokens(),
        },
        Duration:   lastEvent.Duration,
    }, wf.TerminatePlan(), <span class="hljs-literal">nil</span>
}
</code></pre>
<h4 data-id="heading-45">Step 5: Compose Layer 构建</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// backend/domain/workflow/internal/compose/workflow.go (83-158行)</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewWorkflow</span><span class="hljs-params">(ctx context.Context, sc *schema.WorkflowSchema, opts ...WorkflowOption)</span></span> (*Workflow, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 1. 初始化 WorkflowSchema</span>
    sc.Init()
    
    <span class="hljs-comment">// 2. 创建 Workflow 实例</span>
    wf := &amp;Workflow{
        workflow:    compose.NewWorkflow[<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any, <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any](
            compose.WithGenLocalState(GenState()),  <span class="hljs-comment">// 状态生成器</span>
        ),
        hierarchy:   sc.Hierarchy,
        connections: sc.Connections,
        schema:      sc,
    }
    
    <span class="hljs-comment">// 3. 设置执行模式</span>
    wf.streamRun = sc.RequireStreaming()        <span class="hljs-comment">// 是否需要流式输出</span>
    wf.requireCheckpoint = sc.RequireCheckpoint() <span class="hljs-comment">// 是否需要 Checkpoint</span>
    
    <span class="hljs-comment">// 4. 处理选项参数</span>
    wfOpts := &amp;workflowOptions{}
    <span class="hljs-keyword">for</span> _, opt := <span class="hljs-keyword">range</span> opts {
        opt(wfOpts)
    }
    
    <span class="hljs-comment">// 5. 检查节点数量限制</span>
    <span class="hljs-keyword">if</span> wfOpts.maxNodeCount &gt; <span class="hljs-number">0</span> {
        <span class="hljs-keyword">if</span> sc.NodeCount() &gt; <span class="hljs-type">int32</span>(wfOpts.maxNodeCount) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"node count %d exceeds the limit: %d"</span>, 
                sc.NodeCount(), wfOpts.maxNodeCount)
        }
    }
    
    <span class="hljs-keyword">if</span> wfOpts.parentRequireCheckpoint {
        wf.requireCheckpoint = <span class="hljs-literal">true</span>
    }
    
    <span class="hljs-comment">// 6. 设置 input/output 类型定义</span>
    wf.input = sc.GetNode(entity.EntryNodeKey).OutputTypes
    wf.output = sc.GetNode(entity.ExitNodeKey).InputTypes
    
    <span class="hljs-comment">// 7. 【第一轮】添加复合节点（CompositeNodes）</span>
    <span class="hljs-comment">//    复合节点包含内部子工作流，需要先构建</span>
    compositeNodes := sc.GetCompositeNodes()
    processedNodeKey := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[vo.NodeKey]<span class="hljs-keyword">struct</span>{})
    
    <span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> compositeNodes {
        cNode := compositeNodes[i]
        <span class="hljs-keyword">if</span> err := wf.AddCompositeNode(ctx, cNode); err != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
        }
        
        <span class="hljs-comment">// 标记已处理的节点（父节点和子节点）</span>
        processedNodeKey[cNode.Parent.Key] = <span class="hljs-keyword">struct</span>{}{}
        <span class="hljs-keyword">for</span> _, child := <span class="hljs-keyword">range</span> cNode.Children {
            processedNodeKey[child.Key] = <span class="hljs-keyword">struct</span>{}{}
        }
    }
    
    <span class="hljs-comment">// 8. 【第二轮】添加普通节点（Entry, LLM, Exit 等）</span>
    <span class="hljs-comment">//    跳过已经作为复合节点处理的节点</span>
    <span class="hljs-keyword">for</span> _, ns := <span class="hljs-keyword">range</span> sc.Nodes {
        <span class="hljs-keyword">if</span> _, ok := processedNodeKey[ns.Key]; !ok {
            <span class="hljs-keyword">if</span> err := wf.AddNode(ctx, ns); err != <span class="hljs-literal">nil</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
            }
        }
        
        <span class="hljs-comment">// 保存 Exit 节点的终止计划</span>
        <span class="hljs-keyword">if</span> ns.Type == entity.NodeTypeExit {
            wf.terminatePlan = ns.Configs.(*exit.Config).TerminatePlan
        }
    }
    
    <span class="hljs-comment">// 9. 编译成可执行的 Runner</span>
    <span class="hljs-keyword">var</span> compileOpts []compose.GraphCompileOption
    <span class="hljs-keyword">if</span> wf.requireCheckpoint {
        compileOpts = <span class="hljs-built_in">append</span>(compileOpts, 
            compose.WithCheckPointStore(workflow2.GetRepository()))
    }
    <span class="hljs-keyword">if</span> wfOpts.idAsName {
        compileOpts = <span class="hljs-built_in">append</span>(compileOpts, 
            compose.WithGraphName(strconv.FormatInt(wfOpts.wfID, <span class="hljs-number">10</span>)))
    }
    
    r, err := wf.Compile(ctx, compileOpts...)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }
    wf.Runner = r
    
    <span class="hljs-keyword">return</span> wf, <span class="hljs-literal">nil</span>
}
</code></pre>
<p><strong>节点添加流程（AddNode）</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// backend/domain/workflow/internal/compose/workflow.go (216-280行)</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *Workflow)</span></span> addNodeInternal(ctx context.Context, ns *schema.NodeSchema, 
    inner *innerWorkflowInfo) (<span class="hljs-keyword">map</span>[vo.NodeKey][]*compose.FieldMapping, <span class="hljs-type">error</span>) {
    
    key := ns.Key
    
    <span class="hljs-comment">// 1. 解析节点依赖关系</span>
    deps, err := w.resolveDependencies(key, ns.InputSources)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }
    
    <span class="hljs-comment">// 2. 如果是复合节点，合并内部工作流的依赖</span>
    <span class="hljs-keyword">if</span> inner != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">if</span> err = deps.merge(inner.carryOvers); err != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
        }
    }
    
    <span class="hljs-keyword">var</span> innerWorkflow compose.Runnable[<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any, <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any]
    <span class="hljs-keyword">if</span> inner != <span class="hljs-literal">nil</span> {
        innerWorkflow = inner.inner
    }
    
    <span class="hljs-comment">// 3. 【核心】调用 node_builder.New() 创建节点实例</span>
    ins, err := New(ctx, ns, innerWorkflow, w.schema, deps, w.requireCheckpoint)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }
    
    <span class="hljs-comment">// 4. 准备节点选项</span>
    <span class="hljs-keyword">var</span> opts []compose.GraphAddNodeOpt
    opts = <span class="hljs-built_in">append</span>(opts, compose.WithNodeName(<span class="hljs-type">string</span>(ns.Key)))
    
    <span class="hljs-comment">// 5. 添加前置处理器（preHandler）</span>
    preHandler := statePreHandler(ns, w.streamRun)
    <span class="hljs-keyword">if</span> preHandler != <span class="hljs-literal">nil</span> {
        opts = <span class="hljs-built_in">append</span>(opts, preHandler)
    }
    
    <span class="hljs-comment">// 6. 添加后置处理器（postHandler）</span>
    postHandler := statePostHandler(ns, w.streamRun)
    <span class="hljs-keyword">if</span> postHandler != <span class="hljs-literal">nil</span> {
        opts = <span class="hljs-built_in">append</span>(opts, postHandler)
    }
    
    <span class="hljs-comment">// 7. 将节点添加到 Workflow 图中</span>
    <span class="hljs-keyword">var</span> wNode *compose.WorkflowNode
    <span class="hljs-keyword">if</span> ins.Lambda != <span class="hljs-literal">nil</span> {
        wNode = w.AddLambdaNode(<span class="hljs-type">string</span>(key), ins.Lambda, opts...)
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"node instance has no Lambda: %s"</span>, key)
    }
    
    <span class="hljs-comment">// 8. 处理数组钻取（array drill down）</span>
    <span class="hljs-keyword">if</span> err = deps.arrayDrillDown(w.schema.GetAllNodes()); err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }
    
    <span class="hljs-comment">// 9. 添加节点的输入连接（建立节点之间的数据流）</span>
    <span class="hljs-keyword">for</span> fromNodeKey := <span class="hljs-keyword">range</span> deps.inputsFull {
        wNode.AddInput(<span class="hljs-type">string</span>(fromNodeKey))
    }
    
    <span class="hljs-keyword">for</span> fromNodeKey, fieldMappings := <span class="hljs-keyword">range</span> deps.inputs {
        wNode.AddInput(<span class="hljs-type">string</span>(fromNodeKey), fieldMappings...)
    }
    
    <span class="hljs-keyword">for</span> fromNodeKey := <span class="hljs-keyword">range</span> deps.inputsNoDirectDependencyFull {
        wNode.AddInputWithOptions(<span class="hljs-type">string</span>(fromNodeKey), <span class="hljs-literal">nil</span>, 
            compose.WithNoDirectDependency())
    }
    
    <span class="hljs-keyword">for</span> fromNodeKey, fieldMappings := <span class="hljs-keyword">range</span> deps.inputsNoDirectDependency {
        wNode.AddInputWithOptions(<span class="hljs-type">string</span>(fromNodeKey), fieldMappings, 
            compose.WithNoDirectDependency())
    }
    
    <span class="hljs-comment">// ... 返回 carryOver 依赖</span>
}
</code></pre>
<p><strong>节点实例化（node_builder.New）</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// backend/domain/workflow/internal/compose/node_builder.go (40-100行)</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">New</span><span class="hljs-params">(ctx context.Context, s *schema.NodeSchema,
    inner compose.Runnable[<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any, <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any], // 内部工作流（复合节点用）
    sc *schema.WorkflowSchema,                               // 所属工作流 Schema
    deps *dependencyInfo,                                    // 依赖信息
    requireCheckpoint <span class="hljs-type">bool</span>,
)</span></span> (_ *Node, err <span class="hljs-type">error</span>) {
    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">if</span> panicErr := <span class="hljs-built_in">recover</span>(); panicErr != <span class="hljs-literal">nil</span> {
            err = safego.NewPanicErr(panicErr, debug.Stack())
        }
        
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
            err = vo.WrapIfNeeded(errno.ErrCreateNodeFail, err, 
                errorx.KV(<span class="hljs-string">"node_name"</span>, s.Name), 
                errorx.KV(<span class="hljs-string">"cause"</span>, err.Error()))
        }
    }()
    
    <span class="hljs-comment">// 1. 获取完整的数据源信息（如果节点需要）</span>
    <span class="hljs-keyword">var</span> fullSources <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]*schema.SourceInfo
    <span class="hljs-keyword">if</span> m := entity.NodeMetaByNodeType(s.Type); m != <span class="hljs-literal">nil</span> &amp;&amp; m.InputSourceAware {
        <span class="hljs-keyword">if</span> fullSources, err = GetFullSources(s, sc, deps); err != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
        }
        s.FullSources = fullSources
    }
    
    <span class="hljs-comment">// 2. 【策略模式】检查 NodeSchema.Configs 是否实现了 NodeBuilder 接口</span>
    nb, ok := s.Configs.(schema.NodeBuilder)
    <span class="hljs-keyword">if</span> ok {
        <span class="hljs-comment">// 2.1 准备构建选项</span>
        opts := []schema.BuildOption{
            schema.WithWorkflowSchema(sc),
            schema.WithInnerWorkflow(inner),
        }
        
        <span class="hljs-comment">// 2.2 调用具体节点的 Build() 方法</span>
        <span class="hljs-comment">//     例如: LLMConfig.Build(), PluginConfig.Build() 等</span>
        n, err := nb.Build(ctx, s, opts...)
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
        }
        
        <span class="hljs-comment">// 2.3 将节点包装成 Lambda（Eino 统一接口）</span>
        <span class="hljs-keyword">return</span> toNode(s, n), <span class="hljs-literal">nil</span>
    }
    
    <span class="hljs-comment">// 3. 特殊节点类型处理</span>
    <span class="hljs-keyword">switch</span> s.Type {
    <span class="hljs-keyword">case</span> entity.NodeTypeLambda:
        <span class="hljs-comment">// 直接使用预定义的 Lambda</span>
        <span class="hljs-keyword">if</span> s.Lambda == <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"lambda is not defined for NodeTypeLambda"</span>)
        }
        <span class="hljs-keyword">return</span> &amp;Node{Lambda: s.Lambda}, <span class="hljs-literal">nil</span>
        
    <span class="hljs-keyword">case</span> entity.NodeTypeSubWorkflow:
        <span class="hljs-comment">// 构建子工作流</span>
        subWorkflow, err := buildSubWorkflow(ctx, s, requireCheckpoint)
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
        }
        <span class="hljs-keyword">return</span> toNode(s, subWorkflow), <span class="hljs-literal">nil</span>
        
    <span class="hljs-keyword">default</span>:
        <span class="hljs-built_in">panic</span>(fmt.Sprintf(<span class="hljs-string">"node schema's Configs does not implement NodeBuilder. type: %v"</span>, s.Type))
    }
}
</code></pre>
<p><strong>LLM 节点构建示例（Build 方法）</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// backend/domain/workflow/internal/nodes/llm/llm.go</span>
<span class="hljs-comment">// LLMConfig 实现了 schema.NodeBuilder 接口</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *LLMConfig)</span></span> Build(ctx context.Context, ns *schema.NodeSchema, 
    opts ...schema.BuildOption) (schema.InvokableNode, <span class="hljs-type">error</span>) {
    
    <span class="hljs-comment">// 1. 构建 ChatModel</span>
    chatModel, err := modelbuilder.NewChatModel(ctx, c.Model, c.ModelConfig)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }
    
    <span class="hljs-comment">// 2. 构建 Prompt Template</span>
    <span class="hljs-comment">//    将配置中的 Messages 转换为可执行的模板</span>
    <span class="hljs-comment">//    例如: "{{user_input}}" -&gt; 可替换的模板变量</span>
    promptTpl := buildPromptTemplate(c.Messages)
    
    <span class="hljs-comment">// 3. 创建 LLM Chain</span>
    chain := compose.NewChain[<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any, *schema.Message]()
    chain.AppendPrompt(promptTpl)
    chain.AppendChatModel(chatModel)
    
    <span class="hljs-comment">// 4. 返回 LLMNode（实现了 InvokableNode 接口）</span>
    <span class="hljs-keyword">return</span> &amp;LLMNode{
        config:    c,
        chain:     chain,
        chatModel: chatModel,
    }, <span class="hljs-literal">nil</span>
}

<span class="hljs-comment">// LLMNode 的 Invoke 方法（运行时执行）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(n *LLMNode)</span></span> Invoke(ctx context.Context, input <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any) (<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 1. 执行 Prompt -&gt; ChatModel Chain</span>
    <span class="hljs-comment">//    input = {user_input: "Hello, AI!"}</span>
    <span class="hljs-comment">//    -&gt; Prompt 渲染 -&gt; ChatModel API 调用</span>
    msg, err := n.chain.Invoke(ctx, input)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }
        
    <span class="hljs-comment">// 2. 返回输出</span>
    <span class="hljs-comment">//    {output: "Hi there! How can I help you?"}</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any{<span class="hljs-string">"output"</span>: msg.Content}, <span class="hljs-literal">nil</span>
}
</code></pre>
<p><strong>关键流程总结</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[NewWorkflow] --&gt; B[sc.Init 初始化]
    B --&gt; C[创建 Workflow 实例]
    C --&gt; D[设置 streamRun/requireCheckpoint]
    D --&gt; E[第一轮: AddCompositeNode]
    E --&gt; F[第二轮: AddNode 普通节点]
    
    F --&gt; G[addNodeInternal]
    G --&gt; H[resolveDependencies 解析依赖]
    H --&gt; I["node_builder.New() 创建实例"]
    
    I --&gt; J{Configs 实现 NodeBuilder?}
    J --&gt;|是| K[调用 Build 方法]
    J --&gt;|否| L[特殊类型处理]
    
    K --&gt; M[toNode 包装成 Lambda]
    L --&gt; M
    
    M --&gt; N[AddLambdaNode 添加到图]
    N --&gt; O[AddInput 连接数据流]
    
    F --&gt; P[Compile 编译]
    P --&gt; Q[生成 Runner]
    
    style I fill:#ffe0e0
    style K fill:#e1f5ff
    style P fill:#e8f5e9
</code></pre>
<h4 data-id="heading-46">Step 6: Runtime 执行</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// &gt; - `backend/domain/workflow/internal/compose/workflow.go` → `Workflow.SyncRun()` / `Workflow.Runner.Invoke()`</span>
<span class="hljs-comment">// &gt; - `github.com/cloudwego/eino/compose/runnable.go` → `runner.Run()`（节点调度与回调触发）</span>
<span class="hljs-comment">// Eino Framework 内部执行流程</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *Runner)</span></span> Invoke(ctx context.Context, input <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any, opts ...Option) (<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 1. Emit WorkflowStart Event</span>
    callbacks.OnStart(ctx, &amp;callbacks.RunInfo{
        Name: <span class="hljs-string">"workflow_123"</span>,
        Type: <span class="hljs-string">"workflow"</span>,
    })
    
    state := <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any{}
    
    <span class="hljs-comment">// 2. 按拓扑顺序执行节点</span>
    <span class="hljs-keyword">for</span> _, node := <span class="hljs-keyword">range</span> r.sortedNodes {
        <span class="hljs-comment">// 2.1 Entry Node</span>
        <span class="hljs-keyword">if</span> node.Key == <span class="hljs-string">"entry"</span> {
            callbacks.OnStart(ctx, &amp;callbacks.RunInfo{Name: <span class="hljs-string">"entry"</span>})
            state[<span class="hljs-string">"user_input"</span>] = input[<span class="hljs-string">"user_input"</span>]  <span class="hljs-comment">// "Hello, AI!"</span>
            callbacks.OnEnd(ctx, &amp;callbacks.RunInfo{Name: <span class="hljs-string">"entry"</span>})
        }
        
        <span class="hljs-comment">// 2.2 LLM Node</span>
        <span class="hljs-keyword">if</span> node.Key == <span class="hljs-string">"llm_1"</span> {
            callbacks.OnStart(ctx, &amp;callbacks.RunInfo{Name: <span class="hljs-string">"llm_1"</span>})
            
            <span class="hljs-comment">// 获取输入</span>
            nodeInput := <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any{
                <span class="hljs-string">"user_input"</span>: state[<span class="hljs-string">"user_input"</span>],
            }
            
            <span class="hljs-comment">// 执行 LLM Lambda</span>
            nodeOutput, _ := node.Lambda(ctx, nodeInput)
            <span class="hljs-comment">// nodeOutput = {output: "Hi there! How can I help you?"}</span>
            
            state[<span class="hljs-string">"llm_1_output"</span>] = nodeOutput[<span class="hljs-string">"output"</span>]
            
            callbacks.OnEnd(ctx, &amp;callbacks.RunInfo{
                Name: <span class="hljs-string">"llm_1"</span>,
                Extra: <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any{
                    <span class="hljs-string">"input_tokens"</span>: <span class="hljs-number">10</span>,
                    <span class="hljs-string">"output_tokens"</span>: <span class="hljs-number">8</span>,
                },
            })
        }
        
        <span class="hljs-comment">// 2.3 Exit Node</span>
        <span class="hljs-keyword">if</span> node.Key == <span class="hljs-string">"exit"</span> {
            callbacks.OnStart(ctx, &amp;callbacks.RunInfo{Name: <span class="hljs-string">"exit"</span>})
            output := <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any{
                <span class="hljs-string">"output"</span>: state[<span class="hljs-string">"llm_1_output"</span>],
            }
            callbacks.OnEnd(ctx, &amp;callbacks.RunInfo{Name: <span class="hljs-string">"exit"</span>})
            
            callbacks.OnEnd(ctx, &amp;callbacks.RunInfo{
                Name: <span class="hljs-string">"workflow_123"</span>,
                Type: <span class="hljs-string">"workflow"</span>,
            })
            
            <span class="hljs-keyword">return</span> output, <span class="hljs-literal">nil</span>
        }
    }
}
</code></pre>
<h4 data-id="heading-47">Step 7: 事件流</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Runner
    participant Callback
    participant EventChan
    participant Handler
    
    Runner-&gt;&gt;Callback: OnStart(workflow_123)
    Callback-&gt;&gt;EventChan: WorkflowStart
    
    Runner-&gt;&gt;Callback: OnStart(entry)
    Callback-&gt;&gt;EventChan: NodeStart(entry)
    Runner-&gt;&gt;Callback: OnEnd(entry)
    Callback-&gt;&gt;EventChan: NodeSuccess(entry)
    
    Runner-&gt;&gt;Callback: OnStart(llm_1)
    Callback-&gt;&gt;EventChan: NodeStart(llm_1)
    Note over Runner: Call LLM API...
    Runner-&gt;&gt;Callback: OnEnd(llm_1, tokens)
    Callback-&gt;&gt;EventChan: NodeSuccess(llm_1)
    
    Runner-&gt;&gt;Callback: OnStart(exit)
    Callback-&gt;&gt;EventChan: NodeStart(exit)
    Runner-&gt;&gt;Callback: OnEnd(exit)
    Callback-&gt;&gt;EventChan: NodeSuccess(exit)
    
    Runner-&gt;&gt;Callback: OnEnd(workflow_123)
    Callback-&gt;&gt;EventChan: WorkflowSuccess
    EventChan-&gt;&gt;Handler: lastEvent
</code></pre>
<p><strong>事件处理代码</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// backend/domain/workflow/internal/execute/event_handle.go</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">handleEvent</span><span class="hljs-params">(ctx context.Context, event *Event, repo workflow.Repository,
    sw *schema.StreamWriter[*entity.Message])</span></span> (signal terminateSignal, err <span class="hljs-type">error</span>) {
    <span class="hljs-keyword">switch</span> event.Type {
    <span class="hljs-keyword">case</span> WorkflowStart:
        <span class="hljs-comment">// ① WorkflowStart：创建/更新 workflow_execution，标记为 Running，</span>
        <span class="hljs-comment">//    并将“正在运行”状态推送给前端（如果是流式执行）。</span>
    <span class="hljs-keyword">case</span> NodeStart:
        <span class="hljs-comment">// ② NodeStart：写入 node_execution（包含输入、节点类型等），用于后续追踪。</span>
        nodeExec := &amp;entity.NodeExecution{
            ID:        event.NodeExecuteID,
            ExecuteID: event.RootCtx.RootExecuteID,
            NodeID:    <span class="hljs-type">string</span>(event.NodeKey),
            NodeName:  event.NodeName,
            NodeType:  event.NodeType,
            Status:    entity.NodeRunning,
            Input:     ptr.Of(mustMarshalToString(event.Input)),
        }
        <span class="hljs-keyword">if</span> err = repo.CreateNodeExecution(ctx, nodeExec); err != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> noTerminate, fmt.Errorf(<span class="hljs-string">"failed to create node execution: %v"</span>, err)
        }
    <span class="hljs-keyword">case</span> NodeEnd, NodeEndStreaming:
        <span class="hljs-comment">// ③ NodeEnd：记录节点的执行结果、耗时、token 消耗、输出内容等。</span>
        nodeExec := &amp;entity.NodeExecution{
            ID:       event.NodeExecuteID,
            Status:   entity.NodeSuccess,
            Duration: event.Duration,
            TokenInfo: &amp;entity.TokenUsage{
                InputTokens:  event.GetInputTokens(),
                OutputTokens: event.GetOutputTokens(),
            },
            Extra: event.extra,
        }
        <span class="hljs-keyword">if</span> event.outputStr != <span class="hljs-literal">nil</span> {
            nodeExec.Output = event.outputStr
        } <span class="hljs-keyword">else</span> {
            nodeExec.Output = ptr.Of(mustMarshalToString(event.Output))
            nodeExec.RawOutput = event.RawOutput
        }
        <span class="hljs-keyword">if</span> err = repo.UpdateNodeExecution(ctx, nodeExec); err != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> noTerminate, fmt.Errorf(<span class="hljs-string">"failed to save node execution: %v"</span>, err)
        }
        <span class="hljs-keyword">if</span> event.NodeType == entity.NodeTypeExit &amp;&amp; event.SubWorkflowCtx == <span class="hljs-literal">nil</span> {
            <span class="hljs-comment">// Exit 节点完成，标记“最后一个节点已结束”，等待 WorkflowSuccess 事件最终确认。</span>
            <span class="hljs-keyword">return</span> lastNodeDone, <span class="hljs-literal">nil</span>
        }
    <span class="hljs-keyword">case</span> WorkflowSuccess:
        <span class="hljs-comment">// ④ WorkflowSuccess：根工作流成功完成，等待 Exit 节点处理完后统一收尾。</span>
        <span class="hljs-keyword">return</span> workflowSuccess, <span class="hljs-literal">nil</span>
    <span class="hljs-keyword">case</span> WorkflowFailed:
        <span class="hljs-comment">// ⑤ WorkflowFailed：更新 workflow_execution 状态为失败，并将错误信息写入 node_execution。</span>
    <span class="hljs-keyword">default</span>:
        <span class="hljs-built_in">panic</span>(<span class="hljs-string">"unimplemented event type: "</span> + event.Type)
    }
    <span class="hljs-keyword">return</span> noTerminate, <span class="hljs-literal">nil</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">HandleExecuteEvent</span><span class="hljs-params">(ctx context.Context, wfExeID <span class="hljs-type">int64</span>, eventChan &lt;-<span class="hljs-keyword">chan</span> *Event,
    cancelFn, timeoutFn context.CancelFunc, repo workflow.Repository,
    sw *schema.StreamWriter[*entity.Message], exeCfg workflowModel.ExecuteConfig)</span></span> (event *Event) {
    handler := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(event *Event)</span></span> *Event {
        signal, err := handleEvent(ctx, event, repo, sw)
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
            logs.CtxErrorf(ctx, <span class="hljs-string">"failed to handle event: %v"</span>, err)
        }
        <span class="hljs-keyword">switch</span> signal {
        <span class="hljs-keyword">case</span> workflowSuccess:
            <span class="hljs-comment">// ⑥ WorkflowSuccess：如果 Exit 节点也已完成，就调用 setRootWorkflowSuccess</span>
            <span class="hljs-comment">//    写入 workflow_execution（最终输出、token、耗时等）。</span>
            <span class="hljs-keyword">if</span> lastNodeIsDone || exeCfg.Mode == workflowModel.ExecuteModeNodeDebug {
                _ = setRootWorkflowSuccess(ctx, event, repo, sw)
                <span class="hljs-keyword">return</span> event
            }
        <span class="hljs-keyword">case</span> lastNodeDone:
            <span class="hljs-comment">// ⑦ Exit 节点完成：若之前已经收到 workflowSuccess，就立即收尾；否则等待。</span>
            lastNodeIsDone = <span class="hljs-literal">true</span>
            <span class="hljs-keyword">if</span> wfSuccessEvent != <span class="hljs-literal">nil</span> {
                _ = setRootWorkflowSuccess(ctx, wfSuccessEvent, repo, sw)
                <span class="hljs-keyword">return</span> wfSuccessEvent
            }
        <span class="hljs-keyword">case</span> workflowAbort:
            <span class="hljs-comment">// ⑧ workflowAbort：出现取消/失败，直接返回最后一条事件。</span>
            <span class="hljs-keyword">return</span> event
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
    }
    ...
}

</code></pre>
<h4 data-id="heading-48">Step 8: 返回结果</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">//`backend/application/workflow/workflow.go` → `ApplicationService.OpenAPIRun`</span>

<span class="hljs-comment">// 异步执行：只返回 execute_id + debug_url</span>
<span class="hljs-keyword">if</span> req.GetIsAsync() {
    exeCfg.SyncPattern = workflowModel.SyncPatternAsync
    exeCfg.TaskType = workflowModel.TaskTypeBackground
    exeID, err := GetWorkflowDomainSVC().AsyncExecute(ctx, exeCfg, parameters)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }
    <span class="hljs-keyword">return</span> &amp;workflow.OpenAPIRunFlowResponse{
        ExecuteID: ptr.Of(strconv.FormatInt(exeID, <span class="hljs-number">10</span>)),
        DebugUrl:  ptr.Of(debugutil.GetWorkflowDebugURL(ctx, meta.ID, meta.SpaceID, exeID)),
    }, <span class="hljs-literal">nil</span>
}

<span class="hljs-comment">// 同步执行：返回执行结果 + token + debug_url</span>
exeCfg.SyncPattern = workflowModel.SyncPatternSync
exeCfg.TaskType = workflowModel.TaskTypeForeground
wfExe, tPlan, err := GetWorkflowDomainSVC().SyncExecute(ctx, exeCfg, parameters)
...
<span class="hljs-keyword">return</span> &amp;workflow.OpenAPIRunFlowResponse{
    Data:      data,                                     <span class="hljs-comment">// 输出内容（answer 或变量）</span>
    ExecuteID: ptr.Of(strconv.FormatInt(wfExe.ID, <span class="hljs-number">10</span>)),  <span class="hljs-comment">// 执行 ID</span>
    DebugUrl:  ptr.Of(debugutil.GetWorkflowDebugURL(ctx, meta.ID, wfExe.SpaceID, wfExe.ID)),
    Token:     ptr.Of(wfExe.TokenInfo.InputTokens + wfExe.TokenInfo.OutputTokens),
    Cost:      ptr.Of(<span class="hljs-string">"0.00000"</span>),
}, <span class="hljs-literal">nil</span>
</code></pre>
<p><strong>字段含义</strong>：</p>
<ul>
<li><code>ExecuteID</code>：这次执行的唯一 ID，便于查询历史或调试。</li>
<li><code>Data</code>：工作流输出（当 terminate plan 是 <code>ReturnVariables</code> 时直接返回变量，否则封装成标准 answer 结构）。</li>
<li><code>Token</code>：累计 token 消耗（输入 + 输出）。</li>
<li><code>DebugUrl</code>：一键跳转调试页，便于复现。</li>
<li><code>Cost</code>：预留的计费字段，目前固定 <code>0.00000</code>。</li>
<li>异步场景不直接返回数据，只提供 <code>execute_id</code> + <code>debug_url</code>，由客户端轮询结果。</li>
</ul>
<h2 data-id="heading-49">8. 总结与展望</h2>
<p>在梳理 Coze Studio 后端的过程中可以看到，它已经具备一套相对完善的 DDD 分层和跨域治理能力：</p>
<ul>
<li>API 层负责契约与安全</li>
<li>Application 层掌控用例编排</li>
<li>Domain 层沉淀业务模型</li>
<li>Crossdomain / Infra 撑起跨上下文协作和基础设施抽象。</li>
</ul>
<p>这种“骨架＋血液”的分层让我们在阅读代码时始终能找到明确的职责线索，也解释了为什么工作流、插件、知识库这些复杂模块仍能保持可演化性。</p>
<p>整体来看，Coze Studio 的架构基础已经打好，接下来更像是在“好地基”上不断加砖：稳定性、可观测性、跨团队协作能力都会决定它能否支撑规模化的 AI 工作流生产。只要保持代码与文档同频、持续打磨开发者体验，这个平台就有机会成长为开源 AI Agent 体系里的“参考实现”。</p>
<p>后续会分享更多的 coze-studio 源码中值得我们学习的架构和编码思维，并且后续会跟着分享源码的过程中，对coze studio 进行二次开发，比如开发 mcp 插件(其实已经开发出来了，只是还没来得及以文章的方式来与大家见面，可以先给大家预览下二次开发后的效果在文章开头)</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Coco AI 参选 Gitee 2025 最受欢迎开源软件！您的每一票，都是对中国开源的硬核支持]]></title>    <link>https://juejin.cn/post/7573535624532459539</link>    <guid>https://juejin.cn/post/7573535624532459539</guid>    <pubDate>2025-11-17T15:38:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573535624532459539" data-draft-id="7573525634212659243" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Coco AI 参选 Gitee 2025 最受欢迎开源软件！您的每一票，都是对中国开源的硬核支持"/> <meta itemprop="keywords" content="开源,人工智能"/> <meta itemprop="datePublished" content="2025-11-17T15:38:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="极限实验室"/> <meta itemprop="url" content="https://juejin.cn/user/1258294223312599"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Coco AI 参选 Gitee 2025 最受欢迎开源软件！您的每一票，都是对中国开源的硬核支持
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1258294223312599/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    极限实验室
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T15:38:20.000Z" title="Mon Nov 17 2025 15:38:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>「<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Factivity%2F2025opensource" target="_blank" title="https://gitee.com/activity/2025opensource" ref="nofollow noopener noreferrer">Gitee 2025 年度开源项目评选</a>」火热进行中！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22066ca91ee2435296b5ce69a0fa74fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6B6ZmQ5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763998700&amp;x-signature=tX0kjrUYRlNC%2Fzu%2B5irdl40UBgE%3D" alt="" loading="lazy"/></p>
<p>Coco AI 正在参加 Gitee 2025 最受欢迎的开源软件投票活动， 👉 快来给我投票吧！一起见证中国开源力量，谢谢你宝贵的一票！</p>
<p>点击 直达链接，进入投票页面：</p>
<p>投票直达链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Factivity%2F2025opensource%3Fident%3DIEZ3FS" target="_blank" title="https://gitee.com/activity/2025opensource?ident=IEZ3FS" ref="nofollow noopener noreferrer">gitee.com/activity/20…</a></p>
<h2 data-id="heading-0">🥥 什么是 Coco AI</h2>
<p>Coco AI 是 极限科技（INFINI Labs） 重磅推出一款完全开源、跨平台的企业级智能搜索与助手系统，专为现代企业打造。它通过统一搜索入口，连接企业内外部的异构数据源，融合大模型能力，帮助团队高效访问知识，智能决策协作。</p>
<p>Coco 官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcoco.rs" target="_blank" title="https://coco.rs" ref="nofollow noopener noreferrer">coco.rs</a></p>
<p>Gitee 主页：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Finfinilabs%2Fcoco-app" target="_blank" title="https://gitee.com/infinilabs/coco-app" ref="nofollow noopener noreferrer">gitee.com/infinilabs/…</a> (来个 Star ⭐️ 吧)</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6efac84e3e847c3a66a851d3e734b27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6B6ZmQ5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763998700&amp;x-signature=yo4VY3zHWkyBgTXIjnoIFgr80Gg%3D" alt="" loading="lazy"/></p>
<p>Coco Demo 视频：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1yKT7zoEed%2F" target="_blank" title="https://www.bilibili.com/video/BV1yKT7zoEed/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1yK…</a></p>
<p>👉 快来给我投票吧！麻烦大家动动发财手，支持一下，谢谢！！！</p>
<h2 data-id="heading-1">如何投票?</h2>
<p>打开 Gitee 活动页面，搜索框输入 <strong>infini</strong>，找到 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Factivity%2F2025opensource%3Fident%3DIEZ3FS" target="_blank" title="https://gitee.com/activity/2025opensource?ident=IEZ3FS" ref="nofollow noopener noreferrer">Coco</a> 项目，即可参与投票。</p>
<p>同时也欢迎给 INFINI Labs 开源项目：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Factivity%2F2025opensource%3Fident%3DIJQSSC" target="_blank" title="https://gitee.com/activity/2025opensource?ident=IJQSSC" ref="nofollow noopener noreferrer">analysis-ik</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Factivity%2F2025opensource%3Fident%3DI16IWY" target="_blank" title="https://gitee.com/activity/2025opensource?ident=I16IWY" ref="nofollow noopener noreferrer">gateway</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Factivity%2F2025opensource%3Fident%3DI0CVMB" target="_blank" title="https://gitee.com/activity/2025opensource?ident=I0CVMB" ref="nofollow noopener noreferrer">console</a> 投票。</p>
<p>活动链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Factivity%2F2025opensource" target="_blank" title="https://gitee.com/activity/2025opensource" ref="nofollow noopener noreferrer">gitee.com/activity/20…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e855b00630644d4da20155d05f99e4af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6B6ZmQ5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763998700&amp;x-signature=zwAiwDTnl1JRXhLvux8E8WYcwTs%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3da6291231a048c4a430732e4c144968~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6B6ZmQ5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763998700&amp;x-signature=3eo6Xj8p8KXao1NU2AVipgxxHHY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/736803bfc5c54b4abb492d9a223c20ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6B6ZmQ5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763998700&amp;x-signature=QCEgPkzetUnmzh3ph15x6fSxdk8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">🎁 投票福利</h2>
<p>添加小助手微信（INFINI-Labs）提供「已投票」截图，加入抽奖群，抽 5 位送 Coco AI 定制 T 恤 或 暖冬时尚围巾，抽奖礼品将在公示后 15 个工作日内寄送。</p>
<p>投票截止日期：2026-01-09<br/>
抽奖日期：2026-01-10</p>
<p><strong>抽奖礼品</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d911414ecead481084577f172652ea5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6B6ZmQ5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763998700&amp;x-signature=QSEj5rsc3QtKdX4yNWOWfi0pZVg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">关于极限科技（INFINI Labs）</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04104a155dd84c5e8de175b492caf98e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6B6ZmQ5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763998700&amp;x-signature=7sNDOuxKNImxzEaFZFfYJC9rwmU%3D" alt="INFINI Labs" loading="lazy"/></p>
<p>极限科技，全称极限数据（北京）科技有限公司，是一家专注于实时搜索与数据分析的软件公司。旗下品牌极限实验室（INFINI Labs）致力于打造极致易用的数据探索与分析体验。</p>
<p>极限科技是一支年轻的团队，采用天然分布式的方式来进行远程协作，员工分布在全球各地，希望通过努力成为中国乃至全球企业大数据实时搜索分析产品的首选，为中国技术品牌输出添砖加瓦。</p>
<p>官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Finfinilabs.cn" target="_blank" title="https://infinilabs.cn" ref="nofollow noopener noreferrer">infinilabs.cn</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【AI编程】用Codebuddy+lighthouse开发AI年龄模拟网站]]></title>    <link>https://juejin.cn/post/7573524348130017343</link>    <guid>https://juejin.cn/post/7573524348130017343</guid>    <pubDate>2025-11-17T15:53:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573524348130017343" data-draft-id="7573524348130000959" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【AI编程】用Codebuddy+lighthouse开发AI年龄模拟网站"/> <meta itemprop="keywords" content="后端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-17T15:53:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="卷福同学"/> <meta itemprop="url" content="https://juejin.cn/user/3456520291098686"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【AI编程】用Codebuddy+lighthouse开发AI年龄模拟网站
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3456520291098686/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    卷福同学
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T15:53:47.000Z" title="Mon Nov 17 2025 15:53:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.效果</h2>
<p>在线体验地址：<a href="https://link.juejin.cn?target=http%3A%2F%2F118.25.80.25%3A8080%2F" target="_blank" title="http://118.25.80.25:8080/" ref="nofollow noopener noreferrer">http://118.25.80.25:8080/</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46fdfd3af5894a8b8fa5f3351480eeb0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763999627&amp;x-signature=bwV8Q6ssN6dGJqVoxq%2FczNnucjg%3D" alt="0.png" loading="lazy"/></p>
<p>（体验额度有限，用完就没了）</p>
<h2 data-id="heading-1">2.开发教程</h2>
<p>我们这里使用Codebuddy国际版进行开发，目前Codebuddy Pro已经需要付费了，现在付费还可以领取一个月的lighthouse轻量级服务器，属于性价比拉满。为了能继续体验AI编程的乐趣，小卷先开一个月的Pro试试水</p>
<p>下载和开会员地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.codebuddy.ai%2Fpricing" target="_blank" title="https://www.codebuddy.ai/pricing" ref="nofollow noopener noreferrer">www.codebuddy.ai/pricing</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be4124f503d24cefbdb15843248863ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763999627&amp;x-signature=K7yO6yKFL725ZBR3RYnK1jnO7OU%3D" alt="1.png" loading="lazy"/></p>
<p>接着就可以开启我们的Vibe Coding之旅了，整体步骤如下：</p>
<p>1.先获取人像年龄转换的在线API</p>
<p>2.提供API和接口文档给Codebuddy，进行AI编程</p>
<p>3.测试体验通过后适配手机端页面</p>
<h2 data-id="heading-2">3.AI编程</h2>
<p>由于不知道有哪些网站提供人像年龄转换的功能API，我们直接和Codebuddy对话就行</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51c7d9df8d0f4c638310f4572dd11eac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763999627&amp;x-signature=P7hrMNTmI3Hx8NkbmV69BJw0Q%2F4%3D" alt="2.png" loading="lazy"/></p>
<p>它会自行搜索相关内容和文档后，在进行开发</p>
<p>整个过程耗时还是比较久的，期间还出现了很多问题，这里就不记流水账了，只列出关键问题解法：</p>
<p>（1）AI自己找的人像转换API文档不对，开发报错</p>
<p>解决：我们找到腾讯云官方的人脸年龄变化API文档，丢给AI，地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fdocument%2Fproduct%2F1202%2F41968" target="_blank" title="https://cloud.tencent.com/document/product/1202/41968" ref="nofollow noopener noreferrer">cloud.tencent.com/document/pr…</a></p>
<p>（2）网站开发完成后上传图片报错</p>
<p>这种属于AI编程常见的功能错误了，把报错信息丢给AI，让其自行解决就行。PS：报错是一个接着一个，小卷解决这些报错差不多用了半小时</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79941c0cff414a0fa95de32b71c2935d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763999627&amp;x-signature=i%2FA970LY7TFhUk%2Bk2r9mMVCTj5s%3D" alt="3.png" loading="lazy"/></p>
<p>（3）人脸年龄变化功能需要付费</p>
<p>只能多花点米开通了。。。</p>
<p>计费说明：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fdocument%2Fproduct%2F1202%2F45860" target="_blank" title="https://cloud.tencent.com/document/product/1202/45860" ref="nofollow noopener noreferrer">cloud.tencent.com/document/pr…</a></p>
<p>（4）需要提供腾讯云的SecretId和SecretKey</p>
<p>解决：登录腾讯云网站，打开密钥管理，新建个密钥就行了</p>
<p>地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fconsole.cloud.tencent.com%2Fcam%2Fcapi" target="_blank" title="https://console.cloud.tencent.com/cam/capi" ref="nofollow noopener noreferrer">console.cloud.tencent.com/cam/capi</a></p>
<p>最后，经历了一番折腾后，网站终于开发完成，接着我们就需要把它部署上lighthouse就行</p>
<h2 data-id="heading-3">4.部署</h2>
<p>我们点击对话框上面的配置集成按钮，选择Tencent Lighthouse</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b94e51a03f7d49ad9e5f4aaf522de58a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763999627&amp;x-signature=jWc%2BZ3N47wvQQSKOd3S0SIlr9GI%3D" alt="4.png" loading="lazy"/></p>
<p>这一步，因为我们开通了Pro会员，可以白领一个月的lighthouse轻量级服务器用，所以第一次用的时候，根据提示操作就行，Codebuddy会自行把代码部署到服务器上，等待一会就部署完毕了。</p>
<p>最后，对比了下之前用过的Cursor，Claude Code这些工具，Codebuddy最大的优势是和腾讯云的产品都打通了，想做小程序、腾讯云网站等等都非常方便的，可以说用起来非常简单快捷。</p>
<p>总之总之，这次 CodeBuddy 的体验既痛苦又有收获，很多事情只要开始做了，就会发现其实没那么难。</p>
<p>[#CodeBuddy]</p>
<p>[#CodeBuddyIDE]</p>
<p>[#CodeBuddyCode]</p>
<p>[#无界生成力]</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>